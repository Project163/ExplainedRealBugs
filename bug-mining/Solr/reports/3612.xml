<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:27:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-11069] CDCR bootstrapping can get into an infinite loop when a core is reloaded</title>
                <link>https://issues.apache.org/jira/browse/SOLR-11069</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;&lt;tt&gt;LASTPROCESSEDVERSION&lt;/tt&gt; (a.b.v. LPV) action for CDCR breaks down due to poorly initialised and maintained buffer log for either source or target cluster core nodes.&lt;/p&gt;

&lt;p&gt;If buffer is enabled for cores of either source or target cluster, it return &lt;tt&gt;-1&lt;/tt&gt;, &lt;b&gt;irrespective of number of entries in tlog read by the &lt;tt&gt;leader&lt;/tt&gt;&lt;/b&gt; node of each shard of respective collection of respective cluster. Once disabled, it starts telling us the correct LPV for each core.&lt;/p&gt;

&lt;p&gt;Due to the same flawed behavior, Update Log Synchroniser may doesn&apos;t work properly as expected, i.e. provides incorrect seek to the &lt;tt&gt;non-leader&lt;/tt&gt; nodes to advance at. I am not sure whether this is an intended behavior for sync but it surely doesn&apos;t feel right.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13086936">SOLR-11069</key>
            <summary>CDCR bootstrapping can get into an infinite loop when a core is reloaded</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="erickerickson">Erick Erickson</assignee>
                                    <reporter username="sarkaramrit2@gmail.com">Amrit Sarkar</reporter>
                        <labels>
                    </labels>
                <created>Thu, 13 Jul 2017 16:19:35 +0000</created>
                <updated>Wed, 2 Oct 2019 17:24:41 +0000</updated>
                            <resolved>Thu, 17 Aug 2017 03:41:43 +0000</resolved>
                                    <version>6.2</version>
                    <version>6.3</version>
                    <version>6.4</version>
                    <version>6.5</version>
                    <version>6.6</version>
                    <version>7.0</version>
                                    <fixVersion>6.6.1</fixVersion>
                    <fixVersion>6.7</fixVersion>
                    <fixVersion>7.0</fixVersion>
                    <fixVersion>7.1</fixVersion>
                    <fixVersion>8.0</fixVersion>
                                    <component>CDCR</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16085994" author="erickerickson" created="Thu, 13 Jul 2017 16:56:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rendel&quot; class=&quot;user-hover&quot; rel=&quot;rendel&quot;&gt;rendel&lt;/a&gt; Any comments?&lt;/p&gt;</comment>
                            <comment id="16087076" author="sarkaramrit2@gmail.com" created="Fri, 14 Jul 2017 09:20:45 +0000"  >&lt;p&gt;So when we enable buffering in CDCR, &lt;tt&gt;buffertoggle&lt;/tt&gt; gets initialised via &lt;tt&gt;newLogReader()&lt;/tt&gt; where ::&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CdcrLogReader(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList(logs), tlog);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; CdcrLogReader(List&amp;lt;TransactionLog&amp;gt; tlogs, TransactionLog tlog) {
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.tlogs = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LinkedBlockingDeque&amp;lt;&amp;gt;();
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.tlogs.addAll(tlogs);
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (tlog != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.tlogs.push(tlog); &lt;span class=&quot;code-comment&quot;&gt;// ensure that the tlog being written is pushed
&lt;/span&gt;
      &lt;span class=&quot;code-comment&quot;&gt;// Register the pointer in the parent UpdateLog
&lt;/span&gt;      pointer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CdcrLogPointer();
      logPointers.put(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, pointer);

      &lt;span class=&quot;code-comment&quot;&gt;// If the reader is initialised &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; the updates log is empty, &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; nothing
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((currentTlog = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.tlogs.peekLast()) != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        tlogReader = currentTlog.getReader(0);
        pointer.set(currentTlog.tlogFile);
        numRecordsReadInCurrentTlog = 0;
        log.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Init &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; tlog reader &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; {} - tlogReader = {}&quot;&lt;/span&gt;, currentTlog.tlogFile, tlogReader);
      }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;tt&gt;lastVersion&lt;/tt&gt; and &lt;tt&gt;nextToLastVersion&lt;/tt&gt; initialised as &lt;tt&gt;-1&lt;/tt&gt; and never changed / modified / updated ever. The recent logs are added into &lt;tt&gt;tlogs&lt;/tt&gt; and current tlog is maintained though.&lt;/p&gt;

&lt;p&gt;Now LPV is calculated as: CdcrRequestHandler::handleLastProcessedVersionAction&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (CdcrReplicatorState state : replicatorManager.getReplicatorStates()) {
      &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; version = &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MAX_VALUE;
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (state.getLogReader() != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        version = state.getLogReader().getLastVersion();
      }
      lastProcessedVersion = &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.min(lastProcessedVersion, version);
    }

    &lt;span class=&quot;code-comment&quot;&gt;// next check the log reader of the buffer
&lt;/span&gt;    CdcrUpdateLog.CdcrLogReader bufferLogReader = ((CdcrUpdateLog) core.getUpdateHandler().getUpdateLog()).getBufferToggle();
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (bufferLogReader != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      lastProcessedVersion = &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.min(lastProcessedVersion, bufferLogReader.getLastVersion());
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;bufferLogReader.getLastVersion() is calculated &lt;tt&gt;-1&lt;/tt&gt; and LPV outputs &lt;tt&gt;-1&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16087100" author="sarkaramrit2@gmail.com" created="Fri, 14 Jul 2017 09:34:33 +0000"  >&lt;p&gt;Regarding &lt;tt&gt;updateLogSynchronizer&lt;/tt&gt; ::&lt;/p&gt;

&lt;p&gt;Everytime we call &lt;tt&gt;DISABLEBUFFER&lt;/tt&gt; or &lt;tt&gt;ENABLEBUFFER&lt;/tt&gt;, CdcrBufferManager::stateUpdate gets invoked::&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;@Override
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; void stateUpdate() {
    CdcrUpdateLog ulog = (CdcrUpdateLog) core.getUpdateHandler().getUpdateLog();
    &lt;span class=&quot;code-comment&quot;&gt;// If I am not the leader, I should always buffer my updates
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!leaderStateManager.amILeader()) {
      ulog.enableBuffer();
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
    }
    &lt;span class=&quot;code-comment&quot;&gt;// If I am the leader, I should buffer my updates only &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; buffer is enabled
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (bufferStateManager.getState().equals(CdcrParams.BufferState.ENABLED)) {
      ulog.enableBuffer();
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
    }
    &lt;span class=&quot;code-comment&quot;&gt;// otherwise, disable the buffer
&lt;/span&gt;    ulog.disableBuffer();
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The non-leader nodes are by-defaulted are always buffer enabled ::&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!leaderStateManager.amILeader()) {
      ulog.enableBuffer();
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;though LPV always calculated on leader but it has serious drawbacks explained later:&lt;/p&gt;

&lt;p&gt;in CdcrUpdateLogSynchronizer:: run :: if buffering is &lt;tt&gt;enabled&lt;/tt&gt; ::&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we received -1, it means that the log reader on the leader has not yet started to read log entries
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; nothing
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (lastVersion == -1) {
          &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
        }
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
          CdcrUpdateLog ulog = (CdcrUpdateLog) core.getUpdateHandler().getUpdateLog();
          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ulog.isBuffering()) {
            log.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Advancing replica buffering tlog reader to {} @ {}:{}&quot;&lt;/span&gt;, lastVersion, collection, shardId);
            ulog.getBufferToggle().seek(lastVersion);
          }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It always returns on &lt;tt&gt;lastVersion == -1&lt;/tt&gt; and look at the comment &lt;tt&gt;if we received -1, it means that the log reader on the leader has not yet started to read log entries&lt;/tt&gt;, that&apos;s misleading.&lt;/p&gt;

&lt;p&gt;As the &lt;tt&gt;lastVersion&lt;/tt&gt; is not +ve, the seek for the corresponding non-leader nodes are never set to appropriate LPV. &lt;/p&gt;

&lt;p&gt;Now if the leader goes down, and some non-leader becomes the leader himself, the LPV is not set properly resulting in improper sync and I have no idea how the impact will be in that case. &lt;/p&gt;

&lt;p&gt;Also, as for non-leader nodes buffer is always on, if in the future it becomes the leader itself, even if we have disabled buffer for the source collection cluster, the status and its action will be &lt;tt&gt;buffer enabled&lt;/tt&gt;. Again, not sure of the impact, need to look closely.&lt;/p&gt;</comment>
                            <comment id="16087665" author="sarkaramrit2@gmail.com" created="Fri, 14 Jul 2017 17:38:11 +0000"  >&lt;p&gt;Continuing with how LPV was never tested robust:&lt;/p&gt;

&lt;p&gt;The only bit where the LPV mentioned in the tests is in &lt;tt&gt;CdcrRequestHandlerTest&lt;/tt&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-comment&quot;&gt;// replication never started, lastProcessedVersion should be -1 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; both shards
&lt;/span&gt;    rsp = invokeCdcrAction(shardToLeaderJetty.get(SOURCE_COLLECTION).get(SHARD1), CdcrParams.CdcrAction.LASTPROCESSEDVERSION);
    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; lastVersion = (&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;) rsp.get(CdcrParams.LAST_PROCESSED_VERSION);
    assertEquals(-1l, lastVersion);

    rsp = invokeCdcrAction(shardToLeaderJetty.get(SOURCE_COLLECTION).get(SHARD2), CdcrParams.CdcrAction.LASTPROCESSEDVERSION);
    lastVersion = (&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;) rsp.get(CdcrParams.LAST_PROCESSED_VERSION);
    assertEquals(-1l, lastVersion);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;LPV &amp;gt; -1 or what LPV value (which should &amp;gt; 1 atleast) can be when leader reads some entries from tlogs is never tested anywhere or at least I cannot find it.&lt;/p&gt;</comment>
                            <comment id="16088075" author="varunthacker" created="Fri, 14 Jul 2017 21:11:41 +0000"  >&lt;p&gt;I just saw a case where restarting the source cluster triggered bootstrap. Since LASTPROCESSEDVERSION was -1 the source ended up bootstrapping the target. Disabling buffer on source makes the pointer move correctly.&lt;/p&gt;</comment>
                            <comment id="16088095" author="sarkaramrit2@gmail.com" created="Fri, 14 Jul 2017 21:19:44 +0000"  >&lt;blockquote&gt;
&lt;p&gt;I just saw a case where restarting the source cluster triggered bootstrap.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;When leader of shard of source collection goes down and non-leader is selected, it triggers &lt;tt&gt;bootstrap&lt;/tt&gt; due to above stated reason, LPV set to &lt;tt&gt;-1&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16124804" author="erickerickson" created="Sun, 13 Aug 2017 05:19:18 +0000"  >&lt;p&gt;I&apos;m dithering back and forth about this. I suspect that we&apos;re conflating a couple of issues. There&apos;s definitely a problem with bootstrapping (I&apos;ll attach a patch in a minute). It may well be that the LASTPROCESSEDVERSION is not actually a problem, at least in some testing (with the attached patch) the fact that it is -1 when buffering is enabled seems to be OK.&lt;/p&gt;

&lt;p&gt;I propose we use the patch as a starting point to see if this LASTPROCESSEDVERSION is a problem or not.&lt;/p&gt;

&lt;p&gt;1&amp;gt; when buffering is enabled, tlogs will accrue forever according to the original intent. From Renaud:&lt;/p&gt;

&lt;p&gt;The original goal of the buffer on cdcr is to indeed keep indefinitely the tlogs until the buffer is deactivated (&lt;a href=&quot;https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=62687462#CrossDataCenterReplication(CDCR)-TheBufferElement&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=62687462#CrossDataCenterReplication(CDCR)-TheBufferElement&lt;/a&gt;). This was useful for example during maintenance operations, to ensure that the source cluster will keep all the tlogs until the target clsuter is properly initialised. In this scenario, one will activate the buffer on the source. The source will start to store all the tlogs (and does not purge them). Once the target cluster is initialised, and has register a tlog pointer on the source, one can deactivate the buffer on the source and the tlog will start to be purged once they are read by the target cluster.&lt;/p&gt;

&lt;p&gt;But additionally he had this to say:&lt;br/&gt;
Regarding the issue about LPV = -1, I am a bit surprised as this sentinel value should be used only when the source cluster does not have any log pointers, i.e., no target cluster were configured and initialised with this source cluster. In this case it indicates that there is no registered log reader, and that we should not remove any tlogs if buffer is enabled (as we have to wait for the target to register a log reader and log pointer). &lt;/p&gt;

&lt;p&gt;And enabling buffering definitely causes LASTPROCESSEDVERSION to return -1. However, with the patch LPV immediately goes back to a reasonable value as soon as buffering is disabled, the tlogs get cleaned up etc. without bootstrapping. So I do wonder if the -1 value is just overloaded in this case to also mean &quot;don&apos;t purge tlogs&quot;.&lt;/p&gt;

&lt;p&gt;We need to unentangle a couple of things. I&apos;ll attach a patch in a few minutes that might help.&lt;/p&gt;</comment>
                            <comment id="16124809" author="erickerickson" created="Sun, 13 Aug 2017 05:26:49 +0000"  >&lt;p&gt;figuring out the LPV issue is hard because bootstrapping had a problem. At the end of the process, the core is reloaded. However, that means that the code that checks on the state of the replication returns a &quot;notfound&quot;, which causes another bootstrap command to be sent.&lt;/p&gt;

&lt;p&gt;So this patch moves the relevant objects to (Default)SolrCoreState where they&apos;re preserved around core reloads. With this patch (PoC) I can get bootstrapping to occur, enable/disable buffering, bring the target up and down etc. The fact that LPV is -1 when buffering is enabled doesn&apos;t seem to be a problem.&lt;/p&gt;

&lt;p&gt;So if others can give this a whirl and see if their testing is OK with it then maybe the LPV issue is not an issue.&lt;/p&gt;

&lt;p&gt;Mostly I&apos;m throwing this out for others to consider. What do people think about putting the additional objects in SolrCoreState? Putting the objects there was quick, I&apos;m interested in seeing if my results work for others. If so we can decide whether this is the right way to go.&lt;/p&gt;

&lt;p&gt;Haven&apos;t run precommit, haven&apos;t run the full test suite. Did run CdcrBootstrapTest. Also, the CDCR docs need to be updated.&lt;/p&gt;</comment>
                            <comment id="16125589" author="sarkaramrit2@gmail.com" created="Mon, 14 Aug 2017 12:07:33 +0000"  >&lt;p&gt;Thank you Erick for clarifying the root cause. I see LPV may very well not be the issue we are facing here, pardon my limited testing for this.&lt;/p&gt;

&lt;p&gt;Three things I tested on limited schedule to see issues are addressed with Erick&apos;s patch on &lt;tt&gt;branch_6x&lt;/tt&gt;:&lt;/p&gt;

&lt;p&gt;1. Restart source and target clusters at different intervals, see if bootstrap is happening.&lt;br/&gt;
2. On 2x2 source and target collection - clusters, shut down one node / leader to get the other nodes / follower as leader, see if bootstrap is happening.&lt;br/&gt;
3. Observe behaviour of source and target tlogs across all cores in both source and target collections.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;1. Restart source and target clusters, see if bootstrap is happening.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No bootstrap except the obvious, when&apos;s required. The combinations I tested:&lt;br/&gt;
1. CDCR stop, buffer enable, index X documents and then CDCR on, multiple restarts&lt;br/&gt;
2. CDCR stop, buffer disable, index X documents and then CDCR on, multiple restarts&lt;br/&gt;
3. CDCR stop, buffer enable,  index X documents and then CDCR on, buffer enable, multiple restarts&lt;br/&gt;
4. CDCR stop, buffer disable,  index X documents and then CDCR on, buffer disable, multiple restarts&lt;br/&gt;
5. Above 4 steps one after another on singly created source and target collections - clusters.&lt;/p&gt;

&lt;p&gt;The expected behavior is observed, bootstrap when CDCR on.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;2.  On 2x2 source and target collection - clusters, shut down one node / leader to get the other nodes / follower as leader, see if bootstrap is happening.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No bootstrap except the obvious, when&apos;s required. The combinations I tested:&lt;br/&gt;
1. CDCR stop, buffer enable, index X documents and then CDCR on, shut down the leader node&lt;br/&gt;
2. CDCR stop, buffer disable, index X documents and then CDCR on, shut down the leader node&lt;br/&gt;
3. CDCR stop, buffer enable,  index X documents and then CDCR on, buffer enable, shut down the leader node&lt;br/&gt;
4. CDCR stop, buffer disable,  index X documents and then CDCR on, buffer disable, shut down the leader node&lt;br/&gt;
5. Above 4 steps one after another on singly created source and target collections - clusters.&lt;/p&gt;

&lt;p&gt;The expected behavior is observed, bootstrap when CDCR on. &lt;tt&gt;COLLECTIONCHECKPOINT&lt;/tt&gt; and &lt;tt&gt;LASTPROCESSESVERSION&lt;/tt&gt; are transferred / referred to corresponding new leader elected successfully. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;3. Observe behaviour of source and target tlogs across all cores in both source and target collections.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This was peculiar and as stated by Erick on an offline discussion, I had the same observations;&lt;br/&gt;
a) When buffer enable, all the tlogs are maintained forever on disk.&lt;br/&gt;
b) Once we disable, when no indexing is taking place, it remains as it is.&lt;br/&gt;
c) When a single document is indexed after that, the old tlogs gets purged, &lt;b&gt;it doesn&apos;t maintain 10 tlogs ONLY as expected&lt;/b&gt;, but more which gradually decreases as we index along.&lt;br/&gt;
d) There are times only 1-2 tlogs will be present in each core of source collections, as observed by Erick too, when we stop indexing all together or index slowly. &lt;b&gt;Not sure of the reason&lt;/b&gt;, didn&apos;t had a chance to look into, but I speculate there is no need to maintain 10 or N definite number but to keep a tab on the last processed tlog version, it can be 2nd, 10th or ith, depends ?!&lt;/p&gt;</comment>
                            <comment id="16126249" author="erickerickson" created="Mon, 14 Aug 2017 19:11:10 +0000"  >&lt;p&gt;Thanks for testing! So net-net is that with this patch, with the exception of the tlog purging being a little confusing, the patch seems to fix CDCR?&lt;/p&gt;

&lt;p&gt;On a relatively brief inspection of the code the 10 tlog bit is unimportant. The loop in CdcrUpdateLog.addOldLog removes old logs if and only if there&apos;s nothing pointing to it. In fact I don&apos;t really see the reason for even testing it, assuming that the &quot;if (!this.hasLogPointer(log)) {&quot;&lt;br/&gt;
line preserves tlogs necessary for CDCR.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure we need to fix the fact that tlogs aren&apos;t getting purged quite the way we&apos;d expect on this ticket, perhaps raise another one? Especially if this behavior is also present on 6.1, which I believe it is. CDCR is pretty broken with the infinite bootstrapping, but just a little confusing with the tlog retention.&lt;/p&gt;</comment>
                            <comment id="16126693" author="erickerickson" created="Tue, 15 Aug 2017 01:04:42 +0000"  >&lt;p&gt;This one against master. &lt;/p&gt;

&lt;p&gt;Fixes precommit and has documentation changes.&lt;/p&gt;

&lt;p&gt;All tests pass.&lt;/p&gt;

&lt;p&gt;I need to go over the doc changes again, but this is what it&apos;s looking like at this point. The major changes are an admonition about buffering and some explanation about what it&apos;s for.&lt;/p&gt;</comment>
                            <comment id="16127702" author="erickerickson" created="Tue, 15 Aug 2017 18:50:32 +0000"  >&lt;p&gt;Just asciidoc changes, somehow a bunch of my edits yesterday got lost.&lt;/p&gt;</comment>
                            <comment id="16128716" author="shalinmangar" created="Wed, 16 Aug 2017 12:29:40 +0000"  >&lt;p&gt;Looks good to me, Erick! Thanks for fixing this.&lt;/p&gt;</comment>
                            <comment id="16129578" author="jira-bot" created="Wed, 16 Aug 2017 23:03:33 +0000"  >&lt;p&gt;Commit ac97931c7e5800b2e314545f54c4d524eb69b73b in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erickerickson&quot; class=&quot;user-hover&quot; rel=&quot;erickerickson&quot;&gt;erickerickson&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ac97931&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ac97931&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11069&quot; title=&quot;CDCR bootstrapping can get into an infinite loop when a core is reloaded&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11069&quot;&gt;&lt;del&gt;SOLR-11069&lt;/del&gt;&lt;/a&gt;: CDCR bootstrapping can get into an infinite loop when a core is reloaded&lt;/p&gt;</comment>
                            <comment id="16129591" author="jira-bot" created="Wed, 16 Aug 2017 23:09:30 +0000"  >&lt;p&gt;Commit a850749ab32e57d0bd96a8517798febeaad9dec1 in lucene-solr&apos;s branch refs/heads/branch_7x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erickerickson&quot; class=&quot;user-hover&quot; rel=&quot;erickerickson&quot;&gt;erickerickson&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=a850749&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=a850749&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11069&quot; title=&quot;CDCR bootstrapping can get into an infinite loop when a core is reloaded&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11069&quot;&gt;&lt;del&gt;SOLR-11069&lt;/del&gt;&lt;/a&gt;: CDCR bootstrapping can get into an infinite loop when a core is reloaded&lt;/p&gt;

&lt;p&gt;(cherry picked from commit ac97931)&lt;/p&gt;</comment>
                            <comment id="16129614" author="jira-bot" created="Wed, 16 Aug 2017 23:29:25 +0000"  >&lt;p&gt;Commit 34139f7deb698611046263503272267179c0d315 in lucene-solr&apos;s branch refs/heads/branch_7_0 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erickerickson&quot; class=&quot;user-hover&quot; rel=&quot;erickerickson&quot;&gt;erickerickson&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=34139f7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=34139f7&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11069&quot; title=&quot;CDCR bootstrapping can get into an infinite loop when a core is reloaded&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11069&quot;&gt;&lt;del&gt;SOLR-11069&lt;/del&gt;&lt;/a&gt;: CDCR bootstrapping can get into an infinite loop when a core is reloaded&lt;/p&gt;

&lt;p&gt;(cherry picked from commit ac97931c7e5800b2e314545f54c4d524eb69b73b)&lt;/p&gt;</comment>
                            <comment id="16129767" author="jira-bot" created="Thu, 17 Aug 2017 02:11:07 +0000"  >&lt;p&gt;Commit e2477ecce2503f7c4f69ac1966c49691a3c977b8 in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erickerickson&quot; class=&quot;user-hover&quot; rel=&quot;erickerickson&quot;&gt;erickerickson&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=e2477ec&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=e2477ec&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11069&quot; title=&quot;CDCR bootstrapping can get into an infinite loop when a core is reloaded&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11069&quot;&gt;&lt;del&gt;SOLR-11069&lt;/del&gt;&lt;/a&gt;: CDCR bootstrapping can get into an infinite loop when a core is reloaded&lt;/p&gt;

&lt;p&gt;(cherry picked from commit ac97931c7e5800b2e314545f54c4d524eb69b73b)&lt;/p&gt;</comment>
                            <comment id="16129772" author="jira-bot" created="Thu, 17 Aug 2017 02:24:24 +0000"  >&lt;p&gt;Commit c7f9fcea4b4455c921987e4447b68cdbe046e2f6 in lucene-solr&apos;s branch refs/heads/branch_6_6 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erickerickson&quot; class=&quot;user-hover&quot; rel=&quot;erickerickson&quot;&gt;erickerickson&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=c7f9fce&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=c7f9fce&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11069&quot; title=&quot;CDCR bootstrapping can get into an infinite loop when a core is reloaded&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11069&quot;&gt;&lt;del&gt;SOLR-11069&lt;/del&gt;&lt;/a&gt;: CDCR bootstrapping can get into an infinite loop when a core is reloaded&lt;/p&gt;

&lt;p&gt;(cherry picked from commit ac97931c7e5800b2e314545f54c4d524eb69b73b)&lt;/p&gt;</comment>
                            <comment id="16207442" author="shalinmangar" created="Tue, 17 Oct 2017 11:04:14 +0000"  >&lt;p&gt;Bulk close after 7.1.0 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12881993" name="SOLR-11069.patch" size="52359" author="erickerickson" created="Tue, 15 Aug 2017 18:50:11 +0000"/>
                            <attachment id="12881853" name="SOLR-11069.patch" size="52185" author="erickerickson" created="Tue, 15 Aug 2017 01:02:50 +0000"/>
                            <attachment id="12881641" name="SOLR-11069.patch" size="7689" author="erickerickson" created="Sun, 13 Aug 2017 05:19:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 5 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3hhkv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>