<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:11:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-17692] DELETEREPLICA should preempt full-recovery instead of waiting for completion</title>
                <link>https://issues.apache.org/jira/browse/SOLR-17692</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;I recently deleted a NRT replica that was in the middle of a full-recovery and was a bit surprised to see that the &quot;delete&quot; blocked waiting for the recovery to finish.  This is a minor pain when the index is small, but becomes a huge waste of administrator time (and network bandwidth!) as index sizes grow.&lt;/p&gt;

&lt;p&gt;There&apos;s some plumbing in Solr that attempts to preempt recovery during a DELETE, but it appears that it seems that it mostly comes into play during peer-sync and &quot;background replication&quot; scenarios (i.e. PULL and TLOG replicas that do full-recovery during normal operation).  Preemption doesn&apos;t seem to work once a recovering core is in the midst of a &quot;full recovery&quot;.  We should modify this code that it stops full-recovery as well, unless there&apos;s some compelling reason this was avoided in the initial implementation?&lt;/p&gt;</description>
                <environment></environment>
        <key id="13610911">SOLR-17692</key>
            <summary>DELETEREPLICA should preempt full-recovery instead of waiting for completion</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gerlowskija">Jason Gerlowski</assignee>
                                    <reporter username="gerlowskija">Jason Gerlowski</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 6 Mar 2025 15:12:23 +0000</created>
                <updated>Fri, 17 Oct 2025 20:05:39 +0000</updated>
                            <resolved>Wed, 2 Apr 2025 13:19:53 +0000</resolved>
                                                    <fixVersion>9.9</fixVersion>
                    <fixVersion>10.0</fixVersion>
                                    <component>replication (java)</component>
                    <component>SolrCloud</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3600">1h</timespent>
                                <comments>
                            <comment id="17933035" author="gerlowskija" created="Thu, 6 Mar 2025 15:20:40 +0000"  >&lt;p&gt;Solr makes a pretty good attempt to handle this case, but either it never targeted full-recovery, or something broke since the code was added.  &lt;a href=&quot;https://github.com/apache/solr/blob/main/solr/core/src/java/org/apache/solr/core/CoreContainer.java#L2191-L2198&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CoreContainer.unload&lt;/a&gt;, which does most of the processing for a DELETEREPLICA, makes two method calls in an attempt to preempt:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/solr/blob/main/solr/core/src/java/org/apache/solr/update/DefaultSolrCoreState.java#L383-L391&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;core.getSolrCoreState().cancelRecovery()&lt;/a&gt; - aims to cover recovery &quot;proper&quot;, and is most relevant to the case in the issue description above.&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/solr/blob/main/solr/core/src/java/org/apache/solr/cloud/ZkController.java#L1503-L15&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;zkSys.getZkController().stopReplicationFromLeader(...)&lt;/a&gt; - preempts the periodically-triggered &quot;background&quot; replication done by PULL and TLOG replicas in the course of normal operation&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;a href=&quot;https://github.com/apache/solr/blob/main/solr/core/src/java/org/apache/solr/update/DefaultSolrCoreState.java#L383-L391&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;DefaultSolrCoreState.cancelRecovery&lt;/a&gt; calls RecoveryStrategy.close(), which sets a boolean flag that the RecoveryStrategy checks at various points and can be used to early-exit.  This all works great so far as it goes.  The problem though is that the bulk of the logic for a full-recovery, including the loop to iterate over and fetch index files from the leader, lives elsewhere (particularly &lt;a href=&quot;https://github.com/apache/solr/blob/main/solr/core/src/java/org/apache/solr/handler/ReplicationHandler.java#L452&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ReplicationHandler.doFetch&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/solr/blob/main/solr/core/src/java/org/apache/solr/handler/IndexFetcher.java#L405&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;IndexFetcher.fetchLatestIndex&lt;/a&gt;) and doesn&apos;t have access to RecoveryStrategy and its early-exit flag.  So in practice once a full-recovery starts fetching files from the leader, it won&apos;t check RecoveryStrategy&apos;s early-exit flag again until it&apos;s finished.&lt;/p&gt;

&lt;p&gt;Interestingly, IndexFetcher has &lt;a href=&quot;https://github.com/apache/solr/blob/main/solr/core/src/java/org/apache/solr/handler/IndexFetcher.java#L1569-L1571&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;its own early-exit flag&lt;/a&gt; that can be set by a call to IndexFetcher.destroy(), and it is already used for preemption in the PULL/TLOG replica &quot;background replication&quot; scenario.  This flag &lt;a href=&quot;https://github.com/apache/solr/blob/main/solr/core/src/java/org/apache/solr/handler/IndexFetcher.java#L1747-L1751&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;em&gt;does&lt;/em&gt; get checked&lt;/a&gt; in the &quot;iterate and fetch each leader index file&quot; loop, so it seems like a really great option for our case, if we can find a way to set it from &lt;a href=&quot;https://github.com/apache/solr/blob/main/solr/core/src/java/org/apache/solr/update/DefaultSolrCoreState.java#L383-L391&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;DefaultSolrCoreState.cancelRecovery&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17940360" author="jira-bot" created="Wed, 2 Apr 2025 12:55:37 +0000"  >&lt;p&gt;Commit eb96873c174e172a81d0e69cd9d28cc3dc1558c2 in solr&apos;s branch refs/heads/main from Jason Gerlowski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=eb96873c174&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=eb96873c174&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17692&quot; title=&quot;DELETEREPLICA should preempt full-recovery instead of waiting for completion&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17692&quot;&gt;&lt;del&gt;SOLR-17692&lt;/del&gt;&lt;/a&gt;: Abort ongoing fetches on core close (#3292)&lt;/p&gt;

&lt;p&gt;RecoveryStrategy.close aims to stop replication when the surrounding&lt;br/&gt;
core is closed, but doesn&apos;t quite manage in all cases.  In particular,&lt;br/&gt;
the &apos;closed&apos; flag isn&apos;t able to preempt replication once the&lt;br/&gt;
IndexFetcher has started pulling files.&lt;/p&gt;

&lt;p&gt;This commit aims to fix this by having RecoveryStrategy.close invoke&lt;br/&gt;
ReplicationHandler.abortFetch, which sets a flag that &lt;b&gt;is&lt;/b&gt; noticed by&lt;br/&gt;
IndexFetcher.  This should ensure that DELETEREPLICA calls and other&lt;br/&gt;
core-shutdown paths don&apos;t block on long-running recovery operations.&lt;/p&gt;</comment>
                            <comment id="17940365" author="jira-bot" created="Wed, 2 Apr 2025 13:17:49 +0000"  >&lt;p&gt;Commit 244a520c29db0d922ade6d886ff674f915abcbae in solr&apos;s branch refs/heads/branch_9x from Jason Gerlowski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=244a520c29d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=244a520c29d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17692&quot; title=&quot;DELETEREPLICA should preempt full-recovery instead of waiting for completion&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17692&quot;&gt;&lt;del&gt;SOLR-17692&lt;/del&gt;&lt;/a&gt;: Abort ongoing fetches on core close (#3292)&lt;/p&gt;

&lt;p&gt;RecoveryStrategy.close aims to stop replication when the surrounding&lt;br/&gt;
core is closed, but doesn&apos;t quite manage in all cases.  In particular,&lt;br/&gt;
the &apos;closed&apos; flag isn&apos;t able to preempt replication once the&lt;br/&gt;
IndexFetcher has started pulling files.&lt;/p&gt;

&lt;p&gt;This commit aims to fix this by having RecoveryStrategy.close invoke&lt;br/&gt;
ReplicationHandler.abortFetch, which sets a flag that &lt;b&gt;is&lt;/b&gt; noticed by&lt;br/&gt;
IndexFetcher.  This should ensure that DELETEREPLICA calls and other&lt;br/&gt;
core-shutdown paths don&apos;t block on long-running recovery operations.&lt;/p&gt;</comment>
                            <comment id="18009746" author="houston" created="Thu, 24 Jul 2025 22:50:53 +0000"  >&lt;p&gt;Closing after the 9.9.0 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1um8w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>