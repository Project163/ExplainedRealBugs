<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:28:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-3582] Our ZooKeeper watchers respond to session events as if they are change events, creating undesirable side effects.</title>
                <link>https://issues.apache.org/jira/browse/SOLR-3582</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;As brought up by Trym R. M&#248;ller on the mailing list, we are responding to watcher events about connection/disconnection as if they were notifications about node changes.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.lucidimagination.com/search/document/e13ef390b88eeee2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.lucidimagination.com/search/document/e13ef390b88eeee2&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12596122">SOLR-3582</key>
            <summary>Our ZooKeeper watchers respond to session events as if they are change events, creating undesirable side effects.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="markrmiller@gmail.com">Mark Miller</assignee>
                                    <reporter username="markrmiller@gmail.com">Mark Miller</reporter>
                        <labels>
                    </labels>
                <created>Wed, 27 Jun 2012 17:24:40 +0000</created>
                <updated>Mon, 9 May 2016 18:46:26 +0000</updated>
                            <resolved>Thu, 28 Jun 2012 13:32:30 +0000</resolved>
                                                    <fixVersion>4.0-BETA</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13402388" author="markrmiller@gmail.com" created="Wed, 27 Jun 2012 17:38:12 +0000"  >&lt;p&gt;I&apos;m unsure of the proposed solution on the mailing list.&lt;/p&gt;

&lt;p&gt;On a connection event, the watch will fire - we will skip doing anything, but watches are one time events, so we will have no watch in place?&lt;/p&gt;</comment>
                            <comment id="13402398" author="markrmiller@gmail.com" created="Wed, 27 Jun 2012 17:52:30 +0000"  >&lt;p&gt;Never mind - found confirmation elsewhere that session events do not remove the watcher. The ZooKeeper programming guide does not appear very clear on this when it talks about watches being one time triggers.&lt;/p&gt;</comment>
                            <comment id="13402851" author="trym" created="Thu, 28 Jun 2012 05:10:09 +0000"  >&lt;p&gt;Debugging the provided test shows this behaviour as well, that is, the Watch is kept even though, its notified about disConnection and syncConnection and the Watch will first &quot;stop&quot; after it has been notified about a node change.&lt;/p&gt;

&lt;p&gt;As Mark writes on the mailing list, there might be other ZooKeeper Watchers in Solr which might add new watchers on reconnect.&lt;/p&gt;

&lt;p&gt;If we agree about the ZooKeeper watcher behaviour, then I think that the provided bug fix solves the problem in the LeaderElector and it can be committed to svn independently of problems with other watchers. Are there other things I can do to show, that the provided solution is the right one?&lt;/p&gt;

&lt;p&gt;Best regards Trym&lt;/p&gt;</comment>
                            <comment id="13403041" author="steff1193" created="Thu, 28 Jun 2012 12:02:59 +0000"  >&lt;p&gt;Trym didnt mention it, but this is not only a negligible problem that will never cause any problems in real-world usage. Actually we discovered the problem during one of our performance/endurance test of our real world application in a real world setup and with real world workload (high). We are running with numerous Solr instances in a SolrCloud cluster, with numerous collections each having about 25 slices each with 2 shards (one replica for each slice). During the test Solrs lose their ZK connection (probably due to too long GC pause) and reconnect - resulting in more watchers. The next time a dis-/re-connect to ZK happens it gets many watcher-events resulting in even more watchers for the next time. All in all, seen from the outside, this breaks our performance/endurance test - at first things starts to slow down and eventually JVMs break down with OOM errors. This is a self-reinforcing problem, because for every iteration more time has to be used by the garbage collector collecting watchers (twice as many as last time), increasing the probability of new ZK timeouts, and more time has to be used creating new watchers (twice as many as last time).&lt;/p&gt;

&lt;p&gt;I think you should commit the fix. Basically because it makes a (our) real world application able to run for a long time - it wasnt before. Commit the fix, not so much for our sake, because we are using our own build of Solr (inkl this fix, other fixes and nice impl of optimistic locking etc (&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-3173&quot; title=&quot;Database semantics - insert and update&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-3173&quot;&gt;SOLR-3173&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-3178&quot; title=&quot;Versioning - optimistic locking&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-3178&quot;&gt;SOLR-3178&lt;/a&gt;, etc)) anyway, but to save others (that might also be among the &quot;first movers&quot; on using Solr 4.0 for high scale real world applications) from having to use weeks tracking down the essence of this issue and make a fix.&lt;/p&gt;

&lt;p&gt;If you think this observation/fix should lead to a walk through of the code, to check if watchers are used undesirably at other places, and maybe even come to a more generic fix, I would endorse such a task. But for now I urge you to commit to save others from weeks of debugging. If/when you come to a better or more generic solution, you can always go refactor.&lt;/p&gt;

&lt;p&gt;Regards, Per Steffensen&lt;/p&gt;</comment>
                            <comment id="13403091" author="markrmiller@gmail.com" created="Thu, 28 Jun 2012 13:32:31 +0000"  >&lt;p&gt;Thanks Trym!&lt;/p&gt;</comment>
                            <comment id="13412238" author="hossman" created="Wed, 11 Jul 2012 22:32:44 +0000"  >&lt;p&gt;hoss20120711-manual-post-40alpha-change&lt;/p&gt;</comment>
                            <comment id="13958277" author="mewmewball" created="Wed, 2 Apr 2014 22:44:47 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Never mind - found confirmation elsewhere that session events do not remove the watcher. The ZooKeeper programming guide does not appear very clear on this when it talks about watches being one time triggers.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Mark, is this true even if the event is &quot;Expired&quot;? I don&apos;t know how zookeeper works in detail, but I&apos;d be surprised if it would keep watchers across sessions (how can it figure out which session re-establishment is related to the expired session?).&lt;/p&gt;</comment>
                            <comment id="13958299" author="markrmiller@gmail.com" created="Wed, 2 Apr 2014 23:01:35 +0000"  >&lt;p&gt;If the session is expired you have to create all new watchers - you also have to create a new ZooKeeper client instance. Watchers do not span sessions.&lt;/p&gt;</comment>
                            <comment id="13958332" author="mewmewball" created="Wed, 2 Apr 2014 23:32:25 +0000"  >&lt;p&gt;Thanks Mark, that&apos;s what I thought. I think we might need to do some type of isLeader clean-up if we get an Expired here (in the patch)-&lt;del&gt;I&apos;m suspecting this is related to some sort of recovery race/ error I&apos;m seeing&lt;/del&gt;-but I&apos;m going to open a new jira with more descriptions. Thanks.&lt;/p&gt;</comment>
                            <comment id="13958339" author="mewmewball" created="Wed, 2 Apr 2014 23:35:48 +0000"  >&lt;p&gt;Sorry, &quot;if we get an Expired here with certain conditions&quot;. That was really unclear. I&apos;ll just open a new jira with more info...&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>243397</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 33 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i03dtz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>17674</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>