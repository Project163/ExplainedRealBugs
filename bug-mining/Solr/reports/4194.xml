<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:38:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-13418] ZkStateReader.PropsWatcher synchronizes on a string value &amp; doesn&apos;t track zk version</title>
                <link>https://issues.apache.org/jira/browse/SOLR-13418</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;While contemplating adding better caching to collection properties to avoid repeated calls to ZK from code that wishes to consult collection properties, I noticed that the existing PropsWatcher class is synchronizing on a string value for the name of a collection. Synchronizing on strings is bad practice, given that you never know if the string might have been interned, and therefore someone else might also synchronizing on the same object without your knowledge creating contention or even deadlocks. Also this code doesn&apos;t seem to be doing anything to check ZK version information, so it seems possible that out of order processing by threads could&#160;wind up caching out of date data.&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13229459">SOLR-13418</key>
            <summary>ZkStateReader.PropsWatcher synchronizes on a string value &amp; doesn&apos;t track zk version</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gus">Gus Heck</assignee>
                                    <reporter username="gus">Gus Heck</reporter>
                        <labels>
                    </labels>
                <created>Mon, 22 Apr 2019 22:06:28 +0000</created>
                <updated>Thu, 12 May 2022 00:26:49 +0000</updated>
                            <resolved>Tue, 23 Apr 2019 18:29:39 +0000</resolved>
                                    <version>8.0</version>
                    <version>9.0</version>
                                    <fixVersion>8.1</fixVersion>
                    <fixVersion>9.0</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16824303" author="jira-bot" created="Tue, 23 Apr 2019 16:29:57 +0000"  >&lt;p&gt;Commit 80d3ac8709c6d93c4e4634dc7c10ef667a029cb1 in lucene-solr&apos;s branch refs/heads/master from Gus Heck&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=80d3ac8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=80d3ac8&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13418&quot; title=&quot;ZkStateReader.PropsWatcher synchronizes on a string value &amp;amp; doesn&amp;#39;t track zk version&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13418&quot;&gt;&lt;del&gt;SOLR-13418&lt;/del&gt;&lt;/a&gt; - safer synchronization and zk version checking for collection properties&lt;/p&gt;</comment>
                            <comment id="16824408" author="jira-bot" created="Tue, 23 Apr 2019 18:25:20 +0000"  >&lt;p&gt;Commit 0cfd85baef7f6f6fb997330b9a14471d66a62889 in lucene-solr&apos;s branch refs/heads/branch_8x from Gus Heck&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=0cfd85b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=0cfd85b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13418&quot; title=&quot;ZkStateReader.PropsWatcher synchronizes on a string value &amp;amp; doesn&amp;#39;t track zk version&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13418&quot;&gt;&lt;del&gt;SOLR-13418&lt;/del&gt;&lt;/a&gt; - safer synchronization and zk version checking for collection properties&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 80d3ac8709c6d93c4e4634dc7c10ef667a029cb1)&lt;/p&gt;</comment>
                            <comment id="16824413" author="gus_heck" created="Tue, 23 Apr 2019 18:29:39 +0000"  >&lt;p&gt;Synchronized on the collection instead. The synch in the getCollectionProperties is not immediately necessary, but I plan to resolve the todo I left soon, at which point it will make sense.&#160;&lt;/p&gt;</comment>
                            <comment id="16824683" author="tomasflobbe" created="Wed, 24 Apr 2019 00:18:42 +0000"  >&lt;p&gt;With this change the synchronization now is much more broad, and it blocks different watches for different collections to be processed in parallel. Is that intended?&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;While contemplating adding better caching to collection properties to avoid repeated calls to ZK from code that wishes to consult collection properties,&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;you mean for non-watched collections? what&apos;s the use case?&lt;/p&gt;</comment>
                            <comment id="16824723" author="gus_heck" created="Wed, 24 Apr 2019 01:41:35 +0000"  >&lt;p&gt;I&apos;d say it&apos;s acknowleged, I waffled on the possible need to find a more fine grained solution. The upcoming use case is&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13420&quot; title=&quot;Allow Routed Aliases to use Collection Properties instead of core properties&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13420&quot;&gt;&lt;del&gt;SOLR-13420&lt;/del&gt;&lt;/a&gt;&#160;which will want to consult collection properties on each update request, and certainly we won&apos;t want to consult zookeeper directly each time for that. (I also plan to&#160;fiddle with the synch in getCollectionsProperties() to lock less agressively there (a double check probably). If you have insight as to how collection properties have been used (outside of the tests) for other work I&apos;d love to hear it. I couldn&apos;t find anywhere that watchers are registered or getCollectionProperties() is called in the code base so I would guess that (until &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13420&quot; title=&quot;Allow Routed Aliases to use Collection Properties instead of core properties&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13420&quot;&gt;&lt;del&gt;SOLR-13420&lt;/del&gt;&lt;/a&gt;) the only uses are in custom code, or by external systems via the REST api....&lt;/p&gt;</comment>
                            <comment id="16825689" author="gus_heck" created="Thu, 25 Apr 2019 03:49:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tflobbe&quot; class=&quot;user-hover&quot; rel=&quot;tflobbe&quot;&gt;tflobbe&lt;/a&gt;, there&apos;s a patch in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13420&quot; title=&quot;Allow Routed Aliases to use Collection Properties instead of core properties&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13420&quot;&gt;&lt;del&gt;SOLR-13420&lt;/del&gt;&lt;/a&gt; that demonstrates the use case and improves the synchronization somewhat. I haven&apos;t been able to convince myself that there are any ways in which collection properties are likely to&#160; be updated frequently, and mostly&#160;org.apache.solr.common.cloud.ZkStateReader#createClusterStateWatchersAndUpdate() is called when new objects like ZK or overseer update threads are created (or if the overseer hits an error, and calls&#160;forciblyRefreshAllClusterStateSlow()...)&#160;&lt;/p&gt;

&lt;p&gt;If you think we need to do something like keep a map of lock objects keyed by collection to further reduce synchronization or you have another cleaner idea than that we can re-open this.&lt;/p&gt;</comment>
                            <comment id="16826635" author="tomasflobbe" created="Fri, 26 Apr 2019 04:46:40 +0000"  >&lt;p&gt;The intended use of Collection properties is similar to Cluster Properties, to transmit simple configuration to components of collections (in fact, a common pattern we use is to consider cluster properties as default values when a collection property is not present). Since not every node hosts every collection, Collection Properties are implemented slightly different, using watchers (and that&#8217;s the reason a simple call to &lt;tt&gt;getCollectionProperties(collection)&lt;/tt&gt; doesn&#8217;t cache the result). Components can set watchers on collection properties and adapt/reconfigure after changes (i.e. suppose you have a component to apply backpressure in queries, you can change the amount of QPS that the component will allow, without having to reload your collection).&lt;/p&gt;

&lt;p&gt;I don&#8217;t know much about TRA, but looking at your patch, can&#8217;t you make the URPFactory register a watcher (by calling &lt;tt&gt;registerCollectionPropsWatcher&lt;/tt&gt;) and cache the properties locally? That&#8217;s the intended use of the watchers. Then, the URP would just query that map that the factory keeps locally (can be passed to the URP on constructor or whatever way you prefer to do that.&lt;/p&gt;</comment>
                            <comment id="16827001" author="gus_heck" created="Fri, 26 Apr 2019 14:29:21 +0000"  >&lt;p&gt;Routed Aliases conditionally wrap DistributedUpdateRequestProcessor if the request is to a RoutedAlias. The test for this is currently to check a core property, and this check happens for every update in solr (because at that point it&apos;s not know if it&apos;s a routed alias or not). I&apos;m looking to move this check to use&#160;it to a collection property because this is better for testing, more flexible for future features and makes more sense logically. There would be no valid case where one core in a collection would be part of an RA an another would not. Logically, it&apos;s really a collection level attribute.&lt;/p&gt;

&lt;p&gt;Thus since it will always be needed on every update request adding a watcher as you suggest and caching locally would merely duplicate what&apos;s already cached at the ZkStateReader level, and delay the uptake of new information by the time it took the notification thread to make the adjustment.&lt;/p&gt;

&lt;p&gt;I guess it&apos;s true that if one is using a non-java client or otherwise not using CloudSolrClient, this would lead to caching collection properties information on nodes not containing that collection but that would be necessary anyway to ensure proper handling of RoutedAliases.&lt;/p&gt;

&lt;p&gt;I am heartened by your characterization of the configuration stored as &quot;simple&quot;, but of course this is not enforced. Do you think there is risk that something heavy is being stored in Collection properties and caching props for other collections would become significant? If this looks like a problem maybe we should add a system property or other configuration (cluster property?) to turn off the entire RoutedAlias feature set (which would just be an addition to the org.apache.solr.update.processor.RoutedAliasUpdateProcessor#wrap method and therefore fairly simple) Then the only case that would be hard to handle is heavy values&#160;in collection properties and a desire to use RoutedAliases.&lt;/p&gt;

&lt;p&gt;(as a side note this is yet another case where the lack of&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1416&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-1416&lt;/a&gt;&#160;forces us to watch entire blobs of json when we only care about one atribute... )&lt;/p&gt;</comment>
                            <comment id="16827091" author="tomasflobbe" created="Fri, 26 Apr 2019 16:09:50 +0000"  >&lt;blockquote&gt;&lt;p&gt;Thus since it will always be needed on every update request adding a watcher as you suggest and caching locally would merely duplicate what&apos;s already cached at the ZkStateReader level&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;True. As long as you have at least one watcher set on the collection, doing a call to &lt;tt&gt;getCollectionProperties&lt;/tt&gt; should just respond from memory, so no need to duplicate that.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;and delay the uptake of new information by the time it took the notification thread to make the adjustment.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This is just the time for the ZooKeeper watch to be processed. I think this is an OK delay, since it only applies when a collection property is being updated (if the update arrives a couple of milliseconds later, it shouldn&#8217;t be such an impact in practice, in your test, you should setup some mechanism to wait for the change though but that is anyway the case unless you fetch from zk every time)&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I guess it&apos;s true that if one is using a non-java client or otherwise not using CloudSolrClient, this would lead to caching collection properties information on nodes not containing that collection but that would be necessary anyway to ensure proper handling of RoutedAliases.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;If the collection is not present in the node, Solr wouldn&#8217;t create the URP to handle the update, I don&#8217;t think in this case you are leaking properties, right? The leak comes in the case of collections getting moved out of the node or with collections being created/deleted. It&#8217;s not only a memory leak, but also a ZooKeeper watch leak.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I am heartened by your characterization of the configuration stored as &quot;simple&quot;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I meant this as compare with the config API, that allows you to do much bigger changes, like add/remove components, but for which there is no notification mechanism, and relies on core reloads (in addition that the target is really the configset, not the collection). &lt;/p&gt;

&lt;p&gt;Why is TimeRoutedAliasUpdateProcessor created out of a static wrap function in DUP instead of a Factory?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!collectionPropsWatches.containsKey(coll)) {
+      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!watchedCollectionProps.containsKey(coll)) {
         &lt;span class=&quot;code-comment&quot;&gt;// No one can be notified of the change, we can ignore it and &lt;span class=&quot;code-quote&quot;&gt;&quot;unset&quot;&lt;/span&gt; the watch
&lt;/span&gt;         log.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Ignoring property change &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; collection {}&quot;&lt;/span&gt;, coll);
         &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;With this change, if the collection is not being watched, a collection property watcher would not be notified. Also, since the &lt;tt&gt;collectionPropsWatches&lt;/tt&gt; would still contain the collection name, the value of the properties in the map would go stale. What&#8217;s the intention of this change?&lt;/p&gt;</comment>
                            <comment id="16830342" author="gus_heck" created="Tue, 30 Apr 2019 14:23:45 +0000"  >&lt;p&gt;Since our latest comments have&#160;drifted to&#160;mostly be about the patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13420&quot; title=&quot;Allow Routed Aliases to use Collection Properties instead of core properties&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13420&quot;&gt;&lt;del&gt;SOLR-13420&lt;/del&gt;&lt;/a&gt; I&apos;m replying over there...&lt;/p&gt;</comment>
                            <comment id="17535634" author="janhoy" created="Thu, 12 May 2022 00:26:49 +0000"  >&lt;p&gt;Closing after the 9.0.0 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13229472">SOLR-13420</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 26 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z020zs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>