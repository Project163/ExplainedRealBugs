<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:41:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-5408] CollapsingQParserPlugin scores incorrectly when multiple sort criteria are used</title>
                <link>https://issues.apache.org/jira/browse/SOLR-5408</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;When using the collapsing query parser, only the last sort field appears to be used.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://172.18.0.10:8080/solr/product/select_eng?sort=score%20desc,name_sort_eng%20desc&amp;amp;qf=name_eng&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://172.18.0.10:8080/solr/product/select_eng?sort=score%20desc,name_sort_eng%20desc&amp;amp;qf=name_eng&lt;/a&gt;^3+brand^2+categories_term_eng+sku+upc+promoTag+model+related_terms_eng&amp;amp;pf2=name_eng^2&amp;amp;defType=edismax&amp;amp;rows=12&amp;amp;pf=name_eng~5^3&amp;amp;start=0&amp;amp;q=ipad&amp;amp;boost=sqrt(popularity)&amp;amp;qt=/select_eng&amp;amp;fq=productType:MERCHANDISE&amp;amp;fq=merchant:bestbuycanada&amp;amp;fq=(&lt;b&gt;:&lt;/b&gt;&lt;ins&gt;AND&lt;/ins&gt;-all_all_suppressed_b_ovly:&lt;span class=&quot;error&quot;&gt;&amp;#91;*+TO+*&amp;#93;&lt;/span&gt;&lt;ins&gt;AND&lt;/ins&gt;-rbc_all_suppressed_b_ovly:&lt;span class=&quot;error&quot;&gt;&amp;#91;*+TO+*&amp;#93;&lt;/span&gt;&lt;ins&gt;AND&lt;/ins&gt;-rbc_cpx_suppressed_b_ovly:&lt;span class=&quot;error&quot;&gt;&amp;#91;*+TO+*&amp;#93;&lt;/span&gt;)&lt;ins&gt;OR&lt;/ins&gt;(all_all_suppressed_b_ovly:false+AND+-rbc_all_suppressed_b_ovly:&lt;span class=&quot;error&quot;&gt;&amp;#91;*+TO+*&amp;#93;&lt;/span&gt;&lt;ins&gt;AND&lt;/ins&gt;-rbc_cpx_suppressed_b_ovly:&lt;span class=&quot;error&quot;&gt;&amp;#91;*+TO+*&amp;#93;&lt;/span&gt;)&lt;ins&gt;OR&lt;/ins&gt;(rbc_all_suppressed_b_ovly:false+AND+-rbc_cpx_suppressed_b_ovly:&lt;span class=&quot;error&quot;&gt;&amp;#91;*+TO+*&amp;#93;&lt;/span&gt;)&lt;ins&gt;OR&lt;/ins&gt;(rbc_cpx_suppressed_b_ovly:false)&amp;amp;fq=translations:eng&amp;amp;fl=psid,name_eng,score&amp;amp;debug=true&amp;amp;debugQuery=true&amp;amp;fq=&lt;/p&gt;
{!collapse+field%3DgroupId+nullPolicy%3Dexpand}


&lt;p&gt;&amp;lt;result name=&quot;response&quot; numFound=&quot;5927&quot; start=&quot;0&quot; maxScore=&quot;5.6674457&quot;&amp;gt;&lt;br/&gt;
&amp;lt;doc&amp;gt;&lt;br/&gt;
&amp;lt;str name=&quot;psid&quot;&amp;gt;3002010250210&amp;lt;/str&amp;gt;&lt;br/&gt;
&amp;lt;str name=&quot;name_eng&quot;&amp;gt;&lt;br/&gt;
ZOTAC ZBOX nano XS AD13 Plus All-In-One PC (AMD E2-1800/2GB RAM/64GB SSD)&lt;br/&gt;
&amp;lt;/str&amp;gt;&lt;br/&gt;
&amp;lt;float name=&quot;score&quot;&amp;gt;0.41423172&amp;lt;/float&amp;gt;&lt;br/&gt;
&amp;lt;/doc&amp;gt;&lt;/p&gt;


&lt;p&gt;The same query without using the collapsing query parser produces the expected result.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12676857">SOLR-5408</key>
            <summary>CollapsingQParserPlugin scores incorrectly when multiple sort criteria are used</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbernste">Joel Bernstein</assignee>
                                    <reporter username="bchapman">Brandon Chapman</reporter>
                        <labels>
                    </labels>
                <created>Thu, 31 Oct 2013 13:51:36 +0000</created>
                <updated>Tue, 8 Oct 2019 14:51:42 +0000</updated>
                            <resolved>Fri, 15 Nov 2013 19:59:13 +0000</resolved>
                                    <version>4.5</version>
                                    <fixVersion>4.6.1</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13819524" author="joel.bernstein" created="Mon, 11 Nov 2013 22:37:13 +0000"  >&lt;p&gt;I was able to reproduce and am investigating what the issue is.&lt;/p&gt;</comment>
                            <comment id="13819543" author="joel.bernstein" created="Mon, 11 Nov 2013 22:54:26 +0000"  >&lt;p&gt;Brandon,&lt;/p&gt;

&lt;p&gt;I believe this patch should resolve the issue. It was created on branch_4x. If it doesn&apos;t apply to your build, let me know and I&apos;ll create a patch for the version you&apos;re working with.&lt;/p&gt;

&lt;p&gt;The problem was that the scorer needed to be set on the delegate collecter after each segment reader was set. The initial code was setting the scorer on the delegate collector only once, which worked fine for single sort critera. &lt;/p&gt;

&lt;p&gt;Joel&lt;/p&gt;
</comment>
                            <comment id="13819545" author="joel.bernstein" created="Mon, 11 Nov 2013 22:55:22 +0000"  >&lt;p&gt;I&apos;ll add a test case for this as well going forward.&lt;/p&gt;</comment>
                            <comment id="13819677" author="jira-bot" created="Tue, 12 Nov 2013 00:51:00 +0000"  >&lt;p&gt;Commit 1540904 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbernste&quot; class=&quot;user-hover&quot; rel=&quot;jbernste&quot;&gt;jbernste&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1540904&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1540904&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5408&quot; title=&quot;CollapsingQParserPlugin scores incorrectly when multiple sort criteria are used&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5408&quot;&gt;&lt;del&gt;SOLR-5408&lt;/del&gt;&lt;/a&gt; Fix CollapsingQParserPlugin issue with compound sort criteria&lt;/p&gt;</comment>
                            <comment id="13819728" author="ehatcher" created="Tue, 12 Nov 2013 01:49:31 +0000"  >&lt;p&gt;Here&apos;s a test case with Joel&apos;s fix merged in too.&lt;/p&gt;</comment>
                            <comment id="13819746" author="jira-bot" created="Tue, 12 Nov 2013 02:30:43 +0000"  >&lt;p&gt;Commit 1540922 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbernste&quot; class=&quot;user-hover&quot; rel=&quot;jbernste&quot;&gt;jbernste&lt;/a&gt; in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1540922&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1540922&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5408&quot; title=&quot;CollapsingQParserPlugin scores incorrectly when multiple sort criteria are used&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5408&quot;&gt;&lt;del&gt;SOLR-5408&lt;/del&gt;&lt;/a&gt; Fix CollapsingQParserPlugin issue with compound sort criteria&lt;/p&gt;</comment>
                            <comment id="13820279" author="joel.bernstein" created="Tue, 12 Nov 2013 17:48:51 +0000"  >&lt;p&gt;Erick,&lt;/p&gt;

&lt;p&gt;I like the a test case. Only one concern and that is the assertion of 5 segments. Could be a race condition here where a background merge gets done in between commits, causing there to be fewer then 5 segments.&lt;/p&gt;

&lt;p&gt;I was thinking about just taking out this assertion and using the rest of the test. All we need is there to be more then 1 segment to ensure the test is valid.&lt;/p&gt;

&lt;p&gt;Let me know what you think,&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Joel&lt;/p&gt;</comment>
                            <comment id="13820368" author="joel.bernstein" created="Tue, 12 Nov 2013 19:16:17 +0000"  >&lt;p&gt;Further testing shows the bug is still present after this patch. Continuing to investigate...&lt;/p&gt;</comment>
                            <comment id="13820397" author="ehatcher" created="Tue, 12 Nov 2013 20:11:50 +0000"  >&lt;blockquote&gt;&lt;p&gt;Only one concern and that is the assertion of 5 segments... All we need is there to be more then 1 segment to ensure the test is valid.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1, by all means modify the test to whatever makes sense here.  Maybe &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;assertTrue(&lt;span class=&quot;code-quote&quot;&gt;&quot;Must be more than one segment&quot;&lt;/span&gt;, searcherRef.get().getIndexReader().leaves().size() &amp;gt; 1)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; or something like that?&lt;/p&gt;</comment>
                            <comment id="13820400" author="ehatcher" created="Tue, 12 Nov 2013 20:13:09 +0000"  >&lt;blockquote&gt;&lt;p&gt;Further testing shows the bug is still present after this patch.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Under what conditions?  Can you post a failing test case?&lt;/p&gt;</comment>
                            <comment id="13820424" author="joel.bernstein" created="Tue, 12 Nov 2013 20:38:11 +0000"  >&lt;p&gt;When I started testing with a larger dataset (millions) it become apparent pretty quickly that things were still broken with the score sorting when other criteria is used.&lt;/p&gt;

&lt;p&gt;I&apos;m about to post the fix that worked on the larger data set.&lt;/p&gt;

&lt;p&gt;I&apos;ll have to give some thought into how get this to break with a small test case.&lt;/p&gt;</comment>
                            <comment id="13820431" author="joel.bernstein" created="Tue, 12 Nov 2013 20:45:33 +0000"  >&lt;p&gt;I just posted a new patch.&lt;/p&gt;

&lt;p&gt;This patch makes a change to the &quot;dummy&quot; scorer that is passed down to the delegate collector.&lt;/p&gt;

&lt;p&gt;The issue was that certain priority queue implementations wrap the scorer in a cache that saves the score for the last docId. For this cache to work properly the dummy scorer needed to implement the docID() method properly. This patch does that.&lt;/p&gt;

&lt;p&gt;Not all the priority queue implementations use this technique, so depending on how the query is executed you may or may not hit the bug.&lt;/p&gt;</comment>
                            <comment id="13820434" author="joel.bernstein" created="Tue, 12 Nov 2013 20:48:53 +0000"  >&lt;p&gt;Brandon,&lt;/p&gt;

&lt;p&gt;If you want to post your version of the CollapsingQParserPlugin directly to this ticket. I will make the changes to the version you have and post it back.&lt;/p&gt;

&lt;p&gt;Otherwise, I will shortly be committing this fix to trunk and 4x so you could replace your version with the latest version.&lt;/p&gt;</comment>
                            <comment id="13820449" author="jira-bot" created="Tue, 12 Nov 2013 20:53:52 +0000"  >&lt;p&gt;Commit 1541232 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbernste&quot; class=&quot;user-hover&quot; rel=&quot;jbernste&quot;&gt;jbernste&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1541232&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1541232&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5408&quot; title=&quot;CollapsingQParserPlugin scores incorrectly when multiple sort criteria are used&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5408&quot;&gt;&lt;del&gt;SOLR-5408&lt;/del&gt;&lt;/a&gt; Fixed issue with scorer&lt;/p&gt;</comment>
                            <comment id="13820453" author="bchapman" created="Tue, 12 Nov 2013 20:55:56 +0000"  >&lt;p&gt;Attached patch that we are using.&lt;/p&gt;</comment>
                            <comment id="13820505" author="joel.bernstein" created="Tue, 12 Nov 2013 21:38:10 +0000"  >&lt;p&gt;Brandon,&lt;/p&gt;

&lt;p&gt;I&apos;ll edit your version of the CollapsingQParserPlugin directly and post that back to the ticket.&lt;/p&gt;

&lt;p&gt;So just attach the CollapserQParserPlugin.java file.&lt;/p&gt;

&lt;p&gt;Joel &lt;/p&gt;</comment>
                            <comment id="13820507" author="bchapman" created="Tue, 12 Nov 2013 21:41:19 +0000"  >&lt;p&gt;attaching java file instead of patch&lt;/p&gt;</comment>
                            <comment id="13820569" author="joel.bernstein" created="Tue, 12 Nov 2013 22:28:01 +0000"  >&lt;p&gt;Brandon,&lt;/p&gt;

&lt;p&gt;I put a file up for you to test. I don&apos;t have the same build as you have anymore so I won&apos;t be able to compile and test. But the changes were very small, so I suspect they will work.&lt;/p&gt;

&lt;p&gt;Joel&lt;/p&gt;</comment>
                            <comment id="13820575" author="jira-bot" created="Tue, 12 Nov 2013 22:30:43 +0000"  >&lt;p&gt;Commit 1541277 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbernste&quot; class=&quot;user-hover&quot; rel=&quot;jbernste&quot;&gt;jbernste&lt;/a&gt; in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1541277&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1541277&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5408&quot; title=&quot;CollapsingQParserPlugin scores incorrectly when multiple sort criteria are used&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5408&quot;&gt;&lt;del&gt;SOLR-5408&lt;/del&gt;&lt;/a&gt; Fixed issue with scorer&lt;/p&gt;</comment>
                            <comment id="13821735" author="bchapman" created="Wed, 13 Nov 2013 19:36:43 +0000"  >&lt;p&gt;Joel, &lt;/p&gt;

&lt;p&gt;The file you provided worked. I did a brief test in our staging environment for the sorting and ran all our integration tests.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Brandon&lt;/p&gt;</comment>
                            <comment id="13822374" author="joel.bernstein" created="Thu, 14 Nov 2013 12:28:23 +0000"  >&lt;p&gt;Brandon,&lt;/p&gt;

&lt;p&gt;That&apos;s good news. This fix has been committed to trunk and 4x. Thanks for reporting.&lt;/p&gt;

&lt;p&gt;Joel&lt;/p&gt;</comment>
                            <comment id="13854793" author="jira-bot" created="Sat, 21 Dec 2013 05:24:52 +0000"  >&lt;p&gt;Commit 1552875 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbernste&quot; class=&quot;user-hover&quot; rel=&quot;jbernste&quot;&gt;jbernste&lt;/a&gt; in branch &apos;dev/branches/lucene_solr_4_6&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1552875&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1552875&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5408&quot; title=&quot;CollapsingQParserPlugin scores incorrectly when multiple sort criteria are used&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5408&quot;&gt;&lt;del&gt;SOLR-5408&lt;/del&gt;&lt;/a&gt;: CollapsingQParserPlugin scores incorrectly when multiple sort criteria are used&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12657108">SOLR-5027</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12613438" name="CollapsingQParserPlugin.java" size="29865" author="jbernste" created="Tue, 12 Nov 2013 22:26:07 +0000"/>
                            <attachment id="12613431" name="CollapsingQParserPlugin.java" size="29697" author="bchapman" created="Tue, 12 Nov 2013 21:41:19 +0000"/>
                            <attachment id="12613422" name="SOLR-5027.patch" size="33531" author="bchapman" created="Tue, 12 Nov 2013 20:55:56 +0000"/>
                            <attachment id="12613420" name="SOLR-5408.2.patch" size="956" author="jbernste" created="Tue, 12 Nov 2013 20:40:29 +0000"/>
                            <attachment id="12613293" name="SOLR-5408.patch" size="4978" author="ehatcher" created="Tue, 12 Nov 2013 01:49:31 +0000"/>
                            <attachment id="12613250" name="SOLR-5408.patch" size="1028" author="jbernste" created="Mon, 11 Nov 2013 22:47:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>356233</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 48 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1peuv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>356521</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>