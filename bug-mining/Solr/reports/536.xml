<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:20:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-2125] Spatial filter is not accurate</title>
                <link>https://issues.apache.org/jira/browse/SOLR-2125</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;The calculations of distance appears to be off.&lt;/p&gt;

&lt;p&gt;Note: &quot;The radius of the sphere to be used when calculating distances on a sphere (i.e. haversine). Default is the Earth&apos;s mean radius in kilometers (see org.apache.solr.search.function.distance.Constants.EARTH_MEAN_RADIUS_KM) which is set to 3,958.761458084784856. Most applications will not need to set this.&quot;&lt;/p&gt;

&lt;p&gt;The radius of the earth in KM is  6371.009 km (&#8776;3958.761 mi).&lt;/p&gt;

&lt;p&gt;Also filtering distance appears to be off - example data:&lt;/p&gt;

&lt;p&gt;45.17614,-93.87341 to 44.9369054,-91.3929348 Approx 137 miles Google. 169 miles = 220 kilometers&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://....../solr/select?fl=*,score&amp;amp;start=0&amp;amp;rows=10&amp;amp;q=&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://....../solr/select?fl=*,score&amp;amp;start=0&amp;amp;rows=10&amp;amp;q=&lt;/a&gt;&lt;/p&gt;
{!sfilt%20fl=store_lat_lon}
&lt;p&gt;&amp;amp;qt=standard&amp;amp;pt=44.9369054,-91.3929348&amp;amp;d=280&amp;amp;sort=dist(2,store,vector(44.9369054,-91.3929348)) asc &lt;/p&gt;

&lt;p&gt;Nothing shows. d=285 shows results. This is off by a lot.&lt;/p&gt;

&lt;p&gt;Bill&lt;/p&gt;</description>
                <environment></environment>
        <key id="12474641">SOLR-2125</key>
            <summary>Spatial filter is not accurate</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gsingers">Grant Ingersoll</assignee>
                                    <reporter username="billnbell">Bill Bell</reporter>
                        <labels>
                    </labels>
                <created>Mon, 20 Sep 2010 23:48:19 +0000</created>
                <updated>Wed, 30 Mar 2011 15:45:47 +0000</updated>
                            <resolved>Thu, 23 Sep 2010 12:51:01 +0000</resolved>
                                    <version>1.5</version>
                                    <fixVersion>3.1</fixVersion>
                    <fixVersion>4.0-ALPHA</fixVersion>
                                    <component>Build</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12912785" author="yseeley@gmail.com" created="Tue, 21 Sep 2010 00:00:01 +0000"  >&lt;p&gt;Just in time Bill!&lt;br/&gt;
I just started looking at spatial stuff today since I&apos;m planning on putting some of it in my Lucene Revolution presentation.  I&apos;ve seen some tweets about people having difficulties, and I&apos;ve had some problems when I tried stuff myself.&lt;/p&gt;

&lt;p&gt;Anyway, I&apos;m going to try and clean up some of this stuff over the next few days and make the wiki a bit more user oriented - an extra pair of eyeballs would be welcome!&lt;/p&gt;</comment>
                            <comment id="12912799" author="yseeley@gmail.com" created="Tue, 21 Sep 2010 01:18:38 +0000"  >&lt;p&gt;Hmmm, well, I just corrected one bug that hard-coded the distance in miles, but it was just a check to see if we crossed the poles.&lt;br/&gt;
I don&apos;t think that change alone will fix your issue.&lt;/p&gt;

&lt;p&gt;Earlier today, I switched around some fields/field-types in the example schema, so &quot;store&quot; is now of latlon type, and it&apos;s the only location type (having multiple is just confusing).&lt;/p&gt;

&lt;p&gt;So just looking at the bounding box now, here&apos;s the URL from your example:&lt;br/&gt;
&lt;a href=&quot;http://localhost:8983/solr/select?fl=*,score&amp;amp;start=0&amp;amp;rows=10&amp;amp;q=&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8983/solr/select?fl=*,score&amp;amp;start=0&amp;amp;rows=10&amp;amp;q=&lt;/a&gt;&lt;/p&gt;
{!sfilt%20fl=store}
&lt;p&gt;&amp;amp;qt=standard&amp;amp;pt=44.9369054,-91.3929348&amp;amp;d=280&amp;amp;debugQuery=true&lt;/p&gt;

&lt;p&gt;And I can see that the generated bounding box is:&lt;br/&gt;
+store_0_coordinate:&lt;span class=&quot;error&quot;&gt;&amp;#91;43.129843715965166 TO 46.688683890119314&amp;#93;&lt;/span&gt; +store_1_coordinate:&lt;span class=&quot;error&quot;&gt;&amp;#91;-93.83266208454557 TO -88.79716545231159&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Which just misses the longitude of the point on the document of -93.87341.&lt;/p&gt;

&lt;p&gt;Can anyone point to an webapp for checking arbitrary distances between two lat/lon points?&lt;/p&gt;</comment>
                            <comment id="12912808" author="yseeley@gmail.com" created="Tue, 21 Sep 2010 01:44:27 +0000"  >&lt;p&gt;Bill, I found two online distance calculators that both give the distance between the points you provided as 196km.&lt;br/&gt;
&lt;a href=&quot;http://www.movable-type.co.uk/scripts/latlong.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.movable-type.co.uk/scripts/latlong.html&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://www.es.flinders.edu.au/~mattom/Utilities/distance.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.es.flinders.edu.au/~mattom/Utilities/distance.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Now... the distance of 280km you provided should certainly still encompass that, so we still have a bug anyway.&lt;/p&gt;</comment>
                            <comment id="12912820" author="billnbell" created="Tue, 21 Sep 2010 03:16:09 +0000"  >&lt;p&gt;Yes there is still a bug.&lt;/p&gt;

&lt;p&gt;Most of what I was saying was right. I just did a quick maps.google.com - click directions - and then put the 2 lat,long in both fields.&lt;/p&gt;

&lt;p&gt;137 miles = 220.480128 kilometers (Google)&lt;br/&gt;
196.6km using &lt;a href=&quot;http://www.movable-type.co.uk/scripts/latlong.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.movable-type.co.uk/scripts/latlong.html&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;See on map: &lt;a href=&quot;http://www.movable-type.co.uk/scripts/latlong-map.html?lat1=45.176140&amp;amp;long1=-93.873410&amp;amp;lat2=44.936905&amp;amp;long2=-91.392935&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.movable-type.co.uk/scripts/latlong-map.html?lat1=45.176140&amp;amp;long1=-93.873410&amp;amp;lat2=44.936905&amp;amp;long2=-91.392935&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Distance:	196.6 km&lt;br/&gt;
Initial bearing:	096&#176;53&#8242;44&#8243;&lt;br/&gt;
Final bearing:	098&#176;39&#8242;05&#8243;&lt;br/&gt;
Midpoint:	45&#176;03&#8242;48&#8243;N, 092&#176;37&#8242;50&#8243;W&lt;/p&gt;

&lt;p&gt;As the crow flies is less distance (which makes sense).&lt;/p&gt;

&lt;p&gt;I even used the JS function on &lt;a href=&quot;http://www.movable-type.co.uk/scripts/latlong.html:&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.movable-type.co.uk/scripts/latlong.html:&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;function toRad(a) {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; (a*&lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.PI/180);
};

function hsin(lat1,lon1,lat2,lon2) {
&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; R = 6371; &lt;span class=&quot;code-comment&quot;&gt;// km
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; dLat = toRad(lat2-lat1);
&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; dLon = toRad(lon2-lon1); 
&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; a = &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.sin(dLat/2) * &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.sin(dLat/2) +
        &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.cos(toRad(lat1)) * &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.cos(toRad(lat2)) * 
        &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.sin(dLon/2) * &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.sin(dLon/2); 
&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; c = 2 * &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.atan2(&lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.sqrt(a), &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.sqrt(1-a)); 
&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; d = R * c;
&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; d;
};

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As a Javascript function - while looping through the results. Since I cannot find a way to output the distance automagically from the XML coming back from SOLR.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;script&amp;gt;document.write(hsin(lat,lon,solr.lat,solr.lon));&amp;lt;/script&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I kept playing with d=&amp;lt;km&amp;gt; to see when the filter is not longer showing on the results at while value.&lt;/p&gt;

&lt;p&gt;&amp;amp;sort=dist(2,store,vector(44.9369054,-91.3929348)) asc &lt;/p&gt;

&lt;p&gt;d=285 shows.&lt;br/&gt;
d=284 does not show.&lt;/p&gt;



</comment>
                            <comment id="12912822" author="cmale" created="Tue, 21 Sep 2010 03:22:04 +0000"  >&lt;p&gt;The sorting won&apos;t be the issue though surely? The bug seems to be in the bounding box generation that Yonik pointed out.  There will be some rounding issues at different places I can imagine, but nothing that would generate such a discrepancy.&lt;/p&gt;</comment>
                            <comment id="12912823" author="chrismattmann" created="Tue, 21 Sep 2010 03:23:17 +0000"  >&lt;p&gt;Distance using the Haversine function is extremely sensitive to what spatial reference system the data was recorded in. WGS84 isn&apos;t particular great with long distances. The PostGIS in Action book has a really good explanation of this.&lt;/p&gt;</comment>
                            <comment id="12912827" author="yseeley@gmail.com" created="Tue, 21 Sep 2010 03:40:38 +0000"  >&lt;blockquote&gt;&lt;p&gt;Distance using the Haversine function is extremely sensitive to what spatial reference system the data was recorded in. WGS84 isn&apos;t particular great with long distances.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I know nothing on this topic, but an error of 45% at 200 km?  I&apos;m pretty certain that there is a bug not having to do with the accuracy of spatial reference systems here.&lt;/p&gt;</comment>
                            <comment id="12912830" author="chrismattmann" created="Tue, 21 Sep 2010 04:01:50 +0000"  >&lt;p&gt;Umm well if you know nothing then how are you pretty sure? And yes, the error bars are fairly high for the Great Circle distance.&lt;/p&gt;</comment>
                            <comment id="12912833" author="billnbell" created="Tue, 21 Sep 2010 04:07:13 +0000"  >&lt;p&gt;The calculation using hsin Javascript is more accurate than our algorithm ? Chris a few percentage points maybe - but not 45%.&lt;/p&gt;

&lt;p&gt;I will look into it some more tonight. It can&apos;t be that complicated.&lt;/p&gt;

&lt;p&gt;Bill&lt;/p&gt;</comment>
                            <comment id="12912835" author="chrismattmann" created="Tue, 21 Sep 2010 04:14:01 +0000"  >&lt;p&gt;Hey Bill:&lt;/p&gt;

&lt;p&gt;Interesting. usually these types of errors are due to errors in the coordinate reference system of the input data, but if you were able to successfully implement this in JS, then yep, it&apos;s likely some bug in the existing Solr implementation rather than the input data.&lt;/p&gt;

&lt;p&gt;Cheers,&lt;br/&gt;
Chris&lt;/p&gt;</comment>
                            <comment id="12912883" author="billnbell" created="Tue, 21 Sep 2010 08:48:46 +0000"  >&lt;p&gt;/lucene/contrib/spatial/src/java/org/apache/lucene/spatial/DistanceUtils.java - hsin appears to be okay.&lt;/p&gt;

&lt;p&gt;Good print:&lt;/p&gt;

&lt;p&gt;System.out.println(&quot;x1 = &quot; + x1 + &quot; - &quot; + x1*180/Math.PI + &quot;,y1 = &quot; + y1 + &quot; - &quot; + x2*180/Math.PI + &quot;,x2 = &quot; + x2 + &quot; - &quot; + x2*180/Math.PI + &quot;,y2 = &quot; + y2 + &quot; - &quot; + y2*180/Math.PI + &quot;,radius = &quot; + radius + &quot;\n&quot;);&lt;br/&gt;
 System.out.println(&quot;result = &quot; + result + &quot; km\n&quot;);&lt;/p&gt;

&lt;p&gt;My guess: &quot;src/java/org/apache/solr/schema/LatLonType.java&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;[] ur;
    &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;[] ll;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (options.measStr == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || options.measStr.equals(&lt;span class=&quot;code-quote&quot;&gt;&quot;hsin&quot;&lt;/span&gt;)) {
      ur = DistanceUtils.latLonCornerDegs(point[LAT], point[LONG], options.distance, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, options.radius);
      ll = DistanceUtils.latLonCornerDegs(point[LAT], point[LONG], options.distance, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, options.radius);
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
      ur = DistanceUtils.vectorBoxCorner(point, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, options.distance, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
      ll = DistanceUtils.vectorBoxCorner(point, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, options.distance, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
    }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

</comment>
                            <comment id="12912981" author="gsingers" created="Tue, 21 Sep 2010 13:48:13 +0000"  >&lt;p&gt;Hmm, I&apos;m putting in some more exact tests into LatLonType and SpatialFilterTest, trying to work through this.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;clearIndex();
    assertU(adoc(&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;14&quot;&lt;/span&gt;, fieldName, &lt;span class=&quot;code-quote&quot;&gt;&quot;0,5&quot;&lt;/span&gt;));
    assertU(adoc(&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;15&quot;&lt;/span&gt;, fieldName, &lt;span class=&quot;code-quote&quot;&gt;&quot;0,15&quot;&lt;/span&gt;));
    &lt;span class=&quot;code-comment&quot;&gt;//one at the upper right of the box, 3000KM from 0,0, see http://www.movable-type.co.uk/scripts/latlong.html
&lt;/span&gt;    assertU(adoc(&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;16&quot;&lt;/span&gt;, fieldName, &lt;span class=&quot;code-quote&quot;&gt;&quot;18.71111,19.79750&quot;&lt;/span&gt;));
    assertU(commit());

    checkHits(fieldName, &lt;span class=&quot;code-quote&quot;&gt;&quot;0,0&quot;&lt;/span&gt;, 1000, 1, 14);
    checkHits(fieldName, &lt;span class=&quot;code-quote&quot;&gt;&quot;0,0&quot;&lt;/span&gt;, 2000, 1, 14);
    checkHits(fieldName, &lt;span class=&quot;code-quote&quot;&gt;&quot;0,0&quot;&lt;/span&gt;, 3000, 2, 14, 15);
    checkHits(fieldName, &lt;span class=&quot;code-quote&quot;&gt;&quot;0,0&quot;&lt;/span&gt;, 3001, 3, 14, 15, 16);
    checkHits(fieldName, &lt;span class=&quot;code-quote&quot;&gt;&quot;0,0&quot;&lt;/span&gt;, 3000.1, 3, 14, 15, 16);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12912983" author="gsingers" created="Tue, 21 Sep 2010 13:53:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;http://....../solr/select?fl=*,score&amp;amp;start=0&amp;amp;rows=10&amp;amp;q={!sfilt%20fl=store_lat_lon}&amp;amp;qt=standard&amp;amp;pt=44.9369054,-91.3929348&amp;amp;d=280&amp;amp;sort=dist(2,store,vector(44.9369054,-91.3929348)) asc &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This URL has me a bit stumped.  sfilt on a lat_lon is going to use Great Circle to calculate the distance, but then you are sorting using Euclidean distance?  Not saying that&apos;s a problem, but it strikes me a bit weird.&lt;/p&gt;</comment>
                            <comment id="12912986" author="yseeley@gmail.com" created="Tue, 21 Sep 2010 13:59:39 +0000"  >&lt;blockquote&gt;&lt;p&gt;but then you are sorting using Euclidean distance&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I imagine it&apos;s because of the wiki: &lt;a href=&quot;http://wiki.apache.org/solr/SpatialSearch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://wiki.apache.org/solr/SpatialSearch&lt;/a&gt;&lt;br/&gt;
The first example uses &quot;dist&quot; and I imagine many are going to interpret that as geo distance (I made the same mistake trying to follow the wiki).&lt;/p&gt;</comment>
                            <comment id="12912990" author="gsingers" created="Tue, 21 Sep 2010 14:07:02 +0000"  >&lt;p&gt;Ah, good point, Yonik.  I will fix that.&lt;/p&gt;</comment>
                            <comment id="12912993" author="gsingers" created="Tue, 21 Sep 2010 14:10:19 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (options.measStr == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || options.measStr.equals(&lt;span class=&quot;code-quote&quot;&gt;&quot;hsin&quot;&lt;/span&gt;)) {
      ur = DistanceUtils.latLonCornerDegs(point[LAT], point[LONG], options.distance, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, options.radius);
      ll = DistanceUtils.latLonCornerDegs(point[LAT], point[LONG], options.distance, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, options.radius);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It could very well be in the determination of the two corners.  That being said, in the test I just posted, the point 18.71111, 19.79750 is 3000KM away from 0,0 according to movable-type when traveling along a 45 degree bearing and the tests &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;checkHits(fieldName, &lt;span class=&quot;code-quote&quot;&gt;&quot;0,0&quot;&lt;/span&gt;, 3000, 2, 14, 15);
checkHits(fieldName, &lt;span class=&quot;code-quote&quot;&gt;&quot;0,0&quot;&lt;/span&gt;, 3001, 3, 14, 15, 16);
checkHits(fieldName, &lt;span class=&quot;code-quote&quot;&gt;&quot;0,0&quot;&lt;/span&gt;, 3000.1, 3, 14, 15, 16);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Pass for me now that Yonik&apos;s patch is applied.  Please check my logic.&lt;/p&gt;</comment>
                            <comment id="12913011" author="yseeley@gmail.com" created="Tue, 21 Sep 2010 14:45:00 +0000"  >&lt;p&gt;Ok Grant &amp;amp; I chatted and we figured out what&apos;s going wrong.  We were calculating a box the size that would completely fit inside the circle rather than vice-versa.  This was caused by taking the distance and projecting it out to calculate the corners of the box.  But the distance given should really be to the side of the box... and the distance from the center to the corner of the box should be greater (if the box is to completely encompass the circle).&lt;/p&gt;

&lt;p&gt;The fix should be easy - the distance to the corner of the box is sqrt(2) * dist_to_side_of_box.  So internally we just need to multiply the distance by sqrt(2) before finding the corners.&lt;/p&gt;

&lt;p&gt;Grant is coding up the fix and tests.&lt;/p&gt;</comment>
                            <comment id="12913035" author="yseeley@gmail.com" created="Tue, 21 Sep 2010 15:36:20 +0000"  >&lt;p&gt;More chatting with Grant - sqrt(2) is correct if things are flat, but prob not correct for a bounding box on the surface of a sphere.&lt;br/&gt;
Another thought is toproject left, right, up, and down to the sides of the box and use those lat ranges and lon ranges directly as the bounding box.&lt;/p&gt;

&lt;p&gt;The crazy thing is that this is basic geo code - isn&apos;t there some bounding box calculation code out there we can use or at least reference?&lt;/p&gt;</comment>
                            <comment id="12913126" author="billnbell" created="Tue, 21 Sep 2010 17:59:16 +0000"  >&lt;p&gt;Grant: Can you give a good example using the same measurements for sorting and sfilt ?&lt;/p&gt;

&lt;p&gt;Will this work? The Spatial Wiki &lt;a href=&quot;http://wiki.apache.org/solr/SpatialSearch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://wiki.apache.org/solr/SpatialSearch&lt;/a&gt; shows:&lt;/p&gt;

&lt;p&gt;3.Using the &quot;frange&quot; QParser, as in fq=&lt;/p&gt;
{!frange l=0 u=400}
&lt;p&gt;hsin(0.57, -1.3, lat_rad, lon_rad, 3963.205) &lt;/p&gt;

&lt;p&gt;The Function Wiki Shows:&lt;/p&gt;

&lt;p&gt;hsin(radius, true|false, x1,y1,x2,y2)&lt;/p&gt;

&lt;p&gt;Here is the correct solution: (UPDATED)&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8983/solr/select/??fl=*,score&amp;amp;start=0&amp;amp;rows=10&amp;amp;q={!sfilt%20fl=store}&amp;amp;qt=standard&amp;amp;pt=44.9369054,-91.3929348&amp;amp;d=285&amp;amp;sort=hsin(6371,&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;,store,vector(44.9369054,-91.3929348))%20asc
&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The Local Solr from Patrick projected the ur, ll using the distance and did a range check to see if the points are in the box.It is a close approximation. &lt;/p&gt;</comment>
                            <comment id="12913134" author="billnbell" created="Tue, 21 Sep 2010 18:07:11 +0000"  >&lt;p&gt;Two good articles:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://janmatuschek.de/LatitudeLongitudeBoundingCoordinates&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://janmatuschek.de/LatitudeLongitudeBoundingCoordinates&lt;/a&gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Pole and good pictures&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;a href=&quot;http://stackoverflow.com/questions/238260/how-to-calculate-the-bounding-box-for-a-given-lat-lng-location&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://stackoverflow.com/questions/238260/how-to-calculate-the-bounding-box-for-a-given-lat-lng-location&lt;/a&gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Why Sphere is only good for 10KM distances.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12913182" author="gsingers" created="Tue, 21 Sep 2010 19:03:31 +0000"  >&lt;blockquote&gt;&lt;p&gt;The Local Solr from Patrick projected the ur, ll using the distance and did a range check to see if the points are in the box.It is a close approximation. An ellipses would be closer. Circle is not close enough.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;OK, so I went back to that code and looked and we are doing the same thing (in fact, I based it off of that).  Namely, the only thing that is not working in the code is the interpretation of the results and not the math itself.  To that point, Bill, if you look at the points you gave, it is right on the edge of a box that is centered on that point (roughly, Chippewa Falls, WI), but still outside, of the box that was created by Solr (at 280KM).  I worked this out by viewing the maps at:&lt;br/&gt;
1. &lt;a href=&quot;http://www.movable-type.co.uk/scripts/latlong-map.html?lat1=44.936905&amp;amp;long1=-91.392935&amp;amp;lat2=43.09&amp;amp;long2=-93.87341&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.movable-type.co.uk/scripts/latlong-map.html?lat1=44.936905&amp;amp;long1=-91.392935&amp;amp;lat2=43.09&amp;amp;long2=-93.87341&lt;/a&gt;&lt;br/&gt;
2. &lt;a href=&quot;http://www.movable-type.co.uk/scripts/latlong-map.html?lat1=44.936905&amp;amp;long1=-91.392935&amp;amp;lat2=45.17614&amp;amp;long2=-93.87341&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.movable-type.co.uk/scripts/latlong-map.html?lat1=44.936905&amp;amp;long1=-91.392935&amp;amp;lat2=45.17614&amp;amp;long2=-93.87341&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The reason is that we are calculating the box based on the fact that the upper right and lower left corners are 280KM away.  The question is then, is this the intuitive thing app developers expect?  If app developers think in terms of a radius of distance 280km and all points inside, then no, it isn&apos;t.  But if they think in terms of the upper and lower box corners with no suggestion of &quot;radius&quot;, hence implying a circle then it does.  &lt;/p&gt;

&lt;p&gt;So, one fix for this could solely be a documentation fix.  The other fix is to change the reasoning above to simply find the north, south, east, west points of a box that transcribes a radius of the distance given (since most users tend to think in terms of radius from where they are located and not upper and lower box corners.  This will create a box that encloses said radius completely and might give a slight bit more fuzz up near the box corners due to curvature, but that should be fine.  I&apos;m working on a patch for this fix, as I think it is the better way.&lt;/p&gt;
</comment>
                            <comment id="12913244" author="billnbell" created="Tue, 21 Sep 2010 20:52:50 +0000"  >&lt;p&gt;OK so that makes sense. Youa re using distance at 45 degrees. So the east-west would not extend far enough.&lt;/p&gt;

&lt;p&gt;Using &lt;a href=&quot;http://en.wikipedia.org/wiki/Pythagorean_theorem&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://en.wikipedia.org/wiki/Pythagorean_theorem&lt;/a&gt; would help on the east-west case, but circle or ellipses is MUCH better.&lt;/p&gt;

&lt;p&gt;Although extending the 45 degree out would be a conservative estimate. And since we usually sort by distance asc, those extra points would be in the result set but at the end of the list. (this is an improvement - again not at good as ellipses).&lt;/p&gt;

&lt;p&gt;You need a quick function that tells you &quot;is this lat,long in the circle / ellipses or not&quot;. A range &lt;span class=&quot;error&quot;&gt;&amp;#91;X to Y&amp;#93;&lt;/span&gt; will not get you that. You need to use hsin().&lt;/p&gt;

&lt;p&gt;On potential:&lt;/p&gt;

&lt;p&gt;1. Do range select using points &lt;a href=&quot;http://janmatuschek.de/LatitudeLongitudeBoundingCoordinates&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://janmatuschek.de/LatitudeLongitudeBoundingCoordinates&lt;/a&gt; &lt;br/&gt;
(Lat =&amp;gt; 1.2393 AND Lat &amp;lt;= 1.5532) AND (Lon &amp;gt;= -1.8184 AND Lon &amp;lt;= 0.4221)&lt;br/&gt;
2. Check those points for distance  &quot;in the ellipses&quot;.  &lt;a href=&quot;http://janmatuschek.de/LatitudeLongitudeBoundingCoordinates&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://janmatuschek.de/LatitudeLongitudeBoundingCoordinates&lt;/a&gt;&lt;br/&gt;
 acos(sin(1.3963) * sin(Lat) + cos(1.3963) * cos(Lat) * cos(Lon - (-0.6981))) &amp;lt;= 0.1570;&lt;/p&gt;

&lt;p&gt;That should make it fast and simplify the calculations.&lt;/p&gt;

&lt;p&gt;UPDATE - NOTE:&lt;/p&gt;

&lt;p&gt;Plugging all this into the web site, proves that Pythagorean is a good approximation... &lt;/p&gt;

&lt;p&gt;See Excel attached.&lt;/p&gt;

&lt;p&gt;hsin = 309 km from pt to max&lt;br/&gt;
hsin = 314 km from pt to min&lt;br/&gt;
Estimate using Pythagorean is 311 using sqrt(220km^2+220km^2)&lt;/p&gt;

&lt;p&gt;41.42% is the difference from west-east to 45 degree. sqrt(1^2+1^2)&lt;/p&gt;

&lt;p&gt;Yonik: sqrt(2) is right - but the spreadsheet is a bit better based on spheres.&lt;/p&gt;

&lt;p&gt;The #2 will then subselect the points to limit within that result set.&lt;/p&gt;

&lt;p&gt;Therefore, a user could take a distance from the user, sqrt(d^2+d^2) and use that to get a list - it is not exact but better than nothing.&lt;/p&gt;</comment>
                            <comment id="12913295" author="billnbell" created="Tue, 21 Sep 2010 22:37:04 +0000"  >&lt;p&gt;Example calcs to get lat/long for distance of 220km from 44.93691,-91.3929&lt;/p&gt;</comment>
                            <comment id="12913363" author="billnbell" created="Wed, 22 Sep 2010 02:55:05 +0000"  >&lt;p&gt;There is another example...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.movable-type.co.uk/scripts/latlong-db.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.movable-type.co.uk/scripts/latlong-db.html&lt;/a&gt; not sure - but this is also a good first cut. Then if you want more accurate results calculate results that come back&lt;br/&gt;
 and through out ones that are not within. Cache results. The link above &lt;a href=&quot;http://janmatuschek.de/LatitudeLongitudeBoundingCoordinates&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://janmatuschek.de/LatitudeLongitudeBoundingCoordinates&lt;/a&gt; appears a little more accurate. But this is simpler.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// first-cut bounding box (in degrees)
&lt;/span&gt;$maxLat = $lat + rad2deg($rad/$R);
$minLat = $lat - rad2deg($rad/$R);
&lt;span class=&quot;code-comment&quot;&gt;// compensate &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; degrees longitude getting smaller with increasing latitude
&lt;/span&gt;$maxLon = $lon + rad2deg($rad/$R/cos(deg2rad($lat)));
$minLon = $lon - rad2deg($rad/$R/cos(deg2rad($lat)));
 
$sql = &quot;Select ID, Postcode, Lat, Lon
        From MyTable
        Where Lat &amp;gt; $minLat And Lat &amp;lt; $maxLat
          And Lon &amp;gt; $minLon And Lon &amp;lt; $maxLon&quot;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="12913368" author="billnbell" created="Wed, 22 Sep 2010 03:42:20 +0000"  >&lt;p&gt;Fixed the distance calc for box. We still need to take the results and do a hsin()&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; now returns 8 on example data:

http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8983/solr/select/??fl=*,score&amp;amp;start=0&amp;amp;rows=10&amp;amp;q={!sfilt%20fl=store}&amp;amp;qt=standard&amp;amp;pt=44.9369054,-91.3929348&amp;amp;d=196&amp;amp;sort=hsin%286371,&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;,store,vector%2844.9369054,-91.3929348%29%29%20asc
&lt;/span&gt;
Note: 196 km is right

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12913493" author="gsingers" created="Wed, 22 Sep 2010 10:36:47 +0000"  >&lt;p&gt;Couple of things:&lt;/p&gt;

&lt;p&gt;1. I did find some other errors around radians, etc.  I will work to fix today.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Although extending the 45 degree out would be a conservative estimate. And since we usually sort by distance asc, those extra points would be in the result set but at the end of the list. (this is an improvement - again not at good as ellipses).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This FieldType is going to be implemented to be a bounding box around a circle of a radius specified by the passed in distance, which seems to be what most tools do, at least as one way of doing it.  If you want, pick your distance based on the max distance of an ellipse or you can override LatLonType.createSpatialQuery to do so in your own FieldType.  Naturally, this will overselect, but this bounding box stuff is meant to be a filter, like you said.  You can then sort by distance later.  &lt;/p&gt;</comment>
                            <comment id="12913567" author="billnbell" created="Wed, 22 Sep 2010 14:25:42 +0000"  >&lt;p&gt;Grant: Did you see my patch? It appears to work pretty well. I implemented the solution for you.&lt;/p&gt;

&lt;p&gt;One idea: it might be interesting to pass vector(lat,long) as an optional parameters to sfilt ur, ll if we continue using the box. I can see it pretty useful for google maps (to limit the results based on the map size).&lt;/p&gt;

&lt;p&gt;Bill&lt;/p&gt;</comment>
                            <comment id="12913572" author="billnbell" created="Wed, 22 Sep 2010 14:32:29 +0000"  >&lt;p&gt;Another reference:&lt;/p&gt;

&lt;p&gt;I like the pointInPolygon() idea from Microsoft. I do not like that they don&apos;t have a short-cut to reduce the shapes like what we have implemented. But their looping to make sure the distance is being satisfied is good.... See below.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://msdn.microsoft.com/en-us/library/cc451895.aspx&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://msdn.microsoft.com/en-us/library/cc451895.aspx&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;As follow-up, I would take my patch apply it, and then loop through the results to limit by hsin() distance to make sure the results are not on the 45 degree.... I also would make this 2nd step optional, since it slows things down, and for most applications they don&apos;t need to be that precise. (SInce you order by hsin() desc - the large distances if there are any will be at the bottom and inconsequential).&lt;/p&gt;</comment>
                            <comment id="12913573" author="gsingers" created="Wed, 22 Sep 2010 14:32:32 +0000"  >&lt;p&gt;Here&apos;s a patch that puts in the east/west, north/south bounding box, which seems to be what PostGIS offers.  It passes Bill&apos;s example at the top and I put in other tests.  I refactored some of the DistanceUtils to have some other useful methods.  I think I finally got all my degrees/radians straightened out, too.&lt;/p&gt;</comment>
                            <comment id="12913577" author="gsingers" created="Wed, 22 Sep 2010 14:34:36 +0000"  >&lt;p&gt;Hi Bill,&lt;/p&gt;

&lt;p&gt;Sorry, yeah, I did see your patch, but was almost done w/ what I had at that point.  Keep in mind that the approach is meant to be a rough cut for filtering, as it is not 100% accurate.  It is expected that most people would filter based on these range queries, and then do other things to do exact distances later in terms of scoring and sorting.  I will document this on the Wiki.&lt;/p&gt;</comment>
                            <comment id="12914014" author="gsingers" created="Thu, 23 Sep 2010 12:51:01 +0000"  >&lt;p&gt;Committed to trunk and 3.x&lt;/p&gt;</comment>
                            <comment id="12915239" author="simonr" created="Mon, 27 Sep 2010 08:38:41 +0000"  >&lt;p&gt;Is there possible now to use a current Solr build (nightly) to solve this problem: find all points (using index) in radius of R km on earth?&lt;/p&gt;

&lt;p&gt;If so, I&apos;m more than willing to test this for you guys....&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="13013177" author="gsingers" created="Wed, 30 Mar 2011 15:45:47 +0000"  >&lt;p&gt;Bulk close for 3.1.0 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12440848">SOLR-1568</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12455222" name="Distance.diff" size="2009" author="billnbell" created="Wed, 22 Sep 2010 03:42:20 +0000"/>
                            <attachment id="12455269" name="SOLR-2125.patch" size="16514" author="gsingers" created="Wed, 22 Sep 2010 14:32:32 +0000"/>
                            <attachment id="12455200" name="solrspatial.xlsx" size="10275" author="billnbell" created="Tue, 21 Sep 2010 22:37:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5382</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 34 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i03mnr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>19104</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>