<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:23:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-2623] Solr JMX MBeans do not survive core reloads</title>
                <link>https://issues.apache.org/jira/browse/SOLR-2623</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Solr JMX MBeans do not survive core reloads&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;&quot;Steps to reproduce&quot;&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;sh&amp;gt; cd example
sh&amp;gt; vi multicore/core0/conf/solrconfig.xml # enable jmx
sh&amp;gt; java -Dcom.sun.management.jmxremote -Dsolr.solr.home=multicore -jar start.jar
sh&amp;gt; echo &apos;open 8842 # 8842 is java pid
&amp;gt; domain solr/core0
&amp;gt; beans
&amp;gt; &apos; | java -jar jmxterm-1.0-alpha-4-uber.jar
....
solr/core0:id=core0,type=core
solr/core0:id=org.apache.solr.handler.StandardRequestHandler,type=org.apache.solr.handler.StandardRequestHandler
solr/core0:id=org.apache.solr.handler.StandardRequestHandler,type=standard
solr/core0:id=org.apache.solr.handler.XmlUpdateRequestHandler,type=/update
solr/core0:id=org.apache.solr.handler.XmlUpdateRequestHandler,type=org.apache.solr.handler.XmlUpdateRequestHandler
...
solr/core0:id=org.apache.solr.search.SolrIndexSearcher,type=searcher
solr/core0:id=org.apache.solr.update.DirectUpdateHandler2,type=updateHandler
sh&amp;gt; curl &apos;http://localhost:8983/solr/admin/cores?action=RELOAD&amp;amp;core=core0&apos;
sh&amp;gt; echo &apos;open 8842 # 8842 is java pid
&amp;gt; domain solr/core0
&amp;gt; beans
&amp;gt; &apos; | java -jar jmxterm-1.0-alpha-4-uber.jar
# there&apos;s only one bean left after Solr core reload
solr/core0:id=org.apache.solr.search.SolrIndexSearcher,type=Searcher@2e831a91 main
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The root cause of this is Solr core reload behavior:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;create new core (which overwrites existing registered MBeans)&lt;/li&gt;
	&lt;li&gt;register new core and close old one (we remove/un-register MBeans on oldCore.close)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The correct sequence is:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;unregister MBeans from old core&lt;/li&gt;
	&lt;li&gt;create and register new core&lt;/li&gt;
	&lt;li&gt;close old core without touching MBeans&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="12511948">SOLR-2623</key>
            <summary>Solr JMX MBeans do not survive core reloads</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shalin">Shalin Shekhar Mangar</assignee>
                                    <reporter username="alexey.serba">Alexey Serba</reporter>
                        <labels>
                    </labels>
                <created>Tue, 28 Jun 2011 03:58:51 +0000</created>
                <updated>Tue, 30 Jul 2013 22:19:37 +0000</updated>
                            <resolved>Wed, 20 Jul 2011 10:20:53 +0000</resolved>
                                    <version>1.4</version>
                    <version>1.4.1</version>
                    <version>3.1</version>
                    <version>3.2</version>
                                    <fixVersion>3.4</fixVersion>
                    <fixVersion>4.0-ALPHA</fixVersion>
                                    <component>multicore</component>
                        <due></due>
                            <votes>4</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13056281" author="alexey" created="Tue, 28 Jun 2011 04:14:17 +0000"  >&lt;p&gt;Related bug report in solr mailing list - &lt;a href=&quot;http://www.lucidimagination.com/search/document/f109d695b7e5d2ae/weird_issue_with_solr_and_jconsole_jmx&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.lucidimagination.com/search/document/f109d695b7e5d2ae/weird_issue_with_solr_and_jconsole_jmx&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13056295" author="alexey" created="Tue, 28 Jun 2011 04:49:22 +0000"  >&lt;p&gt;Added test&lt;/p&gt;</comment>
                            <comment id="13056299" author="alexey" created="Tue, 28 Jun 2011 04:50:42 +0000"  >&lt;p&gt;Test + fix&lt;/p&gt;</comment>
                            <comment id="13057169" author="shalinmangar" created="Wed, 29 Jun 2011 11:25:11 +0000"  >&lt;p&gt;Thanks for reporting this Alexey. I think the right way to fix it would be to modify the JmxMonitoredMap. Right now, the unregister method checks if a given key is registered with the server and if so, unregisters it. On a core reload, the key is same but the bean instance is different so all keys are unregistered.&lt;/p&gt;

&lt;p&gt;We can modify the SolrDynamicMBean and put the parent core&apos;s hashCode as an extra attribute. Then in the unregister method, remove the mbean from the server after checking if the mbean&apos;s hashCode attribute has the same value.&lt;/p&gt;</comment>
                            <comment id="13058112" author="hossman" created="Thu, 30 Jun 2011 22:32:25 +0000"  >&lt;p&gt;Alexey: at first glance, i think i would prefer Shalin&apos;s suggestion over your patch.  &lt;/p&gt;

&lt;p&gt;My main hesitation about your approach is the parameterized close method &amp;#8211; If we really go that route i&apos;d much rather see something like a &quot;SolrCore.preCloseToReleaesResources()&quot; method.  But more fundementally, if we unregister the MBeans before creating the new core, there is a window of time when the old core is responding to requests, but can&apos;t be monitored (and if anything goes wrong with creating the new core, the old one will continue to handle requests indefinitely but be totally unmonitorable.&lt;/p&gt;

&lt;p&gt;That said: i suspect the fix might even be easier then what Shalin proposed (which would require making SolrCore passing itself into the JmxMonitoredMap) ... can&apos;t we essentially change JmxMonitoredMap.unregsiter(String,SolrInfoMBean) to have psuedo code like this..&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (server.isRegistered(name)) {
  MBean existing = server.getMBean(name)
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (existing intsanceof SolrDynamicMBean &amp;amp;&amp;amp; 
      existing.getSolrInfoMBean() == &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.get(name)) {
    server.unregisterMBean(name);
  } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
     &lt;span class=&quot;code-comment&quot;&gt;// :NOOP: MBean is not ours
&lt;/span&gt;  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;...adding a package protected SolrDynamicMBean.getSolrInfoMBean() seems less invasive then passing the SolrCore to another class&lt;/p&gt;</comment>
                            <comment id="13058461" author="shalinmangar" created="Fri, 1 Jul 2011 09:58:26 +0000"  >&lt;p&gt;Hoss, I wish there was a way to do just that. I looked and looked but couldn&apos;t find it. The JMX API is really screwed up. Once you send in a MBean, apparently you can&apos;t get it out again. I&apos;d be interested if anyone knew of a way to do that.&lt;/p&gt;</comment>
                            <comment id="13058626" author="hossman" created="Fri, 1 Jul 2011 16:29:34 +0000"  >&lt;p&gt;Grr... right, right.   ObjectInstance != MBean.&lt;/p&gt;</comment>
                            <comment id="13061190" author="shalinmangar" created="Thu, 7 Jul 2011 10:28:22 +0000"  >&lt;p&gt;There&apos;s another bug with core reload that I found while running Alexey&apos;s test. Suppose there&apos;s only one core with name &quot;X&quot; and you reload &quot;X&quot;, it then becomes registered with &quot;&quot; as the core name. So all your jmx monitoring is now useless because the key names have changed.&lt;/p&gt;</comment>
                            <comment id="13061233" author="shalinmangar" created="Thu, 7 Jul 2011 11:58:09 +0000"  >&lt;p&gt;Here&apos;s a patch which fixes the issue. I&apos;ve reused Alexey&apos;s tests with the solution I proposed earlier.&lt;/p&gt;

&lt;p&gt;The problem with the core name changing across reloads is something we can address in another issue.&lt;/p&gt;</comment>
                            <comment id="13063798" author="shalinmangar" created="Tue, 12 Jul 2011 10:02:29 +0000"  >&lt;p&gt;Patch updated to trunk.&lt;/p&gt;

&lt;p&gt;I was mistaken about the core name changing on reload.&lt;/p&gt;

&lt;p&gt;I&apos;ll commit this shortly.&lt;/p&gt;

&lt;p&gt;However, regardless of what name you specify in the solr.xml, the default core&apos;s name is always an empty string. Is this intentional?&lt;/p&gt;</comment>
                            <comment id="13063803" author="shalinmangar" created="Tue, 12 Jul 2011 10:24:45 +0000"  >&lt;p&gt;Patch for branch 3x&lt;/p&gt;</comment>
                            <comment id="13063805" author="shalinmangar" created="Tue, 12 Jul 2011 10:28:28 +0000"  >&lt;p&gt;Committed revision 1145518 on trunk and 1145527 on branch_3x&lt;/p&gt;</comment>
                            <comment id="13063810" author="alexey" created="Tue, 12 Jul 2011 10:40:41 +0000"  >&lt;blockquote&gt;&lt;p&gt;However, regardless of what name you specify in the solr.xml, the default core&apos;s name is always an empty string. Is this intentional?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes, I guess this is part of default core name normalization. I&apos;ve noticed the same problem with JMX domain &quot;solr/&quot; (empty collection name) after core reload, but I believe I fixed that problem in my patch.&lt;/p&gt;</comment>
                            <comment id="13063816" author="shalinmangar" created="Tue, 12 Jul 2011 11:00:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;ve noticed the same problem with JMX domain &quot;solr/&quot; (empty collection name) after core reload, but I believe I fixed that problem in my patch.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I removed that part from your patch because I was not sure of its consequences. Also on reload, it was going back to an empty string. I used to think that in 4.0, the default core would be registered with both the original name as well as empty string but it is not so. We should fix it but that belongs to a separate issue.&lt;/p&gt;</comment>
                            <comment id="13063829" author="markrmiller@gmail.com" created="Tue, 12 Jul 2011 11:36:04 +0000"  >&lt;blockquote&gt;&lt;p&gt;Is this intentional?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Its how noble and I first set things up if I remember right - I&apos;ve wanted to address it since as it has a few not nice side affects - have never gotten around to it though.&lt;/p&gt;</comment>
                            <comment id="13065915" author="steve_rowe" created="Fri, 15 Jul 2011 13:23:15 +0000"  >&lt;p&gt;Hi Shalin,&lt;/p&gt;

&lt;p&gt;The new test you added has never succeeded under Maven - here&apos;s the first failure:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://builds.apache.org/job/Lucene-Solr-Maven-3.x/178/testReport/junit/org.apache.solr.core/TestJmxIntegration/testJmxOnCoreReload/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Lucene-Solr-Maven-3.x/178/testReport/junit/org.apache.solr.core/TestJmxIntegration/testJmxOnCoreReload/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Unlike the Ant build, the Maven build copies resources over to solr/build/, and for the Solr core+solrj tests (they run together under Maven), this includes &lt;tt&gt;core/src/test-files/&lt;/tt&gt;, &lt;tt&gt;test-framework/src/test-files/&lt;/tt&gt;, and &lt;tt&gt;solrj/src/test-files/&lt;/tt&gt;, so the environment is somewhat different than under Ant.&lt;/p&gt;

&lt;p&gt;I took a quick look at the code and I don&apos;t understand what&apos;s happening - do you?  The file that can&apos;t be found &lt;tt&gt;solr/solr/conf/solrconfig.xml&lt;/tt&gt; is instead located at &lt;tt&gt;solr/conf/solrconfig.xml&lt;/tt&gt;, so it looks like an extra &lt;tt&gt;solr/&lt;/tt&gt; is being prepended for some reason?&lt;/p&gt;</comment>
                            <comment id="13065917" author="steve_rowe" created="Fri, 15 Jul 2011 13:26:20 +0000"  >&lt;blockquote&gt;&lt;p&gt;The new test you added has never succeeded under Maven &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s incorrect - the new test has never succeeded under Maven &lt;b&gt;on branch_3x&lt;/b&gt;.  On trunk, it succeeds.  Which makes this failure even stranger...&lt;/p&gt;</comment>
                            <comment id="13066532" author="steve_rowe" created="Sat, 16 Jul 2011 20:57:40 +0000"  >&lt;blockquote&gt;&lt;p&gt;the new test has never succeeded under Maven on branch_3x. On trunk, it succeeds. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It failed today on the Jenkins trunk Maven build, so I guess it&apos;s not so strange: &lt;a href=&quot;https://builds.apache.org/job/Lucene-Solr-Maven-trunk/189/testReport/junit/org.apache.solr.core/TestJmxIntegration/testJmxOnCoreReload/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Lucene-Solr-Maven-trunk/189/testReport/junit/org.apache.solr.core/TestJmxIntegration/testJmxOnCoreReload/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I can cause this to fail under IntelliJ if I set the working directory to the location where all the resources are copied to.  That is, if SolrTestCaseJ4.getFile() finds &lt;tt&gt;solr/conf/&lt;/tt&gt; in the current directory, solr home is set to &lt;tt&gt;./solr/solr/&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="13066549" author="steve_rowe" created="Sat, 16 Jul 2011 22:41:47 +0000"  >&lt;p&gt;The Maven build problem should be fixed now: &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3323&quot; title=&quot;Maven build: Junit CWD being the same as the test output directory doesn&amp;#39;t always work&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LUCENE-3323&quot;&gt;&lt;del&gt;LUCENE-3323&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13068226" author="shalinmangar" created="Wed, 20 Jul 2011 08:42:24 +0000"  >&lt;p&gt;The test has problems when run in parallel.&lt;br/&gt;
Also, the code was not merged correctly in branch_3x.&lt;/p&gt;</comment>
                            <comment id="13068243" author="shalinmangar" created="Wed, 20 Jul 2011 09:43:34 +0000"  >&lt;p&gt;Fixed SolrDynamicMBean.getAttribute to support reading coreHashCode.&lt;/p&gt;

&lt;p&gt;Fixed (and simplified) test to compare registered mbeans with info registry size. Comparing number of mbeans between core reloads is flawed because when tests run in parallel, mbeans from multiple tests can be registered in the same mbean server.&lt;/p&gt;</comment>
                            <comment id="13068247" author="shalinmangar" created="Wed, 20 Jul 2011 09:47:56 +0000"  >&lt;p&gt;Fixed tests for trunk&lt;/p&gt;</comment>
                            <comment id="13068262" author="shalinmangar" created="Wed, 20 Jul 2011 10:20:53 +0000"  >&lt;p&gt;Committed revision 1148681 on trunk and 1148683 on branch_3x.&lt;/p&gt;</comment>
                            <comment id="13106224" author="rcmuir" created="Fri, 16 Sep 2011 14:48:53 +0000"  >&lt;p&gt;bulk close for 3.4&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12598347">SOLR-3615</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12486164" name="SOLR-2623-branch3x.patch" size="5101" author="shalin" created="Tue, 12 Jul 2011 10:24:45 +0000"/>
                            <attachment id="12487128" name="SOLR-2623-fixtest-branch_3x.patch" size="3745" author="shalin" created="Wed, 20 Jul 2011 09:43:34 +0000"/>
                            <attachment id="12487130" name="SOLR-2623-testfix-trunk.patch" size="7983" author="shalin" created="Wed, 20 Jul 2011 09:47:56 +0000"/>
                            <attachment id="12486161" name="SOLR-2623.patch" size="7783" author="shalin" created="Tue, 12 Jul 2011 10:02:28 +0000"/>
                            <attachment id="12485574" name="SOLR-2623.patch" size="7708" author="shalin" created="Thu, 7 Jul 2011 11:58:09 +0000"/>
                            <attachment id="12484388" name="SOLR-2623.patch" size="5156" author="alexey.serba" created="Tue, 28 Jun 2011 04:51:04 +0000"/>
                            <attachment id="12484387" name="SOLR-2623.patch" size="5156" author="alexey.serba" created="Tue, 28 Jun 2011 04:50:42 +0000"/>
                            <attachment id="12484384" name="SOLR-2623.patch" size="3637" author="alexey.serba" created="Tue, 28 Jun 2011 04:49:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4924</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 10 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i03jmv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>18614</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>