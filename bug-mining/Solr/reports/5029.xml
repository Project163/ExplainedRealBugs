<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:58:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-16751] ClusterState.collectionFromObjects() stores copy of shards in DocCollection.getProperties()</title>
                <link>https://issues.apache.org/jira/browse/SOLR-16751</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;The way a &lt;tt&gt;DocCollection&lt;/tt&gt; is created by &lt;tt&gt;ClusterState.collectionFromObjects()&lt;/tt&gt; ( ie: &lt;tt&gt;ClusterState&lt;/tt&gt; is read from a JSON payload &#8211; such as &lt;tt&gt;state.json&lt;/tt&gt; ) a copy of the original &lt;tt&gt;&quot;shards&quot;&lt;/tt&gt; mappings is left in the &lt;tt&gt;props&lt;/tt&gt; argument (where it&apos;s carried around in &lt;tt&gt;DocCollection.getProperties()&lt;/tt&gt; ) in addition to the (correct) &lt;tt&gt;slices&lt;/tt&gt; argument (which is used to build &lt;tt&gt;DocCollection.getSlices()&lt;/tt&gt; )&lt;/p&gt;

&lt;p&gt;This is due to the following lines of code, which AFAICT should have been done in reverse order...&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      props = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&amp;gt;(objs);
      objs.remove(CollectionStateProps.SHARDS);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This bug seems to have existed for a while, but seems to have slipped under the radar since nothing has any reason to be looking for a &lt;tt&gt;&quot;shards&quot;&lt;/tt&gt; key in &lt;tt&gt;DocCollection.getProperties()&lt;/tt&gt; .&lt;/p&gt;

&lt;p&gt;Recently however, noble committed 2ac7ed29563a33d9f9a31737996a1d4cfb0fca0d which changed the serialization logic for &lt;tt&gt;DocCollection&lt;/tt&gt; to eliminate a temporary map...&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;-    LinkedHashMap&amp;lt;String, Object&amp;gt; all = CollectionUtil.newLinkedHashMap(slices.size() + 1);
-    all.putAll(propMap);
-    all.put(CollectionStateProps.SHARDS, slices);
-    jsonWriter.write(all);
+    jsonWriter.write(
+        (MapWriter)
+            ew -&amp;gt; {
+              propMap.forEach(ew.getBiConsumer());
+              ew.put(CollectionStateProps.SHARDS, slices);
+            });
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;... so now, instead of an &lt;tt&gt;all&lt;/tt&gt; Map where the &lt;tt&gt;&quot;shards&quot;&lt;/tt&gt; key from &lt;tt&gt;propMap&lt;/tt&gt; being (correctly) overridden by &lt;tt&gt;slices&lt;/tt&gt; and then serialized, now the JSON output contains two entries with the &lt;tt&gt;&quot;shards&quot;&lt;/tt&gt; key.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13532958">SOLR-16751</key>
            <summary>ClusterState.collectionFromObjects() stores copy of shards in DocCollection.getProperties()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Chris M. Hostetter</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Tue, 18 Apr 2023 00:22:45 +0000</created>
                <updated>Fri, 17 Oct 2025 20:05:51 +0000</updated>
                            <resolved>Tue, 18 Apr 2023 18:33:20 +0000</resolved>
                                                    <fixVersion>9.3</fixVersion>
                    <fixVersion>10.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17713325" author="hossman" created="Tue, 18 Apr 2023 00:24:24 +0000"  >&lt;p&gt;I&apos;m not sure why/how this could cause any errors in functionality, since all of the code I found for &lt;em&gt;consuming&lt;/em&gt; &lt;tt&gt;state.json&lt;/tt&gt; seemed to be doing a &quot;last key wins&quot; when parsing the JSON, and once a &lt;tt&gt;DocCollection&lt;/tt&gt; exists, I &lt;em&gt;think&lt;/em&gt; all the consumers are correctly dealing with &lt;tt&gt;DocCollection.getSlices()&lt;/tt&gt; , and never looking at (or trying to mutate) a &lt;tt&gt;&quot;shards&quot;&lt;/tt&gt; key in &lt;tt&gt;DocCollection.getProperties()&lt;/tt&gt; ...&lt;/p&gt;

&lt;p&gt;...and yet...&lt;/p&gt;

&lt;p&gt;We have seen a big spike in recent jenkins failures (with seeds I haven&apos;t been able to reproduce) in &lt;tt&gt;SplitShardWithNodeRoleTest.testSolrClusterWithNodeRoleWithPull&lt;/tt&gt; &#8211; the timing of which seems to line up with GIT:2ac7ed29563a33d9f9a31737996a1d4cfb0fca0d.&lt;/p&gt;

&lt;p&gt;If i&apos;m right, we should see a big drop in failures from &lt;tt&gt;SplitShardWithNodeRoleTest&lt;/tt&gt; if we commit the attached patch.&lt;/p&gt;</comment>
                            <comment id="17713326" author="hossman" created="Tue, 18 Apr 2023 00:25:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noblepaul&quot; class=&quot;user-hover&quot; rel=&quot;noblepaul&quot;&gt;noblepaul&lt;/a&gt; - please sanity check me here.&lt;/p&gt;</comment>
                            <comment id="17713579" author="noble.paul" created="Tue, 18 Apr 2023 12:57:51 +0000"  >&lt;p&gt;this fix is correct. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman&quot; class=&quot;user-hover&quot; rel=&quot;hossman&quot;&gt;hossman&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17713706" author="jira-bot" created="Tue, 18 Apr 2023 18:01:16 +0000"  >&lt;p&gt;Commit 501f69e72332cfbce98716be73b3913f1dcf645a in solr&apos;s branch refs/heads/main from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=501f69e7233&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=501f69e7233&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16751&quot; title=&quot;ClusterState.collectionFromObjects() stores copy of shards in DocCollection.getProperties()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16751&quot;&gt;&lt;del&gt;SOLR-16751&lt;/del&gt;&lt;/a&gt;: ensure &apos;shards&apos; list isn&apos;t included in props when creating DocCollection from JSON&lt;/p&gt;</comment>
                            <comment id="17713712" author="jira-bot" created="Tue, 18 Apr 2023 18:31:45 +0000"  >&lt;p&gt;Commit 3c44aa1e0ed88c04fef4f6e8a88d933b9af790bd in solr&apos;s branch refs/heads/branch_9x from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=3c44aa1e0ed&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=3c44aa1e0ed&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16751&quot; title=&quot;ClusterState.collectionFromObjects() stores copy of shards in DocCollection.getProperties()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16751&quot;&gt;&lt;del&gt;SOLR-16751&lt;/del&gt;&lt;/a&gt;: ensure &apos;shards&apos; list isn&apos;t included in props when creating DocCollection from JSON&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 501f69e72332cfbce98716be73b3913f1dcf645a)&lt;/p&gt;</comment>
                            <comment id="17713713" author="hossman" created="Tue, 18 Apr 2023 18:33:20 +0000"  >&lt;p&gt;I&apos;ve committed &amp;amp; backported the fix, since we know it&apos;s correct - but while running &lt;tt&gt;gradle check&lt;/tt&gt; locally i was still able to cause the &lt;tt&gt;SplitShardWithNodeRoleTest.testSolrClusterWithNodeRoleWithPull&lt;/tt&gt; failure - so my hypotosis was clearly wrong.&lt;/p&gt;

&lt;p&gt;i&apos;ll open a new Jira for that.&lt;/p&gt;</comment>
                            <comment id="17745745" author="houston" created="Fri, 21 Jul 2023 20:40:34 +0000"  >&lt;p&gt;Closing after the 9.3.0 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13543562">SOLR-16891</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13533096">SOLR-16753</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13057344" name="SOLR-16751.patch" size="1844" author="hossman" created="Tue, 18 Apr 2023 00:23:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 16 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1hcds:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>