<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:19:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-10054] Core swapping doesn&apos;t work with new metrics changes in place</title>
                <link>https://issues.apache.org/jira/browse/SOLR-10054</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;The new 6.4.0 version includes some significant changes having to do with metrics.  These changes have broken core swapping.  Will attach some screenshots.&lt;/p&gt;

&lt;p&gt;For the screenshots that I will attach, I started Solr directly from the 6.4.0 download on Windows 7 (bin\solr start).  Then I created a &quot;foo&quot; core and a &quot;bar&quot; core, each from a different configset, using the bin\solr command.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Screenshot 1: you can see the two cores in CoreAdmin.&lt;/li&gt;
	&lt;li&gt;Screenshot 2: Attempting to swap the cores, an error message appears about a metric already existing for the ping handler.&lt;/li&gt;
	&lt;li&gt;Screenshot 3: Clicking somewhere else and then back to CoreAdmin shows that both cores have the same name &amp;#8211; bar.&lt;/li&gt;
	&lt;li&gt;If Solr is stopped and then started back up, the admin UI looks like screenshot 1 again &amp;#8211; the change that caused two cores with the same name only took place within the running Solr and did not update core.properties files.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13039023">SOLR-10054</key>
            <summary>Core swapping doesn&apos;t work with new metrics changes in place</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ab">Andrzej Bialecki</assignee>
                                    <reporter username="elyograg">Shawn Heisey</reporter>
                        <labels>
                    </labels>
                <created>Mon, 30 Jan 2017 22:31:03 +0000</created>
                <updated>Sat, 8 Jun 2019 15:29:09 +0000</updated>
                            <resolved>Wed, 1 Feb 2017 16:50:48 +0000</resolved>
                                    <version>6.4</version>
                    <version>7.0</version>
                                    <fixVersion>6.4.1</fixVersion>
                    <fixVersion>7.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15846056" author="elyograg" created="Mon, 30 Jan 2017 22:31:44 +0000"  >&lt;p&gt;Attaching screenshots.&lt;/p&gt;</comment>
                            <comment id="15846064" author="elyograg" created="Mon, 30 Jan 2017 22:36:39 +0000"  >&lt;p&gt;The initial problem report came in via the #solr IRC channel.&lt;/p&gt;</comment>
                            <comment id="15846130" author="elyograg" created="Mon, 30 Jan 2017 23:24:05 +0000"  >&lt;p&gt;The error message visible in the admin UI is &quot;A metric named ADMIN./admin/ping.requestTimes already exists&quot;&lt;/p&gt;

&lt;p&gt;Below is the full ERROR entry from the logfile when the core swap is attempted.  This is from the binary 6.4.0 release:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2017-01-30 22:18:20.746 ERROR (qtp1769597131-22) [   ] o.a.s.h.RequestHandlerBase java.lang.IllegalArgumentException: A metric named ADMIN./admin/ping.requestTimes already exists
	at com.codahale.metrics.MetricRegistry.register(MetricRegistry.java:91)
	at com.codahale.metrics.MetricRegistry.registerAll(MetricRegistry.java:389)
	at com.codahale.metrics.MetricRegistry.registerAll(MetricRegistry.java:104)
	at org.apache.solr.metrics.SolrMetricManager.moveMetrics(SolrMetricManager.java:227)
	at org.apache.solr.metrics.SolrCoreMetricManager.afterCoreSetName(SolrCoreMetricManager.java:76)
	at org.apache.solr.core.SolrCore.setName(SolrCore.java:423)
	at org.apache.solr.core.SolrCores.swap(SolrCores.java:243)
	at org.apache.solr.core.CoreContainer.swap(CoreContainer.java:1012)
	at org.apache.solr.handler.admin.CoreAdminOperation.lambda$static$3(CoreAdminOperation.java:122)
	at org.apache.solr.handler.admin.CoreAdminOperation.execute(CoreAdminOperation.java:377)
	at org.apache.solr.handler.admin.CoreAdminHandler$CallInfo.call(CoreAdminHandler.java:379)
	at org.apache.solr.handler.admin.CoreAdminHandler.handleRequestBody(CoreAdminHandler.java:165)
	at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:166)
	at org.apache.solr.servlet.HttpSolrCall.handleAdminRequest(HttpSolrCall.java:664)
	at org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:445)
	at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:345)
	at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:296)
	at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1691)
	at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:582)
	at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:143)
	at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:548)
	at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:226)
	at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1180)
	at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:512)
	at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)
	at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1112)
	at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)
	at org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:213)
	at org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:119)
	at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:134)
	at org.eclipse.jetty.server.Server.handle(Server.java:534)
	at org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:320)
	at org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:251)
	at org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:273)
	at org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:95)
	at org.eclipse.jetty.io.SelectChannelEndPoint$2.run(SelectChannelEndPoint.java:93)
	at org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.executeProduceConsume(ExecuteProduceConsume.java:303)
	at org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.produceConsume(ExecuteProduceConsume.java:148)
	at org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.run(ExecuteProduceConsume.java:136)
	at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:671)
	at org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:589)
	at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15846150" author="elyograg" created="Mon, 30 Jan 2017 23:37:05 +0000"  >&lt;p&gt;I see that there is &quot;TestCoreAdmin&quot; but the text &quot;swap&quot; does not appear in that test.  I cannot find any evidence that core swapping is tested by any Solr tests at all.&lt;/p&gt;</comment>
                            <comment id="15847292" author="ab" created="Tue, 31 Jan 2017 18:53:54 +0000"  >&lt;p&gt;Yeah, we definitely need more test coverage of such fundamental functionality... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;The issue turned out to be less trivial than I thought. When rename or swap core is requested the metrics subsystem needs to preserve metrics that are already accumulated under the old core name (we use separate registries per core). Since metrics&apos; initialization occurs when core is constructed we can&apos;t easily re-register all &lt;tt&gt;SolrMetricProducer&lt;/tt&gt;-s in the new registry, so the existing code tried to move actual &lt;tt&gt;Metric&lt;/tt&gt; instances from the old to the new repository. The problem was that more or less the same metric names already existed in the target repository, because they were registered there by the other core&apos;s producers - and vice versa.&lt;/p&gt;

&lt;p&gt;The solution was to implement a dedicated operation &lt;tt&gt;SolrMetricManager.swap(name1, name2)&lt;/tt&gt; that knows how to atomically (or rather under proper locking) swap these two registries, without moving metric instances between registries.&lt;/p&gt;

&lt;p&gt;I also added &lt;tt&gt;TestCoreAdmin.testCoreSwap&lt;/tt&gt; and &lt;tt&gt;testValidCoreRename&lt;/tt&gt;, and extended &lt;tt&gt;CoreAdminRequest&lt;/tt&gt; to support the swap operation.&lt;/p&gt;</comment>
                            <comment id="15847314" author="ab" created="Tue, 31 Jan 2017 19:00:58 +0000"  >&lt;p&gt;Patch relative to branch_6x.&lt;/p&gt;</comment>
                            <comment id="15848134" author="ab" created="Wed, 1 Feb 2017 08:43:05 +0000"  >&lt;p&gt;Updated patch. All tests are passing, I think this is ready.&lt;/p&gt;</comment>
                            <comment id="15848561" author="jira-bot" created="Wed, 1 Feb 2017 15:56:38 +0000"  >&lt;p&gt;Commit 8299378eab3282e4dcb14b92645a4f1d214f13cc in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=8299378&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=8299378&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10054&quot; title=&quot;Core swapping doesn&amp;#39;t work with new metrics changes in place&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10054&quot;&gt;&lt;del&gt;SOLR-10054&lt;/del&gt;&lt;/a&gt;: Core swapping doesn&apos;t work with new metrics changes in place.&lt;/p&gt;</comment>
                            <comment id="15848616" author="jira-bot" created="Wed, 1 Feb 2017 16:50:24 +0000"  >&lt;p&gt;Commit bef725aeefea0ba34bdf9c74b8e67376377e8983 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=bef725a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=bef725a&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10054&quot; title=&quot;Core swapping doesn&amp;#39;t work with new metrics changes in place&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10054&quot;&gt;&lt;del&gt;SOLR-10054&lt;/del&gt;&lt;/a&gt;: Core swapping doesn&apos;t work with new metrics changes in place.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12850384" name="SOLR-10054.patch" size="19785" author="ab" created="Wed, 1 Feb 2017 08:48:16 +0000"/>
                            <attachment id="12850288" name="SOLR-10054.patch" size="18776" author="ab" created="Tue, 31 Jan 2017 19:00:58 +0000"/>
                            <attachment id="12850068" name="solr64coreswap1.png" size="109841" author="elyograg" created="Mon, 30 Jan 2017 22:31:44 +0000"/>
                            <attachment id="12850069" name="solr64coreswap2.png" size="114934" author="elyograg" created="Mon, 30 Jan 2017 22:31:44 +0000"/>
                            <attachment id="12850070" name="solr64coreswap3.png" size="106454" author="elyograg" created="Mon, 30 Jan 2017 22:31:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 41 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i39e2f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>