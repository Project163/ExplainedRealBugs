<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:09:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-8280] Schemaless features don&apos;t work reliably with SolrCoreAware sim factory -- example: SchemaSimilarityFactory</title>
                <link>https://issues.apache.org/jira/browse/SOLR-8280</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8271&quot; title=&quot;use SchemaSimilarityFactory as default when no explicit (top level) sim is configured&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8271&quot;&gt;&lt;del&gt;SOLR-8271&lt;/del&gt;&lt;/a&gt; uncovered problems with using SchemaSimilarityFactory + schemaless features.  While the broader problems of SolrCoreAware objects inited after the SolrCore was live have been spun off into &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8311&quot; title=&quot;SolrCoreAware and ResourceLoaderAware lifecyel is fragile - particularly with objects that can be created after SolrCore is live&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8311&quot;&gt;SOLR-8311&lt;/a&gt; this issue focuses on fixing &amp;amp; testing the core problem of ensuring SchemaSimilarityFactory + schemaless features function together.&lt;/p&gt;

&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;original bug report&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;Something about the code path(s) involved in TestCloudSchemaless &amp;amp; ChangedSchemaMergeTest don&apos;t play nicely with a SimilarityFactory that is SolrCoreAware &amp;#8211; notably: SchemaSimilarityFactory.&lt;/p&gt;

&lt;p&gt;I discovered this while trying to implement &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8271&quot; title=&quot;use SchemaSimilarityFactory as default when no explicit (top level) sim is configured&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8271&quot;&gt;&lt;del&gt;SOLR-8271&lt;/del&gt;&lt;/a&gt;, but it can be reproduced trivially by modifying the schema-add-schema-fields-update-processor.xml file used by TestCloudSchemaless (and hardcoded in java schema used by ChangedSchemaMergeTest) to refer to SchemaSimilarityFactory explicitly.  Other cloud tests (such as CollectionReloadTest) or cloud+schemaless (ex: TestCloudManagedSchema) tests don&apos;t seem to demonstrate the same problem.&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12912355">SOLR-8280</key>
            <summary>Schemaless features don&apos;t work reliably with SolrCoreAware sim factory -- example: SchemaSimilarityFactory</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Chris M. Hostetter</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Thu, 12 Nov 2015 00:33:32 +0000</created>
                <updated>Tue, 26 Sep 2023 12:44:20 +0000</updated>
                            <resolved>Thu, 19 Nov 2015 18:03:10 +0000</resolved>
                                    <version>5.0</version>
                                    <fixVersion>5.4</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15001410" author="hossman" created="Thu, 12 Nov 2015 00:35:37 +0000"  >
&lt;p&gt;With the attached patch, it&apos;s trivial to trigger a suite failure in TestCloudSchemaless, although lots of other cloud related tests (using schema.xml via AbstractFullDistribZkTestBase) function just fine.&lt;/p&gt;

&lt;p&gt;(NOTE: there are in fact a handful of other test failures with this patch, but they exist due to specific Sim related assumptions in those tests vs the general change of schema.xml to using SchemaSimilarityFactory ... i included the change to schema.xml in this patch purely as an easy way to demonstrate that most cloud related tests &amp;#8211; even ones using schemaless and/or involving core reloads &amp;#8211; don&apos;t ffreak out the same way as TestCloudSchemaless)&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Quick walk through of the TestCloudSchemaless failure...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ant test  -Dtestcase=TestCloudSchemaless -Dtests.seed=8F1B744FBE000231 -Dtests.slow=true
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The test itself runs fine, and reaches the &lt;tt&gt;SolrTestCaseJ4 ###Ending test&quot; stage&lt;/tt&gt; at which point shutdown begins &amp;#8211; and eventually stalls in the dir factory waiting for directories to close...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   [junit4]   2&amp;gt; 52621 INFO  (TEST-TestCloudSchemaless.test-seed#[E3CE46BC04E096EF]) [n:127.0.0.1:35554_ c:collection1 s:shard2 r:core_node1 x:collection1] o.a.s.c.SolrCore [collection1] Closing main searcher on request.
   [junit4]   2&amp;gt; 52621 INFO  (TEST-TestCloudSchemaless.test-seed#[E3CE46BC04E096EF]) [n:127.0.0.1:35554_ c:collection1 s:shard2 r:core_node1 x:collection1] o.a.s.c.CachingDirectoryFactory Closing NRTCachingDirectoryFactory - 2 directories currently being tracked
   [junit4]   2&amp;gt; 64733 ERROR (TEST-TestCloudSchemaless.test-seed#[E3CE46BC04E096EF]) [n:127.0.0.1:35554_ c:collection1 s:shard2 r:core_node1 x:collection1] o.a.s.c.CachingDirectoryFactory Timeout waiting for all directory ref counts to be released - gave up waiting on CachedDir&amp;lt;&amp;lt;refCount=1;path=/home/hossman/lucene/dev/solr/build/solr-core/test/J0/temp/solr.schema.TestCloudSchemaless_E3CE46BC04E096EF-001/shard-1-001/cores/collection1/data/index;done=false&amp;gt;&amp;gt;
   [junit4]   2&amp;gt; 64733 ERROR (TEST-TestCloudSchemaless.test-seed#[E3CE46BC04E096EF]) [n:127.0.0.1:35554_ c:collection1 s:shard2 r:core_node1 x:collection1] o.a.s.c.CachingDirectoryFactory Error closing directory:org.apache.solr.common.SolrException: Timeout waiting for all directory ref counts to be released - gave up waiting on CachedDir&amp;lt;&amp;lt;refCount=1;path=/home/hossman/lucene/dev/solr/build/solr-core/test/J0/temp/solr.schema.TestCloudSchemaless_E3CE46BC04E096EF-001/shard-1-001/cores/collection1/data/index;done=false&amp;gt;&amp;gt;
   [junit4]   2&amp;gt; 	at org.apache.solr.core.CachingDirectoryFactory.close(CachingDirectoryFactory.java:187)
   [junit4]   2&amp;gt; 	at org.apache.solr.core.SolrCore.close(SolrCore.java:1268)
   [junit4]   2&amp;gt; 	at org.apache.solr.core.SolrCores.close(SolrCores.java:124)
   [junit4]   2&amp;gt; 	at org.apache.solr.core.CoreContainer.shutdown(CoreContainer.java:570)
   [junit4]   2&amp;gt; 	at org.apache.solr.servlet.SolrDispatchFilter.destroy(SolrDispatchFilter.java:172)
   [junit4]   2&amp;gt; 	at org.apache.solr.cloud.ChaosMonkey.stopJettySolrRunner(ChaosMonkey.java:186)
   [junit4]   2&amp;gt; 	at org.apache.solr.cloud.ChaosMonkey.stop(ChaosMonkey.java:518)
   [junit4]   2&amp;gt; 	at org.apache.solr.cloud.AbstractFullDistribZkTestBase.destroyServers(AbstractFullDistribZkTestBase.java:1514)
   [junit4]   2&amp;gt; 	at org.apache.solr.BaseDistributedSearchTestCase$ShardsRepeatRule$ShardsFixedStatement.callStatement(BaseDistributedSearchTestCase.java:964)
   [junit4]   2&amp;gt; 	at org.apache.solr.BaseDistributedSearchTestCase$ShardsRepeatRule$ShardsStatement.evaluate(BaseDistributedSearchTestCase.java:938)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.rules.SystemPropertiesRestoreRule$1.evaluate(SystemPropertiesRestoreRule.java:57)
   [junit4]   2&amp;gt; 	at org.apache.lucene.util.TestRuleSetupTeardownChained$1.evaluate(TestRuleSetupTeardownChained.java:50)
   [junit4]   2&amp;gt; 	at org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:46)
   [junit4]   2&amp;gt; 	at org.apache.lucene.util.TestRuleThreadAndTestName$1.evaluate(TestRuleThreadAndTestName.java:49)
   [junit4]   2&amp;gt; 	at org.apache.lucene.util.TestRuleIgnoreAfterMaxFailures$1.evaluate(TestRuleIgnoreAfterMaxFailures.java:65)
   [junit4]   2&amp;gt; 	at org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:48)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.ThreadLeakControl$StatementRunner.run(ThreadLeakControl.java:367)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.ThreadLeakControl.forkTimeoutingTask(ThreadLeakControl.java:809)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.ThreadLeakControl$3.evaluate(ThreadLeakControl.java:460)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.RandomizedRunner.runSingleTest(RandomizedRunner.java:875)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.RandomizedRunner$5.evaluate(RandomizedRunner.java:777)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.RandomizedRunner$6.evaluate(RandomizedRunner.java:811)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.RandomizedRunner$7.evaluate(RandomizedRunner.java:822)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.rules.SystemPropertiesRestoreRule$1.evaluate(SystemPropertiesRestoreRule.java:57)
   [junit4]   2&amp;gt; 	at org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:46)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)
   [junit4]   2&amp;gt; 	at org.apache.lucene.util.TestRuleStoreClassName$1.evaluate(TestRuleStoreClassName.java:42)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.rules.NoShadowingOrOverridesOnMethodsRule$1.evaluate(NoShadowingOrOverridesOnMethodsRule.java:40)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.rules.NoShadowingOrOverridesOnMethodsRule$1.evaluate(NoShadowingOrOverridesOnMethodsRule.java:40)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)
   [junit4]   2&amp;gt; 	at org.apache.lucene.util.TestRuleAssertionsRequired$1.evaluate(TestRuleAssertionsRequired.java:54)
   [junit4]   2&amp;gt; 	at org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:48)
   [junit4]   2&amp;gt; 	at org.apache.lucene.util.TestRuleIgnoreAfterMaxFailures$1.evaluate(TestRuleIgnoreAfterMaxFailures.java:65)
   [junit4]   2&amp;gt; 	at org.apache.lucene.util.TestRuleIgnoreTestSuites$1.evaluate(TestRuleIgnoreTestSuites.java:55)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.ThreadLeakControl$StatementRunner.run(ThreadLeakControl.java:367)
   [junit4]   2&amp;gt; 	at java.lang.Thread.run(Thread.java:745)
   [junit4]   2&amp;gt; 
   [junit4]   2&amp;gt; 64733 ERROR (TEST-TestCloudSchemaless.test-seed#[E3CE46BC04E096EF]) [n:127.0.0.1:35554_ c:collection1 s:shard2 r:core_node1 x:collection1] o.a.s.c.SolrCore java.lang.AssertionError: 1
   [junit4]   2&amp;gt; 	at org.apache.solr.core.CachingDirectoryFactory.close(CachingDirectoryFactory.java:201)
   [junit4]   2&amp;gt; 	at org.apache.solr.core.SolrCore.close(SolrCore.java:1268)
   [junit4]   2&amp;gt; 	at org.apache.solr.core.SolrCores.close(SolrCores.java:124)
   [junit4]   2&amp;gt; 	at org.apache.solr.core.CoreContainer.shutdown(CoreContainer.java:570)
   [junit4]   2&amp;gt; 	at org.apache.solr.servlet.SolrDispatchFilter.destroy(SolrDispatchFilter.java:172)
   [junit4]   2&amp;gt; 	at org.apache.solr.cloud.ChaosMonkey.stopJettySolrRunner(ChaosMonkey.java:186)
   [junit4]   2&amp;gt; 	at org.apache.solr.cloud.ChaosMonkey.stop(ChaosMonkey.java:518)
   [junit4]   2&amp;gt; 	at org.apache.solr.cloud.AbstractFullDistribZkTestBase.destroyServers(AbstractFullDistribZkTestBase.java:1514)
   [junit4]   2&amp;gt; 	at org.apache.solr.BaseDistributedSearchTestCase$ShardsRepeatRule$ShardsFixedStatement.callStatement(BaseDistributedSearchTestCase.java:964)
   [junit4]   2&amp;gt; 	at org.apache.solr.BaseDistributedSearchTestCase$ShardsRepeatRule$ShardsStatement.evaluate(BaseDistributedSearchTestCase.java:938)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.rules.SystemPropertiesRestoreRule$1.evaluate(SystemPropertiesRestoreRule.java:57)
   [junit4]   2&amp;gt; 	at org.apache.lucene.util.TestRuleSetupTeardownChained$1.evaluate(TestRuleSetupTeardownChained.java:50)
   [junit4]   2&amp;gt; 	at org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:46)
   [junit4]   2&amp;gt; 	at org.apache.lucene.util.TestRuleThreadAndTestName$1.evaluate(TestRuleThreadAndTestName.java:49)
   [junit4]   2&amp;gt; 	at org.apache.lucene.util.TestRuleIgnoreAfterMaxFailures$1.evaluate(TestRuleIgnoreAfterMaxFailures.java:65)
   [junit4]   2&amp;gt; 	at org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:48)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.ThreadLeakControl$StatementRunner.run(ThreadLeakControl.java:367)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.ThreadLeakControl.forkTimeoutingTask(ThreadLeakControl.java:809)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.ThreadLeakControl$3.evaluate(ThreadLeakControl.java:460)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.RandomizedRunner.runSingleTest(RandomizedRunner.java:875)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.RandomizedRunner$5.evaluate(RandomizedRunner.java:777)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.RandomizedRunner$6.evaluate(RandomizedRunner.java:811)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.RandomizedRunner$7.evaluate(RandomizedRunner.java:822)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.rules.SystemPropertiesRestoreRule$1.evaluate(SystemPropertiesRestoreRule.java:57)
   [junit4]   2&amp;gt; 	at org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:46)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)
   [junit4]   2&amp;gt; 	at org.apache.lucene.util.TestRuleStoreClassName$1.evaluate(TestRuleStoreClassName.java:42)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.rules.NoShadowingOrOverridesOnMethodsRule$1.evaluate(NoShadowingOrOverridesOnMethodsRule.java:40)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.rules.NoShadowingOrOverridesOnMethodsRule$1.evaluate(NoShadowingOrOverridesOnMethodsRule.java:40)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)
   [junit4]   2&amp;gt; 	at org.apache.lucene.util.TestRuleAssertionsRequired$1.evaluate(TestRuleAssertionsRequired.java:54)
   [junit4]   2&amp;gt; 	at org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:48)
   [junit4]   2&amp;gt; 	at org.apache.lucene.util.TestRuleIgnoreAfterMaxFailures$1.evaluate(TestRuleIgnoreAfterMaxFailures.java:65)
   [junit4]   2&amp;gt; 	at org.apache.lucene.util.TestRuleIgnoreTestSuites$1.evaluate(TestRuleIgnoreTestSuites.java:55)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)
   [junit4]   2&amp;gt; 	at com.carrotsearch.randomizedtesting.ThreadLeakControl$StatementRunner.run(ThreadLeakControl.java:367)
   [junit4]   2&amp;gt; 	at java.lang.Thread.run(Thread.java:745)
   [junit4]   2&amp;gt; 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;...at that point, things go from bad to worse, as RecoveryThreads kick in (why is the collection attempting to recover it it was deliberaly being shutdown???) but of course that doesn&apos;t turn out well because the CoreContainer&apos;s are all in shutdown mode...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   [junit4]   2&amp;gt; 69727 INFO  (qtp1007998027-153) [n:127.0.0.1:44195_    ] o.a.s.h.a.CoreAdminHandler Going to wait for coreNodeName: core_node8, state: recovering, checkLive: true, onlyIfLeader: true, onlyIfLeaderActive: true
   [junit4]   2&amp;gt; 69727 INFO  (zkCallback-44-thread-2-processing-n:127.0.0.1:42678_) [n:127.0.0.1:42678_    ] o.a.s.c.c.ZkStateReader Updating data for collection1 from 29 to 30 
   [junit4]   2&amp;gt; 69728 INFO  (zkCallback-39-thread-2-processing-n:127.0.0.1:52349_) [n:127.0.0.1:52349_    ] o.a.s.c.c.ZkStateReader Updating data for collection1 from 29 to 30 
   [junit4]   2&amp;gt; 69728 INFO  (qtp1007998027-153) [n:127.0.0.1:44195_    ] o.a.s.h.a.CoreAdminHandler Will wait a max of 183 seconds to see collection1 (shard1 of collection1) have state: recovering
   [junit4]   2&amp;gt; 69728 INFO  (qtp1007998027-153) [n:127.0.0.1:44195_    ] o.a.s.h.a.CoreAdminHandler In WaitForState(recovering): collection=collection1, shard=shard1, thisCore=collection1, leaderDoesNotNeedRecovery=false, isLeader? true, live=true, checkLive=true, currentState=recovering, localState=active, nodeName=127.0.0.1:42678_, coreNodeName=core_node8, onlyIfActiveCheckResult=false, nodeProps: core_node8:{&quot;core&quot;:&quot;collection1&quot;,&quot;base_url&quot;:&quot;http://127.0.0.1:42678&quot;,&quot;node_name&quot;:&quot;127.0.0.1:42678_&quot;,&quot;state&quot;:&quot;recovering&quot;}
   [junit4]   2&amp;gt; 69729 INFO  (qtp1007998027-153) [n:127.0.0.1:44195_    ] o.a.s.h.a.CoreAdminHandler Waited coreNodeName: core_node8, state: recovering, checkLive: true, onlyIfLeader: true for: 0 seconds.
   [junit4]   2&amp;gt; 69729 INFO  (qtp1007998027-153) [n:127.0.0.1:44195_    ] o.a.s.s.SolrDispatchFilter [admin] webapp=null path=/admin/cores params={nodeName=127.0.0.1:42678_&amp;amp;onlyIfLeaderActive=true&amp;amp;core=collection1&amp;amp;coreNodeName=core_node8&amp;amp;action=PREPRECOVERY&amp;amp;checkLive=true&amp;amp;state=recovering&amp;amp;onlyIfLeader=true&amp;amp;wt=javabin&amp;amp;version=2} status=0 QTime=1 
   [junit4] HEARTBEAT J0 PID(17711@tray): 2015-11-11T16:22:31, stalled for 70.2s at: TestCloudSchemaless.test
   [junit4]   2&amp;gt; 72390 INFO  (RecoveryThread-collection1) [n:127.0.0.1:44717_ c:collection1 s:shard3 r:core_node6 x:collection1] o.a.s.c.RecoveryStrategy Starting Replication Recovery.
   [junit4]   2&amp;gt; 72390 INFO  (RecoveryThread-collection1) [n:127.0.0.1:44717_ c:collection1 s:shard3 r:core_node6 x:collection1] o.a.s.c.RecoveryStrategy Attempting to replicate from http://127.0.0.1:54475/collection1/.
   [junit4]   2&amp;gt; 72391 ERROR (qtp1661135858-94) [n:127.0.0.1:54475_    ] o.a.s.s.SolrDispatchFilter Error processing the request. CoreContainer is either not initialized or shutting down.
   [junit4]   2&amp;gt; 72392 WARN  (qtp1661135858-94) [n:127.0.0.1:54475_    ] o.e.j.s.ServletHandler /collection1/update
   [junit4]   2&amp;gt; org.apache.solr.common.SolrException: Error processing the request. CoreContainer is either not initialized or shutting down.
   [junit4]   2&amp;gt; 	at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:187)
   [junit4]   2&amp;gt; 	at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:179)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)
   [junit4]   2&amp;gt; 	at org.apache.solr.client.solrj.embedded.JettySolrRunner$DebugFilter.doFilter(JettySolrRunner.java:109)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.servlets.UserAgentFilter.doFilter(UserAgentFilter.java:83)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.servlets.GzipFilter.doFilter(GzipFilter.java:300)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:585)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:221)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1127)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:515)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1061)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:97)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.server.Server.handle(Server.java:499)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:310)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:257)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.io.AbstractConnection$2.run(AbstractConnection.java:540)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:635)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:555)
   [junit4]   2&amp;gt; 	at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;...and then things &lt;b&gt;really&lt;/b&gt; get weird, as the RecoveryThread starts trying to do replication recovery, and then nodes start complaining that they can&apos;t open a new searcher because SolrCoreAware.inform() was never called on the SimilarityFactory (an assert that exists inside SchemaSimilarityFactory.getSimilarity()) ...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   [junit4]   2&amp;gt; 74329 INFO  (RecoveryThread-collection1) [n:127.0.0.1:52349_ c:collection1 s:shard4 r:core_node7 x:collection1] o.a.s.c.RecoveryStrategy Attempting to replicate from http://127.0.0.1:54695/collection1/.
   [junit4]   2&amp;gt; 74331 INFO  (qtp1972553455-125) [n:127.0.0.1:54695_ c:collection1 s:shard4 r:core_node3 x:collection1] o.a.s.u.UpdateHandler start commit{,optimize=false,openSearcher=false,waitSearcher=true,expungeDeletes=false,softCommit=false,prepareCommit=false}
   [junit4]   2&amp;gt; 74359 INFO  (qtp1972553455-125) [n:127.0.0.1:54695_ c:collection1 s:shard4 r:core_node3 x:collection1] o.a.s.c.SolrCore SolrDeletionPolicy.onCommit: commits: num=2
   [junit4]   2&amp;gt; 	commit{dir=NRTCachingDirectory(MMapDirectory@/home/hossman/lucene/dev/solr/build/solr-core/test/J0/temp/solr.schema.TestCloudSchemaless_E3CE46BC04E096EF-001/shard-3-001/cores/collection1/data/index lockFactory=org.apache.lucene.store.SingleInstanceLockFactory@5720ab9c; maxCacheMB=48.0 maxMergeSizeMB=4.0),segFN=segments_4,generation=4}
   [junit4]   2&amp;gt; 	commit{dir=NRTCachingDirectory(MMapDirectory@/home/hossman/lucene/dev/solr/build/solr-core/test/J0/temp/solr.schema.TestCloudSchemaless_E3CE46BC04E096EF-001/shard-3-001/cores/collection1/data/index lockFactory=org.apache.lucene.store.SingleInstanceLockFactory@5720ab9c; maxCacheMB=48.0 maxMergeSizeMB=4.0),segFN=segments_5,generation=5}
   [junit4]   2&amp;gt; 74359 INFO  (qtp1972553455-125) [n:127.0.0.1:54695_ c:collection1 s:shard4 r:core_node3 x:collection1] o.a.s.c.SolrCore newest commit generation = 5
   [junit4]   2&amp;gt; 74361 INFO  (qtp1972553455-125) [n:127.0.0.1:54695_ c:collection1 s:shard4 r:core_node3 x:collection1] o.a.s.s.SolrIndexSearcher Opening Searcher@5428727f[collection1] realtime
   [junit4]   2&amp;gt; 74361 INFO  (qtp1972553455-125) [n:127.0.0.1:54695_ c:collection1 s:shard4 r:core_node3 x:collection1] o.a.s.u.p.LogUpdateProcessor [collection1] webapp= path=/update params={waitSearcher=true&amp;amp;openSearcher=false&amp;amp;commit=true&amp;amp;softCommit=false&amp;amp;commit_end_point=true&amp;amp;wt=javabin&amp;amp;version=2} {} 0 30
   [junit4]   2&amp;gt; 74362 ERROR (qtp1972553455-125) [n:127.0.0.1:54695_ c:collection1 s:shard4 r:core_node3 x:collection1] o.a.s.s.SolrDispatchFilter null:java.lang.RuntimeException: java.lang.AssertionError: inform must be called first
   [junit4]   2&amp;gt; 	at org.apache.solr.servlet.HttpSolrCall.sendError(HttpSolrCall.java:616)
   [junit4]   2&amp;gt; 	at org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:475)
   [junit4]   2&amp;gt; 	at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:220)
   [junit4]   2&amp;gt; 	at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:179)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)
   [junit4]   2&amp;gt; 	at org.apache.solr.client.solrj.embedded.JettySolrRunner$DebugFilter.doFilter(JettySolrRunner.java:109)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.servlets.UserAgentFilter.doFilter(UserAgentFilter.java:83)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.servlets.GzipFilter.doFilter(GzipFilter.java:300)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:585)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:221)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1127)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:515)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1061)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:97)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.server.Server.handle(Server.java:499)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:310)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:257)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.io.AbstractConnection$2.run(AbstractConnection.java:540)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:635)
   [junit4]   2&amp;gt; 	at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:555)
   [junit4]   2&amp;gt; 	at java.lang.Thread.run(Thread.java:745)
   [junit4]   2&amp;gt; Caused by: java.lang.AssertionError: inform must be called first
   [junit4]   2&amp;gt; 	at org.apache.solr.search.similarities.SchemaSimilarityFactory.getSimilarity(SchemaSimilarityFactory.java:86)
   [junit4]   2&amp;gt; 	at org.apache.solr.schema.IndexSchema.getSimilarity(IndexSchema.java:269)
   [junit4]   2&amp;gt; 	at org.apache.solr.search.SolrIndexSearcher.&amp;lt;init&amp;gt;(SolrIndexSearcher.java:255)
   [junit4]   2&amp;gt; 	at org.apache.solr.core.SolrCore.openNewSearcher(SolrCore.java:1628)
   [junit4]   2&amp;gt; 	at org.apache.solr.update.DirectUpdateHandler2.commit(DirectUpdateHandler2.java:635)
   [junit4]   2&amp;gt; 	at org.apache.solr.update.processor.RunUpdateProcessor.processCommit(RunUpdateProcessorFactory.java:95)
   [junit4]   2&amp;gt; 	at org.apache.solr.update.processor.UpdateRequestProcessor.processCommit(UpdateRequestProcessor.java:64)
   [junit4]   2&amp;gt; 	at org.apache.solr.update.processor.UpdateRequestProcessor.processCommit(UpdateRequestProcessor.java:64)
   [junit4]   2&amp;gt; 	at org.apache.solr.update.processor.UpdateRequestProcessor.processCommit(UpdateRequestProcessor.java:64)
   [junit4]   2&amp;gt; 	at org.apache.solr.update.processor.UpdateRequestProcessor.processCommit(UpdateRequestProcessor.java:64)
   [junit4]   2&amp;gt; 	at org.apache.solr.update.processor.UpdateRequestProcessor.processCommit(UpdateRequestProcessor.java:64)
   [junit4]   2&amp;gt; 	at org.apache.solr.update.processor.UpdateRequestProcessor.processCommit(UpdateRequestProcessor.java:64)
   [junit4]   2&amp;gt; 	at org.apache.solr.update.processor.UpdateRequestProcessor.processCommit(UpdateRequestProcessor.java:64)
   [junit4]   2&amp;gt; 	at org.apache.solr.update.processor.DistributedUpdateProcessor.doLocalCommit(DistributedUpdateProcessor.java:1616)
   [junit4]   2&amp;gt; 	at org.apache.solr.update.processor.DistributedUpdateProcessor.processCommit(DistributedUpdateProcessor.java:1593)
   [junit4]   2&amp;gt; 	at org.apache.solr.update.processor.LogUpdateProcessor.processCommit(LogUpdateProcessorFactory.java:161)
   [junit4]   2&amp;gt; 	at org.apache.solr.handler.RequestHandlerUtils.handleCommit(RequestHandlerUtils.java:69)
   [junit4]   2&amp;gt; 	at org.apache.solr.handler.ContentStreamHandlerBase.handleRequestBody(ContentStreamHandlerBase.java:68)
   [junit4]   2&amp;gt; 	at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:151)
   [junit4]   2&amp;gt; 	at org.apache.solr.core.SolrCore.execute(SolrCore.java:2079)
   [junit4]   2&amp;gt; 	at org.apache.solr.servlet.HttpSolrCall.execute(HttpSolrCall.java:667)
   [junit4]   2&amp;gt; 	at org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:460)
   [junit4]   2&amp;gt; 	... 23 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;...and then eventually the suite times out.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;There are lots of questions here, notably:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;what makes this tests special that it fails so spectaculaly like this?
	&lt;ul&gt;
		&lt;li&gt;in particular why does this SimilarityFactory change cause the directory ref counting to fail?&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;why is recovery happening after shutdown?&lt;/li&gt;
	&lt;li&gt;regardless of how/why the other things in the test go so bizare in the first place, what code path is leading to the SchemaSimilarityFactory that hasn&apos;t had &lt;tt&gt;.inform(SolrCore)&lt;/tt&gt; called on it?&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15001442" author="hossman" created="Thu, 12 Nov 2015 01:14:18 +0000"  >&lt;p&gt;After filing this, it occurred to me the original issue that lead me down this investigation (&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8271&quot; title=&quot;use SchemaSimilarityFactory as default when no explicit (top level) sim is configured&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8271&quot;&gt;&lt;del&gt;SOLR-8271&lt;/del&gt;&lt;/a&gt;) I was also seeing failures in ChangedSchemaMergeTest.testOptimizeDiffSchemas that i wasn&apos;t seeing with this patch.  Looking into why I realized it&apos;s because that test uses it&apos;s own hardcoded schema(s) that are build on the fly from java code.&lt;/p&gt;

&lt;p&gt;In this new updated patch, i tweaked them to directly refer to SchemaSimilarityFactory, and now you can see the &lt;tt&gt;AssertionError: inform must be called first&lt;/tt&gt; getting logged, and the subsequent cc.shutdown() giving up after a ref count mismatch on the directory factory.&lt;/p&gt;

&lt;p&gt;This is probably a simpler test to trouble shoot why the SolrCoreAware.inform isn&apos;t getting called properly then the cloud test, and hopefully can lead to a fix that helps with both tests.&lt;/p&gt;</comment>
                            <comment id="15006146" author="hossman" created="Mon, 16 Nov 2015 02:07:14 +0000"  >
&lt;p&gt;The root problem seems to be that when using the SolrResourceLoader to create newInstances of objects, the loader is tracking what things are SolrCoreAware, ResourceLoaderAware, and/or SolrInfoMBean.  Then, just before the SolrCore finishes initialiing itself, it calls a method on SolrResourceLoader to take appropriate action on to inform those instances (and/or add them to the MBean registry)&lt;/p&gt;

&lt;p&gt;The problem happens when any new instances are created by the SolrResourceLoader &lt;em&gt;after&lt;/em&gt; the SolrCore is up and running &amp;#8211; it currently has a &lt;tt&gt;live&lt;/tt&gt; boolean it uses to just flat out ignore wether or not these instances are SolrCoreAware, ResourceLoaderAware, and/or SolrInfoMBean, meaning that nothing in the call stack ever informs them about the SolrCore.&lt;/p&gt;

&lt;p&gt;It looks like &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4658&quot; title=&quot;In preparation for dynamic schema modification via REST API, add a &amp;quot;managed&amp;quot; schema facility&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4658&quot;&gt;&lt;del&gt;SOLR-4658&lt;/del&gt;&lt;/a&gt; included a bit of a hack work arround for the ResourceLoaderAware schema elements (see IndexSchema&apos;s constructor which call&apos;s &lt;tt&gt;loader.inform(loader);&lt;/tt&gt;...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/viewvc/lucene/dev/trunk/solr/core/src/java/org/apache/solr/schema/IndexSchema.java?r1=1463182&amp;amp;r2=1463181&amp;amp;pathrev=1463182&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/lucene/dev/trunk/solr/core/src/java/org/apache/solr/schema/IndexSchema.java?r1=1463182&amp;amp;r2=1463181&amp;amp;pathrev=1463182&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;...this seems realy sketchy because it causes &lt;b&gt;any&lt;/b&gt; ResourceLoaderAware plugins inited so far by the core to be {{inform(ResourceLoader)}}ed once the first IndexSchema is created &amp;#8211; even though that&apos;s not suppose to happen until mutch later in the SolrCore constructor just before the CountDownLatch is released.&lt;/p&gt;

&lt;p&gt;What it does do however is ensure that when a new schema gets loaded later (by the REST API, or a schemaless update processor) and ResourceLoaderAware fieldtypes/analyzers are good to go &amp;#8211; but that doesn&apos;t do anything to help SolrCoreAware plugins like SimilarityFactory.&lt;/p&gt;

&lt;p&gt;I&apos;m attaching a work in progress patch where I attempted to fix the underlying problem with SolrResourceLoader by having it keep a refrence to the SolrCore it&apos;s tied to such that any new instances after that the would be immediately informed of the SorlCore/ResourceLoader.  This fixes some of the tests I mentioned before in this issue that have problems with SchemaSimilarityFactory but causes other failures in other existing test that reload the schema &amp;#8211; because any FieldType that is ResourceLoader aware is now being &quot;informed&quot; of the loader as soon as it&apos;s instantiated &amp;#8211; before even basic init() methods are called.  Which makes sense in hind sight &amp;#8211; my whole approach here is flawed because the contract is suppoes to be that the init methods will always be called first, and any (valid) inform methods will be called at some point after that once the core/loader is available, but before the instance is used ... calling &quot;new&quot; then &quot;inform&quot; then &quot;init&quot; is maddness.&lt;/p&gt;

&lt;p&gt;I honestly don&apos;t know if there is a sane way to solve this problem in the general case &amp;#8211; the best thing I can think of at the moment is a similar special case hack for calling &lt;tt&gt;loader.inform(SolrCore)&lt;/tt&gt; after any code that creates a schema (other then SolrCore)&lt;/p&gt;</comment>
                            <comment id="15006470" author="romseygeek" created="Mon, 16 Nov 2015 10:29:10 +0000"  >&lt;p&gt;I have a half-implemented patch hanging around somewhere that tried to clean this up a bit.  I think the root problem is that there are two circumstances in which we&apos;re using SolrResourceLoader, a) during core initialization when we need to call init() immediately, but wait to call inform() until after the loading latch has been released, and then b) to create new objects once the core is up and serving queries.  I tried to split this out into two separate SRL implementations, one of which is private to SolrCore and used only in the constructor, and does the call-init-and-then-delay-inform dance, and the other of which is returned by SolrCore.getResourceLoader() and inits() and informs() before it returns.  To be honest though, I get so confused by the code paths here that I&apos;m not sure whether or not that would help in this case...&lt;/p&gt;</comment>
                            <comment id="15009906" author="hossman" created="Wed, 18 Nov 2015 00:18:24 +0000"  >
&lt;blockquote&gt;&lt;p&gt;I have a half-implemented patch hanging around somewhere that tried to clean this up a bit. I think the root problem is that there are two circumstances in which we&apos;re using SolrResourceLoader, ...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agreed.  It&apos;s a mess, and it would be nice to clean up &amp;#8211; but that&apos;s a huge pile of work, so i&apos;d prefer to punt it to another issue. (which i will file soon)&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;After digging into things a bit more, here are a few things i learned/realized/uncovered in no particular order...&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;in most cases, the schemaless/managed-schema code paths don&apos;t actaully replace the entire IndexSchema used by a SolrCore...
	&lt;ul&gt;
		&lt;li&gt;REST APIs use things like &lt;tt&gt;ManagedIndexSchema.addFieldTypes(...)&lt;/tt&gt; which do shallow copies
		&lt;ul&gt;
			&lt;li&gt;these ManagedIndexSchema methods for mutating things and doing shallow copies already have smarts to ensure that any new &lt;tt&gt;ResourceAware&lt;/tt&gt; objects get properly informed.&lt;/li&gt;
			&lt;li&gt;since there is no way to dynamically change the SimFactory at run time, the existing instance is re-used in all of these shallow copies and no new SimFactory instances ever need informed of the core&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
		&lt;li&gt;some (cloud specific) code paths use things like &lt;tt&gt;ZkIndexSchemaReader.updateSchema&lt;/tt&gt; to notice if/when the schema file changes in ZK and act on that locally
		&lt;ul&gt;
			&lt;li&gt;this does (evidently) construct an entirely new ManagedIndexSchema instance&lt;/li&gt;
			&lt;li&gt;this is the code path that was execing after &lt;tt&gt;TestCloudSchemaless&lt;/tt&gt; was finished &amp;#8211; but I still understand when/why this was happening.&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
		&lt;li&gt;ChangedSchemaMergeTest is kind of a special case, because it goes out of it&apos;s way to construct a new IndexSchema and set it on an existing SolrCore even though it isn&apos;t using MangedIndexSchema&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;There was already a special kludge for SolrCoreAware SimFactories in &lt;tt&gt;SolrCore.initSchema&lt;/tt&gt;
	&lt;ul&gt;
		&lt;li&gt;looks like this was originally for ensuring that the SimFactories was usable when other SolrCoreAware things (like listeners) got informed of the SolrCore and tried to use the SolrIndexSearcher (which depended on the sim)&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So i think the most straight forward solution to the problem (SimilarityFactory-ies that implement SolrCoreAware playing nice with managed schema) is to refactor that existing kludge from &lt;tt&gt;SolrCore.initSchema&lt;/tt&gt; to &lt;tt&gt;SolrCore.setLatestSchema&lt;/tt&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Current Patch...&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;schema-add-schema-fields-update-processor.xml - explicitly use SchemaSimilarityFactory here to help stress  TestCloudSchemaless&lt;/li&gt;
	&lt;li&gt;ChangedSchemaMergeTest - explicitly use SchemaSimilarityFactory here to test that scenerio&lt;/li&gt;
	&lt;li&gt;SolrCore - refactored existing SolrCoreAware simfactory hack so that it applies anytime setLatestSchema is called&lt;/li&gt;
	&lt;li&gt;SchemaSimilarityFactory - switched from assertions to IllegalStateException so it&apos;s more obvious there&apos;s a problem even if assertions are disabled (no NPE)&lt;/li&gt;
	&lt;li&gt;SolrResourceLoader - has some nocommits i want to update with strong warnings and a link to a new jira where my &amp;amp; alan&apos;s comments about the lifecycle problems of objects inited &lt;em&gt;after&lt;/em&gt; the SolrCore is loaded are tracked&lt;/li&gt;
&lt;/ul&gt;


&lt;hr /&gt;

&lt;p&gt;TODO:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;cleanup &amp;amp; beef up nocommit comments&lt;/li&gt;
	&lt;li&gt;beef up ChangedSchemaMergeTest to actually change the sim used in each schema &amp;amp; verify it&apos;s updated (and fully functional)&lt;/li&gt;
	&lt;li&gt;add/update a managed schema test that does an add-field type w/ a per-fieldtype sim and sanity check that code path + input works properly and plays nicely with SchemaSimilarityFactory&lt;/li&gt;
&lt;/ul&gt;


</comment>
                            <comment id="15012363" author="hossman" created="Wed, 18 Nov 2015 23:32:49 +0000"  >
&lt;p&gt;New in this patch...&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;cleanup &amp;amp; beef up nocommit comments to point to new &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8311&quot; title=&quot;SolrCoreAware and ResourceLoaderAware lifecyel is fragile - particularly with objects that can be created after SolrCore is live&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8311&quot;&gt;SOLR-8311&lt;/a&gt; trakcing jira&lt;/li&gt;
	&lt;li&gt;beefed up ChangedSchemaMergeTest to actually change the sim used in each schema &amp;amp; verify it&apos;s updated (and fully functional)&lt;/li&gt;
	&lt;li&gt;put some sanity checks in TestBulkSchemaAPI.testMultipleCommands
	&lt;ul&gt;
		&lt;li&gt;already had some basic verification that adding a fieldtype w/sim + field using that type workd&lt;/li&gt;
		&lt;li&gt;now it whitebox verifies that the the underlying SimilarityFactory for the latest schema is  and returns the expected Sim for each field.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;...still testing, but i think this is good to go.&lt;/p&gt;</comment>
                            <comment id="15013901" author="jira-bot" created="Thu, 19 Nov 2015 17:03:37 +0000"  >&lt;p&gt;Commit 1715215 from hossman@apache.org in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1715215&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1715215&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8280&quot; title=&quot;Schemaless features don&amp;#39;t work reliably with SolrCoreAware sim factory -- example: SchemaSimilarityFactory&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8280&quot;&gt;&lt;del&gt;SOLR-8280&lt;/del&gt;&lt;/a&gt;: Fixed bug in SimilarityFactory initialization that prevented SolrCoreAware factories from functioning properly with managed schema features&lt;/p&gt;</comment>
                            <comment id="15014029" author="jira-bot" created="Thu, 19 Nov 2015 17:57:27 +0000"  >&lt;p&gt;Commit 1715225 from hossman@apache.org in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1715225&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1715225&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8280&quot; title=&quot;Schemaless features don&amp;#39;t work reliably with SolrCoreAware sim factory -- example: SchemaSimilarityFactory&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8280&quot;&gt;&lt;del&gt;SOLR-8280&lt;/del&gt;&lt;/a&gt;: Fixed bug in SimilarityFactory initialization that prevented SolrCoreAware factories from functioning properly with managed schema features (merge r1715215)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12911905">SOLR-8271</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12914188">SOLR-8311</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13552026">SOLR-16998</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12773120" name="SOLR-8280.patch" size="15684" author="hossman" created="Wed, 18 Nov 2015 23:32:49 +0000"/>
                            <attachment id="12772877" name="SOLR-8280.patch" size="7463" author="hossman" created="Wed, 18 Nov 2015 00:18:24 +0000"/>
                            <attachment id="12771884" name="SOLR-8280.patch" size="2522" author="hossman" created="Thu, 12 Nov 2015 01:14:18 +0000"/>
                            <attachment id="12771877" name="SOLR-8280.patch" size="1356" author="hossman" created="Thu, 12 Nov 2015 00:35:37 +0000"/>
                            <attachment id="12772434" name="SOLR-8280__broken__resource_loader_experiment.patch" size="10426" author="hossman" created="Mon, 16 Nov 2015 02:07:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2oa2v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>