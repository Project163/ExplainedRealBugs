<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:10:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-11535] Weird behavior of CollectionStateWatcher</title>
                <link>https://issues.apache.org/jira/browse/SOLR-11535</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;While working on &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11320&quot; title=&quot;Lock autoscaling triggers when changes they requested are being made&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11320&quot;&gt;&lt;del&gt;SOLR-11320&lt;/del&gt;&lt;/a&gt; I noticed a strange behavior in &lt;tt&gt;ActiveReplicaWatcher&lt;/tt&gt;, which is a subclass of &lt;tt&gt;CollectionStateWatcher&lt;/tt&gt; - it appears that its &lt;tt&gt;onStateChanged&lt;/tt&gt; method can be called from multiple threads with exactly the same &lt;tt&gt;DocCollection&lt;/tt&gt; state, ie. unchanged between the calls.&lt;/p&gt;

&lt;p&gt;This seems to run contrary to the javadoc, which implies that this method is called only when the state actually changes, and it also doesn&apos;t mention anything about the need for thread-safety in the method implementation.&lt;/p&gt;

&lt;p&gt;I attached the log, which has a lot of additional debugging - but the most pertinent part being where a Watcher-s hashCode is printed together with the &lt;tt&gt;DocCollection&lt;/tt&gt; - notice that these overlapping calls both submit an instance of &lt;tt&gt;DocCollection&lt;/tt&gt; with the same zkVersion.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dragonsinth&quot; class=&quot;user-hover&quot; rel=&quot;dragonsinth&quot;&gt;dragonsinth&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=romseygeek&quot; class=&quot;user-hover&quot; rel=&quot;romseygeek&quot;&gt;romseygeek&lt;/a&gt; - could you please take a look at this? If this behavior is expected then the javadoc should be updated to state clearly that multiple calls can be made concurrently, with exactly the same state (which is kind of a weak guarantee for a method called &lt;tt&gt;onStateChanged&lt;/tt&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; ).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13111663">SOLR-11535</key>
            <summary>Weird behavior of CollectionStateWatcher</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="magibney">Michael Gibney</assignee>
                                    <reporter username="ab">Andrzej Bialecki</reporter>
                        <labels>
                    </labels>
                <created>Tue, 24 Oct 2017 11:06:22 +0000</created>
                <updated>Tue, 16 Jul 2024 18:01:35 +0000</updated>
                            <resolved>Wed, 10 Apr 2024 19:38:56 +0000</resolved>
                                    <version>7.2</version>
                    <version>8.0</version>
                                    <fixVersion>9.6</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="5400">1.5h</timespent>
                                <comments>
                            <comment id="16216713" author="ab" created="Tue, 24 Oct 2017 11:19:44 +0000"  >&lt;p&gt;Look for lines with &lt;tt&gt;ActiveReplicaWatcher &amp;#8211; onStateChanged&lt;/tt&gt;, and see how the same instance of watcher gets invoked twice with the same version of &lt;tt&gt;DocCollection&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16440480" author="tomasflobbe" created="Tue, 17 Apr 2018 06:38:40 +0000"  >&lt;p&gt;This may be related to the fact that we execute ZooKeeper watches in a multi-thread executor, so if multiple threads in parallel could call the &lt;tt&gt;StateWatcher.refreshAndWatch&lt;/tt&gt; method concurrently (coming from two watches fired on the same znode). Note that we re-set the watch when we call &lt;tt&gt;fetchCollectionState&lt;/tt&gt;. This is similar to what I saw while working on &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12172&quot; title=&quot;Race condition in collection properties can cause invalid cache of properties&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12172&quot;&gt;&lt;del&gt;SOLR-12172&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
 Maybe the solution is to not call &lt;tt&gt;constructState&lt;/tt&gt; when &lt;tt&gt;updateWatchedCollection&lt;/tt&gt; returns &lt;tt&gt;false&lt;/tt&gt;. Other option I think could be to put&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
DocCollection newState = fetchCollectionState(coll, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
updateWatchedCollection(coll, newState);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;inside the synchronize. Other option is to document that the watchers could be called more than once for the same data and make the watcher call handle it. Maybe &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt; also has some thoughts.&lt;/p&gt;</comment>
                            <comment id="17770574" author="mgibney" created="Fri, 29 Sep 2023 19:08:26 +0000"  >&lt;p&gt;This is still a problem! This issue was filed a long time ago, so it&apos;s possible the exact mechanism was different at the time of initial reporting. But as of now, basically new &lt;tt&gt;StateWatcher&lt;/tt&gt; instances are created based on whether a registered &lt;tt&gt;DocCollectionWatcher&lt;/tt&gt; caused a new entry to be &lt;a href=&quot;https://github.com/apache/solr/blob/240ae14962a62192fedaea48d07590dd15ff1891/solr/solrj-zookeeper/src/java/org/apache/solr/common/cloud/ZkStateReader.java#L1755-L1769&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;added to collectionWatches&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;When an entry is &lt;a href=&quot;https://github.com/apache/solr/blob/240ae14962a62192fedaea48d07590dd15ff1891/solr/solrj-zookeeper/src/java/org/apache/solr/common/cloud/ZkStateReader.java#L1987-L1992&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;removed from collectionWatches&lt;/a&gt;, it leaves it&apos;s associated &lt;tt&gt;StateWatcher&lt;/tt&gt; in place. The &lt;tt&gt;StateWatcher&lt;/tt&gt; is then supposed to find that its collection is &lt;a href=&quot;https://github.com/apache/solr/blob/240ae14962a62192fedaea48d07590dd15ff1891/solr/solrj-zookeeper/src/java/org/apache/solr/common/cloud/ZkStateReader.java#L1332-L1336&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;no longer represented in collectionWatches&lt;/a&gt;, and exit (not resetting itself). But if another entry has been added to collectionWatches in the meantime, the old StateWatcher will continue resetting itself indefinitely, and a new StateWatcher will have been added for the entry when it was created.&lt;/p&gt;

&lt;p&gt;The essence of the fix is described &lt;a href=&quot;https://github.com/apache/solr/pull/1964#discussion_r1341703136&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17770644" author="mgibney" created="Sat, 30 Sep 2023 03:11:45 +0000"  >&lt;p&gt;This issue is not purely academic &amp;#8211; it can manifest in really problematic ways. If enough extra StateWatchers get registered, heavy load can trigger a vicious cycle where zkCallback threadpool balloons, and thread contention exacerbates the same race condition, and in some cases the node entirely freezes up. Seen mostly during cluster restarts (lots of CPU, and also lots of state updates).&lt;/p&gt;

&lt;p&gt;I suspect this also explains why thread count sometimes goes quite high upon restart, but (in cases where the node recovers) then shrinks within a reasonable amount of time. I had wondered about this behavior because it&apos;s distinct from ballooning of the jetty thread pool, which would shrink extremely slowly.&lt;/p&gt;</comment>
                            <comment id="17835855" author="jira-bot" created="Wed, 10 Apr 2024 18:54:15 +0000"  >&lt;p&gt;Commit 2b9d4c85dd58920df02317069805f4f5d3abb5c3 in solr&apos;s branch refs/heads/main from Michael Gibney&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=2b9d4c85dd5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=2b9d4c85dd5&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11535&quot; title=&quot;Weird behavior of CollectionStateWatcher&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11535&quot;&gt;&lt;del&gt;SOLR-11535&lt;/del&gt;&lt;/a&gt;: Fix race condition in singleton-per-collection StateWatcher creation (#1964)&lt;/p&gt;
</comment>
                            <comment id="17835862" author="jira-bot" created="Wed, 10 Apr 2024 19:37:42 +0000"  >&lt;p&gt;Commit f5f2ea90cc5cfe40b30f62d25a330699fe1680ab in solr&apos;s branch refs/heads/branch_9x from Michael Gibney&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=f5f2ea90cc5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=f5f2ea90cc5&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11535&quot; title=&quot;Weird behavior of CollectionStateWatcher&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11535&quot;&gt;&lt;del&gt;SOLR-11535&lt;/del&gt;&lt;/a&gt;: Fix race condition in singleton-per-collection StateWatcher creation (#1964)&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 2b9d4c85dd58920df02317069805f4f5d3abb5c3)&lt;/p&gt;</comment>
                            <comment id="17841717" author="gus_heck" created="Sun, 28 Apr 2024 19:22:39 +0000"  >&lt;p&gt;Closing after the 9.6.0 release&lt;/p&gt;</comment>
                            <comment id="17866054" author="dsmiley" created="Mon, 15 Jul 2024 12:48:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;(CHANGES.txt) Fix race condition in singleton-per-collection StateWatcher creation&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Ideally, CHANGES.txt communicates information in ways a user has a chance of understanding / how they would experience the change.&#160; This one is unclear to me.&#160; It appears the change ultimately affects scalability maybe particularly for high-core count?&lt;/p&gt;</comment>
                            <comment id="17866099" author="mgibney" created="Mon, 15 Jul 2024 15:23:45 +0000"  >&lt;p&gt;Thanks, fair criticism; and you&apos;re right about the user-facing impact of this change. Should I retroactively update the CHANGES.txt entry for this change, or is that not recommended?&lt;/p&gt;</comment>
                            <comment id="17866496" author="dsmiley" created="Tue, 16 Jul 2024 18:01:35 +0000"  >&lt;p&gt;Absolutely no pressure from me for you to improve the comment; updating it is annoying, I know.  Mostly I spread this general feedback to help us all do better next time in CHANGES.txt: communicate in ways a user might understand.  &lt;/p&gt;

&lt;p&gt;I still am not 100% sure what the impact of this is &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13099661">SOLR-11320</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12893726" name="test.log" size="332081" author="ab" created="Tue, 24 Oct 2017 11:17:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 17 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3lmuf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>