<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:15:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-9405] ConcurrentModificationException in ZkStateReader.getStateWatchers</title>
                <link>https://issues.apache.org/jira/browse/SOLR-9405</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Jenkins found this: &lt;a href=&quot;http://jenkins.thetaphi.de/job/Lucene-Solr-6.x-Linux/1432/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://jenkins.thetaphi.de/job/Lucene-Solr-6.x-Linux/1432/&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Stack Trace:
java.util.ConcurrentModificationException
        at __randomizedtesting.SeedInfo.seed([FA459DF725097EFF:A77E52876204E1C1]:0)
        at java.util.HashMap$HashIterator.nextNode(java.base@9-ea/HashMap.java:1489)
        at java.util.HashMap$KeyIterator.next(java.base@9-ea/HashMap.java:1513)
        at java.util.AbstractCollection.addAll(java.base@9-ea/AbstractCollection.java:351)
        at java.util.HashSet.&amp;lt;init&amp;gt;(java.base@9-ea/HashSet.java:119)
        at org.apache.solr.common.cloud.ZkStateReader.getStateWatchers(ZkStateReader.java:1279)
        at org.apache.solr.common.cloud.TestCollectionStateWatchers.testSimpleCollectionWatch(TestCollectionStateWatchers.java:116)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12996494">SOLR-9405</key>
            <summary>ConcurrentModificationException in ZkStateReader.getStateWatchers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shalin">Shalin Shekhar Mangar</assignee>
                                    <reporter username="shalin">Shalin Shekhar Mangar</reporter>
                        <labels>
                    </labels>
                <created>Thu, 11 Aug 2016 02:03:45 +0000</created>
                <updated>Wed, 2 Oct 2019 17:23:23 +0000</updated>
                            <resolved>Fri, 12 Aug 2016 12:24:30 +0000</resolved>
                                    <version>6.1</version>
                                    <fixVersion>6.2</fixVersion>
                    <fixVersion>7.0</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="15416374" author="shalinmangar" created="Thu, 11 Aug 2016 02:06:49 +0000"  >&lt;p&gt;FYI &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=romseygeek&quot; class=&quot;user-hover&quot; rel=&quot;romseygeek&quot;&gt;romseygeek&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15417066" author="romseygeek" created="Thu, 11 Aug 2016 11:38:59 +0000"  >&lt;p&gt;Patch fixing the issue, and also dealing with a race in the test.&lt;/p&gt;</comment>
                            <comment id="15417371" author="shalinmangar" created="Thu, 11 Aug 2016 14:58:11 +0000"  >&lt;p&gt;Thanks Alan. I am not sure how CollectionWatch#stateWatchers is thread-safe. Is it because all access to it is inside of ConcurrentHashMap#compute? The javadocs for compute only say that the entire method invocation is performed atomically. That doesn&apos;t necessarily mean that it is synchronized.&lt;/p&gt;

&lt;p&gt;What about access to the size() method? We access it independently in the canBeRemoved() method. Is that likely to cause a problem?&lt;/p&gt;</comment>
                            <comment id="15417453" author="romseygeek" created="Thu, 11 Aug 2016 15:37:02 +0000"  >&lt;blockquote&gt;&lt;p&gt;That doesn&apos;t necessarily mean that it is synchronized&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hm, I disagree here - if something is performed atomically, it necessarily implies that it&apos;s synchronized, doesn&apos;t it?  And the actual JVM implementation certainly uses synchronized blocks under the hood.&lt;/p&gt;

&lt;p&gt;canBeRemoved() is also only ever called from inside a compute() method call, so we should be thread-safe here as well.&lt;/p&gt;

&lt;p&gt;If we want to be totally safe, though, it should be possible to add a lock Object to CollectionWatch and synchronize on that inside the compute() blocks each time - I&apos;ll try it out.&lt;/p&gt;</comment>
                            <comment id="15417688" author="shalinmangar" created="Thu, 11 Aug 2016 18:05:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;Hm, I disagree here - if something is performed atomically, it necessarily implies that it&apos;s synchronized, doesn&apos;t it?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;A method which calls compare and set is atomic but doesn&apos;t necessarily synchronize.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;And the actual JVM implementation certainly uses synchronized blocks under the hood.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m not very familiar with the new collection methods such as compute and that is why I asked if this is really synchronized. All I am saying is that the Javadocs don&apos;t explicitly say that it is synchronized and therefore we should be vary of relying on such behaviour. It is possible that my understanding is wrong but I&apos;d still like to understand why if you can help. If you are confident that the current code is correct, a code comment on stateWatchers stating why and how it must be used in future would be nice to have.&lt;/p&gt;</comment>
                            <comment id="15418238" author="eribeiro" created="Fri, 12 Aug 2016 01:40:19 +0000"  >&lt;p&gt;Hi guys, I &lt;b&gt;guess&lt;/b&gt; this patch doesn&apos;t solve the issue at hand. &lt;/p&gt;

&lt;p&gt;TL;DR: the solution is to declare stateWatchers as &lt;tt&gt;stateWatchers = ConcurrentHashMap.newKeySet();&lt;/tt&gt;  at L#150. That is, no need to modify &lt;tt&gt;getStateWatchers&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Please, let me explain.&lt;/p&gt;

&lt;p&gt;First, the error is happening here:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-comment&quot;&gt;/* &lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt;-&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; testing */&lt;/span&gt;
 1. Set&amp;lt;CollectionStateWatcher&amp;gt; getStateWatchers(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; collection) {
 2.   CollectionWatch watch = collectionWatches.get(collection);
 3.   &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (watch == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
 4.     &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
 5.   &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashSet&amp;lt;&amp;gt;(watch.stateWatchers);
 6. }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That is, &lt;tt&gt;ZkStateReader.getStateWatchers&lt;/tt&gt; is creating a new &lt;tt&gt;HashSet&lt;/tt&gt; instance by providing a new collection: &lt;tt&gt;CollectionWatch#stateWatchers&lt;/tt&gt;. As we can see in ZkStateReader, &lt;tt&gt;watch#stateWatchers&lt;/tt&gt; is also a &lt;tt&gt;HashSet&lt;/tt&gt;.&lt;/p&gt;


&lt;p&gt;Okay, If we look into &lt;tt&gt;HashSet&lt;/tt&gt;/&lt;tt&gt;AbstractCollection&lt;/tt&gt; source code, we see that the constructor seen at line 5 (ABOVE)  basically calls the &lt;tt&gt;addAll&lt;/tt&gt; method passing the collection provided via the constructor. Then &lt;tt&gt;addAll&lt;/tt&gt; basically loops on collection provided including the elements one by one in the new collection. See in the stack trace provided in this issue:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;at java.util.HashMap$KeyIterator.next(java.base@9-ea/HashMap.java:1513) &lt;span class=&quot;code-comment&quot;&gt;// RUNNING THE FOR-EACH LOOP
&lt;/span&gt;at java.util.AbstractCollection.addAll(java.base@9-ea/AbstractCollection.java:351)  &lt;span class=&quot;code-comment&quot;&gt;// DELEGATES TO ADDALL
&lt;/span&gt;at java.util.HashSet.&amp;lt;init&amp;gt;(java.base@9-ea/HashSet.java:119)  &lt;span class=&quot;code-comment&quot;&gt;// THE CONSTRUCTOR&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In a nutshell, what is happening is that while we are populating the new &lt;tt&gt;HashSet&lt;/tt&gt; instance at line 5 of ZkStateReader a new Thread changes &lt;tt&gt;stateWatchers&lt;/tt&gt; concurrently. This throws the &lt;tt&gt;ConcurrentModificationException&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;The proposed patch doesn&apos;t solve the issue because even if &lt;tt&gt;collectionWatches.compute&lt;/tt&gt; is atomic, none of the &lt;tt&gt;Sets&lt;/tt&gt; in use in ZkStateReader is thread-safe.&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;I wrote a test program to demonstrate my speculation: &lt;a href=&quot;https://gist.github.com/eribeiro/4141df2d02c62d7370101bc4349cd8c4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/eribeiro/4141df2d02c62d7370101bc4349cd8c4&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Finally, sorry if I misunderstood the problem, and let me know if what I wrote made any sense. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;

&lt;p&gt;Cheers!&lt;/p&gt;</comment>
                            <comment id="15418427" author="romseygeek" created="Fri, 12 Aug 2016 06:45:25 +0000"  >&lt;p&gt;Thanks Edward, that makes sense.&lt;/p&gt;

&lt;p&gt;I&apos;m about to be away from a keyboard for two weeks - Shalin if you want to take this one in the meantime, feel free, otherwise I&apos;ll get to it when I&apos;m back.&lt;/p&gt;</comment>
                            <comment id="15418628" author="shalinmangar" created="Fri, 12 Aug 2016 10:16:32 +0000"  >&lt;p&gt;Thanks Edward. Yes that&apos;s what I was going for. We need to make the stateWatchers thread-safe either by wrapping with synchronizedMap or by using a set backed by ConcurrentHashMap. I&apos;ll put up a patch.&lt;/p&gt;

&lt;p&gt;Have fun, Alan!&lt;/p&gt;</comment>
                            <comment id="15418736" author="shalinmangar" created="Fri, 12 Aug 2016 12:03:08 +0000"  >&lt;p&gt;Patch which changes the stateWatcher to a set backed by ConcurrentHashMap. It also includes the race condition fix that Alan had supplied for the TestCollectionStateWatchers in his last patch. I&apos;ll commit shortly.&lt;/p&gt;</comment>
                            <comment id="15418739" author="jira-bot" created="Fri, 12 Aug 2016 12:07:08 +0000"  >&lt;p&gt;Commit f82c3b1206011776c55867fb2b5027b824f99812 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f82c3b1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f82c3b1&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9405&quot; title=&quot;ConcurrentModificationException in ZkStateReader.getStateWatchers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9405&quot;&gt;&lt;del&gt;SOLR-9405&lt;/del&gt;&lt;/a&gt;: ConcurrentModificationException in ZkStateReader.getStateWatchers&lt;/p&gt;</comment>
                            <comment id="15418744" author="jira-bot" created="Fri, 12 Aug 2016 12:10:51 +0000"  >&lt;p&gt;Commit 42254c2d9b0e93a96e280b44b2fcbd4b9b6693af in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=42254c2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=42254c2&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9405&quot; title=&quot;ConcurrentModificationException in ZkStateReader.getStateWatchers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9405&quot;&gt;&lt;del&gt;SOLR-9405&lt;/del&gt;&lt;/a&gt;: ConcurrentModificationException in ZkStateReader.getStateWatchers&lt;br/&gt;
(cherry picked from commit f82c3b1)&lt;/p&gt;</comment>
                            <comment id="15418754" author="shalinmangar" created="Fri, 12 Aug 2016 12:24:30 +0000"  >&lt;p&gt;Thanks Alan and Edward. I folded Alan&apos;s changes to use compute in getStateWatchers into the patch/commit.&lt;/p&gt;</comment>
                            <comment id="15422754" author="dsmiley" created="Tue, 16 Aug 2016 13:59:28 +0000"  >&lt;p&gt;Not sure if it&apos;s related to this issue, but when I beast test TestCollectionStateWatchers, I get &quot;ZkTestServer Watch limit violations&quot;.&lt;br/&gt;
&lt;tt&gt;ant beast -Dtestcase=TestCollectionStateWatchers -Dbeast.iters=100&lt;/tt&gt;  It only took a few minutes.&lt;/p&gt;

&lt;p&gt;Separately from that, I find the use of &lt;tt&gt;ConcurrentHashMap.compute()&lt;/tt&gt; in this class very odd... definitely not the intended purpose of this method &amp;#8211; even the return value isn&apos;t used.  I think it&apos;s a nifty method/feature, it&apos;s just that I don&apos;t see why ZkTestServer is calling it the way it&apos;s calling it versus simply calling &lt;tt&gt;get()&lt;/tt&gt;.  Attached is a patch showing something simpler.  My beast test failed &lt;em&gt;with and without&lt;/em&gt; this patch.&lt;/p&gt;</comment>
                            <comment id="15438993" author="mikemccand" created="Fri, 26 Aug 2016 13:59:30 +0000"  >&lt;p&gt;Bulk close resolved issues after 6.2.0 release.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12823458" name="SOLR-9405.patch" size="5850" author="shalin" created="Fri, 12 Aug 2016 12:03:08 +0000"/>
                            <attachment id="12823215" name="SOLR-9405.patch" size="5750" author="romseygeek" created="Thu, 11 Aug 2016 11:38:59 +0000"/>
                            <attachment id="12823896" name="SOLR_9405_no_compute.patch" size="1649" author="dsmiley" created="Tue, 16 Aug 2016 13:59:28 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 12 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i326kf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>