<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:51:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-16187] ExecutorUtil#awaitTermination shouldn&apos;t wait forever</title>
                <link>https://issues.apache.org/jira/browse/SOLR-16187</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;While looking at some of the other thread leak issues, found that ExecutorUtil#awaitTermination is waiting basically forever:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/solr/blob/main/solr/solrj/src/java/org/apache/solr/common/util/ExecutorUtil.java#L98&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/solr/blob/main/solr/solrj/src/java/org/apache/solr/common/util/ExecutorUtil.java#L98&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void awaitTermination(ExecutorService pool) {
    &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; shutdown = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!shutdown) {
      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        &lt;span class=&quot;code-comment&quot;&gt;// Wait a &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; existing tasks to terminate
&lt;/span&gt;        shutdown = pool.awaitTermination(60, TimeUnit.SECONDS);
      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException ie) {
        &lt;span class=&quot;code-comment&quot;&gt;// Preserve interrupt status
&lt;/span&gt;        &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().interrupt();
      }
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Instead it should be possible to wait and then if still not shutdown then interrupt the threads? ie: pool.shutdownNow() then another awaitTermination to at least limit the termination time to 2*60 seconds?&lt;/p&gt;

&lt;p&gt;This would at least have some bound to shutting stuff down.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13443460">SOLR-16187</key>
            <summary>ExecutorUtil#awaitTermination shouldn&apos;t wait forever</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="krisden">Kevin Risden</assignee>
                                    <reporter username="krisden">Kevin Risden</reporter>
                        <labels>
                    </labels>
                <created>Thu, 5 May 2022 20:04:09 +0000</created>
                <updated>Fri, 17 Oct 2025 20:05:02 +0000</updated>
                            <resolved>Tue, 6 Sep 2022 14:35:59 +0000</resolved>
                                                    <fixVersion>9.1</fixVersion>
                    <fixVersion>9.0.1</fixVersion>
                    <fixVersion>10.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3600">1h</timespent>
                                <comments>
                            <comment id="17532508" author="risdenk" created="Thu, 5 May 2022 20:04:42 +0000"  >&lt;p&gt;FYI &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mdrob&quot; class=&quot;user-hover&quot; rel=&quot;mdrob&quot;&gt;mdrob&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=magibney&quot; class=&quot;user-hover&quot; rel=&quot;magibney&quot;&gt;magibney&lt;/a&gt; since this was discussed some in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16154&quot; title=&quot;ZKEventListenerThread leaks from tests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16154&quot;&gt;&lt;del&gt;SOLR-16154&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17581455" author="mdrob" created="Thu, 18 Aug 2022 17:23:34 +0000"  >&lt;p&gt;I think this caused the failure that we saw in &lt;a href=&quot;https://builds.apache.org/job/Solr/job/Solr-Check-main/4429/testReport/junit/org.apache.solr.client.solrj.impl/CloudSolrClientCacheTest/classMethod/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Solr/job/Solr-Check-main/4429/testReport/junit/org.apache.solr.client.solrj.impl/CloudSolrClientCacheTest/classMethod/&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;com.carrotsearch.randomizedtesting.ThreadLeakError: 1 thread leaked from SUITE scope at org.apache.solr.client.solrj.impl.CloudSolrClientCacheTest: 
   1) Thread[id=427, name=CloudSolrClient ThreadPool-240-thread-1, state=RUNNABLE, group=TGRP-CloudSolrClientCacheTest]
        at java.base@11.0.12/jdk.internal.misc.Unsafe.unpark(Native Method)
        at java.base@11.0.12/java.util.concurrent.locks.LockSupport.unpark(LockSupport.java:160)
        at java.base@11.0.12/java.util.concurrent.locks.AbstractQueuedSynchronizer.unparkSuccessor(AbstractQueuedSynchronizer.java:709)
        at java.base@11.0.12/java.util.concurrent.locks.AbstractQueuedSynchronizer.release(AbstractQueuedSynchronizer.java:1305)
        at java.base@11.0.12/java.util.concurrent.locks.ReentrantLock.unlock(ReentrantLock.java:439)
        at java.base@11.0.12/java.util.concurrent.ThreadPoolExecutor.tryTerminate(ThreadPoolExecutor.java:726)
        at java.base@11.0.12/java.util.concurrent.ThreadPoolExecutor.processWorkerExit(ThreadPoolExecutor.java:994)
        at java.base@11.0.12/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
        at java.base@11.0.12/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)
        at java.base@11.0.12/java.lang.Thread.run(Thread.java:834)
	at __randomizedtesting.SeedInfo.seed([56EBCA685869287E]:0)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I can&apos;t think of any other way that this thread pool would still be running after the test has already completed.&lt;/p&gt;</comment>
                            <comment id="17581592" author="mgibney" created="Fri, 19 Aug 2022 01:50:36 +0000"  >&lt;blockquote&gt;&lt;p&gt;I can&apos;t think of any other way that this thread pool would still be running after the test has already completed.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I&apos;m certain this is possible and perfectly normal actually: &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15660?focusedCommentId=17534560#comment-17534560&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-15660?focusedCommentId=17534560#comment-17534560&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I had previously been thinking that this only applied to cases where the threads are introduced within the test code, not by the test framework &#8211; it&apos;s not immediately clear to me which is the case with the above stacktrace. But the conclusion in the above-linked comment (which I&apos;m 100% confident of, despite how counterintuitive it seems) is that ThreadLeakLingering is absolutely necessary to avoid these false positives &#8211; and notably, threads still being detectable after &lt;tt&gt;awaitTermination()&lt;/tt&gt; manifest exactly the stack trace pasted above (i.e., &lt;tt&gt;tryTerminate()&lt;/tt&gt;, etc...).&lt;/p&gt;

&lt;p&gt;Really I think we should restore a blanket ThreadLeakLingering, basically reverting &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15660&quot; title=&quot;Remove universal 10 second test thread leak linger.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15660&quot;&gt;&lt;del&gt;SOLR-15660&lt;/del&gt;&lt;/a&gt; &#8211; 10s was too long, but 1s should suffice. Any of the &lt;tt&gt;@ThreadLeakLingering(linger = 10)&lt;/tt&gt;, or 30, etc. are effective in units of 100ms, so will be &quot;rounded up&quot;, and the fact that they&apos;re there as 10, 30, etc. is misleading.&lt;/p&gt;

&lt;p&gt;I&apos;m glad you brought this up again Mike, it&apos;s been hanging in the back of my mind ... these issues don&apos;t crop up often, but they&apos;re definitely spurious and they definitely contribute needlessly to overall test noise.&lt;/p&gt;</comment>
                            <comment id="17581596" author="mgibney" created="Fri, 19 Aug 2022 02:15:21 +0000"  >&lt;p&gt;Still this month a lot of (presumably mostly spurious?) failures that appear to be related to this issue, &lt;a href=&quot;https://lists.apache.org/list?builds@solr.apache.org:dfr=2022-8-1%7Cdto=2022-8-31:java.util.concurrent.ThreadPoolExecutor.tryTerminate&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;showing up in the builds&lt;/a&gt; ...&lt;/p&gt;</comment>
                            <comment id="17583954" author="mdrob" created="Wed, 24 Aug 2022 02:34:51 +0000"  >&lt;p&gt;The thread that I highlighted was from the CloudSolrClient&apos;s internal thread pool - we try-with-resource create a CSC in the test, then CSC.close() calls shutdownAndAwaitTermination...&lt;/p&gt;

&lt;p&gt;and awaitTermination certainly looks like it won&apos;t return until everything has reached the Terminated state.&lt;/p&gt;

&lt;p&gt;No, hold on, it waits for the pool to reach terminated state, which doesn&apos;t necessarily mean that every thread is TERMINATED? Ok, this took me a long time to get, but I think I&apos;m with you on it now. The worker task can be completed, which would decrement the worker count of the thread pool but the Thread would still be removing itself from the thread group which is something it does as part of termination, so it&apos;s technically still alive at that point.&lt;/p&gt;

&lt;p&gt;So... we set a ThreadLeakLinger of 100ms and these should all go away?&lt;/p&gt;</comment>
                            <comment id="17583955" author="mdrob" created="Wed, 24 Aug 2022 02:35:09 +0000"  >&lt;p&gt;The docs on ThreadLeakLingering even say that we need it when there are Executors around...&lt;/p&gt;</comment>
                            <comment id="17584128" author="dweiss" created="Wed, 24 Aug 2022 08:52:53 +0000"  >&lt;p&gt;Ideally, you&apos;d want to wait for all threads of an executor to switch to terminated state. Sometimes this isn&apos;t possible - executors return from awaitTermination with all tasks completed but they don&apos;t join (await) for all the worker threads to change the state to terminated. Thread lingering is a hacky wait to introduce a grace period after the end of a test, in which the framework allows certain threads to continue running. Typically, a few millis is enough. I&apos;ve seen slow hardware (including github jobs) that can take longer so I typically set it to a second or so.&lt;/p&gt;</comment>
                            <comment id="17600795" author="jira-bot" created="Tue, 6 Sep 2022 14:30:16 +0000"  >&lt;p&gt;Commit fa9dfac8a7cce56020f808cb136ac6b6fecde5d8 in solr&apos;s branch refs/heads/main from Kevin Risden&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=fa9dfac8a7c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=fa9dfac8a7c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16187&quot; title=&quot;ExecutorUtil#awaitTermination shouldn&amp;#39;t wait forever&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16187&quot;&gt;&lt;del&gt;SOLR-16187&lt;/del&gt;&lt;/a&gt;: ExecutorUtil#awaitTermination shouldn&apos;t wait forever (#840)&lt;/p&gt;
</comment>
                            <comment id="17600797" author="jira-bot" created="Tue, 6 Sep 2022 14:32:54 +0000"  >&lt;p&gt;Commit 40ab2d9fc9e8eec13c6a1aa920caf09c84237ef9 in solr&apos;s branch refs/heads/branch_9x from Kevin Risden&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=40ab2d9fc9e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=40ab2d9fc9e&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16187&quot; title=&quot;ExecutorUtil#awaitTermination shouldn&amp;#39;t wait forever&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16187&quot;&gt;&lt;del&gt;SOLR-16187&lt;/del&gt;&lt;/a&gt;: ExecutorUtil#awaitTermination shouldn&apos;t wait forever (#840)&lt;/p&gt;
</comment>
                            <comment id="17600801" author="risdenk" created="Tue, 6 Sep 2022 14:34:50 +0000"  >&lt;p&gt;I created &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16401&quot; title=&quot;Test thread leak linger should be 1s&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16401&quot;&gt;&lt;del&gt;SOLR-16401&lt;/del&gt;&lt;/a&gt; to track adding the 1s thread leak linger back in.&lt;/p&gt;</comment>
                            <comment id="17602444" author="jira-bot" created="Fri, 9 Sep 2022 16:13:02 +0000"  >&lt;p&gt;Commit a066431bb59e49b32e13e41da2c9a7daf80cab6d in solr&apos;s branch refs/heads/branch_9_0 from Kevin Risden&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=a066431bb59&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=a066431bb59&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16187&quot; title=&quot;ExecutorUtil#awaitTermination shouldn&amp;#39;t wait forever&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16187&quot;&gt;&lt;del&gt;SOLR-16187&lt;/del&gt;&lt;/a&gt;: ExecutorUtil#awaitTermination shouldn&apos;t wait forever (#840)&lt;/p&gt;
</comment>
                            <comment id="17656819" author="ishan" created="Tue, 10 Jan 2023 20:45:26 +0000"  >&lt;p&gt;Bulk closing 9.1 issues.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13577765">SOLR-17261</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13552081">SOLR-17000</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13439521">SOLR-16154</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13480303">SOLR-16401</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 44 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z123xs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>