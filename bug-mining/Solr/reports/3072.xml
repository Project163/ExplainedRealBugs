<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:15:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-9389] HDFS Transaction logs stay open for writes which leaks Xceivers</title>
                <link>https://issues.apache.org/jira/browse/SOLR-9389</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;The HdfsTransactionLog implementation keeps a Hadoop FSDataOutputStream open for its whole lifetime, which consumes two threads on the HDFS data node server (dataXceiver and packetresponder) even once the Solr tlog has finished being written to.&lt;/p&gt;

&lt;p&gt;This means for a cluster with many indexes on HDFS, the number of Xceivers can keep growing and eventually hit the limit of 4096 on the data nodes. It&apos;s especially likely for indexes that have low write rates, because Solr keeps enough tlogs around to contain 100 documents (up to a limit of 10 tlogs). There&apos;s also the issue that attempting to write to a finished tlog would be a major bug, so closing it for writes helps catch that.&lt;/p&gt;

&lt;p&gt;Our cluster during testing had 100+ collections with 100 shards each, spread across 8 boxes (each running 4 solr nodes and 1 hdfs data node) and with 3x replication for the tlog files, this meant we hit the xceiver limit fairly easily and had to use the attached patch to ensure tlogs were closed for writes once finished.&lt;/p&gt;

&lt;p&gt;The patch introduces an extra lifecycle state for the tlog, so it can be closed for writes and free up the HDFS resources, while still being available for reading. I&apos;ve tried to make it as unobtrusive as I could, but there&apos;s probably a better way. I have not changed the behaviour of the local disk tlog implementation, because it only consumes a file descriptor regardless of read or write.&lt;/p&gt;

&lt;p&gt;nb We have decided not to use Solr-on-HDFS now, we&apos;re using local disk (for various reasons). So I don&apos;t have a HDFS cluster to do further testing on this, I&apos;m just contributing the patch which worked for us.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12995180">SOLR-9389</key>
            <summary>HDFS Transaction logs stay open for writes which leaks Xceivers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="markrmiller@gmail.com">Mark Miller</assignee>
                                    <reporter username="TimOwen">Tim Owen</reporter>
                        <labels>
                    </labels>
                <created>Fri, 5 Aug 2016 10:52:50 +0000</created>
                <updated>Sat, 8 Jun 2019 15:37:24 +0000</updated>
                            <resolved>Mon, 12 Sep 2016 11:55:24 +0000</resolved>
                                    <version>6.1</version>
                    <version>7.0</version>
                                    <fixVersion>6.2.1</fixVersion>
                    <fixVersion>6.3</fixVersion>
                    <fixVersion>7.0</fixVersion>
                                    <component>Hadoop Integration</component>
                    <component>hdfs</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15437052" author="markrmiller@gmail.com" created="Thu, 25 Aug 2016 15:11:05 +0000"  >&lt;p&gt;I&apos;ve spent some time reviewing and testing out this patch - it all looks reasonable to me and tests out well. I&apos;ll commit this change soon.&lt;/p&gt;</comment>
                            <comment id="15439628" author="jira-bot" created="Fri, 26 Aug 2016 19:22:02 +0000"  >&lt;p&gt;Commit 6bff06ce4fad8edbe2a45e9b3639dfc8d3d2bb87 in lucene-solr&apos;s branch refs/heads/master from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=6bff06c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=6bff06c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9389&quot; title=&quot;HDFS Transaction logs stay open for writes which leaks Xceivers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9389&quot;&gt;&lt;del&gt;SOLR-9389&lt;/del&gt;&lt;/a&gt;: HDFS Transaction logs stay open for writes which leaks Xceivers.&lt;/p&gt;</comment>
                            <comment id="15445964" author="jira-bot" created="Mon, 29 Aug 2016 14:04:03 +0000"  >&lt;p&gt;Commit aaee4c820556ca0f62d51f939e907864e4262a32 in lucene-solr&apos;s branch refs/heads/branch_6x from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=aaee4c8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=aaee4c8&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9389&quot; title=&quot;HDFS Transaction logs stay open for writes which leaks Xceivers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9389&quot;&gt;&lt;del&gt;SOLR-9389&lt;/del&gt;&lt;/a&gt;: HDFS Transaction logs stay open for writes which leaks Xceivers.&lt;/p&gt;</comment>
                            <comment id="15445993" author="markrmiller@gmail.com" created="Mon, 29 Aug 2016 14:14:07 +0000"  >&lt;p&gt;Thanks Tim!&lt;/p&gt;</comment>
                            <comment id="15448406" author="timowen" created="Tue, 30 Aug 2016 08:13:11 +0000"  >&lt;p&gt;Great, thanks for reviewing and testing this Mark &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15450832" author="dsmiley" created="Wed, 31 Aug 2016 02:28:24 +0000"  >&lt;blockquote&gt;&lt;p&gt;100+ collections with 100 shards each, spread across 8 boxes &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=TimOwen&quot; class=&quot;user-hover&quot; rel=&quot;TimOwen&quot;&gt;TimOwen&lt;/a&gt; that would mean ~1250 shards/box; no?  ~312 per Solr process.   Wow!&lt;/p&gt;</comment>
                            <comment id="15451626" author="timowen" created="Wed, 31 Aug 2016 08:51:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt; We&apos;re now running 6 Solr JVMs per box, as the machines in production have 6 SSDs installed, so yeah it works out at around 200 Solr cores being served by each Solr JVM. That seems to run fine, and we&apos;ve had our staging environment for another Solr installation with hundreds of cores per JVM for several years. The reason for many shards is that we do frequent updates and deletes, and want to keep the Lucene index size below a manageable level e.g. 5GB, to avoid a potentially slow merge that would block writes for too long. With composite routing, our queries never touch all shards in a collection - just a few.&lt;/p&gt;

&lt;p&gt;The problem still is with SolrCloud and the Overseer/Zookeeper, which become overloaded with traffic once there&apos;s any kind of problem e.g. machine failure, or worse an entire rack losing power - this causes a flood of overseer queue events and all the nodes feverishly downloading state.json repeatedly. Happy to talk to anyone who&apos;s working on that problem!&lt;/p&gt;</comment>
                            <comment id="15452121" author="markrmiller@gmail.com" created="Wed, 31 Aug 2016 12:40:24 +0000"  >&lt;p&gt;What version are you seeing that with?&lt;/p&gt;</comment>
                            <comment id="15452531" author="timowen" created="Wed, 31 Aug 2016 15:26:28 +0000"  >&lt;p&gt;We&apos;re using Solr 6.1 (on local disk now, as mentioned). The first production cluster we had hoped to get stable was 40 boxes, each running 5 or 6 Solr JVMs, with a dedicated ZK cluster on 3 other boxes, and 100 shards per collection. That was problematic, we had a lot of Zookeeper traffic during normal writes, but especially whenever one or more boxes were deliberately killed as many Solr instances restarted all at once, leading to a large overseer queue and shards in recovery for a long time.&lt;/p&gt;

&lt;p&gt;Right now we&apos;re testing two scaled-down clusters: 24 boxes, and 12 boxes, with correspondingly reduced number of shards, to see at what point it can be stable when we do destructive testing by killing machines and whole racks, to see how it copes. 12 boxes is looking a lot more stable so far.&lt;/p&gt;

&lt;p&gt;We&apos;ll have to consider running multiple of these smaller clusters instead of 1 large one - is that best practice? There was some discussion on &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5872&quot; title=&quot;Eliminate overseer queue &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5872&quot;&gt;SOLR-5872&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5475&quot; title=&quot;Scale Overseer to work on multiple queues and threads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5475&quot;&gt;SOLR-5475&lt;/a&gt; about scaling the overseer with large numbers of collections and shards, although it&apos;s clearly a tricky problem.&lt;/p&gt;</comment>
                            <comment id="15452999" author="dsmiley" created="Wed, 31 Aug 2016 18:33:30 +0000"  >&lt;blockquote&gt;&lt;p&gt;The reason for many shards is that we do frequent updates and deletes, and want to keep the Lucene index size below a manageable level e.g. 5GB, to avoid a potentially slow merge that would block writes for too long.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s addressable easily enough by increasing the merge concurrency threads, and using higher mergeFactor (now split to two other options).  It&apos;s cool your queries only hit a couple shards on average but I think going up a factor of 10 (and using 1/10th number shards) is in a better better direction that truly massive shard counts like this.&lt;/p&gt;</comment>
                            <comment id="15456179" author="timowen" created="Thu, 1 Sep 2016 18:02:52 +0000"  >&lt;p&gt;Thanks for the advice David, I&apos;ll take a look at the concurrency setting, we&apos;ll need to test out using fewer shards and see how that compares for our use-case. Since we create new collections weekly, we always have the option to increase the shard count later if we do hit situations of large merges happening.&lt;/p&gt;

&lt;p&gt;Although I&apos;m a bit surprised that this model is considered &apos;truly massive&apos; .. I&apos;d have expected many large Solr installations will have thousands of shards across all their collections.&lt;/p&gt;</comment>
                            <comment id="15457410" author="dsmiley" created="Fri, 2 Sep 2016 03:48:39 +0000"  >&lt;p&gt;100 shards for any one collection isn&apos;t massive (although I do think it&apos;s high)... I mean the total number of shards you run per box.  I can see now you keep your shard size low, which makes it more feasible; and no doubt you have tons of RAM.  Most people go for bigger shards and fewer number of them, rather than small numerous shards.  A factor enabling you to do this is that your application allows for the very effective use of composite key doc routing.  Nonetheless I&apos;m sure there&apos;s a high java heap overhead per-shard at these numbers, and it&apos;d be nice to bring it down from the stratosphere &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15482806" author="shalinmangar" created="Mon, 12 Sep 2016 02:13:50 +0000"  >&lt;p&gt;Re-opened to back-port to 6.2.1&lt;/p&gt;</comment>
                            <comment id="15483625" author="jira-bot" created="Mon, 12 Sep 2016 09:33:41 +0000"  >&lt;p&gt;Commit 83cd8c12ecd53198eea51ff418c7e1901b4a9dde in lucene-solr&apos;s branch refs/heads/branch_6_2 from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=83cd8c1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=83cd8c1&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9389&quot; title=&quot;HDFS Transaction logs stay open for writes which leaks Xceivers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9389&quot;&gt;&lt;del&gt;SOLR-9389&lt;/del&gt;&lt;/a&gt;: HDFS Transaction logs stay open for writes which leaks Xceivers.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit aaee4c8)&lt;/p&gt;</comment>
                            <comment id="15508552" author="shalinmangar" created="Wed, 21 Sep 2016 03:03:29 +0000"  >&lt;p&gt;Closing after 6.2.1 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12822277" name="SOLR-9389.patch" size="10823" author="TimOwen" created="Fri, 5 Aug 2016 10:53:24 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 9 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i31ygn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>