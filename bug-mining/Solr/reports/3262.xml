<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:19:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-10159] DBQ, where query is based on updated value, reordered with the update doesn&apos;t work</title>
                <link>https://issues.apache.org/jira/browse/SOLR-10159</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;h2&gt;&lt;a name=&quot;Background%2FHistory&quot;&gt;&lt;/a&gt;Background/History&lt;/h2&gt;
&lt;p&gt;If a recently updated (in-place) value is used for DBQ, the DBQ doesn&apos;t work at Lucene level, unless there&apos;s an explicit commit between the update and the DBQ, due to &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-7344&quot; title=&quot;Deletion by query of uncommitted docs not working with DV updates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LUCENE-7344&quot;&gt;LUCENE-7344&lt;/a&gt;. To work around this, Yonik suggested that we use ulog.openRealtimeSearcher() just before the DBQ is performed. This worked fine.&lt;/p&gt;

&lt;p&gt;Example:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ADD: [id=0, dv=200, title=&lt;span class=&quot;code-quote&quot;&gt;&quot;mytitle&quot;&lt;/span&gt;, _version_=100]
UPD: [id=0, dv=300, _version_=200]
DBQ: q=&lt;span class=&quot;code-quote&quot;&gt;&quot;dv:300&quot;&lt;/span&gt;, _version_=300
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;h2&gt;&lt;a name=&quot;Problemdiscoverednow&quot;&gt;&lt;/a&gt;Problem discovered now&lt;/h2&gt;
&lt;p&gt;Suppose, in the above example, the last two commands are reordered at the replica. What would happen is: &amp;#40;i&amp;#41; the full document (&amp;#95;version&amp;#95; 100) is received and indexed, (ii) the DBQ is received (out of ordered) and applied, and no document is deleted [so far so good] and this DBQ is buffered in ulog.deleteByQueries map, (iii) the in-place update arrives (_version 200), it is applied to the document that was added in step i. After that, the buffered DBQ is applied (at DUH2.addAndDelete()). This buffered DBQ, based on a value updated immediately before (step ii), fails to delete the document.&lt;/p&gt;

&lt;h2&gt;&lt;a name=&quot;Whathappensexactly%3F&quot;&gt;&lt;/a&gt;What happens exactly?&lt;/h2&gt;
&lt;p&gt;The initial DBQ query is &lt;tt&gt;&quot;dv:300&quot;&lt;/tt&gt;, but when it is applied, it is expanded to &lt;tt&gt;&quot;&amp;#43;dv:[300 TO 300] -ConstantScore(frange(long(&amp;#95;version&amp;#95;)):[300 TO *])&quot;&lt;/tt&gt;. In spite of doing a ulog.openRealtimeSearcher() just before the DBQ, it doesn&apos;t work. &lt;/p&gt;

&lt;p&gt;A different version of the query, i.e. &lt;tt&gt;&quot;&amp;#43;dv:[300 TO 300] &amp;#43;&amp;#95;version&amp;#95;:[200 TO 200]&quot;&lt;/tt&gt; also doesn&apos;t work. As I found out, &lt;b&gt;this happened due to the presence of two clauses&lt;/b&gt;! &lt;tt&gt;&quot;&amp;#43;dv:[300 TO 300]&quot;&lt;/tt&gt; works, and so does &lt;tt&gt;&quot;&amp;#43;&amp;#95;version&amp;#95;:[200 TO 200]&quot;&lt;/tt&gt;, but both clauses don&apos;t work together. Also, surprisingly, even &lt;tt&gt;&quot;&amp;#43;dv:[300 TO 300] &amp;#43;dv:[300 TO 300]&quot;&lt;/tt&gt; doesn&apos;t work (same clause repeated).&lt;/p&gt;

&lt;h2&gt;&lt;a name=&quot;InvestigationatLucenelevel&quot;&gt;&lt;/a&gt;Investigation at Lucene level&lt;/h2&gt;
&lt;p&gt;Upon some tedious investigation into the internals of Lucene, I discovered that if I change the internal search (at BufferedUpdates) to use Sort.RELEVANCE instead of Sort.INDEXORDER (which, I think is the default when using weight/scorer), the DBQ is applied correctly.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13044229">SOLR-10159</key>
            <summary>DBQ, where query is based on updated value, reordered with the update doesn&apos;t work</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ichattopadhyaya">Ishan Chattopadhyaya</assignee>
                                    <reporter username="ichattopadhyaya">Ishan Chattopadhyaya</reporter>
                        <labels>
                    </labels>
                <created>Sat, 18 Feb 2017 20:23:48 +0000</created>
                <updated>Sat, 8 Jun 2019 15:32:43 +0000</updated>
                            <resolved>Sun, 19 Feb 2017 08:44:14 +0000</resolved>
                                                    <fixVersion>6.5</fixVersion>
                    <fixVersion>7.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15873328" author="ichattopadhyaya" created="Sat, 18 Feb 2017 20:29:24 +0000"  >&lt;p&gt;Here&apos;s a patch that adds the test for reordered DBQ, which is based on updated value.&lt;/p&gt;

&lt;p&gt;Also, added the hack/workaround to BufferedUpdatesStream that solves the problem. I haven&apos;t been able to reproduce a standalone Lucene test for this. &lt;b&gt;My hunch is that this is a Lucene bug related to index sorting.&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;To reproduce the issue, remove the changes from BufferedUpdates.java and the added test fails.&lt;/p&gt;</comment>
                            <comment id="15873373" author="ichattopadhyaya" created="Sun, 19 Feb 2017 00:11:53 +0000"  >&lt;p&gt;Similarly, instead of all the changes in BufferedUpdatesStream, just changing&lt;br/&gt;
&lt;tt&gt;final Weight weight = searcher.createNormalizedWeight(query, false);&lt;/tt&gt; to&lt;br/&gt;
&lt;tt&gt;final Weight weight = searcher.createNormalizedWeight(query, true);&lt;/tt&gt;&lt;br/&gt;
also passes the test reliably. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;My hunch is that this is a Lucene bug related to index sorting.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;So, maybe this has nothing to do with Index sorting, but perhaps something to do with how BooleanQueries are processed?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mikemccand&quot; class=&quot;user-hover&quot; rel=&quot;mikemccand&quot;&gt;mikemccand&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shaie&quot; class=&quot;user-hover&quot; rel=&quot;shaie&quot;&gt;shaie&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman&quot; class=&quot;user-hover&quot; rel=&quot;hossman&quot;&gt;hossman&lt;/a&gt;, does anything jump out to you? I shall continue to dig, but so far my attempts at writing a lucene level test to reproduce this have produced no results. (So far, this: &lt;a href=&quot;https://paste.fedoraproject.org/paste/rAtcbOpqKFGJG57-lWQ58F5M1UNdIGYhyRLivL9gydE=/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://paste.fedoraproject.org/paste/rAtcbOpqKFGJG57-lWQ58F5M1UNdIGYhyRLivL9gydE=/&lt;/a&gt;, but the test passes)&lt;/p&gt;</comment>
                            <comment id="15873393" author="ichattopadhyaya" created="Sun, 19 Feb 2017 01:18:36 +0000"  >&lt;p&gt;Finally, figured out the culprit!&lt;/p&gt;

&lt;p&gt;BufferedUpdatesStream executes the DBQs using a searcher whose queryCache is set to null. When the query contains a DeleteByQueryWrapper (in Solr) clause, its createWeight() method obtains its own searcher (privateContext). This searcher&apos;s cache is not set to null, and hence it caches the queries.&lt;/p&gt;

&lt;p&gt;During the case of reordered DBQs, the DBQ is executed twice: first it cannot delete anything, since the queries return 0 results, and second when it should return results. Unfortunately, caching at this first step resulted in 0 results in the latter step (even though there is an updated value now).&lt;/p&gt;

&lt;p&gt;The fix is to set the queryCache for the DBQW&apos;s privateContext to whatever the initial searcher&apos;s queryCache was set to.&lt;/p&gt;

&lt;p&gt;Planning to commit the attached patch soon. Would be great if someone could review.&lt;/p&gt;</comment>
                            <comment id="15873396" author="jira-bot" created="Sun, 19 Feb 2017 01:43:18 +0000"  >&lt;p&gt;Commit 82f598d895a811a799edbb7760da589cd2d3f51d in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ichattopadhyaya&quot; class=&quot;user-hover&quot; rel=&quot;ichattopadhyaya&quot;&gt;ichattopadhyaya&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=82f598d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=82f598d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10159&quot; title=&quot;DBQ, where query is based on updated value, reordered with the update doesn&amp;#39;t work&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10159&quot;&gt;&lt;del&gt;SOLR-10159&lt;/del&gt;&lt;/a&gt;: When DBQ is reordered with an in-place update, upon whose updated value the DBQ is based on, the DBQ fails due to excessive caching in DeleteByQueryWrapper&lt;/p&gt;</comment>
                            <comment id="15873547" author="jira-bot" created="Sun, 19 Feb 2017 08:35:00 +0000"  >&lt;p&gt;Commit 2cd35288ec7e19af93df6275e8d028de0777bd1e in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ichattopadhyaya&quot; class=&quot;user-hover&quot; rel=&quot;ichattopadhyaya&quot;&gt;ichattopadhyaya&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=2cd3528&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=2cd3528&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10159&quot; title=&quot;DBQ, where query is based on updated value, reordered with the update doesn&amp;#39;t work&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10159&quot;&gt;&lt;del&gt;SOLR-10159&lt;/del&gt;&lt;/a&gt;: When DBQ is reordered with an in-place update, upon whose updated value the DBQ is based on, the DBQ fails due to excessive caching in DeleteByQueryWrapper&lt;/p&gt;</comment>
                            <comment id="15874424" author="shalinmangar" created="Mon, 20 Feb 2017 11:51:25 +0000"  >&lt;p&gt;Nice catch!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12980458">LUCENE-7344</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12706005">SOLR-5944</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12853439" name="SOLR-10159.patch" size="4767" author="ichattopadhyaya" created="Sun, 19 Feb 2017 01:18:36 +0000"/>
                            <attachment id="12853433" name="SOLR-10159.patch" size="5766" author="ichattopadhyaya" created="Sat, 18 Feb 2017 20:29:24 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 39 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3a9vb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>