<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:45:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-5691] Unsynchronized WeakHashMap in SolrDispatchFilter causing issues in SolrCloud</title>
                <link>https://issues.apache.org/jira/browse/SOLR-5691</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;I have a large SolrCloud setup, 7 nodes, each hosting few 1000 cores (leaders/replicas of same shard exist on different nodes), which is maybe making it easier to notice the problem.&lt;/p&gt;

&lt;p&gt;Node can randomly get into a state where it &quot;stops&quot; responding to PeerSync /get requests from other nodes. When that happens, threaddump of that node shows multiple entries like this one (one entry for each &quot;blocked&quot; request from other node; they don&apos;t go away with time):&lt;/p&gt;

&lt;p&gt;&quot;http-bio-8080-exec-1781&quot; daemon prio=5 tid=0x440177200000 nid=0x25ae  [ JVM locked by VM at safepoint, polling bits: safep ]&lt;br/&gt;
   java.lang.Thread.State: RUNNABLE&lt;br/&gt;
        at java.util.WeakHashMap.get(WeakHashMap.java:471)&lt;br/&gt;
        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:351)&lt;br/&gt;
        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:201)&lt;br/&gt;
        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:243)&lt;br/&gt;
        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:210)&lt;/p&gt;

&lt;p&gt;WeakHashMap&apos;s internal state can easily get corrupted when used in unsynchronized way, in which case it is known to enter infinite loop in .get() call. It is very likely that this happens here too. The reason why other maybe don&apos;t see this issue could be related to huge number of cores I have in this system. The problem is usually created when some node is starting. Also, it doesn&apos;t happen with each start, it obviously depends on &quot;correct&quot; timing of events which lead to map&apos;s corruption.&lt;/p&gt;

&lt;p&gt;The fix may be as simple as changing:&lt;/p&gt;

&lt;p&gt;protected final Map&amp;lt;SolrConfig, SolrRequestParsers&amp;gt; parsers = new WeakHashMap&amp;lt;SolrConfig, SolrRequestParsers&amp;gt;();&lt;/p&gt;

&lt;p&gt;to:&lt;/p&gt;

&lt;p&gt;  protected final Map&amp;lt;SolrConfig, SolrRequestParsers&amp;gt; parsers = Collections.synchronizedMap(&lt;br/&gt;
      new WeakHashMap&amp;lt;SolrConfig, SolrRequestParsers&amp;gt;());&lt;/p&gt;

&lt;p&gt;but there may be performance considerations around this since it is entrance into Solr.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12693130">SOLR-5691</key>
            <summary>Unsynchronized WeakHashMap in SolrDispatchFilter causing issues in SolrCloud</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="markrmiller@gmail.com">Mark Miller</assignee>
                                    <reporter username="bosmid">Bojan Smid</reporter>
                        <labels>
                    </labels>
                <created>Tue, 4 Feb 2014 16:11:10 +0000</created>
                <updated>Mon, 9 May 2016 18:57:34 +0000</updated>
                            <resolved>Thu, 6 Feb 2014 04:49:18 +0000</resolved>
                                    <version>4.6.1</version>
                                    <fixVersion>4.7</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13891055" author="markrmiller@gmail.com" created="Tue, 4 Feb 2014 19:22:56 +0000"  >&lt;p&gt;Hmm...what if we put the parser on the solrconfig object as a volatile? Volatiles that don&apos;t change are very fast and we avoid the ugly weakhashmap altogether:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Index: solr/core/src/java/org/apache/solr/core/SolrConfig.java
===================================================================
--- solr/core/src/java/org/apache/solr/core/SolrConfig.java	(revision 1564426)
+++ solr/core/src/java/org/apache/solr/core/SolrConfig.java	(working copy)
@@ -18,6 +18,7 @@
 package org.apache.solr.core;
 
 import static org.apache.solr.core.SolrConfig.PluginOpts.*;
+
 import org.apache.solr.common.SolrException;
 import org.apache.solr.common.SolrException.ErrorCode;
 import org.apache.solr.schema.IndexSchemaFactory;
@@ -28,11 +29,11 @@
 import org.apache.solr.request.SolrRequestHandler;
 import org.apache.solr.response.QueryResponseWriter;
 import org.apache.solr.response.transform.TransformerFactory;
-
 import org.apache.solr.search.CacheConfig;
 import org.apache.solr.search.FastLRUCache;
 import org.apache.solr.search.QParserPlugin;
 import org.apache.solr.search.ValueSourceParser;
+import org.apache.solr.servlet.SolrRequestParsers;
 import org.apache.solr.update.SolrIndexConfig;
 import org.apache.solr.update.UpdateLog;
 import org.apache.solr.update.processor.UpdateRequestProcessorChain;
@@ -40,10 +41,8 @@
 import org.apache.lucene.search.BooleanQuery;
 import org.apache.lucene.index.IndexDeletionPolicy;
 import org.apache.lucene.util.Version;
-
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
-
 import org.w3c.dom.Node;
 import org.w3c.dom.NodeList;
 import org.xml.sax.InputSource;
@@ -89,6 +88,8 @@
   private boolean handleSelect;
 
   private boolean addHttpRequestToContext;
+
+  private volatile SolrRequestParsers solrRequestParsers;
   
   /** Creates a default instance from the solrconfig.xml. */
   public SolrConfig()
@@ -324,6 +325,13 @@
     }
     return result;
   }
+  
+  public SolrRequestParsers getRequestParsers() {
+    if (solrRequestParsers == null) {
+      solrRequestParsers = new SolrRequestParsers(this);
+    }
+    return solrRequestParsers;
+  }
 
   /* The set of materialized parameters: */
   public final int booleanQueryMaxClauseCount;
Index: solr/core/src/java/org/apache/solr/servlet/SolrDispatchFilter.java
===================================================================
--- solr/core/src/java/org/apache/solr/servlet/SolrDispatchFilter.java	(revision 1564426)
+++ solr/core/src/java/org/apache/solr/servlet/SolrDispatchFilter.java	(working copy)
@@ -103,7 +103,6 @@
 
   protected String pathPrefix = null; // strip this from the beginning of a path
   protected String abortErrorMessage = null;
-  protected final Map&amp;lt;SolrConfig, SolrRequestParsers&amp;gt; parsers = new WeakHashMap&amp;lt;SolrConfig, SolrRequestParsers&amp;gt;();
   
   private static final Charset UTF8 = Charset.forName(&quot;UTF-8&quot;);
 
@@ -348,12 +347,7 @@
         if( core != null ) {
           final SolrConfig config = core.getSolrConfig();
           // get or create/cache the parser for the core
-          SolrRequestParsers parser = null;
-          parser = parsers.get(config);
-          if( parser == null ) {
-            parser = new SolrRequestParsers(config);
-            parsers.put(config, parser );
-          }
+          SolrRequestParsers parser = config.getRequestParsers();
 
           // Handle /schema/* paths via Restlet
           if( path.startsWith(&quot;/schema&quot;) ) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13893027" author="jira-bot" created="Thu, 6 Feb 2014 04:47:45 +0000"  >&lt;p&gt;Commit 1565069 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1565069&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1565069&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5691&quot; title=&quot;Unsynchronized WeakHashMap in SolrDispatchFilter causing issues in SolrCloud&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5691&quot;&gt;&lt;del&gt;SOLR-5691&lt;/del&gt;&lt;/a&gt;: Sharing non thread safe WeakHashMap across thread can cause problems.&lt;/p&gt;</comment>
                            <comment id="13893028" author="jira-bot" created="Thu, 6 Feb 2014 04:48:46 +0000"  >&lt;p&gt;Commit 1565070 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1565070&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1565070&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5691&quot; title=&quot;Unsynchronized WeakHashMap in SolrDispatchFilter causing issues in SolrCloud&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5691&quot;&gt;&lt;del&gt;SOLR-5691&lt;/del&gt;&lt;/a&gt;: Sharing non thread safe WeakHashMap across thread can cause problems.&lt;/p&gt;</comment>
                            <comment id="13893029" author="markrmiller@gmail.com" created="Thu, 6 Feb 2014 04:49:18 +0000"  >&lt;p&gt;Die WeakHashMap, die!&lt;/p&gt;

&lt;p&gt;Thanks Bojan!&lt;/p&gt;</comment>
                            <comment id="13893200" author="bosmid" created="Thu, 6 Feb 2014 09:18:26 +0000"  >&lt;p&gt;Thanks for fixing!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>371716</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 41 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1s28n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>372016</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>