<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:40:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-13835] HttpSolrCall produces incorrect extra AuditEvent on AuthorizationResponse.PROMPT</title>
                <link>https://issues.apache.org/jira/browse/SOLR-13835</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;spinning this out of &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13741&quot; title=&quot;AuditLoggerIntegrationTest hardening&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13741&quot;&gt;&lt;del&gt;SOLR-13741&lt;/del&gt;&lt;/a&gt;...&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Wrt the REJECTED + UNAUTHORIZED events I see the same as you, and I believe there is a code bug, not a test bug. In HttpSolrCall#471 in the &lt;tt&gt;authorize()&lt;/tt&gt; call, if authResponse == PROMPT, it will actually match both blocks and emit two audit events: &lt;a href=&quot;https://github.com/apache/lucene-solr/blob/26ede632e6259eb9d16861a3c0f782c9c8999762/solr/core/src/java/org/apache/solr/servlet/HttpSolrCall.java#L475:L493&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/blob/26ede632e6259eb9d16861a3c0f782c9c8999762/solr/core/src/java/org/apache/solr/servlet/HttpSolrCall.java#L475:L493&lt;/a&gt; &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (authResponse.statusCode == AuthorizationResponse.PROMPT.statusCode) {...}
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!(authResponse.statusCode == HttpStatus.SC_ACCEPTED) &amp;amp;&amp;amp; !(authResponse.statusCode == HttpStatus.SC_OK)) {...}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;When code==401, it is also true that code!=200. Intuitively there should be both a sendErrora and return RETURN before line #484 in the first if block?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This causes any and all &lt;tt&gt;REJECTED&lt;/tt&gt; AuditEvent messages to be accompanied by a coresponding &lt;tt&gt;UNAUTHORIZED&lt;/tt&gt; AuditEvent.  &lt;/p&gt;

&lt;p&gt;It&apos;s not yet clear if, from the perspective of the external client, there are any other bugs in behavior (TBD)&lt;/p&gt;</description>
                <environment></environment>
        <key id="13261690">SOLR-13835</key>
            <summary>HttpSolrCall produces incorrect extra AuditEvent on AuthorizationResponse.PROMPT</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="janhoy">Jan H&#248;ydahl</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Fri, 11 Oct 2019 03:08:13 +0000</created>
                <updated>Tue, 21 Jan 2020 16:58:33 +0000</updated>
                            <resolved>Wed, 16 Oct 2019 23:06:54 +0000</resolved>
                                                    <fixVersion>8.3</fixVersion>
                                    <component>Authentication</component>
                    <component>Authorization</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="16949098" author="hossman" created="Fri, 11 Oct 2019 03:24:54 +0000"  >&lt;p&gt;FWIW: it also seems a little concerning to me that any &quot;non-200|202&quot;  &lt;tt&gt;AuthorizationResponse&lt;/tt&gt; is automatically assumed to be &lt;tt&gt;EventType.UNAUTHORIZED&lt;/tt&gt; ... that seems kind of brittle and error prone ... what if an &lt;tt&gt;AuthorizationPlugin&lt;/tt&gt; returns a 500 status code?&lt;/p&gt;</comment>
                            <comment id="16949225" author="janhoy" created="Fri, 11 Oct 2019 07:45:09 +0000"  >&lt;p&gt;The first if block was introduced back in 2005 as part of&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7757&quot; title=&quot;Create a framework to edit/reload security params&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7757&quot;&gt;&lt;del&gt;SOLR-7757&lt;/del&gt;&lt;/a&gt;. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&#160;why does the if not return? It will &lt;b&gt;always&lt;/b&gt;&#160;fall through to and trigger the next if block!&lt;/p&gt;</comment>
                            <comment id="16949629" author="hossman" created="Fri, 11 Oct 2019 16:55:40 +0000"  >&lt;p&gt;Jan: Maybe i&apos;m missing something, but IIUC in the context of how simple those blocks were when the code was initially added, it was reasonable for the first block to fall through to the second:&lt;/p&gt;

&lt;p&gt;Back when the code was introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7757&quot; title=&quot;Create a framework to edit/reload security params&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7757&quot;&gt;&lt;del&gt;SOLR-7757&lt;/del&gt;&lt;/a&gt;:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;If authResp.status == PROMPT: do some logging specific to the authResp, and add some HTTP response headers specified by the auth plugin&lt;/li&gt;
	&lt;li&gt;If authResp.status != OK: sendError(authResp.status)
	&lt;ul&gt;
		&lt;li&gt;ie: it didn&apos;t matter if the authResp.status was PROMPT, or FORBIDDEN, or anything else ... it wasn&apos;t ok so send an error with&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;...it&apos;s only as a result of changes introduced since then (with the addition of audit logging to each of the conditionals) that we now have a bug in the form of multiple Audit Events when authResp is PROMPT.&lt;/p&gt;

&lt;p&gt;IIUC: from the perspective of the external client the behavior is still entirely correct either way, it&apos;s only if/how an AuditLogger plugin is used and what it expects that seems to be at risk.&lt;/p&gt;

&lt;p&gt;(particularly since the AuthorizationPlugin API seems open enough (ie: there is no fixed enum of  authResponse.statusCode values)  that a custom plugin could return a lot of diff non-200/202 error codes that the AuditLogger would all report as &quot;UNAUTHORIZED&quot;)&lt;/p&gt;</comment>
                            <comment id="16950452" author="janhoy" created="Sun, 13 Oct 2019 19:40:56 +0000"  >&lt;p&gt;PR&#160;&lt;a href=&quot;https://github.com/apache/lucene-solr/pull/946&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;GitHub Pull Request #946&lt;/a&gt;&#160;ready for review, also folding in changes from&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13840&quot; title=&quot;AuditLogger issues when logged from HttpServletRequest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13840&quot;&gt;&lt;del&gt;SOLR-13840&lt;/del&gt;&lt;/a&gt; which is now marked as duplicate.&lt;/p&gt;</comment>
                            <comment id="16950454" author="janhoy" created="Sun, 13 Oct 2019 19:42:52 +0000"  >&lt;blockquote&gt;&lt;p&gt;Jan: Maybe i&apos;m missing something, but IIUC in the context of how simple those blocks were when the code was initially added, it was reasonable for the first block to fall through to the second&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;It is not reasonable to execute logc in both those blocks, although before audit code it only had the consequence of double &lt;tt&gt;log.debug(&quot;USER_REQUIRED&lt;/tt&gt; logging and wrong message text &quot;Unauthorized request&quot; in the response.&lt;/p&gt;</comment>
                            <comment id="16951179" author="hossman" created="Mon, 14 Oct 2019 17:32:34 +0000"  >&lt;p&gt;Jan: genreally speaking &lt;a href=&quot;https://patch-diff.githubusercontent.com/raw/apache/lucene-solr/pull/946.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://patch-diff.githubusercontent.com/raw/apache/lucene-solr/pull/946.patch&lt;/a&gt; seems like an improvement, but as far as the larger issue of how this code is deciding what AuditEvents to fire based on the AuthorizationResponse.... i still have the same concern i mentioned before regarding he &quot;non-200|202&quot; block (which is unchanged in your patch):&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;...automatically assumed to be EventType.UNAUTHORIZED ... that seems kind of brittle and error prone ... what if an AuthorizationPlugin returns a 500 status code?&lt;/p&gt;&lt;/blockquote&gt;

&lt;blockquote&gt;&lt;p&gt;(particularly since the AuthorizationPlugin API seems open enough (ie: there is no fixed enum of authResponse.statusCode values) that a custom plugin could return a lot of diff non-200/202 error codes that the AuditLogger would all report as &quot;UNAUTHORIZED&quot;)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;As a concrete example: i can write an AuthorizationPlugin that recognizes a user does in fact have access to a resource, but returns &lt;tt&gt;new AuthorizationResponse(429)&lt;/tt&gt; because of the current state of the system, causing a 429 error to be returned to external client &amp;#8211;  but that will be reported to the AuditLogger plugin as &lt;tt&gt;EventType.UNAUTHORIZED == 403&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;that seems brittle.  Shouldn&apos;t the AuditLogger hooks be more explicit &amp;amp; restricted and only report each &lt;tt&gt;EventType&lt;/tt&gt; when they know for a fact that situation / HTTP Status code occured, and have some more generic, and/or use a more generic &lt;tt&gt;EventType.UNKNOWN&lt;/tt&gt; if there is no direct correlation between the AuthorizationResponse.statusCode and the predefined EventTypes? (or at the very least, use &lt;tt&gt;EventType.ERROR&lt;/tt&gt; when there isn&apos;t a direct correlation?&lt;/p&gt;</comment>
                            <comment id="16952774" author="janhoy" created="Wed, 16 Oct 2019 12:32:24 +0000"  >&lt;p&gt;New commits to PR to explicitly handle known codes:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;401 =&amp;gt; EventType.FORBIDDEN&lt;/li&gt;
	&lt;li&gt;403 =&amp;gt; EventType.UNAUTHORIZED&lt;/li&gt;
	&lt;li&gt;200/202 =&amp;gt; EventType.AUTHORIZED&lt;/li&gt;
	&lt;li&gt;All other statuses =&amp;gt; EventType.ERROR&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Please review. Think this should be mergeable now.&lt;/p&gt;</comment>
                            <comment id="16953219" author="hossman" created="Wed, 16 Oct 2019 22:01:33 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="16953246" author="jira-bot" created="Wed, 16 Oct 2019 22:44:50 +0000"  >&lt;p&gt;Commit 611c4f960e9472880e2ec24dda9336a59cd41426 in lucene-solr&apos;s branch refs/heads/master from Jan H&#248;ydahl&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=611c4f9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=611c4f9&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13835&quot; title=&quot;HttpSolrCall produces incorrect extra AuditEvent on AuthorizationResponse.PROMPT&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13835&quot;&gt;&lt;del&gt;SOLR-13835&lt;/del&gt;&lt;/a&gt; HttpSolrCall produces incorrect extra AuditEvent on AuthorizationResponse.PROMPT (#946)&lt;/p&gt;
</comment>
                            <comment id="16953257" author="jira-bot" created="Wed, 16 Oct 2019 23:04:36 +0000"  >&lt;p&gt;Commit 5a074b0fe49ef863a162e7f5d55e351bc043c806 in lucene-solr&apos;s branch refs/heads/branch_8x from Jan H&#248;ydahl&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=5a074b0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=5a074b0&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13835&quot; title=&quot;HttpSolrCall produces incorrect extra AuditEvent on AuthorizationResponse.PROMPT&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13835&quot;&gt;&lt;del&gt;SOLR-13835&lt;/del&gt;&lt;/a&gt; HttpSolrCall produces incorrect extra AuditEvent on AuthorizationResponse.PROMPT (#946)&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 611c4f960e9472880e2ec24dda9336a59cd41426)&lt;/p&gt;</comment>
                            <comment id="16953259" author="jira-bot" created="Wed, 16 Oct 2019 23:06:15 +0000"  >&lt;p&gt;Commit b58695c98ce1356efc27beeb338a8300f6f72346 in lucene-solr&apos;s branch refs/heads/branch_8_3 from Jan H&#248;ydahl&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=b58695c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=b58695c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13835&quot; title=&quot;HttpSolrCall produces incorrect extra AuditEvent on AuthorizationResponse.PROMPT&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13835&quot;&gt;&lt;del&gt;SOLR-13835&lt;/del&gt;&lt;/a&gt; HttpSolrCall produces incorrect extra AuditEvent on AuthorizationResponse.PROMPT (#946)&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 611c4f960e9472880e2ec24dda9336a59cd41426)&lt;/p&gt;</comment>
                            <comment id="16953260" author="janhoy" created="Wed, 16 Oct 2019 23:06:54 +0000"  >&lt;p&gt;Pushed to master, branch_8x and branch_8_3&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13262019">SOLR-13840</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13262019">SOLR-13840</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13267077">SOLR-13905</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13254886">SOLR-13741</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 4 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z07hnc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>