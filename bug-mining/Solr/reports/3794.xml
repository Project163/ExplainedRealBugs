<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:30:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-11988] MockDirectoryFactory.exists() behaves diff then other impls -- can cause FullSolrCloudDistribCmdsTest failures due to SolrCore.initIndex incorrectly thinking index directory for brand new SolrCores already exist?</title>
                <link>https://issues.apache.org/jira/browse/SOLR-11988</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;There&apos;s been quite a few jenkins failures from FullSolrCloudDistribCmdsTest that all seem to follow a similar pattern:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Failure manifests as &quot;Could not find collection:collection2&quot;&lt;/li&gt;
	&lt;li&gt;Failing seeds &lt;em&gt;frequently&lt;/em&gt; reproduce, but aren&apos;t guaranteed to&lt;/li&gt;
	&lt;li&gt;Root cause can be traced back to the collection creation failing because one of more replica cores failed due to the brand new (Solr)IndexWriter expects to find an existing segments file
	&lt;ul&gt;
		&lt;li&gt;SolrCore should have already created an (empty) index in &lt;tt&gt;SolrCore.initIndex(...)&lt;/tt&gt;&lt;/li&gt;
		&lt;li&gt;The fact that the &lt;tt&gt;SolrIndexWrite&lt;/tt&gt; throws this exception in it&apos;s constructor suggests that the earlier call to &lt;tt&gt;SolrCore.initIndex(...)&lt;/tt&gt; is not functioning reliably&lt;/li&gt;
		&lt;li&gt;Based on some experimenting i&apos;ve done, it seems like the underlying problem is that in &lt;tt&gt;SolrCore.initIndex(...)&lt;/tt&gt; the DirectoryFactory can &quot;lie&quot; about wether a directory already exists.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;More details to follow in comments.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13138617">SOLR-11988</key>
            <summary>MockDirectoryFactory.exists() behaves diff then other impls -- can cause FullSolrCloudDistribCmdsTest failures due to SolrCore.initIndex incorrectly thinking index directory for brand new SolrCores already exist?</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Chris M. Hostetter</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Wed, 14 Feb 2018 22:54:28 +0000</created>
                <updated>Sat, 8 Jun 2019 15:13:35 +0000</updated>
                            <resolved>Thu, 22 Feb 2018 00:28:40 +0000</resolved>
                                                    <fixVersion>7.3</fixVersion>
                    <fixVersion>8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="16364894" author="hossman" created="Wed, 14 Feb 2018 22:56:07 +0000"  >
&lt;p&gt;Below is an example of the type of execption that gets logged when this test fails, from the log.txt file I just attached (where 2 &lt;em&gt;different&lt;/em&gt; replicas had this same problem).&lt;/p&gt;

&lt;p&gt;Note that this log.txt file was produced using the attached &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11988&quot; title=&quot;MockDirectoryFactory.exists() behaves diff then other impls -- can cause FullSolrCloudDistribCmdsTest failures due to SolrCore.initIndex incorrectly thinking index directory for brand new SolrCores already exist?&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11988&quot;&gt;&lt;del&gt;SOLR-11988&lt;/del&gt;&lt;/a&gt;_nocommit_logging.patch that increases the logging verbosity in &lt;tt&gt;SolrCore.initIndex(...)&lt;/tt&gt; &amp;#8211; hence the &quot;nocommit&quot; log line, and the line numbers not matching up exactly with current master &amp;#8211; but the net result is the same: In &lt;tt&gt;SolrCore.initIndex(...)&lt;/tt&gt; the DirectoryFactory claims that the index directory for this brand new, never before in existence SolrCore, already exists and doesn&apos;t need to be initialized.  This then causes a problem when we try to open the &quot;real&quot; IndexWriter against it (using OpenMode.APPEND because we expect it to already exist)...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ ant test  -Dtestcase=FullSolrCloudDistribCmdsTest -Dtests.method=test -Dtests.seed=E6FD3BCDEA5D2094 -Dtests.slow=true -Dtests.locale=ar-JO -Dtests.timezone=Asia/Aqtobe -Dtests.asserts=true -Dtests.file.encoding=US-ASCII
...
   [junit4]   2&amp;gt; 33926 INFO  (qtp1926432793-173) [n:127.0.0.1:60391_kg_fmt c:collection2 s:shard6  x:collection2_shard6_replica_n32] o.a.s.c.SolrCore [collection2_shard6_replica_n32] nocommit: skipping creation of &apos;/home/hossman/lucene/dev/solr/build/solr-core/test/J0/../../../../../../../../../home/hossman/lucene/dev/solr/build/solr-core/test/J0/temp/solr.cloud.FullSolrCloudDistribCmdsTest_E6FD3BCDEA5D2094-001/shard-4-001/cores/collection2_shard6_replica_n32/data/index/&apos; (aka: &apos;/home/hossman/lucene/dev/solr/build/solr-core/test/J0/../../../../../../../../../home/hossman/lucene/dev/solr/build/solr-core/test/J0/temp/solr.cloud.FullSolrCloudDistribCmdsTest_E6FD3BCDEA5D2094-001/shard-4-001/cores/collection2_shard6_replica_n32/data/index&apos;) because dirFac (org.apache.solr.core.MockDirectoryFactory@768117c) says it exists
...
   [junit4]   2&amp;gt; 34763 ERROR (qtp1926432793-173) [n:127.0.0.1:60391_kg_fmt c:collection2 s:shard6  x:collection2_shard6_replica_n32] o.a.s.h.RequestHandlerBase org.apache.solr.common.SolrException: Error CREATEing SolrCore &apos;collection2_shard6_replica_n32&apos;: Unable to create core [collection2_shard6_replica_n32] Caused by: no segments* file found in LockValidatingDirectoryWrapper(MockDirectoryWrapper(RAMDirectory@63c826a3 lockFactory=org.apache.lucene.store.SingleInstanceLockFactory@17cdc1)): files: []
   [junit4]   2&amp;gt;        at org.apache.solr.core.CoreContainer.create(CoreContainer.java:993)
   [junit4]   2&amp;gt;        at org.apache.solr.handler.admin.CoreAdminOperation.lambda$static$0(CoreAdminOperation.java:91)
...
   [junit4]   2&amp;gt; Caused by: org.apache.solr.common.SolrException: Unable to create core [collection2_shard6_replica_n32]
   [junit4]   2&amp;gt;        at org.apache.solr.core.CoreContainer.createFromDescriptor(CoreContainer.java:1059)
   [junit4]   2&amp;gt;        at org.apache.solr.core.CoreContainer.create(CoreContainer.java:954)
   [junit4]   2&amp;gt;        ... 39 more
   [junit4]   2&amp;gt; Caused by: org.apache.solr.common.SolrException: Error opening new searcher
   [junit4]   2&amp;gt;        at org.apache.solr.core.SolrCore.&amp;lt;init&amp;gt;(SolrCore.java:1013)
   [junit4]   2&amp;gt;        at org.apache.solr.core.SolrCore.&amp;lt;init&amp;gt;(SolrCore.java:868)
   [junit4]   2&amp;gt;        at org.apache.solr.core.CoreContainer.createFromDescriptor(CoreContainer.java:1043)
   [junit4]   2&amp;gt;        ... 40 more
   [junit4]   2&amp;gt; Caused by: org.apache.solr.common.SolrException: Error opening new searcher
   [junit4]   2&amp;gt;        at org.apache.solr.core.SolrCore.openNewSearcher(SolrCore.java:2100)
   [junit4]   2&amp;gt;        at org.apache.solr.core.SolrCore.getSearcher(SolrCore.java:2220)
   [junit4]   2&amp;gt;        at org.apache.solr.core.SolrCore.initSearcher(SolrCore.java:1096)
   [junit4]   2&amp;gt;        at org.apache.solr.core.SolrCore.&amp;lt;init&amp;gt;(SolrCore.java:985)
   [junit4]   2&amp;gt;        ... 42 more
   [junit4]   2&amp;gt; Caused by: org.apache.lucene.index.IndexNotFoundException: no segments* file found in LockValidatingDirectoryWrapper(MockDirectoryWrapper(RAMDirectory@63c826a3 lockFactory=org.apache.lucene.store.SingleInstanceLockFactory@17cdc1)): files: []
   [junit4]   2&amp;gt;        at org.apache.lucene.index.IndexWriter.&amp;lt;init&amp;gt;(IndexWriter.java:1072)
   [junit4]   2&amp;gt;        at org.apache.solr.update.SolrIndexWriter.&amp;lt;init&amp;gt;(SolrIndexWriter.java:119)
   [junit4]   2&amp;gt;        at org.apache.solr.update.SolrIndexWriter.create(SolrIndexWriter.java:94)
   [junit4]   2&amp;gt;        at org.apache.solr.update.DefaultSolrCoreState.createMainIndexWriter(DefaultSolrCoreState.java:257)
   [junit4]   2&amp;gt;        at org.apache.solr.update.DefaultSolrCoreState.getIndexWriter(DefaultSolrCoreState.java:131)
   [junit4]   2&amp;gt;        at org.apache.solr.core.SolrCore.openNewSearcher(SolrCore.java:2061)
   [junit4]   2&amp;gt;        ... 45 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;



</comment>
                            <comment id="16364983" author="hossman" created="Thu, 15 Feb 2018 00:01:11 +0000"  >&lt;p&gt;Note: with &lt;tt&gt;useFactory(null);&lt;/tt&gt; added to &lt;tt&gt;FullSolrCloudDistribCmdsTest.beforeSuperClass()&lt;/tt&gt; I can&apos;t get this seed to fail at all ... suggesting that MockDirectoryFactory is &lt;b&gt;almost certainly&lt;/b&gt; the problem.&lt;/p&gt;
</comment>
                            <comment id="16366437" author="hossman" created="Fri, 16 Feb 2018 00:03:14 +0000"  >&lt;p&gt;Ok, the underlying problem seems to be:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;SolrCore&apos;s usage of DirectoryFactory assumes particular semantics/meaning of how &lt;tt&gt;DirectoryFactory.exists(String)&lt;/tt&gt; will behave
	&lt;ul&gt;
		&lt;li&gt;Notably: that it returns &lt;tt&gt;true&lt;/tt&gt; only if the directory exists &quot;on disk&quot; &lt;b&gt;AND&lt;/b&gt; contains at least one file&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;EphemeralDirectoryFactory (and by extension MockDirectoryFactory) does not implement &lt;tt&gt;exists(String)&lt;/tt&gt; in a manner consistent with that expectation:
	&lt;ul&gt;
		&lt;li&gt;EphemeralDirectoryFactory&apos;s impl returns &lt;tt&gt;true&lt;/tt&gt; anytime the specified path name has an entry in the cache &#8211; even if no files have been created in that directory&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Notable if you have code like this....&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; path = ...; &lt;span class=&quot;code-comment&quot;&gt;// some completley &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; never before seen directory name
&lt;/span&gt;DirectoryFactory dirFac = ...;
assertFalse(path + &lt;span class=&quot;code-quote&quot;&gt;&quot; should not exist yet&quot;&lt;/span&gt;, dirFac.exists(path));
Directory dir = dirFac.get(path, DirectoryFactory.DirContext.DEFAULT, DirectoryFactory.LOCK_TYPE_SINGLE);
assertFalse(path + &lt;span class=&quot;code-quote&quot;&gt;&quot; should still not exist&quot;&lt;/span&gt;, dirFac.exists(path));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;...that second assert will fail for &lt;tt&gt;MockDirectoryFactory&lt;/tt&gt;, but succeed for all other DirectoryFactory impls.&lt;/p&gt;

&lt;p&gt;This problem can ultimately manifests itself with the previously mentioned &lt;tt&gt;IndexNotFoundException: no segments* file found in ...&lt;/tt&gt; exception if the following situation arrises...&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;SolrCore starts initializing&lt;/li&gt;
	&lt;li&gt;A background thread (such as the monitors used for autoscaling) polls the metrics gauges for the SolrCore
	&lt;ul&gt;
		&lt;li&gt;one of these gauges calls &lt;tt&gt;SolrCore.getIndexSize()&lt;/tt&gt;&lt;/li&gt;
		&lt;li&gt;This method calls &lt;tt&gt;directoryFactory.get(getIndexDir(),...)&lt;/tt&gt; &#8211; which in the case of MockDirectoryFactory populates the &quot;cache&quot; for the &lt;tt&gt;getIndexDir()&lt;/tt&gt; path&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;After&lt;/b&gt; some other thread has called &lt;tt&gt;SolrCore.getIndexSize()&lt;/tt&gt;, then the core initialization thread makes it to &lt;tt&gt;SolrCore.initIndex(...)&lt;/tt&gt;
	&lt;ul&gt;
		&lt;li&gt;this calls &lt;tt&gt;getDirectoryFactory().exists(indexDir);&lt;/tt&gt; to decide if we should attempt to initialize a new index&lt;/li&gt;
		&lt;li&gt;Because of the buggy imple of &lt;tt&gt;MockDirectoryFactory.exists(...)&lt;/tt&gt; this method assumes there&apos;s already an index, which is not true and eventually causes IndexWriter&apos;s constructor to complain about the lack of any segments.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;hr /&gt;
&lt;p&gt;I&apos;ve attached a patch which:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Beefs up the javadocs for &lt;tt&gt;DirectoryFactory.exists&lt;/tt&gt; to clarify the expected semantics&lt;/li&gt;
	&lt;li&gt;Fixes &lt;tt&gt;EphemeralDirectoryFactory.exists&lt;/tt&gt; to meet those expectations&lt;/li&gt;
	&lt;li&gt;Adds a &lt;tt&gt;TestDirectoryFactory&lt;/tt&gt; that asserts those semantics for all known types of impls of DirectoryFactory&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I should point out there are several TODO comments in TestDirectoryFactory related to if we want to assert any specific semantics of how &lt;tt&gt;DirectoryFactory.exists&lt;/tt&gt; should behave &lt;b&gt;before&lt;/b&gt; a fyle is synced &#8211; because at the moment the behavior of impls like StandardDirectoryFactory disagree with the behavior of impls like NRTCachingDirectoryFactory that do caching/buffering in memory. Perhaps we should consider (in a new jira) tighing up those constraints, and &quot;fixing&quot; the caching based impls to return true if there are files on disk &lt;b&gt;OR&lt;/b&gt; un-synced files in the cache?&lt;/p&gt;</comment>
                            <comment id="16366441" author="hossman" created="Fri, 16 Feb 2018 00:06:21 +0000"  >&lt;p&gt;I should also point out: there&apos;s nothing particularly special about why this failure manifests itself in FullSolrCloudDistribCmdsTest.  In that particular test, it&apos;s very likelye to happen because &quot;collection2&quot; is created w/a really high number of SolrCores, so i&apos;ts just a percentage game.  Any other test (that does not override the MockDirectoryFactory default) can just as easily surface a similar looking failure.&lt;/p&gt;</comment>
                            <comment id="16372250" author="hossman" created="Thu, 22 Feb 2018 00:28:17 +0000"  >&lt;p&gt;Not sure why gitbot didn&apos;t record these...&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Branch: refs/heads/master
Commit: ee51b658ece5b23431a2200e763f5198b53952fa
Parents: 32f3570

Branch: refs/heads/branch_7x
Commit: 9876e8832ad40288e8a852f1594e520495da2cfa
Parents: 05e9201
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12910838" name="SOLR-11988.patch" size="7210" author="hossman" created="Fri, 16 Feb 2018 00:01:22 +0000"/>
                            <attachment id="12910648" name="SOLR-11988_nocommit_logging.patch" size="1201" author="hossman" created="Wed, 14 Feb 2018 22:55:39 +0000"/>
                            <attachment id="12910647" name="log.txt" size="892999" author="hossman" created="Wed, 14 Feb 2018 22:55:31 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 38 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3q78n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>