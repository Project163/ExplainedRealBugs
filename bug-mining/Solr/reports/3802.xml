<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:30:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-10720] Aggressive removal of a collection breaks cluster state</title>
                <link>https://issues.apache.org/jira/browse/SOLR-10720</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;We are periodically seeing tricky concurrency bug in SolrCloud that starts with `Could not fully remove collection: my_collection` exception:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2017-05-17T14:47:50,153 - ERROR [OverseerThreadFactory-6-thread-5:SolrException@159] - {} - Collection: my_collection operation: delete failed:org.apache.solr.common.SolrException: Could not fully remove collection: my_collection
        at org.apache.solr.cloud.DeleteCollectionCmd.call(DeleteCollectionCmd.java:106)
        at org.apache.solr.cloud.OverseerCollectionMessageHandler.processMessage(OverseerCollectionMessageHandler.java:224)
        at org.apache.solr.cloud.OverseerTaskProcessor$Runner.run(OverseerTaskProcessor.java:463)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After that all operations with SolrCloud that involve reading cluster state fail with&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.solr.common.SolrException: Error loading config name for collection my_collection
    at org.apache.solr.common.cloud.ZkStateReader.readConfigName(ZkStateReader.java:198)
    at org.apache.solr.handler.admin.ClusterStatus.getClusterStatus(ClusterStatus.java:141)
...
Caused by: org.apache.zookeeper.KeeperException$NoNodeException: KeeperErrorCode = NoNode for /collections/my_collection
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;See full &lt;a href=&quot;https://gist.github.com/serba/9b7932f005f34f6cd9a511e226c6f0c6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;stacktraces&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;As a result SolrCloud becomes completely broken. We are seeing this with 6.5.1 but I think we&#8217;ve seen that with older versions too.&lt;/p&gt;

&lt;p&gt;From looking into the code it looks like it is a combination of two factors:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Forcefully removing collection&apos;s znode in finally block in &lt;a href=&quot;https://github.com/apache/lucene-solr/blob/releases/lucene-solr/6.5.1/solr/core/src/java/org/apache/solr/cloud/DeleteCollectionCmd.java#L115&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;DeleteCollectionCmd&lt;/a&gt; that was introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5135&quot; title=&quot;Deleting a collection should be extra aggressive in the face of failures.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5135&quot;&gt;&lt;del&gt;SOLR-5135&lt;/del&gt;&lt;/a&gt;. Note that this causes cached cluster state to be not in sync with the state in Zk, i.e. &lt;tt&gt;zkStateReader.getClusterState()&lt;/tt&gt; still has collection in it (see the code &lt;a href=&quot;https://github.com/apache/lucene-solr/blob/releases/lucene-solr/6.5.1/solr/core/src/java/org/apache/solr/cloud/DeleteCollectionCmd.java#L98&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;) whereas &lt;tt&gt;/collections/&amp;lt;collection_id&amp;gt;&lt;/tt&gt; znode in Zk is already removed.&lt;/li&gt;
	&lt;li&gt;Reading cluster state operation not only returns cached version, but it is also reading collection&apos;s config name from &lt;tt&gt;/collections/&amp;lt;collection_id&amp;gt;&lt;/tt&gt; znode, but this znode was forcefully removed. The code to read config name for every collection directly from Zk was introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7636&quot; title=&quot;CLUSTERSTATUS Api should not go to OCP to fetch data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7636&quot;&gt;&lt;del&gt;SOLR-7636&lt;/del&gt;&lt;/a&gt;. Isn&apos;t there any performance implications of reading N znodes (1 per collection) on every &lt;tt&gt;getClusterStatus&lt;/tt&gt; call?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;m not sure what the proper fix should be&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Should we just catch &lt;tt&gt;KeeperException$NoNodeException&lt;/tt&gt; in &lt;tt&gt;getClusterStatus&lt;/tt&gt; and treat such collection as removed? That looks easiest / less invasive fix.&lt;/li&gt;
	&lt;li&gt;Should we stop reading config name from collection znode and get it from cache somehow?&lt;/li&gt;
	&lt;li&gt;Should we not try to delete collection&apos;s data from Zk if delete operation failed?&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13073578">SOLR-10720</key>
            <summary>Aggressive removal of a collection breaks cluster state</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shalin">Shalin Shekhar Mangar</assignee>
                                    <reporter username="alexey.serba">Alexey Serba</reporter>
                        <labels>
                    </labels>
                <created>Fri, 19 May 2017 21:43:05 +0000</created>
                <updated>Wed, 2 Oct 2019 17:24:14 +0000</updated>
                            <resolved>Mon, 26 Feb 2018 05:54:54 +0000</resolved>
                                    <version>6.5.1</version>
                                    <fixVersion>7.3</fixVersion>
                    <fixVersion>8.0</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16376417" author="shalinmangar" created="Mon, 26 Feb 2018 05:51:30 +0000"  >&lt;p&gt;Thanks Alexey. This patch catches NoNodeException and omits the collection assuming it to be removed. I&apos;ve been trying to reproduce this in tests but not getting anywhere. Since the description of the problem is clear and the patch is trivial, I&apos;ll commit this without a test.&lt;/p&gt;</comment>
                            <comment id="16376418" author="jira-bot" created="Mon, 26 Feb 2018 05:52:51 +0000"  >&lt;p&gt;Commit 6f2d99e574888227a29ea173e52f6ff6a19e23db in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=6f2d99e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=6f2d99e&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10720&quot; title=&quot;Aggressive removal of a collection breaks cluster state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10720&quot;&gt;&lt;del&gt;SOLR-10720&lt;/del&gt;&lt;/a&gt;: Aggressive removal of a collection breaks cluster status API&lt;/p&gt;</comment>
                            <comment id="16376419" author="jira-bot" created="Mon, 26 Feb 2018 05:53:37 +0000"  >&lt;p&gt;Commit a96ac1300fee9ce0390c1e20efce86895155770c in lucene-solr&apos;s branch refs/heads/branch_7x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=a96ac13&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=a96ac13&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10720&quot; title=&quot;Aggressive removal of a collection breaks cluster state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10720&quot;&gt;&lt;del&gt;SOLR-10720&lt;/del&gt;&lt;/a&gt;: Aggressive removal of a collection breaks cluster status API&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 6f2d99e)&lt;/p&gt;</comment>
                            <comment id="16376420" author="shalinmangar" created="Mon, 26 Feb 2018 05:54:54 +0000"  >&lt;p&gt;Thanks Alexey!&lt;/p&gt;</comment>
                            <comment id="16539179" author="varunthacker" created="Tue, 10 Jul 2018 20:13:35 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (SolrException e) {
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (e.getCause() &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; KeeperException.NoNodeException)  {
    &lt;span class=&quot;code-comment&quot;&gt;// skip &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; collection because the collection&apos;s znode has been deleted
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// which can happen during aggressive collection removal, see SOLR-10720
&lt;/span&gt;  } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In this code block should we force fetch the new zk state?&#160;&lt;/p&gt;

&lt;p&gt;We saw the same issue with Solr 7.2.1 and only a restart fixes the issue.&#160;&lt;/p&gt;

&lt;p&gt;There was one scenario when a create collection failed because of this error. I&apos;m trying to capture logs when this happened but that&apos;s what motivated me to say we should refresh the zk state when we hit this error.&lt;/p&gt;</comment>
                            <comment id="16539182" author="varunthacker" created="Tue, 10 Jul 2018 20:20:58 +0000"  >&lt;p&gt;Okay so the user was&#160;HttpClusterStateProvider / CloudSolrClient#withSolrUrl which is why when they hit this issue in Solr 7.2.1 create collections would also fail.&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; java.lang.RuntimeException: Couldn&apos;t initialize a HttpClusterStateProvider (is/are the Solr server(s), [http:&lt;span class=&quot;code-comment&quot;&gt;//host:port/solr/], down?)
&lt;/span&gt;at org.apache.solr.client.solrj.impl.CloudSolrClient$Builder.build(CloudSolrClient.java:1496)
...
Caused by: org.apache.solr.client.solrj.impl.HttpSolrClient$RemoteSolrException: Error from server at http:&lt;span class=&quot;code-comment&quot;&gt;//host:port/solr: Error loading config name &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; collection my_collection_name
&lt;/span&gt;at org.apache.solr.client.solrj.impl.HttpSolrClient.executeMethod(HttpSolrClient.java:643)
at org.apache.solr.client.solrj.impl.HttpSolrClient.request(HttpSolrClient.java:255)
at org.apache.solr.client.solrj.impl.HttpSolrClient.request(HttpSolrClient.java:244)
at org.apache.solr.client.solrj.SolrClient.request(SolrClient.java:1219)
at org.apache.solr.client.solrj.impl.HttpClusterStateProvider.fetchLiveNodes(HttpClusterStateProvider.java:189)
at org.apache.solr.client.solrj.impl.HttpClusterStateProvider.&amp;lt;init&amp;gt;(HttpClusterStateProvider.java:64)
at org.apache.solr.client.solrj.impl.CloudSolrClient$Builder.build(CloudSolrClient.java:1494)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13002440">SOLR-9471</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13171461">SOLR-12544</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12663091">SOLR-5135</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12835353">SOLR-7636</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12911985" name="SOLR-10720.patch" size="4952" author="shalin" created="Mon, 26 Feb 2018 05:49:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 19 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3f8xj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>