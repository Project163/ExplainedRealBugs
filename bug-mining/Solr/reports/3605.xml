<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:27:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-11221] SolrJmxReporter broken on core reload</title>
                <link>https://issues.apache.org/jira/browse/SOLR-11221</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;&lt;tt&gt;SolrJmxReporter&lt;/tt&gt; uses Dropwizard&apos;s &lt;tt&gt;JmxReporter&lt;/tt&gt;, which in turn uses a &lt;tt&gt;MetricRegistry&lt;/tt&gt; listener to report newly added metrics as MBeans, and to unregister them from MBeanServer when the reporter is closed, which happens when core is closed.&lt;/p&gt;

&lt;p&gt;The metrics API keeps around existing metrics in &lt;tt&gt;solr.core.*&lt;/tt&gt; registries to help maintain continuous metrics in presence of core reloads. However, this means that some of these metric instances are not registered anew when a core is reloaded - and for these metrics the listener won&apos;t fire, so the MBeans won&apos;t be registered.&lt;/p&gt;

&lt;p&gt;This limitation is a result of the use of &lt;tt&gt;MetricRegistryListener&lt;/tt&gt; in &lt;tt&gt;JmxReporter&lt;/tt&gt; and can&apos;t be fixed without reimplementing this class. Another possible approach would be to configure the &lt;tt&gt;JmxReporter&lt;/tt&gt; to use a &quot;mirroring&quot; registry instead, which will be populated with existing metrics from the original registry (thus generating &quot;metric added&quot; events) and then kept in sync with the main registry via a listener.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13093758">SOLR-11221</key>
            <summary>SolrJmxReporter broken on core reload</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ab">Andrzej Bialecki</assignee>
                                    <reporter username="ab">Andrzej Bialecki</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Aug 2017 11:44:43 +0000</created>
                <updated>Sat, 8 Jun 2019 15:20:00 +0000</updated>
                            <resolved>Mon, 21 Aug 2017 10:43:16 +0000</resolved>
                                    <version>6.6</version>
                    <version>6.7</version>
                    <version>7.0</version>
                    <version>8.0</version>
                                    <fixVersion>6.6.1</fixVersion>
                    <fixVersion>7.0</fixVersion>
                    <fixVersion>7.1</fixVersion>
                    <fixVersion>8.0</fixVersion>
                                    <component>metrics</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16122141" author="ab" created="Thu, 10 Aug 2017 19:11:53 +0000"  >&lt;p&gt;Hmm, yet another more serious bug is present: &lt;tt&gt;SolrJmxReporterTest.testReloadCore&lt;/tt&gt; doesn&apos;t really test the exact sequence of reporters starting and closing, so it doesn&apos;t catch the following problem.&lt;/p&gt;

&lt;p&gt;On reload the old core is closed after the new core has been created - and consequently the old instance of &lt;tt&gt;SolrJmxReporter&lt;/tt&gt; removes the mbeans right after they were registered by a new reporter started by the new core. End result is that only a handful of mbeans related to Searcher are registered, other mbeans are gone.&lt;/p&gt;

&lt;p&gt;In the past &lt;tt&gt;JmxMonitoredMap&lt;/tt&gt; used to track what mbean belongs to what core by adding a &quot;coreHashCode&quot; attribute to all DynamicMBean-s, and removing only those with matching coreHashCode attribute. Unfortunately, it&apos;s not possible to add additional attributes to MBeans created by Dropwizard&apos;s &lt;tt&gt;JmxReporter&lt;/tt&gt;, and on &lt;tt&gt;close()&lt;/tt&gt; it indiscriminately closes all MBeans with known names.&lt;/p&gt;

&lt;p&gt;One possible solution would be to insert reporter&apos;s hashCode into the ObjectName hierarchy, but this would make the MBean names variable and unpredictable. Another (more complicated but more elegant) option is to reimplement &lt;tt&gt;JmxReporter&lt;/tt&gt; to re-introduce &quot;coreHashCode&quot; attribute.&lt;/p&gt;</comment>
                            <comment id="16124322" author="ab" created="Sat, 12 Aug 2017 00:11:59 +0000"  >&lt;p&gt;This patch changes &lt;tt&gt;SolrJmxReporter&lt;/tt&gt; so that it uses a modified version of &lt;tt&gt;JmxReporter&lt;/tt&gt;, which adds an &quot;_instanceTag&quot; attribute to track what beans it had registered and unregisters only those. In a sense this is the same mechanism that &lt;tt&gt;JmxMonitoredMap&lt;/tt&gt; used, only it was called &lt;tt&gt;coreHashCode&lt;/tt&gt; there (we can call it the same if it gives users a sense of familiarity, but I thought the &quot;_instanceTag&quot; name is harder to mistake for a real bean attribute).&lt;/p&gt;

&lt;p&gt;The new unit test passes with this change, while it was failing with the old implementation. Manual testing with JConsole also shows that metrics are now correctly reported in local and cloud mode, and after core and collection reloads.&lt;/p&gt;

&lt;p&gt;This is unfortunately a bigger change than I hoped for, so I&apos;m not sure whether this should go into 7.0 at such late stage in the release. OTOH JMX monitoring is surely broken without this change, so it can&apos;t get much worse &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16125521" author="jira-bot" created="Mon, 14 Aug 2017 10:43:12 +0000"  >&lt;p&gt;Commit 7aa660b747440bfc5beb63051db324db3c5dd761 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=7aa660b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=7aa660b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11221&quot; title=&quot;SolrJmxReporter broken on core reload&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11221&quot;&gt;&lt;del&gt;SOLR-11221&lt;/del&gt;&lt;/a&gt;: SolrJmxReporter broken on core reload.&lt;/p&gt;</comment>
                            <comment id="16125547" author="jira-bot" created="Mon, 14 Aug 2017 11:10:17 +0000"  >&lt;p&gt;Commit ff8b90b9acb7685a77d3b4af14f18aedb681176f in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ff8b90b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ff8b90b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11221&quot; title=&quot;SolrJmxReporter broken on core reload&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11221&quot;&gt;&lt;del&gt;SOLR-11221&lt;/del&gt;&lt;/a&gt;: Fix precommit issues.&lt;/p&gt;</comment>
                            <comment id="16125567" author="jira-bot" created="Mon, 14 Aug 2017 11:46:41 +0000"  >&lt;p&gt;Commit 2711dbed8b4b72c37fa929be5167fb6a823c1134 in lucene-solr&apos;s branch refs/heads/branch_7x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=2711dbe&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=2711dbe&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11221&quot; title=&quot;SolrJmxReporter broken on core reload&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11221&quot;&gt;&lt;del&gt;SOLR-11221&lt;/del&gt;&lt;/a&gt;: SolrJmxReporter broken on core reload.&lt;/p&gt;</comment>
                            <comment id="16125604" author="jira-bot" created="Mon, 14 Aug 2017 12:26:14 +0000"  >&lt;p&gt;Commit be596b90696b24c4e73e3e1455f1fb95dcc58b0d in lucene-solr&apos;s branch refs/heads/branch_7_0 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=be596b9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=be596b9&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11221&quot; title=&quot;SolrJmxReporter broken on core reload&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11221&quot;&gt;&lt;del&gt;SOLR-11221&lt;/del&gt;&lt;/a&gt;: SolrJmxReporter broken on core reload.&lt;/p&gt;</comment>
                            <comment id="16125606" author="ab" created="Mon, 14 Aug 2017 12:27:16 +0000"  >&lt;p&gt;I&apos;m leaving this issue open for now - let&apos;s see if jenkins is happy about this change...&lt;/p&gt;</comment>
                            <comment id="16133632" author="jira-bot" created="Fri, 18 Aug 2017 21:17:39 +0000"  >&lt;p&gt;Commit 54469c7ca5f639a8120d9e4b9e51c0f82ab57b9b in lucene-solr&apos;s branch refs/heads/branch_6_6 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=54469c7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=54469c7&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11221&quot; title=&quot;SolrJmxReporter broken on core reload&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11221&quot;&gt;&lt;del&gt;SOLR-11221&lt;/del&gt;&lt;/a&gt;: SolrJmxReporter broken on core reload.&lt;/p&gt;</comment>
                            <comment id="16207388" author="shalinmangar" created="Tue, 17 Oct 2017 11:03:52 +0000"  >&lt;p&gt;Bulk close after 7.1.0 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12881580" name="SOLR-11221.patch" size="37223" author="ab" created="Sat, 12 Aug 2017 00:00:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 5 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3in3j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>