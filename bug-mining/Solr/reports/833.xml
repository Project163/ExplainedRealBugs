<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:26:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-3241] Document boost fail if a field copy omit the norms</title>
                <link>https://issues.apache.org/jira/browse/SOLR-3241</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;After &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3796&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/LUCENE-3796&lt;/a&gt;, it is not possible to set a boost to a field that has the &quot;omitNorms&quot; set to true. This is making Solr&apos;s document index-time boost to fail when a field that doesn&apos;t omit norms is copied (with copyField) to a field that does omit them and document boost is used. For example:&lt;/p&gt;

&lt;p&gt;&amp;lt;field name=&quot;author&quot; type=&quot;text&quot; indexed=&quot;true&quot; stored=&quot;false&quot; omitNorms=&quot;false&quot;/&amp;gt;&lt;br/&gt;
&amp;lt;field name=&quot;author_display&quot; type=&quot;string&quot; indexed=&quot;true&quot; stored=&quot;true&quot; omitNorms=&quot;true&quot;/&amp;gt;&lt;br/&gt;
&amp;lt;copyField source=&quot;author&quot; dest=&quot;author_display&quot;/&amp;gt;&lt;/p&gt;

&lt;p&gt;I&apos;m attaching a possible fix.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12546299">SOLR-3241</key>
            <summary>Document boost fail if a field copy omit the norms</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rcmuir">Robert Muir</assignee>
                                    <reporter username="tflobbe">Tomas Eduardo Fernandez Lobbe</reporter>
                        <labels>
                    </labels>
                <created>Tue, 13 Mar 2012 21:07:10 +0000</created>
                <updated>Fri, 10 May 2013 10:41:13 +0000</updated>
                            <resolved>Wed, 14 Mar 2012 18:04:31 +0000</resolved>
                                                    <fixVersion>3.6</fixVersion>
                    <fixVersion>4.0-ALPHA</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13228841" author="tomasflobbe" created="Wed, 14 Mar 2012 00:25:34 +0000"  >&lt;p&gt;This still doesn&apos;t work for Types with subtypes, like LatLonType and CurrencyType&lt;/p&gt;</comment>
                            <comment id="13228914" author="hossman" created="Wed, 14 Mar 2012 03:09:08 +0000"  >&lt;p&gt;part of me things we should just remove the error checking for &lt;tt&gt;omitNorms &amp;amp;&amp;amp; boost != 1.0F&lt;/tt&gt; from DocumentBuilder.toDocument (added in /&lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3796&quot; title=&quot;Disallow setBoost() on StringField, throw exception if boosts are set if norms are omitted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LUCENE-3796&quot;&gt;&lt;del&gt;LUCENE-3796&lt;/del&gt;&lt;/a&gt;) and just silently ignore any boost on a SolrInputField where omitNorms==true (ie: maybe log a warning, but don&apos;t throw an Exception).  This would be consistent with the behavior in past releases (except for the warning log if we add that), and wouldn&apos;t cause any confusing errors for things like LatLonType (even if they come from third-party plugins we can&apos;t contro/test)&lt;/p&gt;

&lt;p&gt;On the other hand... that feels really dirty, and it would be nice to fail fast and loud if the client tries to set a boost on an omitNorms field&lt;/p&gt;

&lt;p&gt;Perhaps a better fix would be to leave DocumentBuilder exactly as it is today, and instead change FieldType.createField to (silently) ignore the boost if omitNorms==true for that SchemaField.  if i&apos;m thinking about this right, that would mean the error checking of the SolrInputDocument (and all it&apos;s SolrInputFields) in DocumentBuilder.toDocument would still work as designed &amp;#8211; so you&apos;d get an error if any client or &quot;high level&quot; plugin like an UpdateProcessor tried to use a field boost on an omitNorms field; but any fields added at a lower level (ie: by copyField or a poly field) would silently ignore those boosts if they were copied/cloned to a field where omitNorms==true.&lt;/p&gt;




</comment>
                            <comment id="13228916" author="rcmuir" created="Wed, 14 Mar 2012 03:11:51 +0000"  >&lt;p&gt;Thanks Tom&#225;s (and thanks for the patch!) I&apos;ll look into this.&lt;/p&gt;

&lt;p&gt;The concept of document boost doesn&apos;t really exist anymore, and I don&apos;t think we should fail for an omitNorms field &lt;br/&gt;
just because of the document boost. It just won&apos;t be applied to that field.&lt;/p&gt;

&lt;p&gt;The point is only to fail if someone explicitly boosts an omitNorms field itself.&lt;/p&gt;</comment>
                            <comment id="13228921" author="rcmuir" created="Wed, 14 Mar 2012 03:25:02 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Perhaps a better fix would be to leave DocumentBuilder exactly as it is today, and instead change FieldType.createField to (silently) ignore the boost if omitNorms==true for that SchemaField. if i&apos;m thinking about this right, that would mean the error checking of the SolrInputDocument (and all it&apos;s SolrInputFields) in DocumentBuilder.toDocument would still work as designed &#8211; so you&apos;d get an error if any client or &quot;high level&quot; plugin like an UpdateProcessor tried to use a field boost on an omitNorms field; but any fields added at a lower level (ie: by copyField or a poly field) would silently ignore those boosts if they were copied/cloned to a field where omitNorms==true.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hoss: this sounds good to me? we can add tests that the basic case is still working. &lt;/p&gt;

&lt;p&gt;The reason the logic was somewhat complicated in DocumentBuilder is because, from the lucene indexer its easy to detect this case, but:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;As mentioned before, &quot;document boost&quot; is something only in solr now, so the idea was not to fail just because you had omitNorms field and solr multiplied document boost into field boosts. But this copyField/polyField is an exception as you mention&lt;/li&gt;
	&lt;li&gt;explicit handling was added to DocumentBuilder because its better for Solr to throw an exception here than rely upon lucene, lucene&apos;s exception&lt;br/&gt;
is &quot;nastier&quot; in the sense its a lower-level non-aborting exception that will produce a deleted document.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="13228924" author="hossman" created="Wed, 14 Mar 2012 03:39:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;The reason the logic was somewhat complicated in DocumentBuilder is because, from the lucene indexer its easy to detect this case, but:&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;sure ... but i think it&apos;s not actually just &quot;Document Boost&quot; is it?  if field &quot;foo&quot; is declared with omitNorms==false, and a client sends a doc with a field &quot;foo&quot; using a fieldBoost then that should be totally fine &amp;#8211; but if the schema says to copyField from foo-&amp;gt;bar where bar has omitNorms==true then i think that will currently cause an from the lucene low level check, corret? (i haven&apos;t tried it, i&apos;m going based on tomas&apos;s path) likewise if &quot;foo&quot; is a LatLonField (or any other polyfield) and the underlying dynamic field used has omitNorms==true then won&apos;t that same low level lucene code throw an error there?&lt;/p&gt;

&lt;p&gt;so multiple error paths from totally sane usage none of which has anything to do with doc boost, right?&lt;/p&gt;

&lt;p&gt;(Truth be told, i didn&apos;t even notice the &quot;Document boost&quot; part of the summary, i was just looking at tomas&apos;s patch and skimming the summary)&lt;/p&gt;</comment>
                            <comment id="13228930" author="rcmuir" created="Wed, 14 Mar 2012 03:52:55 +0000"  >&lt;blockquote&gt;
&lt;p&gt;but if the schema says to copyField from foo-&amp;gt;bar where bar has omitNorms==true then i think that will currently cause an from the lucene low level check, corret?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I have no idea.. does copyField actually copy field boosts too? &lt;/p&gt;

&lt;p&gt;The attached test in the patch is a case of document boosting + copyField only.&lt;/p&gt;</comment>
                            <comment id="13229134" author="tomasflobbe" created="Wed, 14 Mar 2012 11:17:33 +0000"  >&lt;p&gt;I found the issue with copyfields as you mentioned Robert. foo is omitNorms=false, and bar is omitNorms=true. I have a copyfield foo-&amp;gt;bar and I add a document like:&lt;br/&gt;
&amp;lt;document boost=X&amp;gt;&lt;br/&gt;
&amp;lt;field name=foo&amp;gt;AAAAAA&amp;lt;/field&amp;gt;&lt;br/&gt;
&amp;lt;/document&amp;gt;&lt;/p&gt;

&lt;p&gt;This case is fixed by the patch. Testing it, i found a similar situation where a field1 is a poly type with omitNorms=false, and the subtype if it has omitNorms=true. In this case, it fails even without a copyfield just by adding a document like:&lt;/p&gt;

&lt;p&gt;&amp;lt;document boost=X&amp;gt;&lt;br/&gt;
&amp;lt;field name=poly&amp;gt;AAA,BBB&amp;lt;/field&amp;gt;&lt;br/&gt;
&amp;lt;/document&amp;gt;&lt;/p&gt;

&lt;p&gt;I don&apos;t know if it makes sense to have a poly field where the subtype have a different value in the &quot;omitNorms&quot; attribute, probably this should fail even before the document is added.&lt;/p&gt;</comment>
                            <comment id="13229157" author="rcmuir" created="Wed, 14 Mar 2012 12:46:44 +0000"  >&lt;p&gt;updating the patch from Tom&#225;s to include an additional test for the field boost+copyField.&lt;/p&gt;

&lt;p&gt;we still need to add tests for this polyField case, and any other possibilities (can you polyField+copyField?)&lt;/p&gt;</comment>
                            <comment id="13229183" author="rcmuir" created="Wed, 14 Mar 2012 13:38:39 +0000"  >&lt;p&gt;Updated patch with fixes for the polyfield case (untested!)&lt;/p&gt;

&lt;p&gt;After reviewing the code: Tom&#225;s had the correct fix for the copyField case, his patch fixes a logic bug, nothing more!&lt;/p&gt;

&lt;p&gt;The polyField case is different: its too late in DocumentBuilder to do anything here after the creation of IndexableFields: moreover we cannot nuke the whole boost for the field because we cannot assume anything just because isPolyField() == true, for example a custom field type might not even be instanceof AbstractSubTypeField! &lt;/p&gt;

&lt;p&gt;Because of this I think these fieldtypes should really treat the fact they use &apos;real fields&apos; as an impl detail. so I added the logic to their subfield creation.&lt;/p&gt;</comment>
                            <comment id="13229229" author="tomasflobbe" created="Wed, 14 Mar 2012 14:28:42 +0000"  >&lt;p&gt;I&apos;m attaching another patch with some more tests.&lt;br/&gt;
Also updated the DocumentBuilder to use the existing logic instead of replicating it where the fix is applied.&lt;/p&gt;</comment>
                            <comment id="13229243" author="rcmuir" created="Wed, 14 Mar 2012 14:59:48 +0000"  >&lt;p&gt;Thanks, patch looks good!&lt;/p&gt;

&lt;p&gt;I&apos;ll wait a bit for any other input.&lt;/p&gt;</comment>
                            <comment id="13229298" author="hossman" created="Wed, 14 Mar 2012 16:19:43 +0000"  >&lt;p&gt;patch looks fine ... i wish there was a way to make it easier for poly fields so they wouldn&apos;t have do do the check themselves, but when i tried the idea i had it didn&apos;t work, so better to go with this for now and maybe refactor a helper method later.&lt;/p&gt;

&lt;p&gt;the few changes i would make:&lt;/p&gt;

&lt;p&gt;1) make the new tests grab the IndexSchema obejct and assert that every field (that the cares about) has the expected omitNorms value &amp;#8211; future proof ourselves against someone nuetering the test w/o realizing by tweaking the test schema because they don&apos;t know that there is a specific reason for those omitNorm settings&lt;/p&gt;

&lt;p&gt;2) add a test that explicitly verifies the failure case of someone setting field boost on a field with omitNorms==true, assert that we get the expected error mesg (doesn&apos;t look like this was added when &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3796&quot; title=&quot;Disallow setBoost() on StringField, throw exception if boosts are set if norms are omitted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LUCENE-3796&quot;&gt;&lt;del&gt;LUCENE-3796&lt;/del&gt;&lt;/a&gt; was commited, and we want to make sure we don&apos;t inadvertantly break that error check)&lt;/p&gt;
</comment>
                            <comment id="13229337" author="rcmuir" created="Wed, 14 Mar 2012 16:54:50 +0000"  >&lt;p&gt;updated patch with hossman&apos;s suggested test improvements. I&apos;ll commit soon.&lt;/p&gt;</comment>
                            <comment id="13229443" author="rcmuir" created="Wed, 14 Mar 2012 18:04:31 +0000"  >&lt;p&gt;Thanks Tom&#225;s!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12518338" name="SOLR-3241.patch" size="11530" author="rcmuir" created="Wed, 14 Mar 2012 16:54:50 +0000"/>
                            <attachment id="12518326" name="SOLR-3241.patch" size="8614" author="tflobbe" created="Wed, 14 Mar 2012 14:28:42 +0000"/>
                            <attachment id="12518319" name="SOLR-3241.patch" size="5747" author="rcmuir" created="Wed, 14 Mar 2012 13:38:39 +0000"/>
                            <attachment id="12518313" name="SOLR-3241.patch" size="3574" author="rcmuir" created="Wed, 14 Mar 2012 12:46:43 +0000"/>
                            <attachment id="12518247" name="SOLR-3241.patch" size="2951" author="tflobbe" created="Tue, 13 Mar 2012 21:08:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>231457</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 36 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i03fun:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>18001</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>