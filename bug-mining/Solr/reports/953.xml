<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:28:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-3621] Fix concurrency race around newIndexWriter </title>
                <link>https://issues.apache.org/jira/browse/SOLR-3621</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;When I did the first big refactor on update handler, I was trying to never close the index writer - I had to give in on this goal due to the replication handler - it requires rebooting the indexwriter. At the time, I settled for allowing a little race that didn&apos;t show up as an issue in tests - this IW reboot was always a bit of a hack in the past anyhow.&lt;/p&gt;

&lt;p&gt;Now that the dust has settled, we should make this air tight though. I&apos;d like to make opening a new indexwriter a full class citizen rather than a hacky method only used minimally for replication to reboot things. It should be a solid API that is valid for any uses down the road.&lt;/p&gt;

&lt;p&gt;For some IW config changes, we may want to do it in &apos;some&apos; cases on reload.&lt;/p&gt;

&lt;p&gt;To do this, we have to start ref counting iw use - so that we only actually open a new one and close the old one when it&apos;s not in use at all.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12598828">SOLR-3621</key>
            <summary>Fix concurrency race around newIndexWriter </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="markrmiller@gmail.com">Mark Miller</assignee>
                                    <reporter username="markrmiller@gmail.com">Mark Miller</reporter>
                        <labels>
                    </labels>
                <created>Sat, 14 Jul 2012 22:29:54 +0000</created>
                <updated>Mon, 9 May 2016 18:58:14 +0000</updated>
                            <resolved>Fri, 26 Oct 2012 15:37:41 +0000</resolved>
                                                    <fixVersion>4.1</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>update</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13414548" author="markrmiller@gmail.com" created="Sat, 14 Jul 2012 23:40:08 +0000"  >&lt;p&gt;A first patch.&lt;/p&gt;</comment>
                            <comment id="13415965" author="thetaphi" created="Tue, 17 Jul 2012 07:27:22 +0000"  >&lt;p&gt;Hi, this seems to have caused a hang in DIH:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[junit4:junit4] &quot;TEST-TestScope-org.apache.solr.handler.dataimport.TestSqlEntityProcessorDelta2.testCompositePk_DeltaImport_delete-seed#[8C1D20BFF6E9C021]&quot; prio=10 tid=0x00007f1cb4560800 nid=0x1227 in Object.wait() [0x00007f1c92c02000]
[junit4:junit4]    java.lang.Thread.State: WAITING (on object monitor)
[junit4:junit4] 	at java.lang.Object.wait(Native Method)
[junit4:junit4] 	- waiting on &amp;lt;0x00000000fb258658&amp;gt; (a org.apache.solr.update.DefaultSolrCoreState)
[junit4:junit4] 	at java.lang.Object.wait(Object.java:485)
[junit4:junit4] 	at org.apache.solr.update.DefaultSolrCoreState.getIndexWriter(DefaultSolrCoreState.java:59)
[junit4:junit4] 	- locked &amp;lt;0x00000000fb258658&amp;gt; (a org.apache.solr.update.DefaultSolrCoreState)
[junit4:junit4] 	at org.apache.solr.update.DirectUpdateHandler2.deleteAll(DirectUpdateHandler2.java:140)
[junit4:junit4] 	at org.apache.solr.update.DirectUpdateHandler2.deleteByQuery(DirectUpdateHandler2.java:361)
[junit4:junit4] 	- locked &amp;lt;0x00000000fb2584d8&amp;gt; (a org.apache.solr.update.DirectUpdateHandler2)
[junit4:junit4] 	at org.apache.solr.update.processor.RunUpdateProcessor.processDelete(RunUpdateProcessorFactory.java:67)
[junit4:junit4] 	at org.apache.solr.update.processor.UpdateRequestProcessor.processDelete(UpdateRequestProcessor.java:55)
[junit4:junit4] 	at org.apache.solr.update.processor.DistributedUpdateProcessor.doDeleteByQuery(DistributedUpdateProcessor.java:728)
[junit4:junit4] 	at org.apache.solr.update.processor.DistributedUpdateProcessor.processDelete(DistributedUpdateProcessor.java:601)
[junit4:junit4] 	at org.apache.solr.update.processor.UpdateRequestProcessor.processDelete(UpdateRequestProcessor.java:55)
[junit4:junit4] 	at org.apache.solr.handler.dataimport.AbstractDataImportHandlerTestCase$TestUpdateRequestProcessor.processDelete(AbstractDataImportHandlerTestCase.java:364)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;See this build for a complete stack trace: &lt;a href=&quot;http://jenkins.sd-datasolutions.de/job/Lucene-Solr-trunk-Linux-Java6-64/1291/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://jenkins.sd-datasolutions.de/job/Lucene-Solr-trunk-Linux-Java6-64/1291/console&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13416162" author="markrmiller@gmail.com" created="Tue, 17 Jul 2012 13:17:57 +0000"  >&lt;p&gt;Looking...&lt;/p&gt;</comment>
                            <comment id="13416208" author="markrmiller@gmail.com" created="Tue, 17 Jul 2012 14:02:47 +0000"  >&lt;p&gt;I think this is related to the fail that kept happening in DIH tests previously (I was actually hoping this would help fix that test and is why I started looking at this the other day again).&lt;/p&gt;

&lt;p&gt;Part of the problem with that test may be that it uses RAMDir though - I don&apos;t think that in Solr that is compatible with booting a new IndexWriter - which happens during rollback, which happens in some error situations with DIH. I think that&apos;s the &quot;no segments file found issue&quot; that sometimes fails.&lt;/p&gt;

&lt;p&gt;Anyhow, my best current guess for this case is that opening a new writer fails, causes an exception, the getWriter lock is never released, someone tries to get a writer, they wait forever. I&apos;m changing to release that lock in a finally so hopefully the true error is more visible and there is no hang.&lt;/p&gt;

&lt;p&gt;The other fix may be to hard code fsdir for these tests that might rollback - but I&apos;ll wait on that.&lt;/p&gt;</comment>
                            <comment id="13429739" author="rcmuir" created="Tue, 7 Aug 2012 03:42:36 +0000"  >&lt;p&gt;rmuir20120906-bulk-40-change&lt;/p&gt;</comment>
                            <comment id="13452212" author="rcmuir" created="Mon, 10 Sep 2012 17:41:58 +0000"  >&lt;p&gt;moving all 4.0 issues not touched in a month to 4.1&lt;/p&gt;</comment>
                            <comment id="13485006" author="markrmiller@gmail.com" created="Fri, 26 Oct 2012 15:37:41 +0000"  >&lt;p&gt;Have no seen any reports of problems here in a while, and all this had hardened a fair amount by now.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12536528" name="SOLR--3621.patch" size="27748" author="markrmiller@gmail.com" created="Sat, 14 Jul 2012 23:39:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>243359</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 4 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i03dlj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>17636</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>