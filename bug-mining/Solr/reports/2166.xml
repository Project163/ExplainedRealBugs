<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:59:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-6579] SnapPuller Replication blocks clean shutdown of tomcat</title>
                <link>https://issues.apache.org/jira/browse/SOLR-6579</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;main issue was described in the mailing list here:&lt;br/&gt;
&lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/lucene-solr-user/201409.mbox/browser&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://mail-archives.apache.org/mod_mbox/lucene-solr-user/201409.mbox/browser&lt;/a&gt;&lt;br/&gt;
and &lt;br/&gt;
here:&lt;/p&gt;

&lt;p&gt;but also including the quotes:&lt;br/&gt;
original message from Nick&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Hello,&lt;br/&gt;
I have solr 4.10 running on tomcat 7. I&apos;m doing replication from one master&lt;br/&gt;
to about 10 slaves, with standard configuration:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;      &amp;lt;requestHandler name=&lt;span class=&quot;code-quote&quot;&gt;&quot;/replication&quot;&lt;/span&gt; class=&lt;span class=&quot;code-quote&quot;&gt;&quot;solr.ReplicationHandler&quot;&lt;/span&gt; &amp;gt;
           &amp;lt;lst name=&lt;span class=&quot;code-quote&quot;&gt;&quot;master&quot;&lt;/span&gt;&amp;gt;
             &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;enable&quot;&lt;/span&gt;&amp;gt;${enable.master:&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;}&amp;lt;/str&amp;gt;
             &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;replicateAfter&quot;&lt;/span&gt;&amp;gt;commit&amp;lt;/str&amp;gt;
             &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;replicateAfter&quot;&lt;/span&gt;&amp;gt;startup&amp;lt;/str&amp;gt;
             &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;confFiles&quot;&lt;/span&gt;&amp;gt;schema.xml,stopwords.txt&amp;lt;/str&amp;gt;
             &amp;lt;!-- str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;commitReserveDuration&quot;&lt;/span&gt;&amp;gt;00:00:10&amp;lt;/str --&amp;gt;
           &amp;lt;/lst&amp;gt;
           &amp;lt;lst name=&lt;span class=&quot;code-quote&quot;&gt;&quot;slave&quot;&lt;/span&gt;&amp;gt;
             &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;enable&quot;&lt;/span&gt;&amp;gt;${enable.slave:&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;}&amp;lt;/str&amp;gt;
             &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;masterUrl&quot;&lt;/span&gt;&amp;gt;http:&lt;span class=&quot;code-comment&quot;&gt;//master:8080/solr/mycore&amp;lt;/str&amp;gt;
&lt;/span&gt;             &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;pollInterval&quot;&lt;/span&gt;&amp;gt;00:00:60&amp;lt;/str&amp;gt;
           &amp;lt;/lst&amp;gt;
      &amp;lt;/requestHandler&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It appears that if tomcat gets shutdown while solr is replicating, it&lt;br/&gt;
prevents tomcat from shutting down fully. Immediately after receiving the&lt;br/&gt;
shutdown command, a thread dump is logged into catalina.out (this may have&lt;br/&gt;
been turned on by some configuration someone else on my team made). I&lt;br/&gt;
removed some threads that didn&apos;t look related, mostly about tomcat session&lt;br/&gt;
replication, or with names like &quot;http-bio-8080-exec-10&quot;.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    62252 [http-bio-8080-exec-1] INFO  org.apache.solr.core.SolrCore  &#8211;
[mycore] webapp=/solr path=/replication
params={command=details&amp;amp;_=1412014928648&amp;amp;wt=json} status=0 QTime=6
    63310 [http-bio-8080-exec-1] INFO  org.apache.solr.core.SolrCore  &#8211;
[mycore] webapp=/solr path=/replication
params={command=details&amp;amp;_=1412014929699&amp;amp;wt=json} status=0 QTime=6
    2014-09-29 14:22:10
    Full thread dump Java HotSpot(TM) 64-Bit Server VM (24.65-b04 mixed
mode):

    &lt;span class=&quot;code-quote&quot;&gt;&quot;fsyncService-12-thread-1&quot;&lt;/span&gt; prio=10 tid=0x00007f3bd4002000 nid=0x203d
waiting on condition [0x00007f3c271f0000]
       java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (parking)
            at sun.misc.Unsafe.park(Native Method)
            - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000007e1ff4458&amp;gt; (a
java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
            at
java.util.concurrent.locks.LockSupport.park(LockSupport.java:186)
            at
java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2043)
            at
java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:442)
            at
java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1068)
            at
java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130)
            at
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)

    &lt;span class=&quot;code-quote&quot;&gt;&quot;explicit-fetchindex-cmd&quot;&lt;/span&gt; daemon prio=10 tid=0x00007f3c0413e800
nid=0x203c runnable [0x00007f3c272f1000]
       java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE
            at java.net.SocketInputStream.socketRead0(Native Method)
            at java.net.SocketInputStream.read(SocketInputStream.java:152)
            at java.net.SocketInputStream.read(SocketInputStream.java:122)
            at
org.apache.http.impl.io.AbstractSessionInputBuffer.read(AbstractSessionInputBuffer.java:198)
            at
org.apache.http.impl.io.ChunkedInputStream.read(ChunkedInputStream.java:174)
            at
org.apache.http.conn.EofSensorInputStream.read(EofSensorInputStream.java:137)
            at
org.apache.solr.common.util.FastInputStream.readWrappedStream(FastInputStream.java:80)
            at
org.apache.solr.common.util.FastInputStream.read(FastInputStream.java:114)
            at
org.apache.solr.common.util.FastInputStream.readFully(FastInputStream.java:152)
            at
org.apache.solr.handler.SnapPuller$DirectoryFileFetcher.fetchPackets(SnapPuller.java:1239)
            at
org.apache.solr.handler.SnapPuller$DirectoryFileFetcher.fetchFile(SnapPuller.java:1187)
            at
org.apache.solr.handler.SnapPuller.downloadIndexFiles(SnapPuller.java:774)
            at
org.apache.solr.handler.SnapPuller.fetchLatestIndex(SnapPuller.java:424)
            at
org.apache.solr.handler.ReplicationHandler.doFetch(ReplicationHandler.java:337)
            at
org.apache.solr.handler.ReplicationHandler$1.run(ReplicationHandler.java:227)

    &lt;span class=&quot;code-quote&quot;&gt;&quot;process reaper&quot;&lt;/span&gt; daemon prio=10 tid=0x00007f3c0409c000 nid=0x203b
waiting on condition [0x00007f3c984e9000]
       java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: TIMED_WAITING (parking)
            at sun.misc.Unsafe.park(Native Method)
            - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000007dfbfd890&amp;gt; (a
java.util.concurrent.SynchronousQueue$TransferStack)
            at
java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:226)
            at
java.util.concurrent.SynchronousQueue$TransferStack.awaitFulfill(SynchronousQueue.java:460)
            at
java.util.concurrent.SynchronousQueue$TransferStack.transfer(SynchronousQueue.java:359)
            at
java.util.concurrent.SynchronousQueue.poll(SynchronousQueue.java:942)
            at
java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1068)
            at
java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130)
            at
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)

    &lt;span class=&quot;code-quote&quot;&gt;&quot;process reaper&quot;&lt;/span&gt; daemon prio=10 tid=0x00007f3c0409a000 nid=0x2039
waiting on condition [0x00007f3cac040000]
       java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: TIMED_WAITING (parking)
            at sun.misc.Unsafe.park(Native Method)
            - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000007dfbfd890&amp;gt; (a
java.util.concurrent.SynchronousQueue$TransferStack)
            at
java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:226)
            at
java.util.concurrent.SynchronousQueue$TransferStack.awaitFulfill(SynchronousQueue.java:460)
            at
java.util.concurrent.SynchronousQueue$TransferStack.transfer(SynchronousQueue.java:359)
            at
java.util.concurrent.SynchronousQueue.poll(SynchronousQueue.java:942)
            at
java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1068)
            at
java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130)
            at
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)

    &lt;span class=&quot;code-quote&quot;&gt;&quot;ajp-bio-8009-AsyncTimeout&quot;&lt;/span&gt; daemon prio=10 tid=0x00007f3ce013c000
nid=0x202e waiting on condition [0x00007f3c27af9000]
       java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: TIMED_WAITING (sleeping)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(Native Method)
            at
org.apache.tomcat.util.net.JIoEndpoint$AsyncTimeout.run(JIoEndpoint.java:148)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)

    &lt;span class=&quot;code-quote&quot;&gt;&quot;ajp-bio-8009-Acceptor-0&quot;&lt;/span&gt; daemon prio=10 tid=0x00007f3ce013a800
nid=0x202d runnable [0x00007f3c985ea000]
       java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE
            at java.net.PlainSocketImpl.socketAccept(Native Method)
            at
java.net.AbstractPlainSocketImpl.accept(AbstractPlainSocketImpl.java:398)
            at java.net.ServerSocket.implAccept(ServerSocket.java:530)
            at java.net.ServerSocket.accept(ServerSocket.java:498)
            at
org.apache.tomcat.util.net.DefaultServerSocketFactory.acceptSocket(DefaultServerSocketFactory.java:60)
            at
org.apache.tomcat.util.net.JIoEndpoint$Acceptor.run(JIoEndpoint.java:216)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)

    &lt;span class=&quot;code-quote&quot;&gt;&quot;http-bio-8080-exec-1&quot;&lt;/span&gt; daemon prio=10 tid=0x00007f3c0c001800 nid=0x202c
runnable [0x00007f3c986eb000]
       java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE
            at java.net.SocketInputStream.socketRead0(Native Method)
            at java.net.SocketInputStream.read(SocketInputStream.java:152)
            at java.net.SocketInputStream.read(SocketInputStream.java:122)
            at
org.apache.coyote.http11.InternalInputBuffer.fill(InternalInputBuffer.java:516)
            at
org.apache.coyote.http11.InternalInputBuffer.fill(InternalInputBuffer.java:501)
            at
org.apache.coyote.http11.Http11Processor.setRequestLineReadTimeout(Http11Processor.java:173)
            at
org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:927)
            at
org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:589)
            at
org.apache.tomcat.util.net.JIoEndpoint$SocketProcessor.run(JIoEndpoint.java:312)
            - locked &amp;lt;0x00000007df0874b0&amp;gt; (a
org.apache.tomcat.util.net.SocketWrapper)
            at
java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
            at
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)

    &lt;span class=&quot;code-quote&quot;&gt;&quot;http-bio-8080-AsyncTimeout&quot;&lt;/span&gt; daemon prio=10 tid=0x00007f3ce0139000
nid=0x202b waiting on condition [0x00007f3cac1aa000]
       java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: TIMED_WAITING (sleeping)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(Native Method)
            at
org.apache.tomcat.util.net.JIoEndpoint$AsyncTimeout.run(JIoEndpoint.java:148)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)

    &lt;span class=&quot;code-quote&quot;&gt;&quot;http-bio-8080-Acceptor-0&quot;&lt;/span&gt; daemon prio=10 tid=0x00007f3ce0138000
nid=0x202a runnable [0x00007f3cac2ab000]
       java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE
            at java.net.PlainSocketImpl.socketAccept(Native Method)
            at
java.net.AbstractPlainSocketImpl.accept(AbstractPlainSocketImpl.java:398)
            at java.net.ServerSocket.implAccept(ServerSocket.java:530)
            at java.net.ServerSocket.accept(ServerSocket.java:498)
            at
org.apache.tomcat.util.net.DefaultServerSocketFactory.acceptSocket(DefaultServerSocketFactory.java:60)
            at
org.apache.tomcat.util.net.JIoEndpoint$Acceptor.run(JIoEndpoint.java:216)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)

    &lt;span class=&quot;code-quote&quot;&gt;&quot;ContainerBackgroundProcessor[StandardEngine[Catalina]]&quot;&lt;/span&gt; daemon prio=10
tid=0x00007f3ce05b4000 nid=0x2029 waiting on condition [0x00007f3cacbb7000]
       java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: TIMED_WAITING (sleeping)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(Native Method)
            at
org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.run(ContainerBase.java:1508)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)

    &lt;span class=&quot;code-quote&quot;&gt;&quot;clock:10000&quot;&lt;/span&gt; daemon prio=10 tid=0x00007f3c5cafc000 nid=0x2028 in
&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait() [0x00007f3c27bfa000]
       java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: TIMED_WAITING (on object monitor)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
            - waiting on &amp;lt;0x00000007dc6cf7e8&amp;gt; (a
org.webmacro.util.Clock$ClockThread)
            at org.webmacro.util.Clock$ClockThread.run(Clock.java:108)
            - locked &amp;lt;0x00000007dc6cf7e8&amp;gt; (a
org.webmacro.util.Clock$ClockThread)

    &lt;span class=&quot;code-quote&quot;&gt;&quot;TimeLoop(1000,600)&quot;&lt;/span&gt; daemon prio=10 tid=0x00007f3c5cac6000 nid=0x2027
waiting on condition [0x00007f3c27cfb000]
       java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: TIMED_WAITING (sleeping)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(Native Method)
            at
org.webmacro.util.TimeLoop$TimeLoopThread.run(TimeLoop.java:237)

    &lt;span class=&quot;code-quote&quot;&gt;&quot;pool-1-thread-2&quot;&lt;/span&gt; daemon prio=10 tid=0x00007f3c5d1b3800 nid=0x2022
waiting on condition [0x00007f3c98246000]
       java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (parking)
            at sun.misc.Unsafe.park(Native Method)
            - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x000000070b90b4a0&amp;gt; (a
java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
            at
java.util.concurrent.locks.LockSupport.park(LockSupport.java:186)
            at
java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2043)
            at
java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:442)
            at
java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1068)
            at
java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130)
            at
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)

    &lt;span class=&quot;code-quote&quot;&gt;&quot;Java2D Disposer&quot;&lt;/span&gt; daemon prio=10 tid=0x00007f3c5cfeb800 nid=0x2021 in
&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait() [0x00007f3c9835d000]
       java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (on object monitor)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
            - waiting on &amp;lt;0x00000007e6030140&amp;gt; (a
java.lang.ref.ReferenceQueue$Lock)
            at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:135)
            - locked &amp;lt;0x00000007e6030140&amp;gt; (a
java.lang.ref.ReferenceQueue$Lock)
            at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:151)
            at sun.java2d.Disposer.run(Disposer.java:145)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)

    &lt;span class=&quot;code-quote&quot;&gt;&quot;MySQL Statement Cancellation Timer&quot;&lt;/span&gt; daemon prio=10
tid=0x00007f3c5ca0c000 nid=0x2020 in &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait() [0x00007f3c9845e000]
       java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (on object monitor)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
            - waiting on &amp;lt;0x00000007e5f45ad8&amp;gt; (a java.util.TaskQueue)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.java:503)
            at java.util.TimerThread.mainLoop(Timer.java:526)
            - locked &amp;lt;0x00000007e5f45ad8&amp;gt; (a java.util.TaskQueue)
            at java.util.TimerThread.run(Timer.java:505)

    &lt;span class=&quot;code-quote&quot;&gt;&quot;Timer-0&quot;&lt;/span&gt; daemon prio=10 tid=0x00007f3c5c9f7800 nid=0x201f in
&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait() [0x00007f3cad0bc000]
       java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (on object monitor)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
            - waiting on &amp;lt;0x00000007e605a8d8&amp;gt; (a java.util.TaskQueue)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.java:503)
            at java.util.TimerThread.mainLoop(Timer.java:526)
            - locked &amp;lt;0x00000007e605a8d8&amp;gt; (a java.util.TaskQueue)
            at java.util.TimerThread.run(Timer.java:505)

    &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-5&quot;&lt;/span&gt; daemon prio=10 tid=0x00007f3c5c00f800 nid=0x201e in
&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait() [0x00007f3cac3ac000]
       java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (on object monitor)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
            - waiting on &amp;lt;0x000000070b92b230&amp;gt; (a java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.java:503)
            at org.apache.solr.core.CloserThread.run(CoreContainer.java:905)
            - locked &amp;lt;0x000000070b92b230&amp;gt; (a java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;)

    &lt;span class=&quot;code-quote&quot;&gt;&quot;snapPuller-10-thread-1&quot;&lt;/span&gt; prio=10 tid=0x00007f3c6c26e800 nid=0x201d
waiting on condition [0x00007f3cac555000]
       java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: TIMED_WAITING (parking)
            at sun.misc.Unsafe.park(Native Method)
            - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x000000070b92b2a8&amp;gt; (a
java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
            at
java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:226)
            at
java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:2082)
            at
java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(ScheduledThreadPoolExecutor.java:1090)
            at
java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(ScheduledThreadPoolExecutor.java:807)
            at
java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1068)
            at
java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130)
            at
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)

    &lt;span class=&quot;code-quote&quot;&gt;&quot;searcherExecutor-6-thread-1&quot;&lt;/span&gt; prio=10 tid=0x00007f3c6c1ea000 nid=0x201c
waiting on condition [0x00007f3cac810000]
       java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (parking)
            at sun.misc.Unsafe.park(Native Method)
            - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x000000070b92b440&amp;gt; (a
java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
            at
java.util.concurrent.locks.LockSupport.park(LockSupport.java:186)
            at
java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2043)
            at
java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:442)
            at
java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1068)
            at
java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130)
            at
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)

    &lt;span class=&quot;code-quote&quot;&gt;&quot;GC Daemon&quot;&lt;/span&gt; daemon prio=10 tid=0x00007f3ce0536000 nid=0x200d in
&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait() [0x00007f3cd8137000]
       java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: TIMED_WAITING (on object monitor)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
            - waiting on &amp;lt;0x000000070bbee5b0&amp;gt; (a sun.misc.GC$LatencyLock)
            at sun.misc.GC$Daemon.run(GC.java:117)
            - locked &amp;lt;0x000000070bbee5b0&amp;gt; (a sun.misc.GC$LatencyLock)

    &lt;span class=&quot;code-quote&quot;&gt;&quot;Service &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;&quot;&lt;/span&gt; daemon prio=10 tid=0x00007f3ce00a6000 nid=0x200b
runnable [0x0000000000000000]
       java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE

    &lt;span class=&quot;code-quote&quot;&gt;&quot;C2 CompilerThread1&quot;&lt;/span&gt; daemon prio=10 tid=0x00007f3ce00a4000 nid=0x200a
waiting on condition [0x0000000000000000]
       java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE

    &lt;span class=&quot;code-quote&quot;&gt;&quot;C2 CompilerThread0&quot;&lt;/span&gt; daemon prio=10 tid=0x00007f3ce00a1000 nid=0x2009
waiting on condition [0x0000000000000000]
       java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE

    &lt;span class=&quot;code-quote&quot;&gt;&quot;Signal Dispatcher&quot;&lt;/span&gt; daemon prio=10 tid=0x00007f3ce009f800 nid=0x2008
waiting on condition [0x0000000000000000]
       java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE

    &lt;span class=&quot;code-quote&quot;&gt;&quot;Finalizer&quot;&lt;/span&gt; daemon prio=10 tid=0x00007f3ce0077800 nid=0x2007 in
&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait() [0x00007f3cd8c1b000]
       java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (on object monitor)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
            - waiting on &amp;lt;0x000000070bbee828&amp;gt; (a
java.lang.ref.ReferenceQueue$Lock)
            at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:135)
            - locked &amp;lt;0x000000070bbee828&amp;gt; (a
java.lang.ref.ReferenceQueue$Lock)
            at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:151)
            at
java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:209)

    &lt;span class=&quot;code-quote&quot;&gt;&quot;Reference Handler&quot;&lt;/span&gt; daemon prio=10 tid=0x00007f3ce0075800 nid=0x2006 in
&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait() [0x00007f3cadffe000]
       java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (on object monitor)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
            - waiting on &amp;lt;0x000000070b8b23b8&amp;gt; (a
java.lang.ref.Reference$Lock)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.java:503)
            at
java.lang.ref.Reference$ReferenceHandler.run(Reference.java:133)
            - locked &amp;lt;0x000000070b8b23b8&amp;gt; (a java.lang.ref.Reference$Lock)

    &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; prio=10 tid=0x00007f3ce0009000 nid=0x1ffc runnable
[0x00007f3ce675c000]
       java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE
            at java.net.PlainSocketImpl.socketAccept(Native Method)
            at
java.net.AbstractPlainSocketImpl.accept(AbstractPlainSocketImpl.java:398)
            at java.net.ServerSocket.implAccept(ServerSocket.java:530)
            at java.net.ServerSocket.accept(ServerSocket.java:498)
            at
org.apache.catalina.core.StandardServer.await(StandardServer.java:452)
            at org.apache.catalina.startup.Catalina.await(Catalina.java:766)
            at org.apache.catalina.startup.Catalina.start(Catalina.java:712)
            at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
            at
sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
            at
sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
            at java.lang.reflect.Method.invoke(Method.java:606)
            at
org.apache.catalina.startup.Bootstrap.start(Bootstrap.java:322)
            at
org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:456)

    JNI global references: 422

    Heap
     PSYoungGen      total 1184256K, used 1031985K [0x00000007aaa80000,
0x0000000800000000, 0x0000000800000000)
      eden space 970240K, 94% used
[0x00000007aaa80000,0x00000007e259e740,0x00000007e5e00000)
      from space 214016K, 55% used
[0x00000007e5e00000,0x00000007ed2adfd0,0x00000007f2f00000)
      to   space 212480K, 0% used
[0x00000007f3080000,0x00000007f3080000,0x0000000800000000)
     ParOldGen       total 1398272K, used 209681K [0x0000000700000000,
0x0000000755580000, 0x00000007aaa80000)
      object space 1398272K, 14% used
[0x0000000700000000,0x000000070ccc4700,0x0000000755580000)
     PSPermGen       total 78848K, used 78659K [0x00000006c0000000,
0x00000006c4d00000, 0x0000000700000000)
      object space 78848K, 99% used
[0x00000006c0000000,0x00000006c4cd0ca8,0x00000006c4d00000)

right after &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, here comes the shutdown:

    Sep 29, 2014 2:22:10 PM org.apache.catalina.core.StandardServer await
    INFO: A valid shutdown command was received via the shutdown port.
Stopping the Server instance.
    Sep 29, 2014 2:22:10 PM org.apache.coyote.AbstractProtocol pause
    INFO: Pausing ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;http-bio-8080&quot;&lt;/span&gt;]
    Sep 29, 2014 2:22:10 PM org.apache.coyote.AbstractProtocol pause
    INFO: Pausing ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;ajp-bio-8009&quot;&lt;/span&gt;]
    Sep 29, 2014 2:22:11 PM org.apache.catalina.core.StandardService
stopInternal
    INFO: Stopping service Catalina
    Sep 29, 2014 2:22:11 PM
org.apache.catalina.ha.session.JvmRouteBinderValve stopInternal
    INFO: JvmRouteBinderValve stopped
    Sep 29, 2014 2:22:11 PM org.apache.catalina.ha.session.DeltaManager
stopInternal
    INFO: Manager [localhost#/dy] expiring sessions upon shutdown

(snip some stuff about an unrelated webapp, then the solr errors)

    64876 [localhost-startStop-2] INFO  org.apache.solr.core.CoreContainer
 &#8211; Shutting down CoreContainer instance=1359815787
    64877 [localhost-startStop-2] INFO  org.apache.solr.core.SolrCore  &#8211;
[mycore]  CLOSING SolrCore org.apache.solr.core.SolrCore@1ade5d50
    64882 [localhost-startStop-2] INFO
 org.apache.solr.update.UpdateHandler  &#8211; closing
DirectUpdateHandler2{commits=0,autocommit
maxTime=15000ms,autocommits=0,soft
autocommits=0,optimizes=0,rollbacks=0,expungeDeletes=0,docsPending=0,adds=0,deletesById=0,deletesByQuery=0,errors=0,cumulative_adds=0,cumulative_deletesById=0,cumulative_deletesByQuery=0,cumulative_errors=0,transaction_logs_total_size=0,transaction_logs_total_number=0}
    64883 [localhost-startStop-2] INFO
 org.apache.solr.update.SolrCoreState  &#8211; Closing SolrCoreState
    64883 [localhost-startStop-2] INFO
 org.apache.solr.update.DefaultSolrCoreState  &#8211; SolrCoreState ref count has
reached 0 - closing IndexWriter
    64883 [localhost-startStop-2] INFO
 org.apache.solr.update.DefaultSolrCoreState  &#8211; closing IndexWriter with
IndexWriterCloser
    64885 [localhost-startStop-2] ERROR
org.apache.solr.update.DefaultSolrCoreState  &#8211; Error during shutdown of
writer.
    org.apache.lucene.store.AlreadyClosedException: &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; IndexWriter is
closed
            at
org.apache.lucene.index.IndexWriter.ensureOpen(IndexWriter.java:700)
            at
org.apache.lucene.index.IndexWriter.waitForMerges(IndexWriter.java:2384)
            at
org.apache.solr.update.DirectUpdateHandler2.closeWriter(DirectUpdateHandler2.java:795)
            at
org.apache.solr.update.DefaultSolrCoreState.closeIndexWriter(DefaultSolrCoreState.java:70)
            at
org.apache.solr.update.DefaultSolrCoreState.close(DefaultSolrCoreState.java:371)
            at
org.apache.solr.update.SolrCoreState.decrefSolrCoreState(SolrCoreState.java:72)
            at org.apache.solr.core.SolrCore.close(SolrCore.java:1073)
            at org.apache.solr.core.SolrCores.close(SolrCores.java:117)
            at
org.apache.solr.core.CoreContainer.shutdown(CoreContainer.java:347)
            at
org.apache.solr.servlet.SolrDispatchFilter.destroy(SolrDispatchFilter.java:200)
            at
org.apache.catalina.core.ApplicationFilterConfig.release(ApplicationFilterConfig.java:315)
            at
org.apache.catalina.core.StandardContext.filterStop(StandardContext.java:4782)
            at
org.apache.catalina.core.StandardContext.stopInternal(StandardContext.java:5565)
            at
org.apache.catalina.util.LifecycleBase.stop(LifecycleBase.java:232)
            at
org.apache.catalina.core.ContainerBase$StopChild.call(ContainerBase.java:1575)
            at
org.apache.catalina.core.ContainerBase$StopChild.call(ContainerBase.java:1564)
            at java.util.concurrent.FutureTask.run(FutureTask.java:262)
            at
java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
            at
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
    2014-09-29T14:22:11.384-0400: [GC 1299401K-&amp;gt;384944K(2543104K),
0.0427280 secs]
    64929 [localhost-startStop-2] INFO  org.apache.solr.core.SolrCore  &#8211;
[mycore] Closing main searcher on request.
    64935 [localhost-startStop-2] INFO
 org.apache.solr.core.CachingDirectoryFactory  &#8211; Closing
NRTCachingDirectoryFactory - 3 directories currently being tracked
    69937 [explicit-fetchindex-cmd] INFO
 org.apache.solr.update.DefaultSolrCoreState  &#8211; Creating &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IndexWriter...
    69938 [explicit-fetchindex-cmd] ERROR
org.apache.solr.handler.ReplicationHandler  &#8211; SnapPull failed
:org.apache.lucene.store.AlreadyClosedException: Already closed
            at
org.apache.solr.core.CachingDirectoryFactory.get(CachingDirectoryFactory.java:341)
            at
org.apache.solr.handler.ReplicationHandler.loadReplicationProperties(ReplicationHandler.java:827)
            at
org.apache.solr.handler.SnapPuller.logReplicationTimeAndConfFiles(SnapPuller.java:569)
            at
org.apache.solr.handler.SnapPuller.fetchLatestIndex(SnapPuller.java:511)
            at
org.apache.solr.handler.ReplicationHandler.doFetch(ReplicationHandler.java:337)
            at
org.apache.solr.handler.ReplicationHandler$1.run(ReplicationHandler.java:227)

    69942 [localhost-startStop-2] INFO
 org.apache.solr.core.CachingDirectoryFactory  &#8211; looking to close
/usr/local/apache-tomcat-7.0.39/solr/mycore/data
[CachedDir&amp;lt;&amp;lt;refCount=0;path=/usr/local/apache-tomcat-7.0.39/solr/mycore/data;done=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&amp;gt;&amp;gt;]
    69942 [localhost-startStop-2] INFO
 org.apache.solr.core.CachingDirectoryFactory  &#8211; Closing directory:
/usr/local/apache-tomcat-7.0.39/solr/mycore/data
    69942 [localhost-startStop-2] INFO
 org.apache.solr.core.CachingDirectoryFactory  &#8211; looking to close
/usr/local/apache-tomcat-7.0.39/solr/mycore/data/index
[CachedDir&amp;lt;&amp;lt;refCount=0;path=/usr/local/apache-tomcat-7.0.39/solr/mycore/data/index;done=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&amp;gt;&amp;gt;]
    69942 [localhost-startStop-2] INFO
 org.apache.solr.core.CachingDirectoryFactory  &#8211; Closing directory:
/usr/local/apache-tomcat-7.0.39/solr/mycore/data/index
    69942 [localhost-startStop-2] INFO
 org.apache.solr.core.CachingDirectoryFactory  &#8211; looking to close
/usr/local/apache-tomcat-7.0.39/solr/mycore/data/index.20140929142203447
[CachedDir&amp;lt;&amp;lt;refCount=0;path=/usr/local/apache-tomcat-7.0.39/solr/mycore/data/index.20140929142203447;done=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;gt;&amp;gt;]
    69942 [localhost-startStop-2] INFO
 org.apache.solr.core.CachingDirectoryFactory  &#8211; Closing directory:
/usr/local/apache-tomcat-7.0.39/solr/mycore/data/index.20140929142203447
    69943 [localhost-startStop-2] INFO
 org.apache.solr.core.CachingDirectoryFactory  &#8211; Removing directory before
core close:
/usr/local/apache-tomcat-7.0.39/solr/mycore/data/index.20140929142203447
    Sep 29, 2014 2:22:16 PM org.apache.catalina.ha.session.DeltaManager
stopInternal
    INFO: Manager [localhost#/solr] expiring sessions upon shutdown
    Sep 29, 2014 2:22:16 PM org.apache.catalina.loader.WebappClassLoader
clearReferencesThreads
    SEVERE: The web application [/solr] appears to have started a thread
named [fsyncService-12-thread-1] but has failed to stop it. This is very
likely to create a memory leak.
    Sep 29, 2014 2:22:16 PM org.apache.catalina.loader.WebappClassLoader
checkThreadLocalMapForLeaks
    SEVERE: The web application [/solr] created a ThreadLocal with key of
type [org.apache.solr.schema.DateField.ThreadLocalDateFormat] (value
[org.apache.solr.schema.DateField$ThreadLocalDateFormat@66271f62]) and a
value of type [org.apache.solr.schema.DateField.ISO8601CanonicalDateFormat]
(value [org.apache.solr.schema.DateField$ISO8601CanonicalDateFormat@6b2ed43a])
but failed to remove it when the web application was stopped. Threads are
going to be renewed over time to &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; and avoid a probable memory leak.
    Sep 29, 2014 2:22:16 PM org.apache.coyote.AbstractProtocol stop
    INFO: Stopping ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;http-bio-8080&quot;&lt;/span&gt;]
    Sep 29, 2014 2:22:16 PM org.apache.coyote.AbstractProtocol stop
    INFO: Stopping ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;ajp-bio-8009&quot;&lt;/span&gt;]
    Sep 29, 2014 2:22:16 PM org.apache.coyote.AbstractProtocol destroy
    INFO: Destroying ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;http-bio-8080&quot;&lt;/span&gt;]
    Sep 29, 2014 2:22:16 PM org.apache.coyote.AbstractProtocol destroy
    INFO: Destroying ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;ajp-bio-8009&quot;&lt;/span&gt;]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;At this point it looks like tomcat has shutdown, but the process is still&lt;br/&gt;
running, as checked by ps. If I start a new tomcat and repeat this process&lt;br/&gt;
a few times, we end up with several zombie instances of tomcat running.&lt;/p&gt;

&lt;p&gt;Is this designed behavior? What is supposed to happen when the container is&lt;br/&gt;
shutdown while replication is running? How are others handling this?&lt;/p&gt;

&lt;p&gt;Please let me know if I can provide any more information.&lt;/p&gt;

&lt;p&gt;Thanks in advance,&lt;br/&gt;
Nick&lt;/p&gt;&lt;/blockquote&gt;


&lt;p&gt;My followup&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;I was helping to look into this with Nick &amp;amp; I think we may have figured out the core of the problem...&lt;/p&gt;

&lt;p&gt;The problem is easily reproducible by starting replication on the slave and then sending a shutdown command to tomcat (e.g. catalina.sh stop).&lt;/p&gt;

&lt;p&gt;With a debugger attached, it looks like the fsyncService thread is blocking VM shutdown because it is created as a non-daemon thread.&lt;/p&gt;

&lt;p&gt;Essentially what seems to be happening is that the fsyncService thread is running when &apos;catalina.sh stop&apos; is executed. This goes in and calls SnapPuller.destroy() which aborts the current sync. Around line 517 of the SnapPuller, there is code that is supposed to cleanup the fsyncService thread, but I don&apos;t think it is getting executed because the thread that called SnapPuller.fetchLatestIndex() is configured as a daemon Thread, so the JVM ends up shutting that down before it can cleanup the fysncService...&lt;/p&gt;

&lt;p&gt;So... it seems like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (fsyncService != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) 
ExecutorUtil.shutdownNowAndAwaitTermination(fsyncService);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;could be added around line 1706 of SnapPuller.java,  or&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;           &lt;span class=&quot;code-comment&quot;&gt;// since otherwise the JVM may kill the thread before any cleanup
&lt;/span&gt;           &lt;span class=&quot;code-comment&quot;&gt;// code can be called
&lt;/span&gt;          puller.setDaemon(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;could be added around line 230 of ReplicationHandler.java, however this needs some additional work (and I think it might need to be added regardless) since the cleanup code in SnapPuller(around 517) that shuts down the fsync thread never gets execute since logReplicationTimeAndConfFiles() can throw IO exceptions bypassing the rest of the finally block...So the call to &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;logReplicationTimeAndConfFiles()&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; around line 512 would need to get wrapped with a try/catch block to catch the IO exception...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I will attach a patch as well that I believe fixes the issues. Is there a reason to &lt;b&gt;not&lt;/b&gt; perform a hard shutdown of the fysnc thread? It seems sane enough to me to do a hard shutdown of the fsyncService if the action is aborted...&lt;/p&gt;</description>
                <environment></environment>
        <key id="12745504">SOLR-6579</key>
            <summary>SnapPuller Replication blocks clean shutdown of tomcat</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="noble.paul">Noble Paul</assignee>
                                    <reporter username="gprbkg">Philip Black-Knight</reporter>
                        <labels>
                    </labels>
                <created>Thu, 2 Oct 2014 14:09:10 +0000</created>
                <updated>Mon, 9 May 2016 18:55:19 +0000</updated>
                            <resolved>Thu, 26 Feb 2015 12:13:27 +0000</resolved>
                                    <version>4.10.1</version>
                                    <fixVersion>4.10.4</fixVersion>
                    <fixVersion>5.0</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>replication (java)</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="14186990" author="gprbkg" created="Tue, 28 Oct 2014 15:55:39 +0000"  >&lt;p&gt;Just curious if there were any plans to pull in my patch for the next release or if there is anything else I can do to move this along....&lt;/p&gt;</comment>
                            <comment id="14204842" author="jira-bot" created="Mon, 10 Nov 2014 14:51:56 +0000"  >&lt;p&gt;Commit 1637879 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1637879&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1637879&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6579&quot; title=&quot;SnapPuller Replication blocks clean shutdown of tomcat&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6579&quot;&gt;&lt;del&gt;SOLR-6579&lt;/del&gt;&lt;/a&gt; SnapPuller Replication blocks clean shutdown of tomcat&lt;/p&gt;</comment>
                            <comment id="14204852" author="jira-bot" created="Mon, 10 Nov 2014 14:57:14 +0000"  >&lt;p&gt;Commit 1637881 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt; in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1637881&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1637881&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6579&quot; title=&quot;SnapPuller Replication blocks clean shutdown of tomcat&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6579&quot;&gt;&lt;del&gt;SOLR-6579&lt;/del&gt;&lt;/a&gt; SnapPuller Replication blocks clean shutdown of tomcat&lt;/p&gt;</comment>
                            <comment id="14332680" author="anshumg" created="Mon, 23 Feb 2015 05:01:18 +0000"  >&lt;p&gt;Bulk close after 5.0 release.&lt;/p&gt;</comment>
                            <comment id="14338304" author="shalinmangar" created="Thu, 26 Feb 2015 12:12:41 +0000"  >&lt;p&gt;Reopening to backport to 4.10.4&lt;/p&gt;</comment>
                            <comment id="14338307" author="jira-bot" created="Thu, 26 Feb 2015 12:14:16 +0000"  >&lt;p&gt;Commit 1662430 from shalin@apache.org in branch &apos;dev/branches/lucene_solr_4_10&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1662430&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1662430&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6579&quot; title=&quot;SnapPuller Replication blocks clean shutdown of tomcat&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6579&quot;&gt;&lt;del&gt;SOLR-6579&lt;/del&gt;&lt;/a&gt;: SnapPuller Replication blocks clean shutdown of tomcat&lt;/p&gt;</comment>
                            <comment id="14348911" author="mikemccand" created="Thu, 5 Mar 2015 15:36:28 +0000"  >&lt;p&gt;Bulk close for 4.10.4 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12672549" name="cleanupSnapPullerFinally.patch" size="1282" author="gprbkg" created="Thu, 2 Oct 2014 14:09:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 37 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i20q9j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>