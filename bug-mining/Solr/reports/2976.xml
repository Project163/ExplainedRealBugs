<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:13:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-9141] ClassCastException occurs in /sql handler with GROUP BY aggregationMode=facet and single shard</title>
                <link>https://issues.apache.org/jira/browse/SOLR-9141</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;ClassCastException occurs in /sql request handler using &lt;del&gt;ORDER BY&lt;/del&gt; GROUP BY clause.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ curl --data-urlencode &quot;stmt=select count(*) from access_log&quot; &quot;http://localhost:8983/solr/access_log/sql?aggregationMode=facet&quot;
{&quot;result-set&quot;:{&quot;docs&quot;:[
{&quot;count(*)&quot;:1309},
{&quot;EOF&quot;:true,&quot;RESPONSE_TIME&quot;:239}]}}

$ curl --data-urlencode &apos;stmt=select response, count(*) as count from access_log group by response&apos; &quot;http://localhost:8983/solr/access_log/sql?aggregationMode=facet&quot;
{&quot;result-set&quot;:{&quot;docs&quot;:[
{&quot;EXCEPTION&quot;:&quot;java.lang.ClassCastException: java.lang.Integer cannot be cast to java.lang.Long&quot;,&quot;EOF&quot;:true,&quot;RESPONSE_TIME&quot;:53}]}}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;See following error messages:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2016-05-19 10:18:06.477 ERROR (qtp1791930789-21) [c:access_log s:shard1 r:core_node1 x:access_log_shard1_replica1] o.a.s.c.s.i.s.ExceptionStream java.io.IOException: java.lang.ClassCastException: java.lang.Integer cannot be cast to java.lang.Long
    at org.apache.solr.client.solrj.io.stream.FacetStream.open(FacetStream.java:300)
    at org.apache.solr.handler.SQLHandler$LimitStream.open(SQLHandler.java:1265)
    at org.apache.solr.client.solrj.io.stream.SelectStream.open(SelectStream.java:153)
    at org.apache.solr.handler.SQLHandler$MetadataStream.open(SQLHandler.java:1511)
    at org.apache.solr.client.solrj.io.stream.ExceptionStream.open(ExceptionStream.java:47)
    at org.apache.solr.handler.StreamHandler$TimerStream.open(StreamHandler.java:362)
    at org.apache.solr.response.TextResponseWriter.writeTupleStream(TextResponseWriter.java:301)
    at org.apache.solr.response.TextResponseWriter.writeVal(TextResponseWriter.java:167)
    at org.apache.solr.response.JSONWriter.writeNamedListAsMapWithDups(JSONResponseWriter.java:183)
    at org.apache.solr.response.JSONWriter.writeNamedList(JSONResponseWriter.java:299)
    at org.apache.solr.response.JSONWriter.writeResponse(JSONResponseWriter.java:95)
    at org.apache.solr.response.JSONResponseWriter.write(JSONResponseWriter.java:60)
    at org.apache.solr.response.QueryResponseWriterUtil.writeQueryResponse(QueryResponseWriterUtil.java:65)
    at org.apache.solr.servlet.HttpSolrCall.writeResponse(HttpSolrCall.java:725)
    at org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:469)
    at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:229)
    at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:184)
    at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1676)
    at org.eclipse.jetty.servlets.CrossOriginFilter.handle(CrossOriginFilter.java:308)
    at org.eclipse.jetty.servlets.CrossOriginFilter.doFilter(CrossOriginFilter.java:262)
    at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1668)
    at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:581)
    at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:143)
    at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:548)
    at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:226)
    at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1160)
    at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:511)
    at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)
    at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1092)
    at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)
    at org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:213)
    at org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:119)
    at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:134)
    at org.eclipse.jetty.server.Server.handle(Server.java:518)
    at org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:308)
    at org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:244)
    at org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:273)
    at org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:95)
    at org.eclipse.jetty.io.SelectChannelEndPoint$2.run(SelectChannelEndPoint.java:93)
    at org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.produceAndRun(ExecuteProduceConsume.java:246)
    at org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.run(ExecuteProduceConsume.java:156)
    at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:654)
    at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:572)
    at java.lang.Thread.run(Thread.java:745)
Caused by: java.lang.ClassCastException: java.lang.Integer cannot be cast to java.lang.Long
    at org.apache.solr.client.solrj.io.stream.FacetStream.fillTuples(FacetStream.java:461)
    at org.apache.solr.client.solrj.io.stream.FacetStream.getTuples(FacetStream.java:420)
    at org.apache.solr.client.solrj.io.stream.FacetStream.open(FacetStream.java:297)
    ... 43 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12971757">SOLR-9141</key>
            <summary>ClassCastException occurs in /sql handler with GROUP BY aggregationMode=facet and single shard</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jdyer">James Dyer</assignee>
                                    <reporter username="minoru">Minoru Osuka</reporter>
                        <labels>
                    </labels>
                <created>Sat, 21 May 2016 06:57:30 +0000</created>
                <updated>Tue, 8 Oct 2019 14:51:33 +0000</updated>
                            <resolved>Thu, 26 May 2016 18:51:22 +0000</resolved>
                                    <version>6.0</version>
                                                    <component>Parallel SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15294805" author="minoru" created="Sat, 21 May 2016 07:02:55 +0000"  >&lt;p&gt;Attach path file.&lt;/p&gt;</comment>
                            <comment id="15297814" author="joel.bernstein" created="Tue, 24 May 2016 07:14:10 +0000"  >&lt;p&gt;I don&apos;t see an ORDER BY clause in your query. It looks like it&apos;s failing on a basic GROUP BY?&lt;/p&gt;

&lt;p&gt;I&apos;ll have to see if I can reproduce this with a test. What is the field type for the response column?&lt;/p&gt;</comment>
                            <comment id="15298032" author="minoru" created="Tue, 24 May 2016 10:37:58 +0000"  >&lt;p&gt;Hi Joel,&lt;/p&gt;

&lt;p&gt;Yes, It seems basic &lt;del&gt;ORDER BY&lt;/del&gt; GROUP BY clause is failing.&lt;/p&gt;

&lt;p&gt;Field type for the response is following:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ curl &quot;http://localhost:8983/solr/access_log/schema/fields/response&quot;
{
  &quot;responseHeader&quot;:{
    &quot;status&quot;:0,
    &quot;QTime&quot;:3},
  &quot;field&quot;:{
    &quot;name&quot;:&quot;response&quot;,
    &quot;type&quot;:&quot;int&quot;,
    &quot;docValues&quot;:true,
    &quot;multiValued&quot;:false,
    &quot;indexed&quot;:true,
    &quot;stored&quot;:true}}

$ curl &quot;http://localhost:8983/solr/access_log/schema/fieldtypes/int&quot;
{
  &quot;responseHeader&quot;:{
    &quot;status&quot;:0,
    &quot;QTime&quot;:246},
  &quot;fieldType&quot;:{
    &quot;name&quot;:&quot;int&quot;,
    &quot;class&quot;:&quot;solr.TrieIntField&quot;,
    &quot;positionIncrementGap&quot;:&quot;0&quot;,
    &quot;precisionStep&quot;:&quot;0&quot;,
    &quot;fields&quot;:[&quot;response&quot;],
    &quot;dynamicFields&quot;:[&quot;*_i&quot;]},
  &quot;warn&quot;:&quot;This API is deprecated&quot;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;aggregationMode=map_reduce works fine.&lt;br/&gt;
Rsult of simple count is following:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ curl --data-urlencode &quot;stmt=SELECT count(*) FROM access_log&quot; &quot;http://localhost:8983/solr/access_log/sql?aggregationMode=map_reduce&quot;
{&quot;result-set&quot;:{&quot;docs&quot;:[
{&quot;count(*)&quot;:1157},
{&quot;EOF&quot;:true,&quot;RESPONSE_TIME&quot;:7}]}}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And result of &lt;del&gt;ORDER BY&lt;/del&gt; GROUP BY clause is following:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ curl --data-urlencode &apos;stmt=SELECT response, count(*) FROM access_log GROUP BY response&apos; &quot;http://localhost:8983/solr/access_log/sql?aggregationMode=map_reduce&quot;
{&quot;result-set&quot;:{&quot;docs&quot;:[
{&quot;response&quot;:200},
{&quot;response&quot;:404},
{&quot;response&quot;:500},
{&quot;EOF&quot;:true,&quot;RESPONSE_TIME&quot;:18}]}}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Also aggregationMode=facet works fine without &lt;del&gt;ORDER BY&lt;/del&gt; GROUP BY clause.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ curl --data-urlencode &quot;stmt=SELECT count(*) FROM access_log&quot; &quot;http://localhost:8983/solr/access_log/sql?aggregationMode=facet&quot;
{&quot;result-set&quot;:{&quot;docs&quot;:[
{&quot;count(*)&quot;:1157},
{&quot;EOF&quot;:true,&quot;RESPONSE_TIME&quot;:9}]}}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If SQL specified &lt;del&gt;ORDER BY&lt;/del&gt; GROUP BY clause, it does&apos;t work due to ClassCastException.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ curl --data-urlencode &apos;stmt=SELECT response, count(*) FROM access_log GROUP BY response&apos; &quot;http://localhost:8983/solr/access_log/sql?aggregationMode=facet&quot;
{&quot;result-set&quot;:{&quot;docs&quot;:[
{&quot;EXCEPTION&quot;:&quot;java.lang.ClassCastException: java.lang.Integer cannot be cast to java.lang.Long&quot;,&quot;EOF&quot;:true,&quot;RESPONSE_TIME&quot;:35}]}}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Please see following solr.log:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2016-05-24 08:48:24.944 INFO  (qtp1791930789-21) [c:access_log s:shard1 r:core_node1 x:access_log_shard1_replica1] o.a.s.c.S.Request [access_log_shard1_replica1]  webapp=/solr path=/sql params={aggregationMode=facet&amp;amp;stmt=select+response,+count(*)+as+count+from+access_log+group+by+response} status=0 QTime=5
2016-05-24 08:48:24.970 INFO  (qtp1791930789-12) [c:access_log s:shard1 r:core_node1 x:access_log_shard1_replica1] o.a.s.c.S.Request [access_log_shard1_replica1]  webapp=/solr path=/select params={q=*:*&amp;amp;json.facet={&quot;response&quot;:{&quot;type&quot;:&quot;terms&quot;,&quot;field&quot;:&quot;response&quot;,&quot;limit&quot;:100,&quot;sort&quot;:{&quot;index&quot;:&quot;asc&quot;},&quot;facet&quot;:{}}}&amp;amp;_stateVer_=access_log:10&amp;amp;rows=0&amp;amp;wt=javabin&amp;amp;version=2} hits=1157 status=0 QTime=5
2016-05-24 08:48:24.979 ERROR (qtp1791930789-21) [c:access_log s:shard1 r:core_node1 x:access_log_shard1_replica1] o.a.s.c.s.i.s.ExceptionStream java.io.IOException: java.lang.ClassCastException: java.lang.Integer cannot be cast to java.lang.Long
    at org.apache.solr.client.solrj.io.stream.FacetStream.open(FacetStream.java:300)
    at org.apache.solr.client.solrj.io.stream.SelectStream.open(SelectStream.java:153)
    at org.apache.solr.client.solrj.io.stream.ExceptionStream.open(ExceptionStream.java:47)
    at org.apache.solr.handler.StreamHandler$TimerStream.open(StreamHandler.java:362)
    at org.apache.solr.response.TextResponseWriter.writeTupleStream(TextResponseWriter.java:301)
    at org.apache.solr.response.TextResponseWriter.writeVal(TextResponseWriter.java:167)
    at org.apache.solr.response.JSONWriter.writeNamedListAsMapWithDups(JSONResponseWriter.java:183)
    at org.apache.solr.response.JSONWriter.writeNamedList(JSONResponseWriter.java:299)
    at org.apache.solr.response.JSONWriter.writeResponse(JSONResponseWriter.java:95)
    at org.apache.solr.response.JSONResponseWriter.write(JSONResponseWriter.java:60)
    at org.apache.solr.response.QueryResponseWriterUtil.writeQueryResponse(QueryResponseWriterUtil.java:65)
    at org.apache.solr.servlet.HttpSolrCall.writeResponse(HttpSolrCall.java:725)
    at org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:469)
    at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:229)
    at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:184)
    at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1676)
    at org.eclipse.jetty.servlets.CrossOriginFilter.handle(CrossOriginFilter.java:308)
    at org.eclipse.jetty.servlets.CrossOriginFilter.doFilter(CrossOriginFilter.java:262)
    at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1668)
    at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:581)
    at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:143)
    at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:548)
    at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:226)
    at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1160)
    at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:511)
    at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)
    at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1092)
    at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)
    at org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:213)
    at org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:119)
    at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:134)
    at org.eclipse.jetty.server.Server.handle(Server.java:518)
    at org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:308)
    at org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:244)
    at org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:273)
    at org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:95)
    at org.eclipse.jetty.io.SelectChannelEndPoint$2.run(SelectChannelEndPoint.java:93)
    at org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.produceAndRun(ExecuteProduceConsume.java:246)
    at org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.run(ExecuteProduceConsume.java:156)
    at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:654)
    at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:572)
    at java.lang.Thread.run(Thread.java:745)
Caused by: java.lang.ClassCastException: java.lang.Integer cannot be cast to java.lang.Long
    at org.apache.solr.client.solrj.io.stream.FacetStream.fillTuples(FacetStream.java:461)
    at org.apache.solr.client.solrj.io.stream.FacetStream.getTuples(FacetStream.java:420)
    at org.apache.solr.client.solrj.io.stream.FacetStream.open(FacetStream.java:297)
    ... 41 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After this patch applied, &lt;del&gt;ORDER BY&lt;/del&gt; GROUP BY clause works fine using aggregationMode=facet.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ curl --data-urlencode &apos;stmt=SELECT response, count(*) FROM access_log GROUP BY response&apos; &quot;http://localhost:8983/solr/access_log/sql?aggregationMode=facet&quot;
{&quot;result-set&quot;:{&quot;docs&quot;:[
{&quot;response&quot;:200,&quot;count(*)&quot;:1153},
{&quot;response&quot;:404,&quot;count(*)&quot;:3},
{&quot;response&quot;:500,&quot;count(*)&quot;:1},
{&quot;EOF&quot;:true,&quot;RESPONSE_TIME&quot;:9}]}}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15298112" author="joel.bernstein" created="Tue, 24 May 2016 12:44:10 +0000"  >&lt;p&gt;Ok, I&apos;ll put a test together for this. Let&apos;s make sure though that we&apos;re using the same terminology so we get the ticket name correct.&lt;/p&gt;

&lt;p&gt;You mention ORDER BY, but unless I&apos;m missing something the query doesn&apos;t contain an ORDER BY. It contains a GROUP BY. If we are in agreement I&apos;ll change the name of the ticket.&lt;/p&gt;

&lt;p&gt;I don&apos;t believe there is a test case for grouping on a numeric field in facet mode, so I&apos;ll put a test case together for this.&lt;/p&gt;
</comment>
                            <comment id="15298148" author="minoru" created="Tue, 24 May 2016 13:12:43 +0000"  >&lt;p&gt;Sorry, I made a typo.&lt;br/&gt;
wrong : ORDER BY&lt;br/&gt;
correct: GROUP BY&lt;/p&gt;

&lt;p&gt;I will correct that.&lt;/p&gt;</comment>
                            <comment id="15298208" author="joel.bernstein" created="Tue, 24 May 2016 14:01:09 +0000"  >&lt;p&gt;Ok thanks for reporting this and providing a patch. I&apos;ll work up a test case for this.&lt;/p&gt;</comment>
                            <comment id="15298311" author="joel.bernstein" created="Tue, 24 May 2016 14:59:19 +0000"  >&lt;p&gt;This turning out to be difficult to reproduce. Originally I thought the issue was related to grouping on a numeric field. But after looking closely at the stack trace and the code the ClassCastException is happening when getting the &lt;b&gt;count&lt;/b&gt;. &lt;/p&gt;

&lt;p&gt;Since there are testcases that exercise getting the count in facet mode already, and I&apos;ve done a fair amount of manual testing that has never run into this error, I&apos;m not sure how to reproduce the exception.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yonik%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;yonik@apache.org&quot;&gt;yonik@apache.org&lt;/a&gt;, a Class cast exception has occurred which seems to be showing that the value from a JSON facet API count is coming back as an int. The FacetStream code treats the count value as a long, which works in the test cases. Are there scenarios where the JSON facet API would return the count as an int?&lt;/p&gt;</comment>
                            <comment id="15298330" author="yseeley@gmail.com" created="Tue, 24 May 2016 15:09:49 +0000"  >&lt;blockquote&gt;&lt;p&gt;Are there scenarios where the JSON facet API would return the count as an int?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes (&quot;original&quot; faceting code does the same thing).&lt;br/&gt;
On a per-shard basis, &quot;count&quot; is normally/often returned as an int (we don&apos;t support more than that many docs per shard), but for distributed search they are summed as a long and returned that way.&lt;/p&gt;

&lt;p&gt;int/long are handled by the client.  If you look at FacetLongMerger, it sums counts via:&lt;br/&gt;
    val += ((Number)facetResult).longValue();&lt;/p&gt;</comment>
                            <comment id="15298460" author="joel.bernstein" created="Tue, 24 May 2016 16:28:59 +0000"  >&lt;p&gt;Since the FacetStream is using CloudSolrServer to make a normal distributed JSON facet call, it will in most cases be returned as a long. This explains why test cases and manual testing work with the current code. But it appears that there is some scenario, possibly a single shard scenario, where the count is returned as an int. I&apos;ll test the single shard scenario and see if this is what&apos;s happening.&lt;/p&gt;</comment>
                            <comment id="15300693" author="jdyer" created="Wed, 25 May 2016 19:22:56 +0000"  >&lt;blockquote&gt;&lt;p&gt;it appears that there is some scenario, possibly a single shard scenario, where the count is returned as an int&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Indeed, if we randomize the # of shards we can reproduce this easily. See patch: &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12806228/12806228_SOLR-9141-test.patch&quot; title=&quot;SOLR-9141-test.patch attached to SOLR-9141&quot;&gt;SOLR-9141-test.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; .  &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.io.IOException: java.lang.ClassCastException: java.lang.Integer cannot be cast to java.lang.Long
	at __randomizedtesting.SeedInfo.seed([530A362A02C855B3:F5E84F942E41E274]:0)
	at org.apache.solr.client.solrj.io.stream.FacetStream.open(FacetStream.java:351)
... etc ...
	at java.lang.Thread.run(Thread.java:745)
Caused by: java.lang.ClassCastException: java.lang.Integer cannot be cast to java.lang.Long
	at org.apache.solr.client.solrj.io.stream.FacetStream.fillTuples(FacetStream.java:506)
	at org.apache.solr.client.solrj.io.stream.FacetStream.getTuples(FacetStream.java:462)
	at org.apache.solr.client.solrj.io.stream.FacetStream.open(FacetStream.java:348)
	... 41 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In fact, several of the test cases in this class fail when there is only 1 shard, but I haven&apos;t looked yet into why, or if these are valid failures.&lt;/p&gt;</comment>
                            <comment id="15300878" author="jdyer" created="Wed, 25 May 2016 21:27:51 +0000"  >&lt;p&gt;ok, better patch, &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12806228/12806228_SOLR-9141-test.patch&quot; title=&quot;SOLR-9141-test.patch attached to SOLR-9141&quot;&gt;SOLR-9141-test.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; .  This randomly chooses either 1, 2 or 3 shards.  Parallel streams use the same # of workers as shards unless there are &amp;gt;2 shards, in which case a random # of workers are chosen up to the # of shards.  I also made adjustments to the # of EOFs to expect, etc.&lt;/p&gt;

&lt;p&gt;With this, all tests in this class pass &lt;em&gt;except&lt;/em&gt; the 2 FacetStream tests, which also pass if Minoru&apos;s patch is applied.&lt;/p&gt;

&lt;p&gt;I can commit both patches and resolve this issue tomorrow, unless someone objects.&lt;/p&gt;</comment>
                            <comment id="15301488" author="risdenk" created="Thu, 26 May 2016 04:07:09 +0000"  >&lt;p&gt;I like the addition of testing randomizing and using a different number of shards. nit but it probably makes sense to pull the numWorkers logic out into a method so it doesn&apos;t have to be adjusted in every test.&lt;/p&gt;

&lt;p&gt;Based on what Yonik said, for consistency could use ((Number)bucket.get(&quot;count&quot;)).longValue(); instead of the toString, cast, longValue? No real preference here.&lt;/p&gt;</comment>
                            <comment id="15301782" author="joel.bernstein" created="Thu, 26 May 2016 09:07:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jdyer&quot; class=&quot;user-hover&quot; rel=&quot;jdyer&quot;&gt;jdyer&lt;/a&gt;, +1 on committing. I like the ((Number)bucket.get(&quot;count&quot;)).longValue(); approach as well.&lt;/p&gt;


</comment>
                            <comment id="15302079" author="minoru" created="Thu, 26 May 2016 13:47:29 +0000"  >&lt;p&gt;&#8203;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbernste&quot; class=&quot;user-hover&quot; rel=&quot;jbernste&quot;&gt;jbernste&lt;/a&gt;, +1. ((Number)bucket.get(&quot;count&quot;)).longValue(); seems faster than my patch (on my Macbook).&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;package test;

import java.util.ArrayList;
import java.util.List;

public class CastTest {
	public static void main(String[] args) {
		List&amp;lt;Object&amp;gt; objList = new ArrayList&amp;lt;Object&amp;gt;();
		for (int i = 0; i &amp;lt; 10000; i++) {
			objList.add(new Integer(i));
		}

		long start = System.nanoTime();
		for (Object obj : objList) {
			long l = new Long(obj.toString()).longValue();
		}
		long end = System.nanoTime();
		System.out.println(String.format(&quot;new Long(obj.toString()).longValue(); : %1$,10d ns&quot;, (end - start)));

		start = System.nanoTime();
		for (Object obj : objList) {
			long l = ((Number)obj).longValue();
		}
		end = System.nanoTime();
		System.out.println(String.format(&quot;((Number)obj).longValue();            : %1$,10d ns&quot;, (end - start)));
	}
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;new Long(obj.toString()).longValue(); : 11,301,332 ns
((Number)obj).longValue();            :    831,366 ns
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15302155" author="jdyer" created="Thu, 26 May 2016 14:35:13 +0000"  >&lt;p&gt;Here&apos;s a final patch (&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12806390/12806390_SOLR-9141.patch&quot; title=&quot;SOLR-9141.patch attached to SOLR-9141&quot;&gt;SOLR-9141.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;) that I will try and commit &amp;amp; back-port later today.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;for consistency could use ((Number)bucket.get(&quot;count&quot;)).longValue();&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;of course.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;nit but it probably makes sense to pull the numWorkers logic out into a method so it doesn&apos;t have to be adjusted in every test.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;got it.&lt;/p&gt;
</comment>
                            <comment id="15302664" author="jira-bot" created="Thu, 26 May 2016 18:42:36 +0000"  >&lt;p&gt;Commit 4d4030350b79303d6f358612473f4e68570858cc in lucene-solr&apos;s branch refs/heads/master from jdyer1&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=4d40303&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=4d40303&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9141&quot; title=&quot;ClassCastException occurs in /sql handler with GROUP BY aggregationMode=facet and single shard&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9141&quot;&gt;&lt;del&gt;SOLR-9141&lt;/del&gt;&lt;/a&gt;: Fix ClassCastException when using the /sql handler count() function with single-shard collections&lt;/p&gt;</comment>
                            <comment id="15302670" author="jira-bot" created="Thu, 26 May 2016 18:49:19 +0000"  >&lt;p&gt;Commit 1609428786b17135f0d8ba413c4203b88977304b in lucene-solr&apos;s branch refs/heads/branch_6x from jdyer1&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=1609428&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=1609428&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9141&quot; title=&quot;ClassCastException occurs in /sql handler with GROUP BY aggregationMode=facet and single shard&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9141&quot;&gt;&lt;del&gt;SOLR-9141&lt;/del&gt;&lt;/a&gt;: Fix ClassCastException when using the /sql handler count() function with single-shard collections&lt;/p&gt;</comment>
                            <comment id="15302679" author="jdyer" created="Thu, 26 May 2016 18:51:22 +0000"  >&lt;p&gt;Minoru, thank you for reporting this one.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12806228" name="SOLR-9141-test.patch" size="8868" author="jdyer" created="Wed, 25 May 2016 21:27:51 +0000"/>
                            <attachment id="12806194" name="SOLR-9141-test.patch" size="1143" author="jdyer" created="Wed, 25 May 2016 19:22:56 +0000"/>
                            <attachment id="12806390" name="SOLR-9141.patch" size="8844" author="jdyer" created="Thu, 26 May 2016 14:46:59 +0000"/>
                            <attachment id="12806387" name="SOLR-9141.patch" size="8849" author="jdyer" created="Thu, 26 May 2016 14:35:13 +0000"/>
                            <attachment id="12805403" name="SOLR-9141.patch" size="1057" author="minoru" created="Sat, 21 May 2016 07:02:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 25 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2yben:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>