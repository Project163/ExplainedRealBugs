<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:21:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-2410] ConcurrentLRUCache can throw class cast exception</title>
                <link>https://issues.apache.org/jira/browse/SOLR-2410</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;ConcurrentLRUCache throws a class cast exception.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12500699">SOLR-2410</key>
            <summary>ConcurrentLRUCache can throw class cast exception</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="yseeley@gmail.com">Yonik Seeley</reporter>
                        <labels>
                    </labels>
                <created>Mon, 7 Mar 2011 22:49:59 +0000</created>
                <updated>Mon, 28 Jul 2014 12:38:39 +0000</updated>
                            <resolved>Mon, 28 Jul 2014 12:38:39 +0000</resolved>
                                    <version>4.0-ALPHA</version>
                                    <fixVersion>4.0-ALPHA</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13003668" author="yseeley@gmail.com" created="Mon, 7 Mar 2011 22:53:20 +0000"  >&lt;p&gt;Here&apos;s the smallest version I could reproduce the issue with.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;CacheEntry&amp;lt;K,V&amp;gt; {
}

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;PQueue&amp;lt;K,V&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; PriorityQueue&amp;lt;CacheEntry&amp;lt;K,V&amp;gt;&amp;gt; {
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) {
    &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PQueue&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;().tst();
  }

  PQueue() {
    &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.initialize(1);
  }

  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; lessThan(CacheEntry&amp;lt;K,V&amp;gt; a, CacheEntry&amp;lt;K,V&amp;gt; b) {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
  }

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; CacheEntry&amp;lt;K,V&amp;gt; tst() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; heap[1];
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I just cut-n-pasted the code into BasicFunctionalityTest, run main() from my IDE, and presto:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; java.lang.ClassCastException: [Ljava.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;; cannot be &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; to [Lorg.apache.solr.CacheEntry;
	at org.apache.solr.PQueue.tst(BasicFunctionalityTest.java:81)
	at org.apache.solr.PQueue.main(BasicFunctionalityTest.java:68)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13003674" author="yseeley@gmail.com" created="Mon, 7 Mar 2011 23:04:59 +0000"  >&lt;p&gt;Here&apos;s an even smaller version w/ no dependencies:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;C&amp;lt;T&amp;gt; {
}

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;A&amp;lt;T1&amp;gt; {
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; T1[] arr = (T1[])(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[1]);
}

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;B&amp;lt;T2&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; A&amp;lt;C&amp;lt;T2&amp;gt;&amp;gt; {
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; C&amp;lt;T2&amp;gt; tst() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; arr[0];
  }

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) {
    &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; B&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;().tst();
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13003675" author="dweiss" created="Mon, 7 Mar 2011 23:06:45 +0000"  >&lt;p&gt;It&apos;s because there&apos;s a bug &amp;#8211; PriorityQueue declares a generic array:&lt;/p&gt;

&lt;p&gt;  protected T[] heap; &lt;/p&gt;

&lt;p&gt;but assigns an Object[] to it in:&lt;/p&gt;

&lt;p&gt;    heap = (T[]) new Object&lt;span class=&quot;error&quot;&gt;&amp;#91;heapSize&amp;#93;&lt;/span&gt;; // T is unbounded type, so this unchecked cast works always&lt;/p&gt;

&lt;p&gt;this is true only if heap is not exposed outside the class (and is the pattern used in JDK&apos;s ArrayDeque&amp;lt;E&amp;gt;, for  example). Unfortunately the compiler will insert casts if you have a subclass with a narrowed generic type to ensure the array is indeed of proper type. The solution is to:&lt;/p&gt;

&lt;p&gt;1) allocate arrays of real component type (impossible if you don&apos;t know it in advance or don&apos;t have an existing array or its component). Example: Google Guava&apos;s ObjectArrays.newArray, as here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://guava-libraries.googlecode.com/svn/tags/release08/javadoc/com/google/common/collect/ObjectArrays.html#newArray(java.lang.Class&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://guava-libraries.googlecode.com/svn/tags/release08/javadoc/com/google/common/collect/ObjectArrays.html#newArray(java.lang.Class&lt;/a&gt;, int)&lt;/p&gt;

&lt;p&gt;2) cast superclass&apos;s array to (Object[]) first, then cast to the concrete component type. Here:&lt;/p&gt;

&lt;p&gt;(CacheEntry&amp;lt;K,V&amp;gt;) ((Object[]) heap)&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;;&lt;/p&gt;

&lt;p&gt;3) Declare PriorityQueue&apos;s internal array as Object[] and provide a getter that casts components to (T)?&lt;/p&gt;</comment>
                            <comment id="13003676" author="dweiss" created="Mon, 7 Mar 2011 23:09:52 +0000"  >&lt;p&gt;Btw. this is exactly the reason Collections declare Object[] toArray() and not T[] toArray &amp;#8211; in the latter case the compiler adds casts to the expression&apos;s argument type and collections can&apos;t know their component type after type erasure. Eh, C#/.NET is so much more elegant with generics.&lt;/p&gt;</comment>
                            <comment id="13003682" author="dweiss" created="Mon, 7 Mar 2011 23:25:46 +0000"  >&lt;p&gt;Yonik, try this and it should be clear why the above doesn&apos;t work:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
public class Example
{
    public static class A&amp;lt;T&amp;gt; {
        @SuppressWarnings(&quot;unchecked&quot;) // it is here for a reason :)
        public T[] array = (T[]) new Object [1]; 
    }
    
    public static void main(String [] args)
    {
        A&amp;lt;Integer&amp;gt; clazzA = new A&amp;lt;Integer&amp;gt;();
        System.out.println(clazzA.array[0]);
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13003690" author="yseeley@gmail.com" created="Mon, 7 Mar 2011 23:37:20 +0000"  >&lt;p&gt;Thanks Dawid!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;2) cast superclass&apos;s array to (Object[]) first, then cast to the concrete component type. Here:&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I tried this, but couldn&apos;t get it to work:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Example
{
   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;A&amp;lt;T&amp;gt; {
       @SuppressWarnings(&lt;span class=&quot;code-quote&quot;&gt;&quot;unchecked&quot;&lt;/span&gt;) &lt;span class=&quot;code-comment&quot;&gt;// it is here &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a reason :)
&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; T[] array = (T[]) &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; [1];
   }

   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; [] args)
   {
       A&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;&amp;gt; clazzA = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; A&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;&amp;gt;();
       &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(((&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;[])((&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[])clazzA.array))[0]);
   }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;edit: I got it - you need to access the array as an Object[]&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;       &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println( (&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;) (((&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[])clazzA.array)[0]));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13003736" author="yseeley@gmail.com" created="Tue, 8 Mar 2011 00:54:02 +0000"  >&lt;p&gt;Here&apos;s a patch that reverts back to a normal PQ (non-generified).  This minimizes the chance of another generics related bug here since the code is so hard to hit.&lt;/p&gt;</comment>
                            <comment id="13003761" author="hossman" created="Tue, 8 Mar 2011 01:36:22 +0000"  >&lt;p&gt;Ad David has pointed out, the root problem is in PriorityQueue &amp;#8211; yonik&apos;s patch just avoids this bug by eliminating the generics&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2953&quot; title=&quot;PriorityQueue is inheriently broken if subclass attempts to use &amp;quot;heap&amp;quot; w/generic T bound to anything other then &amp;quot;Object&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LUCENE-2953&quot;&gt;&lt;del&gt;LUCENE-2953&lt;/del&gt;&lt;/a&gt; trask the underlying problem&lt;/p&gt;</comment>
                            <comment id="13003764" author="yseeley@gmail.com" created="Tue, 8 Mar 2011 01:39:21 +0000"  >&lt;p&gt;Here&apos;s the patch with a test added that normally manages to trip the exception.&lt;/p&gt;</comment>
                            <comment id="13003843" author="dweiss" created="Tue, 8 Mar 2011 07:26:48 +0000"  >&lt;p&gt;Yep, sorry for belated follow up, I went to sleep last night &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; The workaround is to access T[] as an Object[] &amp;#8211; the actual type of the object that is stored in that field. I like reverting to Object[] much more since this &quot;feature&quot; is quite nasty and puzzling, especially for people who haven&apos;t seen it before (I have seen it a few times, for example here: &lt;a href=&quot;http://issues.carrot2.org/browse/HPPC-46&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://issues.carrot2.org/browse/HPPC-46&lt;/a&gt;). Glad I could help.&lt;/p&gt;</comment>
                            <comment id="13004432" author="thetaphi" created="Wed, 9 Mar 2011 09:20:39 +0000"  >&lt;p&gt;This was fixed by trunk revision: 1079707 (through &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2953&quot; title=&quot;PriorityQueue is inheriently broken if subclass attempts to use &amp;quot;heap&amp;quot; w/generic T bound to anything other then &amp;quot;Object&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LUCENE-2953&quot;&gt;&lt;del&gt;LUCENE-2953&lt;/del&gt;&lt;/a&gt;)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12500713">LUCENE-2953</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12472895" name="SOLR-2410.patch" size="3397" author="yseeley@gmail.com" created="Tue, 8 Mar 2011 01:39:21 +0000"/>
                            <attachment id="12472888" name="SOLR-2410.patch" size="2468" author="yseeley@gmail.com" created="Tue, 8 Mar 2011 00:54:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5124</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 37 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i03kxb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>18823</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>