<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:46:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-14971] AtomicUpdate &apos;remove&apos; fails on &apos;pints&apos; fields</title>
                <link>https://issues.apache.org/jira/browse/SOLR-14971</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;The &quot;remove&quot; atomic update action on multivalued int fields fails if the document being changed is uncommitted.&lt;/p&gt;

&lt;p&gt;At first glance this appears to be a type-related issue.  AtomicUpdateDocumentMerger attempts to handle multivalued int fields by processing the List&amp;lt;Integer&amp;gt; type, but in uncommitted docs int fields are still List&amp;lt;String&amp;gt; in the tlog.  Conceptually this feels similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13331&quot; title=&quot;Atomic Update Multivalue remove does not work&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13331&quot;&gt;&lt;del&gt;SOLR-13331&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;It&apos;s likely this issue also affects other numeric and date fields.&lt;/p&gt;

&lt;p&gt;Attached is a simple script to reproduce, meant to be run from the root of a Solr install.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13337921">SOLR-14971</key>
            <summary>AtomicUpdate &apos;remove&apos; fails on &apos;pints&apos; fields</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gerlowskija">Jason Gerlowski</assignee>
                                    <reporter username="gerlowskija">Jason Gerlowski</reporter>
                        <labels>
                    </labels>
                <created>Thu, 29 Oct 2020 18:40:50 +0000</created>
                <updated>Thu, 12 May 2022 00:26:51 +0000</updated>
                            <resolved>Wed, 11 Nov 2020 18:01:16 +0000</resolved>
                                    <version>8.5.2</version>
                                    <fixVersion>8.8</fixVersion>
                    <fixVersion>9.0</fixVersion>
                                    <component>update</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3600">1h</timespent>
                                <comments>
                            <comment id="17223746" author="gerlowskija" created="Fri, 30 Oct 2020 16:35:49 +0000"  >&lt;p&gt;It turns out this is a type problem, but not the one I guessed above.  The &quot;existing document&quot; values aren&apos;t Strings - they&apos;re Longs!&lt;/p&gt;

&lt;p&gt;The code in question is the &lt;tt&gt;removeObj&lt;/tt&gt; method here:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void removeObj(@SuppressWarnings({&lt;span class=&quot;code-quote&quot;&gt;&quot;rawtypes&quot;&lt;/span&gt;})Collection original, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; toRemove, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; fieldName) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(isChildDoc(toRemove)) {
      removeChildDoc(original, (SolrInputDocument) toRemove);
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
      original.remove(getNativeFieldValue(fieldName, toRemove));
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When removing an int value, &lt;tt&gt;getNativeFieldValue&lt;/tt&gt; is consistent in always returning an integer.  But the &apos;original&apos; Collection of existing values has different types depending on whether it was retrieved from the update log (longs) or from the index (ints).&lt;/p&gt;

&lt;p&gt;Java&apos;s Number classes declare &lt;tt&gt;equals()&lt;/tt&gt; in such a way that a Long is never equal to an Integer, even when the two represent the same numeric quantity.  So a type mismatch causes the &lt;tt&gt;remove&lt;/tt&gt; attempt to fail when the existing doc is retrieved from the tlog.&lt;/p&gt;

&lt;p&gt;This cause has one upside - while it&apos;s like to affect int/long and double/float, it seems specific to numerics and doesn&apos;t translate to other types.&lt;/p&gt;

&lt;p&gt;There&apos;s a couple ways we could address this:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Make sure the tlog&apos;s SolrInputDocument has int values instead of longs where appropriate.&lt;/li&gt;
	&lt;li&gt;Special-case numeric values in &lt;tt&gt;AtomicUpdateDocumentMerger.removeObj&lt;/tt&gt; and add custom removal logic that handles the inconsistency in our input types.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Conceptually I like (1) much better - it&apos;d be nice if the atomic-update code (and anything else that pulls RTG values) didn&apos;t have to handle a bunch of arbitrary variations in its input.  But this is could be a big change and might run afoul of whatever legitimate reasons there might be for storing the values as Longs in the UpdateLog.&lt;/p&gt;

&lt;p&gt;Anyway, I&apos;ll probably go with the admittedly-hackier custom logic approach, despite not liking it.  If anyone sees a better way forward though, please let me know.&lt;/p&gt;</comment>
                            <comment id="17230121" author="jira-bot" created="Wed, 11 Nov 2020 17:31:24 +0000"  >&lt;p&gt;Commit a7197ac0ce8333ce7019f49c6fab690a96ff7d77 in lucene-solr&apos;s branch refs/heads/master from Jason Gerlowski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=a7197ac&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=a7197ac&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14971&quot; title=&quot;AtomicUpdate &amp;#39;remove&amp;#39; fails on &amp;#39;pints&amp;#39; fields&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14971&quot;&gt;&lt;del&gt;SOLR-14971&lt;/del&gt;&lt;/a&gt;: Handle atomic-removes on uncommitted docs (#2056)&lt;/p&gt;

&lt;p&gt;Docs fetched from the update log via RTG look different than docs&lt;br/&gt;
fetched from commits in the index: the types of&lt;br/&gt;
field-values may be different between the two, etc.&lt;/p&gt;

&lt;p&gt;This is a problem for atomic add/remove of field values, where matching&lt;br/&gt;
existing values has historically been done by object equals() calls (via&lt;br/&gt;
Collection operations).  This relies on equality checks which don&apos;t have&lt;br/&gt;
flexible enough semantics to match values across these different types.&lt;br/&gt;
(For example, `new Long(1).equals(new Integer(1))` returns `false`).&lt;br/&gt;
This was causing some add-distinct and remove operations on&lt;br/&gt;
uncommitted values to silently fail to remove field values.&lt;/p&gt;

&lt;p&gt;This commit patches over this by converting between types in the more&lt;br/&gt;
common cases before using the fallback behavior.&lt;/p&gt;</comment>
                            <comment id="17230134" author="jira-bot" created="Wed, 11 Nov 2020 17:56:35 +0000"  >&lt;p&gt;Commit 8e9db02530d42a45c9ef89d93ea37f340c9a426c in lucene-solr&apos;s branch refs/heads/branch_8x from Jason Gerlowski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=8e9db02&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=8e9db02&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14971&quot; title=&quot;AtomicUpdate &amp;#39;remove&amp;#39; fails on &amp;#39;pints&amp;#39; fields&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14971&quot;&gt;&lt;del&gt;SOLR-14971&lt;/del&gt;&lt;/a&gt;: Handle atomic-removes on uncommitted docs (#2056)&lt;/p&gt;

&lt;p&gt;Docs fetched from the update log via RTG look different than docs&lt;br/&gt;
fetched from commits in the index: the types of&lt;br/&gt;
field-values may be different between the two, etc.&lt;/p&gt;

&lt;p&gt;This is a problem for atomic add/remove of field values, where matching&lt;br/&gt;
existing values has historically been done by object equals() calls (via&lt;br/&gt;
Collection operations).  This relies on equality checks which don&apos;t have&lt;br/&gt;
flexible enough semantics to match values across these different types.&lt;br/&gt;
(For example, `new Long(1).equals(new Integer(1))` returns `false`).&lt;br/&gt;
This was causing some add-distinct and remove operations on&lt;br/&gt;
uncommitted values to silently fail to remove field values.&lt;/p&gt;

&lt;p&gt;This commit patches over this by converting between types in the more&lt;br/&gt;
common cases before using the fallback behavior.&lt;/p&gt;</comment>
                            <comment id="17230138" author="gerlowskija" created="Wed, 11 Nov 2020 18:00:43 +0000"  >&lt;p&gt;On the github PR, Munendra pointed out that this downside also affects the &apos;add-distinct&apos; operation, so the commits above fix that too.&lt;/p&gt;

&lt;p&gt;Munendra proposed an alternative approach to what I ended up going with that might be worth looking into in the future.  He suggested having the &apos;original&apos; collection of field values iterated over and converted using &apos;toNativeType&apos;.  This would ensure that the needle and haystack are all of the same Java type so to speak and would save us a lot of manual type checking.  I liked this better conceptually but wasn&apos;t confident enough about what effect changing the type of ALL the uncommitted field values might have downstream to pursue it in this PR.  If other cases are found though the ugliness of the type checking might make this worth a second look though.&lt;/p&gt;

&lt;p&gt;Closing this out. &lt;/p&gt;</comment>
                            <comment id="17535653" author="janhoy" created="Thu, 12 May 2022 00:26:51 +0000"  >&lt;p&gt;Closing after the 9.0.0 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13014372" name="reproduce.sh" size="1580" author="gerlowskija" created="Thu, 29 Oct 2020 18:40:23 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 26 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0k4lk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>