<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:11:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-8451] We should not call method.abort in HttpSolrClient and HttpSolrCall#remoteQuery should not close streams.</title>
                <link>https://issues.apache.org/jira/browse/SOLR-8451</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description></description>
                <environment></environment>
        <key id="12923484">SOLR-8451</key>
            <summary>We should not call method.abort in HttpSolrClient and HttpSolrCall#remoteQuery should not close streams.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="markrmiller@gmail.com">Mark Miller</assignee>
                                    <reporter username="markrmiller@gmail.com">Mark Miller</reporter>
                        <labels>
                    </labels>
                <created>Mon, 21 Dec 2015 17:19:27 +0000</created>
                <updated>Mon, 9 May 2016 18:45:43 +0000</updated>
                            <resolved>Tue, 16 Feb 2016 18:18:23 +0000</resolved>
                                                    <fixVersion>5.5</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15066733" author="markrmiller@gmail.com" created="Mon, 21 Dec 2015 17:20:49 +0000"  >&lt;p&gt;See &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7339?focusedCommentId=15066701&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15066701&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-7339?focusedCommentId=15066701&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15066701&lt;/a&gt;&lt;br/&gt;
and&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7339?focusedCommentId=15066716&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15066716&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-7339?focusedCommentId=15066716&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15066716&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15066746" author="markrmiller@gmail.com" created="Mon, 21 Dec 2015 17:29:38 +0000"  >&lt;p&gt;&quot;I moved the method abort call out of &apos;shouldClose&apos; - it doesn&apos;t seem like it should be tied up in that.&lt;br/&gt;
I also made it first. I was just kind of guessing on that, but it looks like it should be first according to: &lt;a href=&quot;https://hc.apache.org/httpcomponents-client-ga/httpclient/examples/org/apache/http/examples/client/ClientAbortMethod.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://hc.apache.org/httpcomponents-client-ga/httpclient/examples/org/apache/http/examples/client/ClientAbortMethod.java&lt;/a&gt;&quot;&lt;/p&gt;</comment>
                            <comment id="15066748" author="markrmiller@gmail.com" created="Mon, 21 Dec 2015 17:30:04 +0000"  >&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Index: solr/solrj/src/java/org/apache/solr/client/solrj/impl/HttpSolrClient.java
===================================================================
--- solr/solrj/src/java/org/apache/solr/client/solrj/impl/HttpSolrClient.java	(revision 1720969)
+++ solr/solrj/src/java/org/apache/solr/client/solrj/impl/HttpSolrClient.java	(working copy)
@@ -589,14 +589,16 @@
       throw new SolrServerException(
           &quot;IOException occured when talking to server at: &quot; + getBaseURL(), e);
     } finally {
-      if (respBody != null &amp;amp;&amp;amp; shouldClose) {
-        try {
-          respBody.close();
-        } catch (IOException e) {
-          log.error(&quot;&quot;, e);
-        } finally {
-          if (!success) {
-            method.abort();
+      try {
+        if (!success) {
+          method.abort();
+        }
+      } finally {
+        if (respBody != null &amp;amp;&amp;amp; shouldClose) {
+          try {
+            respBody.close();
+          } catch (IOException e) {
+            log.error(&quot;&quot;, e);
           }
         }
       }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15069018" author="markrmiller@gmail.com" created="Wed, 23 Dec 2015 01:49:15 +0000"  >&lt;p&gt;I&apos;m evolving this patch in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8453&quot; title=&quot;Jetty update from 9.2 to 9.3 causes the server to reset formerly legitimate client connections.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8453&quot;&gt;&lt;del&gt;SOLR-8453&lt;/del&gt;&lt;/a&gt;. Quote from that issue: &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think we overdo method.abort and I think it messes up connection reuse. On a clean server-&amp;gt;client exception, we should simply make sure the response entity content is fully consumed and closed like a normal request.&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="15069681" author="markrmiller@gmail.com" created="Wed, 23 Dec 2015 14:40:15 +0000"  >&lt;p&gt;Okay, I dug into this a bit. Actually, we should not call abort at all. Right now, since we call it after close, it&apos;s harmless though.&lt;/p&gt;

&lt;p&gt;Also, ConcurrentUpdateSolrClient very oddly seem to always not read that last 40 or 44 bytes of the server response even on successful requests. That&apos;s odd, but should not mess with connection reuse. We only have to ensure we close the content stream, not read it all.&lt;/p&gt;</comment>
                            <comment id="15069751" author="kwright@metacarta.com" created="Wed, 23 Dec 2015 15:35:12 +0000"  >&lt;p&gt;I don&apos;t follow the reasoning here.  AFAICT method.abort should be called whenever there&apos;s any chance that the response has not been fully read, which would be the case if an exception was thrown.&lt;/p&gt;</comment>
                            <comment id="15069755" author="markrmiller@gmail.com" created="Wed, 23 Dec 2015 15:41:46 +0000"  >&lt;blockquote&gt;&lt;p&gt;whenever there&apos;s any chance that the response has not been fully read&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No documentation I can find says that.&lt;/p&gt;

&lt;p&gt;If you make a little test, you will see that method.abort prevents connection reuse. When Solr throws expected errors for updates, we don&apos;t want to poison the connection, we want it to go back to the pool. If we actually had to read the full stream, it would be better to just do that. But again, testing and any documentation I can find shows that we just have to close the stream - we don&apos;t have to read it all. And connections are released happily back to the pool for reuse.&lt;/p&gt;

&lt;p&gt;There is no need for abort here. Nor was it even having an affect when it was called after the content stream close (which it always was).&lt;/p&gt;</comment>
                            <comment id="15069812" author="kwright@metacarta.com" created="Wed, 23 Dec 2015 16:15:55 +0000"  >&lt;p&gt;Hmm, under some circumstances this is definitely not the right thing to do.  &lt;a href=&quot;http://stackoverflow.com/questions/1565349/cancel-abort-a-connection-from-the-threadsafeclientconnmanager-connection-pool&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://stackoverflow.com/questions/1565349/cancel-abort-a-connection-from-the-threadsafeclientconnmanager-connection-pool&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15071304" author="markrmiller@gmail.com" created="Fri, 25 Dec 2015 00:48:16 +0000"  >&lt;p&gt;It&apos;s the right thing to do. I have read the doc, the code, and mailing list info. I have done tests.&lt;/p&gt;

&lt;p&gt;After you are done using a connection you need to do either two things: abort it or close the content stream. If you abort it, you won&apos;t reuse the connection. There is no need to read through the whole inputstream. There is no need to use abort in normal safe code unless you need that as a feature to interrupt a request. All the proper example code shows the pattern to use is to just close the content input stream.&lt;/p&gt;

&lt;p&gt;In the end, it&apos;s really simple to test by hand and see what causes connection reuse and what breaks it.&lt;/p&gt;

&lt;p&gt;It was a mistake to add the abort call, but luckily it never had an effect - closing the content stream ended the request first anyway.&lt;/p&gt;</comment>
                            <comment id="15083852" author="markrmiller@gmail.com" created="Tue, 5 Jan 2016 21:35:25 +0000"  >&lt;p&gt;I have a connection reuse test that hits HttpSolrClient, CloudSolrClient, and ConcurrentUpdateSolrClient. Once I polish it up a little, I&apos;ll commit it with this issue.&lt;/p&gt;</comment>
                            <comment id="15084045" author="markrmiller@gmail.com" created="Tue, 5 Jan 2016 23:27:13 +0000"  >&lt;p&gt;Patch with connection reuse test attached. This new test won&apos;t work until we address the troublesome Jetty upgrade.&lt;/p&gt;</comment>
                            <comment id="15087953" author="jira-bot" created="Thu, 7 Jan 2016 19:37:50 +0000"  >&lt;p&gt;Commit 1723615 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1723615&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1723615&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8451&quot; title=&quot;We should not call method.abort in HttpSolrClient and HttpSolrCall#remoteQuery should not close streams.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8451&quot;&gt;&lt;del&gt;SOLR-8451&lt;/del&gt;&lt;/a&gt;: We should not call method.abort in HttpSolrClient or HttpSolrCall#remoteQuery and HttpSolrCall#remoteQuery should not close streams.&lt;/p&gt;</comment>
                            <comment id="15097099" author="jira-bot" created="Wed, 13 Jan 2016 22:04:38 +0000"  >&lt;p&gt;Commit 1724516 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1724516&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1724516&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8451&quot; title=&quot;We should not call method.abort in HttpSolrClient and HttpSolrCall#remoteQuery should not close streams.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8451&quot;&gt;&lt;del&gt;SOLR-8451&lt;/del&gt;&lt;/a&gt;: We should not call method.abort in HttpSolrClient or HttpSolrCall#remoteQuery and HttpSolrCall#remoteQuery should not close streams.&lt;/p&gt;</comment>
                            <comment id="15110095" author="markrmiller@gmail.com" created="Thu, 21 Jan 2016 05:40:27 +0000"  >&lt;p&gt;Okay, I&apos;d like to come back to this and actually add an attempt to make sure we have always consumed the full response inputstream before closing it.&lt;/p&gt;

&lt;p&gt;I have read, and testing shows, HttpClient appears to clean up these situations for us. We have fine connection reuse, even under error conditions. However, given Jetty was doing this for us on the server side basically, and then all of a sudden it was only half hearted attempting it (which broke us), I think it&apos;s better to put it into our client code explicitly.&lt;/p&gt;

&lt;p&gt;Just would make me sleep better, especially considering issues like &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8578&quot; title=&quot;Successful or not, requests are not always fully consumed by Solrj clients and we count on HttpClient or the JVM.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8578&quot;&gt;SOLR-8578&lt;/a&gt; ConcurrentUpdateSolrServer with BinaryResponseParser leaves 40-42 bytes unconsumed from the request response even without errors.&lt;/p&gt;</comment>
                            <comment id="15111807" author="markrmiller@gmail.com" created="Fri, 22 Jan 2016 02:29:23 +0000"  >&lt;blockquote&gt;&lt;p&gt;HttpClient appears to clean up these situations for us.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I have not been able to find it in the code. Perhaps it&apos;s java itself actually:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Prior to JDK 6, if an application closes a HTTP InputStream when more than a small amount of data remains to be read, then the connection had to be closed, rather than being cached. Now in JDK 6, the behavior is to read up to 512 Kbytes off the connection in a background thread, thus allowing the connection to be reused. The exact amount of data which may be read is configurable through the http.KeepAlive.remainingData system property.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;All the more reason to do it right our self if so.&lt;/p&gt;

&lt;p&gt;It may be the case that simply closing the inputstream is all we need to do:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;if the response body is long and you are not interested in the rest of it after seeing the beginning, you can close the InputStream. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;But, that may usually work, but not always:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;But you need to be aware that more data could be on its way. Thus the connection may not be cleared for reuse.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;So I see great connection reuse in tests, but this is all hairy stuff. We need to consume these streams just to be sure we are hitting every case.&lt;/p&gt;</comment>
                            <comment id="15121939" author="jira-bot" created="Thu, 28 Jan 2016 17:34:32 +0000"  >&lt;p&gt;Commit 62c9b6a1724fb466fd767457b7bbdeb24e164036 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=62c9b6a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=62c9b6a&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8451&quot; title=&quot;We should not call method.abort in HttpSolrClient and HttpSolrCall#remoteQuery should not close streams.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8451&quot;&gt;&lt;del&gt;SOLR-8451&lt;/del&gt;&lt;/a&gt;: fix randomization in test.&lt;/p&gt;</comment>
                            <comment id="15121955" author="jira-bot" created="Thu, 28 Jan 2016 17:40:50 +0000"  >&lt;p&gt;Commit 93172e461f76816474c1a1f2be8118c4b5e8538e in lucene-solr&apos;s branch refs/heads/branch_5x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=93172e4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=93172e4&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8451&quot; title=&quot;We should not call method.abort in HttpSolrClient and HttpSolrCall#remoteQuery should not close streams.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8451&quot;&gt;&lt;del&gt;SOLR-8451&lt;/del&gt;&lt;/a&gt;: fix randomization in test.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12932981">SOLR-8578</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12628469">SOLR-4327</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12923550">SOLR-8453</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12787439">SOLR-7339</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12924414">SOLR-8469</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12928394">SOLR-8501</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12781030" name="SOLR-8451.patch" size="18777" author="markrmiller@gmail.com" created="Thu, 7 Jan 2016 19:21:32 +0000"/>
                            <attachment id="12780654" name="SOLR-8451.patch" size="28295" author="markrmiller@gmail.com" created="Wed, 6 Jan 2016 02:29:03 +0000"/>
                            <attachment id="12780641" name="SOLR-8451.patch" size="18633" author="markrmiller@gmail.com" created="Tue, 5 Jan 2016 23:48:46 +0000"/>
                            <attachment id="12780639" name="SOLR-8451.patch" size="19272" author="markrmiller@gmail.com" created="Tue, 5 Jan 2016 23:27:13 +0000"/>
                            <attachment id="12779253" name="SOLR-8451.patch" size="6872" author="markrmiller@gmail.com" created="Wed, 23 Dec 2015 15:22:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 42 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2q63j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>