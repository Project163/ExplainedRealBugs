<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:42:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-13945] SPLITSHARD data loss due to &quot;rollback&quot;</title>
                <link>https://issues.apache.org/jira/browse/SOLR-13945</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;ol&gt;
	&lt;li&gt;As per &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7673&quot; title=&quot;Race condition in shard splitting can cause operation to hang indefinitely or sub-shards to never become active&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7673&quot;&gt;&lt;del&gt;SOLR-7673&lt;/del&gt;&lt;/a&gt;, there is a commit on the parent shard &lt;b&gt;after state changes&lt;/b&gt; have happened, i.e. from active/construction/construction to inactive/active/active. Please see &lt;a href=&quot;https://github.com/apache/lucene-solr/blob/master/solr/core/src/java/org/apache/solr/cloud/api/collections/SplitShardCmd.java#L586-L588&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/blob/master/solr/core/src/java/org/apache/solr/cloud/api/collections/SplitShardCmd.java#L586-L588&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;Due to &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12509&quot; title=&quot;Improve SplitShardCmd performance and reliability&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12509&quot;&gt;&lt;del&gt;SOLR-12509&lt;/del&gt;&lt;/a&gt;, there&apos;s now a cleanup/rollback method called &quot;cleanupAfterFailure&quot; in the finally block that resets the state to active/construction/construction. Please see: &lt;a href=&quot;https://github.com/apache/lucene-solr/blob/master/solr/core/src/java/org/apache/solr/cloud/api/collections/SplitShardCmd.java#L657&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/blob/master/solr/core/src/java/org/apache/solr/cloud/api/collections/SplitShardCmd.java#L657&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;When 2 is entered into due to a failure in 1, we have a situation where any documents that went into the subshards (because they are already active by now) are now lost after the parent becomes active.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;If my above understanding is correct, I am wondering:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Why is a commit to parent shard needed &lt;b&gt;after&lt;/b&gt; the parent shard is inactive, subshards are now active and the split operation has completed?&lt;/li&gt;
	&lt;li&gt;This rollback looks very suspicious. If state of subshards is already active and parent is inactive, then what is the need for setting them back to construction? Seems like a crucial check is missing there. Also, why do we reset the subshard status back to construction instead of inactive? It is extremely misleading (and, frankly, ridiculous) for any external clusterstate monitoring tools to see the subshards to go from CONSTRUCTION to ACTIVE to CONSTRUCTION and then the subshard disappearing.&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="13269327">SOLR-13945</key>
            <summary>SPLITSHARD data loss due to &quot;rollback&quot;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ichattopadhyaya">Ishan Chattopadhyaya</assignee>
                                    <reporter username="ichattopadhyaya">Ishan Chattopadhyaya</reporter>
                        <labels>
                    </labels>
                <created>Tue, 19 Nov 2019 14:37:47 +0000</created>
                <updated>Tue, 21 Jan 2020 16:59:21 +0000</updated>
                            <resolved>Thu, 12 Dec 2019 03:34:19 +0000</resolved>
                                                    <fixVersion>8.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="16977538" author="ichattopadhyaya" created="Tue, 19 Nov 2019 14:42:32 +0000"  >&lt;p&gt;Attaching a WIP patch getting rid of the commit() on parent shard that happens after the state changes have already taken place. Please note that I&apos;ve removed it because I wasn&apos;t able to understand why it was put there in the first place (&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7673&quot; title=&quot;Race condition in shard splitting can cause operation to hang indefinitely or sub-shards to never become active&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7673&quot;&gt;&lt;del&gt;SOLR-7673&lt;/del&gt;&lt;/a&gt;) and it just doesn&apos;t feel right.&lt;/p&gt;

&lt;p&gt;Also, in a subsequent patch, I would like to modify the rollback thing to do proper state checks before setting back the state and deleting the subshards, such that there is no data loss.&lt;/p&gt;</comment>
                            <comment id="16977776" author="noble.paul" created="Tue, 19 Nov 2019 19:33:08 +0000"  >&lt;p&gt;Is there any point is doing a rollback after the subshards are published as &lt;tt&gt;ACTIVE&lt;/tt&gt; ? Because , they have already started accepting writes and doing a rollback can make the user believe that the shard split failed but there is NO DATA LOSS. It&apos;s much better to just fail and let the user know that it failed due to something and he needs to take some remedial action&lt;/p&gt;</comment>
                            <comment id="16977952" author="ichattopadhyaya" created="Wed, 20 Nov 2019 00:47:30 +0000"  >&lt;p&gt;Please advise, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yonik&quot; class=&quot;user-hover&quot; rel=&quot;yonik&quot;&gt;yonik&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16978371" author="ab" created="Wed, 20 Nov 2019 12:26:29 +0000"  >&lt;p&gt;Did you run this scenario on a collection with replicationFactor==1? If not, then I think there must be something else going on here.&lt;/p&gt;

&lt;p&gt;The call to &lt;tt&gt;commit&lt;/tt&gt; assumes the parent shard is still ACTIVE, and it should be when repFactor &amp;gt; 1, because in this case the parent/sub shard states are switched to inactive/active not in SplitShardCmd but in ReplicaMutator, and then only &lt;b&gt;after&lt;/b&gt; all replicas in the new sub-shards finished recovering and are ACTIVE.&lt;/p&gt;

&lt;p&gt;This doesn&apos;t seem to be the case when repFactor == 1, because that&apos;s when the parent/sub shard states are switched immediately, and then indeed the call to commit would produce an error. This is something that we can easily fix by calling the commit earlier, or not treating this situation as a special case.&lt;/p&gt;

&lt;p&gt;This code section goes as far back as branch_5x &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/warning.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; and I can&apos;t say I fully understand the need for this commit here - I suspect it has something to do with buffering updates and tlog replays between parent and sub-shards, so removing it may result in other subtle data loss.&lt;/p&gt;</comment>
                            <comment id="16978405" author="ichattopadhyaya" created="Wed, 20 Nov 2019 13:11:51 +0000"  >&lt;blockquote&gt;&lt;p&gt;Did you run this scenario on a collection with replicationFactor==1? If not, then I think there must be something else going on here.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Exactly, replicationFactor was 1, hence state change was immediate.&lt;/p&gt;</comment>
                            <comment id="16978427" author="ab" created="Wed, 20 Nov 2019 13:32:59 +0000"  >&lt;p&gt;Please try the patch that I attached just now.&lt;/p&gt;</comment>
                            <comment id="16978520" author="yseeley@gmail.com" created="Wed, 20 Nov 2019 15:34:28 +0000"  >&lt;p&gt;It would be great if we could capture what is currently understood about the overall split strategy here in code comments (unless it already is and I&apos;m missing it?).... perhaps at the top of SplitShardCmd since it is the top-level coordinator for a split?&lt;/p&gt;</comment>
                            <comment id="16978536" author="ichattopadhyaya" created="Wed, 20 Nov 2019 15:52:13 +0000"  >&lt;p&gt;Thanks for your patch. +1 to Yonik&apos;s suggestion. We really need that for this 500 line method, which is so hard to grasp!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Please try the patch that I attached just now.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think we should add a defensive check at the beginning of your cleanup method, on the lines of: if both subshards are active, don&apos;t do anything and bail out.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (repFactor &amp;gt; 1) {
+        t = timings.sub(&lt;span class=&quot;code-quote&quot;&gt;&quot;finalCommit&quot;&lt;/span&gt;);
+        ocmh.commit(results, slice.get(), parentShardLeader);
+        t.stop();
+      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Also, can you please add a comment on why repFactor&amp;gt;1 needs a special handling here?&lt;/p&gt;</comment>
                            <comment id="16978538" author="ichattopadhyaya" created="Wed, 20 Nov 2019 15:53:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;This code section goes as far back as branch_5x and I can&apos;t say I fully understand the need for this commit here - I suspect it has something to do with buffering updates and tlog replays between parent and sub-shards, so removing it may result in other subtle data loss.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;, any ideas, please?&lt;/p&gt;</comment>
                            <comment id="16978661" author="ab" created="Wed, 20 Nov 2019 18:35:57 +0000"  >&lt;blockquote&gt;&lt;p&gt;can you please add a comment on why repFactor&amp;gt;1 needs a special handling here?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;My (limited) understanding is that the new sub-replicas are already sort of recovered - they don&apos;t need to be recovered through peer-sync because they were constructed with all necessary content by SolrIndexSplitter just a moment ago.&lt;/p&gt;

&lt;p&gt;The condition to switch states of parent/sub-shards is that all sub-replicas are recovered, and this is the case here, so there&apos;s no need to wait for it asynchronously (by monitoring replica states in ReplicaMutator).&lt;/p&gt;</comment>
                            <comment id="16981287" author="shalinmangar" created="Mon, 25 Nov 2019 04:28:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ichattopadhyaya&quot; class=&quot;user-hover&quot; rel=&quot;ichattopadhyaya&quot;&gt;ichattopadhyaya&lt;/a&gt; - the final commit was added in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4997&quot; title=&quot;The splitshard api doesn&amp;#39;t call commit on new sub shards&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4997&quot;&gt;&lt;del&gt;SOLR-4997&lt;/del&gt;&lt;/a&gt; so that documents are visible when the sub-shard replicas come up. &lt;del&gt;It is not necessary if there is a single replica.&lt;/del&gt; (note it is necessary to call this commit regardless of the replication factor)&lt;/p&gt;</comment>
                            <comment id="16981291" author="ichattopadhyaya" created="Mon, 25 Nov 2019 04:43:44 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;. &lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;I&apos;ll add parts of your comment above as a documentation comment around that commit() call.&lt;/li&gt;
	&lt;li&gt;I&apos;ll update the rollback code to add a check for state and skip the rollback in case of inactive/active/active.&lt;/li&gt;
	&lt;li&gt;Does it make sense to add a retry around the commit()? (In our case, the commit() probably didn&apos;t fail on the leader but likely just timed out).&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="16994140" author="jira-bot" created="Thu, 12 Dec 2019 03:28:52 +0000"  >&lt;p&gt;Commit 8db8ab3be23b029b5b32e06f2682a905d4e707b2 in lucene-solr&apos;s branch refs/heads/master from Ishan Chattopadhyaya&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=8db8ab3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=8db8ab3&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13945&quot; title=&quot;SPLITSHARD data loss due to &amp;quot;rollback&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13945&quot;&gt;&lt;del&gt;SOLR-13945&lt;/del&gt;&lt;/a&gt;: SPLITSHARD can cause data loss due to rollback when final commit fails&lt;/p&gt;</comment>
                            <comment id="16994142" author="ichattopadhyaya" created="Thu, 12 Dec 2019 03:30:44 +0000"  >&lt;p&gt;Updated &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;&apos;s patch to add some comments and the state check (skip if inactive/active/active) in the cleanup method. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16994146" author="jira-bot" created="Thu, 12 Dec 2019 03:33:22 +0000"  >&lt;p&gt;Commit a13b387fb5448dd0d43663a6c831faccb9d2e27a in lucene-solr&apos;s branch refs/heads/branch_8x from Ishan Chattopadhyaya&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=a13b387&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=a13b387&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13945&quot; title=&quot;SPLITSHARD data loss due to &amp;quot;rollback&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13945&quot;&gt;&lt;del&gt;SOLR-13945&lt;/del&gt;&lt;/a&gt;: SPLITSHARD can cause data loss due to rollback when final commit fails&lt;/p&gt;</comment>
                            <comment id="17005033" author="jpountz" created="Sun, 29 Dec 2019 20:52:02 +0000"  >&lt;p&gt;Closing after the 8.4.0 release.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12986333" name="SOLR-13945.patch" size="1424" author="ab" created="Wed, 20 Nov 2019 13:32:38 +0000"/>
                            <attachment id="12986249" name="SOLR-13945.patch" size="779" author="ichattopadhyaya" created="Tue, 19 Nov 2019 15:20:52 +0000"/>
                            <attachment id="12986241" name="SOLR-13945.patch" size="945" author="ichattopadhyaya" created="Tue, 19 Nov 2019 14:39:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 46 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z08saw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>