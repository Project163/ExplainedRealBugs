<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:42:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-12859] DocExpirationUpdateProcessorFactory does not work with BasicAuth (and other auth plugins that use PKI)</title>
                <link>https://issues.apache.org/jira/browse/SOLR-12859</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;DocExpirationUpdateProcessorFactory initiates it&apos;s periodic delete requests in a way that caused the PKIAuthenticationPlugin to treat them as requests from un-authenticated users, causing them to be rejected when forwarded to other nodes.&lt;/p&gt;

&lt;p&gt;Allthough there are some open questions as to wether or not the overall design of how/where/when PKIAuthenticationPlugin recognizes a &quot;server initiated&quot; &lt;tt&gt;NODE_IS_USER&lt;/tt&gt; requests (vs how/where/when it &lt;em&gt;should&lt;/em&gt; recognize a server initiated request) this issue took a narrow focus of change &lt;b&gt;ONLY&lt;/b&gt; the DocExpirationUpdateProcessorFactory to &quot;fix&quot; the way it generated it&apos;s delete request to ensure PKIAuthenticationPlugin would recognize these as &lt;tt&gt;NODE_IS_USER.&lt;/tt&gt;&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I setup a cluster with basic auth and then wanted to use Solr&apos;s TTL feature ( DocExpirationUpdateProcessorFactory ) to auto-delete documents.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Turns out it doesn&apos;t work when Basic Auth is enabled. I get the following stacktrace from the logs&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2018-10-12 22:06:38.967 ERROR (autoExpireDocs-42-thread-1) [&#160;&#160; ] o.a.s.u.p.DocExpirationUpdateProcessorFactory &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt; error in periodic deletion of expired docs: Async exception during distributed update: Error from server at http:&lt;span class=&quot;code-comment&quot;&gt;//192.168.0.8:8983/solr/gettingstarted_shard2_replica_n6: require authentication
&lt;/span&gt;


request: http:&lt;span class=&quot;code-comment&quot;&gt;//192.168.0.8:8983/solr/gettingstarted_shard2_replica_n6/update?update.distrib=TOLEADER&amp;amp;distrib.from=http%3A%2F%2F192.168.0.8%3A8983%2Fsolr%2Fgettingstarted_shard1_replica_n2%2F&amp;amp;wt=javabin&amp;amp;version=2
&lt;/span&gt;org.apache.solr.update.processor.DistributedUpdateProcessor$DistributedUpdatesAsyncException: Async exception during distributed update: Error from server at http:&lt;span class=&quot;code-comment&quot;&gt;//192.168.0.8:8983/solr/gettingstarted_shard2_replica_n6: require authentication
&lt;/span&gt;


request: http:&lt;span class=&quot;code-comment&quot;&gt;//192.168.0.8:8983/solr/gettingstarted_shard2_replica_n6/update?update.distrib=TOLEADER&amp;amp;distrib.from=http%3A%2F%2F192.168.0.8%3A8983%2Fsolr%2Fgettingstarted_shard1_replica_n2%2F&amp;amp;wt=javabin&amp;amp;version=2
&lt;/span&gt;&#160;&#160; &#160;at org.apache.solr.update.processor.DistributedUpdateProcessor.doFinish(DistributedUpdateProcessor.java:964) ~[solr-core-7.5.0.jar:7.5.0 b5bf70b7e32d7ddd9742cc821d471c5fabd4e3df - jimczi - 2018-09-18 13:07:55]
&#160;&#160; &#160;at org.apache.solr.update.processor.DistributedUpdateProcessor.finish(DistributedUpdateProcessor.java:1976) ~[solr-core-7.5.0.jar:7.5.0 b5bf70b7e32d7ddd9742cc821d471c5fabd4e3df - jimczi - 2018-09-18 13:07:55]
&#160;&#160; &#160;at org.apache.solr.update.processor.LogUpdateProcessorFactory$LogUpdateProcessor.finish(LogUpdateProcessorFactory.java:182) ~[solr-core-7.5.0.jar:7.5.0 b5bf70b7e32d7ddd9742cc821d471c5fabd4e3df - jimczi - 2018-09-18 13:07:55]
&#160;&#160; &#160;at org.apache.solr.update.processor.UpdateRequestProcessor.finish(UpdateRequestProcessor.java:80) ~[solr-core-7.5.0.jar:7.5.0 b5bf70b7e32d7ddd9742cc821d471c5fabd4e3df - jimczi - 2018-09-18 13:07:55]
&#160;&#160; &#160;at org.apache.solr.update.processor.UpdateRequestProcessor.finish(UpdateRequestProcessor.java:80) ~[solr-core-7.5.0.jar:7.5.0 b5bf70b7e32d7ddd9742cc821d471c5fabd4e3df - jimczi - 2018-09-18 13:07:55]
&#160;&#160; &#160;at org.apache.solr.update.processor.UpdateRequestProcessor.finish(UpdateRequestProcessor.java:80) ~[solr-core-7.5.0.jar:7.5.0 b5bf70b7e32d7ddd9742cc821d471c5fabd4e3df - jimczi - 2018-09-18 13:07:55]
&#160;&#160; &#160;at org.apache.solr.update.processor.UpdateRequestProcessor.finish(UpdateRequestProcessor.java:80) ~[solr-core-7.5.0.jar:7.5.0 b5bf70b7e32d7ddd9742cc821d471c5fabd4e3df - jimczi - 2018-09-18 13:07:55]
&#160;&#160; &#160;at org.apache.solr.update.processor.UpdateRequestProcessor.finish(UpdateRequestProcessor.java:80) ~[solr-core-7.5.0.jar:7.5.0 b5bf70b7e32d7ddd9742cc821d471c5fabd4e3df - jimczi - 2018-09-18 13:07:55]
&#160;&#160; &#160;at org.apache.solr.update.processor.UpdateRequestProcessor.finish(UpdateRequestProcessor.java:80) ~[solr-core-7.5.0.jar:7.5.0 b5bf70b7e32d7ddd9742cc821d471c5fabd4e3df - jimczi - 2018-09-18 13:07:55]
&#160;&#160; &#160;at org.apache.solr.update.processor.UpdateRequestProcessor.finish(UpdateRequestProcessor.java:80) ~[solr-core-7.5.0.jar:7.5.0 b5bf70b7e32d7ddd9742cc821d471c5fabd4e3df - jimczi - 2018-09-18 13:07:55]
&#160;&#160; &#160;at org.apache.solr.update.processor.UpdateRequestProcessor.finish(UpdateRequestProcessor.java:80) ~[solr-core-7.5.0.jar:7.5.0 b5bf70b7e32d7ddd9742cc821d471c5fabd4e3df - jimczi - 2018-09-18 13:07:55]
&#160;&#160; &#160;at org.apache.solr.update.processor.UpdateRequestProcessor.finish(UpdateRequestProcessor.java:80) ~[solr-core-7.5.0.jar:7.5.0 b5bf70b7e32d7ddd9742cc821d471c5fabd4e3df - jimczi - 2018-09-18 13:07:55]
&#160;&#160; &#160;at org.apache.solr.update.processor.UpdateRequestProcessor.finish(UpdateRequestProcessor.java:80) ~[solr-core-7.5.0.jar:7.5.0 b5bf70b7e32d7ddd9742cc821d471c5fabd4e3df - jimczi - 2018-09-18 13:07:55]
&#160;&#160; &#160;at org.apache.solr.update.processor.UpdateRequestProcessor.finish(UpdateRequestProcessor.java:80) ~[solr-core-7.5.0.jar:7.5.0 b5bf70b7e32d7ddd9742cc821d471c5fabd4e3df - jimczi - 2018-09-18 13:07:55]
&#160;&#160; &#160;at org.apache.solr.update.processor.DocExpirationUpdateProcessorFactory$DeleteExpiredDocsRunnable.run(DocExpirationUpdateProcessorFactory.java:419) [solr-core-7.5.0.jar:7.5.0 b5bf70b7e32d7ddd9742cc821d471c5fabd4e3df - jimczi - 2018-09-18 13:07:55]
&#160;&#160; &#160;at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) [?:1.8.0_112]
&#160;&#160; &#160;at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:308) [?:1.8.0_112]
&#160;&#160; &#160;at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180) [?:1.8.0_112]
&#160;&#160; &#160;at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294) [?:1.8.0_112]
&#160;&#160; &#160;at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_112]
&#160;&#160; &#160;at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_112]
&#160;&#160; &#160;at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) [?:1.8.0_112]&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13191313">SOLR-12859</key>
            <summary>DocExpirationUpdateProcessorFactory does not work with BasicAuth (and other auth plugins that use PKI)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Chris M. Hostetter</assignee>
                                    <reporter username="varun">Varun Thacker</reporter>
                        <labels>
                    </labels>
                <created>Fri, 12 Oct 2018 22:10:38 +0000</created>
                <updated>Tue, 24 Mar 2020 12:46:25 +0000</updated>
                            <resolved>Wed, 22 Jan 2020 17:58:58 +0000</resolved>
                                    <version>7.5</version>
                                    <fixVersion>8.5</fixVersion>
                    <fixVersion>9.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16649482" author="janhoy" created="Sun, 14 Oct 2018 18:24:33 +0000"  >&lt;p&gt;Guess we&apos;ll have to force it into using PKI, which it should automatically do if the TTL feature&#160;uses the correct thread pool...?&lt;/p&gt;</comment>
                            <comment id="16649488" author="janhoy" created="Sun, 14 Oct 2018 18:27:10 +0000"  >&lt;p&gt;Linking with &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12860&quot; title=&quot;MetricsHistoryHandler does not work with BasicAuth&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12860&quot;&gt;&lt;del&gt;SOLR-12860&lt;/del&gt;&lt;/a&gt; which I believe may have the same cause/solution&lt;/p&gt;</comment>
                            <comment id="16815324" author="janhoy" created="Thu, 11 Apr 2019 11:06:59 +0000"  >&lt;p&gt;I did some tests and managed to avoid 401 on the background delete request. But it fails when the request is distributed to the other&#160;Solr nodes, so somehow there is some Runners or thread pools that do not inherit the isSolrServerThread flag &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;It is using &lt;tt&gt;ErrorReportingConcurrentUpdateSolrClient&lt;/tt&gt; to do the distribution, and I think that is where things go wrong. Tried to transfer the server flag into &lt;tt&gt;ConcurrentUpdateHttp2SolrClient&lt;/tt&gt;&apos;s Runner class but with no success. Ideally these things should be inherited automatically when new threads and executors are spawned...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman&quot; class=&quot;user-hover&quot; rel=&quot;hossman&quot;&gt;hossman&lt;/a&gt;, I see you authored the &lt;tt&gt;DocExpirationUpdateProcessorFactory&lt;/tt&gt; back in the days, any ideas?&lt;/p&gt;</comment>
                            <comment id="16815672" author="hossman" created="Thu, 11 Apr 2019 17:53:05 +0000"  >&lt;p&gt;So, i don&apos;t really know/understand what &quot;isSolrServerThread&quot; is (and skimming the code didn&apos;t make it immediately obvious) but i &lt;em&gt;hope&lt;/em&gt; based on context it&apos;s some solution for how intranode communication can indicate that a node1-&amp;gt;node2 request was initiated directly by node1, and should use some special &quot;direct from node&quot; authorization instead of expecting that node1 should use authorizationforwarded from a client, like in a client-&amp;gt;node1-&amp;gt;node2 situation... is that the idea?&lt;/p&gt;

&lt;p&gt;as far as the parts i &lt;b&gt;do&lt;/b&gt; understand, in DocExpirationUpdateProcessorFactory there is a ScheduledThreadPoolExecutor which periodically runs a DeleteExpiredDocsRunnable which creates a new LocalSolrQueryRequest instance and runs it on the configured chain.&lt;/p&gt;

&lt;p&gt;so &amp;#8211; i&apos;m guessing &amp;#8211; somewhere in the DocExpirationUpdateProcessorFactory/ScheduledThreadPoolExecutor/DeleteExpiredDocsRunnable/LocalSolrQueryRequest call stack something needs to set/use/consult some code to indicate that this &quot;isSolrServerThread&quot; and then, hopefuly, (some magic i don&apos;t understand but you do) the authentication framework will make sure the &quot;correct&quot; credentials get used when DistribuUpdateProcessor forwards that to other nodes ... maybe?&lt;/p&gt;</comment>
                            <comment id="16816051" author="janhoy" created="Fri, 12 Apr 2019 07:46:17 +0000"  >&lt;p&gt;Yes. &lt;tt&gt;PKIAuthenticationPlugin&lt;/tt&gt; will always insert an &lt;tt&gt;HttpRequestInterceptor&lt;/tt&gt;&#160;on the SolrJ (calling) side, ant for every request made, it will first check if the thread is a &quot;solrServerThread&quot; (threadLocal bool in ExecutorUtils), and if it is, it will set the HTTP header &quot;&lt;tt&gt;SolrAuth &amp;lt;nodename&amp;gt; &amp;lt;cipher&amp;gt;&quot;&lt;/tt&gt;&#160;on the request, which the auth framework no the receiving end will detect and invoke PKI auth plugin instead of requiring BasicAuth or whatever configured.&lt;/p&gt;

&lt;p&gt;So even if I set this &lt;tt&gt;isSolrServerThread&lt;/tt&gt;&#160;flag in the runner for the scheduled executor, it gets lost further down. I guess you&apos;re onto something in documenting the call chain and then carefully make sure the flag survives each &quot;hop&quot;. I wish there was a less fragile way to tag&#160;Solr-initiated traffic.&lt;/p&gt;</comment>
                            <comment id="16856010" author="caomanhdat" created="Tue, 4 Jun 2019 18:48:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=janhoy&quot; class=&quot;user-hover&quot; rel=&quot;janhoy&quot;&gt;janhoy&lt;/a&gt; &lt;tt&gt;PKIAuthenticationPlugin&lt;/tt&gt; why should need that flag &lt;tt&gt;isSolrServerThread&lt;/tt&gt;, any request get intercepted by PKIAuthenticationPlugin will be an internal request right?&lt;/p&gt;</comment>
                            <comment id="16979654" author="hossman" created="Thu, 21 Nov 2019 22:20:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=janhoy&quot; class=&quot;user-hover&quot; rel=&quot;janhoy&quot;&gt;janhoy&lt;/a&gt; - skimming the code a bit, i echo Dat&apos;s question from June: why does the &lt;tt&gt;isSolrServerThread&lt;/tt&gt; concept exist? looking at where it&apos;s used, I&apos;m not clear from the code comment (below) why &lt;tt&gt;PKIAuthenticationPlugin&lt;/tt&gt; cares about this thread local variable, since it&apos;s already checking if &lt;tt&gt;SolrRequestInfo&lt;/tt&gt; is null ...&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    SolrRequestInfo reqInfo = getRequestInfo();
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; usr;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (reqInfo != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
       &lt;span class=&quot;code-comment&quot;&gt;// ...
&lt;/span&gt;        usr = principal.getName();
      }
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
      &lt;span class=&quot;code-comment&quot;&gt;//
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// ??? JAN: what does &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; comment below mean ???
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;//
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isSolrThread()) {
        &lt;span class=&quot;code-comment&quot;&gt;//&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is not running inside a Solr threadpool (as in testcases)
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// then no need to add any header
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Optional.empty();
      }
      &lt;span class=&quot;code-comment&quot;&gt;//&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; request seems to be originated from Solr itself
&lt;/span&gt;      usr = &lt;span class=&quot;code-quote&quot;&gt;&quot;$&quot;&lt;/span&gt;; &lt;span class=&quot;code-comment&quot;&gt;//special name to denote the user is the node itself
&lt;/span&gt;    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Assuming it is important to use/set the &lt;tt&gt;isSolrThread(&lt;/tt&gt; thread local value, what is the &quot;best practice&quot; way to do so?&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;I see the (no-javadoc) public method &lt;tt&gt;ExecutorUtil.setServerThreadFlag(Boolean)&lt;/tt&gt; &#8211; but it doesn&apos;t seem to be used much, and in the case of &lt;tt&gt;SolrDispatchFilter&lt;/tt&gt; it&apos;s usage seems backwards to me (it looks like it&apos;s set to &apos;true&apos; when ever processing any request from a client????)&lt;/li&gt;
	&lt;li&gt;the most obvious way that it seems like it &lt;em&gt;should&lt;/em&gt; be used is automatically when using &lt;tt&gt;MDCAwareThreadPoolExecutor&lt;/tt&gt; &#8211; but in the case of &lt;tt&gt;DocExpirationUpdateProcessorFactory&lt;/tt&gt; we need to use a &lt;tt&gt;ScheduledThreadPoolExecutor&lt;/tt&gt; ... is there a reason this thread local variable is set in &lt;tt&gt;MDCAwareThreadPoolExecutor&lt;/tt&gt; instead of &lt;tt&gt;SolrjNamedThreadFactory&lt;/tt&gt; ?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16980416" author="janhoy" created="Fri, 22 Nov 2019 19:00:17 +0000"  >&lt;p&gt;I have the same questions. The concept of &lt;tt&gt;isSolrThread&lt;/tt&gt; was introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7849&quot; title=&quot;Secure Inter-node communication in a  standard mechanism&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7849&quot;&gt;&lt;del&gt;SOLR-7849&lt;/del&gt;&lt;/a&gt;. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt; do you recall?&lt;/p&gt;</comment>
                            <comment id="17016414" author="hossman" created="Thu, 16 Jan 2020 00:07:36 +0000"  >&lt;p&gt;I&apos;ve been looking into this &#8211; starting with a bunch of work to beef up the existing (SolrCloud) &lt;tt&gt;DistribDocExpirationUpdateProcessorTest&lt;/tt&gt; to also test a cluster with BasicAuth enabled (and to test multiple replicas with multiple docs that need to expire &#8211; originally the test only expired 1 doc and was focused on ensuring there weren&apos;t unneccessary deletes on unafected shards, but that ment that with basic auth neabled it qas frequently getting lucky and passing)&lt;/p&gt;

&lt;p&gt;Once I had a reliably BasicAuth + DocExpirationUpdateProcessorFactory test in place, i started digging into the logs and realized that the &lt;tt&gt;isSolrServerThread()&lt;/tt&gt; logic isn&apos;t the problem...&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;isSolrServerThread()&lt;/tt&gt; is getting &quot;properly&quot; (i guess?) set on the &lt;tt&gt;ErrorReportingConcurrentUpdateSolrClient&lt;/tt&gt; instances used by &lt;tt&gt;DistribUpdateProcessor&lt;/tt&gt; (by way of using the &lt;tt&gt;Http2SolrClient&lt;/tt&gt; from &lt;tt&gt;UpdateShardHandler&lt;/tt&gt; under the covers) ... but that never comes into play, because of the user Principal check...&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; Optional&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; generateToken() {
    SolrRequestInfo reqInfo = getRequestInfo();
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; usr;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (reqInfo != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      Principal principal = reqInfo.getUserPrincipal();
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (principal == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        log.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;principal is &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt;);
        &lt;span class=&quot;code-comment&quot;&gt;//&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; had a request but not authenticated
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;//so we don&apos;t not need to set a principal
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Optional.empty();
      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
        usr = principal.getName();
      }
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isSolrThread()) {
      ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The Runnable used in &lt;tt&gt;DocExpirationUpdateProcessor&lt;/tt&gt; has to create a &lt;tt&gt;LocalSolrQueryRequest&lt;/tt&gt; &#8211; &lt;b&gt;AND&lt;/b&gt; set the &lt;tt&gt;SolrRequestInfo&lt;/tt&gt; for the thread &#8211; in order to play nice with the UpdateProcessor chain, but because it does that, &lt;tt&gt;PKIAuthenticationPlugin&lt;/tt&gt; never looks at &lt;tt&gt;isSolrThread()&lt;/tt&gt; ... first it says &quot;hey, this has a SolrRequest, so the only thing we care about is the UserPrincipal from that SolrRequest&quot; and never goes any farther then that.&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;My initial reaction was to &quot;swap&quot; the order of the Principle/isSolrThread() checks &#8211; but w/o a better understanding of why &lt;tt&gt;isSolrThread()&lt;/tt&gt; exists that seems risky (especially since AFAICT, every &lt;tt&gt;SolrClient&lt;/tt&gt; used for distributed Solr requests will return &quot;true&quot; for &lt;tt&gt;isSolrThread()&lt;/tt&gt; &#8211; meaning PKI would probably completely stop forwarding credentials if we did that?&lt;/p&gt;

&lt;p&gt;So for now, the attached patch includes the best straw man solution I could think of to fix the problem and minimize the surface area of the patch:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;LocalSolrQueryRequest now supports setting a Principal&lt;/li&gt;
	&lt;li&gt;DocExpirationUpdateProcessorFactory now sets a Principal user of &lt;tt&gt;PKIAuthenticationPlugin.NODE_IS_USER&lt;/tt&gt; (ie: &lt;tt&gt;&apos;$&apos;&lt;/tt&gt; )
	&lt;ul&gt;
		&lt;li&gt;which is what PKI&apos;s &lt;tt&gt;generateToken()&lt;/tt&gt; uses when &lt;tt&gt;isSolrThread()&lt;/tt&gt; is true anyway&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;m not a huge fan of this solution, but it&apos;s the best I&apos;ve been able to come up with ... any concerns / alternative suggestions?&lt;/p&gt;</comment>
                            <comment id="17016503" author="lucenesolrqa" created="Thu, 16 Jan 2020 03:25:48 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/error.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;b&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;&lt;/b&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Vote &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Subsystem &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Runtime &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Comment &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; Prechecks &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; test4tests &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  0m  0s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; The patch appears to include 1 new or modified test files. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; master Compile Tests &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; compile &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m  0s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; master passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; Patch Compile Tests &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; compile &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m  0s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; javac &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m  0s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Release audit (RAT) &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m  0s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Check forbidden APIs &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m  0s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Validate source patterns &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m  0s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; Other Tests &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt;-1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt; unit &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt; 45m 19s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt; core in the patch failed. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt;&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt; &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt; 49m  6s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt; &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Reason &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Tests &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Failed junit tests &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; solr.search.FuzzySearchTest &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Subsystem &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Report/Notes &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; JIRA Issue &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12859&quot; title=&quot;DocExpirationUpdateProcessorFactory does not work with BasicAuth (and other auth plugins that use PKI)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12859&quot;&gt;&lt;del&gt;SOLR-12859&lt;/del&gt;&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; JIRA Patch URL &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12991050/SOLR-12859.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12991050/SOLR-12859.patch&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Optional Tests &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  compile  javac  unit  ratsources  checkforbiddenapis  validatesourcepatterns  &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; uname &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Linux lucene1-us-west 4.15.0-54-generic #58-Ubuntu SMP Mon Jun 24 10:55:24 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Build tool &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ant &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Personality &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; /home/jenkins/jenkins-slave/workspace/PreCommit-SOLR-Build/sourcedir/dev-tools/test-patch/lucene-solr-yetus-personality.sh &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; git revision &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; master / 4c473db99d5 &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ant &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; version: Apache Ant(TM) version 1.10.5 compiled on March 28 2019 &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Default Java &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; LTS &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; unit &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/job/PreCommit-SOLR-Build/651/artifact/out/patch-unit-solr_core.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-SOLR-Build/651/artifact/out/patch-unit-solr_core.txt&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  Test Results &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/job/PreCommit-SOLR-Build/651/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-SOLR-Build/651/testReport/&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; modules &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; C: solr/core U: solr/core &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Console output &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/job/PreCommit-SOLR-Build/651/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-SOLR-Build/651/console&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Powered by &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Apache Yetus 0.7.0   &lt;a href=&quot;http://yetus.apache.org&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://yetus.apache.org&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;



&lt;p&gt;This message was automatically generated.&lt;/p&gt;
</comment>
                            <comment id="17017689" author="caomanhdat" created="Fri, 17 Jan 2020 04:06:33 +0000"  >&lt;p&gt;To be honest, I&apos;m never fully understand the current authentication framework of Solr. When I did the HTTP/2 things, I basically convert the current interceptor of Apache HttpClient to an equivalent version. After spend sometime to look at the current code and the documentation. I&apos;m guessing that &lt;tt&gt;isSolrThread()&lt;/tt&gt; is a naive/workaround way to check whether the request is about to send to another node was actually sent by a Solr node or not?&lt;/p&gt;

&lt;p&gt;Let&apos;s look into this comment&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;//if this is not running inside a Solr threadpool (as in testcases)&lt;br/&gt;
// then no need to add any header&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;above comment will make sense if we notice how the interceptors was added for Apache HttpClient&lt;br/&gt;
&lt;tt&gt;HttpClientUtil.addRequestInterceptor(interceptor)&lt;/tt&gt; -&amp;gt; interceptor is added into a static variable. This is ok if a JVM only host one node, but with test, a JVM will host several nodes, so there are several PKI interceptors will be added to that static variable. Moreoever every Apache HttpClient created by HttpClientUtil will share the same list of interceptors even with client created in test. So a client created by test, before sending a request will go through n generateToken() interceptors (n = number of Solr nodes).&lt;/p&gt;

&lt;p&gt;In that case how generateToken() can discriminate a request sent from a node with a request sent from a test method if all client will use a same list of interceptors? The naive solution was setting a flag called &lt;tt&gt;isSolrThread&lt;/tt&gt; to distinguish these two case.&lt;br/&gt;
In most of cases, a request sent by a node will be sent from a thread from a threadPool created by &lt;tt&gt;ExecutorUtil&lt;/tt&gt;. So to make auth tests pass  &lt;tt&gt;isServerPool.set(Boolean.TRUE);&lt;/tt&gt; is set before calling any &lt;tt&gt;Runnable&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;With all of these context less review the mystery code again &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    SolrRequestInfo reqInfo = getRequestInfo();
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; usr;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (reqInfo != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      &lt;span class=&quot;code-comment&quot;&gt;// 1.Author&apos;s idea: Ok, the thread is holding a request, &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; authentication is enabled, the req must hold a Principal
&lt;/span&gt;      Principal principal = reqInfo.getUserPrincipal();
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (principal == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        &lt;span class=&quot;code-comment&quot;&gt;// 2. Author&apos;s idea: the req did not pass authentication since Principal is not set, &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not need to &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; anything here!
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// my comment: &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is not &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, SolrRequestInfo is also used as a garbage to put data into so many place rely on data inside SolrRequestInfo, the present of SolrRequestInfo does not mean that it comes from outside.
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Optional.empty();
      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
        usr = principal.getName();
      }
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isSolrThread()) {
        &lt;span class=&quot;code-comment&quot;&gt;// 3. Author&apos;s idea: so the req is not sent inside a thread created by ExecutorUtil, it must come from test code or outside world
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// my comment: it is not &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, since in {{DocExpirationUpdateProcessorFactory}} a {{ScheduledThreadPoolExecutor}} was used instead of a threadPool created by ExecutorUtil
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Optional.empty();
      }
      &lt;span class=&quot;code-comment&quot;&gt;// 4. Author&apos;s idea: &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the req is sent by ExecutorUtil, it must come out from &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; node.
&lt;/span&gt;      usr = &lt;span class=&quot;code-quote&quot;&gt;&quot;$&quot;&lt;/span&gt;; &lt;span class=&quot;code-comment&quot;&gt;//special name to denote the user is the node itself
&lt;/span&gt;    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But with new HTTP/2 client, interceptor is added to each client object, so there are no single static variable here -&amp;gt; no sharing interceptors between clients of nodes and clients of test -&amp;gt; if the interceptor&apos;s code is called it must be sent from a node. So the mystery block can be changed to for the interceptor of HTTP/2 client&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    SolrRequestInfo reqInfo = getRequestInfo();
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; usr = NODE_IS_USER;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (reqInfo != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; reqInfo.getUserPrincipal() != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) 
       usr = reqInfo.getUserPrincipal().getName()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17017713" author="caomanhdat" created="Fri, 17 Jan 2020 04:57:11 +0000"  >&lt;p&gt;I attached a draft patch for fixing the problem, the idea are&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Setting isSolrThread inside &lt;tt&gt;DefaultSolrThreadFactory&lt;/tt&gt;. That class is belonging to solr-core so it will always created by a node&lt;/li&gt;
	&lt;li&gt;if isSolrThread == true, set usr = &quot;$&quot;  even incase of principal == null&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17017714" author="caomanhdat" created="Fri, 17 Jan 2020 04:59:57 +0000"  >&lt;p&gt;Hmm, It seems that a better approach will be let&apos;s the test explicitly let the test set its thread as &lt;tt&gt;isSolrTestThread&lt;/tt&gt;. &lt;/p&gt;</comment>
                            <comment id="17017840" author="caomanhdat" created="Fri, 17 Jan 2020 09:34:07 +0000"  >&lt;p&gt;After having a chat with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;, we kinda think that the Hoss&apos;s initial approach is more valid than mine because&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;it makes less significant change to the code base.&lt;/li&gt;
	&lt;li&gt;even &lt;tt&gt;DefaultSolrThreadFactory&lt;/tt&gt; belongs to solr-core, we can&apos;t enforce tests to not using that.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17018213" author="hossman" created="Fri, 17 Jan 2020 17:49:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=caomanhdat&quot; class=&quot;user-hover&quot; rel=&quot;caomanhdat&quot;&gt;caomanhdat&lt;/a&gt; - i can&apos;t find your patch, did you already delete it? (or forget to add it)&lt;/p&gt;

&lt;p&gt;I think what&apos; you were saying...&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;if isSolrThread == true, set usr = &quot;$&quot; even incase of principal == null&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;...is pretty similar to what i had hypothosized...&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;My initial reaction was to &quot;swap&quot; the order of the Principle/isSolrThread() checks...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;...but i still have the same concerns...&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;...that seems risky (especially since AFAICT, every SolrClient used for distributed Solr requests will return &quot;true&quot; for isSolrThread() &#8211; meaning PKI would probably completely stop forwarding credentials if we did that?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;To put it another way:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Assume &lt;tt&gt;blockUnknown=false&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;So unauthenticated request that gets accepted by the AuthenticationPlugin will have a null Principal.&lt;/li&gt;
	&lt;li&gt;as things stand right now, if that &quot;principal==null&quot; request gets forwarded to a distributed node, it will &lt;em&gt;never&lt;/em&gt; have a PKI header added&lt;/li&gt;
	&lt;li&gt;With your proposed change, if it does get forwarded &lt;em&gt;by another thread&lt;/em&gt; such as ConcurrentUpdateSolrClient (where &lt;tt&gt;isSolrThread == true&lt;/tt&gt;) then a PKI header will be added initiating it is a &quot;principal == &apos;$&apos; (Super User)&quot; request
	&lt;ul&gt;
		&lt;li&gt;ie: anonymous requests will be &quot;promoted&quot; to being super user requests on the distributed nodes&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;i have no idea what practical problems that may cause, but it certainly sounds bad.&lt;/p&gt;
&lt;hr /&gt;
&lt;blockquote&gt;&lt;p&gt;...think that the Hoss&apos;s initial approach is more valid than mine because&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;it makes less significant change to the code base.&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;Yeah, it seems like there are a lot of weird edge cases of the way PKI for &quot;background server threads&quot; works that really needs to be discussed/re-considered &amp;#8211; particularly since even forwarding updates from leader to replicas happens in a background thread (inside of the update client) ... but that should probably happen in a new jira with wider discussion &amp;amp; visibility.&lt;/p&gt;

&lt;p&gt;My patch seems like the minimum amount of change needed to fix the current bug, so unless someone sees a security problem&#160; with it (that doesn&apos;t already exist) i would suggest we move forward using my patch and re-consider the overall &quot;isSolrThread&quot; concept in a new jira?&lt;/p&gt;</comment>
                            <comment id="17018247" author="hossman" created="Fri, 17 Jan 2020 19:08:19 +0000"  >&lt;p&gt;Attaching a slightly updated patch with  javadoc additions that makes it clear the new &lt;tt&gt;setUserPrincipalName()&lt;/tt&gt; method in LocalSolrQueryRequest is experimental and subject ot change in case we want to remove if if/when more comprehensive changes are made to PKI/isSolrThread.&lt;/p&gt;</comment>
                            <comment id="17018407" author="lucenesolrqa" created="Fri, 17 Jan 2020 23:40:44 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;b&gt;&lt;font color=&quot;green&quot;&gt;+1 overall&lt;/font&gt;&lt;/b&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Vote &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Subsystem &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Runtime &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Comment &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; Prechecks &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; test4tests &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  0m  0s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; The patch appears to include 1 new or modified test files. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; master Compile Tests &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; compile &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m  4s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; master passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; Patch Compile Tests &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; compile &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m 45s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; javac &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m 45s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Release audit (RAT) &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m 45s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Check forbidden APIs &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m 45s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Validate source patterns &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m 45s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; Other Tests &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; unit &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; 63m  0s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; core in the patch passed. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt;&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt; &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt; 68m  1s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt; &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Subsystem &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Report/Notes &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; JIRA Issue &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12859&quot; title=&quot;DocExpirationUpdateProcessorFactory does not work with BasicAuth (and other auth plugins that use PKI)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12859&quot;&gt;&lt;del&gt;SOLR-12859&lt;/del&gt;&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; JIRA Patch URL &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12991247/SOLR-12859.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12991247/SOLR-12859.patch&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Optional Tests &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  compile  javac  unit  ratsources  checkforbiddenapis  validatesourcepatterns  &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; uname &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Linux lucene2-us-west.apache.org 4.4.0-170-generic #199-Ubuntu SMP Thu Nov 14 01:45:04 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Build tool &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ant &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Personality &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; /home/jenkins/jenkins-slave/workspace/PreCommit-SOLR-Build/sourcedir/dev-tools/test-patch/lucene-solr-yetus-personality.sh &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; git revision &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; master / aad849b &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ant &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; version: Apache Ant(TM) version 1.9.6 compiled on July 20 2018 &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Default Java &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; LTS &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  Test Results &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/job/PreCommit-SOLR-Build/653/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-SOLR-Build/653/testReport/&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; modules &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; C: solr/core U: solr/core &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Console output &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/job/PreCommit-SOLR-Build/653/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-SOLR-Build/653/console&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Powered by &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Apache Yetus 0.7.0   &lt;a href=&quot;http://yetus.apache.org&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://yetus.apache.org&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;



&lt;p&gt;This message was automatically generated.&lt;/p&gt;
</comment>
                            <comment id="17020703" author="caomanhdat" created="Wed, 22 Jan 2020 01:21:51 +0000"  >&lt;blockquote&gt;
&lt;p&gt;i have no idea what practical problems that may cause, but it certainly sounds bad.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;True true, very thought through as usual.&lt;/p&gt;</comment>
                            <comment id="17021299" author="jira-bot" created="Wed, 22 Jan 2020 17:22:41 +0000"  >&lt;p&gt;Commit 95dfddc7d4eaaa5997ccd69797dbe1fd966f32ac in lucene-solr&apos;s branch refs/heads/master from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=95dfddc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=95dfddc&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12859&quot; title=&quot;DocExpirationUpdateProcessorFactory does not work with BasicAuth (and other auth plugins that use PKI)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12859&quot;&gt;&lt;del&gt;SOLR-12859&lt;/del&gt;&lt;/a&gt;: Fixed DocExpirationUpdateProcessorFactory to work with BasicAuth and other auth plugins that delegate to PKI for server initiated node-to-node communication.&lt;/p&gt;</comment>
                            <comment id="17021309" author="jira-bot" created="Wed, 22 Jan 2020 17:34:19 +0000"  >&lt;p&gt;Commit 475b8cafc5265173cb100e84c895e7946ade902a in lucene-solr&apos;s branch refs/heads/branch_8x from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=475b8ca&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=475b8ca&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12859&quot; title=&quot;DocExpirationUpdateProcessorFactory does not work with BasicAuth (and other auth plugins that use PKI)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12859&quot;&gt;&lt;del&gt;SOLR-12859&lt;/del&gt;&lt;/a&gt;: Fixed DocExpirationUpdateProcessorFactory to work with BasicAuth and other auth plugins that delegate to PKI for server initiated node-to-node communication.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 95dfddc7d4eaaa5997ccd69797dbe1fd966f32ac)&lt;/p&gt;</comment>
                            <comment id="17021325" author="hossman" created="Wed, 22 Jan 2020 17:58:58 +0000"  >&lt;p&gt;Committed &amp;amp; backported.&lt;/p&gt;

&lt;p&gt;resolving this specific bug and linking to &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14204&quot; title=&quot;Rethink PKIs hueristic for dealing with &amp;#39;isSolrThread()&amp;#39;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14204&quot;&gt;SOLR-14204&lt;/a&gt; for future discussion on improving how PKI works and deals with this type of problem&lt;/p&gt;</comment>
                            <comment id="17065709" author="romseygeek" created="Tue, 24 Mar 2020 12:46:25 +0000"  >&lt;p&gt;Bulk close for 8.5.0 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13281030">SOLR-14204</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13191321">SOLR-12860</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12991247" name="SOLR-12859.patch" size="25063" author="hossman" created="Fri, 17 Jan 2020 19:06:47 +0000"/>
                            <attachment id="12991050" name="SOLR-12859.patch" size="24689" author="hossman" created="Thu, 16 Jan 2020 00:07:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 34 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3z5gv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>