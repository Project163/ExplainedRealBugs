<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:05:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-16955] Tracing v2 apis breaks SecurityConfHandler</title>
                <link>https://issues.apache.org/jira/browse/SOLR-16955</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Tracing for v2 apis will eagerly consume the contentstream to find a good name for the span. the assumption here is that the operations are cached so the stream ca be consumed early, but that is not the case for the SecurityConfHandler and possibly other parts of the code.&lt;/p&gt;

&lt;p&gt;With tracing enabled you cannot add a user, a role, etc. Admin UI Security is broken too.&lt;/p&gt;

&lt;p&gt;The clash is between&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;V2HttpCall&#160;&lt;a href=&quot;https://github.com/apache/solr/blob/9a453854a56125fef6740ce8e4a1f69fb444eabe/solr/core/src/java/org/apache/solr/api/V2HttpCall.java#L513&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;solrReq.getCommands&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;SecurityConfHandler &lt;a href=&quot;https://github.com/apache/solr/blob/9a453854a56125fef6740ce8e4a1f69fb444eabe/solr/core/src/java/org/apache/solr/handler/admin/SecurityConfHandler.java#L115&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CommandOperation.readCommands(req.getContentStreams()..)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;relevant stacktrace&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2023-08-29 19:13:57.591 INFO  (qtp605101809-21) [t:750564258779a1605867f784ee33f78a] o.a.s.s.HttpSolrCall [admin] webapp=null path=/cluster/security/authorization params={wt=json&amp;amp;_=1693361587976} status=0 QTime=0
2023-08-29 19:13:57.613 ERROR (qtp605101809-27) [t:b3ab14d057a292fb71ac727c5d871156] o.a.s.h.RequestHandlerBase Server exception =&amp;gt; java.lang.RuntimeException: The JSON must be an Object of the form {&quot;command&quot;: {...},...
	at org.apache.solr.common.util.CommandOperation.parse(CommandOperation.java:275)
java.lang.RuntimeException: The JSON must be an Object of the form {&quot;command&quot;: {...},...
	at org.apache.solr.common.util.CommandOperation.parse(CommandOperation.java:275) ~[?:?]
	at org.apache.solr.common.util.CommandOperation.readCommands(CommandOperation.java:354) ~[?:?]
	at org.apache.solr.common.util.CommandOperation.readCommands(CommandOperation.java:327) ~[?:?]
	at org.apache.solr.handler.admin.SecurityConfHandler.doEdit(SecurityConfHandler.java:116) ~[?:?]
	at org.apache.solr.handler.admin.SecurityConfHandler.handleRequestBody(SecurityConfHandler.java:89) ~[?:?]
	at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:224) ~[?:?]
	at org.apache.solr.api.ApiBag$ReqHandlerToApi.call(ApiBag.java:362) ~[?:?]
	at org.apache.solr.api.V2HttpCall.handleAdmin(V2HttpCall.java:438) ~[?:?]
	at org.apache.solr.servlet.HttpSolrCall.handleAdminRequest(HttpSolrCall.java:870) ~[?:?]
	at org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:539) ~[?:?]
	at org.apache.solr.servlet.SolrDispatchFilter.dispatch(SolrDispatchFilter.java:248) ~[?:?]
	at org.apache.solr.servlet.SolrDispatchFilter.lambda$doFilter$0(SolrDispatchFilter.java:215) ~[?:?]
	at org.apache.solr.servlet.ServletUtils.traceHttpRequestExecution2(ServletUtils.java:241) ~[?:?]
	at org.apache.solr.servlet.ServletUtils.rateLimitRequest(ServletUtils.java:211) ~[?:?]
	at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:209) ~[?:?]
	at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:192) ~[?:?]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I ran into this a few times and could not pinpoint it until now. the reason this does not trigger on the alway-on tracer is that this is hidden behind a &apos;TraceUtils.ifNotNoop&apos; check.&lt;/p&gt;

&lt;p&gt;Also, I think this might be a problem on 9.x too, not completely sure yet.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="13549080">SOLR-16955</key>
            <summary>Tracing v2 apis breaks SecurityConfHandler</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stillalex">Alex Deparvu</assignee>
                                    <reporter username="stillalex">Alex Deparvu</reporter>
                        <labels>
                    </labels>
                <created>Wed, 30 Aug 2023 02:18:40 +0000</created>
                <updated>Sun, 15 Oct 2023 20:13:52 +0000</updated>
                            <resolved>Wed, 6 Sep 2023 23:13:07 +0000</resolved>
                                                    <fixVersion>9.4</fixVersion>
                                    <component>tracing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17760356" author="janhoy" created="Wed, 30 Aug 2023 12:19:22 +0000"  >&lt;p&gt;This should probably be a blocker for 9.4 ?&lt;/p&gt;</comment>
                            <comment id="17760524" author="alex.parvulescu" created="Wed, 30 Aug 2023 16:36:00 +0000"  >&lt;p&gt;you are right Jan. I wanted to validate this a bit more before jumping on the blocker, but I didn&apos;t have the time yet. will mark as blocker.&lt;/p&gt;</comment>
                            <comment id="17761352" author="alex.parvulescu" created="Fri, 1 Sep 2023 16:59:58 +0000"  >&lt;p&gt;Adding more details: the span name for v2 apis has the following format: &apos;path:verb&apos;.&lt;br/&gt;
For the `verb` part, the method is consuming the stream to read commands as an attempt pick a better value than the request method.&lt;/p&gt;

&lt;p&gt;For the failing test (BasicAuthIntegrationTest.testBasicAuth)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the command is `{&quot;set-user&quot;:{&quot;harry&quot;:&quot;HarryIsUberCool&quot;}}`&lt;/li&gt;
	&lt;li&gt;the result being a span named `set-user:/cluster/security/authentication`.&lt;/li&gt;
	&lt;li&gt;the non glamorous alternative would be a simple `post:/cluster/security/authentication`&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I find the approach to read the stream too risky and invasive. there is no guarantee the entire current and future code base will respect the pattern and call `solrReq.getCommands(validateInput)` instead of just simply reading the stream directly. this is why I am hesitant to fix the SecurityConfHandler and I would opt for removing the stream reading on the tracing side. spans can have a simpler name, and if we want to augment the metadata we can do so form inside the SecurityConfHandler (for example we can set an attribute &apos;op&apos; to &apos;set-user&apos; when it is safe to do so).&lt;br/&gt;
My proposal is to remove the code inside V2HttpCall, and if strictly needed I can add an extra attribute for the operation.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=janhoy&quot; class=&quot;user-hover&quot; rel=&quot;janhoy&quot;&gt;janhoy&lt;/a&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt; please let me know your thoughts.&lt;/p&gt;</comment>
                            <comment id="17761368" author="alex.parvulescu" created="Fri, 1 Sep 2023 18:20:43 +0000"  >&lt;p&gt;posted a PR for review &lt;a href=&quot;https://github.com/apache/solr/pull/1884&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/solr/pull/1884&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17761370" author="dsmiley" created="Fri, 1 Sep 2023 18:22:34 +0000"  >&lt;p&gt;I agree; consuming the stream is risky. &#160;Your proposal is fine, even if you don&apos;t get around to adding an attribute for the operation.&lt;/p&gt;

&lt;p&gt;Looking at this bug, I suppose we should have some randomization in play so that we have an active Tracer (that isn&apos;t &quot;Noop&quot;) engaged sometimes, and then this would have been caught originally. &#160;This is in spirit similar to our randomization to sometimes not running tests with assertions enabled. &#160;If this sounds good, I&apos;ll create an issue for this idea, maybe leveraging a variant of the &quot;SimplePropagator&quot; that isn&apos;t no-op.&lt;/p&gt;</comment>
                            <comment id="17761490" author="alex.parvulescu" created="Sat, 2 Sep 2023 17:49:06 +0000"  >&lt;blockquote&gt;&lt;p&gt;Looking at this bug, I suppose we should have some randomization in play so that we have an active Tracer (that isn&apos;t &quot;Noop&quot;) engaged sometimes, and then this would have been caught originally.  This is in spirit similar to our randomization to sometimes not running tests with assertions enabled.  If this sounds good, I&apos;ll create an issue for this idea, maybe leveraging a variant of the &quot;SimplePropagator&quot; that isn&apos;t no-op.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I really like the idea, good stuff. we should definitely set this up.&lt;/p&gt;</comment>
                            <comment id="17762507" author="jira-bot" created="Wed, 6 Sep 2023 22:18:10 +0000"  >&lt;p&gt;Commit bc7c8190de0d91fcbef835018aa183f1d8f250ca in solr&apos;s branch refs/heads/main from Alex Deparvu&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=bc7c8190de0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=bc7c8190de0&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16955&quot; title=&quot;Tracing v2 apis breaks SecurityConfHandler&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16955&quot;&gt;&lt;del&gt;SOLR-16955&lt;/del&gt;&lt;/a&gt; Tracing v2 apis breaks SecurityConfHandler (#1884)&lt;/p&gt;
</comment>
                            <comment id="17762514" author="jira-bot" created="Wed, 6 Sep 2023 23:08:45 +0000"  >&lt;p&gt;Commit 4bb2ed39447499ba14b767c5a8066f381f36f96d in solr&apos;s branch refs/heads/branch_9x from Alex Deparvu&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=4bb2ed39447&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=4bb2ed39447&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16955&quot; title=&quot;Tracing v2 apis breaks SecurityConfHandler&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16955&quot;&gt;&lt;del&gt;SOLR-16955&lt;/del&gt;&lt;/a&gt; Tracing v2 apis breaks SecurityConfHandler (#1884)&lt;/p&gt;</comment>
                            <comment id="17762515" author="alex.parvulescu" created="Wed, 6 Sep 2023 23:13:07 +0000"  >&lt;p&gt;fixed on main and I did a best effort backport to 9.x. &lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;edit&amp;#93;&lt;/span&gt; I rewrote the test and added it to 9.x branch. it didn&apos;t feel right to leave it out.&lt;/p&gt;</comment>
                            <comment id="17762561" author="jira-bot" created="Thu, 7 Sep 2023 04:03:31 +0000"  >&lt;p&gt;Commit 84a411a28ac993825a7d2a04adca297a47840af1 in solr&apos;s branch refs/heads/branch_9x from Alex Deparvu&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=84a411a28ac&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=84a411a28ac&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16955&quot; title=&quot;Tracing v2 apis breaks SecurityConfHandler&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16955&quot;&gt;&lt;del&gt;SOLR-16955&lt;/del&gt;&lt;/a&gt; Tracing v2 apis breaks SecurityConfHandler&lt;/p&gt;</comment>
                            <comment id="17775489" author="alex.parvulescu" created="Sun, 15 Oct 2023 19:57:09 +0000"  >&lt;p&gt;Closing after the 9.4.0 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 4 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1k32w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>