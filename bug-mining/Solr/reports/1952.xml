<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:52:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-6095] SolrCloud cluster can end up without an overseer with overseer roles </title>
                <link>https://issues.apache.org/jira/browse/SOLR-6095</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;We have a large cluster running on ec2 which occasionally ends up without an overseer after a rolling restart. We always restart our overseer nodes at the very last otherwise we end up with a large number of shards that can&apos;t recover properly.&lt;/p&gt;

&lt;p&gt;This cluster is running a custom branch forked from 4.8 and has &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5473&quot; title=&quot;Split clusterstate.json per collection and watch states selectively &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5473&quot;&gt;&lt;del&gt;SOLR-5473&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5495&quot; title=&quot;Recovery strategy for leader partitioned from replica case.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5495&quot;&gt;&lt;del&gt;SOLR-5495&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5468&quot; title=&quot;Option to notify client when desired replication factor not achieved for an update request.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5468&quot;&gt;&lt;del&gt;SOLR-5468&lt;/del&gt;&lt;/a&gt; applied. We have a large number of small collections (120 collections each with approx 5M docs) on 16 Solr nodes. We are also using the overseer roles feature to designate two specified nodes as overseers. However, I think the problem that we&apos;re seeing is not specific to the overseer roles feature.&lt;/p&gt;

&lt;p&gt;As soon as the overseer was shutdown, we saw the following on the node which was next in line to become the overseer:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2014-05-20 09:55:39,261 [main-EventThread] INFO  solr.cloud.ElectionContext  - I am going to be the leader ec2-xxxxxxxxxx.compute-1.amazonaws.com:8987_solr
2014-05-20 09:55:39,265 [main-EventThread] WARN  solr.cloud.LeaderElector  - 
org.apache.zookeeper.KeeperException$NodeExistsException: KeeperErrorCode = NodeExists &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /overseer_elect/leader
	at org.apache.zookeeper.KeeperException.create(KeeperException.java:119)
	at org.apache.zookeeper.KeeperException.create(KeeperException.java:51)
	at org.apache.zookeeper.ZooKeeper.create(ZooKeeper.java:783)
	at org.apache.solr.common.cloud.SolrZkClient$10.execute(SolrZkClient.java:432)
	at org.apache.solr.common.cloud.ZkCmdExecutor.retryOperation(ZkCmdExecutor.java:73)
	at org.apache.solr.common.cloud.SolrZkClient.makePath(SolrZkClient.java:429)
	at org.apache.solr.common.cloud.SolrZkClient.makePath(SolrZkClient.java:386)
	at org.apache.solr.common.cloud.SolrZkClient.makePath(SolrZkClient.java:373)
	at org.apache.solr.cloud.OverseerElectionContext.runLeaderProcess(ElectionContext.java:551)
	at org.apache.solr.cloud.LeaderElector.runIamLeaderProcess(LeaderElector.java:142)
	at org.apache.solr.cloud.LeaderElector.checkIfIamLeader(LeaderElector.java:110)
	at org.apache.solr.cloud.LeaderElector.access$200(LeaderElector.java:55)
	at org.apache.solr.cloud.LeaderElector$ElectionWatcher.process(LeaderElector.java:303)
	at org.apache.zookeeper.ClientCnxn$EventThread.processEvent(ClientCnxn.java:522)
	at org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:498)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When the overseer leader node is gracefully shutdown, we get the following in the logs:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2014-05-20 09:55:39,254 [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-63] ERROR solr.cloud.Overseer  - Exception in Overseer main queue loop
org.apache.solr.common.SolrException: Could not load collection from ZK:sm12
	at org.apache.solr.common.cloud.ZkStateReader.getExternCollectionFresh(ZkStateReader.java:778)
	at org.apache.solr.common.cloud.ZkStateReader.updateClusterState(ZkStateReader.java:553)
	at org.apache.solr.common.cloud.ZkStateReader.updateClusterState(ZkStateReader.java:246)
	at org.apache.solr.cloud.Overseer$ClusterStateUpdater.run(Overseer.java:237)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
Caused by: java.lang.InterruptedException
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.java:503)
	at org.apache.zookeeper.ClientCnxn.submitRequest(ClientCnxn.java:1342)
	at org.apache.zookeeper.ZooKeeper.exists(ZooKeeper.java:1040)
	at org.apache.solr.common.cloud.SolrZkClient$4.execute(SolrZkClient.java:226)
	at org.apache.solr.common.cloud.SolrZkClient$4.execute(SolrZkClient.java:223)
	at org.apache.solr.common.cloud.ZkCmdExecutor.retryOperation(ZkCmdExecutor.java:73)
	at org.apache.solr.common.cloud.SolrZkClient.exists(SolrZkClient.java:223)
	at org.apache.solr.common.cloud.ZkStateReader.getExternCollectionFresh(ZkStateReader.java:767)
	... 4 more
2014-05-20 09:55:39,254 [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-63] INFO  solr.cloud.Overseer  - Overseer Loop exiting : ec2-xxxxxxxxxx.compute-1.amazonaws.com:8986_solr
2014-05-20 09:55:39,256 [main-EventThread] WARN  common.cloud.ZkStateReader  - ZooKeeper watch triggered, but Solr cannot talk to ZK
2014-05-20 09:55:39,259 [ShutdownMonitor] INFO  server.handler.ContextHandler  - stopped o.e.j.w.WebAppContext{/solr,file:/vol0/cloud86/solr-webapp/webapp/},/vol0/cloud86/webapps/solr.war
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Notice how the overseer kept on running almost till the last point i.e. until the jetty context stopped. On some runs, we got the following on the overseer leader node on graceful shutdown:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2014-05-19 21:33:43,657 [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-75] ERROR solr.cloud.Overseer  - Exception in Overseer main queue loop
org.apache.solr.common.SolrException: Could not load collection from ZK:sm71
	at org.apache.solr.common.cloud.ZkStateReader.getExternCollectionFresh(ZkStateReader.java:778)
	at org.apache.solr.common.cloud.ZkStateReader.updateClusterState(ZkStateReader.java:553)
	at org.apache.solr.common.cloud.ZkStateReader.updateClusterState(ZkStateReader.java:246)
	at org.apache.solr.cloud.Overseer$ClusterStateUpdater.run(Overseer.java:237)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
Caused by: java.lang.InterruptedException
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.java:503)
	at org.apache.zookeeper.ClientCnxn.submitRequest(ClientCnxn.java:1342)
	at org.apache.zookeeper.ZooKeeper.getData(ZooKeeper.java:1153)
	at org.apache.solr.common.cloud.SolrZkClient$7.execute(SolrZkClient.java:277)
	at org.apache.solr.common.cloud.SolrZkClient$7.execute(SolrZkClient.java:274)
	at org.apache.solr.common.cloud.ZkCmdExecutor.retryOperation(ZkCmdExecutor.java:73)
	at org.apache.solr.common.cloud.SolrZkClient.getData(SolrZkClient.java:274)
	at org.apache.solr.common.cloud.ZkStateReader.getExternCollectionFresh(ZkStateReader.java:769)
	... 4 more
2014-05-19 21:33:43,662 [main-EventThread] WARN  common.cloud.ZkStateReader  - ZooKeeper watch triggered, but Solr cannot talk to ZK
2014-05-19 21:33:43,663 [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-75] INFO  solr.cloud.Overseer  - Overseer Loop exiting : ec2-xxxxxxxxxxxx.compute-1.amazonaws.com:8987_solr
2014-05-19 21:33:43,664 [OverseerExitThread] ERROR solr.cloud.Overseer  - could not read the data
org.apache.zookeeper.KeeperException$SessionExpiredException: KeeperErrorCode = Session expired &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /overseer_elect/leader
	at org.apache.zookeeper.KeeperException.create(KeeperException.java:127)
	at org.apache.zookeeper.KeeperException.create(KeeperException.java:51)
	at org.apache.zookeeper.ZooKeeper.getData(ZooKeeper.java:1155)
	at org.apache.solr.common.cloud.SolrZkClient$7.execute(SolrZkClient.java:277)
	at org.apache.solr.common.cloud.SolrZkClient$7.execute(SolrZkClient.java:274)
	at org.apache.solr.common.cloud.ZkCmdExecutor.retryOperation(ZkCmdExecutor.java:73)
	at org.apache.solr.common.cloud.SolrZkClient.getData(SolrZkClient.java:274)
	at org.apache.solr.cloud.Overseer$ClusterStateUpdater.checkIfIamStillLeader(Overseer.java:329)
	at org.apache.solr.cloud.Overseer$ClusterStateUpdater.access$300(Overseer.java:85)
	at org.apache.solr.cloud.Overseer$ClusterStateUpdater$1.run(Overseer.java:293)
2014-05-19 21:33:43,665 [ShutdownMonitor] INFO  server.handler.ContextHandler  - stopped o.e.j.w.WebAppContext{/solr,file:/vol0/cloud87/solr-webapp/webapp/},/vol0/cloud87/webapps/solr.war
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Again the overseer was clinging on till the last moment and by the time it exited the ZK session expired and it couldn&apos;t delete the /overseer_elect/leader node. The exception on the next-in-line node was the same i.e. NodeExists for /overseer_elect/leader.&lt;/p&gt;

&lt;p&gt;In both cases, we are left with no overseers after restart. I can easily reproduce this problem by just restarting overseer leader nodes repeatedly.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12715403">SOLR-6095</key>
            <summary>SolrCloud cluster can end up without an overseer with overseer roles </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="noble.paul">Noble Paul</assignee>
                                    <reporter username="shalin">Shalin Shekhar Mangar</reporter>
                        <labels>
                    </labels>
                <created>Tue, 20 May 2014 10:12:18 +0000</created>
                <updated>Mon, 9 May 2016 18:48:23 +0000</updated>
                            <resolved>Wed, 18 Jun 2014 09:42:54 +0000</resolved>
                                    <version>4.8</version>
                                    <fixVersion>4.10</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="14003046" author="shalinmangar" created="Tue, 20 May 2014 10:21:02 +0000"  >&lt;p&gt;I also opened &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6091&quot; title=&quot;Race condition in prioritizeOverseerNodes can trigger extra QUIT operations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6091&quot;&gt;&lt;del&gt;SOLR-6091&lt;/del&gt;&lt;/a&gt; but that didn&apos;t help.&lt;/p&gt;</comment>
                            <comment id="14003585" author="shalinmangar" created="Tue, 20 May 2014 16:26:54 +0000"  >&lt;p&gt;The problem that I could find is in LeaderElector.checkIfIamLeader where we have the following code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (seq &amp;lt;= intSeqs.get(0)) {
      &lt;span class=&quot;code-comment&quot;&gt;// first we delete the node advertising the old leader in &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; the ephem is still there
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        zkClient.delete(context.leaderPath, -1, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt;(Exception e) {
        &lt;span class=&quot;code-comment&quot;&gt;// fine
&lt;/span&gt;      }

      runIamLeaderProcess(context, replacement);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If for whatever reason, the zkClient.delete was unsuccessful, we just ignore and go ahead to runIamLeaderProcess(...) which leads to OverseerElectionContext.runLeaderProcess(...) where it tries to create the /overseer_elect/leader node:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;zkClient.makePath(leaderPath, ZkStateReader.toJSON(myProps),
        CreateMode.EPHEMERAL, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This is where things go wrong. Because the /overseer_elect/leader node already existed, the zkClient.makePath fails and the node decides to give up because it think that there is already a leader. It never tries to rejoin election ever. Then once the ephemeral /overseer_elect/leader node goes away (after the previous overseer leader exits), the cluster is left with no leader.&lt;/p&gt;

&lt;p&gt;Shouldn&apos;t the node next in line to become a leader try again or rejoin the election instead of giving up?&lt;/p&gt;</comment>
                            <comment id="14012802" author="markrmiller@gmail.com" created="Thu, 29 May 2014 20:02:22 +0000"  >&lt;blockquote&gt;&lt;p&gt;We always restart our overseer nodes at the very last otherwise we end up with a large number of shards that can&apos;t recover properly.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Do you know if there is a JIRA issue for that?&lt;/p&gt;</comment>
                            <comment id="14013306" author="shalinmangar" created="Fri, 30 May 2014 05:13:07 +0000"  >&lt;p&gt;No, I don&apos;t think there&apos;s a jira for it. The reason that we could find was that if for some reason the rolling restart sequence matches with the overseer election sequence then the overseer keep shifting with each bounce and are unable to process events. This is kinda okay in small clusters but in large clusters, by the time the rolling restarts complete, some nodes reach &quot;recovery_failed&quot; state and won&apos;t try to come back up again.&lt;/p&gt;

&lt;p&gt;Once we changed our restart sequence to restart the overseer node at the very last, we did not encounter this problem any more.&lt;/p&gt;</comment>
                            <comment id="14014137" author="andyetitmoves" created="Fri, 30 May 2014 19:30:50 +0000"  >&lt;p&gt;Not sure I understand. You bring down first wave, overseers move to second wave. When you bring back first wave, they use the overseer in the second wave to recover and become active. Then you start with the second wave. Why would this be a problem?&lt;/p&gt;</comment>
                            <comment id="14014535" author="shalinmangar" created="Sat, 31 May 2014 06:07:52 +0000"  >&lt;p&gt;Except we don&apos;t do our rolling restarts like that. Our restart scripts iterates through hosts looked up using EC2 APIs (and it almost always returns the node names in the same order) and restarts them one by one and after each restart, waits for 60 seconds, verifies that node is up and continues with the next host.&lt;/p&gt;

&lt;p&gt;Since the script originally created the nodes too in the same order, the election nodes are also approximately in the same order. This causes each host restart to displace the overseer to the next host in line which is again displaced and so on.&lt;/p&gt;</comment>
                            <comment id="14014780" author="andyetitmoves" created="Sat, 31 May 2014 19:49:30 +0000"  >&lt;p&gt;That would explain it, our start script blocks until all cores are active, hence we don&apos;t have this issue..&lt;/p&gt;</comment>
                            <comment id="14021135" author="shalinmangar" created="Sun, 8 Jun 2014 07:24:10 +0000"  >&lt;p&gt;Here&apos;s a testcase which fails with these same issue. Finally after discarding many iterations I managed to create this test. This test sets up 16 shards (2x8) and adds overseer roles to three nodes and then in a loop restarts just the overseers over and over again. It fails usually after the a couple of restarts.&lt;/p&gt;</comment>
                            <comment id="14032386" author="noble.paul" created="Mon, 16 Jun 2014 12:32:11 +0000"  >&lt;p&gt;I have tweaked the roles feature a bit as follows&lt;/p&gt;

&lt;p&gt;The new approach &lt;/p&gt;

&lt;p&gt;If the current order is (everyone who is below is listening to the one right above)&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;nodeA-0 &amp;lt;leader&amp;gt;&lt;/li&gt;
	&lt;li&gt;nodeB-1&lt;/li&gt;
	&lt;li&gt;nodeC-2&lt;/li&gt;
	&lt;li&gt;nodeD-3&lt;/li&gt;
	&lt;li&gt;nodeE-4&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;And addrole asks &lt;b&gt;nodeD&lt;/b&gt; to become overseer&lt;/p&gt;


&lt;p&gt;According to the new approach , a command is sent to nodeD to rejoin election at head, so the new Q becomes &lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;nodeA-0 &amp;lt;leader&amp;gt;&lt;/li&gt;
	&lt;li&gt;nodeB-1  nodeD-1&lt;/li&gt;
	&lt;li&gt;nodeC-2&lt;/li&gt;
	&lt;li&gt;nodeE-4&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Now, both nodeB and nodeD are waiting on &lt;b&gt;nodeA&lt;/b&gt; to become the leader&lt;/p&gt;

&lt;p&gt;The next step is to send a rejoin (not at head) command to &lt;b&gt;nodeB&lt;/b&gt; . So the new order automatically is as follows where nodeD is the next node in line to become the leader. &lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;nodeA-0 &amp;lt;leader&amp;gt;&lt;/li&gt;
	&lt;li&gt;nodeD-1&lt;/li&gt;
	&lt;li&gt;nodeC-2&lt;/li&gt;
	&lt;li&gt;nodeE-4&lt;/li&gt;
	&lt;li&gt;nodeB-5&lt;/li&gt;
&lt;/ol&gt;



&lt;p&gt;The next step is to send a quit command to nodeA (current leader) . So the new order becomes&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;nodeD-1 &amp;lt;leader&amp;gt;&lt;/li&gt;
	&lt;li&gt;nodeC-2&lt;/li&gt;
	&lt;li&gt;nodeE-4&lt;/li&gt;
	&lt;li&gt;nodeB-5&lt;/li&gt;
	&lt;li&gt;nodeA-6&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;So we have promoted &lt;b&gt;nodeD&lt;/b&gt; to leader with just 3 operations . The advantage is that , irrespective of the no:of nodes in the queue , the no:of operations is still the same 3 , So it does not matter if it is a big cluster or small. The good thing is there will never be a loss of overseer , even if the designate does not become the leader (because of errors happening in the prioritizeOverseerNodes)&lt;/p&gt;
</comment>
                            <comment id="14032387" author="noble.paul" created="Mon, 16 Jun 2014 12:33:35 +0000"  >&lt;p&gt;This has the new stress test and the new approach. I plan to commit this soon&lt;/p&gt;</comment>
                            <comment id="14032616" author="mewmewball" created="Mon, 16 Jun 2014 16:34:51 +0000"  >&lt;p&gt;What if before step 2 nodeA dies. Is there a possibility that we&apos;d end up with two Overseers (nodeB and nodeD)? What&apos;s done to prevent this from happening?&lt;/p&gt;</comment>
                            <comment id="14032619" author="noble.paul" created="Mon, 16 Jun 2014 16:43:41 +0000"  >&lt;blockquote&gt;&lt;p&gt;Is there a possibility that we&apos;d end up with two Overseers (nodeB and nodeD)? &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No , only one can succeed. If nodeD succeeds it is great, &lt;br/&gt;
If it does not,  &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;nodeB will become Overseer&lt;/li&gt;
	&lt;li&gt;nodeD will rejoin at the back because the , &quot;leader&quot; node already exists (created by nodeB)&lt;/li&gt;
	&lt;li&gt;and nodeB will go through all the same steps as explained above&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14032659" author="mewmewball" created="Mon, 16 Jun 2014 17:24:15 +0000"  >&lt;blockquote&gt;
&lt;p&gt;nodeD will rejoin at the back because the , &quot;leader&quot; node already exists (created by nodeB)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;When does this happen? The classic zk leader election recipe would not have checked for the leader node. In LeaderElector.checkIfIAmLeader, the node with the smallest seqId deletes the leader node without looking at it before writing itself down as the leader. If the first node that wrote itself down as the leader already passed the amILeader() check in the Overseer loop before the second node overwrites it, it is then possible that the first node will be active for at least one loop iteration while the second node becomes the new leader. &lt;/p&gt;

&lt;p&gt;One of the fundamental assumption of the zk leader election recipe (&lt;a href=&quot;http://zookeeper.apache.org/doc/trunk/recipes.html#sc_leaderElection&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://zookeeper.apache.org/doc/trunk/recipes.html#sc_leaderElection&lt;/a&gt;), which I believe solr follows, is that seqId is handed out by zookeeper and is therefore unique. This change will violate that assumption, so my question is--what&apos;s built around the code in this change that makes it ok to violate that assumption?&lt;/p&gt;


&lt;blockquote&gt;
&lt;p&gt;and nodeB will go through all the same steps as explained above&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Even if say what you describe above worked, here nodeB gets re-prioritized down and then nodeC becomes the leader, we still don&apos;t have the right results. What happens then?&lt;/p&gt;</comment>
                            <comment id="14032760" author="noble.paul" created="Mon, 16 Jun 2014 18:42:55 +0000"  >&lt;p&gt;The classic recipe is tweaked a bit so that the churn of large no:of nodes are avoided in prioritizing another a node .In that case,  the node id is created by the client instead of asking zk to create one. The checkIfIamLeader is modified in this new patch to take care of 2 nodes with same sequence Id. &lt;/p&gt;</comment>
                            <comment id="14032807" author="mewmewball" created="Mon, 16 Jun 2014 19:15:13 +0000"  >&lt;p&gt;I see that your new patch is trying to fix the &quot;seq &amp;lt;= intSeqs.get(0)&quot; case in LeaderElector, but the fix doesn&apos;t quite work. Note that the delete statement is meant to delete the old leader&apos;s node in case it hasn&apos;t expired yet, which is a possible scenario. If the old leader&apos;s node indeed hasn&apos;t expired, both nodeB and nodeD will fail your new statement.&lt;/p&gt;</comment>
                            <comment id="14032814" author="mewmewball" created="Mon, 16 Jun 2014 19:26:07 +0000"  >&lt;p&gt;Sorry that wasn&apos;t true. You were comparing election path, not the leader node. However, this still possibly doesn&apos;t work because sortSeqs extracts just the sequence number (n_0000000001) out of the entire node string and sorts based on that, so in fact the sort order of nodeB and nodeD might not be deterministic in different JVM (calls to zk.getChildren does not guarantee return list ordering, so even though the Collections.sort is stable, the original list is not), which makes this new if statement also non-deterministic.&lt;/p&gt;</comment>
                            <comment id="14032836" author="noble.paul" created="Mon, 16 Jun 2014 19:44:54 +0000"  >&lt;p&gt;I haven&apos;t really gone into the implementation of the Arrays.sort() . But as long as the getChildren returns the nodes in the same order , the Arrays.sort() would give the same order right? (sort can be non-deterministic when the input is random right? )Because ZK does not sort based on the sequence number&lt;/p&gt;

&lt;p&gt;But again , this solution does not give 100% guarantee that nodeD would become the leader ,if the last step quit command is not executed . So, there is a very small possibility that the overseer is not a designate, but there will always be a leader. Only if the leader quits , because of an explicit rejoin coreadmin command, or if the node dies&lt;/p&gt;</comment>
                            <comment id="14032868" author="mewmewball" created="Mon, 16 Jun 2014 20:11:11 +0000"  >&lt;p&gt;The problem is I don&apos;t think getChildren is guaranteed to return nodes in the same order. Its javadoc states&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;The list of children returned is not sorted and no guarantee is provided as to its natural or lexical order.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If somehow getChildren doesn&apos;t return nodes in the same order (unless we can verify otherwise, and add this as a regression test against each zk upgrade since the API doesn&apos;t guarantee it), the sort can possibly get different ordering of nodeB and nodeD so that they both believe they&apos;re the top item in their own invocation, and we&apos;re back to the temporary two-Overseer case (for one loop iteration).&lt;/p&gt;</comment>
                            <comment id="14032923" author="mewmewball" created="Mon, 16 Jun 2014 20:48:17 +0000"  >&lt;p&gt;Just checked zookeeper&apos;s code. Its children is held by HashSet in DataNode, which means that if you hit different instances of zookeeper in the ensemble, you may get different results ordering back.&lt;/p&gt;</comment>
                            <comment id="14033424" author="noble.paul" created="Tue, 17 Jun 2014 04:31:17 +0000"  >&lt;p&gt;The sort is now going to be deterministic&lt;/p&gt;</comment>
                            <comment id="14033451" author="anshumg" created="Tue, 17 Jun 2014 05:32:29 +0000"  >&lt;p&gt;RollingRestartTest.regularRestartTest() is commented out. If it&#8217;s not required, you might want to remove it (or uncomment it and let it run).&lt;/p&gt;</comment>
                            <comment id="14033734" author="shalinmangar" created="Tue, 17 Jun 2014 12:34:08 +0000"  >&lt;blockquote&gt;&lt;p&gt;RollingRestartTest.regularRestartTest() is commented out. If it&#8217;s not required, you might want to remove it (or uncomment it and let it run).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, it is not required in its current form. We can remove it.&lt;/p&gt;</comment>
                            <comment id="14035515" author="jira-bot" created="Wed, 18 Jun 2014 09:39:38 +0000"  >&lt;p&gt;Commit 1603382 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1603382&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1603382&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6095&quot; title=&quot;SolrCloud cluster can end up without an overseer with overseer roles &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6095&quot;&gt;&lt;del&gt;SOLR-6095&lt;/del&gt;&lt;/a&gt; SolrCloud cluster can end up without an overseer with overseer roles&lt;/p&gt;</comment>
                            <comment id="14035520" author="jira-bot" created="Wed, 18 Jun 2014 09:42:19 +0000"  >&lt;p&gt;Commit 1603383 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt; in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1603383&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1603383&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6095&quot; title=&quot;SolrCloud cluster can end up without an overseer with overseer roles &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6095&quot;&gt;&lt;del&gt;SOLR-6095&lt;/del&gt;&lt;/a&gt; SolrCloud cluster can end up without an overseer with overseer roles&lt;/p&gt;</comment>
                            <comment id="14035785" author="jira-bot" created="Wed, 18 Jun 2014 14:46:39 +0000"  >&lt;p&gt;Commit 1603467 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1603467&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1603467&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6095&quot; title=&quot;SolrCloud cluster can end up without an overseer with overseer roles &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6095&quot;&gt;&lt;del&gt;SOLR-6095&lt;/del&gt;&lt;/a&gt; Uncaught Exception causing test failures&lt;/p&gt;</comment>
                            <comment id="14035787" author="jira-bot" created="Wed, 18 Jun 2014 14:48:12 +0000"  >&lt;p&gt;Commit 1603468 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt; in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1603468&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1603468&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6095&quot; title=&quot;SolrCloud cluster can end up without an overseer with overseer roles &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6095&quot;&gt;&lt;del&gt;SOLR-6095&lt;/del&gt;&lt;/a&gt; Uncaught Exception causing test failures&lt;/p&gt;</comment>
                            <comment id="14040728" author="jira-bot" created="Mon, 23 Jun 2014 13:13:50 +0000"  >&lt;p&gt;Commit 1604791 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1604791&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1604791&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6095&quot; title=&quot;SolrCloud cluster can end up without an overseer with overseer roles &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6095&quot;&gt;&lt;del&gt;SOLR-6095&lt;/del&gt;&lt;/a&gt; wait for http responses&lt;/p&gt;</comment>
                            <comment id="14040730" author="jira-bot" created="Mon, 23 Jun 2014 13:15:17 +0000"  >&lt;p&gt;Commit 1604792 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt; in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1604792&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1604792&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6095&quot; title=&quot;SolrCloud cluster can end up without an overseer with overseer roles &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6095&quot;&gt;&lt;del&gt;SOLR-6095&lt;/del&gt;&lt;/a&gt; wait for http responses&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                            <outwardlinks description="incorporates">
                                        <issuelink>
            <issuekey id="12715196">SOLR-6091</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12680297">SOLR-5476</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12650726" name="SOLR-6095.patch" size="36787" author="noble.paul" created="Tue, 17 Jun 2014 04:31:17 +0000"/>
                            <attachment id="12650620" name="SOLR-6095.patch" size="36510" author="noble.paul" created="Mon, 16 Jun 2014 18:42:55 +0000"/>
                            <attachment id="12650556" name="SOLR-6095.patch" size="36136" author="noble.paul" created="Mon, 16 Jun 2014 12:33:35 +0000"/>
                            <attachment id="12648856" name="SOLR-6095.patch" size="6889" author="shalin" created="Sun, 8 Jun 2014 07:24:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>393689</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 22 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1vsin:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>393851</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>