<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:49:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-15777] ICUCollationField useDocValuesAsStored=true leads to server errors or the return of useless field values</title>
                <link>https://issues.apache.org/jira/browse/SOLR-15777</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;&lt;tt&gt;ICUCollationField&lt;/tt&gt; inherently uses sort-specific values in docValues (sorting based on these special-purpose values is the purpose of the field). These values differ substantially from input values, and in some cases the content of docValues is (appropriately) not even valid UTF8. Despite this, &lt;tt&gt;ICUCollationField&lt;/tt&gt; defaults to &lt;tt&gt;useDocValuesAsStored=true&lt;/tt&gt;, so if the field is not stored and the user requests the field value to be returned (either explicitly or implicitly via &lt;tt&gt;fl=&amp;#42;&lt;/tt&gt;), at best it returns a meaningless String value (potentially causing problems on the client side), at worst it can throw a server-side error (see original issue description below).&lt;/p&gt;

&lt;p&gt;Original issue title: &quot;UTF8toUTF16 failing for Unicode Character &#8220;&#7449;&#8221; (U+1D19)&quot;&lt;br/&gt;
Original issue description:&lt;/p&gt;

&lt;p&gt;This issue was seen for bulgarian language and specifically on the inverse R Unicode Character &#8220;&#7449;&#8221; (U+1D19)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Indexing documents was fine&lt;/li&gt;
	&lt;li&gt;On querying following error was seen under following conditions&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Following is the Solr Config(field type &amp;amp; dynamic field for which the error is thrown on querying)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;lt;fieldType name=&lt;span class=&quot;code-quote&quot;&gt;&quot;collated_bg&quot;&lt;/span&gt; class=&lt;span class=&quot;code-quote&quot;&gt;&quot;solr.ICUCollationField&quot;&lt;/span&gt; locale=&lt;span class=&quot;code-quote&quot;&gt;&quot;bg&quot;&lt;/span&gt; strength=&lt;span class=&quot;code-quote&quot;&gt;&quot;primary&quot;&lt;/span&gt; caseLevel=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;/&amp;gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;lt;dynamicField name=&lt;span class=&quot;code-quote&quot;&gt;&quot;sort_X3b_bg_*&quot;&lt;/span&gt; type=&lt;span class=&quot;code-quote&quot;&gt;&quot;collated_bg&quot;&lt;/span&gt; stored=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt; indexed=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt; docValues=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt; /&amp;gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Following is the sample indexed doc content&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
{ &lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;testdoc&quot;&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;sort_X3b_bg_title&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;&#1103;&quot;&lt;/span&gt; }&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;On querying/Select query with id this doc gives the following error on Solr&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
{ &lt;span class=&quot;code-quote&quot;&gt;&quot;error&quot;&lt;/span&gt;:{ &lt;span class=&quot;code-quote&quot;&gt;&quot;msg&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;121&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;trace&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;java.lang.ArrayIndexOutOfBoundsException: 121\n\tat org.apache.lucene.util.UnicodeUtil.UTF8toUTF16(UnicodeUtil.java:602)\n\tat org.apache.lucene.util.BytesRef.utf8ToString(BytesRef.java:137)\n\tat org.apache.solr.search.SolrDocumentFetcher.decodeDVField(SolrDocumentFetcher.java:550)\n\tat org.apache.solr.search.SolrDocumentFetcher.decorateDocValueFields(SolrDocumentFetcher.java:506)\n\tat org.apache.solr.search.SolrDocumentFetcher$RetrieveFieldsOptimizer.getSolrDoc(SolrDocumentFetcher.java:800)\n\tat org.apache.solr.search.SolrDocumentFetcher$RetrieveFieldsOptimizer.access$000(SolrDocumentFetcher.java:672)\n\tat org.apache.solr.search.SolrDocumentFetcher.solrDoc(SolrDocumentFetcher.java:278)\n\tat org.apache.solr.response.DocsStreamer.next(DocsStreamer.java:95)\n\tat org.apache.solr.response.DocsStreamer.next(DocsStreamer.java:59)\n\tat org.apache.solr.response.TextResponseWriter.writeDocuments(TextResponseWriter.java:184)\n\tat org.apache.solr.response.TextResponseWriter.writeVal(TextResponseWriter.java:136)\n\tat org.apache.solr.common.util.JsonTextWriter.writeNamedListAsMapWithDups(JsonTextWriter.java:386)\n\tat org.apache.solr.common.util.JsonTextWriter.writeNamedList(JsonTextWriter.java:292)\n\tat org.apache.solr.response.JSONWriter.writeResponse(JSONWriter.java:73)\n\tat org.apache.solr.response.JSONResponseWriter.write(JSONResponseWriter.java:66)\n\tat org.apache.solr.response.QueryResponseWriterUtil.writeQueryResponse(QueryResponseWriterUtil.java:65)\n\tat org.apache.solr.servlet.HttpSolrCall.writeResponse(HttpSolrCall.java:811)\n\tat org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:540)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:395)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:341)\n\tat org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1602)\n\tat org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:540)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:146)\n\tat org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:548)\n\tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:257)\n\tat org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:1588)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:255)\n\tat org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1345)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:203)\n\tat org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:480)\n\tat org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:1557)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:201)\n\tat org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1247)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:144)\n\tat org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:220)\n\tat org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:126)\n\tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)\n\tat org.eclipse.jetty.rewrite.handler.RewriteHandler.handle(RewriteHandler.java:335)\n\tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)\n\tat org.eclipse.jetty.server.Server.handle(Server.java:502)\n\tat org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:364)\n\tat org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:260)\n\tat org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:305)\n\tat org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:103)\n\tat org.eclipse.jetty.io.ChannelEndPoint$2.run(ChannelEndPoint.java:118)\n\tat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.runTask(EatWhatYouKill.java:333)\n\tat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:310)\n\tat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.tryProduce(EatWhatYouKill.java:168)\n\tat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.run(EatWhatYouKill.java:126)\n\tat org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:366)\n\tat org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:765)\n\tat org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:683)\n\tat java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)\n&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;code&quot;&lt;/span&gt;:500}}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13410523">SOLR-15777</key>
            <summary>ICUCollationField useDocValuesAsStored=true leads to server errors or the return of useless field values</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="magibney">Michael Gibney</assignee>
                                    <reporter username="paragsn">Parag Ninawe</reporter>
                        <labels>
                    </labels>
                <created>Mon, 8 Nov 2021 06:27:29 +0000</created>
                <updated>Thu, 12 May 2022 00:26:56 +0000</updated>
                            <resolved>Sat, 29 Jan 2022 03:10:35 +0000</resolved>
                                    <version>7.7.3</version>
                                    <fixVersion>9.0</fixVersion>
                                    <component>query</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="17450888" author="JIRAUSER280970" created="Tue, 30 Nov 2021 06:33:54 +0000"  >&lt;p&gt;Hi team&lt;/p&gt;

&lt;p&gt;Could you take a look at this issue ASAP as it is affecting our 51 sites?&lt;/p&gt;</comment>
                            <comment id="17451469" author="mgibney" created="Wed, 1 Dec 2021 02:25:42 +0000"  >&lt;p&gt;I haven&apos;t figured out what&apos;s going on yet, but wanted to share what I have so far, in case it&apos;s helpful to anyone else considering looking into this:&lt;/p&gt;

&lt;p&gt;This doesn&apos;t really appear to be a Solr issue, or even a Lucene issue; the error can be reproduced with ICU code only:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    RuleBasedCollator c = (RuleBasedCollator) Collator.getInstance(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ULocale(&lt;span class=&quot;code-quote&quot;&gt;&quot;bg&quot;&lt;/span&gt;));
    c.setStrength(Collator.PRIMARY);
    c.setCaseLevel(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; str : &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[]{&lt;span class=&quot;code-quote&quot;&gt;&quot;&#1103;&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&#1092;&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&#1102;&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&#1089;&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&#1086;&quot;&lt;/span&gt;}) {
      &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; CollationKey k = c.getCollationKey(str);
      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        StandardCharsets.UTF_8.newDecoder().decode(ByteBuffer.wrap(k.toByteArray()));
      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable t) {
        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.err.println(str + &lt;span class=&quot;code-quote&quot;&gt;&quot;: collation key bytes are not valid utf8!&quot;&lt;/span&gt;);
      }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&quot;bg&quot; is not the only locale affected, either. It also affects every one of a handful of locales that I checked, including &quot;en&quot;.&lt;/p&gt;</comment>
                            <comment id="17451495" author="mgibney" created="Wed, 1 Dec 2021 04:10:00 +0000"  >&lt;p&gt;Quick update: maybe take my above comment with a grain of salt; I suspect that the problem is that collation keys are by design not necessarily valid UTF8. If that&apos;s the case, that would make sense and would indicate the need to track down and correct where it&apos;s (directly or indirectly) assumed in Solr that these keys &lt;em&gt;are&lt;/em&gt; valid UTF8. Apologies for any confusion.&lt;/p&gt;</comment>
                            <comment id="17452461" author="mgibney" created="Thu, 2 Dec 2021 15:18:27 +0000"  >&lt;p&gt;Not sure I&apos;ll have the time to dig deeper into this in the near term. If this is a pressing issue for you (as your comment about &quot;51 sites&quot; suggests it may be), I wonder if you might be able to address this issue with configuration changes?&lt;/p&gt;

&lt;p&gt;I trust someone will correct me if I&apos;m off the mark here, but here&apos;s my thinking at the moment:&lt;/p&gt;

&lt;p&gt;It looks like you&apos;re trying to return the raw binary collation key values to the client, and Solr is fetching the binary/processed keys from docValues (where they&apos;re used internally for sorting) and treating these binary values as if they are valid UTF8, which they are (appropriately, iiuc?) not. The only reason I can think of to return these raw collation keys to the client is if you&apos;re going to use them for client-side sorting, which strikes me as a very specialized use case. It&apos;s a plausible use case I guess, but in that case you&apos;d want/need to get the field value as raw binary (probably base64-encoded in the Json response writer).&lt;/p&gt;

&lt;p&gt;I think it would make sense for Solr to support the above &quot;binary sort key&quot; use case (which it evidently currently does not, and errors out unhelpfully). But going out on a limb here: it seems more likely that either:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;You are being returned this value by default (e.g., &lt;tt&gt;fl=*&lt;/tt&gt;, &lt;tt&gt;useDocValuesAsStored=true&lt;/tt&gt;), and you actually don&apos;t care about it, and could probably explicitly add &lt;tt&gt;useDocValuesAsStored=false&lt;/tt&gt; to the field or fieldType definition and call it a day, or&lt;/li&gt;
	&lt;li&gt;You want the original input field value for display, in which case it should suffice for you to add &lt;tt&gt;stored=true&lt;/tt&gt; to the field or fieldType definition (this would require a full reindex to have the desired effect).&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Again, I think there&apos;s probably ideally work to be done here on the Solr side, but there&apos;s a good chance that you can mitigate this issue by using existing configuration options (with quicker turnaround, incidentally).&lt;/p&gt;</comment>
                            <comment id="17470899" author="mgibney" created="Fri, 7 Jan 2022 21:49:25 +0000"  >&lt;p&gt;Encountered another instance of this causing confusion &quot;in the wild&quot; today. I think in most cases what&apos;s happening is that with the change of &lt;tt&gt;useDocValuesAsStored&lt;/tt&gt; defaulting to true (Solr 5.5.0, schema version 1.6), people started getting results for &lt;tt&gt;ICUCollationField&lt;/tt&gt; returned incidentally when specifying &lt;tt&gt;fl=*&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I suspect that people neither expect nor want this, and the values can be invalid UTF-8, and even when they are &lt;em&gt;valid&lt;/em&gt; UTF-8, they can wreak havoc with client-side response parsing, etc.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/solr/pull/506&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR #506&lt;/a&gt; has a few commits. The first causes udvas to default to false (uncontroversial imo?), but tries to support explicit udvas=true (returning the raw collation key serialized as base64-encoded binary). The second commit adds the option to strictly disallow udvas=true (throwing an exception if it is attempted to be explicitly set). The third strips all the other nonsense out and just disallows udvas=true (throwing an exception if it&apos;s attempted).&lt;/p&gt;

&lt;p&gt;I&apos;m convinced that &quot;strict&quot; is the right way to go here. It&apos;s a similar case to &lt;tt&gt;SortableTextField&lt;/tt&gt; except that where the &quot;dv&quot; and &quot;stored&quot; manifestation in &lt;tt&gt;SortableTextField&lt;/tt&gt; stand a good chance of being identical, &quot;dv&quot; and &quot;stored&quot; manifestation for &lt;tt&gt;ICUCollationField&lt;/tt&gt; are significantly different, so it wouldn&apos;t even be remotely possible to support the usual semantics of udvas. (Note, my proposal for analyzed docValues at &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8362&quot; title=&quot;Add docValues support for TextField&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8362&quot;&gt;SOLR-8362&lt;/a&gt; would support the mixed use case cleanly, I think &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;).&lt;/p&gt;

&lt;p&gt;If this approach sounds ok, I&apos;ll probably flesh out some sanity-check tests and try to get this committed (the tests should be straightforward enough that I&apos;d like to offer opportunity for anyone to contradict the proposed approach before writing tests to enshrine that approach ...)&lt;/p&gt;</comment>
                            <comment id="17472153" author="mgibney" created="Mon, 10 Jan 2022 16:47:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman&quot; class=&quot;user-hover&quot; rel=&quot;hossman&quot;&gt;hossman&lt;/a&gt; do you care to weigh in on this? It&apos;s similar to &lt;tt&gt;SortableTextField&lt;/tt&gt; if I&apos;m reading the situation correctly, but simpler because the difference between the docValues sort values and the values users would expect to have returned means it&apos;s simply impossible to support the semantics of udvas for &lt;tt&gt;ICUCollactionField&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I think this is pretty straightforward; absent negative feedback on the proposed solution I&apos;ll probably go ahead an write some (trivial) tests, CHANGES.txt entry and commit in the not-too-distant future.&lt;/p&gt;

</comment>
                            <comment id="17472220" author="hossman" created="Mon, 10 Jan 2022 18:35:46 +0000"  >&lt;p&gt;I haven&apos;t reviewed the patch, but based on my reading of the Jira I think Michael&apos;s overall assessment and &quot;strict&quot; proposal sounds correct:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the fact that anyone ever attempts to &quot;return&quot; these values at all is an unintenteded consequence of &lt;tt&gt;useDocValuesAsStored=true&lt;/tt&gt; implicitly defaulting to true in the base field types&lt;/li&gt;
	&lt;li&gt;no one should ever &lt;em&gt;want&lt;/em&gt; to explicitly set &lt;tt&gt;useDocValuesAsStored=true&lt;/tt&gt; on an &lt;tt&gt;ICUCOllationField&lt;/tt&gt; so there is little downside in not supporting it&lt;/li&gt;
	&lt;li&gt;Even if someone &lt;em&gt;thinks&lt;/em&gt; they wanted to have &lt;tt&gt;useDocValuesAsStored=true&lt;/tt&gt; on an &lt;tt&gt;ICUCOllationField&lt;/tt&gt;, it&apos;s never been valid, so there is very little downside to making it explicitly fail if someone tries.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;That said .... I would suggest using (something like) &lt;tt&gt;XmlConfigFile.assertWarnOrFail(&quot;...&quot;, useDVaS, luceneMatchVersion &amp;gt; 9.0)&lt;/tt&gt; just out of backcompat precaution. If someone foolishly added &lt;tt&gt;useDocValuesAsStored=true&lt;/tt&gt; to an &lt;tt&gt;ICUCOllationField&lt;/tt&gt; in the past, but never encountered this bug (because of how they query solr) then no reason to &quot;break&quot; their solr instance outright on upgrade, just start complaining in the logs unless/until they update their luceneMatchVersion (but anyone &quot;starting clean&quot; with a 9.x conig should get a hard failure right away if they try)&lt;/p&gt;</comment>
                            <comment id="17472946" author="mgibney" created="Tue, 11 Jan 2022 17:13:30 +0000"  >&lt;p&gt;Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman&quot; class=&quot;user-hover&quot; rel=&quot;hossman&quot;&gt;hossman&lt;/a&gt;!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If someone foolishly added useDocValuesAsStored=true to an ICUCOllationField in the past, but never encountered this bug (because of how they query solr) then no reason to &quot;break&quot; their solr instance outright on upgrade&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good point. The vast majority of cases probably just use the default behavior, so would see an immediate improvement. But the failure case (as the patch is currently implemented) would indeed be unnecessarily hard. I&apos;ll look to update the PR to incorporate this suggestion.&lt;/p&gt;

&lt;p&gt;Looks like Uwe approved the approach in the PR as well (thanks, Uwe!) so I&apos;ll move ahead with this and tests.&lt;/p&gt;</comment>
                            <comment id="17482853" author="mgibney" created="Thu, 27 Jan 2022 03:15:20 +0000"  >&lt;p&gt;Commit &lt;a href=&quot;https://github.com/apache/solr/pull/506/commits/7b955214a8d2a466a87ea6a6da1a8925bf49d496&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;7b955214&lt;/a&gt; takes the &quot;warn/fail depending on luceneMatchVersion&quot; approach. I&apos;d like to be able to test this succinctly, but I&apos;m not sure how best to do so (or, tbh, whether this change even warrants a test?) ...  &lt;/p&gt;</comment>
                            <comment id="17483440" author="mgibney" created="Thu, 27 Jan 2022 21:22:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/solr/pull/506&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR #506&lt;/a&gt; has a proper test now (and as is the way, some oversights turned up in testing, now corrected). I plan to merge this tomorrow to &lt;tt&gt;main&lt;/tt&gt; and backport to &lt;tt&gt;branch_9x&lt;/tt&gt; and &lt;tt&gt;branch_9_0&lt;/tt&gt;, unless anyone objects. (I&apos;d like to get this into 9.0 because this would be a compatibility concern for pathological schema configurations &amp;#8211; i.e., users who &lt;em&gt;explicitly&lt;/em&gt; enabled &lt;tt&gt;useDocValuesAsStored=&quot;true&quot;&lt;/tt&gt; on &lt;tt&gt;ICUCollationField&lt;/tt&gt; field types).&lt;/p&gt;</comment>
                            <comment id="17484055" author="jira-bot" created="Sat, 29 Jan 2022 03:01:42 +0000"  >&lt;p&gt;Commit 9e4376738e38559aeba5d62ee7b54dc68f6b9004 in solr&apos;s branch refs/heads/main from Michael Gibney&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=9e43767&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=9e43767&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15777&quot; title=&quot;ICUCollationField useDocValuesAsStored=true leads to server errors or the return of useless field values&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15777&quot;&gt;&lt;del&gt;SOLR-15777&lt;/del&gt;&lt;/a&gt;: Forbid useDocValuesAsStored for ICUCollationField (warn for luceneMatchVersion &amp;lt; 9.0.0) (#506)&lt;/p&gt;
</comment>
                            <comment id="17484057" author="jira-bot" created="Sat, 29 Jan 2022 03:05:01 +0000"  >&lt;p&gt;Commit 16f4210802841969c252fc3075245daf8f615e1c in solr&apos;s branch refs/heads/branch_9x from Michael Gibney&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=16f4210&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=16f4210&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15777&quot; title=&quot;ICUCollationField useDocValuesAsStored=true leads to server errors or the return of useless field values&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15777&quot;&gt;&lt;del&gt;SOLR-15777&lt;/del&gt;&lt;/a&gt;: Forbid useDocValuesAsStored for ICUCollationField (warn for luceneMatchVersion &amp;lt; 9.0.0) (#506)&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 9e4376738e38559aeba5d62ee7b54dc68f6b9004)&lt;/p&gt;</comment>
                            <comment id="17484058" author="jira-bot" created="Sat, 29 Jan 2022 03:08:43 +0000"  >&lt;p&gt;Commit 8ff5e0631d33369bfbc1a859c8ffee624d136f52 in solr&apos;s branch refs/heads/branch_9_0 from Michael Gibney&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=8ff5e06&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=8ff5e06&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15777&quot; title=&quot;ICUCollationField useDocValuesAsStored=true leads to server errors or the return of useless field values&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15777&quot;&gt;&lt;del&gt;SOLR-15777&lt;/del&gt;&lt;/a&gt;: Forbid useDocValuesAsStored for ICUCollationField (warn for luceneMatchVersion &amp;lt; 9.0.0) (#506)&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 16f4210802841969c252fc3075245daf8f615e1c)&lt;/p&gt;</comment>
                            <comment id="17535704" author="janhoy" created="Thu, 12 May 2022 00:26:56 +0000"  >&lt;p&gt;Closing after the 9.0.0 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13407917">SOLR-15712</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 26 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0wir4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>