<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:30:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-11714] AddReplicaSuggester endless loop</title>
                <link>https://issues.apache.org/jira/browse/SOLR-11714</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;&lt;tt&gt;SearchRateTrigger&lt;/tt&gt; events are processed by &lt;tt&gt;ComputePlanAction&lt;/tt&gt; and depending on the condition either a MoveReplicaSuggester or AddReplicaSuggester is selected.&lt;/p&gt;

&lt;p&gt;When &lt;tt&gt;AddReplicaSuggester&lt;/tt&gt; is selected there&apos;s currently a bug in master, due to an API change (Hint.COLL_SHARD should be used instead of Hint.COLL). However, after fixing that bug &lt;tt&gt;ComputePlanAction&lt;/tt&gt; goes into an endless loop because the suggester endlessly keeps creating new operations.&lt;/p&gt;

&lt;p&gt;Please see the patch that fixes the Hint.COLL_SHARD issue and modifies the unit test to illustrate this failure.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13122197">SOLR-11714</key>
            <summary>AddReplicaSuggester endless loop</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ab">Andrzej Bialecki</assignee>
                                    <reporter username="ab">Andrzej Bialecki</reporter>
                        <labels>
                    </labels>
                <created>Fri, 1 Dec 2017 15:41:22 +0000</created>
                <updated>Wed, 2 Oct 2019 17:23:47 +0000</updated>
                            <resolved>Wed, 24 Jan 2018 15:30:52 +0000</resolved>
                                    <version>7.2</version>
                    <version>8.0</version>
                                    <fixVersion>7.3</fixVersion>
                    <fixVersion>8.0</fixVersion>
                                    <component>AutoScaling</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16280569" author="ab" created="Wed, 6 Dec 2017 17:44:21 +0000"  >&lt;p&gt;This patch disables the &lt;tt&gt;searchRate&lt;/tt&gt; trigger in branch 7.2.&lt;/p&gt;</comment>
                            <comment id="16280831" author="jira-bot" created="Wed, 6 Dec 2017 20:12:28 +0000"  >&lt;p&gt;Commit 034daf424c13b467c16629823bc3b94395c738f3 in lucene-solr&apos;s branch refs/heads/branch_7_2 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=034daf4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=034daf4&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11714&quot; title=&quot;AddReplicaSuggester endless loop&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11714&quot;&gt;&lt;del&gt;SOLR-11714&lt;/del&gt;&lt;/a&gt;: Disable searchRate trigger due to a suggester bug.&lt;/p&gt;</comment>
                            <comment id="16282295" author="jpountz" created="Thu, 7 Dec 2017 18:37:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab%40getopt.org&quot; class=&quot;user-hover&quot; rel=&quot;ab@getopt.org&quot;&gt;ab@getopt.org&lt;/a&gt; Can this issue be resolved or is there work left to do?&lt;/p&gt;</comment>
                            <comment id="16282301" author="ab" created="Thu, 7 Dec 2017 18:40:10 +0000"  >&lt;p&gt;This still needs to be properly fixed for all other affected branches (7x and master), the commit above is just a quick fix that disables this functionality in 7.2.&lt;/p&gt;</comment>
                            <comment id="16282352" author="jpountz" created="Thu, 7 Dec 2017 19:11:51 +0000"  >&lt;p&gt;OK, thanks for the explanation.&lt;/p&gt;</comment>
                            <comment id="16311401" author="noble.paul" created="Thu, 4 Jan 2018 14:32:58 +0000"  >&lt;p&gt;The infinite loop is because of wrong usage. AddReplica always return non null operation as long as there are no policy constraints&lt;/p&gt;</comment>
                            <comment id="16312123" author="noble.paul" created="Thu, 4 Jan 2018 22:25:30 +0000"  > &lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
{&lt;span class=&quot;code-quote&quot;&gt;&quot;cluster-preferences&quot;&lt;/span&gt;:[{
        &lt;span class=&quot;code-quote&quot;&gt;&quot;minimize&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;cores&quot;&lt;/span&gt;,
        &lt;span class=&quot;code-quote&quot;&gt;&quot;precision&quot;&lt;/span&gt;:1}]}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;this is the preferences and there is no policy specified. This means an infinite no:of replicas can be added without breaking any rules. &lt;/p&gt;

&lt;p&gt;the test must add an explicit policy limiting the no:of replicas per node AND the ComputeAction must check for something more than just relying on the policy framework to return a &lt;tt&gt;null&lt;/tt&gt; suggestion&lt;/p&gt;</comment>
                            <comment id="16316393" author="ab" created="Mon, 8 Jan 2018 14:23:30 +0000"  >&lt;p&gt;The current behavior of the framework is trappy because user has to modify the preferences when he adds a &lt;tt&gt;searchRate&lt;/tt&gt; trigger in order to avoid the loop - if he forgets to do that he can bring the autoscaling down.&lt;/p&gt;

&lt;p&gt;There are two things that we can do here: &lt;tt&gt;ComputePlanAction&lt;/tt&gt; should be able to detect infinite (or very long) loops based roughly on the cluster size and the total number of replicas across the cluster, eg. if we have a cluster of 10 nodes and 20 replicas but the loop generated 1000 operations then something is definitely wrong.&lt;/p&gt;

&lt;p&gt;Also, can we use some default limit, eg. 2 * replication factor, or something similar, for ADDREPLICA suggester, at least for events produced by &lt;tt&gt;searchRate&lt;/tt&gt; trigger? Where do you think this default should be initialized?&lt;/p&gt;</comment>
                            <comment id="16316399" author="noble.paul" created="Mon, 8 Jan 2018 14:27:24 +0000"  >&lt;p&gt;There is no means for the Policy framework to decide the no:of replicas that required to be added to achieve the given throughput. Instead ComputeActionPlan must only request it to add a certain no:of replicas (worst case, one at a time) and observe the result and add another &lt;/p&gt;</comment>
                            <comment id="16318349" author="ab" created="Tue, 9 Jan 2018 12:38:07 +0000"  >&lt;p&gt;Ok, I see that now.&lt;/p&gt;

&lt;p&gt;The logic in &lt;tt&gt;ComputePlanAction&lt;/tt&gt; for handling &lt;tt&gt;searchRate&lt;/tt&gt; events will end up quite complex, due to the limitations of Suggester API (returning just one op at a time) - eg. &lt;tt&gt;AddReplicaSuggester&lt;/tt&gt; will need to be initialized differently in each loop, otherwise it would keep adding replicas to the first hot shard and ignore the others&#8230; For now this logic need to be put in &lt;tt&gt;ComputePlanAction&lt;/tt&gt; - but if we changed the &lt;tt&gt;Suggester.getSuggestion&lt;/tt&gt; to be able to return multiple suggestions, and changed &lt;tt&gt;AddReplicaSuggester.getSuggestions()&lt;/tt&gt; to return suggestions for all hints, then we could move this complicated logic to &lt;tt&gt;SearchRateTrigger&lt;/tt&gt;. WDYT?&lt;/p&gt;</comment>
                            <comment id="16318375" author="noble.paul" created="Tue, 9 Jan 2018 12:57:15 +0000"  >&lt;p&gt;How does the suggester know what is the impact of the last operation on the search rate on a given node? It&apos;s not predictable. Getting multiple suggestions is not any more useful than the current approach. &lt;/p&gt;</comment>
                            <comment id="16318606" author="ab" created="Tue, 9 Jan 2018 15:31:43 +0000"  >&lt;p&gt;After discussing this with Noble it seems that the best way to solve this is to allow some triggers to calculate the list of expected changes (eg. a list of COLL_SHARD replicas to add), and then explicitly iterate in &lt;tt&gt;ComputePlanAction&lt;/tt&gt; as many times as needed to consume the list of these changes, and initializing suggesters with one change at a time (which would eventually result in calculating up to the same number of ops, though some of them may be null).&lt;/p&gt;</comment>
                            <comment id="16320105" author="ab" created="Wed, 10 Jan 2018 11:28:17 +0000"  >&lt;p&gt;The root issue for the loop was that the Policy framework can properly account for effect of its planned changes only for a few predefined parameters (cores, diskfree, cpu, etc). However, both SearchRateTrigger and MetricTrigger generate events that correspond to more complex cluster state.&lt;/p&gt;

&lt;p&gt;This patch modifies the way these triggers work, and also significantly simplifies &lt;tt&gt;ComputePlanAction&lt;/tt&gt;. Instead of relying on the Policy framework to figure out what and how many operations are needed these triggers specify requested operations explicitly in the form of action+hints, leaving only the target replica placement aspect to the Policy framework.&lt;/p&gt;</comment>
                            <comment id="16327270" author="shalinmangar" created="Tue, 16 Jan 2018 15:50:47 +0000"  >&lt;p&gt;+1 LGTM. I reviewed the diff directly because I couldn&apos;t apply the patch cleanly on latest master.&lt;/p&gt;</comment>
                            <comment id="16337558" author="jira-bot" created="Wed, 24 Jan 2018 13:03:03 +0000"  >&lt;p&gt;Commit fa511a0a6f7e9f395aef853b1da7908d88be9f9a in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=fa511a0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=fa511a0&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11714&quot; title=&quot;AddReplicaSuggester endless loop&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11714&quot;&gt;&lt;del&gt;SOLR-11714&lt;/del&gt;&lt;/a&gt;: AddReplicaSuggester  / ComputePlanAction infinite loop.&lt;/p&gt;</comment>
                            <comment id="16337767" author="jira-bot" created="Wed, 24 Jan 2018 15:29:06 +0000"  >&lt;p&gt;Commit fba5114b78de2eb84b5ae71745a6eb670ca4ad33 in lucene-solr&apos;s branch refs/heads/branch_7x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=fba5114&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=fba5114&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11714&quot; title=&quot;AddReplicaSuggester endless loop&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11714&quot;&gt;&lt;del&gt;SOLR-11714&lt;/del&gt;&lt;/a&gt;: AddReplicaSuggester  / ComputePlanAction infinite loop.&lt;/p&gt;</comment>
                            <comment id="16339474" author="jira-bot" created="Thu, 25 Jan 2018 16:42:25 +0000"  >&lt;p&gt;Commit 09f903ef8dd7d294b1f5b1cf7023b28a58277d25 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=09f903e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=09f903e&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11714&quot; title=&quot;AddReplicaSuggester endless loop&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11714&quot;&gt;&lt;del&gt;SOLR-11714&lt;/del&gt;&lt;/a&gt;: Remove todo now that this issue has been fixed&lt;/p&gt;</comment>
                            <comment id="16339480" author="jira-bot" created="Thu, 25 Jan 2018 16:43:32 +0000"  >&lt;p&gt;Commit af9706cb89335a5aa04f9bcae0c2558a61803b50 in lucene-solr&apos;s branch refs/heads/branch_7x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=af9706c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=af9706c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11714&quot; title=&quot;AddReplicaSuggester endless loop&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11714&quot;&gt;&lt;del&gt;SOLR-11714&lt;/del&gt;&lt;/a&gt;: Remove todo now that this issue has been fixed&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 09f903e)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13105155">SOLR-11403</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13097304">SOLR-11285</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12900905" name="7.2-disable-search-rate-trigger.diff" size="7170" author="ab" created="Wed, 6 Dec 2017 17:43:58 +0000"/>
                            <attachment id="12900242" name="SOLR-11714.diff" size="3099" author="ab" created="Fri, 1 Dec 2017 15:42:29 +0000"/>
                            <attachment id="12905437" name="SOLR-11714.patch" size="36754" author="ab" created="Wed, 10 Jan 2018 11:21:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 42 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3nfov:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>