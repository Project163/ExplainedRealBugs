<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:11:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-8697] Fix LeaderElector issues</title>
                <link>https://issues.apache.org/jira/browse/SOLR-8697</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;This patch is still somewhat WIP for a couple of reasons:&lt;/p&gt;

&lt;p&gt;1) Still debugging test failures.&lt;br/&gt;
2) This will more scrutiny from knowledgable folks!&lt;/p&gt;

&lt;p&gt;There are some subtle bugs with the current implementation of LeaderElector, best demonstrated by the following test:&lt;/p&gt;

&lt;p&gt;1) Start up a small single-node solrcloud.  it should be become Overseer.&lt;br/&gt;
2) kill -9 the solrcloud process and immediately start a new one.&lt;br/&gt;
3) The new process won&apos;t become overseer.  The old process&apos;s ZK leader elect node has not yet disappeared, and the new process fails to set appropriate watches.&lt;/p&gt;

&lt;p&gt;NOTE: this is only reproducible if the new node is able to start up and join the election quickly.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12940265">SOLR-8697</key>
            <summary>Fix LeaderElector issues</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="markrmiller@gmail.com">Mark Miller</assignee>
                                    <reporter username="dragonsinth">Scott Blum</reporter>
                        <labels>
                            <label>patch</label>
                            <label>reliability</label>
                            <label>solrcloud</label>
                    </labels>
                <created>Thu, 18 Feb 2016 19:54:18 +0000</created>
                <updated>Wed, 2 Oct 2019 17:25:04 +0000</updated>
                            <resolved>Thu, 21 Apr 2016 21:12:12 +0000</resolved>
                                    <version>5.4.1</version>
                                    <fixVersion>5.5.1</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="15152995" author="dragonsinth" created="Thu, 18 Feb 2016 20:06:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erickerickson&quot; class=&quot;user-hover&quot; rel=&quot;erickerickson&quot;&gt;erickerickson&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15153011" author="markrmiller@gmail.com" created="Thu, 18 Feb 2016 20:17:39 +0000"  >&lt;blockquote&gt;&lt;p&gt;The old process&apos;s ZK leader elect node has not yet disappeared, and the new process fails to set appropriate watches.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I thought we waited for a while for the old one to go away...is that missing in the Overseer election code and just in the shard election code?&lt;/p&gt;</comment>
                            <comment id="15153048" author="dragonsinth" created="Thu, 18 Feb 2016 20:41:08 +0000"  >&lt;p&gt;TBH, the code is pretty hard to follow in its existing form, and a lot of the theory of operation and design is difficult to distill.  There is code that looks like it&apos;s trying to do what you&apos;re talking about, but it&apos;s buggy.&lt;/p&gt;

&lt;p&gt;Take this analysis with like 70% confidence: The existing code has a very hazy definition of &quot;myself&quot; and &quot;previous registration&quot;, from what I can tell.  The previous elect node from a different process qualifies as &quot;myself&quot; in some cases, so the new process thinks it&apos;s already registered when it&apos;s not.&lt;/p&gt;</comment>
                            <comment id="15153294" author="dragonsinth" created="Thu, 18 Feb 2016 22:52:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erickerickson&quot; class=&quot;user-hover&quot; rel=&quot;erickerickson&quot;&gt;erickerickson&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I think there is a potential problem with how OverseerTest is constructed, that perhaps caused us to write some code into LeaderElector in the past that doesn&apos;t make any sense for live code.&lt;/p&gt;

&lt;p&gt;I&apos;m looking at the implementation of MockZkController.publishState() (it&apos;s kind of a beast) and I notice that when it creates an ElectionContext, it never actually adds it to the map, checks whether one already exists, etc.  As a result, MockZkController does something the real ZkController never does &amp;#8211; it tries to register two different election contexts for the same core on the same ZK session.&lt;/p&gt;

&lt;p&gt;My question is, what&apos;s the right fix?  I can either make MockZkController not setup a new electionContext on subsequent invocations, or I could make it simply cancel the previous election context before creating a new one.&lt;/p&gt;</comment>
                            <comment id="15153418" author="dragonsinth" created="Fri, 19 Feb 2016 00:16:37 +0000"  >&lt;p&gt;Found another bug in ShardLeaderElectionContextBase.&lt;/p&gt;

&lt;p&gt;cancelElection() and runLeaderProcess() can race with each other.  If the local process is trying to cancel right as it becomes leader, cancelElection() won&apos;t see a leaderZkNodeParentVersion yet, so it won&apos;t try to delete the leader registration.  Meanwhile, runLeaderProcess() still succeeds in creating the leader registration.  The call to super.cancelElection() does remove us from the queue, but the dead leader registration is left there.&lt;/p&gt;

&lt;p&gt;I think moving the call to super.cancelElection() to the start of ShardLeaderElectionContextBase.cancelElection() should resolve the race, because actually removing the election node will cause the multi to fail with a NoNode rather than a NodeExists, and it won&apos;t get stuck in a retry loop.&lt;/p&gt;</comment>
                            <comment id="15154618" author="dragonsinth" created="Fri, 19 Feb 2016 18:37:11 +0000"  >&lt;p&gt;Okay, all the tests are passing now, I think this is ready for review.&lt;/p&gt;</comment>
                            <comment id="15154740" author="markrmiller@gmail.com" created="Fri, 19 Feb 2016 19:44:17 +0000"  >&lt;blockquote&gt;&lt;p&gt;TBH, the code is pretty hard to follow in its existing form&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yup. It was mildly hairy in its first form (copying the ZK recipe as described) and took a while to harden. Then some contributions came that just made it insane to follow. I&apos;ve brought it up before, instead of trying to avoid thundering herd issues with what will be a reasonably low number of replicas trying to be leader, we probably should just have very simple leader elections. All of the original logic, and the logic that was added that made it really hard for me to follow, would be really simple if we gave up the cool elegant approach we used to avoid a mostly non existent thundering herd issue. That thicket is just a ripe breeding ground for random bugs our tests just don&apos;t easily expose.&lt;/p&gt;

&lt;p&gt;At this point, the effort to change reliably is probably really high though.&lt;/p&gt;</comment>
                            <comment id="15154817" author="dragonsinth" created="Fri, 19 Feb 2016 20:30:14 +0000"  >&lt;p&gt;I think part of the general problem with a lot of the ZK-interacting code is a lack of clean separation of concerns.  The relationships between LeaderElector and the various ElectionContext subclasses are pretty gnarly and incestuous.  DistributedQueue had a similar kind of design problem before I extracted the app specific gnarly parts into OverseerTaskQueue.&lt;/p&gt;

&lt;p&gt;Have we considered trying to migrate to, say, Apache Curator (full disclosure: I&apos;m a committer)?  There are a lot of advantages to using third party libs for some of these common patterns like distributed queue, leader election, or even observing changes in a tree.  Those components tend to be reusable, better documented, with cleaner APIs, and have a natural resistance to spaghetti invasion.  (Examples: OverseerNodePrioritizer and RebalanceLeaders are intricately tied to implementation details of LeaderElector.)&lt;/p&gt;

&lt;p&gt;A clean, reusable leader election component (with its own tests) that could simply be used in a few different contexts seems like a good place to be longer term.&lt;/p&gt;

&lt;p&gt;That said, I hope this patch can simply clean up some up the existing bugs without being too disruptive.&lt;/p&gt;</comment>
                            <comment id="15154833" author="markrmiller@gmail.com" created="Fri, 19 Feb 2016 20:42:04 +0000"  >&lt;p&gt;Curator has come up before. Personally, I have not wanted to try and mimic what we have or go through a protracted hardening process again. This stuff is all very touchy, and our tests def do not catch everything, so a rip and replace at that low level would be both very difficult and sure to introduce a lot of issues.&lt;/p&gt;

&lt;p&gt;I think a lot of the problem is that devs like to favor just tossing crap on top of what exists, rather than trying to wholistically move the design forward or make it right for what they want to add (Examples: OverseerNodePrioritizer and RebalanceLeaders - which also made the election code much more dense). I feel a lot of &quot;let&apos;s just make this work&quot;. I can&apos;t tell you how surprised I&apos;ve been that some devs have come and built so much on some of the prototype code I initially laid out. I&apos;ve always thought, how do you build so much on this without finding/fixing more core bugs and seeing other necessary improvements more things as you go? Not that it doesn&apos;t happen, but the scale has historically been way below what I think makes sense. Easy for me to say I guess. Anyway, it&apos;s great that you have already filed a bunch of issues &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I&apos;d rather focus on some refactoring than bringing in curator though. The implications of that would be pretty large and we have plenty of other more pressing issues I think.&lt;/p&gt;</comment>
                            <comment id="15154853" author="markrmiller@gmail.com" created="Fri, 19 Feb 2016 20:55:38 +0000"  >&lt;blockquote&gt;&lt;p&gt;full disclosure: I&apos;m a committer&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;And you worked on GWT! Awesome. Have not used it in years, still madly in love with GWT.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;using third party libs &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We may have started with curator but when we started (query side of SolrCloud was 2009 or 2010?) it was not around or we did not know about it back then if it was.&lt;/p&gt;</comment>
                            <comment id="15154888" author="dragonsinth" created="Fri, 19 Feb 2016 21:22:44 +0000"  >&lt;p&gt;Yeah, totally agreed on refactoring and trying to fix core bugs!  Bringing in Curator at some point would be something I&apos;d only advocate for incrementally and in pieces, like replace our DQ with Curator&apos;s, etc.  Moving everything over at in a short period of time would be a pipe dream anyway.&lt;/p&gt;

&lt;p&gt;Back on the topic of LeaderElector, I think this patch is in a pretty good state now.  The only thing I want to consider doing in the short term (after this patch) is that, in addition to watching the node ahead of you, I think we should also be watching our own node, whether or not we&apos;re leader.  If an outside party forcibly deletes our node, we should put ourselves at the back of the line.  If you think about it, if we could trust that behavior, something like RebalanceLeaders wouldn&apos;t even need to be a distributed request; overseer could just delete the current leader elect node and trust the owner to do the right thing.&lt;/p&gt;</comment>
                            <comment id="15154919" author="markrmiller@gmail.com" created="Fri, 19 Feb 2016 21:44:27 +0000"  >&lt;p&gt;You can leave the old patches by the way. We tend to leave the history and just pull the latest patch with the same file name.&lt;/p&gt;</comment>
                            <comment id="15154939" author="markrmiller@gmail.com" created="Fri, 19 Feb 2016 21:54:50 +0000"  >&lt;blockquote&gt;&lt;p&gt;Bringing in Curator at some point would be something I&apos;d only advocate for incrementally and in pieces, like replace our DQ with Curator&apos;s, etc.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah, I suppose if we had some consensus to push it forward over time, that&apos;s a viable option.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If an outside party forcibly deletes our node, we should put ourselves at the back of the line.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah, that sounds like an interesting improvement. Much nicer than making a bunch of distrib calls.&lt;/p&gt;</comment>
                            <comment id="15154950" author="markrmiller@gmail.com" created="Fri, 19 Feb 2016 22:02:01 +0000"  >&lt;p&gt;FYI, we are in a special little place where we can break back compat and don&apos;t have to consider rolling upgrades because the next release is 6.0. We don&apos;t have much time before 6.0 branches though I think.&lt;/p&gt;

&lt;p&gt;Patch looks good to me. Others should take a look as well, but I&apos;ll commit to get Jenkins cranking on it.&lt;/p&gt;</comment>
                            <comment id="15154965" author="jira-bot" created="Fri, 19 Feb 2016 22:07:05 +0000"  >&lt;p&gt;Commit 9418369b46586818467109e482b70ba41e90d4ed in lucene-solr&apos;s branch refs/heads/master from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=9418369&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=9418369&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8697&quot; title=&quot;Fix LeaderElector issues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8697&quot;&gt;&lt;del&gt;SOLR-8697&lt;/del&gt;&lt;/a&gt;: Scope ZK election nodes by session to prevent elections from interfering with each other and other small LeaderElector improvements.&lt;/p&gt;</comment>
                            <comment id="15154976" author="markrmiller@gmail.com" created="Fri, 19 Feb 2016 22:11:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;cancelElection() and runLeaderProcess() can race with each other. If the local process is trying to cancel right as it becomes leader, cancelElection() won&apos;t see a leaderZkNodeParentVersion yet, so it won&apos;t try to delete the leader registration. Meanwhile, runLeaderProcess() still succeeds in creating the leader registration. The call to super.cancelElection() does remove us from the queue, but the dead leader registration is left there.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Any thoughts on why the existing stress tests for leader election can&apos;t catch this? Can we beef something up?&lt;/p&gt;</comment>
                            <comment id="15154993" author="dragonsinth" created="Fri, 19 Feb 2016 22:22:24 +0000"  >&lt;p&gt;Actually OverseerTest.testShardLeaderChange() DID catch this race for me.  But only rarely.  Debugging that flake is how I uncovered the race.&lt;/p&gt;</comment>
                            <comment id="15154996" author="markrmiller@gmail.com" created="Fri, 19 Feb 2016 22:25:07 +0000"  >&lt;p&gt;Okay, good, but then was it after your changes? I don&apos;t recall seeing that test fail in a long, long time on our Jenkins &apos;cluster&apos;, and that&apos;s a bunch of machines running the tests continuously. I also don&apos;t recall it locally.&lt;/p&gt;</comment>
                            <comment id="15155203" author="dragonsinth" created="Sat, 20 Feb 2016 00:22:00 +0000"  >&lt;p&gt;I think it&apos;s such a subtle race, that it would only generally show up with code changes-- but as little as changing logging could trigger it / not trigger it.  So it might have been beaten into a state where it happened to work unless you breathed on it.  Drove me nuts for the longest time debugging it until I stumbled on the race. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/biggrin.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15159525" author="markrmiller@gmail.com" created="Tue, 23 Feb 2016 19:46:49 +0000"  >&lt;p&gt;Note: Have not seen any fails like this in this test in a long, long time so may be related to this change. Perhaps just a test issue, because this retries for like 60 seconds or something.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   [junit4] ERROR   66.3s J4  | OverseerTest.testShardLeaderChange &amp;lt;&amp;lt;&amp;lt;
   [junit4]    &amp;gt; Throwable #1: org.apache.solr.common.SolrException: Could not register as the leader because creating the ephemeral registration node in ZooKeeper failed
   [junit4]    &amp;gt; 	at __randomizedtesting.SeedInfo.seed([C4618609907C7E14:1A3201FE8AE48BE5]:0)
   [junit4]    &amp;gt; 	at org.apache.solr.cloud.ShardLeaderElectionContextBase.runLeaderProcess(ElectionContext.java:212)
   [junit4]    &amp;gt; 	at org.apache.solr.cloud.LeaderElector.runIamLeaderProcess(LeaderElector.java:173)
   [junit4]    &amp;gt; 	at org.apache.solr.cloud.LeaderElector.checkIfIamLeader(LeaderElector.java:138)
   [junit4]    &amp;gt; 	at org.apache.solr.cloud.LeaderElector.joinElection(LeaderElector.java:310)
   [junit4]    &amp;gt; 	at org.apache.solr.cloud.LeaderElector.joinElection(LeaderElector.java:219)
   [junit4]    &amp;gt; 	at org.apache.solr.cloud.OverseerTest$MockZKController.publishState(OverseerTest.java:181)
   [junit4]    &amp;gt; 	at org.apache.solr.cloud.OverseerTest.testShardLeaderChange(OverseerTest.java:841)
   [junit4]    &amp;gt; 	at java.lang.Thread.run(Thread.java:745)
   [junit4]    &amp;gt; Caused by: org.apache.zookeeper.KeeperException$NodeExistsException: KeeperErrorCode = NodeExists
   [junit4]    &amp;gt; 	at org.apache.zookeeper.KeeperException.create(KeeperException.java:119)
   [junit4]    &amp;gt; 	at org.apache.zookeeper.ZooKeeper.multiInternal(ZooKeeper.java:949)
   [junit4]    &amp;gt; 	at org.apache.zookeeper.ZooKeeper.multi(ZooKeeper.java:915)
   [junit4]    &amp;gt; 	at org.apache.solr.common.cloud.SolrZkClient$11.execute(SolrZkClient.java:577)
   [junit4]    &amp;gt; 	at org.apache.solr.common.cloud.SolrZkClient$11.execute(SolrZkClient.java:574)
   [junit4]    &amp;gt; 	at org.apache.solr.common.cloud.ZkCmdExecutor.retryOperation(ZkCmdExecutor.java:60)
   [junit4]    &amp;gt; 	at org.apache.solr.common.cloud.SolrZkClient.multi(SolrZkClient.java:574)
   [junit4]    &amp;gt; 	at org.apache.solr.cloud.ShardLeaderElectionContextBase$1.execute(ElectionContext.java:195)
   [junit4]    &amp;gt; 	at org.apache.solr.common.util.RetryUtil.retryOnThrowable(RetryUtil.java:49)
   [junit4]    &amp;gt; 	at org.apache.solr.common.util.RetryUtil.retryOnThrowable(RetryUtil.java:42)
   [junit4]    &amp;gt; 	at org.apache.solr.cloud.ShardLeaderElectionContextBase.runLeaderProcess(ElectionContext.java:178)
   [junit4]    &amp;gt; 	... 45 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15159537" author="dragonsinth" created="Tue, 23 Feb 2016 19:52:50 +0000"  >&lt;p&gt;I&apos;ll take a look.  I ran into this before on account of the test code doing a couple of questionable things.&lt;/p&gt;

&lt;p&gt;1) Re-using the same ZK session for multiple election contexts on the same election.  I fixed that one in my patch.&lt;/p&gt;

&lt;p&gt;2) Not deleting the registration on cancel.  I didn&apos;t bother fixing this one, since I figured eventually the session timeout would kill all the ephemeral nodes, making for a more thorough test.  But explicitly deleting the registration would speed the test up and make it more reliable, probably.&lt;/p&gt;

&lt;p&gt;Thoughts?&lt;/p&gt;</comment>
                            <comment id="15159554" author="markrmiller@gmail.com" created="Tue, 23 Feb 2016 20:00:50 +0000"  >&lt;p&gt;Here is the log file just in case.&lt;/p&gt;</comment>
                            <comment id="15159562" author="markrmiller@gmail.com" created="Tue, 23 Feb 2016 20:05:57 +0000"  >&lt;blockquote&gt;&lt;p&gt;deleting the registration on cancel.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1.&lt;/p&gt;</comment>
                            <comment id="15159589" author="dragonsinth" created="Tue, 23 Feb 2016 20:29:28 +0000"  >&lt;p&gt;Attached a followup patch that cancels previous elections when the MockZkController is closed.  I haven&apos;t actually been able to get OverseerTest.testShardLeaderChange() to flake on my machine, with or without the change, even running like 100 iterations.  But &lt;/p&gt;</comment>
                            <comment id="15159597" author="markrmiller@gmail.com" created="Tue, 23 Feb 2016 20:34:00 +0000"  >&lt;blockquote&gt;&lt;p&gt;, even running like 100 iterations.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Unfortunately, that is common. The tests are run in a wicked diverse set of envs. We see stuff from the jenkins cluster no dev ever seems to hit. &lt;/p&gt;

&lt;p&gt;A lot of fails only pop when running with other tests to also bog down the system, and you won&apos;t see the issue with that test in isolation, and then you can configure different numbers of tests to run at the same time (I do 10 on my 6 core machine), and the different levels of hardware...&lt;/p&gt;

&lt;p&gt;Some things are pretty hard to replicate locally.&lt;/p&gt;</comment>
                            <comment id="15159610" author="dragonsinth" created="Tue, 23 Feb 2016 20:42:49 +0000"  >&lt;p&gt;Actually, I&apos;m stupid.  The flaky problem is that I &lt;b&gt;still&lt;/b&gt; didn&apos;t fix the race regarding leaderZkNodeParentVersion.  I just made it harder to repro.&lt;/p&gt;

&lt;p&gt;The smoking gun is this line:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;      log.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;No version found &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; ephemeral leader parent node, won&apos;t remove previous leader registration.&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You can repro this pretty easily with the following change:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;
 -- a/solr/core/src/java/org/apache/solr/cloud/ElectionContext.java
 ++ b/solr/core/src/java/org/apache/solr/cloud/ElectionContext.java
&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;
@@ -193,7 +193,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ShardLeaderElectionContextBase &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; ElectionContext {
           List&amp;lt;OpResult&amp;gt; results;
           
           results = zkClient.multi(ops, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
           
           &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(10000);
           &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (OpResult result : results) {
             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (result.getType() == ZooDefs.OpCode.setData) {
               SetDataResult dresult = (SetDataResult) result;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We need a harder synchronization around becoming leader vs. canceling.&lt;/p&gt;</comment>
                            <comment id="15159632" author="dragonsinth" created="Tue, 23 Feb 2016 20:54:36 +0000"  >&lt;p&gt;Attached a patch with real synchronization.  99% sure this will fix the observed flake.&lt;br/&gt;
I also included the MockZKController.close() election cancel change, I think it&apos;s a good cleanup but not related to the flake.&lt;/p&gt;</comment>
                            <comment id="15163535" author="dragonsinth" created="Wed, 24 Feb 2016 19:05:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; should I open a separate jira for the follow on patch?&lt;/p&gt;</comment>
                            <comment id="15163597" author="markrmiller@gmail.com" created="Wed, 24 Feb 2016 19:47:04 +0000"  >&lt;p&gt;No, we only open a new issue if this one has gone out in a release, otherwise we can keep iterating as needed in the same issue. A bit busy, but I&apos;ll get to this soon.&lt;/p&gt;</comment>
                            <comment id="15169379" author="jira-bot" created="Fri, 26 Feb 2016 17:32:26 +0000"  >&lt;p&gt;Commit efb7bb171b22a3c6a00d30eefe935a0024df0c71 in lucene-solr&apos;s branch refs/heads/master from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=efb7bb1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=efb7bb1&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8697&quot; title=&quot;Fix LeaderElector issues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8697&quot;&gt;&lt;del&gt;SOLR-8697&lt;/del&gt;&lt;/a&gt;: Add synchronization around registering as leader and canceling.&lt;/p&gt;</comment>
                            <comment id="15170408" author="jira-bot" created="Sat, 27 Feb 2016 07:06:28 +0000"  >&lt;p&gt;Commit c2bc93822d73b66c74ed998ea6c57a3cce05af44 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=c2bc938&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=c2bc938&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8697&quot; title=&quot;Fix LeaderElector issues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8697&quot;&gt;&lt;del&gt;SOLR-8697&lt;/del&gt;&lt;/a&gt;: Fix precommit failure&lt;/p&gt;</comment>
                            <comment id="15252315" author="anshumg" created="Thu, 21 Apr 2016 17:47:54 +0000"  >&lt;p&gt;Reopening to back port for 5.5.1&lt;/p&gt;</comment>
                            <comment id="15252648" author="jira-bot" created="Thu, 21 Apr 2016 20:39:36 +0000"  >&lt;p&gt;Commit 0dabbadb4dbdabbad4da06a49e2eebd908a4cd62 in lucene-solr&apos;s branch refs/heads/branch_5x from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=0dabbad&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=0dabbad&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8697&quot; title=&quot;Fix LeaderElector issues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8697&quot;&gt;&lt;del&gt;SOLR-8697&lt;/del&gt;&lt;/a&gt;: Scope ZK election nodes by session to prevent elections from interfering with each other and other small LeaderElector improvements.&lt;/p&gt;</comment>
                            <comment id="15252649" author="jira-bot" created="Thu, 21 Apr 2016 20:39:38 +0000"  >&lt;p&gt;Commit d08169e6f6355d9023779cac1303ab48fe2c86e0 in lucene-solr&apos;s branch refs/heads/branch_5x from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=d08169e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=d08169e&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8697&quot; title=&quot;Fix LeaderElector issues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8697&quot;&gt;&lt;del&gt;SOLR-8697&lt;/del&gt;&lt;/a&gt;: Add synchronization around registering as leader and canceling.&lt;/p&gt;</comment>
                            <comment id="15252650" author="jira-bot" created="Thu, 21 Apr 2016 20:39:39 +0000"  >&lt;p&gt;Commit 4b42c77ac6b045dce914d2244298cd0fea5300e4 in lucene-solr&apos;s branch refs/heads/branch_5x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=4b42c77&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=4b42c77&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8697&quot; title=&quot;Fix LeaderElector issues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8697&quot;&gt;&lt;del&gt;SOLR-8697&lt;/del&gt;&lt;/a&gt;: Fix precommit failure&lt;/p&gt;</comment>
                            <comment id="15252750" author="jira-bot" created="Thu, 21 Apr 2016 21:11:42 +0000"  >&lt;p&gt;Commit f8dd98f93b75ff774fd81c3a44d551d204676b94 in lucene-solr&apos;s branch refs/heads/branch_5_5 from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f8dd98f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f8dd98f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8697&quot; title=&quot;Fix LeaderElector issues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8697&quot;&gt;&lt;del&gt;SOLR-8697&lt;/del&gt;&lt;/a&gt;: Scope ZK election nodes by session to prevent elections from interfering with each other and other small LeaderElector improvements.&lt;/p&gt;</comment>
                            <comment id="15252751" author="jira-bot" created="Thu, 21 Apr 2016 21:11:44 +0000"  >&lt;p&gt;Commit 78bed536984dbfd4ba2f802deb58b29979d59329 in lucene-solr&apos;s branch refs/heads/branch_5_5 from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=78bed53&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=78bed53&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8697&quot; title=&quot;Fix LeaderElector issues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8697&quot;&gt;&lt;del&gt;SOLR-8697&lt;/del&gt;&lt;/a&gt;: Add synchronization around registering as leader and canceling.&lt;/p&gt;</comment>
                            <comment id="15252752" author="jira-bot" created="Thu, 21 Apr 2016 21:11:45 +0000"  >&lt;p&gt;Commit f6fca6901665cab4bea078baa4350ddc8964a2cf in lucene-solr&apos;s branch refs/heads/branch_5_5 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f6fca69&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f6fca69&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8697&quot; title=&quot;Fix LeaderElector issues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8697&quot;&gt;&lt;del&gt;SOLR-8697&lt;/del&gt;&lt;/a&gt;: Fix precommit failure&lt;/p&gt;</comment>
                            <comment id="15282958" author="jwartes" created="Fri, 13 May 2016 18:23:46 +0000"  >&lt;p&gt;Does this fix &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6498&quot; title=&quot;LeaderElector sometimes will appear multiple ephemeral nodes in the zookeeper&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6498&quot;&gt;&lt;del&gt;SOLR-6498&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="15282985" author="dragonsinth" created="Fri, 13 May 2016 18:37:42 +0000"  >&lt;p&gt;Probably so.  I think we should close that one and assume it&apos;s fixed.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12740335">SOLR-6498</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12949697">SOLR-8837</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12789290" name="OverseerTestFail.log" size="639890" author="markrmiller@gmail.com" created="Tue, 23 Feb 2016 20:00:50 +0000"/>
                            <attachment id="12789305" name="SOLR-8697-followup.patch" size="8777" author="dragonsinth" created="Tue, 23 Feb 2016 20:53:39 +0000"/>
                            <attachment id="12788725" name="SOLR-8697.patch" size="9602" author="dragonsinth" created="Fri, 19 Feb 2016 18:36:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    <customfieldvalue key="10431"><![CDATA[Important]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 27 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2t0sv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>