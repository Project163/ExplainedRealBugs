<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:11:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-17709] Fix race condition when checking distrib async cmd status</title>
                <link>https://issues.apache.org/jira/browse/SOLR-17709</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;The &lt;tt&gt;DistributedApiAsyncTracker&lt;/tt&gt; mentioned that there could be a race condition between completing an asynchronous request and checking its status. This is causing very infrequent test failures, such as: &lt;tt&gt;ReindexCollectionTest.testAbort&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The solution is to just check the ZK paths in reverse order from how they are updated.&lt;/p&gt;

&lt;p&gt;So when completing or canceling tasks, they are updated in the following order:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;tt&gt;trackedAsyncTasks.put(asyncId, ...)&lt;/tt&gt; or &lt;tt&gt;trackedAsyncTasks.remove(asyncId)&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;inFlightAsyncTasks.deleteInFlightTask(asyncId)&lt;/tt&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Therefore in &lt;tt&gt;getAsyncTaskRequestStatus(asyncId)&lt;/tt&gt;, we need to check &lt;tt&gt;inFlightAsyncTasks&lt;/tt&gt; before &lt;tt&gt;trackedAsyncTasks&lt;/tt&gt;. This means we can get a false-positive &quot;Submitted&quot; or &quot;Running&quot; result (race condition described below). But that will just lead to the client checking again at a later time, and the next time they call, &lt;tt&gt;inFlightAsyncTasks&lt;/tt&gt; will have been updated and we will get the actual response from &lt;tt&gt;trackedAsyncTasks&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Before this PR, the race condition would give us a false-negative &quot;Operation failed. Please resubmit&quot; result. (race condition described below). This would tell the client to try again, when in fact the task could have been successful. This false-negative is much worse than the false-positive described above.&lt;/p&gt;

&lt;p&gt;Race condition before this PR: (false-negative)&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;tt&gt;getAsyncTaskRequestStatus()&lt;/tt&gt; &amp;#8211; &lt;tt&gt;trackedAsyncTasks&lt;/tt&gt; is checked &amp;#8211; no response is found&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;setTaskCompleted()&lt;/tt&gt; &amp;#8211; &lt;tt&gt;trackedAsyncTasks&lt;/tt&gt; id is updated &amp;#8211; response is put into ZK&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;setTaskCompleted()&lt;/tt&gt; &amp;#8211; &lt;tt&gt;inFlightAsyncTasks&lt;/tt&gt; id is deleted &amp;#8211; asyncID is deleted from ZK&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;getAsyncTaskRequestStatus()&lt;/tt&gt; &amp;#8211; {{inFlightAsyncTasks }} is checked &amp;#8211; asyncId is not found
	&lt;ul&gt;
		&lt;li&gt;Return a failure - Assume node died because {{inFlightAsyncTasks }} ephemeral node is gone&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Race condition after this PR: (false-positive)&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;tt&gt;setTaskCompleted()&lt;/tt&gt; &amp;#8211; &lt;tt&gt;trackedAsyncTasks&lt;/tt&gt; id is updated &amp;#8211; response is put into ZK&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;getAsyncTaskRequestStatus()&lt;/tt&gt; &amp;#8211; {{inFlightAsyncTasks }} is checked &amp;#8211; asyncId is found
	&lt;ul&gt;
		&lt;li&gt;Return that the task is in progress&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;setTaskCompleted()&lt;/tt&gt; &amp;#8211; &lt;tt&gt;inFlightAsyncTasks&lt;/tt&gt; id is deleted &amp;#8211; asyncID is deleted from ZK&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="13612429">SOLR-17709</key>
            <summary>Fix race condition when checking distrib async cmd status</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="houston">Houston Putman</assignee>
                                    <reporter username="houston">Houston Putman</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 19 Mar 2025 18:38:23 +0000</created>
                <updated>Thu, 24 Jul 2025 22:50:54 +0000</updated>
                            <resolved>Wed, 19 Mar 2025 19:23:44 +0000</resolved>
                                                    <fixVersion>9.9</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="600">10m</timespent>
                                <comments>
                            <comment id="17936919" author="jira-bot" created="Wed, 19 Mar 2025 19:16:38 +0000"  >&lt;p&gt;Commit d0d4f280b6410d8996fa998620d9b6661848d1f0 in solr&apos;s branch refs/heads/main from Houston Putman&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=d0d4f280b64&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=d0d4f280b64&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17709&quot; title=&quot;Fix race condition when checking distrib async cmd status&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17709&quot;&gt;&lt;del&gt;SOLR-17709&lt;/del&gt;&lt;/a&gt;: Fix race condition when checking distrib async cmd status (#3268)&lt;/p&gt;
</comment>
                            <comment id="17936920" author="jira-bot" created="Wed, 19 Mar 2025 19:21:15 +0000"  >&lt;p&gt;Commit e51dd47d88445259d57fc63dc655aecaafecf265 in solr&apos;s branch refs/heads/branch_9x from Houston Putman&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=e51dd47d884&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=e51dd47d884&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17709&quot; title=&quot;Fix race condition when checking distrib async cmd status&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17709&quot;&gt;&lt;del&gt;SOLR-17709&lt;/del&gt;&lt;/a&gt;: Fix race condition when checking distrib async cmd status (#3268)&lt;/p&gt;

&lt;p&gt;(cherry picked from commit d0d4f280b6410d8996fa998620d9b6661848d1f0)&lt;/p&gt;</comment>
                            <comment id="18009758" author="houston" created="Thu, 24 Jul 2025 22:50:54 +0000"  >&lt;p&gt;Closing after the 9.9.0 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1uvm8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>