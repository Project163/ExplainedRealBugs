<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:45:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-14677] DIH doesnt close DataSource when import encounters errors</title>
                <link>https://issues.apache.org/jira/browse/SOLR-14677</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;DIH imports don&apos;t close DataSource&apos;s (which can hold db connections, etc.) in all cases.  Specifically, if an import runs into an unexpected error forwarding processed docs to other nodes, it will neglect to close the DataSource&apos;s when it finishes.&lt;/p&gt;

&lt;p&gt;This problem goes back to at least 7.5.  This is partially mitigated in older versions of some DataSource implementations (e.g. JdbcDataSource) by means of a &quot;finalize&quot; hook which invokes &quot;close()&quot; when the DataSource object is garbage-collected.  In practice, this means that resources might be held open longer than necessary but will be closed within a few seconds or minutes by GC.  This only helps JdbcDataSource though - all other DataSource impl&apos;s risk leaking resources. &lt;/p&gt;

&lt;p&gt;In master/9.0, which requires a minimum of Java 11 and doesn&apos;t have the finalize-hook, the connections are never cleaned up when an error is encountered during DIH.  DIH will likely be removed for the 9.0 release, but if it isn&apos;t this bug should be fixed.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13318726">SOLR-14677</key>
            <summary>DIH doesnt close DataSource when import encounters errors</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gerlowskija">Jason Gerlowski</assignee>
                                    <reporter username="gerlowskija">Jason Gerlowski</reporter>
                        <labels>
                    </labels>
                <created>Wed, 22 Jul 2020 14:17:29 +0000</created>
                <updated>Wed, 4 Nov 2020 15:21:23 +0000</updated>
                            <resolved>Thu, 29 Oct 2020 12:33:31 +0000</resolved>
                                    <version>7.5</version>
                    <version>9.0</version>
                                    <fixVersion>8.7</fixVersion>
                    <fixVersion>9.0</fixVersion>
                                    <component>contrib - DataImportHandler</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17162853" author="gerlowskija" created="Wed, 22 Jul 2020 14:39:51 +0000"  >&lt;p&gt;I have a branch &lt;a href=&quot;https://github.com/gerlowskija/lucene-solr-1/tree/jdbcdatasource_connection_leak&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; with a few edits that help reproduce the problem.&lt;/p&gt;

&lt;p&gt;What that branch has is:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;logging in JdbcDataSource.close() to record if/when it is called.&lt;/li&gt;
	&lt;li&gt;a script &quot;solr/reproduce-dih-jdbc-leak.sh&quot;, which can be run from in the solr directory to reproduce the problem.&lt;/li&gt;
	&lt;li&gt;some changes to ConcurrentUpdateHttp2SolrClient which optionally fake an IOException to trigger the DIH issue downstream.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;To reproduce the issue, run the included script from the &quot;solr&quot; directory.  It spins up two solr nodes based out of a &quot;cloud-dih&quot; example directory, and kicks off a DIH run.  When the DIH run finishes, the logs (in &lt;tt&gt;solr/example/cloud-dih/node1/logs/solr.log&lt;/tt&gt;) will be missing the line that gets printed when JdbcDataSource closes: &lt;tt&gt;In JdbcDataSource.close&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;To see the &quot;normal&quot; behavior, edit the &quot;reproduce-dih-jdbc-leak.sh&quot; script, changing the &lt;tt&gt;CAUSE_DIH_IO_ERROR&lt;/tt&gt; variable from &quot;true&quot; to &quot;false&quot;.  Following a DIH run, the logs will show that JdbcDataSource was closed correctly.&lt;/p&gt;

&lt;p&gt;For the lazy, I&apos;ve attached the log file from the DIH node from two runs: one that shows the normal good behavior and one that shows the leak when an IOError pops up during the import.&lt;/p&gt;</comment>
                            <comment id="17175901" author="gerlowskija" created="Wed, 12 Aug 2020 00:22:17 +0000"  >&lt;p&gt;I created a PR a few minutes ago that ensures that errors arising during close() operations on DIHWriter don&apos;t derail efforts to close the EntityProcessors and DataSources.&#160; Hoping to commit this in a few days, and then I&apos;ll propose it in the plugin repo I guess?&lt;/p&gt;</comment>
                            <comment id="17176256" author="epugh" created="Wed, 12 Aug 2020 10:52:52 +0000"  >&lt;p&gt;Unfortunately, that makes sense to me on the plugin repo.  In a perfect world, the plugin repo owner will see these commits and pull them over proactively.&lt;/p&gt;</comment>
                            <comment id="17177412" author="jira-bot" created="Fri, 14 Aug 2020 01:21:53 +0000"  >&lt;p&gt;Commit 216aec03a6f658f64801921e7d1c8f8c7e95626b in lucene-solr&apos;s branch refs/heads/master from Jason Gerlowski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=216aec0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=216aec0&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14677&quot; title=&quot;DIH doesnt close DataSource when import encounters errors&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14677&quot;&gt;&lt;del&gt;SOLR-14677&lt;/del&gt;&lt;/a&gt;: Always close DIH EntityProcessor/DataSource (#1741)&lt;/p&gt;

&lt;p&gt;Prior to this commit, the wrapup logic at the end of&lt;br/&gt;
DocBuilder.execute() closed out a series of DIH objects, but did so&lt;br/&gt;
in a way that an exception closing any of them resulted in the remainder&lt;br/&gt;
staying open.  This is especially problematic since Writer.close()&lt;br/&gt;
throws exceptions that DIH uses to determine the success/failure of the&lt;br/&gt;
run.&lt;/p&gt;

&lt;p&gt;In practice this caused network errors sending DIH data to other Solr&lt;br/&gt;
nodes to result in leaked JDBC connections.&lt;/p&gt;

&lt;p&gt;This commit changes DocBuilder&apos;s termination logic to handle exceptions&lt;br/&gt;
more gracefully, ensuring that errors closing a DIHWriter (for example)&lt;br/&gt;
don&apos;t prevent the closure of entity-processor and DataSource objects.&lt;/p&gt;</comment>
                            <comment id="17178047" author="jira-bot" created="Fri, 14 Aug 2020 20:20:02 +0000"  >&lt;p&gt;Commit 8bc6688e6a846451f7b94052290588c70e4dfd99 in lucene-solr&apos;s branch refs/heads/branch_8x from Jason Gerlowski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=8bc6688&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=8bc6688&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14677&quot; title=&quot;DIH doesnt close DataSource when import encounters errors&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14677&quot;&gt;&lt;del&gt;SOLR-14677&lt;/del&gt;&lt;/a&gt;: Always close DIH EntityProcessor/DataSource (#1741)&lt;/p&gt;

&lt;p&gt;Prior to this commit, the wrapup logic at the end of&lt;br/&gt;
DocBuilder.execute() closed out a series of DIH objects, but did so&lt;br/&gt;
in a way that an exception closing any of them resulted in the remainder&lt;br/&gt;
staying open.  This is especially problematic since Writer.close()&lt;br/&gt;
throws exceptions that DIH uses to determine the success/failure of the&lt;br/&gt;
run.&lt;/p&gt;

&lt;p&gt;In practice this caused network errors sending DIH data to other Solr&lt;br/&gt;
nodes to result in leaked JDBC connections.&lt;/p&gt;

&lt;p&gt;This commit changes DocBuilder&apos;s termination logic to handle exceptions&lt;br/&gt;
more gracefully, ensuring that errors closing a DIHWriter (for example)&lt;br/&gt;
don&apos;t prevent the closure of entity-processor and DataSource objects.&lt;/p&gt;</comment>
                            <comment id="17187100" author="arafalov" created="Sat, 29 Aug 2020 20:15:18 +0000"  >&lt;p&gt;Did this land before the code was spun into plugin? Because DIH is just taken out from 9.0 in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14783&quot; title=&quot;Remove DIH from 9.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14783&quot;&gt;&lt;del&gt;SOLR-14783&lt;/del&gt;&lt;/a&gt;. So, issue can be closed either way.&lt;/p&gt;</comment>
                            <comment id="17187798" author="gerlowskija" created="Mon, 31 Aug 2020 15:22:15 +0000"  >&lt;p&gt;No, this bug fix was very recent - well after the plugin was split out.  I opened a PR for the plugin &lt;a href=&quot;https://github.com/rohitbemax/dataimporthandler/pull/7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, but can&apos;t merge it because I don&apos;t have write access.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ichattopadhyaya&quot; class=&quot;user-hover&quot; rel=&quot;ichattopadhyaya&quot;&gt;ichattopadhyaya&lt;/a&gt; mentioned being willing to help review in Slack, but he may have gotten busy. Hopefully someone is able to merge it in.&lt;/p&gt;</comment>
                            <comment id="17222200" author="epugh" created="Wed, 28 Oct 2020 14:32:23 +0000"  >&lt;p&gt;I noticed that your PR has been merged.   Does that mean this can be closed now?&lt;/p&gt;</comment>
                            <comment id="17222865" author="gerlowskija" created="Thu, 29 Oct 2020 12:33:31 +0000"  >&lt;p&gt;Sure, thanks for the reminder.  There&apos;s clearly some warts in the process while this code is shared across two repos, issue trackers, etc.  Though seemingly they won&apos;t be longterm concerns.&lt;/p&gt;

&lt;p&gt;Closed.&lt;/p&gt;</comment>
                            <comment id="17226103" author="atri" created="Wed, 4 Nov 2020 15:21:22 +0000"  >&lt;p&gt;Closing after the 8.7.0 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13008173" name="error-solr.log" size="51824" author="gerlowskija" created="Wed, 22 Jul 2020 14:41:18 +0000"/>
                            <attachment id="13008174" name="no-error-solr.log" size="36237" author="gerlowskija" created="Wed, 22 Jul 2020 14:41:18 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 1 week, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0h3bs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>