<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:43:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-5354] Distributed sort is broken with CUSTOM FieldType</title>
                <link>https://issues.apache.org/jira/browse/SOLR-5354</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;We added a custom field type to allow an indexed binary field type that supports search (exact match), prefix search, and sort as unsigned bytes lexicographical compare. For sort, BytesRef&apos;s UTF8SortedAsUnicodeComparator accomplishes what we want, and even though the name of the comparator mentions UTF8, it doesn&apos;t actually assume so and just does byte-level operation, so it&apos;s good. However, when we do this across different nodes, we run into an issue where in QueryComponent.doFieldSortValues:&lt;/p&gt;

&lt;p&gt;          // Must do the same conversion when sorting by a&lt;br/&gt;
          // String field in Lucene, which returns the terms&lt;br/&gt;
          // data as BytesRef:&lt;br/&gt;
          if (val instanceof BytesRef) &lt;/p&gt;
{
            UnicodeUtil.UTF8toUTF16((BytesRef)val, spare);
            field.setStringValue(spare.toString());
            val = ft.toObject(field);
          }

&lt;p&gt;UnicodeUtil.UTF8toUTF16 is called on our byte array,which isn&apos;t actually UTF8. I did a hack where I specified our own field comparator to be ByteBuffer based to get around that instanceof check, but then the field value gets transformed into BYTEARR in JavaBinCodec, and when it&apos;s unmarshalled, it gets turned into byte[]. Then, in QueryComponent.mergeIds, a ShardFieldSortedHitQueue is constructed with ShardDoc.getCachedComparator, which decides to give me comparatorNatural in the else of the TODO for CUSTOM, which barfs because byte[] are not Comparable...&lt;/p&gt;

&lt;p&gt;From Chris Hostetter:&lt;/p&gt;

&lt;p&gt;I&apos;m not very familiar with the distributed sorting code, but based on your&lt;br/&gt;
comments, and a quick skim of the functions you pointed to, it definitely&lt;br/&gt;
seems like there are two problems here for people trying to implement&lt;br/&gt;
custom sorting in custom FieldTypes...&lt;/p&gt;

&lt;p&gt;1) QueryComponent.doFieldSortValues - this definitely seems like it should&lt;br/&gt;
be based on the FieldType, not an &quot;instanceof BytesRef&quot; check (oddly: the&lt;br/&gt;
comment event suggestsion that it should be using the FieldType&apos;s&lt;br/&gt;
indexedToReadable() method &amp;#8211; but it doesn&apos;t do that.  If it did, then&lt;br/&gt;
this part of hte logic should work for you as long as your custom&lt;br/&gt;
FieldType implemented indexedToReadable in a sane way.&lt;/p&gt;

&lt;p&gt;2) QueryComponent.mergeIds - that TODO definitely looks like a gap that&lt;br/&gt;
needs filled.  I&apos;m guessing the sanest thing to do in the CUSTOM case&lt;br/&gt;
would be to ask the FieldComparatorSource (which should be coming from the&lt;br/&gt;
SortField that the custom FieldType produced) to create a FieldComparator&lt;br/&gt;
(via newComparator - the numHits &amp;amp; sortPos could be anything) and then&lt;br/&gt;
wrap that up in a Comparator facade that delegates to&lt;br/&gt;
FieldComparator.compareValues&lt;/p&gt;

&lt;p&gt;That way a custom FieldType could be in complete control of the sort&lt;br/&gt;
comparisons (even when merging ids).&lt;/p&gt;

&lt;p&gt;...But as i said: i may be missing something, i&apos;m not super familia with&lt;br/&gt;
that code.  Please try it out and let us know if thta works &amp;#8211; either way&lt;br/&gt;
please open a Jira pointing out the problems trying to implement&lt;br/&gt;
distributed sorting in a custom FieldType.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12674031">SOLR-5354</key>
            <summary>Distributed sort is broken with CUSTOM FieldType</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sarowe">Steven Rowe</assignee>
                                    <reporter username="mewmewball">Jessica Cheng Mallet</reporter>
                        <labels>
                            <label>custom</label>
                            <label>query</label>
                            <label>sort</label>
                    </labels>
                <created>Wed, 16 Oct 2013 00:39:32 +0000</created>
                <updated>Mon, 9 May 2016 18:46:13 +0000</updated>
                            <resolved>Tue, 3 Dec 2013 16:57:40 +0000</resolved>
                                    <version>4.4</version>
                    <version>4.5</version>
                    <version>4.6</version>
                    <version>6.0</version>
                                    <fixVersion>4.7</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>SearchComponents - other</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13796289" author="mewmewball" created="Wed, 16 Oct 2013 01:15:19 +0000"  >&lt;p&gt;I think calling indexedToReadable() in QueryComponent.doFieldSortValues won&apos;t actually help here because it&apos;s trying to get the actual Object of the fields, not the readable String representation. If we do go with sending &quot;sort_values&quot; as readable strings, on the other side when QueryComponent.mergeIds is called, it&apos;ll need to take care of translating all readable strings to the actual Objects, which I&apos;m not sure if there&apos;s an easy way to do.&lt;/p&gt;

&lt;p&gt;The safest thing/ least change is probably to check the sort field type instead of using instanceof in QueryComponent.doFieldSortValues.&lt;/p&gt;</comment>
                            <comment id="13807457" author="steve_rowe" created="Mon, 28 Oct 2013 23:14:14 +0000"  >&lt;p&gt;Patch fixing the problem.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;QueryComponent.doFieldSortValues()&lt;/tt&gt; delegates to new method &lt;tt&gt;SortField.toExternal()&lt;/tt&gt;, which serializes according to the sort field type, in the CUSTOM case via new method &lt;tt&gt;FieldComparatorSource.toExternal()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;ShardFieldSortedHitQueue&lt;/tt&gt; uses &lt;tt&gt;ShardComparator.sortVal()&lt;/tt&gt;, which uses new method &lt;tt&gt;SortField.toInternal()&lt;/tt&gt; to convert the external value to the appropriate object, in the CUSTOM case via new method &lt;tt&gt;FieldComparatorSource.toInternal()&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="13808131" author="steve_rowe" created="Tue, 29 Oct 2013 16:12:49 +0000"  >&lt;p&gt;If there are no objections I&apos;ll commit this tomorrow.&lt;/p&gt;</comment>
                            <comment id="13808147" author="rcmuir" created="Tue, 29 Oct 2013 16:23:16 +0000"  >&lt;p&gt;I think there are a couple issues to address first at least in the lucene part.&lt;/p&gt;

&lt;p&gt;Can we please not have the Object/Object stuff in FieldComparatorSource? This is wrong: FieldComparator already has a generic type so I don&apos;t understand the need to discard type safety.&lt;/p&gt;

&lt;p&gt;The unicode conversion for String/String_VAL is incorrect and should not exist: despite the name, these types can be any bytes.&lt;/p&gt;</comment>
                            <comment id="13808160" author="rcmuir" created="Tue, 29 Oct 2013 16:31:54 +0000"  >&lt;p&gt;As a concrete example the CollationField and ICUCollationField sort with String/String_VAL comparators but contain non-unicode bytes.&lt;/p&gt;

&lt;p&gt;These currently do not work distributed today either (which I would love to see fixed on this issue).&lt;/p&gt;</comment>
                            <comment id="13811422" author="steve_rowe" created="Fri, 1 Nov 2013 16:39:12 +0000"  >&lt;p&gt;Thanks for the review Robert.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Can we please not have the Object/Object stuff in FieldComparatorSource? This is wrong: FieldComparator already has a generic type so I don&apos;t understand the need to discard type safety.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m not sure what you have in mind - do you think FieldComparatorSource should be generified? In this case I think each extending class will need to provide an implementation for these methods, since there isn&apos;t a sensible way to provide a default implementation of conversion to/from the generic type.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The unicode conversion for String/String_VAL is incorrect and should not exist: despite the name, these types can be any bytes&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is the status quo right now - the patch just keeps that in place.  But I agree.  I think the issue is non-binary (XML) serialization, for which UTF-8 is safe, but arbitrary binary is not.  Serializing all STRING/STRING_VAL as Base64 seems wasteful in the general case.&lt;/p&gt;

&lt;p&gt;Relatedly, looks like there&apos;s an orphaned &lt;tt&gt;SortField.Type.BYTES&lt;/tt&gt; (orphaned in that it&apos;s not handled in lots of places) - I guess this should go away?&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;As a concrete example the CollationField and ICUCollationField sort with String/String_VAL comparators but contain non-unicode bytes.&lt;/p&gt;

&lt;p&gt;These currently do not work distributed today either (which I would love to see fixed on this issue).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m working on a distributed version of the Solr (icu) collation tests.  Once I get that failing, I&apos;ll be able to test potential solutions.&lt;/p&gt;</comment>
                            <comment id="13811432" author="rcmuir" created="Fri, 1 Nov 2013 16:48:31 +0000"  >&lt;blockquote&gt;
&lt;p&gt;This is the status quo right now - the patch just keeps that in place. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No its not: its a bug in solr. This patch moves that bug into Lucene. &lt;/p&gt;

&lt;p&gt;Lucene&apos;s APIs here work correctly on any bytes today.&lt;/p&gt;</comment>
                            <comment id="13811433" author="rcmuir" created="Fri, 1 Nov 2013 16:50:41 +0000"  >&lt;blockquote&gt;
&lt;p&gt;I think the issue is non-binary (XML) serialization, for which UTF-8 is safe, but arbitrary binary is not. Serializing all STRING/STRING_VAL as Base64 seems wasteful in the general case.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is all solr stuff. I don&apos;t think it makes sense to move that logic into lucene, let the user deal with this. They might not be using XML at all: maybe thrift or avro or something else.&lt;/p&gt;

&lt;p&gt;Why not just add serialize/deserialize methods to solr&apos;s FieldType.java? It seems like the obvious place. &lt;/p&gt;</comment>
                            <comment id="13811450" author="mewmewball" created="Fri, 1 Nov 2013 17:03:03 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Why not just add serialize/deserialize methods to solr&apos;s FieldType.java? It seems like the obvious place.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;When SortField&apos;s are deserialized on the receiving end, it&apos;s no longer clear which FieldType the field came from. If the deserialization method depends on FieldType, the node responsible for the merge must also have the schema loaded, which might not be the case in SolrCloud. Maybe solr needs its own SortField too then?&lt;/p&gt;</comment>
                            <comment id="13811461" author="rcmuir" created="Fri, 1 Nov 2013 17:10:09 +0000"  >&lt;blockquote&gt;
&lt;p&gt;When SortField&apos;s are deserialized on the receiving end, it&apos;s no longer clear which FieldType the field came from. If the deserialization method depends on FieldType, the node responsible for the merge must also have the schema loaded, which might not be the case in SolrCloud.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Then where is it getting a comparator from? I don&apos;t understand how changing a lucene API solves this problem.&lt;/p&gt;</comment>
                            <comment id="13811463" author="rcmuir" created="Fri, 1 Nov 2013 17:12:50 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Maybe solr needs its own SortField too then?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;OK I see it, I think solr should fix its own apis here? It could add FieldType[] to SortSpec or something like that.&lt;/p&gt;</comment>
                            <comment id="13830238" author="hossman" created="Fri, 22 Nov 2013 19:07:49 +0000"  >&lt;p&gt;I&apos;ve been looking into Solr&apos;s distributed sorting code more and more as part of my investigating into &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5463&quot; title=&quot;Provide cursor/token based &amp;quot;searchAfter&amp;quot; support that works with arbitrary sorting (ie: &amp;quot;deep paging&amp;quot;)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5463&quot;&gt;&lt;del&gt;SOLR-5463&lt;/del&gt;&lt;/a&gt; and i spoke breifly with sarowe off line about the overlap.&lt;/p&gt;

&lt;p&gt;I think the problems with CUSTOM distributed sorting is really just a subset of the larger weirdness with the assumptions Solr makes in general about how it can do distributed sorting and how it can de/serialize the sort values when merging hte results from the multiple shards.&lt;/p&gt;

&lt;p&gt;I think my earlier suggestion (in email that jessica quoted in the issue summary) about using methods on the FieldType (like indexedToReadable and toObject) to ensure we safely de/serialize the sort values are still the right way to go &amp;#8211; we have to ensure that no matter what strange object an arbitrary objects are used by a FieldComparator, we can safely serialize it.   But i&apos;m not longer convinced re-using those existing methods makes sense &amp;#8211; because the sort values used by a FieldType&apos;s FieldComparator may not map directly to the &quot;end user&quot; representation of the value (ie: TriedDateField sorts as &quot;long&quot;, but toObject returns &quot;Date&quot;; String fields sort on BytesRefs; Custom classes sort on who-knows-what, etc...)&lt;/p&gt;

&lt;p&gt;I think the best solution would be something like:&lt;/p&gt;


&lt;ul&gt;
	&lt;li&gt;move the toExternal/toInternal concept in the existing patch out of FieldComparatorSource and into Solr&apos;s FieldType as methods clearly ment to be very speciic to sorting (ie: &quot;marshalSortValue&quot; and &quot;unmarshalSortValue&quot;)&amp;gt;&lt;/li&gt;
	&lt;li&gt;change the fsv=true logic on shards to use marshalSortValue for any SortField that is on a field (if it&apos;s score or a function it will be a sinple numeric and already safe to serialize over the wire)&lt;/li&gt;
	&lt;li&gt;change the mergeIds logic on the coordinator node to explicitly use unmarshalSortValue and then use the &lt;em&gt;actual&lt;/em&gt; FieldComparator associated with each SortField instead of the hooky assumptions currently being made in ShardFieldSortedHitQueue.getCachedComparator about using things like &quot;comparatorNatural&quot;&lt;/li&gt;
&lt;/ul&gt;


&lt;hr /&gt;

&lt;p&gt;Other misc comments...&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;If the deserialization method depends on FieldType, the node responsible for the merge must also have the schema loaded, which might not be the case in SolrCloud.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s already a requirement in SolrCloud - the coordnator node merging results and writing them back to the client already has to have the same schema.  (If it didn&apos;t a custom FieldType with a custom FieldComparator could never work, because there would be now way at all to know what order things should go in)&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think solr should fix its own apis here? It could add FieldType[] to SortSpec or something like that.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m not sure why that would help?  We can already ask each SortField for it&apos;s getField() and then look that up in the Schema.  The crux of the problem really seems to be: naive assumptions in the distributed sorting code about how to safely send sort values over the wire; and what comparator to use when sorting those values.&lt;/p&gt;</comment>
                            <comment id="13830727" author="rcmuir" created="Sat, 23 Nov 2013 18:08:20 +0000"  >&lt;blockquote&gt;
&lt;p&gt;I&apos;m not sure why that would help? We can already ask each SortField for it&apos;s getField() and then look that up in the Schema. The crux of the problem really seems to be: naive assumptions in the distributed sorting code about how to safely send sort values over the wire; and what comparator to use when sorting those values.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;My point is that the serialization/deserialization doesn&apos;t really belong in the lucene comparator API, thats all. I agree with your proposed solution...&lt;/p&gt;</comment>
                            <comment id="13832097" author="steve_rowe" created="Tue, 26 Nov 2013 00:05:51 +0000"  >&lt;p&gt;Patch moving de/serialization to Solr&apos;s FieldType according to Hoss&apos;s outline - no Lucene classes are modified in this version.&lt;/p&gt;

&lt;p&gt;All Solr tests pass.&lt;/p&gt;

&lt;p&gt;I think this should also fix distributed (ICU)CollationField - I&apos;m working on a test.&lt;/p&gt;</comment>
                            <comment id="13832268" author="rcmuir" created="Tue, 26 Nov 2013 03:24:20 +0000"  >&lt;p&gt;This looks great Steve, thanks.&lt;/p&gt;</comment>
                            <comment id="13833312" author="hossman" created="Wed, 27 Nov 2013 01:26:49 +0000"  >&lt;p&gt;Steve: looks great for the most part.&lt;/p&gt;

&lt;p&gt;a few comments / questions...&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;call me paranoid, but i really dislike distrib tests that &lt;b&gt;only&lt;/b&gt; use the query() method to ensure that the distrib response is the same as the control response &amp;#8211; could we please add some assertions that use queryServer() to prove the docs are coming back in the right order in the distrib test?&lt;/li&gt;
	&lt;li&gt;the test should really sanity check that multi-level sorts (eg: &quot;payload asc, id desc&quot;) are working properly&lt;/li&gt;
	&lt;li&gt;we should be really clear &amp;amp; careful in the javadocs for FieldType.marshalSortValue and FieldType.unmarshalSortValue &amp;#8211; in your patch they refer to &quot;a value of this FieldType&quot; but that&apos;s not actually what they operate on.  They operate on the values used by the FieldComparator returned by the SortField for this FieldType (ie: SortableDoubleField&apos;s toObject returns a Double, but the marshal method operates on ByteRef)&lt;/li&gt;
	&lt;li&gt;I&apos;m confused why we still need comparatorNatural() and it&apos;s use for REWRITEABLE.  Why not actually rewrite() the SortField using the local IndexSearcher and then wrap the rewritten SortField&apos;s FieldComparator using comparatorFieldComparator() just like any other SortField? Since we&apos;re only ever going to compare the raw values on the coordinator it shouldn&apos;t matter if we rewrite in terms of the local IndexSearcher - it&apos;s the best we can do, and that seems safer then assuming REWRITABLE == function and trusting comparatorNatural.  (ie: consider someone who writes a custom FieldType that uses REWRITABLE)&lt;/li&gt;
	&lt;li&gt;don&apos;t the marshal methods in StrField, TextField, and CollationField need null checks (for the possibilities of docs w/o a value in the sort field?)&lt;/li&gt;
	&lt;li&gt;do we even have any existing tests of distributed sorting on strings &amp;amp; numerics using sortMisstingLast / sortMissingFirst to be sure we don&apos;t break that?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13834407" author="steve_rowe" created="Thu, 28 Nov 2013 00:41:38 +0000"  >&lt;p&gt;Thanks Robert and Hoss for the reviews.&lt;/p&gt;

&lt;p&gt;New patch incorporating Hoss&apos;s suggestions, details below:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;call me paranoid, but i really dislike distrib tests that only use the query() method to ensure that the distrib response is the same as the control response &#8211; could we please add some assertions that use queryServer() to prove the docs are coming back in the right order in the distrib test?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;As Hoss suggested on #solr IRC, I changed &lt;tt&gt;BasicDistributedSearchTestCase#query()&lt;/tt&gt; to return the &lt;tt&gt;QueryResponse&lt;/tt&gt; (instead of void), so that &lt;tt&gt;queryServer()&lt;/tt&gt; doesn&apos;t have to be called separately from the random server vs. control check that &lt;tt&gt;query()&lt;/tt&gt; performs.&lt;/p&gt;

&lt;p&gt;I then added a new method to &lt;tt&gt;SolrTestCaseJ4&lt;/tt&gt;: &lt;tt&gt;assertFieldValues(doclist,fieldName,values)&lt;/tt&gt;, and now check that &lt;tt&gt;id&lt;/tt&gt; field values are in the expected order using this new method.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;the test should really sanity check that multi-level sorts (eg: &quot;payload asc, id desc&quot;) are working properly&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Added.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;we should be really clear &amp;amp; careful in the javadocs for FieldType.marshalSortValue and FieldType.unmarshalSortValue &#8211; in your patch they refer to &quot;a value of this FieldType&quot; but that&apos;s not actually what they operate on. They operate on the values used by the FieldComparator returned by the SortField for this FieldType (ie: SortableDoubleField&apos;s toObject returns a Double, but the marshal method operates on ByteRef)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Reworded.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;m confused why we still need comparatorNatural() and it&apos;s use for REWRITEABLE. Why not actually rewrite() the SortField using the local IndexSearcher and then wrap the rewritten SortField&apos;s FieldComparator using comparatorFieldComparator() just like any other SortField? Since we&apos;re only ever going to compare the raw values on the coordinator it shouldn&apos;t matter if we rewrite in terms of the local IndexSearcher - it&apos;s the best we can do, and that seems safer then assuming REWRITABLE == function and trusting comparatorNatural. (ie: consider someone who writes a custom FieldType that uses REWRITABLE)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Fixed - &lt;tt&gt;comparatorNatural()&lt;/tt&gt; is gone.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;don&apos;t the marshal methods in StrField, TextField, and CollationField need null checks (for the possibilities of docs w/o a value in the sort field?)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, they do, &lt;tt&gt;ICUCollatonField&lt;/tt&gt; too - added.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;do we even have any existing tests of distributed sorting on strings &amp;amp; numerics using sortMisstingLast / sortMissingFirst to be sure we don&apos;t break that?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No, I couldn&apos;t find any, so I added tests for &lt;tt&gt;sortMissingFirst&lt;/tt&gt; and &lt;tt&gt;sortMissingLast&lt;/tt&gt; on both &lt;tt&gt;SortableIntField&lt;/tt&gt; and &lt;tt&gt;StringField&lt;/tt&gt; on the existing &lt;tt&gt;TestDistributedSearch&lt;/tt&gt; class.  I&apos;ll add testing for a Trie field too before I commit, not in the patch yet.&lt;/p&gt;</comment>
                            <comment id="13835075" author="steve_rowe" created="Thu, 28 Nov 2013 21:00:03 +0000"  >&lt;p&gt;I added a Trie long field to the sort missing first/last tests, and moved them from the existing &lt;tt&gt;TestDistributedSearch&lt;/tt&gt; class to a new class &lt;tt&gt;TestDistributedMissingSort&lt;/tt&gt; with its own dedicated minimal schema file.&lt;/p&gt;

&lt;p&gt;All solr tests pass, and &lt;tt&gt;ant precommit&lt;/tt&gt; passes.&lt;/p&gt;

&lt;p&gt;Committing shortly.&lt;/p&gt;

&lt;p&gt;I&apos;ll make a separate issue for testing distributed collation.&lt;/p&gt;</comment>
                            <comment id="13835077" author="jira-bot" created="Thu, 28 Nov 2013 21:00:30 +0000"  >&lt;p&gt;Commit 1546457 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=steve_rowe&quot; class=&quot;user-hover&quot; rel=&quot;steve_rowe&quot;&gt;steve_rowe&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1546457&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1546457&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5354&quot; title=&quot;Distributed sort is broken with CUSTOM FieldType&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5354&quot;&gt;&lt;del&gt;SOLR-5354&lt;/del&gt;&lt;/a&gt;: Distributed sort is broken with CUSTOM FieldType&lt;/p&gt;</comment>
                            <comment id="13835081" author="jira-bot" created="Thu, 28 Nov 2013 21:29:11 +0000"  >&lt;p&gt;Commit 1546461 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=steve_rowe&quot; class=&quot;user-hover&quot; rel=&quot;steve_rowe&quot;&gt;steve_rowe&lt;/a&gt; in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1546461&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1546461&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5354&quot; title=&quot;Distributed sort is broken with CUSTOM FieldType&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5354&quot;&gt;&lt;del&gt;SOLR-5354&lt;/del&gt;&lt;/a&gt;: Distributed sort is broken with CUSTOM FieldType (merged trunk r1546457)&lt;/p&gt;</comment>
                            <comment id="13835082" author="steve_rowe" created="Thu, 28 Nov 2013 21:29:22 +0000"  >&lt;p&gt;Committed to trunk and branch_4x.&lt;/p&gt;</comment>
                            <comment id="13835397" author="jira-bot" created="Fri, 29 Nov 2013 14:37:02 +0000"  >&lt;p&gt;Commit 1546571 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rcmuir&quot; class=&quot;user-hover&quot; rel=&quot;rcmuir&quot;&gt;rcmuir&lt;/a&gt; in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1546571&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1546571&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5354&quot; title=&quot;Distributed sort is broken with CUSTOM FieldType&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5354&quot;&gt;&lt;del&gt;SOLR-5354&lt;/del&gt;&lt;/a&gt;: don&apos;t try to write docvalues with 3.x codec in these tests&lt;/p&gt;</comment>
                            <comment id="13835434" author="jira-bot" created="Fri, 29 Nov 2013 16:03:22 +0000"  >&lt;p&gt;Commit 1546589 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=steve_rowe&quot; class=&quot;user-hover&quot; rel=&quot;steve_rowe&quot;&gt;steve_rowe&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1546589&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1546589&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5354&quot; title=&quot;Distributed sort is broken with CUSTOM FieldType&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5354&quot;&gt;&lt;del&gt;SOLR-5354&lt;/del&gt;&lt;/a&gt;: fix attribution&lt;/p&gt;</comment>
                            <comment id="13835435" author="jira-bot" created="Fri, 29 Nov 2013 16:04:49 +0000"  >&lt;p&gt;Commit 1546591 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=steve_rowe&quot; class=&quot;user-hover&quot; rel=&quot;steve_rowe&quot;&gt;steve_rowe&lt;/a&gt; in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1546591&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1546591&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5354&quot; title=&quot;Distributed sort is broken with CUSTOM FieldType&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5354&quot;&gt;&lt;del&gt;SOLR-5354&lt;/del&gt;&lt;/a&gt;: fix attribution (merged trunk r1546589)&lt;/p&gt;</comment>
                            <comment id="13835891" author="hossman" created="Sat, 30 Nov 2013 23:05:15 +0000"  >&lt;p&gt;Looking further at this as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5463&quot; title=&quot;Provide cursor/token based &amp;quot;searchAfter&amp;quot; support that works with arbitrary sorting (ie: &amp;quot;deep paging&amp;quot;)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5463&quot;&gt;&lt;del&gt;SOLR-5463&lt;/del&gt;&lt;/a&gt; I realized that this change introduces a new bug in some edge cases of sorting on functions.  The easiest way to reproduce this is to add a catchall dynamic field to the example schema.xml...&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&amp;lt;dynamicField name=&quot;*&quot; type=&quot;ignored&quot; multiValued=&quot;true&quot; /&amp;gt;&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;..and then attempt a distributed sort on a function...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://localhost:8983/solr/select?q=*:*&amp;amp;sort=sum%28popularity,price%29+desc&amp;amp;shards=localhost:8983/solr&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8983/solr/select?q=*:*&amp;amp;sort=sum%28popularity,price%29+desc&amp;amp;shards=localhost:8983/solr&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(But the problem can be reproduced in more sublte ways &amp;#8211; notably any prefix based dynamicField that is also a prefix of a function &amp;#8211; for example &lt;tt&gt;&quot;s*&quot;&lt;/tt&gt; or {{&quot;currency*&quot;} as dynamicFields)&lt;/p&gt;

&lt;p&gt;The problem comes about because of a mistaken impression I had when i made this comment above...&lt;/p&gt;

&lt;blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I think solr should fix its own apis here? It could add FieldType[] to SortSpec or something like that.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m not sure why that would help? We can already ask each SortField for it&apos;s getField() and then look that up in the Schema.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;My mistake was in thinking that SortField.getField() would always be null unless the Sort was on a &quot;real&quot; field &amp;#8211; but SortField&apos;s built arround functions have a getField method that returns a string representation of the function.  (This is behavior is currently required for the distributed sorting code when serializing/deserializing the list of sort values from each shard in order to know which values belong to which SortField).&lt;/p&gt;

&lt;p&gt;In the past, using SortField.getField() to ask IndexSchema for a FieldType was a rare occurance driven by the runtime type of the value found &amp;#8211; the FieldType found was never used unless the runtime sort value was a String, so it was never a problem if a dynamicField pattern matched a sort function string since they never returned Strings.  But now wit hthis new code, where we use the FieldType&apos;s marshalling methods for any valid field, it can cause problems.&lt;/p&gt;

&lt;p&gt;I think rmuir&apos;s suggestion is spot on: When parsing the SortSpec we need to keep track of the FieldType at a minimum &amp;#8211; but it&apos;s just as easy to keep track of the SchemaField itself.&lt;/p&gt;

&lt;p&gt;I&apos;ve got a patch where I tweaked sarowe&apos;s new test to demonstrate the bug and then fix it by having SortSpec keep track of a List&amp;lt;SchemaField&amp;gt; that corrisponds one-to-one with the SortFields.  It&apos;s a bit hairy, but it works.&lt;/p&gt;</comment>
                            <comment id="13835893" author="hossman" created="Sat, 30 Nov 2013 23:05:44 +0000"  >
&lt;p&gt;Steve: could you take a look at this patch and let me know what you think?  &lt;/p&gt;

&lt;p&gt;Feel free to go ahead and commit if you think this looks ok, but if you have concerns and think we should go a different direction for the fix you certainly won&apos;t hurt my feelings.&lt;/p&gt;</comment>
                            <comment id="13837786" author="jira-bot" created="Tue, 3 Dec 2013 15:23:01 +0000"  >&lt;p&gt;Commit 1547430 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=steve_rowe&quot; class=&quot;user-hover&quot; rel=&quot;steve_rowe&quot;&gt;steve_rowe&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1547430&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1547430&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5354&quot; title=&quot;Distributed sort is broken with CUSTOM FieldType&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5354&quot;&gt;&lt;del&gt;SOLR-5354&lt;/del&gt;&lt;/a&gt;: applying hoss&apos;s patch to fix function edge case in distributed sort&lt;/p&gt;</comment>
                            <comment id="13837888" author="jira-bot" created="Tue, 3 Dec 2013 16:46:36 +0000"  >&lt;p&gt;Commit 1547473 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=steve_rowe&quot; class=&quot;user-hover&quot; rel=&quot;steve_rowe&quot;&gt;steve_rowe&lt;/a&gt; in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1547473&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1547473&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5354&quot; title=&quot;Distributed sort is broken with CUSTOM FieldType&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5354&quot;&gt;&lt;del&gt;SOLR-5354&lt;/del&gt;&lt;/a&gt;: applying hoss&apos;s patch to fix function edge case in distributed sort (merged trunk r1547430)&lt;/p&gt;</comment>
                            <comment id="13837900" author="steve_rowe" created="Tue, 3 Dec 2013 16:57:40 +0000"  >&lt;p&gt;committed Hoss&apos;s patch to trunk and branch_4x&lt;/p&gt;</comment>
                            <comment id="13872841" author="jira-bot" created="Wed, 15 Jan 2014 23:58:52 +0000"  >&lt;p&gt;Commit 1558618 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rcmuir&quot; class=&quot;user-hover&quot; rel=&quot;rcmuir&quot;&gt;rcmuir&lt;/a&gt; in branch &apos;dev/branches/lucene539399&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1558618&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1558618&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-5399&quot; title=&quot;PagingFieldCollector is very slow with String fields&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LUCENE-5399&quot;&gt;&lt;del&gt;LUCENE-5399&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5354&quot; title=&quot;Distributed sort is broken with CUSTOM FieldType&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5354&quot;&gt;&lt;del&gt;SOLR-5354&lt;/del&gt;&lt;/a&gt;: fix distributed grouping to marshal/unmarshal sort values properly&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12679856">SOLR-5463</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12701913">SOLR-5875</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12616309" name="SOLR-5354.patch" size="74364" author="sarowe" created="Thu, 28 Nov 2013 21:00:03 +0000"/>
                            <attachment id="12616163" name="SOLR-5354.patch" size="69397" author="sarowe" created="Thu, 28 Nov 2013 00:41:38 +0000"/>
                            <attachment id="12615734" name="SOLR-5354.patch" size="45828" author="sarowe" created="Tue, 26 Nov 2013 00:05:51 +0000"/>
                            <attachment id="12610716" name="SOLR-5354.patch" size="38768" author="sarowe" created="Mon, 28 Oct 2013 23:14:14 +0000"/>
                            <attachment id="12616448" name="SOLR-5354__fix_function_edge_case.patch" size="28274" author="hossman" created="Sat, 30 Nov 2013 23:05:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>353654</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 44 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1oz1j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>353946</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>