<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:21:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-10365] Collection re-creation fails if previous collection creation had failed</title>
                <link>https://issues.apache.org/jira/browse/SOLR-10365</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Steps to reproduce:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Create collection using a bad configset that has some errors, due to which collection creation fails.&lt;/li&gt;
	&lt;li&gt;Now, create a collection using the same name, but a good configset. This fails sometimes (about 25-30% of the times, according to my rough estimate).&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Here&apos;s what happens during the second step (can be seen from stacktrace below):&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;In CoreContainer&apos;s create(CoreDescriptor, boolean, boolean), there&apos;s a line {{        zkSys.getZkController().preRegister(dcore);}}.&lt;/li&gt;
	&lt;li&gt;This calls ZkController&apos;s publish(), which in turn calls CoreContainer&apos;s getCore() method. This call &lt;b&gt;should&lt;/b&gt; return null (since previous attempt of core creation didn&apos;t succeed). But, it throws the exception associated with the previous failure.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Here&apos;s the stack trace for the same.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Caused by: org.apache.solr.common.SolrException: SolrCore &lt;span class=&quot;code-quote&quot;&gt;&apos;newcollection2_shard1_replica1&apos;&lt;/span&gt; is not available due to init failure: blahblah
	at org.apache.solr.core.CoreContainer.getCore(CoreContainer.java:1312)
	at org.apache.solr.cloud.ZkController.publish(ZkController.java:1225)
	at org.apache.solr.cloud.ZkController.preRegister(ZkController.java:1399)
	at org.apache.solr.core.CoreContainer.create(CoreContainer.java:945)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;While working on &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6736&quot; title=&quot;A collections-like request handler to manage solr configurations on zookeeper&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6736&quot;&gt;&lt;del&gt;SOLR-6736&lt;/del&gt;&lt;/a&gt;, I ran into this (nasty?) issue. I&apos;ll try to isolate this into a standalone test that demonstrates this issue. Otherwise, as of now, this can be seen in the &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6736&quot; title=&quot;A collections-like request handler to manage solr configurations on zookeeper&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6736&quot;&gt;&lt;del&gt;SOLR-6736&lt;/del&gt;&lt;/a&gt;&apos;s testUploadWithScriptUpdateProcessor() test (which tries to re-create the collection, but sometimes fails).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13059226">SOLR-10365</key>
            <summary>Collection re-creation fails if previous collection creation had failed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ichattopadhyaya">Ishan Chattopadhyaya</assignee>
                                    <reporter username="ichattopadhyaya">Ishan Chattopadhyaya</reporter>
                        <labels>
                    </labels>
                <created>Sun, 26 Mar 2017 16:52:41 +0000</created>
                <updated>Sat, 8 Jun 2019 15:30:34 +0000</updated>
                            <resolved>Fri, 21 Apr 2017 06:25:36 +0000</resolved>
                                                    <fixVersion>6.5</fixVersion>
                    <fixVersion>7.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15942373" author="ichattopadhyaya" created="Sun, 26 Mar 2017 17:59:54 +0000"  >&lt;p&gt;Here&apos;s a patch that fixes this situation.&lt;/p&gt;</comment>
                            <comment id="15942825" author="noble.paul" created="Mon, 27 Mar 2017 08:24:36 +0000"  >&lt;p&gt;LGTM&lt;/p&gt;

&lt;p&gt;BUt how can we test this?&lt;/p&gt;</comment>
                            <comment id="15945444" author="ichattopadhyaya" created="Tue, 28 Mar 2017 16:01:10 +0000"  >&lt;p&gt;Thanks for your review, Noble.&lt;/p&gt;

&lt;p&gt;I think what is happening is the following:&lt;/p&gt;

&lt;p&gt;How does a failed collection get cleaned up?&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;At CoreContainer&apos;s create(CoreDescriptor,boolean,boolean) method, there&apos;s a preRegister step. This publishes the core as DOWN before even attempting to initialize the core.&lt;/li&gt;
	&lt;li&gt;When there&apos;s a failure to initialize the core, the CoreContainer&apos;s coreInitFailures map gets populated with the exception.&lt;/li&gt;
	&lt;li&gt;At OCMH, when there&apos;s a failure with the CreateCollection command, an attempt to clean up is performed. This actually calls DELETE, which in turn calls UNLOAD core admin command from DeleteCollectionCmd.java.&lt;/li&gt;
	&lt;li&gt;This UNLOAD command is invoked from OCMH&apos;s collectionCmd() method, which calls UNLOAD core on every replica registered in step 1.&lt;/li&gt;
	&lt;li&gt;At CoreContainer of the replica, when unload() method is invoked, the coreInitFailures map gets cleared.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;This is all fine, when it works. However, the publish step in preRegister seems intermittent. Sometimes, the publish doesn&apos;t work. I can see that the state opertion is offered to the distributed queue properly, but that message actually doesn&apos;t seem to get processed. Hence, at step 4, no UNLOAD command is sent to the replica. The latest &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6736&quot; title=&quot;A collections-like request handler to manage solr configurations on zookeeper&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6736&quot;&gt;&lt;del&gt;SOLR-6736&lt;/del&gt;&lt;/a&gt; patch&apos;s TestConfigSetsAPI#testUploadWithScriptUpdateProcessor() demonstrates this.&lt;/p&gt;

&lt;p&gt;While this maybe a larger issue with the way OCMH works, I can see that the patch I added here does the job in those circumstances, and the code path followed after the core is registered successfully properly removes the previous exception from the coreInitFailures map. Unless someone has any objections, I am inclined to commit this patch, and hence commit &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6736&quot; title=&quot;A collections-like request handler to manage solr configurations on zookeeper&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6736&quot;&gt;&lt;del&gt;SOLR-6736&lt;/del&gt;&lt;/a&gt; and then continue investigating the above scenario.&lt;/p&gt;</comment>
                            <comment id="15945741" author="jira-bot" created="Tue, 28 Mar 2017 19:03:12 +0000"  >&lt;p&gt;Commit 0322068ea4648c93405da5b60fcbcc3467f5b009 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ichattopadhyaya&quot; class=&quot;user-hover&quot; rel=&quot;ichattopadhyaya&quot;&gt;ichattopadhyaya&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=0322068&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=0322068&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10365&quot; title=&quot;Collection re-creation fails if previous collection creation had failed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10365&quot;&gt;&lt;del&gt;SOLR-10365&lt;/del&gt;&lt;/a&gt;: Handle a SolrCoreInitializationException while publishing core state during SolrCore creation&lt;/p&gt;</comment>
                            <comment id="15945746" author="jira-bot" created="Tue, 28 Mar 2017 19:04:23 +0000"  >&lt;p&gt;Commit c37cb7e94e312fbfe650cb4cc4e812dbc2034478 in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ichattopadhyaya&quot; class=&quot;user-hover&quot; rel=&quot;ichattopadhyaya&quot;&gt;ichattopadhyaya&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=c37cb7e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=c37cb7e&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10365&quot; title=&quot;Collection re-creation fails if previous collection creation had failed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10365&quot;&gt;&lt;del&gt;SOLR-10365&lt;/del&gt;&lt;/a&gt;: Handle a SolrCoreInitializationException while publishing core state during SolrCore creation&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12860614" name="SOLR-10365.patch" size="4157" author="ichattopadhyaya" created="Mon, 27 Mar 2017 08:07:35 +0000"/>
                            <attachment id="12860613" name="SOLR-10365.patch" size="3725" author="ichattopadhyaya" created="Mon, 27 Mar 2017 08:03:54 +0000"/>
                            <attachment id="12860609" name="SOLR-10365.patch" size="4268" author="ichattopadhyaya" created="Mon, 27 Mar 2017 07:52:55 +0000"/>
                            <attachment id="12860571" name="SOLR-10365.patch" size="808" author="ichattopadhyaya" created="Sun, 26 Mar 2017 17:59:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 34 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ct2f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>