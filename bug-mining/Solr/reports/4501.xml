<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:44:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-14492] many json.facet aggregations can throw ArrayIndexOutOfBoundsException when using DVHASH due to incorrect resize impl</title>
                <link>https://issues.apache.org/jira/browse/SOLR-14492</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;It appears we have quite a few SlotAcc impls that don&apos;t properly implement resize: they ask the &lt;tt&gt;Resizer&lt;/tt&gt; to resize their arrays, but throw away the result. (arrays can&apos;t be resized in place, the &lt;tt&gt;Resizer&lt;/tt&gt; is designed to return a new replacment map, initializing empty values and/or mapping old indicies to new indicies)&lt;/p&gt;

&lt;p&gt;For many FacetFieldProcessors, this isn&apos;t (normally) a problem because they create their Accs using a &quot;max upper bound&quot; on the possible number of slots in advance &amp;#8211; and only use resize later to &quot;shrink&quot; the number of slots.&lt;/p&gt;

&lt;p&gt;But in the case of &lt;tt&gt;method:dvhash&lt;/tt&gt; / FacetFieldProcessorByHashDV this processor starts out using a number of slots based on the size of the base DocSet (rounded up to the next power of 2) maxed out at 1024, and then &lt;em&gt;grows&lt;/em&gt; the SlotAccs if it encounters more values then that.&lt;/p&gt;

&lt;p&gt;This means that if the &quot;base&quot; context of the term facet is significantly smaller then the number of values in the docValues field being faceted on (ie: multiValued fields), then these problematic SlotAccs won&apos;t grow properly and you&apos;ll get ArrayIndexOutOfBoundsException&lt;/p&gt;</description>
                <environment></environment>
        <key id="13305309">SOLR-14492</key>
            <summary>many json.facet aggregations can throw ArrayIndexOutOfBoundsException when using DVHASH due to incorrect resize impl</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Chris M. Hostetter</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Fri, 15 May 2020 23:39:15 +0000</created>
                <updated>Wed, 15 Jul 2020 15:09:48 +0000</updated>
                            <resolved>Wed, 20 May 2020 22:42:18 +0000</resolved>
                                                    <fixVersion>8.6</fixVersion>
                                    <component>Facet Module</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="17108762" author="hossman" created="Fri, 15 May 2020 23:41:05 +0000"  >
&lt;p&gt;The attached patch helps demonstrate this failure &amp;#8211; note that this only fails with such a small set of docs/values because TestJsonFacets includes...&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    FacetFieldProcessorByHashDV.MAXIMUM_STARTING_TABLE_SIZE=2; &lt;span class=&quot;code-comment&quot;&gt;// stress test resizing&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Failure example...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   [junit4]   2&amp;gt; NOTE: reproduce with: ant test  -Dtestcase=TestJsonFacets -Dtests.method=testMultiValuedBucketReHashing -Dtests.seed=ABA0B47A555426CA -Dtests.slow=true -Dtests.badapples=true -Dtests.locale=lb-LU -Dtests.timezone=America/Regina -Dtests.asserts=true -Dtests.file.encoding=ISO-8859-1
   [junit4] ERROR   0.02s | TestJsonFacets.testMultiValuedBucketReHashing {p0=DV} &amp;lt;&amp;lt;&amp;lt;
   [junit4]    &amp;gt; Throwable #1: java.lang.ArrayIndexOutOfBoundsException: Index 7 out of bounds for length 2
   [junit4]    &amp;gt; 	at __randomizedtesting.SeedInfo.seed([ABA0B47A555426CA:CD61409929DFC726]:0)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.SumAgg$SumSortedNumericAcc.collectValues(SumAgg.java:92)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.DocValuesAcc.collect(DocValuesAcc.java:50)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessor.collectFirstPhase(FacetFieldProcessor.java:286)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessorByHashDV.collectValFirstPhase(FacetFieldProcessorByHashDV.java:430)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessorByHashDV$5.collect(FacetFieldProcessorByHashDV.java:393)
   [junit4]    &amp;gt; 	at org.apache.solr.search.DocSetUtil.collectSortedDocSet(DocSetUtil.java:278)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessorByHashDV.collectDocs(FacetFieldProcessorByHashDV.java:374)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessorByHashDV.calcFacets(FacetFieldProcessorByHashDV.java:248)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessorByHashDV.process(FacetFieldProcessorByHashDV.java:215)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.FacetRequest.process(FacetRequest.java:416)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.FacetProcessor.processSubs(FacetProcessor.java:475)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.FacetProcessor.fillBucket(FacetProcessor.java:432)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.FacetQueryProcessor.process(FacetQuery.java:64)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.FacetRequest.process(FacetRequest.java:416)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.FacetModule.process(FacetModule.java:147)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;hr /&gt;

&lt;p&gt;Quick and dirty list of places where SlotAccs &lt;em&gt;seem&lt;/em&gt; to be using the &apos;Resizer&apos; correctly...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ grep &apos;=\s*resizer.resize&apos; src/java/org/apache/solr/search/facet/*
src/java/org/apache/solr/search/facet/HLLAgg.java:      sets = resizer.resize(sets, null);
src/java/org/apache/solr/search/facet/MinMaxAgg.java:      exists = resizer.resize(exists);
src/java/org/apache/solr/search/facet/MinMaxAgg.java:      slotOrd = resizer.resize(slotOrd, MISSING);
src/java/org/apache/solr/search/facet/PercentileAgg.java:      digests = resizer.resize(digests, null);
src/java/org/apache/solr/search/facet/PercentileAgg.java:      digests = resizer.resize(digests, null);
src/java/org/apache/solr/search/facet/PercentileAgg.java:      digests = resizer.resize(digests, null);
src/java/org/apache/solr/search/facet/RelatednessAgg.java:      slotvalues = resizer.resize(slotvalues, null);
src/java/org/apache/solr/search/facet/SlotAcc.java:    result = resizer.resize(result, initialValue);
src/java/org/apache/solr/search/facet/SlotAcc.java:    result = resizer.resize(result, initialValue);
src/java/org/apache/solr/search/facet/SlotAcc.java:    result = resizer.resize(result, initialValue);
src/java/org/apache/solr/search/facet/SlotAcc.java:    counts = resizer.resize(counts, 0);
src/java/org/apache/solr/search/facet/SlotAcc.java:    this.counts = resizer.resize(this.counts, 0);
src/java/org/apache/solr/search/facet/SlotAcc.java:    this.sum = resizer.resize(this.sum, 0);
src/java/org/apache/solr/search/facet/SlotAcc.java:    this.counts = resizer.resize(this.counts, 0);
src/java/org/apache/solr/search/facet/SlotAcc.java:    this.result = resizer.resize(this.result, 0);
src/java/org/apache/solr/search/facet/SlotAcc.java:    result = resizer.resize(result, 0);
src/java/org/apache/solr/search/facet/UniqueAgg.java:      sets = resizer.resize(sets, null);
src/java/org/apache/solr/search/facet/UniqueBlockAgg.java:      lastSeenValuesPerSlot = resizer.resize(lastSeenValuesPerSlot, Integer.MIN_VALUE);
src/java/org/apache/solr/search/facet/UniqueSlotAcc.java:    arr = resizer.resize(arr, null);
src/java/org/apache/solr/search/facet/UniqueSlotAcc.java:      counts = resizer.resize(counts, 0);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Quick and dirty example of places where it seems very likely we have broken SlotAcc impls..&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ grep &apos;^\s*resizer.resize&apos; src/java/org/apache/solr/search/facet/*
src/java/org/apache/solr/search/facet/AvgAgg.java:      resizer.resize(counts, 0);
src/java/org/apache/solr/search/facet/AvgAgg.java:      resizer.resize(counts, 0);
src/java/org/apache/solr/search/facet/AvgAgg.java:      resizer.resize(counts, 0);
src/java/org/apache/solr/search/facet/CountValsAgg.java:      resizer.resize(result, 0);
src/java/org/apache/solr/search/facet/DocValuesAcc.java:    resizer.resize(result, initialValue);
src/java/org/apache/solr/search/facet/DocValuesAcc.java:    resizer.resize(result, initialValue);
src/java/org/apache/solr/search/facet/DocValuesAcc.java:    resizer.resize(counts, 0);
src/java/org/apache/solr/search/facet/DocValuesAcc.java:    resizer.resize(sum, 0);
src/java/org/apache/solr/search/facet/DocValuesAcc.java:    resizer.resize(result, initialValue);
src/java/org/apache/solr/search/facet/DocValuesAcc.java:    resizer.resize(result, initialValue);
src/java/org/apache/solr/search/facet/DocValuesAcc.java:    resizer.resize(counts, 0);
src/java/org/apache/solr/search/facet/DocValuesAcc.java:    resizer.resize(sum, 0);
src/java/org/apache/solr/search/facet/MinMaxAgg.java:      resizer.resize(result, MISSING);
src/java/org/apache/solr/search/facet/MinMaxAgg.java:      resizer.resize(slotOrd, MISSING);
src/java/org/apache/solr/search/facet/UnInvertedFieldAcc.java:    resizer.resize(result, initialValue);
src/java/org/apache/solr/search/facet/UnInvertedFieldAcc.java:    resizer.resize(counts, 0);
src/java/org/apache/solr/search/facet/UnInvertedFieldAcc.java:    resizer.resize(sum, 0);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17108781" author="hossman" created="Sat, 16 May 2020 00:18:36 +0000"  >&lt;p&gt;attaching patch with cursory fixes ... IIUC the problematic SlotAccs were all for dealing with multivalued fields ... but don&apos;t quote me on that.&lt;/p&gt;

&lt;p&gt;I&apos;m currently running all tests (and beasting against the new test in in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14477&quot; title=&quot;relatedness() values can be wrong when using &amp;#39;prefix&amp;#39;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14477&quot;&gt;&lt;del&gt;SOLR-14477&lt;/del&gt;&lt;/a&gt;&apos;s patch) but have not added any additional tests for this specific issue beyond what was in the previous patch ... i had an idea of writing a test that would loop over all of the &lt;tt&gt;agg_*&lt;/tt&gt; parsers and:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;assert that they can all produce a SlotAcc of a small size&lt;/li&gt;
	&lt;li&gt;add some slot values&lt;/li&gt;
	&lt;li&gt;resize with a custom Resizer that does special mapping&lt;/li&gt;
	&lt;li&gt;assert that the existing slot values showup in the new mapped slots&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;...but that still wouldn&apos;t garuntee all of the &lt;em&gt;SlotAcc&lt;/em&gt; impls would get tested, because of the way diff impls are chosen based on the properties of the fields, etc. Not sure if/how we can really test this robustly.&lt;/p&gt;</comment>
                            <comment id="17112509" author="jira-bot" created="Wed, 20 May 2020 18:18:44 +0000"  >&lt;p&gt;Commit 28209cb8b1fe2a4d8050e4877c4df2ad5d85509b in lucene-solr&apos;s branch refs/heads/master from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=28209cb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=28209cb&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14492&quot; title=&quot;many json.facet aggregations can throw ArrayIndexOutOfBoundsException when using DVHASH due to incorrect resize impl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14492&quot;&gt;&lt;del&gt;SOLR-14492&lt;/del&gt;&lt;/a&gt;: Fix ArrayIndexOutOfBoundsException in json.facet &apos;terms&apos; when FacetFieldProcessorByHashDV is used with aggregations over multivalued numeric fields&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14477&quot; title=&quot;relatedness() values can be wrong when using &amp;#39;prefix&amp;#39;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14477&quot;&gt;&lt;del&gt;SOLR-14477&lt;/del&gt;&lt;/a&gt;: Fix incorrect &apos;relatedness()&apos; calculations in json.facet &apos;terms&apos; when &apos;prefix&apos; option is used&lt;/p&gt;</comment>
                            <comment id="17112549" author="jira-bot" created="Wed, 20 May 2020 19:18:31 +0000"  >&lt;p&gt;Commit 6755796ddf76bc25d61e6bb3988924ac8a0071ec in lucene-solr&apos;s branch refs/heads/branch_8x from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=6755796&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=6755796&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14492&quot; title=&quot;many json.facet aggregations can throw ArrayIndexOutOfBoundsException when using DVHASH due to incorrect resize impl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14492&quot;&gt;&lt;del&gt;SOLR-14492&lt;/del&gt;&lt;/a&gt;: Fix ArrayIndexOutOfBoundsException in json.facet &apos;terms&apos; when FacetFieldProcessorByHashDV is used with aggregations over multivalued numeric fields&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14477&quot; title=&quot;relatedness() values can be wrong when using &amp;#39;prefix&amp;#39;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14477&quot;&gt;&lt;del&gt;SOLR-14477&lt;/del&gt;&lt;/a&gt;: Fix incorrect &apos;relatedness()&apos; calculations in json.facet &apos;terms&apos; when &apos;prefix&apos; option is used&lt;br/&gt;
(cherry picked from commit 28209cb8b1fe2a4d8050e4877c4df2ad5d85509b)&lt;/p&gt;</comment>
                            <comment id="17113684" author="jira-bot" created="Fri, 22 May 2020 02:13:55 +0000"  >&lt;p&gt;Commit 28209cb8b1fe2a4d8050e4877c4df2ad5d85509b in lucene-solr&apos;s branch refs/heads/&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14461&quot; title=&quot;Replace commons-fileupload use with standard Servlet/Jetty&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14461&quot;&gt;&lt;del&gt;SOLR-14461&lt;/del&gt;&lt;/a&gt;-fileupload from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=28209cb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=28209cb&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14492&quot; title=&quot;many json.facet aggregations can throw ArrayIndexOutOfBoundsException when using DVHASH due to incorrect resize impl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14492&quot;&gt;&lt;del&gt;SOLR-14492&lt;/del&gt;&lt;/a&gt;: Fix ArrayIndexOutOfBoundsException in json.facet &apos;terms&apos; when FacetFieldProcessorByHashDV is used with aggregations over multivalued numeric fields&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14477&quot; title=&quot;relatedness() values can be wrong when using &amp;#39;prefix&amp;#39;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14477&quot;&gt;&lt;del&gt;SOLR-14477&lt;/del&gt;&lt;/a&gt;: Fix incorrect &apos;relatedness()&apos; calculations in json.facet &apos;terms&apos; when &apos;prefix&apos; option is used&lt;/p&gt;</comment>
                            <comment id="17158312" author="broustant" created="Wed, 15 Jul 2020 15:09:48 +0000"  >&lt;p&gt;Closing after the 8.6.0 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13003101" name="SOLR-14492.patch" size="7600" author="hossman" created="Sat, 16 May 2020 00:17:00 +0000"/>
                            <attachment id="13003095" name="SOLR-14492.patch" size="2217" author="hossman" created="Fri, 15 May 2020 23:39:51 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 17 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0esw0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>