<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:46:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-14940] ReplicationHandler memory leak through SolrCore.closeHooks</title>
                <link>https://issues.apache.org/jira/browse/SOLR-14940</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;We are experiencing a memory leak in Solr Cloud cluster configured as 3 TLOG nodes.&lt;/p&gt;

&lt;p&gt;Leader does not seem to be affected while Followers are.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Looking at memory dump we noticed that SolrCore holds lots of references to ReplicationHandler through anonymous inner classes in SolrCore.closeHooks, which in turn holds ReplicationHandlers.&lt;/p&gt;

&lt;p&gt;ReplicationHandler registers hooks as anonymous inner classes in SolrCore.closeHooks through ReplicationHandler.inform() -&amp;gt;&#160;ReplicationHandler.registerCloseHook().&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Whenever ZkController.stopReplicationFromLeader is called - it would shutdown ReplicationHandler (ReplicationHandler.shutdown()), BUT reference to ReplicationHandler will stay in SolrCore.closeHooks. Once replication is started again on same SolrCore - new ReplicationHandler will be created and registered in closeHooks.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;It looks like there are few scenarios when replication is stopped and restarted on same core and in our TLOG setup it shows up quite often.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Potential solutions:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Allow unregistering SolrCore.closeHooks so it can be used from ReplicationHandler.shutdown&lt;/li&gt;
	&lt;li&gt;Hack but easier - break the link between ReplicationHandler close hooks and full ReplicationHandler object so ReplicationHandler can be GCed even when hooks are still registered in SolrCore.closeHooks&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment>&lt;p&gt;Solr Cloud Cluster on v.8.6.2 configured as 3 TLOG nodes with 2 cores in each JVM.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</environment>
        <key id="13335786">SOLR-14940</key>
            <summary>ReplicationHandler memory leak through SolrCore.closeHooks</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mdrob">Mike Drob</assignee>
                                    <reporter username="anverus">Anver Sotnikov</reporter>
                        <labels>
                    </labels>
                <created>Fri, 16 Oct 2020 14:21:35 +0000</created>
                <updated>Thu, 12 May 2022 00:26:19 +0000</updated>
                            <resolved>Wed, 2 Dec 2020 18:57:32 +0000</resolved>
                                                    <fixVersion>8.8</fixVersion>
                    <fixVersion>9.0</fixVersion>
                                    <component>replication (java)</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>13</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="7800">2h 10m</timespent>
                                <comments>
                            <comment id="17216830" author="mdrob" created="Mon, 19 Oct 2020 15:41:15 +0000"  >&lt;p&gt;This is a great find, it looks like your solution implements approach number 1? Do you think you would be able to add a test? I&apos;m working on reproducing this locally right now.&lt;/p&gt;</comment>
                            <comment id="17217128" author="mdrob" created="Mon, 19 Oct 2020 22:09:06 +0000"  >&lt;p&gt;I set up a collection with two TLOG replicas and reloaded the follower core 1000 times, but that didn&apos;t seem to cause a leak for me. Maybe there is something more subtle going on to reproduce this.&lt;/p&gt;</comment>
                            <comment id="17217708" author="anverus" created="Tue, 20 Oct 2020 15:54:38 +0000"  >&lt;p&gt;I assume Core reload actually creates a new core and discards old one, thus hooks would be executed and discarded. It seems that stopping replication and restarting replication on the same core would be a better representation of the problem. Planning to get trough the logs to understand what exactly triggers the problem (we do get quite a few Recoveries getting triggered due to ZK connectivity but need to trace if that is the real reason)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17217710" author="anverus" created="Tue, 20 Oct 2020 15:58:58 +0000"  >&lt;p&gt;Attached screenshot of Memory Analyzer heap dump with 163 hooks registered. Let me know if you&apos;d want to see any details of ReplicationHandlers referenced from hooks&lt;/p&gt;</comment>
                            <comment id="17217772" author="mdrob" created="Tue, 20 Oct 2020 16:59:32 +0000"  >&lt;p&gt;That&apos;s showing an array of ReplicationHandler, not an array of CloseHook. When I was poking at a heap snapshot in YourKit, they actually showed up as ReplicationHandler$1 and $2. Are we sure that we&apos;re looking at the right thing? Possible that I&apos;m misreading that screenshot as well.&lt;/p&gt;</comment>
                            <comment id="17217828" author="anverus" created="Tue, 20 Oct 2020 17:51:09 +0000"  >&lt;p&gt;ReplicationHandler reference is kept in memory as hooks&#160;ReplicationHandler$1 and&#160;&#160;ReplicationHandler$2 are inner anonimous classes and as such they keep implicit reference to parent class instance (to use all the properties listed in hooks like executorService /currentIndexFetcher / etc)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void registerCloseHook() {
    core.addCloseHook(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CloseHook() {
      @Override
      &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void preClose(SolrCore core) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (executorService != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) executorService.shutdown(); &lt;span class=&quot;code-comment&quot;&gt;// we don&apos;t wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; shutdown - &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; can deadlock core reload
&lt;/span&gt;      }

      @Override
      &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void postClose(SolrCore core) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (pollingIndexFetcher != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
          pollingIndexFetcher.destroy();
        }
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (currentIndexFetcher != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; currentIndexFetcher != pollingIndexFetcher) {
          currentIndexFetcher.destroy();
        }
      }
    });

    core.addCloseHook(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CloseHook() {
      @Override
      &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void preClose(SolrCore core) {
        ExecutorUtil.shutdownAndAwaitTermination(restoreExecutor);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (restoreFuture != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
          restoreFuture.cancel(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
        }
      }

      @Override
      &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void postClose(SolrCore core) {}
    });
  }

&#160;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17217833" author="anverus" created="Tue, 20 Oct 2020 17:59:35 +0000"  >&lt;p&gt;Attached closeHooks contents showing hooks (ReplicationHandler$1 and ReplicationHandler$2) on the left in MAT&lt;/p&gt;</comment>
                            <comment id="17218322" author="mdrob" created="Wed, 21 Oct 2020 14:48:35 +0000"  >&lt;p&gt;So I &lt;em&gt;think&lt;/em&gt; the patch you have is good, but I&apos;d really like to see a test included or a more reliable repro case or at least something to give us more confidence. This is a pretty subtle behavior so I want to make sure we catch it correctly.&lt;/p&gt;

&lt;p&gt;I&apos;ve been going through the code paths here trying a few things, and I suspect that your initial diagnosis is going to be the only way to demonstrate it. You need a PULL or TLOG follower that has a flapping ZK connection. I haven&apos;t gotten that working yet, but all of the other code paths seem to account for closing the core.&lt;/p&gt;</comment>
                            <comment id="17220704" author="anverus" created="Mon, 26 Oct 2020 13:44:46 +0000"  >&lt;p&gt;Mike, you were right. We instrumented Solr with extra logging on registerHook and shutdown in ReplicationController to confirm that leak was due to flaky ZK connection. We bumped timeouts (&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10471&quot; title=&quot;Solr script always sets zkClientTimeout to 15000 if ZK_CLIENT_TIMEOUT unset&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10471&quot;&gt;&lt;del&gt;SOLR-10471&lt;/del&gt;&lt;/a&gt;) and fine tuned GC as well. Replication going into recovery happens way less then it was before.&lt;/p&gt;

&lt;p&gt;Stacktrace from registerHook &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
at org.apache.solr.handler.ReplicationHandler.registerCloseHook(ReplicationHandler.java:1397)
java.lang.RuntimeException: ReplicationHandler.registerCloseHooks
	at org.apache.solr.handler.ReplicationHandler.registerCloseHook(ReplicationHandler.java:1397) ~[?:?]
	at org.apache.solr.handler.ReplicationHandler.inform(ReplicationHandler.java:1239) ~[?:?]
	at org.apache.solr.cloud.ReplicateFromLeader.startReplication(ReplicateFromLeader.java:109) ~[?:?]
	at org.apache.solr.cloud.ZkController.startReplicationFromLeader(ZkController.java:1327) ~[?:?]
	at org.apache.solr.cloud.RecoveryStrategy.doSyncOrReplicateRecovery(RecoveryStrategy.java:713) ~[?:?]
	at org.apache.solr.cloud.RecoveryStrategy.doRecovery(RecoveryStrategy.java:334) ~[?:?]
	at org.apache.solr.cloud.RecoveryStrategy.run(RecoveryStrategy.java:317) ~[?:?]
	at com.codahale.metrics.InstrumentedExecutorService$InstrumentedRunnable.run(InstrumentedExecutorService.java:180) ~[metrics-core-4.1.5.jar:4.1.5]
	at java.util.concurrent.Executors$RunnableAdapter.call(Unknown Source) ~[?:?]
	at java.util.concurrent.FutureTask.run(Unknown Source) ~[?:?]
	at org.apache.solr.common.util.ExecutorUtil$MDCAwareThreadPoolExecutor.lambda$execute$0(ExecutorUtil.java:212) ~[?:?]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source) ~[?:?]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source) ~[?:?]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(Unknown Source)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="17220810" author="mdrob" created="Mon, 26 Oct 2020 16:46:52 +0000"  >&lt;p&gt;Thanks for confirming the ZK changes helped!&lt;/p&gt;

&lt;p&gt;I pushed a commit to your PR with a test that passes now, and fails before your change. So that&apos;s a good sign. I&apos;m a little confused about why there are 5 hooks at the end of each reconnect, instead of what I would expect to be 3 hooks. Are we removing the close hooks too late in the process somewhere? Need to continue investigating.&lt;/p&gt;</comment>
                            <comment id="17220941" author="mdrob" created="Mon, 26 Oct 2020 19:11:10 +0000"  >&lt;p&gt;It looks like we end up registering ReplicationHandler twice - &lt;/p&gt;

&lt;p&gt;On core creation,&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;	at org.apache.solr.handler.ReplicationHandler.registerCloseHook(ReplicationHandler.java:1410) [main/:?]
	at org.apache.solr.handler.ReplicationHandler.inform(ReplicationHandler.java:1235) [main/:?]
	at org.apache.solr.core.SolrResourceLoader.inform(SolrResourceLoader.java:674) [main/:?]
	at org.apache.solr.core.SolrCore.&amp;lt;init&amp;gt;(SolrCore.java:1037) [main/:?]
	at org.apache.solr.core.SolrCore.&amp;lt;init&amp;gt;(SolrCore.java:929) [main/:?]
	at org.apache.solr.core.CoreContainer.createFromDescriptor(CoreContainer.java:1375) [main/:?]
	at org.apache.solr.core.CoreContainer.create(CoreContainer.java:1261) [main/:?]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And when we register in ZK&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;	at org.apache.solr.handler.ReplicationHandler.registerCloseHook(ReplicationHandler.java:1410) [main/:?]
	at org.apache.solr.handler.ReplicationHandler.inform(ReplicationHandler.java:1235) [main/:?]
	at org.apache.solr.cloud.ReplicateFromLeader.startReplication(ReplicateFromLeader.java:109) [main/:?]
	at org.apache.solr.cloud.ZkController.startReplicationFromLeader(ZkController.java:1305) [main/:?]
	at org.apache.solr.cloud.ZkController.register(ZkController.java:1198) [main/:?]
	at org.apache.solr.cloud.ZkController.register(ZkController.java:1145) [main/:?]
	at org.apache.solr.core.ZkContainer.lambda$registerInZk$1(ZkContainer.java:208) [main/:?]
	at org.apache.solr.core.ZkContainer.registerInZk(ZkContainer.java:237) [main/:?]
	at org.apache.solr.core.CoreContainer.registerCore(CoreContainer.java:1195) [main/:?]
	at org.apache.solr.core.CoreContainer.createFromDescriptor(CoreContainer.java:1385) [main/:?]
	at org.apache.solr.core.CoreContainer.create(CoreContainer.java:1261) [main/:?]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I think this is likely a bug.&lt;/p&gt;</comment>
                            <comment id="17220992" author="mdrob" created="Mon, 26 Oct 2020 20:58:39 +0000"  >&lt;p&gt;Reading through this more, I feel like I have to ask what is potentially an obvious question... Why do PULL replicas need a ReplicationHandler at all? They&apos;re not listening for commits and can never become leaders. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=caomanhdat&quot; class=&quot;user-hover&quot; rel=&quot;caomanhdat&quot;&gt;caomanhdat&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tflobbe&quot; class=&quot;user-hover&quot; rel=&quot;tflobbe&quot;&gt;tflobbe&lt;/a&gt; - any insight?&lt;/p&gt;</comment>
                            <comment id="17220995" author="mdrob" created="Mon, 26 Oct 2020 21:06:12 +0000"  >&lt;p&gt;Never mind, the ReplicationHandler also does the polling in addition to the request processing.&lt;/p&gt;</comment>
                            <comment id="17221595" author="mdrob" created="Tue, 27 Oct 2020 17:29:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anverus&quot; class=&quot;user-hover&quot; rel=&quot;anverus&quot;&gt;anverus&lt;/a&gt; - please let me know what you think of the latest patch, and if you&apos;re happy with it I think we can commit.&lt;/p&gt;</comment>
                            <comment id="17221604" author="anverus" created="Tue, 27 Oct 2020 17:36:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mdrob&quot; class=&quot;user-hover&quot; rel=&quot;mdrob&quot;&gt;mdrob&lt;/a&gt;&#160;It looks good to me. Thank you for adding tests.&lt;/p&gt;</comment>
                            <comment id="17221780" author="jira-bot" created="Tue, 27 Oct 2020 21:45:48 +0000"  >&lt;p&gt;Commit b8d28555f9f68cd00fc9b65342a175db595c11a3 in lucene-solr&apos;s branch refs/heads/branch_8x from Anver Sotnikov&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=b8d2855&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=b8d2855&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14940&quot; title=&quot;ReplicationHandler memory leak through SolrCore.closeHooks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14940&quot;&gt;&lt;del&gt;SOLR-14940&lt;/del&gt;&lt;/a&gt;: Fix ReplicationHandler memory leak through SolrCore.closeHooks&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Added ability to remove SolrCore.closeHooks&lt;/li&gt;
	&lt;li&gt;Keep references to CloseHooks in ReplicationHandler and remove them on ReplicationHandler.shutdown()&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;closes #1997&lt;/p&gt;</comment>
                            <comment id="17221781" author="jira-bot" created="Tue, 27 Oct 2020 21:45:56 +0000"  >&lt;p&gt;Commit 6d00843d9705827259fa076ac59b43606720fc81 in lucene-solr&apos;s branch refs/heads/master from Anver Sotnikov&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=6d00843&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=6d00843&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14940&quot; title=&quot;ReplicationHandler memory leak through SolrCore.closeHooks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14940&quot;&gt;&lt;del&gt;SOLR-14940&lt;/del&gt;&lt;/a&gt;: Fix ReplicationHandler memory leak through SolrCore.closeHooks&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Added ability to remove SolrCore.closeHooks&lt;/li&gt;
	&lt;li&gt;Keep references to CloseHooks in ReplicationHandler and remove them on ReplicationHandler.shutdown()&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;closes #1997&lt;/p&gt;</comment>
                            <comment id="17229764" author="tomasflobbe" created="Wed, 11 Nov 2020 06:10:53 +0000"  >&lt;p&gt;I believe the test added to &lt;tt&gt;TestPullReplicaErrorHandling&lt;/tt&gt; is causing the failures described in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14992&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-14992&lt;/a&gt;. The failures happen in the tests running immediately after &lt;tt&gt;testCloseHooksDeletedOnReconnect&lt;/tt&gt;, for example:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    [junit4]   2&amp;gt; 37296 INFO  (TEST-TestPullReplicaErrorHandling.testCloseHooksDeletedOnReconnect-seed#[64BCF377B675F037]) [     ] o.a.s.c.MiniSolrCloudCluster Expired zookeeper session 72103195153465373 from node http://127.0.0.1:64010/solr
   [junit4]   2&amp;gt; 37296 INFO  (TEST-TestPullReplicaErrorHandling.testCloseHooksDeletedOnReconnect-seed#[64BCF377B675F037]) [     ] o.a.s.c.SolrCloudTestCase waitForState (pull_replica_error_handling_test_close_hooks_deleted_on_reconnect): Expecting node to reconnect
   [junit4]   2&amp;gt; 37296 WARN  (NIOWorkerThread-1) [     ] o.a.z.s.NIOServerCnxn Unexpected exception
   [junit4]   2&amp;gt;           =&amp;gt; EndOfStreamException: Unable to read additional data from client, it probably closed the socket: address = /127.0.0.1:64510, session = 0x1002979564b001d
   [junit4]   2&amp;gt; 	at org.apache.zookeeper.server.NIOServerCnxn.handleFailedRead(NIOServerCnxn.java:163)
   [junit4]   2&amp;gt; org.apache.zookeeper.server.ServerCnxn$EndOfStreamException: Unable to read additional data from client, it probably closed the socket: address = /127.0.0.1:64510, session = 0x1002979564b001d
   [junit4]   2&amp;gt; 	at org.apache.zookeeper.server.NIOServerCnxn.handleFailedRead(NIOServerCnxn.java:163) ~[zookeeper-3.6.2.jar:3.6.2]
   [junit4]   2&amp;gt; 	at org.apache.zookeeper.server.NIOServerCnxn.doIO(NIOServerCnxn.java:326) [zookeeper-3.6.2.jar:3.6.2]
   [junit4]   2&amp;gt; 	at org.apache.zookeeper.server.NIOServerCnxnFactory$IOWorkRequest.doWork(NIOServerCnxnFactory.java:522) [zookeeper-3.6.2.jar:3.6.2]
   [junit4]   2&amp;gt; 	at org.apache.zookeeper.server.WorkerService$ScheduledWorkRequest.run(WorkerService.java:154) [zookeeper-3.6.2.jar:3.6.2]
   [junit4]   2&amp;gt; 	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130) [?:?]
   [junit4]   2&amp;gt; 	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:630) [?:?]
   [junit4]   2&amp;gt; 	at java.lang.Thread.run(Thread.java:832) [?:?]
   [junit4]   2&amp;gt; 37299 INFO  (zkCallback-214-thread-1) [     ] o.a.s.c.c.ZkStateReader Updated live nodes from ZooKeeper... (4) -&amp;gt; (3)
   [junit4]   2&amp;gt; 37299 INFO  (zkCallback-184-thread-3) [     ] o.a.s.c.c.ZkStateReader Updated live nodes from ZooKeeper... (4) -&amp;gt; (3)
   [junit4]   2&amp;gt; 37299 INFO  (zkCallback-154-thread-1) [     ] o.a.s.c.c.ZkStateReader Updated live nodes from ZooKeeper... (4) -&amp;gt; (3)
   [junit4]   2&amp;gt; 37299 INFO  (zkCallback-100-thread-1) [     ] o.a.s.c.c.ZkStateReader Updated live nodes from ZooKeeper... (4) -&amp;gt; (3)
   [junit4]   2&amp;gt; 37304 INFO  (TEST-TestPullReplicaErrorHandling.testCloseHooksDeletedOnReconnect-seed#[64BCF377B675F037]) [     ] o.a.s.c.TestPullReplicaErrorHandling tearDown deleting collection
   [junit4]   2&amp;gt; 37306 INFO  (SocketProxy-Acceptor-64086) [     ] o.a.s.c.s.c.SocketProxy accepted Socket[addr=/127.0.0.1,port=64511,localport=64086], receiveBufferSize: 65536
   [junit4]   2&amp;gt; 37306 INFO  (SocketProxy-Acceptor-64086) [     ] o.a.s.c.s.c.SocketProxy proxy connection Socket[addr=/127.0.0.1,port=64102,localport=64512], receiveBufferSize=65536
   [junit4]   2&amp;gt; 37308 INFO  (qtp1774678962-277) [n:127.0.0.1:64086_solr     ] o.a.s.h.a.CollectionsHandler Invoked Collection Action :delete with params name=pull_replica_error_handling_test_close_hooks_deleted_on_reconnect&amp;amp;action=DELETE&amp;amp;wt=javabin&amp;amp;version=2 and sendToOCPQueue=true
   [junit4]   2&amp;gt; 37319 INFO  (OverseerThreadFactory-238-thread-1-processing-n:127.0.0.1:64086_solr) [n:127.0.0.1:64086_solr     ] o.a.s.c.a.c.OverseerCollectionMessageHandler Executing Collection Cmd=action=UNLOAD&amp;amp;deleteInstanceDir=true&amp;amp;deleteDataDir=true&amp;amp;deleteMetricsHistory=true, asyncId=null
   [junit4]   2&amp;gt; 37321 INFO  (SocketProxy-Acceptor-64180) [     ] o.a.s.c.s.c.SocketProxy accepted Socket[addr=/127.0.0.1,port=64513,localport=64180], receiveBufferSize: 65536
   [junit4]   2&amp;gt; 37322 INFO  (SocketProxy-Acceptor-64180) [     ] o.a.s.c.s.c.SocketProxy proxy connection Socket[addr=/127.0.0.1,port=64194,localport=64514], receiveBufferSize=65536
   [junit4]   2&amp;gt; 37324 INFO  (qtp420303283-332) [n:127.0.0.1:64180_solr    x:pull_replica_error_handling_test_close_hooks_deleted_on_reconnect_shard1_replica_n1 ] o.a.s.m.SolrMetricManager Closing metric reporters for registry=solr.core.pull_replica_error_handling_test_close_hooks_deleted_on_reconnect.shard1.replica_n1 tag=null
   [junit4]   2&amp;gt; 37324 INFO  (qtp420303283-332) [n:127.0.0.1:64180_solr     ] o.a.s.c.SolrCore [pull_replica_error_handling_test_close_hooks_deleted_on_reconnect_shard1_replica_n1]  CLOSING SolrCore org.apache.solr.core.SolrCore@25632cb5
   [junit4]   2&amp;gt; 37324 INFO  (qtp420303283-332) [n:127.0.0.1:64180_solr     ] o.a.s.m.SolrMetricManager Closing metric reporters for registry=solr.core.pull_replica_error_handling_test_close_hooks_deleted_on_reconnect.shard1.replica_n1 tag=SolrCore@25632cb5
   [junit4]   2&amp;gt; 37324 INFO  (qtp420303283-332) [n:127.0.0.1:64180_solr     ] o.a.s.m.SolrMetricManager Closing metric reporters for registry=solr.collection.pull_replica_error_handling_test_close_hooks_deleted_on_reconnect.shard1.leader tag=SolrCore@25632cb5
   [junit4]   2&amp;gt; 37324 INFO  (qtp420303283-332) [n:127.0.0.1:64180_solr     ] o.a.s.u.DirectUpdateHandler2 Committing on IndexWriter.close()  ... SKIPPED (unnecessary).
   [junit4]   2&amp;gt; 37342 INFO  (qtp420303283-332) [n:127.0.0.1:64180_solr     ] o.a.s.c.ZkShardTerms Successful update of terms at /collections/pull_replica_error_handling_test_close_hooks_deleted_on_reconnect/terms/shard1 to Terms{values={}, version=2}
   [junit4]   2&amp;gt; 37349 INFO  (qtp420303283-332) [n:127.0.0.1:64180_solr     ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/cores params={deleteInstanceDir=true&amp;amp;deleteMetricsHistory=true&amp;amp;core=pull_replica_error_handling_test_close_hooks_deleted_on_reconnect_shard1_replica_n1&amp;amp;qt=/admin/cores&amp;amp;deleteDataDir=true&amp;amp;action=UNLOAD&amp;amp;wt=javabin&amp;amp;version=2} status=0 QTime=24
   [junit4]   2&amp;gt; 37469 INFO  (zkCallback-184-thread-2) [     ] o.a.s.c.c.ZkStateReader A cluster state change: [WatchedEvent state:SyncConnected type:NodeDeleted path:/collections/pull_replica_error_handling_test_close_hooks_deleted_on_reconnect/state.json] for collection [pull_replica_error_handling_test_close_hooks_deleted_on_reconnect] has occurred - updating... (live nodes size: [3])
   [junit4]   2&amp;gt; 37469 INFO  (zkCallback-184-thread-1) [     ] o.a.s.c.c.ZkStateReader A cluster state change: [WatchedEvent state:SyncConnected type:NodeDeleted path:/collections/pull_replica_error_handling_test_close_hooks_deleted_on_reconnect/state.json] for collection [pull_replica_error_handling_test_close_hooks_deleted_on_reconnect] has occurred - updating... (live nodes size: [3])
   [junit4]   2&amp;gt; 37469 INFO  (zkCallback-154-thread-1) [     ] o.a.s.c.c.ZkStateReader A cluster state change: [WatchedEvent state:SyncConnected type:NodeDeleted path:/collections/pull_replica_error_handling_test_close_hooks_deleted_on_reconnect/state.json] for collection [pull_replica_error_handling_test_close_hooks_deleted_on_reconnect] has occurred - updating... (live nodes size: [3])
   [junit4]   2&amp;gt; 37469 INFO  (zkCallback-184-thread-3) [     ] o.a.s.c.c.ZkStateReader A cluster state change: [WatchedEvent state:SyncConnected type:NodeDeleted path:/collections/pull_replica_error_handling_test_close_hooks_deleted_on_reconnect/state.json] for collection [pull_replica_error_handling_test_close_hooks_deleted_on_reconnect] has occurred - updating... (live nodes size: [3])
   [junit4]   2&amp;gt; 37506 INFO  (qtp1774678962-277) [n:127.0.0.1:64086_solr     ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/collections params={name=pull_replica_error_handling_test_close_hooks_deleted_on_reconnect&amp;amp;action=DELETE&amp;amp;wt=javabin&amp;amp;version=2} status=0 QTime=182
   [junit4]   2&amp;gt; 37507 INFO  (TEST-TestPullReplicaErrorHandling.testCloseHooksDeletedOnReconnect-seed#[64BCF377B675F037]) [     ] o.a.s.c.TestPullReplicaErrorHandling Collection deleted
   [junit4]   2&amp;gt; 37507 INFO  (TEST-TestPullReplicaErrorHandling.testCloseHooksDeletedOnReconnect-seed#[64BCF377B675F037]) [     ] o.a.s.SolrTestCaseJ4 ###Ending testCloseHooksDeletedOnReconnect
   [junit4] OK      16.1s J4 | TestPullReplicaErrorHandling.testCloseHooksDeletedOnReconnect
   [junit4]   2&amp;gt; 37551 INFO  (TEST-TestPullReplicaErrorHandling.testCantConnectToPullReplica-seed#[64BCF377B675F037]) [     ] o.a.s.SolrTestCaseJ4 ###Starting testCantConnectToPullReplica
   [junit4]   2&amp;gt; 37554 INFO  (qtp420303283-333) [n:127.0.0.1:64180_solr     ] o.a.s.h.a.CollectionsHandler Invoked Collection Action :create with params pullReplicas=1&amp;amp;collection.configName=conf&amp;amp;maxShardsPerNode=1&amp;amp;name=pull_replica_error_handling_test_cant_connect_to_pull_replica&amp;amp;nrtReplicas=1&amp;amp;action=CREATE&amp;amp;numShards=2&amp;amp;tlogReplicas=0&amp;amp;wt=javabin&amp;amp;version=2 and sendToOCPQueue=true
   [junit4]   2&amp;gt; 37563 INFO  (OverseerThreadFactory-238-thread-2-processing-n:127.0.0.1:64086_solr) [n:127.0.0.1:64086_solr     ] o.a.s.c.a.c.CreateCollectionCmd Create collection pull_replica_error_handling_test_cant_connect_to_pull_replica
   [junit4]   2&amp;gt; 37564 INFO  (OverseerCollectionConfigSetProcessor-72103195153465365-127.0.0.1:64086_solr-n_0000000005) [n:127.0.0.1:64086_solr     ] o.a.s.c.OverseerTaskQueue Response ZK path: /overseer/collection-queue-work/qnr-0000000002 doesn&apos;t exist. Requestor may have disconnected from ZooKeeper
   [junit4]   2&amp;gt; 37795 INFO  (OverseerThreadFactory-238-thread-2-processing-n:127.0.0.1:64086_solr) [n:127.0.0.1:64086_solr     ] o.a.s.c.a.c.OverseerCollectionMessageHandler Executing Collection Cmd=action=UNLOAD&amp;amp;deleteInstanceDir=true&amp;amp;deleteDataDir=true&amp;amp;deleteMetricsHistory=true, asyncId=null
   [junit4]   2&amp;gt; 37914 INFO  (zkCallback-154-thread-1) [     ] o.a.s.c.c.ZkStateReader A cluster state change: [WatchedEvent state:SyncConnected type:NodeDeleted path:/collections/pull_replica_error_handling_test_cant_connect_to_pull_replica/state.json] for collection [pull_replica_error_handling_test_cant_connect_to_pull_replica] has occurred - updating... (live nodes size: [3])
   [junit4]   2&amp;gt; 37920 ERROR (OverseerThreadFactory-238-thread-2-processing-n:127.0.0.1:64086_solr) [n:127.0.0.1:64086_solr     ] o.a.s.c.a.c.OverseerCollectionMessageHandler Collection: pull_replica_error_handling_test_cant_connect_to_pull_replica operation: create failed:org.apache.solr.common.SolrException: Cannot create collection pull_replica_error_handling_test_cant_connect_to_pull_replica. Value of maxShardsPerNode is 1, and the number of nodes currently live or live and part of your createNodeSet is 3. This allows a maximum of 3 to be created. Value of numShards is 2, value of nrtReplicas is 1, value of tlogReplicas is 0 and value of pullReplicas is 1. This requires 4 shards to be created (higher than the allowed number)
   [junit4]   2&amp;gt; 	at org.apache.solr.cloud.api.collections.CreateCollectionCmd.call(CreateCollectionCmd.java:198)
   [junit4]   2&amp;gt; 	at org.apache.solr.cloud.api.collections.OverseerCollectionMessageHandler.processMessage(OverseerCollectionMessageHandler.java:264)
   [junit4]   2&amp;gt; 	at org.apache.solr.cloud.OverseerTaskProcessor$Runner.run(OverseerTaskProcessor.java:517)
   [junit4]   2&amp;gt; 	at org.apache.solr.common.util.ExecutorUtil$MDCAwareThreadPoolExecutor.lambda$execute$0(ExecutorUtil.java:218)
   [junit4]   2&amp;gt; 	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130)
   [junit4]   2&amp;gt; 	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:630)
   [junit4]   2&amp;gt; 	at java.base/java.lang.Thread.run(Thread.java:832)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I didn&apos;t validate this myself, but from the code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 5; i++) {
      cluster.expireZkSession(jetty);
      waitForState(&lt;span class=&quot;code-quote&quot;&gt;&quot;Expecting node to reconnect&quot;&lt;/span&gt;, collectionName, activeReplicaCount(1, 0, 1));
      &lt;span class=&quot;code-comment&quot;&gt;// We have two active ReplicationHandler with two close hooks each, one &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; triggering recovery and one &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; doing interval polling
&lt;/span&gt;      assertEquals(5, core.getCloseHooks().size());
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I believe the problem may be that we are checking for the state immediately after expiration, and maybe the collection state wasn&apos;t updated to reflect the dead node. Maybe we could first &lt;tt&gt;waitForState&lt;/tt&gt; for the node to be down and then up? or have a watch in the live_nodes znode?&lt;/p&gt;
</comment>
                            <comment id="17242622" author="mdrob" created="Wed, 2 Dec 2020 18:57:32 +0000"  >&lt;p&gt;re-resolving in favor of tackling it in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14992&quot; title=&quot;TestPullReplicaErrorHandling.testCantConnectToPullReplica Failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14992&quot;&gt;&lt;del&gt;SOLR-14992&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17535345" author="janhoy" created="Thu, 12 May 2022 00:26:19 +0000"  >&lt;p&gt;Closing after the 9.0.0 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12751687">SOLR-6678</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13339566">SOLR-14992</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13013888" name="Actual references to hooks that in turn hold references to ReplicationHandlers.png" size="1267354" author="anverus" created="Tue, 20 Oct 2020 17:58:24 +0000"/>
                            <attachment id="13013883" name="Memory Analyzer SolrCore.closeHooks .png" size="648412" author="anverus" created="Tue, 20 Oct 2020 15:57:38 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 26 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0jrg0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>