<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:24:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-10824] java.lang.NullPointerException ExactSharedStatsCache.getPerShardTermStats </title>
                <link>https://issues.apache.org/jira/browse/SOLR-10824</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;blockquote&gt;
&lt;p&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;qtp411311908-32&amp;#93;&lt;/span&gt; (SolrCore.java:2304) - &lt;span class=&quot;error&quot;&gt;&amp;#91;collection1_shard3_replica2&amp;#93;&lt;/span&gt;  webapp=/solr path=/select params=&lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {..&amp;amp;distrib=false&amp;amp;_stateVer_=collection1}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; status=0 QTime=18&lt;br/&gt;
INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;qtp2123780104-30&amp;#93;&lt;/span&gt; (SolrCore.java:2304) - &lt;span class=&quot;error&quot;&gt;&amp;#91;collection1_shard1_replica1&amp;#93;&lt;/span&gt; ...&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;qtp411311908-45&amp;#93;&lt;/span&gt; (SolrCore.java:2304) - &lt;span class=&quot;error&quot;&gt;&amp;#91;collection1_shard2_replica1&amp;#93;&lt;/span&gt;  ...&lt;/p&gt;

&lt;p&gt;ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;qtp411311908-33&amp;#93;&lt;/span&gt; (SolrException.java:148) - java.lang.NullPointerException&lt;br/&gt;
	at org.apache.solr.search.stats.ExactSharedStatsCache.getPerShardTermStats(ExactSharedStatsCache.java:76)&lt;br/&gt;
	at org.apache.solr.search.stats.ExactStatsCache.sendGlobalStats(ExactStatsCache.java:233)&lt;br/&gt;
	at org.apache.solr.handler.component.QueryComponent.createMainQuery(QueryComponent.java:930)&lt;br/&gt;
	at org.apache.solr.handler.component.QueryComponent.regularDistributedProcess(QueryComponent.java:726)&lt;br/&gt;
	at org.apache.solr.handler.component.QueryComponent.distributedProcess(QueryComponent.java:679)&lt;br/&gt;
	at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:345)&lt;/p&gt;


&lt;p&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;qtp411311908-33&amp;#93;&lt;/span&gt; (SolrCore.java:2304) - &lt;span class=&quot;error&quot;&gt;&amp;#91;collection1_shard3_replica2&amp;#93;&lt;/span&gt;  webapp=/solr path=/select params=&lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {...&amp;amp;wt=javabin&amp;amp;version=2}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; status=500 QTime=82&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Switching to &lt;tt&gt;LRUStatsCache&lt;/tt&gt; seems help.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13077663">SOLR-10824</key>
            <summary>java.lang.NullPointerException ExactSharedStatsCache.getPerShardTermStats </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="mkhl">Mikhail Khludnev</reporter>
                        <labels>
                    </labels>
                <created>Tue, 6 Jun 2017 12:33:34 +0000</created>
                <updated>Thu, 21 Nov 2019 00:41:44 +0000</updated>
                            <resolved>Mon, 26 Jun 2017 09:47:30 +0000</resolved>
                                    <version>6.6</version>
                                    <fixVersion>6.7</fixVersion>
                    <fixVersion>7.0</fixVersion>
                                    <component>search</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16049672" author="mkhludnev" created="Wed, 14 Jun 2017 21:24:22 +0000"  >&lt;p&gt;Steps to reproduce:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;launched cloud example 4 nodes,&lt;/li&gt;
	&lt;li&gt;created test collection 3x3 (my gut feeling is that it&apos;s caused by 3 replicas, at least it&apos;s reproduced when it&apos;s 3).&lt;/li&gt;
	&lt;li&gt;indexed example docs&lt;/li&gt;
	&lt;li&gt;added &lt;tt&gt;&amp;lt;statsCache class=&quot;org.apache.solr.search.stats.ExactSharedStatsCache&quot;/&amp;gt;&lt;/tt&gt; via &lt;tt&gt;zk downconfig/vim/zk upconfig&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;here we go
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;lst name=&lt;span class=&quot;code-quote&quot;&gt;&quot;responseHeader&quot;&lt;/span&gt;&amp;gt;
  &amp;lt;bool name=&lt;span class=&quot;code-quote&quot;&gt;&quot;zkConnected&quot;&lt;/span&gt;&amp;gt;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;lt;/bool&amp;gt;
  &amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;status&quot;&lt;/span&gt;&amp;gt;500&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;
  &amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;QTime&quot;&lt;/span&gt;&amp;gt;14&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;
  &amp;lt;lst name=&lt;span class=&quot;code-quote&quot;&gt;&quot;params&quot;&lt;/span&gt;&amp;gt;
    &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;q&quot;&lt;/span&gt;&amp;gt;_text_:all&amp;lt;/str&amp;gt;
    &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;indent&quot;&lt;/span&gt;&amp;gt;on&amp;lt;/str&amp;gt;
    &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;wt&quot;&lt;/span&gt;&amp;gt;xml&amp;lt;/str&amp;gt;
    &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;_&quot;&lt;/span&gt;&amp;gt;1497475014424&amp;lt;/str&amp;gt;
  &amp;lt;/lst&amp;gt;
&amp;lt;/lst&amp;gt;
&amp;lt;lst name=&lt;span class=&quot;code-quote&quot;&gt;&quot;error&quot;&lt;/span&gt;&amp;gt;
  &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;trace&quot;&lt;/span&gt;&amp;gt;java.lang.NullPointerException
	at org.apache.solr.search.stats.ExactSharedStatsCache.getPerShardTermStats(ExactSharedStatsCache.java:76)
	at org.apache.solr.search.stats.ExactStatsCache.sendGlobalStats(ExactStatsCache.java:233)
	at org.apache.solr.handler.component.QueryComponent.createMainQuery(QueryComponent.java:942)
	at org.apache.solr.handler.component.QueryComponent.regularDistributedProcess(QueryComponent.java:738)
	at org.apache.solr.handler.component.QueryComponent.distributedProcess(QueryComponent.java:691)
	at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:346)
	at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:173)
	at org.apache.solr.core.SolrCore.execute(SolrCore.java:2477)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;What&apos;s your bets and opinions? &lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16049687" author="erickerickson" created="Wed, 14 Jun 2017 21:32:57 +0000"  >&lt;p&gt;Is this related to the speculation on the mailing lists that another prerequisite is that some of the shards do &lt;em&gt;not&lt;/em&gt; happen to have documents on them?&lt;/p&gt;

&lt;p&gt;Or perhaps is it a problem if the query has zero hits on a particular shard? If this latter it should be pretty easy to reproduce by firing off, say, a query on a &amp;lt;uniqueKey&amp;gt;.....&lt;/p&gt;</comment>
                            <comment id="16049707" author="mkhludnev" created="Wed, 14 Jun 2017 21:50:04 +0000"  >&lt;p&gt;Right, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erickerickson&quot; class=&quot;user-hover&quot; rel=&quot;erickerickson&quot;&gt;erickerickson&lt;/a&gt;. This is exactly the case. id query falls off  &lt;/p&gt;</comment>
                            <comment id="16050128" author="mkhludnev" created="Thu, 15 Jun 2017 08:09:02 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12873129/12873129_SOLR-10824.patch&quot; title=&quot;SOLR-10824.patch attached to SOLR-10824&quot;&gt;SOLR-10824.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; reproducer &lt;/p&gt;</comment>
                            <comment id="16050147" author="mkhludnev" created="Thu, 15 Jun 2017 08:23:48 +0000"  >&lt;p&gt;copypasting NPE check from &lt;tt&gt;LRUStatsCache&lt;/tt&gt; but now &lt;tt&gt;id:5&lt;/tt&gt; query fails with score mismatch for all three &lt;tt&gt;Test*StatsCache&lt;/tt&gt; tests.&lt;/p&gt;
</comment>
                            <comment id="16050294" author="mkhludnev" created="Thu, 15 Jun 2017 10:26:27 +0000"  >&lt;p&gt;I don&apos;t understand how it may work at all: &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;======================= Control Response =======================&lt;br/&gt;
1.6931472 = weight(id:`�� in 2) &lt;span class=&quot;error&quot;&gt;&amp;#91;MockConfigurableSimilarity&amp;#93;&lt;/span&gt;, result of:&lt;br/&gt;
  1.6931472 = fieldWeight in 2, product of:&lt;br/&gt;
    1.0 = tf(freq=1.0), with freq of:&lt;br/&gt;
      1.0 = termFreq=1.0&lt;br/&gt;
    1.6931472 = idf, computed as log((docCount+1)/(docFreq+1)) + 1 from:&lt;br/&gt;
      1.0 = docFreq&lt;br/&gt;
      3.0 = docCount&lt;br/&gt;
    1.0 = fieldNorm(doc=2)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;vs&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;======================= Shard Response =======================&lt;br/&gt;
1.4054651 = weight(id:`�� in 1) &lt;span class=&quot;error&quot;&gt;&amp;#91;MockConfigurableSimilarity&amp;#93;&lt;/span&gt;, result of:&lt;br/&gt;
  1.4054651 = fieldWeight in 1, product of:&lt;br/&gt;
    1.0 = tf(freq=1.0), with freq of:&lt;br/&gt;
      1.0 = termFreq=1.0&lt;br/&gt;
    1.4054651 = idf, computed as log((docCount+1)/(docFreq+1)) + 1 from:&lt;br/&gt;
      1.0 = docFreq&lt;br/&gt;
      2.0 = docCount&lt;br/&gt;
    1.0 = fieldNorm(doc=1)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;So, the problem is the mismatch between control {{ 3.0 = docCount}} and sharded {{ 2.0 = docCount}} &lt;br/&gt;
I can see stats exchange. It seems fine. But I can&apos;t find how global docCount is applied to scoring. Can someone give a clue? &lt;/p&gt;</comment>
                            <comment id="16050556" author="mkhludnev" created="Thu, 15 Jun 2017 14:31:29 +0000"  >&lt;ul&gt;
	&lt;li&gt;NPE fix is nobrainer itself.&lt;/li&gt;
	&lt;li&gt;NPE is reproduced if id query is issued before regular query (hitting all shards and warming cache there).&lt;/li&gt;
	&lt;li&gt;but id query fails tests because maxdoc (colStat) from no-hits shards are omitted. &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12873129/12873129_SOLR-10824.patch&quot; title=&quot;SOLR-10824.patch attached to SOLR-10824&quot;&gt;SOLR-10824.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; shares colStat even it has no certain term (and probably field).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=varun&quot; class=&quot;user-hover&quot; rel=&quot;varun&quot;&gt;varun&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erickerickson&quot; class=&quot;user-hover&quot; rel=&quot;erickerickson&quot;&gt;erickerickson&lt;/a&gt;, what do you think if I commit it?    &lt;/p&gt;</comment>
                            <comment id="16054614" author="varunthacker" created="Mon, 19 Jun 2017 19:15:40 +0000"  >&lt;p&gt;Hi Mikhail,&lt;/p&gt;

&lt;p&gt;I&apos;ll take a look at it within the next 2-3 days. Please don&apos;t hold it up for me if you are confident about the patch &lt;/p&gt;</comment>
                            <comment id="16062116" author="jira-bot" created="Sat, 24 Jun 2017 20:35:19 +0000"  >&lt;p&gt;Commit 3b07e7241ebc539c5acdc642f83e174e5bea9744 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mkhludnev&quot; class=&quot;user-hover&quot; rel=&quot;mkhludnev&quot;&gt;mkhludnev&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=3b07e72&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=3b07e72&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10824&quot; title=&quot;java.lang.NullPointerException ExactSharedStatsCache.getPerShardTermStats &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10824&quot;&gt;&lt;del&gt;SOLR-10824&lt;/del&gt;&lt;/a&gt;: fixing NPE ExactSharedStatsCache, avoid maxdocs skew on&lt;br/&gt;
unique terms.&lt;/p&gt;</comment>
                            <comment id="16062146" author="jira-bot" created="Sat, 24 Jun 2017 21:38:15 +0000"  >&lt;p&gt;Commit 49e230edf045ec162a962adc064e76161fa76e36 in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mkhludnev&quot; class=&quot;user-hover&quot; rel=&quot;mkhludnev&quot;&gt;mkhludnev&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=49e230e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=49e230e&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10824&quot; title=&quot;java.lang.NullPointerException ExactSharedStatsCache.getPerShardTermStats &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10824&quot;&gt;&lt;del&gt;SOLR-10824&lt;/del&gt;&lt;/a&gt;: fixing NPE ExactSharedStatsCache, avoid maxdocs skew on&lt;br/&gt;
unique terms.&lt;/p&gt;</comment>
                            <comment id="16062260" author="mkhludnev" created="Sun, 25 Jun 2017 08:09:23 +0000"  >&lt;p&gt;got a failure &lt;a href=&quot;https://builds.apache.org/job/Lucene-Solr-Tests-master/1901/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Lucene-Solr-Tests-master/1901/testReport/&lt;/a&gt; looking into&lt;/p&gt;</comment>
                            <comment id="16062383" author="mkhludnev" created="Sun, 25 Jun 2017 17:24:15 +0000"  >&lt;ol&gt;
	&lt;li&gt;it fails on ith distrib test iteration, where i&amp;gt;1&lt;/li&gt;
	&lt;li&gt;it looks like max doc difference between shaded {{ 6.0 = docCount}} and control &lt;tt&gt;12.0 = docCount&lt;/tt&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;======================= Control Response =======================
{responseHeader={status=0,QTime=1},response={numFound=1,start=0,maxScore=2.871802,docs=[SolrDocument{id=11, range_facet_l=[11], id_i1=11, range_facet_l_dv=[11], range_facet_i_dv=[11], a_t=[one two three], shard_i=[3], multiDefault=[muLti-Default], 

rawquerystring=id:11,querystring=id:11,parsedquery=id:11,parsedquery_toString=id:11,explain={11=
2.871802 = weight(id:11 in 3) [MockConfigurableSimilarity], result of:
  2.871802 = fieldWeight in 3, product of:
    1.0 = tf(freq=1.0), with freq of:
      1.0 = termFreq=1.0
    2.871802 = idf, computed as log((docCount+1)/(docFreq+1)) + 1 from:
      1.0 = docFreq
      12.0 = docCount
    1.0 = fieldNorm(doc=3)
},QParser=LuceneQParser,timing={time=1.0,


======================= Shard Response =======================

{responseHeader={status=0,QTime=12},response={numFound=1,start=0,maxScore=2.252763,docs=[SolrDocument{id=11, range_facet_l=[11], id_i1=11, range_facet_l_dv=[11], range_facet_i_dv=[11], 
debug={rawquerystring=id:11,querystring=id:11,parsedquery=id:11,parsedquery_toString=id:11,explain={11=
2.252763 = weight(id:11 in 0) [MockConfigurableSimilarity], result of:
  2.252763 = fieldWeight in 0, product of:
    1.0 = tf(freq=1.0), with freq of:
      1.0 = termFreq=1.0
    2.252763 = idf, computed as log((docCount+1)/(docFreq+1)) + 1 from:
      1.0 = docFreq
      6.0 = docCount
    1.0 = fieldNorm(doc=0)
},QParser=LuceneQParser,
rawquerystring=id:11,querystring=id:11,parsedquery=id:11,parsedquery_toString=id:11,QParser=LuceneQParser,explain={11=
2.252763 = weight(id:11 in 0) [MockConfigurableSimilarity], result of:
  2.252763 = fieldWeight in 0, product of:
    1.0 = tf(freq=1.0), with freq of:
      1.0 = termFreq=1.0
    2.252763 = idf, computed as log((docCount+1)/(docFreq+1)) + 1 from:
      1.0 = docFreq
      6.0 = docCount
    1.0 = fieldNorm(doc=0)
}}}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;   &lt;/li&gt;
&lt;/ol&gt;


&lt;ol&gt;
	&lt;li&gt;obviously, &lt;tt&gt;optimize=true&lt;/tt&gt; fixes it.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="16062628" author="mkhludnev" created="Mon, 26 Jun 2017 07:41:15 +0000"  >&lt;p&gt;ok. wrong score is cached on request earlier stages (??) and then retrieved from query result cache. Thus, disabling cache fixed the seed&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;diff --git a/solr/core/src/test/org/apache/solr/search/stats/TestDefaultStatsCache.java b/solr/core/src/test/org/apache/solr/search/stats/TestDefaultStatsCache.java
index 88300ba..f577387 100644
--- a/solr/core/src/test/org/apache/solr/search/stats/TestDefaultStatsCache.java
+++ b/solr/core/src/test/org/apache/solr/search/stats/TestDefaultStatsCache.java
@@ -73,7 +73,7 @@
     commit();
 
     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (aDocId != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
-      dfQuery(&lt;span class=&quot;code-quote&quot;&gt;&quot;q&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;id:&quot;&lt;/span&gt;+aDocId,&lt;span class=&quot;code-quote&quot;&gt;&quot;debugQuery&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;fl&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;*,score&quot;&lt;/span&gt;);
+      dfQuery(&lt;span class=&quot;code-quote&quot;&gt;&quot;q&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;{!cache=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;}id:&quot;&lt;/span&gt;+aDocId,&lt;span class=&quot;code-quote&quot;&gt;&quot;debugQuery&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;fl&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;*,score&quot;&lt;/span&gt;);
     }
     dfQuery(&lt;span class=&quot;code-quote&quot;&gt;&quot;q&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;a_t:one a_t:four&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;debugQuery&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;fl&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;*,score&quot;&lt;/span&gt;);
   }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; </comment>
                            <comment id="16062814" author="mkhludnev" created="Mon, 26 Jun 2017 09:03:50 +0000"  >&lt;p&gt;Ok. Randomised test have found a nice case: &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;search &lt;tt&gt;id:11&lt;/tt&gt;, got it cached in query results.&lt;/li&gt;
	&lt;li&gt;add docs, commit&lt;/li&gt;
	&lt;li&gt;it triggers cache regeneration, this query is executed per every shard. However, their scores are local only.&lt;/li&gt;
	&lt;li&gt;search &lt;tt&gt;id:11&lt;/tt&gt; again, got cache hit, retrieve local only scores. Ignore exact stats, even they are properly distributed via &lt;tt&gt;GET_TERM_STATS&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16062829" author="jira-bot" created="Mon, 26 Jun 2017 09:16:17 +0000"  >&lt;p&gt;Commit 7c448623ccb1d7284f72144bb69e2998051f75ab in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mkhludnev&quot; class=&quot;user-hover&quot; rel=&quot;mkhludnev&quot;&gt;mkhludnev&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=7c44862&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=7c44862&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10824&quot; title=&quot;java.lang.NullPointerException ExactSharedStatsCache.getPerShardTermStats &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10824&quot;&gt;&lt;del&gt;SOLR-10824&lt;/del&gt;&lt;/a&gt;: fixing stats tests: ignore local scores from query result cache.&lt;/p&gt;</comment>
                            <comment id="16062834" author="jira-bot" created="Mon, 26 Jun 2017 09:19:16 +0000"  >&lt;p&gt;Commit 735365e7ee7dec251a8d9e0484e1bc904636848b in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mkhludnev&quot; class=&quot;user-hover&quot; rel=&quot;mkhludnev&quot;&gt;mkhludnev&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=735365e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=735365e&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10824&quot; title=&quot;java.lang.NullPointerException ExactSharedStatsCache.getPerShardTermStats &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10824&quot;&gt;&lt;del&gt;SOLR-10824&lt;/del&gt;&lt;/a&gt;: fixing stats tests: ignore local scores from query result cache.&lt;/p&gt;</comment>
                            <comment id="16062852" author="mkhludnev" created="Mon, 26 Jun 2017 09:47:51 +0000"  >&lt;p&gt;followup &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10952&quot; title=&quot;Exact*Stats are ignored due to query result cache&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10952&quot;&gt;SOLR-10952&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="16063400" author="steve_rowe" created="Mon, 26 Jun 2017 16:56:58 +0000"  >&lt;p&gt;Policeman Jenkins found a reproducing seed for &lt;tt&gt;TestPullReplica.testKillLeader()&lt;/tt&gt; that &lt;tt&gt;git bisect&lt;/tt&gt; blames on commit &lt;tt&gt;7c448623ccb&lt;/tt&gt; on this issue &lt;a href=&quot;https://jenkins.thetaphi.de/job/Lucene-Solr-master-Linux/19974&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://jenkins.thetaphi.de/job/Lucene-Solr-master-Linux/19974&lt;/a&gt;:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   [junit4]   2&amp;gt; NOTE: reproduce with: ant test  -Dtestcase=TestPullReplica -Dtests.method=testKillLeader -Dtests.seed=E7D383DCC0B7483C -Dtests.multiplier=3 -Dtests.slow=true -Dtests.locale=ar-KW -Dtests.timezone=Australia/Queensland -Dtests.asserts=true -Dtests.file.encoding=UTF-8
   [junit4] FAILURE 96.4s J2 | TestPullReplica.testKillLeader &amp;lt;&amp;lt;&amp;lt;
   [junit4]    &amp;gt; Throwable #1: java.lang.AssertionError: Replica state not updated in cluster state
   [junit4]    &amp;gt; null
   [junit4]    &amp;gt; Live Nodes: [127.0.0.1:44447_solr, 127.0.0.1:34771_solr]
   [junit4]    &amp;gt; Last available state: DocCollection(pull_replica_test_kill_leader//collections/pull_replica_test_kill_leader/state.json/6)={
   [junit4]    &amp;gt;   &quot;pullReplicas&quot;:&quot;1&quot;,
   [junit4]    &amp;gt;   &quot;replicationFactor&quot;:&quot;1&quot;,
   [junit4]    &amp;gt;   &quot;shards&quot;:{&quot;shard1&quot;:{
   [junit4]    &amp;gt;       &quot;range&quot;:&quot;80000000-7fffffff&quot;,
   [junit4]    &amp;gt;       &quot;state&quot;:&quot;active&quot;,
   [junit4]    &amp;gt;       &quot;replicas&quot;:{
   [junit4]    &amp;gt;         &quot;core_node1&quot;:{
   [junit4]    &amp;gt;           &quot;core&quot;:&quot;pull_replica_test_kill_leader_shard1_replica_n1&quot;,
   [junit4]    &amp;gt;           &quot;base_url&quot;:&quot;http://127.0.0.1:44447/solr&quot;,
   [junit4]    &amp;gt;           &quot;node_name&quot;:&quot;127.0.0.1:44447_solr&quot;,
   [junit4]    &amp;gt;           &quot;state&quot;:&quot;down&quot;,
   [junit4]    &amp;gt;           &quot;type&quot;:&quot;NRT&quot;,
   [junit4]    &amp;gt;           &quot;leader&quot;:&quot;true&quot;},
   [junit4]    &amp;gt;         &quot;core_node2&quot;:{
   [junit4]    &amp;gt;           &quot;core&quot;:&quot;pull_replica_test_kill_leader_shard1_replica_p1&quot;,
   [junit4]    &amp;gt;           &quot;base_url&quot;:&quot;http://127.0.0.1:34771/solr&quot;,
   [junit4]    &amp;gt;           &quot;node_name&quot;:&quot;127.0.0.1:34771_solr&quot;,
   [junit4]    &amp;gt;           &quot;state&quot;:&quot;active&quot;,
   [junit4]    &amp;gt;           &quot;type&quot;:&quot;PULL&quot;}}}},
   [junit4]    &amp;gt;   &quot;router&quot;:{&quot;name&quot;:&quot;compositeId&quot;},
   [junit4]    &amp;gt;   &quot;maxShardsPerNode&quot;:&quot;100&quot;,
   [junit4]    &amp;gt;   &quot;autoAddReplicas&quot;:&quot;false&quot;,
   [junit4]    &amp;gt;   &quot;nrtReplicas&quot;:&quot;1&quot;,
   [junit4]    &amp;gt;   &quot;tlogReplicas&quot;:&quot;0&quot;}
   [junit4]    &amp;gt; 	at __randomizedtesting.SeedInfo.seed([E7D383DCC0B7483C:AEC57768A20CDC6A]:0)
   [junit4]    &amp;gt; 	at org.apache.solr.cloud.SolrCloudTestCase.waitForState(SolrCloudTestCase.java:269)
   [junit4]    &amp;gt; 	at org.apache.solr.cloud.TestPullReplica.doTestNoLeader(TestPullReplica.java:401)
   [junit4]    &amp;gt; 	at org.apache.solr.cloud.TestPullReplica.testKillLeader(TestPullReplica.java:290)
   [junit4]    &amp;gt; 	at java.lang.Thread.run(Thread.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16063676" author="mkhludnev" created="Mon, 26 Jun 2017 20:07:50 +0000"  >&lt;ol&gt;
	&lt;li&gt;this test doesn&apos;t ever load neither of exact stats&lt;/li&gt;
	&lt;li&gt;it reproduces quite unstable&lt;/li&gt;
	&lt;li&gt;I checked my mail and found similar failures on Jun 3rd, 10th, 17th at Policeman Jenkins.&lt;br/&gt;
So, I don&apos;t think I can help here anyhow.   &lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="16063693" author="steve_rowe" created="Mon, 26 Jun 2017 20:19:43 +0000"  >&lt;p&gt;Okay &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mkhludnev&quot; class=&quot;user-hover&quot; rel=&quot;mkhludnev&quot;&gt;mkhludnev&lt;/a&gt;, thanks for looking into it.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13078344">SOLR-10852</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13082457">SOLR-10952</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12842915">SOLR-7756</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12873129" name="SOLR-10824.patch" size="7399" author="mkhl" created="Thu, 15 Jun 2017 14:26:35 +0000"/>
                            <attachment id="12873083" name="SOLR-10824.patch" size="2518" author="mkhl" created="Thu, 15 Jun 2017 08:17:24 +0000"/>
                            <attachment id="12873078" name="SOLR-10824.patch" size="873" author="mkhl" created="Thu, 15 Jun 2017 08:08:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 21 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3fxcv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>