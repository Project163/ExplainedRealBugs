<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:09:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-17018] LTR queries producing out of memory issues</title>
                <link>https://issues.apache.org/jira/browse/SOLR-17018</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;LTR queries are producing oom and looks like the issue is same as what is described on this &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5986&quot; title=&quot;Don&amp;#39;t allow runaway queries from harming Solr cluster health or search performance&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5986&quot;&gt;&lt;del&gt;SOLR-5986&lt;/del&gt;&lt;/a&gt;.&#160; Query that has 10 or more terms, and LTR trying to compute features for such queries lead to full heap usage, invoking full GC and stop the world.&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13553310">SOLR-17018</key>
            <summary>LTR queries producing out of memory issues</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="rajanimaski">rajanimaski</reporter>
                        <labels>
                            <label>ltr</label>
                    </labels>
                <created>Sun, 8 Oct 2023 23:47:53 +0000</created>
                <updated>Fri, 17 Oct 2025 20:05:21 +0000</updated>
                            <resolved>Mon, 8 Apr 2024 14:07:01 +0000</resolved>
                                    <version>9.1.1</version>
                                    <fixVersion>9.6</fixVersion>
                    <fixVersion>10.0</fixVersion>
                                    <component>contrib - LTR</component>
                    <component>ltr</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="18000">5h</timespent>
                                <comments>
                            <comment id="17774195" author="rajanimaski" created="Wed, 11 Oct 2023 18:40:38 +0000"  >&lt;p&gt;&#160;ok figured it is lengthy queries &quot;q&quot; having many query terms.&#160; LTR feature tries to compute tfidf of such a query and reports &quot;The request took too long to iterate over terms&quot; in log file and on heap, the query parser tries to parse the query fills it up causing full heap use and following by oom.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.solr.search.ReRankCollector @ 0x699161e600.00 MB70.81 MB1.16%org.apache.lucene.search.BooleanQuery @ 0x6991798000.00 MB0.03 MB0.00%java.lang.ThreadLocal$ThreadLocalMap @ 0x69440b3b00.00 MB0.03 MB0.00%org.apache.lucene.search.BooleanQuery @ 0x6b50f73f00.00 MB0.03 MB0.00%org.apache.lucene.queries.function.FunctionScoreQuery @ 0x699167f180.00 MB0.02 MB0.00%com.shutterstock.solr.parser.expression.Expression @ 0x699161c200.00 MB0.01 MB0.00%org.apache.solr.response.SolrQueryResponse @ 0x6991620780.00 MB0.00 MB0.00%java.util.ArrayList @ 0x6991882b00.00 MB0.00 MB0.00%org.apache.solr.handler.component.ResponseBuilder @ 0x699161fa80.00 MB0.00 MB0.00%java.lang.String @ 0x6b50fe8d0 {!edismax qf=description.en pf2=description.en}((bang) OR (blast) OR (blow AND up) OR (breakout) OR (burst) OR (explosion) OR (gale) OR (outbreak) OR (outburst) OR (esplosione)) AND ((dust) OR (filing) OR (powder) OR (polvere)) AND ((blanche) OR (white) OR...0.00 MB0.00 MB0.00%java.lang.String @ 0x6b50fe3b0 ((bang) OR (blast) OR (blow AND up) OR (breakout) OR (burst) OR (explosion) OR (gale) OR (outbreak) OR (outburst) OR (esplosione)) AND ((dust) OR (filing) OR (powder) OR (polvere)) AND ((blanche) OR (white) OR (white AND woman) OR (bianca)) AND ((confine) ...0.00 MB0.00 MB0.00%java.util.ArrayList @ 0x699161d780.00 MB0.00 MB0.00%org.apache.solr.search.ExtendedDismaxQParser$ExtendedDismaxConfiguration @ 0x699161ca00.00 MB0.00 MB0.00%&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;example query and feature defintion &quot;{!edismax qf=description.en pf2=description.en}&quot;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;q=((bang) OR (blast) OR (blow AND up) OR (breakout) OR (burst) OR (explosion) OR (gale) OR (outbreak) OR (outburst) OR (esplosione)) AND ((dust) OR (filing) OR (powder) OR (polvere)) AND ((blanche) OR (white) OR (white AND woman) OR (bianca)) AND ((confine) OR (cut AND off) OR (insular) OR (insulate) OR (insulated) OR (insulating) OR (insulation) OR (insulator) OR (insulators) OR (island) OR (islander) OR (islands) OR (isle) OR (isolable) OR (isolatable) OR (isolate) OR (isolated) OR (isolates) OR (isolation) OR (isolations) OR (isolete) OR (lonely) OR (remote) OR (seal) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thinking this is bug as it causes stop the world. This literally takes over full heap, causes high gc activity (filling up tenured space), high cpu usage.&#160;&lt;/p&gt;</comment>
                            <comment id="17774943" author="dsmiley" created="Fri, 13 Oct 2023 15:11:01 +0000"  >&lt;p&gt;Just an FYI, Solr 9.3 changed timeAllowed implementation &#8211; &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16693&quot; title=&quot;Use TimeLimitingBulkScorer; stop using ExitableDirectoryReader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16693&quot;&gt;&lt;del&gt;SOLR-16693&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17779837" author="JIRAUSER302634" created="Thu, 26 Oct 2023 10:41:51 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt;, just to confirm my understanding:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;LTR does not respect timeAllowed in any Solr version.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;ExitableDirectoryReader&lt;/tt&gt; that was the default until 9.3 respects timeAllowed in core query processing + spellcheck + faceting but not LTR.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;TimeLimitingBulkScorer&lt;/tt&gt; that is the new default in 9.3 respects timeAllowed in query processing only. So it won&apos;t help, it could only make OOM more likely, not withstanding the performance improvement.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17780065" author="dsmiley" created="Thu, 26 Oct 2023 19:33:58 +0000"  >&lt;p&gt;Yes Ahmed.  (LTR &amp;amp; timeAllowed is foreign to me; but what you say seems right based on the linked issue &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14607&quot; title=&quot;LTR Query, timeAllowed parameter causes a timeout exception with no result&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14607&quot;&gt;&lt;del&gt;SOLR-14607&lt;/del&gt;&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="17827551" author="alessandro.benedetti" created="Fri, 15 Mar 2024 16:40:06 +0000"  >&lt;p&gt;There&apos;s been some active development in the area and after a good amount of investigations, I drafted a first pull request that&apos;s ready for review.&lt;/p&gt;</comment>
                            <comment id="17834231" author="jira-bot" created="Fri, 5 Apr 2024 09:53:45 +0000"  >&lt;p&gt;Commit 44211bc40a7cd93507772cf2746a07bcecdee9a0 in solr&apos;s branch refs/heads/main from Alessandro Benedetti&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=44211bc40a7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=44211bc40a7&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17018&quot; title=&quot;LTR queries producing out of memory issues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17018&quot;&gt;&lt;del&gt;SOLR-17018&lt;/del&gt;&lt;/a&gt;: add QueryLimits support to Learning To Rank rescoring (#2348)&lt;/p&gt;

&lt;p&gt;Co-authored-by: Christine Poerschke &amp;lt;cpoerschke@apache.org&amp;gt;&lt;/p&gt;</comment>
                            <comment id="17834240" author="jira-bot" created="Fri, 5 Apr 2024 10:29:16 +0000"  >&lt;p&gt;Commit e767003fa110cc21c52f83cb5c95c0dba1ad2e27 in solr&apos;s branch refs/heads/branch_9x from Alessandro Benedetti&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=e767003fa11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=e767003fa11&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17018&quot; title=&quot;LTR queries producing out of memory issues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17018&quot;&gt;&lt;del&gt;SOLR-17018&lt;/del&gt;&lt;/a&gt;: add QueryLimits support to Learning To Rank rescoring (#2348)&lt;/p&gt;

&lt;p&gt;Co-authored-by: Christine Poerschke &amp;lt;cpoerschke@apache.org&amp;gt;&lt;br/&gt;
(cherry picked from commit 44211bc40a7cd93507772cf2746a07bcecdee9a0)&lt;/p&gt;</comment>
                            <comment id="17834936" author="alessandro.benedetti" created="Mon, 8 Apr 2024 14:07:01 +0000"  >&lt;p&gt;Thanks to everyone involved, the contribution is now merged and backported to 9.x&lt;br/&gt;
I&apos;ll also backported the bugfix to 9.1.x as a client requested it. But the contribution there will be much different as there was no support for Query Limits back then.&lt;/p&gt;

&lt;p&gt;As additional follow ups I created this Jira issues:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Sleep function query to sleep on execution rather than parsing (&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17225&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-17225&lt;/a&gt;))&lt;/li&gt;
	&lt;li&gt;Query limits should be checked also for feature extraction (&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17226&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-17226&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;Refactor of ScoreFeatures (&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17227&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-17227&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;Double label MaybeShouldExit (&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17229&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-17229&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;Better documentation for timeAllowed and partial results (&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17229&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-17229&lt;/a&gt;)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Anyone is welcome to contribute to them, I may do some of them myself (or my team) later on&lt;/p&gt;</comment>
                            <comment id="17837242" author="jira-bot" created="Mon, 15 Apr 2024 13:15:14 +0000"  >&lt;p&gt;Commit 18c0babed4a024d150b30c89cf99983c584b190f in solr&apos;s branch refs/heads/branch_9_1 from Alessandro Benedetti&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=18c0babed4a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=18c0babed4a&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Fix/solr 17018 branch 9 1 (#2358)&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17018&quot; title=&quot;LTR queries producing out of memory issues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17018&quot;&gt;&lt;del&gt;SOLR-17018&lt;/del&gt;&lt;/a&gt;: Query limit timeout is now supported by Learning To Rank rescoring.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17837246" author="alessandro.benedetti" created="Mon, 15 Apr 2024 13:17:54 +0000"  >&lt;p&gt;The bugfix has been also backported to 9.1.x.&lt;br/&gt;
I&apos;ll now monitor the builds for a few days and then volunteer for a 9.1.2 release.&lt;/p&gt;</comment>
                            <comment id="17841728" author="gus_heck" created="Sun, 28 Apr 2024 19:22:40 +0000"  >&lt;p&gt;Closing after the 9.6.0 release&lt;/p&gt;</comment>
                            <comment id="17845633" author="dsmiley" created="Sat, 11 May 2024 18:06:38 +0000"  >&lt;p&gt;I see a small uptick in TestLTRQParserPlugin &lt;a href=&quot;http://fucit.org/solr-jenkins-reports/failure-report.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;failing&lt;/a&gt; since early April. &#160;Maybe related?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13314327">SOLR-14607</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13314327">SOLR-14607</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13566694">SOLR-17138</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13063488" name="image-2023-10-11-14-38-43-351.png" size="1010151" author="rajanimaski" created="Wed, 11 Oct 2023 18:38:44 +0000"/>
                            <attachment id="13064861" name="image-2023-11-30-12-26-04-053.png" size="176886" author="rajanimaski" created="Thu, 30 Nov 2023 17:26:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 26 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1kt5k:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>