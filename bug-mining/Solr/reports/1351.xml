<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:35:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-4652] Resource loader has broken behavior for solr.xml plugins (basically ShardHandlerFactory)</title>
                <link>https://issues.apache.org/jira/browse/SOLR-4652</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;I have the following scenario:&lt;br/&gt;
MyShardHandlerFactory is plugged in via solr.xml.  The jar containing MyShardHandlerFactory is in the shared lib dir.  There are a couple issues:&lt;/p&gt;

&lt;p&gt;1. From within a per core handler (that is loaded within the core&apos;s lib dir), you grab the ShardHandlerFactory from CoreContainer, casting to MyShardHandlerFactory will results in a ClassCastException with a message like &quot;cannot cast instance of MyShardHandlerFactory to MyShardHandlerFactory&quot;.&lt;/p&gt;

&lt;p&gt;2. Adding a custom dir for shared lib (for example &quot;mylib&quot;) does not work.  The ShardHandlerFactory is initialized before sharedLib is loaded.&lt;/p&gt;

&lt;p&gt;I&apos;ve been pouring through the code on this and I don&apos;t see an easy fix.  I&apos;ll keep looking at it, but I wanted to get this up so hopefully others have some thoughts on how best to fix.  IMO, it seems like there needs to be a clear chain of resource loaders (one for loading solr.xml, a child for loading the lib dir, used for solr.xml plugins, a grandchild for per core config, and a great grandchild for per core lib dir based plugins).  Right now there are some siblings, because any place a SolrResourceLoader is created with a null parent classloader, it gets the jetty thread&apos;s classloader as the parent.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12639705">SOLR-4652</key>
            <summary>Resource loader has broken behavior for solr.xml plugins (basically ShardHandlerFactory)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="uschindler">Uwe Schindler</assignee>
                                    <reporter username="rjernst">Ryan Ernst</reporter>
                        <labels>
                    </labels>
                <created>Thu, 28 Mar 2013 23:04:07 +0000</created>
                <updated>Mon, 9 May 2016 18:56:20 +0000</updated>
                            <resolved>Tue, 2 Apr 2013 23:48:10 +0000</resolved>
                                    <version>4.2</version>
                                    <fixVersion>4.3</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13616802" author="thetaphi" created="Thu, 28 Mar 2013 23:19:47 +0000"  >&lt;p&gt;Hi Ryan,&lt;br/&gt;
thanks for bringing this up, you made my day! I was also disappointed when I was digging into that several times, last time when working on Lucene&apos;s SPI issues.&lt;br/&gt;
In my opinion, the context classloader should be out of scope (in general, code that uses the context class loader as a &quot;default&quot; because no other classloader is there is buggy to me and may drive crazy under certain circumstances like different per-thread behaviour, e.g. in callbacks called from system threads).&lt;br/&gt;
The ResourceLoaders/Classloaders in Solr should be built on startup of the webapplication and should use the webapp classloader as root (and dont use context class loader as replacement for webapp classloader, just get it e.g. from inside the SolrDispatchFilter&apos;s init method like this.getClass().getClassLoader()). Any classloader created from solr should be a child/grandchild of this root class loader. The core container&apos;s resource loader should be the only child of the webapp classloader. Every solr core then should be a child of the core container&apos;s classloader. Also those resource loaders must use parent-first semantics as Java suggests (in that case its unlikely that you get class cannot be cast to same name...).&lt;br/&gt;
I simply had no time to fix this, but I may be able to help. A correct classloader design is hard, but doable - and your issue confirms my problems with the current design.&lt;/p&gt;</comment>
                            <comment id="13616825" author="markrmiller@gmail.com" created="Thu, 28 Mar 2013 23:39:28 +0000"  >&lt;p&gt;The crux of the issue is that solr.xml was never able to specify stuff like this before - so the entire design is still basically what we had when Solr was single core.&lt;/p&gt;

&lt;p&gt;As far as I remember, shard handler started in solrconfig.xml and was per core. At some point, someone moved it to core container so that things like the thread pool could be shared across cores. At this point, we lost the ability to configure it - support was simply removed.&lt;/p&gt;

&lt;p&gt;Much later, I needed to set some timeouts for freebsd blackhole reasons and I found I had no way to do this - so I shoved the shardhandler into solr.xml simply so I could set these timeouts in tests. This is why you couldn&apos;t even change the impl - it was all just falling debris.&lt;/p&gt;

&lt;p&gt;At least, if I remember the sequence of events correctly.&lt;/p&gt;

&lt;p&gt;Now that shard handler is in solr.xml and properly supported, it only seems likely that further things will move to solr.xml that belong at the core container level, and so +1 to coming up with a design that makes all this work as it should.&lt;/p&gt;</comment>
                            <comment id="13618223" author="rjernst" created="Sun, 31 Mar 2013 03:53:50 +0000"  >&lt;p&gt;I&apos;ve spent the better part of 2 days going down the road of refactoring how SolrResourceLoaders are created (to make the chain explicit as Uwe suggested), but this was getting very hairy...&lt;/p&gt;

&lt;p&gt;To solve this issue I am trying something more simple for now.  I&apos;m happy to create another jira for refactoring how the classloader/resource loader chains are created.&lt;/p&gt;</comment>
                            <comment id="13618226" author="rjernst" created="Sun, 31 Mar 2013 03:57:35 +0000"  >&lt;p&gt;This patch makes core resource loaders use the CoreContainer.loader.getClassLoader() as it&apos;s parent (solves issue #1) and adds sharedLib to CoreContainer.loader&apos;s class loader before initializing the shard handler factory (solves issue #2).&lt;/p&gt;

&lt;p&gt;I would like to add a unit test to ensure this isn&apos;t broken by any future refactoring here.  Any thoughts on where, or how (since most tests seem to bypass this initialization for core container) I should add a test?&lt;/p&gt;</comment>
                            <comment id="13618603" author="rcmuir" created="Mon, 1 Apr 2013 04:28:04 +0000"  >&lt;p&gt;Can a test be written that just does the simplest checks: getting the loaders and verifying the &quot;hierarchy&quot; with Classloader.getParent()?&lt;/p&gt;

&lt;p&gt;Separately about the refactoring, i think Uwe mentioned (then deleted) a key step for a future issue: in order to be able to guarantee its correct in the future, a good rote refactoring step after this issue would be to remove the &apos;treat null as context classloader&apos; (instead throw exception if its null!) from SolrResourceLoader and remove the ctor that takes no parent classloader: this way its explicit what is happening everywhere and would reduce the confusion.&lt;/p&gt;</comment>
                            <comment id="13618638" author="rjernst" created="Mon, 1 Apr 2013 06:05:42 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Separately about the refactoring, i think Uwe mentioned (then deleted) a key step for a future issue: in order to be able to guarantee its correct in the future, a good rote refactoring step after this issue would be to remove the &apos;treat null as context classloader&apos; (instead throw exception if its null!) from SolrResourceLoader and remove the ctor that takes no parent classloader: this way its explicit what is happening everywhere and would reduce the confusion.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah, this is the route I had started going down when I realized it was a sizable undertaking.  I&apos;ve created a separate issue:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4659&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-4659&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13618639" author="rjernst" created="Mon, 1 Apr 2013 06:07:56 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Can a test be written that just does the simplest checks: getting the loaders and verifying the &quot;hierarchy&quot; with Classloader.getParent()?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good idea.  Done with this new patch.&lt;/p&gt;</comment>
                            <comment id="13618830" author="rcmuir" created="Mon, 1 Apr 2013 15:31:59 +0000"  >&lt;p&gt;Patch looks good!&lt;/p&gt;</comment>
                            <comment id="13618834" author="thetaphi" created="Mon, 1 Apr 2013 15:36:31 +0000"  >&lt;p&gt;Patch looks fine for now, need to have a closer look. For future patches, please dont reorder import statements, but thats not problematic here.&lt;/p&gt;</comment>
                            <comment id="13618845" author="thetaphi" created="Mon, 1 Apr 2013 15:47:06 +0000"  >&lt;p&gt;Hi Ryan,&lt;br/&gt;
I will take care of this issue. Thanks for spending your time in fixing the resource/classloader hell.&lt;/p&gt;

&lt;p&gt;I will review your patch more closely and will commit it for 4.x and trunk.&lt;/p&gt;</comment>
                            <comment id="13618894" author="rjernst" created="Mon, 1 Apr 2013 16:40:51 +0000"  >&lt;blockquote&gt;
&lt;p&gt;For future patches, please dont reorder import statements, but thats not problematic here.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sorry about that.  I have intellij set to reorder imports automatically.  I&apos;ll figure out how to turn this off for my lucene-solr project.&lt;/p&gt;</comment>
                            <comment id="13620414" author="thetaphi" created="Tue, 2 Apr 2013 23:39:47 +0000"  >&lt;p&gt;Hi Ryan,&lt;br/&gt;
I reviewed your patch, which unfortunately did no longer apply to trunk, because there were changes in CoreContainer. As your patch was no SVN patch, my client was not able to download the correct SVN revision number for your patch, so I had to try out. I was then able to upgrade to latest Solr trunk.&lt;/p&gt;

&lt;p&gt;It would be better to supply Subversion patches in the future, because they contain the metadata required to correctly apply the patches. At least mention the revision number in SVN it was created against.&lt;/p&gt;

&lt;p&gt;I reverted the changes in import statements and in your test I used assertSame() instead of assertEquals(), because the classloader must be the same (==) not equal ones.&lt;/p&gt;

&lt;p&gt;I will commit this soon, once all tests passed.&lt;/p&gt;</comment>
                            <comment id="13620416" author="thetaphi" created="Tue, 2 Apr 2013 23:48:10 +0000"  >&lt;p&gt;Committed to trunk and 4.x Will be released with Lucene/Solr 4.3.&lt;/p&gt;

&lt;p&gt;Thanks Ryan, I hope we can fix the remaining issues with chaining of classloaders (disallowing null/context class loader as default classloader, using webapp classloader instead of context one)!&lt;/p&gt;</comment>
                            <comment id="13620470" author="rjernst" created="Wed, 3 Apr 2013 01:03:48 +0000"  >&lt;p&gt;Thanks Uwe!&lt;/p&gt;

&lt;p&gt;I&apos;ve disabled the &quot;auto reorder imports&quot; feature from IntelliJ, so that should be better in future patches.  I will also make sure to figure out the svn revision or use an svn checkout.  Sorry about the hassle!&lt;/p&gt;

&lt;p&gt;I&apos;m hoping to tackle refactoring of the shard handler factory stuff next, but then coming back to classloader chaining is a possibility.  As I said before, I did start down that road...it is just a doozy.  It is pretty straightforward until you get to ZkSolrResourceLoader, then it seemed to get complicated (I stopped there, so I am not sure if there is an easy path there).&lt;/p&gt;</comment>
                            <comment id="13620471" author="markrmiller@gmail.com" created="Wed, 3 Apr 2013 01:06:20 +0000"  >&lt;blockquote&gt;&lt;p&gt;ZkSolrResourceLoader&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If you fill me in, I can probably help. ZkSolrResourceLoader should be pretty simple - it&apos;s intent is simply to load from zk if possible before falling back to how SolrResourceLoader would load - essentially.&lt;/p&gt;</comment>
                            <comment id="13654296" author="thetaphi" created="Fri, 10 May 2013 10:34:41 +0000"  >&lt;p&gt;Closed after release.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12576691" name="SOLR-4652.patch" size="5991" author="uschindler" created="Tue, 2 Apr 2013 23:39:47 +0000"/>
                            <attachment id="12576343" name="SOLR-4652.patch" size="10694" author="rjernst" created="Mon, 1 Apr 2013 06:07:56 +0000"/>
                            <attachment id="12576266" name="SOLR-4652.patch" size="8431" author="rjernst" created="Sun, 31 Mar 2013 03:57:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>320174</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 28 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1j8rz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>320515</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>