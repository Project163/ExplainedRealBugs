<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:40:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-13701] JWTAuthPlugin calls authenticationFailure (which calls HttpServletResponsesendError) before updating metrics - breaks tests</title>
                <link>https://issues.apache.org/jira/browse/SOLR-13701</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;The way JWTAuthPlugin is currently implemented, any failures are sent to the remote client (via &lt;tt&gt;authenticationFailure(...)&lt;/tt&gt; which calls &lt;tt&gt;HttpServletResponsesendError(...)&lt;/tt&gt;) &lt;b&gt;before&lt;/b&gt; &lt;tt&gt;JWTAuthPlugin.doAuthenticate(...)&lt;/tt&gt; has a chance to update it&apos;s metrics (like &lt;tt&gt;numErrors&lt;/tt&gt; and &lt;tt&gt;numWrongCredentials&lt;/tt&gt;)&lt;/p&gt;

&lt;p&gt;This causes a race condition in tests where test threads can:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;see an error response/Exception before the server thread has updated metrics (like &lt;tt&gt;numErrors&lt;/tt&gt; and &lt;tt&gt;numWrongCredentials&lt;/tt&gt;)&lt;/li&gt;
	&lt;li&gt;call white box methods like &lt;tt&gt;SolrCloudAuthTestCase.assertAuthMetricsMinimums(...)&lt;/tt&gt; to assert expected metrics&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;...all before the server thread has ever gotten around to being able to update the metrics in question.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;SolrCloudAuthTestCase.assertAuthMetricsMinimums(...)&lt;/tt&gt; currently has some &lt;tt&gt;&quot;First metrics count assert failed, pausing 2s before re-attempt&quot;&lt;/tt&gt; evidently to try and work around this bug, but it&apos;s still no garuntee that the server thread will be scheduled before the retry happens.&lt;/p&gt;

&lt;p&gt;We can/should just fix JWTAuthPlugin to ensure the metrics are updated before &lt;tt&gt;authenticationFailure(...)&lt;/tt&gt; is called, and then remove the &quot;pausing 2s before re-attempt&quot; logic from &lt;tt&gt;SolrCloudAuthTestCase&lt;/tt&gt; - between this bug fix, and the existing work around for &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13464&quot; title=&quot;no way for external clients to detect when changes to security config have taken effect&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13464&quot;&gt;SOLR-13464&lt;/a&gt;, there should be absolutely no reason to &quot;retry&quot; reading hte metrics.&lt;/p&gt;

&lt;p&gt;(NOTE: BasicAuthPlugin has a similar &lt;tt&gt;authenticationFailure(...)&lt;/tt&gt; method that also calls &lt;tt&gt;HttpServletResponse.sendError(...)&lt;/tt&gt; - but it already (correctly) updates the error/failure metrics &lt;b&gt;before&lt;/b&gt; calling that method.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13251134">SOLR-13701</key>
            <summary>JWTAuthPlugin calls authenticationFailure (which calls HttpServletResponsesendError) before updating metrics - breaks tests</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Chris M. Hostetter</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Fri, 16 Aug 2019 01:18:14 +0000</created>
                <updated>Thu, 12 May 2022 00:26:01 +0000</updated>
                            <resolved>Thu, 22 Aug 2019 00:35:27 +0000</resolved>
                                                    <fixVersion>8.3</fixVersion>
                    <fixVersion>9.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16908597" author="hossman" created="Fri, 16 Aug 2019 01:19:27 +0000"  >
&lt;p&gt;Attaching patch that addressess this.  &lt;/p&gt;

&lt;p&gt;I also updates the existing code paths that propogate the request via &lt;tt&gt;filterChain.doFilter(...)&lt;/tt&gt; to ensure that the associated metrics ( &lt;tt&gt;numPassThrough&lt;/tt&gt; and/or &lt;tt&gt;numAuthenticated&lt;/tt&gt; ) are updated &lt;b&gt;before&lt;/b&gt; &lt;tt&gt;filterChain.doFilter(...)&lt;/tt&gt; is called, so that they are correct even if a subsequent filter (or ultimately, the SolrCore/RequestHandler) encounters an error or otherwise rejects the request.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=janhoy&quot; class=&quot;user-hover&quot; rel=&quot;janhoy&quot;&gt;janhoy&lt;/a&gt; - would appreciate if you could review.&lt;/p&gt;</comment>
                            <comment id="16908886" author="janhoy" created="Fri, 16 Aug 2019 09:21:53 +0000"  >&lt;p&gt;Updating metrics before returning sounds reasonable since we assert on those counts (which has proven fragile).&lt;/p&gt;

&lt;p&gt;I don&apos;t see the&#160;motivation to remove the Test-code 2s retry&#160;yet, unless extensive beasting proves that it is&#160;no longer needed?&lt;/p&gt;</comment>
                            <comment id="16909241" author="hossman" created="Fri, 16 Aug 2019 17:23:38 +0000"  >&lt;p&gt;the beasting i&apos;ve done locally so far indicates that between the &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13464&quot; title=&quot;no way for external clients to detect when changes to security config have taken effect&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13464&quot;&gt;SOLR-13464&lt;/a&gt; work arounds and this fix in this patch there is no need for the 2s retry...&lt;/p&gt;

&lt;p&gt;but until we actually remove it will be hard to know if it&apos;s hiding other bugs - because we have very little visibility in to how often jenkins builds are passing &lt;b&gt;only&lt;/b&gt; because of that retry (test logs aren&apos;t kept of tests that PASS, so we can&apos;t grep for that log message to try and find other situations/bugs we don&apos;t currently know about.&lt;/p&gt;</comment>
                            <comment id="16909265" author="janhoy" created="Fri, 16 Aug 2019 17:48:05 +0000"  >&lt;p&gt;Ok, go ahead, it&apos;s easy enough to put in again should we need it.&lt;/p&gt;</comment>
                            <comment id="16910046" author="jira-bot" created="Sun, 18 Aug 2019 19:21:07 +0000"  >&lt;p&gt;Commit f5856ef40479250abf496e684d88c54f27ee8e73 in lucene-solr&apos;s branch refs/heads/master from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=f5856ef&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=f5856ef&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13701&quot; title=&quot;JWTAuthPlugin calls authenticationFailure (which calls HttpServletResponsesendError) before updating metrics - breaks tests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13701&quot;&gt;&lt;del&gt;SOLR-13701&lt;/del&gt;&lt;/a&gt;: Fixed JWTAuthPlugin to update metrics prior to continuing w/other filters or returning error&lt;/p&gt;</comment>
                            <comment id="16910059" author="jira-bot" created="Sun, 18 Aug 2019 20:35:37 +0000"  >&lt;p&gt;Commit eb7e3b01143c7f14823cd7249e60f4bdb659a70c in lucene-solr&apos;s branch refs/heads/branch_8x from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=eb7e3b01&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=eb7e3b01&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13701&quot; title=&quot;JWTAuthPlugin calls authenticationFailure (which calls HttpServletResponsesendError) before updating metrics - breaks tests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13701&quot;&gt;&lt;del&gt;SOLR-13701&lt;/del&gt;&lt;/a&gt;: Fixed JWTAuthPlugin to update metrics prior to continuing w/other filters or returning error&lt;/p&gt;

&lt;p&gt;(cherry picked from commit f5856ef40479250abf496e684d88c54f27ee8e73)&lt;/p&gt;</comment>
                            <comment id="16910304" author="jira-bot" created="Mon, 19 Aug 2019 10:20:51 +0000"  >&lt;p&gt;Commit f5856ef40479250abf496e684d88c54f27ee8e73 in lucene-solr&apos;s branch refs/heads/jira/&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13650&quot; title=&quot;Support for named global classloaders&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13650&quot;&gt;&lt;del&gt;SOLR-13650&lt;/del&gt;&lt;/a&gt; from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=f5856ef&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=f5856ef&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13701&quot; title=&quot;JWTAuthPlugin calls authenticationFailure (which calls HttpServletResponsesendError) before updating metrics - breaks tests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13701&quot;&gt;&lt;del&gt;SOLR-13701&lt;/del&gt;&lt;/a&gt;: Fixed JWTAuthPlugin to update metrics prior to continuing w/other filters or returning error&lt;/p&gt;</comment>
                            <comment id="17535173" author="janhoy" created="Thu, 12 May 2022 00:26:01 +0000"  >&lt;p&gt;Closing after the 9.0.0 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12977737" name="SOLR-13701.patch" size="5698" author="hossman" created="Fri, 16 Aug 2019 01:18:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 26 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z05pxc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>