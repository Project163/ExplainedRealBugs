<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:05:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-7566] Search requests should return the shard name that is down</title>
                <link>https://issues.apache.org/jira/browse/SOLR-7566</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;If no replicas of a shard are up and running, a search request gives the following response:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;{
  &lt;span class=&quot;code-quote&quot;&gt;&quot;responseHeader&quot;&lt;/span&gt;: {
    &lt;span class=&quot;code-quote&quot;&gt;&quot;status&quot;&lt;/span&gt;: 503,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;QTime&quot;&lt;/span&gt;: 2,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;params&quot;&lt;/span&gt;: {
      &lt;span class=&quot;code-quote&quot;&gt;&quot;q&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;*:*&quot;&lt;/span&gt;,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;indent&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;wt&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;json&quot;&lt;/span&gt;,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;_&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;1432048084930&quot;&lt;/span&gt;
    }
  },
  &lt;span class=&quot;code-quote&quot;&gt;&quot;error&quot;&lt;/span&gt;: {
    &lt;span class=&quot;code-quote&quot;&gt;&quot;msg&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;no servers hosting shard: &quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;code&quot;&lt;/span&gt;: 503
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The message should mention the shard which is down/unreachable.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12831040">SOLR-7566</key>
            <summary>Search requests should return the shard name that is down</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="5" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Trivial</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shalin">Shalin Shekhar Mangar</assignee>
                                    <reporter username="shalin">Shalin Shekhar Mangar</reporter>
                        <labels>
                    </labels>
                <created>Tue, 19 May 2015 15:10:56 +0000</created>
                <updated>Wed, 2 Oct 2019 17:24:16 +0000</updated>
                            <resolved>Fri, 12 Jun 2015 20:08:48 +0000</resolved>
                                    <version>5.1</version>
                                    <fixVersion>5.3</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>search</component>
                    <component>SolrCloud</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14558037" author="mariusneo" created="Mon, 25 May 2015 08:16:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt; could you please give me some tips on how to reproduce this issue?&lt;/p&gt;</comment>
                            <comment id="14558105" author="shalinmangar" created="Mon, 25 May 2015 10:48:29 +0000"  >&lt;ol&gt;
	&lt;li&gt;Create a two node solrcloud cluster&lt;/li&gt;
	&lt;li&gt;create a collection with numShards=2&amp;amp;replication factor=1&amp;amp;maxShardsPerNode=1&lt;/li&gt;
	&lt;li&gt;shutdown one node&lt;/li&gt;
	&lt;li&gt;run a search query using the collection name on the running node&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The request will fail with the error in the description.&lt;/p&gt;</comment>
                            <comment id="14558347" author="mariusneo" created="Mon, 25 May 2015 15:49:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt; thank you. I could reproduce the issue and I have also found the cause of it.&lt;br/&gt;
When doing a distributed search, the available shards are taken from the cluster state and are joined together (HttpShardHandler#checkDistributed(ResponseBuilder) method)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;HttpShardHandler#checkDistributed&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// ...
&lt;/span&gt;            StringBuilder sliceShardsStr = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringBuilder();
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Replica replica : sliceShards.values()) {
              &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!clusterState.liveNodesContain(replica.getNodeName())
                  || replica.getState() != Replica.State.ACTIVE) {
                &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
              }
              &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (first) {
                first = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
              } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                sliceShardsStr.append(&lt;span class=&quot;code-quote&quot;&gt;&apos;|&apos;&lt;/span&gt;);
              }
              &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; url = ZkCoreNodeProps.getCoreUrl(replica);
              sliceShardsStr.append(url);
            }

            rb.shards[i] = sliceShardsStr.toString();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the case when the replicas for a shard are not available, the string corresponding to the shard addresses will remain empty.&lt;/p&gt;

&lt;p&gt;In the SearchHandler#handleRequestBody method, the empty shard will be simply forwarded to the HttpShardHandler to be evaluated asynchronously : &lt;br/&gt;
SearchHandler.java line 352&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;shardHandler1.submit(sreq, shard, params);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and in the HttpShardHandler#submit() method will be thrown the exception with an inconsistent message because the shard is empty.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;HttpShardHandler#submit&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;          &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; there are no shards available &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a slice, urls.size()==0
&lt;/span&gt;          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (urls.size()==0) {
            &lt;span class=&quot;code-comment&quot;&gt;// TODO: what&apos;s the right error code here? We should use the same thing when
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// all of the servers &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a shard are down.
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SolrException(SolrException.ErrorCode.SERVICE_UNAVAILABLE, &lt;span class=&quot;code-quote&quot;&gt;&quot;no servers hosting shard: &quot;&lt;/span&gt; + shard);
          }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;One solution would be to throw the SolrException within the code of HttpShardHandler#checkDistributed method when the &lt;em&gt;sliceShardsStr&lt;/em&gt; StringBuilder is empty. This seems to me the easy way to handle this situation.&lt;/p&gt;

&lt;p&gt;Can somebody give me feedback whether I am on the right track here? Thanks in advance.&lt;/p&gt;</comment>
                            <comment id="14558361" author="mariusneo" created="Mon, 25 May 2015 16:16:28 +0000"  >&lt;p&gt;Attached a small patch that could possibly be used as solution for this issue.&lt;/p&gt;

&lt;p&gt;I think throwing of the exception from HttpShardHandler#submit() method (mentioned in the above comment) should not be kept anymore in its current form. When there are no replica urls available there&apos;s no more need to submit the callable function.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;HttpShardHandler#submit&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; urls = getURLs(sreq, shard);
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (urls.size()==0) {
    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(&lt;span class=&quot;code-quote&quot;&gt;&quot;The shard argument doesn&apos;t contain any valid URLs. got &quot;&lt;/span&gt; + shard);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14581965" author="shalinmangar" created="Thu, 11 Jun 2015 14:20:17 +0000"  >&lt;p&gt;Thanks Marius. Considering that urls can be non null if at least one slice has active replicas, we should detect this situation and throw an exception inside the HttpShardHandler.checkDistributed() method itself.&lt;/p&gt;</comment>
                            <comment id="14583377" author="mariusneo" created="Fri, 12 Jun 2015 13:24:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt; I don&apos;t understand what you imply in your last statement. The patch attached to this issue checks already within HttpShardHandler.checkDistributed method whether a shard doesn&apos;t have any active replicas. &lt;/p&gt;</comment>
                            <comment id="14583399" author="shalinmangar" created="Fri, 12 Jun 2015 13:45:46 +0000"  >&lt;blockquote&gt;&lt;p&gt;The patch attached to this issue checks already within HttpShardHandler.checkDistributed method whether a shard doesn&apos;t have any active replicas.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I am sorry, I misread your earlier patch. I thought that you were checking the complete URL string instead of one slice&apos;s URL string. You should also handle the shards.tolerant parameter (see ShardParams.SHARDS_TOLERANT). If this param is true then we cannot throw an exception in HttpShardHandler.checkDistributed and we should continue with the empty string.&lt;/p&gt;</comment>
                            <comment id="14583514" author="mariusneo" created="Fri, 12 Jun 2015 14:43:44 +0000"  >&lt;p&gt;I&apos;ve added the modifications that you&apos;ve requested on this new patch.&lt;br/&gt;
I didn&apos;t know about the &lt;em&gt;shards.tolerant&lt;/em&gt; parameter handling before.&lt;/p&gt;

&lt;p&gt;Do you see a way to unit test the changes from this patch?&lt;/p&gt;</comment>
                            <comment id="14583972" author="shalinmangar" created="Fri, 12 Jun 2015 19:52:24 +0000"  >&lt;p&gt;There was no test which tested shards.tolerant with a cloud setup so I wrote one. This is ready. I&apos;ll commit shortly.&lt;/p&gt;</comment>
                            <comment id="14583986" author="jira-bot" created="Fri, 12 Jun 2015 20:03:59 +0000"  >&lt;p&gt;Commit 1685153 from shalin@apache.org in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1685153&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1685153&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7566&quot; title=&quot;Search requests should return the shard name that is down&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7566&quot;&gt;&lt;del&gt;SOLR-7566&lt;/del&gt;&lt;/a&gt;: Search requests should return the shard name that is down&lt;/p&gt;</comment>
                            <comment id="14583991" author="jira-bot" created="Fri, 12 Jun 2015 20:07:59 +0000"  >&lt;p&gt;Commit 1685154 from shalin@apache.org in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1685154&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1685154&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7566&quot; title=&quot;Search requests should return the shard name that is down&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7566&quot;&gt;&lt;del&gt;SOLR-7566&lt;/del&gt;&lt;/a&gt;: Search requests should return the shard name that is down&lt;/p&gt;</comment>
                            <comment id="14583992" author="shalinmangar" created="Fri, 12 Jun 2015 20:08:48 +0000"  >&lt;p&gt;Thanks Marius!&lt;/p&gt;</comment>
                            <comment id="14584144" author="mariusneo" created="Fri, 12 Jun 2015 21:47:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt; thank you for setting up the test case. It looks very good and is straightforward to read. I&apos;ve taken the liberty of doing some code cosmetics on it.It&apos;s up to you whether you include them in SVN.&lt;/p&gt;</comment>
                            <comment id="14584166" author="jira-bot" created="Fri, 12 Jun 2015 22:03:50 +0000"  >&lt;p&gt;Commit 1685179 from shalin@apache.org in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1685179&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1685179&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7566&quot; title=&quot;Search requests should return the shard name that is down&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7566&quot;&gt;&lt;del&gt;SOLR-7566&lt;/del&gt;&lt;/a&gt;: Code cosmetics&lt;/p&gt;</comment>
                            <comment id="14584167" author="jira-bot" created="Fri, 12 Jun 2015 22:04:39 +0000"  >&lt;p&gt;Commit 1685180 from shalin@apache.org in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1685180&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1685180&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7566&quot; title=&quot;Search requests should return the shard name that is down&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7566&quot;&gt;&lt;del&gt;SOLR-7566&lt;/del&gt;&lt;/a&gt;: Code cosmetics&lt;/p&gt;</comment>
                            <comment id="14584169" author="shalinmangar" created="Fri, 12 Jun 2015 22:05:15 +0000"  >&lt;p&gt;Committed, thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mariusneo&quot; class=&quot;user-hover&quot; rel=&quot;mariusneo&quot;&gt;mariusneo&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="14713210" author="shalinmangar" created="Wed, 26 Aug 2015 13:06:05 +0000"  >&lt;p&gt;Bulk close for 5.3.0 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12656537">SOLR-5014</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12739343" name="SOLR-7566-test-code-cosmetics.patch" size="1513" author="mariusneo" created="Fri, 12 Jun 2015 21:47:14 +0000"/>
                            <attachment id="12739312" name="SOLR-7566.patch" size="4452" author="shalin" created="Fri, 12 Jun 2015 19:52:24 +0000"/>
                            <attachment id="12739249" name="SOLR-7566.patch" size="1344" author="mariusneo" created="Fri, 12 Jun 2015 14:43:44 +0000"/>
                            <attachment id="12735183" name="SOLR-7566.patch" size="881" author="mariusneo" created="Mon, 25 May 2015 16:16:28 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 12 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2exjr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>