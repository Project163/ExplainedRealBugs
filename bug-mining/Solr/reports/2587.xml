<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:06:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-7836] Possible deadlock when closing refcounted index writers.</title>
                <link>https://issues.apache.org/jira/browse/SOLR-7836</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Preliminary patch for what looks like a possible race condition between writerFree and pauseWriter in DefaultSorlCoreState.&lt;/p&gt;

&lt;p&gt;Looking for comments and/or why I&apos;m completely missing the boat.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12849423">SOLR-7836</key>
            <summary>Possible deadlock when closing refcounted index writers.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yseeley@gmail.com">Yonik Seeley</assignee>
                                    <reporter username="erickerickson">Erick Erickson</reporter>
                        <labels>
                    </labels>
                <created>Mon, 27 Jul 2015 20:39:50 +0000</created>
                <updated>Mon, 9 May 2016 18:44:53 +0000</updated>
                            <resolved>Thu, 3 Sep 2015 15:16:37 +0000</resolved>
                                                    <fixVersion>5.4</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14643433" author="erickerickson" created="Mon, 27 Jul 2015 21:28:55 +0000"  >&lt;p&gt;Looking for comments:&lt;/p&gt;

&lt;p&gt;This looks like I changed more than I did. Expanded the scope of the try/finally block in newIndexWriter, moved the common code for initializing outside an else clause and put a try/finally block in closeIndexWriter. The rest of the diff is just noise due to indentation.&lt;/p&gt;

&lt;p&gt;I have a field report and stack traces of a deadlock, here&apos;s the stack trace:&lt;/p&gt;

&lt;p&gt;I think that the first two in DefaultSolrCoreState are where I&apos;m guessing the root of the problem lies.&lt;/p&gt;

&lt;p&gt;********************First thread in DefaultSolrCoreState &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The thread that owns the updateLock is stuck waiting for pauseWriter to go to false so it can get the IndexWriter:&lt;br/&gt;
java.lang.Object@c0d4b9 &lt;br/&gt;
java.lang.Object.wait&#8203;(Native Method) &lt;br/&gt;
org.apache.solr.update.DefaultSolrCoreState.getIndexWriter&#8203;(DefaultSolrCoreState.java:94) &lt;br/&gt;
org.apache.solr.update.DirectUpdateHandler2.addAndDelete&#8203;(DirectUpdateHandler2.java:436) &lt;br/&gt;
org.apache.solr.update.DirectUpdateHandler2.addDoc0&#8203;(DirectUpdateHandler2.java:216) &lt;br/&gt;
org.apache.solr.update.DirectUpdateHandler2.addDoc&#8203;(DirectUpdateHandler2.java:160) &lt;br/&gt;
org.apache.solr.update.processor.RunUpdateProcessor.processAdd&#8203;(RunUpdateProcessorFactory.java:69) &lt;br/&gt;
org.apache.solr.update.processor.UpdateRequestProcessor.processAdd&#8203;(UpdateRequestProcessor.java:51) &lt;br/&gt;
org.apache.solr.update.processor.DistributedUpdateProcessor.doLocalAdd&#8203;(DistributedUpdateProcessor.java:928) &lt;br/&gt;
org.apache.solr.update.processor.DistributedUpdateProcessor.versionAdd&#8203;(DistributedUpdateProcessor.java:1082) &lt;br/&gt;
org.apache.solr.update.processor.DistributedUpdateProcessor.processAdd&#8203;(DistributedUpdateProcessor.java:695) &lt;br/&gt;
org.apache.solr.handler.loader.JavabinLoader$1.update&#8203;(JavabinLoader.java:96) &lt;br/&gt;
org.apache.solr.client.solrj.request.JavaBinUpdateRequestCodec$1.readOuterMostDocIterator&#8203;(JavaBinUpdateRequestCodec.java:166) &lt;br/&gt;
org.apache.solr.client.solrj.request.JavaBinUpdateRequestCodec$1.readIterator&#8203;(JavaBinUpdateRequestCodec.java:136) &lt;br/&gt;
org.apache.solr.common.util.JavaBinCodec.readVal&#8203;(JavaBinCodec.java:225) &lt;br/&gt;
org.apache.solr.client.solrj.request.JavaBinUpdateRequestCodec$1.readNamedList&#8203;(JavaBinUpdateRequestCodec.java:121) &lt;br/&gt;
org.apache.solr.common.util.JavaBinCodec.readVal&#8203;(JavaBinCodec.java:190) &lt;br/&gt;
org.apache.solr.common.util.JavaBinCodec.unmarshal&#8203;(JavaBinCodec.java:116) &lt;br/&gt;
org.apache.solr.client.solrj.request.JavaBinUpdateRequestCodec.unmarshal&#8203;(JavaBinUpdateRequestCodec.java:173) &lt;br/&gt;
org.apache.solr.handler.loader.JavabinLoader.parseAndLoadDocs&#8203;(JavabinLoader.java:106) &lt;br/&gt;
org.apache.solr.handler.loader.JavabinLoader.load&#8203;(JavabinLoader.java:58) &lt;br/&gt;
org.apache.solr.handler.UpdateRequestHandler$1.load&#8203;(UpdateRequestHandler.java:92) &lt;br/&gt;
org.apache.solr.handler.ContentStreamHandlerBase.handleRequestBody&#8203;(ContentStreamHandlerBase.java:74) &lt;br/&gt;
org.apache.solr.handler.RequestHandlerBase.handleRequest&#8203;(RequestHandlerBase.java:135) &lt;br/&gt;
org.apache.solr.core.SolrCore.execute&#8203;(SolrCore.java:1956) &lt;br/&gt;
org.apache.solr.servlet.SolrDispatchFilter.execute&#8203;(SolrDispatchFilter.java:799) &lt;br/&gt;
org.apache.solr.servlet.SolrDispatchFilter.doFilter&#8203;(SolrDispatchFilter.java:422) &lt;br/&gt;
org.apache.solr.servlet.SolrDispatchFilter.doFilter&#8203;(SolrDispatchFilter.java:208) &lt;br/&gt;
org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter&#8203;(ServletHandler.java:1419) &lt;br/&gt;
com.apple.cie.search.plugin.auth.TrustFilter.doFilter&#8203;(TrustFilter.java:43) &lt;br/&gt;
org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter&#8203;(ServletHandler.java:1419) &lt;br/&gt;
org.eclipse.jetty.servlet.ServletHandler.doHandle&#8203;(ServletHandler.java:455) &lt;br/&gt;
org.eclipse.jetty.server.handler.ScopedHandler.handle&#8203;(ScopedHandler.java:137) &lt;br/&gt;
org.eclipse.jetty.security.SecurityHandler.handle&#8203;(SecurityHandler.java:557) &lt;br/&gt;
org.eclipse.jetty.server.session.SessionHandler.doHandle&#8203;(SessionHandler.java:231) &lt;br/&gt;
org.eclipse.jetty.server.handler.ContextHandler.doHandle&#8203;(ContextHandler.java:1075) &lt;br/&gt;
org.eclipse.jetty.servlet.ServletHandler.doScope&#8203;(ServletHandler.java:384) &lt;br/&gt;
org.eclipse.jetty.server.session.SessionHandler.doScope&#8203;(SessionHandler.java:193) &lt;br/&gt;
org.eclipse.jetty.server.handler.ContextHandler.doScope&#8203;(ContextHandler.java:1009) &lt;br/&gt;
org.eclipse.jetty.server.handler.ScopedHandler.handle&#8203;(ScopedHandler.java:135) &lt;br/&gt;
org.eclipse.jetty.server.handler.ContextHandlerCollection.handle&#8203;(ContextHandlerCollection.java:255) &lt;br/&gt;
org.eclipse.jetty.server.handler.HandlerCollection.handle&#8203;(HandlerCollection.java:154) &lt;br/&gt;
org.eclipse.jetty.server.handler.HandlerWrapper.handle&#8203;(HandlerWrapper.java:116) &lt;br/&gt;
org.eclipse.jetty.server.Server.handle&#8203;(Server.java:368) &lt;br/&gt;
org.eclipse.jetty.server.AbstractHttpConnection.handleRequest&#8203;(AbstractHttpConnection.java:489) &lt;br/&gt;
org.eclipse.jetty.server.BlockingHttpConnection.handleRequest&#8203;(BlockingHttpConnection.java:53) &lt;br/&gt;
org.eclipse.jetty.server.AbstractHttpConnection.content&#8203;(AbstractHttpConnection.java:953) &lt;br/&gt;
org.eclipse.jetty.server.AbstractHttpConnection$RequestHandler.content&#8203;(AbstractHttpConnection.java:1014) &lt;br/&gt;
org.eclipse.jetty.http.HttpParser.parseNext&#8203;(HttpParser.java:953) &lt;br/&gt;
org.eclipse.jetty.http.HttpParser.parseAvailable&#8203;(HttpParser.java:240) &lt;br/&gt;
org.eclipse.jetty.server.BlockingHttpConnection.handle&#8203;(BlockingHttpConnection.java:72) &lt;br/&gt;
org.eclipse.jetty.server.bio.SocketConnector$ConnectorEndPoint.run&#8203;(SocketConnector.java:264) &lt;br/&gt;
org.eclipse.jetty.util.thread.QueuedThreadPool.runJob&#8203;(QueuedThreadPool.java:608) &lt;br/&gt;
org.eclipse.jetty.util.thread.QueuedThreadPool$3.run&#8203;(QueuedThreadPool.java:543) &lt;br/&gt;
java.lang.Thread.run&#8203;(Thread.java:745)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;********************Second thread in DefaultSolrCoreState &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The thread that sets pauseWriter to true that is supposed to later set it to false is stuck on waiting for writerFree to go to true:&lt;br/&gt;
java.lang.Object@c0d4b9 &lt;br/&gt;
java.lang.Object.wait&#8203;(Native Method) &lt;br/&gt;
org.apache.solr.update.DefaultSolrCoreState.newIndexWriter&#8203;(DefaultSolrCoreState.java:156) &lt;br/&gt;
org.apache.solr.core.SolrCore.reload&#8203;(SolrCore.java:431) &lt;br/&gt;
org.apache.solr.core.CoreContainer.reload&#8203;(CoreContainer.java:586) &lt;br/&gt;
org.apache.solr.handler.admin.CoreAdminHandler.handleReloadAction&#8203;(CoreAdminHandler.java:701) &lt;br/&gt;
org.apache.solr.handler.admin.CoreAdminHandler.handleRequestInternal&#8203;(CoreAdminHandler.java:225) &lt;br/&gt;
org.apache.solr.handler.admin.CoreAdminHandler.handleRequestBody&#8203;(CoreAdminHandler.java:188) &lt;br/&gt;
org.apache.solr.handler.RequestHandlerBase.handleRequest&#8203;(RequestHandlerBase.java:135) &lt;br/&gt;
org.apache.solr.servlet.SolrDispatchFilter.handleAdminRequest&#8203;(SolrDispatchFilter.java:751) &lt;br/&gt;
org.apache.solr.servlet.SolrDispatchFilter.doFilter&#8203;(SolrDispatchFilter.java:259) &lt;br/&gt;
org.apache.solr.servlet.SolrDispatchFilter.doFilter&#8203;(SolrDispatchFilter.java:208) &lt;br/&gt;
org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter&#8203;(ServletHandler.java:1419) &lt;br/&gt;
com.apple.cie.search.plugin.auth.TrustFilter.doFilter&#8203;(TrustFilter.java:43) &lt;br/&gt;
org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter&#8203;(ServletHandler.java:1419) &lt;br/&gt;
org.eclipse.jetty.servlet.ServletHandler.doHandle&#8203;(ServletHandler.java:455) &lt;br/&gt;
org.eclipse.jetty.server.handler.ScopedHandler.handle&#8203;(ScopedHandler.java:137) &lt;br/&gt;
org.eclipse.jetty.security.SecurityHandler.handle&#8203;(SecurityHandler.java:557) &lt;br/&gt;
org.eclipse.jetty.server.session.SessionHandler.doHandle&#8203;(SessionHandler.java:231) &lt;br/&gt;
org.eclipse.jetty.server.handler.ContextHandler.doHandle&#8203;(ContextHandler.java:1075) &lt;br/&gt;
org.eclipse.jetty.servlet.ServletHandler.doScope&#8203;(ServletHandler.java:384) &lt;br/&gt;
org.eclipse.jetty.server.session.SessionHandler.doScope&#8203;(SessionHandler.java:193) &lt;br/&gt;
org.eclipse.jetty.server.handler.ContextHandler.doScope&#8203;(ContextHandler.java:1009) &lt;br/&gt;
org.eclipse.jetty.server.handler.ScopedHandler.handle&#8203;(ScopedHandler.java:135) &lt;br/&gt;
org.eclipse.jetty.server.handler.ContextHandlerCollection.handle&#8203;(ContextHandlerCollection.java:255) &lt;br/&gt;
org.eclipse.jetty.server.handler.HandlerCollection.handle&#8203;(HandlerCollection.java:154) &lt;br/&gt;
org.eclipse.jetty.server.handler.HandlerWrapper.handle&#8203;(HandlerWrapper.java:116) &lt;br/&gt;
org.eclipse.jetty.server.Server.handle&#8203;(Server.java:368) &lt;br/&gt;
org.eclipse.jetty.server.AbstractHttpConnection.handleRequest&#8203;(AbstractHttpConnection.java:489) &lt;br/&gt;
org.eclipse.jetty.server.BlockingHttpConnection.handleRequest&#8203;(BlockingHttpConnection.java:53) &lt;br/&gt;
org.eclipse.jetty.server.AbstractHttpConnection.content&#8203;(AbstractHttpConnection.java:953) &lt;br/&gt;
org.eclipse.jetty.server.AbstractHttpConnection$RequestHandler.content&#8203;(AbstractHttpConnection.java:1014) &lt;br/&gt;
org.eclipse.jetty.http.HttpParser.parseNext&#8203;(HttpParser.java:861) &lt;br/&gt;
org.eclipse.jetty.http.HttpParser.parseAvailable&#8203;(HttpParser.java:240) &lt;br/&gt;
org.eclipse.jetty.server.BlockingHttpConnection.handle&#8203;(BlockingHttpConnection.java:72) &lt;br/&gt;
org.eclipse.jetty.server.bio.SocketConnector$ConnectorEndPoint.run&#8203;(SocketConnector.java:264) &lt;br/&gt;
org.eclipse.jetty.util.thread.QueuedThreadPool.runJob&#8203;(QueuedThreadPool.java:608) &lt;br/&gt;
org.eclipse.jetty.util.thread.QueuedThreadPool$3.run&#8203;(QueuedThreadPool.java:543) &lt;br/&gt;
java.lang.Thread.run&#8203;(Thread.java:745)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;****************Lots of threads stuck in DirectUpdateHandler2, but I suspect these aren&apos;t where the problem really is:&lt;br/&gt;
java.lang.Object@73cdbe11 &lt;br/&gt;
org.apache.solr.update.DirectUpdateHandler2.addAndDelete&#8203;(DirectUpdateHandler2.java:435) &lt;br/&gt;
org.apache.solr.update.DirectUpdateHandler2.addDoc0&#8203;(DirectUpdateHandler2.java:216) &lt;br/&gt;
org.apache.solr.update.DirectUpdateHandler2.addDoc&#8203;(DirectUpdateHandler2.java:160) &lt;br/&gt;
org.apache.solr.update.processor.RunUpdateProcessor.processAdd&#8203;(RunUpdateProcessorFactory.java:69) &lt;br/&gt;
org.apache.solr.update.processor.UpdateRequestProcessor.processAdd&#8203;(UpdateRequestProcessor.java:51) &lt;br/&gt;
org.apache.solr.update.processor.DistributedUpdateProcessor.doLocalAdd&#8203;(DistributedUpdateProcessor.java:928) &lt;br/&gt;
org.apache.solr.update.processor.DistributedUpdateProcessor.versionAdd&#8203;(DistributedUpdateProcessor.java:1082) &lt;br/&gt;
org.apache.solr.update.processor.DistributedUpdateProcessor.processAdd&#8203;(DistributedUpdateProcessor.java:695) &lt;/p&gt;</comment>
                            <comment id="14644312" author="erickerickson" created="Tue, 28 Jul 2015 12:39:50 +0000"  >&lt;p&gt;OK, the patch doesn&apos;t address the real issue. I still think it&apos;s bad to leave those dangling pauseWriters around, but the &lt;em&gt;real&lt;/em&gt; issue appears to be over in DirectUpdateHandler2. There&apos;s a ref counted index writer obtained in addDoc0. But then addDoc0 calls addAndDelete which tries to get a ref counted index writer again. If another thread sets pauseWriter in between, then it&apos;s deadlocked.&lt;/p&gt;

&lt;p&gt;I think the solution is to just pass the IndexWriter down to addAndDelete, but won&apos;t have time to really look until this evening.&lt;/p&gt;</comment>
                            <comment id="14644420" author="markrmiller@gmail.com" created="Tue, 28 Jul 2015 14:21:13 +0000"  >&lt;p&gt;That sounds like it&apos;s right - been awhile since I&apos;ve looked at the code, but the idea is, you get a writer, use it briefly, then release it in a finally. There should not be code that gets a writer, then gets a writer, then tries to release both of them after.&lt;/p&gt;</comment>
                            <comment id="14661370" author="erickerickson" created="Fri, 7 Aug 2015 05:45:15 +0000"  >&lt;p&gt;Well, I&apos;ve kicked the can down the road, but now there&apos;s a different deadlock. I wrote a test to beat the heck out of the update/delete-by-query/reload stuff and after the changes above....&lt;/p&gt;

&lt;p&gt;In the morning when I&apos;m fresher I&apos;ll look at why there are so many different things that need to have locks on them. But we have updateLock, and loops like below that &lt;em&gt;seem&lt;/em&gt; to be locking each other out.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yseeley%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;yseeley@gmail.com&quot;&gt;yseeley@gmail.com&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; (and anyone else) Loops like this seem fraught, or is it just me and it&apos;s late?:&lt;br/&gt;
        while (!writerFree) {&lt;br/&gt;
          try &lt;/p&gt;
{
            writerPauseLock.wait(100);
          }
&lt;p&gt; catch (InterruptedException e) {}&lt;br/&gt;
          if (closed) &lt;/p&gt;
{
            throw new SolrException(ErrorCode.SERVICE_UNAVAILABLE, &quot;SolrCoreState already closed&quot;);
          }
&lt;p&gt;        }&lt;/p&gt;

&lt;p&gt;and wait until some other thread sets writerFree to true. &lt;/p&gt;</comment>
                            <comment id="14661739" author="markrmiller@gmail.com" created="Fri, 7 Aug 2015 12:17:05 +0000"  >&lt;p&gt;What&apos;s wrong with the loop?&lt;/p&gt;

&lt;p&gt;The code in place is pretty tricky because it had to retrofitted onto a model that did not fit the right model to make it fit the right model &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I&apos;m not exactly sure what you are point out in the loop though.&lt;/p&gt;

&lt;p&gt;Do you have stack traces for the latest deadlock? Can you share the new test?&lt;/p&gt;</comment>
                            <comment id="14661898" author="erickerickson" created="Fri, 7 Aug 2015 14:26:02 +0000"  >&lt;p&gt;Well, something that sits in a while loop waiting for another thread to change a variable before doing anything seems like it&apos;s harder to get right than some kind of notification. As I&apos;m finding. But I&apos;m terrified of changing the total approach. &lt;/p&gt;

&lt;p&gt;I need to dig some more before posting stack traces, plus it&apos;s the trace with this patch applied (and maybe changed)....&lt;/p&gt;

&lt;p&gt;Mostly bringing it up to see if someone looks at the loops and says &quot;Yuck, how did we do &lt;em&gt;THAT&lt;/em&gt;?&quot; before thinking about replacing the mechanism. You&apos;ve shot that hope in the head though &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. And I&apos;m assuming that part of the complexity here is that we want the index writer to be held by a thread as briefly as possible so as to not introduce bottlenecks.&lt;/p&gt;

&lt;p&gt;Anyway, I&apos;ll dig some more after I take care of morning tasks.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;
</comment>
                            <comment id="14661956" author="markrmiller@gmail.com" created="Fri, 7 Aug 2015 15:00:49 +0000"  >&lt;p&gt;Previously it was done via notification - the time out and check of isClosed was added at some point because this could hang on shutdown (or at least it really slowed down shutdown - can&apos;t remember which).&lt;/p&gt;</comment>
                            <comment id="14662814" author="erickerickson" created="Sat, 8 Aug 2015 05:30:11 +0000"  >&lt;p&gt;This might do it. I&apos;m running 1,000 iterations (or until morning, whichever comes first) but it&apos;s gone through 150 or so already which was usually more than enough to trigger the new deadlock I found so I&apos;m hopeful. Actually, I think this really the old deadlock, the first fix wasn&apos;t very good.&lt;/p&gt;

&lt;p&gt;There are two things I&apos;d appreciate any opinions on:&lt;br/&gt;
1&amp;gt; this patch moves the UpdateLog.add() command out of the ref counted IndexWriter in DirectUpdateHandler2.addDoc0() in multiple places (refactored to methods). But UpdateLog.add gets a new IndexWriter itself which is where the deadlock appears to be as it&apos;s fighting with CoreContainer.reload() which also calls DefaultSolrCoreState.newIndexWriter.&lt;/p&gt;

&lt;p&gt;2&amp;gt; There are two nocommits, but they are to make it easy for someone to see the other bit that other eyes would be most welcome on, I moved &lt;br/&gt;
if (ulog != null) ulog.add(cmd, true); &lt;br/&gt;
out of a synchronized block. This fits the pattern in other places in that code too, so I&apos;m not too worried, but wanted to draw attention to it if anyone wants to look. Actually, there are a lot of operations on ulog.something that are synchronized on solrCoreState.getUpdateLock(), and a bunch that aren&apos;t. What&apos;s up there? The change marked by //nocommit matches the (non-synchronized) usages in addDoc0() though.&lt;/p&gt;

&lt;p&gt;Anyway, the problem was in DirectUpdateHandler2.addDoc0(). The ulog.add command line being inside a ref-counted IndexWriter when adding documents (addAndDelete case). ulog.add eventually tries to get a new Searcher which can be deadlocked with another thread called from SolrCore.reload since the reload wants a new IndexWriter.&lt;/p&gt;

&lt;p&gt;I haven&apos;t run precommit or the full test suite yet, I want to make sure the iterations I&apos;m doing tonight work.&lt;/p&gt;

&lt;p&gt;This looks more intrusive than it is. I refactored some methods out of DirectUpdateHandler2.addDoc0() in order to make this pattern more visible. The original code concealed the fact that the ref counted index writer surrounded all the code, including the ulog.add.&lt;/p&gt;

&lt;p&gt;this is the pattern for all the refactored methods:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;RefCounted&amp;lt;IndexWriter&amp;gt; iw = solrCoreState.getIndexWriter(core);&#8232;&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {&#8232; 
   IndexWriter writer = iw.get();&#8232; 
    &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; the right thing
} &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
    iw.decref();
} 

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ulog != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) ulog.add(cmd, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I think this is a better approach than the original fix which passed the index writer down to the addAndDelete method. we&apos;d have had to pass the IndexWriter on to the ulog.add command or something which would have been a pain (even if it was possible).&lt;/p&gt;

&lt;p&gt;New test case is in this patch. Note that it&apos;s a race condition to get this to fail, so it needs to be run a lot. And using tests.iters apparently triggers the timeouts so....&lt;/p&gt;</comment>
                            <comment id="14663030" author="markrmiller@gmail.com" created="Sat, 8 Aug 2015 15:26:45 +0000"  >&lt;p&gt;Can we get the stress test in as a nightly?&lt;/p&gt;</comment>
                            <comment id="14663038" author="erickerickson" created="Sat, 8 Aug 2015 15:41:51 +0000"  >&lt;p&gt;Looking a bit more, all the ulog.(some operation) commands have this at the top: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 
&lt;p&gt;so they&apos;re serialized. I don&apos;t like the fact that lots of these are called from within&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (solrCoreState.getUpdateLock()) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;as that seems like a good place for a deadlock if it ever happens that the ulog operations want to get that same lock, but I&apos;m not about to change that now by, say, moving all the ulog operations out of the synchronized blocks since I don&apos;t know why they were put in the first place, we can make that a separate JIRA if necessary/desirable. I&apos;m comfortable enough with the one I moved out to go ahead with this commit.&lt;/p&gt;

&lt;p&gt;So I&apos;ll clean up the patch and commit unless there are objections today/tomorrow.&lt;/p&gt;</comment>
                            <comment id="14663062" author="erickerickson" created="Sat, 8 Aug 2015 16:39:33 +0000"  >&lt;p&gt;Final patch I think. It:&lt;br/&gt;
1&amp;gt; tightens up a bit acquiring the index writer in the extracted methods. This is really a minor nit.&lt;/p&gt;

&lt;p&gt;2&amp;gt; makes the test nightly.&lt;/p&gt;

&lt;p&gt;I&apos;ll commit this tonight/tomorrow, need to run it through precommit and the rest of the tests.&lt;/p&gt;</comment>
                            <comment id="14663242" author="jira-bot" created="Sun, 9 Aug 2015 03:38:09 +0000"  >&lt;p&gt;Commit 1694854 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erickoerickson&quot; class=&quot;user-hover&quot; rel=&quot;erickoerickson&quot;&gt;erickoerickson&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1694854&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1694854&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7836&quot; title=&quot;Possible deadlock when closing refcounted index writers.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7836&quot;&gt;&lt;del&gt;SOLR-7836&lt;/del&gt;&lt;/a&gt;: Possible deadlock when closing refcounted index writers&lt;/p&gt;</comment>
                            <comment id="14663271" author="jira-bot" created="Sun, 9 Aug 2015 05:46:44 +0000"  >&lt;p&gt;Commit 1694855 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erickoerickson&quot; class=&quot;user-hover&quot; rel=&quot;erickoerickson&quot;&gt;erickoerickson&lt;/a&gt; in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1694855&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1694855&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7836&quot; title=&quot;Possible deadlock when closing refcounted index writers.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7836&quot;&gt;&lt;del&gt;SOLR-7836&lt;/del&gt;&lt;/a&gt;: Possible deadlock when closing refcounted index writers&lt;/p&gt;</comment>
                            <comment id="14663272" author="erickerickson" created="Sun, 9 Aug 2015 05:47:17 +0000"  >&lt;p&gt;Thanks Jessica!&lt;/p&gt;</comment>
                            <comment id="14679360" author="erickerickson" created="Sun, 9 Aug 2015 21:34:51 +0000"  >&lt;p&gt;I modified the three refactored methods in DirectUpdateHandler2 to be:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;   &lt;span class=&quot;code-comment&quot;&gt;//old code
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ulog != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) ulog.add(cmd);
 

   &lt;span class=&quot;code-comment&quot;&gt;//&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; code
&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (solrCoreState.getUpdateLock()) {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ulog != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) ulog.add(cmd);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and 200 iterations later no failures from TestStressReorder (I&apos;ll try the new test code momentarily, but it&apos;ll take longer).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yseeley%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;yseeley@gmail.com&quot;&gt;yseeley@gmail.com&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt;&lt;br/&gt;
Here&apos;s what I &lt;em&gt;don&apos;t&lt;/em&gt; like about this. None of these three operations (the three new methods: addAndDelete, doNormalUpdate and allowDuplicateUpdate) couples actually changing the index with the write to the ulog. Now, only the code in addAndDelete did before, except that we may have gotten away with this because the indexWriter was grabbed at the very top of addDoc0() and effectively locked other operations out. Maybe.&lt;/p&gt;

&lt;p&gt;But if the ulog.add goes within the synch on the updatelock in addAndDelete, there&apos;s certainly a deadlock so putting it back the way it was isn&apos;t really an option.&lt;/p&gt;

&lt;p&gt;I&apos;m starting to wonder if this isn&apos;t a bit backwards. Rather than going at this piecemeal, what about synchronizing on updateLock at the top of addDoc0 &lt;em&gt;and&lt;/em&gt; in CoreContainer.reload() which drives one of the failure cases for deadlock? Not sure I really like the idea, but I&apos;ll give it a (local) test....&lt;/p&gt;

&lt;p&gt;Meanwhile, I&apos;ll check the current fix in since it&apos;s certainly better pending more experimentation.&lt;/p&gt;</comment>
                            <comment id="14679364" author="jira-bot" created="Sun, 9 Aug 2015 21:46:43 +0000"  >&lt;p&gt;Commit 1694913 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erickoerickson&quot; class=&quot;user-hover&quot; rel=&quot;erickoerickson&quot;&gt;erickoerickson&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1694913&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1694913&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7836&quot; title=&quot;Possible deadlock when closing refcounted index writers.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7836&quot;&gt;&lt;del&gt;SOLR-7836&lt;/del&gt;&lt;/a&gt;: Possible deadlock when closing refcounted index writers. Surrounded ulog updates with updatelock&lt;/p&gt;</comment>
                            <comment id="14679365" author="jira-bot" created="Sun, 9 Aug 2015 21:47:29 +0000"  >&lt;p&gt;Commit 1694914 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erickoerickson&quot; class=&quot;user-hover&quot; rel=&quot;erickoerickson&quot;&gt;erickoerickson&lt;/a&gt; in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1694914&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1694914&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7836&quot; title=&quot;Possible deadlock when closing refcounted index writers.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7836&quot;&gt;&lt;del&gt;SOLR-7836&lt;/del&gt;&lt;/a&gt;: Possible deadlock when closing refcounted index writers. Surrounded ulog updates with updatelock&lt;/p&gt;</comment>
                            <comment id="14679398" author="erickerickson" created="Sun, 9 Aug 2015 23:20:00 +0000"  >&lt;p&gt;bq: I&apos;m starting to wonder if this isn&apos;t a bit backwards. Rather than going at this piecemeal, what about synchronizing on updateLock at the top of addDoc0 and in CoreContainer.reload() which drives one of the failure cases for deadlock? Not sure I really like the idea, but I&apos;ll give it a (local) test....&lt;/p&gt;

&lt;p&gt;That&apos;s a really bad idea, fails first time every time.&lt;/p&gt;</comment>
                            <comment id="14679424" author="markrmiller@gmail.com" created="Mon, 10 Aug 2015 00:19:35 +0000"  >&lt;p&gt;What about the nightly test?&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   //new code
   synchronized (solrCoreState.getUpdateLock()) {
      if (ulog != null) ulog.add(cmd);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;While that says getUpdateLock, it appears to have been additionally proposed as a deleteLock judging by it&apos;s callers and variable name. It looks like the old index update lock was tied into also being a delete lock.&lt;/p&gt;

&lt;p&gt;What is the logic that says you now need that also locking adds other than this test? Why would the index update lock that did not block adds and also was used as a delete lock also lock adds now?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yseeley%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;yseeley@gmail.com&quot;&gt;yseeley@gmail.com&lt;/a&gt; should really look at this as this looks like his code area.&lt;/p&gt;

&lt;p&gt;I&apos;m skeptical that this is the right fix.&lt;/p&gt;</comment>
                            <comment id="14679455" author="erickerickson" created="Mon, 10 Aug 2015 01:32:27 +0000"  >&lt;p&gt;bq: What about the nightly test?&lt;/p&gt;

&lt;p&gt;I&apos;m beating that up as well, 50+ runs and iterating without a problem so far.&lt;/p&gt;

&lt;p&gt;bq: While that says getUpdateLock, it appears to have been additionally proposed as a deleteLock judging by it&apos;s callers and variable name. It looks like the old index update lock was tied into also being a delete lock&lt;/p&gt;

&lt;p&gt;Hmmm. which may explain why changing in in addAndDelete was a problem and apparently not in the other cases.&lt;/p&gt;

&lt;p&gt;bq: What is the logic that says you now need that also locking adds other than this test?&lt;/p&gt;

&lt;p&gt;May well be flawed logic, but I find it really suspicious that the the ulog.add() call is sometimes protected and sometimes not. Although your point that it appears to really be about deletes (which the others don&apos;t do) may be why. Moving getting the indexwriter away from being done at the beginning of addDoc0() did remove a layer of protection around the ulog.add calls in all the code paths in addDoc0(). The ref counted index writer (unintentionally?) locked out some other updates possibly. ulog.add can get a new ref counted index writer which lead to the deadlock in the addAndDelete case.&lt;/p&gt;</comment>
                            <comment id="14679959" author="markrmiller@gmail.com" created="Mon, 10 Aug 2015 11:14:49 +0000"  >&lt;blockquote&gt;&lt;p&gt;I find it really suspicious that the the ulog.add() call is sometimes protected and sometimes not. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s pretty unsound logic for making a change in such a complicated area of code...&lt;/p&gt;</comment>
                            <comment id="14679961" author="markrmiller@gmail.com" created="Mon, 10 Aug 2015 11:17:13 +0000"  >&lt;p&gt;I&apos;m pretty sure that deadlocks around accessing an index writer should not involved synchronization work with the tlog. It may have inadvertently helped, but the two things are pretty unrelated.&lt;/p&gt;</comment>
                            <comment id="14679976" author="markrmiller@gmail.com" created="Mon, 10 Aug 2015 11:42:22 +0000"  >&lt;p&gt;Once you get the stress test up, I&apos;m happy to do some parallel investigation into the deadlock.&lt;/p&gt;</comment>
                            <comment id="14680024" author="markrmiller@gmail.com" created="Mon, 10 Aug 2015 12:21:43 +0000"  >&lt;blockquote&gt;&lt;p&gt;Once you get the stress test up&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Nevermind, I see it&apos;s in an earlier test. I&apos;ll take a look.&lt;/p&gt;</comment>
                            <comment id="14680200" author="erickerickson" created="Mon, 10 Aug 2015 14:39:33 +0000"  >&lt;p&gt;bq: I&apos;m pretty sure that deadlocks around accessing an index writer should not involved synchronization work with the tlog. It may have inadvertently helped, but the two things are pretty unrelated.&lt;/p&gt;

&lt;p&gt;I don&apos;t disagree, but the update log and index writer are intertwined, that&apos;s the problem. I&apos;m perfectly willing to agree that they should be separated out completely, but haven&apos;t had any confirmation that they can be, or were ever intended to be separated.&lt;/p&gt;

&lt;p&gt;ulog.add() calls openNewSearcher which gets an indexWriter which is where things to south. Of course it calls getIndexWriter with null which has the note &quot;core == null is a signal to just return the current writer, or null&quot;; It doesn&apos;t really increment the reference count but does go through the interlock with pauseWriter and the like. Of course then openNewSearcher does a decref on the writer, which was never incremented in the first place and only works because the decref for index writer doesn&apos;t decrement if the count is 0.&lt;/p&gt;

&lt;p&gt;I&apos;ve no objection to taking the two additional synchronized blocks out of DirectUpdateHandler2. The one in addAndDelete was already there although it was enclosed by getting an index writer (which is where all the problems happened). I&apos;m not adverse to taking that one out too&lt;/p&gt;

&lt;p&gt;BTW, you can&apos;t use tests.iters for the new test. I didn&apos;t want to wait for the default suite timeout so I set it locally to 10 minutes and that timer apparently runs across all iters. I wrote a shell script to re-invoke the test for a long time (500 times last night).&lt;/p&gt;</comment>
                            <comment id="14681889" author="markrmiller@gmail.com" created="Tue, 11 Aug 2015 14:46:04 +0000"  >&lt;p&gt;Still trying to duplicate a hang with the above patch removed, but one strange thing I had to work around because the test kept failing relatively quickly for me (JVM bug?):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Index: solr/core/src/java/org/apache/solr/core/SolrCore.java
===================================================================
--- solr/core/src/java/org/apache/solr/core/SolrCore.java	(revision 1695180)
+++ solr/core/src/java/org/apache/solr/core/SolrCore.java	(working copy)
@@ -1639,7 +1639,9 @@
           tmp = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SolrIndexSearcher(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, newIndexDir, getLatestSchema(),
               (realtime ? &lt;span class=&quot;code-quote&quot;&gt;&quot;realtime&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt;), newReader, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, !realtime, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, directoryFactory);
         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;  {
-          RefCounted&amp;lt;IndexWriter&amp;gt; writer = getUpdateHandler().getSolrCoreState().getIndexWriter(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
+          &lt;span class=&quot;code-comment&quot;&gt;// when &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; was getUpdateHandler#getSolrCoreState it could hit an NPE somehow,
&lt;/span&gt;+          &lt;span class=&quot;code-comment&quot;&gt;// even though variables are all &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt;
&lt;/span&gt;+          RefCounted&amp;lt;IndexWriter&amp;gt; writer = solrCoreState.getIndexWriter(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
           DirectoryReader newReader = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
           &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
             newReader = indexReaderFactory.newReader(writer.get(), &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14681912" author="yseeley@gmail.com" created="Tue, 11 Aug 2015 15:01:21 +0000"  >&lt;blockquote&gt;&lt;p&gt;there are a lot of operations on ulog.something that are synchronized on solrCoreState.getUpdateLock(), and a bunch that aren&apos;t. What&apos;s up there? &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Some background here: I wrote the original tlog code (and DUH2 code that called it).  There was no solrCoreState.getUpdateLock() (and no sharing writers across reloads even).  Mark implemented that part and changed synchronized(this) to synchronized(solrCoreState.getUpdateLock()) I believe (to account for the fact that we could have 2 DUH2 instances).&lt;/p&gt;

&lt;p&gt;Hopefully there are comments about when something is synchronized (and why it needed to be).  The intent was to have the common case unsynchronized for best throughput.  For example, I don&apos;t believe writer.updateDocument for the common case is synchronized.  That would be bad for indexing performance.&lt;/p&gt;

&lt;p&gt;deleteByQuery (or an add where we detect a reordered DBQ that we need to apply again) contains the following&lt;br/&gt;
comment next to the synchronize statement:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;      &lt;span class=&quot;code-comment&quot;&gt;//
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; to prevent deleteByQuery from running during the &lt;span class=&quot;code-quote&quot;&gt;&quot;open &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; searcher&quot;&lt;/span&gt;
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// part of a commit.  DBQ needs to signal that a fresh reader will be needed &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// a realtime view of the index.  When a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; searcher is opened after a DBQ, that
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// flag can be cleared.  If those thing happen concurrently, it&apos;s not thread safe.
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;//&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m re-reviewing all this code now to get it back in my head...&lt;/p&gt;</comment>
                            <comment id="14682096" author="erickerickson" created="Tue, 11 Aug 2015 17:12:19 +0000"  >&lt;p&gt;Thanks guys, getting it all in my head is...interesting.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yseeley%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;yseeley@gmail.com&quot;&gt;yseeley@gmail.com&lt;/a&gt; Yeah, I saw that comment. In that case, removing the two synchronizations in the refactored methods &lt;em&gt;other&lt;/em&gt; than addAndDelete is probably indicated. The one &lt;em&gt;in&lt;/em&gt; addAndDelete was there originally, just within the IndexWriter try/finally which is where the issues was since it&apos;d go out and get a new searcher eventually.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; I had to write a shell script to re-submit that individual test repeatedly, it&apos;d pretty much always fail for me by 50 runs. I&apos;ll back those changes out and run it on my machine where it fails reliably and post the results when I get a deadlock.&lt;/p&gt;</comment>
                            <comment id="14682191" author="markrmiller@gmail.com" created="Tue, 11 Aug 2015 18:08:22 +0000"  >&lt;p&gt;Yeah, I have a beasting script that does the same, though can also launch runs in parallel (&lt;a href=&quot;https://gist.github.com/markrmiller/dbdb792216dc98b018ad&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/markrmiller/dbdb792216dc98b018ad&lt;/a&gt;). Still no deadlock on my machine yet though. I&apos;ll keep trying for a while though.&lt;/p&gt;</comment>
                            <comment id="14682339" author="erickerickson" created="Tue, 11 Aug 2015 19:30:35 +0000"  >&lt;p&gt;Here&apos;s the stack trace. A few things:&lt;/p&gt;

&lt;p&gt;&amp;gt; I got this source by &quot;svn checkout -r1694809 &lt;a href=&quot;https://svn.apache.org/repos/asf/lucene/dev/trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/repos/asf/lucene/dev/trunk&lt;/a&gt;&quot; and added the test to that code base.&lt;/p&gt;

&lt;p&gt;&amp;gt; It appears to need two things to fail; a reload operation and a delete by query.&lt;/p&gt;

&lt;p&gt;&amp;gt; thread WRITER5 and TEST-TestReloadDeadlock.testReloadDeadlock-seed#&lt;span class=&quot;error&quot;&gt;&amp;#91;4CFFCB253DB33784&amp;#93;&lt;/span&gt;&quot; are the ones I think are fighting here.&lt;/p&gt;

&lt;p&gt;&amp;gt; The original fix was to pass the index writer from addDoc0() to addAndDelete, but this doesn&apos;t work either. I&apos;ll see if I can attach a run with that change for comparison.&lt;/p&gt;

&lt;p&gt;&amp;gt; I&apos;ve also attached the script I use to run this, although I don&apos;t run it in parallel.&lt;/p&gt;
</comment>
                            <comment id="14682486" author="erickerickson" created="Tue, 11 Aug 2015 20:54:55 +0000"  >&lt;p&gt;Here&apos;s a fail with passing the index writer from addDoc0() to addAndDelete, my first attempt at a &quot;fix&quot;.&lt;/p&gt;

&lt;p&gt;I commented out the necessary lines rather than add or delete them, so the line numbers should correspond to the checkout I mentioned above.&lt;/p&gt;</comment>
                            <comment id="14695206" author="markrmiller@gmail.com" created="Thu, 13 Aug 2015 13:24:52 +0000"  >&lt;p&gt;Strange, I have not been able to get the deadlock with that test on my machine.&lt;/p&gt;

&lt;p&gt;Do you have the full set of stack traces for a deadlock state available?&lt;/p&gt;</comment>
                            <comment id="14695341" author="erickerickson" created="Thu, 13 Aug 2015 15:17:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; I &lt;em&gt;thought&lt;/em&gt; everything was in the two zip files I attached a couple of days ago, what did I miss? See my comments two days ago for the provenance.&lt;/p&gt;

&lt;p&gt;BTW, I&apos;ll be intermittently available today and not at all tomorrow (business hours CA time) if you&apos;d like to chat.&lt;/p&gt;</comment>
                            <comment id="14695417" author="markrmiller@gmail.com" created="Thu, 13 Aug 2015 15:55:44 +0000"  >&lt;p&gt;Ah, sorry, I was looking for the full strack traces pre two days ago - didn&apos;t realize they were in the zip. I&apos;ve been having trouble extracting that into something viable on my mac. I&apos;ll try on my Ubuntu machine.&lt;/p&gt;</comment>
                            <comment id="14695441" author="erickerickson" created="Thu, 13 Aug 2015 16:07:52 +0000"  >&lt;p&gt;Let me know if you need them in another format. I did just download them and extract, so they probably aren&apos;t corrupt at least.&lt;/p&gt;</comment>
                            <comment id="14695610" author="yseeley@gmail.com" created="Thu, 13 Aug 2015 17:24:04 +0000"  >&lt;blockquote&gt;&lt;p&gt;Yeah, I saw that comment. In that case, removing the two synchronizations in the refactored methods other than addAndDelete is probably indicated. The one in addAndDelete was there originally, just within the IndexWriter try/finally which is where the issues was since it&apos;d go out and get a new searcher eventually.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Maybe... but it&apos;s also worth noting that those comments (and my thinking around it) were before (i think) index writers could be shared across reloads.&lt;/p&gt;

&lt;p&gt;It looks fine to me that you moved the ulog.add() outside of the writer get/release.&lt;/p&gt;</comment>
                            <comment id="14695628" author="yseeley@gmail.com" created="Thu, 13 Aug 2015 17:35:09 +0000"  >&lt;p&gt;Let me see how repeatable a deadlock is on my system, then we can look into removing some of the extra sync...&lt;/p&gt;</comment>
                            <comment id="14695714" author="erickerickson" created="Thu, 13 Aug 2015 18:16:47 +0000"  >&lt;p&gt;bq: It looks fine to me that you moved the ulog.add() outside of the writer get/release.&lt;/p&gt;

&lt;p&gt;That&apos;s exactly what makes me nervous. But having it &lt;em&gt;within&lt;/em&gt; the get/release is where the problem was.&lt;/p&gt;

&lt;p&gt;Let me know if there&apos;s anything you&apos;d like to chat about.&lt;/p&gt;

&lt;p&gt;And it wasn&apos;t predictably repeatable (of course). Sometimes the script I attached would run 10-15 iterations OK then barf. Sometimes faster. Never more than 50. With the changes I ran with 400-500 iterations without a problem.&lt;/p&gt;

&lt;p&gt;Since I can get it to fail reasonably predictably though, let me know if you want me to run any changes locally.&lt;/p&gt;</comment>
                            <comment id="14695729" author="markrmiller@gmail.com" created="Thu, 13 Aug 2015 18:26:22 +0000"  >&lt;blockquote&gt;&lt;p&gt;It looks fine to me that you moved the ulog.add() outside of the writer get/release.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Doh, that is my problem - I only reverted the first commit to DirectUpdateHandler2.&lt;/p&gt;</comment>
                            <comment id="14695732" author="markrmiller@gmail.com" created="Thu, 13 Aug 2015 18:28:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;That&apos;s exactly what makes me nervous. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That should make you nervous - the random test fails around the transcation log tests after should be more in the terrified range though &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14695772" author="yseeley@gmail.com" created="Thu, 13 Aug 2015 19:03:38 +0000"  >&lt;p&gt;Erick, I just now ran across this email from you 4 days ago:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Backed out &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7836&quot; title=&quot;Possible deadlock when closing refcounted index writers.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7836&quot;&gt;&lt;del&gt;SOLR-7836&lt;/del&gt;&lt;/a&gt; changes and TestStressReorder doesn&apos;t fail in 100&lt;br/&gt;
iterations, failed 16 times in 100 iterations with changes.&lt;br/&gt;
Digging....&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Is this still the case (that TestStressReorder now sometimes fails?)&lt;/p&gt;</comment>
                            <comment id="14695827" author="erickerickson" created="Thu, 13 Aug 2015 19:45:32 +0000"  >&lt;p&gt;bq: Is this still the case (that TestStressReorder now sometimes fails?)&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yseeley%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;yseeley@gmail.com&quot;&gt;yseeley@gmail.com&lt;/a&gt; It better &lt;em&gt;not&lt;/em&gt; be still failing or I&apos;ll have to fall on my sword. I&apos;m pretty sure I fixed that up, I can&apos;t imagine that I would just check the changes in since the TestStressReorder was what I ripped off to make my new test to avoid that deadlock and the link between the two is pretty obvious, even to me &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I can&apos;t do it right now, but I&apos;ll run TestStressReorder a lot this evening to be sure.&lt;/p&gt;
</comment>
                            <comment id="14697613" author="yseeley@gmail.com" created="Fri, 14 Aug 2015 19:46:31 +0000"  >&lt;p&gt;OK, so it wasn&apos;t too hard for me to replicate the deadlocks w/ the latest commits backed out, and the traces are similar to what was posted before... it&apos;s getIndexWriter fighting with newIndexWriter.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  2&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;WRITER10&quot;&lt;/span&gt; ID=28 TIMED_WAITING on java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;@d8cdd45
  2&amp;gt;    at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
  2&amp;gt;    - timed waiting on java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;@d8cdd45
  2&amp;gt;    at org.apache.solr.update.DefaultSolrCoreState.getIndexWriter(DefaultSolrCoreState.java:96)
  2&amp;gt;    at org.apache.solr.core.SolrCore.openNewSearcher(SolrCore.java:1588)
  2&amp;gt;    at org.apache.solr.update.UpdateLog.add(UpdateLog.java:455)
  2&amp;gt;    - locked org.apache.solr.update.UpdateLog@1df2955d
  2&amp;gt;    at org.apache.solr.update.DirectUpdateHandler2.addAndDelete(DirectUpdateHandler2.java:452)
[...]
  2&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;TEST-TestReloadDeadlock.testReloadDeadlock-seed#[D13A45EBBFA304C4]&quot;&lt;/span&gt; ID=12 TIMED_WAITING on java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;@d8cdd45
  2&amp;gt;    at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
  2&amp;gt;    - timed waiting on java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;@d8cdd45
  2&amp;gt;    at org.apache.solr.update.DefaultSolrCoreState.newIndexWriter(DefaultSolrCoreState.java:158)
  2&amp;gt;    - locked org.apache.solr.update.DefaultSolrCoreState@7d338874
  2&amp;gt;    at org.apache.solr.core.SolrCore.reload(SolrCore.java:479)
  2&amp;gt;    at org.apache.solr.core.CoreContainer.reload(CoreContainer.java:830)
  2&amp;gt;    at org.apache.solr.search.TestReloadDeadlock.testReloadDeadlock(TestReloadDeadlock.java:182)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;On straight trunk, I still get failures (just not deadlocks):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  2&amp;gt; 3406 ERROR (WRITER6) [    ] o.a.s.c.SolrCore org.apache.solr.common.SolrException: Error opening &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; searcher
  2&amp;gt;    at org.apache.solr.core.SolrCore.openNewSearcher(SolrCore.java:1673)
  2&amp;gt;    at org.apache.solr.core.SolrCore.getRealtimeSearcher(SolrCore.java:1530)
  2&amp;gt;    at org.apache.solr.update.VersionInfo.getVersionFromIndex(VersionInfo.java:202)
  2&amp;gt;    at org.apache.solr.update.UpdateLog.lookupVersion(UpdateLog.java:783)
  2&amp;gt;    at org.apache.solr.update.VersionInfo.lookupVersion(VersionInfo.java:195)
  2&amp;gt;    at org.apache.solr.update.processor.DistributedUpdateProcessor.versionAdd(DistributedUpdateProcessor.java:1088)
  2&amp;gt;    at org.apache.solr.update.processor.DistributedUpdateProcessor.processAdd(DistributedUpdateProcessor.java:705)
  2&amp;gt;    at org.apache.solr.update.processor.LogUpdateProcessor.processAdd(LogUpdateProcessorFactory.java:104)
  2&amp;gt;    at org.apache.solr.handler.loader.JsonLoader$SingleThreadedJsonLoader.handleAdds(JsonLoader.java:470)
  2&amp;gt;    at org.apache.solr.handler.loader.JsonLoader$SingleThreadedJsonLoader.processUpdate(JsonLoader.java:134)
  2&amp;gt;    at org.apache.solr.handler.loader.JsonLoader$SingleThreadedJsonLoader.load(JsonLoader.java:113)
  2&amp;gt;    at org.apache.solr.handler.loader.JsonLoader.load(JsonLoader.java:76)
  2&amp;gt;    at org.apache.solr.handler.UpdateRequestHandler$1.load(UpdateRequestHandler.java:98)
  2&amp;gt;    at org.apache.solr.handler.ContentStreamHandlerBase.handleRequestBody(ContentStreamHandlerBase.java:74)
  2&amp;gt;    at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:151)
  2&amp;gt;    at org.apache.solr.core.SolrCore.execute(SolrCore.java:2079)
  2&amp;gt;    at org.apache.solr.servlet.DirectSolrConnection.request(DirectSolrConnection.java:131)
  2&amp;gt;    at org.apache.solr.SolrTestCaseJ4.updateJ(SolrTestCaseJ4.java:1104)
  2&amp;gt;    at org.apache.solr.SolrTestCaseJ4.addAndGetVersion(SolrTestCaseJ4.java:1250)
  2&amp;gt;    at org.apache.solr.search.TestReloadDeadlock.addDoc(TestReloadDeadlock.java:200)
  2&amp;gt;    at org.apache.solr.search.TestReloadDeadlock.access$100(TestReloadDeadlock.java:46)
  2&amp;gt;    at org.apache.solr.search.TestReloadDeadlock$1.run(TestReloadDeadlock.java:156)
  2&amp;gt; Caused by: java.lang.NullPointerException
  2&amp;gt;    at org.apache.solr.core.SolrCore.openNewSearcher(SolrCore.java:1642)
  2&amp;gt;    ... 21 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14697655" author="markrmiller@gmail.com" created="Fri, 14 Aug 2015 20:02:45 +0000"  >&lt;blockquote&gt;&lt;p&gt;and the traces are similar to what was posted before&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;There is not a third thread that has the Writer out? Both of those traces line up with another thread having the writer. I don&apos;t spend why they would deadlock each other without another thread involved.&lt;/p&gt;

&lt;p&gt;I&apos;ll take a closer look now that I can duplicate it. I still suspect the proper fix for this is in SolrCoreState.&lt;/p&gt;</comment>
                            <comment id="14697747" author="erickerickson" created="Fri, 14 Aug 2015 21:01:38 +0000"  >&lt;p&gt;I ran the StressTestReorder yesterday with the changes and didn&apos;t get it to fail for 50 runs on my laptop. Then last night I kicked off a 1,000 repetition run on my home machine and... didn&apos;t remember to look this morning before I left home.&lt;/p&gt;

&lt;p&gt;So I&apos;m pretty sure that StressTestReorder is OK with the latest patch, I&apos;ll look tonight to be sure.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yseeley%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;yseeley@gmail.com&quot;&gt;yseeley@gmail.com&lt;/a&gt; I saw what I think is the same failure on the dev list from a Jenkins build last night and AFAIK the changes are still in there.&lt;/p&gt;</comment>
                            <comment id="14697771" author="yseeley@gmail.com" created="Fri, 14 Aug 2015 21:21:30 +0000"  >&lt;blockquote&gt;&lt;p&gt;There is not a third thread that has the Writer out?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I just checked again... didn&apos;t see another.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Both of those traces line up with another thread having the writer. I don&apos;t spend why they would deadlock each other without another thread involved.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The first thread has the writer?  I have never really reviewed SolrCoreState in depth though... so I&apos;m still not really sure.&lt;/p&gt;</comment>
                            <comment id="14697858" author="yseeley@gmail.com" created="Fri, 14 Aug 2015 22:20:17 +0000"  >&lt;p&gt;Here&apos;s the scenario w/ the old code.&lt;/p&gt;

&lt;p&gt;thread1 does an add:&lt;br/&gt;
  1) in DUH2, calls coreState.getIndexWriter()&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;this increments the ref count on the writer and sets coreState.writerFree=false&lt;br/&gt;
  2) calls UpdateLog.add&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;thread2 calls core reload():&lt;br/&gt;
  3) calls coreState.newIndexWriter()&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;coreState.pauseWriter is set to true, so no new references will be handed out&lt;/li&gt;
	&lt;li&gt;goes into a loop waiting for writerFree=true (for all other references that were handed out to be returned)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;thread1:&lt;br/&gt;
  4) UpdateLog.add continues and indirectly causes coreState.getIndexWriter() to be called&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;sees coreState.pauseWriter set to true and thus does into wait loop&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So: one can&apos;t call getIndexWriter() and then do anything else that will eventually call getIndexWriter() or newIndexWriter()&lt;br/&gt;
If we keep that restriction, then moving the ulog.add outside of the getIndexWriter/release block was correct.&lt;/p&gt;

&lt;p&gt;Don&apos;t know about the other changes... the extra sync added in DUH2 does still seem unnecessary.  And I haven&apos;t looked at what changes were made to SolrCoreState yet.&lt;/p&gt;</comment>
                            <comment id="14698050" author="erickerickson" created="Sat, 15 Aug 2015 01:52:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yseeley%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;yseeley@gmail.com&quot;&gt;yseeley@gmail.com&lt;/a&gt; Glad to see you&apos;re seeing the same thing I saw, senility is not here yet!&lt;/p&gt;

&lt;p&gt;I looked at the StressTestReorder when I got back home tonight and 1,000 iterations went through fine. Whew!&lt;/p&gt;

&lt;p&gt;I&apos;ll remove the extra synch in DUH2 and run the tests tonight to see what happens, along with some additional debugging in case we hit the null pointer exception again. Not a clue what&apos;s happening there.&lt;/p&gt;</comment>
                            <comment id="14698083" author="yseeley@gmail.com" created="Sat, 15 Aug 2015 03:22:01 +0000"  >&lt;p&gt;The NPE failures are likely unrelated to any changes made thus far... I think it&apos;s probably related to the fact that &quot;uhandler&quot; can abruptly change in the UpdateLog on a reload, and can be used perhaps before it&apos;s ready?  I haven&apos;t gone down that rabbit hole...&lt;/p&gt;</comment>
                            <comment id="14698257" author="yseeley@gmail.com" created="Sat, 15 Aug 2015 13:09:12 +0000"  >&lt;p&gt;I ran a while with trunk, with removing the extra sync on the normal &quot;add&quot; case only, not the &quot;addDelete&quot; case.&lt;br/&gt;
I hit another deadlock.&lt;br/&gt;
This looks like the case Mark was looking for before... with a different thread holding the writer.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  2&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;WRITER5&quot;&lt;/span&gt; ID=23 BLOCKED on java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;@5764facb owned by &lt;span class=&quot;code-quote&quot;&gt;&quot;WRITER4&quot;&lt;/span&gt; ID=22
  2&amp;gt;    at org.apache.solr.update.DirectUpdateHandler2.commit(DirectUpdateHandler2.java:593)
  2&amp;gt;    - blocked on java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;@5764facb
  2&amp;gt;    at org.apache.solr.update.processor.RunUpdateProcessor.processCommit(RunUpdateProcessorFactory.java:95)
  2&amp;gt;    at org.apache.solr.update.processor.UpdateRequestProcessor.processCommit(UpdateRequestProcessor.java:64)
  2&amp;gt;    at org.apache.solr.update.processor.DistributedUpdateProcessor.doLocalCommit(DistributedUpdateProcessor.java:1641)
  2&amp;gt;    at org.apache.solr.update.processor.DistributedUpdateProcessor.processCommit(DistributedUpdateProcessor.java:1618)
  2&amp;gt;    at org.apache.solr.update.processor.LogUpdateProcessor.processCommit(LogUpdateProcessorFactory.java:161)
  2&amp;gt;    at org.apache.solr.handler.loader.XMLLoader.processUpdate(XMLLoader.java:270)
[...]
  2&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;WRITER4&quot;&lt;/span&gt; ID=22 TIMED_WAITING on java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;@5a94059a
  2&amp;gt;    at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
  2&amp;gt;    - timed waiting on java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;@5a94059a
  2&amp;gt;    at org.apache.solr.update.DefaultSolrCoreState.getIndexWriter(DefaultSolrCoreState.java:96)
  2&amp;gt;    at org.apache.solr.core.SolrCore.openNewSearcher(SolrCore.java:1588)
  2&amp;gt;    at org.apache.solr.update.UpdateLog.add(UpdateLog.java:455)
  2&amp;gt;    - locked org.apache.solr.update.UpdateLog@5911991e
  2&amp;gt;    at org.apache.solr.update.DirectUpdateHandler2.addAndDelete(DirectUpdateHandler2.java:331)
  2&amp;gt;    - locked java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;@5764facb
  2&amp;gt;    at org.apache.solr.update.DirectUpdateHandler2.addDoc0(DirectUpdateHandler2.java:200)
  2&amp;gt;    at org.apache.solr.update.DirectUpdateHandler2.addDoc(DirectUpdateHandler2.java:164)
  2&amp;gt;    at org.apache.solr.update.processor.RunUpdateProcessor.processAdd(RunUpdateProcessorFactory.java:69)
[...]
  2&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;TEST-TestReloadDeadlock.testReloadDeadlock-seed#[D4E455E167793E1]&quot;&lt;/span&gt; ID=12 TIMED_WAITING on java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;@5a94059a
  2&amp;gt;    at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
  2&amp;gt;    - timed waiting on java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;@5a94059a
  2&amp;gt;    at org.apache.solr.update.DefaultSolrCoreState.newIndexWriter(DefaultSolrCoreState.java:156)
  2&amp;gt;    - locked org.apache.solr.update.DefaultSolrCoreState@1b88614d
  2&amp;gt;    at org.apache.solr.core.SolrCore.reload(SolrCore.java:479)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Writer5 wants to do a commit&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;calls solrCoreState.getIndexWriter()&lt;/li&gt;
	&lt;li&gt;blocks waiting for updateLock&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Writer4 wants to do an addAndDelete&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;aquires updateLock&lt;/li&gt;
	&lt;li&gt;aquires UpdateLog.this&lt;/li&gt;
	&lt;li&gt;calls DefaultSolrCoreState.getIndexWriter and waits forever&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Main-test-thread wants to do a reload:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;calls DefaultSolrCoreState.newIndexWriter and waits forever&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;It feels like this type of deadlock can still be hit on trunk now unmodified?&lt;br/&gt;
Perhaps the right solution was to just pass the IndexWriter down once you aquire it. &lt;/p&gt;</comment>
                            <comment id="14698267" author="yseeley@gmail.com" created="Sat, 15 Aug 2015 13:40:50 +0000"  >&lt;p&gt;Passing the indexWriter down would also fix the NPEs I think since then openReader wouldn&apos;t try to obtain it from the yet-to-be-finished new update handler?&lt;/p&gt;</comment>
                            <comment id="14698671" author="yseeley@gmail.com" created="Sun, 16 Aug 2015 13:49:27 +0000"  >&lt;p&gt;OK, I let the current unmodified trunk run overnight.&lt;br/&gt;
I got 14 fails, 4 of which were deadlocks.&lt;/p&gt;

&lt;p&gt;Here&apos;s the only changes I made to the test:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Index: solr/core/src/test/org/apache/solr/search/TestReloadDeadlock.java
===================================================================
--- solr/core/src/test/org/apache/solr/search/TestReloadDeadlock.java	(revision 1695727)
+++ solr/core/src/test/org/apache/solr/search/TestReloadDeadlock.java	(working copy)
@@ -74,7 +74,7 @@
     &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; nWriteThreads = 5 + random().nextInt(10);
 
     &lt;span class=&quot;code-comment&quot;&gt;// query variables
&lt;/span&gt;-    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; AtomicLong reloads = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AtomicLong(50);  &lt;span class=&quot;code-comment&quot;&gt;// number of reloads. Increase &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; number to force failure.
&lt;/span&gt;+    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; AtomicLong reloads = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AtomicLong(200);  &lt;span class=&quot;code-comment&quot;&gt;// number of reloads. Increase &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; number to force failure.
&lt;/span&gt; 
     ifVerbose(&lt;span class=&quot;code-quote&quot;&gt;&quot;commitPercent&quot;&lt;/span&gt;, commitPercent, &lt;span class=&quot;code-quote&quot;&gt;&quot;deleteByQueryPercent&quot;&lt;/span&gt;, deleteByQueryPercent
         , &lt;span class=&quot;code-quote&quot;&gt;&quot;ndocs&quot;&lt;/span&gt;, ndocs, &lt;span class=&quot;code-quote&quot;&gt;&quot;nWriteThreads&quot;&lt;/span&gt;, nWriteThreads, &lt;span class=&quot;code-quote&quot;&gt;&quot;reloads&quot;&lt;/span&gt;, reloads);
@@ -177,7 +177,7 @@
 
     &lt;span class=&quot;code-comment&quot;&gt;// The reload operation really doesn&apos;t need to happen from multiple threads, we just want it firing pretty often.
&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (reloads.get() &amp;gt; 0) {
-      &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(10 + random().nextInt(250));
+      &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(1 + random().nextInt(50));
       reloads.decrementAndGet();
       h.getCoreContainer().reload(&lt;span class=&quot;code-quote&quot;&gt;&quot;collection1&quot;&lt;/span&gt;);
     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14698680" author="markrmiller@gmail.com" created="Sun, 16 Aug 2015 14:16:08 +0000"  >&lt;blockquote&gt;
&lt;p&gt;So: one can&apos;t call getIndexWriter() and then do anything else that will eventually call getIndexWriter() or newIndexWriter()&lt;br/&gt;
If we keep that restriction, then moving the ulog.add outside of the getIndexWriter/release block was correct.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right - the expected use is to be careful and quickly get and release the writer so that you don&apos;t accidentally try and getwriter or newwriter in between. This is why I thought Erik&apos;s first fix attempt sounded right. But then I guess he started hitting the deadlock you are still getting and figured it was not correct. Seems like it is correct, but we also have to address this other issue.&lt;/p&gt;</comment>
                            <comment id="14698687" author="markrmiller@gmail.com" created="Sun, 16 Aug 2015 14:22:37 +0000"  >&lt;blockquote&gt;&lt;p&gt;Perhaps the right solution was to just pass the IndexWriter down once you aquire it.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Passing the indexWriter down would also fix the NPEs I think since then openReader wouldn&apos;t try to obtain it from the yet-to-be-finished new update handler?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Wasn&apos;t that Erik&apos;s first fix attempt?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think the solution is to just pass the IndexWriter down to addAndDelete, but won&apos;t have time to really look until this evening.&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="14698697" author="yseeley@gmail.com" created="Sun, 16 Aug 2015 14:39:38 +0000"  >&lt;blockquote&gt;&lt;p&gt;Wasn&apos;t that Erik&apos;s first fix attempt?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah, I was essentially saying that seems to be the correct approach.&lt;/p&gt;
</comment>
                            <comment id="14698699" author="markrmiller@gmail.com" created="Sun, 16 Aug 2015 14:47:12 +0000"  >&lt;p&gt;Hmm, I wonder what was still not working about it yet. I should be able to duplicate this too now, I&apos;ll take a look at the stack traces with just that change.&lt;/p&gt;</comment>
                            <comment id="14698724" author="yseeley@gmail.com" created="Sun, 16 Aug 2015 15:29:12 +0000"  >&lt;p&gt;At some point in time, it seems like everyone develops some sort of script to run a test over and over again...&lt;br/&gt;
I really should have put this up years ago:&lt;br/&gt;
&lt;a href=&quot;https://github.com/yonik/misc/blob/master/scripts/test.sh&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/yonik/misc/blob/master/scripts/test.sh&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14698752" author="erickerickson" created="Sun, 16 Aug 2015 16:48:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; If you check out trunk revision 1694809, then the stack trace above in the deadlock_5_pass_iw.res.zip is the problem I hit by passing the indexwriter down to DUH2.addanddelete. It really doesn&apos;t help because updatelog.add has this bit of code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
          RefCounted e1 = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.uhandler.core.openNewSearcher(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
          e1.decref();
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception var8) {
          SolrException.log(log, &lt;span class=&quot;code-quote&quot;&gt;&quot;Error opening realtime searcher &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; deleteByQuery&quot;&lt;/span&gt;, var8);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;so the IW passed to addAndDelete in DUH2 doesn&apos;t make a difference, the fact that the IW is held open is blocking the call to openNewSearcher above; it doesn&apos;t matter whether addAndDelete has an already opened IW passed in or opens its own, as long as the IW is open across the call to ulog.add(), a deadlock occurs. Sometimes.&lt;/p&gt;

&lt;p&gt;Based on the exception message, would a better approach be to open up the new searcher in delete by query instead? Would that cover all the cases? I&apos;ll look a little here. Then I could move all the ulog.add()s back inside the associated IW and again tightly couple the document adds with updating the ulog.&lt;/p&gt;

&lt;p&gt;Or maybe the answer is making realtime searchers sensitive to whether anything&apos;s been indexed since the last time it was opened rather than pre-opening a new one in addDoc0(). Don&apos;t even know if it&apos;s possible, haven&apos;t looked yet. Essentially this would make opening a realtime searcher &quot;lazy&quot;. Which I can argue is a better solution than adding this overhead to all updates, although it also seems it would make realtime gets vary a lot depending on whether they had to open a searcher or not.&lt;/p&gt;

</comment>
                            <comment id="14698792" author="erickerickson" created="Sun, 16 Aug 2015 17:45:06 +0000"  >&lt;p&gt;Poking a little more, opening a new searcher in add happens only when clearCaches==true, which only happens explicitly in DUH2.addAndDelete which is where all this started. There&apos;s also a call in the CDCR code that passes a variable in, but I don&apos;t think that&apos;s really relevant.&lt;/p&gt;

&lt;p&gt;It&apos;s simple enough to move opening a new searcher up to these two places, I&apos;ll give it a try to evaluate. I don&apos;t like that solution much since it&apos;s trappy; a new call to add(cmd, true) that fails to open a new searcher could re-introduce the problem that opening that searcher where it&apos;s done now is designed to prevent. I suppose a big fat warning is in order?&lt;/p&gt;

&lt;p&gt;Let me try it just to see whether it cures things or not. I&apos;m pretty sure it&apos;ll cure the deadlock problem, I&apos;ll first try to just comment out the openSearcher and see if I can blow up the real time get tests, then move the open out and see if either realtime get tests or the new deadlock test fail with the reorganized code. When I collect that data we can discuss some more. Probably have something later today.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yseeley%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;yseeley@gmail.com&quot;&gt;yseeley@gmail.com&lt;/a&gt; Those numbers in the new test were chosen completely arbitrarily, I&apos;m guessing that the point of your changes is to drive the failure more often without lengthening the time the test takes, so I&apos;ll incorporate them.&lt;/p&gt;</comment>
                            <comment id="14703493" author="erickerickson" created="Wed, 19 Aug 2015 18:11:40 +0000"  >&lt;p&gt;This patch should be applied after &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7836&quot; title=&quot;Possible deadlock when closing refcounted index writers.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7836&quot;&gt;&lt;del&gt;SOLR-7836&lt;/del&gt;&lt;/a&gt;.patch if anyone is back-porting&lt;/p&gt;

&lt;p&gt;Here&apos;s a new patch for comment that &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;puts the ulog writes back inside the IW blocks&lt;/li&gt;
	&lt;li&gt;pulls out the problematic open searcher in ulog.add to a separate method.&lt;/li&gt;
	&lt;li&gt;calls the extracted method from the two places that could call UpdateLog.add(cmd, true), which was the condition for opening a new searcher. The calls to the new method must be outside the IW block.&lt;/li&gt;
	&lt;li&gt;removes the extra synchronized blocks on solrCoreState.getUpdatelock()&lt;/li&gt;
	&lt;li&gt;changes the test to hit this condition harder as per Yonik.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;It&apos;s possible that the CDCR code calls ulog.add with clearCaches==true, in which case the extracted method in ulog is called. Frankly I doubt that&apos;s a necessary thing, but seems harmless.&lt;/p&gt;

&lt;p&gt;I don&apos;t particularly like decoupling the open searcher from the updatelog.add, but I like lockups even less. Not to mention possible tlog craziness. So I&apos;ll live with my dislike.&lt;/p&gt;

&lt;p&gt;I think this addresses concerns about the tlog synchronization.&lt;/p&gt;

&lt;p&gt;I ran this last night for 360 iterations, then made some trivial changes (yeah, right). I&apos;ll try some beasting on this today plus StressTestReorder, then do the usual precommit and full test. Assuming all that goes well I&apos;ll probably check this in tomorrow and call this done unless there are objections.&lt;/p&gt;

&lt;p&gt;This, coupled with Yoniks changes for the NPE should put this to bed.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yseeley%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;yseeley@gmail.com&quot;&gt;yseeley@gmail.com&lt;/a&gt; all comments welcome of course.&lt;/p&gt;</comment>
                            <comment id="14705052" author="yseeley@gmail.com" created="Thu, 20 Aug 2015 14:53:40 +0000"  >&lt;blockquote&gt;&lt;p&gt;pulls out the problematic open searcher in ulog.add to a separate method.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;There are a few areas with complex synchronization that should not be changed unless one is confident about understanding why all the synchronization was there in the first place.  Having the tests pass isn&apos;t a high enough bar for these areas because of the difficulty in actually getting a test to expose subtle race conditions or thread safety issues.  This comes back to my original &quot;get it back in my head&quot; - I don&apos;t fee comfortable messing with this stuff either until I&apos;ve really internalized the bigger picture again... and it doesn&apos;t last &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;For the specific case above, one can&apos;t just take what was one synchronized block and break it up into two.  It certainly creates race conditions and breaks the invariants we try to keep.  The specific invariant here is that if it&apos;s not in the tlog maps, then it is guaranteed to be in the realtime reader.  Hopefully some of our tests would fail with this latest patch... but it&apos;s hard stuff to test.&lt;/p&gt;

&lt;p&gt;I worked up a patch that passed down the IndexWriter (it needs to be passed &lt;b&gt;all&lt;/b&gt; the way down to SolrCore.openSearcher to actually avoid deadlocks).  That ended up changing more code than I&apos;d like... so now I&apos;m working up a patch to make IW locking re-entrant.  That approach should be less fragile going forward (i.e. less likely to easily introduce a deadlock through seemingly unrelated changes).&lt;/p&gt;</comment>
                            <comment id="14705157" author="yseeley@gmail.com" created="Thu, 20 Aug 2015 15:50:51 +0000"  >&lt;p&gt;I tried applying the last patch and running TestStressReorder and luckily it does fail often for me.&lt;/p&gt;</comment>
                            <comment id="14705478" author="erickerickson" created="Thu, 20 Aug 2015 18:19:23 +0000"  >&lt;p&gt;bq: I tried applying the last patch and running TestStressReorder and luckily it does fail often for me.&lt;/p&gt;

&lt;p&gt;Yep, I saw that last night. I looked a bit at whether it was a test artifact and apparently it&apos;s not so I was going to dive into that today.&lt;/p&gt;

&lt;p&gt;Anyway, since you&apos;re working up alternatives, I&apos;ll leave it to you. The current checkin (not the latest patch which I won&apos;t commit) at least avoids the deadlock that started me down this path in the first place. Whether it creates other issues is, of course, the $64K question. Let me know if there&apos;s anything I can do besides cheer you on.&lt;/p&gt;</comment>
                            <comment id="14705580" author="yseeley@gmail.com" created="Thu, 20 Aug 2015 19:08:20 +0000"  >&lt;p&gt;OK, here&apos;s a patch that uses a reentrant read-write lock in DefaultSolrCoreState.&lt;/p&gt;

&lt;p&gt;Notes:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;no more pauseWriter / freeWriter variables&lt;/li&gt;
	&lt;li&gt;readlock is for grabbing the current writer, writeLock is for ensuring there are no readers&lt;/li&gt;
	&lt;li&gt;the RefCounted&amp;lt;IndexWriter&amp;gt; doesn&apos;t do much any more... decRef releases the readLock, that&apos;s the only important thing.  I just kept it to keep the API the same for now.&lt;/li&gt;
	&lt;li&gt;all of newIndexWriter, closeIndexWriter, and openIndexWriter all delegate to changeIndexWriter to remove duplicated code.  This does change the semantics of some of these methods, but I hope for the better?
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;The old openIndexWriter method only synchronized on writerPauseLock, so if there were any readers and writers in the lock loop, or even readers open, this method could go in and still change the writer anyway.  Sharing the code in changeWriter now means that it would wait for any readers to finish (which looking at the comments implies there should not be anyway?  and if there were, new IW creation would fail), close any existing old writer, and then open the new one.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;I reordered some things so that if we got an exception while opening a new writer, the writer reference would already be cleared so we won&apos;t simply default to using the old (presumably now closed) writer, but will try to open again.  Should be more resilient in the face of a spurious exception.&lt;/li&gt;
	&lt;li&gt;it&apos;s really not clear if polling is still needed in getIndexWriter, but I kept it for now just to be safe.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;looping some tests now...&lt;/p&gt;</comment>
                            <comment id="14705653" author="erickerickson" created="Thu, 20 Aug 2015 19:54:57 +0000"  >&lt;p&gt;I&apos;ll beast the stressdeadlock and stresstestreorder for a while as well.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="14705966" author="erickerickson" created="Thu, 20 Aug 2015 23:22:29 +0000"  >&lt;p&gt;FWIW, 96 runs each (look, 96 divides by 6 processors evenly, OK?) and both StressTestReorder and TestReloadDeadlock seem happy, along with precommit. Running full test suite now.&lt;/p&gt;</comment>
                            <comment id="14707634" author="erickerickson" created="Fri, 21 Aug 2015 23:26:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yseeley%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;yseeley@gmail.com&quot;&gt;yseeley@gmail.com&lt;/a&gt; Since you&apos;ve done the heavy lifting here and I&apos;ve beasted both the the tests, and a full test also worked, do you want me to just go ahead and check it in? Or do you want to polish it yet?&lt;/p&gt;</comment>
                            <comment id="14707760" author="yseeley@gmail.com" created="Sat, 22 Aug 2015 01:24:47 +0000"  >&lt;p&gt;I&apos;m running some more tests and will do a little more polishing on comments...&lt;/p&gt;</comment>
                            <comment id="14712222" author="yseeley@gmail.com" created="Wed, 26 Aug 2015 00:10:03 +0000"  >&lt;p&gt;I&apos;ve been running ChaosMonkeySafeLeaderTest for about 3 days with my test script that also searches for corrupt indexes or assertion failures even when the test still passes.&lt;br/&gt;
Current trunk (as of last week): 9 corrupt indexes&lt;br/&gt;
Patched trunk: 14 corrupt indexes and 2 test failures (inconsistent shards)&lt;/p&gt;

&lt;p&gt;The corrupt indexes &lt;b&gt;may&lt;/b&gt; not be a problem, I don&apos;t really know.  We kill off servers, perhaps during replication?  Seems like that could produce corrupt indexes, but I don&apos;t know if that&apos;s the scenario or not.  Increasing the incidence of those doesn&apos;t necessarily point to a problem either.  But inconsistent shards vs not... does seem like a problem if it holds.&lt;/p&gt;

&lt;p&gt;I&apos;ve reviewed the locking code again, and it looks solid, so I&apos;m not sure what&apos;s going on.&lt;/p&gt;

&lt;p&gt;Here&apos;s a typical corrupt index trace:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  2&amp;gt; 21946 WARN  (RecoveryThread-collection1) [n:127.0.0.1:51815_ c:collection1 s:shard1 r:core_node2 x:collection1] o.a.s.h.IndexFetcher Could not retrie
ve checksum from file.
  2&amp;gt; org.apache.lucene.index.CorruptIndexException: codec footer mismatch (file truncated?): actual footer=1698720114 vs expected footer=-1071082520 (resource=MMapIndexInput(path=&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/code/lusolr_clean2/solr/build/solr-core/test/J0/temp/solr.cloud.ChaosMonkeySafeLeaderTest_B7DC9C42462BF20D-001/shard-2-001/cores/collection1/data/index/_0.fdt&quot;&lt;/span&gt;))
  2&amp;gt;    at org.apache.lucene.codecs.CodecUtil.validateFooter(CodecUtil.java:416)
  2&amp;gt;    at org.apache.lucene.codecs.CodecUtil.retrieveChecksum(CodecUtil.java:401)
  2&amp;gt;    at org.apache.solr.handler.IndexFetcher.compareFile(IndexFetcher.java:876)
  2&amp;gt;    at org.apache.solr.handler.IndexFetcher.downloadIndexFiles(IndexFetcher.java:839)
  2&amp;gt;    at org.apache.solr.handler.IndexFetcher.fetchLatestIndex(IndexFetcher.java:437)
  2&amp;gt;    at org.apache.solr.handler.IndexFetcher.fetchLatestIndex(IndexFetcher.java:265)
  2&amp;gt;    at org.apache.solr.handler.ReplicationHandler.doFetch(ReplicationHandler.java:382)
  2&amp;gt;    at org.apache.solr.cloud.RecoveryStrategy.replicate(RecoveryStrategy.java:162)
  2&amp;gt;    at org.apache.solr.cloud.RecoveryStrategy.doRecovery(RecoveryStrategy.java:437)
  2&amp;gt;    at org.apache.solr.cloud.RecoveryStrategy.run(RecoveryStrategy.java:227)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14716703" author="yseeley@gmail.com" created="Thu, 27 Aug 2015 13:56:33 +0000"  >&lt;p&gt;I&apos;m trying some different variants of my patch, trying to pin down exactly what change in semantics are causing the fails.  It takes some time though... I normally need to let it loop for a day to get failures.&lt;/p&gt;</comment>
                            <comment id="14725676" author="yseeley@gmail.com" created="Tue, 1 Sep 2015 16:51:49 +0000"  >&lt;p&gt;OK, I found the issue.&lt;br/&gt;
When I re-wrote the SolrCoreState locking to use reentrant read-write locks, I was using the current trunk as a reference.  Unfortunately, a previous commit in this issue had introduced a bug by changing the semantics.  I didn&apos;t realize it until I went back to look at trunk before any commits on this issue.&lt;/p&gt;

&lt;p&gt;The bug was the addition of this to closeIndexWriter:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;     } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
        pauseWriter = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
        writerPauseLock.notifyAll();
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;closeIndexWriter / newIndexWriter are meant to be used as a pair, and block any readers inbetween them being called.&lt;/p&gt;

&lt;p&gt;I&apos;ve been looping ChaosMonkeySafeLeaderTest since yesterday afternoon and no fails yet.&lt;/p&gt;</comment>
                            <comment id="14726204" author="markrmiller@gmail.com" created="Tue, 1 Sep 2015 21:17:43 +0000"  >&lt;blockquote&gt;&lt;p&gt;The bug was the addition of this to closeIndexWriter:&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ouch, lucky to notice that. Shows how careful we have to be when touching update side synchronization. Quick commits can quickly get lost and introduce hard to track down bugs.&lt;/p&gt;</comment>
                            <comment id="14726738" author="erickerickson" created="Wed, 2 Sep 2015 04:46:58 +0000"  >&lt;p&gt;Hmmm, looks like I screwed the pooch on that one. Siiiggggghhhhh.&lt;/p&gt;</comment>
                            <comment id="14727456" author="erickerickson" created="Wed, 2 Sep 2015 14:54:04 +0000"  >&lt;p&gt;Worth merging into 5.3 in case a 5.3.1 gets cut?&lt;/p&gt;</comment>
                            <comment id="14729210" author="jira-bot" created="Thu, 3 Sep 2015 15:07:25 +0000"  >&lt;p&gt;Commit 1701043 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yonik%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;yonik@apache.org&quot;&gt;yonik@apache.org&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1701043&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1701043&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7836&quot; title=&quot;Possible deadlock when closing refcounted index writers.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7836&quot;&gt;&lt;del&gt;SOLR-7836&lt;/del&gt;&lt;/a&gt;: change SolrCoreState to use a reentrant locking implementation to fix deadlocks&lt;/p&gt;</comment>
                            <comment id="14729212" author="jira-bot" created="Thu, 3 Sep 2015 15:08:48 +0000"  >&lt;p&gt;Commit 1701044 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yonik%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;yonik@apache.org&quot;&gt;yonik@apache.org&lt;/a&gt; in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1701044&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1701044&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7836&quot; title=&quot;Possible deadlock when closing refcounted index writers.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7836&quot;&gt;&lt;del&gt;SOLR-7836&lt;/del&gt;&lt;/a&gt;: change SolrCoreState to use a reentrant locking implementation to fix deadlocks&lt;/p&gt;</comment>
                            <comment id="14729227" author="yseeley@gmail.com" created="Thu, 3 Sep 2015 15:16:37 +0000"  >&lt;p&gt;Not sure if there will even be a 5.3.1 release.&lt;br/&gt;
If there is, perhaps everything that was committed as part of this issue should go back?  Would be nice to let it bake a while longer in 5x/trunk just to make sure that nothing else is broken.&lt;/p&gt;</comment>
                            <comment id="14730965" author="erickerickson" created="Fri, 4 Sep 2015 15:34:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yseeley%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;yseeley@gmail.com&quot;&gt;yseeley@gmail.com&lt;/a&gt;] re: back-porting to 5.3.1. Never mind...&lt;/p&gt;

&lt;p&gt;I just checked to be sure. Noble cut the 5.3 branch 3 days &lt;em&gt;before&lt;/em&gt; my first checkin for this ticket. If the problems you found with that check in were in the release a back-port was in order. But  since they&apos;re not, I see no need.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12751314" name="SOLR-7836-reorg.patch" size="6122" author="erickerickson" created="Wed, 19 Aug 2015 18:11:40 +0000"/>
                            <attachment id="12749489" name="SOLR-7836-synch.patch" size="1315" author="erickerickson" created="Sun, 9 Aug 2015 21:34:51 +0000"/>
                            <attachment id="12753555" name="SOLR-7836.patch" size="16003" author="yseeley@gmail.com" created="Tue, 1 Sep 2015 16:51:49 +0000"/>
                            <attachment id="12751557" name="SOLR-7836.patch" size="14989" author="yseeley@gmail.com" created="Thu, 20 Aug 2015 19:08:20 +0000"/>
                            <attachment id="12749423" name="SOLR-7836.patch" size="24808" author="erickerickson" created="Sat, 8 Aug 2015 16:39:33 +0000"/>
                            <attachment id="12749404" name="SOLR-7836.patch" size="24734" author="erickerickson" created="Sat, 8 Aug 2015 05:30:11 +0000"/>
                            <attachment id="12747427" name="SOLR-7836.patch" size="4612" author="erickerickson" created="Mon, 27 Jul 2015 21:28:55 +0000"/>
                            <attachment id="12749915" name="deadlock_3.res.zip" size="47167" author="erickerickson" created="Tue, 11 Aug 2015 19:30:35 +0000"/>
                            <attachment id="12749942" name="deadlock_5_pass_iw.res.zip" size="116159" author="erickerickson" created="Tue, 11 Aug 2015 20:54:55 +0000"/>
                            <attachment id="12749916" name="deadlock_test" size="806" author="erickerickson" created="Tue, 11 Aug 2015 19:30:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>10.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 11 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2hzhj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>