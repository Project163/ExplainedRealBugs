<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:32:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-4136] SolrCloud bugs when servlet context contains &quot;/&quot; or &quot;_&quot;</title>
                <link>https://issues.apache.org/jira/browse/SOLR-4136</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;SolrCloud does not work properly with non-trivial values for &quot;hostContext&quot; (ie: the servlet context path).  In particular...&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Using a hostContext containing a  &quot;/&quot; (ie: a servlet context with a subdir path, semi-common among people who organize webapps hierarchically for lod blanacer rules) is explicitly forbidden in ZkController because of how the hostContext is used to build a ZK nodeName&lt;/li&gt;
	&lt;li&gt;Using a hostContext containing a &quot;&amp;#95;&quot; causes problems in OverseerCollectionProcessor where it assumes all &quot;&amp;#95;&quot; characters should be converted to &quot;/&quot; to reconstitute a URL from nodeName (NOTE: this code specifically has a TODO to fix this, and then has a subsequent TODO about assuming &quot;http://&quot; labeled &quot;this sucks&quot;)&lt;/li&gt;
&lt;/ul&gt;

</description>
                <environment></environment>
        <key id="12618516">SOLR-4136</key>
            <summary>SolrCloud bugs when servlet context contains &quot;/&quot; or &quot;_&quot;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Chris M. Hostetter</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Sun, 2 Dec 2012 23:03:58 +0000</created>
                <updated>Mon, 9 May 2016 18:55:17 +0000</updated>
                            <resolved>Fri, 14 Dec 2012 19:22:43 +0000</resolved>
                                    <version>4.0</version>
                                    <fixVersion>4.1</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13508394" author="hossman" created="Sun, 2 Dec 2012 23:04:50 +0000"  >
&lt;p&gt;Context...&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/lucene-solr-user/201211.mbox/%3Calpine.DEB.2.02.1211292004430.2543@frisbee%3E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://mail-archives.apache.org/mod_mbox/lucene-solr-user/201211.mbox/%3Calpine.DEB.2.02.1211292004430.2543@frisbee%3E&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/lucene-solr-user/201211.mbox/%3C551C5E62-0520-42A2-BF71-165FDA3608ED@gmail.com%3E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://mail-archives.apache.org/mod_mbox/lucene-solr-user/201211.mbox/%3C551C5E62-0520-42A2-BF71-165FDA3608ED@gmail.com%3E&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Mark&apos;s suggestion in that email regarding my original question (about prohibiting &quot;/&quot; in nodeNames) was that zkcontroller should replace them &quot;/&quot; with &quot;_&quot; &amp;#8211; but that would cause potential collisions between contexts like &quot;/foo/solr&quot; and &quot;/foo_solr&quot;, so i think using something like URLEncoding makes more sense (and shouldn&apos;t impact existing ZK cluster state data for most existing users)&lt;/p&gt;

&lt;p&gt;The attached patch enhances the test base classes to allow for randomized hostContext values, and then uses this URLEncoding logic in ZKController to build nodeNames &amp;#8211; and in most cases seems to work.  But thinking about &quot;_&quot; in paths got me paranoid about explicitly testing that which is how I discovered the crufty logic in OverseerCollectionProcessor.  (NOTE: you can see the obvious OverseerCollectionProcessor errors trying to talk to the wrong URL in the test logs, and they seem to explain the subsequent test failure message, but it&apos;s also possible there is a subsequent problem i haven&apos;t noticed yet)&lt;/p&gt;

&lt;p&gt;I haven&apos;t dug into this part of the code/problem very much yet, but i &lt;b&gt;think&lt;/b&gt; the right fix here is to clean this up this code so that intead of making assumptions about the node name, is uses the clusterstate to lookup the base_url from the nodeName.&lt;/p&gt;

&lt;p&gt;Logged error (repeated for multiple shards)...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[junit4:junit4]   2&amp;gt; 204647 T33 oasc.SolrException.log SEVERE Collection createcollection of awholynewcollection_1 failed
[junit4:junit4]   2&amp;gt; 204686 T31 oasc.DistributedQueue$LatchChildWatcher.process Watcher fired on path: /overseer/collection-queue-work state: SyncConnected type NodeChildrenChanged
[junit4:junit4]   2&amp;gt; 204688 T33 oasc.OverseerCollectionProcessor.createCollection Create collection awholynewcollection_2 on [127.0.0.1:57855_randctxmqvf%2F_ay, 127.0.0.1:37463_randctxmqvf%2F_ay]
[junit4:junit4]   2&amp;gt; 204691 T33 oasc.OverseerCollectionProcessor.createCollection SEVERE Error talking to shard: 127.0.0.1:37463/randctxmqvf%2F/ay org.apache.solr.common.SolrException: Server at http://127.0.0.1:37463/randctxmqvf%2F/ay returned non ok status:404, message:Not Found
[junit4:junit4]   2&amp;gt; 	at org.apache.solr.client.solrj.impl.HttpSolrServer.request(HttpSolrServer.java:372)
[junit4:junit4]   2&amp;gt; 	at org.apache.solr.client.solrj.impl.HttpSolrServer.request(HttpSolrServer.java:181)
[junit4:junit4]   2&amp;gt; 	at org.apache.solr.handler.component.HttpShardHandler$1.call(HttpShardHandler.java:166)
[junit4:junit4]   2&amp;gt; 	at org.apache.solr.handler.component.HttpShardHandler$1.call(HttpShardHandler.java:133)
[junit4:junit4]   2&amp;gt; 	at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:334)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Final test failure message...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   &amp;lt;testcase classname=&quot;org.apache.solr.cloud.BasicDistributedZkTest&quot; name=&quot;testDistribSearch&quot; time=&quot;268.833&quot;&amp;gt;
      &amp;lt;failure message=&quot;Could not find new 2 slice collection called awholynewcollection_0&quot; type=&quot;java.lang.AssertionError&quot;&amp;gt;java.lang.AssertionError: Could not find new 2 slice collection called awholynewcollection_0
        at __randomizedtesting.SeedInfo.seed([1BD856523B97C07C:9A3ED84A4CC8A040]:0)
        at org.junit.Assert.fail(Assert.java:93)
        at org.apache.solr.cloud.BasicDistributedZkTest.checkForCollection(BasicDistributedZkTest.java:1053)
        at org.apache.solr.cloud.BasicDistributedZkTest.testCollectionsAPI(BasicDistributedZkTest.java:768)
        at org.apache.solr.cloud.BasicDistributedZkTest.doTest(BasicDistributedZkTest.java:361)
        at org.apache.solr.BaseDistributedSearchTestCase.testDistribSearch(BaseDistributedSearchTestCase.java:712)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="13510698" author="hossman" created="Wed, 5 Dec 2012 19:19:24 +0000"  >
&lt;p&gt;Been poking around the SolrCloud/zk code ... fun times.&lt;/p&gt;

&lt;p&gt;From what i can tell, we don&apos;t record anywhere in zookeeper the mapping of &quot;nodeName&quot; -&amp;gt; &quot;baseURL&quot; for the various solr nodes in a solr cloud cluster.  We &lt;em&gt;do&lt;/em&gt; seem evidently record the baseUrl associated with a nodeName in the info about each &lt;em&gt;replica&lt;/em&gt; &amp;#8211; but that information is per collection &amp;amp; shard, so as is it doesn&apos;t really help in the general case of the bad code in OverseerCollectionProcessor.&lt;/p&gt;

&lt;p&gt;Three options occur to me...&lt;/p&gt;

&lt;p&gt;1) We could consider adding these mappins to ZK as 1st order info. possibly by adding some data to the ephemeral &quot;liveNodes&quot; path for each node, so code like OverseerCollectionProcessor could just ask for the data of each liveNode to know it&apos;s baseUrl ... but i&apos;m not sure how far down that rabithole we want to go (i don&apos;t really know the performance characteristics of ZK enough to know if it&apos;s a good idea to have code doing lots of those kinds of lookups ad-hoc)&lt;/p&gt;

&lt;p&gt;2) we could cheat: we could add something like this to ClusterState...&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; baseUrls;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; getBaseUrl(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; nodeName);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;...and populate the baseUrls Map in the constructor based on the properties found when looping over every collections-&amp;gt;slice-&amp;gt;replica.  The only question is what to do if/when two diff collections/slice/replica in the clusterstate disagree about the baseUrl?  (assertion failed?)&lt;/p&gt;

&lt;p&gt;3) We could improve the kludge to be a bit less kludgy: OverseerCollectionProcessor (and possibly other places) currently assume that a baseUrl can be computed from a nodeName by replacing all &quot;&amp;#95;&quot; with &quot;/&quot; &amp;#8211; if we change that substitution to only apply to the &lt;em&gt;first&lt;/em&gt; &quot;&amp;#95;&quot; in the nodeName, and combine it with some URL decoding on the &quot;hostContext&quot; portion of the nodeName (to match my suggested improvement in theprevious patch) i think we would have a fairly safe way of bi-directinally converting nodeName&amp;lt;-&amp;gt;URL regardless of what&apos;s in the hostContext - because hostnames and ports can&apos;t ever have &quot;&amp;#95;&quot; in them.  (this wouldn&apos;t address the &quot;http://&quot; kludge, but that assumption seems to be more pervasive - we can fight that battle another day)&lt;/p&gt;

&lt;p&gt;&amp;#8211;&lt;/p&gt;

&lt;p&gt;Option #3 seems the invasive for now, so unless mark/yonik/sami/somebody chimes in with more encouragment to go down one of the other routes, i&apos;ll take a stab at #3 and see what other problems i encounter.&lt;/p&gt;
</comment>
                            <comment id="13510710" author="markrmiller@gmail.com" created="Wed, 5 Dec 2012 19:31:15 +0000"  >&lt;p&gt;Yeah, I&apos;ve looked at this in the past because we have problems with _ in the url&apos;s the way things are now (there are comments to that affect). Never got to adding the right info to ZK yet though. I don&apos;t remember thinking of a silver bullet that seemed like the clear way to go.&lt;/p&gt;

&lt;p&gt;Take a stab, I&apos;ll try and catch up soon.&lt;/p&gt;</comment>
                            <comment id="13511132" author="hossman" created="Thu, 6 Dec 2012 05:40:42 +0000"  >&lt;p&gt;New patch...&lt;/p&gt;

&lt;p&gt;1) implements the &quot;less kludgy-kludge&quot; idea i mentioned above.  I put the new public method for getting the baseURL of a nodeName in SolrZkClient in case we want to change it to be a live lookup from ZK at some point (and marked it @lucene.experimental in case we want completely move/remove it at some point)&lt;/p&gt;

&lt;p&gt;2) improved ZkController to allow both leading and trailing &quot;/&quot; in the hostContext &amp;#8211; both of which get striped off &lt;em&gt;after&lt;/em&gt; the &quot;empty string defaults to &apos;solr&apos;&quot; logic, and &lt;em&gt;before&lt;/em&gt; the generation of the nodeName.  As as result, specifying &lt;tt&gt;hostContext=&quot;/&quot;&lt;/tt&gt; in solr.xml is now a viable way to tell solr it&apos;s running in the root context.  (In general i think this makes things easier to use, but &lt;/p&gt;

&lt;p&gt;3) enhanced the hostContext randomization logic in BaseDistributedSearchTestCase so that it randomly uses: the root context (eg: &quot;/&quot;), one level paths (eg: &quot;/as&quot;), two level paths (eg: &quot;/s/bf&quot;), and, sometimes including an &quot;&lt;em&gt;&quot; character in a path (eg: &quot;/as&lt;/em&gt;&quot;, &quot;/s_d&quot;, &quot;/_d/bf&quot;, etc..)&lt;/p&gt;

&lt;p&gt;4) Changed BaseDistributedSearchTestCase to us the context path randomization logic by default.  This is something i had left out of my previous patch because i wa worried about users who might have their own tests extending BaseDistributedSearchTestCase that were then making assumptions about the context being &quot;/solr&quot; &amp;#8211; but i decided having more test coverage using these random context paths was more important &amp;#8211; we can include an upgrade note along the lines of...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;BaseDistributedSearchTestCase now randomizes the servlet context it uses when 
creating Jetty instances.  Subclasses that assume a hard coded context of 
&quot;/solr&quot; should either be fixed to use the &quot;String context&quot; variable, or should 
take advantage of the new BaseDistributedSearchTestCase(String) constructor
to explicitly specify a fixed servlet context path.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;5) Fixed test bugs exposed by 3 &amp;amp; 4 above.&lt;/p&gt;

&lt;p&gt;&amp;#8211;&lt;/p&gt;

&lt;p&gt;Mark: would really appreciate it if you could take this bad-boy for a spin and let me know what you think&lt;/p&gt;</comment>
                            <comment id="13528166" author="hossman" created="Mon, 10 Dec 2012 18:48:33 +0000"  >&lt;p&gt;patch updated to trunk&lt;/p&gt;</comment>
                            <comment id="13528224" author="markrmiller@gmail.com" created="Mon, 10 Dec 2012 19:58:29 +0000"  >&lt;p&gt;I&apos;m going to take a closer look at this today.&lt;/p&gt;</comment>
                            <comment id="13528266" author="hossman" created="Mon, 10 Dec 2012 20:43:03 +0000"  >&lt;p&gt;patch updated to trunk (again)&lt;/p&gt;</comment>
                            <comment id="13528576" author="markrmiller@gmail.com" created="Tue, 11 Dec 2012 01:30:57 +0000"  >&lt;p&gt;This looks great! +1&lt;/p&gt;</comment>
                            <comment id="13529246" author="hossman" created="Tue, 11 Dec 2012 19:30:59 +0000"  >&lt;p&gt;Hmmm... running the lsat patch, CloudSolrServerTest just tickled a bug when &quot;/&quot; got selected as the hostContext...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;      &amp;lt;failure message=&quot;fail check for leader:http://127.0.0.1:54905//collection1 in [http://127.0.0.1:54905/collection1/, http://127.0.0.1:35690/collection1/]&quot; type=&quot;java.lang.AssertionError&quot;&amp;gt;java.lang.AssertionError: fail check for leader:http://127.0.0.1:54905//collection1 in [http://127.0.0.1:54905/collection1/, http://127.0.0.1:35690/collection1/]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;...i just sanity checked, and the precendent is that baseUrl never ends in a trailing slash (something i had already noticed, but somehow overlooked after my change).  It seemed like an easy fix but in running the full tests again I&apos;ve already seen several failures go by that i need to figure out.&lt;/p&gt;</comment>
                            <comment id="13529262" author="hossman" created="Tue, 11 Dec 2012 19:45:55 +0000"  >&lt;p&gt;ok, so it turns out the failure i was seeing scroll by all came from OverseerCollectionProcessorTest which is a new test added in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4114&quot; title=&quot;Collection API: Allow multiple shards from one collection on the same Solr server&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4114&quot;&gt;&lt;del&gt;SOLR-4114&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The assertion failure(s) are fairly obtuse...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;      &amp;lt;failure message=&quot;
  Expectation failure on verify:
    submit(capture(Nothing captured yet), capture(Nothing captured yet), capture(Nothing captured yet)): expected: 1, actual: 0
    takeCompletedOrError(): expected: 7, actual: 0
    submit(capture(Nothing captured yet), capture(Nothing captured yet), capture(Nothing captured yet)): expected: 1, actual: 0
    submit(capture(Nothing captured yet), capture(Nothing captured yet), capture(Nothing captured yet)): expected: 1, actual: 0
    submit(capture(Nothing captured yet), capture(Nothing captured yet), capture(Nothing captured yet)): expected: 1, actual: 0
    submit(capture(Nothing captured yet), capture(Nothing captured yet), capture(Nothing captured yet)): expected: 1, actual: 0
    submit(capture(Nothing captured yet), capture(Nothing captured yet), capture(Nothing captured yet)): expected: 1, actual: 0&quot; type=&quot;java.lang.AssertionError&quot;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;...but the root issue seems to be hidden in a log message i found: the easymock stuff is evidently freaking out because a new method is being called that it doesn&apos;t expect...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[junit4:junit4]   2&amp;gt; 689 T1552 oasc.SolrException.log SEVERE Collection createcollection of mycollection failed:java.lang.AssertionError: 
[junit4:junit4]   2&amp;gt; 	  Unexpected method call getZkClient():
[junit4:junit4]   2&amp;gt; 		at org.easymock.internal.MockInvocationHandler.invoke(MockInvocationHandler.java:45)
[junit4:junit4]   2&amp;gt; 		at org.easymock.internal.ObjectMethodsFilter.invoke(ObjectMethodsFilter.java:73)
[junit4:junit4]   2&amp;gt; 		at org.easymock.internal.ClassProxyFactory$MockMethodInterceptor.intercept(ClassProxyFactory.java:92)
[junit4:junit4]   2&amp;gt; 		at org.apache.solr.common.cloud.ZkStateReader$$EnhancerByCGLIB$$a53a0cdb.getZkClient(&amp;lt;generated&amp;gt;)
[junit4:junit4]   2&amp;gt; 		at org.apache.solr.cloud.OverseerCollectionProcessor.createCollection(OverseerCollectionProcessor.java:263)
[junit4:junit4]   2&amp;gt; 		at org.apache.solr.cloud.OverseerCollectionProcessor.processMessage(OverseerCollectionProcessor.java:155)
[junit4:junit4]   2&amp;gt; 		at org.apache.solr.cloud.OverseerCollectionProcessor.run(OverseerCollectionProcessor.java:102)
[junit4:junit4]   2&amp;gt; 		at java.lang.Thread.run(Thread.java:679)
[junit4:junit4]   2&amp;gt; 	
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The new test also has some hardcoded assumptions about hte context being &quot;solr&quot; and being able to rebuild the URL by replacing &quot;_&quot; with &quot;/&quot; &amp;#8211; but since it doesn&apos;t subclass the distrib base test, i think those will actualy be ok.  i just need help udnerstanding how to tell the easy mock stuff to expect this method call.&lt;/p&gt;

&lt;p&gt;&amp;#8212;&lt;/p&gt;

&lt;p&gt;The updated attachment:&lt;/p&gt;

&lt;p&gt;1) brings things up to date with trunk&lt;br/&gt;
2) incorporated my jetty context change suggestion from &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4057&quot; title=&quot;SolrCloud will not run on the root context.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4057&quot;&gt;&lt;del&gt;SOLR-4057&lt;/del&gt;&lt;/a&gt; so it&apos;s really trivial now to run the example on any context you want&lt;br/&gt;
3) fixes a small glitch in the generated the &quot;baseUrl&quot; for a node when context is &quot;/&quot; ... the trailing &quot;/&quot; was being left on the URL, which is inconsistent with past behavior, so i cleaned that up (this was triggering a failure in CloudSolrServerTest because it was finding that &quot;http://foo:8983//collection1&quot; wasn&apos;t equal to &quot;http://foo:8983/collection1&quot; when checking the leader URL)&lt;/p&gt;

&lt;p&gt;...but it still suffers from the easy mock failure.&lt;/p&gt;

</comment>
                            <comment id="13529289" author="markrmiller@gmail.com" created="Tue, 11 Dec 2012 20:08:21 +0000"  >&lt;p&gt;You need something along these lines:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Index: solr/core/src/test/org/apache/solr/cloud/OverseerCollectionProcessorTest.java
===================================================================
--- solr/core/src/test/org/apache/solr/cloud/OverseerCollectionProcessorTest.java	(revision 1420361)
+++ solr/core/src/test/org/apache/solr/cloud/OverseerCollectionProcessorTest.java	(working copy)
@@ -35,6 +35,7 @@
 
 import org.apache.solr.SolrTestCaseJ4;
 import org.apache.solr.common.cloud.ClusterState;
+import org.apache.solr.common.cloud.SolrZkClient;
 import org.apache.solr.common.cloud.ZkNodeProps;
 import org.apache.solr.common.cloud.ZkStateReader;
 import org.apache.solr.common.params.CoreAdminParams;
@@ -61,6 +62,7 @@
   private ShardHandler shardHandlerMock;
   private ZkStateReader zkStateReaderMock;
   private ClusterState clusterStateMock;
+  private SolrZkClient solrZkClientMock;
   
   private Thread thread;
   private Queue&amp;lt;byte[]&amp;gt; queue = new BlockingArrayQueue&amp;lt;byte[]&amp;gt;();
@@ -88,6 +90,7 @@
     shardHandlerMock = createMock(ShardHandler.class);
     zkStateReaderMock = createMock(ZkStateReader.class);
     clusterStateMock = createMock(ClusterState.class);
+    solrZkClientMock = createMock(SolrZkClient.class);
     underTest = new OverseerCollectionProcessorToBeTested(zkStateReaderMock,
         &quot;1234&quot;, shardHandlerMock, ADMIN_PATH, workQueueMock);
   }
@@ -129,6 +132,15 @@
       }
     }).anyTimes();
     
+    zkStateReaderMock.getZkClient();
+    expectLastCall().andAnswer(new IAnswer&amp;lt;Object&amp;gt;() {
+      @Override
+      public Object answer() throws Throwable {
+        return solrZkClientMock;
+      }
+    }).anyTimes();
+    
+    
     clusterStateMock.getCollections();
     expectLastCall().andAnswer(new IAnswer&amp;lt;Object&amp;gt;() {
       @Override
@@ -138,7 +150,19 @@
     }).anyTimes();
     final Set&amp;lt;String&amp;gt; liveNodes = new HashSet&amp;lt;String&amp;gt;();
     for (int i = 0; i &amp;lt; liveNodesCount; i++) {
-      liveNodes.add(&quot;localhost:&quot; + (8963 + i) + &quot;_solr&quot;);
+      final String address = &quot;localhost:&quot; + (8963 + i) + &quot;_solr&quot;;
+      liveNodes.add(address);
+      
+      solrZkClientMock.getBaseUrlForNodeName(address);
+      expectLastCall().andAnswer(new IAnswer&amp;lt;Object&amp;gt;() {
+        @Override
+        public Object answer() throws Throwable {
+          // This works as long as this test does not use a 
+          // webapp context with an underscore in it
+          return address.replaceAll(&quot;_&quot;, &quot;/&quot;);
+        }
+      }).anyTimes();
+      
     }
     clusterStateMock.getLiveNodes();
     expectLastCall().andAnswer(new IAnswer&amp;lt;Object&amp;gt;() {
@@ -336,6 +360,7 @@
     }
     
     replay(workQueueMock);
+    replay(solrZkClientMock);
     replay(zkStateReaderMock);
     replay(clusterStateMock);
     replay(shardHandlerMock);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13529508" author="hossman" created="Wed, 12 Dec 2012 00:26:47 +0000"  >&lt;p&gt;Mark: that&apos;s all greek to me, bu it seems to work, and saved me the trouble of learning greek!&lt;/p&gt;

&lt;p&gt;Committed revision 1420497. - trunk&lt;/p&gt;

&lt;p&gt;backporting and testing on 4x now.&lt;/p&gt;</comment>
                            <comment id="13529795" author="steff1193" created="Wed, 12 Dec 2012 10:13:59 +0000"  >&lt;p&gt;Can confirm that Marks patch for OverseerCollectionProcessorTest seems to be good. In a mocked test you mock components used by the &quot;class under test&quot; (OverseerCollectionProcessor in this case) and basically tells those mocks how to behave when used by the &quot;class under test&quot;. This way you test only the logic in the &quot;class under test&quot; and at the same time you get to verify that it communicates (calles stuff on) the components in interacts with (the mocked ones) in exactly the way you expect. I guess you have changed createCollection so that it also calls zkStateReaderMock.getZkClient().getBaseUrlForNodeName() which it didnt before, so that call wasnt &quot;expected&quot; by the test and you didnt tell the mocked component (ZkStateReader) how to &quot;simulate&quot; correct behaviour. Mark added this and the test should be fine again. &lt;/p&gt;

&lt;p&gt;Basically since you changed createCollection in a way so that it did not anylonger behave exactly as verified by the OverseerCollectionProcessorTest you needed to tweak the test also. This is a nice thing!&lt;/p&gt;</comment>
                            <comment id="13530239" author="hossman" created="Wed, 12 Dec 2012 19:33:17 +0000"  >&lt;p&gt;FYI: staled on backporting due to other test instabilities on 4x at the moment ... i don&apos;t wnat to risk making the situation worse.&lt;/p&gt;</comment>
                            <comment id="13530247" author="markrmiller@gmail.com" created="Wed, 12 Dec 2012 19:43:51 +0000"  >&lt;p&gt;Good call. Looks like Yonik is merging back some critical work in 5x that will help with those fails.&lt;/p&gt;

&lt;p&gt;When doing the Directory first class issue, some of the changes actually &lt;del&gt;introduced&lt;/del&gt;/exposed a bunch of fails that i fixed on 5x.&lt;/p&gt;

&lt;p&gt;Somehow, some similar issues seem to have been recently exposed on 4x - but the fixes (both test and core code) are not there yet.&lt;/p&gt;

&lt;p&gt;I&apos;m holding off on back porting to 4x until this merge up is complete.&lt;/p&gt;</comment>
                            <comment id="13530468" author="commit-tag-bot" created="Wed, 12 Dec 2012 23:06:25 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;trunk commit&amp;#93;&lt;/span&gt; Chris M. Hostetter&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1421034&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1421034&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4136&quot; title=&quot;SolrCloud bugs when servlet context contains &amp;quot;/&amp;quot; or &amp;quot;_&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4136&quot;&gt;&lt;del&gt;SOLR-4136&lt;/del&gt;&lt;/a&gt;: fix hostContext randomization to never include double slashes&lt;/p&gt;</comment>
                            <comment id="13530480" author="hossman" created="Wed, 12 Dec 2012 23:23:06 +0000"  >&lt;p&gt;Yonik merged the 1420497 changes to the 4x branch in r1420992...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1420992&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1420992&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;There is a glitch however in the hostContext randomization code that resulted in contexts with multiple consecutive slashes (eg: &quot;//s&quot;) which caused tests to complain about 404s when trying to talk to the jetty instances...&lt;/p&gt;

&lt;p&gt;Committed revision 1421034. - trunk&lt;br/&gt;
Committed revision 1421036. - 4x.&lt;/p&gt;
</comment>
                            <comment id="13530484" author="commit-tag-bot" created="Wed, 12 Dec 2012 23:28:25 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;branch_4x commit&amp;#93;&lt;/span&gt; Chris M. Hostetter&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1421036&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1421036&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4136&quot; title=&quot;SolrCloud bugs when servlet context contains &amp;quot;/&amp;quot; or &amp;quot;_&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4136&quot;&gt;&lt;del&gt;SOLR-4136&lt;/del&gt;&lt;/a&gt;: fix hostContext randomization to never include double slashes (merge r1421034)&lt;/p&gt;</comment>
                            <comment id="13531958" author="markrmiller@gmail.com" created="Fri, 14 Dec 2012 03:41:56 +0000"  >&lt;p&gt;I just got this one that seems suspicious - can you take a look hossman?&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Error Message

Server at http://127.0.0.1:44836//unloadcollection2 returned non ok status:404, message:Not Found
Stacktrace

org.apache.solr.common.SolrException: Server at http://127.0.0.1:44836//unloadcollection2 returned non ok status:404, message:Not Found
	at __randomizedtesting.SeedInfo.seed([EB9D48266225215F:6A7BC63E157A4163]:0)
	at org.apache.solr.client.solrj.impl.HttpSolrServer.request(HttpSolrServer.java:372)
	at org.apache.solr.client.solrj.impl.HttpSolrServer.request(HttpSolrServer.java:181)
	at org.apache.solr.client.solrj.request.AbstractUpdateRequest.process(AbstractUpdateRequest.java:117)
	at org.apache.solr.client.solrj.SolrServer.add(SolrServer.java:116)
	at org.apache.solr.client.solrj.SolrServer.add(SolrServer.java:102)
	at org.apache.solr.cloud.BasicDistributedZkTest.testCoreUnloadAndLeaders(BasicDistributedZkTest.java:548)
	at org.apache.solr.cloud.BasicDistributedZkTest.doTest(BasicDistributedZkTest.java:352)
	at org.apache.solr.BaseDistributedSearchTestCase.testDistribSearch(BaseDistributedSearchTestCase.java:793)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13531959" author="markrmiller@gmail.com" created="Fri, 14 Dec 2012 03:43:16 +0000"  >&lt;p&gt;Eg, it looks like perhaps an empty context? And some tests are not prepared to work with that if it is indeed running on the root? I dunno...first guess...pretty rare...&lt;/p&gt;</comment>
                            <comment id="13532564" author="hossman" created="Fri, 14 Dec 2012 19:22:43 +0000"  >&lt;p&gt;Hmmm, mark: i tried testing on both trunk@1422017 and 4x@1422022...&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;that seed did in fact produce the root context &quot;/&quot; for me&lt;/li&gt;
	&lt;li&gt;that tests passed with that seed and the root context&lt;/li&gt;
	&lt;li&gt;no where in the test log did get any mention of &quot;//unloadcollection2&quot; (which i would suspect if there was a bug building up a client url using the baseUrlWithTrailingSlash + &quot;/corename&quot; ... but there should never be a baseUrlWithTrailingSlash)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I then modified my local working copy of trunk like so, in order to force every test to run with the root context, and even then i could not reproduce...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Index: solr/test-framework/src/java/org/apache/solr/BaseDistributedSearchTestCase.java
===================================================================
--- solr/test-framework/src/java/org/apache/solr/BaseDistributedSearchTestCase.java	(revision 1422017)
+++ solr/test-framework/src/java/org/apache/solr/BaseDistributedSearchTestCase.java	(working copy)
@@ -110,7 +110,9 @@
       }
     }
     // paranoia, we *really* don&apos;t want to ever get &quot;//&quot; in a path...
-    final String hc = hostContext.toString().replaceAll(&quot;\\/+&quot;,&quot;/&quot;);
+    // final String hc = hostContext.toString().replaceAll(&quot;\\/+&quot;,&quot;/&quot;);
+    // :nocommit: ... test the shit out of the root context
+    final String hc = &quot;/&quot;;
 
     log.info(&quot;Setting hostContext system property: &quot; + hc);
     System.setProperty(&quot;hostContext&quot;, hc);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;...this smells to me like it must have run against the code prior to my r1421034 commit (to get that &quot;//&quot; URL)&lt;/p&gt;</comment>
                            <comment id="13532567" author="hossman" created="Fri, 14 Dec 2012 19:25:26 +0000"  >&lt;blockquote&gt;&lt;p&gt;...this smells to me like it must have run against the code prior to my r1421034 commit (to get that &quot;//&quot; URL)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hmmm, except if that were the case, this line number would be different...&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;...testDistribSearch(BaseDistributedSearchTestCase.java:793)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I really have no idea what caused that failure you got.&lt;/p&gt;</comment>
                            <comment id="13532576" author="markrmiller@gmail.com" created="Fri, 14 Dec 2012 19:32:42 +0000"  >&lt;p&gt;Thanks for looking - I&apos;ll keep an eye for a repeat - I have the logs somewhere too. I&apos;ll take it to another issue.&lt;/p&gt;</comment>
                            <comment id="13537484" author="commit-tag-bot" created="Thu, 20 Dec 2012 23:30:00 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;trunk commit&amp;#93;&lt;/span&gt; Chris M. Hostetter&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1424755&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1424755&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4136&quot; title=&quot;SolrCloud bugs when servlet context contains &amp;quot;/&amp;quot; or &amp;quot;_&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4136&quot;&gt;&lt;del&gt;SOLR-4136&lt;/del&gt;&lt;/a&gt;: followup: fix getBaseUrlForNodeName to never including trailing slash when using the root context, and harden generateNodeName to not trust the caller as far as leading/trailing slashes&lt;/p&gt;</comment>
                            <comment id="13537517" author="commit-tag-bot" created="Thu, 20 Dec 2012 23:51:15 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;branch_4x commit&amp;#93;&lt;/span&gt; Chris M. Hostetter&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1424762&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1424762&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4136&quot; title=&quot;SolrCloud bugs when servlet context contains &amp;quot;/&amp;quot; or &amp;quot;_&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4136&quot;&gt;&lt;del&gt;SOLR-4136&lt;/del&gt;&lt;/a&gt;: followup: fix getBaseUrlForNodeName to never including trailing slash when using the root context, and harden generateNodeName to not trust the caller as far as leading/trailing slashes (merge r1424755)&lt;/p&gt;</comment>
                            <comment id="13537525" author="commit-tag-bot" created="Fri, 21 Dec 2012 00:02:14 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;branch_4x commit&amp;#93;&lt;/span&gt; Chris M. Hostetter&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1424768&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1424768&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4136&quot; title=&quot;SolrCloud bugs when servlet context contains &amp;quot;/&amp;quot; or &amp;quot;_&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4136&quot;&gt;&lt;del&gt;SOLR-4136&lt;/del&gt;&lt;/a&gt;: revert unclean r1424762&lt;/p&gt;</comment>
                            <comment id="13537543" author="commit-tag-bot" created="Fri, 21 Dec 2012 00:22:41 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;branch_4x commit&amp;#93;&lt;/span&gt; Chris M. Hostetter&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1424771&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1424771&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4136&quot; title=&quot;SolrCloud bugs when servlet context contains &amp;quot;/&amp;quot; or &amp;quot;_&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4136&quot;&gt;&lt;del&gt;SOLR-4136&lt;/del&gt;&lt;/a&gt;: followup: fix getBaseUrlForNodeName to never including trailing slash when using the root context, and harden generateNodeName to not trust the caller as far as leading/trailing slashes (merge r1424755 - redo)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310060">
                    <name>Container</name>
                                            <outwardlinks description="contains">
                                        <issuelink>
            <issuekey id="12615548">SOLR-4057</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12615548">SOLR-4057</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12560431" name="SOLR-4136.patch" size="19508" author="hossman" created="Tue, 11 Dec 2012 19:45:55 +0000"/>
                            <attachment id="12560266" name="SOLR-4136.patch" size="18605" author="hossman" created="Mon, 10 Dec 2012 20:43:03 +0000"/>
                            <attachment id="12560238" name="SOLR-4136.patch" size="18529" author="hossman" created="Mon, 10 Dec 2012 18:48:33 +0000"/>
                            <attachment id="12556214" name="SOLR-4136.patch" size="18464" author="hossman" created="Thu, 6 Dec 2012 05:40:42 +0000"/>
                            <attachment id="12555693" name="SOLR-4136.patch" size="6721" author="hossman" created="Sun, 2 Dec 2012 23:04:50 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>293334</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 48 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0swsn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>166790</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>