<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:18:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-9847] Deadlock on ManagedIndexSchema lock.</title>
                <link>https://issues.apache.org/jira/browse/SOLR-9847</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Seems we hold the lock while in ManagedIndexSchema.waitForSchemaZkVersionAgreement, so we may never see agreement because are updates may also be waiting on that lock.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13027322">SOLR-9847</key>
            <summary>Deadlock on ManagedIndexSchema lock.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sarowe">Steven Rowe</assignee>
                                    <reporter username="markrmiller@gmail.com">Mark Miller</reporter>
                        <labels>
                    </labels>
                <created>Mon, 12 Dec 2016 02:37:06 +0000</created>
                <updated>Sat, 8 Jun 2019 15:33:02 +0000</updated>
                            <resolved>Tue, 20 Dec 2016 17:08:15 +0000</resolved>
                                                    <fixVersion>6.4</fixVersion>
                    <fixVersion>7.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15740799" author="markrmiller@gmail.com" created="Mon, 12 Dec 2016 02:51:06 +0000"  >&lt;p&gt;Not a complete deadlock I guess, but takes a long time to sort out:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   [junit4] HEARTBEAT J9 PID(4929@totalmetal): 2016-12-11T21:27:14, stalled for  190s at: TestBulkSchemaConcurrent.test
   [junit4] HEARTBEAT J9 PID(4929@totalmetal): 2016-12-11T21:28:14, stalled for  250s at: TestBulkSchemaConcurrent.test
   [junit4] HEARTBEAT J9 PID(4929@totalmetal): 2016-12-11T21:29:14, stalled for  310s at: TestBulkSchemaConcurrent.test
   [junit4] HEARTBEAT J9 PID(4929@totalmetal): 2016-12-11T21:30:14, stalled for  370s at: TestBulkSchemaConcurrent.test
   [junit4] HEARTBEAT J9 PID(4929@totalmetal): 2016-12-11T21:31:14, stalled for  430s at: TestBulkSchemaConcurrent.test
   [junit4] HEARTBEAT J9 PID(4929@totalmetal): 2016-12-11T21:32:14, stalled for  490s at: TestBulkSchemaConcurrent.test
   [junit4] HEARTBEAT J9 PID(4929@totalmetal): 2016-12-11T21:33:14, stalled for  550s at: TestBulkSchemaConcurrent.test
   [junit4] HEARTBEAT J9 PID(4929@totalmetal): 2016-12-11T21:34:14, stalled for  610s at: TestBulkSchemaConcurrent.test
   [junit4] Suite: org.apache.solr.schema.TestBulkSchemaConcurrent
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15740801" author="markrmiller@gmail.com" created="Mon, 12 Dec 2016 02:51:42 +0000"  >&lt;p&gt;I suppose that eventually happens because of:&lt;/p&gt;

&lt;p&gt;// eventually, this loop will get killed by the ExecutorService&apos;s timeout&lt;/p&gt;</comment>
                            <comment id="15740809" author="markrmiller@gmail.com" created="Mon, 12 Dec 2016 02:57:41 +0000"  >&lt;p&gt;I don&apos;t know this code so well, but here is one idea.&lt;/p&gt;</comment>
                            <comment id="15740813" author="markrmiller@gmail.com" created="Mon, 12 Dec 2016 02:59:40 +0000"  >&lt;p&gt;The stacks:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;qtp1112580055-3894 [WAITING]
sun.misc.Unsafe.park(boolean, long) Unsafe.java (native)
java.util.concurrent.locks.LockSupport.parkNanos(Object, long) LockSupport.java:215
java.util.concurrent.FutureTask.awaitDone(boolean, long) FutureTask.java:426
java.util.concurrent.FutureTask.get(long, TimeUnit) FutureTask.java:204
java.util.concurrent.AbstractExecutorService.invokeAll(Collection, long, TimeUnit) AbstractExecutorService.java:289
org.apache.solr.schema.ManagedIndexSchema.waitForSchemaZkVersionAgreement(String, String, int, ZkController, int) ManagedIndexSchema.java:238
org.apache.solr.schema.SchemaManager.waitForOtherReplicasToUpdate(TimeOut, int) SchemaManager.java:167
org.apache.solr.schema.SchemaManager.doOperations(List) SchemaManager.java:137
org.apache.solr.schema.SchemaManager.performOperations(Reader) SchemaManager.java:92
org.apache.solr.handler.SchemaHandler.handleRequestBody(SolrQueryRequest, SolrQueryResponse) SchemaHandler.java:91
org.apache.solr.handler.RequestHandlerBase.handleRequest(SolrQueryRequest, SolrQueryResponse) RequestHandlerBase.java:152
org.apache.solr.core.SolrCore.execute(SolrRequestHandler, SolrQueryRequest, SolrQueryResponse) SolrCore.java:2227
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;zkCallback-535-thread-2-processing-n:127.0.0.1:34881_c_c [BLOCKED]
org.apache.solr.schema.ZkIndexSchemaReader.updateSchema(Watcher, int) ZkIndexSchemaReader.java:131
org.apache.solr.schema.ZkIndexSchemaReader.access$200(ZkIndexSchemaReader, Watcher, int) ZkIndexSchemaReader.java:39
org.apache.solr.schema.ZkIndexSchemaReader$2.process(WatchedEvent) ZkIndexSchemaReader.java:97
org.apache.solr.common.cloud.SolrZkClient$3.lambda$process$0(Watcher, WatchedEvent) SolrZkClient.java:268
org.apache.solr.common.cloud.SolrZkClient$3$$Lambda$62.run()
java.util.concurrent.Executors$RunnableAdapter.call() Executors.java:511
java.util.concurrent.FutureTask.run() FutureTask.java:266
org.apache.solr.common.util.ExecutorUtil$MDCAwareThreadPoolExecutor.lambda$execute$0(ArrayList, List, Map, String, Runnable, Exception) ExecutorUtil.java:229
org.apache.solr.common.util.ExecutorUtil$MDCAwareThreadPoolExecutor$$Lambda$40.run()
java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor$Worker) ThreadPoolExecutor.java:1142
java.util.concurrent.ThreadPoolExecutor$Worker.run() ThreadPoolExecutor.java:617
java.lang.Thread.run() Thread.java:745
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;zkCallback-522-thread-2-processing-n:127.0.0.1:39199_c_c [BLOCKED]
org.apache.solr.schema.ZkIndexSchemaReader.updateSchema(Watcher, int) ZkIndexSchemaReader.java:131
org.apache.solr.schema.ZkIndexSchemaReader.access$200(ZkIndexSchemaReader, Watcher, int) ZkIndexSchemaReader.java:39
org.apache.solr.schema.ZkIndexSchemaReader$2.process(WatchedEvent) ZkIndexSchemaReader.java:97
org.apache.solr.common.cloud.SolrZkClient$3.lambda$process$0(Watcher, WatchedEvent) SolrZkClient.java:268
org.apache.solr.common.cloud.SolrZkClient$3$$Lambda$62.run()
java.util.concurrent.Executors$RunnableAdapter.call() Executors.java:511
java.util.concurrent.FutureTask.run() FutureTask.java:266
org.apache.solr.common.util.ExecutorUtil$MDCAwareThreadPoolExecutor.lambda$execute$0(ArrayList, List, Map, String, Runnable, Exception) ExecutorUtil.java:229
org.apache.solr.common.util.ExecutorUtil$MDCAwareThreadPoolExecutor$$Lambda$40.run()
java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor$Worker) ThreadPoolExecutor.java:1142
java.util.concurrent.ThreadPoolExecutor$Worker.run() ThreadPoolExecutor.java:617
java.lang.Thread.run() Thread.java:745
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15746977" author="markrmiller@gmail.com" created="Wed, 14 Dec 2016 02:20:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=steve_rowe&quot; class=&quot;user-hover&quot; rel=&quot;steve_rowe&quot;&gt;steve_rowe&lt;/a&gt;, any thoughts on this one? It has bit me quite a lot locally over the months.&lt;/p&gt;</comment>
                            <comment id="15749331" author="steve_rowe" created="Wed, 14 Dec 2016 20:07:46 +0000"  >&lt;p&gt;I see this failure rarely on my Jenkins - like once every couple months.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt;, have you noticed whether the &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9832&quot; title=&quot;Schema modifications are not immediately visible on the coordinating node&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9832&quot;&gt;&lt;del&gt;SOLR-9832&lt;/del&gt;&lt;/a&gt; changes impacted frequency of this failure?&lt;/p&gt;

&lt;p&gt;I&apos;ll start beasting to see whether I can get this failure locally.&lt;/p&gt;</comment>
                            <comment id="15761858" author="steve_rowe" created="Mon, 19 Dec 2016 18:05:46 +0000"  >&lt;p&gt;I beasted &lt;tt&gt;TestBulkSchemaConcurrent&lt;/tt&gt; for 500 iterations with and without the patch, and the patch doesn&apos;t seem to change anything: unpatched, 27/500 iterations had the 600 second timeout; and patched, 28/500 iterations did.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt;, did your patch improve things for you locally?&lt;/p&gt;

&lt;p&gt;A different idea: we could release the update lock after local changes are made, but before waiting for all replicas to receive the update.  I&apos;ll try this out.&lt;/p&gt;</comment>
                            <comment id="15761861" author="markrmiller@gmail.com" created="Mon, 19 Dec 2016 18:08:13 +0000"  >&lt;p&gt;Sorry, I have not yet had a lot of time on a branch with the test fix. Been meaning to get back to it. No evidence it works yet, just a thought looking at the deadlock stack traces.&lt;/p&gt;</comment>
                            <comment id="15762589" author="steve_rowe" created="Mon, 19 Dec 2016 23:13:29 +0000"  >&lt;p&gt;Patch that narrows the period during which the schema update lock is held to exclude waiting for other replicas to receive the update.  With this patch, there were no stalls when I beasted &lt;tt&gt;TestBulkSchemaConcurrent&lt;/tt&gt; for 500 iterations (versus 5% of the time unpatched and with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt;&apos;s patch on this issue).  Running all Solr tests now.&lt;/p&gt;</comment>
                            <comment id="15762671" author="steve_rowe" created="Mon, 19 Dec 2016 23:46:49 +0000"  >&lt;blockquote&gt;&lt;p&gt;Running all Solr tests now.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;All Solr tests passed for me with my alternate patch, as does precommit.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt;: does it look good to commit?&lt;/p&gt;</comment>
                            <comment id="15764557" author="markrmiller@gmail.com" created="Tue, 20 Dec 2016 16:18:09 +0000"  >&lt;blockquote&gt;&lt;p&gt;Patch that narrows the period during which the schema update lock is held&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That was my first inclination, but I don&apos;t know how all this works that well yet, so I tried to hack something sim with the wait.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;does it look good to commit?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1. I&apos;ll report if I run into anything further.&lt;/p&gt;</comment>
                            <comment id="15764692" author="jira-bot" created="Tue, 20 Dec 2016 17:07:10 +0000"  >&lt;p&gt;Commit cfbfc13209c57e1c76bd478c3b584135b5d109eb in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=steve_rowe&quot; class=&quot;user-hover&quot; rel=&quot;steve_rowe&quot;&gt;steve_rowe&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=cfbfc13&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=cfbfc13&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9847&quot; title=&quot;Deadlock on ManagedIndexSchema lock.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9847&quot;&gt;&lt;del&gt;SOLR-9847&lt;/del&gt;&lt;/a&gt;: Stop blocking further schema updates while waiting for a pending update to propagate to other replicas.  This reduces the likelihood of a (time-limited) distributed deadlock during concurrent schema updates.&lt;/p&gt;</comment>
                            <comment id="15764693" author="jira-bot" created="Tue, 20 Dec 2016 17:07:12 +0000"  >&lt;p&gt;Commit 04108d993574537d9623d5d1bf2658cafad12ef8 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=steve_rowe&quot; class=&quot;user-hover&quot; rel=&quot;steve_rowe&quot;&gt;steve_rowe&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=04108d9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=04108d9&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9847&quot; title=&quot;Deadlock on ManagedIndexSchema lock.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9847&quot;&gt;&lt;del&gt;SOLR-9847&lt;/del&gt;&lt;/a&gt;: Stop blocking further schema updates while waiting for a pending update to propagate to other replicas.  This reduces the likelihood of a (time-limited) distributed deadlock during concurrent schema updates.&lt;/p&gt;</comment>
                            <comment id="15764696" author="steve_rowe" created="Tue, 20 Dec 2016 17:08:15 +0000"  >&lt;p&gt;Thanks Mark.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12843966" name="SOLR-9847-release-lock-before-replica-version-agreement.patch" size="5888" author="sarowe" created="Mon, 19 Dec 2016 23:13:29 +0000"/>
                            <attachment id="12842747" name="SOLR-9847.patch" size="6609" author="markrmiller@gmail.com" created="Mon, 12 Dec 2016 02:57:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 48 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i37gjz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>