<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:45:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-5526] Query parser extends standard cause NPE on Solr startup</title>
                <link>https://issues.apache.org/jira/browse/SOLR-5526</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Adding any custom query parser extending standard one with non-final field &lt;tt&gt;NAME&lt;/tt&gt; lead to messy &lt;tt&gt;NullPointerException&lt;/tt&gt; during Solr startup.&lt;/p&gt;

&lt;p&gt;Definition of standard parsers is located in  &lt;tt&gt;QParserPlugin.standardPlugins&lt;/tt&gt; static array. The array contains names from static &lt;tt&gt;NAME&lt;/tt&gt; fields and classes for each plugin.                       &lt;/p&gt;

&lt;p&gt;But all of listed parsers are derived from &lt;tt&gt;QParserPlugin&lt;/tt&gt;, so we have circular dependency of static fields.&lt;/p&gt;

&lt;p&gt;Normally, class loader start initializing &lt;tt&gt;QParserPlugin&lt;/tt&gt; before all listed plugins in &lt;tt&gt;SolrCore.initQParsers&lt;/tt&gt;, and array elements referenced to &lt;tt&gt;NAME&lt;/tt&gt; plugins&apos; fields are filled properly.&lt;/p&gt;

&lt;p&gt;Custom parsers are instantiated before standard parsers. And when we subclass plugin with non-final &lt;tt&gt;NAME&lt;/tt&gt; field and add it to Solr via &lt;tt&gt;solrconfig.xml&lt;/tt&gt;, class loader start loading our class before &lt;tt&gt;QParserPlugin&lt;/tt&gt;. Because &lt;tt&gt;QParserPlugin&lt;/tt&gt; is a superclass for plugin, it must be initialized before subclasses, and static dereferencing cause null elements in &lt;tt&gt;standardPlugins&lt;/tt&gt; array because it filled before &lt;tt&gt;NAME&lt;/tt&gt; field of loading plugin&apos;s superclass.&lt;/p&gt;

&lt;p&gt;How to reproduce:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Checkout Solr (trunk or stable)&lt;/li&gt;
	&lt;li&gt;Add the following line to solr/example/solr/collection1/conf/solrconfig.xml&lt;br/&gt;
  &lt;tt&gt;&amp;lt;queryParser name=&quot;fail&quot; class=&quot;solr.search.LuceneQParserPlugin&quot;/&amp;gt;&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Call ant run-example in solr folder&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Possible workarounds:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;dev-workaround: add &lt;tt&gt;int workaround = QParserPlugin.standardPlugins.length;&lt;/tt&gt; as a first line to&lt;br/&gt;
  &lt;tt&gt;SolrCore.initQParsers&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;user-workaround: add plugin with final &lt;tt&gt;NAME&lt;/tt&gt; field (edismax) to solrconfig.xml  before subclasses of standard plugins.&lt;br/&gt;
  &lt;tt&gt;&amp;lt;queryParser name=&quot;workaround&quot; class=&quot;solr.search.ExtendedDismaxQParserPlugin&quot;/&amp;gt;&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Possible fix:&lt;br/&gt;
Move &lt;tt&gt;standardPlugins&lt;/tt&gt; to new final class to break circular dependency.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Linux, Java 1.7.0_45&lt;/p&gt;</environment>
        <key id="12682345">SOLR-5526</key>
            <summary>Query parser extends standard cause NPE on Solr startup</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="khitrin">Nikolay Khitrin</reporter>
                        <labels>
                    </labels>
                <created>Tue, 3 Dec 2013 09:53:29 +0000</created>
                <updated>Mon, 9 May 2016 18:47:48 +0000</updated>
                            <resolved>Wed, 5 Feb 2014 01:43:34 +0000</resolved>
                                    <version>4.5.1</version>
                    <version>4.6</version>
                    <version>6.0</version>
                                    <fixVersion>4.7</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>query parsers</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="13837641" author="khitrin" created="Tue, 3 Dec 2013 12:43:01 +0000"  >&lt;p&gt;I&apos;ve attached patch where all static variables from &lt;tt&gt;QParserPlugin&lt;/tt&gt; were moved to inner static final class &lt;tt&gt;QParserPlugin.Defaults&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="13837937" author="hossman" created="Tue, 3 Dec 2013 17:42:35 +0000"  >&lt;p&gt;Ouch!&lt;/p&gt;

&lt;p&gt;Nikolay: Nice diagnoses! thanks for digging into this.&lt;/p&gt;

&lt;p&gt;Maybe i&apos;m missing something, but isn&apos;t the root level bug really that the standard parsers should all be declaring the static NAME as final? ... even with your proposed change, it seems dangerous to me that those NAME variables are mutable.&lt;/p&gt;

&lt;p&gt;If we fix them all to be &quot;final&quot; then the problem goes away w/o needing the rest of your patch, correct?&lt;/p&gt;

&lt;p&gt;We should also be able to whip up a simple test using reflection to fail the build if anyone ever adds a class to QParserPlugin.standardPlugins w/o static final NAME.&lt;/p&gt;

&lt;p&gt;You mentioned discovering this problem because you have custom query parsers extending some standard one where NAME isn&apos;t final &amp;#8211; &lt;br/&gt;
Is there an aspect of this bug that you&apos;re seeing with your custom parser that wouldn&apos;t be fixed with the solution i&apos;m suggesting?&lt;/p&gt;</comment>
                            <comment id="13838764" author="khitrin" created="Wed, 4 Dec 2013 09:27:22 +0000"  >&lt;p&gt;I think making all NAMEs final will fix the issue.&lt;/p&gt;

&lt;p&gt;There is extremely artificial case with non compile time constant final NAME field... &lt;br/&gt;
(How to reproduce: &lt;br/&gt;
on edismax parser: public static final String NAME = QParserPlugin.DEFAULT_QTYPE + &quot;edismax&quot;; &lt;br/&gt;
solrconfig.xml: &amp;lt;queryParser name=&quot;fail&quot; class=&quot;solr.search.ExtendedDismaxQParserPlugin&quot;/&amp;gt; )&lt;br/&gt;
But I absolutely cannot imagine this in real life. &lt;/p&gt;

&lt;p&gt;So I propose to apply your suggestion as a hotfix and do calmly think about plugins list structure and location. &lt;br/&gt;
Will it be located in abstract supeclass field? Is it good?&lt;/p&gt;</comment>
                            <comment id="13839979" author="khitrin" created="Thu, 5 Dec 2013 09:43:53 +0000"  >&lt;p&gt;Attached patch adding final modifiers to all names for standard parsers, as mentioned in your suggestion.&lt;/p&gt;</comment>
                            <comment id="13875868" author="vzhovtiuk" created="Sun, 19 Jan 2014 14:02:25 +0000"  >&lt;p&gt;NPE stacktrace during solr load&lt;/p&gt;</comment>
                            <comment id="13877426" author="vzhovtiuk" created="Tue, 21 Jan 2014 12:33:41 +0000"  >&lt;p&gt;Missed final NAME field in org.apache.solr.search.SimpleQParserPlugin. Fixed.&lt;/p&gt;</comment>
                            <comment id="13877427" author="vzhovtiuk" created="Tue, 21 Jan 2014 12:34:23 +0000"  >&lt;p&gt;Test reproducing NPE on Solr start-up&lt;br/&gt;
Test checking final and static NAME field for all standard parsers&lt;/p&gt;</comment>
                            <comment id="13877476" author="shalinmangar" created="Tue, 21 Jan 2014 13:56:14 +0000"  >&lt;p&gt;Thanks Vitaliy. Can you please combine the two patches i.e. the test and making the NAME fields final?&lt;/p&gt;

&lt;p&gt;Just a tip for the future: Just have the same names for each iteration of the patch. Jira will automatically grey out old patches and keep the latest one highlighted. It also helps reviewers in figuring out which is the the latest patch.&lt;/p&gt;</comment>
                            <comment id="13877842" author="vzhovtiuk" created="Tue, 21 Jan 2014 20:51:45 +0000"  >&lt;p&gt;Combined:&lt;br/&gt;
Missed final NAME field fixes. &lt;br/&gt;
Test reproducing NPE on Solr start-up&lt;br/&gt;
Test checking final and static NAME field for all standard parsers&lt;/p&gt;</comment>
                            <comment id="13877902" author="hossman" created="Tue, 21 Jan 2014 21:58:40 +0000"  >&lt;p&gt;Hey Vitaliy,&lt;/p&gt;

&lt;p&gt;For the most part, these tests look great &amp;#8211; just a few minor things i think we should try to clean up...&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;QParserPlugin.standardPlugins&apos;s javadoc needs to point out the importance of these names being static &amp;amp; final so people aren&apos;t surprised by these  tests when new parsers are added in the future.&lt;/li&gt;
	&lt;li&gt;TestStandardQParsers is doing something sufficiently odd that it really needs some javadocs explaining why it exists (ie: mention the class loading problems associated if there is a standardPlugin that has a non-static, non-final name, with an &lt;tt&gt;@see&lt;/tt&gt; this issue, &lt;tt&gt;@see QParserPlugin.standardPlugins&lt;/tt&gt;, etc...)&lt;/li&gt;
	&lt;li&gt;we should probably make TestStandardQParsers assert that the static &amp;amp; final name it finds in each class matches the name associated in QParserPlugin.standardPlugins.&lt;/li&gt;
	&lt;li&gt;solrconfig-query-parser-init.xml has a cut &amp;amp; paste comment referring to an unrelated test.&lt;/li&gt;
	&lt;li&gt;TestInitQParser should have a javadoc comment explaining what the point of the test is&lt;/li&gt;
	&lt;li&gt;TestInitQParser should actaully do a query using the &quot;fail&quot; parser registered in the config, to help future-proof us against someone unwittingly changing the test config in a way that defeats the point of the test.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;...if you want to take a crack at this that would be great, if not i&apos;ll try to make some time later this week.&lt;/p&gt;</comment>
                            <comment id="13878953" author="vzhovtiuk" created="Wed, 22 Jan 2014 18:21:02 +0000"  >&lt;p&gt;minor fixes:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt; QParserPlugin.standardPlugins&apos;s javadoc needs to point out the importance of these names being static &amp;amp; final so people aren&apos;t surprised by these  tests when new parsers are added in the future.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Added relevant javadocs.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;br/&gt;
TestStandardQParsers is doing something sufficiently odd that it really needs some javadocs explaining why it exists (ie: mention the class loading problems associated if there is a standardPlugin that has a non-static, non-final name, with an &lt;tt&gt;@see&lt;/tt&gt; this issue, &lt;tt&gt;@see QParserPlugin.standardPlugins&lt;/tt&gt;, etc...)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Added javadocs&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt; we should probably make TestStandardQParsers assert that the static &amp;amp; final name it finds in each class matches the name associated in QParserPlugin.standardPlugins.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Thats actually what TestStandardQParsers does. Unit test takes classes registered in QParserPlugin.standardPlugins and ensure that each class has final and static NAME field.&lt;br/&gt;
Added relevant javadocs to TestStandardQParsers.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt; solrconfig-query-parser-init.xml has a cut &amp;amp; paste comment referring to an unrelated test.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Fixed, added relevant comments.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt; TestInitQParser should have a javadoc comment explaining what the point of the test is&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Fixed, added relevant comments.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;TestInitQParser should actaully do a query using the &quot;fail&quot; parser registered in the config, to help future-proof us against someone unwittingly changing the test config in a way that defeats the point of the test.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This test alerady does query using defType=fail, so i expect this registered QParser used and return result.&lt;/p&gt;</comment>
                            <comment id="13891443" author="hossman" created="Tue, 4 Feb 2014 23:44:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;This test alerady does query using defType=fail, so i expect this registered QParser used and return result.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yep yep ... i must have misread that, sorry.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Thats actually what TestStandardQParsers does. Unit test takes classes registered in QParserPlugin.standardPlugins and ensure that each class has final and static NAME field.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Correct, but that&apos;s not the point i was making in that bullet point &amp;#8211; what i said was as long as we were doing that, we should also make sure the NAME field &lt;em&gt;matches&lt;/em&gt; the registered name in QParserPlugin.standardPlugins.&lt;/p&gt;

&lt;p&gt;I&apos;m attaching a patch that eliminates some existing duplication in your TestStandardQParsers and adds the type of check i was refering to ... running full tests &amp;amp; precommit now, and unless something weird pops up i&apos;ll commit.&lt;/p&gt;</comment>
                            <comment id="13891529" author="hossman" created="Wed, 5 Feb 2014 00:39:12 +0000"  >&lt;p&gt;fixed a javadoc mistake caught by &quot;ant precommit&quot;&lt;/p&gt;

&lt;p&gt;Going to commit &amp;amp; backport now&lt;/p&gt;</comment>
                            <comment id="13891533" author="jira-bot" created="Wed, 5 Feb 2014 00:41:26 +0000"  >&lt;p&gt;Commit 1564588 from hossman@apache.org in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1564588&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1564588&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5526&quot; title=&quot;Query parser extends standard cause NPE on Solr startup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5526&quot;&gt;&lt;del&gt;SOLR-5526&lt;/del&gt;&lt;/a&gt;: Fixed NPE that could arrise when explicitly configuring some built in QParserPlugins&lt;/p&gt;</comment>
                            <comment id="13891588" author="jira-bot" created="Wed, 5 Feb 2014 01:43:32 +0000"  >&lt;p&gt;Commit 1564606 from hossman@apache.org in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1564606&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1564606&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5526&quot; title=&quot;Query parser extends standard cause NPE on Solr startup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5526&quot;&gt;&lt;del&gt;SOLR-5526&lt;/del&gt;&lt;/a&gt;: Fixed NPE that could arrise when explicitly configuring some built in QParserPlugins (merge r1564588)&lt;/p&gt;</comment>
                            <comment id="13891589" author="hossman" created="Wed, 5 Feb 2014 01:43:35 +0000"  >&lt;p&gt;Thanks Nikolay &amp;amp; Vitaliy!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12693373">SOLR-5697</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12623856" name="NPE_load_trace" size="3490" author="vzhovtiuk" created="Sun, 19 Jan 2014 14:02:25 +0000"/>
                            <attachment id="12624116" name="SOLR-5526-final-names.patch" size="12607" author="vzhovtiuk" created="Tue, 21 Jan 2014 12:33:41 +0000"/>
                            <attachment id="12617138" name="SOLR-5526-final-names.patch" size="12849" author="khitrin" created="Thu, 5 Dec 2013 09:43:53 +0000"/>
                            <attachment id="12624118" name="SOLR-5526-tests.patch" size="7556" author="vzhovtiuk" created="Tue, 21 Jan 2014 12:34:23 +0000"/>
                            <attachment id="12627040" name="SOLR-5526.patch" size="23859" author="hossman" created="Wed, 5 Feb 2014 00:39:12 +0000"/>
                            <attachment id="12627029" name="SOLR-5526.patch" size="23883" author="hossman" created="Tue, 4 Feb 2014 23:44:05 +0000"/>
                            <attachment id="12624383" name="SOLR-5526.patch" size="22668" author="vzhovtiuk" created="Wed, 22 Jan 2014 18:21:02 +0000"/>
                            <attachment id="12624188" name="SOLR-5526.patch" size="20163" author="vzhovtiuk" created="Tue, 21 Jan 2014 20:51:45 +0000"/>
                            <attachment id="12616764" name="SOLR-5526.patch" size="9510" author="khitrin" created="Tue, 3 Dec 2013 12:43:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>361602</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 42 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1qc07:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>361900</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>