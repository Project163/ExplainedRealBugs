<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:44:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-14546] OverseerTaskProcessor can process messages out of order</title>
                <link>https://issues.apache.org/jira/browse/SOLR-14546</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;&lt;b&gt;Summary:&lt;/b&gt;&#160;&lt;/p&gt;

&lt;p&gt;Collection API and ConfigSet API messages can be processed out of order by the &lt;tt&gt;OverseerTaskProcessor&lt;/tt&gt;/&lt;tt&gt;OverseerCollectionConfigSetProcessor&lt;/tt&gt; because of the way locking is handled.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Some context:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;The Overseer task processor dequeues messages from the Collection and ConfigSet Zookeeper queue at &lt;tt&gt;/overseer/collection-queue-work&lt;/tt&gt; and hands processing to an executor pool with 100 max parallel tasks (&lt;tt&gt;ClusterStateUpdater&lt;/tt&gt; on the other hand uses a single thread consuming and processing the &lt;tt&gt;/overseer/queue&lt;/tt&gt;&#160;and does not suffer from the problem described here).&lt;/p&gt;

&lt;p&gt;Locking prevents tasks modifying the same or related data from running concurrently. For the Collection API, locking can be done at &lt;tt&gt;CLUSTER&lt;/tt&gt;, &lt;tt&gt;COLLECTION&lt;/tt&gt;, &lt;tt&gt;SHARD&lt;/tt&gt; or &lt;tt&gt;REPLICA&lt;/tt&gt; level and each command has its locking level defined in &lt;tt&gt;CollectionParams.CollectionAction&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Multiple tasks for the same or competing locking levels do not execute concurrently. Commands locking at &lt;tt&gt;COLLECTION&lt;/tt&gt; level for the same collection (for example &lt;tt&gt;CREATE&lt;/tt&gt; creating a collection, &lt;tt&gt;CREATEALIAS&lt;/tt&gt; creating an alias for the collection and &lt;tt&gt;CREATESHARD&lt;/tt&gt; creating a new shard for the collection) will be executed sequentially, and it is expected that they are executed in submission order. Commands locking at different levels are also serialized when needed (for example changes to a shard of a collection and changes to the collection itself).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;The issue:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;The way &lt;tt&gt;OverseerTaskProcessor.run()&lt;/tt&gt; deals with messages that cannot be executed due to competing messages already running (i.e. lock unavailable) is not correct. The method basically iterates over the set of messages to execute, skips those that can&#8217;t be executed due to locking and executes those that can be (assuming enough remaining available executors).&lt;/p&gt;

&lt;p&gt;The issue of out of order execution occurs when at least 3 messages compete for a lock. The following scenario shows out of order execution (messages numbered in enqueue order):&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Message 1 gets the lock and runs,&lt;/li&gt;
	&lt;li&gt;Message 2 can&#8217;t be executed because the lock is taken,&lt;/li&gt;
	&lt;li&gt;Message 1 finishes execution and releases the lock,&lt;/li&gt;
	&lt;li&gt;Message 3 can be executed, gets the lock and runs,&lt;/li&gt;
	&lt;li&gt;Message 2 eventually runs when Message 3 finishes and releases the lock.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;We therefore have execution order 1 - 3 - 2 when the expected execution order is 1 - 2 - 3. Order 1 - 3 - 2 might not make sense or result in a different final state from 1 - 2 - 3.&lt;/p&gt;

&lt;p&gt;(there&#8217;s a variant of this scenario in which after Message 2 can&apos;t be executed the number of max parallel tasks is reached, then remaining tasks in &lt;tt&gt;heads&lt;/tt&gt; including Message 3 are put into the &lt;tt&gt;blockedTasks&lt;/tt&gt; map. These tasks are the first ones considered for processing on the next iteration of the main &lt;tt&gt;while&lt;/tt&gt; loop. The reordering is similar).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Note that from the client perspective, there does not need to be 3 outstanding tasks, 2 are sufficient. The third task required for observing reordering could be enqueued after the first one completed.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Impact of the issue:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;This problem makes &lt;tt&gt;MultiThreadedOCPTest.testFillWorkQueue()&lt;/tt&gt; fail because the test requires task execution in submission order (&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14524&quot; title=&quot;Harden MultiThreadedOCPTest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14524&quot;&gt;&lt;del&gt;SOLR-14524&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The messages required for reordering to happen are not necessarily messages at the same locking level: a message locking at &lt;tt&gt;SHARD&lt;/tt&gt; or &lt;tt&gt;REPLICA&lt;/tt&gt; level prevents execution of a &lt;tt&gt;COLLECTION&lt;/tt&gt; level message for the same collection. Examples can be built of sequences of messages that lead to incorrect results or failures. For example &lt;tt&gt;ADDREPLICA&lt;/tt&gt; followed by &lt;tt&gt;CREATEALIAS&lt;/tt&gt; followed by &lt;tt&gt;DELETEALIAS&lt;/tt&gt;, could see alias creation and deletion reordered, making no sense.&lt;/p&gt;

&lt;p&gt;I wasn&#8217;t able to come up with a realistic production example that would be impacted by this issue (doesn&apos;t mean one doesn&apos;t exist!).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13310075">SOLR-14546</key>
            <summary>OverseerTaskProcessor can process messages out of order</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ilan">Ilan Ginzburg</assignee>
                                    <reporter username="ilan">Ilan Ginzburg</reporter>
                        <labels>
                            <label>collection-api</label>
                            <label>correctness</label>
                            <label>overseer</label>
                    </labels>
                <created>Mon, 8 Jun 2020 10:02:40 +0000</created>
                <updated>Wed, 15 Jul 2020 18:13:04 +0000</updated>
                            <resolved>Tue, 23 Jun 2020 16:42:02 +0000</resolved>
                                    <version>9.0</version>
                                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>7</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="12000">3h 20m</timespent>
                                <comments>
                            <comment id="17128157" author="murblanc" created="Mon, 8 Jun 2020 10:47:52 +0000"  >&lt;p&gt;I might understand a few things that appeared pretty mysterious when I wrote the Overseer doc: why &lt;tt&gt;LockTree.Session&lt;/tt&gt; marks a node as busy when the lock can&apos;t be obtained (see &lt;a href=&quot;https://docs.google.com/document/d/1KTHq3noZBVUQ7QNuBGEhujZ_duwTVpAsvN3Nz5anQUY/edit#bookmark=id.ef1yf1sb14qu&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;). I now guess the intent of this was to solve this very issue.&lt;/p&gt;

&lt;p&gt;It&apos;s certainly the right direction for a fix.&lt;/p&gt;

&lt;p&gt;Currently my understanding is that the whole Session thing doesn&apos;t work (see &lt;a href=&quot;https://docs.google.com/document/d/1KTHq3noZBVUQ7QNuBGEhujZ_duwTVpAsvN3Nz5anQUY/edit#bookmark=id.oh0pwq90n27s&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;) because the &lt;tt&gt;OverseerCollectionMessageHandler.sessionId&lt;/tt&gt; is always &lt;tt&gt;-1&lt;/tt&gt; and never updated so never equal to the task batch id. This is easy to fix (set it).&lt;/p&gt;

&lt;p&gt;EDIT: the following is not  true, was due to a misunderstanding from my part on what ends up in blockedTasks. &lt;em&gt;This is likely not sufficient, as we would need to rely on the old &lt;tt&gt;Session&lt;/tt&gt; (from the &quot;previous&quot; batch id) when processing the &lt;tt&gt;blockedTask&lt;/tt&gt; that got moved to the head of the heads processing list (or said differently: increment the batch id at a different place).&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;Will work on a proposal along these lines.&lt;/p&gt;</comment>
                            <comment id="17129936" author="murblanc" created="Wed, 10 Jun 2020 01:37:29 +0000"  >&lt;p&gt;Here are the changes done in &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/1561&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/1561&lt;/a&gt;:&lt;/p&gt;

&lt;p&gt;Effectively use &lt;tt&gt;Sessions&lt;/tt&gt; for iterating over queued tasks. In &lt;tt&gt;OverseerCollectionMessageHandler.lockTask()&lt;/tt&gt; the &lt;tt&gt;sessionId&lt;/tt&gt; is now assigned the new passed batch session id which was the main missing piece (&lt;tt&gt;Sessions&lt;/tt&gt; were used once then thrown away). The bulk clearing of all locks was removed, it triggered &lt;tt&gt;&#8220;Unlocked multiple times&#8221;&lt;/tt&gt; and &lt;tt&gt;&#8220;lock_is_leaked&#8221;&lt;/tt&gt; logs from &lt;tt&gt;LockTree&lt;/tt&gt;. Even though there were no running tasks when locks were bulk cleared, there were race conditions because tasks get removed from the running task set before their lock is &#8220;naturally&#8221; released. If there are lock leaks we should fix them (but code looks pretty solid).&lt;/p&gt;

&lt;p&gt;Some refactoring/clean up done in &lt;tt&gt;LockTree&lt;/tt&gt;. I&#8217;ve run into some locking inconsistencies that were easier to fix that way.&lt;/p&gt;

&lt;p&gt;Some clean-up/refactoring of &lt;tt&gt;LockLevel&lt;/tt&gt; in &lt;tt&gt;CollectionParams&lt;/tt&gt;. Enum order reversed to allow reference to the child locking level and make the notion of &#8220;height&#8221; (&lt;tt&gt;isHigherOrEqual()&lt;/tt&gt;) more intuitive. Nothing fundamental.&lt;/p&gt;

&lt;p&gt;In &lt;tt&gt;OverseerTaskProcessor&lt;/tt&gt; added comments. Removed a few always true if conditions and simplified task batch id management.&lt;/p&gt;

&lt;p&gt;It is very likely that a fix was doable with less code changes, but as always understanding then fixing didn&#8217;t go in a straight line and I believe readability has improved (slightly) so submitting the PR that way.&lt;/p&gt;</comment>
                            <comment id="17142446" author="murblanc" created="Mon, 22 Jun 2020 22:11:46 +0000"  >&lt;p&gt;I will merge this tomorrow (after re running precommit and Solr tests).&lt;/p&gt;

&lt;p&gt;Did some mess with commits the way I &quot;rebased&quot; on master but that will go away when squashing on merge. Sorry about that.&lt;/p&gt;</comment>
                            <comment id="17142973" author="jira-bot" created="Tue, 23 Jun 2020 14:17:02 +0000"  >&lt;p&gt;Commit 3e42286e9e78ffe74c791426fe321ca28c4671bd in lucene-solr&apos;s branch refs/heads/master from Ilan Ginzburg&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=3e42286&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=3e42286&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14546&quot; title=&quot;OverseerTaskProcessor can process messages out of order&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14546&quot;&gt;&lt;del&gt;SOLR-14546&lt;/del&gt;&lt;/a&gt;: OverseerTaskProcessor can process messages out of order (#1561)&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14546&quot; title=&quot;OverseerTaskProcessor can process messages out of order&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14546&quot;&gt;&lt;del&gt;SOLR-14546&lt;/del&gt;&lt;/a&gt;: OverseerTaskProcessor can process messages out of order&lt;/p&gt;</comment>
                            <comment id="17142974" author="jira-bot" created="Tue, 23 Jun 2020 14:17:04 +0000"  >&lt;p&gt;Commit 3e42286e9e78ffe74c791426fe321ca28c4671bd in lucene-solr&apos;s branch refs/heads/master from Ilan Ginzburg&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=3e42286&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=3e42286&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14546&quot; title=&quot;OverseerTaskProcessor can process messages out of order&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14546&quot;&gt;&lt;del&gt;SOLR-14546&lt;/del&gt;&lt;/a&gt;: OverseerTaskProcessor can process messages out of order (#1561)&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14546&quot; title=&quot;OverseerTaskProcessor can process messages out of order&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14546&quot;&gt;&lt;del&gt;SOLR-14546&lt;/del&gt;&lt;/a&gt;: OverseerTaskProcessor can process messages out of order&lt;/p&gt;</comment>
                            <comment id="17143059" author="ichattopadhyaya" created="Tue, 23 Jun 2020 15:41:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ilan&quot; class=&quot;user-hover&quot; rel=&quot;ilan&quot;&gt;ilan&lt;/a&gt;, Shouldn&apos;t we place this changelog in &quot;Bugfix&quot; section instead of &quot;Other Changes&quot;?&lt;/p&gt;</comment>
                            <comment id="17143073" author="murblanc" created="Tue, 23 Jun 2020 16:13:40 +0000"  >&lt;p&gt;Sure &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ichattopadhyaya&quot; class=&quot;user-hover&quot; rel=&quot;ichattopadhyaya&quot;&gt;ichattopadhyaya&lt;/a&gt;, thank for spotting this that totally escaped me.&lt;/p&gt;

&lt;p&gt;I&apos;ll create the Bug Fixes section for 9.0.0 and move it there.&lt;/p&gt;</comment>
                            <comment id="17143085" author="murblanc" created="Tue, 23 Jun 2020 16:28:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/lucene-solr/pull/1607&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/1607&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17143091" author="jira-bot" created="Tue, 23 Jun 2020 16:36:04 +0000"  >&lt;p&gt;Commit 3c6e09268cc806daec05f2cdbdeb380ab0721309 in lucene-solr&apos;s branch refs/heads/master from Ilan Ginzburg&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=3c6e092&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=3c6e092&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14546&quot; title=&quot;OverseerTaskProcessor can process messages out of order&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14546&quot;&gt;&lt;del&gt;SOLR-14546&lt;/del&gt;&lt;/a&gt;: add a Bug Fixes section for Solr 9.0.0 in CHANGES.txt (#1607)&lt;/p&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13308533">SOLR-14524</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 21 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0fm80:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>