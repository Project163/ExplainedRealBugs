<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:59:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-6776] Data lost when use SoftCommit and TLog</title>
                <link>https://issues.apache.org/jira/browse/SOLR-6776</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;We enabled update log and change autoCommit to some bigger value 10 mins.&lt;/p&gt;

&lt;p&gt;After restart, we push one doc with softCommit=true&lt;br/&gt;
&lt;a href=&quot;http://localhost:8983/solr/update?stream.body=&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8983/solr/update?stream.body=&lt;/a&gt;&amp;lt;add&amp;gt;&amp;lt;doc&amp;gt;&amp;lt;field name=&quot;id&quot;&amp;gt;id1&amp;lt;/field&amp;gt;&amp;lt;/doc&amp;gt;&amp;lt;/add&amp;gt;&amp;amp;softCommit=true&lt;/p&gt;

&lt;p&gt;Then we kill the java process after a min. &lt;/p&gt;

&lt;p&gt;After restart, Tlog failed to replay with following exception, and there is no data in solr.&lt;br/&gt;
6245 &lt;span class=&quot;error&quot;&gt;&amp;#91;coreLoadExecutor-5-thread-1&amp;#93;&lt;/span&gt; ERROR org.apache.solr.update.UpdateLog  &#251; Failure to open existing log file (non fatal) E:\jeffery\src\apache\solr\4.10.2\solr-4.10.2\example\solr\collection1\data\t&lt;br/&gt;
log\tlog.0000000000000000000:org.apache.solr.common.SolrException: java.io.EOFException&lt;br/&gt;
        at org.apache.solr.update.TransactionLog.&amp;lt;init&amp;gt;(TransactionLog.java:181)&lt;br/&gt;
        at org.apache.solr.update.UpdateLog.init(UpdateLog.java:261)&lt;br/&gt;
        at org.apache.solr.update.UpdateHandler.&amp;lt;init&amp;gt;(UpdateHandler.java:134)&lt;br/&gt;
        at org.apache.solr.update.UpdateHandler.&amp;lt;init&amp;gt;(UpdateHandler.java:94)&lt;br/&gt;
        at org.apache.solr.update.DirectUpdateHandler2.&amp;lt;init&amp;gt;(DirectUpdateHandler2.java:100)&lt;br/&gt;
        at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)&lt;br/&gt;
        at sun.reflect.NativeConstructorAccessorImpl.newInstance(Unknown Source)&lt;br/&gt;
        at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(Unknown Source)&lt;br/&gt;
        at java.lang.reflect.Constructor.newInstance(Unknown Source)&lt;br/&gt;
        at org.apache.solr.core.SolrCore.createInstance(SolrCore.java:550)&lt;br/&gt;
        at org.apache.solr.core.SolrCore.createUpdateHandler(SolrCore.java:620)&lt;br/&gt;
        at org.apache.solr.core.SolrCore.&amp;lt;init&amp;gt;(SolrCore.java:835)&lt;br/&gt;
        at org.apache.solr.core.SolrCore.&amp;lt;init&amp;gt;(SolrCore.java:646)&lt;br/&gt;
        at org.apache.solr.core.CoreContainer.create(CoreContainer.java:491)&lt;br/&gt;
        at org.apache.solr.core.CoreContainer$1.call(CoreContainer.java:255)&lt;br/&gt;
        at org.apache.solr.core.CoreContainer$1.call(CoreContainer.java:249)&lt;br/&gt;
        at java.util.concurrent.FutureTask.run(Unknown Source)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)&lt;br/&gt;
        at java.lang.Thread.run(Unknown Source)&lt;br/&gt;
Caused by: java.io.EOFException&lt;br/&gt;
        at org.apache.solr.common.util.FastInputStream.readUnsignedByte(FastInputStream.java:73)&lt;br/&gt;
        at org.apache.solr.common.util.FastInputStream.readInt(FastInputStream.java:216)&lt;br/&gt;
        at org.apache.solr.update.TransactionLog.readHeader(TransactionLog.java:268)&lt;br/&gt;
        at org.apache.solr.update.TransactionLog.&amp;lt;init&amp;gt;(TransactionLog.java:159)&lt;br/&gt;
        ... 19 more&lt;/p&gt;

&lt;p&gt;Check the code: seems this is related with: org.apache.solr.update.processor.RunUpdateProcessor, in processCommit, it sets changesSinceCommit=false(even we are using softCommit)&lt;/p&gt;

&lt;p&gt;So in finish, updateLog.finish will not be called.&lt;br/&gt;
  public void finish() throws IOException {&lt;br/&gt;
    if (changesSinceCommit &amp;amp;&amp;amp; updateHandler.getUpdateLog() != null) &lt;/p&gt;
{
      updateHandler.getUpdateLog().finish(null);
    }
&lt;p&gt;    super.finish();&lt;br/&gt;
  }&lt;/p&gt;

&lt;p&gt;To fix this issue: I have to change RunUpdateProcessor.processCommit like below:&lt;br/&gt;
    if (!cmd.softCommit) &lt;/p&gt;
{
      changesSinceCommit = false;
    }</description>
                <environment></environment>
        <key id="12757091">SOLR-6776</key>
            <summary>Data lost when use SoftCommit and TLog</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yseeley@gmail.com">Yonik Seeley</assignee>
                                    <reporter username="yuanyun.cn">jefferyyuan</reporter>
                        <labels>
                            <label>softCommit</label>
                            <label>updateLog</label>
                    </labels>
                <created>Fri, 21 Nov 2014 21:39:33 +0000</created>
                <updated>Tue, 2 Dec 2014 16:49:36 +0000</updated>
                            <resolved>Tue, 2 Dec 2014 16:49:36 +0000</resolved>
                                    <version>4.10</version>
                                    <fixVersion>4.10.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14225445" author="simplebread" created="Wed, 26 Nov 2014 00:10:01 +0000"  >&lt;p&gt;Probably this is not a bug. Finish() is about flush tlog into hard disk and soft-commit is just about visibility. &lt;/p&gt;</comment>
                            <comment id="14227062" author="markrmiller@gmail.com" created="Thu, 27 Nov 2014 00:47:31 +0000"  >&lt;p&gt;By default, the tlog doesnt fsync, it just flushes and leans on replicas. You can configure the sync level in solrconfig.xml.&lt;/p&gt;</comment>
                            <comment id="14230053" author="yuanyun.cn" created="Mon, 1 Dec 2014 17:13:38 +0000"  >&lt;p&gt;The finish of UpdateProcessoris is always called in org.apache.solr.handler.ContentStreamHandlerBase.handleRequestBody(SolrQueryRequest, SolrQueryResponse).&lt;/p&gt;

&lt;p&gt;When we add a doc without softcommit or commit,  the org.apache.solr.update.processor.RunUpdateProcessor.finish() will call getUpdateLog().finish() to fsync the tlog.&lt;/p&gt;

&lt;p&gt;But if add a doc with softcommit=true, RunUpdateProcessor.finish() will not call getUpdateLog().finish(), and will not fsync the tlog.&lt;/p&gt;

&lt;p&gt;This is kind of not right.&lt;/p&gt;

&lt;p&gt;User enables transaction log for data durability, to make sure there is no data lost.&lt;br/&gt;
So I think it should always fsync the tlog after add this doc to solr and before the hard commit.&lt;/p&gt;</comment>
                            <comment id="14230063" author="yseeley@gmail.com" created="Mon, 1 Dec 2014 17:20:55 +0000"  >&lt;p&gt;If this is reproducible by someone, it represents a bug.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;To fix this issue: I have to change RunUpdateProcessor.processCommit like below:&lt;br/&gt;
if (!cmd.softCommit)&lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: { changesSinceCommit = false; }&lt;/span&gt; &lt;/div&gt;&lt;/blockquote&gt;

&lt;p&gt;It&apos;s not clear what this change is trying to fix (or why it changes anything for the reporter), but one should not have to softCommit (or commit) in order to not lose data.&lt;/p&gt;

&lt;p&gt;edit: I understand now (mis-read the patch the first time, missing the &quot;!&quot;).  You are correct, this is a bug and the fix looks correct.&lt;/p&gt;</comment>
                            <comment id="14230071" author="yuanyun.cn" created="Mon, 1 Dec 2014 17:26:38 +0000"  >&lt;p&gt;Hi, Yonik:&lt;/p&gt;

&lt;p&gt;The problem here is that if we add a doc with softcommit=true(user wants the data to be immediately searchable), processCommit  will set changesSinceCommit=false,&lt;br/&gt;
then in finish method, it will not call updateHandler.getUpdateLog().finish(null) to fsync the tlog.&lt;/p&gt;

&lt;p&gt;If we kill the java after that, then data will be lost.&lt;/p&gt;</comment>
                            <comment id="14231728" author="jira-bot" created="Tue, 2 Dec 2014 16:46:10 +0000"  >&lt;p&gt;Commit 1642946 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yonik%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;yonik@apache.org&quot;&gt;yonik@apache.org&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1642946&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1642946&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6776&quot; title=&quot;Data lost when use SoftCommit and TLog&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6776&quot;&gt;&lt;del&gt;SOLR-6776&lt;/del&gt;&lt;/a&gt;: only clear changesSinceCommit on a hard commit so tlog will still be flushed on a softCommit&lt;/p&gt;</comment>
                            <comment id="14231732" author="jira-bot" created="Tue, 2 Dec 2014 16:48:11 +0000"  >&lt;p&gt;Commit 1642950 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yonik%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;yonik@apache.org&quot;&gt;yonik@apache.org&lt;/a&gt; in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1642950&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1642950&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6776&quot; title=&quot;Data lost when use SoftCommit and TLog&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6776&quot;&gt;&lt;del&gt;SOLR-6776&lt;/del&gt;&lt;/a&gt;: only clear changesSinceCommit on a hard commit so tlog will still be flushed on a softCommit&lt;/p&gt;</comment>
                            <comment id="14231733" author="jira-bot" created="Tue, 2 Dec 2014 16:48:41 +0000"  >&lt;p&gt;Commit 1642951 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yonik%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;yonik@apache.org&quot;&gt;yonik@apache.org&lt;/a&gt; in branch &apos;dev/branches/lucene_solr_4_10&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1642951&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1642951&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6776&quot; title=&quot;Data lost when use SoftCommit and TLog&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6776&quot;&gt;&lt;del&gt;SOLR-6776&lt;/del&gt;&lt;/a&gt;: only clear changesSinceCommit on a hard commit so tlog will still be flushed on a softCommit&lt;/p&gt;</comment>
                            <comment id="14231736" author="yseeley@gmail.com" created="Tue, 2 Dec 2014 16:49:36 +0000"  >&lt;p&gt;Committed.  Thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 51 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i22o67:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>