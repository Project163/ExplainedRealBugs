<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:42:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-14013] javabin performance regressions</title>
                <link>https://issues.apache.org/jira/browse/SOLR-14013</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;As noted by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rrockenbaugh&quot; class=&quot;user-hover&quot; rel=&quot;rrockenbaugh&quot;&gt;rrockenbaugh&lt;/a&gt; in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13963&quot; title=&quot;JavaBinCodec has concurrent modification of CharArr resulting in corrupt intranode updates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13963&quot;&gt;&lt;del&gt;SOLR-13963&lt;/del&gt;&lt;/a&gt;, javabin also recently became orders of magnitude slower in certain cases since v7.7.  The cases identified so far include large numbers of values in a field.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13272284">SOLR-14013</key>
            <summary>javabin performance regressions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yseeley@gmail.com">Yonik Seeley</assignee>
                                    <reporter username="yseeley@gmail.com">Yonik Seeley</reporter>
                        <labels>
                    </labels>
                <created>Wed, 4 Dec 2019 16:34:10 +0000</created>
                <updated>Sat, 18 Apr 2020 12:16:23 +0000</updated>
                            <resolved>Fri, 13 Dec 2019 06:50:19 +0000</resolved>
                                    <version>7.7</version>
                                    <fixVersion>8.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>17</watches>
                                                                                                                <comments>
                            <comment id="16987986" author="yseeley@gmail.com" created="Wed, 4 Dec 2019 16:36:28 +0000"  >&lt;p&gt;The original reporter suspects that this may be caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12983&quot; title=&quot;JavabinLoader should avoid creating String Objects and create UTF8CharSequence  fields from byte[]&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12983&quot;&gt;&lt;del&gt;SOLR-12983&lt;/del&gt;&lt;/a&gt;, so I&apos;ll link it as such for now.&lt;/p&gt;</comment>
                            <comment id="16988249" author="noble.paul" created="Wed, 4 Dec 2019 21:51:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rrockenbaugh&quot; class=&quot;user-hover&quot; rel=&quot;rrockenbaugh&quot;&gt;rrockenbaugh&lt;/a&gt;&#160;can you add relevant details here as well please&lt;/p&gt;</comment>
                            <comment id="16988961" author="rrockenbaugh" created="Thu, 5 Dec 2019 16:37:37 +0000"  >&lt;p&gt;Here are my initial steps to reproduce:&lt;/p&gt;

&lt;p&gt;extract solr 7.6.0&lt;/p&gt;

&lt;p&gt;start solr:&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;bin/solr start -e cloud -noprompt&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;index record:&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;curl -X POST &quot;http://localhost:8983/solr/gettingstarted/update/json/docs?commit=true&quot; -T test.json&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;query record:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;curl &quot;http://localhost:8983/solr/gettingstarted/select?q=id:1&quot;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Results are returned in miliseconds (10-20 ms for me)&lt;/p&gt;

&lt;p&gt;Then do the same for solr 7.7.2:&lt;/p&gt;

&lt;p&gt;extract solr 7.7.2&lt;/p&gt;

&lt;p&gt;start solr:&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;bin/solr start -e cloud -noprompt&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;index record:&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;curl -X POST &quot;http://localhost:8983/solr/gettingstarted/update/json/docs?commit=true&quot; -T test.json&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;query record:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;curl &quot;http://localhost:8983/solr/gettingstarted/select?q=id:1&quot;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Results are returned in seconds(20-30 seconds for me)&lt;/p&gt;

&lt;p&gt;I had the same behavior in 8.0.0, 8.1.0, 8.2.0, 8.3.0&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Note:&#160; If I query a specific shard and set distrib=false, and javabin format is not used, and return times are miliseconds.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;curl &quot;http://localhost:8983/solr/gettingstarted_shard1_replica_n1/select?q=id:1&amp;amp;distrib=false&quot;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If I add wt=javabin:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;curl &quot;http://localhost:8983/solr/gettingstarted_shard1_replica_n1/select?q=id:1&amp;amp;distrib=false&amp;amp;wt=javabin&quot;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;Results are returned in seconds (20-30 seconds for me)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16989121" author="yseeley@gmail.com" created="Thu, 5 Dec 2019 20:06:17 +0000"  >&lt;p&gt;I did some digging... the current code is certainly more complex than it used to be.&lt;/p&gt;

&lt;p&gt;So for a multi-valued field, the values internally are now IndexableField (for each value)&lt;br/&gt;
For each of those values, we call JavaBinCodec.writeVal&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;which tries writeKnownTypes&lt;/li&gt;
	&lt;li&gt;which tests if it&apos;s a member of ~10 primitive types via instanceof&lt;/li&gt;
	&lt;li&gt;failing, then tests against 19 other types&lt;/li&gt;
	&lt;li&gt;failing, falls back to object resolver which tries against 4 other types, finally matching it up to IndexableField&lt;/li&gt;
	&lt;li&gt;the schema is used to look up the SchemaField based on name (2 more hash lookups)&lt;/li&gt;
	&lt;li&gt;then we call DocStreamer.getValue(), which does another hash lookup based on the .getClass()&lt;/li&gt;
	&lt;li&gt;and then calls FieldType.toObject() which calls toExternal() which finally calls stringValue() on the IndexableField&lt;/li&gt;
	&lt;li&gt;and now that we have our object, JavaBinCodec can try writeKnownTypes() again&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;And this is now the common case!&lt;/p&gt;</comment>
                            <comment id="16989860" author="yseeley@gmail.com" created="Fri, 6 Dec 2019 15:11:33 +0000"  >&lt;p&gt;Just an update... I tried speeding things up by skipping most of the above, and it did get faster, but it&apos;s still much slower.&#160; Still digging...&lt;/p&gt;</comment>
                            <comment id="16990124" author="noble.paul" created="Fri, 6 Dec 2019 19:51:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yseeley%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;yseeley@gmail.com&quot;&gt;yseeley@gmail.com&lt;/a&gt;&lt;br/&gt;
You can just avoid the call to&lt;br/&gt;
&lt;tt&gt;JavaBinCodec#setReadStringAsCharSeq()&lt;/tt&gt; and get the old behavior&lt;/p&gt;</comment>
                            <comment id="16990572" author="yseeley@gmail.com" created="Sat, 7 Dec 2019 18:48:12 +0000"  >&lt;p&gt;OK, found the primary issue.... it&apos;s an N^2 bug.&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;Background%3A&quot;&gt;&lt;/a&gt;Background: &lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12885&quot; title=&quot;BinaryResponseWriter (javabin format) should directly copy from Bytesref to output&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12885&quot;&gt;&lt;del&gt;SOLR-12885&lt;/del&gt;&lt;/a&gt; changed SolrDocument (among other things) to make it so&lt;br/&gt;
 that when used through certain interfaces, gets would auto-check-and-convert&lt;br/&gt;
 keys &amp;amp; values of type Utf8CharSequence to String. This happened in methods&lt;br/&gt;
 getFieldValueMap.get(), getFieldValueMap.keySet(), remove() and getValues()&lt;/p&gt;

&lt;h3&gt;&lt;a name=&quot;Issues%3A&quot;&gt;&lt;/a&gt;Issues: &lt;/h3&gt;
&lt;p&gt; SolrDocument does not auto-convert through many other of its methods,&lt;br/&gt;
 such as .get(), .put(), .keySet(), so depending on this anywhere is extremely&lt;br/&gt;
 fragile and will break if you change how you access SolrDocument&lt;/p&gt;

&lt;p&gt;SolrInputField has some of the same issues as SolrDocument, the mere act of&lt;br/&gt;
 doing a .get() on a multi-valued field (which should be O(1)) scans the entire&lt;br/&gt;
 list for CharSequence and if it finds one, creates a new list and iterates over&lt;br/&gt;
 the whole thing again to convert each element.&lt;/p&gt;

&lt;h3&gt;&lt;a name=&quot;Clientsideindexing%3A&quot;&gt;&lt;/a&gt;Client side indexing:&lt;/h3&gt;
&lt;p&gt; And it&apos;s worse, because it looks like this auto-check-and-convert logic is even&lt;br/&gt;
 triggered when the SolrJ is using JavaBinCodec to send documents... so even if&lt;br/&gt;
 some field values were Utf8CharSequence to begin with, they would still be converted to&lt;br/&gt;
 String before being converted back to utf8 by JavaBinCodec!&lt;/p&gt;

&lt;h3&gt;&lt;a name=&quot;Serversideindexing%3A&quot;&gt;&lt;/a&gt;Server side indexing:&lt;/h3&gt;
&lt;p&gt; Then on the server side, JavaBinCodec parses String values as Utf8CharSequence, and&lt;br/&gt;
 we start going through the update processor chain. FieldMutatingUpdateProcessor (used&lt;br/&gt;
 in our _default config to remove blank values) asks each SolrInputField for its&lt;br/&gt;
 value, which again triggers iteration over the complete list. Also, for &lt;b&gt;any&lt;/b&gt;&lt;br/&gt;
 string values (single valued too), FieldMutatingUpdateProcessor replaces those&lt;br/&gt;
 Utf8CharSequence objects with String objects (destroying any attempted re-serializing&lt;br/&gt;
 optimization)&lt;/p&gt;

&lt;p&gt;Then comes NestedUpdateProcessorFactory, which triggers the&lt;br/&gt;
 auto-check-and-convert &lt;b&gt;twice&lt;/b&gt;, because getValue() returned a pointer&lt;br/&gt;
 previously, which would have been optimized away. Both lines below iterate&lt;br/&gt;
 over all values, &lt;b&gt;before&lt;/b&gt; the actual iteration by the explicit &quot;for&quot; loop:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isSingleVal = !(field.getValue() &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; Collection); 
  &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;(Objectval: field) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;then isAtomicUpdate(), and then finally writeSolrInputDocument() to convert to&lt;br/&gt;
 JavaBin for the transaction log both trigger the extra&lt;br/&gt;
 iterate-over-all-values with each inspection. If FieldMutatingUpdateProcessor&lt;br/&gt;
 hadn&apos;t overwritten Utf8CharSequence already, all of these accesses would have&lt;br/&gt;
 also triggered a new collection creation each time (and an additional iteration to&lt;br/&gt;
 create the new collection) for every multi-valued string field.&lt;/p&gt;

&lt;h3&gt;&lt;a name=&quot;Serversidequery%3A&quot;&gt;&lt;/a&gt;Server side query:&lt;/h3&gt;
&lt;p&gt; On the query side, we get a Lucene Document, and then convert it into a&lt;br/&gt;
 SolrDocument. Binary ResponseWriter uses MaskCharSeqSolrDocument which&lt;br/&gt;
 inherits from SolrDocument to do the auto-convert-on-access stuff more&lt;br/&gt;
 thoroughly.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (IndexableField f : doc.getFields()) {
      &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; fname = f.name();
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; == fieldNamesNeeded || fieldNamesNeeded.contains(fname) ) {
        &lt;span class=&quot;code-comment&quot;&gt;// Make sure multivalued fields are represented as lists
&lt;/span&gt;        &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; existing = out.get(fname);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;For multi-valued fields, what we get back from lucene is actually a flat list&lt;br/&gt;
 of all the values in the whole document. We need to collect all values&lt;br/&gt;
 with the same field into a list. So if there are 1000 values in a&lt;br/&gt;
 field, the outer loop executes over 1000 times. Then in the inner loop we&lt;br/&gt;
 retrieve any existing value for the field by calling &quot;out.get(fname)&quot;, which&lt;br/&gt;
 triggers the auto-convert-on-access which scans all the values so far (on average 1000/2),&lt;br/&gt;
 and hence we have our O(N^2) behavior that the original poster reported.&lt;/p&gt;

&lt;h3&gt;&lt;a name=&quot;Other%3A&quot;&gt;&lt;/a&gt;Other:&lt;/h3&gt;
&lt;p&gt;It took a really long time to review some of this code (and I&apos;ve only reviewed&lt;br/&gt;
 some), often because a lack of comments around non-obvious things. I thought&lt;br/&gt;
 there might be lifetime/sharing bugs with BytesBlock for example, until I&lt;br/&gt;
 realized that strings are appended in the block rather than placed at the start.&lt;/p&gt;

&lt;p&gt;Same issue for FastInputStream.readDirectUtf8... since it looked like it&lt;br/&gt;
 was sharing the internal buffer, I thought there was a possible lifetime issue&lt;br/&gt;
 there. A single line comment in both of those cases would have saved me quite&lt;br/&gt;
 a bit.&lt;/p&gt;

&lt;p&gt;Actually... looking at it again, there still may be a subtle sharing bug in&lt;br/&gt;
 this new FastInputStream.readDirectUtf8. I can&apos;t say I quite understand the&lt;br/&gt;
 logic behind for when you can&apos;t share the internal buffer.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (in !=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || end &amp;lt; pos + len) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;; 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;You can only share the buffer when the bytes you want are right up at the end of the buffer?&lt;br/&gt;
 I&apos;m not sure I understand the logic around that, but ChannelFastInputStream (used by&lt;br/&gt;
 TransactionLog) derives from FastInputStream and doesn&apos;t have an input stream,&lt;br/&gt;
 so if it got unlucky and did a string read at the end of a buffer, there would&lt;br/&gt;
 likely be data corruption.&lt;/p&gt;</comment>
                            <comment id="16990579" author="yseeley@gmail.com" created="Sat, 7 Dec 2019 19:01:15 +0000"  >&lt;p&gt;Even without the O(N^2) bug, which would be that hard to work around, this auto-check-and-convert&lt;br/&gt;
on access is quite a trap (as seen above) that would be constantly biting devs forever.  It&apos;s also almost assuredly&lt;br/&gt;
the case that after just handling the N^2 bug, things will be slower overall (often with more memory usage)&lt;br/&gt;
than before this attempt to save utf-8 conversion.&lt;/p&gt;

&lt;p&gt;At this point I think the best thing to do is roll it back.&lt;br/&gt;
I support the idea of trying to use more CharSequence... but it&apos;s hard in practice and we need to be careful.&lt;br/&gt;
The original fault lies with Java of course, which introduced CharSequence long after String, and was&lt;br/&gt;
never fully converted/adopted &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;In the future, we should certainly benchmark any changes that are meant to improve performance.&lt;/p&gt;</comment>
                            <comment id="16990752" author="ichattopadhyaya" created="Sun, 8 Dec 2019 06:43:26 +0000"  >&lt;blockquote&gt;&lt;p&gt;At this point I think the best thing to do is roll it back.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="16990802" author="janhoy" created="Sun, 8 Dec 2019 10:11:41 +0000"  >&lt;p&gt;+1&lt;br/&gt;
Perf improvements should be backed by benchmarks.&lt;/p&gt;</comment>
                            <comment id="16990868" author="jpountz" created="Sun, 8 Dec 2019 14:11:31 +0000"  >&lt;p&gt;I&apos;m also a bit disappointed that &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12885&quot; title=&quot;BinaryResponseWriter (javabin format) should directly copy from Bytesref to output&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12885&quot;&gt;&lt;del&gt;SOLR-12885&lt;/del&gt;&lt;/a&gt; changed Field&apos;s constructor from String to CharSequence silently.&lt;/p&gt;</comment>
                            <comment id="16990919" author="ichattopadhyaya" created="Sun, 8 Dec 2019 16:43:35 +0000"  >&lt;blockquote&gt;&lt;p&gt;Perf improvements should be backed by benchmarks.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;FYI, &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12885?focusedCommentId=16709641&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-16709641&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-12885?focusedCommentId=16709641&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-16709641&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16990926" author="yseeley@gmail.com" created="Sun, 8 Dec 2019 17:15:47 +0000"  >&lt;p&gt;Those benchmarks look like they are testing different settings, not a before-vs-after patch scenario?&#160; Also, a lot of the issues I saw would affect the indexing pipeline performance.&lt;/p&gt;</comment>
                            <comment id="16991014" author="yseeley@gmail.com" created="Sun, 8 Dec 2019 23:02:20 +0000"  >&lt;p&gt;I worked up a quick-n-dirty patch to disable the charseq optimization stuff to test my hypothesis on slower indexing speed:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
git diff
diff --git a/solr/core/src/java/org/apache/solr/handler/component/HttpShardHandler.java b/solr/core/src/java/org/apache/solr/handler/component/HttpShardHandler.java
index 69da3948fe9..620fffb1303 100644
--- a/solr/core/src/java/org/apache/solr/handler/component/HttpShardHandler.java
+++ b/solr/core/src/java/org/apache/solr/handler/component/HttpShardHandler.java
@@ -146,7 +146,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;HttpShardHandler &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; ShardHandler {
   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; BinaryResponseParser READ_STR_AS_CHARSEQ_PARSER = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BinaryResponseParser() {
     @Override
     &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; JavaBinCodec createCodec() {
-      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JavaBinCodec(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, stringCache).setReadStringAsCharSeq(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
+      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JavaBinCodec(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, stringCache).setReadStringAsCharSeq(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
     }
   };

diff --git a/solr/core/src/java/org/apache/solr/response/DocsStreamer.java b/solr/core/src/java/org/apache/solr/response/DocsStreamer.java
index 3d1976e143c..056dc08d963 100644
--- a/solr/core/src/java/org/apache/solr/response/DocsStreamer.java
+++ b/solr/core/src/java/org/apache/solr/response/DocsStreamer.java
@@ -148,9 +148,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;DocsStreamer &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Iterator&amp;lt;SolrDocument&amp;gt; {
     &lt;span class=&quot;code-comment&quot;&gt;// because that doesn&apos;t include extra fields needed by transformers
&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Set&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; fieldNamesNeeded = fields.getLuceneFieldNames();

-    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; SolrDocument out = ResultContext.READASBYTES.get() == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; ?
-        &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SolrDocument() :
-        &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BinaryResponseWriter.MaskCharSeqSolrDocument();
+    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; SolrDocument out = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SolrDocument();

     &lt;span class=&quot;code-comment&quot;&gt;// NOTE: it would be tempting to &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; and optimize &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; to loop over fieldNamesNeeded
&lt;/span&gt;     &lt;span class=&quot;code-comment&quot;&gt;// when it&lt;span class=&quot;code-quote&quot;&gt;&apos;s smaller then the IndexableField[] in the Document -- but that&apos;&lt;/span&gt;s actually *less* effecient
&lt;/span&gt;diff --git a/solr/solrj/src/java/org/apache/solr/common/util/ByteArrayUtf8CharSequence.java b/solr/solrj/src/java/org/apache/solr/common/util/ByteArrayUtf8CharSequence.java
index 7a4abe2c303..53cfbee320f 100644
--- a/solr/solrj/src/java/org/apache/solr/common/util/ByteArrayUtf8CharSequence.java
+++ b/solr/solrj/src/java/org/apache/solr/common/util/ByteArrayUtf8CharSequence.java
@@ -209,8 +209,11 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ByteArrayUtf8CharSequence &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Utf8CharSequence {
     }
     &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; vals;
   }
-
   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; convertCharSeq(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; o) {
+    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; o; &lt;span class=&quot;code-comment&quot;&gt;// nocommit
&lt;/span&gt;+  }
+
+  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; _convertCharSeq(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; o) {
     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (o == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (o &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; Utf8CharSequence) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ((Utf8CharSequence) o).toString();
     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (o &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; Collection) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; convertCharSeq((Collection) o);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I also hacked up the unit test I used to find the N^2 issue...&lt;br/&gt;
it&apos;s obviously not good for benchmarking (being a unit test, etc), but good enough to detect anything major.&lt;br/&gt;
I tested with a single value per string field (and many fields per doc).. it would be worse for multiple values per field.&lt;/p&gt;

&lt;p&gt;Results:&lt;br/&gt;
===================== master, single valued string fields&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt; 2&amp;gt; INDEX TIME=10293&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt; 2&amp;gt; QUERY TIME=891 xml&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt; 2&amp;gt; QUERY TIME=415 javabin&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt; 2&amp;gt; QUERY TIME=600 json&lt;/p&gt;

&lt;p&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt; 2&amp;gt; INDEX TIME=10313&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt; 2&amp;gt; QUERY TIME=872 xml&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt; 2&amp;gt; QUERY TIME=389 javabin&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt; 2&amp;gt; QUERY TIME=579 json&lt;/p&gt;

&lt;p&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt; 2&amp;gt; INDEX TIME=10307&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt; 2&amp;gt; QUERY TIME=858 xml&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt; 2&amp;gt; QUERY TIME=410 javabin&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt; 2&amp;gt; QUERY TIME=570 json&lt;/p&gt;

&lt;p&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt; 2&amp;gt; INDEX TIME=10318&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt; 2&amp;gt; QUERY TIME=915 xml&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt; 2&amp;gt; QUERY TIME=382 javabin&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt; 2&amp;gt; QUERY TIME=600 json&lt;/p&gt;

&lt;p&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt; 2&amp;gt; INDEX TIME=10579&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt; 2&amp;gt; QUERY TIME=843 xml&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt; 2&amp;gt; QUERY TIME=386 javabin&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt; 2&amp;gt; QUERY TIME=570 json&lt;/p&gt;

&lt;p&gt;===================== patch disabling charseq stuff, single valued string fields&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt; INDEX TIME=8547&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt; QUERY TIME=881 xml&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt; QUERY TIME=396 javabin&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt; QUERY TIME=576 json&lt;/p&gt;

&lt;p&gt;   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt; INDEX TIME=9428&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt; QUERY TIME=821 xml&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt; QUERY TIME=374 javabin&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt; QUERY TIME=543 json&lt;/p&gt;

&lt;p&gt;   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt; INDEX TIME=9181&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt; QUERY TIME=812 xml&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt; QUERY TIME=382 javabin&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt; QUERY TIME=533 json&lt;/p&gt;

&lt;p&gt;   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt; INDEX TIME=9455&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt; QUERY TIME=863 xml&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt; QUERY TIME=395 javabin&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt; QUERY TIME=613 json&lt;/p&gt;

&lt;p&gt;   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt; INDEX TIME=9530&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt; QUERY TIME=863 xml&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt; QUERY TIME=385 javabin&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt; QUERY TIME=559 json&lt;/p&gt;

&lt;p&gt;So the charseq stuff (or rather probably the extra work to auto-convert-to-string) did cause slower indexing speed.&lt;br/&gt;
There is enough noise that I don&apos;t think one can draw any conclusions about query speed.&lt;/p&gt;


</comment>
                            <comment id="16991017" author="yseeley@gmail.com" created="Sun, 8 Dec 2019 23:09:08 +0000"  >&lt;p&gt;Here&apos;s the &quot;benchmark&quot; program I used.  I&apos;m not recommending this... a real benchmark program shouldn&apos;t be run as a unit test.  But if one is looking to debug performance issues, then running it as a unit test can be useful.&lt;/p&gt;</comment>
                            <comment id="16991031" author="noble.paul" created="Mon, 9 Dec 2019 00:25:21 +0000"  >&lt;p&gt;I have submitted a bug fix for the perf degradation&lt;/p&gt;

&lt;p&gt;There are 3 places where the optimizations are done&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Writing out responses&lt;/li&gt;
	&lt;li&gt;Indexing&lt;/li&gt;
	&lt;li&gt;deserializing responses during inter-node communications&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The changes are minimal for #1 and #2 and #3 are complex&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I would recommend reverting #2 and #3 and let #1 continue to be there with the bug fix (and more auditing) I have just submitted.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;ll go with the decision of the community and do the necessary work&lt;/p&gt;</comment>
                            <comment id="16991041" author="yseeley@gmail.com" created="Mon, 9 Dec 2019 01:12:19 +0000"  >&lt;p&gt;Please don&apos;t commit that huge JSON file... a doc matching that can be created with a few lines of java in the test.&lt;br/&gt;
I&apos;m not sure the test belongs as a unit test anyway as it&apos;s more of a performance benchmark, but I don&apos;t care much either way as long as it&apos;s quick to run.&lt;/p&gt;

&lt;p&gt;In general, what I think should be done is:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the auto-convert changes should be removed (in SolrDocument, SolrInputField, MaskCharSeqSolrDocument)&lt;/li&gt;
	&lt;li&gt;if there are parts of the code base that can&apos;t handle CharSequence, then disable reading Strings as CharSequence and look at if those other pieces of code can be fixed to handle CharSequence.&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="16993844" author="houston" created="Wed, 11 Dec 2019 19:27:32 +0000"  >&lt;p&gt;I&apos;ve created a patch that adds in &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&#160;&apos;s test and fix (without the large file), and reverts the conversion for indexing and deserializing responses. I think I incorporated all of the places that you mentioned &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yseeley%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;yseeley@gmail.com&quot;&gt;yseeley@gmail.com&lt;/a&gt;. The only issue in the tests was in the langid contrib module, which was reverting a later-made fix.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Probably too close of a call to get it into 8.4. What do y&apos;all think of backporting this to 7.7.x, since it is such a serious regression?&lt;/p&gt;

&lt;p&gt;The solr/lucene tests pass on 8x and master. I&apos;ve used &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rrockenbaugh&quot; class=&quot;user-hover&quot; rel=&quot;rrockenbaugh&quot;&gt;rrockenbaugh&lt;/a&gt;&apos;s testing method mentioned above, for all branches that I could think would be relevant. The results are below:&lt;/p&gt;



&lt;p&gt;&lt;b&gt;patch (8.x)&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Ingest - 1.2 seconds&lt;br/&gt;
Sharded Query - 0.4 seconds&lt;br/&gt;
Non-Distrib Javabin Query - 0.17 seconds&lt;br/&gt;
Non-Distrib JSON Query - 0.13 seconds&lt;/p&gt;


&lt;p&gt; &lt;b&gt;patch (master)&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Ingest - .87 seconds&lt;br/&gt;
Sharded Query - .3 seconds&lt;br/&gt;
Non-Distrib Javabin Query - 0.06 seconds&lt;br/&gt;
Non-Distrib JSON Query - 0.08 seconds&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;7.6&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Ingest - 1.6 seconds&lt;br/&gt;
Sharded Query - 0.3 seconds&lt;br/&gt;
Non-Distrib Javabin Query - 0.12 seconds&lt;br/&gt;
Non-Distrib JSON Query - 0.15 seconds&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;7.x&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Ingest - 1.3 seconds&lt;br/&gt;
Sharded Query - 36 seconds&lt;br/&gt;
Non-Distrib Javabin Query -&#160; 30 seconds&lt;br/&gt;
Non-Distrib JSON Query - 0.3 seconds&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;8.x&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Ingest - 1.18 seconds&lt;br/&gt;
Sharded Query - 21 seconds&lt;br/&gt;
Non-Distrib Javabin Query - 20 seconds&lt;br/&gt;
Non-Distrib JSON Query - 0.07 seconds&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;master&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Ingest - 2.6 seconds&lt;br/&gt;
Sharded Query - 35 seconds&lt;br/&gt;
Non-Distrib Javabin Query - 35 seconds&lt;br/&gt;
Non-Distrib JSON Query - .16 seconds&lt;/p&gt;</comment>
                            <comment id="16993963" author="noble.paul" created="Wed, 11 Dec 2019 22:54:51 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=houston&quot; class=&quot;user-hover&quot; rel=&quot;houston&quot;&gt;houston&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I didn&apos;t understand the difference between the following . The perf (with the patch ) should be same on both &lt;tt&gt;8.x&lt;/tt&gt;&#160;and &lt;tt&gt;master&lt;/tt&gt;, correct?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
patch (8.x)

Ingest - 1.2 seconds
Sharded Query - 0.4 seconds
Non-Distrib Javabin Query - 0.17 seconds
Non-Distrib JSON Query - 0.13 seconds

patch (master)

Ingest - .87 seconds
Sharded Query - .3 seconds
Non-Distrib Javabin Query - 0.06 seconds
Non-Distrib JSON Query - 0.08 seconds


&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16994233" author="ichattopadhyaya" created="Thu, 12 Dec 2019 05:34:31 +0000"  >&lt;blockquote&gt;&lt;p&gt;Probably too close of a call to get it into 8.4&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This is a blocker for 8.4. If &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jpountz&quot; class=&quot;user-hover&quot; rel=&quot;jpountz&quot;&gt;jpountz&lt;/a&gt; feels we shouldn&apos;t wait for this one, then we can have a 8.4.1 with this.&lt;/p&gt;</comment>
                            <comment id="16994350" author="jpountz" created="Thu, 12 Dec 2019 07:49:46 +0000"  >&lt;p&gt;I&apos;m deferring to you as to whether this patch is safe to get in so close to the release, but if you think it&apos;s better to get it in than not, then to me the question is about how long you think we need to get it merged. If it&apos;s a matter of one or two additional days it&apos;s fine. If it&apos;s weeks, I&apos;ll have a preference for targeting it for the next release.&lt;/p&gt;</comment>
                            <comment id="16994367" author="noble.paul" created="Thu, 12 Dec 2019 08:22:12 +0000"  >&lt;p&gt;I shall merge a fix soon. This fix is important&lt;/p&gt;</comment>
                            <comment id="16994603" author="jira-bot" created="Thu, 12 Dec 2019 12:27:02 +0000"  >&lt;p&gt;Commit b35f1debe33e69dcfb94d295324ca7fa85a6b5d7 in lucene-solr&apos;s branch refs/heads/master from Noble Paul&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=b35f1de&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=b35f1de&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14013&quot; title=&quot;javabin performance regressions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14013&quot;&gt;&lt;del&gt;SOLR-14013&lt;/del&gt;&lt;/a&gt;: javabin performance regressions&lt;/p&gt;</comment>
                            <comment id="16994610" author="noble.paul" created="Thu, 12 Dec 2019 12:32:17 +0000"  >&lt;p&gt;I accidentally pushed the fix to master instead of a branch an raise a PR&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yseeley%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;yseeley@gmail.com&quot;&gt;yseeley@gmail.com&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=houston&quot; class=&quot;user-hover&quot; rel=&quot;houston&quot;&gt;houston&lt;/a&gt;&#160;please review&lt;/p&gt;

&lt;p&gt;The changes are&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Perf optimizations are eliminated from HttpShardHandler &amp;amp; JavabinLoader&lt;/li&gt;
	&lt;li&gt;The bug is fixed&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="16994614" author="jira-bot" created="Thu, 12 Dec 2019 12:39:06 +0000"  >&lt;p&gt;Commit 4d5df0e20ac3f2ac0a050241b3e124667ea1f812 in lucene-solr&apos;s branch refs/heads/master from Noble Paul&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=4d5df0e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=4d5df0e&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14013&quot; title=&quot;javabin performance regressions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14013&quot;&gt;&lt;del&gt;SOLR-14013&lt;/del&gt;&lt;/a&gt;: FIX: javabin performance regressions&lt;/p&gt;</comment>
                            <comment id="16994621" author="noble.paul" created="Thu, 12 Dec 2019 12:50:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jpountz&quot; class=&quot;user-hover&quot; rel=&quot;jpountz&quot;&gt;jpountz&lt;/a&gt;&#160;It&apos;s not yet pushed to branch_8x. I&apos;ll do it once it is reviewed. This has to go in &lt;tt&gt;8.4&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="16994650" author="jira-bot" created="Thu, 12 Dec 2019 13:22:31 +0000"  >&lt;p&gt;Commit b35f1debe33e69dcfb94d295324ca7fa85a6b5d7 in lucene-solr&apos;s branch refs/heads/gradle-master from Noble Paul&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=b35f1de&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=b35f1de&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14013&quot; title=&quot;javabin performance regressions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14013&quot;&gt;&lt;del&gt;SOLR-14013&lt;/del&gt;&lt;/a&gt;: javabin performance regressions&lt;/p&gt;</comment>
                            <comment id="16994651" author="jira-bot" created="Thu, 12 Dec 2019 13:22:34 +0000"  >&lt;p&gt;Commit 4d5df0e20ac3f2ac0a050241b3e124667ea1f812 in lucene-solr&apos;s branch refs/heads/gradle-master from Noble Paul&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=4d5df0e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=4d5df0e&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14013&quot; title=&quot;javabin performance regressions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14013&quot;&gt;&lt;del&gt;SOLR-14013&lt;/del&gt;&lt;/a&gt;: FIX: javabin performance regressions&lt;/p&gt;</comment>
                            <comment id="16994888" author="houston" created="Thu, 12 Dec 2019 17:22:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;, my speed tests weren&apos;t completely scientific, but I tried to make the scenarios as similar between the setups as possible.&lt;/p&gt;

&lt;p&gt;I think the main takeaways were that the queries were significantly faster (30 seconds -&amp;gt; .1 seconds). The smaller differences between the ingest speeds were less of a concern to me. I can redo the tests and try to make them more scientific &amp;amp; accurate if these numbers give you pause.&lt;/p&gt;

&lt;p&gt;I&apos;ve reviewed the patch and run the test on the updated master, and everything looks good to me.&lt;/p&gt;</comment>
                            <comment id="16995400" author="jira-bot" created="Fri, 13 Dec 2019 06:43:16 +0000"  >&lt;p&gt;Commit 9717540b8ecb6f5e142aaef8e27464690684a0f9 in lucene-solr&apos;s branch refs/heads/branch_8x from Noble Paul&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=9717540&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=9717540&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14013&quot; title=&quot;javabin performance regressions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14013&quot;&gt;&lt;del&gt;SOLR-14013&lt;/del&gt;&lt;/a&gt;: javabin performance regressions&lt;/p&gt;</comment>
                            <comment id="16995402" author="jira-bot" created="Fri, 13 Dec 2019 06:48:38 +0000"  >&lt;p&gt;Commit 422de99acf7cfab004e1e976c1ab47870dc6cfba in lucene-solr&apos;s branch refs/heads/branch_8_4 from Noble Paul&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=422de99&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=422de99&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14013&quot; title=&quot;javabin performance regressions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14013&quot;&gt;&lt;del&gt;SOLR-14013&lt;/del&gt;&lt;/a&gt;: javabin performance regressions&lt;/p&gt;</comment>
                            <comment id="17004922" author="jpountz" created="Sun, 29 Dec 2019 20:49:40 +0000"  >&lt;p&gt;Closing after the 8.4.0 release.&lt;/p&gt;</comment>
                            <comment id="17025919" author="over_flo" created="Wed, 29 Jan 2020 14:30:32 +0000"  >&lt;p&gt;Do you plan to fix it in 7.X series also ? or do we have to migrate to 8.4.0&lt;/p&gt;</comment>
                            <comment id="17026032" author="noble.paul" created="Wed, 29 Jan 2020 16:51:46 +0000"  >&lt;p&gt;I can port it to 7.x , but, no release is planned&lt;/p&gt;</comment>
                            <comment id="17026046" author="houston" created="Wed, 29 Jan 2020 17:10:17 +0000"  >&lt;p&gt;I think backporting would be a good idea, even if a release isn&apos;t planned yet.&lt;/p&gt;</comment>
                            <comment id="17026170" author="kstoney" created="Wed, 29 Jan 2020 19:52:44 +0000"  >&lt;p&gt;Please could this be backported to 7_7 &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;?  We build that branch from source anyway so I&apos;d really appreciate it! &lt;/p&gt;</comment>
                            <comment id="17035499" author="houston" created="Wed, 12 Feb 2020 16:39:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;, at the very least I think we should backport this to 7_7. If we want to leave the latest release of 7 in a state with a significant regression/bug in it, then we are basically asking people to either:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Know that 7.6 is the last stable release of solr for people wanting to use multiValued fields in a sharded collection&lt;/li&gt;
	&lt;li&gt;Upgrade to Solr 8.4&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In my opinion, neither of those are good options. Because users are always going to go with the most up to date version of Solr that works for their index, and upgrading to new major versions is a very tough process for a lot of people.&lt;/p&gt;

&lt;p&gt;This isn&apos;t a bug that existed throughout the entirety of Solr 7, it was introduced in the last minor release. A lot of people are very comfortable with Solr 7, and trust it. People also trust that the last minor/patch version of something is going to be the most stable version. We should make sure that the latest release of our second to last major version (7) is stable and maintains that trust that users have in it and Solr in general.&lt;/p&gt;

&lt;p&gt;It is very little work to backport this, and also probably not a whole lot of work to do another patch or minor release (7.8 or 7.7.3). And with that work we will be providing a significantly better user experience for our community.&#160;&lt;/p&gt;</comment>
                            <comment id="17035589" author="noble.paul" created="Wed, 12 Feb 2020 18:28:53 +0000"  >&lt;p&gt;I&apos;ve opened&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14259&quot; title=&quot;backport SOLR-14013 to Solr 7.7&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14259&quot;&gt;&lt;del&gt;SOLR-14259&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17083861" author="jira-bot" created="Wed, 15 Apr 2020 07:06:43 +0000"  >&lt;p&gt;Commit 5d3dfbd0ce8a2ad990635e71144615f1c4815d22 in lucene-solr&apos;s branch refs/heads/branch_7_7 from Noble Paul&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=5d3dfbd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=5d3dfbd&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14013&quot; title=&quot;javabin performance regressions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14013&quot;&gt;&lt;del&gt;SOLR-14013&lt;/del&gt;&lt;/a&gt;: trying to port to SOlr 7.7 (#1254)&lt;/p&gt;
</comment>
                            <comment id="17086432" author="jira-bot" created="Sat, 18 Apr 2020 12:15:08 +0000"  >&lt;p&gt;Commit 6b1263a035cf1ff01c868dac5b32b2421aa74f1f in lucene-solr&apos;s branch refs/heads/branch_7_7 from Noble Paul&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=6b1263a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=6b1263a&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14259&quot; title=&quot;backport SOLR-14013 to Solr 7.7&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14259&quot;&gt;&lt;del&gt;SOLR-14259&lt;/del&gt;&lt;/a&gt;: Back port javabin performance regression fixes from &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14013&quot; title=&quot;javabin performance regressions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14013&quot;&gt;&lt;del&gt;SOLR-14013&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17086434" author="jira-bot" created="Sat, 18 Apr 2020 12:16:23 +0000"  >&lt;p&gt;Commit c2cd10b923cf2dca0030f2b1c304038bd8267b4e in lucene-solr&apos;s branch refs/heads/branch_7_7 from Noble Paul&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=c2cd10b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=c2cd10b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14259&quot; title=&quot;backport SOLR-14013 to Solr 7.7&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14259&quot;&gt;&lt;del&gt;SOLR-14259&lt;/del&gt;&lt;/a&gt;: Back port javabin performance regression fixes from &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14013&quot; title=&quot;javabin performance regressions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14013&quot;&gt;&lt;del&gt;SOLR-14013&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310460">
                    <name>Child-Issue</name>
                                                                <inwardlinks description="is a child of">
                                        <issuelink>
            <issuekey id="13192756">SOLR-12885</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="13284890">SOLR-14259</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13197964">SOLR-12983</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12988581" name="SOLR-14013.patch" size="14900" author="houston" created="Wed, 11 Dec 2019 19:28:21 +0000"/>
                            <attachment id="12988280" name="SOLR-14013.patch" size="702118" author="noble.paul" created="Mon, 9 Dec 2019 00:16:02 +0000"/>
                            <attachment id="12988279" name="TestQuerySpeed.java" size="5734" author="yseeley@gmail.com" created="Sun, 8 Dec 2019 23:07:00 +0000"/>
                            <attachment id="12987622" name="test.json" size="397809" author="rrockenbaugh" created="Thu, 5 Dec 2019 16:17:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 30 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z09ajk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>