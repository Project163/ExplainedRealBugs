<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:32:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-4161] deadlock if commit+newSearcher occurs during core close, can happen as a result of snappuller (occured in TestReplicationHandler)</title>
                <link>https://issues.apache.org/jira/browse/SOLR-4161</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;There appears to be a lock related bug in the DefaultSolrCoreState/DirectUpdateHandler2 interactions. It appears that if CoreContainer is shutting down the core at the same time that some other thread attempts to do a commit which triggers a newSearcher, then DefaultSolrCoreState.closeIndexWriter and DefaultSolrCoreState.getIndexWriter get into deadlock.&lt;/p&gt;

&lt;p&gt;This has been observed in TestReplicationHandler, but doesn&apos;t appear to be related to any bugs in thta testcase, so it seems like it could easily affect real life users as well.&lt;/p&gt;

&lt;p&gt;Summary of the deadlock stacks, see attachments for full details...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Found one Java-level deadlock:
=============================
&quot;snapPuller-422-thread-1&quot;:
  waiting to lock monitor 0x00007f5a2011a9e0 (object 0x00000000f5f485a0, a org.apache.solr.update.DefaultSolrCoreState),
  which is held by &quot;TEST-TestReplicationHandler.test-seed#[1B46F52130C14E03]&quot;
&quot;TEST-TestReplicationHandler.test-seed#[1B46F52130C14E03]&quot;:
  waiting for ownable synchronizer 0x00000000f60fe5c8, (a java.util.concurrent.locks.ReentrantLock$NonfairSync),
  which is held by &quot;snapPuller-422-thread-1&quot;

Java stack information for the threads listed above:
===================================================
&quot;snapPuller-422-thread-1&quot;:
	at org.apache.solr.update.DefaultSolrCoreState.getIndexWriter(DefaultSolrCoreState.java:77)
	- waiting to lock &amp;lt;0x00000000f5f485a0&amp;gt; (a org.apache.solr.update.DefaultSolrCoreState)
	at org.apache.solr.core.SolrCore.openNewSearcher(SolrCore.java:1358)
	at org.apache.solr.update.DirectUpdateHandler2.commit(DirectUpdateHandler2.java:561)
	- locked &amp;lt;0x00000000f5f485d0&amp;gt; (a java.lang.Object)
	at org.apache.solr.handler.SnapPuller.doCommit(SnapPuller.java:655)
	at org.apache.solr.handler.SnapPuller.fetchLatestIndex(SnapPuller.java:454)
	at org.apache.solr.handler.ReplicationHandler.doFetch(ReplicationHandler.java:273)
	at org.apache.solr.handler.SnapPuller$1.run(SnapPuller.java:222)
...

&quot;TEST-TestReplicationHandler.test-seed#[1B46F52130C14E03]&quot;:
	at sun.misc.Unsafe.park(Native Method)
	- parking to wait for  &amp;lt;0x00000000f60fe5c8&amp;gt; (a java.util.concurrent.locks.ReentrantLock$NonfairSync)
	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:186)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:838)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued(AbstractQueuedSynchronizer.java:871)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(AbstractQueuedSynchronizer.java:1201)
	at java.util.concurrent.locks.ReentrantLock$NonfairSync.lock(ReentrantLock.java:214)
	at java.util.concurrent.locks.ReentrantLock.lock(ReentrantLock.java:290)
	at org.apache.solr.update.DirectUpdateHandler2.closeWriter(DirectUpdateHandler2.java:668)
	at org.apache.solr.update.DefaultSolrCoreState.closeIndexWriter(DefaultSolrCoreState.java:64)
	- locked &amp;lt;0x00000000f5f485a0&amp;gt; (a org.apache.solr.update.DefaultSolrCoreState)
	at org.apache.solr.update.DefaultSolrCoreState.close(DefaultSolrCoreState.java:259)
	- locked &amp;lt;0x00000000f5f485a0&amp;gt; (a org.apache.solr.update.DefaultSolrCoreState)
	at org.apache.solr.core.SolrCore.decrefSolrCoreState(SolrCore.java:879)
	- locked &amp;lt;0x00000000f5f485a0&amp;gt; (a org.apache.solr.update.DefaultSolrCoreState)
	at org.apache.solr.core.SolrCore.close(SolrCore.java:971)
	at org.apache.solr.core.CoreContainer.shutdown(CoreContainer.java:723)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Original Report...&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;while testing out another patch i noticed &quot;stalled&quot; heartbeat messages getting logged by TestReplicationHandler.test and started taking some stack traces to see if it was in the code i was working on.&lt;/p&gt;

&lt;p&gt;it&apos;s not, so i suspect it&apos;s unrelated to the changes i&apos;m looking at, but i did notice that there was a full on deadlock reported, so i wanted to make sure it got tracked.&lt;/p&gt;&lt;/blockquote&gt;</description>
                <environment></environment>
        <key id="12623196">SOLR-4161</key>
            <summary>deadlock if commit+newSearcher occurs during core close, can happen as a result of snappuller (occured in TestReplicationHandler)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="4" iconUrl="https://issues.apache.org/jira/images/icons/statuses/reopened.png" description="This issue was once resolved, but the resolution was deemed incorrect. From here issues are either marked assigned or resolved.">Reopened</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Mon, 10 Dec 2012 19:20:36 +0000</created>
                <updated>Wed, 12 Dec 2012 01:54:52 +0000</updated>
                                                                                <due></due>
                            <votes>3</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13528194" author="hossman" created="Mon, 10 Dec 2012 19:21:54 +0000"  >&lt;p&gt;multiple dump files taken a few seconds apart ... i haven&apos;t looked at them in a lot of depth, but but given the deadlock state i suspect there aren&apos;t&apos; a lot of differneces.&lt;/p&gt;</comment>
                            <comment id="13528225" author="markrmiller@gmail.com" created="Mon, 10 Dec 2012 19:59:49 +0000"  >&lt;p&gt;I think I just fixed this - see commits from a short while ago and my reply to the fail of replication handler test on the dev list.&lt;/p&gt;

&lt;p&gt;More details to follow.&lt;/p&gt;</comment>
                            <comment id="13528571" author="hossman" created="Tue, 11 Dec 2012 01:25:44 +0000"  >&lt;p&gt;In addition to the related changes in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4060&quot; title=&quot;ReplicationHandler can try and do a snappull and open a new writer after shutdown has already occurred, leaving an IndexWriter that is not closed.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4060&quot;&gt;&lt;del&gt;SOLR-4060&lt;/del&gt;&lt;/a&gt;, i was asking mark about this in in IRC earlier today and confirmed he was talking about this commit...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/viewvc?rev=1419665&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1419665&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;...which switched from looping over writerPauseLock.wait() to writerPauseLock.wait&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/thumbs_down.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; and checking the closed boolean.&lt;/p&gt;</comment>
                            <comment id="13529094" author="markrmiller@gmail.com" created="Tue, 11 Dec 2012 16:23:40 +0000"  >&lt;p&gt;Okay, sorry - the commit above solved a different issue. This issue still exists.&lt;/p&gt;</comment>
                            <comment id="13529516" author="commit-tag-bot" created="Wed, 12 Dec 2012 00:40:09 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;trunk commit&amp;#93;&lt;/span&gt; Mark Robert Miller&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1420500&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1420500&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4161&quot; title=&quot;deadlock if commit+newSearcher occurs during core close, can happen as a result of snappuller (occured in TestReplicationHandler)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4161&quot;&gt;SOLR-4161&lt;/a&gt;: add a little more protection&lt;/p&gt;</comment>
                            <comment id="13529522" author="markrmiller@gmail.com" created="Wed, 12 Dec 2012 00:57:04 +0000"  >&lt;p&gt;So whats at odds are the commit lock and the DefaultSolrCore this lock.&lt;/p&gt;

&lt;p&gt;I&apos;ve added a bit more protection which should reduce the window, but perhaps not solve this.&lt;/p&gt;

&lt;p&gt;A better way to deal with this type of thing IMO, would be to try making sure all request handlers were shutdown or something before shutting down the core.&lt;/p&gt;

&lt;p&gt;For some like the replication handler, which could take a long time, an interruption option would also be nice. Currently we kind of count on random shutdown issues to interrupt it - it tries to do something that requires an open option and that thing fails.&lt;/p&gt;</comment>
                            <comment id="13529567" author="commit-tag-bot" created="Wed, 12 Dec 2012 01:54:52 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;branch_4x commit&amp;#93;&lt;/span&gt; Mark Robert Miller&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1420508&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1420508&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4161&quot; title=&quot;deadlock if commit+newSearcher occurs during core close, can happen as a result of snappuller (occured in TestReplicationHandler)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4161&quot;&gt;SOLR-4161&lt;/a&gt;: add a little more protection&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12510861">SOLR-2608</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12615600">SOLR-4060</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12560246" name="dump2.txt" size="44635" author="hossman" created="Mon, 10 Dec 2012 19:21:54 +0000"/>
                            <attachment id="12560247" name="dump3.txt" size="44635" author="hossman" created="Mon, 10 Dec 2012 19:21:54 +0000"/>
                            <attachment id="12560248" name="dump4.txt" size="44635" author="hossman" created="Mon, 10 Dec 2012 19:21:54 +0000"/>
                            <attachment id="12560249" name="dump5.txt" size="44635" author="hossman" created="Mon, 10 Dec 2012 19:21:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>296807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 50 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i14hf3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>234285</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>