<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:10:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-8453] Jetty update from 9.2 to 9.3 causes the server to reset formerly legitimate client connections.</title>
                <link>https://issues.apache.org/jira/browse/SOLR-8453</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;The basic problem is that when we are streaming in updates via a client, an update can fail in a way that further updates in the request will not be processed, but not in a way that causes the client to stop and finish up the request before the server does something else with that connection.&lt;/p&gt;

&lt;p&gt;This seems to mean that even after the server stops processing the request, the concurrent update client is still in the process of sending the request. It seems previously, Jetty would not go after the connection very quickly after the server processing thread was stopped via exception, and the client (usually?) had time to clean up properly. But after the Jetty upgrade from 9.2 to 9.3, Jetty closes the connection on the server sooner than previous versions &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;, and the client does not end up getting notified of the original exception at all and instead hits a connection reset exception. The result was random fails due to connection reset throughout our tests and one particular test failing consistently. Even before this update, it does not seem like we are acting in a safe or &apos;behaved&apos; manner, but our version of Jetty was relaxed enough (or a bug was fixed?) for our tests to work out.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12923550">SOLR-8453</key>
            <summary>Jetty update from 9.2 to 9.3 causes the server to reset formerly legitimate client connections.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="markrmiller@gmail.com">Mark Miller</assignee>
                                    <reporter username="markrmiller@gmail.com">Mark Miller</reporter>
                        <labels>
                    </labels>
                <created>Mon, 21 Dec 2015 20:21:50 +0000</created>
                <updated>Wed, 2 Oct 2019 17:30:36 +0000</updated>
                            <resolved>Wed, 13 Jan 2016 16:58:15 +0000</resolved>
                                                    <fixVersion>5.5</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="15067034" author="markrmiller@gmail.com" created="Mon, 21 Dec 2015 20:24:25 +0000"  >&lt;p&gt;Here is one idea.&lt;/p&gt;</comment>
                            <comment id="15067040" author="markrmiller@gmail.com" created="Mon, 21 Dec 2015 20:38:31 +0000"  >&lt;p&gt;This &apos;bad&apos; behavior is kind of baked into some our test error handling expectations. When a single request multi update has a fail in it, we expect that the rest of the updates are not processed.&lt;/p&gt;

&lt;p&gt;Can we easily tell between a streaming request and a single multi-update request in DistributedUpdateProcessor?&lt;/p&gt;</comment>
                            <comment id="15067106" author="markrmiller@gmail.com" created="Mon, 21 Dec 2015 21:40:12 +0000"  >&lt;p&gt;Rather than in DistributedUpdateProcessor, probably the right place to deal with this without changing behavior is in the code that manages the UpdateProcessor objects. That is a bit of a drag though, because a bunch of places can work with those.&lt;/p&gt;</comment>
                            <comment id="15067199" author="markrmiller@gmail.com" created="Mon, 21 Dec 2015 22:47:52 +0000"  >&lt;p&gt;I did a little more work on the above patch. You can try and simulate the old behavior by letting the client finishing sending and just do nothing with those updates after a fail. Better if we could tell the client to give up more cleanly, but anyway.&lt;/p&gt;

&lt;p&gt;The main issue I&apos;ve found with that so far is that DocBasedVersionConstraintsProcessor actually counts on getting a physical exception for 409 conflicts. I think one other spot may too.&lt;/p&gt;</comment>
                            <comment id="15067469" author="markrmiller@gmail.com" created="Tue, 22 Dec 2015 02:45:45 +0000"  >&lt;p&gt;Here is a fairly simple and clean approach.&lt;/p&gt;

&lt;p&gt;We inject a new ErrorHandlingProcessor as the first processor in all chains (have not thought very long about the name yet).&lt;/p&gt;

&lt;p&gt;This can provide with us with the almost identical behavior to what we had previously while getting us to what we need now (to cleanly manage our client / server connection lifecycles).&lt;/p&gt;

&lt;p&gt;Patch still needs some work.&lt;/p&gt;</comment>
                            <comment id="15067496" author="markrmiller@gmail.com" created="Tue, 22 Dec 2015 03:37:05 +0000"  >&lt;p&gt;Here is a more complete patch with test fixes.&lt;/p&gt;

&lt;p&gt;This also has a couple unrelated other changes I&apos;ve tried while looking into &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7339&quot; title=&quot;Upgrade Jetty from 9.2 to 9.3&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7339&quot;&gt;&lt;del&gt;SOLR-7339&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15068201" author="shalinmangar" created="Tue, 22 Dec 2015 14:51:59 +0000"  >&lt;p&gt;This is great, thanks for debugging this.&lt;/p&gt;

&lt;p&gt;If you move the following to the life cycle started method then you should also increase the timeout in the start() method because currently it gives up waiting for solr in 500ms.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (JettySolrRunner.&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;) {
          waitOnSolr = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
          JettySolrRunner.&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.notify();
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Did you see any test failures after this change? When I tried moving waitOnSolr to life cycle started, it failed many tests. However, I tried only once so it may have been the locale problems we&apos;ve seen in other places. I&apos;ll run the tests in a loop with this patch to see if I can reproduce the failures.&lt;/p&gt;</comment>
                            <comment id="15068279" author="markrmiller@gmail.com" created="Tue, 22 Dec 2015 15:44:15 +0000"  >&lt;p&gt;I have not seen any failures due to that change and have been running it for a lot of days. I don&apos;t know that it&apos;s very important for this issue though - I&apos;ll probably pare a couple of those things out or into their own issues. I think most tests now are actually using that wait till cores are loaded option anyway? Logically, this does make more sense to me though.&lt;/p&gt;

&lt;p&gt;I&apos;m still fighting with some DIH tests a little. Their test classes really want the &apos;old processor throws out an exception&apos; behavior - and while I can easily simulate that, it seems that also leaves those tests with the random connection reset issue. Old behavior, old problem I guess. Will probably have to try and tweak those tests a bit more.&lt;/p&gt;</comment>
                            <comment id="15069016" author="markrmiller@gmail.com" created="Wed, 23 Dec 2015 01:45:41 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;ll run the tests in a loop with this patch to see if I can reproduce the failures.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m still looping more recent versions. If you get a chance, update to the most recent patch. It has some changes to how our clients handle cleanup under failures. I think we overdo method.abort and I think it messes up connection reuse. On a clean server-&amp;gt;client exception, we should simply make sure the response entity content is fully consumed and closed like a normal request.&lt;/p&gt;</comment>
                            <comment id="15073402" author="markrmiller@gmail.com" created="Tue, 29 Dec 2015 03:03:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yseeley%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;yseeley@gmail.com&quot;&gt;yseeley@gmail.com&lt;/a&gt;, you have a some time to look at this? We are holding off on the Jetty upgrade for a bit, but I think that has just made it easier to see issues that exist even on the older version. I think it may just be a matter of timing.&lt;/p&gt;

&lt;p&gt;Basically, we are not managing the connection like we are supposed to - errors, especially ones we expect to see in normal operations, should not bubble out and cut off the request. We want to use our Response.exception handling to properly notify the client, and let the request fully execute.&lt;/p&gt;
</comment>
                            <comment id="15081360" author="yseeley@gmail.com" created="Mon, 4 Jan 2016 16:59:05 +0000"  >&lt;p&gt;Catching up from the holidays... yeah, I can take a look.&lt;/p&gt;

&lt;p&gt;IIRC, in the past, didn&apos;t a failed update in a batch cause all the updates after that to fail as well?  That was never that desirable, but I don&apos;t remember if it was ever fixed.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;the client does not end up getting notified of the original exception at all and instead hits a connection reset exception.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I thought we caught &lt;b&gt;all&lt;/b&gt; exceptions in the SolrDispatchFilter and never let any bubble up to Jetty.&lt;br/&gt;
edit: this code is in HttpSolrCall now:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable ex) {
      sendError(ex);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15081423" author="markrmiller@gmail.com" created="Mon, 4 Jan 2016 17:34:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;I thought we caught all exceptions in the SolrDispatchFilter and never let any bubble up to Jetty.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The problem is not about whether the exception comes out of the SolrDispatchFilter - it&apos;s a matter of managing the connection.&lt;/p&gt;

&lt;p&gt;We want the client to handle the connection, so everything can be done cleanly. So the client needs to be able to fully send the request and then fully receive the response - that is the goal for all but really exceptional cases. If we let an exception bubble out and stop the server thread (whether the dispatch filter swallows it or not), the request thread can still be wrapping up - but if it tries to do any communication, it will get a connection reset as the server has closed the connection. We are not properly letting the client finish its request in these cases - so there is a race. We need to make sure the server does not close the connection until the request is fully done.&lt;/p&gt;</comment>
                            <comment id="15081468" author="yseeley@gmail.com" created="Mon, 4 Jan 2016 17:52:58 +0000"  >&lt;p&gt;That&apos;s unfortunate if one can&apos;t provide an error response before the request has finished.&lt;br/&gt;
(I&apos;m thinking of something like uploading a multi-gigabyte CSV file, but one of the fields is missing... it would be nice to have the option of saying &quot;abort on any errors&quot;, and still get the specific error message back).&lt;/p&gt;

&lt;p&gt;Trying to figure out if this is a Jetty regression (regardless of how we want to act - which would seem to depend on context).&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;An HTTP/1.1 (or later) client sending a message-body SHOULD monitor the network connection &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; an error status &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; it is transmitting the request. If the client sees an error status, it SHOULD immediately cease transmitting the body.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15081576" author="yseeley@gmail.com" created="Mon, 4 Jan 2016 18:59:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;That&apos;s unfortunate if one can&apos;t provide an error response before the request has finished.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hmmm, OK... it doesn&apos;t look like that&apos;s happening:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;~$ nc 127.0.0.1 8983
POST /solr/techproducts/update HTTP/1.1
Host: localhost:8983
User-Agent: curl/7.43.0
Accept: */*
Content-type:application/json
Content-Length: 1000000000


[
 {&lt;span class=&quot;code-quote&quot;&gt;&quot;id_not_exist&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;TestDoc1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;title&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;test1&quot;&lt;/span&gt;},
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;HTTP/1.1 400 Bad Request
Content-Type: text/plain;charset=utf-8
Transfer-Encoding: chunked

7E
{&lt;span class=&quot;code-quote&quot;&gt;&quot;responseHeader&quot;&lt;/span&gt;:{&lt;span class=&quot;code-quote&quot;&gt;&quot;status&quot;&lt;/span&gt;:400,&lt;span class=&quot;code-quote&quot;&gt;&quot;QTime&quot;&lt;/span&gt;:6312},&lt;span class=&quot;code-quote&quot;&gt;&quot;error&quot;&lt;/span&gt;:{&lt;span class=&quot;code-quote&quot;&gt;&quot;msg&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;Document is missing mandatory uniqueKey field: id&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;code&quot;&lt;/span&gt;:400}}

0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I guess this suggests that we should be able to handle things better on the client side?&lt;/p&gt;</comment>
                            <comment id="15083141" author="markrmiller@gmail.com" created="Tue, 5 Jan 2016 14:33:55 +0000"  >&lt;p&gt;I think it&apos;s more related to using HttpClient than http. We see random connection resets in many tests that go away with this, but looking at the consistent test we have that fails (SolrExampleStreamingTest#testUpdateField), we seem to hit the problem when HttpClient is cleaning up and closing the outputstream, which flushes a buffer.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.net.SocketException: Connection reset
	at java.net.SocketOutputStream.socketWrite(SocketOutputStream.java:113)
	at java.net.SocketOutputStream.write(SocketOutputStream.java:153)
	at org.apache.http.impl.io.AbstractSessionOutputBuffer.flushBuffer(AbstractSessionOutputBuffer.java:159)
	at org.apache.http.impl.io.AbstractSessionOutputBuffer.flush(AbstractSessionOutputBuffer.java:166)
	at org.apache.http.impl.io.ChunkedOutputStream.close(ChunkedOutputStream.java:205)
	at org.apache.http.impl.entity.EntitySerializer.serialize(EntitySerializer.java:118)
	at org.apache.http.impl.AbstractHttpClientConnection.sendRequestEntity(AbstractHttpClientConnection.java:265)
	at org.apache.http.impl.conn.ManagedClientConnectionImpl.sendRequestEntity(ManagedClientConnectionImpl.java:203)
	at org.apache.http.protocol.HttpRequestExecutor.doSendRequest(HttpRequestExecutor.java:237)
	at org.apache.http.protocol.HttpRequestExecutor.execute(HttpRequestExecutor.java:122)
	at org.apache.http.impl.client.DefaultRequestDirector.tryExecute(DefaultRequestDirector.java:685)
	at org.apache.http.impl.client.DefaultRequestDirector.execute(DefaultRequestDirector.java:487)
	at org.apache.http.impl.client.AbstractHttpClient.doExecute(AbstractHttpClient.java:882)
	at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:82)
	at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:107)
	at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:55)
	at org.apache.solr.client.solrj.impl.ConcurrentUpdateSolrClient$Runner.sendUpdateStream(ConcurrentUpdateSolrClient.java:280)
	at org.apache.solr.client.solrj.impl.ConcurrentUpdateSolrClient$Runner.run(ConcurrentUpdateSolrClient.java:161)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It may also be that it only happens with this chunked encoding. On close, it tries to write a &apos;closing chunk&apos; and then flush: &lt;a href=&quot;https://github.com/apache/httpcore/blob/4.0.x/httpcore/src/main/java/org/apache/http/impl/io/ChunkedOutputStream.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcore/blob/4.0.x/httpcore/src/main/java/org/apache/http/impl/io/ChunkedOutputStream.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If there is a problem here we get the connection reset.&lt;/p&gt;

&lt;p&gt;It does actually seem like a bit of a race to me and I&apos;m not sure how to address that yet (other than this patch). If you remove the 250ms poll that happens in ConcurrentUpdateSolrClient-&amp;gt;sendUpdateStream-&amp;gt;EntityTemplate-&amp;gt;writeTo, it seems to go away. But that would indicate our connection management is a bit fragile, with the client kind of racing the server.&lt;/p&gt;

&lt;p&gt;Still playing around to try and find other potential fixes.&lt;/p&gt;</comment>
                            <comment id="15083159" author="markrmiller@gmail.com" created="Tue, 5 Jan 2016 14:48:39 +0000"  >&lt;blockquote&gt;&lt;p&gt;If you remove the 250ms poll that happens ... with the client kind of racing the server.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;On trunk right now, you have to drop that poll to 12ms or less on my machine to get the test to pass.&lt;/p&gt;</comment>
                            <comment id="15083272" author="markrmiller@gmail.com" created="Tue, 5 Jan 2016 15:54:00 +0000"  >&lt;blockquote&gt;&lt;p&gt;On trunk right now, you have to drop that poll to 12ms or less on my machine to get the test to pass.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;And on 5x, Jetty is not sensitive to the length of the poll it seems (at least up to 30 seconds).&lt;/p&gt;</comment>
                            <comment id="15083405" author="yseeley@gmail.com" created="Tue, 5 Jan 2016 17:25:47 +0000"  >&lt;p&gt;Here&apos;s a test with normal solrj clients that reproduces HTTP level exceptions.  It uses multiple threads and large request sizes.&lt;/p&gt;

&lt;p&gt;Example exception summary (from 10 clients):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;3567 ERROR (TEST-TestSolrJErrorHandling.testWithBinary-seed#[5C3578C3D02417A3]) [    ] o.a.s.c.s.TestSolrJErrorHandling CHAIN: -&amp;gt;SolrServerException-&amp;gt;SocketException(Connection reset)
3569 ERROR (TEST-TestSolrJErrorHandling.testWithBinary-seed#[5C3578C3D02417A3]) [    ] o.a.s.c.s.TestSolrJErrorHandling CHAIN: -&amp;gt;SolrServerException-&amp;gt;ClientProtocolException-&amp;gt;NonRepeatableRequestException-&amp;gt;SocketException(Broken pipe)
3569 ERROR (TEST-TestSolrJErrorHandling.testWithBinary-seed#[5C3578C3D02417A3]) [    ] o.a.s.c.s.TestSolrJErrorHandling CHAIN: -&amp;gt;SolrServerException-&amp;gt;ClientProtocolException-&amp;gt;NonRepeatableRequestException-&amp;gt;SocketException(Broken pipe)
3570 ERROR (TEST-TestSolrJErrorHandling.testWithBinary-seed#[5C3578C3D02417A3]) [    ] o.a.s.c.s.TestSolrJErrorHandling CHAIN: -&amp;gt;SolrServerException-&amp;gt;ClientProtocolException-&amp;gt;NonRepeatableRequestException-&amp;gt;SocketException(Broken pipe)
3571 ERROR (TEST-TestSolrJErrorHandling.testWithBinary-seed#[5C3578C3D02417A3]) [    ] o.a.s.c.s.TestSolrJErrorHandling CHAIN: -&amp;gt;SolrServerException-&amp;gt;ClientProtocolException-&amp;gt;NonRepeatableRequestException-&amp;gt;SocketException(Broken pipe)
3571 ERROR (TEST-TestSolrJErrorHandling.testWithBinary-seed#[5C3578C3D02417A3]) [    ] o.a.s.c.s.TestSolrJErrorHandling CHAIN: -&amp;gt;SolrServerException-&amp;gt;ClientProtocolException-&amp;gt;NonRepeatableRequestException-&amp;gt;SocketException(Broken pipe)
3571 ERROR (TEST-TestSolrJErrorHandling.testWithBinary-seed#[5C3578C3D02417A3]) [    ] o.a.s.c.s.TestSolrJErrorHandling CHAIN: -&amp;gt;SolrServerException-&amp;gt;ClientProtocolException-&amp;gt;NonRepeatableRequestException-&amp;gt;SocketException(Broken pipe)
3572 ERROR (TEST-TestSolrJErrorHandling.testWithBinary-seed#[5C3578C3D02417A3]) [    ] o.a.s.c.s.TestSolrJErrorHandling CHAIN: -&amp;gt;SolrServerException-&amp;gt;ClientProtocolException-&amp;gt;NonRepeatableRequestException-&amp;gt;SocketException(Broken pipe)
3572 ERROR (TEST-TestSolrJErrorHandling.testWithBinary-seed#[5C3578C3D02417A3]) [    ] o.a.s.c.s.TestSolrJErrorHandling CHAIN: -&amp;gt;SolrServerException-&amp;gt;ClientProtocolException-&amp;gt;NonRepeatableRequestException-&amp;gt;SocketException(Broken pipe)
3572 ERROR (TEST-TestSolrJErrorHandling.testWithBinary-seed#[5C3578C3D02417A3]) [    ] o.a.s.c.s.TestSolrJErrorHandling CHAIN: -&amp;gt;SolrServerException-&amp;gt;ClientProtocolException-&amp;gt;NonRepeatableRequestException-&amp;gt;SocketException(Broken pipe)
3573 INFO  (TEST-TestSolrJErrorHandling.testWithBinary-seed#[5C3578C3D02417A3]) [    ] o.a.s.SolrTestCaseJ4 ###Ending testWithBinary
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15083471" author="yseeley@gmail.com" created="Tue, 5 Jan 2016 17:58:41 +0000"  >&lt;p&gt;Here&apos;s an updated test that dedups the exception summary and cranks up the number of client threads, just to see what type of errors we can get.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;10714 ERROR (TEST-TestSolrJErrorHandling.testWithXml-seed#[CDCE136AF9E0FF01]) [    ] o.a.s.c.s.TestSolrJErrorHandling EXCEPTION LIST:
	98) SolrServerException-&amp;gt;ClientProtocolException-&amp;gt;NonRepeatableRequestException-&amp;gt;SocketException(Broken pipe)
	2) SolrServerException-&amp;gt;ClientProtocolException-&amp;gt;NonRepeatableRequestException-&amp;gt;SocketException(Protocol wrong type &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; socket)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15083534" author="yseeley@gmail.com" created="Tue, 5 Jan 2016 18:37:07 +0000"  >&lt;p&gt;This test currently passes on Solr 5x.&lt;/p&gt;</comment>
                            <comment id="15085065" author="markrmiller@gmail.com" created="Wed, 6 Jan 2016 06:44:26 +0000"  >&lt;p&gt;Okay, I&apos;m starting to think it&apos;s a change in consumeAll in - &lt;a href=&quot;https://github.com/eclipse/jetty.project/blame/jetty-9.3.x/jetty-server/src/main/java/org/eclipse/jetty/server/HttpInput.java#L443&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/eclipse/jetty.project/blame/jetty-9.3.x/jetty-server/src/main/java/org/eclipse/jetty/server/HttpInput.java#L443&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I think perhaps that is now returning false in &lt;a href=&quot;https://github.com/eclipse/jetty.project/blob/jetty-9.3.x/jetty-server/src/main/java/org/eclipse/jetty/server/HttpConnection.java#L403&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/eclipse/jetty.project/blob/jetty-9.3.x/jetty-server/src/main/java/org/eclipse/jetty/server/HttpConnection.java#L403&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It&apos;s looking to me like the server resets the connection because of unconsumed content, and previously it must have been properly consuming the extra.&lt;/p&gt;</comment>
                            <comment id="15085861" author="markrmiller@gmail.com" created="Wed, 6 Jan 2016 17:18:51 +0000"  >&lt;p&gt;Here is consumeAll from 9.2:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/eclipse/jetty.project/blame/jetty-9.2.x/jetty-server/src/main/java/org/eclipse/jetty/server/HttpInput.java#L281&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/eclipse/jetty.project/blame/jetty-9.2.x/jetty-server/src/main/java/org/eclipse/jetty/server/HttpInput.java#L281&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;There are a couple possible changes that may be doing this to us:&lt;/p&gt;

&lt;p&gt;9.3&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; consumeAll()
    {
        &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (_inputQ)
        {
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
            {
                &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!isFinished())
                {
                    Content item = nextContent();
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (item == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
                        &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;; &lt;span class=&quot;code-comment&quot;&gt;// Let&apos;s not bother blocking
&lt;/span&gt;
                    skip(item, remaining(item));
                }
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; isFinished() &amp;amp;&amp;amp; !isError();
            }
            &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e)
            {
                LOG.debug(e);
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
            }
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;9.2&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; consumeAll()
    {
        &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (lock())
        {
            &lt;span class=&quot;code-comment&quot;&gt;// Don&apos;t bother reading &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we already know there was an error.
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (_onError != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;

            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
            {
                &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!isFinished())
                {
                    T item = getNextContent();
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (item == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
                        _contentState.waitForContent(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
                    &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
                        consume(item, remaining(item));
                }
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
            }
            &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e)
            {
                LOG.debug(e);
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
            }
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I would first guess it&apos;s the change of not waiting for a new entity on item==null with  _contentState.waitForContent(this) anymore. The other change looks to be instead of just checking the error status at the start, we check it at the end.&lt;/p&gt;</comment>
                            <comment id="15085884" author="markrmiller@gmail.com" created="Wed, 6 Jan 2016 17:32:27 +0000"  >&lt;p&gt;If that change is the issue (and it was added in 9.3), it&apos;s this commit: &lt;a href=&quot;https://github.com/eclipse/jetty.project/commit/ebaf84b97ec50c6836c230f9068b46ad8030f974&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/eclipse/jetty.project/commit/ebaf84b97ec50c6836c230f9068b46ad8030f974&lt;/a&gt; Refactored HttpInput to use poison pills&lt;/p&gt;

&lt;p&gt;I don&apos;t see any tracking issue for it.&lt;/p&gt;</comment>
                            <comment id="15086065" author="markrmiller@gmail.com" created="Wed, 6 Jan 2016 18:57:27 +0000"  >&lt;p&gt;Yup, seems to go away with this hack:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; consumeAll()
    {
        &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (_inputQ)
        {
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
            {
                &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!isFinished())
                {
                    Content item = nextContent();
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (item == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                      blockForContent();
                      item = nextContent();
                     }

                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (item != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) skip(item, remaining(item));
                }
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
            }
            &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e)
            {
                LOG.debug(e);
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
            }
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15087580" author="yseeley@gmail.com" created="Thu, 7 Jan 2016 15:31:59 +0000"  >&lt;p&gt;Nice find!&lt;/p&gt;

&lt;p&gt;I&apos;ve been messing around on the client side with HttpURLConnection and raw sockets.&lt;/p&gt;

&lt;p&gt;Even with HttpURLConnection (the stuff built into the JVM) I can&apos;t even get the status code...&lt;br/&gt;
The server has probably written the error response, but the client side wants to push the complete request before looking at it I guess:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Caused by: java.io.IOException: Error writing to server
	at sun.net.www.protocol.http.HttpURLConnection.writeRequests(HttpURLConnection.java:665)
	at sun.net.www.protocol.http.HttpURLConnection.writeRequests(HttpURLConnection.java:677)
	at sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1533)
	at sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1440)
	at java.net.HttpURLConnection.getResponseCode(HttpURLConnection.java:480)
	at org.apache.solr.client.solrj.TestSolrJErrorHandling.testHttpURLConnection(TestSolrJErrorHandling.java:242)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Catching the exception and trying to get the errorStream also doesn&apos;t work.&lt;/p&gt;

&lt;p&gt;Anyway, I had a thought that even if we could fix this in the SolrJ clients, there are a lot of other clients out there that will get bitten by this.&lt;br/&gt;
Regardless of what improvements we make to SolrJ, it seems like we should roll back the Jetty upgrade.&lt;/p&gt;</comment>
                            <comment id="15087612" author="joakime" created="Thu, 7 Jan 2016 15:56:46 +0000"  >&lt;p&gt;You should probably have reached out to us (at Jetty) as soon as you discovered this.&lt;br/&gt;
Before you even dug into the Jetty source.  &lt;/p&gt;

&lt;p&gt;Do you have a wireshark capture of this behavior?&lt;br/&gt;
Lets see what is happening on the network first.&lt;/p&gt;</comment>
                            <comment id="15087662" author="markrmiller@gmail.com" created="Thu, 7 Jan 2016 16:32:29 +0000"  >&lt;p&gt;I think someone reached out to the Jetty project in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7339&quot; title=&quot;Upgrade Jetty from 9.2 to 9.3&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7339&quot;&gt;&lt;del&gt;SOLR-7339&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I&apos;ll attach a wireshark log I have.&lt;/p&gt;

&lt;p&gt;Wireshark and debug logs all confirm this change in behavior.&lt;/p&gt;</comment>
                            <comment id="15087671" author="markrmiller@gmail.com" created="Thu, 7 Jan 2016 16:39:35 +0000"  >&lt;blockquote&gt;&lt;p&gt;Anyway, I had a thought that even if we could fix this in the SolrJ clients, there are a lot of other clients out there that will get bitten by this.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I would think so. It seems to just be a matter of if the client pauses sending the request long enough to get cut off. We are able to trigger it so easily because ConcurrentUpdateSolrClient will generally pause 250 ms after adding a single doc. A GC event or load or something of the like could cause the same thing.&lt;/p&gt;</comment>
                            <comment id="15087912" author="jira-bot" created="Thu, 7 Jan 2016 19:22:24 +0000"  >&lt;p&gt;Commit 1723613 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yonik%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;yonik@apache.org&quot;&gt;yonik@apache.org&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1723613&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1723613&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8453&quot; title=&quot;Jetty update from 9.2 to 9.3 causes the server to reset formerly legitimate client connections.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8453&quot;&gt;&lt;del&gt;SOLR-8453&lt;/del&gt;&lt;/a&gt;: test HTTP client error responses&lt;/p&gt;</comment>
                            <comment id="15088327" author="gregw@webtide.com" created="Thu, 7 Jan 2016 22:57:57 +0000"  >&lt;p&gt;Copying this comment over from the jetty-users discussion (and expanding somewhat)&lt;/p&gt;

&lt;p&gt;This is indeed a change in behaviour in jetty 9.3, but not one that should affect any application.&lt;/p&gt;

&lt;p&gt;The problem with consumeAll previously is that it was an unlimited commitment - a client could send chunks forever and consume a thread forever. The only reason we need to consume all is to maintain a persistent connection.   But a server is under no obligation to maintain a persistent connection (even if the application consumes all the request data).  So if jetty doesn&apos;t consumeAll, we can close that connection and the client needs to start a new one.&lt;/p&gt;

&lt;p&gt;So the approach that 9.3 takes is that if the application has not read all it&apos;s content (which is normally an error condition of the application), then jetty will make a best effort attempt to read the content, but only if it can do so without blocking.  If it has to block - it gives up and the connection is closed.   The decision is that it is better to throw away the connection rather than commit to blocking for an unknown period of time.   This is more important now as apps are using the async APIs and are configured with minimal threadpools - thus we need to avoid places where the container can block and consume the thread pool (and thus be vulnerable to DOS attacks).&lt;/p&gt;

&lt;p&gt;So your client needs to be more robust in this circumstance and/or your application should make a better attempt to consume all the data.&lt;/p&gt;

&lt;p&gt;Even if we reinstated the behaviour in jetty - it would really just be happenstance that your client works and intermediaries/proxies could change the behaviour.&lt;/p&gt;</comment>
                            <comment id="15088394" author="gregw@webtide.com" created="Thu, 7 Jan 2016 23:40:37 +0000"  >&lt;p&gt;Note I just added a comment on 7339 - that this can be worked around by adding a filter that consumes all the content.   But the client should still be fixed IMHO.&lt;/p&gt;</comment>
                            <comment id="15088495" author="jira-bot" created="Fri, 8 Jan 2016 00:45:04 +0000"  >&lt;p&gt;Commit 1723646 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tflobbe&quot; class=&quot;user-hover&quot; rel=&quot;tflobbe&quot;&gt;tflobbe&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1723646&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1723646&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8453&quot; title=&quot;Jetty update from 9.2 to 9.3 causes the server to reset formerly legitimate client connections.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8453&quot;&gt;&lt;del&gt;SOLR-8453&lt;/del&gt;&lt;/a&gt;: Fix precommit&lt;/p&gt;</comment>
                            <comment id="15088501" author="markrmiller@gmail.com" created="Fri, 8 Jan 2016 00:50:35 +0000"  >&lt;blockquote&gt;&lt;p&gt;But the client should still be fixed IMHO.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;On the Jetty mailing list you mentioned that Apache HttpClient seemed to be acting reasonably. I&apos;m not sure how that relates to this comment about the client being fixed?&lt;/p&gt;</comment>
                            <comment id="15088506" author="markrmiller@gmail.com" created="Fri, 8 Jan 2016 00:55:35 +0000"  >&lt;p&gt;To expand:&lt;/p&gt;

&lt;p&gt;If HttpClient is behaving reasonably by throwing an exception about connection reset, Solr cannot get the actual server exception, which is essential to our proper operation. I don&apos;t see what we can do as a client without changes to HttpClient.&lt;/p&gt;</comment>
                            <comment id="15088651" author="gregw@webtide.com" created="Fri, 8 Jan 2016 03:40:51 +0000"  >
&lt;p&gt;Ah - well I&apos;ve evolved my view a bit, although the client (as in the part that uses the HttpClient) may need to be fixed.&lt;/p&gt;

&lt;p&gt;To repeat what I stated on the jetty-user list, I think both client and server are acting reasonably.   Jetty sees an application return without having consumed all of a request - it assumes this is an error condition, makes a best effort attempt to consume, but when that requires blocking decides to close the connection before all the content is sent.&lt;/p&gt;

&lt;p&gt;The HttpClient is sending a chunked body and the connection is closed before it sends the terminal chunk, so apache is correct to return an exceptional condition to the client application, as the request did not end correctly.   I guess the HttpClient could potentially do better by making the status received in the response available, but then it is in a race because the close may occur prior to the response being read/parsed/processed.&lt;/p&gt;

&lt;p&gt;So if the client applications cannot be made more robust - ie it can&apos;t reasonably handle such connection failures without knowing the status code, then the best solution is to avoid the server creating the ambiguity in the first place.   If it is important for the client that all the content is consumed, then the server application should consume all the content, even if there is an error.    A filter can achieve that or perhaps a sendError wrapper.&lt;/p&gt;

&lt;p&gt;We really don&apos;t want Jetty to have to do this consumeAll, because we then cannot protect asynchronous apps with small thread pools from DOS attacks.   &lt;/p&gt;

&lt;p&gt;cheers&lt;/p&gt;



</comment>
                            <comment id="15088670" author="markrmiller@gmail.com" created="Fri, 8 Jan 2016 04:14:24 +0000"  >&lt;p&gt;Okay here is a patch that has the filter read out the inputstream on errors.&lt;/p&gt;</comment>
                            <comment id="15088691" author="markrmiller@gmail.com" created="Fri, 8 Jan 2016 04:34:04 +0000"  >&lt;blockquote&gt;&lt;p&gt;So if the client applications cannot be made more robust - ie it can&apos;t reasonably handle such connection failures without knowing the status code&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t think we can. As a user of HttpClient, we don&apos;t care about the connection reset. We do care about the error on the server though. We would want to be able to get the error, and ignore that we won&apos;t be reusing that connection. Solr wants connection reuse, but we don&apos;t want to be interrupted when it doesn&apos;t happen (especially if that also means we don&apos;t get the server error). I don&apos;t think we can get that option in the short term though, so best bet seems to be as you suggest in a filter.&lt;/p&gt;</comment>
                            <comment id="15088866" author="jira-bot" created="Fri, 8 Jan 2016 08:07:45 +0000"  >&lt;p&gt;Commit 1723660 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thetaphi&quot; class=&quot;user-hover&quot; rel=&quot;thetaphi&quot;&gt;thetaphi&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1723660&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1723660&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8453&quot; title=&quot;Jetty update from 9.2 to 9.3 causes the server to reset formerly legitimate client connections.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8453&quot;&gt;&lt;del&gt;SOLR-8453&lt;/del&gt;&lt;/a&gt;: Fix raw socket test to correctly use HTTP spec: headers in HTTP are US-ASCII, body&apos;s Content-Length is number of bytes (not chars!), PrintWriter swallows Exceptions and was not needed (Forbidden apis found the bug, but fix was incorrect)&lt;/p&gt;</comment>
                            <comment id="15089498" author="yseeley@gmail.com" created="Fri, 8 Jan 2016 16:56:21 +0000"  >&lt;blockquote&gt;&lt;p&gt;I guess the HttpClient could potentially do better by making the status received in the response available, but then it is in a race because the close may occur prior to the response being read/parsed/processed.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Not sure I understand this part.  At the OS/socket level, the server can send the response and immediately close the socket, and the client (if written properly) can always read the response.&lt;/p&gt;</comment>
                            <comment id="15093917" author="markrmiller@gmail.com" created="Tue, 12 Jan 2016 14:05:30 +0000"  >&lt;p&gt;I think this patch is okay. I change consomeInput to not throw out an Exception , instead we just log it, and I added a bit of doc that links to this JIRA.&lt;/p&gt;</comment>
                            <comment id="15094203" author="yseeley@gmail.com" created="Tue, 12 Jan 2016 16:33:40 +0000"  >&lt;p&gt;+1, looks fine.&lt;/p&gt;</comment>
                            <comment id="15095619" author="gregw@webtide.com" created="Wed, 13 Jan 2016 05:07:16 +0000"  >&lt;p&gt;It depends on how the socket is closed.   If the socket is RST rather than FIN&apos;d then it is possible for the RST to overtake sent data - ie to cause some kind of exception with unconsumed data in a buffer.  I have no idea if that is really the case or not.&lt;/p&gt;

&lt;p&gt;Jetty will to a proper close only if it has completed a HTTP message.  Otherwise the close may be more brutal and may result in a RST (not directly under the control of java).&lt;/p&gt;</comment>
                            <comment id="15096467" author="jira-bot" created="Wed, 13 Jan 2016 16:24:08 +0000"  >&lt;p&gt;Commit 1724450 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1724450&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1724450&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8453&quot; title=&quot;Jetty update from 9.2 to 9.3 causes the server to reset formerly legitimate client connections.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8453&quot;&gt;&lt;del&gt;SOLR-8453&lt;/del&gt;&lt;/a&gt;: Solr should attempt to consume the request inputstream on errors as we cannot count on the container to do it.&lt;/p&gt;</comment>
                            <comment id="15096486" author="jira-bot" created="Wed, 13 Jan 2016 16:30:53 +0000"  >&lt;p&gt;Commit 1724457 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1724457&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1724457&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8453&quot; title=&quot;Jetty update from 9.2 to 9.3 causes the server to reset formerly legitimate client connections.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8453&quot;&gt;&lt;del&gt;SOLR-8453&lt;/del&gt;&lt;/a&gt;: Solr should attempt to consume the request inputstream on errors as we cannot count on the container to do it.&lt;/p&gt;</comment>
                            <comment id="15097316" author="jira-bot" created="Wed, 13 Jan 2016 23:58:07 +0000"  >&lt;p&gt;Commit 1724529 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1724529&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1724529&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8453&quot; title=&quot;Jetty update from 9.2 to 9.3 causes the server to reset formerly legitimate client connections.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8453&quot;&gt;&lt;del&gt;SOLR-8453&lt;/del&gt;&lt;/a&gt;: Only consume input here if exp != null, otherwise it is done in writeResponse.&lt;/p&gt;</comment>
                            <comment id="15097318" author="jira-bot" created="Wed, 13 Jan 2016 23:59:04 +0000"  >&lt;p&gt;Commit 1724530 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1724530&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1724530&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8453&quot; title=&quot;Jetty update from 9.2 to 9.3 causes the server to reset formerly legitimate client connections.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8453&quot;&gt;&lt;del&gt;SOLR-8453&lt;/del&gt;&lt;/a&gt;: Only consume input here if exp != null, otherwise it is done in writeResponse.&lt;/p&gt;</comment>
                            <comment id="15149094" author="markrmiller@gmail.com" created="Tue, 16 Feb 2016 18:57:05 +0000"  >&lt;p&gt;Seems only doing this on errors is not enough. I&apos;m looking at upgrading Jetty again and still see a bunch of connection resets now unless I make sure to always fully consume the stream.&lt;/p&gt;</comment>
                            <comment id="15150173" author="gregw@webtide.com" created="Wed, 17 Feb 2016 09:26:32 +0000"  >&lt;p&gt;If solr is in the habit of not consuming the content AND is particular about how such connections are closed/reused, then I believe a filter should be applied to all requests.&lt;br/&gt;
I will have a look again to see if jetty can provide consumeAll behaviour as an option, but I really think that is just making solr dependent on a container features... as it was when it assumed the container would consume all of the input on it&apos;s behalf - which is behaviour not covered by any spec I know of.&lt;/p&gt;

&lt;p&gt;Other than that, you could make a feature request on the client to be able to handle request sending errors separately to response processing.  Ie in this case may receive a valid response and the request body send still failed.&lt;/p&gt;
</comment>
                            <comment id="15150629" author="markrmiller@gmail.com" created="Wed, 17 Feb 2016 15:20:07 +0000"  >&lt;p&gt;Yeah, we are doing it in a filter, but we were just doing it on failures. I suspect some other code changes have exposed that we really should be doing it every request, but I&apos;ve made that change. Currently, we don&apos;t really want the client or server to give up early in any case if we can help it. Since this issue is released, I filed a new JIRA for it, &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8683&quot; title=&quot;Always consume the full request on the server, not just in the case of an error.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8683&quot;&gt;&lt;del&gt;SOLR-8683&lt;/del&gt;&lt;/a&gt; Always consume the full request on the server, not just in the case of an error.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12787439">SOLR-7339</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12923484">SOLR-8451</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12939589">SOLR-8683</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12781828" name="SOLR-8453.patch" size="2629" author="markrmiller@gmail.com" created="Tue, 12 Jan 2016 14:05:30 +0000"/>
                            <attachment id="12781137" name="SOLR-8453.patch" size="2337" author="markrmiller@gmail.com" created="Fri, 8 Jan 2016 04:14:24 +0000"/>
                            <attachment id="12779137" name="SOLR-8453.patch" size="39148" author="markrmiller@gmail.com" created="Tue, 22 Dec 2015 21:57:08 +0000"/>
                            <attachment id="12779075" name="SOLR-8453.patch" size="35210" author="markrmiller@gmail.com" created="Tue, 22 Dec 2015 15:46:01 +0000"/>
                            <attachment id="12779066" name="SOLR-8453.patch" size="32015" author="markrmiller@gmail.com" created="Tue, 22 Dec 2015 14:59:39 +0000"/>
                            <attachment id="12779056" name="SOLR-8453.patch" size="32207" author="markrmiller@gmail.com" created="Tue, 22 Dec 2015 14:07:08 +0000"/>
                            <attachment id="12778976" name="SOLR-8453.patch" size="28116" author="markrmiller@gmail.com" created="Tue, 22 Dec 2015 03:37:05 +0000"/>
                            <attachment id="12778970" name="SOLR-8453.patch" size="6819" author="markrmiller@gmail.com" created="Tue, 22 Dec 2015 02:45:45 +0000"/>
                            <attachment id="12778901" name="SOLR-8453.patch" size="19374" author="markrmiller@gmail.com" created="Mon, 21 Dec 2015 20:24:25 +0000"/>
                            <attachment id="12780587" name="SOLR-8453_test.patch" size="6518" author="yseeley@gmail.com" created="Tue, 5 Jan 2016 17:58:41 +0000"/>
                            <attachment id="12780581" name="SOLR-8453_test.patch" size="5957" author="yseeley@gmail.com" created="Tue, 5 Jan 2016 17:25:47 +0000"/>
                            <attachment id="12780998" name="jetty9.2.pcapng" size="560464" author="markrmiller@gmail.com" created="Thu, 7 Jan 2016 16:33:42 +0000"/>
                            <attachment id="12780999" name="jetty9.3.pcapng" size="567256" author="markrmiller@gmail.com" created="Thu, 7 Jan 2016 16:33:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>13.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 39 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2q6i7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>