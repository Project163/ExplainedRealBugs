<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:33:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-4300] Possible race condition in CoreContainer.getCore() when lazily loading cores.</title>
                <link>https://issues.apache.org/jira/browse/SOLR-4300</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Yonik pointed out in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-1028&quot; title=&quot;Automatic core loading unloading for multicore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-1028&quot;&gt;&lt;del&gt;SOLR-1028&lt;/del&gt;&lt;/a&gt; that there is a possible race condition here, he&apos;s right not to my surprise. Calling it a &quot;blocker&quot; for now so we make a decision on it rather than let it fall through the cracks. I should be able to get a patch up tonight (Sunday).&lt;/p&gt;

&lt;p&gt;That said, there&apos;s potential here to introduce deadlocks, is it worth rushing into 4.1?&lt;/p&gt;</description>
                <environment></environment>
        <key id="12627353">SOLR-4300</key>
            <summary>Possible race condition in CoreContainer.getCore() when lazily loading cores.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sarowe">Steven Rowe</assignee>
                                    <reporter username="erickerickson">Erick Erickson</reporter>
                        <labels>
                    </labels>
                <created>Sun, 13 Jan 2013 18:07:34 +0000</created>
                <updated>Mon, 9 May 2016 18:56:38 +0000</updated>
                            <resolved>Wed, 16 Jan 2013 05:03:55 +0000</resolved>
                                    <version>4.1</version>
                    <version>6.0</version>
                                    <fixVersion>4.1</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13552407" author="erickerickson" created="Mon, 14 Jan 2013 03:05:30 +0000"  >&lt;p&gt;Definitely a race condition. This patch includes a test case that fails before the patch and succeeds after the patch. All tests pass.&lt;/p&gt;

&lt;p&gt;The question is whether or not this should be put into the 4.1 release, or held until 4.2. Of course I have the usual programmer&apos;s pride and want any of my code included in a release to be as good as I can make it, but I&apos;m also aware of the hazards of including changes like this late in the game. Not sure this will be widely enough used to warrant the risk....&lt;/p&gt;

&lt;p&gt;I don&apos;t &lt;em&gt;think&lt;/em&gt; there is an infinite loop here (the sleep), but then I always think my code is perfect. I think that if a core fails to load, the finally block will allow other threads to continue. They&apos;ll fail also assuming the underlying cause isn&apos;t fixed (say the lazily-loaded core configurations are mal-formed XML). But that&apos;s not something I think should be addressed in the code.&lt;/p&gt;</comment>
                            <comment id="13554325" author="erickerickson" created="Tue, 15 Jan 2013 20:54:39 +0000"  >&lt;p&gt;OK, I&apos;m going to commit this this evening or tomorrow morning for both trunk, 4.1 &amp;amp; 4.x unless there are objections. I&apos;ll take another detailed pass over the code before I do on the theory that anything stupid will be clearer after not looking at it for a while.&lt;/p&gt;

&lt;p&gt;My fears of deadlock are probably overblown. People don&apos;t &lt;em&gt;get&lt;/em&gt; to the code in question unless they&apos;re defining lazily-loaded cores, so &quot;It shouldn&apos;t affect anyone not using the new functionality&quot; (tm).&lt;/p&gt;
</comment>
                            <comment id="13554579" author="commit-tag-bot" created="Wed, 16 Jan 2013 00:50:21 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;trunk commit&amp;#93;&lt;/span&gt; Erick Erickson&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1433778&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1433778&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4300&quot; title=&quot;Possible race condition in CoreContainer.getCore() when lazily loading cores.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4300&quot;&gt;&lt;del&gt;SOLR-4300&lt;/del&gt;&lt;/a&gt;, possible race condition when loading lazy cores&lt;/p&gt;</comment>
                            <comment id="13554628" author="erickerickson" created="Wed, 16 Jan 2013 01:49:03 +0000"  >&lt;p&gt;trunk: r - 1433778&lt;br/&gt;
4.x:   r - 1433790&lt;br/&gt;
4.1:   r - 1433787&lt;/p&gt;</comment>
                            <comment id="13554633" author="commit-tag-bot" created="Wed, 16 Jan 2013 01:52:10 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;branch_4x commit&amp;#93;&lt;/span&gt; Erick Erickson&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1433790&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1433790&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4300&quot; title=&quot;Possible race condition in CoreContainer.getCore() when lazily loading cores.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4300&quot;&gt;&lt;del&gt;SOLR-4300&lt;/del&gt;&lt;/a&gt;, race condition when loading lazy cores from multiple threads&lt;/p&gt;</comment>
                            <comment id="13554741" author="steve_rowe" created="Wed, 16 Jan 2013 04:50:01 +0000"  >&lt;p&gt;Jenkins is unhappy:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Build: http://jenkins.thetaphi.de/job/Lucene-Solr-trunk-MacOSX/92/
Java: 64bit/jdk1.7.0 -XX:+UseSerialGC

1 tests failed.
FAILED:  junit.framework.TestSuite.org.apache.solr.core.TestLazyCores

Error Message:
Clean up static fields (in @AfterClass?), your test seems to hang on to approximately 13,549,312 bytes (threshold is 10,485,760). Field reference sizes (counted individually):   - 14,228,288 bytes, static java.util.List org.apache.solr.core.TestLazyCores._theCores   - 720 bytes, private static java.lang.String[] org.apache.solr.core.TestLazyCores._necessaryConfs   - 280 bytes, public static org.junit.rules.TestRule org.apache.solr.SolrTestCaseJ4.solrClassRules   - 240 bytes, protected static java.lang.String org.apache.solr.SolrTestCaseJ4.testSolrHome   - 128 bytes, private static java.lang.String org.apache.solr.SolrTestCaseJ4.factoryProp   - 64 bytes, private static java.lang.String org.apache.solr.SolrTestCaseJ4.coreName

Stack Trace:
junit.framework.AssertionFailedError: Clean up static fields (in @AfterClass?), your test seems to hang on to approximately 13,549,312 bytes (threshold is 10,485,760). Field reference sizes (counted individually):
 - 14,228,288 bytes, static java.util.List org.apache.solr.core.TestLazyCores._theCores
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I can reproduce this on my Mac.&lt;/p&gt;

&lt;p&gt;After applying the patch below converting the static field &lt;tt&gt;_theCores&lt;/tt&gt; into a local variable of the only method it&apos;s used in, I was able to successfully run &lt;tt&gt;ant test -Dtestcase=TestLazyCores -Dtests.dups=100&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Index: solr/core/src/test/org/apache/solr/core/TestLazyCores.java
===================================================================
--- solr/core/src/test/org/apache/solr/core/TestLazyCores.java	(revision 1433815)
+++ solr/core/src/test/org/apache/solr/core/TestLazyCores.java	(working copy)
@@ -248,10 +248,10 @@
     }
   }
 
-  &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; List&amp;lt;SolrCore&amp;gt; _theCores = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;SolrCore&amp;gt;();
   &lt;span class=&quot;code-comment&quot;&gt;// Test &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; SOLR-4300
&lt;/span&gt;   @Test
   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testRace() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
+    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; List&amp;lt;SolrCore&amp;gt; _theCores = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;SolrCore&amp;gt;();
     &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; CoreContainer cc = init();
     &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;ll commit this shortly.&lt;/p&gt;</comment>
                            <comment id="13554748" author="steve_rowe" created="Wed, 16 Jan 2013 05:03:55 +0000"  >&lt;p&gt;Committed the above patch to TestLazyCores on trunk, branch_4x and lucene_solr_4_1.&lt;/p&gt;</comment>
                            <comment id="13554749" author="commit-tag-bot" created="Wed, 16 Jan 2013 05:04:23 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;trunk commit&amp;#93;&lt;/span&gt; Steven Rowe&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1433823&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1433823&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4300&quot; title=&quot;Possible race condition in CoreContainer.getCore() when lazily loading cores.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4300&quot;&gt;&lt;del&gt;SOLR-4300&lt;/del&gt;&lt;/a&gt;: In TestLazyCores, convert static field into local variable to avoid post-test memory retention&lt;/p&gt;</comment>
                            <comment id="13554753" author="commit-tag-bot" created="Wed, 16 Jan 2013 05:14:17 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;branch_4x commit&amp;#93;&lt;/span&gt; Steven Rowe&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1433824&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1433824&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4300&quot; title=&quot;Possible race condition in CoreContainer.getCore() when lazily loading cores.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4300&quot;&gt;&lt;del&gt;SOLR-4300&lt;/del&gt;&lt;/a&gt;: In TestLazyCores, convert static field into local variable to avoid post-test memory retention&lt;/p&gt;</comment>
                            <comment id="13554991" author="erickerickson" created="Wed, 16 Jan 2013 12:37:26 +0000"  >&lt;p&gt;Duh. Thanks Steve! Some days I&apos;m the pigeon and some days I&apos;m the statue... Sigggghhh.&lt;/p&gt;</comment>
                            <comment id="13565715" author="yseeley@gmail.com" created="Tue, 29 Jan 2013 19:47:55 +0000"  >&lt;p&gt;I haven&apos;t had a chance to check out the whole patch in context... but if we get a chance to revisit at any point, it would probably be nicer to use a mechanism other than sleep/poll.  Either wait/notify or Future would seem to fit the bill.&lt;/p&gt;</comment>
                            <comment id="13565773" author="erickerickson" created="Tue, 29 Jan 2013 20:32:23 +0000"  >&lt;p&gt;It turns out that this code was already done for &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4196&quot; title=&quot;Untangle XML-specific nature of Config and Container classes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4196&quot;&gt;&lt;del&gt;SOLR-4196&lt;/del&gt;&lt;/a&gt;, of course that&apos;s not checked in yet. I&apos;ll see if I can do one of these in that code.&lt;/p&gt;

&lt;p&gt;Erick&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12415195">SOLR-1028</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12564653" name="SOLR-4300.patch" size="5537" author="erickerickson" created="Mon, 14 Jan 2013 03:05:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>304126</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 43 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i17jjb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>252134</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>