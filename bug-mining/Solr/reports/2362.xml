<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:03:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-7128] Two phase distributed search is fetching extra fields in GET_TOP_IDS phase</title>
                <link>https://issues.apache.org/jira/browse/SOLR-7128</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pqueixalos&quot; class=&quot;user-hover&quot; rel=&quot;pqueixalos&quot;&gt;pqueixalos&lt;/a&gt; reported this to me privately so I am creating this issue on his behalf.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;We found an issue in versions 4.10.+ (4.10.2 and 4.10.3 for sure).&lt;/p&gt;

&lt;p&gt;When processing a two phase distributed query with an explicit fl parameter, the two phases are well processed, but the GET_TOP_IDS retrieves the matching documents fields, even if a GET_FIELDS shard request is getting executed just after.&lt;/p&gt;

&lt;p&gt;/solr/someCollectionCore?collection=someOtherCollection&amp;amp;q=&lt;b&gt;:&lt;/b&gt;&amp;amp;debug=true&amp;amp;fl=id,title&lt;br/&gt;
=&amp;gt; id is retrieved during GET_TOP_IDS phase that&apos;s ok:: it&apos;s our uniqueKeyField&lt;br/&gt;
=&amp;gt; title is also retrieved during GET_TOP_IDS phase, that&apos;s not ok.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m able to reproduce this. This is pretty bad performance bug that was introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5768&quot; title=&quot;Add a distrib.singlePass parameter to make EXECUTE_QUERY phase fetch all fields and skip GET_FIELDS&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5768&quot;&gt;&lt;del&gt;SOLR-5768&lt;/del&gt;&lt;/a&gt; or it&apos;s subsequent related issues. I plan to fix this bug and add substantial tests to assert such things.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12776234">SOLR-7128</key>
            <summary>Two phase distributed search is fetching extra fields in GET_TOP_IDS phase</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shalin">Shalin Shekhar Mangar</assignee>
                                    <reporter username="shalin">Shalin Shekhar Mangar</reporter>
                        <labels>
                    </labels>
                <created>Thu, 19 Feb 2015 19:21:44 +0000</created>
                <updated>Wed, 2 Oct 2019 17:23:42 +0000</updated>
                            <resolved>Fri, 27 Feb 2015 19:45:58 +0000</resolved>
                                    <version>4.10.2</version>
                    <version>4.10.3</version>
                                    <fixVersion>4.10.4</fixVersion>
                    <fixVersion>5.1</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>search</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14333886" author="shalinmangar" created="Mon, 23 Feb 2015 22:11:39 +0000"  >&lt;p&gt;This was introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6796&quot; title=&quot;distrib.singlePass does not return correct set of fields for multi-fl-parameter requests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6796&quot;&gt;&lt;del&gt;SOLR-6796&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Here&apos;s a test which exposes this issue. &lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;I created a TrackingShardHandlerFactory which can record shard requests sent from any node. There are a few helper methods to get requests by shard and by purpose.&lt;/li&gt;
	&lt;li&gt;The new test TestTwoPhaseDistributedQuery uses this factory to assert the fields which are being requested in GET_TOP_IDS phase.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I will likely move the TrackingShardHandlerFactory into its own issue because it is helpful for other distributed tests as well. I also need to decouple it from the MiniSolrCloudCluster abstraction. I found a problem in MiniSolrCloudCluster too and opened &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7146&quot; title=&quot;MiniSolrCloudCluster based tests can fail with ZooKeeperException NoNode for /live_nodes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7146&quot;&gt;&lt;del&gt;SOLR-7146&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;m working on a fix.&lt;/p&gt;</comment>
                            <comment id="14334174" author="hossman" created="Tue, 24 Feb 2015 00:43:16 +0000"  >&lt;p&gt;I had a lot of feedback/ideas about the TrackingShardHandlerFactory, but not a lot of feedback/comments/ideas about the root issue here, so i went ahead and filed &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7147&quot; title=&quot;Introduce new TrackingShardHandlerFactory for monitoring what requests are sent to shards during tests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7147&quot;&gt;&lt;del&gt;SOLR-7147&lt;/del&gt;&lt;/a&gt; for you.&lt;/p&gt;</comment>
                            <comment id="14337134" author="shalinmangar" created="Wed, 25 Feb 2015 20:38:19 +0000"  >&lt;p&gt;This patch fixes the bug and modifies the DistributedQueryComponentOptimizationTest to use the TrackingShardHandlerFactory introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7147&quot; title=&quot;Introduce new TrackingShardHandlerFactory for monitoring what requests are sent to shards during tests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7147&quot;&gt;&lt;del&gt;SOLR-7147&lt;/del&gt;&lt;/a&gt;. I removed the TestTwoPhaseDistributedQuery test that I had introduced earlier.&lt;/p&gt;

&lt;p&gt;This test now asserts that every distrib.singlePass query:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Makes exactly &apos;numSlices&apos; number of shard requests&lt;/li&gt;
	&lt;li&gt;Makes no GET_FIELDS requests&lt;/li&gt;
	&lt;li&gt;Must request the unique key field from shards&lt;/li&gt;
	&lt;li&gt;Must request the score if &apos;fl&apos; has score or sort by score is requested&lt;/li&gt;
	&lt;li&gt;Requests all fields that are present in &apos;fl&apos; param&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;It also asserts that every regular two phase distribtued search:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Makes at most 2 * &apos;numSlices&apos; number of shard requests&lt;/li&gt;
	&lt;li&gt;Must request the unique key field from shards&lt;/li&gt;
	&lt;li&gt;Must request the score if &apos;fl&apos; has score or sort by score is requested&lt;/li&gt;
	&lt;li&gt;Requests no fields other than id and score in GET_TOP_IDS request&lt;/li&gt;
	&lt;li&gt;Requests exactly the fields that are present in &apos;fl&apos; param in GET_FIELDS request and no others&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;and also asserts that:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Each query which requests id or score or both behaves exactly like a single pass query&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="14337848" author="shalinmangar" created="Thu, 26 Feb 2015 04:22:40 +0000"  >&lt;p&gt;Updated patch. I moved my earlier Jira comment about the kind of assertions being made in this test to the Javadocs of the test method.&lt;/p&gt;

&lt;p&gt;All tests pass. ant precommit passes. I&apos;ll commit this shortly.&lt;/p&gt;</comment>
                            <comment id="14337915" author="erickerickson" created="Thu, 26 Feb 2015 05:32:45 +0000"  >&lt;p&gt;Shalin:&lt;/p&gt;

&lt;p&gt;I was looking at the fact that two-phase distributed search also &lt;em&gt;decompresses&lt;/em&gt; the doc to get the ID to pass back to the aggregator on the first pass, on the surface I don&apos;t see why all the fields that need to be passed back can&apos;t be taken from indexed terms, i.e. the ID and sort criteria for each doc &lt;em&gt;better&lt;/em&gt; be indexed terms. see: &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6888&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-6888&lt;/a&gt;, and one comment was that &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6810&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-6810&lt;/a&gt; would take care of this.&lt;/p&gt;

&lt;p&gt;Just wondering how this issue relates to those two for my background.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="14337975" author="shalinmangar" created="Thu, 26 Feb 2015 06:30:44 +0000"  >&lt;p&gt;I reverted some of my changes to QueryComponent because I realised the duplicate field names aren&apos;t really a problem because SolrReturnFields maintains a Set of them. My logic not to add duplicate &apos;id&apos; fields was just making it more complicated for no reason. However, I feel that it could be simplified more but perhaps some other time.&lt;/p&gt;</comment>
                            <comment id="14337984" author="shalinmangar" created="Thu, 26 Feb 2015 06:35:40 +0000"  >&lt;p&gt;Erick, this is a different bug. The bug is that the complete list of fields from the &apos;fl&apos; param were being requested in the first phase of distributed search. Really only id and/or score is required in this first phase with the current distributed search algorithm.&lt;/p&gt;

&lt;p&gt;How those fields are actually retrieved by a shard is the subject of &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6888&quot; title=&quot;Decompressing documents on first-pass distributed queries to get docId is inefficient, use indexed values instead?&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6888&quot;&gt;&lt;del&gt;SOLR-6888&lt;/del&gt;&lt;/a&gt; and whether id is really required to be fetched at all is the subject of &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6810&quot; title=&quot;Faster searching limited but high rows across many shards all with many hits&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6810&quot;&gt;SOLR-6810&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14338005" author="jira-bot" created="Thu, 26 Feb 2015 06:50:26 +0000"  >&lt;p&gt;Commit 1662366 from shalin@apache.org in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1662366&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1662366&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7128&quot; title=&quot;Two phase distributed search is fetching extra fields in GET_TOP_IDS phase&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7128&quot;&gt;&lt;del&gt;SOLR-7128&lt;/del&gt;&lt;/a&gt;: Two phase distributed search is fetching extra fields in GET_TOP_IDS phase&lt;/p&gt;</comment>
                            <comment id="14338011" author="jira-bot" created="Thu, 26 Feb 2015 06:52:58 +0000"  >&lt;p&gt;Commit 1662367 from shalin@apache.org in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1662367&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1662367&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7128&quot; title=&quot;Two phase distributed search is fetching extra fields in GET_TOP_IDS phase&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7128&quot;&gt;&lt;del&gt;SOLR-7128&lt;/del&gt;&lt;/a&gt;: Two phase distributed search is fetching extra fields in GET_TOP_IDS phase&lt;/p&gt;</comment>
                            <comment id="14339960" author="mikemccand" created="Fri, 27 Feb 2015 10:04:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt; looks like this is done?  Is the fix low-risk?  Since I haven&apos;t managed to cut a 4.10.4 yet (various fun Lucene issues...) maybe it makes sense to backport for 4.10.4?&lt;/p&gt;</comment>
                            <comment id="14340130" author="shalinmangar" created="Fri, 27 Feb 2015 13:44:23 +0000"  >&lt;p&gt;Hoss prodded me privately about the duplicate field names being requested in shard requests (thanks Hoss!) so I refactored the field modifying logic so that duplicates aren&apos;t possible. I also added more tests with no &apos;fl&apos;, fl=* and fl=*,score in both single pass and regular search.&lt;/p&gt;</comment>
                            <comment id="14340311" author="jira-bot" created="Fri, 27 Feb 2015 15:52:38 +0000"  >&lt;p&gt;Commit 1662729 from shalin@apache.org in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1662729&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1662729&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7128&quot; title=&quot;Two phase distributed search is fetching extra fields in GET_TOP_IDS phase&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7128&quot;&gt;&lt;del&gt;SOLR-7128&lt;/del&gt;&lt;/a&gt;: Make sure fields aren&apos;t duplicated in shard requests&lt;/p&gt;</comment>
                            <comment id="14340314" author="jira-bot" created="Fri, 27 Feb 2015 15:56:05 +0000"  >&lt;p&gt;Commit 1662730 from shalin@apache.org in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1662730&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1662730&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7128&quot; title=&quot;Two phase distributed search is fetching extra fields in GET_TOP_IDS phase&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7128&quot;&gt;&lt;del&gt;SOLR-7128&lt;/del&gt;&lt;/a&gt;: Make sure fields aren&apos;t duplicated in shard requests&lt;/p&gt;</comment>
                            <comment id="14340688" author="jira-bot" created="Fri, 27 Feb 2015 19:37:26 +0000"  >&lt;p&gt;Commit 1662802 from shalin@apache.org in branch &apos;dev/branches/lucene_solr_4_10&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1662802&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1662802&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7128&quot; title=&quot;Two phase distributed search is fetching extra fields in GET_TOP_IDS phase&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7128&quot;&gt;&lt;del&gt;SOLR-7128&lt;/del&gt;&lt;/a&gt;: Two phase distributed search is fetching extra fields in GET_TOP_IDS phase&lt;/p&gt;</comment>
                            <comment id="14340694" author="shalinmangar" created="Fri, 27 Feb 2015 19:42:28 +0000"  >&lt;blockquote&gt;&lt;p&gt;Since I haven&apos;t managed to cut a 4.10.4 yet (various fun Lucene issues...) maybe it makes sense to backport for 4.10.4?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thanks for waiting &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mikemccand&quot; class=&quot;user-hover&quot; rel=&quot;mikemccand&quot;&gt;mikemccand&lt;/a&gt;! The test actually took some time to back-port because of so many changes in Solr&apos;s test suite between 4.x and 5.0.&lt;/p&gt;

&lt;p&gt;Note to anyone who reviews my 4.10 commit &amp;#8211; I had to change the solr-trackingshardhandler.xml to use the old style solr.xml otherwise it wouldn&apos;t load collection1. Since there was no time to find/fix any bugs, I chose the easy way and changed the format of solr.xml itself. I verified that the TestTrackingShardHandler factory still tests the right things and passes.&lt;/p&gt;</comment>
                            <comment id="14348910" author="mikemccand" created="Thu, 5 Mar 2015 15:36:28 +0000"  >&lt;p&gt;Bulk close for 4.10.4 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12777002">SOLR-7147</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12701358" name="SOLR-7128-addendum.patch" size="7069" author="shalin" created="Fri, 27 Feb 2015 13:44:23 +0000"/>
                            <attachment id="12700985" name="SOLR-7128.patch" size="19770" author="shalin" created="Thu, 26 Feb 2015 06:30:44 +0000"/>
                            <attachment id="12700967" name="SOLR-7128.patch" size="19713" author="shalin" created="Thu, 26 Feb 2015 04:22:40 +0000"/>
                            <attachment id="12700853" name="SOLR-7128.patch" size="18494" author="shalin" created="Wed, 25 Feb 2015 20:38:19 +0000"/>
                            <attachment id="12700273" name="SOLR-7128.patch" size="17629" author="shalin" created="Mon, 23 Feb 2015 22:11:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 37 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i25tlj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>