<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:02:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-6969] When opening an HDFSTransactionLog for append we must first attempt to recover it&apos;s lease to prevent data loss.</title>
                <link>https://issues.apache.org/jira/browse/SOLR-6969</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;This can happen after a hard crash and restart. The current workaround is to stop and wait it out and start again. We should retry and wait a given amount of time as we do when we detect safe mode though.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12766902">SOLR-6969</key>
            <summary>When opening an HDFSTransactionLog for append we must first attempt to recover it&apos;s lease to prevent data loss.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="markrmiller@gmail.com">Mark Miller</assignee>
                                    <reporter username="markrmiller@gmail.com">Mark Miller</reporter>
                        <labels>
                    </labels>
                <created>Mon, 12 Jan 2015 18:05:07 +0000</created>
                <updated>Sat, 2 Feb 2019 17:39:34 +0000</updated>
                            <resolved>Mon, 2 Mar 2015 04:46:15 +0000</resolved>
                                                    <fixVersion>5.0</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>hdfs</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14274046" author="markrmiller@gmail.com" created="Mon, 12 Jan 2015 19:48:01 +0000"  >&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR - 2015-01-12 17:49:43.992; org.apache.solr.common.SolrException; Failure to open existing log file (non fatal) hdfs://localhost:8020/solr_test/collection1/core_node1/data/tlog/tlog.0000000000000000000:org.apache.solr.common.SolrException: org.apache.hadoop.ipc.RemoteException(org.apache.hadoop.hdfs.protocol.RecoveryInProgressException): Failed to close file /solr_test/collection1/core_node1/data/tlog/tlog.0000000000000000000. Lease recovery is in progress. Try again later.
	at org.apache.hadoop.hdfs.server.namenode.FSNamesystem.recoverLeaseInternal(FSNamesystem.java:2626)
	at org.apache.hadoop.hdfs.server.namenode.FSNamesystem.appendFileInternal(FSNamesystem.java:2462)
	at org.apache.hadoop.hdfs.server.namenode.FSNamesystem.appendFileInt(FSNamesystem.java:2700)
	at org.apache.hadoop.hdfs.server.namenode.FSNamesystem.appendFile(FSNamesystem.java:2663)
	at org.apache.hadoop.hdfs.server.namenode.NameNodeRpcServer.append(NameNodeRpcServer.java:559)
	at org.apache.hadoop.hdfs.protocolPB.ClientNamenodeProtocolServerSideTranslatorPB.append(ClientNamenodeProtocolServerSideTranslatorPB.java:388)
	at org.apache.hadoop.hdfs.protocol.proto.ClientNamenodeProtocolProtos$ClientNamenodeProtocol$2.callBlockingMethod(ClientNamenodeProtocolProtos.java)
	at org.apache.hadoop.ipc.ProtobufRpcEngine$Server$ProtoBufRpcInvoker.call(ProtobufRpcEngine.java:585)
	at org.apache.hadoop.ipc.RPC$Server.call(RPC.java:928)
	at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:2013)
	at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:2009)
	at java.security.AccessController.doPrivileged(Native Method)
	at javax.security.auth.Subject.doAs(Subject.java:422)
	at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1614)
	at org.apache.hadoop.ipc.Server$Handler.run(Server.java:2007)

	at org.apache.solr.update.HdfsTransactionLog.&amp;lt;init&amp;gt;(HdfsTransactionLog.java:121)
	at org.apache.solr.update.HdfsUpdateLog.init(HdfsUpdateLog.java:190)
	at org.apache.solr.update.UpdateHandler.&amp;lt;init&amp;gt;(UpdateHandler.java:134)
	at org.apache.solr.update.UpdateHandler.&amp;lt;init&amp;gt;(UpdateHandler.java:94)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14274244" author="markrmiller@gmail.com" created="Mon, 12 Jan 2015 22:00:38 +0000"  >&lt;p&gt;Praneeth also mentions seeing AlreadyBeingCreatedException in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6367&quot; title=&quot;empty tlog on HDFS when hard crash - no docs to replay on recovery&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6367&quot;&gt;&lt;del&gt;SOLR-6367&lt;/del&gt;&lt;/a&gt; - we should deal with that as well.&lt;/p&gt;</comment>
                            <comment id="14276292" author="mdrob" created="Wed, 14 Jan 2015 00:48:37 +0000"  >&lt;p&gt;Ignoring the error itself for a moment, the error message is also really confusing. It starts with &quot;Failure to open existing log file&quot; and then later in the same line is &quot;Failed to close file.&quot;&lt;/p&gt;

&lt;p&gt;For SafeMode it looks like we retry indefinitely. Do we want to exhibit the same behaviour here?&lt;/p&gt;</comment>
                            <comment id="14276299" author="markrmiller@gmail.com" created="Wed, 14 Jan 2015 00:54:45 +0000"  >&lt;p&gt;Safe mode can be turned on and off by the user, so we retry without limit. It seems this should be a bound wait though.&lt;/p&gt;</comment>
                            <comment id="14284016" author="anshumg" created="Tue, 20 Jan 2015 17:03:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; do you intend to get this in for 5.0? I&apos;m asking as this has been marked as critical for this release.&lt;/p&gt;</comment>
                            <comment id="14286485" author="mdrob" created="Wed, 21 Jan 2015 22:59:08 +0000"  >&lt;p&gt;Is retrying always going to be safe? That works fine after we&apos;ve lost a server and started a new one (albeit too quickly) but what about the case where two servers both think they are responsible for that tlog? This can happen if the original server partially dies, but still has some threads that are doing work and haven&apos;t been cleaned up.&lt;/p&gt;

&lt;p&gt;Looking at how other projects handle similar issues - HBase moves the entire directory&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; to break any existing leases and ensure any other processes gets kicked out. Maybe a retry is a good stop-gap, but is it going to be a full solution?&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;: &lt;a href=&quot;https://github.com/apache/hbase/blob/master/hbase-server/src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java#L310&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hbase/blob/master/hbase-server/src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java#L310&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14286892" author="markrmiller@gmail.com" created="Thu, 22 Jan 2015 03:21:08 +0000"  >&lt;p&gt;You can&apos;t have two Solr severs trying to access the same files when configured properly. The index lock will prevent this before you get to tlog files. &lt;/p&gt;

&lt;p&gt;I do think a long term / full solution requires some discussion with some hdfs guys. I talked to Colin a little about it today. Sounds like it&apos;s kind of an ugly situation. &lt;/p&gt;</comment>
                            <comment id="14286894" author="markrmiller@gmail.com" created="Thu, 22 Jan 2015 03:22:23 +0000"  >&lt;p&gt;Part of the problem is that we don&apos;t want to diverge from how things work with local file system as much as we can.&lt;/p&gt;</comment>
                            <comment id="14286910" author="anshumg" created="Thu, 22 Jan 2015 03:36:57 +0000"  >&lt;p&gt;So it&apos;s certainly not for 5.0, right?&lt;/p&gt;</comment>
                            <comment id="14295307" author="markrmiller@gmail.com" created="Wed, 28 Jan 2015 15:43:55 +0000"  >&lt;p&gt;Colin pointed us to &lt;a href=&quot;https://github.com/apache/hbase/blob/833feefbf977a8208f8f71f5f3bd9b027d54961f/hbase-server/src/main/java/org/apache/hadoop/hbase/util/FSHDFSUtils.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hbase/blob/833feefbf977a8208f8f71f5f3bd9b027d54961f/hbase-server/src/main/java/org/apache/hadoop/hbase/util/FSHDFSUtils.java&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14296043" author="markrmiller@gmail.com" created="Wed, 28 Jan 2015 23:27:11 +0000"  >&lt;p&gt;Here is a first patch.&lt;/p&gt;</comment>
                            <comment id="14296076" author="markrmiller@gmail.com" created="Wed, 28 Jan 2015 23:48:01 +0000"  >&lt;blockquote&gt;&lt;p&gt;Ignoring the error itself for a moment, the error message is also really confusing. It starts with &quot;Failure to open existing log file&quot; and then later in the same line is &quot;Failed to close file.&quot;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It&apos;s two different things. The high level log item says that there was a &quot;Failure to open existing log file&quot;. It shows the cause of this as RecoveryInProgressException and that has a message that let&apos;s you know that the problem was &quot;Failed to close file.&quot;. Which is what happened. If the file had been properly closed previously (no -9, bug, OOM, etc), you would not have an outstanding lease that causes this issue.&lt;/p&gt;</comment>
                            <comment id="14296382" author="markrmiller@gmail.com" created="Thu, 29 Jan 2015 05:11:01 +0000"  >&lt;p&gt;Patch adds a basic test to hit the lease recovery path.&lt;/p&gt;</comment>
                            <comment id="14297162" author="jira-bot" created="Thu, 29 Jan 2015 17:22:44 +0000"  >&lt;p&gt;Commit 1655754 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1655754&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1655754&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6969&quot; title=&quot;When opening an HDFSTransactionLog for append we must first attempt to recover it&amp;#39;s lease to prevent data loss.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6969&quot;&gt;&lt;del&gt;SOLR-6969&lt;/del&gt;&lt;/a&gt;: When opening an HDFSTransactionLog for append we must first attempt to recover  it&apos;s lease to prevent data loss.&lt;/p&gt;</comment>
                            <comment id="14297166" author="jira-bot" created="Thu, 29 Jan 2015 17:23:28 +0000"  >&lt;p&gt;Commit 1655756 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1655756&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1655756&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6969&quot; title=&quot;When opening an HDFSTransactionLog for append we must first attempt to recover it&amp;#39;s lease to prevent data loss.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6969&quot;&gt;&lt;del&gt;SOLR-6969&lt;/del&gt;&lt;/a&gt;: When opening an HDFSTransactionLog for append we must first attempt to recover  it&apos;s lease to prevent data loss.&lt;/p&gt;</comment>
                            <comment id="14297175" author="markrmiller@gmail.com" created="Thu, 29 Jan 2015 17:25:36 +0000"  >&lt;p&gt;The testing could be improved, but I have added a basic test to hit the code path and did a bunch of manual testing so that we can get this into 5.0.&lt;/p&gt;</comment>
                            <comment id="14297193" author="jira-bot" created="Thu, 29 Jan 2015 17:33:31 +0000"  >&lt;p&gt;Commit 1655761 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/branches/lucene_solr_5_0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1655761&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1655761&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6969&quot; title=&quot;When opening an HDFSTransactionLog for append we must first attempt to recover it&amp;#39;s lease to prevent data loss.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6969&quot;&gt;&lt;del&gt;SOLR-6969&lt;/del&gt;&lt;/a&gt;: When opening an HDFSTransactionLog for append we must first attempt to recover  it&apos;s lease to prevent data loss.&lt;/p&gt;</comment>
                            <comment id="14310311" author="markrmiller@gmail.com" created="Sat, 7 Feb 2015 00:40:49 +0000"  >&lt;p&gt;The lease renewer here can end up running through other tests because we don&apos;t shut it down.&lt;/p&gt;</comment>
                            <comment id="14312631" author="markrmiller@gmail.com" created="Mon, 9 Feb 2015 18:56:55 +0000"  >&lt;p&gt;I filed &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7092&quot; title=&quot;Stop the HDFS lease recovery retries on HdfsTransactionLog on close and try to avoid lease recovery on closed files.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7092&quot;&gt;&lt;del&gt;SOLR-7092&lt;/del&gt;&lt;/a&gt; for that issue.&lt;/p&gt;</comment>
                            <comment id="14332596" author="anshumg" created="Mon, 23 Feb 2015 05:00:52 +0000"  >&lt;p&gt;Bulk close after 5.0 release.&lt;/p&gt;</comment>
                            <comment id="14340615" author="anshumg" created="Fri, 27 Feb 2015 19:02:16 +0000"  >&lt;p&gt;Reopening for backporting to 4.10.4.&lt;/p&gt;</comment>
                            <comment id="14340620" author="anshumg" created="Fri, 27 Feb 2015 19:02:59 +0000"  >&lt;p&gt;4.10.4 backport patch.&lt;/p&gt;</comment>
                            <comment id="14340632" author="anshumg" created="Fri, 27 Feb 2015 19:07:48 +0000"  >&lt;p&gt;This adds a dependency for solr/core so I&apos;m not sure if we should be backporting this to a bug fix release: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;dependency org=&lt;span class=&quot;code-quote&quot;&gt;&quot;commons-collections&quot;&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;commons-collections&quot;&lt;/span&gt; rev=&lt;span class=&quot;code-quote&quot;&gt;&quot;${/commons-collections/commons-collections}&quot;&lt;/span&gt; conf=&lt;span class=&quot;code-quote&quot;&gt;&quot;compile.hadoop&quot;&lt;/span&gt;/&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;What&apos;s the general practice?&lt;/p&gt;</comment>
                            <comment id="14342732" author="anshumg" created="Mon, 2 Mar 2015 04:46:15 +0000"  >&lt;p&gt;I&apos;m opting to not backport this to 4.10.x branch due to the added dependency.&lt;br/&gt;
In case someone wants to use it, feel free to use the patch though.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12733541">SOLR-6367</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12773537">SOLR-7092</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12786369">SOLR-7321</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12701415" name="SOLR-6969-4.10.4-backport.patch" size="9404" author="anshum" created="Fri, 27 Feb 2015 19:02:59 +0000"/>
                            <attachment id="12695183" name="SOLR-6969.patch" size="15958" author="markrmiller@gmail.com" created="Thu, 29 Jan 2015 05:11:01 +0000"/>
                            <attachment id="12695119" name="SOLR-6969.patch" size="11207" author="markrmiller@gmail.com" created="Wed, 28 Jan 2015 23:27:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 38 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i249r3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>