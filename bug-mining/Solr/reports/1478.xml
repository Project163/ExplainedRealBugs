<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:38:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-4997] The splitshard api doesn&apos;t call commit on new sub shards</title>
                <link>https://issues.apache.org/jira/browse/SOLR-4997</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;The splitshard api doesn&apos;t call commit on new sub shards but it happily sets them to active state which means on a successful split, the documents are not visible to searchers unless an explicit commit is called on the cluster.&lt;/p&gt;

&lt;p&gt;The coreadmin split api will still not call commit on targetCores. That is by design and we&apos;re not going to change that.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12656041">SOLR-4997</key>
            <summary>The splitshard api doesn&apos;t call commit on new sub shards</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shalin">Shalin Shekhar Mangar</assignee>
                                    <reporter username="shalin">Shalin Shekhar Mangar</reporter>
                        <labels>
                    </labels>
                <created>Wed, 3 Jul 2013 15:20:01 +0000</created>
                <updated>Tue, 23 Jul 2013 18:38:41 +0000</updated>
                            <resolved>Tue, 16 Jul 2013 07:16:02 +0000</resolved>
                                    <version>4.3</version>
                    <version>4.3.1</version>
                                    <fixVersion>4.4</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="13699090" author="shalinmangar" created="Wed, 3 Jul 2013 15:38:30 +0000"  >&lt;p&gt;Hmm, we don&apos;t know the name of the update handler inside the Overseer Collection Processor so we can do one of the following:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Assume it is /update&lt;/li&gt;
	&lt;li&gt;Pass in the update handler name in the OverseerCollectionProcessor constructor&lt;/li&gt;
	&lt;li&gt;Change CoreAdmin request apply updates action to accept a commit param&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="13699099" author="markrmiller@gmail.com" created="Wed, 3 Jul 2013 15:49:14 +0000"  >&lt;p&gt;1. -1&lt;/p&gt;


&lt;p&gt;Something along 2 or 3 lines seems way preferable.&lt;/p&gt;</comment>
                            <comment id="13699101" author="shalinmangar" created="Wed, 3 Jul 2013 15:51:51 +0000"  >&lt;p&gt;Agreed. I am going to use 3 just because it is something I control. Configurable handlers for such basic things are a pain.&lt;/p&gt;</comment>
                            <comment id="13699158" author="shalinmangar" created="Wed, 3 Jul 2013 16:48:08 +0000"  >&lt;p&gt;There is no way to match the last commit point on the parent exactly. The best we can do is to commit right before we switch states. So users must still call a commit after splitshard but at least they will get more up to date results.&lt;/p&gt;</comment>
                            <comment id="13699180" author="mistigi" created="Wed, 3 Jul 2013 17:05:10 +0000"  >&lt;p&gt;&quot;at least they will get more up to date results.&quot;&lt;/p&gt;

&lt;p&gt;Does it mean that if there is update activity outside of CoreAdmin API during SPLISTSHARD call the resulting splitted shard may be in inconsistent state ?&lt;/p&gt;

&lt;p&gt;In other words, if I am actively indexing on the collection while I am performing SPLITSHARD call, some of the indexing operation may not be reflected in my collection after SPLITSHARD completes ?&lt;/p&gt;</comment>
                            <comment id="13699193" author="shalinmangar" created="Wed, 3 Jul 2013 17:15:33 +0000"  >&lt;blockquote&gt;&lt;p&gt;In other words, if I am actively indexing on the collection while I am performing SPLITSHARD call, some of the indexing operation may not be reflected in my collection after SPLITSHARD completes ?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;For Solr 4.3.1 &amp;#8211; no operations are reflected on subshards until you call commit after splitshard. After this issue is fixed (with Solr 4.4), all indexing operations performed till the completion of splitshard will be reflected in sub shards.&lt;/p&gt;</comment>
                            <comment id="13699220" author="yseeley@gmail.com" created="Wed, 3 Jul 2013 17:31:34 +0000"  >&lt;blockquote&gt;&lt;p&gt;In other words, if I am actively indexing on the collection while I am performing SPLITSHARD call, some of the indexing operation may not be reflected in my collection after SPLITSHARD completes ?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The phrase &quot;may not be reflected&quot; is bound to be confusing to others reading this issue.&lt;br/&gt;
You won&apos;t lose any updates... this is more about update visibility.&lt;/p&gt;</comment>
                            <comment id="13699269" author="shalinmangar" created="Wed, 3 Jul 2013 18:08:36 +0000"  >&lt;blockquote&gt;&lt;p&gt;You won&apos;t lose any updates... this is more about update visibility.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, exactly. A side effect of this bug is that the newly created sub shards are inconsistent in terms of update visibility. The leader of the sub shard will not have new updates visible (depending on auto commit settings) but all other replicas will have new updates visible because they are created after the split.&lt;/p&gt;</comment>
                            <comment id="13702466" author="shalinmangar" created="Mon, 8 Jul 2013 21:34:41 +0000"  >&lt;p&gt;I found another bug while investigating this. Any core starting up as part of a &quot;construction&quot; shard was set to skip log replay but it also skipped recovery. So a subshard replica would publish itself as active without having any documents.&lt;/p&gt;

&lt;p&gt;I also wasted a lot of time trying to figure out why a commit request would not work until I realized that HttpShardHandler is hardcoded to send QueryRequest so it cannot be used to issue a commit.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Fix for above issue &amp;#8211; Only skip log replay but not recovery for cores belonging to &quot;construction&quot; state shards&lt;/li&gt;
	&lt;li&gt;Call distrib commit before we switch shard states&lt;/li&gt;
	&lt;li&gt;Tests for shard consistency&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The test currently fails with sub shard leader having more docs than its replicas and I&apos;m still trying to figure out why.&lt;/p&gt;</comment>
                            <comment id="13703645" author="shalinmangar" created="Tue, 9 Jul 2013 18:57:15 +0000"  >&lt;p&gt;I think I have found the cause of the failures. It has to do with sub shard replication. I&apos;m working on a test + fix.&lt;/p&gt;</comment>
                            <comment id="13706334" author="shalinmangar" created="Thu, 11 Jul 2013 22:16:50 +0000"  >&lt;p&gt;This took some time to track down.&lt;/p&gt;

&lt;p&gt;Changes&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Overseer collection processor calls commit after all replicas are created and before it switches shard states&lt;/li&gt;
	&lt;li&gt;ZkController is modified to have only sub shard leaders skip log recovery on startup. Sub shard replicas will recover from leader before they publish themselves as active&lt;/li&gt;
	&lt;li&gt;Changes in DistributedUpdateProcessor to detect when the current node is a sub shard leader and it should forward updates to its replicas&lt;/li&gt;
	&lt;li&gt;ShardSplitTests tests for shard consistency as well before calling a global commit and testing for final correctness&lt;/li&gt;
	&lt;li&gt;Fixed SolrCmdDistributor.syncRequest to log the correct exception&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;All tests pass.&lt;/p&gt;

&lt;p&gt;This patch fixes three (related) bugs in total.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;We don&apos;t commit on sub shards because of which sub shards don&apos;t have all docs visible&lt;/li&gt;
	&lt;li&gt;Sub shard replicas skip recovering from leader because of which they show no docs upon creation&lt;/li&gt;
	&lt;li&gt;Sub shard replicas can lose updates from leader between the time they are created and the time the shard becomes active&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The first two have easy fixes. The last one required invasive changes.&lt;/p&gt;

&lt;p&gt;I&apos;ll put up this patch in case someone wants to review and commit it tomorrow morning my time (IST).&lt;/p&gt;

&lt;p&gt;I&apos;d like to include this in 4.4 since it fixes major bugs but I&apos;m not sure if we have enough time to let this bake. Perhaps if we cut the RC on Monday instead of Friday, we can let jenkins test it for a while? Review comments are welcome.&lt;/p&gt;</comment>
                            <comment id="13706412" author="yseeley@gmail.com" created="Thu, 11 Jul 2013 23:09:21 +0000"  >&lt;blockquote&gt;&lt;p&gt;Perhaps if we cut the RC on Monday instead of Friday&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I believe that was Steve&apos;s original plan anyway. &lt;/p&gt;</comment>
                            <comment id="13706751" author="jira-bot" created="Fri, 12 Jul 2013 07:32:15 +0000"  >&lt;p&gt;Commit 1502458 from shalin@apache.org&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1502458&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1502458&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4997&quot; title=&quot;The splitshard api doesn&amp;#39;t call commit on new sub shards&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4997&quot;&gt;&lt;del&gt;SOLR-4997&lt;/del&gt;&lt;/a&gt;: The splitshard api doesn&apos;t call commit on new sub shards before switching shard states. Multiple bugs related to sub shard recovery and replication are also fixed.&lt;/p&gt;</comment>
                            <comment id="13706755" author="jira-bot" created="Fri, 12 Jul 2013 07:36:56 +0000"  >&lt;p&gt;Commit 1502460 from shalin@apache.org&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1502460&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1502460&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4997&quot; title=&quot;The splitshard api doesn&amp;#39;t call commit on new sub shards&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4997&quot;&gt;&lt;del&gt;SOLR-4997&lt;/del&gt;&lt;/a&gt;: The splitshard api doesn&apos;t call commit on new sub shards before switching shard states. Multiple bugs related to sub shard recovery and replication are also fixed.&lt;/p&gt;</comment>
                            <comment id="13706899" author="erickerickson" created="Fri, 12 Jul 2013 12:41:16 +0000"  >&lt;p&gt;Shalin:&lt;/p&gt;

&lt;p&gt;I see there&apos;s a 4_4 branch already, are we sure it&apos;s on that branch too? Just don&apos;t want this to be lost in the shuffle.&lt;/p&gt;</comment>
                            <comment id="13708096" author="jira-bot" created="Sun, 14 Jul 2013 18:41:41 +0000"  >&lt;p&gt;Commit 1503019 from shalin@apache.org in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1503019&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1503019&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4997&quot; title=&quot;The splitshard api doesn&amp;#39;t call commit on new sub shards&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4997&quot;&gt;&lt;del&gt;SOLR-4997&lt;/del&gt;&lt;/a&gt;: Call commit before checking shard consistency&lt;/p&gt;</comment>
                            <comment id="13708097" author="jira-bot" created="Sun, 14 Jul 2013 18:42:56 +0000"  >&lt;p&gt;Commit 1503020 from shalin@apache.org in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1503020&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1503020&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4997&quot; title=&quot;The splitshard api doesn&amp;#39;t call commit on new sub shards&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4997&quot;&gt;&lt;del&gt;SOLR-4997&lt;/del&gt;&lt;/a&gt;: Call commit before checking shard consistency&lt;/p&gt;</comment>
                            <comment id="13708301" author="jira-bot" created="Mon, 15 Jul 2013 08:12:07 +0000"  >&lt;p&gt;Commit 1503130 from shalin@apache.org in branch &apos;dev/branches/lucene_solr_4_4&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1503130&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1503130&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4997&quot; title=&quot;The splitshard api doesn&amp;#39;t call commit on new sub shards&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4997&quot;&gt;&lt;del&gt;SOLR-4997&lt;/del&gt;&lt;/a&gt;: The splitshard api doesn&apos;t call commit on new sub shards before switching shard states. Multiple bugs related to sub shard recovery and replication are also fixed.&lt;/p&gt;</comment>
                            <comment id="13708302" author="jira-bot" created="Mon, 15 Jul 2013 08:13:16 +0000"  >&lt;p&gt;Commit 1503131 from shalin@apache.org in branch &apos;dev/branches/lucene_solr_4_4&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1503131&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1503131&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4997&quot; title=&quot;The splitshard api doesn&amp;#39;t call commit on new sub shards&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4997&quot;&gt;&lt;del&gt;SOLR-4997&lt;/del&gt;&lt;/a&gt;: Call commit before checking shard consistency&lt;/p&gt;</comment>
                            <comment id="13708621" author="jira-bot" created="Mon, 15 Jul 2013 16:47:49 +0000"  >&lt;p&gt;Commit 1503328 from shalin@apache.org in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1503328&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1503328&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4997&quot; title=&quot;The splitshard api doesn&amp;#39;t call commit on new sub shards&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4997&quot;&gt;&lt;del&gt;SOLR-4997&lt;/del&gt;&lt;/a&gt;: Skip log recovery for sub shard leaders only&lt;/p&gt;</comment>
                            <comment id="13708624" author="jira-bot" created="Mon, 15 Jul 2013 16:48:59 +0000"  >&lt;p&gt;Commit 1503331 from shalin@apache.org in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1503331&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1503331&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4997&quot; title=&quot;The splitshard api doesn&amp;#39;t call commit on new sub shards&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4997&quot;&gt;&lt;del&gt;SOLR-4997&lt;/del&gt;&lt;/a&gt;: Skip log recovery for sub shard leaders only&lt;/p&gt;</comment>
                            <comment id="13708625" author="jira-bot" created="Mon, 15 Jul 2013 16:50:03 +0000"  >&lt;p&gt;Commit 1503332 from shalin@apache.org in branch &apos;dev/branches/lucene_solr_4_4&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1503332&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1503332&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4997&quot; title=&quot;The splitshard api doesn&amp;#39;t call commit on new sub shards&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4997&quot;&gt;&lt;del&gt;SOLR-4997&lt;/del&gt;&lt;/a&gt;: Skip log recovery for sub shard leaders only&lt;/p&gt;</comment>
                            <comment id="13708629" author="shalinmangar" created="Mon, 15 Jul 2013 16:54:14 +0000"  >&lt;p&gt;I fixed a bug that I had introduced which skipped log recovery on startup for all leaders instead of only sub shard leaders. I caught this only because I was doing another line-by-line review of all my changes. We should have a test which catches such a condition.&lt;/p&gt;</comment>
                            <comment id="13708776" author="markrmiller@gmail.com" created="Mon, 15 Jul 2013 18:24:26 +0000"  >&lt;blockquote&gt;&lt;p&gt;We should have a test which catches such a condition.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;yeah, scary.&lt;/p&gt;</comment>
                            <comment id="13709561" author="shalinmangar" created="Tue, 16 Jul 2013 07:14:39 +0000"  >&lt;p&gt;I opened &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5041&quot; title=&quot;Add a test to make sure that a leader always recovers from log on startup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5041&quot;&gt;&lt;del&gt;SOLR-5041&lt;/del&gt;&lt;/a&gt; for the test task.&lt;/p&gt;</comment>
                            <comment id="13716823" author="steve_rowe" created="Tue, 23 Jul 2013 18:38:41 +0000"  >&lt;p&gt;Bulk close resolved 4.4 issues&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12591923" name="SOLR-4997.patch" size="21376" author="shalin" created="Thu, 11 Jul 2013 22:16:50 +0000"/>
                            <attachment id="12591286" name="SOLR-4997.patch" size="10849" author="shalin" created="Mon, 8 Jul 2013 21:34:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>336316</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 18 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1m0fb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>336640</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>