<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:31:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-11769] Sorting performance degrades when useFilterForSortedQuery is enabled and there is no filter query specified</title>
                <link>https://issues.apache.org/jira/browse/SOLR-11769</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;The performance of sorting degrades significantly when the &lt;tt&gt;useFilterForSortedQuery&lt;/tt&gt; is enabled, and there&apos;s no filter query specified.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Steps to Reproduce:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;1. Set &lt;tt&gt;useFilterForSortedQuery=true&lt;/tt&gt; in &lt;tt&gt;solrconfig.xml&lt;/tt&gt;&lt;br/&gt;
2. Run a  query to match and return a single document. Also add sorting&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Example &lt;tt&gt;/select?q=foo:123&amp;amp;sort=bar+desc&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;Having a large index (&amp;gt; 10 million documents), this yields to a slow response (a few hundreds of milliseconds on average) even when the resulting set consists of a single document.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Observation 1:&lt;/b&gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Disabling &lt;tt&gt;useFilterForSortedQuery&lt;/tt&gt; improves the performance to &amp;lt; 1ms&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;b&gt;Observation 2:&lt;/b&gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Removing the &lt;tt&gt;sort&lt;/tt&gt; improves the performance to &amp;lt; 1ms&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;b&gt;Observation 3:&lt;/b&gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Keeping the &lt;tt&gt;sort&lt;/tt&gt;, and adding any filter query (such as &lt;tt&gt;fq=&amp;#42;:&amp;#42;&lt;/tt&gt;) improves the performance to &amp;lt; 1 ms.&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;After profiling &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;a=blob;f=solr/core/src/java/org/apache/solr/search/SolrIndexSearcher.java;h=9ee5199bdf7511c70f2cc616c123292c97d36b5b;hb=HEAD#l1400&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;SolrIndexSearcher.java&lt;/a&gt; found that the bottleneck is on &lt;br/&gt;
&lt;tt&gt;DocSet bigFilt = getDocSet(cmd.getFilterList());&lt;/tt&gt; &lt;/p&gt;

&lt;p&gt;when &lt;tt&gt;cmd.getFilterList())&lt;/tt&gt; is passed in as &lt;tt&gt;null&lt;/tt&gt;. This is making &lt;tt&gt;getDocSet()&lt;/tt&gt; function collect document ids every single time it is called without any caching.&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
1394     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (useFilterCache) {
1395       &lt;span class=&quot;code-comment&quot;&gt;// now actually use the filter cache.
&lt;/span&gt;1396       &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; large filters that match few documents, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; may be
&lt;/span&gt;1397       &lt;span class=&quot;code-comment&quot;&gt;// slower than simply re-executing the query.
&lt;/span&gt;1398       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (out.docSet == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
1399         out.docSet = getDocSet(cmd.getQuery(), cmd.getFilter());
1400         DocSet bigFilt = getDocSet(cmd.getFilterList());
1401         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (bigFilt != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) out.docSet = out.docSet.intersection(bigFilt);
1402       }
1403       &lt;span class=&quot;code-comment&quot;&gt;// todo: there could be a sortDocSet that could take a list of
&lt;/span&gt;1404       &lt;span class=&quot;code-comment&quot;&gt;// the filters instead of anding them first...
&lt;/span&gt;1405       &lt;span class=&quot;code-comment&quot;&gt;// perhaps there should be a multi-docset-iterator
&lt;/span&gt;1406       sortDocSet(qr, cmd);
1407     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;OS: macOS Sierra (version 10.12.4)&lt;br/&gt;
Memory: 16GB&lt;br/&gt;
CPU: 2.9 GHz Intel Core i7&lt;br/&gt;
Java Version: 1.8&lt;/p&gt;
</environment>
        <key id="13125452">SOLR-11769</key>
            <summary>Sorting performance degrades when useFilterForSortedQuery is enabled and there is no filter query specified</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dsmiley">David Smiley</assignee>
                                    <reporter username="bdeva">Betim Deva</reporter>
                        <labels>
                            <label>performance</label>
                    </labels>
                <created>Sun, 17 Dec 2017 07:20:37 +0000</created>
                <updated>Sat, 8 Jun 2019 15:16:09 +0000</updated>
                            <resolved>Wed, 28 Feb 2018 17:41:36 +0000</resolved>
                                    <version>4.10.4</version>
                                    <fixVersion>7.3</fixVersion>
                                    <component>search</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16294516" author="dsmiley" created="Mon, 18 Dec 2017 04:39:36 +0000"  >&lt;p&gt;I think the solution is as simple as wrapping lines 1400 &amp;amp; 1401 in a new if block to check that getFilterList is non-null and non-empty.  I think the idea of &quot;useFilterForSortedQuery&quot; is still relevant when there are no filters because the query is also considered, and will be cached here (on line 1399 call to getDocSet) and thus benefit from the optimization.&lt;/p&gt;</comment>
                            <comment id="16295810" author="bdeva" created="Mon, 18 Dec 2017 23:01:43 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;As suggested, I&apos;ve changed lines 1400-1401 to following and verified that the performance improves while the result set remains the same. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        List&amp;lt;Query&amp;gt; filterList = cmd.getFilterList();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (filterList != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !filterList.isEmpty()) {
          DocSet bigFilt = getDocSet(cmd.filterList);
          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (bigFilt != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            out.docSet = out.docSet.intersection(bigFilt);
          }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16297889" author="dsmiley" created="Wed, 20 Dec 2017 05:01:39 +0000"  >&lt;p&gt;I couldn&apos;t help myself today but dig deeper here and figure out why there would be a slow-down even without the above change.  The result is a more broader improvement for match-all-docs (&lt;b&gt;:&lt;/b&gt;) scenarios that is not specific to the particular useFilterForSortedQuery situation above.  Essentially SolrIndexSearcher.getProcessedFilter would return an empty pf if there are no queries or filters (the semantics mean match-all-docs).  But there is the &quot;answer&quot; field that could be populated with getLiveDocs, and pf.answer is examined by getDocSet so it can return early.  I also optimized DocSetUtil.createDocSet to check that the query arg is a MatchAllDocsQuery and the live docs is &quot;instantiated&quot;, allowing us to return that directly.&lt;/p&gt;

&lt;p&gt;The only quirky thing about this was a test failure I fixed in TestSolrQueryParser that checked the filter cache insert delta after executing a query.  The additional call to getLiveDocs in this patch by getProcessedFilter occurred which got in the cache and increased the counter an additional time.  An assumption I make in the getProcessedFilter change is that returning getLiveDocs is either cheap or a forlorn conclusion that it will ultimately be instantiated at some point any way so might as well get it on with.  Alternatively, it&apos;s caller could instead check for this case (e.g. filter == null &amp;amp;&amp;amp; postFilter == null then return getLiveDocs)?  But that seems less clean since &quot;answer&quot; is there for a reason so why avoid it.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yonik%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;yonik@apache.org&quot;&gt;yonik@apache.org&lt;/a&gt; can you please review this?  It intersects with modifications you&apos;ve done in the past.&lt;/p&gt;

&lt;p&gt;As an aside, I think it would be good if more DocSet methods in SolrIndexSearcher move over to DocSetUtil so that we can keep the unwieldily SolrIndexSearcher tamed.  Essentially I suggest a similar change as I did for the SolrDocumentFetcher refactoring but for DocSets.  With such a change, it would have access to the searcher and not need it in the methods.&lt;/p&gt;</comment>
                            <comment id="16298292" author="yseeley@gmail.com" created="Wed, 20 Dec 2017 11:07:02 +0000"  >&lt;p&gt;We just need to be careful about returning cached sets where we did not before (and check that we never modify sets returned, as well as document that the returned set should not be modified).&lt;br/&gt;
For DocSetUtil.createDocSet specifically, it feels like potentially returning liveDocs should either be moved to a higher level caching function, or we should rename createDocSet since it can now sometimes just return an existing shared set.&lt;/p&gt;</comment>
                            <comment id="16366589" author="dsmiley" created="Fri, 16 Feb 2018 04:01:23 +0000"  >
&lt;p&gt;Yonik: That&apos;s a good point &amp;#8211; &quot;createDocSet&quot; ought to have a result that is safe to modify.  However note that you made createDocSet return DocSetUtil.getDocSet( answer, searcher ) at the very end, which is expressly documented to not have a result that is safe to modify since it can set LiveDocs.  Maybe an indirect caller here, SolrIndexSearcher.getDocSet(Query query) and getDocSet(Query, DocSet) ought to then concern themselves with calling this on the results of getDocSetNC because these methods are cache aware.&lt;/p&gt;

&lt;p&gt;Separately, I&apos;ve been poking around this related code and noticed this DocSetProducer thing.  I&apos;m skeptical we should have it.  Firstly it&apos;s a Solr thing but most Queries are implemented at the Lucene level.  Secondly, I think we can achieve the same by grabbing the Weight then Scorer and then the DocIdSetIterator, then pass to BitSetIterator.getFixedBitSetOrNull(iter).  That should work with a some Lucene and Solr queries,&lt;/p&gt;</comment>
                            <comment id="16374948" author="dsmiley" created="Fri, 23 Feb 2018 20:50:22 +0000"  >&lt;p&gt;The original problem is easily fixed; I should commit this so that it can get into 7.3.   The larger refactorings can be postponed to a new issue.&lt;/p&gt;</comment>
                            <comment id="16380719" author="jira-bot" created="Wed, 28 Feb 2018 17:38:49 +0000"  >&lt;p&gt;Commit ef989124f345af46a905d1196bc589ef37b221c9 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ef98912&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ef98912&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11769&quot; title=&quot;Sorting performance degrades when useFilterForSortedQuery is enabled and there is no filter query specified&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11769&quot;&gt;&lt;del&gt;SOLR-11769&lt;/del&gt;&lt;/a&gt;: optimize useFilterForSortedQuery=true when no filter queries&lt;/p&gt;</comment>
                            <comment id="16380721" author="jira-bot" created="Wed, 28 Feb 2018 17:39:43 +0000"  >&lt;p&gt;Commit 9b3d68843beb5e0a834d6847446a480742665805 in lucene-solr&apos;s branch refs/heads/branch_7x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=9b3d688&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=9b3d688&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11769&quot; title=&quot;Sorting performance degrades when useFilterForSortedQuery is enabled and there is no filter query specified&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11769&quot;&gt;&lt;del&gt;SOLR-11769&lt;/del&gt;&lt;/a&gt;: optimize useFilterForSortedQuery=true when no filter queries&lt;/p&gt;

&lt;p&gt;(cherry picked from commit ef98912)&lt;/p&gt;</comment>
                            <comment id="16380725" author="dsmiley" created="Wed, 28 Feb 2018 17:41:36 +0000"  >&lt;p&gt;Thanks for reporting this.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13141553">SOLR-12044</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12902969" name="SOLR-11769_Optimize_MatchAllDocsQuery_more.patch" size="9272" author="dsmiley" created="Wed, 20 Dec 2017 04:39:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 37 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3nzmn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>