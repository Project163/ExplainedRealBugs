<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:40:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-5216] Document updates to SolrCloud can cause a distributed deadlock.</title>
                <link>https://issues.apache.org/jira/browse/SOLR-5216</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description></description>
                <environment></environment>
        <key id="12667243">SOLR-5216</key>
            <summary>Document updates to SolrCloud can cause a distributed deadlock.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="markrmiller@gmail.com">Mark Miller</assignee>
                                    <reporter username="markrmiller@gmail.com">Mark Miller</reporter>
                        <labels>
                    </labels>
                <created>Fri, 6 Sep 2013 01:40:19 +0000</created>
                <updated>Mon, 9 May 2016 18:53:19 +0000</updated>
                            <resolved>Sat, 19 Oct 2013 17:24:22 +0000</resolved>
                                                    <fixVersion>4.6</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="13760516" author="tvaillancourt" created="Fri, 6 Sep 2013 18:59:57 +0000"  >&lt;p&gt;Hey guys,&lt;/p&gt;

&lt;p&gt;We tested this patch and unfortunately encountered some serious issues a few hours of 500 update-batches/sec. Our update batch is 10 docs, so we are writing about 5000 docs/sec total, using autoCommit to commit the updates (no explicit commits).&lt;/p&gt;

&lt;p&gt;Our environment:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Solr 4.3.1 w/&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5216&quot; title=&quot;Document updates to SolrCloud can cause a distributed deadlock.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5216&quot;&gt;&lt;del&gt;SOLR-5216&lt;/del&gt;&lt;/a&gt; patch.&lt;/li&gt;
	&lt;li&gt;Jetty 9, Java 1.7.&lt;/li&gt;
	&lt;li&gt;3 solr instances, 1 per physical server.&lt;/li&gt;
	&lt;li&gt;1 collection.&lt;/li&gt;
	&lt;li&gt;3 shards.&lt;/li&gt;
	&lt;li&gt;2 replicas (each instance is a leader and a replica).&lt;/li&gt;
	&lt;li&gt;Soft autoCommit is 1000ms.&lt;/li&gt;
	&lt;li&gt;Hard autoCommit is 15000ms.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;After about 6 hours of stress-testing this patch, we see many of these stalled transactions (below), and the Solr instances start to see each other as down, flooding our Solr logs with &quot;Connection Refused&quot; exceptions, and otherwise no obviously-useful logs that I could see.&lt;/p&gt;

&lt;p&gt;I did notice some stalled transactions on both /select and /update, however. This never occurred without this patch.&lt;/p&gt;

&lt;p&gt;Stack /select seems stalled on: &lt;a href=&quot;http://pastebin.com/Y1NCrXGC&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://pastebin.com/Y1NCrXGC&lt;/a&gt;&lt;br/&gt;
Stack /update seems stalled on: &lt;a href=&quot;http://pastebin.com/cFLbC8Y9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://pastebin.com/cFLbC8Y9&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Lastly, I have a summary of the ERROR-severity logs from this 24-hour soak. My script &quot;normalizes&quot; the ERROR-severity stack traces and returns them in order of occurrence.&lt;/p&gt;

&lt;p&gt;Summary of my solr.log: &lt;a href=&quot;http://pastebin.com/pBdMAWeb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://pastebin.com/pBdMAWeb&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;

&lt;p&gt;Tim Vaillancourt&lt;/p&gt;</comment>
                            <comment id="13764057" author="markrmiller@gmail.com" created="Wed, 11 Sep 2013 06:44:15 +0000"  >&lt;p&gt;I think the only thing that this patch could possibly do is eliminate the deadlock, but allow for more threads. I only expect up to a 2x max use in threads, but it could be off and allow for more than that if there is some small bug I&apos;m missing. In any case, I&apos;m sure the idea is the right one for the deadlock. I worry the problems you get after many hours might be due to the sheer number of threads and requests. I worry about spending too much time trying to get this solution working though - it might be energy better spent changing things towards a better direction - &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5232&quot; title=&quot;SolrCloud should distribute updates via streaming rather than buffering.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5232&quot;&gt;&lt;del&gt;SOLR-5232&lt;/del&gt;&lt;/a&gt;: SolrCloud should distribute updates via streaming rather than buffering.&lt;/p&gt;</comment>
                            <comment id="13799545" author="markrmiller@gmail.com" created="Fri, 18 Oct 2013 21:38:36 +0000"  >&lt;p&gt;I&apos;m going to resolve this for 4.6 with &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5232&quot; title=&quot;SolrCloud should distribute updates via streaming rather than buffering.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5232&quot;&gt;&lt;del&gt;SOLR-5232&lt;/del&gt;&lt;/a&gt; - look forward to any help testing it out &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13799577" author="jira-bot" created="Fri, 18 Oct 2013 22:10:54 +0000"  >&lt;p&gt;Commit 1533649 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1533649&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1533649&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5216&quot; title=&quot;Document updates to SolrCloud can cause a distributed deadlock.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5216&quot;&gt;&lt;del&gt;SOLR-5216&lt;/del&gt;&lt;/a&gt;: Document updates to SolrCloud can cause a distributed deadlock.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5232&quot; title=&quot;SolrCloud should distribute updates via streaming rather than buffering.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5232&quot;&gt;&lt;del&gt;SOLR-5232&lt;/del&gt;&lt;/a&gt;: SolrCloud should distribute updates via streaming rather than buffering.&lt;/p&gt;</comment>
                            <comment id="13799585" author="jira-bot" created="Fri, 18 Oct 2013 22:15:36 +0000"  >&lt;p&gt;Commit 1533652 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1533652&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1533652&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5216&quot; title=&quot;Document updates to SolrCloud can cause a distributed deadlock.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5216&quot;&gt;&lt;del&gt;SOLR-5216&lt;/del&gt;&lt;/a&gt;: Document updates to SolrCloud can cause a distributed deadlock.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5232&quot; title=&quot;SolrCloud should distribute updates via streaming rather than buffering.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5232&quot;&gt;&lt;del&gt;SOLR-5232&lt;/del&gt;&lt;/a&gt;: SolrCloud should distribute updates via streaming rather than buffering.&lt;/p&gt;</comment>
                            <comment id="13834628" author="rmerizalde" created="Thu, 28 Nov 2013 09:06:34 +0000"  >&lt;p&gt;Mark, can this issue affect SolrCloud deployments with a single shard? We&apos;ve been running SolrCloud since April and we experienced an odd outage today we&apos;ve never seen before. &lt;/p&gt;

&lt;p&gt;We are currently running Solr 4.5.1 with 4 slaves and we use CloudSolrServer to send updates. The number of threads went from under 100 to almost 400 in each of the instances in less than one minute. The heap filled up quickly as well until they ran out of memory. It filled about 2GB worth of heap in a couple minutes. Of course, all four JVM started doing major collections one after another but couldn&apos;t free any heap memory.&lt;/p&gt;

&lt;p&gt;Unfortunately, we forgot to take thread dumps in the rush for recovering our site. All we have are the heap dumps.&lt;/p&gt;

&lt;p&gt;Also, we do auto hard commits every 5 minutes or every 10k documents. &lt;/p&gt;

&lt;p&gt;We&apos;ll be trying 4.6 soon, however I want to check if we are headed in the right direction.&lt;/p&gt;</comment>
                            <comment id="13834886" author="erickerickson" created="Thu, 28 Nov 2013 14:34:27 +0000"  >&lt;p&gt;This shouldn&apos;t affect single-shard setups. The deadlock,&lt;br/&gt;
as I remember, showed up when lots of nodes split up&lt;br/&gt;
incoming batches of documents to forward to lots of&lt;br/&gt;
leaders. Since a single shard won&apos;t split up the documents,&lt;br/&gt;
I doubt this is the root of what you&apos;re seeing.&lt;/p&gt;

&lt;p&gt;But yeah, a stack trace would tell us for certain.&lt;/p&gt;

&lt;p&gt;And Mark committed &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5232&quot; title=&quot;SolrCloud should distribute updates via streaming rather than buffering.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5232&quot;&gt;&lt;del&gt;SOLR-5232&lt;/del&gt;&lt;/a&gt; which uses a different&lt;br/&gt;
mechanism anyway.&lt;/p&gt;

&lt;p&gt;To recap: I doubt this issue is a problem in single-shard&lt;br/&gt;
setups.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12674472">SOLR-5364</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                            <outwardlinks description="incorporates">
                                        <issuelink>
            <issuekey id="12674472">SOLR-5364</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12667987">SOLR-5232</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12601748" name="SOLR-5216.patch" size="6798" author="markrmiller@gmail.com" created="Fri, 6 Sep 2013 01:43:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>347180</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 51 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1nv7r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>347479</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>