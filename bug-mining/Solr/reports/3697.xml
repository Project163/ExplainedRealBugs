<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:29:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-11413] SolrGraphiteReporter fails to report metrics due to non-thread safe code</title>
                <link>https://issues.apache.org/jira/browse/SOLR-11413</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Symptom:&lt;br/&gt;
Intermittent errors writing graphite metrics.  Errors indicate use of sockets which have already been closed.&lt;/p&gt;

&lt;p&gt;Cause:&lt;br/&gt;
SolrGraphiteReporter caches and shares dropwizard Graphite instances.  These reporters are not thread safe as they  open and close an instance variable of type GraphiteSender.  On modern bare metal hardware this problem was observed consistently, and resulted in the majority of metrics failing to be delivered to graphite.&lt;/p&gt;

&lt;p&gt;Proposed Fix:&lt;br/&gt;
Graphite (and PickledGraphite) are not designed to be cached, and should not be.&lt;/p&gt;

&lt;p&gt;Test:&lt;br/&gt;
Patch file includes test which forces error.&lt;/p&gt;

&lt;p&gt;Alternative Fixes Considered:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Totally change solr metrics architecture to use a single metrics registry - seems undesirable and impractical&lt;/li&gt;
	&lt;li&gt;Create a synchronized or otherwise thread-safe implementation of dropwizard graphite reporter - should be fixed upstream in dropwizard and not obviously preferred to current model&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13105638">SOLR-11413</key>
            <summary>SolrGraphiteReporter fails to report metrics due to non-thread safe code</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ab">Andrzej Bialecki</assignee>
                                    <reporter username="erikpersson">Erik Persson</reporter>
                        <labels>
                    </labels>
                <created>Thu, 28 Sep 2017 02:49:48 +0000</created>
                <updated>Sat, 8 Jun 2019 15:24:34 +0000</updated>
                            <resolved>Mon, 30 Oct 2017 11:57:09 +0000</resolved>
                                    <version>6.6</version>
                    <version>7.0</version>
                                    <fixVersion>7.2</fixVersion>
                    <fixVersion>8.0</fixVersion>
                                    <component>metrics</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16183740" author="erikpersson" created="Thu, 28 Sep 2017 06:31:26 +0000"  >&lt;p&gt;Associate unit test to demonstrate failure not running reliably.  Above patch tested in high volume metrics tests.&lt;/p&gt;</comment>
                            <comment id="16185978" author="erikpersson" created="Fri, 29 Sep 2017 15:26:07 +0000"  >&lt;p&gt;Example error messages using Solr 6.6.0.  &lt;tt&gt;Already connected&lt;/tt&gt; and &lt;tt&gt;Stream closed&lt;/tt&gt; are typical examples of the errors due to different graphite scheduled reporter timer threads running concurrently a shared GraphiteSender instance.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2017-09-28 19:09:16.226 ERROR (metrics-graphite-reporter-2-thread-1) [   ] c.c.m.ScheduledReporter Exception thrown from GraphiteReporter#report. Exception was suppressed.
java.lang.IllegalStateException: Already connected
        at com.codahale.metrics.graphite.Graphite.connect(Graphite.java:111)
        at com.codahale.metrics.graphite.GraphiteReporter.report(GraphiteReporter.java:240)
        at com.codahale.metrics.ScheduledReporter.report(ScheduledReporter.java:235)
        at com.codahale.metrics.ScheduledReporter$1.run(ScheduledReporter.java:174)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
        at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:308)
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180)
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
2017-09-28 19:09:16.226 WARN  (metrics-graphite-reporter-1-thread-1) [   ] c.c.m.g.GraphiteReporter Unable to report to Graphite
java.io.IOException: Stream closed
        at java.io.BufferedWriter.ensureOpen(BufferedWriter.java:116)
        at java.io.BufferedWriter.write(BufferedWriter.java:221)
        at java.io.Writer.write(Writer.java:157)
        at com.codahale.metrics.graphite.Graphite.send(Graphite.java:138)
        at com.codahale.metrics.graphite.GraphiteReporter.sendIfEnabled(GraphiteReporter.java:328)
        at com.codahale.metrics.graphite.GraphiteReporter.reportMetered(GraphiteReporter.java:305)
        at com.codahale.metrics.graphite.GraphiteReporter.report(GraphiteReporter.java:255)
        at com.codahale.metrics.ScheduledReporter.report(ScheduledReporter.java:235)
        at com.codahale.metrics.ScheduledReporter$1.run(ScheduledReporter.java:174)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
        at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:308)
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180)
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
2017-09-28 19:09:16.234 ERROR (metrics-graphite-reporter-3-thread-1) [   ] c.c.m.ScheduledReporter Exception thrown from GraphiteReporter#report. Exception was suppressed.
java.lang.NullPointerException&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16192717" author="ab" created="Thu, 5 Oct 2017 10:46:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erikpersson&quot; class=&quot;user-hover&quot; rel=&quot;erikpersson&quot;&gt;erikpersson&lt;/a&gt; you mentioned the patch includes a unit test that illustrates the problem - but the test is not in the attached patch.&lt;/p&gt;

&lt;p&gt;Your proposed fix looks reasonable, but it would be nice to have a test case that illustrates the failure (and the fix).&lt;/p&gt;</comment>
                            <comment id="16197702" author="erikpersson" created="Mon, 9 Oct 2017 21:10:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt; Unfortunately the unit test that I had was misleading, so I removed it from the patch.  It appears to fail &apos;randomly&apos;.  Specifically it failed when I tried against un-patched Solr and worked when I tried it against my patch.  Subsequent tests were inconsistent.  &lt;/p&gt;

&lt;p&gt;My believe is that the problem lies in the embedded MockGraphite class in SolrGraphiteReporterTest.java.  I believe that the inconsistency in test results relates to how it handles support concurrent connections, but as of yet I cannot see why there would be a problem.  I will take another shot at it. &lt;/p&gt;</comment>
                            <comment id="16224781" author="jira-bot" created="Mon, 30 Oct 2017 11:52:42 +0000"  >&lt;p&gt;Commit c8d55cc6d45afaff31160a22fbe01dc36bb6675f in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=c8d55cc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=c8d55cc&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11413&quot; title=&quot;SolrGraphiteReporter fails to report metrics due to non-thread safe code&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11413&quot;&gt;&lt;del&gt;SOLR-11413&lt;/del&gt;&lt;/a&gt;: SolrGraphiteReporter fails to report metrics due to non-thread safe code.&lt;/p&gt;</comment>
                            <comment id="16224786" author="jira-bot" created="Mon, 30 Oct 2017 11:54:02 +0000"  >&lt;p&gt;Commit 235bdb384765893adfaba338c5dd8c167bbec9e3 in lucene-solr&apos;s branch refs/heads/branch_7x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=235bdb3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=235bdb3&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11413&quot; title=&quot;SolrGraphiteReporter fails to report metrics due to non-thread safe code&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11413&quot;&gt;&lt;del&gt;SOLR-11413&lt;/del&gt;&lt;/a&gt;: SolrGraphiteReporter fails to report metrics due to non-thread safe code.&lt;/p&gt;</comment>
                            <comment id="16224790" author="ab" created="Mon, 30 Oct 2017 11:56:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erikpersson&quot; class=&quot;user-hover&quot; rel=&quot;erikpersson&quot;&gt;erikpersson&lt;/a&gt; I couldn&apos;t reproduce this failure, but looking at the internals of how Dropwizard&apos;s GraphiteReporter uses the instance of Graphite this stacktrace makes sense, so I applied your fix. Thank you!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12889449" name="SOLR-11413.patch" size="1429" author="erikpersson" created="Thu, 28 Sep 2017 06:28:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 3 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3kn8n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>