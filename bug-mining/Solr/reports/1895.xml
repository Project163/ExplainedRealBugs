<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:50:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-6002] Fix a couple of ugly issues around SolrIndexWriter close and rollback as well as how SolrIndexWriter manages it&apos;s ref counted directory instance.</title>
                <link>https://issues.apache.org/jira/browse/SOLR-6002</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;We tried jumping all kinds of hoops (unsuccessfully anyway) to &lt;b&gt;really&lt;/b&gt; &lt;b&gt;really&lt;/b&gt; close an IndexWriter in the past, but Lucene wouldn&apos;t let you. Now that is fixed in Lucene and we should update our close/rollback code.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12709604">SOLR-6002</key>
            <summary>Fix a couple of ugly issues around SolrIndexWriter close and rollback as well as how SolrIndexWriter manages it&apos;s ref counted directory instance.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="markrmiller@gmail.com">Mark Miller</assignee>
                                    <reporter username="markrmiller@gmail.com">Mark Miller</reporter>
                        <labels>
                    </labels>
                <created>Mon, 21 Apr 2014 19:08:20 +0000</created>
                <updated>Mon, 9 May 2016 18:57:27 +0000</updated>
                            <resolved>Mon, 28 Jul 2014 18:40:42 +0000</resolved>
                                                    <fixVersion>4.9</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13975978" author="markrmiller@gmail.com" created="Mon, 21 Apr 2014 20:15:39 +0000"  >&lt;p&gt;Just found a bug hidden in this - SolrIndexWriter should not release it&apos;s directory in close because it&apos;s managed externally and passed in.&lt;/p&gt;</comment>
                            <comment id="13975985" author="markrmiller@gmail.com" created="Mon, 21 Apr 2014 20:19:42 +0000"  >&lt;p&gt;Hmm...no not quiet that, but something is off...&lt;/p&gt;</comment>
                            <comment id="13976054" author="markrmiller@gmail.com" created="Mon, 21 Apr 2014 21:16:35 +0000"  >&lt;p&gt;First pass on a patch. Much, much better.&lt;/p&gt;</comment>
                            <comment id="13976772" author="markrmiller@gmail.com" created="Tue, 22 Apr 2014 13:44:14 +0000"  >&lt;p&gt;I&apos;ll commit this shortly.&lt;/p&gt;</comment>
                            <comment id="13976966" author="markrmiller@gmail.com" created="Tue, 22 Apr 2014 16:04:52 +0000"  >&lt;p&gt;New, better patch.&lt;/p&gt;

&lt;p&gt;An issue we had previously is that close may or may not have called rollback and perhaps even the reverse. It seems now that close always calls rollback, but we shouldn&apos;t really count on that so I have changed things to assume that either may or may not call the other and SolrIndexWriter will still properly clean up.&lt;/p&gt;</comment>
                            <comment id="13977458" author="jira-bot" created="Tue, 22 Apr 2014 21:23:32 +0000"  >&lt;p&gt;Commit 1589294 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1589294&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1589294&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6002&quot; title=&quot;Fix a couple of ugly issues around SolrIndexWriter close and rollback as well as how SolrIndexWriter manages it&amp;#39;s ref counted directory instance.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6002&quot;&gt;&lt;del&gt;SOLR-6002&lt;/del&gt;&lt;/a&gt;: Fix a couple of ugly issues around SolrIndexWriter close and rollback as well as how SolrIndexWriter manages it&apos;s ref counted directory instance.&lt;/p&gt;</comment>
                            <comment id="13977519" author="jira-bot" created="Tue, 22 Apr 2014 21:58:41 +0000"  >&lt;p&gt;Commit 1589298 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1589298&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1589298&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6002&quot; title=&quot;Fix a couple of ugly issues around SolrIndexWriter close and rollback as well as how SolrIndexWriter manages it&amp;#39;s ref counted directory instance.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6002&quot;&gt;&lt;del&gt;SOLR-6002&lt;/del&gt;&lt;/a&gt;: Fix a couple of ugly issues around SolrIndexWriter close and rollback as well as how SolrIndexWriter manages it&apos;s ref counted directory instance.&lt;/p&gt;</comment>
                            <comment id="13977635" author="gchanan" created="Tue, 22 Apr 2014 23:51:55 +0000"  >&lt;p&gt;1) I don&apos;t understand the need for the CLOSE_LOCK, can you explain?&lt;/p&gt;

&lt;p&gt;2) In DirectUpdateHandler2 why the change from writer.shutdown() to writer.close()?  All the other changes go in the other direction, e.g. close -&amp;gt; shutdown.&lt;/p&gt;</comment>
                            <comment id="13977662" author="markrmiller@gmail.com" created="Wed, 23 Apr 2014 00:35:37 +0000"  >&lt;p&gt;Thanks for the review!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;1) I don&apos;t understand the need for the CLOSE_LOCK, can you explain?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Just so that only one thread will actually do the close logic. You can close an IndexWriter with either rollback or close and one of those might internally call the other - so the CLOSE_LOCK just makes sure the SolrIndexWriter close logic happens once. We don&apos;t use the this lock just so that we don&apos;t end up conflicting with other uses.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;2) In DirectUpdateHandler2 why the change from writer.shutdown() to writer.close()? All the other changes go in the other direction, e.g. close -&amp;gt; shutdown.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Because shutdown will wait for merges and commit, etc and DirectUpdateHandler2 actually does that right above - optionally - it was actually a small bug that someone changed it to shutdown (that&apos;s just on branch 5x though). We didn&apos;t want to commit in all cases like shutdown was doing. &lt;/p&gt;

&lt;p&gt;I do see a problem though - we need to call waitForMerges before we close.&lt;/p&gt;</comment>
                            <comment id="13977673" author="markrmiller@gmail.com" created="Wed, 23 Apr 2014 00:43:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;I do see a problem though - we need to call waitForMerges before we close.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Though I guess that fine points of that are up for debate. Waiting for merges can take a long time - perhaps we should just bail on them on shutdown - you don&apos;t lose data from that. Or perhaps we should wait when we commit on shutdown and not when we don&apos;t.&lt;/p&gt;

&lt;p&gt;I almost favor not waiting in either case - when I want to shutdown, I want it to be fairly prompt. Perhaps it should be a configuration and default to off. I don&apos;t want to tie all that into this issue though. We should probably just wait for merges for now as I think it&apos;s been done for a long time.&lt;/p&gt;</comment>
                            <comment id="13977682" author="gchanan" created="Wed, 23 Apr 2014 00:51:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;Just so that only one thread will actually do the close logic. You can close an IndexWriter with either rollback or close and one of those might internally call the other - so the CLOSE_LOCK just makes sure the SolrIndexWriter close logic happens once. We don&apos;t use the this lock just so that we don&apos;t end up conflicting with other uses.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Why is the CLOSE_LOCK static though?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Though I guess that fine points of that are up for debate. Waiting for merges can take a long time - perhaps we should just bail on them on shutdown - you don&apos;t lose data from that. Or perhaps we should wait when we commit on shutdown and not when we don&apos;t.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I almost favor not waiting in either case - when I want to shutdown, I want it to be fairly prompt. Perhaps it should be a configuration and default to off. I don&apos;t want to tie all that into this issue though. We should probably just wait for merges for now as I think it&apos;s been done for a long time.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Waiting for now with a config seems reasonable, but I don&apos;t have a strong opinion.&lt;/p&gt;</comment>
                            <comment id="13977687" author="markrmiller@gmail.com" created="Wed, 23 Apr 2014 00:58:37 +0000"  >&lt;blockquote&gt;&lt;p&gt;Why is the CLOSE_LOCK static though?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Whoops - just fell in line with the final statics around it I guess - no need for a global lock though.&lt;/p&gt;</comment>
                            <comment id="13977691" author="jira-bot" created="Wed, 23 Apr 2014 01:01:46 +0000"  >&lt;p&gt;Commit 1589327 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1589327&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1589327&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6002&quot; title=&quot;Fix a couple of ugly issues around SolrIndexWriter close and rollback as well as how SolrIndexWriter manages it&amp;#39;s ref counted directory instance.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6002&quot;&gt;&lt;del&gt;SOLR-6002&lt;/del&gt;&lt;/a&gt;: CLOSE_LOCK does not need to be static, waitForMerges when DirectUpdateHandler2 closes the IndexWriter, add Greg to CHANGES entry.&lt;/p&gt;</comment>
                            <comment id="13977693" author="gchanan" created="Wed, 23 Apr 2014 01:04:39 +0000"  >&lt;p&gt;+1 lgtm&lt;/p&gt;</comment>
                            <comment id="13977694" author="jira-bot" created="Wed, 23 Apr 2014 01:04:39 +0000"  >&lt;p&gt;Commit 1589328 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1589328&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1589328&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6002&quot; title=&quot;Fix a couple of ugly issues around SolrIndexWriter close and rollback as well as how SolrIndexWriter manages it&amp;#39;s ref counted directory instance.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6002&quot;&gt;&lt;del&gt;SOLR-6002&lt;/del&gt;&lt;/a&gt;: CLOSE_LOCK does not need to be static, waitForMerges when DirectUpdateHandler2 closes the IndexWriter, add Greg to CHANGES entry.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12599843">LUCENE-4246</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12702806">LUCENE-5544</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12698780">SOLR-5815</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12695423">SOLR-5735</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12641336" name="SOLR-6002.patch" size="9728" author="markrmiller@gmail.com" created="Tue, 22 Apr 2014 21:20:10 +0000"/>
                            <attachment id="12641262" name="SOLR-6002.patch" size="9680" author="markrmiller@gmail.com" created="Tue, 22 Apr 2014 16:04:52 +0000"/>
                            <attachment id="12641121" name="SOLR-6002.patch" size="8643" author="markrmiller@gmail.com" created="Mon, 21 Apr 2014 21:16:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>387926</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 31 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1utqv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>388186</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>