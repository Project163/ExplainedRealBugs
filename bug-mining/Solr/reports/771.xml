<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:25:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-2891] InvalidTokenOffsetsException when using MappingCharFilterFactory, DictionaryCompoundWordTokenFilterFactory and Highlighting</title>
                <link>https://issues.apache.org/jira/browse/SOLR-2891</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;I would like to handle german accents (Umlaute) by replacing the accented char with its two-letter substitute (e.g &#228; =&amp;gt; ae). For this reason I use the char-filter solr.MappingCharFilterFactory configured with a mapping file containing entries like &quot;&#228;&quot; =&amp;gt; &quot;ae&quot;. I also want to use the solr.DictionaryCompoundWordTokenFilterFactory to find words which are part of compound words (e.g. revision in totalrevision). And finally I want to use Solr highlighting. But there seems to be a problem if I combine the char filter and the compound word filter in combination with highlighting (an org.apache.lucene.search.highlight.InvalidTokenOffsetsException is raised).&lt;/p&gt;

&lt;p&gt;Here are the details:&lt;/p&gt;

&lt;p&gt;types:&lt;br/&gt;
--------&lt;br/&gt;
    &amp;lt;fieldType name=&quot;textAnalyzedFailed&quot; class=&quot;solr.TextField&quot; positionIncrementGap=&quot;100&quot;&amp;gt;&lt;br/&gt;
      &amp;lt;analyzer&amp;gt;&lt;br/&gt;
        &amp;lt;charFilter class=&quot;solr.MappingCharFilterFactory&quot; mapping=&quot;mapping.txt&quot;/&amp;gt;&lt;br/&gt;
        &amp;lt;tokenizer class=&quot;solr.WhitespaceTokenizerFactory&quot;/&amp;gt;&lt;br/&gt;
        &amp;lt;filter class=&quot;solr.DictionaryCompoundWordTokenFilterFactory&quot; dictionary=&quot;words.txt&quot;/&amp;gt;&lt;br/&gt;
      &amp;lt;/analyzer&amp;gt;&lt;br/&gt;
    &amp;lt;/fieldType&amp;gt;&lt;/p&gt;

&lt;p&gt;schema:&lt;br/&gt;
-----------&lt;br/&gt;
  &amp;lt;fields&amp;gt;&lt;br/&gt;
     &amp;lt;field name=&quot;id&quot;         type=&quot;string&quot;               indexed=&quot;true&quot; stored=&quot;true&quot; required=&quot;true&quot; /&amp;gt; &lt;br/&gt;
     &amp;lt;field name=&quot;title&quot;      type=&quot;textAnalyzedFailed&quot;   indexed=&quot;true&quot; stored=&quot;true&quot;/&amp;gt;&lt;br/&gt;
  &amp;lt;/fields&amp;gt;&lt;/p&gt;

&lt;p&gt;document:&lt;br/&gt;
--------------&lt;br/&gt;
  &amp;lt;doc&amp;gt;&lt;br/&gt;
     &amp;lt;field name=&quot;id&quot;&amp;gt;1&amp;lt;/field&amp;gt; &lt;br/&gt;
     &amp;lt;field name=&quot;title&quot;&amp;gt;bank&#252;berfall&amp;lt;/field&amp;gt; &lt;br/&gt;
  &amp;lt;/doc&amp;gt;&lt;/p&gt;

&lt;p&gt;mapping.txt:&lt;br/&gt;
-----------------&lt;br/&gt;
&quot;&#252;&quot; =&amp;gt; &quot;ue&quot;&lt;/p&gt;

&lt;p&gt;words.txt:&lt;br/&gt;
--------------&lt;br/&gt;
fall&lt;/p&gt;

&lt;p&gt;The resulting error when search with:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://localhost:8080/solr/select/?q=bank&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8080/solr/select/?q=bank&lt;/a&gt;&#252;berfall&amp;amp;hl=true&amp;amp;hl.fl=title&lt;/p&gt;

&lt;p&gt;Nov 4, 2011 4:29:12 PM org.apache.solr.core.SolrCore execute&lt;br/&gt;
INFO: [] webapp=/solr path=/select/ params=&lt;/p&gt;
{q=bank?berfall&amp;amp;hl.fl=title_hl&amp;amp;hl=true}
&lt;p&gt; hits=1 status=0 QTime=13 &lt;br/&gt;
Nov 4, 2011 4:29:16 PM org.apache.solr.common.SolrException log&lt;br/&gt;
SEVERE: org.apache.solr.common.SolrException: org.apache.lucene.search.highlight.InvalidTokenOffsetsException: Token fall exceeds length of provided text sized 12&lt;br/&gt;
	at org.apache.solr.highlight.DefaultSolrHighlighter.doHighlightingByHighlighter(DefaultSolrHighlighter.java:469)&lt;br/&gt;
	at org.apache.solr.highlight.DefaultSolrHighlighter.doHighlighting(DefaultSolrHighlighter.java:378)&lt;br/&gt;
	at org.apache.solr.handler.component.HighlightComponent.process(HighlightComponent.java:116)&lt;br/&gt;
	at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:194)&lt;br/&gt;
	at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:129)&lt;br/&gt;
	at org.apache.solr.core.SolrCore.execute(SolrCore.java:1360)&lt;br/&gt;
	at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:356)&lt;br/&gt;
	at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:252)&lt;br/&gt;
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:243)&lt;br/&gt;
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:210)&lt;br/&gt;
	at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:224)&lt;br/&gt;
	at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:175)&lt;br/&gt;
	at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:462)&lt;br/&gt;
	at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:164)&lt;br/&gt;
	at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:100)&lt;br/&gt;
	at org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:851)&lt;br/&gt;
	at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:118)&lt;br/&gt;
	at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:405)&lt;br/&gt;
	at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:278)&lt;br/&gt;
	at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:515)&lt;br/&gt;
	at org.apache.tomcat.util.net.JIoEndpoint$SocketProcessor.run(JIoEndpoint.java:302)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:680)&lt;br/&gt;
Caused by: org.apache.lucene.search.highlight.InvalidTokenOffsetsException: Token fall exceeds length of provided text sized 12&lt;br/&gt;
	at org.apache.lucene.search.highlight.Highlighter.getBestTextFragments(Highlighter.java:228)&lt;br/&gt;
	at org.apache.solr.highlight.DefaultSolrHighlighter.doHighlightingByHighlighter(DefaultSolrHighlighter.java:462)&lt;br/&gt;
	... 23 more&lt;/p&gt;



&lt;p&gt;The analysis tool says the following for field name=title, field value=bank&#252;berfall:&lt;br/&gt;
------------------------------------------------------------------------------------&lt;br/&gt;
Index Analyzer&lt;br/&gt;
org.apache.solr.analysis.MappingCharFilterFactory &lt;/p&gt;
{mapping=mapping.txt, luceneMatchVersion=LUCENE_31}
&lt;p&gt;text	bankueberfall&lt;br/&gt;
org.apache.solr.analysis.WhitespaceTokenizerFactory &lt;/p&gt;
{luceneMatchVersion=LUCENE_31}
&lt;p&gt;position	1&lt;br/&gt;
term text	bankueberfall&lt;br/&gt;
startOffset	0&lt;br/&gt;
endOffset	12&lt;br/&gt;
org.apache.solr.analysis.DictionaryCompoundWordTokenFilterFactory &lt;/p&gt;
{dictionary=words.txt, luceneMatchVersion=LUCENE_31}
&lt;p&gt;position	1&lt;br/&gt;
term text	bankueberfall&lt;br/&gt;
                fall&lt;br/&gt;
startOffset	0&lt;br/&gt;
                9&lt;br/&gt;
endOffset	12&lt;br/&gt;
                13&lt;br/&gt;
flags	        0&lt;br/&gt;
                0&lt;br/&gt;
type	        word&lt;br/&gt;
                word&lt;br/&gt;
payload	&lt;/p&gt;</description>
                <environment>&lt;p&gt;MacOS X, Java 1.6, Tomcat 7&lt;/p&gt;</environment>
        <key id="12531098">SOLR-2891</key>
            <summary>InvalidTokenOffsetsException when using MappingCharFilterFactory, DictionaryCompoundWordTokenFilterFactory and Highlighting</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rcmuir">Robert Muir</assignee>
                                    <reporter username="esteiner">Edwin Steiner</reporter>
                        <labels>
                    </labels>
                <created>Fri, 11 Nov 2011 07:46:45 +0000</created>
                <updated>Fri, 10 May 2013 10:39:38 +0000</updated>
                            <resolved>Sun, 22 Jan 2012 16:49:31 +0000</resolved>
                                    <version>3.1</version>
                    <version>3.4</version>
                                    <fixVersion>3.6</fixVersion>
                    <fixVersion>4.0-ALPHA</fixVersion>
                                    <component>highlighter</component>
                    <component>Schema and Analysis</component>
                    <component>search</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13148433" author="ldb" created="Fri, 11 Nov 2011 11:26:24 +0000"  >&lt;p&gt;it&#180;s an old bug. I have big problems too with OffsetExceptions when i use&lt;br/&gt;
Highlighting, or Carrot.&lt;br/&gt;
It looks like a problem with HTMLStripCharFilter.&lt;br/&gt;
Patch doesn&#180;t work.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2208&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/LUCENE-2208&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13190706" author="rcmuir" created="Sun, 22 Jan 2012 16:33:44 +0000"  >&lt;p&gt;The problem is CompoundWordTokenFilter has the same bugs as &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3642&quot; title=&quot;EdgeNgrams creates invalid offsets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LUCENE-3642&quot;&gt;&lt;del&gt;LUCENE-3642&lt;/del&gt;&lt;/a&gt;. There was a note in the source code (I think noted by Uwe):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// TODO: This ignores the original endOffset, &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; a CharFilter/Tokenizer/Filter removed
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// chars from the term, offsets may not match correctly (other filters producing tokens
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// may also have &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; problem):&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Edwin: thanks for providing good information, i turned this into a test and fixed it the same way as &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3642&quot; title=&quot;EdgeNgrams creates invalid offsets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LUCENE-3642&quot;&gt;&lt;del&gt;LUCENE-3642&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13190707" author="rcmuir" created="Sun, 22 Jan 2012 16:49:31 +0000"  >&lt;p&gt;Thanks Edwin!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12511434" name="SOLR-2891.patch" size="4335" author="rcmuir" created="Sun, 22 Jan 2012 16:33:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>216836</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 44 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i03hxz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>18340</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>