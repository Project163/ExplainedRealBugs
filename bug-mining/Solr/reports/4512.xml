<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:44:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-14467] json.facet&apos;s relatedness() should not cause server errors or nonsense results when combined with allBuckets:true</title>
                <link>https://issues.apache.org/jira/browse/SOLR-14467</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;While testing randomized permutations of json.facet params in combination with the &lt;tt&gt;relatedness()&lt;/tt&gt; function it was discovered that:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;relatedness()&lt;/tt&gt; would produce server errors in many situations when combined with &lt;tt&gt;allBuckets:true&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;In situations where this combination of options was used an a server error did not happen, the computed values for the &lt;tt&gt;relatedness()&lt;/tt&gt; function that would be put in the &lt;tt&gt;allBuckets&lt;/tt&gt; bucket were meaningless&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The end result of this jira was to modify &lt;tt&gt;relatedness()&lt;/tt&gt; to skip computation for the &lt;tt&gt;allBuckets&lt;/tt&gt; bucket&lt;/p&gt;

&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;original description&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;While working on randomized testing for &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13132&quot; title=&quot;Improve JSON &amp;quot;terms&amp;quot; facet performance when sorted by relatedness &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13132&quot;&gt;&lt;del&gt;SOLR-13132&lt;/del&gt;&lt;/a&gt; i discovered a variety of different ways that JSON Faceting&apos;s &quot;allBuckets&quot; option can fail when combined with the &quot;relatedness()&quot; function.&lt;/p&gt;

&lt;p&gt;I haven&apos;t found a trivial way to manual reproduce this, but i have been able to trigger the failures with a trivial patch to &lt;tt&gt;TestCloudJSONFacetSKG&lt;/tt&gt; which i will attach.&lt;/p&gt;

&lt;p&gt;Based on the nature of the failures it looks like it may have something to do with multiple segments of different sizes, and or resizing the SlotAccs ?&lt;/p&gt;

&lt;p&gt;The relatedness() function doesn&apos;t have much (any?) existing tests in place that leverage &quot;allBuckets&quot; so this is probably a bug that has always existed &amp;#8211; it&apos;s possible it may be excessively cumbersome to fix and we might nee/wnat to just document that incompatibility and add some code to try and detect if the user combines these options and if so fail with a 400 error?&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13303512">SOLR-14467</key>
            <summary>json.facet&apos;s relatedness() should not cause server errors or nonsense results when combined with allBuckets:true</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Chris M. Hostetter</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Fri, 8 May 2020 00:36:22 +0000</created>
                <updated>Wed, 15 Jul 2020 15:11:47 +0000</updated>
                            <resolved>Fri, 5 Jun 2020 16:58:12 +0000</resolved>
                                                    <fixVersion>8.6</fixVersion>
                    <fixVersion>9.0</fixVersion>
                                    <component>Facet Module</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17102133" author="hossman" created="Fri, 8 May 2020 00:37:29 +0000"  >
&lt;p&gt;Examples of the various (root cause) failures that can occur with the attached test patch...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   [junit4]   2&amp;gt; 5351 INFO  (qtp10892224-67) [n:127.0.0.1:40385_solr c:org.apache.solr.search.facet.TestCloudJSONFacetSKG_collection s:shard1 r:core_node3 x:org.apache.solr.search.facet.TestCloudJSONFacetSKG_collection_shard1_replica_n1 ] o.a.s.c.S.Request [org.apache.solr.search.facet.TestCloudJSONFacetSKG_collection_shard1_replica_n1]  webapp=/solr path=/select params={df=text&amp;amp;distrib=false&amp;amp;_facet_={}&amp;amp;fl=id&amp;amp;fl=score&amp;amp;shards.purpose=1064964&amp;amp;start=0&amp;amp;fsv=true&amp;amp;back=*:*&amp;amp;shard.url=http://127.0.0.1:40385/solr/org.apache.solr.search.facet.TestCloudJSONFacetSKG_collection_shard1_replica_n1/&amp;amp;rows=0&amp;amp;fore=(field_4_sds:17+OR+field_7_sds:49+OR+field_10_sds:23+OR+field_2_sdsS:7+OR+field_5_sdsS:31+OR+field_6_ss:20+OR+field_4_sds:43+OR+field_14_sdsS:61+OR+field_7_sds:34)&amp;amp;version=2&amp;amp;q=(field_3_ss:44+OR+field_14_sdsS:23+OR+field_13_sds:28+OR+field_6_ss:44)&amp;amp;json.facet={+processEmpty:+true,+facet_1+:+{+type:terms,+field:field_14_idsS,+limit:-1,+overrequest:0,+sort:+&apos;skg+desc&apos;,+allBuckets:true,+refine:+true,+domain:+{+query:+&apos;*:*&apos;+},+facet:{+processEmpty:+true,+facet_2+:+{+type:terms,+field:field_8_idsS,+limit:67,+overrequest:0,+sort:+&apos;index+asc&apos;,+allBuckets:true,+refine:+true,+domain:+{+query:+&apos;*:*&apos;+},+facet:{+processEmpty:+true,+skg+:+&apos;relatedness($fore,$back)&apos;}}+,skg+:+&apos;relatedness($fore,$back)&apos;}}+,facet_3+:+{+type:terms,+field:field_2_idsS,+limit:-1,+overrequest:0,+sort:+&apos;skg+asc&apos;,+allBuckets:true,+refine:+true,+domain:+{+query:+&apos;*:*&apos;+},+facet:{+processEmpty:+true,+skg+:+&apos;relatedness($fore,$back)&apos;}}+}&amp;amp;omitHeader=false&amp;amp;NOW=1588893509649&amp;amp;isShard=true&amp;amp;wt=javabin} hits=12 status=500 QTime=56
   [junit4]   2&amp;gt; 5352 ERROR (qtp1523452543-62) [n:127.0.0.1:33775_solr c:org.apache.solr.search.facet.TestCloudJSONFacetSKG_collection s:shard2 r:core_node4 x:org.apache.solr.search.facet.TestCloudJSONFacetSKG_collection_shard2_replica_n2 ] o.a.s.s.HttpSolrCall null:java.lang.ArrayIndexOutOfBoundsException: Index 128 out of bounds for length 128
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessorByHashDV.lambda$new$3(FacetFieldProcessorByHashDV.java:439)
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.RelatednessAgg$SKGSlotAcc.processSlot(RelatednessAgg.java:189)
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.RelatednessAgg$SKGSlotAcc.collect(RelatednessAgg.java:217)
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessor$SpecialSlotAcc.collect(FacetFieldProcessor.java:772)
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessor.collectFirstPhase(FacetFieldProcessor.java:289)
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessorByHashDV.collectValFirstPhase(FacetFieldProcessorByHashDV.java:430)
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessorByHashDV$5.collect(FacetFieldProcessorByHashDV.java:389)
   [junit4]   2&amp;gt; 	at org.apache.solr.search.DocSetUtil.collectSortedDocSet(DocSetUtil.java:278)
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessorByHashDV.collectDocs(FacetFieldProcessorByHashDV.java:374)
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessorByHashDV.calcFacets(FacetFieldProcessorByHashDV.java:248)
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessorByHashDV.process(FacetFieldProcessorByHashDV.java:215)
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetRequest.process(FacetRequest.java:416)
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetProcessor.processSubs(FacetProcessor.java:475)
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetProcessor.fillBucket(FacetProcessor.java:432)
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetQueryProcessor.process(FacetQuery.java:64)
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetRequest.process(FacetRequest.java:416)
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetModule.process(FacetModule.java:147)



   [junit4]   2&amp;gt; NOTE: reproduce with: ant test  -Dtestcase=TestCloudJSONFacetSKG -Dtests.method=testRandom -Dtests.seed=58E72A6ADD982BE0 -Dtests.slow=true -Dtests.badapples=true -Dtests.locale=it-VA -Dtests.timezone=Etc/GMT-13 -Dtests.asserts=true -Dtests.file.encoding=ISO-8859-1
   [junit4] ERROR   0.11s | TestCloudJSONFacetSKG.testRandom &amp;lt;&amp;lt;&amp;lt;
   [junit4]    &amp;gt; Throwable #1: java.lang.RuntimeException: init query failed: {main(q=(field_6_ss:29+OR+field_8_sdsS:9+OR+field_0_ss:36+OR+field_7_sds:15+OR+field_6_ss:54+OR+field_2_sdsS:50+OR+field_4_sds:47+OR+field_8_sdsS:21)&amp;amp;json.facet={+processEmpty:+true,+facet_1+:+{+type:terms,+field:field_7_sds,+limit:50,+overrequest:0,+sort:+&apos;skg+desc&apos;,+allBuckets:true,+refine:+true,+domain:+{+query:+&apos;*:*&apos;+},+facet:{+processEmpty:+true,+facet_2+:+{+type:terms,+field:field_14_sdsS,+limit:-1,+overrequest:0,+sort:+&apos;count+asc&apos;,+allBuckets:true,+refine:+true,+domain:+{+query:+&apos;*:*&apos;+},+facet:{+processEmpty:+true,+skg+:+&apos;relatedness($fore,$back)&apos;}}+,skg+:+&apos;relatedness($fore,$back)&apos;}}+}),extra(rows=0&amp;amp;fore=(field_13_sds:45+OR+field_0_ss:4+OR+field_9_ss:16+OR+field_3_ss:49)&amp;amp;back=(field_1_sds:20+OR+field_11_sdsS:24+OR+field_12_ss:62+OR+field_12_ss:37))}: Error from server at http://127.0.0.1:42897/solr/org.apache.solr.search.facet.TestCloudJSONFacetSKG_collection: Error from server at null: Expected mime type application/octet-stream but got text/html. &amp;lt;html&amp;gt;
   [junit4]    &amp;gt; &amp;lt;head&amp;gt;
   [junit4]    &amp;gt; &amp;lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html;charset=utf-8&quot;/&amp;gt;
   [junit4]    &amp;gt; &amp;lt;title&amp;gt;Error 500 java.lang.AssertionError&amp;lt;/title&amp;gt;
   [junit4]    &amp;gt; &amp;lt;/head&amp;gt;
   [junit4]    &amp;gt; &amp;lt;body&amp;gt;&amp;lt;h2&amp;gt;HTTP ERROR 500 java.lang.AssertionError&amp;lt;/h2&amp;gt;
   [junit4]    &amp;gt; &amp;lt;table&amp;gt;
   [junit4]    &amp;gt; &amp;lt;tr&amp;gt;&amp;lt;th&amp;gt;URI:&amp;lt;/th&amp;gt;&amp;lt;td&amp;gt;/solr/org.apache.solr.search.facet.TestCloudJSONFacetSKG_collection_shard2_replica_n2/select&amp;lt;/td&amp;gt;&amp;lt;/tr&amp;gt;
   [junit4]    &amp;gt; &amp;lt;tr&amp;gt;&amp;lt;th&amp;gt;STATUS:&amp;lt;/th&amp;gt;&amp;lt;td&amp;gt;500&amp;lt;/td&amp;gt;&amp;lt;/tr&amp;gt;
   [junit4]    &amp;gt; &amp;lt;tr&amp;gt;&amp;lt;th&amp;gt;MESSAGE:&amp;lt;/th&amp;gt;&amp;lt;td&amp;gt;java.lang.AssertionError&amp;lt;/td&amp;gt;&amp;lt;/tr&amp;gt;
   [junit4]    &amp;gt; &amp;lt;tr&amp;gt;&amp;lt;th&amp;gt;SERVLET:&amp;lt;/th&amp;gt;&amp;lt;td&amp;gt;org.apache.solr.client.solrj.embedded.JettySolrRunner$Servlet404-55da7b8b&amp;lt;/td&amp;gt;&amp;lt;/tr&amp;gt;
   [junit4]    &amp;gt; &amp;lt;tr&amp;gt;&amp;lt;th&amp;gt;CAUSED BY:&amp;lt;/th&amp;gt;&amp;lt;td&amp;gt;java.lang.AssertionError&amp;lt;/td&amp;gt;&amp;lt;/tr&amp;gt;
   [junit4]    &amp;gt; &amp;lt;/table&amp;gt;
   [junit4]    &amp;gt; &amp;lt;h3&amp;gt;Caused by:&amp;lt;/h3&amp;gt;&amp;lt;pre&amp;gt;java.lang.AssertionError
   [junit4]    &amp;gt; 	at org.apache.lucene.index.AssertingLeafReader$AssertingSortedSetDocValues.lookupOrd(AssertingLeafReader.java:1004)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessorByArrayDV.lookupOrd(FacetFieldProcessorByArrayDV.java:182)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessorByArray.lambda$new$2(FacetFieldProcessorByArray.java:138)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.RelatednessAgg$SKGSlotAcc.processSlot(RelatednessAgg.java:189)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.RelatednessAgg$SKGSlotAcc.collect(RelatednessAgg.java:217)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessor$SpecialSlotAcc.collect(FacetFieldProcessor.java:772)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessorByArrayDV.collect(FacetFieldProcessorByArrayDV.java:335)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessorByArrayDV.collectDocs(FacetFieldProcessorByArrayDV.java:303)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessorByArrayDV.collectDocs(FacetFieldProcessorByArrayDV.java:171)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessorByArray.calcFacets(FacetFieldProcessorByArray.java:112)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessorByArray.process(FacetFieldProcessorByArray.java:62)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.FacetRequest.process(FacetRequest.java:416)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.FacetProcessor.processSubs(FacetProcessor.java:475)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.FacetProcessor.fillBucket(FacetProcessor.java:432)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.FacetQueryProcessor.process(FacetQuery.java:64)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.FacetRequest.process(FacetRequest.java:416)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.FacetModule.process(FacetModule.java:147)
   [junit4]    &amp;gt; 	at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:328)



   [junit4]   2&amp;gt; java.lang.AssertionError: null
   [junit4]   2&amp;gt; 	at org.apache.lucene.util.packed.PackedLongValues.get(PackedLongValues.java:105) ~[java/:?]
   [junit4]   2&amp;gt; 	at org.apache.lucene.index.OrdinalMap.getFirstSegmentNumber(OrdinalMap.java:344) ~[java/:?]
   [junit4]   2&amp;gt; 	at org.apache.lucene.index.MultiDocValues$MultiSortedSetDocValues.lookupOrd(MultiDocValues.java:884) ~[java/:?]
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessorByArrayDV.lookupOrd(FacetFieldProcessorByArrayDV.java:182) ~[java/:?]
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessorByArray.lambda$new$2(FacetFieldProcessorByArray.java:138) ~[java/:?]
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.RelatednessAgg$SKGSlotAcc.processSlot(RelatednessAgg.java:189) ~[java/:?]
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.RelatednessAgg$SKGSlotAcc.collect(RelatednessAgg.java:217) ~[java/:?]
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessor$SpecialSlotAcc.collect(FacetFieldProcessor.java:772) ~[java/:?]
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessorByArrayDV.collect(FacetFieldProcessorByArrayDV.java:335) ~[java/:?]
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessorByArrayDV.collectDocs(FacetFieldProcessorByArrayDV.java:303) ~[java/:?]
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessorByArrayDV.collectDocs(FacetFieldProcessorByArrayDV.java:171) ~[java/:?]
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessorByArray.calcFacets(FacetFieldProcessorByArray.java:112) ~[java/:?]
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessorByArray.process(FacetFieldProcessorByArray.java:62) ~[java/:?]
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetRequest.process(FacetRequest.java:416) ~[java/:?]
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetProcessor.processSubs(FacetProcessor.java:475) ~[java/:?]
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessor.fillBucketFromSlot(FacetFieldProcessor.java:545) ~[java/:?]
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessor.findTopSlots(FacetFieldProcessor.java:446) ~[java/:?]
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessorByHashDV.calcFacets(FacetFieldProcessorByHashDV.java:250) ~[java/:?]
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetFieldProcessorByHashDV.process(FacetFieldProcessorByHashDV.java:215) ~[java/:?]
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetRequest.process(FacetRequest.java:416) ~[java/:?]
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetProcessor.processSubs(FacetProcessor.java:475) ~[java/:?]
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetProcessor.fillBucket(FacetProcessor.java:432) ~[java/:?]
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetQueryProcessor.process(FacetQuery.java:64) ~[java/:?]
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetRequest.process(FacetRequest.java:416) ~[java/:?]
   [junit4]   2&amp;gt; 	at org.apache.solr.search.facet.FacetModule.process(FacetModule.java:147) ~[java/:?]
   [junit4]   2&amp;gt; 	at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:328) ~[java/:?]



&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="17107321" author="mgibney" created="Thu, 14 May 2020 13:58:50 +0000"  >&lt;p&gt;Hi Hoss, I&apos;ve been looking into this (over at &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13132&quot; title=&quot;Improve JSON &amp;quot;terms&amp;quot; facet performance when sorted by relatedness &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13132&quot;&gt;&lt;del&gt;SOLR-13132&lt;/del&gt;&lt;/a&gt;), but I noticed that the test patch attached here only removes the &lt;tt&gt;TestCloudJSONFacetSKG.java&lt;/tt&gt; file from master, and doesn&apos;t add any tests?&lt;/p&gt;

&lt;p&gt;I also have a more general question about the semantics of &lt;tt&gt;allBuckets&lt;/tt&gt;. From the ref guide:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;A boolean. If true, adds an &#8220;allBuckets&#8221; bucket to the response, representing the union of all of the buckets. For multi-valued fields, this is different than a bucket for all of the documents in the domain since a single document can belong to multiple buckets. Defaults to false.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The ref guide docs for &lt;tt&gt;allBuckets&lt;/tt&gt; seem ambiguous to me wrt whether &lt;tt&gt;allBuckets&lt;/tt&gt; represents the union of all buckets across the full domain, or the union of all &lt;em&gt;returned&lt;/em&gt; buckets. For the latter, &lt;tt&gt;allBuckets&lt;/tt&gt; stats would be inconsistent across different settings of &lt;tt&gt;limit&lt;/tt&gt; for deferred stats, but consistent for non-deferred (&lt;tt&gt;collectAcc&lt;/tt&gt;) stats. My initial intuition is that having stats for &lt;tt&gt;allBuckets&lt;/tt&gt; represent the union across all buckets (whether returned or not) would be preferable, but I think that would mean preventing &lt;em&gt;any&lt;/em&gt; deferral of stats when &lt;tt&gt;allBuckets==true&lt;/tt&gt;, which is not currently done. But I think that approach (if chosen) would be pretty straightforward: if &lt;tt&gt;allBuckets==true&lt;/tt&gt;, instead of creating any &lt;tt&gt;otherAccs&lt;/tt&gt;, simply add all accs to &lt;tt&gt;collectAcc&lt;/tt&gt; using &lt;tt&gt;MultiAcc&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="17107525" author="hossman" created="Thu, 14 May 2020 18:05:52 +0000"  >&lt;blockquote&gt;&lt;p&gt;I noticed that the test patch attached here only removes the TestCloudJSONFacetSKG.java file from master, and doesn&apos;t add any tests?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Hmm, yeah - not sure how i botched that .. IIRC my &quot;trivial patch to TestCloudJSONFacetSKG&quot; to demonstrate the various errors was simply adding a hardcoded &lt;tt&gt;allBuckets:true,&lt;/tt&gt; to the JSON output string in the &lt;tt&gt;TermFacet&lt;/tt&gt; class.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;My initial intuition is that having stats for allBuckets represent the union across all buckets (whether returned or not)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That is hte only interpretation i have ever had/imagined for how allBuckets is ment to work, and jives with how it behaves for count and &quot;simple&quot; stats...&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ bin/solr -e techproducts
...
$ curl http://localhost:8983/solr/techproducts/query -d &apos;q=*:*&amp;amp;rows=0&amp;amp;omitHeader=true&amp;amp;json.facet=
{
  &quot;categories&quot;: {
    &quot;type&quot;: &quot;terms&quot;,
    &quot;field&quot;: &quot;cat&quot;,
    &quot;limit&quot;: 1,
    allBuckets: true,
    facet : { sum : &quot;sum(price)&quot; }
  }
}&apos;

{
  &quot;response&quot;:{&quot;numFound&quot;:32,&quot;start&quot;:0,&quot;numFoundExact&quot;:true,&quot;docs&quot;:[]
  },
  &quot;facets&quot;:{
    &quot;count&quot;:32,
    &quot;categories&quot;:{
      &quot;allBuckets&quot;:{
        &quot;count&quot;:37,
        &quot;sum&quot;:8563.560066223145},
      &quot;buckets&quot;:[{
          &quot;val&quot;:&quot;electronics&quot;,
          &quot;count&quot;:12,
          &quot;sum&quot;:2772.3200187683105}]}}}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;blockquote&gt;&lt;p&gt;...but I think that would mean preventing any deferral of stats when allBuckets==true, which is not currently done. But I think that approach (if chosen) would be pretty straightforward: if allBuckets==true, instead of creating any otherAccs, simply add all accs to collectAcc using MultiAcc?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Hmmmm.... I&apos;m really not sure either way &#8211; but IIUC the whole point of SpecialSlotAcc is that it &lt;b&gt;does/can&lt;/b&gt; do collection against all of the &lt;tt&gt;otherAccs&lt;/tt&gt; using the &lt;tt&gt;otherAccsSlot&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I suspsect the key bug here is just in how the &lt;tt&gt;slotContext&lt;/tt&gt; works when dealing with these &quot;special&quot; slots ... SpecialSlotAcc may just need to ensure it passes down it&apos;s own slot context that ignores the slot# it get&apos;s passed and instead wraps/hides usage of SpecialSlotAcc.otherAccsSlot/SpecialSlotAcc.collectAccSlot as needed? (which i gather may be along the lines of what you&apos;ve recently tried adding in your recent &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13132&quot; title=&quot;Improve JSON &amp;quot;terms&amp;quot; facet performance when sorted by relatedness &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13132&quot;&gt;&lt;del&gt;SOLR-13132&lt;/del&gt;&lt;/a&gt; commits? ... haven&apos;t dug in there yet).&lt;/p&gt;

&lt;p&gt;If that&apos;s really the underlying problem then it won&apos;t really matter if MultiAcc is used everytime we have &lt;tt&gt;allBuckets:true&lt;/tt&gt; situation, because we&apos;ll still need that &quot;slot mapping&quot; logic for the special slot.&lt;/p&gt;

&lt;p&gt;Ultimately though, I still don&apos;t have a good conceptual grasp of what the &quot;correct&quot; &lt;tt&gt;relatedness()&lt;/tt&gt; stats &lt;em&gt;should be&lt;/em&gt; for the &lt;tt&gt;allBuckets&lt;/tt&gt; situation &#8211; relatedness values are fundamentally about the &quot;domain&quot; of the entire bucket realteive to the foreground/background sets, so doesn&apos;t really make sense to try and &quot;merge&quot; the values from multiple buckets. Ultimately it may not matter &lt;em&gt;what&lt;/em&gt; value we compute for &lt;tt&gt;relatedness()&lt;/tt&gt; in an &lt;tt&gt;allBuckets:true&lt;/tt&gt; bucket (My gut says we should just using the &lt;tt&gt;base&lt;/tt&gt; DocSet/domain for the entire facet as the slotContext in SpecialSlotAcc, ... but i can imagine there might be other interpretations) as long as we don&apos;t &quot;fail&quot; with an error if someone tries.&lt;/p&gt;</comment>
                            <comment id="17108477" author="mgibney" created="Fri, 15 May 2020 17:21:40 +0000"  >&lt;p&gt;That all sounds exactly right to me (sorry about the confusion &#8211; I realize my concern about &lt;em&gt;needing&lt;/em&gt; to prevent deferral of stats when &lt;tt&gt;allBuckets==true&lt;/tt&gt; was misplaced).&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;the key bug here is just in how the&#160;&lt;tt&gt;slotContext&lt;/tt&gt;&#160;works when dealing with these &quot;special&quot; slots&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes, and the approach you&apos;ve described (a special slotContext that ignores the slot# it&apos;s passed) is indeed what&apos;s introduced over at &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13132&quot; title=&quot;Improve JSON &amp;quot;terms&amp;quot; facet performance when sorted by relatedness &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13132&quot;&gt;&lt;del&gt;SOLR-13132&lt;/del&gt;&lt;/a&gt; (in&#160;3ec93950373b0f9e7777bbab52992c5514727260).&lt;/p&gt;

&lt;p&gt;A quick overview of some of the simple stats Accs in &lt;tt&gt;SlotAcc.java&lt;/tt&gt; (e.g., MinMax, Sum, Variance, etc.) shows that, unsurprisingly, most (all?) seem to ignore &lt;tt&gt;slotContext&lt;/tt&gt; (which explains why Relatedness has issues with &lt;tt&gt;allBuckets&lt;/tt&gt;, but other stats don&apos;t). I&apos;ve attached &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13004759/13004759_SOLR-14467.patch&quot; title=&quot;SOLR-14467.patch attached to SOLR-14467&quot;&gt;SOLR-14467.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; which takes the approach of separating the slot for &lt;em&gt;accumulation&lt;/em&gt; purposes from the slot for &lt;em&gt;context&lt;/em&gt; purposes. Putting the onus on individual &lt;tt&gt;SlotAcc&lt;/tt&gt;&#160;implementations to determine whether or not they need the slotContext seems to cleanly address these issues without introducing unnecessary overhead.&lt;/p&gt;

&lt;p&gt;Thanks for the heads-up about the expectation of focusing on &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14477&quot; title=&quot;relatedness() values can be wrong when using &amp;#39;prefix&amp;#39;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14477&quot;&gt;&lt;del&gt;SOLR-14477&lt;/del&gt;&lt;/a&gt;; but when you&apos;re able to take a look, I&apos;m curious to know what you make of the approach in the attached patch. If you think this approach is good (and if you haven&apos;t yet done work based off the &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14467&quot; title=&quot;json.facet&amp;#39;s relatedness() should not cause server errors or nonsense results when combined with allBuckets:true&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14467&quot;&gt;&lt;del&gt;SOLR-14467&lt;/del&gt;&lt;/a&gt;&quot; commits at PR #751 and it&apos;s ok with you) I could force-push/overwrite those commits, replacing the initial approach taken there with the approach taken here.&lt;/p&gt;</comment>
                            <comment id="17112695" author="hossman" created="Thu, 21 May 2020 01:15:25 +0000"  >&lt;blockquote&gt;&lt;p&gt;... unsurprisingly, most (all?) seem to ignore slotContext ...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Correct. slotContext was introduced when the &lt;tt&gt;relatedness()&lt;/tt&gt; stat was added. Prior to that, all &quot;stats&quot; were simple aggregations of document field values &#8211; they cared only about the individual documents, not the &quot;set&quot; of documents that make up the bucket.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;relatedness()&lt;/tt&gt; introduced the need for knowing &quot;context&quot; about the current bucket/slot for the purpose of computing statistical results that couldn&apos;t be aggregated from the individual document values.&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;SlotContext&lt;/tt&gt; API was added as a &quot;hook&quot; to capture the information currently needed by &lt;tt&gt;relatedness()&lt;/tt&gt; (the &lt;tt&gt;Query&lt;/tt&gt;) and to provide an extention point for the future if/when any additional info that might be needed by other &quot;advanced&quot; stats about the context of the bucket. The &lt;tt&gt;collect()&lt;/tt&gt; API was extended to take in a &lt;tt&gt;IntFunction&amp;lt;SlotContext&amp;gt;&lt;/tt&gt; (as opposed to just &lt;tt&gt;SlotContext&lt;/tt&gt;) so that there would be no overhead for &quot;simple&quot; aggregations that only care about the individual documents and their field values &#8211; ex: computing &quot;sum(price)&quot; under a &quot;terms&quot; facet on the &quot;category&quot; doesn&apos;t result in building a &lt;tt&gt;SlotContext&lt;/tt&gt; (object or a &lt;tt&gt;TermQuery&lt;/tt&gt;) for evey facet bucket, because the &quot;sum&quot; aggretaion never invokes the &lt;tt&gt;IntFunction&lt;/tt&gt;.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I&apos;m curious to know what you make of the approach in the attached patch.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;My Initial impressions:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;i don&apos;t like the idea of adding yet another collect method signature to specify the &quot;accumulation&quot; slot independently of the &quot;collection&quot; slot ... i think that if that info really is useful it should just be added as a new method callback in the &lt;tt&gt;SlotContext&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;I &lt;em&gt;really&lt;/em&gt; don&apos;t like adding &lt;tt&gt;instanceof&lt;/tt&gt; checks to &lt;tt&gt;RelatednessAgg&lt;/tt&gt; that make hardocded assumptions about what impls will/won&apos;t ever exist or support allBuckets
	&lt;ul&gt;
		&lt;li&gt;reading &lt;tt&gt;allBucketsSlot&lt;/tt&gt; once and assuming it will never change is also a brittle assumption that defies the design of the Resizer API &#8211; having just fixed&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14492&quot; title=&quot;many json.facet aggregations can throw ArrayIndexOutOfBoundsException when using DVHASH due to incorrect resize impl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14492&quot;&gt;&lt;del&gt;SOLR-14492&lt;/del&gt;&lt;/a&gt;, I&apos;m pretty sure this will break with DVHASH.&lt;/li&gt;
		&lt;li&gt;Again: I think it would be better if this info was conveyed via the SlotContext, using some Enum or flag&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;trackAllBucketsTermOrds looks like it&apos;s broken if/when a Resizer is used? ... i don&apos;t see any resize calls for it (again: pretty sure this will break with DVHASH)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In general i feel like this patch jumps through a lot of hoops to try and &quot;support&quot; &lt;tt&gt;allBuckets&lt;/tt&gt; on &lt;tt&gt;relatedness()&lt;/tt&gt; &#8211; to the point of (IIUC?) a lot of new bookkeeping about when we&apos;ve already accumulated this slot, but not for the same contextSlotOrd, in which case we merge it (in a way that i&apos;m not sure at a glance is correct? .. it might be, but i think i saw a place where we overwrite a slot value with a new BUcketData w/o checking if it&apos;s non-null?) .... but none of this really answers the question of whether this accumulated/merged &lt;tt&gt;relatedness()&lt;/tt&gt; calculation is &lt;b&gt;meaningful&lt;/b&gt; in the allBucket context?&lt;/p&gt;

&lt;p&gt;That&apos;s really the question that should be asked before doing any work to make the code more complicated: Is there any semantic &lt;b&gt;meaning&lt;/b&gt; behind returning a &lt;tt&gt;relatedness()&lt;/tt&gt; score for the &lt;tt&gt;allBuckets:true&lt;/tt&gt; situation?&lt;/p&gt;

&lt;p&gt;I would argue the answer is &quot;No&quot; ...&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;relatedness()&lt;/tt&gt; is inherently a computation of how the population of the &lt;em&gt;&lt;b&gt;SET&lt;/b&gt;&lt;/em&gt; of documents in a bucket intersects with the population of the &quot;foreground&quot; and &quot;background&quot; sets of documents. &lt;tt&gt;allBuckets&lt;/tt&gt; is fundamental about merging the a*ccumulated results* of many different buckets &lt;em&gt;even when the sets of documents in those buckets overlap&lt;/em&gt; due to the buckets corresponding with multivalued field.&lt;/p&gt;

&lt;p&gt;I said before...&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;My gut says we should just using the base DocSet/domain for the entire facet as the slotContext in SpecialSlotAcc ...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;... but the more i think about it the more i feel like that would also be missleading, A user that explicitly requested &lt;tt&gt;allBuckets: true&lt;/tt&gt; knowing that the resulting sub-stat calculations will be different then just computing stats on the &quot;base&quot; set, would then be misslead by &lt;tt&gt;relatedness()&lt;/tt&gt; values that don&apos;t factor in counting the same document more then once because they occur in multiple buckets ... but likewise adding special logic to &quot;double count&quot; documents based on how many buckets they are in seems like it would violate the intent of &lt;tt&gt;relatedness()&lt;/tt&gt; since the calculations are currently focused solely on the &lt;em&gt;set&lt;/em&gt; of documents, and don&apos;t consider things like &quot;these buckets are based on term values, how many times does this term appear in each document?&quot;&lt;/p&gt;

&lt;p&gt;I think the safe thing to do (for now) is say &quot; &lt;tt&gt;relatedness()&lt;/tt&gt; is meaningless in &lt;tt&gt;allBuckets&lt;/tt&gt; .&quot; ... in a way that fixes the Server errors, and leave open the possibility of revisting the idea later.&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;Here&apos;s what i would propose we do...&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;add &lt;tt&gt;public boolean isAllBucket() { return false;&lt;/tt&gt;} to SlotContext
	&lt;ul&gt;
		&lt;li&gt;&lt;tt&gt;SpecialSlotAcc&lt;/tt&gt; should override this to return true&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;SKGSlotAcc.processSlot()&lt;/tt&gt; should start checking for &lt;tt&gt;isAllBucket()&lt;/tt&gt;
	&lt;ul&gt;
		&lt;li&gt;when true, asign to that slot a &lt;tt&gt;new AllBucketsSpecialBucketData(agg)&lt;/tt&gt; and return immediately (no need to do any calculations)&lt;/li&gt;
		&lt;li&gt;this would be a new &lt;tt&gt;BucketData&lt;/tt&gt; subclass that overrides &lt;tt&gt;externalize&lt;/tt&gt; so that the &quot;final&quot; bucket returned to the end user is null (or maybe an empty map? ... not sure what would be better)
		&lt;ul&gt;
			&lt;li&gt;probably need to return something special in the &lt;tt&gt;isShard&lt;/tt&gt; situation and update FacetMerger to recognize thisand return the correct BucketData instance on merging?&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Add a note in the ref-gude explaining that &lt;tt&gt;relatedness()&lt;/tt&gt; scores are meaningless in the context of &lt;tt&gt;allBucket&lt;/tt&gt; so we don&apos;t compute them, and explain what users should expect in the result...&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The end result being that people can still use &lt;tt&gt;relatedness()&lt;/tt&gt; as a sub-stat of a &lt;tt&gt;terms&lt;/tt&gt; facet that uses the &lt;tt&gt;allBuckets: true&lt;/tt&gt; option (ie: if they are interesting computing &lt;em&gt;other&lt;/em&gt; stats across &lt;tt&gt;allBuckets&lt;/tt&gt; ) but the &lt;tt&gt;relatedness()&lt;/tt&gt; value that gets put in the &lt;tt&gt;allBuckets&lt;/tt&gt; output will be &quot;empty&quot;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;thoughts?&lt;/p&gt;</comment>
                            <comment id="17114234" author="mgibney" created="Fri, 22 May 2020 16:55:47 +0000"  >&lt;p&gt;This sounds good to me.&lt;/p&gt;

&lt;p&gt;One general question: when &lt;tt&gt;SlotContext.isAllBucket()==true&lt;/tt&gt;, what would be returned by &lt;tt&gt;SlotContext.getSlotQuery()&lt;/tt&gt;? I agree that using the base DocSet/domain for the entire facet as the slotContext in SpecialSlotAcc would be misleading. (I had also wondered about using &lt;tt&gt;field:&lt;span class=&quot;error&quot;&gt;&amp;#91;* TO *&amp;#93;&lt;/span&gt;&lt;/tt&gt;, which would be slightly different, but equally misleading for all the same reasons you identified). So if there&apos;s no single slotQuery that &lt;em&gt;wouldn&apos;t&lt;/em&gt; be misleading in the allBuckets case, the options could be:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;treat &lt;tt&gt;isAllBucket()==true&lt;/tt&gt; as mutually exclusive with &lt;tt&gt;getSlotQuery()&lt;/tt&gt;, and have the latter either return &lt;tt&gt;null&lt;/tt&gt; or throw an &lt;tt&gt;IllegalStateException&lt;/tt&gt;?&lt;/li&gt;
	&lt;li&gt;allow SlotContext to wrap the original (i.e. not allBuckets) slot and slotContext, e.g.:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;SlotContext {
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isAllBuckets;
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Query slotQuery;
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; originalSlot = -1;
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; IntFunction&amp;lt;SlotContext&amp;gt; originalContext;
  &lt;span class=&quot;code-comment&quot;&gt;/** constructs a normal instance */&lt;/span&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; SlotContext(Query slotQuery) {
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.slotQuery = slotQuery;
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.isAllBuckets = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
  }
  &lt;span class=&quot;code-comment&quot;&gt;/** constructs an allBuckets instance */&lt;/span&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; SlotContext() {
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.slotQuery = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.isAllBuckets = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
  }
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Query getSlotQuery() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; isAllBuckets ? originalContext.apply(originalSlot).getSlotQuery() : slotQuery;
  }
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isAllBuckets() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; isAllBuckets;
  }
  &lt;span class=&quot;code-comment&quot;&gt;/** provides access to the original slot, &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; desired? */&lt;/span&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; getOriginalSlot() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; originalSlot;
  }
  &lt;span class=&quot;code-comment&quot;&gt;/** called by SpecialSlotAcc before passing to collectAcc/otherAccs */&lt;/span&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void updateAllBuckets(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; originalSlot, IntFunction&amp;lt;SlotContext&amp;gt; originalContext) {
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.originalSlot = originalSlot;
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.originalContext = originalContext;
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;FWIW I thought a little more about why I proceeded under the assumption that &lt;tt&gt;relatedness()&lt;/tt&gt; would be meaningful for &lt;tt&gt;allBuckets&lt;/tt&gt;. I actually &lt;em&gt;do&lt;/em&gt; think it could be relevant, but in a way that (upon further reflection) I think can only be practically calculated using sweep collection. And for that matter, considering the problems and awkwardness you identified with making &lt;tt&gt;RelatednessAgg&lt;/tt&gt; directly aware of &lt;tt&gt;allBucketsSlot&lt;/tt&gt; and &quot;double-counting&quot;, could (I think?) be best supported by extending the concept of &quot;sweep collection&quot; to cover &quot;normal&quot; &lt;tt&gt;allBuckets&lt;/tt&gt; collection. I&apos;m not exactly sure what that would look like, but in any event it seems clear that it would be a different issue, if there&apos;s even any interest in pursuing it.&lt;/p&gt;

&lt;p&gt;To briefly expand on why I think &lt;tt&gt;relatedness()&lt;/tt&gt; might be meaningful for &lt;tt&gt;allBuckets&lt;/tt&gt;: at a high level, say you have 5 buckets returned out of 10 total buckets, and each of the 5 returned is perfectly correlated (relatedness==1.0). Despite this, you have no way of knowing how &quot;special&quot; these buckets are in the overall context of field you&apos;re faceting on ... perhaps all 10 bucket values are perfectly correlated; or perhaps the 5 buckets that weren&apos;t returned are perfectly &lt;em&gt;negatively&lt;/em&gt; correlated (relatedness==-1.0). I &lt;em&gt;think&lt;/em&gt; that calculating relatedness over allBuckets (with fgCount=&quot;sum(fgCount) over all buckets&quot;, bgCount=&quot;sum(bgCount) over all buckets&quot;, and fgSize and bgSize each multiplied by the total number of buckets) should give you a meaningful way of normalizing/contextualizing relatedness scores of individual buckets. But the non-sweep implementation of relatedness, being driven by the presence of values in the base domain, would be a bad fit for this, since it ignores all buckets not represented in the base domain (regardless of whether they might have values in the fgSet or bgSet that would be relevant to calculating a meaningful &quot;allBuckets&quot; relatedness score).&lt;/p&gt;</comment>
                            <comment id="17114300" author="mgibney" created="Fri, 22 May 2020 18:09:28 +0000"  >&lt;p&gt;Oh, and in light of this conversation, I&apos;m guessing we should probably force-push/overwrite all of my most recent (last 5, &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14467&quot; title=&quot;json.facet&amp;#39;s relatedness() should not cause server errors or nonsense results when combined with allBuckets:true&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14467&quot;&gt;&lt;del&gt;SOLR-14467&lt;/del&gt;&lt;/a&gt;-related commits) at&#160;&lt;a href=&quot;https://github.com/apache/lucene-solr/pull/751/commits/add5d8ed168faf872ed62212d388f09284fd04b8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR #751&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17116880" author="hossman" created="Tue, 26 May 2020 16:37:51 +0000"  >
&lt;blockquote&gt;&lt;p&gt;One general question: when SlotContext.isAllBucket()==true, what would be returned by SlotContext.getSlotQuery()?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I would suggest that the javadoc for &lt;tt&gt;getQuery()&lt;/tt&gt; should say that it&apos;s behavior is undefined if &lt;tt&gt;isAllBucket()&lt;/tt&gt; is true &amp;#8211; from an implementation standpoint i think throwing &lt;tt&gt;IllegalStateException&lt;/tt&gt; is is going to be the best/fastest way to catch bugs.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;FWIW I thought a little more about why I proceeded under the assumption that relatedness() would be meaningful for allBuckets. I actually do think it could be relevant, but in a way that (upon further reflection) I think can only be practically calculated using sweep collection. ...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Let&apos;s file a new &quot;Improvement&quot; jira to re-consider this topic down the road, cross link back to this issue for the existing context/discussion of semantic meaning &amp;amp; implementation ideas, and make sure that the changes we make to SlotAcc &amp;amp; SKGAcc for this bug fix have &apos;TODO&apos; comments linking to the new issue as possible improvements.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;Oh, and in light of this conversation, I&apos;m guessing we should probably force-push/overwrite all of my most recent ...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Well, that&apos;s entirely up to you &amp;#8211; it&apos;s your repo, and doesn&apos;t affect me much (both because i odn&apos;t have any significant unpushed changes, and because i&apos;m always very cautions about preserving work in patch files and stashes).  &lt;/p&gt;

&lt;p&gt;If you&apos;re asking my opinion: I personally think force-push is the single greatest failure in the design of GIT, and if i was in charge at github I would completely disable it for all repos and tell people who want to use it to find hosting elsewhere ... it&apos;s the antithesis of collab development (even if there&apos;s only one person with rights to &quot;push&quot; it can cause problems for anyone who has the ability to &quot;fetch&quot; and depends on the repo).&lt;/p&gt;

&lt;p&gt;If your motivation is to try and keep the history on the PR branch clean, don&apos;t worry about it &amp;#8211; i&apos;m not sure how PR normally get &quot;applied&quot; if you use the gitub UI, but i&apos;ll ultimately do it manually either via squash merge or by actually generating a new patch file (I mentioned before: I&apos;m old school)&lt;/p&gt;</comment>
                            <comment id="17117154" author="hossman" created="Tue, 26 May 2020 22:25:52 +0000"  >&lt;p&gt;I&apos;ve updated &lt;tt&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14467&quot; title=&quot;json.facet&amp;#39;s relatedness() should not cause server errors or nonsense results when combined with allBuckets:true&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14467&quot;&gt;&lt;del&gt;SOLR-14467&lt;/del&gt;&lt;/a&gt;_test.patch&lt;/tt&gt; to now (really) test what happens if &lt;tt&gt;allBuckets:true&lt;/tt&gt; is specified, and assert the behavior we&apos;ve discussed (although some tweaks may be needed depending on the final output chosen).  &lt;/p&gt;

&lt;p&gt;(The patch also includes test logic to skip trying to use allBuckets when STREAM parser may be used - see &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14514&quot; title=&quot;json.facets: method:stream is incompatible with allBuckets:true&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14514&quot;&gt;&lt;del&gt;SOLR-14514&lt;/del&gt;&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgibney&quot; class=&quot;user-hover&quot; rel=&quot;mgibney&quot;&gt;mgibney&lt;/a&gt; - did you (still) want to take a stab at the new solution we discussed to fix this or should i start working on it?&lt;/p&gt;</comment>
                            <comment id="17117822" author="mgibney" created="Wed, 27 May 2020 14:49:12 +0000"  >&lt;p&gt;I just uploaded a patch that I think covers everything we discussed above. There&apos;s a nocommit marking an edge case problem for distributed merging. I think this happens for the case buckets are merged without any shard having initialized a bucket. If all the shards are implied (counts of zero), then there&apos;s no way to know whether the term is allBuckets or a term bucket, and it&apos;s not possible to choose the proper &lt;tt&gt;externalize(boolean)&lt;/tt&gt; implementation.&lt;/p&gt;

&lt;p&gt;... although, as I write this, I &lt;em&gt;think&lt;/em&gt; maybe we &lt;em&gt;can&lt;/em&gt; choose ... but I&apos;m not sure how to test/verify this. I&apos;m thinking that any term bucket that is merged is guaranteed to have at least one &quot;materialized&quot; (i.e., not &quot;implied/empty&quot;) &lt;tt&gt;BucketData&lt;/tt&gt;, which would identify that mergeResult as being for a term bucket, not allBuckets. But the &lt;tt&gt;allBuckets&lt;/tt&gt; bucket is present (and gets merged) regardless of whether there&apos;s any &quot;materialized&quot; content there, so if all the merged buckets are all &quot;implied/empty&quot;, perhaps we can infer that we&apos;re dealing with the &quot;allBuckets&quot; bucket?&lt;/p&gt;</comment>
                            <comment id="17117826" author="mgibney" created="Wed, 27 May 2020 14:56:41 +0000"  >&lt;p&gt;More specifically, I&apos;m thinking we might be able to do something like this?:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; getMergedResult() {
      &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; BucketData bucketData;
      &lt;span class=&quot;code-keyword&quot;&gt;switch&lt;/span&gt; (bucketType) {
        &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;:
          &lt;span class=&quot;code-comment&quot;&gt;// NOTE: TERM buckets would always have at least one shard with a &lt;span class=&quot;code-quote&quot;&gt;&quot;materialized&quot;&lt;/span&gt; bucket, so &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;
&lt;/span&gt;          &lt;span class=&quot;code-comment&quot;&gt;// all the buckets are implied/empty, we can infer we&apos;re dealing with the allBuckets bucket.
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; ALL_BUCKET:
          bucketData = ALL_BUCKETS_SPECIAL_BUCKET_DATA;
          &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; TERM:
          bucketData = mergedData;
          &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
      }
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; bucketData.externalize(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17118199" author="hossman" created="Thu, 28 May 2020 01:12:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;There&apos;s a nocommit marking an edge case problem for distributed merging. I think this happens for the case buckets are merged without any shard having initialized a bucket.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Ah yeah ... that is an interesting edge case. (discussion of your suggested solution below)&lt;/p&gt;

&lt;p&gt;Another interesting discrepancy in the output that I noticed when testing your patch is that in &quot;single core&quot; mode the &quot;key&quot; for &lt;tt&gt;relatedness()&lt;/tt&gt; is completley missing from the &lt;tt&gt;allBuckets&lt;/tt&gt; bucket while in distributed mode the key was coming back with a literal value of &lt;tt&gt;null&lt;/tt&gt;. (It jumped out at me because i didn&apos;t understand why you had needed to add the &lt;tt&gt;notPresent(List)&lt;/tt&gt; method to the test &#8211; and then realized it was to account for the possibility that either the key had no values, or the key had a &lt;tt&gt;null&lt;/tt&gt; value).&lt;/p&gt;

&lt;p&gt;I confirmed this is because of a logic discrepancy between how the per-shard (and single core) code paths dealing with &lt;tt&gt;SlotAcc.getValue()&lt;/tt&gt; ignore result values of &lt;tt&gt;null&lt;/tt&gt; (and don&apos;t add the key to the response) but the corresponding code path in &lt;tt&gt;FacetBucket.getMergedBucket()&lt;/tt&gt; does not &#8211; we should be able to (safely) fix &lt;tt&gt;FacetBucket.getMergedBucket()&lt;/tt&gt; to be consistent w/o impacting any other aggregations, since &lt;tt&gt;RelatednessAgg&lt;/tt&gt; is the only one that can produce a &quot;non-null&quot; slot value on a shard (to return the fg/bg sizes for buckets that don&apos;t exist on the shard) but may still want a final &quot;null&quot; merged value (for allBuckets).&lt;/p&gt;

&lt;p&gt;(stats like &quot;sum&quot; always return a value at the shard level, even if there are no docs in the bucket, so they always produce a merged value; while stats like &quot;min&quot; don&apos;t return anything at the shard level if no docs are in the bucket, so a merger is never initialized)&lt;/p&gt;

&lt;p&gt;Which circles back to your point about merging in the situation where there are no buckets: we also have to consider the &quot;how allBuckets behaves when there are no buckets&quot; in the &lt;em&gt;non&lt;/em&gt; cloud case, where no merging happens &#8211; based on testing, some (not sure if all?) processors evidently do&apos;t do any collection on the the &lt;tt&gt;allBuckets&lt;/tt&gt; slot at all in this situation &#8211; meaning that with the &lt;tt&gt;implied&lt;/tt&gt; concept you introduced for the &quot; &lt;tt&gt;// since we haven&apos;t been told about any docs for this slot, use a slot w/no counts&lt;/tt&gt; &quot; code path of &lt;tt&gt;getValue(int)&lt;/tt&gt;, we have to ensure that (in the non-shard situation) a bucket that is implied externalizes as &lt;tt&gt;null&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;So here&apos;s an updated patch with some additional improvements/fixes...&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;rolled the test patch and the code patch into one&lt;/li&gt;
	&lt;li&gt;beefed up javadocs for the SlotContext API methods&lt;/li&gt;
	&lt;li&gt;tweaked ref-guide wording to make it clear the &lt;tt&gt;relatedness()&lt;/tt&gt; key won&apos;t be in the &lt;tt&gt;allBuckets&lt;/tt&gt; bucket at all&lt;/li&gt;
	&lt;li&gt;tweaked TestCloudJSONFacetSKG to require that the key must be explicitly missing from allBuckets&lt;/li&gt;
	&lt;li&gt;added explicit testing of both basic allBuckets usage as well as the &quot;allBuckets when there are no regular buckets&quot; situation to to TestJsonFacets &amp;amp; TestJsonFacetRefinement&lt;/li&gt;
	&lt;li&gt;fixed &lt;tt&gt;FacetBucket.getMergedBucket()&lt;/tt&gt; to ignore null (merged) values from stats&lt;/li&gt;
	&lt;li&gt;fixed &lt;tt&gt;BucketData.externalize()&lt;/tt&gt; to consider &lt;tt&gt;implied&lt;/tt&gt; flag for the non-shard case and return null&lt;/li&gt;
	&lt;li&gt;added some nocommits with reminders to revisit &amp;amp; consider if/how &lt;tt&gt;implied&lt;/tt&gt; should affect plumbing methods like hashCode, equals, compareTo, etc...&lt;/li&gt;
	&lt;li&gt;incorporate your suggested change to &lt;tt&gt;BucketData.getMergedResult()&lt;/tt&gt; to assume that entirely implied (merged data must be allBuckets&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;...back to your idea: i think you&apos;re correct, and this change should be safe. I&apos;m trying to beast it now and wnat to think about it more ... BUT ... I think even if/once we confirm this is a &quot;correct&quot; fix, there might be a simpler solution?&lt;/p&gt;

&lt;p&gt;Since we definitely need the &lt;tt&gt;implied&lt;/tt&gt; concept to deal with the &quot;never got a SlotContext so we don&apos;t know if it&apos;s the allBucket&quot; situation, we may not need the special &lt;tt&gt;ALL_BUCKETS_SPECIAL_BUCKET_DATA&lt;/tt&gt; object &#8211; I need to think it through a little more, but the gist of waht i have in mind is...&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;make &lt;tt&gt;implied&lt;/tt&gt; non final&lt;/li&gt;
	&lt;li&gt;set &lt;tt&gt;implied=false&lt;/tt&gt; anytime we &lt;tt&gt;incCounts()&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;if we know a bucket is &lt;tt&gt;allBuckets&lt;/tt&gt; then never call &lt;tt&gt;incCounts()&lt;/tt&gt; on it (already true)&lt;/li&gt;
	&lt;li&gt;if we are merging in a bucket from a shard that said it was &lt;tt&gt;implied:true&lt;/tt&gt; then make sure we don&apos;t call &lt;tt&gt;incCounts()&lt;/tt&gt; when merging it
	&lt;ul&gt;
		&lt;li&gt;we should even be able to prevent the counts from being returned for an implied shard?&lt;/li&gt;
		&lt;li&gt;(and assert that the counts are 0 when externalizing both &lt;tt&gt;isShard&lt;/tt&gt; and &lt;tt&gt;implied&lt;/tt&gt; ?)&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;for non-shard requests, externalizing an &lt;tt&gt;implied&lt;/tt&gt; should always just be &lt;tt&gt;null&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think that would let us remove a lot of the special casing of &lt;tt&gt;allBuckets&lt;/tt&gt; in terms of merging? .. like i said, I need to think it through more &#8211; i don&apos;t wnat to try and simplify/refactor any of this until test beasting seems solid.&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;Unfortunately with these new tests beasting can fail pretty easily ... we appear to have uncovered yet another (seemingly?) unrelated problem with allBuckets + refine in some processors that prevents beasting of SKG tests from getting very far.&lt;/p&gt;

&lt;p&gt;I&apos;ve attached 2 beast logs showing examples ... I&apos;m still trying to wrap my head around this, i &lt;em&gt;think&lt;/em&gt; it&apos;s specific to using allBuckets on a nested subfacet? ... i&apos;m going to open a new jira to track this (and try to repro in a simple test) but i&apos;m not sure how far down the rabbit hole i care to go about this .. for the purpose of this jira, and testing &lt;tt&gt;relatedness()&lt;/tt&gt;, we may want to just restrict the randomized testing of &apos;allBuckets&apos; to only top level facets &#8211; since we don&apos;t actually care about allBuckets! (other then proving &lt;tt&gt;relatedness()&lt;/tt&gt; doesn&apos;t break in that case ... if the processor can&apos;t handle refining allBuckets that&apos;s out of hte scope of what we&apos;re trying to test here.)&lt;/p&gt;</comment>
                            <comment id="17121301" author="mgibney" created="Mon, 1 Jun 2020 19:58:50 +0000"  >&lt;p&gt;Yes, this all sounds good to me. I wasn&apos;t sure what was going on with the null vs absent stats, so I&apos;m glad there&apos;s a logical explanation (and that that&apos;s fixed now!).&lt;/p&gt;

&lt;p&gt;It took me a while to dig into the 2 beast logs, but I think the issue has to do with &lt;tt&gt;FacetFieldProcessorByArray&lt;/tt&gt;&#160;and refinement requests where &lt;tt&gt;allBuckets:true&lt;/tt&gt;. The attached patch (&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13004516/13004516_SOLR-14467_allBuckets_refine.patch&quot; title=&quot;SOLR-14467_allBuckets_refine.patch attached to SOLR-14467&quot;&gt;SOLR-14467_allBuckets_refine.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;) I think fixes the problem by intercepting (and ignoring) normal calls to &lt;tt&gt;countAcc.collect(...)&lt;/tt&gt; in such situations, and by setting &lt;tt&gt;otherAccs=accs&lt;/tt&gt; to allow &lt;tt&gt;setNextReader(...)&lt;/tt&gt; to be&#160;called on accs during what is essentially &quot;single-pass&quot; collection (with &lt;tt&gt;allBuckets&lt;/tt&gt; bucket being ultimately the only collect target).&lt;/p&gt;</comment>
                            <comment id="17124035" author="hossman" created="Tue, 2 Jun 2020 16:41:55 +0000"  >&lt;p&gt;&lt;em&gt;(I thought i posted this comment last night, but found it sitting in an open tab this AM)&lt;/em&gt;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;The attached patch (&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13004516/13004516_SOLR-14467_allBuckets_refine.patch&quot; title=&quot;SOLR-14467_allBuckets_refine.patch attached to SOLR-14467&quot;&gt;SOLR-14467_allBuckets_refine.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;) I think fixes the problem ...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Sweet! ... i moved/combined your patch with the test patch already over in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14520&quot; title=&quot;json.facets: allBucket:true can cause server errors when combined with refine:true&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14520&quot;&gt;&lt;del&gt;SOLR-14520&lt;/del&gt;&lt;/a&gt; ... i need to review it more in depth but i&apos;m currently beasting the combination of your patch to fix that issue with the new tests &amp;amp; fixes in this issue to see if anything else shakes out.&lt;/p&gt;</comment>
                            <comment id="17125367" author="hossman" created="Wed, 3 Jun 2020 22:43:35 +0000"  >&lt;blockquote&gt;&lt;p&gt;...  I think that would let us remove a lot of the special casing of allBuckets in terms of merging? .. like i said, I need to think it through more &#8211; i don&apos;t wnat to try and simplify/refactor any of this until test beasting seems solid.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Now that &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14520&quot; title=&quot;json.facets: allBucket:true can cause server errors when combined with refine:true&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14520&quot;&gt;&lt;del&gt;SOLR-14520&lt;/del&gt;&lt;/a&gt; is fixed and the tests seemed solid, i took a crack at this idea, see updated patch.&lt;/p&gt;

&lt;p&gt;I think it&apos;s a lot cleaner/simpler then having the special BucketData singlton for allBuckets &amp;#8211;  what do you think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgibney&quot; class=&quot;user-hover&quot; rel=&quot;mgibney&quot;&gt;mgibney&lt;/a&gt;, any concens?&lt;/p&gt;</comment>
                            <comment id="17125612" author="lucenesolrqa" created="Thu, 4 Jun 2020 07:10:03 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;b&gt;&lt;font color=&quot;green&quot;&gt;+1 overall&lt;/font&gt;&lt;/b&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Vote &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Subsystem &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Runtime &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Comment &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; Prechecks &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; test4tests &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  0m  0s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; The patch appears to include 4 new or modified test files. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; master Compile Tests &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; compile &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m  4s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; master passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; Patch Compile Tests &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; compile &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m  4s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; javac &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m  4s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Release audit (RAT) &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m  8s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Check forbidden APIs &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m  4s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Validate source patterns &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m  4s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Validate ref guide &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m  4s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; Other Tests &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; unit &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; 45m 16s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; core in the patch passed. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt;&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt; &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt; 49m 53s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt; &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Subsystem &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Report/Notes &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; JIRA Issue &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14467&quot; title=&quot;json.facet&amp;#39;s relatedness() should not cause server errors or nonsense results when combined with allBuckets:true&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14467&quot;&gt;&lt;del&gt;SOLR-14467&lt;/del&gt;&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; JIRA Patch URL &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13004759/SOLR-14467.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/13004759/SOLR-14467.patch&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Optional Tests &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  compile  javac  unit  ratsources  checkforbiddenapis  validatesourcepatterns  validaterefguide  &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; uname &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Linux lucene1-us-west 4.15.0-54-generic #58-Ubuntu SMP Mon Jun 24 10:55:24 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Build tool &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ant &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Personality &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; /home/jenkins/jenkins-slave/workspace/PreCommit-SOLR-Build/sourcedir/dev-tools/test-patch/lucene-solr-yetus-personality.sh &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; git revision &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; master / 08a13ce5894 &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ant &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; version: Apache Ant(TM) version 1.10.5 compiled on March 28 2019 &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Default Java &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; LTS &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  Test Results &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/job/PreCommit-SOLR-Build/760/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-SOLR-Build/760/testReport/&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; modules &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; C: solr/core solr/solr-ref-guide U: solr &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Console output &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/job/PreCommit-SOLR-Build/760/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-SOLR-Build/760/console&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Powered by &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Apache Yetus 0.7.0   &lt;a href=&quot;http://yetus.apache.org&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://yetus.apache.org&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;



&lt;p&gt;This message was automatically generated.&lt;/p&gt;
</comment>
                            <comment id="17126126" author="mgibney" created="Thu, 4 Jun 2020 18:05:53 +0000"  >&lt;p&gt;Yes, this looks good to me! Integrating the &quot;implied&quot; concept more generally and not as an explicit special case makes sense.&lt;/p&gt;</comment>
                            <comment id="17126913" author="jira-bot" created="Fri, 5 Jun 2020 15:59:11 +0000"  >&lt;p&gt;Commit b055c7489fca05fd9e065d6a76b5bba749252b68 in lucene-solr&apos;s branch refs/heads/master from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=b055c74&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=b055c74&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14467&quot; title=&quot;json.facet&amp;#39;s relatedness() should not cause server errors or nonsense results when combined with allBuckets:true&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14467&quot;&gt;&lt;del&gt;SOLR-14467&lt;/del&gt;&lt;/a&gt;: Fix relatedness() stat in json.facets to no longer cause server errors (or nonsense results) when combined with allBuckets:true&lt;/p&gt;</comment>
                            <comment id="17126941" author="jira-bot" created="Fri, 5 Jun 2020 16:54:10 +0000"  >&lt;p&gt;Commit d12e3bc5703350c8d024869b63175fdfdd9bca0d in lucene-solr&apos;s branch refs/heads/branch_8x from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=d12e3bc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=d12e3bc&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14467&quot; title=&quot;json.facet&amp;#39;s relatedness() should not cause server errors or nonsense results when combined with allBuckets:true&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14467&quot;&gt;&lt;del&gt;SOLR-14467&lt;/del&gt;&lt;/a&gt;: Fix relatedness() stat in json.facets to no longer cause server errors (or nonsense results) when combined with allBuckets:true&lt;/p&gt;

&lt;p&gt;(cherry picked from commit b055c7489fca05fd9e065d6a76b5bba749252b68)&lt;/p&gt;</comment>
                            <comment id="17126944" author="hossman" created="Fri, 5 Jun 2020 16:58:12 +0000"  >&lt;p&gt;committed and backported, thanks for your help michael!&lt;/p&gt;</comment>
                            <comment id="17126951" author="mgibney" created="Fri, 5 Jun 2020 17:06:25 +0000"  >&lt;p&gt;Great! Happy to help, and thanks to you as well!&lt;/p&gt;</comment>
                            <comment id="17158457" author="broustant" created="Wed, 15 Jul 2020 15:11:47 +0000"  >&lt;p&gt;Closing after the 8.6.0 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13307555">SOLR-14514</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13307873">SOLR-14520</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13004759" name="SOLR-14467.patch" size="30404" author="hossman" created="Wed, 3 Jun 2020 22:41:11 +0000"/>
                            <attachment id="13004183" name="SOLR-14467.patch" size="29537" author="hossman" created="Thu, 28 May 2020 01:08:27 +0000"/>
                            <attachment id="13004148" name="SOLR-14467.patch" size="12035" author="magibney" created="Wed, 27 May 2020 14:28:21 +0000"/>
                            <attachment id="13003054" name="SOLR-14467.patch" size="6818" author="magibney" created="Fri, 15 May 2020 17:11:50 +0000"/>
                            <attachment id="13004516" name="SOLR-14467_allBuckets_refine.patch" size="3181" author="magibney" created="Mon, 1 Jun 2020 19:57:27 +0000"/>
                            <attachment id="13004067" name="SOLR-14467_test.patch" size="11504" author="hossman" created="Tue, 26 May 2020 22:22:21 +0000"/>
                            <attachment id="13002351" name="SOLR-14467_test.patch" size="32464" author="hossman" created="Fri, 8 May 2020 00:37:17 +0000"/>
                            <attachment id="13004181" name="beast.log.txt" size="27150127" author="hossman" created="Thu, 28 May 2020 01:09:09 +0000"/>
                            <attachment id="13004182" name="beast2.log.txt" size="5699880" author="hossman" created="Thu, 28 May 2020 01:08:51 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 17 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ehtc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>