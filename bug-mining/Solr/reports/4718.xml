<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:48:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-14457] SolrClient leaks connections on compressed responses if the response is malformed</title>
                <link>https://issues.apache.org/jira/browse/SOLR-14457</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;h3&gt;&lt;a name=&quot;Summary&quot;&gt;&lt;/a&gt;Summary&lt;/h3&gt;

&lt;p&gt;When the SolrJ receives a malformed response Entity, for example like the one described in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14456&quot; title=&quot;Compressed requests fail in SolrCloud when the request is routed internally by the serving solr node&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14456&quot;&gt;&lt;del&gt;SOLR-14456&lt;/del&gt;&lt;/a&gt;, the client leaks the connection forever as it&apos;s never released back to the pool.&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;Problemdescription&quot;&gt;&lt;/a&gt;Problem description&lt;/h3&gt;

&lt;p&gt;HttpSolrClient should have compression enabled, so it uses the compression interceptors.&lt;/p&gt;

&lt;p&gt;When the request is marked with &quot;Content-Encoding: gzip&quot; but for whatever reason the response is not in GZIP format, when&#160; HttpSolrClient tries to close the connection using Utils.consumeFully(), it tries to create the GzipInputStream failing and throwing an Exception. The exception thrown makes it impossible to access the underlying InputStream to be closed, therefore the connection is leaked.&lt;/p&gt;

&lt;p&gt;Despite that the content in the response should honour the headers specified for it, SolrJ should be reliable enough to prevent the connection leak when this scenario happens. On top of the bug itself, not being able to set a timeout while waiting for a connection to be available, makes any application unresponsive as it will run out of threads eventually.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Solr version: 7.7.2&lt;/p&gt;

&lt;p&gt;Solr cloud enabled&lt;/p&gt;

&lt;p&gt;Cluster topology: 6 nodes, 1 single collection, 10 shards and 3 replicas. 1 HTTP LB using&lt;/p&gt;

&lt;p&gt;Round Robin over all nodes&lt;/p&gt;

&lt;p&gt;All cluster nodes have gzip enabled for all paths, all HTTP verbs and all MIME types.&lt;/p&gt;

&lt;p&gt;Solr client: HttpSolrClient targeting the HTTP LB&lt;/p&gt;</environment>
        <key id="13302421">SOLR-14457</key>
            <summary>SolrClient leaks connections on compressed responses if the response is malformed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="houston">Houston Putman</assignee>
                                    <reporter username="samuelgmartinez">Samuel Garc&#237;a Mart&#237;nez</reporter>
                        <labels>
                    </labels>
                <created>Sat, 2 May 2020 10:29:00 +0000</created>
                <updated>Tue, 28 Sep 2021 20:22:23 +0000</updated>
                            <resolved>Sat, 4 Sep 2021 16:47:07 +0000</resolved>
                                    <version>7.7.2</version>
                                    <fixVersion>8.10</fixVersion>
                                    <component>SolrJ</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>7</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="6600">1h 50m</timespent>
                                <comments>
                            <comment id="17097902" author="samuelgmartinez" created="Sat, 2 May 2020 10:29:52 +0000"  >&lt;p&gt;Scenarios that corrupt the response like &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14456&quot; title=&quot;Compressed requests fail in SolrCloud when the request is routed internally by the serving solr node&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14456&quot;&gt;&lt;del&gt;SOLR-14456&lt;/del&gt;&lt;/a&gt; breaks the connection management&lt;/p&gt;</comment>
                            <comment id="17099650" author="roger.lehmann" created="Tue, 5 May 2020 08:20:04 +0000"  >&lt;p&gt;I can confirm this issue happening even with Solr 8.5.0 and standalone mode.&lt;br/&gt;
Also I came to the same conclusion, the exception is fired but handled silently, i.e. simply skipped.&lt;br/&gt;
This happens for us also for seemingly correctly formed responses, our application could handle the data and also the unzipped data from a curl call seemed to be correct.&lt;/p&gt;

&lt;p&gt;Properly closing the connection even when the exception occurs is the preferred solution form my point of view.&lt;/p&gt;</comment>
                            <comment id="17100277" author="samuelgmartinez" created="Tue, 5 May 2020 21:51:00 +0000"  >&lt;p&gt;Just for me to understand, I have several questions:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;In your scenario, are you using the HTTP1 or HTTP2 client?&lt;/li&gt;
	&lt;li&gt;When do you observe the leaks?&lt;/li&gt;
	&lt;li&gt;How a connection is leaked with proper HTTP responses? Do you know where it happens?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In this bug, the exception happens like the following:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;HTTPSolrClient receives an error code or a malformed response&lt;/li&gt;
	&lt;li&gt;The client throws an error&lt;/li&gt;
	&lt;li&gt;The client, on a finally block, ensures the connection is closed with Utils.consumeFully(HttpEntity)&lt;/li&gt;
	&lt;li&gt;Utils.consumeFully uses HttpEntity#getContent&lt;/li&gt;
	&lt;li&gt;When compression is enabled and response is compressed, the interceptor returns a new GzipInputStream&lt;/li&gt;
	&lt;li&gt;The GzipInputStream expects the header and it&apos;s not there because it&apos;s not really compressed.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Does your scenario look like the one I explained above?&lt;/p&gt;</comment>
                            <comment id="17100590" author="roger.lehmann" created="Wed, 6 May 2020 08:39:58 +0000"  >&lt;p&gt;Sorry for the confusion!&lt;br/&gt;
 We&apos;re using the HTTP1 client, since I think Http2SolrClient doesn&apos;t yet have allowCompression() available?&lt;/p&gt;

&lt;p&gt;The bug happens exactly as you say, I was just confused by the multiple wrapped objects and the content buffer seemingly being gzipped (see Debug view of the screenshots below). I&apos;m not a Java programmer, just stumbled upon this issue when we tried use GZIP in our production environment and it ran against the wall. So I can&apos;t help much with further debugging/developing a fix for it unfortunately.&lt;/p&gt;

&lt;p&gt;I&apos;ve used using a small test application here with a prefilled Solr running in a Docker container for testing this.&lt;br/&gt;
 In our production environment we experience the same issue when using GZIP, not using Docker there.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13002150/13002150_multiple-wrapped-entities.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13002149/13002149_content-gzipped.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17408395" author="houston" created="Wed, 1 Sep 2021 21:48:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=samuelgmartinez&quot; class=&quot;user-hover&quot; rel=&quot;samuelgmartinez&quot;&gt;samuelgmartinez&lt;/a&gt; &amp;amp; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roger.lehmann&quot; class=&quot;user-hover&quot; rel=&quot;roger.lehmann&quot;&gt;roger.lehmann&lt;/a&gt; I have a patch up that should fix this. Let me know what y&apos;all think and/or if it works for you when you test it out.&lt;/p&gt;</comment>
                            <comment id="17409652" author="jira-bot" created="Fri, 3 Sep 2021 18:11:20 +0000"  >&lt;p&gt;Commit 42b2ff5c61ef60f24e7287c80d6fe0eabe0a0bae in solr&apos;s branch refs/heads/main from Houston Putman&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=42b2ff5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=42b2ff5&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14457&quot; title=&quot;SolrClient leaks connections on compressed responses if the response is malformed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14457&quot;&gt;&lt;del&gt;SOLR-14457&lt;/del&gt;&lt;/a&gt;: Fix closing of malformed GZIPInputStream (#283)&lt;/p&gt;
</comment>
                            <comment id="17410002" author="jira-bot" created="Sat, 4 Sep 2021 16:46:33 +0000"  >&lt;p&gt;Commit c2f30e7e18fd276c2f428d63d0d5296f08807743 in lucene-solr&apos;s branch refs/heads/branch_8x from Houston Putman&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=c2f30e7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=c2f30e7&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14457&quot; title=&quot;SolrClient leaks connections on compressed responses if the response is malformed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14457&quot;&gt;&lt;del&gt;SOLR-14457&lt;/del&gt;&lt;/a&gt;: Fix closing of malformed GZIPInputStream (#283)&lt;/p&gt;</comment>
                            <comment id="17421696" author="thelabdude" created="Tue, 28 Sep 2021 20:22:23 +0000"  >&lt;p&gt;Closing after the 8.10.0 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13302413">SOLR-14456</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13002149" name="content-gzipped.png" size="257263" author="roger.lehmann" created="Wed, 6 May 2020 08:32:36 +0000"/>
                            <attachment id="13002150" name="multiple-wrapped-entities.png" size="280670" author="roger.lehmann" created="Wed, 6 May 2020 08:32:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 7 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ebe0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>