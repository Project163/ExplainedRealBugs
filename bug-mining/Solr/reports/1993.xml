<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:54:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-6136] ConcurrentUpdateSolrServer includes a Spin Lock</title>
                <link>https://issues.apache.org/jira/browse/SOLR-6136</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;ConcurrentUpdateSolrServer.blockUntilFinished() includes a Spin Lock. This causes an extremely high amount of CPU to be used on the Cloud Leader during indexing.&lt;/p&gt;

&lt;p&gt;Here is a summary of our system testing. &lt;/p&gt;

&lt;p&gt;Importing data on Solr4.5.0: &lt;br/&gt;
Throughput gets as high as 240 documents per second.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;tomcat@solr-stg01 logs&amp;#93;&lt;/span&gt;$ uptime &lt;br/&gt;
09:53:50 up 310 days, 23:52, 1 user, load average: 3.33, 3.72, 5.43&lt;/p&gt;

&lt;p&gt;PID USER PR NI VIRT RES SHR S %CPU %MEM TIME+ COMMAND &lt;br/&gt;
9547 tomcat 21 0 6850m 1.2g 16m S 86.2 5.0 1:48.81 java&lt;/p&gt;

&lt;p&gt;Importing data on Solr4.7.0 with no replicas: &lt;br/&gt;
Throughput peaks at 350 documents per second.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;tomcat@solr-stg01 logs&amp;#93;&lt;/span&gt;$ uptime &lt;br/&gt;
10:03:44 up 311 days, 2 min, 1 user, load average: 4.57, 2.55, 4.18&lt;/p&gt;

&lt;p&gt;PID USER PR NI VIRT RES SHR S %CPU %MEM TIME+ COMMAND &lt;br/&gt;
9728 tomcat 23 0 6859m 2.2g 28m S 62.3 9.0 2:20.20 java&lt;/p&gt;

&lt;p&gt;Importing data on Solr4.7.0 with replicas: &lt;br/&gt;
Throughput peaks at 30 documents per second because the Solr machine is out of CPU.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;tomcat@solr-stg01 logs&amp;#93;&lt;/span&gt;$ uptime &lt;br/&gt;
09:40:04 up 310 days, 23:38, 1 user, load average: 30.54, 12.39, 4.79&lt;/p&gt;

&lt;p&gt;PID USER PR NI VIRT RES SHR S %CPU %MEM TIME+ COMMAND &lt;br/&gt;
9190 tomcat 17 0 7005m 397m 15m S 198.5 1.6 7:14.87 java&lt;/p&gt;</description>
                <environment></environment>
        <key id="12718408">SOLR-6136</key>
            <summary>ConcurrentUpdateSolrServer includes a Spin Lock</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thelabdude">Timothy Potter</assignee>
                                    <reporter username="bchapman">Brandon Chapman</reporter>
                        <labels>
                    </labels>
                <created>Wed, 4 Jun 2014 16:39:53 +0000</created>
                <updated>Mon, 9 May 2016 18:44:39 +0000</updated>
                            <resolved>Tue, 15 Jul 2014 22:04:35 +0000</resolved>
                                    <version>4.6</version>
                    <version>4.6.1</version>
                    <version>4.7</version>
                    <version>4.7.1</version>
                    <version>4.7.2</version>
                    <version>4.8</version>
                    <version>4.8.1</version>
                                    <fixVersion>4.10</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="14017838" author="bchapman" created="Wed, 4 Jun 2014 16:41:19 +0000"  >&lt;p&gt;Applying the patch from the linked ticket to Solr 4.5 will cause the same issue to be present in Solr 4.5.&lt;/p&gt;</comment>
                            <comment id="14017842" author="bchapman" created="Wed, 4 Jun 2014 16:44:15 +0000"  >&lt;p&gt;Attached patch for Solr 4.7.1 drastically improves performance. The patch is a workaround of the spin lock by using a simple wait / notify mechanism. It is not a suggestion on how to fix ConcurrentUpdateSolrServer for an official release.&lt;/p&gt;</comment>
                            <comment id="14017896" author="thelabdude" created="Wed, 4 Jun 2014 17:23:34 +0000"  >&lt;p&gt;Thanks for the patch Brandon! I&apos;ll start working on this issue tomorrow unless someone can dig into it sooner.&lt;/p&gt;</comment>
                            <comment id="14055104" author="markrmiller@gmail.com" created="Tue, 8 Jul 2014 16:37:01 +0000"  >&lt;p&gt;I&apos;ll def help with any thoughts or review on this one - important issue to fix.&lt;/p&gt;</comment>
                            <comment id="14055636" author="thelabdude" created="Tue, 8 Jul 2014 22:57:43 +0000"  >&lt;p&gt;Thanks Mark. My strategy is to use Brandon&apos;s wait/notify around the runners object, which seems clean to me. The only other thing his patch needs is to use your fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4260&quot; title=&quot;Inconsistent numDocs between leader and replica&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4260&quot;&gt;&lt;del&gt;SOLR-4260&lt;/del&gt;&lt;/a&gt; (the check for non-empty queue and no runners). Unless you guys see a problem with using wait/notify on the runners object? &lt;/p&gt;

&lt;p&gt;Main thing is the testing ... I&apos;ve yet to actually see this block of code show up as a CPU hotspot in my testing &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I&apos;m trying some things on a CPU constrained node with complex docs to see if I can get it to trigger.&lt;/p&gt;</comment>
                            <comment id="14055839" author="shalinmangar" created="Wed, 9 Jul 2014 04:41:14 +0000"  >&lt;blockquote&gt;&lt;p&gt;Main thing is the testing ... I&apos;ve yet to actually see this block of code show up as a CPU hotspot in my testing  I&apos;m trying some things on a CPU constrained node with complex docs to see if I can get it to trigger.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It might be easier to trigger if you send docs individually at a high rate instead of a batching them.&lt;/p&gt;</comment>
                            <comment id="14056571" author="thelabdude" created="Wed, 9 Jul 2014 18:33:57 +0000"  >&lt;p&gt;Thanks Shalin ... that helped a little. Here&apos;s where I&apos;m at with this: using the current &quot;spin-lock&quot; code on trunk (without wait/notify), VisualVM shows some self CPU time in the blockUntilFinished, with Brandon&apos;s patch + the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4260&quot; title=&quot;Inconsistent numDocs between leader and replica&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4260&quot;&gt;&lt;del&gt;SOLR-4260&lt;/del&gt;&lt;/a&gt; added back in, the self CPU time is negligible, which aligns with what Brandon reported &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; So I think I&apos;m convinced this is a good improvement and am now going to run some stress tests on this and then post a patch for review. Also, surprisingly, CUSS didn&apos;t have a unit test case for it, so I&apos;m building that too.&lt;/p&gt;</comment>
                            <comment id="14056673" author="thelabdude" created="Wed, 9 Jul 2014 19:55:24 +0000"  >&lt;p&gt;Mark - just curious - what was the thinking on using only 1 thread for the CUSS used by StreamingSolrServers? Specifically, I&apos;m looking at this code in StreamingSolrServers:&lt;/p&gt;

&lt;p&gt;      server = new ConcurrentUpdateSolrServer(url, httpClient, 100, 1, updateExecutor, true) {&lt;/p&gt;

&lt;p&gt;If I had to guess it was that you didn&apos;t want to over-complicate debugging when this code was new? Wondering if you see value in increasing the thread count a little?&lt;/p&gt;</comment>
                            <comment id="14056681" author="markrmiller@gmail.com" created="Wed, 9 Jul 2014 20:02:44 +0000"  >&lt;p&gt;I intended on making it configurable eventually, but I think it should default to 1.  We should be artful about spinning up too many threads by default for a single request I think. Once we fix distributed deadlock, I&apos;d like it if you could largely control the number of threads proportionally just by using the container thread pool sizing config. &lt;/p&gt;</comment>
                            <comment id="14056790" author="thelabdude" created="Wed, 9 Jul 2014 21:39:42 +0000"  >&lt;p&gt;Ok, makes sense ... I&apos;m wondering if it doesn&apos;t make sense to be a little more flexible if the queue is filling up? Currently, the code only allocates a new Runner if:&lt;/p&gt;

&lt;p&gt;          if (runners.isEmpty() || (queue.remainingCapacity() &amp;lt; queue.size() &amp;amp;&amp;amp; runners.size() &amp;lt; threadCount)) {&lt;/p&gt;

&lt;p&gt;My thinking is to relax this a little to allow an additional runner if the queue is half full but otherwise just keep it at 1.&lt;/p&gt;</comment>
                            <comment id="14057445" author="markrmiller@gmail.com" created="Thu, 10 Jul 2014 13:16:25 +0000"  >&lt;blockquote&gt;&lt;p&gt;My thinking is to relax this a little to allow an additional runner if the queue is half full but otherwise just keep it at 1.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That sounds okay to me - my only worry is doing something that spins up too many threads for a small queue.&lt;/p&gt;</comment>
                            <comment id="14058855" author="thelabdude" created="Fri, 11 Jul 2014 14:54:04 +0000"  >&lt;p&gt;Here&apos;s a patch based largely on Brandon&apos;s original patch, using wait / notifyAll instead of the spin lock in blockUntilFinished. As mentioned above, VisualVM shows good evidence of this improvement in that the amount of CPU spent in the block method is negligible with this patch (and very noticeable without it).&lt;/p&gt;

&lt;p&gt;I&apos;ve also included the first cut at a unit test for CUSS. There&apos;s probably more things we can do to exercise the logic in CUSS, so let me know if you have any other ideas for the unit test.&lt;/p&gt;

&lt;p&gt;Brandon - please try this patch out in your environment if possible. I&apos;ll plan to commit this to trunk and backport to 4x branch in a few days after keeping on eye on things in Jenkins.&lt;/p&gt;</comment>
                            <comment id="14058858" author="thelabdude" created="Fri, 11 Jul 2014 14:56:08 +0000"  >&lt;p&gt;btw - I decided to not mess with the threadCount stuff Mark and I were discussing here as that should be handled under another &quot;improvement&quot; ticket after doing some benchmarking to show if it even helps.&lt;/p&gt;</comment>
                            <comment id="14058910" author="markrmiller@gmail.com" created="Fri, 11 Jul 2014 15:31:04 +0000"  >&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;-            final UpdateRequest updateRequest = queue.poll(250,
-                TimeUnit.MILLISECONDS);
+            final UpdateRequest updateRequest = 
+                queue.poll(pollQueueTime, TimeUnit.MILLISECONDS);
             if (updateRequest == null)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Know when that bug was introduced? If it went out in 4.9, that is a pretty severe performance bug if you are not streaming or batching big.&lt;/p&gt;</comment>
                            <comment id="14058916" author="thelabdude" created="Fri, 11 Jul 2014 15:45:16 +0000"  >&lt;p&gt;not sure about that one ... just something I caught while working on this issue&lt;/p&gt;</comment>
                            <comment id="14059082" author="markrmiller@gmail.com" created="Fri, 11 Jul 2014 17:46:25 +0000"  >&lt;p&gt;Ah, I see, it&apos;s a different poll call. I only had this take affect on one of the poll calls because that was enough to relieve the performance issue in my benchmarks. I think it makes sense to expand it to the this other poll call as well.&lt;/p&gt;

&lt;p&gt;+1 on the patch, looks okay to me, tests pass locally.&lt;/p&gt;

&lt;p&gt;I don&apos;t want to think about testing CUSS at the moment, but nice work on a new test for it. Will be great to have it grow - this has been a troublesome class to stabilize over the years.&lt;/p&gt;</comment>
                            <comment id="14106810" author="markrmiller@gmail.com" created="Fri, 22 Aug 2014 13:10:21 +0000"  >&lt;p&gt;I don&apos;t know if it&apos;s this or not, but right around when this went in I started seeing the rare hang at:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; [junit4]    &amp;gt;         at org.apache.solr.client.solrj.impl.ConcurrentUpdateSolrServer.blockUntilFinished(ConcurrentUpdateSolrServer.java:374)
   [junit4]    &amp;gt;         at org.apache.solr.update.StreamingSolrServers.blockUntilFinished(StreamingSolrServers.java:103)
   [junit4]    &amp;gt;         at org.apache.solr.update.SolrCmdDistributor.blockAndDoRetries(SolrCmdDistributor.java:228)
   [junit4]    &amp;gt;         at org.apache.solr.update.SolrCmdDistributor.finish(SolrCmdDistributor.java:89)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14106898" author="thelabdude" created="Fri, 22 Aug 2014 14:34:07 +0000"  >&lt;p&gt;ugh ... weird though as the notifyAll call that would free up the hang at that spot is in a finally block you&apos;d think it would be getting called correctly ... the only path I can see that notify wouldn&apos;t get called is the queue never empties. &lt;/p&gt;</comment>
                            <comment id="14106907" author="markrmiller@gmail.com" created="Fri, 22 Aug 2014 14:39:15 +0000"  >&lt;p&gt;I filed &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6406&quot; title=&quot;ConcurrentUpdateSolrServer hang in blockUntilFinished.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6406&quot;&gt;&lt;del&gt;SOLR-6406&lt;/del&gt;&lt;/a&gt; to track this.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12736076">SOLR-6406</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12667987">SOLR-5232</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12655220" name="SOLR-6136.patch" size="15723" author="thelabdude" created="Fri, 11 Jul 2014 14:54:04 +0000"/>
                            <attachment id="12648349" name="wait___notify_all.patch" size="9439" author="bchapman" created="Wed, 4 Jun 2014 16:44:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>396607</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 13 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1wa5j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>396728</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>