<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:42:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-13975] ConcurrentUpdateSolrClient connection stall prevention</title>
                <link>https://issues.apache.org/jira/browse/SOLR-13975</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;When a Solr process, which hosts replicas of a collection, is suspended - that is, the OS process is suspended using eg. &lt;tt&gt;kill -STOP &amp;lt;pid&amp;gt;&lt;/tt&gt; - a long stall may occur in CUSC until a socket timeout is reached.&lt;/p&gt;

&lt;p&gt;During this stall updates from the leader are not forwarded to any replica, even though other replicas are still active and can receive updates.  If the sender uses CUSC (eg. via &lt;tt&gt;CloudSolrClient&lt;/tt&gt;) then it becomes stalled because the leader stops processing updates, too.&lt;/p&gt;

&lt;p&gt;This situation is caused by several issues:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;when a process is suspended its sockets remain open - so there is no immediate disconnect as if the process died, but the process becomes unresponsive. Eventually, a socket timeout will be reached (distribUpdateSoTimeout) - but in the default version of &lt;tt&gt;solr.xml&lt;/tt&gt; this is set to 10 min. During this time all indexing to that shard will be stuck.&lt;/li&gt;
	&lt;li&gt;there are several infinite &lt;tt&gt;for&lt;/tt&gt; loops in CUSC (eg. in &lt;tt&gt;blockUntilFinished&lt;/tt&gt;, &lt;tt&gt;waitForEmptyQueue&lt;/tt&gt; and even in &lt;tt&gt;request&lt;/tt&gt;), which rely either on the relatively quick success of the call or an exception to be thrown. However, in this situation neither happens quickly - the call is stuck waiting for the remote end until soTimeout expires.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This issue proposes to add a stall prevention logic, which would break these infinite loops long before the socket timeout occurs based on the progress of the queue processing.&lt;/p&gt;

&lt;p&gt;This is a follow-up to &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13896&quot; title=&quot;Paused a non-leader node can cause recovery on other nodes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13896&quot;&gt;&lt;del&gt;SOLR-13896&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13271054">SOLR-13975</key>
            <summary>ConcurrentUpdateSolrClient connection stall prevention</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ab">Andrzej Bialecki</assignee>
                                    <reporter username="ab">Andrzej Bialecki</reporter>
                        <labels>
                    </labels>
                <created>Wed, 27 Nov 2019 16:58:36 +0000</created>
                <updated>Tue, 21 Jan 2020 16:57:25 +0000</updated>
                            <resolved>Thu, 12 Dec 2019 20:50:26 +0000</resolved>
                                    <version>8.3</version>
                    <version>8.4</version>
                                    <fixVersion>8.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16987097" author="ab" created="Tue, 3 Dec 2019 17:31:21 +0000"  >&lt;p&gt;This patch adds a stall detection logic to the key methods in &lt;tt&gt;ConcurrentUpdateSolrClient&lt;/tt&gt; as well as &lt;tt&gt;ConcurrentUpdateHttp2SolrClient&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I wasn&apos;t sure what timeout value to use - in CUSC I used &lt;tt&gt;connectionTimeout&lt;/tt&gt; and in CUH2SC I used &lt;tt&gt;client.getIdleTime().&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;I&apos;m not sure also how to implement a unit test for this - I tested it manually by suspending Solr process from shell, which is not really possible to do from the unit test without spawning a separate Solr instance and using Runtime.exec to suspend / resume it, which sounds exceedingly messy.&lt;/p&gt;</comment>
                            <comment id="16988216" author="ab" created="Wed, 4 Dec 2019 20:59:38 +0000"  >&lt;p&gt;Updated patch:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;includes a tweaked patch from &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13896&quot; title=&quot;Paused a non-leader node can cause recovery on other nodes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13896&quot;&gt;&lt;del&gt;SOLR-13896&lt;/del&gt;&lt;/a&gt;.&lt;/li&gt;
	&lt;li&gt;adds a new system property &lt;tt&gt;solr.cloud.client.stallTime&lt;/tt&gt; to control the maximum stall time. This is 10,000 ms by default.&lt;/li&gt;
	&lt;li&gt;This may be controversial: if a stall is detected an IOException is thrown instead of just logging a warning. This doesn&apos;t break any tests but perhaps it may cause issues in external applications? Still, I think it&apos;s better to report this error up front instead of hiding it in the logs and pretending that nothing happened.&lt;/li&gt;
	&lt;li&gt;unit test.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=caomanhdat&quot; class=&quot;user-hover&quot; rel=&quot;caomanhdat&quot;&gt;caomanhdat&lt;/a&gt; I would appreciate a review.&lt;/p&gt;</comment>
                            <comment id="16992932" author="jira-bot" created="Tue, 10 Dec 2019 20:46:11 +0000"  >&lt;p&gt;Commit c4f0c3363828c088eefa2b99783178848c2f1f7a in lucene-solr&apos;s branch refs/heads/master from Andrzej Bialecki&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=c4f0c33&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=c4f0c33&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13975&quot; title=&quot;ConcurrentUpdateSolrClient connection stall prevention&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13975&quot;&gt;&lt;del&gt;SOLR-13975&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13896&quot; title=&quot;Paused a non-leader node can cause recovery on other nodes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13896&quot;&gt;&lt;del&gt;SOLR-13896&lt;/del&gt;&lt;/a&gt;: ConcurrentUpdateSolrClient connection stall prevention.&lt;/p&gt;</comment>
                            <comment id="16993280" author="jira-bot" created="Wed, 11 Dec 2019 08:11:31 +0000"  >&lt;p&gt;Commit c4f0c3363828c088eefa2b99783178848c2f1f7a in lucene-solr&apos;s branch refs/heads/gradle-master from Andrzej Bialecki&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=c4f0c33&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=c4f0c33&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13975&quot; title=&quot;ConcurrentUpdateSolrClient connection stall prevention&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13975&quot;&gt;&lt;del&gt;SOLR-13975&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13896&quot; title=&quot;Paused a non-leader node can cause recovery on other nodes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13896&quot;&gt;&lt;del&gt;SOLR-13896&lt;/del&gt;&lt;/a&gt;: ConcurrentUpdateSolrClient connection stall prevention.&lt;/p&gt;</comment>
                            <comment id="16993463" author="jira-bot" created="Wed, 11 Dec 2019 12:01:27 +0000"  >&lt;p&gt;Commit 783a40a93cb1a3ea6421da99649570aeaeb5fefd in lucene-solr&apos;s branch refs/heads/branch_8x from Andrzej Bialecki&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=783a40a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=783a40a&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13975&quot; title=&quot;ConcurrentUpdateSolrClient connection stall prevention&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13975&quot;&gt;&lt;del&gt;SOLR-13975&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13896&quot; title=&quot;Paused a non-leader node can cause recovery on other nodes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13896&quot;&gt;&lt;del&gt;SOLR-13896&lt;/del&gt;&lt;/a&gt;: ConcurrentUpdateSolrClient connection stall prevention.&lt;/p&gt;</comment>
                            <comment id="16994629" author="ab" created="Thu, 12 Dec 2019 12:54:38 +0000"  >&lt;p&gt;Jenkins failure related to this change (&lt;a href=&quot;https://jenkins.thetaphi.de/job/Lucene-Solr-8.x-Windows/591/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://jenkins.thetaphi.de/job/Lucene-Solr-8.x-Windows/591/&lt;/a&gt;):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 [junit4]   2&amp;gt; java.io.IOException: Request processing has stalled &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 102ms with 100 remaining elements in the queue.
   [junit4]   2&amp;gt; 	at org.apache.solr.client.solrj.impl.ConcurrentUpdateHttp2SolrClient.request(ConcurrentUpdateHttp2SolrClient.java:446)
   [junit4]   2&amp;gt; 	at org.apache.solr.client.solrj.SolrClient.request(SolrClient.java:1290)
   [junit4]   2&amp;gt; 	at org.apache.solr.client.solrj.impl.ConcurrentUpdateSolrClientTest$SendDocsRunnable.run(ConcurrentUpdateSolrClientTest.java:301)
   [junit4]   2&amp;gt; 	at org.apache.solr.common.util.ExecutorUtil$MDCAwareThreadPoolExecutor.lambda$execute$0(ExecutorUtil.java:210)
   [junit4]   2&amp;gt; 	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
   [junit4]   2&amp;gt; 	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
   [junit4]   2&amp;gt; 	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
   [junit4]   2&amp;gt; 46259 INFO  (TEST-ConcurrentUpdateHttp2SolrClientTest.testConcurrentUpdate-seed#[2B5284771F7CB908]) [     ] o.a.s.SolrTestCaseJ4 ###Ending testConcurrentUpdate
   [junit4]   2&amp;gt; NOTE: reproduce with: ant test  -Dtestcase=ConcurrentUpdateHttp2SolrClientTest -Dtests.method=testConcurrentUpdate -Dtests.seed=2B5284771F7CB908 -Dtests.slow=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; -Dtests.locale=uk-UA -Dtests.timezone=America/Punta_Arenas -Dtests.asserts=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; -Dtests.file.encoding=UTF-8
   [junit4] FAILURE 5.10s J0 | ConcurrentUpdateHttp2SolrClientTest.testConcurrentUpdate &amp;lt;&amp;lt;&amp;lt;
   [junit4]    &amp;gt; Throwable #1: java.lang.AssertionError: Expected CUSS to send 500 but got 495
   [junit4]    &amp;gt; 	at __randomizedtesting.SeedInfo.seed([2B5284771F7CB908:D354DD8CCB44DC43]:0)
   [junit4]    &amp;gt; 	at org.apache.solr.client.solrj.impl.ConcurrentUpdateHttp2SolrClientTest.testConcurrentUpdate(ConcurrentUpdateHttp2SolrClientTest.java:102)
   [junit4]    &amp;gt; 	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16994929" author="jira-bot" created="Thu, 12 Dec 2019 18:07:47 +0000"  >&lt;p&gt;Commit 640e6fc3c02617bf3f461ab3bbb908ae8421b47f in lucene-solr&apos;s branch refs/heads/branch_8x from Andrzej Bialecki&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=640e6fc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=640e6fc&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13975&quot; title=&quot;ConcurrentUpdateSolrClient connection stall prevention&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13975&quot;&gt;&lt;del&gt;SOLR-13975&lt;/del&gt;&lt;/a&gt;: Make sure the stall time is adjusted up when an unusually long&lt;br/&gt;
poll time is configured.&lt;/p&gt;</comment>
                            <comment id="16994964" author="jira-bot" created="Thu, 12 Dec 2019 18:57:41 +0000"  >&lt;p&gt;Commit e809d3ac0d2aa768bb8e158f334e88dbcfd99cf5 in lucene-solr&apos;s branch refs/heads/branch_8_4 from Andrzej Bialecki&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=e809d3a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=e809d3a&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13975&quot; title=&quot;ConcurrentUpdateSolrClient connection stall prevention&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13975&quot;&gt;&lt;del&gt;SOLR-13975&lt;/del&gt;&lt;/a&gt;: Make sure the stall time is adjusted up when an unusually long&lt;br/&gt;
poll time is configured.&lt;/p&gt;</comment>
                            <comment id="16995066" author="jira-bot" created="Thu, 12 Dec 2019 20:46:39 +0000"  >&lt;p&gt;Commit e155649026a62e684667e657175d0f722601c05b in lucene-solr&apos;s branch refs/heads/master from Andrzej Bialecki&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=e155649&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=e155649&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13975&quot; title=&quot;ConcurrentUpdateSolrClient connection stall prevention&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13975&quot;&gt;&lt;del&gt;SOLR-13975&lt;/del&gt;&lt;/a&gt;: Make sure the stall time is adjusted up when an unusually long&lt;br/&gt;
poll time is configured.&lt;/p&gt;</comment>
                            <comment id="16995949" author="dsmiley" created="Fri, 13 Dec 2019 21:56:53 +0000"  >&lt;p&gt;Please ask for a code review next time; okay? &#160;This is some complex code in our codebase; I&apos;ve wrangled with it before. &#160;Also, using a GitHub PR is more conducive to invite peer examination.&lt;/p&gt;

&lt;p&gt;My main comment on what you have here is code duplication. &#160;There was a fair amount of it there already, granted, but you added more. &#160;IntelliJ points this out to me.&lt;/p&gt;</comment>
                            <comment id="16996240" author="ab" created="Sat, 14 Dec 2019 08:23:48 +0000"  >&lt;p&gt;I asked for a code review - see above - and got nothing. Since this particular problem was plaguing one of customers I felt it had to be somehow addressed in the nearest release.&lt;/p&gt;

&lt;p&gt;You are right that there&apos;s a lot of code duplication - I&apos;m happy to work on this more post 8.4.&lt;/p&gt;</comment>
                            <comment id="17004966" author="jpountz" created="Sun, 29 Dec 2019 20:50:33 +0000"  >&lt;p&gt;Closing after the 8.4.0 release.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12987506" name="SOLR-13975.patch" size="23981" author="ab" created="Wed, 4 Dec 2019 20:52:43 +0000"/>
                            <attachment id="12987387" name="SOLR-13975.patch" size="10037" author="ab" created="Tue, 3 Dec 2019 17:29:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 46 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z092yo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>