<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:20:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-9835] Create another replication mode for SolrCloud</title>
                <link>https://issues.apache.org/jira/browse/SOLR-9835</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;The current replication mechanism of SolrCloud is called state machine, which replicas start in same initial state and for each input, the input is distributed across replicas so all replicas will end up with same next state. &lt;/p&gt;

&lt;p&gt;But this type of replication have some drawbacks&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The commit (which costly) have to run on all replicas&lt;/li&gt;
	&lt;li&gt;Slow recovery, because if replica miss more than N updates on its down time, the replica have to download entire index from its leader.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So we create create another replication mode for SolrCloud called state transfer, which acts like master/slave replication. In basically&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Leader distribute the update to other replicas, but the leader only apply the update to IW, other replicas just store the update to UpdateLog (act like replication).&lt;/li&gt;
	&lt;li&gt;Replicas frequently polling the latest segments from leader.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Pros:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Lightweight for indexing, because only leader are running the commit, updates.&lt;/li&gt;
	&lt;li&gt;Very fast recovery, replicas just have to download the missing segments.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;On CAP point of view, this ticket will trying to promise to end users a distributed systems :&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Partition tolerance&lt;/li&gt;
	&lt;li&gt;Weak Consistency for normal query : clusters can serve stale data. This happen when leader finish a commit and slave is fetching for latest segment. This period can at most &lt;tt&gt;pollInterval + time to fetch latest segment&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;Consistency for RTG : if we &lt;b&gt;do not use DQBs&lt;/b&gt;, replicas will consistence with master just like original SolrCloud mode&lt;/li&gt;
	&lt;li&gt;Weak Availability : just like original SolrCloud mode. If a leader down, client must wait until new leader being elected.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;To use this new replication mode, a new collection must be created with an additional parameter &lt;tt&gt;liveReplicas=1&lt;/tt&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8983/solr/admin/collections?action=CREATE&amp;amp;name=newCollection&amp;amp;numShards=2&amp;amp;replicationFactor=1&amp;amp;realtimeReplicas=1&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13026378">SOLR-9835</key>
            <summary>Create another replication mode for SolrCloud</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shalin">Shalin Shekhar Mangar</assignee>
                                    <reporter username="caomanhdat">Cao Manh Dat</reporter>
                        <labels>
                    </labels>
                <created>Wed, 7 Dec 2016 15:20:57 +0000</created>
                <updated>Wed, 2 Oct 2019 17:30:27 +0000</updated>
                            <resolved>Mon, 3 Jul 2017 23:00:42 +0000</resolved>
                                                    <fixVersion>7.0</fixVersion>
                                        <due></due>
                            <votes>2</votes>
                                    <watches>18</watches>
                                                                                                                <comments>
                            <comment id="15729828" author="erickerickson" created="Wed, 7 Dec 2016 20:27:51 +0000"  >&lt;p&gt;I believe that if we do implement this, it should make &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9706&quot; title=&quot;fetchIndex blocks incoming queries when issued on a replica in SolrCloud&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9706&quot;&gt;SOLR-9706&lt;/a&gt; obsolete. The proposed replication mode sounds like it would make manually issuing a fetchIndex unnecessary since the use-case for &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9706&quot; title=&quot;fetchIndex blocks incoming queries when issued on a replica in SolrCloud&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9706&quot;&gt;SOLR-9706&lt;/a&gt; I&apos;m familiar with is exactly only indexing to the leader and having the followers use the regular polling mechanism which doesn&apos;t block during replication.&lt;/p&gt;

&lt;p&gt;At least we should verify whether &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9706&quot; title=&quot;fetchIndex blocks incoming queries when issued on a replica in SolrCloud&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9706&quot;&gt;SOLR-9706&lt;/a&gt; is made obsolete by this proposal.&lt;/p&gt;</comment>
                            <comment id="15732174" author="praste" created="Thu, 8 Dec 2016 13:12:43 +0000"  >&lt;p&gt;I am curious to know how soft commits (in memory segments) would be handled.&lt;/p&gt;</comment>
                            <comment id="15732527" author="markrmiller@gmail.com" created="Thu, 8 Dec 2016 15:33:07 +0000"  >&lt;p&gt;Soft commits are for near realtime and doing master-&amp;gt;slave replication won&apos;t benefit from that. Effectively, soft commits won&apos;t be useful.&lt;/p&gt;</comment>
                            <comment id="15732554" author="ichattopadhyaya" created="Thu, 8 Dec 2016 15:43:40 +0000"  >&lt;p&gt;I&apos;m curious about the handling of searcher reopens (which would create a new segment, afaict). Such a searcher reopen can happen if an RTG request uses filters. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;                 ulog.openRealtimeSearcher();  &lt;span class=&quot;code-comment&quot;&gt;// force open a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; realtime searcher&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15732576" author="shalinmangar" created="Thu, 8 Dec 2016 15:53:15 +0000"  >&lt;p&gt;Hold your questions for a bit. Dat and I are working on a design and we will try to answer your questions as much as we can. We will post it in a couple of days.&lt;/p&gt;</comment>
                            <comment id="15735547" author="caomanhdat" created="Fri, 9 Dec 2016 15:05:15 +0000"  >&lt;p&gt;Here are the detail design that I and Shalin have been working for recently&lt;/p&gt;

&lt;h2&gt;&lt;a name=&quot;Overview&quot;&gt;&lt;/a&gt;Overview&lt;/h2&gt;
&lt;p&gt;The current replication mechanism of SolrCloud is called state machine, which replicas start in same initial state and for each input, the input is distributed across replicas so all replicas will end up with same next state.&lt;/p&gt;

&lt;p&gt;But this type of replication has some drawbacks :&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The indexing and commits have to run on all replicas&lt;/li&gt;
	&lt;li&gt;Slow recovery, because if replica miss more than N updates on its down time, the replica has to (usually) download the entire index from its leader.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So we introduce another replication for SolrCloud called state transfer, which acts like master/slave replication. Basically:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Leader distribute the update to other replicas, but only the leader applies the update to IndexWriter; other replicas just store the update to UpdateLog (act like replication)&lt;/li&gt;
	&lt;li&gt;Replicas frequently polling the latest segments from leader.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Pros:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Lightweight for indexing, because only leader are running the updates and commits&lt;/li&gt;
	&lt;li&gt;Very fast recovery. If a replica fails, it just has to download newest segments, instead of re-downloading entire index.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Cons :&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Leader can become a hotspot when there are many replicas (we can optimize later)&lt;/li&gt;
	&lt;li&gt;Longer turnaround time compared to current NRT replication&lt;/li&gt;
&lt;/ul&gt;


&lt;h2&gt;&lt;a name=&quot;Commit&quot;&gt;&lt;/a&gt;Commit&lt;/h2&gt;
&lt;p&gt;When we commit, we write the version of update command into the commit data in addition to the timestamp that is written today.&lt;/p&gt;

&lt;h2&gt;&lt;a name=&quot;Update&quot;&gt;&lt;/a&gt;Update&lt;/h2&gt;
&lt;ol&gt;
	&lt;li&gt;When a replica receive an update request it will forward the update request to
	&lt;ul&gt;
		&lt;li&gt;Correct leader ( in case of add document, delete by id )&lt;/li&gt;
		&lt;li&gt;All leaders ( in case of delete by query, commit )&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Leader assigns version to update as it does today, writes to update log and applies the update to IndexWriter&lt;/li&gt;
	&lt;li&gt;Leader distributes the update to its replicas&lt;/li&gt;
	&lt;li&gt;When replica receives an update, it writes the update to update log and return successfully&lt;/li&gt;
	&lt;li&gt;Leader return successful&lt;/li&gt;
&lt;/ol&gt;


&lt;h2&gt;&lt;a name=&quot;PeriodicSegmentReplication&quot;&gt;&lt;/a&gt;Periodic Segment Replication&lt;/h2&gt;
&lt;p&gt;Replica will poll the leader for the latest commit point generation and version and compare against the latest commit point locally. If it is the same, then replication is successful and nothing needs to be done. If not, then:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Replica downloads all files since the local commit point from the leader&lt;/li&gt;
	&lt;li&gt;Installs into the index, synchronize on the update log, close the old tlog, create a new one and copy over all records from the old tlog which have version greater than the latest commit point&#8217;s version. This is to ensure that any update which hasn&#8217;t made it to the index is preserved in the current tlog. This might lead to duplication of updates in the previous and the current tlogs but that is okay.&lt;/li&gt;
	&lt;li&gt;Replica re-opens the searcher&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;For example:&lt;br/&gt;
Leader has the following tlogs&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TLog1 has versions 1,2,3,commit&lt;/li&gt;
	&lt;li&gt;TLog2 has versions 4,5&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Before segment replication, the replica have the following tlogs:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TLog1 - 1,2,3,4,commit&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;After segment replication, the replica will have the following tlogs:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TLog1 - 1,2,3,4,commit&lt;/li&gt;
	&lt;li&gt;TLog2 - 4,5&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;During this process, the replica does not need to be put into &#8216;recovery&#8217; state. It continues to be &#8216;active&#8217; and participate in indexing and searches.&lt;/p&gt;

&lt;h2&gt;&lt;a name=&quot;Replicarecovery&quot;&gt;&lt;/a&gt;Replica recovery&lt;/h2&gt;
&lt;ol&gt;
	&lt;li&gt;Replica puts itself in &#8216;recovery&#8217; state.&lt;/li&gt;
	&lt;li&gt;Replica compares its latest commit point against the leader&lt;/li&gt;
	&lt;li&gt;If the index is same as leader, then it performs &#8216;peersync&#8217; with the leader but only writes the peersync updates to its update log&lt;/li&gt;
	&lt;li&gt;If the index is not the same as leader or if peersync fails, the replica:
	&lt;ul&gt;
		&lt;li&gt;Puts its update log in &#8220;buffering&#8221; state&lt;/li&gt;
		&lt;li&gt;Issues a hard commit to the leader&lt;/li&gt;
		&lt;li&gt;Copies the index commit points from the leader that do not exist locally&lt;/li&gt;
		&lt;li&gt;Publishes itself as &#8216;active&#8217;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;The &#8220;buffering&#8221; state in the above steps ensures that any updates that haven&#8217;t been committed to the leader are also present/replicated to the replica&#8217;s current transaction log&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;With respect to the current recovery strategy in Solr, we need only one change which is to check the index version of leader vs replica before we attempt a peersync.&lt;/p&gt;

&lt;h2&gt;&lt;a name=&quot;LeaderElection&quot;&gt;&lt;/a&gt;Leader Election&lt;/h2&gt;
&lt;p&gt;When a leader dies, a candidate replica will become a new leader. The leader election algorithm remains mostly the same except that after the &#8220;sync&#8221; step, the leader candidate will replay its transaction log before publishing itself as the leader.&lt;/p&gt;

&lt;h2&gt;&lt;a name=&quot;Collectionpropertytoswitchreplicationscheme&quot;&gt;&lt;/a&gt;Collection property to switch replication scheme&lt;/h2&gt;
&lt;p&gt;A new property called &#8220;onlyLeaderIndexes&#8221; will be added to the collection. Any collection that has this property set to true will only index to the elected leader and the rest of the replicas will only fetch index segments from the leader as described above in the document. This property must be set during collection creation. It will default to &#8220;false&#8221;. Existing collections cannot be switched to using the new replication scheme. Future work can attempt to fix that.&lt;/p&gt;

&lt;h2&gt;&lt;a name=&quot;FAQ&quot;&gt;&lt;/a&gt;FAQ&lt;/h2&gt;

&lt;p&gt;Q: What happens on a soft-commit?&lt;br/&gt;
A: soft-commit is nothing but a searcher opened using the IndexWriter which flushes a new segment to the disk but does not commit it. In this case, the newly written segment not being part of a commit point, is not replicated at all. Effectively, soft commits are not useful in this new design currently. Future work may attempt to solve this problem. This same answer applies to searcher re-opens due to real-time-get.&lt;/p&gt;</comment>
                            <comment id="15736051" author="praste" created="Fri, 9 Dec 2016 19:16:26 +0000"  >&lt;p&gt;Instead of periodic polling, can leader upon receiving and processing a commit command, send a notification to replicas asking them to sync up?&lt;/p&gt;</comment>
                            <comment id="15741742" author="shalinmangar" created="Mon, 12 Dec 2016 12:09:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;Instead of periodic polling, can leader upon receiving and processing a commit command, send a notification to replicas asking them to sync up?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We thought about that but we ended up favoring the polling model because the poll request is cheap and we can use existing replication handler code. We will keep the poll interval at half the auto commit time for a start. For this issue, we want to keep the changes limited as much as possible but we can consider a notification feature in later enhancements.&lt;/p&gt;</comment>
                            <comment id="15748538" author="ichattopadhyaya" created="Wed, 14 Dec 2016 14:54:31 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Collection property to switch replication scheme&lt;/p&gt;

&lt;p&gt;A new property called &#8220;onlyLeaderIndexes&#8221; will be added to the collection. Any collection that has this property set to true will only index to the elected leader and the rest of the replicas will only fetch index segments from the leader as described above in the document. This property must be set during collection creation. It will default to &#8220;false&#8221;. Existing collections cannot be switched to using the new replication scheme. Future work can attempt to fix that.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Instead of a hardcoded property name, i.e. onlyLeaderIndexes=true/false, I suggest that we have something like &quot;replicationScheme=onlyLeaderIndexes&quot; (or some other value for the current replication scheme). That would keep the door open for us to add any other replication scheme in future.&lt;/p&gt;</comment>
                            <comment id="15750712" author="caomanhdat" created="Thu, 15 Dec 2016 07:59:12 +0000"  >&lt;p&gt;Here a the patch for this issue, I didn&apos;t do anything related to Leader Recovery, just wanna upload the patch soon so anyone can comment first.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Add &lt;tt&gt;onlyLeaderIndexes&lt;/tt&gt; property to &lt;tt&gt;DocCollection&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Modified &lt;tt&gt;SolrIndexWriter#setCommitData(IndexWriter iw, long commitCommandVersion)&lt;/tt&gt; to store version of commit command to commit point.&lt;/li&gt;
	&lt;li&gt;Start replication process to periodically poll latest segments from leader when replica become active&lt;/li&gt;
	&lt;li&gt;Add &lt;tt&gt;UpdateCommand.IGNORE_INDEXWRITER&lt;/tt&gt; so&lt;br/&gt;
  + DistributedUpdateProcessor can look into the role of current core to add the flag to command&lt;br/&gt;
  + DirectUpdateHandler2 based on the existence of &lt;tt&gt;IGNORE_INDEXWRITER&lt;/tt&gt; to skip making changes to IW, just write down the updateCommand to its tlog&lt;/li&gt;
	&lt;li&gt;Make sure that the current tlog of replicas have all uncommit updates&lt;br/&gt;
  + When replication process is complete&lt;br/&gt;
  + When replica restart&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="15751394" author="caomanhdat" created="Thu, 15 Dec 2016 13:37:51 +0000"  >&lt;p&gt;Updated patch for this issue&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;When a new tlog is created, it copy all old updates that not have been made to its local index.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15778369" author="caomanhdat" created="Mon, 26 Dec 2016 13:50:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yonik%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;yonik@apache.org&quot;&gt;yonik@apache.org&lt;/a&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yseeley%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;yseeley@gmail.com&quot;&gt;yseeley@gmail.com&lt;/a&gt; : Here are scenario for the problem that I encountered today&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;an replica ( let&apos;s call it rep1 ) is on recovering mode -&amp;gt; its ulog will be on buffering state.&lt;/li&gt;
	&lt;li&gt;rep1 receives an update ( contain doc1 ), rep1 will write the update to its tlog without updating ulog.map for real-time-get&lt;/li&gt;
	&lt;li&gt;rep1 replay buffered updates, rep1 will write doc1 to its index, and update ulog.map for real-time-get ( but in this case, ulog.map will point doc1 -&amp;gt; position = -1 because we don&apos;t write updateCommand with REPLAY flag to tlog )&lt;/li&gt;
	&lt;li&gt;client call real-time-get for doc1&lt;/li&gt;
	&lt;li&gt;rep1 will always open a real-time-searcher for this case. Because ulog.map for doc 1 return position = -1&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I just wonder why we do that currently? Why don&apos;t we just write the update to tlog and ulog.map so we don&apos;t have to open a new real-time-searcher for this case?&lt;/p&gt;</comment>
                            <comment id="15782633" author="caomanhdat" created="Wed, 28 Dec 2016 10:47:12 +0000"  >&lt;p&gt;Updated patch&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Leader Recovery&lt;/li&gt;
	&lt;li&gt;Replica recovery will always do replication ( skip peersync ) because I found it very complex to fix all the bugs caused by peersync in this mode. We can support peersync for this mode in future.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15788716" author="praste" created="Sat, 31 Dec 2016 01:49:23 +0000"  >&lt;p&gt;How are we handling leader failure here. if replicas are some what out of sync with the original leader, how would we elect a new leader. &lt;/p&gt;

&lt;p&gt;When the leader fails and a new leader gets elected, the  new leader asks all the replicas to sync with the new leader. My understanding is, &quot;since we are replicating index by fetching segments from leader, most of the segments on all the replicas should look the same, hence all the replicas will not go into full index copying&quot;. Is that correct ?&lt;/p&gt;</comment>
                            <comment id="15788811" author="caomanhdat" created="Sat, 31 Dec 2016 03:10:44 +0000"  >&lt;p&gt;Currently, PeerSync sync on tlog, so it is not a problem if the indexes on all replicas are the same. So Leader Election will be the same as today except that when new leader sync success with other replicas, it must replay its tlog to make all necessary changes to its index.&lt;/p&gt;</comment>
                            <comment id="15793929" author="caomanhdat" created="Tue, 3 Jan 2017 02:23:41 +0000"  >&lt;p&gt;Updated patch for this issues, the changes are pretty solid now. &lt;/p&gt;

&lt;p&gt;The main difference between &lt;tt&gt;onlyLeaderIndexes&lt;/tt&gt; mode and current mode is in &lt;tt&gt;onlyLeaderIndexes&lt;/tt&gt; mode we can serve stale data. So I modified TestInjection to make replicas wait for indexFetcher finish upon receiving commit request, then we can reuse existing tests for SolrCloud to test for &lt;tt&gt;onlyLeaderIndexes&lt;/tt&gt; mode. These are failed tests (5/206 tests of SolrCloud)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;CdcrVersionReplicationTest, ShardSplitTest, SyncSliceTest: we can notify to users that &lt;tt&gt;onlyLeaderIndexes&lt;/tt&gt; hasn&apos;t  supported for CDCR, ShardSplit and SyncSlice yet.&lt;/li&gt;
	&lt;li&gt;LeaderFailureAfterFreshStartTest, PeerSyncReplicationTest : we don&apos;t support peersync yet.&lt;br/&gt;
I think all these tests can be ignored for this issue, we can tackle these failed on other tickets.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I also run the jepsen tests for this mode ( &lt;a href=&quot;https://lucidworks.com/blog/2014/12/10/call-maybe-solrcloud-jepsen-flaky-networks/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://lucidworks.com/blog/2014/12/10/call-maybe-solrcloud-jepsen-flaky-networks/&lt;/a&gt; ). The tests are passed so I think we can pretty sure that new mode is consistency and partition tolerance.&lt;/p&gt;</comment>
                            <comment id="15794569" author="caomanhdat" created="Tue, 3 Jan 2017 09:04:55 +0000"  >&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Clean up the patch.&lt;/li&gt;
	&lt;li&gt;Enable &lt;tt&gt;onlyLeaderIndexes&lt;/tt&gt; mode on some tests.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15795916" author="noble.paul" created="Tue, 3 Jan 2017 19:16:07 +0000"  >&lt;p&gt;What is the public interface for this feature? How do I enable/disable this feature? Is there a command?&lt;/p&gt;</comment>
                            <comment id="15796970" author="caomanhdat" created="Wed, 4 Jan 2017 02:50:45 +0000"  >&lt;p&gt;Right now, to create a collection in &lt;tt&gt;onlyLeaderIndexesMode&lt;/tt&gt; we must use &quot;Create Collection API&quot; with additional parameter : onlyLeaderIndexes=true. When a collection is created on a mode, it will stick to that mode.&lt;/p&gt;

&lt;p&gt;In further ticket, we can support switch between modes.&lt;/p&gt;</comment>
                            <comment id="15796982" author="noble.paul" created="Wed, 4 Jan 2017 02:59:34 +0000"  >&lt;p&gt;I would like this to be added to the description of the ticket&lt;/p&gt;</comment>
                            <comment id="15800881" author="caomanhdat" created="Thu, 5 Jan 2017 09:29:10 +0000"  >&lt;p&gt;Updated patch, change &lt;tt&gt;boolean onlyLeaderIndexes&lt;/tt&gt; to &lt;tt&gt;int liveReplicas&lt;/tt&gt;. &lt;tt&gt;liveReplicas&lt;/tt&gt; indicate the number of replica ( running on old replication mode ). If &lt;tt&gt;liveReplicas = 1&lt;/tt&gt; it will be the same as &lt;tt&gt;onlyLeaderIndexes = true&lt;/tt&gt;, all non-leader replicas will fetch latest index from leader. If &lt;tt&gt;liveReplicas = -1&lt;/tt&gt; it will be the same as &lt;tt&gt;onlyLeaderIndexes = false&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Right now the valid value for &lt;tt&gt;liveReplicas&lt;/tt&gt; are 1 and -1.&lt;/p&gt;

&lt;p&gt;This will enable the opportunity to configure a cluster with some replicas run in old mode and some replicas run in new replication mode.&lt;/p&gt;</comment>
                            <comment id="15815930" author="tomasflobbe" created="Tue, 10 Jan 2017 19:29:13 +0000"  >&lt;p&gt;Great idea! just took a quick look at the patch to understand this better. I have a couple of questions/comments, I know this is work in progress, so feel free to disregard any of my comments if you are working on them:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;onlyLeaderIndexes = zkStateReader.getClusterState().getCollection(collection).getLiveReplicas() == 1;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Maybe add a method to DocCollection like &lt;tt&gt;isOnlyLeaderIndexes()&lt;/tt&gt; (or choose other name)? I understand why you did this, but this code is repeated many times, maybe can be improved for now.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, ReplicateFromLeader&amp;gt; replicateFromLeaders = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&amp;gt;();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Does this need to be synchronized?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;-  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; masterUrl;
+  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; masterUrl;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;should &lt;tt&gt;masterUrl&lt;/tt&gt; now be volatile?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; waitForInSyncWithLeader(SolrCore core, Replica leaderReplica) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InterruptedException {
+    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (waitForReplicasInSync == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
+
+    Pair&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;,&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;&amp;gt; pair = parseValue(waitForReplicasInSync);
+    &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; enabled = pair.first();
+    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!enabled) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
+
+    &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(1000);
+    HttpSolrClient leaderClient = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HttpSolrClient.Builder(leaderReplica.getCoreUrl()).build();
+    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; leaderVersion = -1;
+    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; localVersion = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
+    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
+      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; pair.second(); i++) {
+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (core.isClosed()) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
+        ModifiableSolrParams params = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ModifiableSolrParams();
+        params.set(CommonParams.QT, ReplicationHandler.PATH);
+        params.set(COMMAND, CMD_DETAILS);
+
+        NamedList&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; response = leaderClient.request(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; QueryRequest(params));
+        leaderVersion = (&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;) ((NamedList)response.get(&lt;span class=&quot;code-quote&quot;&gt;&quot;details&quot;&lt;/span&gt;)).get(&lt;span class=&quot;code-quote&quot;&gt;&quot;indexVersion&quot;&lt;/span&gt;);
+
+        localVersion = core.getDeletionPolicy().getLatestCommit().getUserData().get(SolrIndexWriter.COMMIT_TIME_MSEC_KEY);
+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (localVersion == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; leaderVersion == 0) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
+
+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (localVersion != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.parseLong(localVersion) == leaderVersion) {
+          &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
+        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
+          &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(500);
+        }
+      }
+
+    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
+      log.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Exception when wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; replicas in sync with master&quot;&lt;/span&gt;);
+    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
+      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (leaderClient != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) leaderClient.close();
+      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
+        e.printStackTrace();
+      }
+    }
+
+    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
+  }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In many cases in the tests the leader will change before the replication happens, right? Does it make sense to discover the leader inside of the loop? Also, is there a way to remove that Thread.sleep(1000) at the beginning? This code will be called very frequently in tests.&lt;/p&gt;</comment>
                            <comment id="15816241" author="noble.paul" created="Tue, 10 Jan 2017 21:28:59 +0000"  >&lt;blockquote&gt;&lt;p&gt;Maybe add a method to DocCollection like isOnlyLeaderIndexes() (or choose other name)? &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;how about &lt;tt&gt;getLiveReplicasCount()&lt;/tt&gt; ?&lt;/p&gt;</comment>
                            <comment id="15816283" author="tomasflobbe" created="Tue, 10 Jan 2017 21:44:59 +0000"  >&lt;p&gt;I&apos;m just saying, we use the count to detect the mode, and everywhere we are getting the count and inferring the mode depending on the count (count==1 -&amp;gt; onlyLeaderIndexes, count==-1 -&amp;gt; default mode), Instead of that, lets put that logic inside of the DocCollection and ask it for the mode. Anyway, this is not too important, just a suggestion. &lt;/p&gt;</comment>
                            <comment id="15816535" author="yriveiro" created="Tue, 10 Jan 2017 23:32:09 +0000"  >&lt;blockquote&gt;&lt;p&gt;how about getLiveReplicasCount() ?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If I&apos;m reading the code and found a method called getLiveReplicasCount(), I expected that return the number of live replicas for a shard, and if the only value that can return is 1 for onlyLeaderIndexes and -1 for the rest is not a good name.&lt;/p&gt;

&lt;p&gt;Something like: &lt;tt&gt;zkStateReader.getClusterState().getCollection(collection).getReplicationMode()&lt;/tt&gt; that returns an enum(ONLY_LEADER_INDEXES, ALL_REPLICAS_INDEXES) or something like that.&lt;/p&gt;
</comment>
                            <comment id="15816564" author="noble.paul" created="Tue, 10 Jan 2017 23:48:21 +0000"  >&lt;p&gt;It will have a proper count in the future. A mixed mode has to be there eventually. Enum can&apos;t accommodate that&lt;/p&gt;</comment>
                            <comment id="15816584" author="tomasflobbe" created="Tue, 10 Jan 2017 23:58:29 +0000"  >&lt;p&gt;As I said, I understand the reason why it was done this way, but the code right now is only using the count to identify the mode. In the future, the count alone won&apos;t be enough in any of those sections to determine what to do, you&apos;ll have to identify the mode first and then take some more actions (e.g. Am I in the list of replicas that index or not?). &lt;/p&gt;</comment>
                            <comment id="15816918" author="caomanhdat" created="Wed, 11 Jan 2017 02:35:19 +0000"  >&lt;p&gt;Thanks a lot for your comments!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Maybe add a method to DocCollection like &lt;tt&gt;isOnlyLeaderIndexes()&lt;/tt&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;As you know, we won&apos;t use &lt;tt&gt;isOnlyLeaderIndexes()&lt;/tt&gt; in the future ( it won&apos;t have enough information ), so I just do not want to add a public method on DocCollection ( solrj ) and remove it in the future.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Does this need to be synchronized?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yeah, I think we should.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;should masterUrl now be volatile?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I don&apos;t see any reason why we need masterUrl to be volatile? IndexFetcher instance is not being shared across threads.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;In many cases in the tests the leader will change before the replication happens, right? Does it make sense to discover the leader inside of the loop? Also, is there a way to remove that Thread.sleep(1000) at the beginning? This code will be called very frequently in tests.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That&apos;s a good idea.&lt;/p&gt;
</comment>
                            <comment id="15816951" author="tomasflobbe" created="Wed, 11 Jan 2017 02:49:11 +0000"  >&lt;blockquote&gt;&lt;p&gt;I don&apos;t see any reason why we need masterUrl to be volatile? IndexFetcher instance is not being shared across threads.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Isn&apos;t it being used by the ReplicationHandler? Different requests would use the same instance from different threads, right? &lt;/p&gt;</comment>
                            <comment id="15816959" author="caomanhdat" created="Wed, 11 Jan 2017 02:52:09 +0000"  >&lt;p&gt;I created a new ReplicationHandler to do the replication process, so it will not use the same instance from different threads.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;replicationProcess = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ReplicationHandler();
replicationProcess.init(replicationConfig);
replicationProcess.inform(core);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15820080" author="caomanhdat" created="Thu, 12 Jan 2017 03:49:34 +0000"  >&lt;p&gt;Updated patch for this issue :&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Remove &lt;tt&gt;UpdateCommand.NOTICE_INDEXWRITER&lt;/tt&gt; flag by not replaying buffer log if the updates is not made to IW. This changes help the patch more compact&lt;/li&gt;
	&lt;li&gt;When replica recover,
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;replica won&apos;t apply buffer updates&lt;/li&gt;
		&lt;li&gt;fix bug: RTG support for buffering updates ( along with test )&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;ZkController.replicateFromLeaders&lt;/tt&gt; is thread-safe now&lt;/li&gt;
	&lt;li&gt;When cluster restart, only leaders should call &lt;tt&gt;ulog.recoverFromLog()&lt;/tt&gt;, tested by TestCloudRecovery&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;OnlyLeaderIndexesTest&lt;/tt&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;test for RTG&lt;/li&gt;
		&lt;li&gt;test for replicas are consistent&lt;/li&gt;
		&lt;li&gt;more test for replica recovery&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;More tests and fixed bugs&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I will try to write more tests for all possible cases during Replica Recovery and Leader Election. Hoping that I can find more bugs by doing this.&lt;/p&gt;</comment>
                            <comment id="15821813" author="caomanhdat" created="Fri, 13 Jan 2017 14:01:54 +0000"  >&lt;p&gt;This is my final patch, cleanup to make the patch more robust. ( all related tests are passed, included jepsen tests ).&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt; Can you review this patch?&lt;/p&gt;</comment>
                            <comment id="15822697" author="shalinmangar" created="Sat, 14 Jan 2017 05:36:00 +0000"  >&lt;p&gt;Thanks Dat. I have started reviewing your patch.&lt;/p&gt;</comment>
                            <comment id="15850983" author="caomanhdat" created="Fri, 3 Feb 2017 02:58:01 +0000"  >&lt;p&gt;Updated patch to latest source.&lt;/p&gt;</comment>
                            <comment id="15865297" author="caomanhdat" created="Tue, 14 Feb 2017 07:47:14 +0000"  >&lt;p&gt;Updated patch, resolve the potential problem with &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5944&quot; title=&quot;Support updates of numeric DocValues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5944&quot;&gt;&lt;del&gt;SOLR-5944&lt;/del&gt;&lt;/a&gt;. &lt;br/&gt;
In this patch, updates is being sorted before applying when a replica become new leader.&lt;/p&gt;</comment>
                            <comment id="15869050" author="caomanhdat" created="Thu, 16 Feb 2017 03:14:36 +0000"  >&lt;p&gt;Updated patch, change &lt;tt&gt;liveReplicas&lt;/tt&gt; to &lt;tt&gt;realtimeReplicas&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="15879022" author="shalinmangar" created="Wed, 22 Feb 2017 19:24:18 +0000"  >&lt;p&gt;Thanks Dat. Sorry it took me a while to finish reviewing. A few questions/comments&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;LeaderInitiatedRecoveryThread &amp;#8211; What is the reason behind adding SocketTimeoutException in the list of communication errors on which no more retries are made?&lt;/li&gt;
	&lt;li&gt;ZkController.register method &amp;#8211; The condition for !isLeader &amp;amp;&amp;amp; onlyLeaderIndexes can be replaced by the isReplicaInOnlyLeaderIndexes variable.&lt;/li&gt;
	&lt;li&gt;Since there is no log replay on startup on replicas anymore, what if the replica is killed (which keeps its state as &apos;active&apos; in ZK) and then the cluster is restarted and the replica becomes leader candidate? If we do not replay the discarded log then it could lead to data loss?&lt;/li&gt;
	&lt;li&gt;UpdateLog &amp;#8211; Can you please add javadocs outlining the motivation/purpose of the new methods such as copyOverBufferingUpdates and switchToNewTlog e.g. why does switchToNewTlog require copying over some updates from the old tlog?&lt;/li&gt;
	&lt;li&gt;It seems that any commits that might be triggered explicitly by the user can interfere with the index replication. Suppose that a replication is in progress and a user explicitly calls commit which is distributed to all replicas, in such a case the tlogs will be rolled over and then when the ReplicateFromLeader calls switchToNewTlog(), the previous tlog may not have all the updates that should have been copied over. We should have a way to either disable explicit commits or protect against them on the replicas.&lt;/li&gt;
	&lt;li&gt;UpdateLog &amp;#8211; why does copyOverBufferUpdates block updates while calling switchToNewTlog but ReplicateFromLeader doesn&apos;t? How are they both safe?&lt;/li&gt;
	&lt;li&gt;Can we add tests for testing CDCR and backup/restore with this new replication scheme?&lt;/li&gt;
	&lt;li&gt;ZkController.startReplicationFromLeader &amp;#8211; Using a ConcurrentHashMap is not enough to prevent two simultaneous replications from happening concurrently. You should use the atomic putIfAbsent to put a core to the map before starting replication.&lt;/li&gt;
	&lt;li&gt;Aren&apos;t some of the guarantees of real-time-get are relaxed in this new mode especially around delete-by-queries which no longer apply on replicas? Can you please document them as a comment on the issue that we can transfer to the ref guide in future?&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15879721" author="caomanhdat" created="Thu, 23 Feb 2017 02:09:38 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;!&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;LeaderInitiatedRecoveryThread &#8211; What is the reason behind adding SocketTimeoutException in the list of communication errors on which no more retries are made?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This change come from a jepsen test. This bug is also affect current mode. I created another issue for this bug &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9913&quot; title=&quot;LIR should continue on SocketTimeoutException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9913&quot;&gt;SOLR-9913&lt;/a&gt;. We can skip this change for this ticket.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;ZkController.register method &#8211; The condition for !isLeader &amp;amp;&amp;amp; onlyLeaderIndexes can be replaced by the isReplicaInOnlyLeaderIndexes variable.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yeah, that&apos;s right&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Since there is no log replay on startup on replicas anymore, what if the replica is killed (which keeps its state as &apos;active&apos; in ZK) and then the cluster is restarted and the replica becomes leader candidate? If we do not replay the discarded log then it could lead to data loss?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Very good catch, I try to resolve this problem.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;UpdateLog &#8211; Can you please add javadocs outlining the motivation/purpose of the new methods such as copyOverBufferingUpdates and switchToNewTlog e.g. why does switchToNewTlog require copying over some updates from the old tlog?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Sure!&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;It seems that any commits that might be triggered explicitly by the user can interfere with the index replication. Suppose that a replication is in progress and a user explicitly calls commit which is distributed to all replicas, in such a case the tlogs will be rolled over and then when the ReplicateFromLeader calls switchToNewTlog(), the previous tlog may not have all the updates that should have been copied over. We should have a way to either disable explicit commits or protect against them on the replicas.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I don&apos;t think so, switchToNewTlog() is based on commit version at lucene index level (&lt;tt&gt;commit.getUserData().get(SolrIndexWriter.COMMIT_COMMAND_VERSION)&lt;/tt&gt;), so we will always roll over updates in right way.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;UpdateLog &#8211; why does copyOverBufferUpdates block updates while calling switchToNewTlog but ReplicateFromLeader doesn&apos;t? How are they both safe?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Good catch I think we should blockUpdates in switchToNewTlog as well.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Can we add tests for testing CDCR and backup/restore with this new replication scheme?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;CDCR is very complex, I don&apos;t think we should support CDCR in this new replication mode now.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;ZkController.startReplicationFromLeader &#8211; Using a ConcurrentHashMap is not enough to prevent two simultaneous replications from happening concurrently. You should use the atomic putIfAbsent to put a core to the map before starting replication.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yeah, that&apos;s sounds a good idea.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Aren&apos;t some of the guarantees of real-time-get are relaxed in this new mode especially around delete-by-queries which no longer apply on replicas? Can you please document them as a comment on the issue that we can transfer to the ref guide in future?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I will update the ticket description now. Basically RTG is not consistency for DBQs&lt;/p&gt;</comment>
                            <comment id="15879841" author="ichattopadhyaya" created="Thu, 23 Feb 2017 04:38:09 +0000"  >&lt;p&gt;Also, lets add a simple test to ensure that in-place updates work on a replica:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Index few documents to leader, including a full document with id=0.&lt;/li&gt;
	&lt;li&gt;Commit&lt;/li&gt;
	&lt;li&gt;Index few more documents&lt;/li&gt;
	&lt;li&gt;Commit&lt;/li&gt;
	&lt;li&gt;Update id=0 document in-place&lt;/li&gt;
	&lt;li&gt;Commit&lt;/li&gt;
	&lt;li&gt;Assert that the document with id=0 has the same updated value in the leader and the replica.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15880130" author="shalinmangar" created="Thu, 23 Feb 2017 08:51:15 +0000"  >&lt;blockquote&gt;&lt;p&gt;I don&apos;t think so, switchToNewTlog() is based on commit version at lucene index level (commit.getUserData().get(SolrIndexWriter.COMMIT_COMMAND_VERSION)), so we will always roll over updates in right way.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I understand that we use the commit version of the latest commit but the copyOverOldUpdates method only copies updates from the last tlog. If a hard commit happened between the time that we started replication and finished replication, the last tlog will not have all updates that should be copied over. Example:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Leader has the following tlog with these versions:
	&lt;ul&gt;
		&lt;li&gt;tlog0: 1,2,3,4,commit&lt;/li&gt;
		&lt;li&gt;tlog1: 5,6&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Replica has tlogs:
	&lt;ul&gt;
		&lt;li&gt;tlog0: 1,2,3,4,5&lt;/li&gt;
		&lt;li&gt;replication from leader starts&lt;/li&gt;
		&lt;li&gt;user calls explicit commit on replica&lt;/li&gt;
		&lt;li&gt;tlog1: 6&lt;/li&gt;
		&lt;li&gt;replication completes and we call switchToNewTLog which copies over all versions greater than 4 from the last tlog&lt;/li&gt;
		&lt;li&gt;tlog2: 6&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In this case, the update with version 5 is lost and will no longer be available in case this replica becomes leader.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;CDCR is very complex, I don&apos;t think we should support CDCR in this new replication mode now.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Okay, let&apos;s create a follow-up issue for this. CDCR is important enough that we must support it eventually. But I think backup/restore must be supported and tested.&lt;/p&gt;</comment>
                            <comment id="15881765" author="caomanhdat" created="Fri, 24 Feb 2017 01:50:52 +0000"  >&lt;p&gt;Updated patch based on comments of &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ichattopadhyaya&quot; class=&quot;user-hover&quot; rel=&quot;ichattopadhyaya&quot;&gt;ichattopadhyaya&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;2. ZkController.register method &#8211; The condition for !isLeader &amp;amp;&amp;amp; onlyLeaderIndexes can be replaced by the isReplicaInOnlyLeaderIndexes variable.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Done!&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;3. Since there is no log replay on startup on replicas anymore, what if the replica is killed (which keeps its state as &apos;active&apos; in ZK) and then the cluster is restarted and the replica becomes leader candidate? If we do not replay the discarded log then it could lead to data loss?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;To solve this problem, we call &lt;tt&gt;copyOverOldUpdates&lt;/tt&gt; from the last recent tlog on startup.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;4. UpdateLog &#8211; Can you please add javadocs outlining the motivation/purpose of the new methods such as copyOverBufferingUpdates and switchToNewTlog e.g. why does switchToNewTlog require copying over some updates from the old tlog?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Done!&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;6. UpdateLog &#8211; why does copyOverBufferUpdates block updates while calling switchToNewTlog but ReplicateFromLeader doesn&apos;t? How are they both safe?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Both of them are blocking updates now.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;8. ZkController.startReplicationFromLeader &#8211; Using a ConcurrentHashMap is not enough to prevent two simultaneous replications from happening concurrently. You should use the atomic putIfAbsent to put a core to the map before starting replication.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Done!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Also, lets add a simple test to ensure that in-place updates work on a replica&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I modified &lt;tt&gt;TestInPlaceUpdatesDistrib&lt;/tt&gt; to run in random mode. If the tests run on the new mode, we will skip some outOfOderDBQs tests.&lt;/p&gt;</comment>
                            <comment id="15885586" author="shalinmangar" created="Mon, 27 Feb 2017 11:06:32 +0000"  >&lt;ol&gt;
	&lt;li&gt;Dat, can you please add javadocs for all the new methods in UpdateLog?&lt;/li&gt;
	&lt;li&gt;I was looking into &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9706&quot; title=&quot;fetchIndex blocks incoming queries when issued on a replica in SolrCloud&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9706&quot;&gt;SOLR-9706&lt;/a&gt; and it applies to this patch too. However, the fix is easy because most of the corruption checks added by &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6640&quot; title=&quot;Replication can cause index corruption.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6640&quot;&gt;&lt;del&gt;SOLR-6640&lt;/del&gt;&lt;/a&gt; aren&apos;t necessary in this new replication mode so we can safely skip them.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15887477" author="caomanhdat" created="Tue, 28 Feb 2017 07:37:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt; sure,&lt;br/&gt;
This is the updated patch, that I added doc for all new public methods at &lt;tt&gt;UpdateLog&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="15893851" author="caomanhdat" created="Fri, 3 Mar 2017 07:21:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt; Newest patch, ignore block introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6640&quot; title=&quot;Replication can cause index corruption.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6640&quot;&gt;&lt;del&gt;SOLR-6640&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15898427" author="tomasflobbe" created="Tue, 7 Mar 2017 00:08:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=caomanhdat&quot; class=&quot;user-hover&quot; rel=&quot;caomanhdat&quot;&gt;caomanhdat&lt;/a&gt;, I created &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10233&quot; title=&quot;Add support for different replica types in Solr&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10233&quot;&gt;&lt;del&gt;SOLR-10233&lt;/del&gt;&lt;/a&gt; with some related work&lt;/p&gt;</comment>
                            <comment id="15898465" author="caomanhdat" created="Tue, 7 Mar 2017 00:38:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tflobbe&quot; class=&quot;user-hover&quot; rel=&quot;tflobbe&quot;&gt;tflobbe&lt;/a&gt; That sounds great. I will create a branch for this ticket and run some jenkins tests for the patch before committing.&lt;/p&gt;</comment>
                            <comment id="15905479" author="tomasflobbe" created="Fri, 10 Mar 2017 17:52:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=caomanhdat&quot; class=&quot;user-hover&quot; rel=&quot;caomanhdat&quot;&gt;caomanhdat&lt;/a&gt;, I do see some random failures in &lt;tt&gt;OnlyLeaderIndexesTest&lt;/tt&gt; when beasting, do you too?&lt;br/&gt;
Also, I noticed this code in the test&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      checkRTG(1, 1, cluster.getJettySolrRunners());
      fail(&lt;span class=&quot;code-quote&quot;&gt;&quot;Doc1 is deleted but it&apos;s still exist&quot;&lt;/span&gt;);
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (AssertionError e) {}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;which seems wrong&lt;/p&gt;</comment>
                            <comment id="15905973" author="caomanhdat" created="Sat, 11 Mar 2017 01:13:43 +0000"  >&lt;p&gt;@tomasflobbe I also see the tests failed but in this line&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;checkRTG(3,7, cluster.getJettySolrRunners());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The reason for that is LIR is being kicked off when we add document 7 ( &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9555&quot; title=&quot;Leader incorrectly publishes state for replica when it puts replica into LIR.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9555&quot;&gt;&lt;del&gt;SOLR-9555&lt;/del&gt;&lt;/a&gt; ). But I don&apos;t think the code you mentioned is an error.&lt;/p&gt;</comment>
                            <comment id="15905980" author="tomasflobbe" created="Sat, 11 Mar 2017 01:24:02 +0000"  >&lt;blockquote&gt;&lt;p&gt;The reason for that is LIR is being kicked off when we add document 7 ( &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9555&quot; title=&quot;Leader incorrectly publishes state for replica when it puts replica into LIR.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9555&quot;&gt;&lt;del&gt;SOLR-9555&lt;/del&gt;&lt;/a&gt; ). &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes, saw that in my testing too&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;But I don&apos;t think the code you mentioned is an error.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;tt&gt;fail(&quot;Doc1 is deleted but it&apos;s still exist&quot;)&lt;/tt&gt; will throw an &lt;tt&gt;AssertionError&lt;/tt&gt; if hit, but this code is swallowing that error&lt;/p&gt;</comment>
                            <comment id="15905981" author="caomanhdat" created="Sat, 11 Mar 2017 01:26:10 +0000"  >&lt;p&gt;That&apos;s right. I will fix that problem today.&lt;/p&gt;</comment>
                            <comment id="15923572" author="caomanhdat" created="Tue, 14 Mar 2017 04:47:46 +0000"  >&lt;p&gt;Latest patch for this ticket. Will commit it soon.&lt;/p&gt;</comment>
                            <comment id="15923724" author="jira-bot" created="Tue, 14 Mar 2017 07:38:00 +0000"  >&lt;p&gt;Commit 7830462d4b7da3acefff6353419e71cde62d5fee in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=caomanhdat&quot; class=&quot;user-hover&quot; rel=&quot;caomanhdat&quot;&gt;caomanhdat&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=7830462&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=7830462&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9835&quot; title=&quot;Create another replication mode for SolrCloud&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9835&quot;&gt;&lt;del&gt;SOLR-9835&lt;/del&gt;&lt;/a&gt;: Create another replication mode for SolrCloud&lt;/p&gt;</comment>
                            <comment id="15923854" author="jira-bot" created="Tue, 14 Mar 2017 09:20:57 +0000"  >&lt;p&gt;Commit 120274b451646ddd9e1de9e12a4904414f881c7c in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=caomanhdat&quot; class=&quot;user-hover&quot; rel=&quot;caomanhdat&quot;&gt;caomanhdat&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=120274b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=120274b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9835&quot; title=&quot;Create another replication mode for SolrCloud&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9835&quot;&gt;&lt;del&gt;SOLR-9835&lt;/del&gt;&lt;/a&gt;: Update CHANGES.txt&lt;/p&gt;</comment>
                            <comment id="15923897" author="markrmiller@gmail.com" created="Tue, 14 Mar 2017 09:54:43 +0000"  >&lt;p&gt;Looks like this broke the build? I compile errors about missing ZkController methods.&lt;/p&gt;</comment>
                            <comment id="15923899" author="markrmiller@gmail.com" created="Tue, 14 Mar 2017 09:55:43 +0000"  >&lt;p&gt;Nevermind, some local glitch. Got it cleaned up.&lt;/p&gt;</comment>
                            <comment id="15930253" author="yseeley@gmail.com" created="Fri, 17 Mar 2017 16:30:06 +0000"  >&lt;p&gt;OnlyLeaderIndexesTest just failed for me. Seems like it fails sometimes for jenkins too:&lt;br/&gt;
&lt;a href=&quot;https://jenkins.thetaphi.de/job/Lucene-Solr-master-Windows/6455/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://jenkins.thetaphi.de/job/Lucene-Solr-master-Windows/6455/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15931066" author="markrmiller@gmail.com" created="Sat, 18 Mar 2017 05:23:52 +0000"  >&lt;p&gt;Yeah, I see this too. It doesn&apos;t beast too terribly though. I&apos;ll attach some fail logs.&lt;/p&gt;</comment>
                            <comment id="15932053" author="jira-bot" created="Mon, 20 Mar 2017 01:22:05 +0000"  >&lt;p&gt;Commit 4bc75dbf235145fad5ec1001004c663e15449523 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=caomanhdat&quot; class=&quot;user-hover&quot; rel=&quot;caomanhdat&quot;&gt;caomanhdat&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=4bc75db&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=4bc75db&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9835&quot; title=&quot;Create another replication mode for SolrCloud&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9835&quot;&gt;&lt;del&gt;SOLR-9835&lt;/del&gt;&lt;/a&gt;: Fix OnlyLeaderIndexesTest failure, inplace updates is not copied over properly&lt;/p&gt;</comment>
                            <comment id="15942950" author="jira-bot" created="Mon, 27 Mar 2017 09:44:33 +0000"  >&lt;p&gt;Commit d156aafd1d5cfda2d7b56e4c73c6ddee43d48e91 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=caomanhdat&quot; class=&quot;user-hover&quot; rel=&quot;caomanhdat&quot;&gt;caomanhdat&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=d156aaf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=d156aaf&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9835&quot; title=&quot;Create another replication mode for SolrCloud&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9835&quot;&gt;&lt;del&gt;SOLR-9835&lt;/del&gt;&lt;/a&gt;: TestInjection.waitForInSyncWithLeader() should rely on commit point of searcher&lt;/p&gt;</comment>
                            <comment id="15943368" author="jira-bot" created="Mon, 27 Mar 2017 14:36:19 +0000"  >&lt;p&gt;Commit cd66a5ff51b7a9ff55edaa9fb5d7df5af42707e4 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=cd66a5f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=cd66a5f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9835&quot; title=&quot;Create another replication mode for SolrCloud&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9835&quot;&gt;&lt;del&gt;SOLR-9835&lt;/del&gt;&lt;/a&gt;: Fixed precommit failure.&lt;/p&gt;</comment>
                            <comment id="15954328" author="erickerickson" created="Mon, 3 Apr 2017 23:28:29 +0000"  >&lt;p&gt;will this be ported to 6x and what is the expected timeframe if so? Or will it just be a 7.0 feature?&lt;/p&gt;</comment>
                            <comment id="15954479" author="ctargett" created="Tue, 4 Apr 2017 02:25:16 +0000"  >&lt;blockquote&gt;&lt;p&gt;will this be ported to 6x and what is the expected timeframe if so? Or will it just be a 7.0 feature?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;In this comment to &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10233&quot; title=&quot;Add support for different replica types in Solr&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10233&quot;&gt;&lt;del&gt;SOLR-10233&lt;/del&gt;&lt;/a&gt;: &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10233?focusedCommentId=15901980&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15901980&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-10233?focusedCommentId=15901980&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15901980&lt;/a&gt;, Tom&#225;s notes that some API changes will be made in the course of developing that feature, and those changes will impact the work done on this issue already. Because of this, these changes will be kept on master for the time-being to avoid back-compat issues.&lt;/p&gt;</comment>
                            <comment id="16014895" author="tomasflobbe" created="Wed, 17 May 2017 22:51:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=caomanhdat&quot; class=&quot;user-hover&quot; rel=&quot;caomanhdat&quot;&gt;caomanhdat&lt;/a&gt;, I have a nocommit in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10233&quot; title=&quot;Add support for different replica types in Solr&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10233&quot;&gt;&lt;del&gt;SOLR-10233&lt;/del&gt;&lt;/a&gt; related to a change you did as part of this Jira:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;@@ -260,7 +263,7 @@ public class RecoveryStrategy extends Thread implements Closeable {
       UpdateRequest ureq = new UpdateRequest();
       ureq.setParams(new ModifiableSolrParams());
       ureq.getParams().set(DistributedUpdateProcessor.COMMIT_END_POINT, true);
-      ureq.getParams().set(UpdateParams.OPEN_SEARCHER, false);
+      ureq.getParams().set(UpdateParams.OPEN_SEARCHER, onlyLeaderIndexes);
       ureq.setAction(AbstractUpdateRequest.ACTION.COMMIT, false, true).process(
           client);
     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Why do we need to open searcher in the leader when doing a commit on leader for recovery?&lt;/p&gt;</comment>
                            <comment id="16072965" author="tomasflobbe" created="Mon, 3 Jul 2017 23:00:42 +0000"  >&lt;p&gt;Marking this as resolved. Any extra related work should have it&apos;s own Jira.&lt;/p&gt;</comment>
                            <comment id="16082512" author="caomanhdat" created="Tue, 11 Jul 2017 16:58:47 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tflobbe&quot; class=&quot;user-hover&quot; rel=&quot;tflobbe&quot;&gt;tflobbe&lt;/a&gt;!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12726683">SOLR-6237</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13048668">SOLR-10233</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13016639">SOLR-9706</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="13041507">SOLR-10106</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12859409" name="OnlyLeaderIndexesTest-fail-1.zip" size="80532" author="markrmiller@gmail.com" created="Sat, 18 Mar 2017 05:24:20 +0000"/>
                            <attachment id="12858621" name="SOLR-9835.patch" size="98401" author="caomanhdat" created="Tue, 14 Mar 2017 04:47:46 +0000"/>
                            <attachment id="12855795" name="SOLR-9835.patch" size="94772" author="caomanhdat" created="Fri, 3 Mar 2017 07:21:37 +0000"/>
                            <attachment id="12855080" name="SOLR-9835.patch" size="93654" author="caomanhdat" created="Tue, 28 Feb 2017 07:37:36 +0000"/>
                            <attachment id="12854358" name="SOLR-9835.patch" size="93192" author="caomanhdat" created="Fri, 24 Feb 2017 01:51:19 +0000"/>
                            <attachment id="12852956" name="SOLR-9835.patch" size="90569" author="caomanhdat" created="Thu, 16 Feb 2017 03:14:36 +0000"/>
                            <attachment id="12852520" name="SOLR-9835.patch" size="90349" author="caomanhdat" created="Tue, 14 Feb 2017 07:47:14 +0000"/>
                            <attachment id="12850753" name="SOLR-9835.patch" size="78370" author="caomanhdat" created="Fri, 3 Feb 2017 02:58:01 +0000"/>
                            <attachment id="12847337" name="SOLR-9835.patch" size="78822" author="caomanhdat" created="Fri, 13 Jan 2017 14:01:54 +0000"/>
                            <attachment id="12847143" name="SOLR-9835.patch" size="81519" author="caomanhdat" created="Thu, 12 Jan 2017 03:49:34 +0000"/>
                            <attachment id="12845758" name="SOLR-9835.patch" size="86415" author="caomanhdat" created="Thu, 5 Jan 2017 09:29:10 +0000"/>
                            <attachment id="12845351" name="SOLR-9835.patch" size="87825" author="caomanhdat" created="Tue, 3 Jan 2017 09:04:55 +0000"/>
                            <attachment id="12845317" name="SOLR-9835.patch" size="79869" author="caomanhdat" created="Tue, 3 Jan 2017 02:23:41 +0000"/>
                            <attachment id="12844914" name="SOLR-9835.patch" size="75357" author="caomanhdat" created="Wed, 28 Dec 2016 10:47:12 +0000"/>
                            <attachment id="12843416" name="SOLR-9835.patch" size="52123" author="caomanhdat" created="Thu, 15 Dec 2016 13:37:51 +0000"/>
                            <attachment id="12843366" name="SOLR-9835.patch" size="52645" author="caomanhdat" created="Thu, 15 Dec 2016 07:59:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>16.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 19 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i37aq7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>