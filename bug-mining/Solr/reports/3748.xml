<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:30:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-11692] SolrDispatchFilter.closeShield passes the shielded response object back to jetty making the stream unclose able</title>
                <link>https://issues.apache.org/jira/browse/SOLR-11692</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;In test mode we trigger closeShield code in SolrDispatchFilter, however there are code paths where we passthrough the objects to the DefaultHandler which can no longer close the response.&lt;/p&gt;

&lt;p&gt;Example stack trace:&lt;br/&gt;
java.lang.AssertionError: Attempted close of response output stream.&lt;br/&gt;
    at org.apache.solr.servlet.SolrDispatchFilter$2$1.close(SolrDispatchFilter.java:528)&lt;br/&gt;
    at org.eclipse.jetty.server.Dispatcher.commitResponse(Dispatcher.java:315)&lt;br/&gt;
    at org.eclipse.jetty.server.Dispatcher.forward(Dispatcher.java:279)&lt;br/&gt;
    at org.eclipse.jetty.server.Dispatcher.forward(Dispatcher.java:103)&lt;br/&gt;
    at org.eclipse.jetty.servlet.DefaultServlet.doGet(DefaultServlet.java:566)&lt;br/&gt;
    at javax.servlet.http.HttpServlet.service(HttpServlet.java:734)&lt;br/&gt;
    at javax.servlet.http.HttpServlet.service(HttpServlet.java:847)&lt;br/&gt;
    at org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:684)&lt;br/&gt;
    at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1448)&lt;br/&gt;
    at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:385)&lt;br/&gt;
    at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:326)&lt;br/&gt;
    at searchserver.filter.SfdcDispatchFilter.doFilter(SfdcDispatchFilter.java:204)&lt;br/&gt;
    at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1419)&lt;br/&gt;
    at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:455)&lt;br/&gt;
    at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:137)&lt;br/&gt;
    at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:557)&lt;br/&gt;
    at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:231)&lt;br/&gt;
    at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1075)&lt;br/&gt;
    at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:384)&lt;br/&gt;
    at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:193)&lt;br/&gt;
    at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1009)&lt;br/&gt;
    at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:135)&lt;br/&gt;
    at org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:255)&lt;br/&gt;
    at org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:154)&lt;br/&gt;
    at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:116)&lt;br/&gt;
    at org.eclipse.jetty.server.Server.handle(Server.java:370)&lt;br/&gt;
    at org.eclipse.jetty.server.AbstractHttpConnection.handleRequest(AbstractHttpConnection.java:489)&lt;br/&gt;
    at org.eclipse.jetty.server.AbstractHttpConnection.headerComplete(AbstractHttpConnection.java:949)&lt;br/&gt;
    at org.eclipse.jetty.server.AbstractHttpConnection$RequestHandler.headerComplete(AbstractHttpConnection.java:1011)&lt;br/&gt;
    at org.eclipse.jetty.http.HttpParser.parseNext(HttpParser.java:644)&lt;br/&gt;
    at org.eclipse.jetty.http.HttpParser.parseAvailable(HttpParser.java:235)&lt;br/&gt;
    at org.eclipse.jetty.server.AsyncHttpConnection.handle(AsyncHttpConnection.java:82)&lt;br/&gt;
    at org.eclipse.jetty.io.nio.SelectChannelEndPoint.handle(SelectChannelEndPoint.java:668)&lt;br/&gt;
    at org.eclipse.jetty.io.nio.SelectChannelEndPoint$1.run(SelectChannelEndPoint.java:52)&lt;br/&gt;
    at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:608)&lt;br/&gt;
    at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:543)&lt;br/&gt;
    at java.lang.Thread.run(Thread.java:745)&lt;/p&gt;

&lt;p&gt;Related JIRA: &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8933&quot; title=&quot;SolrDispatchFilter::consumeInput logs &amp;quot;Stream Closed&amp;quot; IOException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8933&quot;&gt;&lt;del&gt;SOLR-8933&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Linux/Mac tested&lt;/p&gt;</environment>
        <key id="13121449">SOLR-11692</key>
            <summary>SolrDispatchFilter.closeShield passes the shielded response object back to jetty making the stream unclose able</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dsmiley">David Smiley</assignee>
                                    <reporter username="millerjeff0">Jeff Miller</reporter>
                        <labels>
                            <label>dispatchlayer</label>
                            <label>jetty</label>
                            <label>newbie</label>
                            <label>streams</label>
                    </labels>
                <created>Tue, 28 Nov 2017 21:17:08 +0000</created>
                <updated>Sat, 8 Jun 2019 15:11:48 +0000</updated>
                            <resolved>Tue, 9 Jan 2018 03:41:39 +0000</resolved>
                                    <version>7.1</version>
                                    <fixVersion>7.3</fixVersion>
                                    <component>Response Writers</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="10800">3h</timeoriginalestimate>
                            <timeestimate seconds="10800">3h</timeestimate>
                                        <comments>
                            <comment id="16269476" author="millerjeff0" created="Tue, 28 Nov 2017 21:19:49 +0000"  >&lt;p&gt;Note this is test mode only code,  doesn&apos;t affect solr with asserts turned off.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt; suggested a fix where we keep the original response object to pass back up to jetty when solr code is done with it,  I will send out a attempted patch later&lt;/p&gt;</comment>
                            <comment id="16273647" author="millerjeff0" created="Thu, 30 Nov 2017 23:24:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; Can you comment on this patch? The idea being we wrap the closeshield for the request/response only in the context of SolrDispatchFilter and if we have to pass it up to chain or forward it we pass the original &lt;/p&gt;

&lt;p&gt;&amp;lt;Removed Pasted Code&amp;gt;&lt;/p&gt;</comment>
                            <comment id="16273860" author="dsmiley" created="Fri, 1 Dec 2017 02:59:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=millerjeff0&quot; class=&quot;user-hover&quot; rel=&quot;millerjeff0&quot;&gt;millerjeff0&lt;/a&gt; can you attach a patch to the issue instead?  inlining diffs is problematic due to escaping.  Also, unlike some diffs which need no context, for this one it&apos;s necessary to apply it to notice that your intent was to move the closing until after code that calls &lt;tt&gt;chain.doFilter&lt;/tt&gt;.  I looked at SolrDispatchFilter and do note &lt;tt&gt;chain.doFilter&lt;/tt&gt; is actually in two places (not one); the second is beyond where you moved it to.  So I think your patch here only addresses the issue for some cases but not others.  Any way, the fix should be easy.&lt;/p&gt;</comment>
                            <comment id="16274610" author="millerjeff0" created="Fri, 1 Dec 2017 16:47:29 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt;, here is a patch&lt;/p&gt;</comment>
                            <comment id="16275021" author="dsmiley" created="Fri, 1 Dec 2017 21:33:13 +0000"  >&lt;p&gt;+1 I like it Jeff.&lt;/p&gt;

&lt;p&gt;The only change I suggest making is a little bit of maintenance here regarding the annoying casting of ServletRequest to HttpServletRequest in several places in this method.  You&apos;ve added another spot.  Notice the first line of this method ensures we have the HTTP version.  Perhaps we can rename the parameter slightly and then cast to the current name in a local variable... then change various methods here to expect/return HttpServletRequest.  What do you think?  &lt;/p&gt;</comment>
                            <comment id="16275163" author="millerjeff0" created="Fri, 1 Dec 2017 23:17:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt; sent PR &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/281&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/281&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16275670" author="dsmiley" created="Sat, 2 Dec 2017 17:38:27 +0000"  >&lt;p&gt;Ok; when creating PRs, be sure to reference the JIRA issue ID so that it gets linked automatically.  Maybe PRs can be renamed?  If not; no big deal.&lt;/p&gt;

&lt;p&gt;BTW thanks for entertaining my request to do this little bit of cleanup.  IMO cleanup needs to be amortized into all we do; doing cleanup just for cleanup sake (its own issue) is hard to get the time for.&lt;/p&gt;</comment>
                            <comment id="16275719" author="dsmiley" created="Sat, 2 Dec 2017 19:19:13 +0000"  >&lt;p&gt;Code looks good &amp;#8211; I&apos;m running test now and will commit after.  Thanks for contributing Jeff!&lt;/p&gt;

&lt;p&gt;Proposed CHANGES.txt&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Other Changes:
* SOLR-11692: (tests only) When SolrDispatchFilter passes on requests in the Servlet filter chain, 
  it should not use its closeShield&apos;ed streams.  (Jeff Miller, David Smiley)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16275817" author="dsmiley" created="Sun, 3 Dec 2017 04:29:36 +0000"  >&lt;p&gt;4 tests fail, and I tried at at least some of them with and without the patch to verify they reproduced with the patch but not without the patch:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   [junit4] Tests with failures [seed: 37DAB2BA08A37C95]:
   [junit4]   - org.apache.solr.security.BasicAuthStandaloneTest.testBasicAuth
   [junit4]   - org.apache.solr.cloud.TestConfigSetsAPI.testUploadWithScriptUpdateProcessor
   [junit4]   - org.apache.solr.security.BasicAuthIntegrationTest.testBasicAuth
   [junit4]   - org.apache.solr.security.PKIAuthenticationIntegrationTest.testPkiAuth
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16317069" author="dsmiley" created="Mon, 8 Jan 2018 21:12:30 +0000"  >&lt;p&gt;Aha; I see the problem.  Took a bit of debugging to find this nasty bug.  Notice on line ~353 that the request var is replaced with wrappedRequest.get() if there&apos;s something there.  In your patch you retained both &quot;request&quot; and &quot;httpServletRequest&quot; as valid variables... which is conducive to causing this bug.  In this new version of the patch, I renamed the formal parameter names to have a leading underscore and then first thing I immediately assign them to the Http variant with the same name without the leading underscore.&lt;/p&gt;

&lt;p&gt;Tests are running now; if it checks out I&apos;ll commit shortly.  Thanks for the contribution Jeff!&lt;/p&gt;</comment>
                            <comment id="16317633" author="jira-bot" created="Tue, 9 Jan 2018 03:39:47 +0000"  >&lt;p&gt;Commit 7a375fda828015ab62702e2e0f07a1038aef40c6 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=7a375fd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=7a375fd&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11692&quot; title=&quot;SolrDispatchFilter.closeShield passes the shielded response object back to jetty making the stream unclose able&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11692&quot;&gt;&lt;del&gt;SOLR-11692&lt;/del&gt;&lt;/a&gt;: Constrain cases where SolrDispatchFilter uses closeShield&lt;/p&gt;</comment>
                            <comment id="16317634" author="jira-bot" created="Tue, 9 Jan 2018 03:40:32 +0000"  >&lt;p&gt;Commit 9e3c16cf2ef0d2b9d562d8df75b4688d6ce0131a in lucene-solr&apos;s branch refs/heads/branch_7x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=9e3c16c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=9e3c16c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11692&quot; title=&quot;SolrDispatchFilter.closeShield passes the shielded response object back to jetty making the stream unclose able&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11692&quot;&gt;&lt;del&gt;SOLR-11692&lt;/del&gt;&lt;/a&gt;: Constrain cases where SolrDispatchFilter uses closeShield&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 7a375fd)&lt;/p&gt;</comment>
                            <comment id="16335373" author="githubbot" created="Tue, 23 Jan 2018 04:31:01 +0000"  >&lt;p&gt;Github user tflobbe commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/281&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/281&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    This PR was already merged (&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11692&quot; title=&quot;SolrDispatchFilter.closeShield passes the shielded response object back to jetty making the stream unclose able&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11692&quot;&gt;&lt;del&gt;SOLR-11692&lt;/del&gt;&lt;/a&gt;) but wasn&apos;t mentioned in the commit message. Could you close @millerjeff0 ?&lt;/p&gt;</comment>
                            <comment id="16458296" author="markrmiller@gmail.com" created="Mon, 30 Apr 2018 04:02:31 +0000"  >&lt;p&gt;Sorry, I missed this. The jetty servlet actually should not be closing in forward like that, we need to reuse our connections and only the container itself should close them. I&apos;ve addressed this properly and expanded shielding to cover even more than it was in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12290&quot; title=&quot;Do not close any servlet streams and improve our servlet stream closing prevention code for users and devs.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12290&quot;&gt;&lt;del&gt;SOLR-12290&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13155994">SOLR-12290</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12905155" name="SOLR-11692.patch" size="8483" author="dsmiley" created="Mon, 8 Jan 2018 21:06:37 +0000"/>
                            <attachment id="12900248" name="SOLR-11692.patch" size="1143" author="millerjeff0" created="Fri, 1 Dec 2017 16:47:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 29 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3nb3b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>