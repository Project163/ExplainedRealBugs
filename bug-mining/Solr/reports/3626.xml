<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:27:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-11293] Possible data loss when index of tlog replica is not empty but latestVersions of master equals 0</title>
                <link>https://issues.apache.org/jira/browse/SOLR-11293</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;From ReplicationHandler&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (latestVersion == 0L) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (forceReplication &amp;amp;&amp;amp; commit.getGeneration() != 0) {
          solrCore.getIndexWriter().deleteAll();
          solrCore.getUpdateHandler().commit(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CommitUpdateCommand(req, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;));
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; success;
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The inconsistent happens when commit version of master equals 0 but tlog replica does not clear its index.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://jenkins.thetaphi.de/job/Lucene-Solr-master-MacOSX/4140/testReport/org.apache.solr.cloud/HttpPartitionTest/test/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://jenkins.thetaphi.de/job/Lucene-Solr-master-MacOSX/4140/testReport/org.apache.solr.cloud/HttpPartitionTest/test/&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Error Message

Doc with id=1 not found in http:&lt;span class=&quot;code-comment&quot;&gt;//127.0.0.1:60897/b/xj/collMinRf_1x3 due to: Path not found: /id; rsp={doc=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;}
&lt;/span&gt;Stacktrace

java.lang.AssertionError: Doc with id=1 not found in http:&lt;span class=&quot;code-comment&quot;&gt;//127.0.0.1:60897/b/xj/collMinRf_1x3 due to: Path not found: /id; rsp={doc=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;}
&lt;/span&gt;	at __randomizedtesting.SeedInfo.seed([ACF841744A332569:24AC7EAEE4CF4891]:0)
	at org.junit.Assert.fail(Assert.java:93)
	at org.junit.Assert.assertTrue(Assert.java:43)
	at org.apache.solr.cloud.HttpPartitionTest.assertDocExists(HttpPartitionTest.java:603)
	at org.apache.solr.cloud.HttpPartitionTest.assertDocsExistInAllReplicas(HttpPartitionTest.java:558)
	at org.apache.solr.cloud.HttpPartitionTest.testMinRf(HttpPartitionTest.java:249)
	at org.apache.solr.cloud.HttpPartitionTest.test(HttpPartitionTest.java:127)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13097853">SOLR-11293</key>
            <summary>Possible data loss when index of tlog replica is not empty but latestVersions of master equals 0</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="caomanhdat">Cao Manh Dat</assignee>
                                    <reporter username="noble.paul">Noble Paul</reporter>
                        <labels>
                    </labels>
                <created>Mon, 28 Aug 2017 00:16:38 +0000</created>
                <updated>Wed, 2 Oct 2019 17:30:19 +0000</updated>
                            <resolved>Sat, 9 Dec 2017 00:06:00 +0000</resolved>
                                                    <fixVersion>7.2</fixVersion>
                    <fixVersion>8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="16143795" author="jira-bot" created="Mon, 28 Aug 2017 13:50:40 +0000"  >&lt;p&gt;Commit d86bc63e7041ced644fd609e922d6e88888c0f2e in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=d86bc63&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=d86bc63&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11293&quot; title=&quot;Possible data loss when index of tlog replica is not empty but latestVersions of master equals 0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11293&quot;&gt;&lt;del&gt;SOLR-11293&lt;/del&gt;&lt;/a&gt;: Awaits fix&lt;/p&gt;</comment>
                            <comment id="16143801" author="noble.paul" created="Mon, 28 Aug 2017 13:53:16 +0000"  >&lt;p&gt;diagnosis. TLOG type replica loses updates and they don&apos;t get fetched in real-time gets. This may cause data-loss for TLOG replica types  &lt;/p&gt;</comment>
                            <comment id="16146784" author="noble.paul" created="Wed, 30 Aug 2017 07:04:53 +0000"  >&lt;p&gt;The patch fixes bugs in &lt;tt&gt;UpdateLog.java&lt;/tt&gt; and &lt;tt&gt;ReplicateFromLeader.java&lt;/tt&gt; and re-enables the &lt;tt&gt;HttpPartitionTest&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="16146786" author="noble.paul" created="Wed, 30 Aug 2017 07:05:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=caomanhdat&quot; class=&quot;user-hover&quot; rel=&quot;caomanhdat&quot;&gt;caomanhdat&lt;/a&gt; pls take a look&lt;/p&gt;</comment>
                            <comment id="16147848" author="jira-bot" created="Wed, 30 Aug 2017 19:00:54 +0000"  >&lt;p&gt;Commit d66e2ad614c4d44ded83ddcf50843dc16e391aa8 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=janhoy&quot; class=&quot;user-hover&quot; rel=&quot;janhoy&quot;&gt;janhoy&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=d66e2ad&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=d66e2ad&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11293&quot; title=&quot;Possible data loss when index of tlog replica is not empty but latestVersions of master equals 0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11293&quot;&gt;&lt;del&gt;SOLR-11293&lt;/del&gt;&lt;/a&gt;: Fix precommit failures on unused imports&lt;/p&gt;</comment>
                            <comment id="16148797" author="caomanhdat" created="Thu, 31 Aug 2017 10:23:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt; +1 to commit the patch, &lt;/p&gt;</comment>
                            <comment id="16148955" author="jira-bot" created="Thu, 31 Aug 2017 13:12:37 +0000"  >&lt;p&gt;Commit 1d3137057797a367c4a29ea7ef584244cf2b8198 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=1d31370&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=1d31370&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11293&quot; title=&quot;Possible data loss when index of tlog replica is not empty but latestVersions of master equals 0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11293&quot;&gt;&lt;del&gt;SOLR-11293&lt;/del&gt;&lt;/a&gt;: Potential data loss in TLOG replicas after replication failures&lt;/p&gt;</comment>
                            <comment id="16148958" author="jira-bot" created="Thu, 31 Aug 2017 13:14:26 +0000"  >&lt;p&gt;Commit a72f9aba54f20849e915265a9596e3cc34c092b4 in lucene-solr&apos;s branch refs/heads/branch_7x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=a72f9ab&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=a72f9ab&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11293&quot; title=&quot;Possible data loss when index of tlog replica is not empty but latestVersions of master equals 0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11293&quot;&gt;&lt;del&gt;SOLR-11293&lt;/del&gt;&lt;/a&gt;: Potential data loss in TLOG replicas after replication failures&lt;/p&gt;</comment>
                            <comment id="16149267" author="tomasflobbe" created="Thu, 31 Aug 2017 17:06:56 +0000"  >&lt;p&gt;If this is fixing a potential data loss, maybe we should backport this to 7_0 and respin. WDYT &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="16149717" author="noble.paul" created="Thu, 31 Aug 2017 22:29:39 +0000"  >&lt;p&gt;Let the 7.0 go ahead. TLOG is used by very few people we will let users know it&lt;/p&gt;</comment>
                            <comment id="16149943" author="shalinmangar" created="Fri, 1 Sep 2017 02:37:56 +0000"  >&lt;p&gt;Sorry, we shouldn&apos;t release with a known data-loss bug in a major feature being introduced with 7.0! This is absolutely a blocker. Ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anshumg&quot; class=&quot;user-hover&quot; rel=&quot;anshumg&quot;&gt;anshumg&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16149945" author="tomasflobbe" created="Fri, 1 Sep 2017 02:41:52 +0000"  >&lt;blockquote&gt;&lt;p&gt;Sorry, we shouldn&apos;t release with a known data-loss bug in a major feature being introduced with 7.0! &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;+1. If we are confident of the solution let&apos;s backpprt and respin&lt;/p&gt;</comment>
                            <comment id="16150029" author="noble.paul" created="Fri, 1 Sep 2017 04:28:35 +0000"  >&lt;p&gt;I don&apos;t know what has changed between 7.0 and master. Even after beasting it for 50 iterations , the test hasn&apos;t failed even once.&lt;/p&gt;</comment>
                            <comment id="16150617" author="anshumg" created="Fri, 1 Sep 2017 14:25:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt; if you are still confident about the fix, I don&apos;t mind re-spinning. &lt;/p&gt;

&lt;p&gt;Actually, to rephrase, I wouldn&apos;t want to release with a known data loss issue, so if you think that the issue exists on 7.0 as well, let&apos;s abort the current vote, and respin.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tflobbe&quot; class=&quot;user-hover&quot; rel=&quot;tflobbe&quot;&gt;tflobbe&lt;/a&gt;: what do you think?&lt;/p&gt;</comment>
                            <comment id="16150667" author="noble.paul" created="Fri, 1 Sep 2017 14:55:22 +0000"  >&lt;p&gt;The test was failing in 5 iterations in master while I could not get it to fail in 100 iterations in 7.0. so, it id reasonable to assume that something has changed in master that makes it more likely to happen. So, in the absence of a proper test, i cannot say with any confidence that this bug indeed exists in 7.0. &lt;/p&gt;</comment>
                            <comment id="16150894" author="tomasflobbe" created="Fri, 1 Sep 2017 17:37:46 +0000"  >&lt;p&gt;Can you explain the logic behind the change? Before, the &quot;oldTlog&quot; wouldn&apos;t be copied over if it finished with a commit, but now it is?&lt;/p&gt;</comment>
                            <comment id="16151343" author="noble.paul" created="Sat, 2 Sep 2017 00:35:48 +0000"  >&lt;p&gt;There were multiple issues.&lt;br/&gt;
If a commit happens and there are some docs there in the index,they were not copied over &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;f the commit versions are not changed&lt;/li&gt;
	&lt;li&gt;f the docs address not in the current TLOG&lt;/li&gt;
	&lt;li&gt;If the tlog file ends with a commit message&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16151383" author="caomanhdat" created="Sat, 2 Sep 2017 02:48:22 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;, I suddenly realize that your patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11293&quot; title=&quot;Possible data loss when index of tlog replica is not empty but latestVersions of master equals 0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11293&quot;&gt;&lt;del&gt;SOLR-11293&lt;/del&gt;&lt;/a&gt; is very ineffection, every time IndexFetcher is kick off even when nothing is downloaded, we will always reading the oldTlog over and over. I don&apos;t think this is a good idea. I will look at this issue deeper today.&lt;/p&gt;</comment>
                            <comment id="16151390" author="noble.paul" created="Sat, 2 Sep 2017 03:14:58 +0000"  >&lt;p&gt;No. When nothing is downloaded, the callback is not invoked &lt;/p&gt;</comment>
                            <comment id="16151391" author="caomanhdat" created="Sat, 2 Sep 2017 03:16:22 +0000"  >&lt;p&gt;No, you can check that again. Even  when nothing is downloaded, updateLog.copyOverOldUpdates() will always be invoked.&lt;/p&gt;</comment>
                            <comment id="16151405" author="caomanhdat" created="Sat, 2 Sep 2017 04:28:14 +0000"  >&lt;p&gt;Here are my patch for fixing the problem. This revert the changes from Noble&apos;s commit and adding the fix.&lt;/p&gt;

&lt;p&gt;According to the design, every commit must be handled very carefully in TLOG replicas. &lt;br/&gt;
But in IndexFetcher, it actually do a commit directly when &lt;tt&gt;lastestVersion==0&lt;/tt&gt; (when master&apos;s index is empty)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;solrCore.getUpdateHandler().commit(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CommitUpdateCommand(req, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Therefore, the patch carefully handle that commit, and copy over updates in current tlog to the newTlog.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tflobbe&quot; class=&quot;user-hover&quot; rel=&quot;tflobbe&quot;&gt;tflobbe&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt; Can you take a look at the patch?&lt;/p&gt;</comment>
                            <comment id="16151453" author="caomanhdat" created="Sat, 2 Sep 2017 08:59:34 +0000"  >&lt;p&gt;This patch remove &lt;tt&gt;forceReplication&lt;/tt&gt; flag check in IndexFetcher. I will explain the case in detail, here are a code block in IndexFetcher.doFetch(..)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (latestVersion == 0L) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (forceReplication &amp;amp;&amp;amp; commit.getGeneration() != 0) {
          solrCore.getIndexWriter().deleteAll();
          solrCore.getUpdateHandler().commit(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CommitUpdateCommand(req, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;));
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; success;
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So in case of master&apos;s index is empty (lastestVersion == 0) and slave&apos;s index is not empty (commit.getGeneration() != 0), we clear slave&apos;s index. That&apos;s sounds reasonable, except the &lt;tt&gt;forceReplication&lt;/tt&gt; flag there, if forceReplication == false ( which is the default for the first run ), we won&apos;t clear slave&apos;s index. &lt;br/&gt;
Therefore Tlog replica index is not empty meanwhile master index is empty &lt;br/&gt;
==&amp;gt; Inconsistent between Tlog replica and it&apos;s master.&lt;/p&gt;

&lt;p&gt;But I think we can let Solr 7.0 continue without respin, because&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Firstly, for data loss event happen, the master&apos;s index must be emptied and the IndexFetcher failed to fetch the index from master in the first try. This kinda very rare ( I think ).&lt;/li&gt;
	&lt;li&gt;Secondly, for inconsistent event happen ( no data get lost in this case ), the master&apos;s must be emptied and the replica&apos;s index is not empty. Furthermore the inconsistent state will gone when master do the next commit.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think both cases are very rare to happen in production, so we can let Solr 7.0 voting continue if we are not confident with the patch.&lt;/p&gt;</comment>
                            <comment id="16151646" author="shalinmangar" created="Sun, 3 Sep 2017 02:06:33 +0000"  >&lt;p&gt;Thanks Dat. I reviewed the patch and it looks good to me. A few comments:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;You removed a piece of debug logging in PrepRecoveryOp. Can you restore it please?&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;switchTransactionLog&lt;/tt&gt; isn&apos;t a very good name. The tlog is switched on commit always. Perhaps it can be more explicitly called &lt;tt&gt;copyUpdatesFromOldTlog&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;I see that DUH2 supports a commit with IGNORE_INDEXWRITER flag. It is okay as a temporary fix but I don&apos;t like the complexity. Now, certain code paths copy over old updates separately after a commit and one code path does the same thing as part of the commit. I&apos;d like to refactor this at some point later.&lt;/li&gt;
&lt;/ol&gt;


&lt;blockquote&gt;
&lt;p&gt;Secondly, for inconsistent event happen ( no data get lost in this case ), the master&apos;s must be emptied and the replica&apos;s index is not empty. Furthermore the inconsistent state will gone when master do the next commit.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You are quite right but I should point out that RTG becomes inconsistent during this time on 7.0 without these fixes although the data might be recovered in future. But yeah, I agree that we can let Solr 7.0 continue without these fixes.&lt;/p&gt;

&lt;p&gt;Can you please add a more deterministic test for the scenario that you fixed? If we don&apos;t need this fix in 7.0 then we have ample time.&lt;/p&gt;</comment>
                            <comment id="16151654" author="caomanhdat" created="Sun, 3 Sep 2017 03:07:32 +0000"  >&lt;p&gt;Thanks Shalin&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;1. You removed a piece of debug logging in PrepRecoveryOp. Can you restore it please?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;No, we must remove that debug logging, as I said earlier, every commit now must be handled carefully and in that debugging block, we do a commit, that may cause some problem.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;2. switchTransactionLog isn&apos;t a very good name. The tlog is switched on commit always. Perhaps it can be more explicitly called copyUpdatesFromOldTlog.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yeah, sure that sounds a better name.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;3. I see that DUH2 supports a commit with IGNORE_INDEXWRITER flag. It is okay as a temporary fix but I don&apos;t like the complexity. Now, certain code paths copy over old updates separately after a commit and one code path does the same thing as part of the commit. I&apos;d like to refactor this at some point later.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Totally agree with this idea.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Can you please add a more deterministic test for the scenario that you fixed? If we don&apos;t need this fix in 7.0 then we have ample time.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This kinda tricky, but I will think about it ( should we handle this work in another ticket ? )&lt;/p&gt;</comment>
                            <comment id="16151657" author="shalinmangar" created="Sun, 3 Sep 2017 03:15:41 +0000"  >&lt;blockquote&gt;&lt;p&gt;This kinda tricky, but I will think about it ( should we handle this work in another ticket ? )&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="16154040" author="tomasflobbe" created="Tue, 5 Sep 2017 17:41:19 +0000"  >&lt;p&gt;Thanks for looking &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=caomanhdat&quot; class=&quot;user-hover&quot; rel=&quot;caomanhdat&quot;&gt;caomanhdat&lt;/a&gt;. So, if I understand the patch and the comments correctly, this is ONLY a problem in the case of Master version = 0 and slave generation != 0? (and that debug code) So it would mostly affect tests, not not likely any prod installation.&lt;br/&gt;
Do we really need to do that &#8220;commit&#8221; in IndexFetcher in this case, maybe we can, instead of adding this flag just do a specific call to a method that only does the tlog switch?&lt;br/&gt;
I think &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10751&quot; title=&quot;Master/Slave IndexVersion conflict&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10751&quot;&gt;SOLR-10751&lt;/a&gt; describes different symptoms of a similar problem BTW&lt;/p&gt;</comment>
                            <comment id="16156724" author="caomanhdat" created="Thu, 7 Sep 2017 09:05:32 +0000"  >&lt;blockquote&gt;&lt;p&gt;So, if I understand the patch and the comments correctly, this is ONLY a problem in the case of Master version = 0 and slave generation != 0? (and that debug code) So it would mostly affect tests, not not likely any prod installation.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yeah that&apos;s right&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Do we really need to do that &#8220;commit&#8221; in IndexFetcher in this case, maybe we can, instead of adding this flag just do a specific call to a method that only does the tlog switch?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think we need that &quot;commit&quot;, because it will open a new searcher ( on empty index ), just does the tlog switch is not enough.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10751&quot; title=&quot;Master/Slave IndexVersion conflict&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10751&quot;&gt;SOLR-10751&lt;/a&gt; describes different symptoms of a similar problem BTW&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yeah, through a quick glance, It seems related.&lt;/p&gt;</comment>
                            <comment id="16182379" author="caomanhdat" created="Wed, 27 Sep 2017 11:05:25 +0000"  >&lt;p&gt;Updated patch, &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;including test by using metrics to count copyOverUpdates times.&lt;/li&gt;
	&lt;li&gt;Removed the change to DUH2.&lt;/li&gt;
	&lt;li&gt;In case of masterVersion = zero, tlog replica won&apos;t do commit, just open new searcher.&lt;br/&gt;
I will commit this patch soon.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16182766" author="jira-bot" created="Wed, 27 Sep 2017 15:47:40 +0000"  >&lt;p&gt;Commit cc9c867083831cbacfdc76466800522fda05e1f7 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=caomanhdat&quot; class=&quot;user-hover&quot; rel=&quot;caomanhdat&quot;&gt;caomanhdat&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=cc9c867&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=cc9c867&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11293&quot; title=&quot;Possible data loss when index of tlog replica is not empty but latestVersions of master equals 0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11293&quot;&gt;&lt;del&gt;SOLR-11293&lt;/del&gt;&lt;/a&gt;: Fix downgrade in performance from precommit&lt;/p&gt;</comment>
                            <comment id="16183538" author="jira-bot" created="Thu, 28 Sep 2017 01:32:26 +0000"  >&lt;p&gt;Commit ccfe1939a4954aa4c84bb7dada6a6bf37fe2eda3 in lucene-solr&apos;s branch refs/heads/branch_7x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=caomanhdat&quot; class=&quot;user-hover&quot; rel=&quot;caomanhdat&quot;&gt;caomanhdat&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ccfe193&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ccfe193&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11293&quot; title=&quot;Possible data loss when index of tlog replica is not empty but latestVersions of master equals 0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11293&quot;&gt;&lt;del&gt;SOLR-11293&lt;/del&gt;&lt;/a&gt;: Fix downgrade in performance from precommit&lt;/p&gt;</comment>
                            <comment id="16192171" author="tomasflobbe" created="Wed, 4 Oct 2017 22:41:41 +0000"  >&lt;p&gt;There are a number of Jenkin failures with:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;FAILED:  org.apache.solr.cloud.TestTlogReplica.testOutOfOrderDBQWithInPlaceUpdates

Error Message:
Can not find doc 1 in https://127.0.0.1:42663/solr
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;since this was committed, I believe it may be related&lt;/p&gt;</comment>
                            <comment id="16197903" author="hossman" created="Mon, 9 Oct 2017 23:56:21 +0000"  >&lt;p&gt;see also &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11452&quot; title=&quot;TestTlogReplica.testOnlyLeaderIndexes() failure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11452&quot;&gt;&lt;del&gt;SOLR-11452&lt;/del&gt;&lt;/a&gt; and new failures (from new asserts added by this jira) in TestTlogReplica.testOnlyLeaderIndexes()&lt;/p&gt;</comment>
                            <comment id="16197995" author="caomanhdat" created="Tue, 10 Oct 2017 01:22:49 +0000"  >&lt;p&gt;Thank &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman&quot; class=&quot;user-hover&quot; rel=&quot;hossman&quot;&gt;hossman&lt;/a&gt;, I will take a look today.&lt;/p&gt;</comment>
                            <comment id="16284424" author="ctargett" created="Fri, 8 Dec 2017 23:42:23 +0000"  >&lt;p&gt;This was reopened but the original fix is supposed to be in 7.2. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=caomanhdat&quot; class=&quot;user-hover&quot; rel=&quot;caomanhdat&quot;&gt;caomanhdat&lt;/a&gt;, have the issues that caused that action been resolved? If so, can this issue be resolved? If not, what is remaining here? &lt;/p&gt;</comment>
                            <comment id="16284745" author="mkhludnev" created="Sat, 9 Dec 2017 14:01:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://builds.apache.org/job/Lucene-Solr-Tests-7.2/6/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Lucene-Solr-Tests-7.2/6/&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
FAILED:  org.apache.solr.cloud.HttpPartitionTest.test

Error Message:
Doc with id=94 not found in http:&lt;span class=&quot;code-comment&quot;&gt;//127.0.0.1:57348/c8n_1x2 due to: Path not found: /id; rsp={doc=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;}
&lt;/span&gt;
Stack Trace:
java.lang.AssertionError: Doc with id=94 not found in http:&lt;span class=&quot;code-comment&quot;&gt;//127.0.0.1:57348/c8n_1x2 due to: Path not found: /id; rsp={doc=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;}
&lt;/span&gt;        at __randomizedtesting.SeedInfo.seed([9BA46EC30E3F7793:13F05119A0C31A6B]:0)
        at org.junit.Assert.fail(Assert.java:93)
        at org.junit.Assert.assertTrue(Assert.java:43)
        at org.apache.solr.cloud.HttpPartitionTest.assertDocExists(HttpPartitionTest.java:604)
        at org.apache.solr.cloud.HttpPartitionTest.assertDocsExistInAllReplicas(HttpPartitionTest.java:559)
        at org.apache.solr.cloud.HttpPartitionTest.testRf2(HttpPartitionTest.java:380)
        at org.apache.solr.cloud.HttpPartitionTest.test(HttpPartitionTest.java:131)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16284757" author="caomanhdat" created="Sat, 9 Dec 2017 14:31:07 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mkhludnev&quot; class=&quot;user-hover&quot; rel=&quot;mkhludnev&quot;&gt;mkhludnev&lt;/a&gt;, but this seems not related to the bug that gets discussed above ( which cause HttpPartitionTest to fail 50% times ). I will update this issue&apos;s description and name then open another issue for this recent failure.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="13108015">SOLR-11452</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12889272" name="SOLR-11293.patch" size="17863" author="caomanhdat" created="Wed, 27 Sep 2017 11:02:44 +0000"/>
                            <attachment id="12885071" name="SOLR-11293.patch" size="10310" author="caomanhdat" created="Sat, 2 Sep 2017 08:39:09 +0000"/>
                            <attachment id="12885059" name="SOLR-11293.patch" size="9855" author="caomanhdat" created="Sat, 2 Sep 2017 04:25:14 +0000"/>
                            <attachment id="12884418" name="SOLR-11293.patch" size="5191" author="noble.paul" created="Wed, 30 Aug 2017 07:03:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 49 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3jbz3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>