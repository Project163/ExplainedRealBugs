<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:23:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-2673] Some Solr tests depend on order of test methods in source file, but Java 7 seems to no longer ensure that</title>
                <link>https://issues.apache.org/jira/browse/SOLR-2673</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;With Java7 (b147) Solr tests fail, seems to be because of caching (maybe ConcurrentLRUCache violates Java Memory Model, which can be seen in Java 7 only):&lt;/p&gt;

&lt;p&gt;Example TestFiltering (passes sometimes):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;junit-sequential:
    [junit] Testsuite: org.apache.solr.search.TestFiltering
    [junit] Tests run: 2, Failures: 0, Errors: 1, Time elapsed: 6,082 sec
    [junit]
    [junit] ------------- Standard Error -----------------
    [junit] VII 24, 2011 4:53:02 AM org.apache.solr.SolrTestCaseJ4 assertJQ
    [junit] SEVERE: query failed JSON validation. error=mismatch: &apos;3&apos;!=&apos;2&apos; @ response/docs/[0]/val_i
    [junit]  expected =/response/docs==[{&quot;val_i&quot;:3}]
    [junit]  response = {
    [junit]   &quot;responseHeader&quot;:{
    [junit]     &quot;status&quot;:0,
    [junit]     &quot;QTime&quot;:11},
    [junit]   &quot;response&quot;:{&quot;numFound&quot;:5,&quot;start&quot;:2,&quot;docs&quot;:[
    [junit]       {
    [junit]         &quot;val_i&quot;:2}]
    [junit]   }}
    [junit]  request = fl=val_i&amp;amp;sort=val_i+asc&amp;amp;start=2&amp;amp;q={!cache%3Dfalse}*:*&amp;amp;rows=1
    [junit] NOTE: reproduce with: ant test -Dtestcase=TestFiltering -Dtestmethod=testCaching -Dtests.seed=9127548164660185224:-55134
75064094727964
    [junit] NOTE: test params are: codec=RandomCodecProvider: {id=MockFixedIntBlock(blockSize=571), val_i=MockFixedIntBlock(blockSiz
e=571)}, locale=bg, timezone=Pacific/Galapagos
    [junit] NOTE: all tests run in this JVM:
    [junit] [TestFiltering]
    [junit] NOTE: Windows 7 6.1 amd64/Oracle Corporation 1.7.0 (64-bit)/cpus=2,threads=1,free=253309552,total=262799360
    [junit] ------------- ---------------- ---------------
    [junit] Testcase: testCaching(org.apache.solr.search.TestFiltering):        Caused an ERROR
    [junit] mismatch: &apos;3&apos;!=&apos;2&apos; @ response/docs/[0]/val_i
    [junit] java.lang.RuntimeException: mismatch: &apos;3&apos;!=&apos;2&apos; @ response/docs/[0]/val_i
    [junit]     at org.apache.solr.SolrTestCaseJ4.assertJQ(SolrTestCaseJ4.java:467)
    [junit]     at org.apache.solr.SolrTestCaseJ4.assertJQ(SolrTestCaseJ4.java:415)
    [junit]     at org.apache.solr.search.TestFiltering.testCaching(TestFiltering.java:105)
    [junit]     at org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:1486)
    [junit]     at org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:1404)
    [junit]
    [junit]
    [junit] Test org.apache.solr.search.TestFiltering FAILED
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It is definitely not a Hotspot issue, as it also happens with -Xint and -Xbatch.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12515189">SOLR-2673</key>
            <summary>Some Solr tests depend on order of test methods in source file, but Java 7 seems to no longer ensure that</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="uschindler">Uwe Schindler</reporter>
                        <labels>
                            <label>Java7</label>
                    </labels>
                <created>Sun, 24 Jul 2011 12:15:09 +0000</created>
                <updated>Fri, 16 Sep 2011 14:48:50 +0000</updated>
                            <resolved>Sun, 24 Jul 2011 19:15:30 +0000</resolved>
                                                    <fixVersion>3.4</fixVersion>
                    <fixVersion>4.0-ALPHA</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13070156" author="thetaphi" created="Sun, 24 Jul 2011 12:31:37 +0000"  >&lt;p&gt;I tried making all methods of ConcurrentLRUCache synchronized, it did not help. So problem seems to be somewhere else.&lt;/p&gt;</comment>
                            <comment id="13070162" author="yseeley@gmail.com" created="Sun, 24 Jul 2011 13:00:48 +0000"  >&lt;p&gt;Hmmm... notice the &quot;numFound&quot;:5&lt;br/&gt;
There are only 4 documents added in this test.&lt;br/&gt;
If I add a clearIndex() at the top of the test method, everything is fine.&lt;/p&gt;

&lt;p&gt;But why would that be necessary?&lt;br/&gt;
It looks like with Java7, that the test methods are not being run in the order they are declared in the file.&lt;br/&gt;
That&apos;s probably the root cause of the other Solr test failures with Java7 too.&lt;/p&gt;</comment>
                            <comment id="13070164" author="thetaphi" created="Sun, 24 Jul 2011 13:05:27 +0000"  >&lt;p&gt;Aahhhhaaaa.&lt;/p&gt;

&lt;p&gt;We should always clear the index. It seems maybe that reflection and annotations in Java 7 are simply return (for performance reasons) in arbitrary order.&lt;/p&gt;

&lt;p&gt;In general it is bad to have them relying on each other.&lt;/p&gt;</comment>
                            <comment id="13070166" author="dweiss" created="Sun, 24 Jul 2011 13:09:49 +0000"  >&lt;p&gt;Can you confirm this? If this is the case, it&apos;ll be interesting. There is nothing in Java spec saying reflection should return field or methods in their declaration order, but traditionally this was the case. Jeroen Frijters (IKVM) hit a similar problem with other Java programs &amp;#8211; they rely on the order of fields returned by reflection; turned out he actually had to patch IKVM to mimic Java (HotSpot) behavior for these programs.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://weblog.ikvm.net/CommentView.aspx?guid=c1c354e6-2c7d-404a-b2fe-244db9f03250&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://weblog.ikvm.net/CommentView.aspx?guid=c1c354e6-2c7d-404a-b2fe-244db9f03250&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13070169" author="thetaphi" created="Sun, 24 Jul 2011 13:20:05 +0000"  >&lt;p&gt;More info, so its really not defined in which order reflection returns fields:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://stackoverflow.com/questions/1097807/java-reflection-is-the-order-of-class-fields-and-methods-standardized&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://stackoverflow.com/questions/1097807/java-reflection-is-the-order-of-class-fields-and-methods-standardized&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This issue should fix all solr tests to no longer rely on order as declared in tests. So tests should have no side-effects. If they have side-effects, we should make a hyper-method that calls the previous test* methods in order. I did this for EchoParams and now it works.&lt;/p&gt;</comment>
                            <comment id="13070171" author="rcmuir" created="Sun, 24 Jul 2011 13:26:23 +0000"  >&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Index: lucene/src/test-framework/org/apache/lucene/util/LuceneTestCase.java
===================================================================
--- lucene/src/test-framework/org/apache/lucene/util/LuceneTestCase.java	(revision 1150089)
+++ lucene/src/test-framework/org/apache/lucene/util/LuceneTestCase.java	(working copy)
@@ -1457,6 +1457,7 @@
           } catch (Exception e) { throw new RuntimeException(e); }
         }
       }
+      Collections.shuffle(testMethods); // doesn&apos;t use seed (its not initialized yet!) but i think this is ok...
       return testMethods;
     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13070172" author="thetaphi" created="Sun, 24 Jul 2011 13:27:01 +0000"  >&lt;p&gt;Simple fix for TestFiltering.&lt;/p&gt;</comment>
                            <comment id="13070173" author="cmale" created="Sun, 24 Jul 2011 13:30:07 +0000"  >&lt;p&gt;Was just going to suggest the same thing Robert!&lt;/p&gt;</comment>
                            <comment id="13070174" author="rcmuir" created="Sun, 24 Jul 2011 13:32:50 +0000"  >&lt;p&gt;hehe i want all tests to be reproducible though, maybe we pass shuffle a random init&apos;ed by the current day of the month or something &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;we don&apos;t have to commit it either, or we can make it a -D or something that is not set by default, just so we can fix tests.&lt;/p&gt;</comment>
                            <comment id="13070177" author="cmale" created="Sun, 24 Jul 2011 13:38:09 +0000"  >&lt;p&gt;If the Collection is ordered differently each time before the shuffle (which it might be since the method order is no longer defined), would it ever be reproducible even with a known random?&lt;/p&gt;</comment>
                            <comment id="13070178" author="rcmuir" created="Sun, 24 Jul 2011 13:40:00 +0000"  >&lt;p&gt;The problem i am concerned about would be e.g. a test that makes a reader in @beforeclass (many tests build the index in beforeclass and share resources across tests).&lt;/p&gt;

&lt;p&gt;In this case, perhaps there is some reuse bug (e.g. imagine a bug in terms dictionary cache or something) and it would not be reproducible if we shuffled differently...&lt;/p&gt;</comment>
                            <comment id="13070179" author="rcmuir" created="Sun, 24 Jul 2011 13:42:14 +0000"  >&lt;p&gt;By the way, if you add this shuffle, all these problems become visible on java6.&lt;/p&gt;

&lt;p&gt;Also TestReplicationHandler is broken in the same way.&lt;/p&gt;</comment>
                            <comment id="13070180" author="cmale" created="Sun, 24 Jul 2011 13:44:01 +0000"  >&lt;p&gt;Absolutely.  My point is, can we even avoid that since the initial Collection is itself randomly sorted now since the methods come back in an undefined order?&lt;/p&gt;</comment>
                            <comment id="13070181" author="rcmuir" created="Sun, 24 Jul 2011 13:46:19 +0000"  >&lt;p&gt;I doubt its truly random... it may be undefined but for a given jre its probably typically the same each time.&lt;/p&gt;

&lt;p&gt;I will investigate. We might be able to init LuceneTestCase&apos;s random in computeTestMethods instead of in beforeClass(), this would &lt;br/&gt;
give us a reproducible shuffle, which is the ideal situation.&lt;/p&gt;</comment>
                            <comment id="13070183" author="cmale" created="Sun, 24 Jul 2011 13:47:54 +0000"  >&lt;p&gt;We could also sort it to a known order (alphabetically) and then shuffle.&lt;/p&gt;</comment>
                            <comment id="13070185" author="thetaphi" created="Sun, 24 Jul 2011 13:48:43 +0000"  >&lt;p&gt;First bunch fixed (TestFiltering and TestEchoParams):&lt;/p&gt;

&lt;p&gt;Committed trunk revision: 1150362&lt;br/&gt;
Committed 3.x revision: 1150367&lt;/p&gt;</comment>
                            <comment id="13070186" author="thetaphi" created="Sun, 24 Jul 2011 13:50:35 +0000"  >&lt;blockquote&gt;&lt;p&gt;We could also sort it to a known order (alphabetically) and then shuffle.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We must do this in all cases, because else the same random would not help, if Java 7 already shuffled them.&lt;/p&gt;</comment>
                            <comment id="13070187" author="cmale" created="Sun, 24 Jul 2011 13:52:17 +0000"  >&lt;p&gt;Yup.&lt;/p&gt;</comment>
                            <comment id="13070188" author="thetaphi" created="Sun, 24 Jul 2011 13:53:35 +0000"  >&lt;blockquote&gt;&lt;p&gt;I doubt its truly random... it may be undefined but for a given jre its probably typically the same each time.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Its somehow random in Java 7. If I run the same test multiple times, sometimes it fails sometimes it succeeds. Very strange, but it seems to be related to class loading and hotspot (maybe it uses some internal hotspot caches to speedup reflective access).&lt;/p&gt;</comment>
                            <comment id="13070190" author="rcmuir" created="Sun, 24 Jul 2011 14:01:55 +0000"  >&lt;p&gt;attached is a patch that inits LTC&apos;s random inside computeTestMethods instead, and uses this to shuffle the test methods (so the shuffle is reproducible according to random seed)&lt;/p&gt;</comment>
                            <comment id="13070192" author="rcmuir" created="Sun, 24 Jul 2011 14:03:05 +0000"  >&lt;blockquote&gt;
&lt;p&gt;We must do this in all cases, because else the same random would not help, if Java 7 already shuffled them.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You and chris are definitely right, in order to be consistent across different JREs, we must sort the methods first before shuffling.&lt;/p&gt;

&lt;p&gt;I&apos;ll update the patch.&lt;/p&gt;</comment>
                            <comment id="13070193" author="rcmuir" created="Sun, 24 Jul 2011 14:07:20 +0000"  >&lt;p&gt;updated patch, with the sort-by-name before shuffle.&lt;/p&gt;</comment>
                            <comment id="13070194" author="cmale" created="Sun, 24 Jul 2011 14:09:10 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13070221" author="rcmuir" created="Sun, 24 Jul 2011 17:51:37 +0000"  >&lt;p&gt;I think we can resolve this issue now.&lt;/p&gt;</comment>
                            <comment id="13070222" author="thetaphi" created="Sun, 24 Jul 2011 17:53:58 +0000"  >&lt;p&gt;We should add a changes entry.&lt;/p&gt;</comment>
                            <comment id="13070232" author="rcmuir" created="Sun, 24 Jul 2011 19:15:23 +0000"  >&lt;p&gt;i don&apos;t think thats very important, its just our internal tests, and everyone here is a committer.&lt;/p&gt;</comment>
                            <comment id="13106197" author="rcmuir" created="Fri, 16 Sep 2011 14:48:50 +0000"  >&lt;p&gt;bulk close for 3.4&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                            <outwardlinks description="incorporates">
                                        <issuelink>
            <issuekey id="12515188">SOLR-2672</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12487640" name="SOLR-2673.patch" size="523" author="uschindler" created="Sun, 24 Jul 2011 13:27:01 +0000"/>
                            <attachment id="12487642" name="SOLR-2673_randomize_methods.patch" size="2399" author="rcmuir" created="Sun, 24 Jul 2011 14:07:20 +0000"/>
                            <attachment id="12487641" name="SOLR-2673_randomize_methods.patch" size="1969" author="rcmuir" created="Sun, 24 Jul 2011 14:01:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4878</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 10 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i03jcf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>18567</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>