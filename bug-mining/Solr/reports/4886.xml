<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:51:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-10059] In SolrCloud, every fq added via &lt;lst name=&quot;appends&quot;&gt; is computed twice.</title>
                <link>https://issues.apache.org/jira/browse/SOLR-10059</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;While researching another issue, I noticed that parameters appended to a query via SearchHandler&apos;s &amp;lt;lst name=&quot;appends&quot;&amp;gt; are added to the query twice in SolrCloud: once on the aggregator and again on the shard.&lt;/p&gt;

&lt;p&gt;The FacetComponent corrects this automatically by removing duplicates. Field queries added in this fashion are however computed twice and that hinders performance on filter queries that aren&apos;t simple bitsets such as those produced by the CollapsingQueryParser.&lt;/p&gt;

&lt;p&gt;To reproduce the issue, simply test this handler on a large enough collection, then replace &quot;appends&quot; with &quot;defaults&quot;. You&apos;ll notice significant performance improvements.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;requestHandler name=&lt;span class=&quot;code-quote&quot;&gt;&quot;/myHandler&quot;&lt;/span&gt; class=&lt;span class=&quot;code-quote&quot;&gt;&quot;solr.SearchHandler&quot;&lt;/span&gt;&amp;gt;
    &amp;lt;lst name=&lt;span class=&quot;code-quote&quot;&gt;&quot;appends&quot;&lt;/span&gt;&amp;gt;
        &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;fq&quot;&lt;/span&gt;&amp;gt;{!collapse field=routingKey hint=top_fc}&amp;lt;/str&amp;gt;
    &amp;lt;/lst&amp;gt;
&amp;lt;/requestHandler&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13039094">SOLR-10059</key>
            <summary>In SolrCloud, every fq added via &lt;lst name=&quot;appends&quot;&gt; is computed twice.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="epugh">Eric Pugh</assignee>
                                    <reporter username="marc.morissette">Marc Morissette</reporter>
                        <labels>
                            <label>performance</label>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 31 Jan 2017 04:30:49 +0000</created>
                <updated>Tue, 19 Nov 2024 00:00:42 +0000</updated>
                                            <version>6.4</version>
                                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>7</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="26400">7h 20m</timespent>
                                <comments>
                            <comment id="15846394" author="marc.morissette" created="Tue, 31 Jan 2017 04:56:49 +0000"  >&lt;p&gt;I am willing to work on a patch but I&apos;d like some guidance. I see two ways to solve this:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Eliminate duplicate filter queries. Other parameters might however suffer from the same duplication issue so it seems like too narrow a solution.&lt;/li&gt;
	&lt;li&gt;Disable RequestHandler &quot;appends&quot; when ShardParams.IS_SHARD is true. This seems like the better solution since the appended parameters should already have been added to the query by the aggregating node. I don&apos;t know if there are some corner cases that I haven&apos;t considered though.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I&apos;d appreciate some feedback.&lt;/p&gt;</comment>
                            <comment id="15890736" author="hossman" created="Wed, 1 Mar 2017 18:17:46 +0000"  >&lt;p&gt;SOme historical context here is that when &quot;distributed search&quot; was first added, before there was any native &quot;cloud support&quot; the want to trigger a distributed search was to specify a list of shard URLs (as a request param) for the coordinator node to query &amp;amp; aggregate the responses from.  A common configuration pattern was for people to put the shards (URLS) in their handler defaults in solrconfig.xml &amp;#8211; but also have a &quot;shards.qt&quot; param that pointed at a different handler name. (to some other handler registration w/o the shards list) ... alternatively, some people deployed one solrconfig.xml file to the nodes that had data one them (and included things like defaults/appends fqs), and had completely diff solrconfig.xml for their coordinator nodes that only know about the shards param and the list of nodes to aggregate from.&lt;/p&gt;

&lt;p&gt;you&apos;re definitely correct &amp;#8211; as things evolved into solr cloud, the fact that things like appends fqs are being computed multiple times because they come from both the coordinator node&apos;s init params and the individual shard&apos;s (identical) init params.&lt;/p&gt;

&lt;p&gt;I think the the general approach #2 you suggested makes the most sense ... the bit of code (in RequestHandlerBase i believe?) where the defaults/invariants/appends are wrapped around/under the request params should be skipped in (some) solr cloud shard requests &amp;#8211; but i think checking IS_SHARD is really only 1 piece of the puzzle? for completeness we should probably also check that the SolrCore says we are in solrcloud mode (to ensure the user isn&apos;t rolling their own distributed search via pre-solrcloud shard requests like i described above)&lt;/p&gt;

&lt;p&gt;the only other thing to worry about i guess is what should happen when multi-collection requests are issued? &amp;#8211; such as when a collection alias points to multiple collections.  Shouldn&apos;t the &quot;appends&quot; FQ params from collection1 be applied anytime a query includes collection1, and the appends FQ params from collection1 be applied any time a query includes collection2; even if those are both a single query that originated via a request to &quot;both_collections&quot; (which is an alias for &quot;collection1,collection2&quot;) ?&lt;/p&gt;

&lt;p&gt;I suppose the coordinating node could include the &quot;source collection (alias)&quot; of the request as a param that the individual shards could compare with themselves to decide when they need to wrap the params?&lt;/p&gt;

&lt;p&gt;(just thinking outloud &amp;#8211; probably a better solution)&lt;/p&gt;



</comment>
                            <comment id="15900371" author="marc.morissette" created="Tue, 7 Mar 2017 23:20:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman&quot; class=&quot;user-hover&quot; rel=&quot;hossman&quot;&gt;hossman&lt;/a&gt; It might be that existing parameters are not descriptive enough to handle every use case. We could add a new parameter to CommonParams: &quot;handler.chain&quot; or &quot;distrib.call.stack&quot; or something similar. It would be a comma delimited list of all the handlers that were involved in a distributed operation and that have forwarded their parameters to the current RequestHandler. A handler would be identified by Collection or Core Name followed by /RequestHandler. e.g. distrib.call.stack=MyCollection/MyHandler,MyCollection2/MyHandler2,... RequestHandlerBase could use this parameter to determine whether defaults, appends and initParams were already applied by the same handler up the chain.&lt;/p&gt;

&lt;p&gt;It would not handle the case of appends in initParams that apply to different handlers in the same call chain but I would assume this rarely occurs in practice.&lt;/p&gt;

&lt;p&gt;I&apos;d rather not add more parameters to Solr given how messy the current parameter namespace already is but I don&apos;t see a better solution. What do you think? &lt;/p&gt;</comment>
                            <comment id="17139917" author="tboeghk" created="Thu, 18 Jun 2020 18:52:40 +0000"  >&lt;p&gt;I attached a patch for this issue, which still exists in 7.x and 8.x.&#160;&lt;/p&gt;

&lt;p&gt;In a distributes request, pre-configured query params in the &quot;appends&quot;-section get re-appended on the shards. If those parameters furthermore reference other parameters (like $qq), these do not get dereferenced. In our case, this broke the collapse component.&lt;/p&gt;

&lt;p&gt;The patch skips re-appending on the shards (&lt;em&gt;isShard=true&lt;/em&gt;) if the parameter &lt;em&gt;shards.handler.skipAppends=true&lt;/em&gt;. The latter defaults to &lt;em&gt;false&lt;/em&gt;.&lt;/p&gt;</comment>
                            <comment id="17213880" author="cpoerschke" created="Wed, 14 Oct 2020 12:40:54 +0000"  >&lt;p&gt;Just adding a note here to cross-reference &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10059&quot; title=&quot;In SolrCloud, every fq added via &amp;lt;lst name=&amp;quot;appends&amp;quot;&amp;gt; is computed twice.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10059&quot;&gt;SOLR-10059&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14931&quot; title=&quot;Macros in appends/invariants parameters not getting expanded in Solrcloud&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14931&quot;&gt;SOLR-14931&lt;/a&gt; as potentially having things in common; haven&apos;t looked too closely though, only going by &lt;em&gt;&quot;SolrCloud&quot; and &quot;appends&quot; and &quot;twice&quot;&lt;/em&gt; mentionings.&lt;/p&gt;</comment>
                            <comment id="17213937" author="jbaiter" created="Wed, 14 Oct 2020 14:00:20 +0000"  >&lt;p&gt;I believe &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14931&quot; title=&quot;Macros in appends/invariants parameters not getting expanded in Solrcloud&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14931&quot;&gt;SOLR-14931&lt;/a&gt; describes exactly the same issue in the above comment by  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tboeghk&quot; class=&quot;user-hover&quot; rel=&quot;tboeghk&quot;&gt;tboeghk&lt;/a&gt;, thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cpoerschke&quot; class=&quot;user-hover&quot; rel=&quot;cpoerschke&quot;&gt;cpoerschke&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="17221474" author="cpoerschke" created="Tue, 27 Oct 2020 14:31:31 +0000"  >&lt;blockquote&gt;&lt;p&gt;... The FacetComponent corrects this automatically by removing duplicates. ...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Thanks for sharing that detail! &lt;a href=&quot;https://github.com/apache/lucene-solr/blob/releases/lucene-solr/8.6.3/solr/core/src/java/org/apache/solr/handler/component/FacetComponent.java#L86-L101&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/blob/releases/lucene-solr/8.6.3/solr/core/src/java/org/apache/solr/handler/component/FacetComponent.java#L86-L101&lt;/a&gt; looks to be the area of code where duplicate facet parameters are removed.&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;I don&apos;t know how far or close we are here w.r.t. changing the existing behaviour for every handler that inherits from &lt;tt&gt;RequestHandlerBase&lt;/tt&gt; but complementary to any changes, if a protected (say) &lt;tt&gt;RequestHandlerBase.prepareRequestParams&lt;/tt&gt; method was factored out then that would slightly shorten the &lt;tt&gt;handleRequest&lt;/tt&gt; method &#8211; &lt;a href=&quot;https://github.com/apache/lucene-solr/blob/releases/lucene-solr/8.6.3/solr/core/src/java/org/apache/solr/handler/RequestHandlerBase.java#L189-L276&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/blob/releases/lucene-solr/8.6.3/solr/core/src/java/org/apache/solr/handler/RequestHandlerBase.java#L189-L276&lt;/a&gt; &#8211; and custom handlers could override this method e.g. to de-duplicate parameters.&lt;/p&gt;

&lt;p&gt;How would having a custom handler differ from locally patching the &lt;tt&gt;RequestHandlerBase&lt;/tt&gt; code itself?&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Any &lt;tt&gt;RequestHandlerBase&lt;/tt&gt; change automatically applies to all handlers that inherit from it, no configuration changes would be needed but a locally built Solr needs to be deployed.&lt;/li&gt;
	&lt;li&gt;A custom handler means that changes only apply to the handler being customised but a configuration change would be needed to use the custom handler. Build wise the custom handler could be built separately and deployed as a plugin i.e. no need to locally build Solr itself.&lt;/li&gt;
&lt;/ul&gt;


&lt;hr /&gt;
&lt;p&gt;Another approach perhaps might be to have custom search component &#8211; a bit like &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=janhoy&quot; class=&quot;user-hover&quot; rel=&quot;janhoy&quot;&gt;janhoy&lt;/a&gt;&apos;s &lt;a href=&quot;https://github.com/cominvent/request-sanitizer-component&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;RequestSanitizerComponent&lt;/a&gt; &#8211; which dedupes parameters before any other component gets to see the request and its parameters?&lt;/p&gt;</comment>
                            <comment id="17355779" author="tboeghk" created="Wed, 2 Jun 2021 14:39:29 +0000"  >&lt;p&gt;I added another Github Pull Request to the new Solr repo:&#160;&lt;a href=&quot;https://github.com/apache/solr/pull/159&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/solr/pull/159&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17581892" author="jira-bot" created="Fri, 19 Aug 2022 14:47:52 +0000"  >&lt;p&gt;Commit 03946ee1f585017bd2c3c0c79edd645ef962f8bd in solr&apos;s branch refs/heads/main from Christine Poerschke&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=03946ee1f58&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=03946ee1f58&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10059&quot; title=&quot;In SolrCloud, every fq added via &amp;lt;lst name=&amp;quot;appends&amp;quot;&amp;gt; is computed twice.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10059&quot;&gt;SOLR-10059&lt;/a&gt;: add SearchHandlerAppendsCloudTest (#426)&lt;/p&gt;
</comment>
                            <comment id="17581897" author="jira-bot" created="Fri, 19 Aug 2022 14:55:05 +0000"  >&lt;p&gt;Commit 1aa900b08a45bc90b0942329fbce79adbb0ee453 in solr&apos;s branch refs/heads/branch_9x from Christine Poerschke&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=1aa900b08a4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=1aa900b08a4&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10059&quot; title=&quot;In SolrCloud, every fq added via &amp;lt;lst name=&amp;quot;appends&amp;quot;&amp;gt; is computed twice.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10059&quot;&gt;SOLR-10059&lt;/a&gt;: add SearchHandlerAppendsCloudTest (#426)&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 03946ee1f585017bd2c3c0c79edd645ef962f8bd)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13335374">SOLR-14931</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13014203" name="SOLR-10059-RequestHandlerBase-prepareRequestParams.patch" size="2137" author="cpoerschke" created="Tue, 27 Oct 2020 14:29:13 +0000"/>
                            <attachment id="13005992" name="SOLR-10059_7x.patch" size="1173" author="tboeghk" created="Thu, 18 Jun 2020 19:49:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 12 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i39ei7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>