<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:27:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-3424] PhoneticFilterFactory threadsafety bug</title>
                <link>https://issues.apache.org/jira/browse/SOLR-3424</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;PhoneticFilterFactory has a static HashMap registry mapping an encoder name to an implementation. There is a ReentrantLock used when the map is modified (when the encoder config specifies a class name).  However, this map, which can be accessed by multiple indexing threads, isn&apos;t guarded on any of the reads, which isn&apos;t just the common path but also the error messages which dump the registry into the error message.&lt;/p&gt;

&lt;p&gt;I realize the likelihood of a problem is extremely slim, but a bug&apos;s a bug.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12553307">SOLR-3424</key>
            <summary>PhoneticFilterFactory threadsafety bug</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dsmiley">David Smiley</assignee>
                                    <reporter username="dsmiley">David Smiley</reporter>
                        <labels>
                    </labels>
                <created>Mon, 30 Apr 2012 06:25:46 +0000</created>
                <updated>Sun, 6 May 2012 02:26:20 +0000</updated>
                            <resolved>Sun, 6 May 2012 02:26:20 +0000</resolved>
                                    <version>3.6</version>
                    <version>4.0-ALPHA</version>
                                    <fixVersion>4.0-ALPHA</fixVersion>
                                    <component>Schema and Analysis</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13264686" author="dsmiley" created="Mon, 30 Apr 2012 06:30:59 +0000"  >&lt;p&gt;The attached patch fixes the problem by basically &quot;upgrading&quot; the code to use Guava&apos;s MapMaker which is excellent for caches. I keep 2 distinct registries, the constant builtin one, and the custom class one, because there is a distinction between the two which is the capitalization of the keys.  I couldn&apos;t have just one MapMaker map because the key lookup of the computed value should be the original class name uncapitalized.&lt;/p&gt;</comment>
                            <comment id="13264688" author="dsmiley" created="Mon, 30 Apr 2012 06:32:28 +0000"  >&lt;p&gt;And I also noticed that Commons-Codec&apos;s Caverphone.class was deprecated for Caverphone2.class so I made that simple change.  The docs say the deprecated one simply forwards calls, so there should be no side-effects of this change.&lt;/p&gt;</comment>
                            <comment id="13264720" author="rcmuir" created="Mon, 30 Apr 2012 08:15:36 +0000"  >&lt;p&gt;where is the test for the bug?&lt;/p&gt;

&lt;p&gt;why does this factory have a cache at all?! &lt;/p&gt;</comment>
                            <comment id="13264730" author="thetaphi" created="Mon, 30 Apr 2012 08:33:53 +0000"  >&lt;p&gt;The whole design of this cache is wrong:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;it should not be static, the resolved class lookups should only be cached per instance&lt;/li&gt;
	&lt;li&gt;the cache only caches &quot;resolves&quot; not instantiations of encoders, the JVM caches Class.forName() lookups, so why cache it again?&lt;/li&gt;
	&lt;li&gt;To fix the orginal issue, a ConcurrentHashMap would also be fine&lt;/li&gt;
	&lt;li&gt;Solr/Lucene use Analyzers which are now enforced to reuse tokenstreams, so the lookup is only done once when IndexWriter starts and a new indexing thread is created&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The last point tells me: &quot;remove this cache&quot;&lt;/p&gt;</comment>
                            <comment id="13264741" author="thetaphi" created="Mon, 30 Apr 2012 08:59:51 +0000"  >&lt;p&gt;One thing to add:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;the cache only caches &quot;resolves&quot; not instantiations of encoders, the JVM caches Class.forName() lookups, so why cache it again?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You may argue, that the lookup may be more expensive, as it uses a try..catch block (first try in expected commons package, later try a full class name). I think the chain of Try...Catch with ClassNoFound should be changed to do it more smart: If the name of encoder contains a period (indexOf(&apos;.&apos;)&amp;gt;=0), look it up as class name, otherwise prefix it with the commons package name. This way, the JVM cache for loaded classes can be used and the cache is completely useless.&lt;/p&gt;


&lt;p&gt;I like in your fix, that it also changed the broken uppercasing: It should only do that for the builtins, class names itsself are case sensitive.&lt;/p&gt;

&lt;p&gt;+1 to remove the cache and only keep the static builtins (and please: as Collections.unmodifiableMap!!!), lookup non-builtins without try...catch(ClassNotFound). The error message should only list the builtins and mention that otherwise the name should be a full class name.&lt;/p&gt;</comment>
                            <comment id="13264976" author="dsmiley" created="Mon, 30 Apr 2012 15:30:53 +0000"  >&lt;p&gt;Rob: This is a (minor) thread-safety bug and consequently it&apos;s not really feasible to test it without a lot of work and without a guarantee at the end that there is no problem, and so it isn&apos;t worth it.  Of course if you want to; go for it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Uwe: Thanks very much for your comments.  I wasn&apos;t sure what the lifecycle of this class was or if/how it is shared; I looked at the javadocs of TokenFilterFactory just now and I think its clearer.  Given that the Factory&apos;s init() method is not going to be called frequently, it seems to me that the class name based lookups need not cache at all.  And I also like your suggestion of improving the fallback lookup by looking for a &apos;.&apos;.  BTW I considered wrapping with unmodifiableMap but didn&apos;t bother because it&apos;s not exposed outside of this class, which is fairly small too, but I will since it seems to be a big deal to you (three exclamation points).  I&apos;ll propose another patch later&lt;/p&gt;

&lt;p&gt;~ David&lt;/p&gt;</comment>
                            <comment id="13264986" author="thetaphi" created="Mon, 30 Apr 2012 15:39:03 +0000"  >&lt;p&gt;Thanks! Thaks for taking care, as I have no time to provide a patch at the moment &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;but I will since it seems to be a big deal to you (three exclamation points)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; It&apos;s not so important, if it&apos;s private to the class! I just don&apos;t want public code to expose Collections not intended to be modified in a modifiable way, so i am fine with or without unmodifiable. There are also places in Lucene violating this (or use public arrays, which cannot be protected - like CompositeReader.getSequentialSubReaders()).&lt;/p&gt;</comment>
                            <comment id="13265638" author="dsmiley" created="Tue, 1 May 2012 04:20:02 +0000"  >&lt;p&gt;Here is an updated patch. I enhanced the javadocs too, which have become out of date.&lt;/p&gt;</comment>
                            <comment id="13265696" author="thetaphi" created="Tue, 1 May 2012 07:28:43 +0000"  >&lt;p&gt;Hi David,&lt;/p&gt;

&lt;p&gt;looks good, but there is a bug:&lt;br/&gt;
The refactoring of the REGISTRY static map was an anonymous inner class before (new HashMap() {{ hashmap ctor code }}; (please note double parens). Now it is assigned to a static field, but the initializer code is an inline ctor of the factory, means the initialization runs on every instantiation.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;add &lt;b&gt;static&lt;/b&gt; before the anonymous ctor:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;? &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Encoder&amp;gt;&amp;gt; registry = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;? &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Encoder&amp;gt;&amp;gt;(6);
&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; {
 registry.put(...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;or leave the initializer as it was before (anonymous HashMap subclass with overridden ctor).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;in resolve encoder maybe remove the clazz variable and directly return the result of forName(). I do&apos;t like non-final variables initialized with null because that prevents compilation failures on missing initialization and null could be returned - especially with lots of try-catch blocks.&lt;/p&gt;</comment>
                            <comment id="13265698" author="thetaphi" created="Tue, 1 May 2012 07:44:11 +0000"  >&lt;p&gt;Attached is a patch that fixes the initialization bug and improves the reflection code.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;One thing that came into my mind when I looked at the code of PhoneticFilter:&lt;/b&gt; I did not find out if Encoders are threadsafe or not. If they aren&apos;t or we are not sure (the documentation states nothing), we should create the Encoder class instance in the TokenStream create() method. TokenStreams itsself are only used per thread (iterator pattern), and the Analyzer reuse ensures that we have a separate instance for each thread.&lt;/p&gt;</comment>
                            <comment id="13265703" author="thetaphi" created="Tue, 1 May 2012 08:02:19 +0000"  >&lt;p&gt;Updated patch, I added a testcase for the reflection without package name:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I use &quot;Caverphone2&quot; as package less name, which is not in the REGISTRY. The returned class should be Caverphone2&lt;/li&gt;
	&lt;li&gt;I cross-check with the REGISTRY name &quot;Caverphone&quot;, which should also return the new Caverphone2 encoder, but without reflection&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13265862" author="dsmiley" created="Tue, 1 May 2012 15:28:43 +0000"  >&lt;p&gt;Uwe: Excellent catch RE my &quot;static&quot; bug, and I agree on your improvement RE clazz &amp;amp; null.&lt;/p&gt;

&lt;p&gt;I tried to ascertain the thread-safety status of Commons-Codec and unfortunately I don&apos;t think we can assume it&apos;s thread-safe.  I sent an email to their list about this just now: &lt;a href=&quot;http://apache-commons.680414.n4.nabble.com/Thread-safety-of-Commons-Codec-Encoder-tt4600956.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://apache-commons.680414.n4.nabble.com/Thread-safety-of-Commons-Codec-Encoder-tt4600956.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;So I agree that we&apos;ll have to insatiate one of these in our create() method instead of caching it.&lt;/p&gt;</comment>
                            <comment id="13266333" author="dsmiley" created="Wed, 2 May 2012 04:26:14 +0000"  >&lt;p&gt;My new patch creates &amp;amp; initializes the encoder per call to create(). The testSpeed() tests seem about the same. I also added a test for the maxCodeLen arg, and i documented it too.&lt;/p&gt;</comment>
                            <comment id="13266617" author="dsmiley" created="Wed, 2 May 2012 15:02:11 +0000"  >&lt;p&gt;I&apos;ll commit it in ~24 hours.&lt;/p&gt;</comment>
                            <comment id="13267229" author="thetaphi" created="Thu, 3 May 2012 06:05:07 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;I wanted to review the stock Lucene Analyzer about thread safety, too.&lt;/p&gt;</comment>
                            <comment id="13267233" author="thetaphi" created="Thu, 3 May 2012 06:08:14 +0000"  >&lt;p&gt;There seems to be no Analyzer in Lucene that uses this class. The phonetic package only contains the plain TokenFilters and those are single-thread only.&lt;/p&gt;</comment>
                            <comment id="13267246" author="thetaphi" created="Thu, 3 May 2012 06:35:39 +0000"  >&lt;p&gt;Hi, I looked again at the code and found the following improvement, attached as new patch:&lt;/p&gt;

&lt;p&gt;The reflection based-method lookup should be done in the initialization. The pointer to the method is then saved in a instance field, so the getEncoder() method only needs to invoke. This removes more than half of the reflection cost.&lt;br/&gt;
The pointer to the method is null, if no maxLength is set.&lt;br/&gt;
I also did some minor cleanups in Exception handling.&lt;/p&gt;</comment>
                            <comment id="13267264" author="dsmiley" created="Thu, 3 May 2012 07:05:26 +0000"  >&lt;p&gt;So it appears the Commons-Codec Encoders are all thread-safe after all:&lt;br/&gt;
&lt;a href=&quot;http://apache-commons.680414.n4.nabble.com/Thread-safety-of-Commons-Codec-Encoder-tt4600956.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://apache-commons.680414.n4.nabble.com/Thread-safety-of-Commons-Codec-Encoder-tt4600956.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13267272" author="thetaphi" created="Thu, 3 May 2012 07:26:10 +0000"  >&lt;p&gt;Hi David,&lt;br/&gt;
I don&apos;t really trust that thread so I would really go with the current solution. In Lucene 4.0, reuse of TokenStreams is &lt;b&gt;enforced&lt;/b&gt; so there is no cost at all by the reflection and the createInstance. I also improved the reflective method call (which has the side effect of being able to print a useful message when the encoder does not support setMaxLen, the old code throwed unspecified and unhelpful Exception).&lt;/p&gt;

&lt;p&gt;In general, the commons encoders might be thread safe, but we use reflection and use any class the user provides and other classes implementing the abstract Encoder interface may not be thread safe (unless this is explicitely specified in their spec / javadocs - which isn&apos;t)&lt;/p&gt;

&lt;p&gt;As it costs us nothing (Class.newInstance() is cheap and only called once a new thread is used and the SolrAnalyzer class has to create new TokenStreamComponents), we should stay with the current code. The thread-safety is then ensured by the Analyzer class (it uses thread-locals to reuse TokenStreams).&lt;/p&gt;

&lt;p&gt;What do you think about my latest patch?&lt;/p&gt;</comment>
                            <comment id="13268053" author="dsmiley" created="Fri, 4 May 2012 02:46:26 +0000"  >&lt;p&gt;Looks good Uwe.&lt;br/&gt;
One minor nit is that the URL in the class Javadoc to Commons-Codec&apos;s Language package should be this URL:&lt;br/&gt;
&lt;a href=&quot;http://commons.apache.org/codec/apidocs/org/apache/commons/codec/language/package-summary.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://commons.apache.org/codec/apidocs/org/apache/commons/codec/language/package-summary.html&lt;/a&gt;   which is the one to 1.6; the existing link is older with fewer classes.  We&apos;ve got this link in both the FilterFactory &amp;amp; Filter.&lt;/p&gt;

&lt;p&gt;Feel free to commit if you want or just leave it to me.&lt;/p&gt;</comment>
                            <comment id="13269064" author="thetaphi" created="Sat, 5 May 2012 21:29:00 +0000"  >&lt;p&gt;Hi David,&lt;br/&gt;
just commit it, I am about to leave for business trips (including Lucene Rev) so have not much time.&lt;br/&gt;
Uwe&lt;/p&gt;</comment>
                            <comment id="13269106" author="dsmiley" created="Sun, 6 May 2012 02:26:20 +0000"  >&lt;p&gt;Committed to trunk in 1334544.&lt;/p&gt;

&lt;p&gt;I left the commons-coded javadoc url as-is since it was finally updated to the latest version.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12525405" name="SOLR-3424_PhoneticFilterFactory_threadsafety_bug.patch" size="11040" author="uschindler" created="Thu, 3 May 2012 06:35:38 +0000"/>
                            <attachment id="12525255" name="SOLR-3424_PhoneticFilterFactory_threadsafety_bug.patch" size="10766" author="dsmiley" created="Wed, 2 May 2012 04:26:13 +0000"/>
                            <attachment id="12525161" name="SOLR-3424_PhoneticFilterFactory_threadsafety_bug.patch" size="7633" author="uschindler" created="Tue, 1 May 2012 08:02:18 +0000"/>
                            <attachment id="12525159" name="SOLR-3424_PhoneticFilterFactory_threadsafety_bug.patch" size="6249" author="uschindler" created="Tue, 1 May 2012 07:44:09 +0000"/>
                            <attachment id="12525153" name="SOLR-3424_PhoneticFilterFactory_threadsafety_bug.patch" size="6248" author="dsmiley" created="Tue, 1 May 2012 04:20:01 +0000"/>
                            <attachment id="12525041" name="SOLR-3424_PhoneticFilterFactory_threadsafety_bug.patch" size="6133" author="dsmiley" created="Mon, 30 Apr 2012 06:30:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>237442</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 29 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i03erj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>17825</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>