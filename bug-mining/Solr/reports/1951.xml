<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:52:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-6160] Exception possible with group.facet, range faceting, with distributed search</title>
                <link>https://issues.apache.org/jira/browse/SOLR-6160</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;I&apos;m seeing a hard to reproduce bug when the following conditions are true:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Distributed search&lt;/li&gt;
	&lt;li&gt;group=true with group.field=xxx and group.facet=true&lt;/li&gt;
	&lt;li&gt;facet=true with facet.field and facet.range&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;On a sharded request (isShard=true, distrib=false) that has requestPurpose=GET_FIELDS, &lt;b&gt;sometimes&lt;/b&gt; facet=true but sometimes it isn&apos;t.  Apparently, sometimes the earlier GET_FACETS phase satisfies the faceting alone and sometimes more is done in GET_FIELDS.  So &lt;b&gt;if&lt;/b&gt; facet=true on such a request &lt;b&gt;and&lt;/b&gt; facet.range is set (or perhaps facet.query), then the bug will hit.  Specifically both the facet.range and facet.query logic will conditionally call SimpleFacets.getGroupedFacetQueryCount, and both will conditionally do so when they detect that &quot;group.field&quot; has been set.  BUT, for a GET_FIELDS shard request, the &quot;group&quot; parameter flag is explicitly removed from the request by StoredFieldsShardRequestFactory, effectively disabling grouping.  So SimpleFacets.getGroupedFacetQueryCount will throw an error.  The error is that &quot;group.field&quot; hasn&apos;t been set which technically isn&apos;t true.&lt;/p&gt;

&lt;p&gt;It&apos;s 100% reproducible on my customer&apos;s system.  Reproducing it is tricky because it&apos;s not going to happen if the faceting logic doesn&apos;t happen on GET_FIELDS, which doesn&apos;t seem to happen often.  I found that for a test query if I changed the facet.limit to a sufficiently high number then it trips, but if it&apos;s low then it doesn&apos;t.  I presume this has something to do with refining faceting counts such that a higher facet.limit increases the chance that the coordinating node (what do we call that?) will need to ask a shard for more counts beyond which was provided on the initial GET_FACETS phase.&lt;/p&gt;

&lt;p&gt;If anyone has pointers on how to reproduce this (such as in a test!), then that would help.&lt;/p&gt;

&lt;p&gt;Even though I don&apos;t have 100% understanding of the bug and have yet to reproduce it with test data, it seems to me the bug might be as simple as having SimpleFacets.getGroupedFacetQueryCount retrieve the group.field parameter directly from parameters instead of possibly failing to find it in rb.GetGroupingSpec() (because &quot;group&quot; wasn&apos;t set).  After all, that is how the callers of this method determine wether or not they want to get a grouped query count.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12720663">SOLR-6160</key>
            <summary>Exception possible with group.facet, range faceting, with distributed search</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dsmiley">David Smiley</assignee>
                                    <reporter username="dsmiley">David Smiley</reporter>
                        <labels>
                    </labels>
                <created>Wed, 11 Jun 2014 19:10:41 +0000</created>
                <updated>Mon, 9 May 2016 18:54:21 +0000</updated>
                            <resolved>Tue, 17 Jun 2014 23:15:31 +0000</resolved>
                                    <version>4.7.1</version>
                                    <fixVersion>4.9</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14028297" author="dsmiley" created="Wed, 11 Jun 2014 19:39:19 +0000"  >&lt;p&gt;Here&apos;s the patch against 4.7.  Two lines were replaced with one.  Solr&apos;s tests pass and I would be surprised if this doesn&apos;t fix it on the production in system but it&apos;ll take time to deploy the fix to see.&lt;/p&gt;

&lt;p&gt;One thing about this simple patch I don&apos;t like is that group.field is having an effect even though group=true isn&apos;t on the request.  That actually was the case before this patch as well since both callers of the method I changed simply looked for the group.field param.  This isn&apos;t a big deal; arguably the client shouldn&apos;t be sending them in the first place.  But nonetheless, it would be nice if a sharded request could have its parameters stripped (by prefix) so as not to have side-effects like this. Doing so would then raise the question of how, in a GET_FIELDS phase, a facet query could get a grouped count even though we don&apos;t &lt;em&gt;actually&lt;/em&gt; want to group the results?  &lt;em&gt;&amp;lt;&amp;lt;shrug&amp;gt;&amp;gt;&lt;/em&gt; Thoughts welcome.&lt;/p&gt;</comment>
                            <comment id="14034369" author="peterciuffetti" created="Tue, 17 Jun 2014 21:02:58 +0000"  >&lt;p&gt;Confirming that this patch has resolved the issue in the SolrCloud environment where it was initially discovered.  Thanks!   Let me know if you want me to post any query logs or other data from the environment.&lt;/p&gt;</comment>
                            <comment id="14034442" author="dsmiley" created="Tue, 17 Jun 2014 21:54:22 +0000"  >&lt;p&gt;That confirmation works for me.  I&apos;ll commit to trunk, 4x, and the 4.9 release branch momentarily.&lt;/p&gt;</comment>
                            <comment id="14034556" author="jira-bot" created="Tue, 17 Jun 2014 23:01:58 +0000"  >&lt;p&gt;Commit 1603310 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1603310&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1603310&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6160&quot; title=&quot;Exception possible with group.facet, range faceting, with distributed search&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6160&quot;&gt;&lt;del&gt;SOLR-6160&lt;/del&gt;&lt;/a&gt;: bugfix when facet query or range with group facets and distributed&lt;/p&gt;</comment>
                            <comment id="14034573" author="jira-bot" created="Tue, 17 Jun 2014 23:12:27 +0000"  >&lt;p&gt;Commit 1603312 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt; in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1603312&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1603312&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6160&quot; title=&quot;Exception possible with group.facet, range faceting, with distributed search&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6160&quot;&gt;&lt;del&gt;SOLR-6160&lt;/del&gt;&lt;/a&gt;: bugfix when facet query or range with group facets and distributed&lt;/p&gt;</comment>
                            <comment id="14034577" author="jira-bot" created="Tue, 17 Jun 2014 23:14:14 +0000"  >&lt;p&gt;Commit 1603313 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt; in branch &apos;dev/branches/lucene_solr_4_9&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1603313&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1603313&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6160&quot; title=&quot;Exception possible with group.facet, range faceting, with distributed search&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6160&quot;&gt;&lt;del&gt;SOLR-6160&lt;/del&gt;&lt;/a&gt;: bugfix when facet query or range with group facets and distributed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12649862" name="SOLR-6160__bugfix_when_facet_query_or_range_with_group_facets_and_distributed.patch" size="877" author="dsmiley" created="Wed, 11 Jun 2014 19:39:19 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>398862</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 23 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1wo27:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>398984</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>