<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:11:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-17419] Improve HttpShardHandler performance in many-shard collections</title>
                <link>https://issues.apache.org/jira/browse/SOLR-17419</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;In Solr 8, HttpShardHandler sends shard-requests by submitting Callables to an ExecutorService. As a result, both the &quot;request-sending&quot; and &quot;response-awaiting&quot; happened asynchronous to the original request-thread.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void submit(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ShardRequest sreq, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; shard, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ModifiableSolrParams params) {
    ShardRequestor shardRequestor = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ShardRequestor(sreq, shard, params, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;); &lt;span class=&quot;code-comment&quot;&gt;// Callable
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      shardRequestor.init();
      pending.add(completionService.submit(shardRequestor));
    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
      shardRequestor.end();
    }   
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;However, in Solr 9.x HttpShardHandler ditched the ExecutorService/per-request-thread approach in favor of &lt;a href=&quot;https://github.com/apache/solr/blob/main/solr/core/src/java/org/apache/solr/handler/component/HttpShardHandler.java#L163&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;sending all requests serially using &quot;SolrClient.requestAsync&quot;&lt;/a&gt;. &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14354&quot; title=&quot;HttpShardHandler send requests in async&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14354&quot;&gt;&lt;del&gt;SOLR-14354&lt;/del&gt;&lt;/a&gt;, which made this change, did this in an effort to avoid unnecessary thread and CPU context-switching. As Dat described in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14354&quot; title=&quot;HttpShardHandler send requests in async&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14354&quot;&gt;&lt;del&gt;SOLR-14354&lt;/del&gt;&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;after sending a request that thread basically do nothing just waiting for response from other side. That thread will be swapped out and CPU will try to handle another thread (this is called context switch, CPU will save the context of the current thread and switch to another one). When some data (not all) come back, that thread will be called to parsing these data, then it will wait until more data come back. So there will be lots of context switching in CPU. That is quite inefficient&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This approach comes with a downside though - all the shard requests are sent serially. If sending each request takes ~1ms, then a user is unlikely to notice this in their collection with 5 or 10 shards.&#160; But the cost here scales linearly, so in&#160;&lt;b&gt;a collection with 50 shards - this approach would bake a ~50ms delay into the critical path of every single query!&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;This issue is intended to reevaluate whether there&apos;s a better way to balance these concerns. Ideally we can come up with an approach that improves all scenarios. Lacking that, maybe Solr could choose between one of several approaches semi-intelligently based on the number of shards or other factors?&lt;/p&gt;</description>
                <environment></environment>
        <key id="13589651">SOLR-17419</key>
            <summary>Improve HttpShardHandler performance in many-shard collections</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gerlowskija">Jason Gerlowski</assignee>
                                    <reporter username="gerlowskija">Jason Gerlowski</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 21 Aug 2024 20:02:20 +0000</created>
                <updated>Fri, 17 Oct 2025 20:04:46 +0000</updated>
                            <resolved>Fri, 6 Sep 2024 17:06:32 +0000</resolved>
                                    <version>9.0</version>
                    <version>9.6.1</version>
                                    <fixVersion>9.8</fixVersion>
                    <fixVersion>10.0</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="17878128" author="gerlowskija" created="Fri, 30 Aug 2024 13:43:57 +0000"  >&lt;p&gt;I opened a PR for this ticket but accidentally swapped two digits in the JIRA number, so it hasn&apos;t been linked here yet. Would love reviews on the code &lt;a href=&quot;https://github.com/apache/solr/pull/2681&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; if anyone has a few moments.&lt;/p&gt;

&lt;p&gt;Rather than trying to improve HttpShardHandler, the linked PR introduces an alternate implementation: ParallelHttpShardHandler&lt;span class=&quot;error&quot;&gt;&amp;#91;Factory&amp;#93;&lt;/span&gt;. The new implementation extends HttpShardHandler&lt;span class=&quot;error&quot;&gt;&amp;#91;Factory&amp;#93;&lt;/span&gt; and reuses most of its code. The only difference: ParallelHttpShardHandler.submit uses the executor to both send the request and await the response. This allows the &quot;submit&quot; call to return sooner, and for SearchHandler (or other callers) to iterate through a series of &quot;submit&quot; calls more quickly. The tradeoff of course is potentially higher CPU utilization, depending on the number of shards in play, etc.&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;I&apos;ve run some perf tests (details below), and the results look pretty promising in certain scenarios!&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13071200/13071200_shardhandler-perf-graph.png&quot; height=&quot;365&quot; width=&quot;607&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;To summarize:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;With auth disabled HttpShardHandler outperforms the new implementation even in collections with many shards.&lt;/li&gt;
	&lt;li&gt;With auth enabled though, ParallelShardHandler outperforms HttpShardHandler by a factor of nearly &quot;3x&quot; regardless of the number of shards.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;At first glance, it&apos;s surprising that &quot;auth&quot; has such a huge impact. The cause, according to some profiling, is PKI auth. Generating and signing the &quot;PKI&quot; header consumes a massive amount of CPU and drives the cost of HttpShardHandler.submit. Without PKI, request-sending is cheap enough that doing it serially outperforms the thread-creation overhead incurred by the &quot;Parallel&quot; implementation. As soon as PKI is needed though, it dwarfs any thread-creation overhead and ParallelHttpShardHandler wins out.&lt;/p&gt;

&lt;p&gt;P.S: With PKI being so expensive, should we stress the security.json &quot;forwardCredentials=true&quot; option more strongly in the docs? Or make it a default in the AuthPlugins that support it?&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Appendix: Perf Test Details&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;The results discussed above come from a series of perf experiments I ran on a local 4-node Solr cluster created via &quot;bin/solr start -e cloud -m 2g&quot;. &quot;Avg QTime&quot; measurements were taken by (1) creating a collection with a particular &apos;numShard&apos; value and using a particular &apos;ShardHandlerFactory&apos;, (2) loading in some data, (3) warming the JVM and collection with an initial round of queries, and (4) running &apos;numQueries&apos; from each of &apos;numThreads&apos; QueryRunner threads.&lt;/p&gt;

&lt;p&gt;As a data set, I used emails from our &quot;dev@&quot; list exported from &quot;lists.apache.org&quot;. (I have a little script to export and clean up this data that I&apos;m considering saving somewhere - it&apos;s been an interesting dataset to work with and might be useful in our benchmark module or elsewhere?) For queries, the perf-test code uses the &quot;/terms&quot; handler to fetch common terms and then creates single-term queries from those.&lt;/p&gt;

&lt;p&gt;Other details:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;b&gt;Solr Version:&lt;/b&gt; 10.0.0-SNAPSHOT (a branch based off of &apos;main&apos;, with the commit: 1818841868d70adebde364165d60114f164952de)&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;JVM:&lt;/b&gt; openjdk version &quot;17.0.8&quot; 2023-07-18&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;OS:&lt;/b&gt; MacOS Sonoma 14.6.1&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;Hardware:&lt;/b&gt; 2017 iMac Pro, 2.5GHz 14-core Intel Xeon, 128gb ram&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17879913" author="jira-bot" created="Fri, 6 Sep 2024 16:01:46 +0000"  >&lt;p&gt;Commit eeeb0e3840f17aae44a8f1d2165c03713a966fe5 in solr&apos;s branch refs/heads/main from Jason Gerlowski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=eeeb0e3840f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=eeeb0e3840f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17419&quot; title=&quot;Improve HttpShardHandler performance in many-shard collections&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17419&quot;&gt;&lt;del&gt;SOLR-17419&lt;/del&gt;&lt;/a&gt;: Introduce ParallelHttpShardHandler (#2681)&lt;/p&gt;

&lt;p&gt;The default ShardHandler implementation, HttpShardHandler, sends all&lt;br/&gt;
shard-requests serially, only parallelizing the waiting and parsing of&lt;br/&gt;
responses.  This works great for collections with few shards, but as the&lt;br/&gt;
number of shards increases the serialized sending of shard-requests adds&lt;br/&gt;
a larger and larger overhead to the overall request (especially when&lt;br/&gt;
auth and PKI are done at request-sending time).&lt;/p&gt;

&lt;p&gt;This commit fixes this by introducing an alternate ShardHandler&lt;br/&gt;
implementation, geared towards collections with many shards.  This&lt;br/&gt;
ShardHandler uses an executor to parallelize both request sending and&lt;br/&gt;
response waiting/parsing.  This consumes more CPU, but reduces greatly&lt;br/&gt;
reduces the latency/QTime observed by users querying many-shard&lt;br/&gt;
collections.&lt;/p&gt;</comment>
                            <comment id="17879926" author="jira-bot" created="Fri, 6 Sep 2024 17:05:34 +0000"  >&lt;p&gt;Commit 245956c6efa8a8073784e67e7b6aa06469c1e297 in solr&apos;s branch refs/heads/branch_9x from Jason Gerlowski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=245956c6efa&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=245956c6efa&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17419&quot; title=&quot;Improve HttpShardHandler performance in many-shard collections&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17419&quot;&gt;&lt;del&gt;SOLR-17419&lt;/del&gt;&lt;/a&gt;: Introduce ParallelHttpShardHandler (#2681)&lt;/p&gt;

&lt;p&gt;The default ShardHandler implementation, HttpShardHandler, sends all&lt;br/&gt;
shard-requests serially, only parallelizing the waiting and parsing of&lt;br/&gt;
responses.  This works great for collections with few shards, but as the&lt;br/&gt;
number of shards increases the serialized sending of shard-requests adds&lt;br/&gt;
a larger and larger overhead to the overall request (especially when&lt;br/&gt;
auth and PKI are done at request-sending time).&lt;/p&gt;

&lt;p&gt;This commit fixes this by introducing an alternate ShardHandler&lt;br/&gt;
implementation, geared towards collections with many shards.  This&lt;br/&gt;
ShardHandler uses an executor to parallelize both request sending and&lt;br/&gt;
response waiting/parsing.  This consumes more CPU, but reduces greatly&lt;br/&gt;
reduces the latency/QTime observed by users querying many-shard&lt;br/&gt;
collections.&lt;/p&gt;</comment>
                            <comment id="17914297" author="dsmiley" created="Sat, 18 Jan 2025 06:43:02 +0000"  >&lt;p&gt;I found out about this cool optimization by reading our release notes, LOL. &#160;Nice work!&lt;/p&gt;

&lt;p&gt;Question: &#160;Did you consider enhancing the default handler so that either approach can be taken without the user explicitly configuring this thing? &#160;Ideally Solr would use this if the shard count is above some threshold.&lt;/p&gt;</comment>
                            <comment id="17914972" author="gerlowskija" created="Tue, 21 Jan 2025 12:52:40 +0000"  >&lt;blockquote&gt;&lt;p&gt;I found out about this cool optimization by reading our release notes, LOL.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Well, that&apos;s why we write them I guess haha!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Did you consider enhancing the default handler so that either approach can be taken without the user explicitly configuring this thing?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I considered it, but ultimately chose the more conservative route taken here of having it be fully &quot;opt in&quot;.  Mostly for risk-aversion reasons - I figured it&apos;d be best to let it bake for a few minor releases to flush out potential bugs, before enabling automatically.&lt;/p&gt;

&lt;p&gt;I agree it&apos;d be great to make it &quot;opt-out&quot; eventually though, for collections with enough shards.&lt;/p&gt;</comment>
                            <comment id="17921930" author="anshumg" created="Tue, 28 Jan 2025 22:17:51 +0000"  >&lt;p&gt;Closing after the 9.8.0 release&lt;/p&gt;</comment>
                            <comment id="17945726" author="jira-bot" created="Fri, 18 Apr 2025 18:14:49 +0000"  >&lt;p&gt;Commit a5784325f0a87fd30732124905c2c20f7ffd51d5 in solr&apos;s branch refs/heads/add-pki-caching from Jason Gerlowski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=a5784325f0a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=a5784325f0a&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17419&quot; title=&quot;Improve HttpShardHandler performance in many-shard collections&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17419&quot;&gt;&lt;del&gt;SOLR-17419&lt;/del&gt;&lt;/a&gt;: Introduce ParallelHttpShardHandler (#105)&lt;/p&gt;

&lt;p&gt;The default ShardHandler implementation, HttpShardHandler, sends all&lt;br/&gt;
shard-requests serially, only parallelizing the waiting and parsing of&lt;br/&gt;
responses.  This works great for collections with few shards, but as the&lt;br/&gt;
number of shards increases the serialized sending of shard-requests adds&lt;br/&gt;
a larger and larger overhead to the overall request (especially when&lt;br/&gt;
auth and PKI are done at request-sending time).&lt;/p&gt;

&lt;p&gt;This commit fixes this by introducing an alternate ShardHandler&lt;br/&gt;
implementation, geared towards collections with many shards.  This&lt;br/&gt;
ShardHandler uses an executor to parallelize both request sending and&lt;br/&gt;
response waiting/parsing.  This consumes more CPU, but reduces greatly&lt;br/&gt;
reduces the latency/QTime observed by users querying many-shard&lt;br/&gt;
collections.&lt;/p&gt;

&lt;p&gt;Co-authored-by: Jason Gerlowski &amp;lt;gerlowskija@apache.org&amp;gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13071200" name="shardhandler-perf-graph.png" size="216613" author="gerlowskija" created="Fri, 30 Aug 2024 12:52:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            29 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1qzyw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>