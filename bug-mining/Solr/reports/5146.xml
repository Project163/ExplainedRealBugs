<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:09:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-17060] CoreContainer#create may deadlock with concurrent requests for metrics</title>
                <link>https://issues.apache.org/jira/browse/SOLR-17060</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;CoreContainer#create registers metrics for the created core quite early, and metrics can be requested for a core that is still being created. If a metrics request calls SolrCore#getSearcher with unlucky timing (race condition), then CoreContainer#create can deadlock.&lt;/p&gt;

&lt;p&gt;This problem was described on the users lists: &lt;a href=&quot;https://lists.apache.org/thread/mvpp1ogkxfdgfx87mdt6ylhqsttoq2dw&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://lists.apache.org/thread/mvpp1ogkxfdgfx87mdt6ylhqsttoq2dw&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We ran into such a deadlock with Solr 9.2.1, a CoreAdmin CREATE request, and a periodic thread that requests all available JMX metrics.&lt;/p&gt;

&lt;p&gt;A CoreAdmin CREATE request was received, but its thread waits forever because onDeckSearchers is 1 and _searcher is null (variables checked in heap dump):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;
&quot;qtp1800649922-28&quot; #28 prio=5 os_prio=0 cpu=757.69ms elapsed=25383.63s tid=0x00007fe6dc9613a0 nid=0x70 in Object.wait()  [0x00007fe6c68ca000]
   java.lang.Thread.State: WAITING (on object monitor)
    at java.lang.Object.wait(java.base@17.0.8.1/Native  Method)
    - waiting on &amp;lt;no object reference available&amp;gt;
    at java.lang.Object.wait(java.base@17.0.8.1/Unknown  Source)
    at org.apache.solr.core.SolrCore.getSearcher(SolrCore.java:2528)
    - locked &amp;lt;0x00000000e25dd2c8&amp;gt; (a java.lang.Object)
    at org.apache.solr.core.SolrCore.initSearcher(SolrCore.java:1283)
    at org.apache.solr.core.SolrCore.&amp;lt;init&amp;gt;(SolrCore.java:1168)
    at org.apache.solr.core.SolrCore.&amp;lt;init&amp;gt;(SolrCore.java:1051)
    at org.apache.solr.core.CoreContainer.createFromDescriptor(CoreContainer.java:1666)
    at org.apache.solr.core.CoreContainer.create(CoreContainer.java:1532)
    at org.apache.solr.handler.admin.CoreAdminOperation.lambda$static$0(CoreAdminOperation.java:111)
    at org.apache.solr.handler.admin.CoreAdminOperation$$Lambda$437/0x00007fe66048cc60.execute(Unknown Source)
    at org.apache.solr.handler.admin.CoreAdminOperation.execute(CoreAdminOperation.java:398)
    at org.apache.solr.handler.admin.CoreAdminHandler$CallInfo.call(CoreAdminHandler.java:354)
    at org.apache.solr.handler.admin.CoreAdminHandler.handleRequestBody(CoreAdminHandler.java:219)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
There&apos;s no way for clients to retry the CREATE request, because CoreContainer rejects additional requests for good reason (&quot;Already creating a core with name ...&quot;, see &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14969&quot; title=&quot;Prevent creating multiple cores with the same name which leads to instabilities (race condition)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14969&quot;&gt;&lt;del&gt;SOLR-14969&lt;/del&gt;&lt;/a&gt;).&lt;br/&gt;
The only solution is to restart Solr.&lt;br/&gt;
&#160;&lt;br/&gt;
A thread for metrics was also waiting in the same way:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;
prometheus-http-1-1&quot; #30 daemon prio=5 os_prio=0 cpu=1212.68ms elapsed=25383.60s tid=0x00007fe620008ac0 nid=0x73 in Object.wait()  [0x00007fe6c680b000]
   java.lang.Thread.State: WAITING (on object monitor)
       at java.lang.Object.wait(java.base@17.0.8.1/Native  Method)
       - waiting on &amp;lt;no object reference available&amp;gt;
       at java.lang.Object.wait(java.base@17.0.8.1/Unknown  Source)
       at org.apache.solr.core.SolrCore.getSearcher(SolrCore.java:2528)
       - locked &amp;lt;0x00000000e25dd2c8&amp;gt; (a java.lang.Object)
       at org.apache.solr.core.SolrCore.getSearcher(SolrCore.java:2271)
       at org.apache.solr.core.SolrCore.getSearcher(SolrCore.java:2106)
       at org.apache.solr.core.SolrCore.withSearcher(SolrCore.java:2124)
       at org.apache.solr.core.SolrCore.getSegmentCount(SolrCore.java:534)
       at org.apache.solr.core.SolrCore.lambda$initializeMetrics$11(SolrCore.java:1360)
       at org.apache.solr.core.SolrCore$$Lambda$760/0x00007fe660634ec8.getValue(Unknown Source)
       at org.apache.solr.metrics.SolrMetricManager$GaugeWrapper.getValue(SolrMetricManager.java:779)
       at org.apache.solr.metrics.reporters.jmx.JmxMetricsReporter$JmxGauge.getValue(JmxMetricsReporter.java:207
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This thread gathers multiple metrics one after the other. We can assume, that it had called SolrCore#getSearcher successfully before, and that the previous call has incremented onDeckSearchers to 1.&lt;/p&gt;

&lt;p&gt;A previous call to #getSearcher should eventually decrement onDeckSearchers again, and also set the _searcher field, but that&apos;s not happening. Normally, this should happen in SolrCore#registerSearcher, but that method is executed on the searcherExecutor, see&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/solr/blob/releases/solr/9.2.1/solr/core/src/java/org/apache/solr/core/SolrCore.java#L2681&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/solr/blob/releases/solr/9.2.1/solr/core/src/java/org/apache/solr/core/SolrCore.java#L2681&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The problem is, that searcherExecutor will never execute #registerSearcher because the executor is still blocked by another job. This is because the core is still being created, see&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/solr/blob/releases/solr/9.2.1/solr/core/src/java/org/apache/solr/core/SolrCore.java#L1160&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/solr/blob/releases/solr/9.2.1/solr/core/src/java/org/apache/solr/core/SolrCore.java#L1160&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;
&quot;searcherExecutor-14-thread-1-processing-studio&quot; #50 prio=5 os_prio=0 cpu=0.27ms elapsed=25212.18s tid=0x00007fe608146080 nid=0xbd waiting on condition  [0x00007fe6c637a000]
   java.lang.Thread.State: WAITING (parking)
       at jdk.internal.misc.Unsafe.park(java.base@17.0.8.1/Native  Method)
       - parking to wait for  &amp;lt;0x00000000e738c1a8&amp;gt; (a java.util.concurrent.CountDownLatch$Sync)
       at java.util.concurrent.locks.LockSupport.park(java.base@17.0.8.1/Unknown  Source)
       at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(java.base@17.0.8.1/Unknown  Source)
       at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(java.base@17.0.8.1/Unknown  Source)
       at java.util.concurrent.CountDownLatch.await(java.base@17.0.8.1/Unknown  Source)
       at org.apache.solr.core.SolrCore.lambda$new$3(SolrCore.java:1162)
       at org.apache.solr.core.SolrCore$$Lambda$815/0x00007fe6606f3c40.call(Unknown Source)
       at java.util.concurrent.FutureTask.run(java.base@17.0.8.1/Unknown  Source) 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In summary, we have&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;thread &quot;qtp1800649922-28&quot; in SolrCore.&amp;lt;init&amp;gt; trying to create a core, which is waiting for&lt;/li&gt;
	&lt;li&gt;#registerSearcher job in the searcherExecutor work queue, which is waiting to be executed by&lt;/li&gt;
	&lt;li&gt;thread &quot;searcherExecutor-14-thread-1-processing-studio&quot; which waits for the first thread &quot;qtp1800649922-28&quot; to unblock it&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13556101">SOLR-17060</key>
            <summary>CoreContainer#create may deadlock with concurrent requests for metrics</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stillalex">Alex Deparvu</assignee>
                                    <reporter username="ahubold">Andreas Hubold</reporter>
                        <labels>
                            <label>deadlock</label>
                            <label>metrics</label>
                            <label>monitoring</label>
                    </labels>
                <created>Mon, 30 Oct 2023 14:33:30 +0000</created>
                <updated>Fri, 17 Oct 2025 20:05:03 +0000</updated>
                            <resolved>Tue, 19 Dec 2023 20:56:51 +0000</resolved>
                                    <version>9.2.1</version>
                    <version>9.4</version>
                                    <fixVersion>9.5</fixVersion>
                    <fixVersion>9.4.1</fixVersion>
                    <fixVersion>10.0</fixVersion>
                                    <component>multicore</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>8</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="12000">3h 20m</timespent>
                                <comments>
                            <comment id="17786678" author="ahubold" created="Thu, 16 Nov 2023 08:55:22 +0000"  >&lt;p&gt;It seems this bug has been introduced with Solr 9. We have never seen it with 8.11.2 or earlier versions, and the metric &quot;solr.&amp;lt;core&amp;gt;.INDEX.segments&quot;, which acquires a searcher here, was introduced with Solr 9 (part of &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15428&quot; title=&quot;Integrate the OpenJDK JMH micro benchmark framework for micro benchmarks and performance comparisons and investigation.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15428&quot;&gt;&lt;del&gt;SOLR-15428&lt;/del&gt;&lt;/a&gt; in &lt;a href=&quot;https://github.com/apache/solr/commit/890ef78421f8c0645ae9f4f53ebca1177e8141d9#diff-3bf44f923643744a743460bb0f64301618dd7529a602d945fe2f7f193d4cdde0R1213&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;commit&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="17786811" author="ahubold" created="Thu, 16 Nov 2023 15:45:04 +0000"  >&lt;p&gt;I was able to work around the issue by excluding the INDEX.segments metric in solr.xml. Well, I hope so - at least I wasn&apos;t able to reproduce the issue anymore. The workaround is just valid for gathering metrics via JMX. It will not prevent deadlocks if metrics are retrieved from the /admin/metrics HTTP endpoint.&lt;/p&gt;

&lt;p&gt;For reference, this is how I excluded INDEX.segments but kept all the other metrics in solr.xml. It&apos;s a bit clumsy, but I did not find a better way to exclude a metric - so I included all metrics except the problematic one:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;metrics enabled=&lt;span class=&quot;code-quote&quot;&gt;&quot;${metricsEnabled:true}&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;reporter name=&lt;span class=&quot;code-quote&quot;&gt;&quot;jmx_metrics_core&quot;&lt;/span&gt; group=&lt;span class=&quot;code-quote&quot;&gt;&quot;core&quot;&lt;/span&gt; class=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.solr.metrics.reporters.SolrJmxReporter&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
      &amp;lt;!--
        Workaround for SOLR-17060: Exclude &lt;span class=&quot;code-quote&quot;&gt;&apos;INDEX.segments&apos;&lt;/span&gt; MBean attribute, because read access may cause a deadlock.
        Sadly, it&apos;s not possible to exclude a single metric by configuration. We can only list included name prefixes.
        The following prefixes should cover all metrics except &lt;span class=&quot;code-quote&quot;&gt;&apos;INDEX.segments&apos;&lt;/span&gt;.
        To that end, we are listing all categories from org.apache.solr.core.SolrInfoBean.Category except INDEX,
        and known attributes from INDEX except INDEX.segments.
      --&amp;gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;filter&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;CONTAINER&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/str&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;filter&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;ADMIN&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/str&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;filter&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;CORE&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/str&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;filter&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;QUERY&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/str&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;filter&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;UPDATE&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/str&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;filter&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;CACHE&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/str&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;filter&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;HIGHLIGHTER&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/str&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;filter&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;QUERYPARSER&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/str&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;filter&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;SPELLCHECKER&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/str&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;filter&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;SEARCHER&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/str&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;filter&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;REPLICATION&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/str&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;filter&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;TLOG&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/str&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;filter&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;DIRECTORY&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/str&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;filter&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;HTTP&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/str&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;filter&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;SECURITY&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/str&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;filter&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;OTHER&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/str&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;filter&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;INDEX.flush&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/str&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;filter&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;INDEX.merge&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/str&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;filter&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;INDEX.size&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/str&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;filter&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;INDEX.sizeInBytes&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/str&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/reporter&amp;gt;&lt;/span&gt;
    &amp;lt;!--
      Add other available metrics, for all groups except group &lt;span class=&quot;code-quote&quot;&gt;&quot;core&quot;&lt;/span&gt; that is defined above.
      The list of possible groups is taken from org.apache.solr.core.SolrInfoBean.Group.
    --&amp;gt;
    &amp;lt;reporter name=&lt;span class=&quot;code-quote&quot;&gt;&quot;jmx_metrics_other&quot;&lt;/span&gt;
              group=&lt;span class=&quot;code-quote&quot;&gt;&quot;jetty, jvm, node, collection, shard, cluster, overseer&quot;&lt;/span&gt;
              class=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.solr.metrics.reporters.SolrJmxReporter&quot;&lt;/span&gt;/&amp;gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/metrics&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17786869" author="gus_heck" created="Thu, 16 Nov 2023 17:26:05 +0000"  >&lt;p&gt;Sounds like it would interact very badly with things like time routed aliases, or any user written (external) automation. I haven&apos;t looked/tested in detail but I could imagine the TRA getting completely stuck because the collection it needs can&apos;t be created.&lt;/p&gt;

&lt;p&gt;This maybe should be a blocker for 9.5? until fixed or TRA behavior is known to not become wedged. Also possibly worthy of back-port to a 9.4.x?&lt;/p&gt;

&lt;p&gt;Not sure if I currently have time to look at it, but I am worried by this.&lt;/p&gt;</comment>
                            <comment id="17787081" author="duerrm" created="Fri, 17 Nov 2023 08:34:10 +0000"  >&lt;p&gt;Not sure whether it is related, but at least I wanted to mention it here:&lt;/p&gt;

&lt;p&gt;We have a similar issue since a while, but I was not able to reproduce this problem on a testing environment.&lt;br/&gt;
The problem occurs when we restart our 2 solr servers (cloud mode) while a metrics exporter (running as a separate instance at another server) tries to retrieve metrics from the restarting nodes. The result is that sometimes a core of a collection cannot be loaded (state &quot;down&quot; in admin ui). The reason also seems to be the call to SolrCore.getSearcher() but in our case it is called by MetricsHandler.handleRequestBody(). As the metrics exporter will continue causing that call to happen, we see an increasing number of threads that get stuck waiting for SolrCore.getSearcher() to return.&lt;/p&gt;

&lt;p&gt;Our &quot;solution&quot; to this problem yet is to stop the mertics exporter before we restart a solr node.&#160;&lt;/p&gt;

&lt;p&gt;The corresponding mail thread can be found here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://www.mail-archive.com/users@solr.apache.org/msg06133.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.mail-archive.com/users@solr.apache.org/msg06133.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17787085" author="ahubold" created="Fri, 17 Nov 2023 08:53:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=duerrm&quot; class=&quot;user-hover&quot; rel=&quot;duerrm&quot;&gt;duerrm&lt;/a&gt; In the mail thread, there&apos;s are a call to &quot;SolrCore.getSegmentCount&quot; for metrics on one thread, and a call to &quot;SolrCore.&amp;lt;init&amp;gt;&quot; on another. It looks like exactly the same issue to me.&lt;/p&gt;

&lt;p&gt;BTW, the answer in the mail thread &quot;This thread is waiting for the lock on &apos;java.lang.Object@6665e80c&apos;&quot; was not entirely correct. The mentioned thread was waiting for a notify call on that object / on that lock. That does not mean that another thread was currently holding the lock and also explains why you haven&apos;t found another thread holding that lock in the thread dump.&lt;/p&gt;</comment>
                            <comment id="17790775" author="alex.parvulescu" created="Tue, 28 Nov 2023 21:55:41 +0000"  >&lt;p&gt;I took a stab at a proposal for a fix &lt;a href=&quot;https://github.com/apache/solr/pull/2101&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/solr/pull/2101&lt;/a&gt; which I am not entirely sure will work correctly.&lt;/p&gt;

&lt;p&gt;The approach is to identify the problematic window (core still in init phase) and avoid enabling the metrics. based on this idea I extended the existing isClosed() (refCount.get() &amp;lt;= 0) check to verify that the core is opened instead (refCount.get() &amp;lt;= 1).&lt;/p&gt;

&lt;p&gt;The test provided is a best-effort, I could not capture the deadlock, but I did get some exception which may indicate some error in opening the searcher but I am not familiar enough with this code to tell for sure.&lt;/p&gt;

&lt;p&gt;Open to feedback on both fix and test - even if to say that this approach is not good in identifying and fixing the deadlock.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Exception trace caused by the test&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.solr.core.SolrCoreTest &amp;gt; testCoreInitDeadlockMetrics FAILED
    org.apache.solr.common.SolrException: Error CREATEing SolrCore &apos;tmpCore&apos;: Unable to create core [tmpCore] Caused by: no segments* file found in LockValidatingDirectoryWrapper(MockDirectoryWrapper(ByteBuffersDirectory@140da8ef lockFactory=org.apache.lucene.store.SingleInstanceLockFactory@632b9c9e)): files: []
        at __randomizedtesting.SeedInfo.seed([3110F9390179E105:3BE771D8AB76AF96]:0)
        at app//org.apache.solr.core.CoreContainer.create(CoreContainer.java:1613)
        at app//org.apache.solr.core.CoreContainer.create(CoreContainer.java:1514)
        at app//org.apache.solr.core.SolrCoreTest.testCoreInitDeadlockMetrics(SolrCoreTest.java:375)
        ...
Caused by:
org.apache.solr.common.SolrException: Unable to create core [tmpCore]
    at app//org.apache.solr.core.CoreContainer.createFromDescriptor(CoreContainer.java:1738)
    at app//org.apache.solr.core.CoreContainer.create(CoreContainer.java:1571)
    ... 48 more
Caused by:
org.apache.solr.common.SolrException: Error opening new searcher
    at app//org.apache.solr.core.SolrCore.&amp;lt;init&amp;gt;(SolrCore.java:1234)
    at app//org.apache.solr.core.SolrCore.&amp;lt;init&amp;gt;(SolrCore.java:1057)
    at app//org.apache.solr.core.CoreContainer.createFromDescriptor(CoreContainer.java:1705)
    ... 49 more
Caused by:
org.apache.solr.common.SolrException: Error opening new searcher
    at app//org.apache.solr.core.SolrCore.openNewSearcher(SolrCore.java:2464)
    at app//org.apache.solr.core.SolrCore.getSearcher(SolrCore.java:2597)
    at app//org.apache.solr.core.SolrCore.initSearcher(SolrCore.java:1293)
    at app//org.apache.solr.core.SolrCore.&amp;lt;init&amp;gt;(SolrCore.java:1178)
    ... 51 more
Caused by:
org.apache.lucene.index.IndexNotFoundException: no segments* file found in LockValidatingDirectoryWrapper(MockDirectoryWrapper(ByteBuffersDirectory@140da8ef lockFactory=org.apache.lucene.store.SingleInstanceLockFactory@632b9c9e)): files: []
    at app//org.apache.lucene.index.IndexWriter.&amp;lt;init&amp;gt;(IndexWriter.java:1075)
    at app//org.apache.solr.update.SolrIndexWriter.&amp;lt;init&amp;gt;(SolrIndexWriter.java:145)
    at app//org.apache.solr.update.SolrIndexWriter.create(SolrIndexWriter.java:110)
    at app//org.apache.solr.update.DefaultSolrCoreState.createMainIndexWriter(DefaultSolrCoreState.java:258)
    at app//org.apache.solr.update.DefaultSolrCoreState.getIndexWriter(DefaultSolrCoreState.java:125)
    at app//org.apache.solr.core.SolrCore.openNewSearcher(SolrCore.java:2415)
    ... 54 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17793776" author="dsmiley" created="Wed, 6 Dec 2023 15:16:53 +0000"  >&lt;p&gt;Fantastic investigation!&lt;/p&gt;</comment>
                            <comment id="17798735" author="jira-bot" created="Tue, 19 Dec 2023 20:48:42 +0000"  >&lt;p&gt;Commit 5876c530c6e3e86891a36432acd29c9e64cdc774 in solr&apos;s branch refs/heads/main from Alex Deparvu&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=5876c530c6e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=5876c530c6e&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17060&quot; title=&quot;CoreContainer#create may deadlock with concurrent requests for metrics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17060&quot;&gt;&lt;del&gt;SOLR-17060&lt;/del&gt;&lt;/a&gt; CoreContainer#create may deadlock with concurrent requests for metrics (#2101)&lt;/p&gt;
</comment>
                            <comment id="17798740" author="jira-bot" created="Tue, 19 Dec 2023 20:54:45 +0000"  >&lt;p&gt;Commit 8a865e80db634d4b603ec82736b336ac6c518f5e in solr&apos;s branch refs/heads/branch_9x from Alex Deparvu&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=8a865e80db6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=8a865e80db6&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17060&quot; title=&quot;CoreContainer#create may deadlock with concurrent requests for metrics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17060&quot;&gt;&lt;del&gt;SOLR-17060&lt;/del&gt;&lt;/a&gt; CoreContainer#create may deadlock with concurrent requests for metrics (#2101)&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 5876c530c6e3e86891a36432acd29c9e64cdc774)&lt;/p&gt;</comment>
                            <comment id="17798744" author="alex.parvulescu" created="Tue, 19 Dec 2023 20:56:51 +0000"  >&lt;p&gt;thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt; for&#160;the continued reviews. the PR is merged and backported to 9x branch. will keep an eye on builds in the following days to see if there is anything failing.&lt;/p&gt;</comment>
                            <comment id="17798807" author="dsmiley" created="Wed, 20 Dec 2023 03:30:25 +0000"  >&lt;p&gt;I recommend bringing this to 9.4.1&lt;/p&gt;</comment>
                            <comment id="17799203" author="jira-bot" created="Wed, 20 Dec 2023 23:18:17 +0000"  >&lt;p&gt;Commit 79bce121a33397cd2bffa6e81c24fe4ae6d2e8f3 in solr&apos;s branch refs/heads/branch_9_4 from Alex Deparvu&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=79bce121a33&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=79bce121a33&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17060&quot; title=&quot;CoreContainer#create may deadlock with concurrent requests for metrics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17060&quot;&gt;&lt;del&gt;SOLR-17060&lt;/del&gt;&lt;/a&gt; CoreContainer#create may deadlock with concurrent requests for metrics (#2101)&lt;/p&gt;</comment>
                            <comment id="17799205" author="alex.parvulescu" created="Wed, 20 Dec 2023 23:19:08 +0000"  >&lt;p&gt;sure &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt; I backported to 9.4.1&lt;/p&gt;</comment>
                            <comment id="17808384" author="dsmiley" created="Thu, 18 Jan 2024 22:33:07 +0000"  >&lt;p&gt;Closing after the 9.4.1 release&lt;/p&gt;</comment>
                            <comment id="17885027" author="JIRAUSER285039" created="Thu, 26 Sep 2024 13:51:50 +0000"  >&lt;p&gt;It didn&apos;t seem to be fixed fully. We are still observing this issue with 9.6.1. &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17463&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-17463&lt;/a&gt; was created&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13589766">SOLR-17420</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13593397">SOLR-17463</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 6 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ladc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>