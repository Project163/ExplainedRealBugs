<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:11:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-8575] Fix HDFSLogReader replay status numbers, a performance bug where we can reopen FSDataInputStream much too often, and an hdfs tlog data integrity bug.</title>
                <link>https://issues.apache.org/jira/browse/SOLR-8575</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pdvorak%40cloudera.com&quot; class=&quot;user-hover&quot; rel=&quot;pdvorak@cloudera.com&quot;&gt;pdvorak@cloudera.com&lt;/a&gt; noticed some funny transaction log replay status logging a while back:&lt;/p&gt;

&lt;p&gt;active=true starting pos=444978 current pos=2855956 current size=16262 % read=17562&lt;br/&gt;
active=true starting pos=444978 current pos=5748869 current size=16262 % read=35352&lt;/p&gt;

&lt;p&gt;17562% read? Current size does not change as expected in this case?&lt;/p&gt;</description>
                <environment></environment>
        <key id="12932798">SOLR-8575</key>
            <summary>Fix HDFSLogReader replay status numbers, a performance bug where we can reopen FSDataInputStream much too often, and an hdfs tlog data integrity bug.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="markrmiller@gmail.com">Mark Miller</assignee>
                                    <reporter username="markrmiller@gmail.com">Mark Miller</reporter>
                        <labels>
                    </labels>
                <created>Wed, 20 Jan 2016 18:36:16 +0000</created>
                <updated>Mon, 9 May 2016 18:50:03 +0000</updated>
                            <resolved>Sun, 21 Feb 2016 01:36:44 +0000</resolved>
                                                    <fixVersion>6.0</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="15109609" author="markrmiller@gmail.com" created="Wed, 20 Jan 2016 22:23:51 +0000"  >&lt;p&gt;Patch that fixes a couple issues and adds an isolated test that tries to target tlog replay while buffering during recovery.&lt;/p&gt;

&lt;p&gt;When we recalculated the size of the tlog, it keeps coming back the same as the first size call, even if the tlog has grown. I think this has something to do with an open file with hdfs.&lt;/p&gt;

&lt;p&gt;We were somewhat incorrectly using that size for tlog progress logging. We should having been using our internally tracked size.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;the same as the first size call, even if the tlog has grown.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;And that kept a large performance issue in. When we opened the tlog at first, we could replay fairly fast, but if we buffer updates while replay, we were reopening the reader every update due to the stale size issue.&lt;/p&gt;</comment>
                            <comment id="15109639" author="mdrob" created="Wed, 20 Jan 2016 22:45:53 +0000"  >&lt;p&gt;I had talked to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andrew.wang&quot; class=&quot;user-hover&quot; rel=&quot;andrew.wang&quot;&gt;andrew.wang&lt;/a&gt; about this maybe a month ago and he suggested that if you want to get the updated size from the file then you have to use hsync with the length update flag[1] using an HdfsOutputStream (not FSDataOutputStream like we use).&lt;/p&gt;

&lt;p&gt;Using an internally stored length is probably better anyway, though.&lt;/p&gt;

&lt;p&gt;[1]: &lt;a href=&quot;https://github.com/apache/hadoop/blob/2ec438e8f7cd77cb48fd1264781e60a48e331908/hadoop-hdfs-project/hadoop-hdfs-client/src/main/java/org/apache/hadoop/hdfs/client/HdfsDataOutputStream.java#L105&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hadoop/blob/2ec438e8f7cd77cb48fd1264781e60a48e331908/hadoop-hdfs-project/hadoop-hdfs-client/src/main/java/org/apache/hadoop/hdfs/client/HdfsDataOutputStream.java#L105&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15109686" author="markrmiller@gmail.com" created="Wed, 20 Jan 2016 23:03:08 +0000"  >&lt;blockquote&gt;&lt;p&gt;Using an internally stored length is probably better anyway, though.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The problem is that our internal size does not correlate with what we can actually read, even after an hflush. (unless we reopen inputstreams)&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;updated size from the file then you have to use hsync with the length update flag&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; using an HdfsOutputStream &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ah, interesting, I&apos;ll poke around that a bit to see if we want to do anything different.&lt;/p&gt;</comment>
                            <comment id="15133219" author="mdrob" created="Thu, 4 Feb 2016 22:52:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; - do you think we will be going with your current proposed approach or do you expect to redo this to use HdfsOutputStream? Not sure how much research you&apos;ve already done so I don&apos;t want to duplicate effort, but would be interested in making sure this issue gets resolved.&lt;/p&gt;</comment>
                            <comment id="15133252" author="markrmiller@gmail.com" created="Thu, 4 Feb 2016 22:55:12 +0000"  >&lt;p&gt;Yeah, I was about to commit what I have. Adding an hsync would be much slower than this and is not necessary with this approach in my testing.&lt;/p&gt;</comment>
                            <comment id="15133275" author="jira-bot" created="Thu, 4 Feb 2016 23:06:40 +0000"  >&lt;p&gt;Commit ec4c72310f3548b93139b25a12d6e9a16ac9e322 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mark.miller%40oblivion.ch&quot; class=&quot;user-hover&quot; rel=&quot;mark.miller@oblivion.ch&quot;&gt;mark.miller@oblivion.ch&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ec4c723&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ec4c723&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8575&quot; title=&quot;Fix HDFSLogReader replay status numbers, a performance bug where we can reopen FSDataInputStream much too often, and an hdfs tlog data integrity bug.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8575&quot;&gt;&lt;del&gt;SOLR-8575&lt;/del&gt;&lt;/a&gt;: Fix HDFSLogReader replay status numbers and a performance bug where we can reopen FSDataInputStream too often.&lt;/p&gt;</comment>
                            <comment id="15133361" author="jira-bot" created="Thu, 4 Feb 2016 23:54:42 +0000"  >&lt;p&gt;Commit 482b40f841660820f633267a21e6df44aff55346 in lucene-solr&apos;s branch refs/heads/branch_5x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mark.miller%40oblivion.ch&quot; class=&quot;user-hover&quot; rel=&quot;mark.miller@oblivion.ch&quot;&gt;mark.miller@oblivion.ch&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=482b40f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=482b40f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8575&quot; title=&quot;Fix HDFSLogReader replay status numbers, a performance bug where we can reopen FSDataInputStream much too often, and an hdfs tlog data integrity bug.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8575&quot;&gt;&lt;del&gt;SOLR-8575&lt;/del&gt;&lt;/a&gt;: Fix HDFSLogReader replay status numbers and a performance bug where we can reopen FSDataInputStream too often.&lt;/p&gt;</comment>
                            <comment id="15133372" author="anshumg" created="Fri, 5 Feb 2016 00:03:55 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; is the commit supposed to be from the &lt;em&gt;mark dot miller at oblivion dot ch&lt;/em&gt; id ?&lt;/p&gt;</comment>
                            <comment id="15133375" author="markrmiller@gmail.com" created="Fri, 5 Feb 2016 00:07:23 +0000"  >&lt;p&gt;Strange...not what is in my gitconfig. Must be something to do with the INFRA tagging script?&lt;/p&gt;</comment>
                            <comment id="15133377" author="markrmiller@gmail.com" created="Fri, 5 Feb 2016 00:08:32 +0000"  >&lt;p&gt;Probably because my name is not my username, just my email id&apos;s me. I&apos;ll switch the username.&lt;/p&gt;</comment>
                            <comment id="15133382" author="thetaphi" created="Fri, 5 Feb 2016 00:09:41 +0000"  >&lt;p&gt;Where do you see this in this commit? It shows both for author and committer the same &lt;tt&gt;@apache.org&lt;/tt&gt; ID.&lt;/p&gt;</comment>
                            <comment id="15133383" author="thetaphi" created="Fri, 5 Feb 2016 00:10:52 +0000"  >&lt;p&gt;Ah the comment refers wrong JIRA user name! I think thats a bug and INFRA should take care.&lt;/p&gt;</comment>
                            <comment id="15133649" author="anshumg" created="Fri, 5 Feb 2016 04:41:17 +0000"  >&lt;p&gt;Thanks Uwe! &lt;/p&gt;

&lt;p&gt;Do you mean to say there&apos;s already an open issue? or do we need to open another one?&lt;/p&gt;</comment>
                            <comment id="15133772" author="thetaphi" created="Fri, 5 Feb 2016 07:08:18 +0000"  >&lt;p&gt;I think we should contact them or open issue. Maybe they have a &quot;mapping&quot; table (ASF-ID -&amp;gt; JIRA-ID) somewhere.&lt;/p&gt;</comment>
                            <comment id="15134544" author="jira-bot" created="Fri, 5 Feb 2016 17:40:00 +0000"  >&lt;p&gt;Commit ec4c72310f3548b93139b25a12d6e9a16ac9e322 in lucene-solr&apos;s branch refs/heads/lucene-6835 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mark.miller%40oblivion.ch&quot; class=&quot;user-hover&quot; rel=&quot;mark.miller@oblivion.ch&quot;&gt;mark.miller@oblivion.ch&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ec4c723&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ec4c723&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8575&quot; title=&quot;Fix HDFSLogReader replay status numbers, a performance bug where we can reopen FSDataInputStream much too often, and an hdfs tlog data integrity bug.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8575&quot;&gt;&lt;del&gt;SOLR-8575&lt;/del&gt;&lt;/a&gt;: Fix HDFSLogReader replay status numbers and a performance bug where we can reopen FSDataInputStream too often.&lt;/p&gt;</comment>
                            <comment id="15142219" author="yseeley@gmail.com" created="Thu, 11 Feb 2016 04:08:10 +0000"  >&lt;p&gt;I was going to reopen this issue, but it&apos;s still open anyway.&lt;br/&gt;
I&apos;ve changed to a blocker for 5.5 based on what I&apos;m seeing in here:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8586?focusedCommentId=15142215&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15142215&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-8586?focusedCommentId=15142215&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15142215&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15142521" author="mikemccand" created="Thu, 11 Feb 2016 10:25:03 +0000"  >&lt;p&gt;Hmm so it sounds like the changes committed for this issue caused the test failures you&apos;re seeing on &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8586&quot; title=&quot;Implement hash over all documents to check for shard synchronization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8586&quot;&gt;&lt;del&gt;SOLR-8586&lt;/del&gt;&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yseeley%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;yseeley@gmail.com&quot;&gt;yseeley@gmail.com&lt;/a&gt;?  Should we revert the change here until we can explain it?&lt;/p&gt;</comment>
                            <comment id="15142718" author="markrmiller@gmail.com" created="Thu, 11 Feb 2016 13:27:34 +0000"  >&lt;p&gt;Yeah, I would just pull it out of 5.5 rather than try and address it.&lt;/p&gt;</comment>
                            <comment id="15142725" author="jira-bot" created="Thu, 11 Feb 2016 13:32:47 +0000"  >&lt;p&gt;Commit f6098148aed067c06e2459a3ab55abe2e66300b0 in lucene-solr&apos;s branch refs/heads/master from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f609814&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f609814&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8575&quot; title=&quot;Fix HDFSLogReader replay status numbers, a performance bug where we can reopen FSDataInputStream much too often, and an hdfs tlog data integrity bug.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8575&quot;&gt;&lt;del&gt;SOLR-8575&lt;/del&gt;&lt;/a&gt;: Revert while investigated. (reverted from commit ec4c72310f3548b93139b25a12d6e9a16ac9e322)&lt;/p&gt;</comment>
                            <comment id="15142729" author="jira-bot" created="Thu, 11 Feb 2016 13:36:39 +0000"  >&lt;p&gt;Commit 68ba7a5e5275d4ad10e4e8f70e223f9b61d70b54 in lucene-solr&apos;s branch refs/heads/branch_5x from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=68ba7a5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=68ba7a5&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8575&quot; title=&quot;Fix HDFSLogReader replay status numbers, a performance bug where we can reopen FSDataInputStream much too often, and an hdfs tlog data integrity bug.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8575&quot;&gt;&lt;del&gt;SOLR-8575&lt;/del&gt;&lt;/a&gt;: Revert while investigated. (reverted from commit 482b40f841660820f633267a21e6df44aff55346)&lt;/p&gt;</comment>
                            <comment id="15142733" author="jira-bot" created="Thu, 11 Feb 2016 13:40:45 +0000"  >&lt;p&gt;Commit 51257d2ebe099a6c7029e7fd47ce25f4393cfb49 in lucene-solr&apos;s branch refs/heads/branch_5_5 from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=51257d2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=51257d2&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8575&quot; title=&quot;Fix HDFSLogReader replay status numbers, a performance bug where we can reopen FSDataInputStream much too often, and an hdfs tlog data integrity bug.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8575&quot;&gt;&lt;del&gt;SOLR-8575&lt;/del&gt;&lt;/a&gt;: Revert while investigated. (reverted from commit 482b40f841660820f633267a21e6df44aff55346)&lt;/p&gt;</comment>
                            <comment id="15142796" author="mikemccand" created="Thu, 11 Feb 2016 14:29:07 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15143262" author="yseeley@gmail.com" created="Thu, 11 Feb 2016 18:55:18 +0000"  >&lt;p&gt;Here&apos;s an interesting exception I found logged:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  2&amp;gt; 84141 ERROR (recoveryExecutor-132-thread-2-processing-n:127.0.0.1:44435_ x:collection1 s:shard5 c:collection1 r:core_node4) [n:127.0.0.1:44435_ c:collection1 s:shard5 r:core_node4 x:collection1] o.a.s.u.UpdateLog java.io.EOFException
  2&amp;gt; 	at org.apache.solr.common.util.FastInputStream.readByte(FastInputStream.java:207)
  2&amp;gt; 	at org.apache.solr.common.util.JavaBinCodec.readVal(JavaBinCodec.java:207)
  2&amp;gt; 	at org.apache.solr.update.HdfsTransactionLog$HDFSLogReader.next(HdfsTransactionLog.java:419)
  2&amp;gt; 	at org.apache.solr.update.UpdateLog$LogReplayer.doReplay(UpdateLog.java:1333)
  2&amp;gt; 	at org.apache.solr.update.UpdateLog$LogReplayer.run(UpdateLog.java:1255)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;An important part of this patch was recording the amount of data we&apos;ve written so far (as &quot;sz&quot;),&lt;br/&gt;
and then a new input stream is opened.&lt;/p&gt;

&lt;p&gt;Does HDFS guarantee that all data written will be readable if we open the file again (even if we haven&apos;t closed the file)?&lt;br/&gt;
And does read() make the same guarantees about reading at least a single byte (or blocking) unless we&apos;ve reached EOF?&lt;/p&gt;</comment>
                            <comment id="15143938" author="markrmiller@gmail.com" created="Fri, 12 Feb 2016 02:59:06 +0000"  >&lt;p&gt;Here is the patch I&apos;m currently playing with.&lt;/p&gt;

&lt;p&gt;On opening the the Log reader, when we first open the input stream reader, we now hflush before that. In all the fails I was seeing, the starting position was 0 and we were hitting EOF pretty much right away.&lt;/p&gt;

&lt;p&gt;Still testing out, but I think I&apos;m on the right path.&lt;/p&gt;</comment>
                            <comment id="15144592" author="markrmiller@gmail.com" created="Fri, 12 Feb 2016 13:45:40 +0000"  >&lt;p&gt;I&apos;m no longer seeing inconsistency fails with this patch.&lt;/p&gt;</comment>
                            <comment id="15144727" author="markrmiller@gmail.com" created="Fri, 12 Feb 2016 15:43:33 +0000"  >&lt;p&gt;Should also note, latest patch does also include an additional fast stream flushbuffer so that the sz we get is accurate and works with the hflush. I had originally thought that was simply the issue, but still got these EOF fails in the same read method until also changing the constructor.&lt;/p&gt;</comment>
                            <comment id="15144779" author="yseeley@gmail.com" created="Fri, 12 Feb 2016 16:17:41 +0000"  >&lt;p&gt;I&apos;ve started testing this morning with this patch... it will be a few hours at least before I know if it&apos;s fixed for me as well.&lt;/p&gt;

&lt;p&gt;One of the error caused by premature EOF that I was seeing happened after the re-open, so the constructor changes should not matter in that specific fail.&lt;br/&gt;
But an important addition was made in this current patch, which calls fos.flushBuffer() in the reopen... that was missing in the previous patch.&lt;/p&gt;

&lt;p&gt;Actually, it looks like this patch fixed more than just performance... that missing fos.flushBuffer() wasn&apos;t just missing from the previous patch, it was never there in the code to begin with!  This appears to mean that prior to this JIRA, buffering while replaying could sometimes prematurely abort (by getting an EOF) because a partial record was written.  Simply adding a flushBuffer would not have been sufficient though... by using the actual size of the file (unsynchronized) as the point to read up to, we can get premature EOFs as well.  Given we&apos;re using 64K write buffers, the odds of seeing issues due to this is related to the document size being indexed as well as the throughput.&lt;/p&gt;</comment>
                            <comment id="15144808" author="yseeley@gmail.com" created="Fri, 12 Feb 2016 16:35:53 +0000"  >&lt;p&gt;With the latest patch, the flushBuffer in this part of the code is redundant:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; next() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException, InterruptedException {
      &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; pos = fis.position();

      &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (HdfsTransactionLog.&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (trace) {
          log.trace(&lt;span class=&quot;code-quote&quot;&gt;&quot;Reading log record.  pos=&quot;&lt;/span&gt;+pos+&lt;span class=&quot;code-quote&quot;&gt;&quot; currentSize=&quot;&lt;/span&gt;+fos.size());
        }

        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (pos &amp;gt;= fos.size()) {
          &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        }
       
        fos.flushBuffer();
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15144833" author="markrmiller@gmail.com" created="Fri, 12 Feb 2016 16:45:53 +0000"  >&lt;blockquote&gt;&lt;p&gt;Actually, it looks like this patch fixed more than just performance&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right, it&apos;s not just a performance fix or a &apos;status&apos; numbers fix. The issue was the size hdfs was returning to us was wrong and we were going off the wrong size info. That made it so that when we had to open a new reader, we then did so every update. That seems to have hidden some of the issues here. There was no way to know if there was a bug users where hitting here beyond super, super slow replay while buffering performance though. For example, you were not seeing inconsistency fails with that code. It was obviously a bug no matter what flushing happened though, because we were basing our logic on file sizes that did not relate to reality (and did not generally change at all between calls). &lt;/p&gt;</comment>
                            <comment id="15144882" author="yseeley@gmail.com" created="Fri, 12 Feb 2016 17:17:08 +0000"  >&lt;p&gt;Yeah, if HDFS had reported the correct length, the old code (prior to this JIRA) would have attempted to read partial records and get EOFs where it shouldn&apos;t.&lt;/p&gt;

&lt;p&gt;For others following along... the key thing to the current patch is this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (HdfsTransactionLog.&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;) {
          fos.flushBuffer();
          sz = fos.size();
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The synchronization (which is the same monitor used to write records) means that our recorded &quot;sz&quot; represents a whole record and is hence safe to read up to.&lt;/p&gt;</comment>
                            <comment id="15145286" author="jira-bot" created="Fri, 12 Feb 2016 20:58:20 +0000"  >&lt;p&gt;Commit 4cc844897e094ffc07f1825d88730ea975de3fde in lucene-solr&apos;s branch refs/heads/master from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=4cc8448&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=4cc8448&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8575&quot; title=&quot;Fix HDFSLogReader replay status numbers, a performance bug where we can reopen FSDataInputStream much too often, and an hdfs tlog data integrity bug.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8575&quot;&gt;&lt;del&gt;SOLR-8575&lt;/del&gt;&lt;/a&gt;: Fix HDFSLogReader replay status numbers, a performance bug where we can reopen FSDataInputStream much too often, and an hdfs tlog data integrity bug.&lt;/p&gt;</comment>
                            <comment id="15145307" author="yseeley@gmail.com" created="Fri, 12 Feb 2016 21:12:42 +0000"  >&lt;p&gt;Yeah, everything looks good - no consistency fails after running all day!&lt;/p&gt;</comment>
                            <comment id="15145344" author="markrmiller@gmail.com" created="Fri, 12 Feb 2016 21:31:10 +0000"  >&lt;p&gt;I&apos;ll spend a little time trying to get rid of some false chaos monkey test fails so we can keep a better track when things go bad.&lt;/p&gt;</comment>
                            <comment id="15149375" author="mdrob" created="Tue, 16 Feb 2016 21:47:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/lucene-solr/blob/0bba332549a11d5c381efc93a66087999b6de210/solr/core/src/java/org/apache/solr/update/UpdateLog.java#L1443&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/blob/0bba332549a11d5c381efc93a66087999b6de210/solr/core/src/java/org/apache/solr/update/UpdateLog.java#L1443&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Is that line supposed to have an assert on it?&lt;/p&gt;</comment>
                            <comment id="15149378" author="markrmiller@gmail.com" created="Tue, 16 Feb 2016 21:49:30 +0000"  >&lt;p&gt;Yeah, good catch.&lt;/p&gt;</comment>
                            <comment id="15155839" author="jira-bot" created="Sun, 21 Feb 2016 01:35:53 +0000"  >&lt;p&gt;Commit 2fd90cd4893952f5150e34ed70e86d3e85f61458 in lucene-solr&apos;s branch refs/heads/master from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=2fd90cd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=2fd90cd&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8575&quot; title=&quot;Fix HDFSLogReader replay status numbers, a performance bug where we can reopen FSDataInputStream much too often, and an hdfs tlog data integrity bug.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8575&quot;&gt;&lt;del&gt;SOLR-8575&lt;/del&gt;&lt;/a&gt;: Add missing assert.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12787602" name="SOLR-8575.patch" size="20018" author="markrmiller@gmail.com" created="Fri, 12 Feb 2016 02:59:06 +0000"/>
                            <attachment id="12783440" name="SOLR-8575.patch" size="9739" author="markrmiller@gmail.com" created="Wed, 20 Jan 2016 22:23:51 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 39 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2rr2f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>