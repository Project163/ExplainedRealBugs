<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:33:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-4016] Deduplication is broken by partial update</title>
                <link>https://issues.apache.org/jira/browse/SOLR-4016</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;The SignatureUpdateProcessorFactory used (primarily?) for deduplication does not consider partial update semantics.&lt;/p&gt;

&lt;p&gt;The below uses the following solrconfig.xml excerpt:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;     &amp;lt;updateRequestProcessorChain name=&quot;text_hash&quot;&amp;gt;
       &amp;lt;processor class=&quot;solr.processor.SignatureUpdateProcessorFactory&quot;&amp;gt;
         &amp;lt;bool name=&quot;enabled&quot;&amp;gt;true&amp;lt;/bool&amp;gt;
         &amp;lt;str name=&quot;signatureField&quot;&amp;gt;text_hash&amp;lt;/str&amp;gt;
         &amp;lt;bool name=&quot;overwriteDupes&quot;&amp;gt;false&amp;lt;/bool&amp;gt;
         &amp;lt;str name=&quot;fields&quot;&amp;gt;text&amp;lt;/str&amp;gt;
         &amp;lt;str name=&quot;signatureClass&quot;&amp;gt;solr.processor.TextProfileSignature&amp;lt;/str&amp;gt;
       &amp;lt;/processor&amp;gt;
       &amp;lt;processor class=&quot;solr.LogUpdateProcessorFactory&quot; /&amp;gt;
       &amp;lt;processor class=&quot;solr.RunUpdateProcessorFactory&quot; /&amp;gt;
     &amp;lt;/updateRequestProcessorChain&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Firstly, the processor treats &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;{&quot;set&quot;: &quot;value&quot;}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; as a string and hashes it, instead of the value alone:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ curl &apos;$URL/update?commit=true&apos; -H &apos;Content-type:application/json&apos; -d &apos;{&quot;add&quot;:{&quot;doc&quot;:{&quot;id&quot;: &quot;abcde&quot;, &quot;text&quot;: {&quot;set&quot;: &quot;hello world&quot;}}}}&apos; &amp;amp;&amp;amp; curl &apos;$URL/select?q=id:abcde&apos;
{&quot;responseHeader&quot;:{&quot;status&quot;:0,&quot;QTime&quot;:30}}
&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;&amp;lt;response&amp;gt;&amp;lt;lst name=&quot;responseHeader&quot;&amp;gt;&amp;lt;int name=&quot;status&quot;&amp;gt;0&amp;lt;/int&amp;gt;&amp;lt;int name=&quot;QTime&quot;&amp;gt;1&amp;lt;/int&amp;gt;&amp;lt;lst name=&quot;params&quot;&amp;gt;&amp;lt;str name=&quot;q&quot;&amp;gt;id:abcde&amp;lt;/str&amp;gt;&amp;lt;/lst&amp;gt;&amp;lt;/lst&amp;gt;&amp;lt;result name=&quot;response&quot; numFound=&quot;1&quot; start=&quot;0&quot;&amp;gt;&amp;lt;doc&amp;gt;&amp;lt;str name=&quot;id&quot;&amp;gt;abcde&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;text&quot;&amp;gt;hello world&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;text_hash&quot;&amp;gt;ad48c7ad60ac22cc&amp;lt;/str&amp;gt;&amp;lt;long name=&quot;_version_&quot;&amp;gt;1417247434224959488&amp;lt;/long&amp;gt;&amp;lt;/doc&amp;gt;&amp;lt;/result&amp;gt;
&amp;lt;/response&amp;gt;
$
$ curl &apos;$URL/update?commit=true&apos; -H &apos;Content-type:application/json&apos; -d &apos;{&quot;add&quot;:{&quot;doc&quot;:{&quot;id&quot;: &quot;abcde&quot;, &quot;text&quot;: &quot;hello world&quot;}}}&apos; &amp;amp;&amp;amp; curl &apos;$URL/select?q=id:abcde&apos;
{&quot;responseHeader&quot;:{&quot;status&quot;:0,&quot;QTime&quot;:27}}
&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;
&amp;lt;response&amp;gt;
&amp;lt;lst name=&quot;responseHeader&quot;&amp;gt;&amp;lt;int name=&quot;status&quot;&amp;gt;0&amp;lt;/int&amp;gt;&amp;lt;int name=&quot;QTime&quot;&amp;gt;1&amp;lt;/int&amp;gt;&amp;lt;lst name=&quot;params&quot;&amp;gt;&amp;lt;str name=&quot;q&quot;&amp;gt;id:abcde&amp;lt;/str&amp;gt;&amp;lt;/lst&amp;gt;&amp;lt;/lst&amp;gt;&amp;lt;result name=&quot;response&quot; numFound=&quot;1&quot; start=&quot;0&quot;&amp;gt;&amp;lt;doc&amp;gt;&amp;lt;str name=&quot;id&quot;&amp;gt;abcde&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;text&quot;&amp;gt;hello world&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;text_hash&quot;&amp;gt;b169c743d220da8d&amp;lt;/str&amp;gt;&amp;lt;long name=&quot;_version_&quot;&amp;gt;1417248022215000064&amp;lt;/long&amp;gt;&amp;lt;/doc&amp;gt;&amp;lt;/result&amp;gt;
&amp;lt;/response&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note the different text_hash value.&lt;/p&gt;

&lt;p&gt;Secondly, when updating a field other than those used to create the signature (which I imagine is a more common use-case), the signature is recalculated from no values:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ curl &apos;$URL/update?commit=true&apos; -H &apos;Content-type:application/json&apos; -d &apos;{&quot;add&quot;:{&quot;doc&quot;:{&quot;id&quot;: &quot;abcde&quot;, &quot;title&quot;: {&quot;set&quot;: &quot;new title&quot;}}}}&apos; &amp;amp;&amp;amp; curl &apos;$URL/select?q=id:abcde&apos;
{&quot;responseHeader&quot;:{&quot;status&quot;:0,&quot;QTime&quot;:39}}
&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;
&amp;lt;response&amp;gt;
&amp;lt;lst name=&quot;responseHeader&quot;&amp;gt;&amp;lt;int name=&quot;status&quot;&amp;gt;0&amp;lt;/int&amp;gt;&amp;lt;int name=&quot;QTime&quot;&amp;gt;1&amp;lt;/int&amp;gt;&amp;lt;lst name=&quot;params&quot;&amp;gt;&amp;lt;str name=&quot;q&quot;&amp;gt;id:abcde&amp;lt;/str&amp;gt;&amp;lt;/lst&amp;gt;&amp;lt;/lst&amp;gt;&amp;lt;result name=&quot;response&quot; numFound=&quot;1&quot; start=&quot;0&quot;&amp;gt;&amp;lt;doc&amp;gt;&amp;lt;str name=&quot;id&quot;&amp;gt;abcde&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;text&quot;&amp;gt;hello world&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;text_hash&quot;&amp;gt;0000000000000000&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;title&quot;&amp;gt;new title&amp;lt;/str&amp;gt;&amp;lt;long name=&quot;_version_&quot;&amp;gt;1417248120480202752&amp;lt;/long&amp;gt;&amp;lt;/doc&amp;gt;&amp;lt;/result&amp;gt;
&amp;lt;/response&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Tomcat6 / Catalina on Ubuntu 12.04 LTS&lt;/p&gt;</environment>
        <key id="12614012">SOLR-4016</key>
            <summary>Deduplication is broken by partial update</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shalin">Shalin Shekhar Mangar</assignee>
                                    <reporter username="jnothman">Joel Nothman</reporter>
                        <labels>
                            <label>4.0.1_Candidate</label>
                    </labels>
                <created>Tue, 30 Oct 2012 10:55:29 +0000</created>
                <updated>Mon, 9 May 2016 18:53:22 +0000</updated>
                            <resolved>Wed, 16 Jan 2013 04:30:46 +0000</resolved>
                                    <version>4.0</version>
                                    <fixVersion>4.1</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>update</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13539959" author="shalinmangar" created="Thu, 27 Dec 2012 13:52:09 +0000"  >&lt;p&gt;All these problems go away if we add the DistributedUpdateProcessorFactory ahead of all other processors instead of adding it just before RunUpdateProcessorFactory by default.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yonik%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;yonik@apache.org&quot;&gt;yonik@apache.org&lt;/a&gt;, is there a reason why we add DUPF at the last? It seems that other processors such as RegexReplaceProcessorFactory will also be affected.&lt;/p&gt;</comment>
                            <comment id="13540209" author="yseeley@gmail.com" created="Thu, 27 Dec 2012 23:11:40 +0000"  >&lt;p&gt;If the SignatureUpdateProcessorFactory is generating the unique id, it must come before the distributed code&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-2822&quot; title=&quot;don&amp;#39;t run update processors twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-2822&quot;&gt;&lt;del&gt;SOLR-2822&lt;/del&gt;&lt;/a&gt; is a good starting place for related issues / discussions (I know there were more discussions but I can&apos;t find them now).&lt;/p&gt;</comment>
                            <comment id="13542881" author="shalinmangar" created="Thu, 3 Jan 2013 11:59:18 +0000"  >&lt;p&gt;This patch expands the document before computing signature.&lt;/p&gt;

&lt;p&gt;I&apos;m not convinced that it is the right solution. The DUPF gets the updated document in a synchronized (bucket) block which we don&apos;t. We could set the original document back (after adding signature to it) and let DUPF do its thing but that could lead to race conditions.&lt;/p&gt;

&lt;p&gt;Perhaps we should decouple the document expansion for partial updates from DistributedUpdateRequestProcessor and apply it at the start of the request so that all UpdateRequestProcessors can work on the full document.&lt;/p&gt;

&lt;p&gt;I don&apos;t fully comprehend the race conditions that may happen so I&apos;ll let someone more knowledgeable about this code to comment before proceeding any further.&lt;/p&gt;</comment>
                            <comment id="13544521" author="yseeley@gmail.com" created="Sat, 5 Jan 2013 02:15:02 +0000"  >&lt;p&gt;I think we should simply skip the &quot;generate signature&quot; logic of the processor if it&apos;s an atomic update.&lt;/p&gt;

&lt;p&gt;If one did want to do a full-blown solution, one way would probably involve using realtime-get to get the latest version of the document and then use optimistic concurrency when making the update.  But I don&apos;t think it&apos;s that big of a restriction to say that atomic updates won&apos;t change the signature generated.&lt;/p&gt;</comment>
                            <comment id="13545903" author="shalinmangar" created="Mon, 7 Jan 2013 14:10:12 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think we should simply skip the &quot;generate signature&quot; logic of the processor if it&apos;s an atomic update.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I see why you suggested that. The signature is like a unique key and modifying it seems like a rare use-case. But, if we do go that way, we should throw an exception and explicitly disallow partial update of signature generating fields. Otherwise you end up with documents containing a wrong signature.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If one did want to do a full-blown solution, one way would probably involve using realtime-get to get the latest version of the document and then use optimistic concurrency when making the update.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;DUPF code says that it synchronizes on the bucket so that realtime-get works reliably. Is that necessary inside DedupUPF? If so, how do I get access to the VersionInfo? If not, is this  patch an appropriate solution?&lt;/p&gt;</comment>
                            <comment id="13552681" author="shalinmangar" created="Mon, 14 Jan 2013 14:32:47 +0000"  >&lt;p&gt;Patch which disallows partial updates on signature generating fields&lt;/p&gt;</comment>
                            <comment id="13552926" author="shalinmangar" created="Mon, 14 Jan 2013 17:53:35 +0000"  >&lt;p&gt;Patch with a better test.&lt;/p&gt;</comment>
                            <comment id="13552935" author="commit-tag-bot" created="Mon, 14 Jan 2013 18:02:11 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;trunk commit&amp;#93;&lt;/span&gt; Shalin Shekhar Mangar&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1433013&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1433013&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4016&quot; title=&quot;Deduplication is broken by partial update&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4016&quot;&gt;&lt;del&gt;SOLR-4016&lt;/del&gt;&lt;/a&gt;: Deduplication does not work with atomic/partial updates so disallow atomic update requests which change signature generating fields.&lt;/p&gt;</comment>
                            <comment id="13552950" author="yseeley@gmail.com" created="Mon, 14 Jan 2013 18:18:23 +0000"  >&lt;blockquote&gt;&lt;p&gt;I see why you suggested that. The signature is like a unique key and modifying it seems like a rare use-case. But, if we do go that way, we should throw an exception and explicitly disallow partial update of signature generating fields.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;There are different use-cases here.  If the signature being generated was the unique key, then atomic updates should be able to proceed fine as long as the id field is specified (as should always be the case with atomic updates).&lt;/p&gt;</comment>
                            <comment id="13552967" author="shalinmangar" created="Mon, 14 Jan 2013 18:34:11 +0000"  >&lt;blockquote&gt;&lt;p&gt;If the signature being generated was the unique key, then atomic updates should be able to proceed fine as long as the id field is specified (as should always be the case with atomic updates).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The patch that I committed throws an exception if an atomic update request contains fields that are used to compute the signature. An atomic update request which does not modify the signature, proceeds as normal. This way we make sure that a document never contains a wrong signature.&lt;/p&gt;

&lt;p&gt;Do you agree that this is an acceptable compromise until a proper fix is in place?&lt;/p&gt;</comment>
                            <comment id="13554024" author="commit-tag-bot" created="Tue, 15 Jan 2013 17:24:09 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;branch_4x commit&amp;#93;&lt;/span&gt; Shalin Shekhar Mangar&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1433530&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1433530&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4016&quot; title=&quot;Deduplication is broken by partial update&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4016&quot;&gt;&lt;del&gt;SOLR-4016&lt;/del&gt;&lt;/a&gt;: Deduplication does not work with atomic/partial updates so disallow atomic update requests which change signature generating fields.&lt;/p&gt;</comment>
                            <comment id="13554537" author="steve_rowe" created="Tue, 15 Jan 2013 23:52:26 +0000"  >&lt;p&gt;Shalin, this can be resolved as fixed, right?&lt;/p&gt;</comment>
                            <comment id="13554733" author="shalinmangar" created="Wed, 16 Jan 2013 04:30:46 +0000"  >&lt;p&gt;Fixed in 4.1 and trunk.&lt;/p&gt;

&lt;p&gt;Thanks Joel and Yonik.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12556706">SOLR-3473</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12564742" name="SOLR-4016-disallow-partial-update.patch" size="8066" author="shalin" created="Mon, 14 Jan 2013 17:53:35 +0000"/>
                            <attachment id="12564711" name="SOLR-4016-disallow-partial-update.patch" size="3425" author="shalin" created="Mon, 14 Jan 2013 14:32:47 +0000"/>
                            <attachment id="12563067" name="SOLR-4016.patch" size="11126" author="shalin" created="Thu, 3 Jan 2013 11:59:18 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>253127</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 44 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0dbpz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>75828</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>