<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:06:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-7673] Race condition in shard splitting can cause operation to hang indefinitely or sub-shards to never become active</title>
                <link>https://issues.apache.org/jira/browse/SOLR-7673</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;I found this while digging into the failure on &lt;a href=&quot;https://builds.apache.org/job/Lucene-Solr-Tests-trunk-Java8/69/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Lucene-Solr-Tests-trunk-Java8/69/&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;   [junit4]   2&amp;gt; 390032 INFO  (OverseerStateUpdate-93987739315601411-127.0.0.1:57926_-n_0000000000) [n:127.0.0.1:57926_    ] o.a.s.c.o.ReplicaMutator Update state numShards=1 message={
   [junit4]   2&amp;gt;   &lt;span class=&quot;code-quote&quot;&gt;&quot;core&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;testasynccollectioncreation_shard1_0_replica2&quot;&lt;/span&gt;,
   [junit4]   2&amp;gt;   &lt;span class=&quot;code-quote&quot;&gt;&quot;core_node_name&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;core_node5&quot;&lt;/span&gt;,
   [junit4]   2&amp;gt;   &lt;span class=&quot;code-quote&quot;&gt;&quot;roles&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;,
   [junit4]   2&amp;gt;   &lt;span class=&quot;code-quote&quot;&gt;&quot;base_url&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//127.0.0.1:38702&quot;&lt;/span&gt;,
&lt;/span&gt;   [junit4]   2&amp;gt;   &lt;span class=&quot;code-quote&quot;&gt;&quot;node_name&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;127.0.0.1:38702_&quot;&lt;/span&gt;,
   [junit4]   2&amp;gt;   &lt;span class=&quot;code-quote&quot;&gt;&quot;numShards&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;,
   [junit4]   2&amp;gt;   &lt;span class=&quot;code-quote&quot;&gt;&quot;state&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;active&quot;&lt;/span&gt;,
   [junit4]   2&amp;gt;   &lt;span class=&quot;code-quote&quot;&gt;&quot;shard&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;shard1_0&quot;&lt;/span&gt;,
   [junit4]   2&amp;gt;   &lt;span class=&quot;code-quote&quot;&gt;&quot;collection&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;testasynccollectioncreation&quot;&lt;/span&gt;,
   [junit4]   2&amp;gt;   &lt;span class=&quot;code-quote&quot;&gt;&quot;operation&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;state&quot;&lt;/span&gt;}
   [junit4]   2&amp;gt; 390033 INFO  (OverseerStateUpdate-93987739315601411-127.0.0.1:57926_-n_0000000000) [n:127.0.0.1:57926_    ] o.a.s.c.o.ZkStateWriter going to update_collection /collections/testasynccollectioncreation/state.json version: 18
   [junit4]   2&amp;gt; 390033 INFO  (RecoveryThread-testasynccollectioncreation_shard1_0_replica2) [n:127.0.0.1:38702_ c:testasynccollectioncreation s:shard1_0 r:core_node5 x:testasynccollectioncreation_shard1_0_replica2] o.a.s.u.UpdateLog Took 2 ms to seed version buckets with highest version 1503803851028824064
   [junit4]   2&amp;gt; 390033 INFO  (zkCallback-167-thread-1-processing-n:127.0.0.1:57926_) [n:127.0.0.1:57926_    ] o.a.s.c.c.ZkStateReader A cluster state change: WatchedEvent state:SyncConnected type:NodeDataChanged path:/collections/testasynccollectioncreation/state.json &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; collection testasynccollectioncreation has occurred - updating... (live nodes size: 2)
   [junit4]   2&amp;gt; 390033 INFO  (RecoveryThread-testasynccollectioncreation_shard1_0_replica2) [n:127.0.0.1:38702_ c:testasynccollectioncreation s:shard1_0 r:core_node5 x:testasynccollectioncreation_shard1_0_replica2] o.a.s.c.RecoveryStrategy Finished recovery process.
   [junit4]   2&amp;gt; 390033 INFO  (zkCallback-173-thread-1-processing-n:127.0.0.1:38702_) [n:127.0.0.1:38702_    ] o.a.s.c.c.ZkStateReader A cluster state change: WatchedEvent state:SyncConnected type:NodeDataChanged path:/collections/testasynccollectioncreation/state.json &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; collection testasynccollectioncreation has occurred - updating... (live nodes size: 2)
   [junit4]   2&amp;gt; 390034 INFO  (zkCallback-167-thread-1-processing-n:127.0.0.1:57926_) [n:127.0.0.1:57926_    ] o.a.s.c.c.ZkStateReader Updating data &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; testasynccollectioncreation to ver 19 
   [junit4]   2&amp;gt; 390034 INFO  (zkCallback-173-thread-1-processing-n:127.0.0.1:38702_) [n:127.0.0.1:38702_    ] o.a.s.c.c.ZkStateReader Updating data &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; testasynccollectioncreation to ver 19 
   [junit4]   2&amp;gt; 390298 INFO  (qtp1859109869-1664) [n:127.0.0.1:38702_    ] o.a.s.h.a.CollectionsHandler Invoked Collection Action :requeststatus with paramsrequestid=1004&amp;amp;action=REQUESTSTATUS&amp;amp;wt=javabin&amp;amp;version=2 
   [junit4]   2&amp;gt; 390299 INFO  (qtp1859109869-1664) [n:127.0.0.1:38702_    ] o.a.s.s.SolrDispatchFilter [admin] webapp=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; path=/admin/collections params={requestid=1004&amp;amp;action=REQUESTSTATUS&amp;amp;wt=javabin&amp;amp;version=2} status=0 QTime=1 
   [junit4]   2&amp;gt; 390348 INFO  (qtp1859109869-1665) [n:127.0.0.1:38702_    ] o.a.s.h.a.CoreAdminHandler Checking request status &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; : 10042599422118342586
   [junit4]   2&amp;gt; 390348 INFO  (qtp1859109869-1665) [n:127.0.0.1:38702_    ] o.a.s.s.SolrDispatchFilter [admin] webapp=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; path=/admin/cores params={qt=/admin/cores&amp;amp;requestid=10042599422118342586&amp;amp;action=REQUESTSTATUS&amp;amp;wt=javabin&amp;amp;version=2} status=0 QTime=1 
   [junit4]   2&amp;gt; 390348 INFO  (OverseerThreadFactory-891-thread-4-processing-n:127.0.0.1:57926_) [n:127.0.0.1:57926_    ] o.a.s.c.OverseerCollectionProcessor Asking sub shard leader to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;: testasynccollectioncreation_shard1_0_replica2 to be alive on: 127.0.0.1:38702_
   [junit4]   2&amp;gt; 390349 INFO  (OverseerThreadFactory-891-thread-4-processing-n:127.0.0.1:57926_) [n:127.0.0.1:57926_    ] o.a.s.c.OverseerCollectionProcessor Creating replica shard testasynccollectioncreation_shard1_1_replica2 as part of slice shard1_1 of collection testasynccollectioncreation on 127.0.0.1:38702_
   [junit4]   2&amp;gt; 390349 INFO  (OverseerThreadFactory-891-thread-4-processing-n:127.0.0.1:57926_) [n:127.0.0.1:57926_    ] o.a.s.c.c.ZkStateReader Load collection config from:/collections/testasynccollectioncreation
   [junit4]   2&amp;gt; 390350 INFO  (OverseerThreadFactory-891-thread-4-processing-n:127.0.0.1:57926_) [n:127.0.0.1:57926_    ] o.a.s.c.c.ZkStateReader path=/collections/testasynccollectioncreation configName=conf1 specified config exists in ZooKeeper
   [junit4]   2&amp;gt; 390352 INFO  (qtp381614561-1631) [n:127.0.0.1:57926_    ] o.a.s.s.SolrDispatchFilter [admin] webapp=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; path=/admin/cores params={nodeName=127.0.0.1:38702_&amp;amp;core=testasynccollectioncreation_shard1_0_replica1&amp;amp;async=10042599424132346542&amp;amp;qt=/admin/cores&amp;amp;coreNodeName=core_node5&amp;amp;action=PREPRECOVERY&amp;amp;checkLive=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;state=recovering&amp;amp;onlyIfLeader=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;wt=javabin&amp;amp;version=2} status=0 QTime=2 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The following sequence of events lead to deadlock:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;testasynccollectioncreation_shard1_0_replica2 (core_node5) becomes active&lt;/li&gt;
	&lt;li&gt;OCP asks sub-shard leader testasynccollectioncreation_shard1_0_replica1  to wait until replica2 is in recovery&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;At this point, the test just keeps pinging for status until timeout and fails.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12837512">SOLR-7673</key>
            <summary>Race condition in shard splitting can cause operation to hang indefinitely or sub-shards to never become active</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shalin">Shalin Shekhar Mangar</assignee>
                                    <reporter username="shalin">Shalin Shekhar Mangar</reporter>
                        <labels>
                    </labels>
                <created>Fri, 12 Jun 2015 21:17:16 +0000</created>
                <updated>Mon, 9 May 2016 18:45:24 +0000</updated>
                            <resolved>Tue, 30 Jun 2015 08:52:05 +0000</resolved>
                                    <version>4.10.4</version>
                    <version>5.2</version>
                                    <fixVersion>5.3</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14584102" author="shalinmangar" created="Fri, 12 Jun 2015 21:19:49 +0000"  >&lt;p&gt;Attaching full log from the jenkins failure.&lt;/p&gt;</comment>
                            <comment id="14584143" author="shalinmangar" created="Fri, 12 Jun 2015 21:46:56 +0000"  >&lt;p&gt;I think there is another race condition. For example, we update the shard state to recovery &lt;b&gt;after&lt;/b&gt; adding a replica but if in the meantime the replica becomes active, the slice won&apos;t be set to &quot;active&quot; anytime soon.&lt;/p&gt;</comment>
                            <comment id="14607886" author="shalinmangar" created="Tue, 30 Jun 2015 07:40:53 +0000"  >&lt;p&gt;Here&apos;s a patch which fixes both the race conditions.&lt;/p&gt;

&lt;p&gt;This patch creates the replicas in cluster state first (by submitting an addreplica command to the overseer queue), then it calls updateshardstate to set the sub-slices to &apos;recovery&apos; state and then it invokes addreplica action to actually create the replica cores.&lt;/p&gt;

&lt;p&gt;A new flag called &quot;skipCreateReplicaInClusterState&quot; is added to the addreplica action so that OCP doesn&apos;t try to create the replica in cluster state again. This is a hack to avoid duplicating most of the logic of addreplica inside splitshard and I&apos;ve put in comments to this effect. I did not want to perform potentially dangerous refactoring as part of this bug fix but once this is committed, we can open a separate issue just to refactor OCP.&lt;/p&gt;

&lt;p&gt;I&apos;ve been beasting this test quite a bit and haven&apos;t been able to reproduce the failures.&lt;/p&gt;</comment>
                            <comment id="14607939" author="jira-bot" created="Tue, 30 Jun 2015 08:27:52 +0000"  >&lt;p&gt;Commit 1688396 from shalin@apache.org in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1688396&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1688396&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7673&quot; title=&quot;Race condition in shard splitting can cause operation to hang indefinitely or sub-shards to never become active&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7673&quot;&gt;&lt;del&gt;SOLR-7673&lt;/del&gt;&lt;/a&gt;: Race condition in shard splitting can cause operation to hang indefinitely or sub-shards to never become active&lt;/p&gt;</comment>
                            <comment id="14607967" author="jira-bot" created="Tue, 30 Jun 2015 08:51:08 +0000"  >&lt;p&gt;Commit 1688404 from shalin@apache.org in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1688404&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1688404&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7673&quot; title=&quot;Race condition in shard splitting can cause operation to hang indefinitely or sub-shards to never become active&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7673&quot;&gt;&lt;del&gt;SOLR-7673&lt;/del&gt;&lt;/a&gt;: Race condition in shard splitting can cause operation to hang indefinitely or sub-shards to never become active&lt;/p&gt;</comment>
                            <comment id="14713340" author="shalinmangar" created="Wed, 26 Aug 2015 13:06:29 +0000"  >&lt;p&gt;Bulk close for 5.3.0 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12739334" name="Lucene-Solr-Tests-trunk-Java8-69.log" size="1369907" author="shalin" created="Fri, 12 Jun 2015 21:19:49 +0000"/>
                            <attachment id="12742734" name="SOLR-7673.patch" size="13089" author="shalin" created="Tue, 30 Jun 2015 07:40:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 12 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2fzqv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>