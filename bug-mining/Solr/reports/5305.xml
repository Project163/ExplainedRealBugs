<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:12:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-17831] ExitableDirectoryReader always initialized with QueryLimits.NONE</title>
                <link>https://issues.apache.org/jira/browse/SOLR-17831</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman&quot; class=&quot;user-hover&quot; rel=&quot;hossman&quot;&gt;hossman&lt;/a&gt; discovered that when the system property &lt;tt&gt;solr.useExitableDirectoryReader&lt;/tt&gt; is set to true then &lt;tt&gt;SolrIndexSearcher&lt;/tt&gt; is supposed to always wrap the current index reader with &lt;tt&gt;ExitableDirectoryReader&lt;/tt&gt; and make it use the &lt;tt&gt;QueryLimits.getCurrentLimits()&lt;/tt&gt; configuration, which should contain the limits configuration taken from the current query context (&lt;tt&gt;SolrRequestInfo.getRequestInfo&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;However, the code mistakenly invokes &lt;tt&gt;QueryLimits.getCurrentLimits()&lt;/tt&gt; directly in the wrapping method, when the query context is always empty. As a result, the &lt;tt&gt;ExitableDirectoryReader&lt;/tt&gt; was always configured with &lt;tt&gt;QueryLimits.NONE&lt;/tt&gt; which made its use pointless and misleading.&lt;/p&gt;

&lt;p&gt;The key change necessary to fix this bug is a one-liner:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
diff --git a/solr/core/src/java/org/apache/solr/search/SolrIndexSearcher.java b/solr/core/src/java/org/apache/solr/search/SolrIndexSearcher.java
index f4d0304ec3..e12d54eb9f 100644
--- a/solr/core/src/java/org/apache/solr/search/SolrIndexSearcher.java
+++ b/solr/core/src/java/org/apache/solr/search/SolrIndexSearcher.java
@@ -214,7 +214,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;SolrIndexSearcher &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; IndexSearcher &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Closeable, SolrI
     &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; reader != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
     reader = UninvertingReader.wrap(reader, core.getLatestSchema().getUninversionMapper());
     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (useExitableDirectoryReader) { &lt;span class=&quot;code-comment&quot;&gt;// SOLR-16693 legacy; may be removed.  Probably inefficient.
&lt;/span&gt;-      reader = ExitableDirectoryReader.wrap(reader, QueryLimits.getCurrentLimits());
+      reader = ExitableDirectoryReader.wrap(reader, () -&amp;gt; QueryLimits.getCurrentLimits().shouldExit());
     }
     &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; reader;
   }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;However, due to the way this property is initialized (statically during class-loading of &lt;tt&gt;SolrIndexSearcher&lt;/tt&gt;) it&apos;s nearly impossible to actually test its impact. That&apos;s also the reason this bug survived so long &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;&lt;/p&gt;

&lt;p&gt;So in addition to the fix above I propose to move the initialization of this property to a different object (e.g. SolrCore?) which can then be reinitialized without exiting the JVM. There are helper classes (&lt;tt&gt;CallerSpecificQueryLimit&lt;/tt&gt; that can be used to test exactly where the limits were tripped.&lt;/p&gt;

&lt;p&gt;Also, I&apos;d like to reword the comment referring to &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16693&quot; title=&quot;Use TimeLimitingBulkScorer; stop using ExitableDirectoryReader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16693&quot;&gt;&lt;del&gt;SOLR-16693&lt;/del&gt;&lt;/a&gt; - until we come up with a better alternative, using &lt;tt&gt;ExitableDirectoryReader&lt;/tt&gt; is sometimes the only way to prevent Solr from getting stuck in a tight loop, either due to buggy components or due to the actual complexity of the query. Higher-level limit checks in SearchHandler or in individual SearchComponents can&apos;t break these lower-level loops and thus cannot prevent runaway queries. Also, performance impact of using &lt;tt&gt;ExitableDirectoryReader&lt;/tt&gt; hasn&apos;t been quantified.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13624897">SOLR-17831</key>
            <summary>ExitableDirectoryReader always initialized with QueryLimits.NONE</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ab">Andrzej Bialecki</assignee>
                                    <reporter username="ab">Andrzej Bialecki</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 29 Jul 2025 13:34:56 +0000</created>
                <updated>Fri, 1 Aug 2025 14:14:41 +0000</updated>
                            <resolved>Fri, 1 Aug 2025 14:14:41 +0000</resolved>
                                    <version>9.9</version>
                                    <fixVersion>9.9.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="6000">1h 40m</timespent>
                                <comments>
                            <comment id="18010710" author="hossman" created="Tue, 29 Jul 2025 16:42:32 +0000"  >&lt;blockquote&gt;&lt;p&gt;So in addition to the fix above I propose to move the initialization of this property to a different object (e.g. SolrCore?) which can then be reinitialized without exiting the JVM. There are helper classes (&lt;tt&gt;CallerSpecificQueryLimit&lt;/tt&gt; that can be used to test exactly where the limits were tripped.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Or at the very least, switch from a &lt;tt&gt;private static final boolean useExitableDirectoryReader = ...&lt;/tt&gt; to a &lt;tt&gt;private final boolean useExitableDirectoryReader ...&lt;/tt&gt; so that the system property gets re-read for every new &lt;tt&gt;SolrIndexSearcher&lt;/tt&gt; ... that way tests can modify the system property.&lt;/p&gt;</comment>
                            <comment id="18011414" author="jira-bot" created="Fri, 1 Aug 2025 11:33:13 +0000"  >&lt;p&gt;Commit 199eed9454bccad5f0817241d7223fdc921f54b0 in solr&apos;s branch refs/heads/main from Andrzej Bialecki&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=199eed9454b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=199eed9454b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17831&quot; title=&quot;ExitableDirectoryReader always initialized with QueryLimits.NONE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17831&quot;&gt;&lt;del&gt;SOLR-17831&lt;/del&gt;&lt;/a&gt;: Fix the bug in QueryLimits initialization in SolrIndexSearcher. (#3446)&lt;/p&gt;
</comment>
                            <comment id="18011440" author="jira-bot" created="Fri, 1 Aug 2025 13:59:36 +0000"  >&lt;p&gt;Commit e7fffd9ee6b73ebe2c62f3f042f25deff127b5fd in solr&apos;s branch refs/heads/branch_9_9 from Andrzej Bialecki&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=e7fffd9ee6b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=e7fffd9ee6b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17831&quot; title=&quot;ExitableDirectoryReader always initialized with QueryLimits.NONE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17831&quot;&gt;&lt;del&gt;SOLR-17831&lt;/del&gt;&lt;/a&gt;: Fix the bug in QueryLimits initialization in SolrIndexSearcher. (#3449)&lt;/p&gt;

&lt;p&gt;Cherry-pick from PR #3446.&lt;/p&gt;</comment>
                            <comment id="18011443" author="jira-bot" created="Fri, 1 Aug 2025 14:14:12 +0000"  >&lt;p&gt;Commit 276b6109766ff83ee774eb5c282de811a4ca8772 in solr&apos;s branch refs/heads/branch_9x from Andrzej Bialecki&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=276b6109766&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=276b6109766&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17831&quot; title=&quot;ExitableDirectoryReader always initialized with QueryLimits.NONE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17831&quot;&gt;&lt;del&gt;SOLR-17831&lt;/del&gt;&lt;/a&gt;: Fix the bug in QueryLimits initialization in SolrIndexSearcher. (#3448)&lt;/p&gt;

&lt;p&gt;Cherry-pick from PR #3446.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1x040:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>