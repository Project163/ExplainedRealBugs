<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:45:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-14897] HttpSolrCall will forward a virtually unlimited number of times until ClusterState ZkWatcher is updated after collection delete</title>
                <link>https://issues.apache.org/jira/browse/SOLR-14897</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;While investigating the root cause of some &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14896&quot; title=&quot;jetty &amp;quot;Bad Message 400&amp;quot; / &amp;quot;Illegal character&amp;quot; responses to sporadic requests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14896&quot;&gt;&lt;del&gt;SOLR-14896&lt;/del&gt;&lt;/a&gt; related failures, I have seen evidence that if a collection is deleted, but a client makes a subequent request for that collection &lt;em&gt;before&lt;/em&gt; the local ClusterState has been updated to remove that DocCollection, HttpSolrCall will forward/proxy that request a (virtually) unbounded number of times in a very short time period - stopping only once the the &quot;cached&quot; local DocCollection is updated to indicate there are no active replicas.**&lt;/p&gt;

&lt;p&gt;While HttpSolrCall does track &amp;amp; increment a &lt;tt&gt;_forwardedCount&lt;/tt&gt; param on every request it forwards, it doesn&apos;t consult that request unless/until it finds a situation where the (local) DocCollection says there are no active replicas.&lt;/p&gt;

&lt;p&gt;So if you have a collection XX with 4 total replicas on 4 diff nodes (A,B,C,D), and and you delete XX (triggering sequential core deletions on A,B,C,D that fire successive ZkWatchers on various nodes to update the collection state) a request for XX can bounce back and forth between nodes C &amp;amp; D 20+ times until the ClusterState watcher fires on both of those nodes so they finally realize that the &lt;tt&gt;_forwardedCount=20&lt;/tt&gt; is more the the 0 active replicas...&lt;/p&gt;

&lt;p&gt;In the below code snippet from HttpSolrCall, the first call to &lt;tt&gt;getCoreUrl(...)&lt;/tt&gt; is expected to return null if there are no active replicas - but it uses the local cached DocCollection, which may &lt;em&gt;think&lt;/em&gt; there is an active replica on another node, so it forwards the request to that node - where the replica may have been deleted, so that node runs hte same code and may forward the request right back to the original node....&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; coreUrl = getCoreUrl(collectionName, origCorename, clusterState,
        activeSlices, byCoreName, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);

    &lt;span class=&quot;code-comment&quot;&gt;// Avoid getting into a recursive loop of requests being forwarded by
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// stopping forwarding and erroring out after (totalReplicas) forwards
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (coreUrl == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (queryParams.getInt(INTERNAL_REQUEST_COUNT, 0) &amp;gt; totalReplicas){
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SolrException(SolrException.ErrorCode.INVALID_STATE,
            &lt;span class=&quot;code-quote&quot;&gt;&quot;No active replicas found &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; collection: &quot;&lt;/span&gt; + collectionName);
      }
      coreUrl = getCoreUrl(collectionName, origCorename, clusterState,
          activeSlices, byCoreName, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;..the check that is suppose to prevent a &quot;recursive loop&quot; is only consulted once a situation arises where local ClusterState indicates there are no active replicas - which seems to defeat the point of the forward check?&#160; (at which point if the total number of replicas hasn&apos;t been exceeded, the code is happy to forward the request to a coreUrl which the local ClusterState indicates is &lt;em&gt;not&lt;/em&gt; active (which also sems to defeat the point?)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13329502">SOLR-14897</key>
            <summary>HttpSolrCall will forward a virtually unlimited number of times until ClusterState ZkWatcher is updated after collection delete</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="munendrasn">Munendra S N</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Sat, 26 Sep 2020 00:15:49 +0000</created>
                <updated>Fri, 9 Oct 2020 15:52:11 +0000</updated>
                            <resolved>Tue, 29 Sep 2020 14:49:42 +0000</resolved>
                                                    <fixVersion>8.6.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17202471" author="hossman" created="Sat, 26 Sep 2020 00:33:10 +0000"  >&lt;p&gt;As an example, here is the output of running &lt;tt&gt;grep sigtest-c7cfa75ce_recs_aggr | grep -e INFO -e &apos;HttpChannel REQUEST&apos; -e &apos;HttpChannel action COMPLETE&apos;&lt;/tt&gt; over a solr log where jetty level DEBUGing was turned on to help diagnose &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14896&quot; title=&quot;jetty &amp;quot;Bad Message 400&amp;quot; / &amp;quot;Illegal character&amp;quot; responses to sporadic requests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14896&quot;&gt;&lt;del&gt;SOLR-14896&lt;/del&gt;&lt;/a&gt; (with my commentary interspersed, but no lines removed)&lt;/p&gt;

&lt;p&gt;It&apos;s useful to note while lookng at this log, that the &apos;sigtest-c7cfa75ce_recs_aggr&apos; only ever had 2 shards, with 2 replicas each...&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2020-09-25 06:02:59.175 DEBUG (qtp1800649922-102) [   ] o.e.j.s.HttpChannel REQUEST for //dzmitry-solr-1.dzmitry-solr-headless:8983/solr/admin/collections?&amp;amp;json.nl=map&amp;amp;indent=true&amp;amp;name=sigtest-c7cfa75ce_recs_aggr&amp;amp;action=DELETE&amp;amp;wt=json on HttpChannelOverHttp@dd53d71{s=HttpChannelState@56b5eeb8{s=IDLE rs=BLOCKING os=OPEN is=IDLE awp=false se=false i=true al=0},r=3,c=false/false,a=IDLE,uri=//dzmitry-solr-1.dzmitry-solr-headless:8983/solr/admin/collections?&amp;amp;json.nl=map&amp;amp;indent=true&amp;amp;name=sigtest-c7cfa75ce_recs_aggr&amp;amp;action=DELETE&amp;amp;wt=json,age=0}
2020-09-25 06:02:59.176 INFO  (qtp1800649922-102) [   ] o.a.s.h.a.CollectionsHandler Invoked Collection Action :delete with params json.nl=map&amp;amp;indent=true&amp;amp;name=sigtest-c7cfa75ce_recs_aggr&amp;amp;action=DELETE&amp;amp;wt=json and sendToOCPQueue=true
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This node happens to be the one that receives the DELETE COLLECTION request for &lt;tt&gt;sigtest-c7cfa75ce_recs_aggr&lt;/tt&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2020-09-25 06:02:59.191 INFO  (qtp1800649922-15) [   x:sigtest-c7cfa75ce_recs_aggr_shard1_replica_n2] o.a.s.m.SolrMetricManager Closing metric reporters for registry=solr.core.sigtest-c7cfa75ce_recs_aggr.shard1.replica_n2 tag=null
2020-09-25 06:02:59.191 INFO  (qtp1800649922-15) [   x:sigtest-c7cfa75ce_recs_aggr_shard1_replica_n2] o.a.s.m.r.SolrJmxReporter Closing reporter [org.apache.solr.metrics.reporters.SolrJmxReporter@17e0cfa2: rootName = null, domain = solr.core.sigtest-c7cfa75ce_recs_aggr.shard1.replica_n2, service url = null, agent id = null] for registry solr.core.sigtest-c7cfa75ce_recs_aggr.shard1.replica_n2/com.codahale.metrics.MetricRegistry@553013e1
2020-09-25 06:02:59.194 INFO  (qtp1800649922-15) [   ] o.a.s.c.SolrCore [sigtest-c7cfa75ce_recs_aggr_shard1_replica_n2]  CLOSING SolrCore org.apache.solr.core.SolrCore@3f6d08b8
2020-09-25 06:02:59.194 INFO  (qtp1800649922-15) [   ] o.a.s.m.SolrMetricManager Closing metric reporters for registry=solr.core.sigtest-c7cfa75ce_recs_aggr.shard1.replica_n2 tag=SolrCore@3f6d08b8
2020-09-25 06:02:59.194 INFO  (qtp1800649922-15) [   ] o.a.s.m.SolrMetricManager Closing metric reporters for registry=solr.collection.sigtest-c7cfa75ce_recs_aggr.shard1.leader tag=SolrCore@3f6d08b8
2020-09-25 06:02:59.199 INFO  (qtp1800649922-15) [   ] o.a.s.c.ZkShardTerms Successful update of terms at /collections/sigtest-c7cfa75ce_recs_aggr/terms/shard1 to Terms{values={core_node3=0}, version=2}
2020-09-25 06:02:59.204 INFO  (qtp1800649922-15) [   ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/cores params={deleteInstanceDir=true&amp;amp;deleteMetricsHistory=true&amp;amp;core=sigtest-c7cfa75ce_recs_aggr_shard1_replica_n2&amp;amp;qt=/admin/cores&amp;amp;deleteDataDir=true&amp;amp;action=UNLOAD&amp;amp;wt=javabin&amp;amp;version=2} status=0 QTime=14
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;...it also hosts a replica of the collection, and within 30ms of the DELETE COLLECTION request has fully unloaded it&apos;s local core.&lt;/p&gt;

&lt;p&gt;...BUT...&lt;/p&gt;

&lt;p&gt;...we still haven&apos;t seen any ZkWatchers (locally) fire for this collection yet, and we&apos;re about to be forwarded a /select request by some other node (that seem to think our replica is alive) ...&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2020-09-25 06:02:59.243 DEBUG (qtp1800649922-15) [   ] o.e.j.s.HttpChannel REQUEST for //dzmitry-solr-1.dzmitry-solr-headless:8983/solr/sigtest-c7cfa75ce_recs_aggr/select?_forwardedCount=1 on HttpChannelOverHttp@349d7280{s=HttpChannelState@48bf7d7e{s=IDLE rs=BLOCKING os=OPEN is=IDLE awp=false se=false i=true al=0},r=155,c=false/false,a=IDLE,uri=//dzmitry-solr-1.dzmitry-solr-headless:8983/solr/sigtest-c7cfa75ce_recs_aggr/select?_forwardedCount=1,age=0}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Since we don&apos;t have a core for that collection, we (evidently) forward it to someone else using &lt;tt&gt;_forwardCount=2&lt;/tt&gt; &#8211; who forwards it right back to us.&lt;/p&gt;

&lt;p&gt;this repeats for a while, involving at least 2 other nodes (because we don&apos;t get &quot;every other&quot; numbered forward) ...&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2020-09-25 06:02:59.250 DEBUG (qtp1800649922-19) [   ] o.e.j.s.HttpChannel REQUEST for //dzmitry-solr-1.dzmitry-solr-headless:8983/solr/sigtest-c7cfa75ce_recs_aggr/select?_forwardedCount=3 on HttpChannelOverHttp@1e1c0a8{s=HttpChannelState@5050c26b{s=IDLE rs=BLOCKING os=OPEN is=IDLE awp=false se=false i=true al=0},r=95,c=false/false,a=IDLE,uri=//dzmitry-solr-1.dzmitry-solr-headless:8983/solr/sigtest-c7cfa75ce_recs_aggr/select?_forwardedCount=3,age=0}
2020-09-25 06:02:59.274 DEBUG (qtp1800649922-18) [   ] o.e.j.s.HttpChannel REQUEST for //dzmitry-solr-1.dzmitry-solr-headless:8983/solr/sigtest-c7cfa75ce_recs_aggr/select?_forwardedCount=10 on HttpChannelOverHttp@73304bea{s=HttpChannelState@19accdca{s=IDLE rs=BLOCKING os=OPEN is=IDLE awp=false se=false i=true al=0},r=105,c=false/false,a=IDLE,uri=//dzmitry-solr-1.dzmitry-solr-headless:8983/solr/sigtest-c7cfa75ce_recs_aggr/select?_forwardedCount=10,age=0}
2020-09-25 06:02:59.280 DEBUG (qtp1800649922-205) [   ] o.e.j.s.HttpChannel REQUEST for //dzmitry-solr-1.dzmitry-solr-headless:8983/solr/sigtest-c7cfa75ce_recs_aggr/select?_forwardedCount=12 on HttpChannelOverHttp@60d2652d{s=HttpChannelState@6702b72b{s=IDLE rs=BLOCKING os=OPEN is=IDLE awp=false se=false i=true al=0},r=4,c=false/false,a=IDLE,uri=//dzmitry-solr-1.dzmitry-solr-headless:8983/solr/sigtest-c7cfa75ce_recs_aggr/select?_forwardedCount=12,age=0}
2020-09-25 06:02:59.296 DEBUG (qtp1800649922-100) [   ] o.e.j.s.HttpChannel REQUEST for //dzmitry-solr-1.dzmitry-solr-headless:8983/solr/sigtest-c7cfa75ce_recs_aggr/select?_forwardedCount=17 on HttpChannelOverHttp@3cf825c0{s=HttpChannelState@148e5cb0{s=IDLE rs=BLOCKING os=OPEN is=IDLE awp=false se=false i=true al=0},r=22,c=false/false,a=IDLE,uri=//dzmitry-solr-1.dzmitry-solr-headless:8983/solr/sigtest-c7cfa75ce_recs_aggr/select?_forwardedCount=17,age=0}
2020-09-25 06:02:59.304 DEBUG (qtp1800649922-24) [   ] o.e.j.s.HttpChannel REQUEST for //dzmitry-solr-1.dzmitry-solr-headless:8983/solr/sigtest-c7cfa75ce_recs_aggr/select?_forwardedCount=19 on HttpChannelOverHttp@117eb506{s=HttpChannelState@4b93cdac{s=IDLE rs=BLOCKING os=OPEN is=IDLE awp=false se=false i=true al=0},r=1,c=false/false,a=IDLE,uri=//dzmitry-solr-1.dzmitry-solr-headless:8983/solr/sigtest-c7cfa75ce_recs_aggr/select?_forwardedCount=19,age=0}
2020-09-25 06:02:59.317 DEBUG (qtp1800649922-16) [   ] o.e.j.s.HttpChannel REQUEST for //dzmitry-solr-1.dzmitry-solr-headless:8983/solr/sigtest-c7cfa75ce_recs_aggr/select?_forwardedCount=23 on HttpChannelOverHttp@2f4e148{s=HttpChannelState@5f1bd187{s=IDLE rs=BLOCKING os=OPEN is=IDLE awp=false se=false i=true al=0},r=1,c=false/false,a=IDLE,uri=//dzmitry-solr-1.dzmitry-solr-headless:8983/solr/sigtest-c7cfa75ce_recs_aggr/select?_forwardedCount=23,age=0}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We&apos;re up to 23 forwards in the space of on 74ms before the local ZkWatcher for the cluster state fires, and we finally know that the collection has been deleted....&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2020-09-25 06:02:59.325 INFO  (zkCallback-12-thread-15) [   ] o.a.s.c.c.ZkStateReader A cluster state change: [WatchedEvent state:SyncConnected type:NodeDeleted path:/collections/sigtest-c7cfa75ce_recs_aggr/state.json] for collection [sigtest-c7cfa75ce_recs_aggr] has occurred - updating... (live nodes size: [3])
2020-09-25 06:02:59.325 INFO  (zkCallback-12-thread-13) [   ] o.a.s.c.c.ZkStateReader A cluster state change: [WatchedEvent state:SyncConnected type:NodeDeleted path:/collections/sigtest-c7cfa75ce_recs_aggr/state.json] for collection [sigtest-c7cfa75ce_recs_aggr] has occurred - updating... (live nodes size: [3])
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;One &quot;final&quot; forward comes to us (#25 for those keeping count at home), and we now know there is no point in forwarding it to anyone else, so we start responding back with 404 responses, and the request stack unwinds...&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2020-09-25 06:02:59.325 DEBUG (qtp1800649922-99) [   ] o.e.j.s.HttpChannel REQUEST for //dzmitry-solr-1.dzmitry-solr-headless:8983/solr/sigtest-c7cfa75ce_recs_aggr/select?_forwardedCount=25 on HttpChannelOverHttp@258bd7b7{s=HttpChannelState@dd4b25c{s=IDLE rs=BLOCKING os=OPEN is=IDLE awp=false se=false i=true al=0},r=1,c=false/false,a=IDLE,uri=//dzmitry-solr-1.dzmitry-solr-headless:8983/solr/sigtest-c7cfa75ce_recs_aggr/select?_forwardedCount=25,age=0}
2020-09-25 06:02:59.377 DEBUG (qtp1800649922-99) [   ] o.e.j.s.HttpChannel action COMPLETE HttpChannelOverHttp@258bd7b7{s=HttpChannelState@dd4b25c{s=HANDLING rs=COMPLETING os=COMPLETED is=READY awp=false se=false i=false al=1},r=1,c=false/true,a=HANDLING,uri=//dzmitry-solr-1.dzmitry-solr-headless:8983/solr/sigtest-c7cfa75ce_recs_aggr/select?_forwardedCount=25,age=52}
2020-09-25 06:02:59.378 DEBUG (qtp1800649922-16) [   ] o.e.j.s.HttpChannel action COMPLETE HttpChannelOverHttp@2f4e148{s=HttpChannelState@5f1bd187{s=HANDLING rs=COMPLETING os=COMPLETED is=READY awp=false se=false i=false al=1},r=1,c=false/true,a=HANDLING,uri=//dzmitry-solr-1.dzmitry-solr-headless:8983/solr/sigtest-c7cfa75ce_recs_aggr/select?_forwardedCount=23,age=61}
2020-09-25 06:02:59.381 DEBUG (qtp1800649922-24) [   ] o.e.j.s.HttpChannel action COMPLETE HttpChannelOverHttp@117eb506{s=HttpChannelState@4b93cdac{s=HANDLING rs=COMPLETING os=COMPLETED is=READY awp=false se=false i=false al=1},r=1,c=false/true,a=HANDLING,uri=//dzmitry-solr-1.dzmitry-solr-headless:8983/solr/sigtest-c7cfa75ce_recs_aggr/select?_forwardedCount=19,age=77}
2020-09-25 06:02:59.381 INFO  (qtp1800649922-102) [   ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/collections params={json.nl=map&amp;amp;indent=true&amp;amp;name=sigtest-c7cfa75ce_recs_aggr&amp;amp;action=DELETE&amp;amp;wt=json} status=0 QTime=205
2020-09-25 06:02:59.381 DEBUG (qtp1800649922-102) [   ] o.e.j.s.HttpChannel action COMPLETE HttpChannelOverHttp@dd53d71{s=HttpChannelState@56b5eeb8{s=HANDLING rs=COMPLETING os=OPEN is=READY awp=false se=false i=false al=1},r=3,c=false/false,a=HANDLING,uri=//dzmitry-solr-1.dzmitry-solr-headless:8983/solr/admin/collections?&amp;amp;json.nl=map&amp;amp;indent=true&amp;amp;name=sigtest-c7cfa75ce_recs_aggr&amp;amp;action=DELETE&amp;amp;wt=json,age=206}
2020-09-25 06:02:59.382 DEBUG (qtp1800649922-100) [   ] o.e.j.s.HttpChannel action COMPLETE HttpChannelOverHttp@3cf825c0{s=HttpChannelState@148e5cb0{s=HANDLING rs=COMPLETING os=COMPLETED is=READY awp=false se=false i=false al=1},r=22,c=false/true,a=HANDLING,uri=//dzmitry-solr-1.dzmitry-solr-headless:8983/solr/sigtest-c7cfa75ce_recs_aggr/select?_forwardedCount=17,age=86}
2020-09-25 06:02:59.385 DEBUG (qtp1800649922-205) [   ] o.e.j.s.HttpChannel action COMPLETE HttpChannelOverHttp@60d2652d{s=HttpChannelState@6702b72b{s=HANDLING rs=COMPLETING os=COMPLETED is=READY awp=false se=false i=false al=1},r=4,c=false/true,a=HANDLING,uri=//dzmitry-solr-1.dzmitry-solr-headless:8983/solr/sigtest-c7cfa75ce_recs_aggr/select?_forwardedCount=12,age=105}
2020-09-25 06:02:59.386 DEBUG (qtp1800649922-18) [   ] o.e.j.s.HttpChannel action COMPLETE HttpChannelOverHttp@73304bea{s=HttpChannelState@19accdca{s=HANDLING rs=COMPLETING os=COMPLETED is=READY awp=false se=false i=false al=1},r=105,c=false/true,a=HANDLING,uri=//dzmitry-solr-1.dzmitry-solr-headless:8983/solr/sigtest-c7cfa75ce_recs_aggr/select?_forwardedCount=10,age=112}
2020-09-25 06:02:59.397 DEBUG (qtp1800649922-15) [   ] o.e.j.s.HttpChannel action COMPLETE HttpChannelOverHttp@349d7280{s=HttpChannelState@48bf7d7e{s=HANDLING rs=COMPLETING os=OPEN is=READY awp=false se=false i=false al=1},r=155,c=false/false,a=HANDLING,uri=//dzmitry-solr-1.dzmitry-solr-headless:8983/solr/sigtest-c7cfa75ce_recs_aggr/select?_forwardedCount=1,age=154}
2020-09-25 06:02:59.398 DEBUG (qtp1800649922-19) [   ] o.e.j.s.HttpChannel action COMPLETE HttpChannelOverHttp@1e1c0a8{s=HttpChannelState@5050c26b{s=HANDLING rs=COMPLETING os=ABORTED is=READY awp=false se=false i=false al=1},r=95,c=false/false,a=HANDLING,uri=//dzmitry-solr-1.dzmitry-solr-headless:8983/solr/sigtest-c7cfa75ce_recs_aggr/select?_forwardedCount=3,age=148}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The kicker of all of this: prior to being deleted, the &apos;sigtest-c7cfa75ce_recs_aggr&apos; only ever had 2 shards, with 2 replicas each &#8211; so even if it had taken 30minutes for the ZkWatcher to fire on &lt;em&gt;ANY&lt;/em&gt; node, as soon as a node saw &lt;tt&gt;_forwardedCount=5&lt;/tt&gt; it should have known something was wrong and stop forwarding.&lt;/p&gt;</comment>
                            <comment id="17202474" author="hossman" created="Sat, 26 Sep 2020 01:01:32 +0000"  >&lt;p&gt;This excessive forwarding, combined with &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14898&quot; title=&quot;Proxied/Forwarded requests to other nodes wind up getting duplicate response headers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14898&quot;&gt;&lt;del&gt;SOLR-14898&lt;/del&gt;&lt;/a&gt; causing response header duplication on &lt;em&gt;every&lt;/em&gt; forward, is what leads to the the &quot;Response header too large&quot; error situation that causes &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14896&quot; title=&quot;jetty &amp;quot;Bad Message 400&amp;quot; / &amp;quot;Illegal character&amp;quot; responses to sporadic requests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14896&quot;&gt;&lt;del&gt;SOLR-14896&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Here&apos;s what jetty&apos;s &lt;tt&gt;HttpChannel COMMIT&lt;/tt&gt; debug logging looks like for the &lt;tt&gt;_forwardedCount=23&lt;/tt&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; 2020-09-25 06:02:59.377 DEBUG (qtp1800649922-16) [   ] o.e.j.s.HttpChannel COMMIT for /solr/sigtest-c7cfa75ce_recs_aggr/select on HttpChannelOverHttp@2f4e148{s=HttpChannelState@5f1bd187{s=HANDLING rs
=BLOCKING os=COMMITTED is=IDLE awp=false se=false i=true al=0},r=1,c=false/false,a=HANDLING,uri=//dzmitry-solr-1.dzmitry-solr-headless:8983/solr/sigtest-c7cfa75ce_recs_aggr/select?_forwardedCount=23,
age=60}
404 null HTTP/1.1
Content-Security-Policy: default-src &apos;none&apos;; base-uri &apos;none&apos;; connect-src &apos;self&apos;; form-action &apos;self&apos;; font-src &apos;self&apos;; frame-ancestors &apos;none&apos;; img-src &apos;self&apos;; media-src &apos;self&apos;; style-src &apos;self&apos; &apos;unsa
fe-inline&apos;; script-src &apos;self&apos;; worker-src &apos;self&apos;;
X-Content-Type-Options: nosniff
X-Frame-Options: SAMEORIGIN
X-XSS-Protection: 1; mode=block
Content-Security-Policy: default-src &apos;none&apos;; base-uri &apos;none&apos;; connect-src &apos;self&apos;; form-action &apos;self&apos;; font-src &apos;self&apos;; frame-ancestors &apos;none&apos;; img-src &apos;self&apos;; media-src &apos;self&apos;; style-src &apos;self&apos; &apos;unsa
fe-inline&apos;; script-src &apos;self&apos;; worker-src &apos;self&apos;;
X-Content-Type-Options: nosniff
X-Frame-Options: SAMEORIGIN
X-XSS-Protection: 1; mode=block
Content-Security-Policy: default-src &apos;none&apos;; base-uri &apos;none&apos;; connect-src &apos;self&apos;; form-action &apos;self&apos;; font-src &apos;self&apos;; frame-ancestors &apos;none&apos;; img-src &apos;self&apos;; media-src &apos;self&apos;; style-src &apos;self&apos; &apos;unsa
fe-inline&apos;; script-src &apos;self&apos;; worker-src &apos;self&apos;;
X-Content-Type-Options: nosniff
X-Frame-Options: SAMEORIGIN
X-XSS-Protection: 1; mode=block
Content-Security-Policy: default-src &apos;none&apos;; base-uri &apos;none&apos;; connect-src &apos;self&apos;; form-action &apos;self&apos;; font-src &apos;self&apos;; frame-ancestors &apos;none&apos;; img-src &apos;self&apos;; media-src &apos;self&apos;; style-src &apos;self&apos; &apos;unsa
fe-inline&apos;; script-src &apos;self&apos;; worker-src &apos;self&apos;;
X-Content-Type-Options: nosniff
X-Frame-Options: SAMEORIGIN
X-XSS-Protection: 1; mode=block
Cache-Control: must-revalidate,no-cache,no-store
Content-Type: text/html;charset=iso-8859-1
Content-Length: 397
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;...as we keep popping off the stack of requests (decreating the forward count, they just get longer and longer until they stop being 404 and become 500 because jetty has decided the response headers are too large to send.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17203241" author="munendrasn" created="Mon, 28 Sep 2020 13:50:05 +0000"  >&lt;p&gt; &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13012240/13012240_SOLR-14897.patch&quot; title=&quot;SOLR-14897.patch attached to SOLR-14897&quot;&gt;SOLR-14897.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; &lt;br/&gt;
This does forwardCount check even in case of active replica. I&apos;m not able figure out way to add test for this change, any help would be appreciated&lt;/p&gt;</comment>
                            <comment id="17203355" author="hossman" created="Mon, 28 Sep 2020 16:47:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=munendrasn&quot; class=&quot;user-hover&quot; rel=&quot;munendrasn&quot;&gt;munendrasn&lt;/a&gt; - +1 to committing your patch.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;... I&apos;m not able figure out way to add test for this change, any help would be appreciated&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m not sure we have any good template/plumbing/helpers for testing this kind of situation ... i have some thoughts on how we might go about it (from an offline idea proposed by AB) that i&apos;ll put into a new jira, but i don&apos;t think we should let building new test scaffolding for situations like this should solw us down in trying to fix this really heinous bug ASAP.&lt;/p&gt;
</comment>
                            <comment id="17203982" author="jira-bot" created="Tue, 29 Sep 2020 14:28:43 +0000"  >&lt;p&gt;Commit 3dcb19f88670b954e0956d0764853effedd923ef in lucene-solr&apos;s branch refs/heads/master from Munendra S N&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=3dcb19f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=3dcb19f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14897&quot; title=&quot;HttpSolrCall will forward a virtually unlimited number of times until ClusterState ZkWatcher is updated after collection delete&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14897&quot;&gt;&lt;del&gt;SOLR-14897&lt;/del&gt;&lt;/a&gt;: limit no of forwarding for given request&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Irrespective of active or down replicas, restrict no of forwarding of request.&lt;br/&gt;
  Previously, this restriction was applied only if active is not found&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17203987" author="jira-bot" created="Tue, 29 Sep 2020 14:41:47 +0000"  >&lt;p&gt;Commit ade0a8fb9a9a352847592bda621633b8a0d5f209 in lucene-solr&apos;s branch refs/heads/branch_8x from Munendra S N&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=ade0a8f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=ade0a8f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14897&quot; title=&quot;HttpSolrCall will forward a virtually unlimited number of times until ClusterState ZkWatcher is updated after collection delete&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14897&quot;&gt;&lt;del&gt;SOLR-14897&lt;/del&gt;&lt;/a&gt;: limit no of forwarding for given request&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Irrespective of active or down replicas, restrict no of forwarding of request.&lt;br/&gt;
  Previously, this restriction was applied only if active is not found&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17203992" author="jira-bot" created="Tue, 29 Sep 2020 14:45:36 +0000"  >&lt;p&gt;Commit 47615df8615380f4aec4f3cae05d3fa8c9686923 in lucene-solr&apos;s branch refs/heads/branch_8_6 from Munendra S N&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=47615df&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=47615df&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14897&quot; title=&quot;HttpSolrCall will forward a virtually unlimited number of times until ClusterState ZkWatcher is updated after collection delete&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14897&quot;&gt;&lt;del&gt;SOLR-14897&lt;/del&gt;&lt;/a&gt;: limit no of forwarding for given request&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Irrespective of active or down replicas, restrict no of forwarding of request.&lt;br/&gt;
  Previously, this restriction was applied only if active is not found&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17211102" author="gerlowskija" created="Fri, 9 Oct 2020 15:45:38 +0000"  >&lt;p&gt;Closing after the 8.6.3 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                            <outwardlinks description="fixes">
                                        <issuelink>
            <issuekey id="13329464">SOLR-14896</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13329505">SOLR-14898</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13329464">SOLR-14896</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13012240" name="SOLR-14897.patch" size="4321" author="munendrasn" created="Mon, 28 Sep 2020 13:48:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 5 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ixmw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>