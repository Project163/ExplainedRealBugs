<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:51:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-16436] DirectSolrSpellChecher: maxQueryFrequency bug in multi-shard </title>
                <link>https://issues.apache.org/jira/browse/SOLR-16436</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;&lt;tt&gt;DirectSolrSpellChecher&lt;/tt&gt; has some very confusing/unexpected behavior when:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;maxQueryFrequency&lt;/tt&gt; is configured&lt;/li&gt;
	&lt;li&gt;In a multi-shard collection&lt;/li&gt;
	&lt;li&gt;Using &lt;tt&gt;thresholdTokenFrequency&lt;/tt&gt; or &lt;tt&gt;spellcheck.onlyMorePopular=true&lt;/tt&gt; or &lt;tt&gt;spellcheck.alternativeTermCount&lt;/tt&gt;
	&lt;ul&gt;
		&lt;li&gt;(ie: anything that cause &lt;tt&gt;SuggestMode != SUGGEST_WHEN_NOT_IN_INDEX&lt;/tt&gt; so suggestions are possible even for terms in the index)&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The nature of the unexpected behavior varies depending on whether &lt;tt&gt;maxQueryFrequency&lt;/tt&gt; is configured as a float less then 1 (ie: a percentage relative to the maxDocs in the index) or an integer greater then 1 (ie: an absolute max frequency):&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;When &lt;tt&gt;maxQueryFrequency &amp;lt; 1&lt;/tt&gt; (ie: &quot;percentage of maxDocs&quot;)
	&lt;ul&gt;
		&lt;li&gt;It&apos;s possible to get &quot;false negative&quot; suggestions
		&lt;ul&gt;
			&lt;li&gt;ie: a term that &lt;em&gt;should&lt;/em&gt; generate suggestions (and would in an equivalent single-shard deployment) &lt;b&gt;does not&lt;/b&gt;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
		&lt;li&gt;A term from the original query may not exist in enough total documents then the configured &lt;tt&gt;maxQueryFrequency&lt;/tt&gt; percentage across the entire collection, but will not return suggestions&lt;/li&gt;
		&lt;li&gt;This can happen if a term exists in more then the configured &lt;tt&gt;maxQueryFrequency&lt;/tt&gt; percentage of docs on &lt;em&gt;one (or more)&lt;/em&gt; individual shards
		&lt;ul&gt;
			&lt;li&gt;As long as at least one shard says the term is &quot;correctly spelled&quot; (which is what &lt;tt&gt;DirectSolrSpellChecher&lt;/tt&gt; decides when the &lt;tt&gt;maxQueryFrequency&lt;/tt&gt; threshold is met) then the merge logic ignores any suggestions that might come from other shards&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;When &lt;tt&gt;1 &amp;lt; maxQueryFrequency&lt;/tt&gt; (ie &quot;absolute value&quot;)
	&lt;ul&gt;
		&lt;li&gt;It&apos;s possible to get &quot;false positive&quot; suggestions
		&lt;ul&gt;
			&lt;li&gt;ie: a term that &lt;em&gt;should not&lt;/em&gt; generate suggestions (and would not in an equivalent single-shard deployment) &lt;b&gt;does&lt;/b&gt;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
		&lt;li&gt;A term from the original query may exist in more total documents in the collection then the configured &lt;tt&gt;maxQueryFrequency&lt;/tt&gt; but will still return suggestions&lt;/li&gt;
		&lt;li&gt;This can happen if a term exists in fewer then the configured &lt;tt&gt;maxQueryFrequency&lt;/tt&gt; number of docs on &lt;em&gt;every&lt;/em&gt; individual shard
		&lt;ul&gt;
			&lt;li&gt;Since no shard says the term is &quot;correctly spelled&quot;, the suggestions are merged and returned&lt;/li&gt;
			&lt;li&gt;No aspect of the code considers the possibility that the sum of the &lt;tt&gt;origFreq&lt;/tt&gt; returned by all shards might be higher then the specified &lt;tt&gt;maxQueryFrequency&lt;/tt&gt;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13483548">SOLR-16436</key>
            <summary>DirectSolrSpellChecher: maxQueryFrequency bug in multi-shard </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Chris M. Hostetter</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Tue, 27 Sep 2022 21:41:01 +0000</created>
                <updated>Fri, 17 Oct 2025 20:05:28 +0000</updated>
                            <resolved>Tue, 11 Oct 2022 01:10:33 +0000</resolved>
                                                    <fixVersion>9.2</fixVersion>
                    <fixVersion>10.0</fixVersion>
                                    <component>spellchecker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17610253" author="hossman" created="Tue, 27 Sep 2022 21:43:28 +0000"  >&lt;p&gt;The &quot;false positive&quot; situation seems fairly straightforward to fix: Give the &lt;tt&gt;DirectSpellChecker&lt;/tt&gt; instance on the coordinator node the ability to modify the Shard Requests, and participate in the &quot;merge&quot; of Shard Responses, so it can request extended results and sum up the &lt;tt&gt;origFreq&lt;/tt&gt; of each original term and decide when/if to ignore suggestions from the individual shards because the term is in fact frequent enough (in the collection as a whole) that it should not generate suggestions.&lt;/p&gt;

&lt;p&gt;I&apos;m attaching a patch w/test that demonstrates this improvement.&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;I don&apos;t really have any good ideas for addressing the &quot;false negative&quot; situation ... I&apos;m hoping someone else reading this will have a &quot;Eureka! moment&quot; and suggest a straight forward solution that i&apos;m not considering. Worst case (If no one chimes in with an idea soon) I&apos;ll update the patch to modify the ref-guide to note that when configuring &lt;tt&gt;maxQueryFrequency&lt;/tt&gt; as a percentage, it&apos;s evaluated &lt;em&gt;per shard&lt;/em&gt;.&lt;/p&gt;</comment>
                            <comment id="17610737" author="hossman" created="Wed, 28 Sep 2022 21:41:26 +0000"  >&lt;p&gt;Updated patch with new note in ref-guide&lt;/p&gt;</comment>
                            <comment id="17615399" author="jira-bot" created="Tue, 11 Oct 2022 00:35:49 +0000"  >&lt;p&gt;Commit a41c4cc2662ed07b5cfe454140c5616ac36647ec in solr&apos;s branch refs/heads/main from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=a41c4cc2662&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=a41c4cc2662&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16436&quot; title=&quot;DirectSolrSpellChecher: maxQueryFrequency bug in multi-shard &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16436&quot;&gt;&lt;del&gt;SOLR-16436&lt;/del&gt;&lt;/a&gt;: Fix &quot;false positive&quot; suggestions from DirectSolrSpellChecker when using maxQueryFrequency &amp;gt; 1 in multi-shard collections&lt;/p&gt;</comment>
                            <comment id="17615405" author="jira-bot" created="Tue, 11 Oct 2022 01:08:47 +0000"  >&lt;p&gt;Commit 58b03895e231fe132f18d2130c368852b152da34 in solr&apos;s branch refs/heads/branch_9x from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=58b03895e23&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=58b03895e23&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16436&quot; title=&quot;DirectSolrSpellChecher: maxQueryFrequency bug in multi-shard &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16436&quot;&gt;&lt;del&gt;SOLR-16436&lt;/del&gt;&lt;/a&gt;: Fix &quot;false positive&quot; suggestions from DirectSolrSpellChecker when using maxQueryFrequency &amp;gt; 1 in multi-shard collections&lt;/p&gt;

&lt;p&gt;(cherry picked from commit a41c4cc2662ed07b5cfe454140c5616ac36647ec)&lt;/p&gt;</comment>
                            <comment id="17617697" author="ichattopadhyaya" created="Fri, 14 Oct 2022 12:32:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman&quot; class=&quot;user-hover&quot; rel=&quot;hossman&quot;&gt;hossman&lt;/a&gt;, should we include this to 9.1 release?&lt;/p&gt;</comment>
                            <comment id="17619017" author="hossman" created="Mon, 17 Oct 2022 17:20:40 +0000"  >&lt;blockquote&gt;&lt;p&gt;should we include this to 9.1 release?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;when i committed this and backported to 9x i was under the (mistaken?) impression that the RC process had already started for 9.1, and i didn&apos;t want to complicated it.&lt;/p&gt;

&lt;p&gt;I don&apos;t think this is a particularly &quot;high risk&quot; issue to backport, but I also don&apos;t see it as an &quot;servere impact&quot; issue that needs to have a fix released urgently... so on balance I&apos;d rather just stay out of the way and not risk complicating other more important backports currently in process.&lt;/p&gt;

&lt;p&gt;If you, as the RM, feel like it&apos;s an easy piece of low hanging fruit and want to go ahead and backport it &#8211; go for it.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17705493" author="houston" created="Mon, 27 Mar 2023 18:04:13 +0000"  >&lt;p&gt;Closing after the 9.2.0 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13049894" name="SOLR-16436-1.patch" size="14868" author="hossman" created="Wed, 28 Sep 2022 21:41:25 +0000"/>
                            <attachment id="13049837" name="SOLR-16436.patch" size="12351" author="hossman" created="Tue, 27 Sep 2022 21:43:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 33 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z18wew:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>