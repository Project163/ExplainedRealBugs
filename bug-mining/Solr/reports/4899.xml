<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:51:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-16414] Race condition in PRS state updates</title>
                <link>https://issues.apache.org/jira/browse/SOLR-16414</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;For PRS collections the individual states are potentially updated from individual nodes and sometimes from overseer too. it&apos;s possible that&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;OP1 is sent to overseer at T1&lt;/li&gt;
	&lt;li&gt;OP2 is executed in the node itself at T2&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Because we cannot guarantee that the OP1 sent to overseer may execute before OP2 tyhe final state will be the result of OP1 which is incorrect and can lead to errors .&lt;/p&gt;

&lt;p&gt;The solution is to never do any PRS writes from overseer.&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13481969">SOLR-16414</key>
            <summary>Race condition in PRS state updates</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="noble.paul">Noble Paul</assignee>
                                    <reporter username="noble.paul">Noble Paul</reporter>
                        <labels>
                    </labels>
                <created>Sat, 17 Sep 2022 05:57:16 +0000</created>
                <updated>Tue, 14 May 2024 21:32:35 +0000</updated>
                            <resolved>Thu, 3 Nov 2022 19:39:18 +0000</resolved>
                                                    <fixVersion>9.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3000">50m</timespent>
                                <comments>
                            <comment id="17606697" author="ichattopadhyaya" created="Mon, 19 Sep 2022 17:51:11 +0000"  >&lt;p&gt;I benchmarked the collection CREATE operations using solr-bench after this change.&lt;br/&gt;
It took 297 seconds to create 1000 PRS collections, vs 307 seconds to create 1000 non-PRS collections.&lt;/p&gt;

&lt;p&gt;The suite is here: &lt;a href=&quot;https://github.com/fullstorydev/solr-bench/blob/master/cluster-test.json&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/fullstorydev/solr-bench/blob/master/cluster-test.json&lt;/a&gt; (just change the correct commit to point to this PR branch, and change &quot;perReplicaState&quot; variable to true/false for the comparison).&lt;/p&gt;</comment>
                            <comment id="17606920" author="jira-bot" created="Tue, 20 Sep 2022 05:53:40 +0000"  >&lt;p&gt;Commit f2a9aa5f609916b865e274f7f1e25dbce3d943a5 in solr&apos;s branch refs/heads/main from Noble Paul&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=f2a9aa5f609&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=f2a9aa5f609&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16414&quot; title=&quot;Race condition in PRS state updates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16414&quot;&gt;&lt;del&gt;SOLR-16414&lt;/del&gt;&lt;/a&gt;: Race condition in PRS state updates (#1019)&lt;/p&gt;
</comment>
                            <comment id="17606922" author="jira-bot" created="Tue, 20 Sep 2022 05:56:04 +0000"  >&lt;p&gt;Commit 97e5483cb6bbd8298abe47733317ef7d002e6829 in solr&apos;s branch refs/heads/branch_9x from Noble Paul&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=97e5483cb6b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=97e5483cb6b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16414&quot; title=&quot;Race condition in PRS state updates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16414&quot;&gt;&lt;del&gt;SOLR-16414&lt;/del&gt;&lt;/a&gt;: Race condition in PRS state updates (#1019)&lt;/p&gt;
</comment>
                            <comment id="17607358" author="risdenk" created="Tue, 20 Sep 2022 18:39:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt; / &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ichattopadhyaya&quot; class=&quot;user-hover&quot; rel=&quot;ichattopadhyaya&quot;&gt;ichattopadhyaya&lt;/a&gt; - &lt;a href=&quot;https://github.com/apache/solr/pull/1019&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/solr/pull/1019&lt;/a&gt; was merged - is this jira done then?&lt;/p&gt;</comment>
                            <comment id="17607360" author="ichattopadhyaya" created="Tue, 20 Sep 2022 18:44:15 +0000"  >&lt;p&gt;All good to close it now. Thanks to everyone for the contribution.&lt;/p&gt;</comment>
                            <comment id="17607364" author="risdenk" created="Tue, 20 Sep 2022 18:52:45 +0000"  >&lt;p&gt;It looks like this is causing NPE in org.apache.solr.cloud.ZkControllerTest.testPublishAndWaitForDownStates &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://lists.apache.org/list?builds@solr.apache.org:lte=1M:org.apache.solr.cloud.ZkControllerTest.testPublishAndWaitForDownStates&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://lists.apache.org/list?builds@solr.apache.org:lte=1M:org.apache.solr.cloud.ZkControllerTest.testPublishAndWaitForDownStates&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
FAILED: org.apache.solr.cloud.ZkControllerTest.testPublishAndWaitForDownStates

Error Message:
java.lang.NullPointerException: Cannot invoke &lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.solr.common.cloud.DocCollection.getName()&quot;&lt;/span&gt; because &lt;span class=&quot;code-quote&quot;&gt;&quot;coll&quot;&lt;/span&gt; is &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;

Stack Trace:
java.lang.NullPointerException: Cannot invoke &lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.solr.common.cloud.DocCollection.getName()&quot;&lt;/span&gt; because &lt;span class=&quot;code-quote&quot;&gt;&quot;coll&quot;&lt;/span&gt; is &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
at __randomizedtesting.SeedInfo.seed([9041825327B5F309:B74EEEBF8622BC36]:0)
at org.apache.solr.cloud.ZkController.lambda$publishNodeAsDown$24(ZkController.java:2930)
at java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)
at java.base/java.util.Collections$2.tryAdvance(Collections.java:4820)
at java.base/java.util.Collections$2.forEachRemaining(Collections.java:4828)
at java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:484)
at java.base/java.util.stream.ForEachOps$ForEachTask.compute(ForEachOps.java:290)
at java.base/java.util.concurrent.CountedCompleter.exec(CountedCompleter.java:746)
at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:295)
at java.base/java.util.concurrent.ForkJoinTask.doInvoke(ForkJoinTask.java:413)
at java.base/java.util.concurrent.ForkJoinTask.invoke(ForkJoinTask.java:741)
at java.base/java.util.stream.ForEachOps$ForEachOp.evaluateParallel(ForEachOps.java:159)
at java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateParallel(ForEachOps.java:173)
at java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:233)
at java.base/java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:596)
at java.base/java.util.stream.ReferencePipeline$Head.forEach(ReferencePipeline.java:765)
at org.apache.solr.cloud.ZkController.publishNodeAsDown(ZkController.java:2927)
at org.apache.solr.cloud.ZkController.publishAndWaitForDownStates(ZkController.java:1131)
at org.apache.solr.cloud.ZkControllerTest.testPublishAndWaitForDownStates(ZkControllerTest.java:330)
at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:78)
at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
at java.base/java.lang.reflect.Method.invoke(Method.java:567)
at com.carrotsearch.randomizedtesting.RandomizedRunner.invoke(RandomizedRunner.java:1758)
at com.carrotsearch.randomizedtesting.RandomizedRunner$8.evaluate(RandomizedRunner.java:946)
at com.carrotsearch.randomizedtesting.RandomizedRunner$9.evaluate(RandomizedRunner.java:982)
at com.carrotsearch.randomizedtesting.RandomizedRunner$10.evaluate(RandomizedRunner.java:996)
at com.carrotsearch.randomizedtesting.rules.SystemPropertiesRestoreRule$1.evaluate(SystemPropertiesRestoreRule.java:80)
at org.junit.rules.RunRules.evaluate(RunRules.java:20)
at org.apache.lucene.tests.util.TestRuleSetupTeardownChained$1.evaluate(TestRuleSetupTeardownChained.java:44)
at org.apache.lucene.tests.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:43)
at org.apache.lucene.tests.util.TestRuleThreadAndTestName$1.evaluate(TestRuleThreadAndTestName.java:45)
at org.apache.lucene.tests.util.TestRuleIgnoreAfterMaxFailures$1.evaluate(TestRuleIgnoreAfterMaxFailures.java:60)
at org.apache.lucene.tests.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:44)
at org.junit.rules.RunRules.evaluate(RunRules.java:20)
at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)
at com.carrotsearch.randomizedtesting.ThreadLeakControl$StatementRunner.run(ThreadLeakControl.java:390)
at com.carrotsearch.randomizedtesting.ThreadLeakControl.forkTimeoutingTask(ThreadLeakControl.java:843)
at com.carrotsearch.randomizedtesting.ThreadLeakControl$3.evaluate(ThreadLeakControl.java:490)
at com.carrotsearch.randomizedtesting.RandomizedRunner.runSingleTest(RandomizedRunner.java:955)
at com.carrotsearch.randomizedtesting.RandomizedRunner$5.evaluate(RandomizedRunner.java:840)
at com.carrotsearch.randomizedtesting.RandomizedRunner$6.evaluate(RandomizedRunner.java:891)
at com.carrotsearch.randomizedtesting.RandomizedRunner$7.evaluate(RandomizedRunner.java:902)
at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)
at org.apache.lucene.tests.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:43)
at org.apache.lucene.tests.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:43)
at com.carrotsearch.randomizedtesting.rules.SystemPropertiesRestoreRule$1.evaluate(SystemPropertiesRestoreRule.java:80)
at org.junit.rules.RunRules.evaluate(RunRules.java:20)
at org.apache.lucene.tests.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:43)
at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)
at org.apache.lucene.tests.util.TestRuleStoreClassName$1.evaluate(TestRuleStoreClassName.java:38)
at com.carrotsearch.randomizedtesting.rules.NoShadowingOrOverridesOnMethodsRule$1.evaluate(NoShadowingOrOverridesOnMethodsRule.java:40)
at com.carrotsearch.randomizedtesting.rules.NoShadowingOrOverridesOnMethodsRule$1.evaluate(NoShadowingOrOverridesOnMethodsRule.java:40)
at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)
at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)
at org.apache.lucene.tests.util.TestRuleAssertionsRequired$1.evaluate(TestRuleAssertionsRequired.java:53)
at org.apache.lucene.tests.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:43)
at org.apache.lucene.tests.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:44)
at org.apache.lucene.tests.util.TestRuleIgnoreAfterMaxFailures$1.evaluate(TestRuleIgnoreAfterMaxFailures.java:60)
at org.apache.lucene.tests.util.TestRuleIgnoreTestSuites$1.evaluate(TestRuleIgnoreTestSuites.java:47)
at org.junit.rules.RunRules.evaluate(RunRules.java:20)
at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)
at com.carrotsearch.randomizedtesting.ThreadLeakControl$StatementRunner.run(ThreadLeakControl.java:390)
at com.carrotsearch.randomizedtesting.ThreadLeakControl.lambda$forkTimeoutingTask$0(ThreadLeakControl.java:850)
at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:831)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17607459" author="noble.paul" created="Wed, 21 Sep 2022 02:02:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krisden&quot; class=&quot;user-hover&quot; rel=&quot;krisden&quot;&gt;krisden&lt;/a&gt;&#160; thanks,&lt;/p&gt;

&lt;p&gt;I&apos;m looking into it&lt;/p&gt;</comment>
                            <comment id="17607746" author="jira-bot" created="Wed, 21 Sep 2022 13:13:31 +0000"  >&lt;p&gt;Commit 7f058eb8379b1f0b51367f2fdbbe0fbee9d11cc1 in solr&apos;s branch refs/heads/main from Noble Paul&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=7f058eb8379&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=7f058eb8379&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16414&quot; title=&quot;Race condition in PRS state updates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16414&quot;&gt;&lt;del&gt;SOLR-16414&lt;/del&gt;&lt;/a&gt;: NPE on node down (#1034)&lt;/p&gt;
</comment>
                            <comment id="17607766" author="janhoy" created="Wed, 21 Sep 2022 13:53:19 +0000"  >&lt;p&gt;Was there any peer review of the latest PR &lt;a href=&quot;https://github.com/apache/solr/pull/1034&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;#1034&lt;/a&gt;? Can you explain what the NPE bug was about and what the gist of the fix was? Is there any test coverage or was it hard to reproduce the NPE in tests?&lt;/p&gt;</comment>
                            <comment id="17608004" author="noble.paul" created="Thu, 22 Sep 2022 00:00:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=janhoy&quot; class=&quot;user-hover&quot; rel=&quot;janhoy&quot;&gt;janhoy&lt;/a&gt; the NPE was because of missing collection. This was failing in jenkins, that&apos;s why I had to commit this.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;It&apos;s not easily reproduced. However, I shall add a JUnit&lt;/p&gt;</comment>
                            <comment id="17608359" author="hossman" created="Thu, 22 Sep 2022 17:16:03 +0000"  >&lt;p&gt;It looks like the NPE fix was only committed to main even though the change that caused the NPE was commited to both main &amp;amp; 9x?&lt;/p&gt;

&lt;p&gt;So we&apos;re still seeing the NPE on 9x...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://ci-builds.apache.org/job/Solr/job/Solr-Check-9.x/2171/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-builds.apache.org/job/Solr/job/Solr-Check-9.x/2171/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17608461" author="jira-bot" created="Fri, 23 Sep 2022 01:10:48 +0000"  >&lt;p&gt;Commit 5f2d2a466cdae146c2ec727672d9bbc502a8a908 in solr&apos;s branch refs/heads/branch_9x from Noble Paul&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=5f2d2a466cd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=5f2d2a466cd&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16414&quot; title=&quot;Race condition in PRS state updates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16414&quot;&gt;&lt;del&gt;SOLR-16414&lt;/del&gt;&lt;/a&gt;: NPE on node down (#1034)&lt;/p&gt;
</comment>
                            <comment id="17628102" author="ichattopadhyaya" created="Thu, 3 Nov 2022 04:29:14 +0000"  >&lt;p&gt;The last commit caused a massive slowdown in node stop event. With 1000 cores/node, the nodes never gracefully stopped, had to be kill -9&apos;d. Repoening for a fix to remove parallelStream usage.&lt;/p&gt;</comment>
                            <comment id="17628105" author="jira-bot" created="Thu, 3 Nov 2022 04:34:27 +0000"  >&lt;p&gt;Commit 5125dab476625fadab9c30561621f5b2c67f9bfe in solr&apos;s branch refs/heads/main from Noble Paul&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=5125dab4766&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=5125dab4766&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16414&quot; title=&quot;Race condition in PRS state updates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16414&quot;&gt;&lt;del&gt;SOLR-16414&lt;/del&gt;&lt;/a&gt;: remove parallelStream&lt;/p&gt;</comment>
                            <comment id="17628107" author="jira-bot" created="Thu, 3 Nov 2022 04:36:47 +0000"  >&lt;p&gt;Commit 1ad3f97790f0d510f8c9ef434ee019486acdcdad in solr&apos;s branch refs/heads/branch_9_1 from Noble Paul&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=1ad3f97790f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=1ad3f97790f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16414&quot; title=&quot;Race condition in PRS state updates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16414&quot;&gt;&lt;del&gt;SOLR-16414&lt;/del&gt;&lt;/a&gt;: remove parallelStream&lt;/p&gt;</comment>
                            <comment id="17628111" author="jira-bot" created="Thu, 3 Nov 2022 04:52:08 +0000"  >&lt;p&gt;Commit b33161d0cdd976fc0c3dc78c4afafceb4db671cf in solr&apos;s branch refs/heads/branch_9x from Noble Paul&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=b33161d0cdd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=b33161d0cdd&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16414&quot; title=&quot;Race condition in PRS state updates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16414&quot;&gt;&lt;del&gt;SOLR-16414&lt;/del&gt;&lt;/a&gt;: remove parallelStream&lt;/p&gt;</comment>
                            <comment id="17628244" author="janhoy" created="Thu, 3 Nov 2022 10:34:09 +0000"  >&lt;p&gt;Do we know that the sequential forEach is safe? It will also cause a burst of events, although slower.&lt;/p&gt;

&lt;p&gt;Do you know the root cause of the deadlock? We can guess that the unbounded parallellStream would cause too much traffic to ZK at once so that something breaks? But if someone has 100 solr nodes instead of 8, you&apos;d still get a massive parallell load on ZK?&lt;/p&gt;

&lt;p&gt;Still, if this is a PRS-only issue and the fix today is likely to work on the 8-node 1000 collections test, then we should not hold up 9.1 to try to get a perfect solution for 1% of Solr&apos;s users.&lt;/p&gt;</comment>
                            <comment id="17628272" author="noble.paul" created="Thu, 3 Nov 2022 11:22:00 +0000"  >&lt;p&gt;&amp;gt; Do you know the root cause of the deadlock?&#160;&lt;/p&gt;

&lt;p&gt;Actually, there is no deadlock. The forkjoin pool threads are just waiting and preventing Solr&#160; from shutting down gracefully.&#160;&#160;&lt;/p&gt;</comment>
                            <comment id="17628495" author="ichattopadhyaya" created="Thu, 3 Nov 2022 19:37:38 +0000"  >&lt;blockquote&gt;&lt;p&gt;Still, if this is a PRS-only issue and the fix today is likely to work on the 8-node 1000 collections test, then we should not hold up 9.1 to try to get a perfect solution for 1% of Solr&apos;s users. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This affects non PRS as well. This test was specifically for the general case:&lt;br/&gt;
&lt;a href=&quot;https://github.com/fullstorydev/solr-bench/blob/ishan/repeatable-jenkins/suites/cluster-test.json#L7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/fullstorydev/solr-bench/blob/ishan/repeatable-jenkins/suites/cluster-test.json#L7&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;we should not hold up 9.1 to try to get a perfect solution for 1% of Solr&apos;s users.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;However, this attitude towards our users needs to change. Fullstory is using PRS in production, only because of performance benefits. Punishing early adopters and active contributors for no reason is not useful for our project. Even though this issue is not PRS specific, but even had it been so, a respin would&apos;ve been warranted (given the severity of the problem).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Do you know the root cause of the deadlock? We can guess that the unbounded parallellStream would cause too much traffic to ZK at once so that something breaks? But if someone has 100 solr nodes instead of 8, you&apos;d still get a massive parallell load on ZK?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Here&apos;s the thread dump at the time of failed graceful shutdown. &lt;a href=&quot;https://termbin.com/7cfz&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://termbin.com/7cfz&lt;/a&gt;. Seems like a Java/JDK/JVM or usage issue regarding parallelStream, that just causes unnecessary contention on the thread pool.&lt;/p&gt;</comment>
                            <comment id="17628563" author="JIRAUSER291114" created="Thu, 3 Nov 2022 23:24:32 +0000"  >&lt;p&gt;Dug a little bit deeper into the issue. The core issues appear to be:&lt;br/&gt;
`parallelStream` has rather weird handling, it does NOT interrupt or return at once if any of the `Consumer` supplied throws unhandled exception. Based on testing, it will keep on executing all the consumers, and once everyone is done, throws the unhandled exception again. Such behavior is shown in this &lt;a href=&quot;https://gist.github.com/patsonluk/04365cd1140e39d5d59c267782265ece&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;gist&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Now in our cases, the shutdown flow appears to be:&lt;br/&gt;
1. it iterates (parallel, but it should have certain bound, my local test it goes as batch of 20, but probably machine/java implementation specific) each collection and attempts to &lt;a href=&quot;https://github.com/apache/solr/blob/main/solr/core/src/java/org/apache/solr/cloud/ZkController.java#L2962&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;fetch PerReplicaStates&lt;/a&gt;&lt;br/&gt;
2. It eventually invokes SolrZkClient#getChildren which  calls `zkCmdExecutor.retryOperation(() -&amp;gt; keeper.getChildren(path, wrapWatcher(watcher), stat));`&lt;br/&gt;
3. The `retryOperation` first tries to call `keeper.getChildren(path, wrapWatcher(watcher), stat)`, which this case might throw `KeeperException.ConnectionLossException`. This is because during that time the `zkclient` is also getting closed, and after a chain of events, will eventually set the `state` of `ClientCnxn$SendThread` to `CLOSED` (might also get `SessionTimeoutException`), which creates and throws `KeeperException.ConnectionLossException` &lt;br/&gt;
4. But instead of returning right the way, the `ZkCmdExecutor#retryOperation` sleeps for 1.5 secs, then checks `ZkCmdExecutor#isClosed`, which is `true`. This time it throws `AlreadyClosedException` which is a `RuntimeException`, which bubbles all the way up unhandled to the parallelStream.foreach&lt;br/&gt;
5. Unfortunately, parallelStream.foreach does NOT interrupt even if there&apos;s unhandled exception. It will simply just keep going with all the collections, and each batch (20?) of collections can get stuck for 1.5 secs. So in an environment with alot of collections, the shutdown could be slow? &lt;/p&gt;


&lt;p&gt;Replacing `parallelStream` with `stream` will interrupt the `forEach` immediately if any unhandled runtime exception is thrown within, hence avoiding this problem. However, if we do want some form of parallelism, perhaps we should use more traditional threading/forkjoin task construct instead of `parallelStream` ? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/biggrin.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt; did u observe the slowness in an environment with a lot of collections? Im hoping that my finding could explain what you observed.&lt;/p&gt;</comment>
                            <comment id="17628565" author="JIRAUSER291114" created="Thu, 3 Nov 2022 23:32:57 +0000"  >&lt;p&gt;Another kinda minor thought is perhaps we should always check `isClosed()` for `ZkCmdExecutor#retryOperation`. So it should not sleep a minimum of 1.5 sec even if connection is closed. It&apos;s not major, perhaps the check was there in case `isClosed()` is expensive to call ?&lt;/p&gt;

&lt;p&gt; &lt;a href=&quot;https://github.com/apache/solr/blob/main/solr/solrj-zookeeper/src/java/org/apache/solr/common/cloud/ZkCmdExecutor.java#L69&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/solr/blob/main/solr/solrj-zookeeper/src/java/org/apache/solr/common/cloud/ZkCmdExecutor.java#L69&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17628606" author="noble.paul" created="Fri, 4 Nov 2022 00:41:15 +0000"  >&lt;blockquote&gt;&lt;p&gt;However, if we do want some form of parallelism, perhaps we should use more traditional threading/forkjoin task construct instead of `parallelStream` ?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;We actually do not need any parallelism.&#160; The operations are quite fast&lt;/p&gt;</comment>
                            <comment id="17629050" author="mgibney" created="Fri, 4 Nov 2022 15:35:11 +0000"  >&lt;p&gt;Thank you for the in-depth analysis, Patson! And thanks for the thread dump and for identifying this issue, Ishan and Noble. Would you be able to provide logs for the shutdown as well?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt; We actually do not need any parallelism.  The operations are quite fast&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;iiuc everyone&apos;s in agreement on that point; but the way this manifested doesn&apos;t look like it&apos;s simply related to concurrent load induced by using &lt;tt&gt;parallelStream&lt;/tt&gt; instead of serial &lt;tt&gt;forEach&lt;/tt&gt;. On the one hand this hopefully reassures &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=janhoy&quot; class=&quot;user-hover&quot; rel=&quot;janhoy&quot;&gt;janhoy&lt;/a&gt; that this fix isn&apos;t simply a matter of throttling load in an arbitrary way &amp;#8211; it&apos;s actually a consequence of the behavior of &lt;tt&gt;parallelStream&lt;/tt&gt; in a way unrelated to parallelism &lt;em&gt;per se&lt;/em&gt;. On the other hand, this may have uncovered a latent issue, perhaps around exception handling/ordering assumptions in the shutdown code, warranting digging a bit further to figure out more specifically what&apos;s going on, and if there may be other changes that could guard against this kind of thing happening in the future. &lt;/p&gt;

&lt;p&gt;Patson&apos;s analysis definitely seems relevant, but the thread dump Ishan posted seems to point at something else possibly going on. What I find curious about the thread dump is that it doesn&apos;t actually look like resource contention at this point; rather, it looks like a bunch of non-daemon threads somehow got created &lt;em&gt;after&lt;/em&gt; the shutdown process considered itself to be finished, and the non-daemon threads are preventing the JVM from exiting, despite the fact that the shutdown hook has exited and no more work is actually being done.&lt;/p&gt;

&lt;p&gt;It&apos;s possible I&apos;m misreading the situation, but fwiw that hypothetical situation could potentially be a consequence of the behavior Patson outlined: could the tasks executed by parallelStream somehow re-instantiate &quot;searcherExecutor&quot; and &quot;parallelCoreAdminExecutor&quot; thread pools &lt;em&gt;after&lt;/em&gt; the point when the shutdown process would consider the need to shut them down?&lt;/p&gt;</comment>
                            <comment id="17629063" author="JIRAUSER291114" created="Fri, 4 Nov 2022 15:59:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=magibney&quot; class=&quot;user-hover&quot; rel=&quot;magibney&quot;&gt;magibney&lt;/a&gt; that&apos;s very true that we don&apos;t seem to see any method name (for example `retryOperation`) that does the wait i mentioned in the thread dump provided, sorry I didn&apos;t look at the thread dump provided.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ichattopadhyaya&quot; class=&quot;user-hover&quot; rel=&quot;ichattopadhyaya&quot;&gt;ichattopadhyaya&lt;/a&gt; is there a shutdown log we can look at too? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17630210" author="jira-bot" created="Tue, 8 Nov 2022 06:22:25 +0000"  >&lt;p&gt;Commit 6bc3d6860e0d05a70c5449cd80347999b9157d9f in solr&apos;s branch refs/heads/main from Noble Paul&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=6bc3d6860e0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=6bc3d6860e0&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16414&quot; title=&quot;Race condition in PRS state updates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16414&quot;&gt;&lt;del&gt;SOLR-16414&lt;/del&gt;&lt;/a&gt;: simplified code&lt;/p&gt;</comment>
                            <comment id="17630211" author="jira-bot" created="Tue, 8 Nov 2022 06:23:13 +0000"  >&lt;p&gt;Commit 1d7b7795cc77ad6863832e3a87d144a68490ba06 in solr&apos;s branch refs/heads/branch_9x from Noble Paul&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=1d7b7795cc7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=1d7b7795cc7&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16414&quot; title=&quot;Race condition in PRS state updates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16414&quot;&gt;&lt;del&gt;SOLR-16414&lt;/del&gt;&lt;/a&gt;: simplified code&lt;/p&gt;</comment>
                            <comment id="17656796" author="ishan" created="Tue, 10 Jan 2023 20:45:23 +0000"  >&lt;p&gt;Bulk closing 9.1 issues.&lt;/p&gt;</comment>
                            <comment id="17677741" author="jira-bot" created="Tue, 17 Jan 2023 12:42:32 +0000"  >&lt;p&gt;Commit deb9e2439957dd42c349fc7fe2529d9fb63bd54d in solr&apos;s branch refs/heads/branch_9_1 from Ishan Chattopadhyaya&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=deb9e243995&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=deb9e243995&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16622&quot; title=&quot;Replicas don&amp;#39;t come up active after node restart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16622&quot;&gt;&lt;del&gt;SOLR-16622&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16414&quot; title=&quot;Race condition in PRS state updates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16414&quot;&gt;&lt;del&gt;SOLR-16414&lt;/del&gt;&lt;/a&gt;: simplified code / bugfix for a node restart not working correctly&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 43 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z18mso:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>