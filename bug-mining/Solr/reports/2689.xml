<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:08:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-6406] ConcurrentUpdateSolrServer hang in blockUntilFinished.</title>
                <link>https://issues.apache.org/jira/browse/SOLR-6406</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Not sure what is causing this, but &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6136&quot; title=&quot;ConcurrentUpdateSolrServer includes a Spin Lock&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6136&quot;&gt;&lt;del&gt;SOLR-6136&lt;/del&gt;&lt;/a&gt; may have taken us a step back here. I see this problem occasionally pop up in ChaosMonkeyNothingIsSafeTest now - test fails because of a thread leak, thread leak is due to a ConcurrentUpdateSolrServer hang in blockUntilFinished. Only started popping up recently.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12736076">SOLR-6406</key>
            <summary>ConcurrentUpdateSolrServer hang in blockUntilFinished.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yseeley@gmail.com">Yonik Seeley</assignee>
                                    <reporter username="markrmiller@gmail.com">Mark Miller</reporter>
                        <labels>
                    </labels>
                <created>Fri, 22 Aug 2014 14:36:38 +0000</created>
                <updated>Thu, 28 Apr 2016 15:26:34 +0000</updated>
                            <resolved>Thu, 28 Apr 2016 15:26:25 +0000</resolved>
                                                    <fixVersion>5.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>13</watches>
                                                                                                                <comments>
                            <comment id="14106906" author="markrmiller@gmail.com" created="Fri, 22 Aug 2014 14:37:33 +0000"  >&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   1) Thread[id=55, name=qtp823025155-55, state=WAITING, group=TGRP-ChaosMonkeyNothingIsSafeTest]
        at java.lang.Object.wait(Native Method)
        at java.lang.Object.wait(Object.java:503)
        at org.apache.solr.client.solrj.impl.ConcurrentUpdateSolrServer.blockUntilFinished(ConcurrentUpdateSolrServer.java:374)
        at org.apache.solr.update.StreamingSolrServers.blockUntilFinished(StreamingSolrServers.java:103)
        at org.apache.solr.update.SolrCmdDistributor.blockAndDoRetries(SolrCmdDistributor.java:228)
        at org.apache.solr.update.SolrCmdDistributor.finish(SolrCmdDistributor.java:89)
        at org.apache.solr.update.processor.DistributedUpdateProcessor.doFinish(DistributedUpdateProcessor.java:766)
        at org.apache.solr.update.processor.DistributedUpdateProcessor.finish(DistributedUpdateProcessor.java:1662)
        at org.apache.solr.update.processor.LogUpdateProcessor.finish(LogUpdateProcessorFactory.java:179)
        at org.apache.solr.handler.ContentStreamHandlerBase.handleRequestBody(ContentStreamHandlerBase.java:83)
        at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:135)
        at org.apache.solr.core.SolrCore.execute(SolrCore.java:1967)
        at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:777)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14106909" author="markrmiller@gmail.com" created="Fri, 22 Aug 2014 14:40:36 +0000"  >&lt;p&gt;This was on a nightly of ChaosMonkeyNothingIsSafeTest. It&apos;s fairly rare.&lt;/p&gt;</comment>
                            <comment id="14297214" author="markrmiller@gmail.com" created="Thu, 29 Jan 2015 17:44:52 +0000"  >&lt;p&gt;I still see this happen in tests. This hangs at  runners.wait(); and no notify or anything comes and it&apos;s just an ugly hang.&lt;/p&gt;</comment>
                            <comment id="14297238" author="thelabdude" created="Thu, 29 Jan 2015 17:54:41 +0000"  >&lt;p&gt;Would it make sense to change the code to wait(timeoutMs) and we can recheck the state of things and going back to waiting if it makes sense vs. the indefinite way you&apos;re seeing?&lt;/p&gt;</comment>
                            <comment id="14297242" author="markrmiller@gmail.com" created="Thu, 29 Jan 2015 17:56:54 +0000"  >&lt;p&gt;Mabye. I&apos;ve been trying to spot how it can happen (without a runner also still going, which I don&apos;t see). So far, I cannot spot how it happens.&lt;/p&gt;</comment>
                            <comment id="14701450" author="stephlag" created="Tue, 18 Aug 2015 15:43:01 +0000"  >&lt;p&gt;I have attached a cpu sample of a solr cloud server which has very poor update performance since a few hours.&lt;br/&gt;
I guess it could be related to this problem.&lt;/p&gt;</comment>
                            <comment id="14972813" author="markrmiller@gmail.com" created="Sat, 24 Oct 2015 18:59:11 +0000"  >&lt;p&gt;A more recent set of stack traces:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   [junit4] ERROR   0.00s | HdfsChaosMonkeyNothingIsSafeTest (suite) &amp;lt;&amp;lt;&amp;lt;
   [junit4]    &amp;gt; Throwable #1: java.lang.AssertionError: ERROR: SolrIndexSearcher opens=39 closes=38
   [junit4]    &amp;gt; 	at __randomizedtesting.SeedInfo.seed([71608A03B4692CB]:0)
   [junit4]    &amp;gt; 	at org.apache.solr.SolrTestCaseJ4.endTrackingSearchers(SolrTestCaseJ4.java:468)
   [junit4]    &amp;gt; 	at org.apache.solr.SolrTestCaseJ4.afterClass(SolrTestCaseJ4.java:234)
   [junit4]    &amp;gt; 	at java.lang.Thread.run(Thread.java:745)Throwable #2: com.carrotsearch.randomizedtesting.ThreadLeakError: 2 threads leaked from SUITE scope at org.apache.solr.cloud.hdfs.HdfsChaosMonkeyNothingIsSafeTest: 
   [junit4]    &amp;gt;    1) Thread[id=243, name=qtp487431535-243, state=WAITING, group=TGRP-HdfsChaosMonkeyNothingIsSafeTest]
   [junit4]    &amp;gt;         at java.lang.Object.wait(Native Method)
   [junit4]    &amp;gt;         at java.lang.Object.wait(Object.java:502)
   [junit4]    &amp;gt;         at org.apache.solr.client.solrj.impl.ConcurrentUpdateSolrClient.blockUntilFinished(ConcurrentUpdateSolrClient.java:404)
   [junit4]    &amp;gt;         at org.apache.solr.update.StreamingSolrClients.blockUntilFinished(StreamingSolrClients.java:103)
   [junit4]    &amp;gt;         at org.apache.solr.update.SolrCmdDistributor.blockAndDoRetries(SolrCmdDistributor.java:231)
   [junit4]    &amp;gt;         at org.apache.solr.update.SolrCmdDistributor.finish(SolrCmdDistributor.java:89)
   [junit4]    &amp;gt;         at org.apache.solr.update.processor.DistributedUpdateProcessor.doFinish(DistributedUpdateProcessor.java:778)
   [junit4]    &amp;gt;         at org.apache.solr.update.processor.DistributedUpdateProcessor.finish(DistributedUpdateProcessor.java:1622)
   [junit4]    &amp;gt;         at org.apache.solr.update.processor.LogUpdateProcessor.finish(LogUpdateProcessorFactory.java:183)
   [junit4]    &amp;gt;         at org.apache.solr.handler.ContentStreamHandlerBase.handleRequestBody(ContentStreamHandlerBase.java:83)
   [junit4]    &amp;gt;         at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:151)
   [junit4]    &amp;gt;         at org.apache.solr.core.SolrCore.execute(SolrCore.java:2079)
   [junit4]    &amp;gt;         at org.apache.solr.servlet.HttpSolrCall.execute(HttpSolrCall.java:667)
   [junit4]    &amp;gt;         at org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:460)
   [junit4]    &amp;gt;         at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:220)
   [junit4]    &amp;gt;         at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:179)
   [junit4]    &amp;gt;         at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)
   [junit4]    &amp;gt;         at org.apache.solr.client.solrj.embedded.JettySolrRunner$DebugFilter.doFilter(JettySolrRunner.java:109)
   [junit4]    &amp;gt;         at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)
   [junit4]    &amp;gt;         at org.eclipse.jetty.servlets.UserAgentFilter.doFilter(UserAgentFilter.java:83)
   [junit4]    &amp;gt;         at org.eclipse.jetty.servlets.GzipFilter.doFilter(GzipFilter.java:300)
   [junit4]    &amp;gt;         at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)
   [junit4]    &amp;gt;         at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:585)
   [junit4]    &amp;gt;         at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:221)
   [junit4]    &amp;gt;         at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1127)
   [junit4]    &amp;gt;         at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:515)
   [junit4]    &amp;gt;         at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)
   [junit4]    &amp;gt;         at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1061)
   [junit4]    &amp;gt;         at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)
   [junit4]    &amp;gt;         at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:97)
   [junit4]    &amp;gt;         at org.eclipse.jetty.server.Server.handle(Server.java:499)
   [junit4]    &amp;gt;         at org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:310)
   [junit4]    &amp;gt;         at org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:257)
   [junit4]    &amp;gt;         at org.eclipse.jetty.io.AbstractConnection$2.run(AbstractConnection.java:540)
   [junit4]    &amp;gt;         at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:635)
   [junit4]    &amp;gt;         at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:555)
   [junit4]    &amp;gt;         at java.lang.Thread.run(Thread.java:745)
   [junit4]    &amp;gt;    2) Thread[id=266, name=searcherExecutor-30-thread-1, state=WAITING, group=TGRP-HdfsChaosMonkeyNothingIsSafeTest]
   [junit4]    &amp;gt;         at sun.misc.Unsafe.park(Native Method)
   [junit4]    &amp;gt;         at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
   [junit4]    &amp;gt;         at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2039)
   [junit4]    &amp;gt;         at java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:442)
   [junit4]    &amp;gt;         at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1067)
   [junit4]    &amp;gt;         at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1127)
   [junit4]    &amp;gt;         at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
   [junit4]    &amp;gt;         at java.lang.Thread.run(Thread.java:745)
   [junit4]    &amp;gt; 	at __randomizedtesting.SeedInfo.seed([71608A03B4692CB]:0)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It would seem that runners.wait() can race with a final runners.notifyAll() or something.&lt;/p&gt;</comment>
                            <comment id="14972821" author="yseeley@gmail.com" created="Sat, 24 Oct 2015 19:22:13 +0000"  >&lt;p&gt;OK, here&apos;s one theory after a quick look:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;      } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (runners) {
          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (runners.size() == 1 &amp;amp;&amp;amp; !queue.isEmpty()) {
            &lt;span class=&quot;code-comment&quot;&gt;// keep &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; runner alive
&lt;/span&gt;            scheduler.execute(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
          } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            runners.remove(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (runners.isEmpty())
              runners.notifyAll();
          }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;What if the queue isn&apos;t empty, so we try to do &quot;scheduler.execute&quot;, but the scheduler has been shut down?  That will throw an exception and the else block containing notifyAll() will never be executed.&lt;/p&gt;</comment>
                            <comment id="14972840" author="yseeley@gmail.com" created="Sat, 24 Oct 2015 20:25:05 +0000"  >&lt;p&gt;OK, how about this patch?&lt;/p&gt;

&lt;p&gt;It&apos;s probably hard to read as an actual patch file, so basically what I did was:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;pull out the &quot;while (!queue.isEmpty())&quot; loop into sendUpdateStream() method.&lt;/li&gt;
	&lt;li&gt;added a for(;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; loop around the call to sendUpdateStream() and the associated error handling.&lt;/li&gt;
	&lt;li&gt;stayed in the outer loop if we&apos;re the last runner and something else was added to the queue.&lt;/li&gt;
	&lt;li&gt;removed runnerLock and the code to resubmit ourselves to the executor.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This shouldn&apos;t change any behavior except for the hypothetical buggy behavior, but it&apos;s completely untested at this point.&lt;/p&gt;</comment>
                            <comment id="14972844" author="markrmiller@gmail.com" created="Sat, 24 Oct 2015 20:45:38 +0000"  >&lt;p&gt;Yeah, it seems like we need to be sure we remove a  Runner when it is rejected by the scheduler. Patch attached - just a quick stab.&lt;/p&gt;</comment>
                            <comment id="14972845" author="markrmiller@gmail.com" created="Sat, 24 Oct 2015 20:46:25 +0000"  >&lt;p&gt;Ha - hadn&apos;t refreshed my browser.&lt;/p&gt;

&lt;p&gt;I&apos;ll review this approach.&lt;/p&gt;</comment>
                            <comment id="14973243" author="markrmiller@gmail.com" created="Sun, 25 Oct 2015 13:40:58 +0000"  >&lt;p&gt;I&apos;m testing Yonik&apos;s approach today and will see if it resolves this. My quick patch does not FWIW.&lt;/p&gt;</comment>
                            <comment id="14973270" author="markrmiller@gmail.com" created="Sun, 25 Oct 2015 14:47:10 +0000"  >&lt;p&gt;Got a hang at the same spot - 2 threads stuck on it this time rather than the usual 1:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   [junit4]    &amp;gt;    2) Thread[id=1071, name=qtp612828486-1071, state=WAITING, group=TGRP-HdfsChaosMonkeyNothingIsSafeTest]
   [junit4]    &amp;gt;         at java.lang.Object.wait(Native Method)
   [junit4]    &amp;gt;         at java.lang.Object.wait(Object.java:502)
   [junit4]    &amp;gt;         at org.apache.solr.client.solrj.impl.ConcurrentUpdateSolrClient.blockUntilFinished(ConcurrentUpdateSolrClient.java:418)
   [junit4]    &amp;gt;         at org.apache.solr.update.StreamingSolrClients.blockUntilFinished(StreamingSolrClients.java:106)
   [junit4]    &amp;gt;         at org.apache.solr.update.SolrCmdDistributor.blockAndDoRetries(SolrCmdDistributor.java:231)
   [junit4]    &amp;gt;         at org.apache.solr.update.SolrCmdDistributor.finish(SolrCmdDistributor.java:89)
   [junit4]    &amp;gt;         at org.apache.solr.update.processor.DistributedUpdateProcessor.doFinish(DistributedUpdateProcessor.java:778)
   [junit4]    &amp;gt;         at org.apache.solr.update.processor.DistributedUpdateProcessor.finish(DistributedUpdateProcessor.java:1622)
   [junit4]    &amp;gt;         at org.apache.solr.update.processor.LogUpdateProcessor.finish(LogUpdateProcessorFactory.java:183)
   [junit4]    &amp;gt;         at org.apache.solr.handler.ContentStreamHandlerBase.handleRequestBody(ContentStreamHandlerBase.java:83)
   [junit4]    &amp;gt;         at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:151)
   [junit4]    &amp;gt;         at org.apache.solr.core.SolrCore.execute(SolrCore.java:2079)
   [junit4]    &amp;gt;         at org.apache.solr.servlet.HttpSolrCall.execute(HttpSolrCall.java:667)
   [junit4]    &amp;gt;         at org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:460)
   [junit4]    &amp;gt;         at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:220)
   [junit4]    &amp;gt;         at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:179)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14974518" author="yseeley@gmail.com" created="Mon, 26 Oct 2015 16:42:22 +0000"  >&lt;blockquote&gt;&lt;p&gt;Got a hang at the same spot - 2 threads stuck on it this time rather than the usual 1:&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hmmm, yeah, I only fixed one spot where runners are submitted. I&apos;ll try taking another crack at it...&lt;br/&gt;
Although having 2 threads stuck at the same place in blockUntilFinished should be impossible... it&apos;s a synchronized method.&lt;/p&gt;</comment>
                            <comment id="14980772" author="markrmiller@gmail.com" created="Thu, 29 Oct 2015 16:50:49 +0000"  >&lt;p&gt;Just two threads stuck - not necessarily from the same client. Previously I had only ever seen 1 thread stuck. Just noting it, may not mean much.&lt;/p&gt;</comment>
                            <comment id="14980812" author="yseeley@gmail.com" created="Thu, 29 Oct 2015 17:05:12 +0000"  >&lt;p&gt;OK, I was able to reproduce... Interestingly, this is pretty easy to hit (and I also saw 2 threads stuck at the same point... which as you say must be 2 different client objects).  There must be something more here than a subtle/little race condition.&lt;/p&gt;</comment>
                            <comment id="14982724" author="yseeley@gmail.com" created="Fri, 30 Oct 2015 15:45:41 +0000"  >&lt;p&gt;Here&apos;s another patch (currently untested, but I&apos;m going to start looping the chaos tests... they seemed to be good at hitting this).&lt;/p&gt;

&lt;p&gt;I added this comment to explain why I think we were hanging:&lt;br/&gt;
        // NOTE: if the executor is shut down, runners may never become empty (a scheduled task may never be run,&lt;br/&gt;
        // which means it would never remove itself from the runners list.  This is why we don&apos;t wait forever&lt;br/&gt;
        // and periodically check if the scheduler is shutting down.&lt;/p&gt;

&lt;p&gt;So instead of waiting forever now, we periodically exit the wait and check if the scheduler is still running.&lt;/p&gt;

&lt;p&gt;I changed scheduler.isTerminated() to scheduler.isShutdown()... the latter should be true when the executor is starting to try and shut down.  I think the former is only true when it actually succeeds.&lt;/p&gt;

&lt;p&gt;I also refactored the &quot;add another runner&quot; logic out to addRunner()&lt;/p&gt;</comment>
                            <comment id="14983761" author="markrmiller@gmail.com" created="Sat, 31 Oct 2015 02:44:58 +0000"  >&lt;p&gt;Ha, that&apos;s actually close to the first hack fix I made. Occasionally waking up in the wait and checking if empty again. &lt;/p&gt;</comment>
                            <comment id="14984535" author="yseeley@gmail.com" created="Sun, 1 Nov 2015 20:18:15 +0000"  >&lt;p&gt;OK, so I haven&apos;t hit any hangs with this latest patch and shutdownNow() on the associated executor.  Interestingly enough though, this still results in inconsistent shard failures.  My guess is that the shutdown of the executor is done as one of the last steps in CoreContainer.shutdown(), which still gives time for streaming update requests to continue streaming.&lt;/p&gt;</comment>
                            <comment id="14985389" author="jira-bot" created="Mon, 2 Nov 2015 15:29:00 +0000"  >&lt;p&gt;Commit 1712045 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yonik%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;yonik@apache.org&quot;&gt;yonik@apache.org&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1712045&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1712045&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6406&quot; title=&quot;ConcurrentUpdateSolrServer hang in blockUntilFinished.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6406&quot;&gt;&lt;del&gt;SOLR-6406&lt;/del&gt;&lt;/a&gt;: fix race/hang in ConcurrentUpdateSolrClient.blockUntilFinished when executor service is shut down&lt;/p&gt;</comment>
                            <comment id="14985392" author="jira-bot" created="Mon, 2 Nov 2015 15:31:01 +0000"  >&lt;p&gt;Commit 1712047 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yonik%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;yonik@apache.org&quot;&gt;yonik@apache.org&lt;/a&gt; in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1712047&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1712047&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6406&quot; title=&quot;ConcurrentUpdateSolrServer hang in blockUntilFinished.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6406&quot;&gt;&lt;del&gt;SOLR-6406&lt;/del&gt;&lt;/a&gt;: fix race/hang in ConcurrentUpdateSolrClient.blockUntilFinished when executor service is shut down&lt;/p&gt;</comment>
                            <comment id="14990254" author="yseeley@gmail.com" created="Wed, 4 Nov 2015 19:41:22 +0000"  >&lt;p&gt;Reopening... something is wrong.&lt;/p&gt;

&lt;p&gt;Overview of what happened:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I tested my update to DistributedUpdateProcessor in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8203&quot; title=&quot;Stop processing updates more quickly on shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8203&quot;&gt;&lt;del&gt;SOLR-8203&lt;/del&gt;&lt;/a&gt; alone, and verified that there were no shard inconsistency failures&lt;/li&gt;
	&lt;li&gt;Mark tested his change to use shutdownNow on the updateExecutor alone (w/o my change), and reported no shard inconsistency failures, but he did hit hangs, which led to me to tackle this issue&lt;/li&gt;
	&lt;li&gt;I tested this issue w/o my fix in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8203&quot; title=&quot;Stop processing updates more quickly on shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8203&quot;&gt;&lt;del&gt;SOLR-8203&lt;/del&gt;&lt;/a&gt;, to more easily reproduce the hang, and to verify it had been fixed - I was not looking for shard inconsistency failures&lt;/li&gt;
	&lt;li&gt;Now that both patches are committed, I&apos;m seeing shard inconsistency failures again!&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Either:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I messed up this patch somehow, causing updates to be further reordered&lt;/li&gt;
	&lt;li&gt;This idea of this patch is somehow incompatible with &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8203&quot; title=&quot;Stop processing updates more quickly on shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8203&quot;&gt;&lt;del&gt;SOLR-8203&lt;/del&gt;&lt;/a&gt; (unlikely)&lt;/li&gt;
	&lt;li&gt;Something else in trunk has changed (unlikely)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;First, I&apos;m going to go back to trunk w/o both of these patches and start with just the check in the DistributedUpdateProcessor, and move on from there until I find out what reintroduced the problem.&lt;/p&gt;</comment>
                            <comment id="14991961" author="yseeley@gmail.com" created="Thu, 5 Nov 2015 16:50:53 +0000"  >&lt;p&gt;Update: I looped 3 tests overnight...&lt;br/&gt;
1) trunk with shutdownNow on the update executor reverted&lt;br/&gt;
2) trunk with shutdownNow and the client changes in this patch reverted&lt;br/&gt;
3) plain trunk&lt;/p&gt;

&lt;p&gt;Only #3 resulted in inconsistent shards.  I&apos;m setting up some new variants to test now...&lt;/p&gt;</comment>
                            <comment id="14995263" author="yseeley@gmail.com" created="Sat, 7 Nov 2015 16:03:20 +0000"  >&lt;p&gt;The other variants:&lt;br/&gt;
 4) trunk with only client changes reverted (i.e. DUH check enabled, shutdownNow used)&lt;br/&gt;
 5) trunk with client + DUH changes reverted (i.e. only shutdownNow enabled)&lt;br/&gt;
 6) trunk with alternate client changes (only changes to blockUntilFinished)&lt;br/&gt;
 7) trunk with alternate client changes 2 (only changes to blockUntilFinished, but using former isTerminated instead of isShutdown) &lt;/p&gt;

&lt;p&gt;I managed to get inconsistent shard runs with all of these.&lt;br/&gt;
The common element is shutdownNow being used on the shard update executor.&lt;/p&gt;</comment>
                            <comment id="14997248" author="markrmiller@gmail.com" created="Mon, 9 Nov 2015 19:55:31 +0000"  >&lt;p&gt;Strange. I got over 300 runs without an out of sync with it originally. I have not tried on recent trunk or recent changes though.&lt;/p&gt;</comment>
                            <comment id="15001429" author="yseeley@gmail.com" created="Thu, 12 Nov 2015 00:56:24 +0000"  >&lt;p&gt;I was analyzing another &quot;shards-out-of-sync&quot; failure on trunk.&lt;br/&gt;
It looks like that certain update are just not being forwarded from the leader to a certain replica.&lt;/p&gt;

&lt;p&gt;Working theory: the max connections per host of the HttpClient is being hit, starving updates from certain update threads.&lt;br/&gt;
This could account for why shutdownNow on the update executor service is having such an impact.  In an orderly shutdown, all scheduled jobs will still be run (I think), which means that connections will be released, and the updates that were being starved will get to proceed.  But it&apos;s for exactly this reason that we should probably keep the shutdownNow... it mimics much better what will happen in real world situations when a node goes down.&lt;/p&gt;

&lt;p&gt;From this, it looks like max connections per host is 20:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;13404 INFO  (TEST-HdfsChaosMonkeyNothingIsSafeTest.test-seed#[A22375CC545D2B82]) [    ] o.a.s.h.c.HttpShardHandlerFactory created with socketTimeout : 90000,urlScheme : ,connTimeout : 15000,maxConnectionsPerHost : 20,maxConnections : 10000,corePoolSize : 0,maximumPoolSize : 2147483647,maxThreadIdleTime : 5,sizeOfQueue : -1,fairnessPolicy : &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;,useRetries : &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;,
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;edit: oops the above is for &lt;b&gt;search&lt;/b&gt; not updates.  The default for updates looks like it&apos;s 100, so harder to hit.  Although if we have a mix of streaming and non-streaming, and connections are not reused immediately, perhaps still possible.  Still digging along this line of logic.&lt;/p&gt;

&lt;p&gt;The test used 12 nodes (and 2 shards)... increasing the chance of hitting the max connections (since all nodes run on the same host).&lt;/p&gt;</comment>
                            <comment id="15009016" author="yseeley@gmail.com" created="Tue, 17 Nov 2015 16:58:46 +0000"  >&lt;p&gt;So increasing maxConnectionsPerHost didn&apos;t fix the problem.&lt;br/&gt;
I instrumented the ConcurrentUpdateSolrServer to try and understand what is happening when, and am analyzing some of those fails now.&lt;br/&gt;
They are all beyond the max size that can be uploaded to JIRA though, so I&apos;lll just put up a summary based on what I find.&lt;/p&gt;</comment>
                            <comment id="15261732" author="stephlag" created="Thu, 28 Apr 2016 08:17:00 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yonik%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;yonik@apache.org&quot;&gt;yonik@apache.org&lt;/a&gt; did you make any progress on this issue?&lt;/p&gt;</comment>
                            <comment id="15262332" author="yseeley@gmail.com" created="Thu, 28 Apr 2016 15:26:25 +0000"  >&lt;p&gt;Actually, since this issue is more about the hang in blockUntilFinished (and that&apos;s been fixed), this can be closed.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12718408">SOLR-6136</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12902452">SOLR-8129</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12907664">SOLR-8203</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12751050" name="CPU Sampling.png" size="17495" author="stephlag" created="Tue, 18 Aug 2015 15:41:52 +0000"/>
                            <attachment id="12769799" name="SOLR-6406.patch" size="16246" author="yseeley@gmail.com" created="Fri, 30 Oct 2015 15:45:41 +0000"/>
                            <attachment id="12768556" name="SOLR-6406.patch" size="2284" author="markrmiller@gmail.com" created="Sat, 24 Oct 2015 20:45:38 +0000"/>
                            <attachment id="12768553" name="SOLR-6406.patch" size="13171" author="yseeley@gmail.com" created="Sat, 24 Oct 2015 20:25:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 29 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1z8dz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>