<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:55:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-16670] Couldn&apos;t restore a backed up config set from S3</title>
                <link>https://issues.apache.org/jira/browse/SOLR-16670</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;&#160;&lt;br/&gt;
Solr 9.1.x doesn&apos;t currently allow me to make a full restore of a backup where the data and config set are stored on a S3 bucket. The error I have received each run is &quot;The specified key does not exist&quot;. Additionally, the full message is:&lt;br/&gt;
&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
An AmazonServiceException was thrown! [serviceName=S3] [awsRequestId=2C6] [httpStatus=404] [s3ErrorCode=NoSuchKey] [message=The specified key does not exist.] &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
After investigating&#160;the problem further, I have found that the path used to control whether it&apos;s a directory or not in the&#160;&lt;a href=&quot;https://github.com/apache/solr/blob/branch_9_1/solr/modules/s3-repository/src/java/org/apache/solr/s3/S3StorageClient.java#L323&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;isDirectory&lt;/a&gt;&#160;method makes the `&lt;a href=&quot;https://github.com/apache/solr/blob/branch_9_1/solr/modules/s3-repository/src/java/org/apache/solr/s3/S3StorageClient.java#L328&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;S3Client.headObject&lt;/a&gt;` method panic. On&#160;&lt;a href=&quot;https://github.com/apache/solr/blob/branch_9_1/solr/modules/s3-repository/src/java/org/apache/solr/s3/S3StorageClient.java#L324&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;line&lt;/a&gt;&#160;324,&#160;the path pointing to a file is transformed into a path leading to a slash. When a path, for example, is &quot;path1/path2/backup-name/collection-name/zk_backup_0/configs/config-set-v1/configoverlay.json&quot;, `sanitizedDirPath` adds a&#160;&lt;em&gt;slash&lt;/em&gt;&#160;&quot;/&quot; character to the end of the path as &quot;path1/path2/backup-name/collection-name/zk_backup_0/configs/config-set-v1/configoverlay.json&lt;font color=&quot;#ff0000&quot;&gt;/&lt;/font&gt;&quot;. Although I&apos;m able to restore the backup if the cluster already has the config schema definition in the zk, I cannot restore the backed up config schema files while&#160;creating an empty cluster due to this error.&lt;br/&gt;
&#160;&#160;&lt;br/&gt;
For the sake of this question, here I am describing the other parts;&lt;br/&gt;
&#160;&lt;br/&gt;
Backup definition:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; &amp;lt;backup&amp;gt;
&#160; &#160; &amp;lt;repository name=&lt;span class=&quot;code-quote&quot;&gt;&quot;s3-repo&quot;&lt;/span&gt; class=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.solr.s3.S3BackupRepository&quot;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;&amp;gt;
&#160; &#160; &#160; &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;s3.bucket.name&quot;&lt;/span&gt;&amp;gt;com.dev.bucket.backup.folder&amp;lt;/str&amp;gt;
&#160; &#160; &#160; &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;s3.region&quot;&lt;/span&gt;&amp;gt;us-east-2&amp;lt;/str&amp;gt;
&#160; &#160; &amp;lt;/repository&amp;gt;
&#160; &amp;lt;/backup&amp;gt; &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
The backup folder structure on S3:&lt;br/&gt;
&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
.
&#9492;&#9472;&#9472; bucket-name
&#160; &#160; &#9492;&#9472;&#9472; path1
&#160; &#160; &#160; &#160; &#9492;&#9472;&#9472; path2
&#160; &#160; &#160; &#160; &#160; &#160; &#9492;&#9472;&#9472; backup-name
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#9492;&#9472;&#9472; collection-name
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#9500;&#9472;&#9472; backup_0.properties
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#9500;&#9472;&#9472; index ...
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#9500;&#9472;&#9472; shard_backup_metadata
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#9474;&#160;&#160; &#9492;&#9472;&#9472; md_shard1_0.json
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#9492;&#9472;&#9472; zk_backup_0
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#9500;&#9472;&#9472; collection_state.json
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#9492;&#9472;&#9472; configs
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#9492;&#9472;&#9472; config-set-v1
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#9500;&#9472;&#9472; configoverlay.json
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#9500;&#9472;&#9472; solrconfig.xml
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#9500;&#9472;&#9472; stopwords.txt
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#9492;&#9472;&#9472; synonyms.txt &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;br/&gt;
The cURL request I use for restore:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
curl -i -X POST \
&#160; &#160;-H &lt;span class=&quot;code-quote&quot;&gt;&quot;Content-Type:application/json&quot;&lt;/span&gt; \
&#160; &#160;-d \
&apos;{
&#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;restore-collection&quot;&lt;/span&gt;: {
&#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;backup-name&quot;&lt;/span&gt;,
&#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;collection&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;collection-name-restored&quot;&lt;/span&gt;,
&#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;location&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;path1/path2/&quot;&lt;/span&gt;
&#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;repository&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;s3-pro&quot;&lt;/span&gt;,
&#160; }
}&apos; \
&#160;&lt;span class=&quot;code-quote&quot;&gt;&apos;http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8983/api/c&apos;&lt;/span&gt; &lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This is the original &lt;a href=&quot;https://lists.apache.org/thread/krrn3z5q4891fzcxs5dgcgkoohs86ncs&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;question&lt;/a&gt; providing the same description.&lt;br/&gt;
&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13525248">SOLR-16670</key>
            <summary>Couldn&apos;t restore a backed up config set from S3</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="houston">Houston Putman</assignee>
                                    <reporter username="ozlerhakan">Hakan &#214;zler</reporter>
                        <labels>
                            <label>Restore</label>
                            <label>S3</label>
                            <label>aws-s3</label>
                    </labels>
                <created>Fri, 17 Feb 2023 19:23:37 +0000</created>
                <updated>Mon, 27 Mar 2023 18:07:30 +0000</updated>
                            <resolved>Wed, 22 Feb 2023 01:42:10 +0000</resolved>
                                    <version>9.1</version>
                    <version>9.1.1</version>
                                    <fixVersion>9.2</fixVersion>
                                    <component>Backup/Restore</component>
                    <component>contrib - S3 Repository</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17691450" author="houston" created="Tue, 21 Feb 2023 08:13:13 +0000"  >&lt;p&gt;&#160;I&apos;ve created a PR that might address this, but for the life of me I cannot reproduce the failure/fix in one of the unit tests (via S3IncrementalBackupTest). Would you be able to test this out?&lt;/p&gt;</comment>
                            <comment id="17691505" author="JIRAUSER298933" created="Tue, 21 Feb 2023 10:30:55 +0000"  >&lt;p&gt;I&apos;ll let you know about the result.&lt;/p&gt;</comment>
                            <comment id="17691535" author="JIRAUSER298933" created="Tue, 21 Feb 2023 11:33:39 +0000"  >&lt;p&gt;It definitely addresses the issue! You could add another assert to the &lt;a href=&quot;https://github.com/apache/solr/blob/main/solr/modules/s3-repository/src/test/org/apache/solr/s3/S3PathsTest.java#L46&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testDirectory&lt;/a&gt; method to produce the exception. For example:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
assertFalse(&lt;span class=&quot;code-quote&quot;&gt;&quot;File should not exist in the path&quot;&lt;/span&gt;, client.isDirectory(&lt;span class=&quot;code-quote&quot;&gt;&quot;/simple-directory/empty.xml&quot;&lt;/span&gt;));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17691829" author="houston" created="Wed, 22 Feb 2023 00:05:56 +0000"  >&lt;p&gt;So unfortunately it doesn&apos;t look like our test S3 framework throws the right error here. I added a test, and it works with the code change or without the code change.&lt;/p&gt;

&lt;p&gt;I didn&apos;t notice before, but the &lt;tt&gt;pathExists()&lt;/tt&gt; method uses the exact same logic. So I think this is safe. I&apos;ll add the test anyways, so that hopefully one day the s3 framework will throw the right error and we can check for it!&lt;/p&gt;</comment>
                            <comment id="17691856" author="jira-bot" created="Wed, 22 Feb 2023 01:35:09 +0000"  >&lt;p&gt;Commit 7bdebb2bd02584eb39761ba5ac563c214ba5c901 in solr&apos;s branch refs/heads/main from Houston Putman&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=7bdebb2bd02&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=7bdebb2bd02&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16670&quot; title=&quot;Couldn&amp;#39;t restore a backed up config set from S3&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16670&quot;&gt;&lt;del&gt;SOLR-16670&lt;/del&gt;&lt;/a&gt;: Fix 404 error in S3 directory check (#1373)&lt;/p&gt;
</comment>
                            <comment id="17691859" author="jira-bot" created="Wed, 22 Feb 2023 01:40:59 +0000"  >&lt;p&gt;Commit d192626dd69a07b63f19955ff0745a326c1ab4d4 in solr&apos;s branch refs/heads/branch_9x from Houston Putman&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=d192626dd69&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=d192626dd69&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16670&quot; title=&quot;Couldn&amp;#39;t restore a backed up config set from S3&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16670&quot;&gt;&lt;del&gt;SOLR-16670&lt;/del&gt;&lt;/a&gt;: Fix 404 error in S3 directory check (#1373)&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 7bdebb2bd02584eb39761ba5ac563c214ba5c901)&lt;/p&gt;</comment>
                            <comment id="17705579" author="houston" created="Mon, 27 Mar 2023 18:04:21 +0000"  >&lt;p&gt;Closing after the 9.2.0 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 33 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1g0wg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>