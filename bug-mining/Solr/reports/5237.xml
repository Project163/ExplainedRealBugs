<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:11:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-17413] UpdateLog Replay can throw ConcurrentModificationException from sharing the request</title>
                <link>https://issues.apache.org/jira/browse/SOLR-17413</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;I saw org.apache.solr.cloud.BasicDistributedZkTest fail with a stack trace revealing we have a real issue with UpdateLog replay.  Essentially, a SolrQueryRequest is not threadsafe but we replay logs in parallel sharing the same request instance.  Creating DistributedUpdateProcessor ends up adding to a shared HashMap in req.getContext() that should not be shared.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  2&amp;gt; WARNING: Uncaught exception in thread: Thread[replayUpdatesExecutor-590-thread-2,5,TGRP-BasicDistributedZkTest]
  2&amp;gt; java.util.ConcurrentModificationException
  2&amp;gt; 	at __randomizedtesting.SeedInfo.seed([F2227B12A8FC234]:0)
  2&amp;gt; 	at java.base/java.util.HashMap.computeIfAbsent(HashMap.java:1135)
  2&amp;gt; 	at org.apache.solr.update.processor.DistributedUpdateProcessorFactory.addParamToDistributedRequestWhitelist(DistributedUpdateProcessorFactory.java:46)
  2&amp;gt; 	at org.apache.solr.update.processor.DistributedUpdateProcessor.&amp;lt;init&amp;gt;(DistributedUpdateProcessor.java:190)
  2&amp;gt; 	at org.apache.solr.update.processor.DistributedUpdateProcessor.&amp;lt;init&amp;gt;(DistributedUpdateProcessor.java:160)
  2&amp;gt; 	at org.apache.solr.update.processor.DistributedZkUpdateProcessor.&amp;lt;init&amp;gt;(DistributedZkUpdateProcessor.java:114)
  2&amp;gt; 	at org.apache.solr.update.processor.DistributedUpdateProcessorFactory.getInstance(DistributedUpdateProcessorFactory.java:59)
  2&amp;gt; 	at org.apache.solr.update.processor.UpdateRequestProcessorChain.createProcessor(UpdateRequestProcessorChain.java:242)
  2&amp;gt; 	at org.apache.solr.update.processor.UpdateRequestProcessorChain.createProcessor(UpdateRequestProcessorChain.java:214)
  2&amp;gt; 	at org.apache.solr.update.UpdateLog$LogReplayer.lambda$doReplay$0(UpdateLog.java:2103)
  2&amp;gt; 	at java.base/java.lang.ThreadLocal$SuppliedThreadLocal.initialValue(ThreadLocal.java:305)
  2&amp;gt; 	at java.base/java.lang.ThreadLocal.setInitialValue(ThreadLocal.java:195)
  2&amp;gt; 	at java.base/java.lang.ThreadLocal.get(ThreadLocal.java:172)
  2&amp;gt; 	at org.apache.solr.update.UpdateLog$LogReplayer.lambda$execute$2(UpdateLog.java:2342)
  2&amp;gt; 	at org.apache.solr.util.OrderedExecutor.lambda$execute$0(OrderedExecutor.java:68)
  2&amp;gt; 	at org.apache.solr.common.util.ExecutorUtil$MDCAwareThreadPoolExecutor.lambda$execute$1(ExecutorUtil.java:449)
  2&amp;gt; 	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)
  2&amp;gt; 	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)
  2&amp;gt; 	at java.base/java.lang.Thread.run(Thread.java:829)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13589524">SOLR-17413</key>
            <summary>UpdateLog Replay can throw ConcurrentModificationException from sharing the request</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gerlowskija">Jason Gerlowski</assignee>
                                    <reporter username="dsmiley">David Smiley</reporter>
                        <labels>
                            <label>newdev</label>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 21 Aug 2024 02:55:48 +0000</created>
                <updated>Fri, 18 Apr 2025 18:14:49 +0000</updated>
                            <resolved>Mon, 28 Oct 2024 19:11:09 +0000</resolved>
                                                    <fixVersion>9.8</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="6600">1h 50m</timespent>
                                <comments>
                            <comment id="17875329" author="dsmiley" created="Wed, 21 Aug 2024 03:06:41 +0000"  >&lt;p&gt;This should be somewhat straightforward to fix by creating a copy of the request in the ThreadLocal.withInitial lambda.&lt;/p&gt;</comment>
                            <comment id="17875506" author="dsmiley" created="Wed, 21 Aug 2024 14:11:16 +0000"  >&lt;p&gt;I&apos;d prefer to avoid catching this exception to take some other action &amp;#8211; would feel too much like a hack.  I&apos;m optimistic a more elegant solution without doing this can be found.&lt;/p&gt;

&lt;p&gt;Perhaps SynchronousQueue?  Maybe I can rule this out based on a little test I did, as it throws a RejectedExecutionException (instead of blocking), which I&apos;d rather not catch.&lt;/p&gt;

&lt;p&gt;Perhaps a LinkedBlockingQueue (thus infinite queue size) but have an ExecutorService subclass that observes the queue size to see if a threshold is reached and if so then runs the task directly?  This way we never reject and the caller threads receive back pressure by doing the work that they would have done anyway with multiThreaded=false ! There is plenty of precedent for an ExecutorService that runs the task in the caller thread &amp;#8211; I&apos;m thinking of Lucene&apos;s SameThreadExecutorService and Solr&apos;s SimpleFacets.directExecutor.&lt;/p&gt;</comment>
                            <comment id="17889281" author="gerlowskija" created="Mon, 14 Oct 2024 17:30:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;This should be somewhat straightforward to fix by creating a copy of the request in the ThreadLocal.withInitial lambda.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I like this approach for its simplicity.  IMO it also tracks in terms of the &quot;Principle of Least Surprise&quot; - creating copies is a pretty standard way to work around threadsafety limitations.  Gonna try to reproduce this in tests today, and will create a PR if I can validate the fix.&lt;/p&gt;</comment>
                            <comment id="17889664" author="gerlowskija" created="Tue, 15 Oct 2024 13:34:39 +0000"  >&lt;p&gt;The failure shows very rarely, but I am able to reproduce it on my local machine when using a very high number of iterations:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
./gradlew -p solr/core test --tests BasicDistributedZkTest -Ptests.iters=300 -Ptests.dups=4
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;ve created a PR for the fix &lt;a href=&quot;https://github.com/apache/solr/pull/2765&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, which allows BasicDistributedZkTest to reliably succeed.  Will kick off a few more high-iteration runs to make sure I haven&apos;t just gotten &quot;lucky&quot;, but seems like this works &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/thumbs_up.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17893567" author="jira-bot" created="Mon, 28 Oct 2024 18:12:26 +0000"  >&lt;p&gt;Commit 0b4157a8d83225d46e21087c4c0c610defc17e35 in solr&apos;s branch refs/heads/main from Jason Gerlowski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=0b4157a8d83&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=0b4157a8d83&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17413&quot; title=&quot;UpdateLog Replay can throw ConcurrentModificationException from sharing the request&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17413&quot;&gt;&lt;del&gt;SOLR-17413&lt;/del&gt;&lt;/a&gt;: ulog replay should copy SolrQueryRequest (#2765)&lt;/p&gt;

&lt;p&gt;SolrQueryRequest is a non-threadsafe type, but was being shared across&lt;br/&gt;
executor threads during UpdateLog replay.  This introduces a number of&lt;br/&gt;
issues, not the least being a ConcurrentModificationException if&lt;br/&gt;
multiple threads happen to tweak the request &apos;context&apos; simultaneously.&lt;/p&gt;

&lt;p&gt;This commit fixes this issue by giving each executor thread a unique&lt;br/&gt;
LocalSolrQueryRequest instance to use.&lt;/p&gt;</comment>
                            <comment id="17893571" author="jira-bot" created="Mon, 28 Oct 2024 18:19:59 +0000"  >&lt;p&gt;Commit a15e6f4278523f2a23ad35246fe7e34bf531e12f in solr&apos;s branch refs/heads/branch_9x from Jason Gerlowski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=a15e6f42785&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=a15e6f42785&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17413&quot; title=&quot;UpdateLog Replay can throw ConcurrentModificationException from sharing the request&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17413&quot;&gt;&lt;del&gt;SOLR-17413&lt;/del&gt;&lt;/a&gt;: ulog replay should copy SolrQueryRequest (#2765)&lt;/p&gt;

&lt;p&gt;SolrQueryRequest is a non-threadsafe type, but was being shared across&lt;br/&gt;
executor threads during UpdateLog replay.  This introduces a number of&lt;br/&gt;
issues, not the least being a ConcurrentModificationException if&lt;br/&gt;
multiple threads happen to tweak the request &apos;context&apos; simultaneously.&lt;/p&gt;

&lt;p&gt;This commit fixes this issue by giving each executor thread a unique&lt;br/&gt;
LocalSolrQueryRequest instance to use.&lt;/p&gt;</comment>
                            <comment id="17921951" author="anshumg" created="Tue, 28 Jan 2025 22:17:54 +0000"  >&lt;p&gt;Closing after the 9.8.0 release&lt;/p&gt;</comment>
                            <comment id="17945729" author="jira-bot" created="Fri, 18 Apr 2025 18:14:49 +0000"  >&lt;p&gt;Commit 3dd3a96f09c89f5d6a9f2915256aface46a4a8a0 in solr&apos;s branch refs/heads/add-pki-caching from Jason Gerlowski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=3dd3a96f09c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=3dd3a96f09c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17413&quot; title=&quot;UpdateLog Replay can throw ConcurrentModificationException from sharing the request&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17413&quot;&gt;&lt;del&gt;SOLR-17413&lt;/del&gt;&lt;/a&gt;: ulog replay should copy SolrQueryRequest (#110)&lt;/p&gt;

&lt;p&gt;SolrQueryRequest is a non-threadsafe type, but was being shared across&lt;br/&gt;
executor threads during UpdateLog replay.  This introduces a number of&lt;br/&gt;
issues, not the least being a ConcurrentModificationException if&lt;br/&gt;
multiple threads happen to tweak the request &apos;context&apos; simultaneously.&lt;/p&gt;

&lt;p&gt;This commit fixes this issue by giving each executor thread a unique&lt;br/&gt;
LocalSolrQueryRequest instance to use.&lt;/p&gt;

&lt;p&gt;NOTE: This fix is on its way to 9.8 upstream, but may take a slightly&lt;br/&gt;
different final form.&lt;/p&gt;

&lt;p&gt;Co-authored-by: Jason Gerlowski &amp;lt;gerlowskija@apache.org&amp;gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13158357">SOLR-12338</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13426676">SOLR-15983</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            29 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1qz6o:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>