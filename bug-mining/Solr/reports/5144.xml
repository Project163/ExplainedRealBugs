<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:09:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-16949] RCE via Backup/Restore APIs - Fix for all file extensions</title>
                <link>https://issues.apache.org/jira/browse/SOLR-16949</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Before an 8.11.3 release, &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16480&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-16480&lt;/a&gt; needs to be backported, thus creating this as a blocker.&lt;/p&gt;

&lt;p&gt;Here I am assuming that 8.x is vulnerable to the same attack, which should be investigated.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13548490">SOLR-16949</key>
            <summary>RCE via Backup/Restore APIs - Fix for all file extensions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="janhoy">Jan H&#248;ydahl</assignee>
                                    <reporter username="janhoy">Jan H&#248;ydahl</reporter>
                        <labels>
                    </labels>
                <created>Thu, 24 Aug 2023 09:42:07 +0000</created>
                <updated>Fri, 9 Feb 2024 16:45:56 +0000</updated>
                            <resolved>Wed, 13 Dec 2023 22:54:24 +0000</resolved>
                                    <version>8.11.2</version>
                                    <fixVersion>8.11.3</fixVersion>
                    <fixVersion>9.5</fixVersion>
                    <fixVersion>9.4.1</fixVersion>
                                    <component>Backup/Restore</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17784102" author="janhoy" created="Wed, 8 Nov 2023 15:43:25 +0000"  >&lt;p&gt;See attached patch. It is not a back port of &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16480&quot; title=&quot;RCE via Backup/Restore APIs that allow for deployment of executables in malicious ConfigSets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16480&quot;&gt;&lt;del&gt;SOLR-16480&lt;/del&gt;&lt;/a&gt; and is not for branch_8_11, but for main.&lt;br/&gt;
It adds a file content MAGIC check for each location where we today call &lt;tt&gt;ZkMaintenanceUtils.isFileForbiddenInConfigSets()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I.e. it will peek inside each file and use &quot;libmagic&quot; style detection based on a config file in resources/magic folder. There exists thousands of matching rules for all kid of file formats (see &lt;a href=&quot;https://github.com/file/file/tree/master/magic/Magdir&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/file/file/tree/master/magic/Magdir&lt;/a&gt;), but I copied rules for ZIP, TAR and CLASS, and made a simple regex rule for shell scripts.&lt;/p&gt;

&lt;p&gt;As an alternative to using the &lt;a href=&quot;https://github.com/j256/simplemagic&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/j256/simplemagic&lt;/a&gt; library (which is not super well maintained) would be to write our own detection rules in Java, which would not be too hard for JAR and CLASS which are the most important.&lt;/p&gt;</comment>
                            <comment id="17784515" author="houston" created="Thu, 9 Nov 2023 15:29:58 +0000"  >&lt;p&gt;This is definitely not a requirement for the change, but we should get rid of the file type extension stuff that I added in.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Otherwise that looks like a really good patch, thanks for the awesome work here Jan!&lt;/p&gt;</comment>
                            <comment id="17784921" author="janhoy" created="Fri, 10 Nov 2023 12:41:52 +0000"  >&lt;p&gt;So we now have three options for safeguarding 8.11.3 against this attack:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;This patch (replacing filename suffix solution). It is way safer and I cannot think of a way an attacker could circumvent it, other than crafting a .jar or .class file that we cannot detect&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16781&quot; title=&quot;Remove &amp;lt;lib&amp;gt; directives from Solr&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16781&quot;&gt;&lt;del&gt;SOLR-16781&lt;/del&gt;&lt;/a&gt; to feature toggle &amp;lt;lib&amp;gt; directives (keep old behavior by default)&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/solr/pull/2068&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/solr/pull/2068&lt;/a&gt; to feature toggle BACKUP to local file system (keep disabled by default)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;If we choose 1 we may not urgently need 2 or 3. But we may want to proceed with 2 for other reasons later.&lt;br/&gt;
If we choose 2, we don&apos;t plug the hole by defualt but will need to document a recommendation to disable.&lt;br/&gt;
If we choose 3 it will be a breaking change for users of BACKUP feature that needs to be documented.&lt;/p&gt;</comment>
                            <comment id="17784987" author="houston" created="Fri, 10 Nov 2023 15:35:07 +0000"  >&lt;p&gt;I choose Option 1 for all 8.11, 9.x, main&lt;/p&gt;

&lt;p&gt;Option 2 for 9.x, and remove &amp;lt;lib&amp;gt; in 10&lt;/p&gt;</comment>
                            <comment id="17785207" author="janhoy" created="Sat, 11 Nov 2023 19:07:00 +0000"  >&lt;p&gt;If anyone wants to expedite this, feel free to grab this. I won&apos;t be able to continue until mid next week.&lt;/p&gt;</comment>
                            <comment id="17785209" author="janhoy" created="Sat, 11 Nov 2023 19:22:04 +0000"  >&lt;p&gt;&amp;gt; we should get rid of the file type extension stuff that I added in.&lt;/p&gt;

&lt;p&gt;Formally that cannot be removed until 10.0. We could document the deprecation of the extension feature together with this patch, and open a new Jira to remove the code in main.&lt;/p&gt;</comment>
                            <comment id="17787527" author="ichattopadhyaya" created="Sat, 18 Nov 2023 19:57:33 +0000"  >&lt;blockquote&gt;&lt;p&gt;I won&apos;t be able to continue until mid next week.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Would you be able to get to this soon? If so, I&apos;ll wait for you to get it in and then spin RC2.&lt;/p&gt;</comment>
                            <comment id="17787607" author="janhoy" created="Sun, 19 Nov 2023 14:53:26 +0000"  >&lt;p&gt;I can give backporting an attempt...&lt;/p&gt;</comment>
                            <comment id="17787686" author="janhoy" created="Mon, 20 Nov 2023 00:11:24 +0000"  >&lt;p&gt;Uploaded a patch for branch_8_11 &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13064513/13064513_SOLR-16949-8_11.patch&quot; title=&quot;SOLR-16949-8_11.patch attached to SOLR-16949&quot;&gt;SOLR-16949-8_11.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;It is based on the other patch, but with tweaks to make it fit the older codebase.&lt;/p&gt;

&lt;p&gt;As a workarodnd for the fact that the new FileTypeMagicUtil is in core and not in solrj, and therefore cannot be used by&#160;&lt;br/&gt;
ZkMaintenanceUtils where we have methods like uploadToZK() and zkTransfer(), I added a check in SolrCLI before uploading a configset with either solr zk upconfig or solr create -c foo -d folder/. It is not perfect, but I did not want to introduce a new jar dependency to solrj, and I did not fancy writing the detectors myself.&lt;/p&gt;</comment>
                            <comment id="17788575" author="janhoy" created="Wed, 22 Nov 2023 00:00:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ichattopadhyaya&quot; class=&quot;user-hover&quot; rel=&quot;ichattopadhyaya&quot;&gt;ichattopadhyaya&lt;/a&gt; please take it for a spin if you like. So with this we fail fast if the configSet contains a sh, zip, jar, tar or class file&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;When uploading configset with bin/solr&lt;/li&gt;
	&lt;li&gt;When uploading configset through configset API&lt;/li&gt;
	&lt;li&gt;When doing backup of a collection (skip file and warn, not abort)&lt;/li&gt;
	&lt;li&gt;When restoring a configset from a backup into zookeeper (skip file and warn, not abort)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The patch contains some tests but not extensive integration tests here. I have run the entire test suite with ant. No refguide or CHANGES so far.&lt;/p&gt;

&lt;p&gt;When reviewing, pay special attention to&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Do we detect enough file tyes?&lt;/li&gt;
	&lt;li&gt;Is the detection for each (especially jar) robust or can it be gamed?&lt;/li&gt;
	&lt;li&gt;Should the backup/restore fail instead of just skip file and warn when an illegal file is detected?&lt;/li&gt;
	&lt;li&gt;Try to customize &lt;tt&gt;solr.configset.upload.mimetypes.forbidden&lt;/tt&gt; sysprop&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Based on review feedback I may help to refine a time or two before commit. Or feel free to revise the patch at your liking. When the 8.x patch is solid, we can update the main-branch patch with the latest changes.&lt;/p&gt;</comment>
                            <comment id="17793927" author="houston" created="Wed, 6 Dec 2023 20:28:46 +0000"  >&lt;blockquote&gt;&lt;p&gt;As a workarodnd for the fact that the new FileTypeMagicUtil is in core and not in solrj, and therefore cannot be used by&#160;&lt;br/&gt;
ZkMaintenanceUtils where we have methods like uploadToZK() and zkTransfer(), I added a check in SolrCLI before uploading a configset with either solr zk upconfig or solr create -c foo -d folder/. It is not perfect, but I did not want to introduce a new jar dependency to solrj, and I did not fancy writing the detectors myself.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This also requires direct access to ZooKeeper, so I&apos;m not nearly as concerned.&lt;/p&gt;

&lt;p&gt;We can really only control the Solr ConfigSets API as well as any downloading of Zookeeper data to disk (Backups)&lt;/p&gt;
&lt;blockquote&gt;&lt;ul&gt;
	&lt;li&gt;Do we detect enough file tyes?&lt;/li&gt;
	&lt;li&gt;Is the detection for each (especially jar) robust or can it be gamed?&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;Maybe it would be helpful to add a second level of security here.&lt;br/&gt;
Most of the places that would be dangerous to allow jars/class files to be backed up to are &quot;lib/&quot; directories. (/solr/lib, /solr/modules/&amp;lt;&amp;gt;/lib, /solr-home/lib, /solr-core/lib, etc)&lt;br/&gt;
We could basically forbid saving anything to a &quot;lib&quot; folder, or to a known classloader folder (like shared-lib).&lt;/p&gt;</comment>
                            <comment id="17793946" author="houston" created="Wed, 6 Dec 2023 22:39:01 +0000"  >&lt;blockquote&gt;&lt;p&gt;Maybe it would be helpful to add a second level of security here.&lt;br/&gt;
Most of the places that would be dangerous to allow jars/class files to be backed up to are &quot;lib/&quot; directories. (/solr/lib, /solr/modules/&amp;lt;&amp;gt;/lib, /solr-home/lib, /solr-core/lib, etc)&lt;br/&gt;
We could basically forbid saving anything to a &quot;lib&quot; folder, or to a known classloader folder (like shared-lib).&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Ok I went ahead and tried this out, adding it as &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16949&quot; title=&quot;RCE via Backup/Restore APIs - Fix for all file extensions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16949&quot;&gt;&lt;del&gt;SOLR-16949&lt;/del&gt;&lt;/a&gt;-main-protect-lib.patch&lt;/p&gt;

&lt;p&gt;This is independent of the other patch, but ultimately I think both should be merged. Thoughts?&lt;/p&gt;</comment>
                            <comment id="17794096" author="janhoy" created="Thu, 7 Dec 2023 09:02:20 +0000"  >&lt;p&gt;Thanks for review Houston.&lt;/p&gt;

&lt;p&gt;The protected lib technique is orthogonal and would definitely add another layer. Should that patch perhaps ripple down from main -&amp;gt; 9x -&amp;gt; 9.4.1 -&amp;gt; 8.11.3, or do&#160; you want to land it in 8.11.3 first?&lt;/p&gt;

&lt;p&gt;We urgently want to get 8.11.3 and 9.4.1 out the door, so I think it needs to land both places anyway.&lt;/p&gt;</comment>
                            <comment id="17794308" author="houston" created="Thu, 7 Dec 2023 15:37:32 +0000"  >&lt;p&gt;Thanks for agreeing Jan. If you have time to review, I&apos;ll make it ready for commit and then do the regular main -&amp;gt; 9x -&amp;gt; 9.4.1 -&amp;gt; 8.11.3 workflow.&lt;/p&gt;</comment>
                            <comment id="17794324" author="janhoy" created="Thu, 7 Dec 2023 16:03:32 +0000"  >&lt;p&gt;The protected path feature can be added in the open, right, as it does not reveal any undisclosed CVE to anyone, it is just an additional hardening against potential future undiscovered attacks. I&apos;ll try to review PRs.&lt;/p&gt;</comment>
                            <comment id="17794338" author="houston" created="Thu, 7 Dec 2023 16:34:21 +0000"  >&lt;p&gt;Hmm I guess, its a different way of solving the same vulnerability, so I&apos;m not sure it can be done openly. Happy to make a public JIRA/PR if y&apos;all think its ok.&lt;/p&gt;</comment>
                            <comment id="17794423" author="houston" created="Thu, 7 Dec 2023 20:26:27 +0000"  >&lt;p&gt;Added more tests, and fixed something that the tests found. It should be close to ready I think.&lt;/p&gt;</comment>
                            <comment id="17794465" author="dsmiley" created="Thu, 7 Dec 2023 22:50:59 +0000"  >&lt;p&gt;I&apos;m trying to get up to speed on what&apos;s happening here and I&apos;m confused. &#160;If the problem relates to being able to tell Solr to backup stuff to locations that shouldn&apos;t be (i.e. to places inside Solr), can&apos;t we have a simple allowList approach? &#160;Maybe the parent issue &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16480&quot; title=&quot;RCE via Backup/Restore APIs that allow for deployment of executables in malicious ConfigSets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16480&quot;&gt;&lt;del&gt;SOLR-16480&lt;/del&gt;&lt;/a&gt; is what matters and not this backport one? &#160;I see my &quot;slippery slope&quot; comment there and it really still resonates me... we are going down a slippery slope alright.&lt;/p&gt;</comment>
                            <comment id="17794466" author="houston" created="Thu, 7 Dec 2023 23:01:28 +0000"  >&lt;p&gt;I&apos;d appreciate it if you would expand on &quot;slippery slope&quot; when you use that phrase. I don&apos;t think having a list of &quot;protected paths&quot; that don&apos;t allow writes is anything crazy. I also think limiting the file types that we allow in configSets is perfectly acceptable.&lt;/p&gt;

&lt;p&gt;I have no issue with also adding an &quot;allowList&quot; for backups.&lt;br/&gt;
The big difference being that this is back-compat for good-faith users for 9x and 8.11, whereas allowList wouldn&apos;t be.&lt;/p&gt;</comment>
                            <comment id="17794490" author="dsmiley" created="Fri, 8 Dec 2023 02:29:05 +0000"  >&lt;p&gt;The slippery slope is a cat &amp;amp; mouse game with someone who observes these... what I consider band-aids, and sees something we missed, and this continues. &#160;If we protect certain paths but forget one, is that then CVE worthy? &#160;I&apos;d argue instead that we should require the installer user, the one who can configure solr.xml &amp;amp; startup, to choose the allowList paths that are okay. &#160;A similar mindset for file extensions if we want to block based on them.&lt;/p&gt;

&lt;p&gt;RE back-combat; IMO it&apos;s reasonable to require that an upgrading user further specify certain startup/solr.xml options that didn&apos;t exist before, in the name of security. &#160;Perhaps some good defaults could mean no action is necessary for some users. &#160;Maybe &quot;/var&quot; is pre-approved. &#160;Maybe furthermore we shouldn&apos;t load libs from a &quot;/var&quot; path unless the configuration is explicit about using such a path. &#160;Just brainstorming a bit.&lt;/p&gt;</comment>
                            <comment id="17794786" author="janhoy" created="Fri, 8 Dec 2023 16:11:23 +0000"  >&lt;p&gt;I don&apos;t think it hurts to add multiple layers of security.&lt;/p&gt;

&lt;p&gt;However, the root cause of this issue is that it is even allowed to define a file-system backup outside of the &quot;location&quot; that is defined in solr.xml as the backup repository location, see &lt;a href=&quot;https://solr.apache.org/guide/solr/latest/deployment-guide/backup-restore.html#localfilesystemrepository&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://solr.apache.org/guide/solr/latest/deployment-guide/backup-restore.html#localfilesystemrepository&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;What if we modified the &lt;tt&gt;LocalFileSystemRepository&lt;/tt&gt; to restrict the backup location to be within the statically configured location? Then attackers whould need to figure out how to add that admin-decided location to classpath, or to create a core inside that location. Or something else.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;backup&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;repository name=&lt;span class=&quot;code-quote&quot;&gt;&quot;local_repo&quot;&lt;/span&gt; class=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.solr.core.backup.repository.LocalFileSystemRepository&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;location&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;/solr/backup_data&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/str&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/repository&amp;gt;&lt;/span&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/backup&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17794794" author="houston" created="Fri, 8 Dec 2023 16:27:10 +0000"  >&lt;blockquote&gt;&lt;p&gt;If we protect certain paths but forget one, is that then CVE worthy?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;With two layers of protection, I think we&apos;d be pretty safe from having to issue another CVE, but obviously there is always the possibility.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&#160;I&apos;d argue instead that we should require the installer user, the one who can configure solr.xml &amp;amp; startup, to choose the allowList paths that are okay.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The &quot;allowBackupPath&quot; you suggest is really close to the &quot;allowPaths&quot; logic we already have, however it really just adds &quot;SOLR_HOME&quot;, &quot;SOLR_DATA_HOME&quot; and &quot;coreRootDirectory&quot;.&lt;br/&gt;
&quot;SOLR_DATA_HOME&quot; is fine, no libraries are loaded from there. &quot;SOLR_HOME&quot; has &quot;SOLR_HOME/lib&quot; and &quot;coreRootDirectory&quot; has &quot;coreRootDirectory/lib&quot;.&lt;br/&gt;
Lastly, &quot;sharedLib&quot; might be included under &quot;allowPaths&quot;, so we can forbid that just for the sake of being cautious.&lt;br/&gt;
The other logic in the protections merely exist to be extra cautious.&lt;/p&gt;

&lt;p&gt;Basically this is one less configuration a user needs to care about, but adds extra checks to make sure they can&apos;t shoot themselves in the foot.&lt;br/&gt;
(e.g. even if the &quot;allowBackupPath&quot; option existed, they could set it to a folder that included their SOLR_HOME, which would make them vulnerable)&lt;/p&gt;

&lt;p&gt;That&apos;s basically what this PR is, although extra protected paths have been added just to be extra cautious&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;RE back-combat; IMO it&apos;s reasonable to require that an upgrading user further specify certain startup/solr.xml options that didn&apos;t exist before, in the name of security.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I agree for a minor version, but this would be a fairly big change for users in a patch change, especially when there are options that aren&apos;t back-compat breaking.&lt;/p&gt;

&lt;p&gt;Users using an &quot;8.11&quot; docker image, to auto-receive security updates, would see their backups start failing automatically.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Perhaps some good defaults could mean no action is necessary for some users. &#160;Maybe &quot;/var&quot; is pre-approved.&#160;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I don&apos;t like the ideas of defaults when Solr has no guidelines for how a filesystem should be setup.&lt;br/&gt;
Using &quot;/var&quot; as a default wouldn&apos;t work because the SOLR_HOME/lib and SOLR_CORE/lib could easily be under &quot;/var&quot;, like they are in the Docker image.&lt;/p&gt;</comment>
                            <comment id="17794795" author="dsmiley" created="Fri, 8 Dec 2023 16:29:04 +0000"  >&lt;p&gt;Looks good Jan.&lt;/p&gt;

&lt;p&gt;And maybe the &quot;slipper slope&quot; metaphor isn&apos;t the right metaphor&lt;/p&gt;</comment>
                            <comment id="17794798" author="houston" created="Fri, 8 Dec 2023 16:37:27 +0000"  >&lt;p&gt;Jan, I think making the location required going forward is a good idea. And all paths provided in the API would need to be relative to that location (without &quot;../&quot;).&lt;/p&gt;

&lt;p&gt;But I think for 8.11 at least (and probably 9.4.1), we would need to protect without making &quot;location&quot; mandatory. (As I&apos;ve mentioned before).&lt;/p&gt;</comment>
                            <comment id="17794852" author="janhoy" created="Fri, 8 Dec 2023 20:37:36 +0000"  >&lt;p&gt;Did some basic cleanup of the 8.11 patch, added some javadoc, when traversing folders, skip only &quot;.&quot; and &quot;..&quot;, not every folder starting with a &quot;.&quot;. Ran &quot;ant precommit&quot;.&lt;/p&gt;

&lt;p&gt;Do you have a suggestion for CHANGES.txt entry and JIRA number to use? &lt;/p&gt;</comment>
                            <comment id="17795950" author="houston" created="Tue, 12 Dec 2023 22:09:45 +0000"  >&lt;p&gt;Looks good to me Jan. I would use this JIRA. And something simple like &quot;Restrict certain file types from being uploaded with or downloaded from Config Sets.&quot;&lt;/p&gt;</comment>
                            <comment id="17796212" author="janhoy" created="Wed, 13 Dec 2023 12:01:48 +0000"  >&lt;p&gt;Pushed to branch_8_11 in &lt;a href=&quot;https://github.com/apache/lucene-solr/commit/7e9a2e67f812032a049836c3aa0b18bf5cd717f9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/commit/7e9a2e67f812032a049836c3aa0b18bf5cd717f9&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17796302" author="janhoy" created="Wed, 13 Dec 2023 14:31:47 +0000"  >&lt;p&gt;I have updated the patch for main branch with latest updates from 8.11 patch:  &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13064266/13064266_SOLR-16949.patch&quot; title=&quot;SOLR-16949.patch attached to SOLR-16949&quot;&gt;SOLR-16949.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Precommit passes and I am ready to merge. Do we want to avoid the extra publicity that a PR gives, by pushing directly from the command line? If so, I&apos;m grateful for a patch review of the updated patch.&lt;/p&gt;

&lt;p&gt;Note: I kept the patch from &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16480&quot; title=&quot;RCE via Backup/Restore APIs that allow for deployment of executables in malicious ConfigSets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16480&quot;&gt;&lt;del&gt;SOLR-16480&lt;/del&gt;&lt;/a&gt; intact, but we could do another JIRA to remove that filename-suffix feature from main branch after this has landed.&lt;/p&gt;</comment>
                            <comment id="17796352" author="houston" created="Wed, 13 Dec 2023 15:30:43 +0000"  >&lt;p&gt;That patch for main looks good to me Jan, I would push directly to main (and backport of course) without PRs.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;As for &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16480&quot; title=&quot;RCE via Backup/Restore APIs that allow for deployment of executables in malicious ConfigSets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16480&quot;&gt;&lt;del&gt;SOLR-16480&lt;/del&gt;&lt;/a&gt;, I do think we should have a Jira to remove that in main, after this has landed.&lt;/p&gt;</comment>
                            <comment id="17796489" author="janhoy" created="Wed, 13 Dec 2023 22:54:24 +0000"  >&lt;p&gt;main: &lt;a href=&quot;https://github.com/apache/solr/commit/15534754f492079e52288dd11abaf1c4261b3ea4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/solr/commit/15534754f492079e52288dd11abaf1c4261b3ea4&lt;/a&gt;&lt;br/&gt;
branch_9x: &lt;a href=&quot;https://github.com/apache/solr/commit/644dd3a6d6780d71030f7070754d2f3adce22859&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/solr/commit/644dd3a6d6780d71030f7070754d2f3adce22859&lt;/a&gt;&lt;br/&gt;
branch_9_4: &lt;a href=&quot;https://github.com/apache/solr/commit/ad6854b04361e351e08aa8f39fb7ff0e8fedc9a2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/solr/commit/ad6854b04361e351e08aa8f39fb7ff0e8fedc9a2&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17797209" author="gerlowskija" created="Fri, 15 Dec 2023 14:37:08 +0000"  >&lt;p&gt;There&apos;s some local (and Jenkins) test failures that look related to this change, particularly in TestConfigSetService and TestFileSystemConfigSetService.&lt;/p&gt;

&lt;p&gt;See &lt;a href=&quot;https://ci-builds.apache.org/job/Solr/job/Solr-Check-main/8570/testReport/junit/org.apache.solr.core/TestConfigSetService/classMethod/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this Jenkins build&lt;/a&gt; for an example.  (I&apos;ve also attached the Jenkins logs, so they&apos;re preserved after our build-retention rolls over.)  &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13065352/13065352_jenkins.log.txt.gz&quot; title=&quot;jenkins.log.txt.gz attached to SOLR-16949&quot;&gt;jenkins.log.txt.gz&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; &lt;/p&gt;

&lt;p&gt;At a glance it looks like the problem is that this change introduces &lt;a href=&quot;https://github.com/apache/solr/commit/15534754f492079e52288dd11abaf1c4261b3ea4#diff-8c1bceee609c78bfecf8b4d7902c02defa47106f9a3dfc96e10d5612215065c8R217&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;some InputStream leaks&lt;/a&gt;] in our ConfigSet code.  Seems like a simple-ish fix?  I suspect one of you guys might already be aware of this and working on a fix, and I don&apos;t want to duplicate effort.  But if you aren&apos;t already on it, lmk and I can toss a fix together.&lt;/p&gt;</comment>
                            <comment id="17797967" author="janhoy" created="Sun, 17 Dec 2023 21:05:44 +0000"  >&lt;p&gt;Yea, looks like some careless stream handling there. Taking a look.&lt;/p&gt;</comment>
                            <comment id="17797978" author="janhoy" created="Sun, 17 Dec 2023 23:38:11 +0000"  >&lt;p&gt;Fix in &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13065375/13065375_SOLR-16949-inputstream-leaks.patch&quot; title=&quot;SOLR-16949-inputstream-leaks.patch attached to SOLR-16949&quot;&gt;SOLR-16949-inputstream-leaks.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;. This patch passes &lt;tt&gt;Path&lt;/tt&gt; objects instead of &lt;tt&gt;InputStream&lt;/tt&gt; and also uses the &lt;tt&gt;File&lt;/tt&gt; and &lt;tt&gt;byte[]&lt;/tt&gt; methods of SimpleMagic library instead of always converting to InputStream. Also streamlines tests with try-with-resources. I ran the entire test suite locally, so committed right away:&lt;/p&gt;

&lt;p&gt;main: &lt;a href=&quot;https://github.com/apache/solr/commit/c89813a675663bb82f18236840b2a84cac05e1ee&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/solr/commit/c89813a675663bb82f18236840b2a84cac05e1ee&lt;/a&gt;&lt;br/&gt;
branch_9x: &lt;a href=&quot;https://github.com/apache/solr/commit/c79011e81dada2f9bc4b4df32ffb32152ef81152&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/solr/commit/c79011e81dada2f9bc4b4df32ffb32152ef81152&lt;/a&gt;&lt;br/&gt;
branch_9_4: &lt;a href=&quot;https://github.com/apache/solr/commit/ce2813c97f70b5e83ece80455aad74a1fd7eeca6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/solr/commit/ce2813c97f70b5e83ece80455aad74a1fd7eeca6&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17798238" author="gerlowskija" created="Mon, 18 Dec 2023 15:05:04 +0000"  >&lt;p&gt;A belated LGTM on the resource-leak fix; thanks Jan!&lt;/p&gt;</comment>
                            <comment id="17798266" author="janhoy" created="Mon, 18 Dec 2023 16:11:42 +0000"  >&lt;p&gt;Yep, looks good. Doesn&apos;t look like &lt;tt&gt;branch_8_11&lt;/tt&gt; code is directly using the same code, except some tests that may be leaking streams. I&apos;ll have a look at pushing a patch to that branch too.&lt;/p&gt;</comment>
                            <comment id="17798471" author="janhoy" created="Tue, 19 Dec 2023 07:55:45 +0000"  >&lt;p&gt;Backport of inputstream handling to branch_8_11: &lt;a href=&quot;https://github.com/apache/lucene-solr/commit/6c8f24eb9e3fe1cb19058173f2e221de3febfeda&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/commit/6c8f24eb9e3fe1cb19058173f2e221de3febfeda&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17808386" author="dsmiley" created="Thu, 18 Jan 2024 22:33:08 +0000"  >&lt;p&gt;Closing after the 9.4.1 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13561882">SOLR-17104</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                            <outwardlinks description="supercedes">
                                        <issuelink>
            <issuekey id="13487163">SOLR-16480</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13065295" name="SOLR-16949-1.patch" size="43070" author="janhoy" created="Wed, 13 Dec 2023 14:27:02 +0000"/>
                            <attachment id="13064566" name="SOLR-16949-8_11-1.patch" size="28293" author="janhoy" created="Mon, 20 Nov 2023 08:43:40 +0000"/>
                            <attachment id="13065146" name="SOLR-16949-8_11-2.patch" size="28853" author="janhoy" created="Fri, 8 Dec 2023 20:22:07 +0000"/>
                            <attachment id="13065265" name="SOLR-16949-8_11-3.patch" size="29828" author="janhoy" created="Tue, 12 Dec 2023 19:47:48 +0000"/>
                            <attachment id="13064513" name="SOLR-16949-8_11.patch" size="26535" author="janhoy" created="Sun, 19 Nov 2023 23:58:45 +0000"/>
                            <attachment id="13065375" name="SOLR-16949-inputstream-leaks.patch" size="11892" author="janhoy" created="Sun, 17 Dec 2023 23:33:39 +0000"/>
                            <attachment id="13065101" name="SOLR-16949-main-protect-lib-1.patch" size="15431" author="houston" created="Thu, 7 Dec 2023 20:26:00 +0000"/>
                            <attachment id="13065135" name="SOLR-16949-main-protect-lib-2.patch" size="16599" author="houston" created="Fri, 8 Dec 2023 16:40:10 +0000"/>
                            <attachment id="13065036" name="SOLR-16949-main-protect-lib.patch" size="14861" author="houston" created="Wed, 6 Dec 2023 22:37:56 +0000"/>
                            <attachment id="13064266" name="SOLR-16949.patch" size="29495" author="janhoy" created="Wed, 8 Nov 2023 15:35:52 +0000"/>
                            <attachment id="13065352" name="jenkins.log.txt.gz" size="40112" author="gerlowskija" created="Fri, 15 Dec 2023 14:37:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 42 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1jzfs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>