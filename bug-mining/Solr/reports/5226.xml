<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:11:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-17416] Streaming Expressions:  Exception swallowed and not&#160;propagated back to the client leading to inconsistent results</title>
                <link>https://issues.apache.org/jira/browse/SOLR-17416</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;There appears to be a bug in the &lt;em&gt;ExportWriter/ExportBuffers&lt;/em&gt; implementation within the&#160;Streaming Expressions plugin. Specifically, when an InterruptedException occurs&#160;due to an ExportBuffers timeout, the exception is swallowed and not&#160;propagated back to the client (still logged on the server side though).&lt;/p&gt;

&lt;p&gt;As a result, the client receives an EOF marker, thinking that it has received the full set of results, when in fact it has only&#160;received partial results. This leads to inconsistent search results, as the client&#160;is unaware that the export process was interrupted and terminated prematurely. &#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13589645">SOLR-17416</key>
            <summary>Streaming Expressions:  Exception swallowed and not&#160;propagated back to the client leading to inconsistent results</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Chris M. Hostetter</assignee>
                                    <reporter username="Idjeraoui">Lamine</reporter>
                        <labels>
                    </labels>
                <created>Wed, 21 Aug 2024 18:17:33 +0000</created>
                <updated>Fri, 17 Oct 2025 20:04:44 +0000</updated>
                            <resolved>Wed, 4 Sep 2024 17:12:45 +0000</resolved>
                                                    <fixVersion>9.8</fixVersion>
                    <fixVersion>10.0</fixVersion>
                                    <component>Export Writer</component>
                    <component>streaming expressions</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17877915" author="hossman" created="Thu, 29 Aug 2024 23:39:32 +0000"  >&lt;p&gt;I&apos;ve seen this in the wild and after digging into it a bit can elaborate on the circumstances...&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;ExportBuffers.run(Callable)&lt;/tt&gt; is designed around the use of two threads:
	&lt;ul&gt;
		&lt;li&gt;a background thread that acts as a &quot;filler&quot; to read data from disk and populate a &lt;tt&gt;fillBuffer&lt;/tt&gt;&lt;/li&gt;
		&lt;li&gt;the caller thread, which serially invokes the &quot;writer&quot; logic passed in as the &lt;tt&gt;Callable&lt;/tt&gt; argument, to serialize an &lt;tt&gt;outputBuffer&lt;/tt&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;These two threads use &lt;tt&gt;exchangeBuffers()&lt;/tt&gt; to swap with each other, which under the covers uses a &lt;tt&gt;CylicBarrier&lt;/tt&gt;
	&lt;ul&gt;
		&lt;li&gt;The &lt;tt&gt;CyclicBarrier.await(time)&lt;/tt&gt; calls use a hard coded timeout of 600 seconds
		&lt;ul&gt;
			&lt;li&gt;This seems to have been chosen as an arbitrary &quot;big value&quot; to ensure that the neither thread sat around waiting forever (consuming ram) if the other thread died.&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The problem however is that this 600 second timeout may not be enough to account for really slow downstream consumption of the data. With really large collections, and really complicated streaming expressions, this can happen even when well behaved clients that are actively trying to consume data.&lt;/p&gt;

&lt;p&gt;One particular example I&apos;ve seen is a stream where a &lt;tt&gt;leftOuterJoin&lt;/tt&gt; is wrapped around two very large collections, spread over a large number of shards....&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;leftOuterJoin(search(biggest_left_collection,q=&quot;*:*&quot;,sort=&quot;join_field asc&quot;,fl=&quot;...&quot;,qt=&quot;/export&quot;),
              search(big_right_collection,q=&quot;*:*&quot;,sort=&quot;join_field asc&quot;,fl=&quot;...&quot;,qt=&quot;/export&quot;),
              on=&quot;join_field&quot;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;...After an initial burst of fetching the an initial &lt;tt&gt;batchSize&lt;/tt&gt; of Tuples from both streams, and slurping up all the results from both streams that have the same &lt;tt&gt;join_field&lt;/tt&gt; value as the head of the left Tuple, each &lt;tt&gt;read()&lt;/tt&gt; call from the downstream client causes Tuples from the merged set to be consumed &#8211; but neither of the upstream &quot;left&quot; or &quot;right&quot; streams reads any new data for a bit. And even once additional values are read from the &quot;left&quot; stream, the &quot;right&quot; stream may sit stagnant for even longer as the node running the join code keeps consuming (and passing downstream) Tuples from the left stream until it encounters the same &lt;tt&gt;field_field&lt;/tt&gt; value from the head of right stream and &lt;em&gt;then&lt;/em&gt; starts fetching more data from the individual replicas of that right stream collection.&lt;/p&gt;

&lt;p&gt;Which can take a while &#8211; and in the meantime the &quot;filler&quot; thread on one (or more) of the replicas of &lt;tt&gt;big_right_collection&lt;/tt&gt; may have encountered a &lt;tt&gt;TimeoutException&lt;/tt&gt; from the &lt;tt&gt;barrier.await(time)&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;In &lt;em&gt;theory&lt;/em&gt; the &quot;filler&quot; code in &lt;tt&gt;ExportBuffers&lt;/tt&gt; reports the &lt;tt&gt;TimeoutException&lt;/tt&gt;&#160; in this situation by by passing the exception to the following method before the filler thread ends...&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void error(Throwable t) {
    error = t;
    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt; the lock on the other thread too
&lt;/span&gt;    barrier.reset();
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;...expecting the &quot;writer&quot; code (from the caller thread) to check the value of &lt;tt&gt;getError()&lt;/tt&gt; and report it.&lt;/p&gt;

&lt;p&gt;But there are two main problems with this approach to passing the exception along:&lt;/p&gt;

&lt;p&gt;1. The common case &quot;writer&quot; logic in &lt;tt&gt;ExportWriter&lt;/tt&gt; (which calls &lt;tt&gt;ExportBuffers.run()&lt;/tt&gt; &lt;b&gt;&lt;em&gt;NEVER&lt;/em&gt;&lt;/b&gt; checks &lt;tt&gt;ExportBuffers.getError()&lt;/tt&gt; &#8211; it is only ever checked by (the special case logic in) &lt;tt&gt;ExportWriterStream&lt;/tt&gt; and even there it&apos;s only check in the event of a &lt;tt&gt;BrokenBarrierException&lt;/tt&gt;&lt;br/&gt;
2. The logic inside &lt;tt&gt;ExportBuffers.run()&lt;/tt&gt; itself only logs (and ignores) any type of Throwable that propagates up to it.&lt;/p&gt;

&lt;p&gt;A very tightly related third problem is the call to &lt;tt&gt;barrier.reset()&lt;/tt&gt; :&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;AFAICT The usage of this method call seems to be a complete mistake / misunderstanding
	&lt;ul&gt;
		&lt;li&gt;It&apos;s comment &amp;amp; usage here in the &lt;tt&gt;error()&lt;/tt&gt; method (ie: after one of the two parties gets either a &lt;tt&gt;TimeoutException&lt;/tt&gt; or &lt;tt&gt;BrokenBarrierException&lt;/tt&gt; ) seems to be with the intent of ensuring that &lt;em&gt;if&lt;/em&gt; the other thread is currently &lt;tt&gt;await(time)&lt;/tt&gt; -ing on the barrier, that thread should get a &lt;tt&gt;BrokenBarrierException&lt;/tt&gt; &#8211; but that&apos;s not what this method is designed for.&lt;/li&gt;
		&lt;li&gt;The way we are using the &lt;tt&gt;CyclicBarrier&lt;/tt&gt; in this code, the situation described in the comment should never even be possible.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;In general, anytime any call to &lt;tt&gt;CyclicBarrier.await()&lt;/tt&gt; throws an exception the barrier is left in a &quot;broken&quot; state, and any other calls to &lt;tt&gt;CyclicBarrier.await()&lt;/tt&gt; (&lt;em&gt;either currently waiting, or in the future&lt;/em&gt;) will get a &lt;tt&gt;BrokenBarrierException&lt;/tt&gt;
	&lt;ul&gt;
		&lt;li&gt;The call to &lt;tt&gt;barrier.reset()&lt;/tt&gt; here causes that &quot;broken&quot; state to be reset, &lt;b&gt;&lt;em&gt;preventing&lt;/em&gt;&lt;/b&gt; any future calls to &lt;tt&gt;CyclicBarrier.await()&lt;/tt&gt; (from the thread that didn&apos;t already encounter an error) to throw &lt;tt&gt;BrokenBarrierException&lt;/tt&gt; &#8211; instead that thread waits the full timeout amount (for a thread that has already errored out and is long gone)&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In general, I think the design of &lt;tt&gt;ExportBuffers&lt;/tt&gt; (and use of a &lt;tt&gt;CyclicBarrier.await(time)&lt;/tt&gt; to exchange buffers between two threads) is more complicated and error prone then it needs to be, and should to be re-considered in order to ensure that these kind of &quot;slow consumption&quot; situations can&apos;t result the &quot;filler&quot; thread giving up after an arbitrary time limit even though the &quot;writer&quot; thread is still around and the client is still consuming results. I will open a separate jira to discuss options for redesigning this.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In the meantime, my biggest concern is the &quot;false success&quot; that is returned to clients in the event that the filler code does timeout &#8211; so that client/caller code has no idea there was a problem and partial results have been returned.&lt;/p&gt;

&lt;p&gt;I&apos;m attaching a patch that does 3 things:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Fixes both &quot;writer&quot; code paths to check &lt;tt&gt;getError()&lt;/tt&gt; (and report it) regardless of how they finish
	&lt;ul&gt;
		&lt;li&gt;I am not 100% certain that these are the &lt;em&gt;best&lt;/em&gt; places to check &lt;tt&gt;getError()&lt;/tt&gt; or that there are not &lt;em&gt;additional&lt;/em&gt; places that should do this check - but this seemed to address the situations where I could reproduce this type of problem&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Makes the &lt;tt&gt;CyclicBarrier.await(time)&lt;/tt&gt; timeout value configurable via an (undocumented) EnvUtils sysprop.
	&lt;ul&gt;
		&lt;li&gt;So that Solr deployments with large collections have an expert level mechanism for addressing TimeoutErrors they may encounter&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;remove the call the &lt;tt&gt;barrier.reset()&lt;/tt&gt;
	&lt;ul&gt;
		&lt;li&gt;It just makes no sense in this code, and leaving it in ensures that &lt;em&gt;if&lt;/em&gt; the &quot;filler&quot; times out, the &quot;writer&quot; code (when it is ready to &lt;tt&gt;exchangeBuffers()&lt;/tt&gt; ) winds up waiting the full time limit itself for no reason.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;...the way the code is designed, we don&apos;t really have a straight forward way to write a junit test for these types of situations, and if we&apos;re going to spend time refactoring to improve the test coverage I&apos;d rather focus on bigger picture refactoring to eliminate the risk of these bugs in general &#8211; but I&apos;m open to suggestions if folks want to contribute test cases that should be committed along with these changes.&lt;/p&gt;</comment>
                            <comment id="17877919" author="hossman" created="Thu, 29 Aug 2024 23:48:15 +0000"  >&lt;p&gt;&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;In general, I think the design of ExportBuffers (and use of a CyclicBarrier.await(time) to exchange buffers between two threads) is more complicated and error prone then it needs to be, and should to be re-considered in order to ensure that these kind of &quot;slow consumption&quot; situations can&apos;t result the &quot;filler&quot; thread giving up after an arbitrary time limit even though the &quot;writer&quot; thread is still around and the client is still consuming results. I will open a separate jira to discuss options for redesigning this.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17430&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-17430&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17878554" author="ab" created="Mon, 2 Sep 2024 10:25:53 +0000"  >&lt;p&gt;+1 for the proposed immediate fix.&lt;/p&gt;</comment>
                            <comment id="17879291" author="jira-bot" created="Wed, 4 Sep 2024 16:17:46 +0000"  >&lt;p&gt;Commit 4a6e18b54cef6e0b4e518bdcddfb8975a69c9fb1 in solr&apos;s branch refs/heads/main from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=4a6e18b54ce&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=4a6e18b54ce&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17416&quot; title=&quot;Streaming Expressions:  Exception swallowed and not&#160;propagated back to the client leading to inconsistent results&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17416&quot;&gt;&lt;del&gt;SOLR-17416&lt;/del&gt;&lt;/a&gt;: Fixed ExportHandler bug that silently suppressed errors and returned partial results in some situations&lt;/p&gt;</comment>
                            <comment id="17879307" author="jira-bot" created="Wed, 4 Sep 2024 17:09:21 +0000"  >&lt;p&gt;Commit ff9f6ac74a4346766f41975f1f3578c0d11d29a8 in solr&apos;s branch refs/heads/branch_9x from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=ff9f6ac74a4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=ff9f6ac74a4&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17416&quot; title=&quot;Streaming Expressions:  Exception swallowed and not&#160;propagated back to the client leading to inconsistent results&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17416&quot;&gt;&lt;del&gt;SOLR-17416&lt;/del&gt;&lt;/a&gt;: Fixed ExportHandler bug that silently suppressed errors and returned partial results in some situations&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 4a6e18b54cef6e0b4e518bdcddfb8975a69c9fb1)&lt;/p&gt;</comment>
                            <comment id="17921924" author="anshumg" created="Tue, 28 Jan 2025 22:17:51 +0000"  >&lt;p&gt;Closing after the 9.8.0 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13590506">SOLR-17430</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13071184" name="SOLR-17416.patch" size="2758" author="hossman" created="Thu, 29 Aug 2024 23:40:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            41 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1qzxk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>