<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:48:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-15783] MDC Values can leak between request threads, trace_id currently does</title>
                <link>https://issues.apache.org/jira/browse/SOLR-15783</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>
&lt;p&gt;Currently, the only general &quot;MDC Cleanup&quot; code that happens from request to request is done by &lt;tt&gt;MDCLoggingContext.clear()&lt;/tt&gt; and &lt;tt&gt;MDCLoggingContext.reset()&lt;/tt&gt; ... but these methods (in addition to only being concerned with a static list of 5 specific MDC values) are currently designed and used in such a way that things like &quot;trace_id&quot; are only &quot;reset&quot; at the &lt;em&gt;begining&lt;/em&gt; of &lt;tt&gt;HttpSolrCall.call()&lt;/tt&gt; ... which means any request specific log messages that happen before that point (like authn errors) will incorrectly refer to the trace_id of whatever request the thread &lt;em&gt;previously&lt;/em&gt; processed.&lt;/p&gt;

&lt;p&gt;As a trivial example of this, if you apply a patch like...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;diff --git a/solr/core/src/java/org/apache/solr/client/solrj/embedded/JettySolrRunner.java b/solr/core/src/java/org/apache/solr/client/solrj/embedded/JettySolrRunner.java
index 5f481c48e92..97c864617f4 100644
--- a/solr/core/src/java/org/apache/solr/client/solrj/embedded/JettySolrRunner.java
+++ b/solr/core/src/java/org/apache/solr/client/solrj/embedded/JettySolrRunner.java
@@ -109,7 +109,7 @@ public class JettySolrRunner {
 
   private static final Logger log = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());
 
-  private static final int THREAD_POOL_MAX_THREADS = 10000;
+  private static final int THREAD_POOL_MAX_THREADS = 10; // nocommit
   // NOTE: needs to be larger than SolrHttpClient.threadPoolSweeperMaxIdleTime
   private static final int THREAD_POOL_MAX_IDLE_TIME_MS = 260000;
 
diff --git a/solr/core/src/java/org/apache/solr/servlet/SolrDispatchFilter.java b/solr/core/src/java/org/apache/solr/servlet/SolrDispatchFilter.java
index 28167270099..fa6bb9a4eb8 100644
--- a/solr/core/src/java/org/apache/solr/servlet/SolrDispatchFilter.java
+++ b/solr/core/src/java/org/apache/solr/servlet/SolrDispatchFilter.java
@@ -484,6 +484,9 @@ public class SolrDispatchFilter extends BaseSolrFilter {
         response.sendError(429, errorMessage);
       }
 
+      log.error(&quot;nocommit: fake log message before HttpSolrCall.call() as if auth error happened: MDC_claims={} ; real_traceId={}&quot;,
+                org.slf4j.MDC.get(org.apache.solr.logging.MDCLoggingContext.TRACE_ID), span.context().toTraceId());
+      
       AtomicReference&amp;lt;HttpServletRequest&amp;gt; wrappedRequest = new AtomicReference&amp;lt;&amp;gt;();
       if (!authenticateRequest(request, response, wrappedRequest)) { // the response and status code have already been sent
         return;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;...and then run &lt;tt&gt;./gradlew test --tests TestDistributedTracing -Ptests.verbose=true&lt;/tt&gt; you can pick out any single jetty query thread and see something like...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  2&amp;gt; 4103 ERROR (qtp1310066330-70) [] o.a.s.s.SolrDispatchFilter nocommit: fake log message before HttpSolrCall.call() as if auth error happened: MDC_claims=null ; real_traceId=1
  2&amp;gt; 6146 ERROR (qtp1310066330-70) [n:127.0.0.1:34135_solr t:1] o.a.s.s.SolrDispatchFilter nocommit: fake log message before HttpSolrCall.call() as if auth error happened: MDC_claims=1 ; real_traceId=22
  2&amp;gt; 6661 ERROR (qtp1310066330-70) [n:127.0.0.1:34135_solr t:22] o.a.s.s.SolrDispatchFilter nocommit: fake log message before HttpSolrCall.call() as if auth error happened: MDC_claims=22 ; real_traceId=50
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;(Note also that during authn, the nodeId isn&apos;t populated for a &apos;new&apos; thread, it&apos;s only set if it was leaked from the last request processed)&lt;/p&gt;</description>
                <environment></environment>
        <key id="13410938">SOLR-15783</key>
            <summary>MDC Values can leak between request threads, trace_id currently does</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Chris M. Hostetter</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Tue, 9 Nov 2021 23:07:47 +0000</created>
                <updated>Thu, 12 May 2022 00:27:02 +0000</updated>
                            <resolved>Thu, 11 Nov 2021 21:58:44 +0000</resolved>
                                                    <fixVersion>9.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17441424" author="hossman" created="Tue, 9 Nov 2021 23:10:51 +0000"  >&lt;p&gt;There&apos;s a lot going on in &lt;tt&gt;MDCLoggingContext&lt;/tt&gt; that I don&apos;t really understand (some of it due to historic choices that I can&apos;t make sense of, and some of it seems like the result of gradual evolution in ways it wasn&apos;t intended to &#8211; or in some cases: that it was specifically designed to prevent) that probably could/should be reviewed more in depth ... but IMO it seems like (independent of any of the choices made there) we can safely (and should) make the following changes:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;SolrDispatchFilter.doFilter&lt;/tt&gt; should populate the MDC with nodeID (when available) before executing any code
	&lt;ul&gt;
		&lt;li&gt;it ultimately comes from CoreContainer, which SolrDispatchFilter has on init&lt;/li&gt;
		&lt;li&gt;no reason to wait for &lt;tt&gt;HttpSolrCall.call()&lt;/tt&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;trace_id should get populated in the MDC as soon as the top level &quot;scope&quot; is entered
	&lt;ul&gt;
		&lt;li&gt;ie: set this in &lt;tt&gt;SolrDispatchFilter.doFilter&lt;/tt&gt;&lt;/li&gt;
		&lt;li&gt;no reason to wait for &lt;tt&gt;HttpSolrCall.call()&lt;/tt&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;SolrDispatchFilter&lt;/tt&gt; should ensure that &lt;em&gt;ALL&lt;/em&gt; MDC values (not just those explicitly managed by MDCLoggingContext) are &quot;cleaned up&quot;
	&lt;ul&gt;
		&lt;li&gt;To prevent leaks like the current issue with trace_id, as well as any other values that might leak from other places in the code now or in the future&lt;/li&gt;
		&lt;li&gt;TestHarness should do the same thing so non-jetty tests get the same level of cleanup (not really a &quot;bug&quot; if they did since it would be test only code &#8211; but just to prevent any risk of confusion)&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;...the attached patch makes these changes by introducing an (AutoCloseable) &lt;tt&gt;MDCSnapshot&lt;/tt&gt; modeled after SLF4J&apos;s existing &lt;tt&gt;MDC.MDCCloseable&lt;/tt&gt; class&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt; : Any comments/concerns here?&lt;/p&gt;</comment>
                            <comment id="17441434" author="dsmiley" created="Wed, 10 Nov 2021 00:04:14 +0000"  >&lt;p&gt;+1 to your patch &#8211; looks great! &#160;Thanks for finding/fixing this.&lt;/p&gt;

&lt;p&gt;I&apos;m very interested in your views on MDCLoggingContext if you care to share them.&lt;/p&gt;</comment>
                            <comment id="17442004" author="hossman" created="Wed, 10 Nov 2021 23:35:56 +0000"  >&lt;p&gt;FWIW: &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15790&quot; title=&quot;Populate MDC with rid (CommonParams.REQUEST_ID)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15790&quot;&gt;&lt;del&gt;SOLR-15790&lt;/del&gt;&lt;/a&gt; is the idea I was exploring that led me to notice this bug, because I was investigating how other places in the code dealt with &quot;long lived&quot; MDC values.&lt;/p&gt;

&lt;p&gt;It&apos;s an example of a situation where (I think) it makes sense for a piece of code to call &lt;tt&gt;MDC.put()&lt;/tt&gt; w/o removing the value itself &amp;#8211; because it wants the value to live beyond it&apos;s own scope for the duration of the (HTTP) request &amp;#8211; and why I think it&apos;s a good idea for this bug to be fixed by ensuring SolrDispatchFilter does a general &quot;cleanup&quot; of all MDC values &amp;#8211; so code like &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15790&quot; title=&quot;Populate MDC with rid (CommonParams.REQUEST_ID)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15790&quot;&gt;&lt;del&gt;SOLR-15790&lt;/del&gt;&lt;/a&gt; can safely exist.&lt;/p&gt;</comment>
                            <comment id="17442010" author="hossman" created="Thu, 11 Nov 2021 00:03:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m very interested in your views on MDCLoggingContext if you care to share them.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;(Hmmm.. something changed in jira notiications and i didn&apos;t see your comment until now...)&lt;/p&gt;

&lt;p&gt;In general MDCLoggingContext just seems very complicated/confusing for how little it actually does &amp;#8211; and when i tired to wrap my head around the history, the two things I remember that jumped out at me (I wasn&apos;t really taking detailed notes) were:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;I couldn&apos;t really find an explanation for the semi-sort-of-ref-counting that&apos;s done ... was it a perf optimization? why can&apos;t we just reduce the number of places that call &apos;setCore*&apos; ?&lt;/li&gt;
	&lt;li&gt;It &lt;em&gt;seems&lt;/em&gt; like the original goal was to keep it very tight and confined to managing all &quot;core&quot; centric MDC values (core, replica, shard, collection, nodeId) using a SolrCore (or eventually CoreDescripter) all at once using only 2 public methods (setCore/clear)
	&lt;ul&gt;
		&lt;li&gt;Miller even called out (somewhere in a jira comment?) that it shouldn&apos;t be a generic helper class for MDC values, and it should only be for the case of the &lt;em&gt;active&lt;/em&gt; core &amp;#8211; not for things like Overseer indicating what SolrCore it was in the process of creating&lt;/li&gt;
		&lt;li&gt;... but then at some point MDCLoggingContext got refactored so a lot of individual public &quot;set&quot; methods got introduced, and Overseer actually uses some of them in the exact way Miller was trying to avoid ... w/o clearing them (which would actaully be bad if it tried because that would throw off the ref counting i believe?)&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;...i just remember being left with the impression that a lot of this class could/should probably just go away? ... I don&apos;t remember really seeing any reason why trace id (or any of the  &lt;tt&gt;public setFoo(String)&lt;/tt&gt; methods really)  &lt;em&gt;needed&lt;/em&gt; to be dealt with in this class (especially after &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15630&quot; title=&quot;MDC &amp;quot;prefix labels&amp;quot; should be handled by Layout - not hardcoded in solr code&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15630&quot;&gt;&lt;del&gt;SOLR-15630&lt;/del&gt;&lt;/a&gt;); and the original &quot;meat&quot; of what setCore/clear were trying to do felt like maybe it could be cleaner if moved into the CoreDescriptor class as setMDC/clearMDC methods (and maybe skip the ref-counting? is that still important if SDF starts ensuring the MDC is &quot;clean&quot; for request threads?)&lt;/p&gt;</comment>
                            <comment id="17442463" author="jira-bot" created="Thu, 11 Nov 2021 21:57:18 +0000"  >&lt;p&gt;Commit 2e5f89a87296269cdf05ac30d178089832cfa5a7 in solr&apos;s branch refs/heads/main from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=2e5f89a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=2e5f89a&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15783&quot; title=&quot;MDC Values can leak between request threads, trace_id currently does&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15783&quot;&gt;&lt;del&gt;SOLR-15783&lt;/del&gt;&lt;/a&gt;: Prevent Logging MDC values from leaking between request threads, and set &apos;trace_id&apos; in MDC as soon as it&apos;s available&lt;/p&gt;</comment>
                            <comment id="17450458" author="gus_heck" created="Mon, 29 Nov 2021 13:34:22 +0000"  >&lt;p&gt;When I merged this change into 15590 I recall thinking that this might have been a great candidate for a separate servlet filter wrapping our dispatch filter if only I had got 15590 in first... thoughts?&lt;/p&gt;</comment>
                            <comment id="17450755" author="hossman" created="Mon, 29 Nov 2021 22:52:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gus&quot; class=&quot;user-hover&quot; rel=&quot;gus&quot;&gt;gus&lt;/a&gt; - i don&apos;t really understand &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15590&quot; title=&quot;Start up Core Container via ServletContextListener&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15590&quot;&gt;&lt;del&gt;SOLR-15590&lt;/del&gt;&lt;/a&gt; (or more specifically: the capabilities/best practices of &quot;ServletListeners&quot; as implemented in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15590&quot; title=&quot;Start up Core Container via ServletContextListener&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15590&quot;&gt;&lt;del&gt;SOLR-15590&lt;/del&gt;&lt;/a&gt;) to have much of an opinion on how that issue might relate....&lt;/p&gt;

&lt;p&gt;The most important thing here (from my perspective) is that the logic this jira added/tweaked in SolrDispatchFilter needs to happen on every (HTTP) request &#8211; in the jetty thread that handles the request (from a ThreadLocal/MDC perspective)&#160; &#8211; before/after any other solr code deals with the request.&lt;/p&gt;

&lt;p&gt;As far as your specific question about a &quot;separate servlet filter wrapping our dispatch filter&quot; that would be fine i think ... my main concern (and the reason i didn&apos;t personally try to implement this that way myself) would be ensuring that it works just as well in cloud based tests &#8211; and I&apos;m confident that adding a new ServletFilter would require a bunch of changes to JettySolrRunner &#8211; and i have some philosophical objections to (personally) working on any improvements that make the same jetty related change in two places just to play nice with tests (ie: I&apos;m not personally willing to be complicit in consciously kicking the &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14903&quot; title=&quot;SolrCloud tests should use the jetty.xml that we ship with&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14903&quot;&gt;&lt;del&gt;SOLR-14903&lt;/del&gt;&lt;/a&gt; can even further down the road)&lt;/p&gt;</comment>
                            <comment id="17535766" author="janhoy" created="Thu, 12 May 2022 00:27:02 +0000"  >&lt;p&gt;Closing after the 9.0.0 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13411152">SOLR-15790</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13035893" name="SOLR-15783.patch" size="7618" author="hossman" created="Tue, 9 Nov 2021 23:10:40 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 26 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0wlb4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>