<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:51:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-5426] org.apache.solr.common.SolrException; org.apache.solr.common.SolrException: org.apache.lucene.search.highlight.InvalidTokenOffsetsException: Token 0 exceeds length of provided text sized 840</title>
                <link>https://issues.apache.org/jira/browse/SOLR-5426</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Highlighter does not work correctly on test-data.&lt;br/&gt;
I added index- and config- files (see attached highlighter.zip) for reproducing this issue.&lt;br/&gt;
Everything works fine if I search without highlighting:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://localhost:8983/solr/global/select?q=aa&amp;amp;wt=json&amp;amp;indent=true&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8983/solr/global/select?q=aa&amp;amp;wt=json&amp;amp;indent=true&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;But if search with highlighting: &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://localhost:8983/solr/global/select?q=aa&amp;amp;wt=json&amp;amp;indent=true&amp;amp;hl=true&amp;amp;hl.fl=*_stx&amp;amp;hl.simple.pre=&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8983/solr/global/select?q=aa&amp;amp;wt=json&amp;amp;indent=true&amp;amp;hl=true&amp;amp;hl.fl=*_stx&amp;amp;hl.simple.pre=&lt;/a&gt;&amp;lt;em&amp;gt;&amp;amp;hl.simple.post=&amp;lt;%2Fem&amp;gt;&lt;/p&gt;

&lt;p&gt;I&apos;m get the error:&lt;/p&gt;

&lt;p&gt;ERROR - 2013-11-07 10:17:15.797; org.apache.solr.common.SolrException; null:org.apache.solr.common.SolrException: org.apache.lucene.search.highlight.InvalidTokenOffsetsException: Token 0 exceeds length of provided text sized 840&lt;br/&gt;
	at org.apache.solr.highlight.DefaultSolrHighlighter.doHighlightingByHighlighter(DefaultSolrHighlighter.java:542)&lt;br/&gt;
	at org.apache.solr.highlight.DefaultSolrHighlighter.doHighlighting(DefaultSolrHighlighter.java:414)&lt;br/&gt;
	at org.apache.solr.handler.component.HighlightComponent.process(HighlightComponent.java:139)&lt;br/&gt;
	at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:208)&lt;br/&gt;
	at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:135)&lt;br/&gt;
	at org.apache.solr.core.SolrCore.execute(SolrCore.java:1859)&lt;br/&gt;
	at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:703)&lt;br/&gt;
	at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:406)&lt;br/&gt;
	at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:195)&lt;br/&gt;
	at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1419)&lt;br/&gt;
	at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:455)&lt;br/&gt;
	at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:137)&lt;br/&gt;
	at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:557)&lt;br/&gt;
	at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:231)&lt;br/&gt;
	at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1075)&lt;br/&gt;
	at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:384)&lt;br/&gt;
	at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:193)&lt;br/&gt;
	at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1009)&lt;br/&gt;
	at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:135)&lt;br/&gt;
	at org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:255)&lt;br/&gt;
	at org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:154)&lt;br/&gt;
	at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:116)&lt;br/&gt;
	at org.eclipse.jetty.server.Server.handle(Server.java:368)&lt;br/&gt;
	at org.eclipse.jetty.server.AbstractHttpConnection.handleRequest(AbstractHttpConnection.java:489)&lt;br/&gt;
	at org.eclipse.jetty.server.BlockingHttpConnection.handleRequest(BlockingHttpConnection.java:53)&lt;br/&gt;
	at org.eclipse.jetty.server.AbstractHttpConnection.headerComplete(AbstractHttpConnection.java:942)&lt;br/&gt;
	at org.eclipse.jetty.server.AbstractHttpConnection$RequestHandler.headerComplete(AbstractHttpConnection.java:1004)&lt;br/&gt;
	at org.eclipse.jetty.http.HttpParser.parseNext(HttpParser.java:640)&lt;br/&gt;
	at org.eclipse.jetty.http.HttpParser.parseAvailable(HttpParser.java:235)&lt;br/&gt;
	at org.eclipse.jetty.server.BlockingHttpConnection.handle(BlockingHttpConnection.java:72)&lt;br/&gt;
	at org.eclipse.jetty.server.bio.SocketConnector$ConnectorEndPoint.run(SocketConnector.java:264)&lt;br/&gt;
	at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:608)&lt;br/&gt;
	at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:543)&lt;br/&gt;
	at java.lang.Thread.run(Unknown Source)&lt;br/&gt;
Caused by: org.apache.lucene.search.highlight.InvalidTokenOffsetsException: Token 0 exceeds length of provided text sized 840&lt;br/&gt;
	at org.apache.lucene.search.highlight.Highlighter.getBestTextFragments(Highlighter.java:225)&lt;br/&gt;
	at org.apache.solr.highlight.DefaultSolrHighlighter.doHighlightingByHighlighter(DefaultSolrHighlighter.java:527)&lt;br/&gt;
	... 33 more&lt;/p&gt;</description>
                <environment></environment>
        <key id="12677928">SOLR-5426</key>
            <summary>org.apache.solr.common.SolrException; org.apache.solr.common.SolrException: org.apache.lucene.search.highlight.InvalidTokenOffsetsException: Token 0 exceeds length of provided text sized 840</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Chris M. Hostetter</assignee>
                                    <reporter username="nmg">Nikolay</reporter>
                        <labels>
                    </labels>
                <created>Thu, 7 Nov 2013 03:58:32 +0000</created>
                <updated>Mon, 9 May 2016 18:46:57 +0000</updated>
                            <resolved>Fri, 13 Jun 2014 21:36:07 +0000</resolved>
                                    <version>4.4</version>
                    <version>4.5.1</version>
                                    <fixVersion>4.9</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>highlighter</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13815638" author="nmg" created="Thu, 7 Nov 2013 04:34:16 +0000"  >&lt;p&gt;data for reproduce the bug, folder &quot;global&quot; contains lucene index, also there are 2 config files (schema.xml, solrconfig.xml)&lt;/p&gt;</comment>
                            <comment id="13885364" author="arun_mist" created="Wed, 29 Jan 2014 14:08:02 +0000"  >&lt;p&gt;I did investigate this issue and found that it is a desired behavior of the highlighter. The default chars to analyze for highlighter is hard coded and set to 51200 chars max.&lt;/p&gt;

&lt;p&gt;DEFAULT_MAX_CHARS_TO_ANALYZE = 50*1024;&lt;/p&gt;

&lt;p&gt;But the document you indexed has more characters to analyze in one of the field value that causes this issue. But there is a way to increase this max chars to analyze by sending an additional query param like this hl.maxAnalyzedChars=52300&lt;/p&gt;

&lt;p&gt;So if I fire a query as below then the error is not seen.&lt;br/&gt;
&lt;a href=&quot;http://localhost:8983/solr/global/select?q=aa&amp;amp;indent=true&amp;amp;hl=true&amp;amp;hl.fl=*_stx&amp;amp;hl.simple.pre=%3Cem%3E&amp;amp;hl.simple.post=%3C/em%3E&amp;amp;hl.maxAnalyzedChars=52300&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8983/solr/global/select?q=aa&amp;amp;indent=true&amp;amp;hl=true&amp;amp;hl.fl=*_stx&amp;amp;hl.simple.pre=%3Cem%3E&amp;amp;hl.simple.post=%3C/em%3E&amp;amp;hl.maxAnalyzedChars=52300&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Hope this helps. &lt;/p&gt;</comment>
                            <comment id="13892043" author="arun_mist" created="Wed, 5 Feb 2014 12:20:48 +0000"  >&lt;p&gt;disregard my previous comments, Even if a string exists the max offset limit it shouldn&apos;t blow up with an exception. On further investigation I found that an unused token of the larger string when it token count increase the max offset limit carries to the next available string in the loop. Attached a patch file for the fix, it resolves the issue.&lt;/p&gt;</comment>
                            <comment id="13893706" author="hossman" created="Thu, 6 Feb 2014 19:37:44 +0000"  >&lt;p&gt;Arun: Since you seem to have a grasp on the problem here, would it be possible for you to help write a unit test to recreate it?&lt;/p&gt;</comment>
                            <comment id="13893709" author="hossman" created="Thu, 6 Feb 2014 19:39:27 +0000"  >&lt;p&gt;Also: when submitting patches, it&apos;s really helpful if you can please generate the patch against the entire code base...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://wiki.apache.org/solr/HowToContribute#Generating_a_patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://wiki.apache.org/solr/HowToContribute#Generating_a_patch&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13894432" author="arun_mist" created="Fri, 7 Feb 2014 11:41:19 +0000"  >&lt;p&gt;Patch generated at the project root level. &lt;/p&gt;</comment>
                            <comment id="13894434" author="arun_mist" created="Fri, 7 Feb 2014 11:44:51 +0000"  >&lt;p&gt;Hi Hoss,&lt;/p&gt;

&lt;p&gt;Thanks for your review, I have updated the patch which is generated against the entire code base. I tried to create an unit test to recreate it but couldn&apos;t do that successfully as this is reproducible in combination of CachingTokenFilter along with OffsetLimitTokenFilter.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Arun&lt;/p&gt;</comment>
                            <comment id="13900481" author="steve_rowe" created="Thu, 13 Feb 2014 16:32:09 +0000"  >&lt;p&gt;Arun, what do you mean when you say the following?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I tried to create an unit test to recreate it but couldn&apos;t do that successfully as this is reproducible in combination of CachingTokenFilter along with OffsetLimitTokenFilter.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t understand why these token filters need to be involved?  I looked at the schema.xml in the .zip attachment, and the &lt;tt&gt;&amp;#42;_stx&lt;/tt&gt; fields&apos; type &lt;tt&gt;text_stx&lt;/tt&gt; doesn&apos;t use those filters.&lt;/p&gt;

&lt;p&gt;The patch you attached can&apos;t be committed without a unit test that fails without the patch and succeeds with it.&lt;/p&gt;</comment>
                            <comment id="13902433" author="arun_mist" created="Sat, 15 Feb 2014 15:17:17 +0000"  >&lt;p&gt;Steve, thanks for reviewing my changes. All these token filters are used by the highlighter component. I have updated the patch with a unit test which helps us to reproduce the issue and the code change in the patch fixes it. &lt;/p&gt;</comment>
                            <comment id="13988848" author="iorixxx" created="Sat, 3 May 2014 23:40:25 +0000"  >&lt;p&gt;Bring failing test case to trunk. Simplify schema and add 5 test methods to isolate problem. Problematic field type is given below. Exception occurs for only &lt;b&gt;stored&lt;/b&gt; and &lt;b&gt;multiValued&lt;/b&gt; field. TestCase demonstrates this.&lt;/p&gt;

&lt;p&gt;Another interesting thing is test passes&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;when WordDelimiterFilterFactory is removed from index analyzer&lt;/li&gt;
	&lt;li&gt;when ReversedWildcardFilterFactory is removed from index analyzer&lt;br/&gt;
separately. &lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt; &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;fieldType name=&lt;span class=&quot;code-quote&quot;&gt;&quot;text_stx&quot;&lt;/span&gt; class=&lt;span class=&quot;code-quote&quot;&gt;&quot;solr.TextField&quot;&lt;/span&gt; positionIncrementGap=&lt;span class=&quot;code-quote&quot;&gt;&quot;100&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;analyzer type=&lt;span class=&quot;code-quote&quot;&gt;&quot;index&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;tokenizer class=&lt;span class=&quot;code-quote&quot;&gt;&quot;solr.WhitespaceTokenizerFactory&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;filter class=&lt;span class=&quot;code-quote&quot;&gt;&quot;solr.WordDelimiterFilterFactory&quot;&lt;/span&gt; generateWordParts=&lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt; generateNumberParts=&lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt; catenateWords=&lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt; catenateNumbers=&lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt; catenateAll=&lt;span class=&quot;code-quote&quot;&gt;&quot;0&quot;&lt;/span&gt; splitOnCaseChange=&lt;span class=&quot;code-quote&quot;&gt;&quot;0&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;filter class=&lt;span class=&quot;code-quote&quot;&gt;&quot;solr.LowerCaseFilterFactory&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
        &amp;lt;filter class=&lt;span class=&quot;code-quote&quot;&gt;&quot;solr.ReversedWildcardFilterFactory&quot;&lt;/span&gt; withOriginal=&lt;span class=&quot;code-quote&quot;&gt;&quot;true&quot;&lt;/span&gt;
           maxPosAsterisk=&lt;span class=&quot;code-quote&quot;&gt;&quot;3&quot;&lt;/span&gt; maxPosQuestion=&lt;span class=&quot;code-quote&quot;&gt;&quot;2&quot;&lt;/span&gt; maxFractionAsterisk=&lt;span class=&quot;code-quote&quot;&gt;&quot;0.33&quot;&lt;/span&gt;/&amp;gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/analyzer&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;analyzer type=&lt;span class=&quot;code-quote&quot;&gt;&quot;query&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;tokenizer class=&lt;span class=&quot;code-quote&quot;&gt;&quot;solr.WhitespaceTokenizerFactory&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;filter class=&lt;span class=&quot;code-quote&quot;&gt;&quot;solr.SynonymFilterFactory&quot;&lt;/span&gt; synonyms=&lt;span class=&quot;code-quote&quot;&gt;&quot;synonyms.txt&quot;&lt;/span&gt; ignoreCase=&lt;span class=&quot;code-quote&quot;&gt;&quot;true&quot;&lt;/span&gt; expand=&lt;span class=&quot;code-quote&quot;&gt;&quot;true&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;filter class=&lt;span class=&quot;code-quote&quot;&gt;&quot;solr.WordDelimiterFilterFactory&quot;&lt;/span&gt; generateWordParts=&lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt; generateNumberParts=&lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt; catenateWords=&lt;span class=&quot;code-quote&quot;&gt;&quot;0&quot;&lt;/span&gt; catenateNumbers=&lt;span class=&quot;code-quote&quot;&gt;&quot;0&quot;&lt;/span&gt; catenateAll=&lt;span class=&quot;code-quote&quot;&gt;&quot;0&quot;&lt;/span&gt; splitOnCaseChange=&lt;span class=&quot;code-quote&quot;&gt;&quot;0&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;filter class=&lt;span class=&quot;code-quote&quot;&gt;&quot;solr.LowerCaseFilterFactory&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/analyzer&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/fieldType&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13988850" author="iorixxx" created="Sat, 3 May 2014 23:43:36 +0000"  >&lt;p&gt;Does any know how can we add &lt;tt&gt;ReversedWildcardFilterFactory&lt;/tt&gt; to &lt;tt&gt;TestRandomChains&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="13988858" author="iorixxx" created="Sun, 4 May 2014 00:03:58 +0000"  >&lt;p&gt;I said/used &lt;tt&gt;stored&lt;/tt&gt; by mistake. I was trying to figure out its relation to &lt;tt&gt;indexed&lt;/tt&gt; property. This patch corrects this. Note that indexed=false fields can be highlighted if tokenizer defined for them.&lt;/p&gt;

&lt;p&gt;Only failing method is testIndexedMultiValued. Other three combinations pass.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt; &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;field name=&lt;span class=&quot;code-quote&quot;&gt;&quot;indexed_multiValued&quot;&lt;/span&gt;       type=&lt;span class=&quot;code-quote&quot;&gt;&quot;text_stx&quot;&lt;/span&gt; indexed=&lt;span class=&quot;code-quote&quot;&gt;&quot;true&quot;&lt;/span&gt; stored=&lt;span class=&quot;code-quote&quot;&gt;&quot;true&quot;&lt;/span&gt;  multiValued=&lt;span class=&quot;code-quote&quot;&gt;&quot;true&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13988860" author="iorixxx" created="Sun, 4 May 2014 00:13:18 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arun_mist&quot; class=&quot;user-hover&quot; rel=&quot;arun_mist&quot;&gt;arun_mist&lt;/a&gt;, I couldn&apos;t see your fix in your patch. Did you forget to add it accidentally? The patch you attached does not include OffsetLimitTokenFilter.java.patch. Can you re-attact it?&lt;/p&gt;</comment>
                            <comment id="14014641" author="arun_mist" created="Sat, 31 May 2014 13:14:03 +0000"  >&lt;p&gt;In my last patch upload I accidentally missed out the main change, in this patch it is covered up. &lt;/p&gt;</comment>
                            <comment id="14014731" author="iorixxx" created="Sat, 31 May 2014 18:20:12 +0000"  >&lt;p&gt;Thanks! Arun, so this is the fix &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;-    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (offsetCount &amp;lt; offsetLimit &amp;amp;&amp;amp; input.incrementToken()) {
+    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (input.incrementToken() &amp;amp;&amp;amp; offsetCount &amp;lt; offsetLimit) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;with this test of &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-3193&quot; title=&quot;highligting on an unindexed field throws InvalidTokenOffsetsException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-3193&quot;&gt;&lt;del&gt;SOLR-3193&lt;/del&gt;&lt;/a&gt; passes too. Can you explain what is the magic here?&lt;/p&gt;</comment>
                            <comment id="14031013" author="hossman" created="Fri, 13 Jun 2014 19:04:32 +0000"  >&lt;p&gt;I&apos;ve updated the patch to cleanup the test a bit...&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;renamed new schema field &amp;amp; added comment about it&apos;s purpose&lt;/li&gt;
	&lt;li&gt;refactored test to eliminate some duplication &amp;amp; move the test methods to the top&lt;/li&gt;
	&lt;li&gt;added firm assertions to the test to ensure highlighting is actually happening
	&lt;ul&gt;
		&lt;li&gt;this actually uncovered a bug in the test that it wasn&apos;t doing anything useful on the non-indexed fields because they didn&apos;t match any docs&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;...the change to OffsetLimitTokenFilter definitely fixes the problem &amp;#8211; but i&apos;m honestly not sure if that&apos;s the right fix &amp;#8211; it&apos;s not clear to me why consuming the token before checking hte limit is the &quot;correct&quot; behavior (it seems counter intuitive to me) and makes me wonder if this is actually masking some other &quot;real&quot; bug in ReversedWildcardFilter&lt;/p&gt;</comment>
                            <comment id="14031042" author="thetaphi" created="Fri, 13 Jun 2014 19:24:36 +0000"  >&lt;p&gt;Hi,&lt;br/&gt;
the issue is in ReversedWildcardTokenFilter: The TokenFilter does not correctly implement reset(). If the TokenStream is reused and it was not completely consumed before, the state is still active. In that case it restores the &quot;save&quot; state and so injects a buggy state from the previous usage as first token into the new one.&lt;/p&gt;

&lt;p&gt;The fix is to make ReverseWildcardTokenFilter correctly implement reset() and NULL all state. The pseudo-fix in the highligters&apos;s tokenfilter just hides the bug.&lt;/p&gt;

&lt;p&gt;I will provide a patch in a minute!&lt;/p&gt;</comment>
                            <comment id="14031054" author="thetaphi" created="Fri, 13 Jun 2014 19:32:41 +0000"  >&lt;p&gt;This is the correct fix:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Added missing reset() in ReverseWildCardFilter&lt;/li&gt;
	&lt;li&gt;made fields correct final, so its obvious which is state and which is config&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14031067" author="hossman" created="Fri, 13 Jun 2014 19:41:31 +0000"  >&lt;p&gt;Spoke to Uwe on IRC: he&apos;s AFK but asked me to go ahead and commit &amp;amp; backport on his behalf &amp;#8211; will do as soon as full test&amp;amp;precommit finish.&lt;/p&gt;</comment>
                            <comment id="14031182" author="jira-bot" created="Fri, 13 Jun 2014 21:15:51 +0000"  >&lt;p&gt;Commit 1602525 from hossman@apache.org in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1602525&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1602525&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5426&quot; title=&quot;org.apache.solr.common.SolrException; org.apache.solr.common.SolrException: org.apache.lucene.search.highlight.InvalidTokenOffsetsException: Token 0 exceeds length of provided text sized 840&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5426&quot;&gt;&lt;del&gt;SOLR-5426&lt;/del&gt;&lt;/a&gt;: Fixed a bug in ReverseWildCardFilter that could cause InvalidTokenOffsetsException when highlighting&lt;/p&gt;</comment>
                            <comment id="14031200" author="iorixxx" created="Fri, 13 Jun 2014 21:30:18 +0000"  >&lt;p&gt;Thanks Uwe! and Hoss for bringing closure.&lt;/p&gt;</comment>
                            <comment id="14031202" author="jira-bot" created="Fri, 13 Jun 2014 21:31:40 +0000"  >&lt;p&gt;Commit 1602527 from hossman@apache.org in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1602527&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1602527&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5426&quot; title=&quot;org.apache.solr.common.SolrException; org.apache.solr.common.SolrException: org.apache.lucene.search.highlight.InvalidTokenOffsetsException: Token 0 exceeds length of provided text sized 840&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5426&quot;&gt;&lt;del&gt;SOLR-5426&lt;/del&gt;&lt;/a&gt;: Fixed a bug in ReverseWildCardFilter that could cause InvalidTokenOffsetsException when highlighting (merge r1602525)&lt;/p&gt;</comment>
                            <comment id="14031209" author="hossman" created="Fri, 13 Jun 2014 21:36:07 +0000"  >&lt;p&gt;Thanks everybody!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12609444">SOLR-3901</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12544965">SOLR-3193</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12544965">SOLR-3193</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12650369" name="SOLR-5426.patch" size="34136" author="uschindler" created="Fri, 13 Jun 2014 19:32:41 +0000"/>
                            <attachment id="12650364" name="SOLR-5426.patch" size="32812" author="hossman" created="Fri, 13 Jun 2014 19:04:32 +0000"/>
                            <attachment id="12647772" name="SOLR-5426.patch" size="33680" author="arun_mist" created="Sat, 31 May 2014 13:14:03 +0000"/>
                            <attachment id="12643244" name="SOLR-5426.patch" size="33059" author="iorixxx" created="Sun, 4 May 2014 00:03:58 +0000"/>
                            <attachment id="12643242" name="SOLR-5426.patch" size="48954" author="iorixxx" created="Sat, 3 May 2014 23:40:25 +0000"/>
                            <attachment id="12629221" name="SOLR-5426.patch" size="100381" author="arun_mist" created="Sat, 15 Feb 2014 15:17:17 +0000"/>
                            <attachment id="12612531" name="highlighter.zip" size="129336" author="nmg" created="Thu, 7 Nov 2013 04:34:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>357303</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 23 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1plgf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>357593</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>