<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:46:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[NIFI-6420] Controller Service references not properly tracked if multiple references from same component</title>
                <link>https://issues.apache.org/jira/browse/NIFI-6420</link>
                <project id="12316020" key="NIFI">Apache NiFi</project>
                    <description>&lt;p&gt;The StandardControllerServiceNode keeps track of any references to it via `addReference` and `removeReference` methods. However, if a Processor (or another Controller Service) has two different properties that reference the service, then the references can become incorrect.&lt;/p&gt;

&lt;p&gt;This is due to the fact that when Properties are set for a component, we determine that Property A previously referenced Service 123 but no longer does and call `removeReference` on Service 123. However, if Property B also is referencing Service 123, we have a condition where the Processor is referencing Service 123, but Service 123 does not know about it, because of the call to `removeReference`.&lt;/p&gt;

&lt;p&gt;We should either be storing references as a `List` in `StandardControllerServiceNode` or else should determine whether or not all references have been removed before calling `removeReference`. I suspect that the latter is less error-prone, given that calls to `addReference` currently are idempotent and changing the data structure to a `List` would mean that the method is no longer idempotent.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13243072">NIFI-6420</key>
            <summary>Controller Service references not properly tracked if multiple references from same component</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="AxelSync">Alessandro D&apos;Armiento</assignee>
                                    <reporter username="markap14">Mark Payne</reporter>
                        <labels>
                            <label>cleanup</label>
                            <label>codesmell</label>
                            <label>refactor</label>
                    </labels>
                <created>Wed, 3 Jul 2019 18:49:00 +0000</created>
                <updated>Sat, 10 Aug 2019 09:06:30 +0000</updated>
                            <resolved>Fri, 9 Aug 2019 19:23:51 +0000</resolved>
                                                    <fixVersion>1.10.0</fixVersion>
                                    <component>Core Framework</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="14400">4h</timespent>
                                <comments>
                            <comment id="16878081" author="markap14" created="Wed, 3 Jul 2019 18:50:19 +0000"  >&lt;p&gt;The following integration test can be used to replicate this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testReferenceCounts() {
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ControllerServiceNode serviceNode = createControllerServiceNode(LongValidatingControllerService.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getName());
    serviceNode.setProperties(Collections.singletonMap(LongValidatingControllerService.DELAY.getName(), &lt;span class=&quot;code-quote&quot;&gt;&quot;250 millis&quot;&lt;/span&gt;));

    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ProcessorNode counter = createProcessorNode(ControllerServiceReferencingProcessor.class);

    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; properties = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&amp;gt;();

    properties.put(ControllerServiceReferencingProcessor.OPTIONAL_SERVICE.getName(), serviceNode.getIdentifier());
    counter.setProperties(properties);
    assertEquals(1, serviceNode.getReferences().getReferencingComponents().size());

    properties.put(ControllerServiceReferencingProcessor.IGNORED_OPTIONAL_SERVICE.getName(), serviceNode.getIdentifier());
    counter.setProperties(properties);
    assertEquals(1, serviceNode.getReferences().getReferencingComponents().size());

    properties.put(ControllerServiceReferencingProcessor.IGNORED_OPTIONAL_SERVICE.getName(), &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
    counter.setProperties(properties);
    assertEquals(1, serviceNode.getReferences().getReferencingComponents().size());

    properties.clear();
    properties.put(ControllerServiceReferencingProcessor.OPTIONAL_SERVICE.getName(), &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
    counter.setProperties(properties);
    assertEquals(0, serviceNode.getReferences().getReferencingComponents().size());
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16904143" author="jira-bot" created="Fri, 9 Aug 2019 19:22:50 +0000"  >&lt;p&gt;Commit 35d79eaf0fbd2361b3950a8417cb5f5b82d8cd44 in nifi&apos;s branch refs/heads/master from Alessandro D&apos;Armiento&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=nifi.git;h=35d79ea&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=nifi.git;h=35d79ea&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/NIFI-6420&quot; title=&quot;Controller Service references not properly tracked if multiple references from same component&quot; class=&quot;issue-link&quot; data-issue-key=&quot;NIFI-6420&quot;&gt;&lt;del&gt;NIFI-6420&lt;/del&gt;&lt;/a&gt; Controller Service references not properly tracked if multiple references from same component&lt;/p&gt;

&lt;p&gt;&amp;lt;h1&amp;gt;Changes&amp;lt;/h1&amp;gt;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Instead of keeping a Set of referencing `ComponentNode`, keep instead a Map which stores, for each referencing component, also the name of the property for which the service is referenced&lt;/li&gt;
	&lt;li&gt;This is done to keep the `addReference()` idempotent&lt;/li&gt;
	&lt;li&gt;`StandardControllerService.referencingComponents` changed from HashSet to HashMap&lt;/li&gt;
	&lt;li&gt;`Key` is the combination of `ComponentNode.hashCode()` and property name&lt;/li&gt;
	&lt;li&gt;`Value` is the referencing `ComponentNode`&lt;/li&gt;
	&lt;li&gt;`ControllerServiceNode.addReference()` now requires a tuple (referring `ComponentNode`, property name)&lt;/li&gt;
	&lt;li&gt;`ControllerServiceNode.removeReference()` now requires a tuple (referring `ComponentNode`, property name)&lt;/li&gt;
	&lt;li&gt;`ControllerServiceNode.getReferences()` signature is left untouched, when it&apos;s called, the values of the `referencingComponents` map are turned into a Set, meaning a referencing component will keep being returned by this method until at least one of its properties still reference the `ControllerService`&lt;/li&gt;
	&lt;li&gt;`StandardSchedulingContext.leaseControllerService()` uses a dedicated constant&lt;/li&gt;
	&lt;li&gt;`FrameworkIntegrationTest` has a test which create a processor with two optional controller service properties and then verifies that having them referencing and dereferencing the same controller service doesn&apos;t cause the reported bug anymore&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Removed SchedulingContext from ClojureScriptEngineConfigurator&lt;/p&gt;

&lt;p&gt;Co-Authored-By: Marco Gaido &amp;lt;marcogaido91@gmail.com&amp;gt;&lt;br/&gt;
Signed-off-by: Mark Payne &amp;lt;markap14@hotmail.com&amp;gt;&lt;/p&gt;

&lt;p&gt;This closes #3600.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13238833">NIFI-6371</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 14 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z04csw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>