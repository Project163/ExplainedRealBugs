{"url":"https://api.github.com/repos/FasterXML/jackson-dataformats-binary/issues/67","repository_url":"https://api.github.com/repos/FasterXML/jackson-dataformats-binary","labels_url":"https://api.github.com/repos/FasterXML/jackson-dataformats-binary/issues/67/labels{/name}","comments_url":"https://api.github.com/repos/FasterXML/jackson-dataformats-binary/issues/67/comments","events_url":"https://api.github.com/repos/FasterXML/jackson-dataformats-binary/issues/67/events","html_url":"https://github.com/FasterXML/jackson-dataformats-binary/issues/67","id":216388644,"node_id":"MDU6SXNzdWUyMTYzODg2NDQ=","number":67,"title":"Serialization of multiple nesting levels has issues","user":{"login":"marsqing","id":71290,"node_id":"MDQ6VXNlcjcxMjkw","avatar_url":"https://avatars.githubusercontent.com/u/71290?v=4","gravatar_id":"","url":"https://api.github.com/users/marsqing","html_url":"https://github.com/marsqing","followers_url":"https://api.github.com/users/marsqing/followers","following_url":"https://api.github.com/users/marsqing/following{/other_user}","gists_url":"https://api.github.com/users/marsqing/gists{/gist_id}","starred_url":"https://api.github.com/users/marsqing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marsqing/subscriptions","organizations_url":"https://api.github.com/users/marsqing/orgs","repos_url":"https://api.github.com/users/marsqing/repos","events_url":"https://api.github.com/users/marsqing/events{/privacy}","received_events_url":"https://api.github.com/users/marsqing/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":433796747,"node_id":"MDU6TGFiZWw0MzM3OTY3NDc=","url":"https://api.github.com/repos/FasterXML/jackson-dataformats-binary/labels/protobuf","name":"protobuf","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/FasterXML/jackson-dataformats-binary/milestones/10","html_url":"https://github.com/FasterXML/jackson-dataformats-binary/milestone/10","labels_url":"https://api.github.com/repos/FasterXML/jackson-dataformats-binary/milestones/10/labels","id":2353768,"node_id":"MDk6TWlsZXN0b25lMjM1Mzc2OA==","number":10,"title":"2.8.8","description":null,"creator":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":4,"state":"open","created_at":"2017-02-28T16:34:02Z","updated_at":"2017-04-04T23:20:13Z","due_on":null,"closed_at":null},"comments":4,"created_at":"2017-03-23T10:56:09Z","updated_at":"2017-04-04T23:20:13Z","closed_at":"2017-04-04T23:20:13Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"With latest snapshot version 2.9.0.pr3-SNAPSHOT, field of bigger tag will be serialized between fields  of smaller tag. Below is the test case.\r\nThe serialization result is(in hex)\r\n08 01 12 0a 12 02 08 03 **08 02** 12 02 08 04\r\nWhile the correct result is(in hex) \r\n08 01 12 0a  **08 02** 12 02 08 03 12 02 08 04\r\n\r\n'08 02' is inserted between list element '12 02 08 03' and '12 02 08 04' \r\n\r\n\r\n```java\r\nimport static org.junit.Assert.assertEquals;\r\n\r\nimport com.fasterxml.jackson.databind.ObjectMapper;\r\nimport com.fasterxml.jackson.dataformat.protobuf.ProtobufMapper;\r\nimport com.fasterxml.jackson.dataformat.protobuf.schema.ProtobufSchema;\r\nimport com.fasterxml.jackson.dataformat.protobuf.schemagen.ProtobufSchemaGenerator;\r\nimport java.io.ByteArrayInputStream;\r\nimport java.io.ByteArrayOutputStream;\r\nimport java.util.Arrays;\r\nimport java.util.List;\r\nimport org.junit.Test;\r\n\r\n/**\r\n * Created by marsqing on 23/03/2017.\r\n */\r\npublic class BugReport {\r\n\r\n  @Test\r\n  public void test() throws Exception {\r\n    ProtobufMapper mapper = new ProtobufMapper();\r\n    ProtobufSchema schema = getSchema(mapper, Level1.class);\r\n\r\n    System.out.println(schema.getSource());\r\n\r\n    Level1 level1 = new Level1();\r\n    Level2 level2 = new Level2();\r\n    Level3 level3a = new Level3();\r\n    Level3 level3b = new Level3();\r\n\r\n    level1.setValue(1);\r\n    level2.setValue(2);\r\n    level3a.setValue(3);\r\n    level3b.setValue(4);\r\n    List<Level3> level3s = Arrays.asList(level3a, level3b);\r\n\r\n    level1.setLevel2(level2);\r\n    level2.setLevel3s(level3s);\r\n\r\n    ByteArrayOutputStream bout = new ByteArrayOutputStream();\r\n    mapper.writer(schema).writeValue(bout, level1);\r\n\r\n    showBytes(bout.toByteArray());\r\n\r\n    Level1 gotLevel1 = mapper.readerFor(Level1.class).with(schema).readValue(new ByteArrayInputStream(bout.toByteArray()));\r\n\r\n//    byte[] correct = new byte[]{0x08, 0x01, 0x12, 0x0a, 0x08, 0x02, 0x12, 0x02, 0x08, 0x03, 0x12, 0x02, 0x08, 0x04};\r\n//    Level1 gotLevel1 = mapper.readerFor(Level1.class).with(schema).readValue(new ByteArrayInputStream(correct));\r\n\r\n    assertEquals(level1.getValue(), gotLevel1.getValue());\r\n    assertEquals(level2.getValue(), gotLevel1.getLevel2().getValue());\r\n    assertEquals(level3s.size(), gotLevel1.getLevel2().getLevel3s().size());\r\n    assertEquals(level3a.getValue(), gotLevel1.getLevel2().getLevel3s().get(0).getValue());\r\n    assertEquals(level3b.getValue(), gotLevel1.getLevel2().getLevel3s().get(1).getValue());\r\n  }\r\n\r\n  private ProtobufSchema getSchema(ObjectMapper mapper, Class<?> clazz) throws Exception {\r\n    ProtobufSchemaGenerator gen = new ProtobufSchemaGenerator();\r\n    mapper.acceptJsonFormatVisitor(clazz, gen);\r\n    return gen.getGeneratedSchema();\r\n  }\r\n\r\n  private void showBytes(byte[] bytes) {\r\n    for (byte b : bytes) {\r\n      System.out.print(String.format(\"%8s\", Integer.toHexString(b)).substring(6, 8).replaceAll(\" \", \"0\") + \" \");\r\n    }\r\n    System.out.println();\r\n  }\r\n\r\n  public static class Level1 {\r\n\r\n    private int value;\r\n\r\n    private Level2 level2;\r\n\r\n    public int getValue() {\r\n      return value;\r\n    }\r\n\r\n    public void setValue(int value) {\r\n      this.value = value;\r\n    }\r\n\r\n    public Level2 getLevel2() {\r\n      return level2;\r\n    }\r\n\r\n    public void setLevel2(Level2 level2) {\r\n      this.level2 = level2;\r\n    }\r\n  }\r\n\r\n  public static class Level2 {\r\n\r\n    private int value;\r\n    private List<Level3> level3s;\r\n\r\n    public int getValue() {\r\n      return value;\r\n    }\r\n\r\n    public void setValue(int value) {\r\n      this.value = value;\r\n    }\r\n\r\n    public List<Level3> getLevel3s() {\r\n      return level3s;\r\n    }\r\n\r\n    public void setLevel3s(List<Level3> level3s) {\r\n      this.level3s = level3s;\r\n    }\r\n  }\r\n\r\n  public static class Level3 {\r\n\r\n    private int value;\r\n\r\n    public int getValue() {\r\n      return value;\r\n    }\r\n\r\n    public void setValue(int value) {\r\n      this.value = value;\r\n    }\r\n\r\n  }\r\n\r\n}\r\n```","closed_by":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/FasterXML/jackson-dataformats-binary/issues/67/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/FasterXML/jackson-dataformats-binary/issues/67/timeline","performed_via_github_app":null,"state_reason":"completed"}