<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sun Nov 09 05:55:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GEOMETRY-71] Investigate Spherical Barycenter Accuracy</title>
                <link>https://issues.apache.org/jira/browse/GEOMETRY-71</link>
                <project id="12321920" key="GEOMETRY">Commons Geometry</project>
                    <description>&lt;p&gt;The current code for computing spherical barycenters in &lt;tt&gt;ConvexArea2S.getBarycenter()&lt;/tt&gt; seems to suffer from floating point accuracy issues. The &lt;tt&gt;ConvexArea2STest.checkBarycenterConsistency()&lt;/tt&gt; method checks the consistency of the barycenter computation of a region by splitting the region into two sections, computing the area and barycenter of each section, and then computing the combined barycenter of the sections by adding the barycenter of each scaled by its corresponding area. It is expected that the combined barycenter computed in this way should equal the barycenter computed for the region as a whole. However, in practice, a large epsilon value is needed in the comparison in order for the tests to pass. We need to investigate why this is the case.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13272002">GEOMETRY-71</key>
            <summary>Investigate Spherical Barycenter Accuracy</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="mattjuntunen">Matt Juntunen</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 3 Dec 2019 16:47:22 +0000</created>
                <updated>Sun, 19 Jan 2020 16:26:49 +0000</updated>
                            <resolved>Sun, 19 Jan 2020 16:26:36 +0000</resolved>
                                                    <fixVersion>1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17006108" author="balsingh" created="Tue, 31 Dec 2019 13:48:04 +0000"  >&lt;p&gt;Somewhat related issue that I reported in commons-math3:&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/MATH-1507&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/MATH-1507&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I have no tried to recreate the issue with the new library (yet) as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erans&quot; class=&quot;user-hover&quot; rel=&quot;erans&quot;&gt;erans&lt;/a&gt;&#160;suggested.&lt;/p&gt;</comment>
                            <comment id="17006153" author="mattjuntunen" created="Tue, 31 Dec 2019 16:09:08 +0000"  >&lt;p&gt;Yes, this sounds similar to what I was seeing. I&apos;ll be very interested to see if the issue you reported is still present in the new code.&lt;/p&gt;

&lt;p&gt;BTW, here is one way you could create your test circle with the new API (note: this is untested):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
DoublePrecisionContext precision = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; EpsilonDoublePrecisionContext(1e-6);

GreatArcPath path = GreatArcPath.builder(precision)
	.append(Point2S.of(0, PlaneAngleRadians.PI_OVER_TWO))
	.append(Point2S.of(PlaneAngleRadians.PI_OVER_TWO, PlaneAngleRadians.PI_OVER_TWO)
	&lt;span class=&quot;code-comment&quot;&gt;// ... more vertices in whatever winding order is desired
&lt;/span&gt;	.build(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;); &lt;span class=&quot;code-comment&quot;&gt;// build the path, ending with the start vertex
&lt;/span&gt;	
RegionBSPTree2S tree = path.toTree(); &lt;span class=&quot;code-comment&quot;&gt;// convert to a bsp tree (contains functionality of previous SphericalPolygonsSet class)
&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;// compute geometric properties
&lt;/span&gt;tree.getBarycenter();
tree.getSize();
tree.getBoundarySize();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17007578" author="balsingh" created="Fri, 3 Jan 2020 15:45:12 +0000"  >&lt;p&gt;Why do you need the first two points?&lt;/p&gt;</comment>
                            <comment id="17007580" author="mattjuntunen" created="Fri, 3 Jan 2020 15:50:49 +0000"  >&lt;p&gt;You don&apos;t. I just included them to demonstrate how to append vertices to the path.&lt;/p&gt;</comment>
                            <comment id="17007592" author="balsingh" created="Fri, 3 Jan 2020 15:57:19 +0000"  >&lt;p&gt;Sounds good.&#160;I&apos;ll certainly test it and share the results, but I can&apos;t upgrade my production code until this library is released. What is the expected release time?&lt;/p&gt;</comment>
                            <comment id="17007623" author="mattjuntunen" created="Fri, 3 Jan 2020 16:52:07 +0000"  >&lt;p&gt;Ideally as soon as possible, since I&apos;d like to use it, too. The main bulk of the work for the first release was completed a month or two ago and we&apos;re now polishing and adding smaller features. The &lt;a href=&quot;https://issues.apache.org/jira/projects/GEOMETRY/versions/12344160&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;TODO page&lt;/a&gt; for release 1 lists 8 issues remaining. There are a number of other features that I&apos;d like to add but it may be better to just save those for later releases in order to get this out the door.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erans&quot; class=&quot;user-hover&quot; rel=&quot;erans&quot;&gt;erans&lt;/a&gt;, what do you think?&lt;/p&gt;</comment>
                            <comment id="17007670" author="erans" created="Fri, 3 Jan 2020 18:04:24 +0000"  >&lt;blockquote&gt;&lt;p&gt;release &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt; what do you think?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This must be discussed on the &quot;dev&quot; ML.  Especially to gather opinions about what would be blockers.&lt;br/&gt;
We also mentioned releasing a &quot;beta&quot; version (with no compatibility requirements). With a &quot;0.x&quot; version &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</comment>
                            <comment id="17009161" author="balsingh" created="Mon, 6 Jan 2020 20:53:53 +0000"  >&lt;p&gt;Is there new API to translate a Point2S by a some distance in some direction (bearing/azimuth)? Need it to generate points at a constant distance from the circle center.&lt;/p&gt;</comment>
                            <comment id="17009311" author="mattjuntunen" created="Tue, 7 Jan 2020 02:34:42 +0000"  >&lt;p&gt;There isn&apos;t anything in the API about bearing but you can rotate points along great arcs using the &lt;tt&gt;Transform2S&lt;/tt&gt; class. You could use something like the code below to generate your point sequence:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Point2S centerPt = Point2S.PLUS_I; &lt;span class=&quot;code-comment&quot;&gt;// center point of the circle
&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; circleSize = 0.25 * &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.PI; &lt;span class=&quot;code-comment&quot;&gt;// circle radius given in radians
&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; numPts = 20; &lt;span class=&quot;code-comment&quot;&gt;// number of points on the outside of the circle
&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;// get an arbitrary point on the circle boundary
&lt;/span&gt;Point2S outsidePt = Transform2S.createRotation(centerPt.getVector().orthogonal(), circleSize)
        .apply(centerPt);

&lt;span class=&quot;code-comment&quot;&gt;// create the list of boundary points by rotating the previous point around the circle center
&lt;/span&gt;List&amp;lt;Point2S&amp;gt; pts = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;();
pts.add(outsidePt);

Transform2S rotate = Transform2S.createRotation(centerPt, PlaneAngleRadians.TWO_PI / numPts);
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 1; i &amp;lt; numPts; ++i) {
    pts.add(rotate.apply(pts.get(i - 1)));
}

&lt;span class=&quot;code-comment&quot;&gt;// create the path and bsp tree from the circle points
&lt;/span&gt;RegionBSPTree2S tree = GreatArcPath.fromVertexLoop(pts, precision).toTree();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Feel free to start a discussion on the dev ML, create a new JIRA issue, and/or submit a PR if you feel something is lacking in the API.&lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                            <comment id="17009821" author="balsingh" created="Tue, 7 Jan 2020 15:26:27 +0000"  >&lt;p&gt;I added it as a unit test for RegionBSPTree2S. See&#160;&lt;a href=&quot;https://github.com/apache/commons-geometry/pull/51&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-geometry/pull/51&lt;/a&gt;. As in commons-math 3.6.1, looks like the test is failing.&lt;/p&gt;</comment>
                            <comment id="17009880" author="mattjuntunen" created="Tue, 7 Jan 2020 16:20:09 +0000"  >&lt;p&gt;Yeah, that is off significantly &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;

&lt;p&gt;Here are a few follow-up questions that I&apos;m curious about:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does commons-math-3.6.1 produce the exact same results?&lt;/li&gt;
	&lt;li&gt;Are the other geometric properties correct (size, boundary size)?&lt;/li&gt;
	&lt;li&gt;How is the accuracy of the result affected by things like number of boundary arcs, size of the circle, clockwise vs counter-clockwise, etc?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The current code to compute the barycenter was ported from the original commons-math code (which I did not write) &lt;a href=&quot;https://github.com/apache/commons-math/blob/MATH_3_6_1/src/main/java/org/apache/commons/math3/geometry/spherical/twod/PropertiesComputer.java#L133&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. While the algorithm for the area computation is derived from a reference book (article 99 in chapter VIII Area Of a Spherical Triangle. Spherical Excess. &lt;a href=&quot;http://www.gutenberg.org/ebooks/19770&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.gutenberg.org/ebooks/19770&lt;/a&gt;), the barycenter algorithm does not have such a reference. The best I could find was &lt;a href=&quot;https://archive.org/details/centroidinertiat00broc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt;, which seems to indicate that the barycenter is the sum of the pole vectors of each boundary arc multiplied by its arc length. (I documented this in the &lt;tt&gt;ConvexArea2S.getBarycenter()&lt;/tt&gt; method but I guess I forgot to do that in &lt;tt&gt;RegionBSPTree2S&lt;/tt&gt;.) This is what the code does, so either&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;I&apos;m reading the reference paper incorrectly and have the algorithm wrong,&lt;/li&gt;
	&lt;li&gt;I have the algorithm correct but implemented it incorrectly, or&lt;/li&gt;
	&lt;li&gt;the code is correct but suffers from severe issues with floating point errors.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I&apos;m not sure which one is the case.&lt;/p&gt;</comment>
                            <comment id="17009949" author="alexherbert" created="Tue, 7 Jan 2020 18:20:21 +0000"  >&lt;p&gt;Correct me if I am wrong but the PR contains an example of a point at position (1,1) with a circle drawn around it with length 0.001. This results in a lot of calls via&#160;Vector3D.linearCombination using scalar products that sum to close to 1 or zero. This delegates to numbers LinearCombination.&lt;/p&gt;

&lt;p&gt;I found an accuracy issue when using numbers LinearCombination to compute the term &lt;tt&gt;x^2 + y^2 - 1&lt;/tt&gt; when &lt;tt&gt;x^2 + y^2 == 1&lt;/tt&gt; to floating-point error in the numbers Complex class. I fixed the Complex class to use its own implementation of the scalar product. I am currently looking at the cases where LinearCombination fails and will prepare a suggestion to fix this.&lt;/p&gt;

&lt;p&gt;As a test you could replace the call to LinearCombination.value(...) in Vector3D with:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; value(&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; a1, &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; b1, &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; a2, &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; b2) {
        &lt;span class=&quot;code-comment&quot;&gt;// Deliberately avoid BigDecimal.valueOf(&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;) &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; correct precision
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BigDecimal(a1).multiply(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BigDecimal(b1))
          .add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BigDecimal(a2).multiply(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BigDecimal(b2))).doubleValue();
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;See if that improves/fixes the accuracy. If so then this is a problem with LinearCombination.value().&lt;/p&gt;

&lt;p&gt;However that may not fix it because I note that the method is using:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            barycenterVector = Vector3D.linearCombination(
                    1, barycenterVector,
                    size, area.getBarycenter().getVector());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;to accumulate a scalar product sum for each dimension x,y,z. The first part of the computation is mute as multiplication by 1 does nothing. Thus this is constantly converting the double precision coordinates for the barycentre vector to extended precision (in LinearCombination), adding a single multiplied result in high precision and then back again converting back to standard double precision. Each round-trip will result in a rounding error. Thus it may be required to maintain the extended precision representation of the barycentre through the entire summation.&lt;/p&gt;</comment>
                            <comment id="17009968" author="mattjuntunen" created="Tue, 7 Jan 2020 18:45:25 +0000"  >&lt;p&gt;Thanks, Alex! This is extraordinarily helpful. I&apos;ll try out your suggestions and see what happens.&lt;/p&gt;</comment>
                            <comment id="17009981" author="mattjuntunen" created="Tue, 7 Jan 2020 18:46:40 +0000"  >&lt;p&gt;I&apos;ve also reclassified this issue as a bug since we know that the code is definitely producing incorrect results.&lt;/p&gt;</comment>
                            <comment id="17010037" author="alexherbert" created="Tue, 7 Jan 2020 19:55:45 +0000"  >&lt;p&gt;This is not a problem with the sum of the areas. I tried this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        BigDecimal x = BigDecimal.ZERO;
        BigDecimal y = BigDecimal.ZERO;
        BigDecimal z = BigDecimal.ZERO;
        BigDecimal s = BigDecimal.ZERO;
        MathContext c = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MathContext(100); 

        &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; size;
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (ConvexArea2S area : areas) {
            size = area.getSize();

            sizeSum += size;
            barycenterVector = Vector3D.linearCombination(
                    1, barycenterVector,
                    size, area.getBarycenter().getVector());

            BigDecimal s2 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BigDecimal(size);
            Vector3D v = area.getBarycenter().getVector();
            s = s.add(s2);
            x = x.add(s2.multiply(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BigDecimal(v.getX())), c);
            y = y.add(s2.multiply(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BigDecimal(v.getY())), c);
            z = z.add(s2.multiply(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BigDecimal(v.getZ())), c);
        }

        barycenterVector = Vector3D.of(x.doubleValue(), y.doubleValue(), z.doubleValue());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The test still fails with the same margin of error.&lt;/p&gt;

&lt;p&gt;I note that in the test there is only 1 area in areas so the sum is not difficult. The code for toConvex() is beyond my knowledge of the library (or geometry) so I&apos;ll leave the investigation to you.&lt;/p&gt;

</comment>
                            <comment id="17010038" author="balsingh" created="Tue, 7 Jan 2020 19:56:32 +0000"  >&lt;p&gt;I added tests for area and boundary size. The area size is correct for both counterclockwise and clockwise. However, the boundary size test is failing for both windings. The error in the boundary size seems small (0.004%), but I wonder if that gets accumulated with float-point error. &lt;/p&gt;

&lt;p&gt;Btw, there is a &lt;a href=&quot;https://docs.oracle.com/javase/9/docs/api/java/lang/Math.html#fma-double-double-double-&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;FMA&lt;/a&gt; method as of Java 9. On modern hardware, its fast (HotSpot intrinsic). On older hardware, it relies on the slower BigDecimal.&lt;/p&gt;
</comment>
                            <comment id="17010041" author="alexherbert" created="Tue, 7 Jan 2020 20:01:40 +0000"  >&lt;p&gt;The issue with FMA is that the result is a double. If you want to use the result for more high precision work then it is better to leave the result of the computation in high precision. You only want to convert back to standard precision at the end.&lt;/p&gt;

&lt;p&gt;I wonder if there is scope in &lt;span class=&quot;error&quot;&gt;&amp;#91;numbers&amp;#93;&lt;/span&gt; to create a high precision representation of a double (i.e. a split double in two parts) with multiply, divide, add and subtract computations. The results can extend to arbitrary precision but for a start the representation could always maintain just high and low parts using 2 doubles.&lt;/p&gt;</comment>
                            <comment id="17010161" author="balsingh" created="Tue, 7 Jan 2020 23:16:14 +0000"  >&lt;p&gt;I also tried simple addition using the + operation. Still no difference. See below:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
barycenterVector = barycenterVector.add(size, area.getBarycenter().getVector());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;del&gt;I think there may a flaw in the the algorithm. The linear combination is essentially a weighted average of the barycenter normals. While this is fine for Cartesian geometry, it may not work on spherical geometry. Another way to look at weighted average is interpolation. We know that spherical interpolation (slerp) is different from linear interpolation. I don&apos;t have a mathematical proof, but intuitively, a linear average does not seem appropriate.&lt;/del&gt;&lt;/p&gt;</comment>
                            <comment id="17010203" author="balsingh" created="Wed, 8 Jan 2020 00:23:23 +0000"  >&lt;p&gt;I tried the solution provided &lt;a href=&quot;https://stackoverflow.com/questions/19897187/locating-the-centroid-center-of-mass-of-spherical-polygons&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. I wrote the following and it works for both windings:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; Point2S getBarycenter(List&amp;lt;Point2S&amp;gt; list) {
        Vector3D sumVector = Vector3D.ZERO;

        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; list.size(); i++) {
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Vector3D first = list.get(i).getVector();
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Vector3D second = list.get((i + 1) % list.size()).getVector();

            sumVector = sumVector.add(first.angle(second), first.cross(second).normalize());
        }

        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Point2S.from(sumVector);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So, it seems the algorithm is correct. There is must be a bug somewhere in calculations. Not totally sure how the above code translates in to ConvexArea2S etc.&lt;/p&gt;</comment>
                            <comment id="17010234" author="balsingh" created="Wed, 8 Jan 2020 01:30:55 +0000"  >&lt;p&gt;Something else I discovered while debugging this: see &lt;a href=&quot;https://issues.apache.org/jira/browse/GEOMETRY-86&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;GEOMETRY-86&lt;/a&gt;. This may be related to the error here.&lt;/p&gt;</comment>
                            <comment id="17010702" author="erans" created="Wed, 8 Jan 2020 14:20:29 +0000"  >&lt;p&gt;The build fails for PR #51 because of &lt;a href=&quot;https://travis-ci.org/apache/commons-geometry/jobs/634240674?utm_medium=notification&amp;amp;utm_source=github_status&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CheckStyle issues&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17010716" author="balsingh" created="Wed, 8 Jan 2020 14:39:08 +0000"  >&lt;p&gt;Fixed the Checkstyle issues. The tests still fail.&lt;/p&gt;</comment>
                            <comment id="17010805" author="erans" created="Wed, 8 Jan 2020 16:23:57 +0000"  >&lt;blockquote&gt;&lt;p&gt;Fixed the Checkstyle issues.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thanks.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The tests still fail.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Help welcome to pinpoint the origin of the problem. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17011397" author="mattjuntunen" created="Thu, 9 Jan 2020 04:18:46 +0000"  >&lt;p&gt;Here are a few more notes on this:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;When performing the ccw computation, the region consists of a single convex area, which results in a somewhat reasonable calculation of the barycenter: (0.9999999469754381, 1.0000001302354973) vs the expected value of (1.0, 1.0). This leads me to believe that the barycenter algorithm in &lt;tt&gt;ConvexArea2S&lt;/tt&gt; is &lt;span class=&quot;error&quot;&gt;&amp;#91;at least mostly&amp;#93;&lt;/span&gt; correct.&lt;/li&gt;
	&lt;li&gt;When performing the cw computation, the region is no longer convex since its encloses over half of the sphere. Therefore, when &lt;tt&gt;RegionBSPTree2S&lt;/tt&gt; computes the barycenter, the computation becomes the combination of the barycenters of 200 convex areas, the first of which is considerably larger than the others. Since the &lt;tt&gt;ConvexArea2S&lt;/tt&gt; barycenter computation seems to be correct, I suspect that the issue lies with how we&apos;re combining the barycenters of convex areas to obtain the barycenter of the whole region. We are currently just taking the region barycenter to be the sum of the 3D vector of each convex area&apos;s barycenter weighted by the area size. This is what commons-math did. However, I have yet to find an actual mathematical reference saying that this is the correct approach. I briefly tried slerp tonight but that didn&apos;t seem much better. Also, using BigDecimal to try to remove floating-point issues did not seem to help either.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17011813" author="balsingh" created="Thu, 9 Jan 2020 13:30:39 +0000"  >&lt;p&gt;Also, since the total area of the cw polygon is accurate, its probably safe to assume that the conversion to multiple ConvexArea2S is correct.&lt;/p&gt;</comment>
                            <comment id="17011848" author="erans" created="Thu, 9 Jan 2020 14:11:12 +0000"  >&lt;p&gt;Unit test(s)?&lt;/p&gt;</comment>
                            <comment id="17011852" author="balsingh" created="Thu, 9 Jan 2020 14:13:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erans&quot; class=&quot;user-hover&quot; rel=&quot;erans&quot;&gt;erans&lt;/a&gt; yes, that&apos;s what I already added in PR #51!&lt;/p&gt;</comment>
                            <comment id="17011888" author="erans" created="Thu, 9 Jan 2020 14:35:59 +0000"  >&lt;p&gt;You mentioned something as being correct, but the build fails.&lt;/p&gt;</comment>
                            <comment id="17011898" author="mattjuntunen" created="Thu, 9 Jan 2020 14:42:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erans&quot; class=&quot;user-hover&quot; rel=&quot;erans&quot;&gt;erans&lt;/a&gt;, the PR is a work-in-progress and contains unit tests that demonstrate the current issue. It is not intended to pass yet.&lt;/p&gt;</comment>
                            <comment id="17011927" author="erans" created="Thu, 9 Jan 2020 15:01:04 +0000"  >&lt;p&gt;My comment was referring to&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;its probably safe to assume that the conversion to multiple ConvexArea2S is correct.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;and asking indirectly whether a test was ensuring the &quot;it is safe to assume&quot; part in the above sentence.&#160; If &lt;b&gt;that&lt;/b&gt; test is part of the PR, then it could be committed (as WIP indeed), through a PR that does not fail the build, indicating at least the issue is somewhere else.&lt;/p&gt;

&lt;p&gt;Or perhaps I&apos;m mistaken that PR #51 is intended to be merged into &quot;master&quot; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. If so, it should be closed.&lt;/p&gt;</comment>
                            <comment id="17011943" author="balsingh" created="Thu, 9 Jan 2020 15:21:38 +0000"  >&lt;p&gt;I think I fixed it! Based on what&apos;s inside ConvexArea2S, and the code in the comments above, barycenter is the vector sum of the pole vector scaled with arclength of each edge. However, in RegionBSPTree2S, the code has two issues:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Conversion to Point2S from barycenter vector causes a loss of information, which is the weight of the ConvexArea2S barycenter.&lt;/li&gt;
	&lt;li&gt;It sums the ConvexArea2D barycenters with areas. In spherical geometry, it seems the boundary/arc length should be used.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So, I introduced a weighted barycenter. The result seems to work for both CCW and CW, and all other tests are passing too. I did increase the tolerance on the boundary size test to make it pass, which I think is fine.&lt;/p&gt;

&lt;p&gt;I haven&apos;t verified other cases (in case they don&apos;t already have unit tests). Like, does this algorithm work with polygon with holes?&lt;/p&gt;

&lt;p&gt;TravisCI seems to be taking a while to run. Things are working locally on my end.&lt;/p&gt;</comment>
                            <comment id="17011948" author="erans" created="Thu, 9 Jan 2020 15:28:08 +0000"  >&lt;blockquote&gt;&lt;p&gt;&#160;Things are working locally on my end.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Great.&lt;br/&gt;
Please squash all commits into a single one with the fixed code and unit tests (and with the first line of the log starting with &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/GEOMETRY-71&quot; title=&quot;Investigate Spherical Barycenter Accuracy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GEOMETRY-71&quot;&gt;&lt;del&gt;GEOMETRY-71&lt;/del&gt;&lt;/a&gt;&quot;).  Thanks.&lt;/p&gt;</comment>
                            <comment id="17011966" author="balsingh" created="Thu, 9 Jan 2020 15:46:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erans&quot; class=&quot;user-hover&quot; rel=&quot;erans&quot;&gt;erans&lt;/a&gt; done.&lt;/p&gt;</comment>
                            <comment id="17012377" author="mattjuntunen" created="Fri, 10 Jan 2020 01:44:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=balsingh&quot; class=&quot;user-hover&quot; rel=&quot;balsingh&quot;&gt;balsingh&lt;/a&gt;, this looks great! I tried out the implementation and I was able to almost completely remove the temporary &lt;tt&gt;BARYCENTER_EPS&lt;/tt&gt; value from &lt;tt&gt;ConvexArea2STest&lt;/tt&gt; with the exception of &lt;tt&gt;testFromBounds_triangle_small&lt;/tt&gt;. (That test is still off by about 0.003 radians from the expected value, but I&apos;m not sure if &lt;tt&gt;getBarycenter()&lt;/tt&gt; is wrong or the computation of the expected value in &lt;tt&gt;triangleBarycenter()&lt;/tt&gt;.)&lt;br/&gt;
 Here are a few follow-up items before I&apos;d say we&apos;re ready to merge:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;You mentioned that &quot;In spherical geometry, it seems the boundary/arc length should be used.&quot; Do you have any mathematical references for this? Is there some proof or formula we can reference in the code that proves that we&apos;re doing this correctly?&lt;/li&gt;
	&lt;li&gt;We may want to rename &lt;tt&gt;getWeightedBarycenter&lt;/tt&gt; to &lt;tt&gt;getWeightedBarycenterVector&lt;/tt&gt; since the convention is that a barycenter is a point in the space in question, whereas this method returns a vector in the embedding space. We should also explain in the javadoc how this value is derived and what it can be used for, ie combination of the barycenters of multiple regions.&lt;/li&gt;
	&lt;li&gt;We need to handle cases where the computed barycenter vector is exactly zero, which may be the case where identical regions lie directly opposite each other. The current behavior would be to throw an IllegalArgumentException from &lt;tt&gt;Point2S.from()&lt;/tt&gt;. However, in this case, I think we should return null, indicating that there is no unique barycenter value, and document as such. This would need to be done in &lt;tt&gt;ConvexArea2S&lt;/tt&gt; and &lt;tt&gt;RegionBSPTree2S&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;We should remove all uses of &lt;tt&gt;BARYCENTER_EPS&lt;/tt&gt; from the tests and get them to pass using the &quot;full&quot; test precision value in barycenter comparisons. (The presence of &lt;tt&gt;BARYCENTER_EPS&lt;/tt&gt; was the initial reason behind the creation of this ticket.)&lt;/li&gt;
	&lt;li&gt;We should add unit tests covering cases of polygons with holes, as you mentioned above.&lt;/li&gt;
	&lt;li&gt;Increase coverage to 100% on new code.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Thanks for your work on this!&lt;/p&gt;</comment>
                            <comment id="17012437" author="balsingh" created="Fri, 10 Jan 2020 04:05:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mattjuntunen&quot; class=&quot;user-hover&quot; rel=&quot;mattjuntunen&quot;&gt;mattjuntunen&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;I don&apos;t have any (peer-reviewed) references. I&apos;m going by the answer &lt;a href=&quot;https://stackoverflow.com/a/38201499&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, combined with my knowledge and the empirical results.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;ConvexArea2S.getBarycenter()&lt;/tt&gt; is effectively no different than before. So, I think it is the expected value in &lt;tt&gt;testFromBounds_triangle_small&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;I have no issue renaming it to &lt;tt&gt;getWeightedBarycenterVector&lt;/tt&gt;. It is package-private anyways.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;RegionBSPTree2S&lt;/tt&gt; already handles the &lt;tt&gt;Vector3D.Zero&lt;/tt&gt; case. For &lt;tt&gt;ConvexArea2S&lt;/tt&gt;, I don&apos;t expect sum to be &lt;tt&gt;Vector3D.Zero&lt;/tt&gt; unless the boundaries are invalid. But that&apos;s my guess, I don&apos;t know the code that well.&lt;/li&gt;
	&lt;li&gt;Perhaps you can take the lead on the unit tests for polygon with holes, removing &lt;tt&gt;BARYCENTER_EPS&lt;/tt&gt;, and increasing coverage, etc.? I&apos;m new to this API, so you can probably get that done faster.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17013155" author="balsingh" created="Fri, 10 Jan 2020 19:21:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mattjuntunen&quot; class=&quot;user-hover&quot; rel=&quot;mattjuntunen&quot;&gt;mattjuntunen&lt;/a&gt; &lt;br/&gt;
There is paper that has the equation centroid equation: &lt;a href=&quot;https://asmedigitalcollection.asme.org/appliedmechanics/article/42/1/239/387501/The-Inertia-Tensor-for-a-Spherical-Triangle&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://asmedigitalcollection.asme.org/appliedmechanics/article/42/1/239/387501/The-Inertia-Tensor-for-a-Spherical-Triangle&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;They actually also reference the &lt;a href=&quot;https://calhoun.nps.edu/handle/10945/29748&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the paper&lt;/a&gt; you mentioned.&lt;/p&gt;</comment>
                            <comment id="17013492" author="mattjuntunen" created="Sat, 11 Jan 2020 13:39:24 +0000"  >&lt;p&gt;Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=balsingh&quot; class=&quot;user-hover&quot; rel=&quot;balsingh&quot;&gt;balsingh&lt;/a&gt;. That paper looks familiar. I may have come across it at some point and then forgot about it&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erans&quot; class=&quot;user-hover&quot; rel=&quot;erans&quot;&gt;erans&lt;/a&gt;, what do you think of handling this in two PRs: we can merge PR 51 now since it is clearly superior to the current implementation and then I can add additional unit tests and docs after a bit more investigation.&lt;/p&gt;</comment>
                            <comment id="17013584" author="erans" created="Sat, 11 Jan 2020 21:55:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;we can merge PR 51 now&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Done in commit dd5c19b1674e067d874fe10dc83ef53101e67faf (&quot;master&quot; branch).&lt;/p&gt;</comment>
                            <comment id="17014428" author="balsingh" created="Mon, 13 Jan 2020 15:49:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mattjuntunen&quot; class=&quot;user-hover&quot; rel=&quot;mattjuntunen&quot;&gt;mattjuntunen&lt;/a&gt; FYI, I tried the the case of polygon with holes (using apache-math3). The algorithms still holds!&lt;/p&gt;</comment>
                            <comment id="17016519" author="mattjuntunen" created="Thu, 16 Jan 2020 03:40:56 +0000"  >&lt;p&gt;Good news! Thanks.&lt;/p&gt;</comment>
                            <comment id="17018601" author="mattjuntunen" created="Sat, 18 Jan 2020 14:12:15 +0000"  >&lt;p&gt;I just added a follow-up pull request: &lt;a href=&quot;https://github.com/apache/commons-geometry/pull/57&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-geometry/pull/57&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I was able to remove nearly all usages of the &lt;tt&gt;BARYCENTER_EPS&lt;/tt&gt; value in the tests, with two exceptions in &lt;tt&gt;RegionBSPTree2STest&lt;/tt&gt;: one in the computation of the barycenter of France and the other in the circle test with the very small radius (0.0001). However, I was able to lower the epsilon value from 1e-2 to 1e-5 so we have a considerably higher level of precision now.&lt;/p&gt;

&lt;p&gt;I also updated the barycenter computation in &lt;tt&gt;RegionBSPTree1S&lt;/tt&gt; to use the same weighted-barycenter approach as &lt;tt&gt;RegionBSPTree2S&lt;/tt&gt;. They both now return null when no &lt;em&gt;unique&lt;/em&gt; barycenter exists.&lt;/p&gt;

&lt;p&gt;Any objections to closing this issue after this PR is merged?&lt;/p&gt;</comment>
                            <comment id="17018747" author="balsingh" created="Sun, 19 Jan 2020 01:04:38 +0000"  >&lt;p&gt;Looks good to me!&lt;/p&gt;</comment>
                            <comment id="17018769" author="erans" created="Sun, 19 Jan 2020 02:56:02 +0000"  >&lt;p&gt;PR #57 merged in commit 9a0b874ad4ccad380e49b92ccad90bc7a634f1d9.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                            <outwardlinks description="supercedes">
                                        <issuelink>
            <issuekey id="13275809">MATH-1507</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 43 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z098t4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>