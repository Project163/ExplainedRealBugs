<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:23:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HTTPCORE-774] Race condition causing java.lang.ArithmeticException: Update causes flow control window to exceed 2147483647</title>
                <link>https://issues.apache.org/jira/browse/HTTPCORE-774</link>
                <project id="12310340" key="HTTPCORE">HttpComponents HttpCore</project>
                    <description>&lt;p&gt;I&#8217;m getting&#160;&lt;tt&gt;java.lang.ArithmeticException: Update causes flow control window to exceed 2147483647&lt;/tt&gt;&#160;intermittently when making HTTP/2 requests using HTTP Client 5.3.1 as the engine for the&#160;&lt;a href=&quot;https://github.com/ktorio/ktor/tree/3.0.3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Ktor HTTP Client 3.0.3&lt;/a&gt;.&#160; It occurs in about 10% of requests to some addresses from my desktop.&lt;/p&gt;

&lt;p&gt;I&#8217;ve found what seems to be a race condition that appears to be the root cause of the problem in &lt;tt&gt;&lt;a href=&quot;https://github.com/apache/httpcomponents-core/blob/rel/v5.2.4/httpcore5-h2/src/main/java/org/apache/hc/core5/http2/impl/nio/AbstractH2StreamMultiplexer.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;org.apache.hc.core5.http2.impl.nio.AbstractH2StreamMultiplexer&lt;/a&gt;&lt;/tt&gt;&#160;(version 5.2.4 is used by this version of HTTP Client).&lt;/p&gt;

&lt;p&gt;This is the stack trace I get:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.lang.ArithmeticException: Update causes flow control window to exceed 2147483647
     at org.apache.hc.core5.http2.impl.nio.AbstractH2StreamMultiplexer.updateWindow(AbstractH2StreamMultiplexer.java:215)
     at org.apache.hc.core5.http2.impl.nio.AbstractH2StreamMultiplexer.updateInputWindow(AbstractH2StreamMultiplexer.java:225)
     at org.apache.hc.core5.http2.impl.nio.AbstractH2StreamMultiplexer.incrementInputCapacity(AbstractH2StreamMultiplexer.java:385)
     at org.apache.hc.core5.http2.impl.nio.AbstractH2StreamMultiplexer.access$1200(AbstractH2StreamMultiplexer.java:94)
     at org.apache.hc.core5.http2.impl.nio.AbstractH2StreamMultiplexer$H2StreamChannelImpl.update(AbstractH2StreamMultiplexer.java:1448)
     at io.ktor.client.engine.apache5.ApacheResponseConsumer.updateCapacity(ApacheResponseConsumer.kt:131)
     at io.ktor.client.engine.apache5.BasicResponseConsumer.updateCapacity(ApacheResponseConsumer.kt:54)
     at org.apache.hc.client5.http.impl.async.HttpAsyncMainClientExec$1.updateCapacity(HttpAsyncMainClientExec.java:233)
     at org.apache.hc.core5.http2.impl.nio.ClientH2StreamHandler.updateInputCapacity(ClientH2StreamHandler.java:226)
     at org.apache.hc.core5.http2.impl.nio.AbstractH2StreamMultiplexer$H2Stream.produceInputCapacityUpdate(AbstractH2StreamMultiplexer.java:1662)
     at org.apache.hc.core5.http2.impl.nio.AbstractH2StreamMultiplexer.consumeDataFrame(AbstractH2StreamMultiplexer.java:1030)
     at org.apache.hc.core5.http2.impl.nio.AbstractH2StreamMultiplexer.consumeFrame(AbstractH2StreamMultiplexer.java:735)
     at org.apache.hc.core5.http2.impl.nio.AbstractH2StreamMultiplexer.onInput(AbstractH2StreamMultiplexer.java:446)
     at org.apache.hc.core5.http2.impl.nio.AbstractH2IOEventHandler.inputReady(AbstractH2IOEventHandler.java:65)
     at org.apache.hc.core5.http2.impl.nio.ClientH2IOEventHandler.inputReady(ClientH2IOEventHandler.java:39)
     at org.apache.hc.core5.reactor.ssl.SSLIOSession.decryptData(SSLIOSession.java:609)
     at org.apache.hc.core5.reactor.ssl.SSLIOSession.access$200(SSLIOSession.java:74)
     at org.apache.hc.core5.reactor.ssl.SSLIOSession$1.inputReady(SSLIOSession.java:202)
     at org.apache.hc.core5.reactor.InternalDataChannel.onIOEvent(InternalDataChannel.java:142)
     at org.apache.hc.core5.reactor.InternalChannel.handleIOEvent(InternalChannel.java:51)
     ... 5 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The problem is in the&#160;&lt;tt&gt;&lt;a href=&quot;https://github.com/apache/httpcomponents-core/blob/rel/v5.2.4/httpcore5-h2/src/main/java/org/apache/hc/core5/http2/impl/nio/AbstractH2StreamMultiplexer.java#L202&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;updateWindow&lt;/a&gt;&lt;/tt&gt;&#160;method, which attempts to adjust the flow control window by a delta computed previously.&#160; The method caters for the window size changing concurrently with the computation and validation of the new size by aborting and retrying conflicted calls.&#160; However, it doesn&#8217;t cater for the consequences of out-of-order deltas.&lt;/p&gt;

&lt;p&gt;On connect, the size of&#160;&lt;tt&gt;connInputWindow&lt;/tt&gt;&#160;is increased by the&#160;&lt;tt&gt;&lt;a href=&quot;https://github.com/apache/httpcomponents-core/blob/rel/v5.2.4/httpcore5-h2/src/main/java/org/apache/hc/core5/http2/impl/nio/AbstractH2StreamMultiplexer.java#L1049&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;maximizeConnWindow&lt;/a&gt;&lt;/tt&gt;&#160;method to&#160;&lt;tt&gt;Integer.MAX_VALUE&lt;/tt&gt;, the largest permitted size.&#160; As data is consumed and received, the&#160;&lt;tt&gt;&lt;a href=&quot;https://github.com/apache/httpcomponents-core/blob/rel/v5.2.4/httpcore5-h2/src/main/java/org/apache/hc/core5/http2/impl/nio/AbstractH2StreamMultiplexer.java#L202&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;updateWindow&lt;/a&gt;&lt;/tt&gt; method is called with positive and negative deltas to reflect the changes in available capacity.&#160; However, the order in which these updates are applied is not guaranteed.&#160; If a negative delta due to the receipt of data is applied after the positive delta due to some of that data being consumed, the window size will be increased beyond &lt;tt&gt;Integer.MAX_VALUE,&lt;/tt&gt; and&#160;&lt;tt&gt;ArithmeticException&lt;/tt&gt;&#160;will be thrown.&lt;/p&gt;

&lt;p&gt;It would be possible to mitigate this somewhat (perhaps entirely) if&#160;&lt;tt&gt;&lt;a href=&quot;https://github.com/apache/httpcomponents-core/blob/rel/v5.2.4/httpcore5-h2/src/main/java/org/apache/hc/core5/http2/impl/nio/AbstractH2StreamMultiplexer.java#L1049&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;maximizeConnWindow&lt;/a&gt;&lt;/tt&gt;&#160;&#160;could be configured to use a maximum size somewhat less than&#160;&lt;tt&gt;Integer.MAX_VALUE&lt;/tt&gt;, but I&#8217;m not familiar enough with HTTP/2 to know if this would have wider consequences.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13602872">HTTPCORE-774</key>
            <summary>Race condition causing java.lang.ArithmeticException: Update causes flow control window to exceed 2147483647</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="markslater">Mark Slater</reporter>
                        <labels>
                    </labels>
                <created>Fri, 20 Dec 2024 16:51:44 +0000</created>
                <updated>Sat, 4 Jan 2025 08:37:15 +0000</updated>
                            <resolved>Sat, 4 Jan 2025 08:37:15 +0000</resolved>
                                    <version>5.3.1</version>
                                    <fixVersion>5.3.2</fixVersion>
                    <fixVersion>5.4-alpha1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="6600">1h 50m</timespent>
                                <comments>
                            <comment id="17907495" author="abernal" created="Fri, 20 Dec 2024 21:20:56 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markslater&quot; class=&quot;user-hover&quot; rel=&quot;markslater&quot;&gt;markslater&lt;/a&gt; &#231;,&lt;/p&gt;

&lt;p&gt;I&#8217;ve submitted a PR addressing the issue by capping the window size in &lt;tt&gt;updateWindow&lt;/tt&gt; to prevent overflow. The fix also refines &lt;tt&gt;maximizeConnWindow&lt;/tt&gt; and includes tests validating the changes against edge cases. Please review and let me know if this resolves the problem.&lt;/p&gt;

&lt;p&gt;Best,&lt;/p&gt;

&lt;p&gt;Arturo&lt;/p&gt;</comment>
                            <comment id="17907534" author="olegk" created="Sat, 21 Dec 2024 04:55:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markslater&quot; class=&quot;user-hover&quot; rel=&quot;markslater&quot;&gt;markslater&lt;/a&gt; Please reproduce the issue with the following log categories set to DEBUG and attach the log to this ticket&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&amp;lt;Logger name=&quot;org.apache.hc.client5.http2.frame&quot; level=&quot;debug&quot;/&amp;gt;
&amp;lt;Logger name=&quot;org.apache.hc.client5.http2.flow&quot; level=&quot;debug&quot;/&amp;gt;
&amp;lt;Logger name=&quot;org.apache.hc.client5.http.impl&quot; level=&quot;debug&quot;/&amp;gt;
&amp;lt;Logger name=&quot;org.apache.hc.client5.http.headers&quot; level=&quot;debug&quot;/&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Oleg &lt;/p&gt;</comment>
                            <comment id="17908456" author="JIRAUSER303564" created="Fri, 27 Dec 2024 11:47:12 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;With DEBUG logging turned on for either &lt;tt&gt;org.apache.hc.client5.http2.frame&lt;/tt&gt; or &lt;tt&gt;org.apache.hc.client5.http2.flow&lt;/tt&gt;, I&#8217;m unable to reproduce the issue. &#160;I suspect this is because producing the Strings for the log messages is slowing something down; I can&#8217;t reproduce it even with debug logs being sent to a no-op appender:&#160; &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;lt;appender name=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt; class=&lt;span class=&quot;code-quote&quot;&gt;&quot;ch.qos.logback.core.helpers.NOPAppender&quot;&lt;/span&gt; /&amp;gt;
&#160;
&amp;lt;Logger name=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.hc.client5.http2.frame&quot;&lt;/span&gt; level=&lt;span class=&quot;code-quote&quot;&gt;&quot;debug&quot;&lt;/span&gt; addivity=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;&amp;gt;
  &#160; &amp;lt;appender-ref ref=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt;/&amp;gt;
&amp;lt;/Logger&amp;gt;&#160;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I can, however, reproduce it with DEBUG logging turned on for the other two loggers your requested &#8211; see &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13073708/13073708_apache-client.log&quot; title=&quot;apache-client.log attached to HTTPCORE-774&quot;&gt;attached (slightly redacted) file&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;. &#160;Let me know if there&#8217;s some more specific DEBUG logging I can switch on.&lt;/p&gt;

&lt;p&gt;I&#8217;m slightly confused by the references to HTTP/1.1 in the logs. &#160;The responses I get claim to be HTTP/2, and this seems to be backed up by the stack trace.&lt;/p&gt;</comment>
                            <comment id="17908467" author="olegk" created="Fri, 27 Dec 2024 12:35:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markslater&quot; class=&quot;user-hover&quot; rel=&quot;markslater&quot;&gt;markslater&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;First off, let me just say I am bit doubtful this kind of issue could have gone undetected for about a decade.&lt;/p&gt;

&lt;p&gt;Disregard HTTP/1.1 version in the logs. It is merely a hint that the request producer wants HTTP/1.1 compatible  transport. The actual HTTP transport negotiated is clearly HTTP/2. &lt;/p&gt;

&lt;p&gt;There is not much I can do without frame / flow logs. It might be a race, though I doubt it but it, but also might be Jetty sends garbage in the connection window update. I need to see the frames to be able to say for certain.&lt;/p&gt;

&lt;p&gt;You can try to reproduce the issue with the flow (and ideally frame logs) or create a test app that I could run locally to reproduce the issue (using Docker based server image). Otherwise I will have no choice but to close this issue as CANT_REPRODUCE.&lt;/p&gt;

&lt;p&gt;Oleg   &lt;/p&gt;
</comment>
                            <comment id="17908479" author="JIRAUSER303564" created="Fri, 27 Dec 2024 13:44:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt; I agree that it&apos;s surprising.&#160; I will try to make a standalone reproducer for you.&lt;/p&gt;</comment>
                            <comment id="17909129" author="olegk" created="Wed, 1 Jan 2025 12:40:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markslater&quot; class=&quot;user-hover&quot; rel=&quot;markslater&quot;&gt;markslater&lt;/a&gt; I added Jetty 12 compatibility tests to the core project &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; and so far I was unable to produce any H2 protocol related issues.&lt;/p&gt;

&lt;p&gt;Do feel free to use this test suite as a starting point for building a reproducer for the issue you have been having. Without one, I will not be able to do much.&lt;/p&gt;

&lt;p&gt;Oleg &lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/httpcomponents-core/blob/master/httpcore5-testing/src/test/java/org/apache/hc/core5/testing/compatibility/JettyCompatIT.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-core/blob/master/httpcore5-testing/src/test/java/org/apache/hc/core5/testing/compatibility/JettyCompatIT.java&lt;/a&gt;&lt;/p&gt;
</comment>
                            <comment id="17909419" author="JIRAUSER303564" created="Thu, 2 Jan 2025 20:30:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;, I&#8217;m still working on reproducing this with full debug logging, or in a form you can use to reproduce it locally. In the interim, please &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13073757/13073757_apache-client-flow-control.log&quot; title=&quot;apache-client-flow-control.log attached to HTTPCORE-774&quot;&gt;find attached&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; &lt;tt&gt;org.apache.hc.client5.http2.flow&lt;/tt&gt; debug logging from my machine when I encounter the problem.&lt;/p&gt;

&lt;p&gt;Something a bit mysterious in the log is that immediately prior to the exception, the flow control window has been reduced to 2147467263 &lt;span class=&quot;error&quot;&gt;&amp;#91;=Integer.MAX_VALUE-(8192 * 2)&amp;#93;&lt;/span&gt;, after which 8192 bytes of response data are read, which I guess leads to the flow control window growing by 8192 bytes, and possibly failing before it logs, but that&#8217;s still 8192 bytes short of the maximum value.&lt;/p&gt;

&lt;p&gt;I don&#8217;t think it&#8217;s a Jetty issue. It&#8217;s not visible to the client, but the server is fronted by &lt;a href=&quot;https://aws.amazon.com/elasticloadbalancing/application-load-balancer/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;AWS Application Load Balancer&lt;/a&gt;, which is terminating the HTTP/2 connections and forwarding requests over HTTP/1.1 to Jetty. I think the possible sources of the problem are ALB, Ktor, or Apache HTTP Client. Given all three of those are very widely used, none seem very likely, but it seems it must be one of them.&lt;/p&gt;

&lt;p&gt;Mark&lt;/p&gt;</comment>
                            <comment id="17909526" author="jira-bot" created="Fri, 3 Jan 2025 09:42:42 +0000"  >&lt;p&gt;Commit f8ca4a15ceaaeb344af55f13c33629cf249fd2cf in httpcomponents-core&apos;s branch refs/heads/&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-774&quot; title=&quot;Race condition causing java.lang.ArithmeticException: Update causes flow control window to exceed 2147483647&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-774&quot;&gt;&lt;del&gt;HTTPCORE-774&lt;/del&gt;&lt;/a&gt; from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=f8ca4a15c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=f8ca4a15c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-774&quot; title=&quot;Race condition causing java.lang.ArithmeticException: Update causes flow control window to exceed 2147483647&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-774&quot;&gt;&lt;del&gt;HTTPCORE-774&lt;/del&gt;&lt;/a&gt;: fixed a race condition caused by concurrent update of the connection input window to the max value.&lt;/p&gt;</comment>
                            <comment id="17909527" author="jira-bot" created="Fri, 3 Jan 2025 09:42:42 +0000"  >&lt;p&gt;Commit 8e168c8f7a1ef637e87a5a5c3c47c623b3303139 in httpcomponents-core&apos;s branch refs/heads/&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-774&quot; title=&quot;Race condition causing java.lang.ArithmeticException: Update causes flow control window to exceed 2147483647&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-774&quot;&gt;&lt;del&gt;HTTPCORE-774&lt;/del&gt;&lt;/a&gt; from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=8e168c8f7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=8e168c8f7&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-774&quot; title=&quot;Race condition causing java.lang.ArithmeticException: Update causes flow control window to exceed 2147483647&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-774&quot;&gt;&lt;del&gt;HTTPCORE-774&lt;/del&gt;&lt;/a&gt;: update window management improvements&lt;/p&gt;</comment>
                            <comment id="17909533" author="olegk" created="Fri, 3 Jan 2025 09:53:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markslater&quot; class=&quot;user-hover&quot; rel=&quot;markslater&quot;&gt;markslater&lt;/a&gt; I can confirm this is indeed a race condition in HttpClient (HttpCcore H2 transport).&lt;/p&gt;

&lt;p&gt;This one liner alone should fix the defect:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/httpcomponents-core/commit/f8ca4a15ceaaeb344af55f13c33629cf249fd2cf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-core/commit/f8ca4a15ceaaeb344af55f13c33629cf249fd2cf&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I also refactored the connection update window code in order to make it more resilient to potential concurrency issues.&lt;/p&gt;

&lt;p&gt;Please review and do try to test locally the proposed fix:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/httpcomponents-core/pull/511&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-core/pull/511&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17909583" author="JIRAUSER303564" created="Fri, 3 Jan 2025 12:48:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt; I can confirm I&apos;m unable to reproduce the problem on &lt;a href=&quot;https://github.com/apache/httpcomponents-core/blob/8e168c8f7a1ef637e87a5a5c3c47c623b3303139&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the current head of HTTPCORE-774&lt;/a&gt;, so the fix looks good to me.&lt;/p&gt;

&lt;p&gt;Thanks very much for spending the time to dig into it - I really appreciate it!&lt;/p&gt;

&lt;p&gt;Mark&lt;/p&gt;</comment>
                            <comment id="17909722" author="jira-bot" created="Sat, 4 Jan 2025 08:30:09 +0000"  >&lt;p&gt;Commit d31d0000084d1ffdd37a9596b53e2aa7779451bc in httpcomponents-core&apos;s branch refs/heads/5.3.x from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=d31d00000&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=d31d00000&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-774&quot; title=&quot;Race condition causing java.lang.ArithmeticException: Update causes flow control window to exceed 2147483647&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-774&quot;&gt;&lt;del&gt;HTTPCORE-774&lt;/del&gt;&lt;/a&gt;: fixed a race condition caused by concurrent update of the connection input window to the max value.&lt;/p&gt;</comment>
                            <comment id="17909723" author="jira-bot" created="Sat, 4 Jan 2025 08:30:09 +0000"  >&lt;p&gt;Commit 2a83df38b579b12d1017c40e07c6480e4da9b42d in httpcomponents-core&apos;s branch refs/heads/5.3.x from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=2a83df38b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=2a83df38b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-774&quot; title=&quot;Race condition causing java.lang.ArithmeticException: Update causes flow control window to exceed 2147483647&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-774&quot;&gt;&lt;del&gt;HTTPCORE-774&lt;/del&gt;&lt;/a&gt;: update window management improvements&lt;/p&gt;</comment>
                            <comment id="17909724" author="jira-bot" created="Sat, 4 Jan 2025 08:35:14 +0000"  >&lt;p&gt;Commit 2cb5fb73faf85cbc4efa380d8ee9c442b94831f3 in httpcomponents-core&apos;s branch refs/heads/master from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=2cb5fb73f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=2cb5fb73f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-774&quot; title=&quot;Race condition causing java.lang.ArithmeticException: Update causes flow control window to exceed 2147483647&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-774&quot;&gt;&lt;del&gt;HTTPCORE-774&lt;/del&gt;&lt;/a&gt;: update window management improvements&lt;/p&gt;</comment>
                            <comment id="17909725" author="olegk" created="Sat, 4 Jan 2025 08:37:15 +0000"  >&lt;p&gt;Fixed in 5.3.x and master.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13073757" name="apache-client-flow-control.log" size="20047" author="markslater" created="Thu, 2 Jan 2025 20:23:56 +0000"/>
                            <attachment id="13073708" name="apache-client.log" size="20567" author="markslater" created="Fri, 27 Dec 2024 11:41:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            44 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1t95c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>