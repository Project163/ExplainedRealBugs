diff --git a/httpcore5-h2/src/main/java/org/apache/hc/core5/http2/impl/nio/ClientHttpProtocolNegotiationStarter.java b/httpcore5-h2/src/main/java/org/apache/hc/core5/http2/impl/nio/ClientHttpProtocolNegotiationStarter.java
index 68f06d2b8..4ba1562c4 100644
--- a/httpcore5-h2/src/main/java/org/apache/hc/core5/http2/impl/nio/ClientHttpProtocolNegotiationStarter.java
+++ b/httpcore5-h2/src/main/java/org/apache/hc/core5/http2/impl/nio/ClientHttpProtocolNegotiationStarter.java
@@ -82,12 +82,12 @@ public HttpConnectionEventHandler createHandler(final ProtocolIOSession ioSessio
         HttpVersionPolicy endpointPolicy = versionPolicy;
         if (attachment instanceof EndpointParameters) {
             final EndpointParameters params = (EndpointParameters) attachment;
-            if (tlsStrategy != null && URIScheme.HTTPS.same(params.getScheme())) {
-                tlsStrategy.upgrade(ioSession, params, params.getAttachment(), handshakeTimeout, null);
-            }
             if (params.getAttachment() instanceof HttpVersionPolicy) {
                 endpointPolicy = (HttpVersionPolicy) params.getAttachment();
             }
+            if (tlsStrategy != null && URIScheme.HTTPS.same(params.getScheme())) {
+                tlsStrategy.upgrade(ioSession, params, endpointPolicy, handshakeTimeout, null);
+            }
         }
 
         ioSession.registerProtocol(ApplicationProtocol.HTTP_1_1.id, new ClientHttp1UpgradeHandler(http1StreamHandlerFactory));
diff --git a/httpcore5-h2/src/main/java/org/apache/hc/core5/http2/impl/nio/ServerHttpProtocolNegotiationStarter.java b/httpcore5-h2/src/main/java/org/apache/hc/core5/http2/impl/nio/ServerHttpProtocolNegotiationStarter.java
index 1a29166d0..3156dfa5b 100644
--- a/httpcore5-h2/src/main/java/org/apache/hc/core5/http2/impl/nio/ServerHttpProtocolNegotiationStarter.java
+++ b/httpcore5-h2/src/main/java/org/apache/hc/core5/http2/impl/nio/ServerHttpProtocolNegotiationStarter.java
@@ -83,13 +83,13 @@ public HttpConnectionEventHandler createHandler(final ProtocolIOSession ioSessio
         URIScheme uriScheme = URIScheme.HTTP;
         if (attachment instanceof EndpointParameters) {
             final EndpointParameters params = (EndpointParameters) attachment;
-            if (tlsStrategy != null && URIScheme.HTTPS.same(params.getScheme())) {
-                uriScheme = URIScheme.HTTPS;
-                tlsStrategy.upgrade(ioSession, params, params.getAttachment(), handshakeTimeout, null);
-            }
             if (params.getAttachment() instanceof HttpVersionPolicy) {
                 endpointPolicy = (HttpVersionPolicy) params.getAttachment();
             }
+            if (tlsStrategy != null && URIScheme.HTTPS.same(params.getScheme())) {
+                uriScheme = URIScheme.HTTPS;
+                tlsStrategy.upgrade(ioSession, params, endpointPolicy, handshakeTimeout, null);
+            }
         }
 
         ioSession.registerProtocol(ApplicationProtocol.HTTP_1_1.id,
