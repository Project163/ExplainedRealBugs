{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/11610","repository_url":"https://api.github.com/repos/pytest-dev/pytest","labels_url":"https://api.github.com/repos/pytest-dev/pytest/issues/11610/labels{/name}","comments_url":"https://api.github.com/repos/pytest-dev/pytest/issues/11610/comments","events_url":"https://api.github.com/repos/pytest-dev/pytest/issues/11610/events","html_url":"https://github.com/pytest-dev/pytest/issues/11610","id":1989841456,"node_id":"I_kwDOAjwLdc52mpIw","number":11610,"title":"Add a `set_filter()` context manager to the caplog fixture","user":{"login":"jenstroeger","id":12053937,"node_id":"MDQ6VXNlcjEyMDUzOTM3","avatar_url":"https://avatars.githubusercontent.com/u/12053937?v=4","gravatar_id":"","url":"https://api.github.com/users/jenstroeger","html_url":"https://github.com/jenstroeger","followers_url":"https://api.github.com/users/jenstroeger/followers","following_url":"https://api.github.com/users/jenstroeger/following{/other_user}","gists_url":"https://api.github.com/users/jenstroeger/gists{/gist_id}","starred_url":"https://api.github.com/users/jenstroeger/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jenstroeger/subscriptions","organizations_url":"https://api.github.com/users/jenstroeger/orgs","repos_url":"https://api.github.com/users/jenstroeger/repos","events_url":"https://api.github.com/users/jenstroeger/events{/privacy}","received_events_url":"https://api.github.com/users/jenstroeger/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2023-11-13T03:55:04Z","updated_at":"2023-11-24T12:38:35Z","closed_at":"2023-11-24T12:38:35Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\nThanks for suggesting a feature!\r\n\r\nQuick check-list while suggesting features:\r\n-->\r\n\r\n#### What's the problem this feature will solve?\r\n<!-- What are you trying to do, that you are unable to achieve with pytest as it currently stands? -->\r\n\r\nI need to test a custom [filter](https://docs.python.org/3/library/logging.html#filter-objects) for logging, and currently I use one of the following two approaches:\r\n```python\r\ndef test_filter(caplog: pytest.LogCaptureFixture) -> None:\r\n    caplog.set_level(logging.INFO)\r\n\r\n    logger = logging.getLogger(__name__)  # This test module's logger.\r\n    filter_ = SchnufteCustomFilter()\r\n    logger.addFilter(filter_)\r\n\r\n    # Run tests.\r\n    assert len(caplog.record_tuples) == 1\r\n    assert caplog.record_tuples[0] == (\"test_custom_filter\", 20, \"Schnufte!\")\r\n\r\n    logger.removeFilter(filter_)\r\n```\r\nor\r\n```python\r\ndef test_filter(caplog: pytest.LogCaptureFixture) -> None:\r\n    caplog.set_level(logging.INFO)\r\n\r\n    filter_ = SchnufteCustomFilter()\r\n    caplog.handler.addFilter(filter_)\r\n\r\n    # Run tests.\r\n    assert len(caplog.record_tuples) == 1\r\n    assert caplog.record_tuples[0] == (\"test_custom_filter\", 20, \"Schnufte!\")     \r\n\r\n    caplog.handler.removeFilter(filter_)\r\n```\r\n#### Describe the solution you'd like\r\n<!-- A clear and concise description of what you want to happen. -->\r\n<!-- Provide examples of real-world use cases that this would enable and how it solves the problem described above. -->\r\n\r\nSimilar to the [`at_level()`](https://docs.pytest.org/en/6.2.x/reference.html?highlight=logcapturefixture#pytest.LogCaptureFixture.at_level) context manager I think it would be useful to wrap the second of the above filter setups into a custom context manager, that I can then call like so:\r\n```python\r\ndef test_filter(caplog: pytest.LogCaptureFixture) -> None:\r\n    caplog.set_level(logging.INFO)\r\n\r\n    filter_ = SchnufteCustomFilter()\r\n    with caplog.set_filter(filter_):  # use_filter() or with_filter() or ...\r\n        # Run tests.\r\n        assert len(caplog.record_tuples) == 1\r\n        assert caplog.record_tuples[0] == (\"test_custom_filter\", 20, \"Schnufte!\")     \r\n```\r\n\r\n#### Alternative Solutions\r\n<!-- Have you tried to workaround the problem using a pytest plugin or other tools? Or a different approach to solving this issue? Please elaborate here. -->\r\n\r\nSee above’s examples, I guess.\r\n\r\n#### Additional context\r\n<!-- Add any other context, links, etc. about the feature here. -->\r\n\r\nI’m happy to give a PR a shot: I suppose the change would be adding a method to the [LogCaptureFixture](https://github.com/pytest-dev/pytest/blob/99f77388107fcee4cbc665659fac61c8468b693d/src/_pytest/logging.py#L391), for example:\r\n```python\r\n@final\r\nclass LogCaptureFixture:\r\n\r\n    @contextmanager\r\n    def set_filter(filter_: logging.Filter) -> Generator[None, None, None]:  # Type needs to be aligned with _FilterType from stdlib/typeshed.\r\n        self.handler.addFilter(filter_)\r\n        try:\r\n            yield\r\n        finally:\r\n            self.handler.removeFilter(filter_)\r\n```","closed_by":{"login":"nicoddemus","id":1085180,"node_id":"MDQ6VXNlcjEwODUxODA=","avatar_url":"https://avatars.githubusercontent.com/u/1085180?v=4","gravatar_id":"","url":"https://api.github.com/users/nicoddemus","html_url":"https://github.com/nicoddemus","followers_url":"https://api.github.com/users/nicoddemus/followers","following_url":"https://api.github.com/users/nicoddemus/following{/other_user}","gists_url":"https://api.github.com/users/nicoddemus/gists{/gist_id}","starred_url":"https://api.github.com/users/nicoddemus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicoddemus/subscriptions","organizations_url":"https://api.github.com/users/nicoddemus/orgs","repos_url":"https://api.github.com/users/nicoddemus/repos","events_url":"https://api.github.com/users/nicoddemus/events{/privacy}","received_events_url":"https://api.github.com/users/nicoddemus/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/11610/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pytest-dev/pytest/issues/11610/timeline","performed_via_github_app":null,"state_reason":"completed"}