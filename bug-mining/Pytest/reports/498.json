{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/13312","repository_url":"https://api.github.com/repos/pytest-dev/pytest","labels_url":"https://api.github.com/repos/pytest-dev/pytest/issues/13312/labels{/name}","comments_url":"https://api.github.com/repos/pytest-dev/pytest/issues/13312/comments","events_url":"https://api.github.com/repos/pytest-dev/pytest/issues/13312/events","html_url":"https://github.com/pytest-dev/pytest/issues/13312","id":2932900078,"node_id":"I_kwDOAjwLdc6u0IDu","number":13312,"title":"[regression][8.2.2] `KeyError` sometimes crashes test collection on PyPy while reordering fixtures","user":{"login":"webknjaz","id":578543,"node_id":"MDQ6VXNlcjU3ODU0Mw==","avatar_url":"https://avatars.githubusercontent.com/u/578543?v=4","gravatar_id":"","url":"https://api.github.com/users/webknjaz","html_url":"https://github.com/webknjaz","followers_url":"https://api.github.com/users/webknjaz/followers","following_url":"https://api.github.com/users/webknjaz/following{/other_user}","gists_url":"https://api.github.com/users/webknjaz/gists{/gist_id}","starred_url":"https://api.github.com/users/webknjaz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/webknjaz/subscriptions","organizations_url":"https://api.github.com/users/webknjaz/orgs","repos_url":"https://api.github.com/users/webknjaz/repos","events_url":"https://api.github.com/users/webknjaz/events{/privacy}","received_events_url":"https://api.github.com/users/webknjaz/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":224849193,"node_id":"MDU6TGFiZWwyMjQ4NDkxOTM=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/type:%20bug","name":"type: bug","color":"fc2929","default":false,"description":"problem that needs to be addressed"},{"id":240496914,"node_id":"MDU6TGFiZWwyNDA0OTY5MTQ=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/topic:%20parametrize","name":"topic: parametrize","color":"fbca04","default":false,"description":"related to @pytest.mark.parametrize"},{"id":240511492,"node_id":"MDU6TGFiZWwyNDA1MTE0OTI=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/topic:%20collection","name":"topic: collection","color":"006b75","default":false,"description":"related to the collection phase"},{"id":240511787,"node_id":"MDU6TGFiZWwyNDA1MTE3ODc=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/topic:%20selection","name":"topic: selection","color":"c2e0c6","default":false,"description":"related to test selection from the command line"},{"id":315571544,"node_id":"MDU6TGFiZWwzMTU1NzE1NDQ=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/type:%20regression","name":"type: regression","color":"f7c6c7","default":false,"description":"indicates a problem that was introduced in a release which was working previously"},{"id":604021555,"node_id":"MDU6TGFiZWw2MDQwMjE1NTU=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/topic:%20fixtures","name":"topic: fixtures","color":"5319e7","default":false,"description":"anything involving fixtures directly or indirectly"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":18,"created_at":"2025-03-19T19:21:20Z","updated_at":"2025-05-28T08:25:39Z","closed_at":"2025-05-28T08:25:39Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"So @bdraco was adding new tests in https://github.com/aio-libs/multidict/pull/1072. And it worked at first. But they had readability problems, and I added a few refactoring commits on top. And that's when things went south.\n\nThe first version of the tests made use of `@pytest.mark.parametrize` which I later converted into a parametrized fixture. That specific fixture depends on `request: pytest.FixtureRequest`, but doesn't depend on anything else we have declared in `conftest.py`.\n\nThe params set uses a trick that @The-Compiler has shown in his EuroPython 2023 workshop â€” wrapping them in dataclasses featuring `__str__()` interface. Not sure if that's relevant, though.\n\n\nSo the traceback I'm talking about is only happening on PyPy and looks like this:\n```console\nRun python -Im pytest tests -v --cov-report xml --junitxml=.test-results/pytest/test.xml --no-c-extensions\n============================= test session starts ==============================\nplatform linux -- Python 3.9.19[pypy-7.3.16-final], pytest-8.3.5, pluggy-1.5.0 -- /opt/hostedtoolcache/PyPy/3.9.19/x64/bin/python\ncodspeed: 3.2.0 (disabled, mode: walltime, timer_resolution: 1.0ns)\ncachedir: .pytest_cache\nrootdir: /home/runner/work/multidict/multidict\nconfigfile: pytest.ini\nplugins: cov-6.0.0, codspeed-3.2.0\ncollecting ... collected 1161 items\nINTERNALERROR> Traceback (most recent call last):\nINTERNALERROR>   File \"/opt/hostedtoolcache/PyPy/3.9.19/x64/lib/pypy3.9/site-packages/_pytest/main.py\", line 283, in wrap_session\nINTERNALERROR>     session.exitstatus = doit(config, session) or 0\nINTERNALERROR>   File \"/opt/hostedtoolcache/PyPy/3.9.19/x64/lib/pypy3.9/site-packages/_pytest/main.py\", line 336, in _main\nINTERNALERROR>     config.hook.pytest_collection(session=session)\nINTERNALERROR>   File \"/opt/hostedtoolcache/PyPy/3.9.19/x64/lib/pypy3.9/site-packages/pluggy/_hooks.py\", line 513, in __call__\nINTERNALERROR>     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\nINTERNALERROR>   File \"/opt/hostedtoolcache/PyPy/3.9.19/x64/lib/pypy3.9/site-packages/pluggy/_manager.py\", line 120, in _hookexec\nINTERNALERROR>     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\nINTERNALERROR>   File \"/opt/hostedtoolcache/PyPy/3.9.19/x64/lib/pypy3.9/site-packages/pluggy/_callers.py\", line 139, in _multicall\nINTERNALERROR>     raise exception.with_traceback(exception.__traceback__)\nINTERNALERROR>   File \"/opt/hostedtoolcache/PyPy/3.9.19/x64/lib/pypy3.9/site-packages/pluggy/_callers.py\", line 122, in _multicall\nINTERNALERROR>     teardown.throw(exception)  # type: ignore[union-attr]\nINTERNALERROR>   File \"/opt/hostedtoolcache/PyPy/3.9.19/x64/lib/pypy3.9/site-packages/_pytest/logging.py\", line 790, in pytest_collection\nINTERNALERROR>     return (yield)\nINTERNALERROR>   File \"/opt/hostedtoolcache/PyPy/3.9.19/x64/lib/pypy3.9/site-packages/pluggy/_callers.py\", line 122, in _multicall\nINTERNALERROR>     teardown.throw(exception)  # type: ignore[union-attr]\nINTERNALERROR>   File \"/opt/hostedtoolcache/PyPy/3.9.19/x64/lib/pypy3.9/site-packages/_pytest/warnings.py\", line 121, in pytest_collection\nINTERNALERROR>     return (yield)\nINTERNALERROR>   File \"/opt/hostedtoolcache/PyPy/3.9.19/x64/lib/pypy3.9/site-packages/pluggy/_callers.py\", line 122, in _multicall\nINTERNALERROR>     teardown.throw(exception)  # type: ignore[union-attr]\nINTERNALERROR>   File \"/opt/hostedtoolcache/PyPy/3.9.19/x64/lib/pypy3.9/site-packages/_pytest/config/__init__.py\", line 1417, in pytest_collection\nINTERNALERROR>     return (yield)\nINTERNALERROR>   File \"/opt/hostedtoolcache/PyPy/3.9.19/x64/lib/pypy3.9/site-packages/pluggy/_callers.py\", line 103, in _multicall\nINTERNALERROR>     res = hook_impl.function(*args)\nINTERNALERROR>   File \"/opt/hostedtoolcache/PyPy/3.9.19/x64/lib/pypy3.9/site-packages/_pytest/main.py\", line 347, in pytest_collection\nINTERNALERROR>     session.perform_collect()\nINTERNALERROR>   File \"/opt/hostedtoolcache/PyPy/3.9.19/x64/lib/pypy3.9/site-packages/_pytest/main.py\", line 812, in perform_collect\nINTERNALERROR>     hook.pytest_collection_modifyitems(\nINTERNALERROR>   File \"/opt/hostedtoolcache/PyPy/3.9.19/x64/lib/pypy3.9/site-packages/pluggy/_hooks.py\", line 513, in __call__\nINTERNALERROR>     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\nINTERNALERROR>   File \"/opt/hostedtoolcache/PyPy/3.9.19/x64/lib/pypy3.9/site-packages/pluggy/_manager.py\", line 120, in _hookexec\nINTERNALERROR>     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\nINTERNALERROR>   File \"/opt/hostedtoolcache/PyPy/3.9.19/x64/lib/pypy3.9/site-packages/pluggy/_callers.py\", line 139, in _multicall\nINTERNALERROR>     raise exception.with_traceback(exception.__traceback__)\nINTERNALERROR>   File \"/opt/hostedtoolcache/PyPy/3.9.19/x64/lib/pypy3.9/site-packages/pluggy/_callers.py\", line 122, in _multicall\nINTERNALERROR>     teardown.throw(exception)  # type: ignore[union-attr]\nINTERNALERROR>   File \"/opt/hostedtoolcache/PyPy/3.9.19/x64/lib/pypy3.9/site-packages/_pytest/cacheprovider.py\", line 443, in pytest_collection_modifyitems\nINTERNALERROR>     res = yield\nINTERNALERROR>   File \"/opt/hostedtoolcache/PyPy/3.9.19/x64/lib/pypy3.9/site-packages/pluggy/_callers.py\", line 122, in _multicall\nINTERNALERROR>     teardown.throw(exception)  # type: ignore[union-attr]\nINTERNALERROR>   File \"/opt/hostedtoolcache/PyPy/3.9.19/x64/lib/pypy3.9/site-packages/_pytest/cacheprovider.py\", line 373, in pytest_collection_modifyitems\nINTERNALERROR>     res = yield\nINTERNALERROR>   File \"/opt/hostedtoolcache/PyPy/3.9.19/x64/lib/pypy3.9/site-packages/pluggy/_callers.py\", line 103, in _multicall\nINTERNALERROR>     res = hook_impl.function(*args)\nINTERNALERROR>   File \"/opt/hostedtoolcache/PyPy/3.9.19/x64/lib/pypy3.9/site-packages/_pytest/fixtures.py\", line 1627, in pytest_collection_modifyitems\nINTERNALERROR>     items[:] = reorder_items(items)\nINTERNALERROR>   File \"/opt/hostedtoolcache/PyPy/3.9.19/x64/lib/pypy3.9/site-packages/_pytest/fixtures.py\", line 233, in reorder_items\nINTERNALERROR>     reorder_items_atscope(\nINTERNALERROR>   File \"/opt/hostedtoolcache/PyPy/3.9.19/x64/lib/pypy3.9/site-packages/_pytest/fixtures.py\", line 282, in reorder_items_atscope\nINTERNALERROR>     other_scoped_items_by_argkey[argkey].move_to_end(\nINTERNALERROR> KeyError: <Function test_setdefault[case-insensitive-pure-python-module]>\n\n============================ no tests ran in 5.81s =============================\nError: Process completed with exit code 3.\n```\n\nI was able to reproduce it locally on my Gentoo Linux laptop using pypy3.9-7.3.16. But I wasn't really able to make the repro smaller. I learned that this traceback is first seen in `pytest == 8.2.2`. And `pytest == 8.2.1` does not have this problem.\n\nSo the current STR is something like:\n1. `pyenv install pypy3.9-7.3.16`\n2. `pyenv virtualenv pypy3.9-7.3.16 multidict-pyenv-pypy3.9-7.3.16`\n3. `pyenv shell multidict-pyenv-pypy3.9-7.3.16`\n4. Get a copy of https://github.com/aio-libs/multidict/pull/1072\n5. `pip install -r requirements/pytest.txt`\n6. `pip install -e .`\n7. `SETUPTOOLS_SCM_PRETEND_VERSION_FOR_PYTEST='8.2.2.dev0+first-broken-due-to-pr12414-regression' pip install 'pytest @ https://github.com/pytest-dev/pytest/archive/214d098fcce88940f5ce9353786b3cc8f0bd3938.tar.gz'`\n8. And finally run `pytest --collect-only --no-cov tests/test_abc.py tests/test_copy.py tests/test_incorrect_args.py tests/test_multidict.py tests/test_mypy.py tests/test_pickle.py tests/test_types.py tests/test_update.py tests/test_version.py`\n\nThese aren't all the test modules of the project. Removing them from CLI args or removing some of the tests inside makes it so that it doesn't traceback anymore. That's why I wasn't able to come up with a single-snippet reproducer. It feels like it only happens when a certain amount of tests is hit or something.\n\nI also ran it with `--pdb` which allowed me to see the value of `item` at that point when `OrderedDict.move_to_end()` is called: https://github.com/pytest-dev/pytest/blame/2b40981/src/_pytest/fixtures.py#L278C29-L280C30.\nIt kinda suggests that the PyPy implementation of `OrderedDict` is weird:\n```pycon\n>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> PDB post_mortem (IO-capturing turned off) >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>\n> ~/.pyenv/versions/pypy3.9-7.3.16/envs/multidict-pyenv-pypy3.9-7.3.16/lib/pypy3.9/site-packages/_pytest/fixtures.py(236)fix_cache_order()\n-> scoped_items_by_argkey[key].move_to_end(item, last=False)\n(Pdb) pp item\n<Function test_popitem[case-insensitive-pure-python-module]>\n(Pdb) pp [(k, v) for k, v in scoped_items_by_argkey[key].items() if str(k) == '<Function test_popitem[case-insensitive-pure-python-module]>']\n[(<Function test_popitem[case-insensitive-pure-python-module]>, None),\n (<Function test_popitem[case-insensitive-pure-python-module]>, None)]\n(Pdb) pp scoped_items_by_argkey[key][item]\n*** KeyError: <Function test_popitem[case-insensitive-pure-python-module]>\n(Pdb) pp [(k, v, id(k), hash(k)) for k, v in scoped_items_by_argkey[key].items() if str(k) == '<Function test_popitem[case-insensitive-pure-python-module]>']\n[(<Function test_popitem[case-insensitive-pure-python-module]>,\n  None,\n  140541205124888,\n  -760398202047905062),\n (<Function test_popitem[case-insensitive-pure-python-module]>,\n  None,\n  140541205124888,\n  -760398202047905062)]\n(Pdb) pp id(item), hash(item)\n(140541205124888, -760398202047905062)\n```\nðŸ¤” *Why* does this dict have duplicate keys? ðŸ˜±\n\nAnyway.. I confirmed that doing `SETUPTOOLS_SCM_PRETEND_VERSION_FOR_PYTEST='8.2.2.dev0+last-working-right-before-pr12414-regression' pip install 'pytest @ https://github.com/pytest-dev/pytest/archive/b41d5a52bbb808780ab310456d71e5ce509fd402.tar.gz'` makes the problem go away (which is expected because it does not yet have the `OrderedDict.move_to_end()` call).\n\nAnd so this makes https://github.com/pytest-dev/pytest/pull/12414 (https://github.com/pytest-dev/pytest/pull/12409) responsible for the regression.\n\ncc @bluetech I hope you'll have at least some idea of where to look because I've spent enough time staring at this w/o any clue...\n\n\n---\n\nUPD: I also forgot to mention that removing our own `pytest_collection_modifyitems` in `conftest.py` does not help in any way, it still reproduces. Plus, changing the fixture scopes to match what we have in `conftest.py` has no effect either.\n\nUPD2: pypy3.11-7.3.19 shows this behavior too.","closed_by":{"login":"bluetech","id":1223550,"node_id":"MDQ6VXNlcjEyMjM1NTA=","avatar_url":"https://avatars.githubusercontent.com/u/1223550?v=4","gravatar_id":"","url":"https://api.github.com/users/bluetech","html_url":"https://github.com/bluetech","followers_url":"https://api.github.com/users/bluetech/followers","following_url":"https://api.github.com/users/bluetech/following{/other_user}","gists_url":"https://api.github.com/users/bluetech/gists{/gist_id}","starred_url":"https://api.github.com/users/bluetech/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bluetech/subscriptions","organizations_url":"https://api.github.com/users/bluetech/orgs","repos_url":"https://api.github.com/users/bluetech/repos","events_url":"https://api.github.com/users/bluetech/events{/privacy}","received_events_url":"https://api.github.com/users/bluetech/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/13312/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pytest-dev/pytest/issues/13312/timeline","performed_via_github_app":null,"state_reason":"completed"}