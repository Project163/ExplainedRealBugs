{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/10558","repository_url":"https://api.github.com/repos/pytest-dev/pytest","labels_url":"https://api.github.com/repos/pytest-dev/pytest/issues/10558/labels{/name}","comments_url":"https://api.github.com/repos/pytest-dev/pytest/issues/10558/comments","events_url":"https://api.github.com/repos/pytest-dev/pytest/issues/10558/events","html_url":"https://github.com/pytest-dev/pytest/issues/10558","id":1473713186,"node_id":"I_kwDOAjwLdc5X1xQi","number":10558,"title":"pytest.Config.getoption `default` argument not working as expected","user":{"login":"ryancausey","id":2704075,"node_id":"MDQ6VXNlcjI3MDQwNzU=","avatar_url":"https://avatars.githubusercontent.com/u/2704075?v=4","gravatar_id":"","url":"https://api.github.com/users/ryancausey","html_url":"https://github.com/ryancausey","followers_url":"https://api.github.com/users/ryancausey/followers","following_url":"https://api.github.com/users/ryancausey/following{/other_user}","gists_url":"https://api.github.com/users/ryancausey/gists{/gist_id}","starred_url":"https://api.github.com/users/ryancausey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ryancausey/subscriptions","organizations_url":"https://api.github.com/users/ryancausey/orgs","repos_url":"https://api.github.com/users/ryancausey/repos","events_url":"https://api.github.com/users/ryancausey/events{/privacy}","received_events_url":"https://api.github.com/users/ryancausey/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":224849193,"node_id":"MDU6TGFiZWwyMjQ4NDkxOTM=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/type:%20bug","name":"type: bug","color":"fc2929","default":false,"description":"problem that needs to be addressed"},{"id":705853693,"node_id":"MDU6TGFiZWw3MDU4NTM2OTM=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/topic:%20config","name":"topic: config","color":"006b75","default":false,"description":"related to config handling, argument parsing and config file"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":21,"created_at":"2022-12-03T04:11:28Z","updated_at":"2024-10-13T18:33:58Z","closed_at":"2024-10-13T18:33:57Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\nThanks for submitting an issue!\r\n\r\nQuick check-list while reporting bugs:\r\n-->\r\n\r\n- [x] a detailed description of the bug or problem you are having\r\n- [x] output of `pip list` from the virtual environment you are using\r\n- [x] pytest and operating system versions\r\n- [x] minimal example if possible\r\n\r\nI'm running into an issue where the `default` argument to `pytest.Config.getoption` is not working as expected, or at least not as it is [documented](https://docs.pytest.org/en/latest/reference/reference.html#pytest.Config.getoption).\r\n\r\n# Reproduction steps\r\n\r\n1. define the `pytest_generate_tests` hook in a `conftest.py` file.\r\n2. use the `metafunc` argument to access the `pytest.Config` object via `metafunc.config`.\r\n3. try to call `getoption` on an option that was not passed while specifying a default, E.G. `metafunc.config.getoption(name=\"foobaz\", default={})`\r\n\r\n# Exepected behavior\r\n\r\nThe empty dictionary is returned as it is set as the default.\r\n\r\n# Actual behavior\r\n\r\n`None` is returned instead.\r\n\r\n# Possible fix\r\n\r\nThe issue appears to be the check inside `getoption` on line 1541:\r\n\r\n```python\r\n(Pdb) ll\r\n1529        def getoption(self, name: str, default=notset, skip: bool = False):\r\n1530            \"\"\"Return command line option value.\r\n1531\r\n1532            :param name: Name of the option.  You may also specify\r\n1533                the literal ``--OPT`` option instead of the \"dest\" option name.\r\n1534            :param default: Default value if no option of that name exists.\r\n1535            :param skip: If True, raise pytest.skip if option does not exists\r\n1536                or has a None value.\r\n1537            \"\"\"\r\n1538            name = self._opt2dest.get(name, name)\r\n1539            try:\r\n1540                val = getattr(self.option, name)\r\n1541 ->             if val is None and skip:\r\n1542                    raise AttributeError(name)\r\n1543                return val\r\n1544            except AttributeError as e:\r\n1545                if default is not notset:\r\n1546                    return default\r\n1547                if skip:\r\n1548                    import pytest\r\n1549\r\n1550                    pytest.skip(f\"no {name!r} option found\")\r\n1551                raise ValueError(f\"no option named {name!r}\") from e\r\n(Pdb) print(val)\r\nNone\r\n(Pdb) print(skip)\r\nFalse\r\n(Pdb)\r\n```\r\n\r\nSince `skip` is not passed, it defaults to `False` which means even if a `default` is set to something other than `notset`, that default value will never be returned unless `skip` is also set to `True`. I believe the fix is to change line 1541 to:\r\n\r\n`if val is None:`\r\n\r\nThis will be a breaking change, however, as it would mean not passing `default` would lead to a `ValueError` being raised when `skip` is `False`.\r\n\r\n# Minimal reproduction example\r\n\r\n```python\r\n# conftest.py\r\ndef pytest_generate_tests(metafunc):\r\n    my_cool_option = metafunc.config.getoption(name=\"foobaz\", default={})\r\n    assert my_cool_option is not None\r\n```\r\n\r\n# Pip list\r\n\r\n<details><summary>Actually it's `poetry show`</summary>\r\n<p>\r\n\r\n```bash\r\n$ poetry show\r\nastroid               2.12.10   An abstract syntax tree for Python with inference support.\r\nattrs                 22.1.0    Classes Without Boilerplate\r\naws-xray-sdk          2.10.0    The AWS X-Ray SDK for Python (the SDK) enables Python developers to record and emit information from within their applications to the AWS X-Ray se...\r\nawscrt                0.14.0    A common runtime for AWS Python projects\r\nbackoff               2.1.2     Function decoration for backoff and retry\r\nblack                 22.8.0    The uncompromising code formatter.\r\nboto3                 1.26.6    The AWS SDK for Python\r\nbotocore              1.29.6    Low-level, data-driven core of boto 3.\r\ncertifi               2022.9.24 Python package for providing Mozilla's CA Bundle.\r\ncfgv                  3.3.1     Validate configuration and produce human readable error messages.\r\ncharset-normalizer    2.1.1     The Real First Universal Charset Detector. Open, modern and actively maintained alternative to Chardet.\r\nclick                 8.1.3     Composable command line interface toolkit\r\nclick-log             0.4.0     Logging integration for Click\r\ncloup                 1.0.2     Adds features to Click: option groups, constraints, subcommand sections and help themes.\r\ncoverage              6.4.4     Code coverage measurement for Python\r\ndill                  0.3.5.1   serialize all of python\r\ndistlib               0.3.6     Distribution utilities\r\ndodgy                 0.2.1     Dodgy: Searches for dodgy looking lines in Python code\r\nexceptiongroup        1.0.4     Backport of PEP 654 (exception groups)\r\nexecnet               1.9.0     execnet: rapid multi-Python deployment\r\nfaunadb               4.3.1     FaunaDB Python driver\r\nfilelock              3.8.0     A platform independent file lock.\r\nflake8                2.3.0     the modular source code checker: pep8, pyflakes and co\r\nflake8-polyfill       1.0.2     Polyfill package for Flake8 plugins\r\nfluctuate             1.0.1     A simple migration utility for Fauna DB.\r\nfuture                0.18.2    Clean single-source support for Python 3 and 2\r\nh2                    2.6.2     HTTP/2 State-Machine based protocol implementation\r\nhpack                 3.0.0     Pure-Python HPACK header compression\r\nhyper                 0.7.0     HTTP/2 Client for Python\r\nhyperframe            3.2.0     HTTP/2 framing layer for Python\r\nidentify              2.5.6     File identification library for Python\r\nidna                  3.4       Internationalized Domain Names in Applications (IDNA)\r\niniconfig             1.1.1     iniconfig: brain-dead simple config-ini parsing\r\niso8601               1.0.2     Simple module to parse ISO 8601 dates\r\nisort                 5.10.1    A Python utility / library to sort Python imports.\r\njmespath              1.0.1     JSON Matching Expressions\r\nlazy-object-proxy     1.7.1     A fast and thorough lazy object proxy.\r\nmccabe                0.6.1     McCabe checker, plugin for flake8\r\nmypy-extensions       0.4.3     Experimental type system extensions for programs checked with the mypy typechecker.\r\nnodeenv               1.7.0     Node.js virtual environment builder\r\npackaging             21.3      Core utilities for Python packages\r\npathspec              0.10.1    Utility library for gitignore style pattern matching of file paths.\r\npep8                  1.7.1     Python style guide checker\r\npep8-naming           0.10.0    Check PEP-8 naming conventions, plugin for flake8\r\nplatformdirs          2.5.2     A small Python module for determining appropriate platform-specific dirs, e.g. a \"user data dir\".\r\npluggy                1.0.0     plugin and hook calling mechanisms for python\r\npre-commit            2.20.0    A framework for managing and maintaining multi-language pre-commit hooks.\r\nprospector            1.7.7\r\npy                    1.11.0    library with cross-python path, ini-parsing, io, code, log facilities\r\npycodestyle           2.8.0     Python style guide checker\r\npydocstyle            6.1.1     Python docstring style checker\r\npyflakes              2.5.0     passive checker of Python programs\r\npylint                2.15.3    python code static checker\r\npylint-celery         0.3       pylint-celery is a Pylint plugin to aid Pylint in recognising and understandingerrors caused when using the Celery library\r\npylint-django         2.5.3     A Pylint plugin to help Pylint understand the Django web framework\r\npylint-flask          0.6       pylint-flask is a Pylint plugin to aid Pylint in recognizing and understanding errors caused when using Flask\r\npylint-plugin-utils   0.7       Utilities and helpers for writing Pylint plugins\r\npyparsing             3.0.9     pyparsing module - Classes and methods to define and execute parsing grammars\r\npytest                7.2.0     pytest: simple powerful testing with Python\r\npytest-cov            3.0.0     Pytest plugin for measuring coverage.\r\npytest-env            0.6.2     py.test plugin that allows you to add environment variables.\r\npytest-forked         1.4.0     run tests in isolated forked subprocesses\r\npytest-xdist          2.5.0     pytest xdist plugin for distributed testing and loop-on-failing modes\r\npython-dateutil       2.8.2     Extensions to the standard Python datetime module\r\npython-decouple       3.6       Strict separation of settings from code.\r\nPyYAML                6.0       YAML parser and emitter for Python\r\nrequests              2.28.1    Python HTTP for Humans.\r\nrequirements-detector 0.7       Python tool to find and list requirements of a Python project\r\ns3transfer            0.6.0     An Amazon S3 Transfer Manager\r\nsentry-sdk            1.9.9     Python client for Sentry (https://sentry.io)\r\nsetoptconf-tmp        0.3.1     A module for retrieving program settings from various sources in a consistant method.\r\nsetuptools            65.5.0    Easily download, build, install, upgrade, and uninstall Python packages\r\nsix                   1.16.0    Python 2 and 3 compatibility utilities\r\nsnowballstemmer       2.2.0     This package provides 29 stemmers for 28 languages generated from Snowball algorithms.\r\ntoml                  0.10.2    Python Library for Tom's Obvious, Minimal Language\r\ntomli                 2.0.1     A lil' TOML parser\r\ntomlkit               0.11.4    Style preserving TOML library\r\ntyping-extensions     4.3.0     Backported and Experimental Type Hints for Python 3.7+\r\nurllib3               1.26.12   HTTP library with thread-safe connection pooling, file post, and more.\r\nvirtualenv            20.16.5   Virtual Python Environment builder\r\nwrapt                 1.14.1    Module for decorators, wrappers and monkey patching.\r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n# pytest and OS versions\r\n\r\n```bash\r\n$ poetry show pytest\r\n name         : pytest\r\n version      : 7.2.0\r\n description  : pytest: simple powerful testing with Python\r\n\r\ndependencies\r\n - attrs >=19.2.0\r\n - colorama *\r\n - exceptiongroup >=1.0.0rc8\r\n - iniconfig *\r\n - packaging *\r\n - pluggy >=0.12,<2.0\r\n - tomli >=1.0.0\r\n\r\nrequired by\r\n - pytest-cov >=4.6\r\n - pytest-env >=2.6.0\r\n - pytest-forked >=3.10\r\n - pytest-xdist >=6.2.0\r\n\r\n$ lsb_release -a\r\nNo LSB modules are available.\r\nDistributor ID: Ubuntu\r\nDescription:    Ubuntu 22.04.1 LTS\r\nRelease:        22.04\r\nCodename:       jammy\r\n```\r\n","closed_by":{"login":"nicoddemus","id":1085180,"node_id":"MDQ6VXNlcjEwODUxODA=","avatar_url":"https://avatars.githubusercontent.com/u/1085180?v=4","gravatar_id":"","url":"https://api.github.com/users/nicoddemus","html_url":"https://github.com/nicoddemus","followers_url":"https://api.github.com/users/nicoddemus/followers","following_url":"https://api.github.com/users/nicoddemus/following{/other_user}","gists_url":"https://api.github.com/users/nicoddemus/gists{/gist_id}","starred_url":"https://api.github.com/users/nicoddemus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicoddemus/subscriptions","organizations_url":"https://api.github.com/users/nicoddemus/orgs","repos_url":"https://api.github.com/users/nicoddemus/repos","events_url":"https://api.github.com/users/nicoddemus/events{/privacy}","received_events_url":"https://api.github.com/users/nicoddemus/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/10558/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pytest-dev/pytest/issues/10558/timeline","performed_via_github_app":null,"state_reason":"completed"}