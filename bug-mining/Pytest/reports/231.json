{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/8258","repository_url":"https://api.github.com/repos/pytest-dev/pytest","labels_url":"https://api.github.com/repos/pytest-dev/pytest/issues/8258/labels{/name}","comments_url":"https://api.github.com/repos/pytest-dev/pytest/issues/8258/comments","events_url":"https://api.github.com/repos/pytest-dev/pytest/issues/8258/events","html_url":"https://github.com/pytest-dev/pytest/issues/8258","id":789816761,"node_id":"MDU6SXNzdWU3ODk4MTY3NjE=","number":8258,"title":"Faulthandler not enabled when pytest run under Python Dev Mode (-X dev)","user":{"login":"thomascobb","id":7705060,"node_id":"MDQ6VXNlcjc3MDUwNjA=","avatar_url":"https://avatars.githubusercontent.com/u/7705060?v=4","gravatar_id":"","url":"https://api.github.com/users/thomascobb","html_url":"https://github.com/thomascobb","followers_url":"https://api.github.com/users/thomascobb/followers","following_url":"https://api.github.com/users/thomascobb/following{/other_user}","gists_url":"https://api.github.com/users/thomascobb/gists{/gist_id}","starred_url":"https://api.github.com/users/thomascobb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/thomascobb/subscriptions","organizations_url":"https://api.github.com/users/thomascobb/orgs","repos_url":"https://api.github.com/users/thomascobb/repos","events_url":"https://api.github.com/users/thomascobb/events{/privacy}","received_events_url":"https://api.github.com/users/thomascobb/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2021-01-20T09:47:14Z","updated_at":"2021-01-28T16:03:25Z","closed_at":"2021-01-28T16:03:25Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"# Description\r\nI use [Python Dev Mode](https://docs.python.org/3/library/devmode.html#devmode) as a handy shortcut for enabling faulthandler, enabling debug mode of asyncio, logging resource leaks, and other goodies. Unfortunately, pytest's faulthandler plugin doesn't install itself if something else has already enabled the faulthandler. This means the output of the faulthandler is swallowed unless pytest is run with `-s`\r\n\r\n# Minimal example\r\nHere is a file with 2 tests, one which fails with an asyncio error when run under dev mode, and another which occasionally seg faults. I would like to see the asyncio error when it doesn't segfault, and the stack trace when it does.\r\n```python\r\nimport ctypes\r\nimport asyncio\r\nimport threading\r\nimport time\r\n\r\ndef test_wrong_thread():\r\n    loop = asyncio.get_event_loop()\r\n    t = threading.Thread(target=loop.run_forever)\r\n    t.setDaemon(True)\r\n    t.start()\r\n    loop.call_soon(print)\r\n\r\ndef test_segfault():\r\n    if time.time() % 1 < 0.3:\r\n        ctypes.string_at(0)\r\n```\r\nRunning\r\n```\r\n$ python -X dev -m pytest\r\n```\r\nGives the error from asyncio:\r\n```\r\nRuntimeError: Non-thread-safe operation invoked on an event loop other than the current one\r\n```\r\nBut when it segfaults the stack trace is swallowed unless run with `-s`\r\n# Suggestion\r\nEither unconditionally enabling faulthandler in the plugin (regardless of whether it was already enabled) or adding an option to do so would fix this, I am happy to provide a PR if this is a valid solution.\r\nThis naive solution fixes things for my example:\r\n```diff\r\n--- faulthandler.py\t2021-01-20 09:42:57.611168438 +0000\r\n+++ faulthandler_patch.py\t2021-01-20 09:43:30.767501381 +0000\r\n@@ -25,7 +25,7 @@\r\n def pytest_configure(config: Config) -> None:\r\n     import faulthandler\r\n \r\n-    if not faulthandler.is_enabled():\r\n+    if True:\r\n         # faulthhandler is not enabled, so install plugin that does the actual work\r\n         # of enabling faulthandler before each test executes.\r\n         config.pluginmanager.register(FaultHandlerHooks(), \"faulthandler-hooks\")\r\n```\r\n\r\n# Environment\r\n```\r\n$ pip list\r\nPackage       Version\r\n------------- ----------\r\nappdirs       1.4.3\r\nattrs         20.3.0\r\nCacheControl  0.12.6\r\ncertifi       2019.11.28\r\nchardet       3.0.4\r\ncolorama      0.4.3\r\ncontextlib2   0.6.0\r\ndistlib       0.3.0\r\ndistro        1.4.0\r\nhtml5lib      1.0.1\r\nidna          2.8\r\niniconfig     1.1.1\r\nipaddr        2.2.0\r\nlockfile      0.12.2\r\nmsgpack       0.6.2\r\npackaging     20.8\r\npep517        0.8.2\r\npip           20.0.2\r\npkg-resources 0.0.0\r\npluggy        0.13.1\r\nprogress      1.5\r\npy            1.10.0\r\npyparsing     2.4.7\r\npytest        6.2.1\r\npytoml        0.1.21\r\nrequests      2.22.0\r\nretrying      1.3.3\r\nsetuptools    44.0.0\r\nsix           1.14.0\r\ntoml          0.10.2\r\nurllib3       1.25.8\r\nwebencodings  0.5.1\r\nwheel         0.34.2\r\n```","closed_by":{"login":"nicoddemus","id":1085180,"node_id":"MDQ6VXNlcjEwODUxODA=","avatar_url":"https://avatars.githubusercontent.com/u/1085180?v=4","gravatar_id":"","url":"https://api.github.com/users/nicoddemus","html_url":"https://github.com/nicoddemus","followers_url":"https://api.github.com/users/nicoddemus/followers","following_url":"https://api.github.com/users/nicoddemus/following{/other_user}","gists_url":"https://api.github.com/users/nicoddemus/gists{/gist_id}","starred_url":"https://api.github.com/users/nicoddemus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicoddemus/subscriptions","organizations_url":"https://api.github.com/users/nicoddemus/orgs","repos_url":"https://api.github.com/users/nicoddemus/repos","events_url":"https://api.github.com/users/nicoddemus/events{/privacy}","received_events_url":"https://api.github.com/users/nicoddemus/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/8258/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pytest-dev/pytest/issues/8258/timeline","performed_via_github_app":null,"state_reason":"completed"}