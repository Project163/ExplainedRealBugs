{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/9036","repository_url":"https://api.github.com/repos/pytest-dev/pytest","labels_url":"https://api.github.com/repos/pytest-dev/pytest/issues/9036/labels{/name}","comments_url":"https://api.github.com/repos/pytest-dev/pytest/issues/9036/comments","events_url":"https://api.github.com/repos/pytest-dev/pytest/issues/9036/events","html_url":"https://github.com/pytest-dev/pytest/issues/9036","id":979392105,"node_id":"MDU6SXNzdWU5NzkzOTIxMDU=","number":9036,"title":"`pytest.warns` and `pytest.raises` ordering issue","user":{"login":"jrbourbeau","id":11656932,"node_id":"MDQ6VXNlcjExNjU2OTMy","avatar_url":"https://avatars.githubusercontent.com/u/11656932?v=4","gravatar_id":"","url":"https://api.github.com/users/jrbourbeau","html_url":"https://github.com/jrbourbeau","followers_url":"https://api.github.com/users/jrbourbeau/followers","following_url":"https://api.github.com/users/jrbourbeau/following{/other_user}","gists_url":"https://api.github.com/users/jrbourbeau/gists{/gist_id}","starred_url":"https://api.github.com/users/jrbourbeau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jrbourbeau/subscriptions","organizations_url":"https://api.github.com/users/jrbourbeau/orgs","repos_url":"https://api.github.com/users/jrbourbeau/repos","events_url":"https://api.github.com/users/jrbourbeau/events{/privacy}","received_events_url":"https://api.github.com/users/jrbourbeau/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":224849193,"node_id":"MDU6TGFiZWwyMjQ4NDkxOTM=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/type:%20bug","name":"type: bug","color":"fc2929","default":false,"description":"problem that needs to be addressed"},{"id":615327396,"node_id":"MDU6TGFiZWw2MTUzMjczOTY=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/plugin:%20warnings","name":"plugin: warnings","color":"fef2c0","default":false,"description":"related to the warnings builtin plugin"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2021-08-25T16:14:03Z","updated_at":"2023-07-01T04:58:43Z","closed_at":"2023-07-01T04:58:43Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\nThanks for submitting an issue!\r\n\r\nQuick check-list while reporting bugs:\r\n-->\r\n\r\n- [x] a detailed description of the bug or problem you are having\r\n- [x] output of `pip list` from the virtual environment you are using\r\n- [x] pytest and operating system versions\r\n- [x] minimal example if possible\r\n\r\n## Description\r\n\r\nIt appears that when testing that both a warning is emitted and an exception is raised, the order in which `pytest.raises` and `pytest.warns` are used matters and can lead to potentially confusing behavior.\r\n\r\n## Minimal example\r\n\r\nFor example, the following test passes:\r\n\r\n```python\r\nimport warnings\r\n\r\nimport pytest\r\n\r\ndef my_func():\r\n    # This both emits a `FutureWarning` and raises a `ValueError`\r\n    warnings.warn(\"my warning\", category=FutureWarning)\r\n    raise ValueError(\"my error\")\r\n\r\ndef test():\r\n    with pytest.raises(ValueError, match=\"my error\"):\r\n        with pytest.warns(SyntaxWarning, match=\"my warning\"): # <-- I expected this to fail because `my_func` doesn't emit a `SyntaxWarning`\r\n            my_func()\r\n```\r\n\r\nNaively I expected this test to fail as `my_func` is emitting a `FutureWarning`, but the test checking that a `SyntaxWarning` is emitted.\r\n\r\nHowever, if I switch the order of `pytest.raises` and `pytest.warns`, then the test fails as expected. That is\r\n\r\n```python\r\nimport warnings\r\n\r\nimport pytest\r\n\r\ndef my_func():\r\n    # This both emits a `FutureWarning` and raises a `ValueError`\r\n    warnings.warn(\"my warning\", category=FutureWarning)\r\n    raise ValueError(\"my error\")\r\n\r\ndef test():\r\n    with pytest.warns(SyntaxWarning, match=\"my warning\"):\r\n        with pytest.raises(ValueError, match=\"my error\"):\r\n            my_func()\r\n```\r\n\r\noutputs\r\n\r\n```\r\n__________________________________________________________________________ test __________________________________________________________________________\r\n\r\n    def test():\r\n        with pytest.warns(SyntaxWarning, match=\"my warning\"):\r\n            with pytest.raises(ValueError, match=\"my error\"):\r\n>               my_func()\r\nE               Failed: DID NOT WARN. No warnings of type (<class 'SyntaxWarning'>,) was emitted. The list of emitted warnings is: [FutureWarning('my warning')].\r\n\r\ntest.py:13: Failed\r\n```\r\n\r\n## Extra info\r\n\r\n<details>\r\n<summary>pip list:</summary>\r\n\r\n```\r\nPackage                       Version                    Location\r\n----------------------------- -------------------------- --------------------------------------\r\naiobotocore                   1.3.3\r\naiohttp                       3.7.4.post0\r\naioitertools                  0.7.1\r\nalabaster                     0.7.12\r\nanyio                         3.3.0\r\nappdirs                       1.4.4\r\nappnope                       0.1.2\r\nargon2-cffi                   20.1.0\r\nasync-generator               1.10\r\nasync-timeout                 3.0.1\r\nasyncssh                      2.7.0\r\nattrs                         21.2.0\r\nawscli                        1.19.106\r\nBabel                         2.9.1\r\nbackcall                      0.2.0\r\nbackports.functools-lru-cache 1.6.4\r\nbcrypt                        3.2.0\r\nbleach                        3.3.1\r\nblosc                         1.10.2\r\nbokeh                         2.3.3\r\nbotocore                      1.20.106\r\nbrotlipy                      0.7.0\r\ncached-property               1.5.2\r\ncertifi                       2021.5.30\r\ncffi                          1.14.6\r\ncfgv                          3.3.0\r\ncftime                        1.5.0\r\nchardet                       4.0.0\r\ncharset-normalizer            2.0.0\r\nclick                         8.0.1\r\ncloudpickle                   1.6.0\r\ncmarkgfm                      0.6.0\r\ncolorama                      0.4.3\r\ncryptography                  3.4.7\r\ncytoolz                       0.11.0\r\ndask                          2021.8.1+3.ga6cc44fd.dirty /Users/james/projects/dask/dask\r\ndask-labextension             5.1.0\r\ndask-sphinx-theme             1.3.6\r\ndebugpy                       1.4.1\r\ndecorator                     5.0.9\r\ndefusedxml                    0.7.1\r\ndistlib                       0.3.2\r\ndistributed                   2021.8.1                   /Users/james/projects/dask/distributed\r\ndocutils                      0.16\r\neditdistance-s                1.0.0\r\nentrypoints                   0.3\r\nexecnet                       1.9.0\r\nfilelock                      3.0.12\r\nfsspec                        2021.7.0+8.gee22435\r\nfuture                        0.18.2\r\ngssapi                        1.6.14\r\nh5py                          3.3.0\r\nHeapDict                      1.0.1\r\nidentify                      2.2.11\r\nidna                          3.1\r\nimagesize                     1.2.0\r\nimportlib-metadata            4.6.1\r\niniconfig                     1.1.1\r\nipykernel                     6.0.3\r\nipython                       7.25.0\r\nipython-genutils              0.2.0\r\nipywidgets                    7.6.3\r\njedi                          0.18.0\r\nJinja2                        3.0.1\r\njmespath                      0.10.0\r\njoblib                        1.1.0.dev0\r\njson5                         0.9.5\r\njsonschema                    3.2.0\r\njupyter-client                6.1.12\r\njupyter-core                  4.7.1\r\njupyter-server                1.10.1\r\njupyter-server-proxy          3.1.0\r\njupyterlab                    3.1.1\r\njupyterlab-pygments           0.1.2\r\njupyterlab-server             2.6.1\r\njupyterlab-widgets            1.0.0\r\nKeras                         2.4.3\r\nkeyring                       23.0.1\r\nlocket                        0.2.0\r\nlz4                           3.1.3\r\nMarkupSafe                    2.0.1\r\nmatplotlib-inline             0.1.2\r\nmistune                       0.8.4\r\nmore-itertools                8.8.0\r\nmsgpack                       1.0.2\r\nmultidict                     5.1.0\r\nnbclassic                     0.3.1\r\nnbclient                      0.5.3\r\nnbconvert                     6.1.0\r\nnbformat                      5.1.3\r\nnest-asyncio                  1.5.1\r\nnetCDF4                       1.5.7\r\nnodeenv                       1.6.0\r\nnotebook                      6.4.0\r\nnumpy                         1.21.1\r\nnumpydoc                      1.1.0\r\nolefile                       0.46\r\npackaging                     21.0\r\npandas                        1.3.1\r\npandocfilters                 1.4.2\r\nparamiko                      2.7.2\r\nparso                         0.8.2\r\npartd                         1.2.0\r\npexpect                       4.8.0\r\npickleshare                   0.7.5\r\nPillow                        8.2.0\r\npip                           21.2.1\r\npkginfo                       1.7.1\r\npluggy                        0.13.1\r\npre-commit                    2.13.0\r\nprometheus-client             0.11.0\r\nprompt-toolkit                3.0.19\r\npsutil                        5.8.0\r\nptyprocess                    0.7.0\r\npy                            1.10.0\r\npyasn1                        0.4.8\r\npycparser                     2.20\r\nPygments                      2.9.0\r\nPyNaCl                        1.4.0\r\npynvml                        11.0.0\r\npyOpenSSL                     20.0.1\r\npyparsing                     2.4.7\r\npyrsistent                    0.17.3\r\nPySocks                       1.7.1\r\npytest                        6.2.4\r\npytest-asyncio                0.12.0\r\npytest-faulthandler           2.0.1\r\npytest-forked                 1.3.0\r\npytest-repeat                 0.8.0\r\npytest-rerunfailures          10.1\r\npytest-timeout                1.4.2\r\npytest-xdist                  2.3.0\r\npython-dateutil               2.8.2\r\npython-snappy                 0.6.0\r\npytz                          2021.1\r\nPyYAML                        5.4.1\r\npyzmq                         22.1.0\r\nreadme-renderer               27.0\r\nrequests                      2.26.0\r\nrequests-toolbelt             0.9.1\r\nrequests-unixsocket           0.2.0\r\nrfc3986                       1.5.0\r\nrsa                           4.7.2\r\ns3fs                          2021.7.0+5.g0df4f28\r\ns3transfer                    0.4.2\r\nscikit-learn                  0.24.2\r\nscipy                         1.7.0\r\nSend2Trash                    1.7.1\r\nsetuptools                    49.6.0.post20210108\r\nsimpervisor                   0.4\r\nsix                           1.16.0\r\nsniffio                       1.2.0\r\nsnowballstemmer               2.1.0\r\nsortedcollections             2.1.0\r\nsortedcontainers              2.4.0\r\nSphinx                        4.1.2\r\nsphinx-click                  3.0.1\r\nsphinx-rtd-theme              0.5.2\r\nsphinxcontrib-applehelp       1.0.2\r\nsphinxcontrib-devhelp         1.0.2\r\nsphinxcontrib-htmlhelp        2.0.0\r\nsphinxcontrib-jsmath          1.0.1\r\nsphinxcontrib-qthelp          1.0.3\r\nsphinxcontrib-serializinghtml 1.1.5\r\ntblib                         1.7.0\r\nterminado                     0.10.1\r\ntestpath                      0.5.0\r\nthreadpoolctl                 2.2.0\r\ntoml                          0.10.2\r\ntoolz                         0.11.1\r\ntorch                         1.9.0\r\ntorchvision                   0.9.0a0\r\ntornado                       6.1\r\ntqdm                          4.61.2\r\ntraitlets                     5.0.5\r\ntwine                         0.0.0\r\ntyping-extensions             3.10.0.0\r\nurllib3                       1.26.6\r\nvirtualenv                    20.4.7\r\nwcwidth                       0.2.5\r\nwebencodings                  0.5.1\r\nwebsocket-client              0.57.0\r\nwheel                         0.36.2\r\nwidgetsnbextension            3.5.1\r\nwrapt                         1.12.1\r\nyarl                          1.6.3\r\nzict                          2.0.0\r\nzipp                          3.5.0\r\nzstandard                     0.15.2\r\n```\r\n\r\n</details>\r\n\r\nI'm using `pytest==6.2.4` on a Mac running Big Sur. ","closed_by":{"login":"Zac-HD","id":12229877,"node_id":"MDQ6VXNlcjEyMjI5ODc3","avatar_url":"https://avatars.githubusercontent.com/u/12229877?v=4","gravatar_id":"","url":"https://api.github.com/users/Zac-HD","html_url":"https://github.com/Zac-HD","followers_url":"https://api.github.com/users/Zac-HD/followers","following_url":"https://api.github.com/users/Zac-HD/following{/other_user}","gists_url":"https://api.github.com/users/Zac-HD/gists{/gist_id}","starred_url":"https://api.github.com/users/Zac-HD/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Zac-HD/subscriptions","organizations_url":"https://api.github.com/users/Zac-HD/orgs","repos_url":"https://api.github.com/users/Zac-HD/repos","events_url":"https://api.github.com/users/Zac-HD/events{/privacy}","received_events_url":"https://api.github.com/users/Zac-HD/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/9036/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pytest-dev/pytest/issues/9036/timeline","performed_via_github_app":null,"state_reason":"completed"}