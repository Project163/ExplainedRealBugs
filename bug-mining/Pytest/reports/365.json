{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/11137","repository_url":"https://api.github.com/repos/pytest-dev/pytest","labels_url":"https://api.github.com/repos/pytest-dev/pytest/issues/11137/labels{/name}","comments_url":"https://api.github.com/repos/pytest-dev/pytest/issues/11137/comments","events_url":"https://api.github.com/repos/pytest-dev/pytest/issues/11137/events","html_url":"https://github.com/pytest-dev/pytest/issues/11137","id":1772813436,"node_id":"I_kwDOAjwLdc5pqvx8","number":11137,"title":"`Package` should not be a `Module`/`File`","user":{"login":"bluetech","id":1223550,"node_id":"MDQ6VXNlcjEyMjM1NTA=","avatar_url":"https://avatars.githubusercontent.com/u/1223550?v=4","gravatar_id":"","url":"https://api.github.com/users/bluetech","html_url":"https://github.com/bluetech","followers_url":"https://api.github.com/users/bluetech/followers","following_url":"https://api.github.com/users/bluetech/following{/other_user}","gists_url":"https://api.github.com/users/bluetech/gists{/gist_id}","starred_url":"https://api.github.com/users/bluetech/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bluetech/subscriptions","organizations_url":"https://api.github.com/users/bluetech/orgs","repos_url":"https://api.github.com/users/bluetech/repos","events_url":"https://api.github.com/users/bluetech/events{/privacy}","received_events_url":"https://api.github.com/users/bluetech/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":224849844,"node_id":"MDU6TGFiZWwyMjQ4NDk4NDQ=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/type:%20proposal","name":"type: proposal","color":"006b75","default":false,"description":"proposal for a new feature, often to gather opinions or design the API around the new feature"},{"id":240511492,"node_id":"MDU6TGFiZWwyNDA1MTE0OTI=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/topic:%20collection","name":"topic: collection","color":"006b75","default":false,"description":"related to the collection phase"},{"id":240739369,"node_id":"MDU6TGFiZWwyNDA3MzkzNjk=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/type:%20backward%20compatibility","name":"type: backward compatibility","color":"f7c6c7","default":false,"description":"might present some backward compatibility issues which should be carefully noted in the changelog"}],"state":"closed","locked":false,"assignee":{"login":"bluetech","id":1223550,"node_id":"MDQ6VXNlcjEyMjM1NTA=","avatar_url":"https://avatars.githubusercontent.com/u/1223550?v=4","gravatar_id":"","url":"https://api.github.com/users/bluetech","html_url":"https://github.com/bluetech","followers_url":"https://api.github.com/users/bluetech/followers","following_url":"https://api.github.com/users/bluetech/following{/other_user}","gists_url":"https://api.github.com/users/bluetech/gists{/gist_id}","starred_url":"https://api.github.com/users/bluetech/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bluetech/subscriptions","organizations_url":"https://api.github.com/users/bluetech/orgs","repos_url":"https://api.github.com/users/bluetech/repos","events_url":"https://api.github.com/users/bluetech/events{/privacy}","received_events_url":"https://api.github.com/users/bluetech/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"bluetech","id":1223550,"node_id":"MDQ6VXNlcjEyMjM1NTA=","avatar_url":"https://avatars.githubusercontent.com/u/1223550?v=4","gravatar_id":"","url":"https://api.github.com/users/bluetech","html_url":"https://github.com/bluetech","followers_url":"https://api.github.com/users/bluetech/followers","following_url":"https://api.github.com/users/bluetech/following{/other_user}","gists_url":"https://api.github.com/users/bluetech/gists{/gist_id}","starred_url":"https://api.github.com/users/bluetech/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bluetech/subscriptions","organizations_url":"https://api.github.com/users/bluetech/orgs","repos_url":"https://api.github.com/users/bluetech/repos","events_url":"https://api.github.com/users/bluetech/events{/privacy}","received_events_url":"https://api.github.com/users/bluetech/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/pytest-dev/pytest/milestones/35","html_url":"https://github.com/pytest-dev/pytest/milestone/35","labels_url":"https://api.github.com/repos/pytest-dev/pytest/milestones/35/labels","id":5503484,"node_id":"MDk6TWlsZXN0b25lNTUwMzQ4NA==","number":35,"title":"8.0","description":"","creator":{"login":"nicoddemus","id":1085180,"node_id":"MDQ6VXNlcjEwODUxODA=","avatar_url":"https://avatars.githubusercontent.com/u/1085180?v=4","gravatar_id":"","url":"https://api.github.com/users/nicoddemus","html_url":"https://github.com/nicoddemus","followers_url":"https://api.github.com/users/nicoddemus/followers","following_url":"https://api.github.com/users/nicoddemus/following{/other_user}","gists_url":"https://api.github.com/users/nicoddemus/gists{/gist_id}","starred_url":"https://api.github.com/users/nicoddemus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicoddemus/subscriptions","organizations_url":"https://api.github.com/users/nicoddemus/orgs","repos_url":"https://api.github.com/users/nicoddemus/repos","events_url":"https://api.github.com/users/nicoddemus/events{/privacy}","received_events_url":"https://api.github.com/users/nicoddemus/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":11,"state":"closed","created_at":"2020-06-05T11:56:50Z","updated_at":"2024-04-14T12:35:09Z","due_on":null,"closed_at":"2024-04-14T12:35:09Z"},"comments":0,"created_at":"2023-06-24T16:23:10Z","updated_at":"2023-07-28T20:15:10Z","closed_at":"2023-07-28T20:15:10Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"*Note: this issue is extracted verbatim from https://github.com/pytest-dev/pytest/issues/7777#issuecomment-1575652688 so I can refer to it separately*\r\n\r\n`Package` is currently a subclass of a `Module`, with `package.path` being the `__init__.py` file.\r\n\r\nWhile technically in terms of the Python data model this [is correct](https://docs.python.org/3/glossary.html#term-package), I'm pretty convinced this was the wrong decision in pytest:\r\n\r\n`Package` is a `Module` with path `__init__.py`, but it doesn't actually act as a `Module` behaviorally, it overrides everything that `Module` does and doesn't call `super()` on anything.\r\n\r\n`Module` is a `nodes.File`, which makes `Package` a `nodes.File`, but it doesn't act as a file.\r\n\r\nThe previous points can be rephrased as: `Package` breaks Liskov substitution -- any code dealing with `File` or `Module` generically probably doesn't want `Package`.\r\n\r\n`Package` is a `Module` with path `__init__.py`, but it actually collects a \"real\" (non-`Package`) `Module` for the `__init__.py` file (if permitted by `python_files` glob). This is very confusing.\r\n\r\n`Package` and `__init__.py` necessitates several special-casings because of these points:\r\n\r\n- https://github.com/pytest-dev/pytest/blob/24534cdd29d74e302e86db1a719c99e024d7903e/src/_pytest/cacheprovider.py#L275-L278\r\n- https://github.com/pytest-dev/pytest/blob/24534cdd29d74e302e86db1a719c99e024d7903e/src/_pytest/main.py#L805-L818\r\n- https://github.com/pytest-dev/pytest/blob/24534cdd29d74e302e86db1a719c99e024d7903e/src/_pytest/fixtures.py#L123\r\n- https://github.com/pytest-dev/pytest/blob/24534cdd29d74e302e86db1a719c99e024d7903e/src/_pytest/python.py#L229-L231\r\n- https://github.com/pytest-dev/pytest/blob/24534cdd29d74e302e86db1a719c99e024d7903e/src/_pytest/python.py#L750-L761\r\n\r\n### Proposed solution\r\n\r\nAs part of the breaking `Package` changes discussed previously in this issue, also make these changes\r\n\r\n- `Package` no longer inherits from `Module` (or `File` by extension), just from `FSCollector`.\r\n- `Package.path` is the package directory, not the `__init__.py` file.\r\n- Collecting `pkg/__init__.py` collects the `__init__.py` file as a module (file), doesn't collect the entire package.\r\n\r\nThis also matches the new `Directory` node, which is the non-`Package` directory collector. `Directory` will inherit just from `FSCollector` and its `path` will be the directory. It will be much better if they are as similar to each other as possible.\r\n\r\n### Complication\r\n\r\nCurrently `Package`  has a `setup()` method which imports the `__init__.py`' and runs its `setup_module` function and registers `teardown_module` finalizer (in effectively the package scope). If we want to stop having `Package` as a `Module` it becomes a bit less natural to implement.\r\n\r\nThis functionality has some issues:\r\n- It is undocumented.\r\n- It doesn't match `unittest` which doesn't have package functionality\r\n- The names `setup_module` and `teardown_module` conflict with the \"real\" `__init__.py` `Module` setup/teardown; i.e., these methods are executed twice, if the `__init__.py` is included in the glob. It would have been better to call them `setup_package`/`teardown_package` (this is how nose [calls them](https://nose.readthedocs.io/en/latest/writing_tests.html#test-packages)).\r\n\r\nIt is tempting to just remove it, but it will probably cause some breakage (particularly the `__init__.py` importing part), so for now I plan to keep it in an ad-hoc manner.\r\n\r\n### POC\r\n\r\nI have an initial implementation of this change here, with all tests passing:\r\nhttps://github.com/bluetech/pytest/commits/pkg-mod","closed_by":{"login":"bluetech","id":1223550,"node_id":"MDQ6VXNlcjEyMjM1NTA=","avatar_url":"https://avatars.githubusercontent.com/u/1223550?v=4","gravatar_id":"","url":"https://api.github.com/users/bluetech","html_url":"https://github.com/bluetech","followers_url":"https://api.github.com/users/bluetech/followers","following_url":"https://api.github.com/users/bluetech/following{/other_user}","gists_url":"https://api.github.com/users/bluetech/gists{/gist_id}","starred_url":"https://api.github.com/users/bluetech/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bluetech/subscriptions","organizations_url":"https://api.github.com/users/bluetech/orgs","repos_url":"https://api.github.com/users/bluetech/repos","events_url":"https://api.github.com/users/bluetech/events{/privacy}","received_events_url":"https://api.github.com/users/bluetech/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/11137/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pytest-dev/pytest/issues/11137/timeline","performed_via_github_app":null,"state_reason":"completed"}