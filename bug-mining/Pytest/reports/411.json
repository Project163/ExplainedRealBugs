{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/11475","repository_url":"https://api.github.com/repos/pytest-dev/pytest","labels_url":"https://api.github.com/repos/pytest-dev/pytest/issues/11475/labels{/name}","comments_url":"https://api.github.com/repos/pytest-dev/pytest/issues/11475/comments","events_url":"https://api.github.com/repos/pytest-dev/pytest/issues/11475/events","html_url":"https://github.com/pytest-dev/pytest/issues/11475","id":1921859582,"node_id":"I_kwDOAjwLdc5yjT_-","number":11475,"title":"ModuleNotFoundError when using `--doctest-modules`, a `src/` layout, and `--import-mode=importlib` (and no editable mode install)","user":{"login":"flying-sheep","id":291575,"node_id":"MDQ6VXNlcjI5MTU3NQ==","avatar_url":"https://avatars.githubusercontent.com/u/291575?v=4","gravatar_id":"","url":"https://api.github.com/users/flying-sheep","html_url":"https://github.com/flying-sheep","followers_url":"https://api.github.com/users/flying-sheep/followers","following_url":"https://api.github.com/users/flying-sheep/following{/other_user}","gists_url":"https://api.github.com/users/flying-sheep/gists{/gist_id}","starred_url":"https://api.github.com/users/flying-sheep/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/flying-sheep/subscriptions","organizations_url":"https://api.github.com/users/flying-sheep/orgs","repos_url":"https://api.github.com/users/flying-sheep/repos","events_url":"https://api.github.com/users/flying-sheep/events{/privacy}","received_events_url":"https://api.github.com/users/flying-sheep/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":240511492,"node_id":"MDU6TGFiZWwyNDA1MTE0OTI=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/topic:%20collection","name":"topic: collection","color":"006b75","default":false,"description":"related to the collection phase"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":29,"created_at":"2023-10-02T12:50:00Z","updated_at":"2024-03-11T21:40:17Z","closed_at":"2024-03-03T12:43:15Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## [reproducer](https://github.com/flying-sheep/pytest-doctest-import-mismatch)\r\n\r\nWe’d like to run our tests on an installed package instead of the development version, as we delete some files in our build process. We therefore don’t use editable installs.\r\n\r\nI think the problem is that there seems to be no way to configure the import root used with the importlib import mode. The project rootdir gets passed here instead of something user configurable:\r\n\r\nhttps://github.com/pytest-dev/pytest/blob/c34eaaaa1c485e9c8c3d1fe7f05549b6436f49cc/src/_pytest/doctest.py#L545-L549\r\n\r\nWhich means that the following code will run `module_name = module_name_from_path('<rootdir>/src/anndata/_types.py', '<rootdir>')`, i.e. `module_name = 'src.anndata._types'` when it should be `'anndata._types'`\r\n\r\nhttps://github.com/pytest-dev/pytest/blob/9f3bdac1500143c51ab358d07eb58b4cfa6d3fdf/src/_pytest/pathlib.py#L524-L525\r\n\r\nWithout `src/` layout, this works accidentally, as the `module_name` happens to match the real module name, and the module only gets imported once.\r\n\r\nPytest 7.4.2","closed_by":{"login":"nicoddemus","id":1085180,"node_id":"MDQ6VXNlcjEwODUxODA=","avatar_url":"https://avatars.githubusercontent.com/u/1085180?v=4","gravatar_id":"","url":"https://api.github.com/users/nicoddemus","html_url":"https://github.com/nicoddemus","followers_url":"https://api.github.com/users/nicoddemus/followers","following_url":"https://api.github.com/users/nicoddemus/following{/other_user}","gists_url":"https://api.github.com/users/nicoddemus/gists{/gist_id}","starred_url":"https://api.github.com/users/nicoddemus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicoddemus/subscriptions","organizations_url":"https://api.github.com/users/nicoddemus/orgs","repos_url":"https://api.github.com/users/nicoddemus/repos","events_url":"https://api.github.com/users/nicoddemus/events{/privacy}","received_events_url":"https://api.github.com/users/nicoddemus/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/11475/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pytest-dev/pytest/issues/11475/timeline","performed_via_github_app":null,"state_reason":"completed"}