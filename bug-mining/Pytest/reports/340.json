{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/8711","repository_url":"https://api.github.com/repos/pytest-dev/pytest","labels_url":"https://api.github.com/repos/pytest-dev/pytest/issues/8711/labels{/name}","comments_url":"https://api.github.com/repos/pytest-dev/pytest/issues/8711/comments","events_url":"https://api.github.com/repos/pytest-dev/pytest/issues/8711/events","html_url":"https://github.com/pytest-dev/pytest/issues/8711","id":906139564,"node_id":"MDU6SXNzdWU5MDYxMzk1NjQ=","number":8711,"title":"Handle logging.disable() in caplog.set_level and caplog.at_level","user":{"login":"alexlambson","id":6721199,"node_id":"MDQ6VXNlcjY3MjExOTk=","avatar_url":"https://avatars.githubusercontent.com/u/6721199?v=4","gravatar_id":"","url":"https://api.github.com/users/alexlambson","html_url":"https://github.com/alexlambson","followers_url":"https://api.github.com/users/alexlambson/followers","following_url":"https://api.github.com/users/alexlambson/following{/other_user}","gists_url":"https://api.github.com/users/alexlambson/gists{/gist_id}","starred_url":"https://api.github.com/users/alexlambson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alexlambson/subscriptions","organizations_url":"https://api.github.com/users/alexlambson/orgs","repos_url":"https://api.github.com/users/alexlambson/repos","events_url":"https://api.github.com/users/alexlambson/events{/privacy}","received_events_url":"https://api.github.com/users/alexlambson/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":224849844,"node_id":"MDU6TGFiZWwyMjQ4NDk4NDQ=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/type:%20proposal","name":"type: proposal","color":"006b75","default":false,"description":"proposal for a new feature, often to gather opinions or design the API around the new feature"},{"id":763820991,"node_id":"MDU6TGFiZWw3NjM4MjA5OTE=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/plugin:%20logging","name":"plugin: logging","color":"ff5432","default":false,"description":"related to the logging builtin plugin"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2021-05-28T22:15:51Z","updated_at":"2023-05-18T13:19:01Z","closed_at":"2023-05-18T13:19:01Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\nThanks for suggesting a feature!\r\n\r\nQuick check-list while suggesting features:\r\n-->\r\n\r\n### What's the problem this feature will solve?\r\n\r\n\r\nCurrently, caplog will not catch logs if `logging.disable(LEVEL)` was called somewhere, in my case it's called in my django\r\nsettings for test runs.\r\n\r\n### Describe the solution you'd like\r\n\r\n`caplog.at_level` and `caplog.set_level` should both take a new arg called `force_enable` that tells `caplog` to set the disable setting to one level below whatever level was requested to caplog. \r\nOr it should force enable the logging level if `rootLogger.manager.disable >= level` so that logging will always\r\nbe enabled for the level a test is trying to capture.\r\n\r\nThis will allow caplog to capture logs at the desired level even if they were disabled. \r\n\r\ne.g.\r\n\r\n```python\r\n# settings/testing.py\r\n# disables all logs\r\nimport logging\r\nlogging.disable(logging.CRITICAL)\r\n\r\n\r\n# test_file.py\r\nimport logging\r\n\r\n\r\ndef test_stuff(caplog):\r\n    caplog.set_level(logging.WARNING)\r\n    logging.error(\"Sierra 117\")\r\n    assert len(caplog.records) == 1\r\n    assert \"117\" in caplog.text\r\n```\r\n\r\nThe test will currently fail because caplog doesn't override `logging.disable` which is a separate setting from log level.\r\n\r\nMy proposal is to add a call to `logging.disable(max(level-10, 0))` inside both `set_level` and `at_level`. The `-10` means disable everything *below* the requested level for `caplog`. We set a minimum of `0` because that's the lowest log level.\r\n\r\nThis can be reset by adding an attribute to keep track of the initial disabled level, similar to the one added to fix https://github.com/pytest-dev/pytest/issues/7133.\r\n\r\n### Alternative Solutions\r\n\r\nThis is my current workaround in one of my tests\r\n\r\n```python\r\nwith caplog.at_level(logging.WARNING):\r\n    # logging.disable needs to be called because caplog doesn't handle disabled logging.\r\n    logging.disable(logging.WARNING)\r\n    # inside this request a `logging.error()` is called.\r\n    response = ah_client.get(\"/api/redacted/\")\r\n    # re-disable all logs.\r\n    logging.disable(logging.CRITICAL)\r\n```\r\n\r\n### Additional context\r\n\r\nI have an example PR that I can transition to a full PR if the team decides they want this behavior\r\nhttps://github.com/alexlambson/pytest/pull/1\r\n","closed_by":{"login":"nicoddemus","id":1085180,"node_id":"MDQ6VXNlcjEwODUxODA=","avatar_url":"https://avatars.githubusercontent.com/u/1085180?v=4","gravatar_id":"","url":"https://api.github.com/users/nicoddemus","html_url":"https://github.com/nicoddemus","followers_url":"https://api.github.com/users/nicoddemus/followers","following_url":"https://api.github.com/users/nicoddemus/following{/other_user}","gists_url":"https://api.github.com/users/nicoddemus/gists{/gist_id}","starred_url":"https://api.github.com/users/nicoddemus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicoddemus/subscriptions","organizations_url":"https://api.github.com/users/nicoddemus/orgs","repos_url":"https://api.github.com/users/nicoddemus/repos","events_url":"https://api.github.com/users/nicoddemus/events{/privacy}","received_events_url":"https://api.github.com/users/nicoddemus/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/8711/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pytest-dev/pytest/issues/8711/timeline","performed_via_github_app":null,"state_reason":"completed"}