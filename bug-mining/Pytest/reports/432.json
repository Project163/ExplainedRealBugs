{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/12367","repository_url":"https://api.github.com/repos/pytest-dev/pytest","labels_url":"https://api.github.com/repos/pytest-dev/pytest/issues/12367/labels{/name}","comments_url":"https://api.github.com/repos/pytest-dev/pytest/issues/12367/comments","events_url":"https://api.github.com/repos/pytest-dev/pytest/issues/12367/events","html_url":"https://github.com/pytest-dev/pytest/issues/12367","id":2317187139,"node_id":"I_kwDOAjwLdc6KHXhD","number":12367,"title":"Unittest class instances no longer released on test teardown since pytest 8.2.0","user":{"login":"bluetech","id":1223550,"node_id":"MDQ6VXNlcjEyMjM1NTA=","avatar_url":"https://avatars.githubusercontent.com/u/1223550?v=4","gravatar_id":"","url":"https://api.github.com/users/bluetech","html_url":"https://github.com/bluetech","followers_url":"https://api.github.com/users/bluetech/followers","following_url":"https://api.github.com/users/bluetech/following{/other_user}","gists_url":"https://api.github.com/users/bluetech/gists{/gist_id}","starred_url":"https://api.github.com/users/bluetech/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bluetech/subscriptions","organizations_url":"https://api.github.com/users/bluetech/orgs","repos_url":"https://api.github.com/users/bluetech/repos","events_url":"https://api.github.com/users/bluetech/events{/privacy}","received_events_url":"https://api.github.com/users/bluetech/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":315571544,"node_id":"MDU6TGFiZWwzMTU1NzE1NDQ=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/type:%20regression","name":"type: regression","color":"f7c6c7","default":false,"description":"indicates a problem that was introduced in a release which was working previously"},{"id":346031262,"node_id":"MDU6TGFiZWwzNDYwMzEyNjI=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/plugin:%20unittest","name":"plugin: unittest","color":"006b75","default":false,"description":"related to the unittest integration builtin plugin"}],"state":"closed","locked":false,"assignee":{"login":"bluetech","id":1223550,"node_id":"MDQ6VXNlcjEyMjM1NTA=","avatar_url":"https://avatars.githubusercontent.com/u/1223550?v=4","gravatar_id":"","url":"https://api.github.com/users/bluetech","html_url":"https://github.com/bluetech","followers_url":"https://api.github.com/users/bluetech/followers","following_url":"https://api.github.com/users/bluetech/following{/other_user}","gists_url":"https://api.github.com/users/bluetech/gists{/gist_id}","starred_url":"https://api.github.com/users/bluetech/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bluetech/subscriptions","organizations_url":"https://api.github.com/users/bluetech/orgs","repos_url":"https://api.github.com/users/bluetech/repos","events_url":"https://api.github.com/users/bluetech/events{/privacy}","received_events_url":"https://api.github.com/users/bluetech/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"bluetech","id":1223550,"node_id":"MDQ6VXNlcjEyMjM1NTA=","avatar_url":"https://avatars.githubusercontent.com/u/1223550?v=4","gravatar_id":"","url":"https://api.github.com/users/bluetech","html_url":"https://github.com/bluetech","followers_url":"https://api.github.com/users/bluetech/followers","following_url":"https://api.github.com/users/bluetech/following{/other_user}","gists_url":"https://api.github.com/users/bluetech/gists{/gist_id}","starred_url":"https://api.github.com/users/bluetech/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bluetech/subscriptions","organizations_url":"https://api.github.com/users/bluetech/orgs","repos_url":"https://api.github.com/users/bluetech/repos","events_url":"https://api.github.com/users/bluetech/events{/privacy}","received_events_url":"https://api.github.com/users/bluetech/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":0,"created_at":"2024-05-25T19:01:17Z","updated_at":"2024-05-26T07:34:12Z","closed_at":"2024-05-26T07:34:12Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Follow up to #12266. Related to #12198.\r\n\r\nSince 0dc036035107b213c9b73bf965cbd7356111b85a in pytest 8.2, pytest started holding onto class instances on the Function items, where previously the instance was gone on teardown.\r\n\r\nI was a bit confused how the previous behavior happened, since it *doesn't* happen for non-unittest test classes. The secret is this line:\r\n\r\nhttps://github.com/pytest-dev/pytest/blob/889d9b28d786c75b66f4d1acb80123bdb341639c/src/_pytest/unittest.py#L225C9-L225C25\r\n\r\nturns out unittest explicitly clears up the obj on teardown, since e46e653794e3b72d7cc02d374086191224221501 (pytest 3.0.4). The reason this regressed in 0dc036035107b213c9b73bf965cbd7356111b85a is that we now also need to clear `_instance`.  So the fix is simple.\r\n\r\nCommit 0dc036035107b213c9b73bf965cbd7356111b85a came with [a test](https://github.com/pytest-dev/pytest/blob/889d9b28d786c75b66f4d1acb80123bdb341639c/testing/test_unittest.py#L192), but it didn't catch the regression. I will try to improve it.\r\n\r\n---\r\n\r\nOne obvious question I think is, why do we only clear `_obj` for `TestCaseFunction` and not for `Function` itself (superclass of `TestCaseFunction` used for regular test methods and functions)? As far as I can see there is no good reason, we should do it and gain the same \"prompt release\" behavior for all tests. All of pytest's tests pass when I try it.\r\n\r\nUnfortunately there *is* a hitch involving plugins. The `Function` item has a feature where it can take a `callobj` argument to use as the `obj` instead of getting it itself. In this case the `Function` doesn't \"own\" the obj and can't clear it, otherwise when the item is re-run (as is done by plugins such as pytest-rerunfailures) the `obj` will not be the `callobj` on the second run.\r\n\r\nInternally, `callobj` is only used for `FunctionDefinition` and it's not a problem to handle this, but `callobj` is also used by several plugins, most notably [pytest-asyncio](https://github.com/pytest-dev/pytest-asyncio/blob/2bfffea3a8eb615a934d6ab175804e28ee9edb60/pytest_asyncio/plugin.py#L400) and we can't break that.\r\n\r\nSo while it will be good to do this change more generally, it requires care. So for now I'll only do the fix for unittest.","closed_by":{"login":"bluetech","id":1223550,"node_id":"MDQ6VXNlcjEyMjM1NTA=","avatar_url":"https://avatars.githubusercontent.com/u/1223550?v=4","gravatar_id":"","url":"https://api.github.com/users/bluetech","html_url":"https://github.com/bluetech","followers_url":"https://api.github.com/users/bluetech/followers","following_url":"https://api.github.com/users/bluetech/following{/other_user}","gists_url":"https://api.github.com/users/bluetech/gists{/gist_id}","starred_url":"https://api.github.com/users/bluetech/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bluetech/subscriptions","organizations_url":"https://api.github.com/users/bluetech/orgs","repos_url":"https://api.github.com/users/bluetech/repos","events_url":"https://api.github.com/users/bluetech/events{/privacy}","received_events_url":"https://api.github.com/users/bluetech/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/12367/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pytest-dev/pytest/issues/12367/timeline","performed_via_github_app":null,"state_reason":"completed"}