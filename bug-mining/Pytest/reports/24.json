{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/3372","repository_url":"https://api.github.com/repos/pytest-dev/pytest","labels_url":"https://api.github.com/repos/pytest-dev/pytest/issues/3372/labels{/name}","comments_url":"https://api.github.com/repos/pytest-dev/pytest/issues/3372/comments","events_url":"https://api.github.com/repos/pytest-dev/pytest/issues/3372/events","html_url":"https://github.com/pytest-dev/pytest/issues/3372","id":311914603,"node_id":"MDU6SXNzdWUzMTE5MTQ2MDM=","number":3372,"title":"pytest.raises 3.5.0 breaks for exception classes that look iterable (e.g. spyne.error.RequestNotAllowed)","user":{"login":"backbord","id":6814946,"node_id":"MDQ6VXNlcjY4MTQ5NDY=","avatar_url":"https://avatars.githubusercontent.com/u/6814946?v=4","gravatar_id":"","url":"https://api.github.com/users/backbord","html_url":"https://github.com/backbord","followers_url":"https://api.github.com/users/backbord/followers","following_url":"https://api.github.com/users/backbord/following{/other_user}","gists_url":"https://api.github.com/users/backbord/gists{/gist_id}","starred_url":"https://api.github.com/users/backbord/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/backbord/subscriptions","organizations_url":"https://api.github.com/users/backbord/orgs","repos_url":"https://api.github.com/users/backbord/repos","events_url":"https://api.github.com/users/backbord/events{/privacy}","received_events_url":"https://api.github.com/users/backbord/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":224849193,"node_id":"MDU6TGFiZWwyMjQ4NDkxOTM=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/type:%20bug","name":"type: bug","color":"fc2929","default":false,"description":"problem that needs to be addressed"},{"id":315571544,"node_id":"MDU6TGFiZWwzMTU1NzE1NDQ=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/type:%20regression","name":"type: regression","color":"f7c6c7","default":false,"description":"indicates a problem that was introduced in a release which was working previously"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2018-04-06T09:50:23Z","updated_at":"2018-04-07T01:12:57Z","closed_at":"2018-04-07T01:12:46Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hi,\r\n\r\nI recently update to pytest 3.5.0 and use it to test applications that use [spyne](https://github.com/arskom/spyne).\r\n\r\nUnfortunately, my tests that have code like\r\n```python\r\nimport pytest\r\nfrom spyne.errors import RequestNotAllowed, InvalidCredentialsError\r\n\r\nimport mymodule\r\n\r\ndef test_a():\r\n    with pytest.raises(RequestNotAllowed):\r\n        mymodule.func_that_raises_request_not_allowed()\r\n\r\ndef test_b():\r\n    with pytest.raises(InvalidCredentialsError):\r\n        mymodule.func_that_raises_invalid_credentials_error()\r\n```\r\nnow break in the lines starting on `with pytest.raises` and give a traceback similar to this one:\r\n```\r\n___ test_detect_replay_nonce[example_forecast.xml.gz] ___\r\n\r\n    def test_a():\r\n>       with pytest.raises(RequestNotAllowed):\r\n\r\ntests/test_client.py:130: \r\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \r\n/foobar/lib/python3.6/site-packages/_pytest/python_api.py:587: in raises\r\n    for exc in filterfalse(isclass, always_iterable(expected_exception)):\r\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \r\nself = <class 'spyne.error.RequestNotAllowed'>, item = 0\r\n\r\n    def __getitem__(self, item):\r\n>       return self.customize(**item)\r\nE       TypeError: customize() argument after ** must be a mapping, not int\r\n\r\n/foobar/lib/python3.6/site-packages/spyne/model/_base.py:179: TypeError\r\n```\r\n\r\nThe issue didn't come up in previous versions of pytest so I dug a bit and found that\r\n- pytest.raises changed in version 3.5.0 to use `always_iterable`,\r\n- the exception classes used by spyne both have a `__len__` and a `__getitem__` function,\r\n- python thinks that the exception class is iterable,\r\nand that this is the cause of these unexpected problems.\r\n\r\nI don't know whether exception classes that look iterable are generally disallowed or if this is something that should be supported/fixed in pytest.\r\nI didn't find this behavior change to be mentioned in the [changelog](https://docs.pytest.org/en/latest/changelog.html) but I may have not looked thoroughly enough.\r\n\r\nPerhaps you can advise?\r\n\r\nThanks!\r\nTim\r\n\r\n----\r\nHere is some IPython output from my digging:\r\n```\r\nPython 3.6.5\r\nType 'copyright', 'credits' or 'license' for more information\r\nIPython 6.3.0 -- An enhanced Interactive Python. Type '?' for help.\r\nWarning: disable autoreload in ipython_config.py to improve performance.\r\n\r\nIn [1]: from spyne.error import InvalidCredentialsError\r\n\r\nIn [2]: hasattr(InvalidCredentialsError, '__getitem__')\r\nOut[2]: True\r\n\r\nIn [3]: hasattr(InvalidCredentialsError, '__len__')\r\nOut[3]: True\r\n\r\nIn [4]: from more_itertools.more import always_iterable\r\n\r\nIn [5]: next(always_iterable(InvalidCredentialsError))\r\n---------------------------------------------------------------------------\r\nTypeError                                 Traceback (most recent call last)\r\n<ipython-input-5-24d61822a93e> in <module>()\r\n----> 1 next(always_iterable(InvalidCredentialsError))\r\n\r\n/foobar/lib/python3.6/site-packages/spyne/model/_base.py in __getitem__(self, item)\r\n    177 class ModelBaseMeta(type(object)):\r\n    178     def __getitem__(self, item):\r\n--> 179         return self.customize(**item)\r\n    180\r\n    181     def customize(self, **kwargs):\r\n\r\nTypeError: customize() argument after ** must be a mapping, not int\r\n```\r\n\r\n`always_iterable` attempts to create an iterable by executing\r\n```python\r\ntry:\r\n    return iter(obj)\r\nexcept TypeError:\r\n    return iter((obj,))\r\n```\r\n\r\n```\r\nIn [6]: next(iter(InvalidCredentialsError))\r\n---------------------------------------------------------------------------\r\nTypeError                                 Traceback (most recent call last)\r\n<ipython-input-6-5759e2f7cde0> in <module>()\r\n----> 1 next(iter(InvalidCredentialsError))\r\n\r\n/foobar/lib/python3.6/site-packages/spyne/model/_base.py in __getitem__(self, item)\r\n    177 class ModelBaseMeta(type(object)):\r\n    178     def __getitem__(self, item):\r\n--> 179         return self.customize(**item)\r\n    180\r\n    181     def customize(self, **kwargs):\r\n\r\nTypeError: customize() argument after ** must be a mapping, not int\r\n```\r\n\r\nI'm using\r\n- python 3.6.5\r\n- pytest 3.5.0\r\n- spyne 2.12.14\r\n\r\nIt works in pytest 3.4.2 where `always_iterable` isn't used in function`raises` of `_pytest/python_api.py`.","closed_by":{"login":"nicoddemus","id":1085180,"node_id":"MDQ6VXNlcjEwODUxODA=","avatar_url":"https://avatars.githubusercontent.com/u/1085180?v=4","gravatar_id":"","url":"https://api.github.com/users/nicoddemus","html_url":"https://github.com/nicoddemus","followers_url":"https://api.github.com/users/nicoddemus/followers","following_url":"https://api.github.com/users/nicoddemus/following{/other_user}","gists_url":"https://api.github.com/users/nicoddemus/gists{/gist_id}","starred_url":"https://api.github.com/users/nicoddemus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicoddemus/subscriptions","organizations_url":"https://api.github.com/users/nicoddemus/orgs","repos_url":"https://api.github.com/users/nicoddemus/repos","events_url":"https://api.github.com/users/nicoddemus/events{/privacy}","received_events_url":"https://api.github.com/users/nicoddemus/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/3372/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pytest-dev/pytest/issues/3372/timeline","performed_via_github_app":null,"state_reason":"completed"}