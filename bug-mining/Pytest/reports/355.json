{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/10337","repository_url":"https://api.github.com/repos/pytest-dev/pytest","labels_url":"https://api.github.com/repos/pytest-dev/pytest/issues/10337/labels{/name}","comments_url":"https://api.github.com/repos/pytest-dev/pytest/issues/10337/comments","events_url":"https://api.github.com/repos/pytest-dev/pytest/issues/10337/events","html_url":"https://github.com/pytest-dev/pytest/issues/10337","id":1396604908,"node_id":"I_kwDOAjwLdc5TPn_s","number":10337,"title":"AttributeError: Test modules cannot use parent module's attributes under `--import-mode=importlib`","user":{"login":"akhilramkee","id":31619526,"node_id":"MDQ6VXNlcjMxNjE5NTI2","avatar_url":"https://avatars.githubusercontent.com/u/31619526?v=4","gravatar_id":"","url":"https://api.github.com/users/akhilramkee","html_url":"https://github.com/akhilramkee","followers_url":"https://api.github.com/users/akhilramkee/followers","following_url":"https://api.github.com/users/akhilramkee/following{/other_user}","gists_url":"https://api.github.com/users/akhilramkee/gists{/gist_id}","starred_url":"https://api.github.com/users/akhilramkee/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/akhilramkee/subscriptions","organizations_url":"https://api.github.com/users/akhilramkee/orgs","repos_url":"https://api.github.com/users/akhilramkee/repos","events_url":"https://api.github.com/users/akhilramkee/events{/privacy}","received_events_url":"https://api.github.com/users/akhilramkee/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":224849193,"node_id":"MDU6TGFiZWwyMjQ4NDkxOTM=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/type:%20bug","name":"type: bug","color":"fc2929","default":false,"description":"problem that needs to be addressed"},{"id":240511492,"node_id":"MDU6TGFiZWwyNDA1MTE0OTI=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/topic:%20collection","name":"topic: collection","color":"006b75","default":false,"description":"related to the collection phase"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-10-04T17:19:25Z","updated_at":"2023-07-01T18:54:21Z","closed_at":"2023-07-01T15:12:43Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\nThanks for submitting an issue!\r\n\r\nQuick check-list while reporting bugs:\r\n-->\r\n\r\n- [x] a detailed description of the bug or problem you are having\r\n- [ ] output of `pip list` from the virtual environment you are using\r\n- [x] pytest and operating system versions\r\n- [x] minimal example if possible\r\n\r\n**Description of the bug:**\r\nPytest when executed under `--import-mode=importlib` doesn't try to retain the child module as parent module's attribute if parent module is already in `sys.path`. This started happening in pytest 7.1.3 after enabling doctest to respect `import-mode` in https://github.com/pytest-dev/pytest/pull/10088. \r\n\r\n**Minimal Example**\r\n\r\n**File structure**\r\n```\r\npytest_importlib_issue/\r\n├── __init__.py\r\n├── temp.py\r\n└── tests/\r\n    └── test_temp.py\r\n```\r\n**temp.py**\r\n```\r\ndef x():\r\n    \"\"\"\r\n    >>> assert 1==1\r\n    \"\"\"\r\n    return 2\r\n```\r\n\r\n**test_temp.py**\r\n```\r\nimport pytest_importlib_issue\r\nfrom pytest_importlib_issue import temp\r\n\r\ndef test_x():\r\n    assert temp.x() == 2\r\n    assert pytest_importlib_issue.temp.x() == 2\r\n```\r\n\r\n**Output** - MacOS 12.6\r\n\r\n**pytest7.1.3 without importlib**\r\n```\r\n(pytest7.1.3) akhileshr@Akhileshs-MacBook-Air /tmp % pytest pytest_importlib_issue --doctest-modules                                       \r\n============================================================================================================ test session starts =============================================================================================================\r\nplatform darwin -- Python 3.9.10, pytest-7.1.3, pluggy-0.13.1\r\nrootdir: /private/tmp\r\nplugins: anyio-3.5.0, xdist-2.2.1, easyread-0.1.0, forked-1.3.0\r\ncollected 2 items                                                                                                                                                                                                                            \r\n\r\npytest_importlib_issue/temp.py .                                                                                                                                                                                                       [ 50%]\r\npytest_importlib_issue/tests/test_temp.py .                                                                                                                                                                                            [100%]\r\n\r\n============================================================================================================= 2 passed in 0.03s ==============================================================================================================\r\n```\r\n\r\n**pytest-7.1.3 with importlib**\r\n```\r\n(pytest7.1.3) akhileshr@Akhileshs-MacBook-Air /tmp % pytest pytest_importlib_issue --import-mode=importlib --doctest-modules                                             \r\n============================================================================================================ test session starts =============================================================================================================\r\nplatform darwin -- Python 3.9.10, pytest-7.1.3, pluggy-0.13.1\r\nrootdir: /private/tmp\r\nplugins: anyio-3.5.0, xdist-2.2.1, easyread-0.1.0, forked-1.3.0\r\ncollected 2 items                                                                                                                                                                                                                            \r\n\r\npytest_importlib_issue/temp.py .                                                                                                                                                                                                       [ 50%]\r\npytest_importlib_issue/tests/test_temp.py F                                                                                                                                                                                            [100%]\r\n\r\n================================================================================================================== FAILURES ==================================================================================================================\r\n___________________________________________________________________________________________________________________ test_x ___________________________________________________________________________________________________________________\r\n\r\n    def test_x():\r\n        assert temp.x() == 2\r\n>       assert pytest_importlib_issue.temp.x() == 2\r\nE       AttributeError: module 'pytest_importlib_issue' has no attribute 'temp'\r\n\r\npytest_importlib_issue/tests/test_temp.py:6: AttributeError\r\n========================================================================================================== short test summary info ===========================================================================================================\r\nFAILED pytest_importlib_issue/tests/test_temp.py::test_x - AttributeError: module 'pytest_importlib_issue' has no attribute 'temp'\r\n======================================================================================================== 1 failed, 1 passed in 0.08s =========================================================================================================\r\n```\r\n\r\nIt could be seen that the failure happens when we try to access the child module through parent module.\r\n\r\n**pytest-7.0.1 with importlib**\r\n\r\n```\r\n(pytest7.0.1) akhileshr@Akhileshs-MacBook-Air /tmp % pytest pytest_importlib_issue --import-mode=importlib --doctest-modules\r\n============================================================================================================ test session starts =============================================================================================================\r\nplatform darwin -- Python 3.9.10, pytest-7.0.1, pluggy-0.13.1\r\nrootdir: /private/tmp\r\nplugins: anyio-3.5.0, xdist-2.2.1, easyread-0.1.0, forked-1.3.0\r\ncollected 2 items                                                                                                                                                                                                                            \r\n\r\npytest_importlib_issue/temp.py .                                                                                                                                                                                                       [ 50%]\r\npytest_importlib_issue/tests/test_temp.py .                                                                                                                                                                                            [100%]\r\n\r\n============================================================================================================= 2 passed in 0.03s ==============================================================================================================\r\n```\r\n\r\nThis passes, because doctest-modules were using `prepend` instead of `importlib` before the PR. ( added this to state this is a recent issue ).\r\n\r\n**Fix**: Child module has to be persisted in Parent module as an attribute similar to how `importlib.import_module` does.\r\n","closed_by":{"login":"nicoddemus","id":1085180,"node_id":"MDQ6VXNlcjEwODUxODA=","avatar_url":"https://avatars.githubusercontent.com/u/1085180?v=4","gravatar_id":"","url":"https://api.github.com/users/nicoddemus","html_url":"https://github.com/nicoddemus","followers_url":"https://api.github.com/users/nicoddemus/followers","following_url":"https://api.github.com/users/nicoddemus/following{/other_user}","gists_url":"https://api.github.com/users/nicoddemus/gists{/gist_id}","starred_url":"https://api.github.com/users/nicoddemus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicoddemus/subscriptions","organizations_url":"https://api.github.com/users/nicoddemus/orgs","repos_url":"https://api.github.com/users/nicoddemus/repos","events_url":"https://api.github.com/users/nicoddemus/events{/privacy}","received_events_url":"https://api.github.com/users/nicoddemus/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/10337/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pytest-dev/pytest/issues/10337/timeline","performed_via_github_app":null,"state_reason":"completed"}