{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/8796","repository_url":"https://api.github.com/repos/pytest-dev/pytest","labels_url":"https://api.github.com/repos/pytest-dev/pytest/issues/8796/labels{/name}","comments_url":"https://api.github.com/repos/pytest-dev/pytest/issues/8796/comments","events_url":"https://api.github.com/repos/pytest-dev/pytest/issues/8796/events","html_url":"https://github.com/pytest-dev/pytest/issues/8796","id":930269339,"node_id":"MDU6SXNzdWU5MzAyNjkzMzk=","number":8796,"title":"Internal error when adding a skip mark to a doctest inside a contextmanager","user":{"login":"lesteve","id":1680079,"node_id":"MDQ6VXNlcjE2ODAwNzk=","avatar_url":"https://avatars.githubusercontent.com/u/1680079?v=4","gravatar_id":"","url":"https://api.github.com/users/lesteve","html_url":"https://github.com/lesteve","followers_url":"https://api.github.com/users/lesteve/followers","following_url":"https://api.github.com/users/lesteve/following{/other_user}","gists_url":"https://api.github.com/users/lesteve/gists{/gist_id}","starred_url":"https://api.github.com/users/lesteve/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lesteve/subscriptions","organizations_url":"https://api.github.com/users/lesteve/orgs","repos_url":"https://api.github.com/users/lesteve/repos","events_url":"https://api.github.com/users/lesteve/events{/privacy}","received_events_url":"https://api.github.com/users/lesteve/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":224849193,"node_id":"MDU6TGFiZWwyMjQ4NDkxOTM=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/type:%20bug","name":"type: bug","color":"fc2929","default":false,"description":"problem that needs to be addressed"},{"id":240592808,"node_id":"MDU6TGFiZWwyNDA1OTI4MDg=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/plugin:%20doctests","name":"plugin: doctests","color":"fad8c7","default":false,"description":"related to the doctests builtin plugin"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2021-06-25T15:15:20Z","updated_at":"2021-11-01T07:01:27Z","closed_at":"2021-11-01T07:01:27Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"To reproduce:\r\n\r\n```py\r\n# conftest.py\r\nimport pytest\r\nfrom _pytest.doctest import DoctestItem\r\n\r\n\r\ndef pytest_collection_modifyitems(config, items):\r\n    skip_marker = pytest.mark.skip(reason='Skipping doctests')\r\n\r\n    for item in items:\r\n        if isinstance(item, DoctestItem):\r\n            item.add_marker(skip_marker)\r\n```\r\n\r\n```py\r\n# test.py\r\nfrom contextlib import contextmanager\r\n\r\n@contextmanager\r\ndef my_config_context():\r\n    \"\"\"\r\n    >>> import os\r\n    \"\"\"\r\n```\r\n\r\n```\r\n❯ pytest test.py --doctest-modules\r\n=========================================================== test session starts ============================================================\r\nplatform linux -- Python 3.9.5, pytest-6.2.4, py-1.10.0, pluggy-0.13.1\r\nrootdir: /tmp\r\ncollected 1 item                                                                                                                           \r\n\r\ntest.py \r\nINTERNALERROR> Traceback (most recent call last):\r\nINTERNALERROR>   File \"/home/lesteve/miniconda3/envs/test/lib/python3.9/site-packages/_pytest/main.py\", line 269, in wrap_session\r\nINTERNALERROR>     session.exitstatus = doit(config, session) or 0\r\nINTERNALERROR>   File \"/home/lesteve/miniconda3/envs/test/lib/python3.9/site-packages/_pytest/main.py\", line 323, in _main\r\nINTERNALERROR>     config.hook.pytest_runtestloop(session=session)\r\nINTERNALERROR>   File \"/home/lesteve/miniconda3/envs/test/lib/python3.9/site-packages/pluggy/hooks.py\", line 286, in __call__\r\nINTERNALERROR>     return self._hookexec(self, self.get_hookimpls(), kwargs)\r\nINTERNALERROR>   File \"/home/lesteve/miniconda3/envs/test/lib/python3.9/site-packages/pluggy/manager.py\", line 93, in _hookexec\r\nINTERNALERROR>     return self._inner_hookexec(hook, methods, kwargs)\r\nINTERNALERROR>   File \"/home/lesteve/miniconda3/envs/test/lib/python3.9/site-packages/pluggy/manager.py\", line 84, in <lambda>\r\nINTERNALERROR>     self._inner_hookexec = lambda hook, methods, kwargs: hook.multicall(\r\nINTERNALERROR>   File \"/home/lesteve/miniconda3/envs/test/lib/python3.9/site-packages/pluggy/callers.py\", line 208, in _multicall\r\nINTERNALERROR>     return outcome.get_result()\r\nINTERNALERROR>   File \"/home/lesteve/miniconda3/envs/test/lib/python3.9/site-packages/pluggy/callers.py\", line 80, in get_result\r\nINTERNALERROR>     raise ex[1].with_traceback(ex[2])\r\nINTERNALERROR>   File \"/home/lesteve/miniconda3/envs/test/lib/python3.9/site-packages/pluggy/callers.py\", line 187, in _multicall\r\nINTERNALERROR>     res = hook_impl.function(*args)\r\nINTERNALERROR>   File \"/home/lesteve/miniconda3/envs/test/lib/python3.9/site-packages/_pytest/main.py\", line 348, in pytest_runtestloop\r\nINTERNALERROR>     item.config.hook.pytest_runtest_protocol(item=item, nextitem=nextitem)\r\nINTERNALERROR>   File \"/home/lesteve/miniconda3/envs/test/lib/python3.9/site-packages/pluggy/hooks.py\", line 286, in __call__\r\nINTERNALERROR>     return self._hookexec(self, self.get_hookimpls(), kwargs)\r\nINTERNALERROR>   File \"/home/lesteve/miniconda3/envs/test/lib/python3.9/site-packages/pluggy/manager.py\", line 93, in _hookexec\r\nINTERNALERROR>     return self._inner_hookexec(hook, methods, kwargs)\r\nINTERNALERROR>   File \"/home/lesteve/miniconda3/envs/test/lib/python3.9/site-packages/pluggy/manager.py\", line 84, in <lambda>\r\nINTERNALERROR>     self._inner_hookexec = lambda hook, methods, kwargs: hook.multicall(\r\nINTERNALERROR>   File \"/home/lesteve/miniconda3/envs/test/lib/python3.9/site-packages/pluggy/callers.py\", line 208, in _multicall\r\nINTERNALERROR>     return outcome.get_result()\r\nINTERNALERROR>   File \"/home/lesteve/miniconda3/envs/test/lib/python3.9/site-packages/pluggy/callers.py\", line 80, in get_result\r\nINTERNALERROR>     raise ex[1].with_traceback(ex[2])\r\nINTERNALERROR>   File \"/home/lesteve/miniconda3/envs/test/lib/python3.9/site-packages/pluggy/callers.py\", line 187, in _multicall\r\nINTERNALERROR>     res = hook_impl.function(*args)\r\nINTERNALERROR>   File \"/home/lesteve/miniconda3/envs/test/lib/python3.9/site-packages/_pytest/runner.py\", line 109, in pytest_runtest_protocol\r\nINTERNALERROR>     runtestprotocol(item, nextitem=nextitem)\r\nINTERNALERROR>   File \"/home/lesteve/miniconda3/envs/test/lib/python3.9/site-packages/_pytest/runner.py\", line 120, in runtestprotocol\r\nINTERNALERROR>     rep = call_and_report(item, \"setup\", log)\r\nINTERNALERROR>   File \"/home/lesteve/miniconda3/envs/test/lib/python3.9/site-packages/_pytest/runner.py\", line 217, in call_and_report\r\nINTERNALERROR>     report: TestReport = hook.pytest_runtest_makereport(item=item, call=call)\r\nINTERNALERROR>   File \"/home/lesteve/miniconda3/envs/test/lib/python3.9/site-packages/pluggy/hooks.py\", line 286, in __call__\r\nINTERNALERROR>     return self._hookexec(self, self.get_hookimpls(), kwargs)\r\nINTERNALERROR>   File \"/home/lesteve/miniconda3/envs/test/lib/python3.9/site-packages/pluggy/manager.py\", line 93, in _hookexec\r\nINTERNALERROR>     return self._inner_hookexec(hook, methods, kwargs)\r\nINTERNALERROR>   File \"/home/lesteve/miniconda3/envs/test/lib/python3.9/site-packages/pluggy/manager.py\", line 84, in <lambda>\r\nINTERNALERROR>     self._inner_hookexec = lambda hook, methods, kwargs: hook.multicall(\r\nINTERNALERROR>   File \"/home/lesteve/miniconda3/envs/test/lib/python3.9/site-packages/pluggy/callers.py\", line 203, in _multicall\r\nINTERNALERROR>     gen.send(outcome)\r\nINTERNALERROR>   File \"/home/lesteve/miniconda3/envs/test/lib/python3.9/site-packages/_pytest/skipping.py\", line 314, in pytest_runtest_makereport\r\nINTERNALERROR>     assert line is not None\r\nINTERNALERROR> AssertionError\r\n\r\n========================================================== no tests ran in 0.01s ===========================================================\r\n```\r\n\r\nThis is a simplified issue from a real use case in the scikit-learn repo. We sometimes want to skip doctests, for example when matplotlib (an optional dependency) is not installed. If there is be a better way to do it with pytest than using `pytest_collection_modifyitems`, let me know.\r\n\r\n<details>\r\n<summary>conda list output</summary>\r\n\r\n```\r\n❯ conda list\r\n# packages in environment at /home/lesteve/miniconda3/envs/test:\r\n#\r\n# Name                    Version                   Build  Channel\r\n_libgcc_mutex             0.1                        main  \r\n_openmp_mutex             4.5                       1_gnu  \r\nattrs                     21.2.0             pyhd3eb1b0_0  \r\nca-certificates           2021.5.25            h06a4308_1  \r\ncertifi                   2021.5.30        py39h06a4308_0  \r\niniconfig                 1.1.1              pyhd3eb1b0_0  \r\nld_impl_linux-64          2.35.1               h7274673_9  \r\nlibffi                    3.3                  he6710b0_2  \r\nlibgcc-ng                 9.3.0               h5101ec6_17  \r\nlibgomp                   9.3.0               h5101ec6_17  \r\nlibstdcxx-ng              9.3.0               hd4cf53a_17  \r\nmore-itertools            8.8.0              pyhd3eb1b0_0  \r\nncurses                   6.2                  he6710b0_1  \r\nopenssl                   1.1.1k               h27cfd23_0  \r\npackaging                 20.9               pyhd3eb1b0_0  \r\npip                       21.1.2           py39h06a4308_0  \r\npluggy                    0.13.1           py39h06a4308_0  \r\npy                        1.10.0             pyhd3eb1b0_0  \r\npyparsing                 2.4.7              pyhd3eb1b0_0  \r\npytest                    6.2.4            py39h06a4308_2  \r\npython                    3.9.5                h12debd9_4  \r\nreadline                  8.1                  h27cfd23_0  \r\nsetuptools                52.0.0           py39h06a4308_0  \r\nsix                       1.16.0             pyhd3eb1b0_0  \r\nsqlite                    3.36.0               hc218d9a_0  \r\ntk                        8.6.10               hbc83047_0  \r\ntoml                      0.10.2             pyhd3eb1b0_0  \r\ntzdata                    2021a                h52ac0ba_0  \r\nwheel                     0.36.2             pyhd3eb1b0_0  \r\nxz                        5.2.5                h7b6447c_0  \r\nzlib                      1.2.11               h7b6447c_3  \r\n```\r\n\r\n</details>","closed_by":{"login":"bluetech","id":1223550,"node_id":"MDQ6VXNlcjEyMjM1NTA=","avatar_url":"https://avatars.githubusercontent.com/u/1223550?v=4","gravatar_id":"","url":"https://api.github.com/users/bluetech","html_url":"https://github.com/bluetech","followers_url":"https://api.github.com/users/bluetech/followers","following_url":"https://api.github.com/users/bluetech/following{/other_user}","gists_url":"https://api.github.com/users/bluetech/gists{/gist_id}","starred_url":"https://api.github.com/users/bluetech/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bluetech/subscriptions","organizations_url":"https://api.github.com/users/bluetech/orgs","repos_url":"https://api.github.com/users/bluetech/repos","events_url":"https://api.github.com/users/bluetech/events{/privacy}","received_events_url":"https://api.github.com/users/bluetech/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/8796/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pytest-dev/pytest/issues/8796/timeline","performed_via_github_app":null,"state_reason":"completed"}