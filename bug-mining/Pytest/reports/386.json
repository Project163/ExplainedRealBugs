{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/11603","repository_url":"https://api.github.com/repos/pytest-dev/pytest","labels_url":"https://api.github.com/repos/pytest-dev/pytest/issues/11603/labels{/name}","comments_url":"https://api.github.com/repos/pytest-dev/pytest/issues/11603/comments","events_url":"https://api.github.com/repos/pytest-dev/pytest/issues/11603/events","html_url":"https://github.com/pytest-dev/pytest/issues/11603","id":1986305123,"node_id":"I_kwDOAjwLdc52ZJxj","number":11603,"title":"TestLocalPath.test_make_numbered_dir_multiprocess_safe sometimes fails with py.error.EEXIST: [File exists]","user":{"login":"hroncok","id":2401856,"node_id":"MDQ6VXNlcjI0MDE4NTY=","avatar_url":"https://avatars.githubusercontent.com/u/2401856?v=4","gravatar_id":"","url":"https://api.github.com/users/hroncok","html_url":"https://github.com/hroncok","followers_url":"https://api.github.com/users/hroncok/followers","following_url":"https://api.github.com/users/hroncok/following{/other_user}","gists_url":"https://api.github.com/users/hroncok/gists{/gist_id}","starred_url":"https://api.github.com/users/hroncok/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hroncok/subscriptions","organizations_url":"https://api.github.com/users/hroncok/orgs","repos_url":"https://api.github.com/users/hroncok/repos","events_url":"https://api.github.com/users/hroncok/events{/privacy}","received_events_url":"https://api.github.com/users/hroncok/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":27,"created_at":"2023-11-09T19:54:44Z","updated_at":"2023-11-14T14:41:37Z","closed_at":"2023-11-14T14:41:37Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\nThanks for submitting an issue!\r\n\r\nQuick check-list while reporting bugs:\r\n-->\r\n\r\nHello. I've noticed recently that the Fedora build system nudges me that pytest fails to build every now and then. This has been happening with 7.4.2 and I've managed to reproduce with 7.4.3 as well.\r\n\r\nThe failure always looks like this:\r\n\r\n```\r\n+ PYTEST_XDIST_AUTO_NUM_WORKERS=5\r\n+ /builddir/build/BUILDROOT/pytest-7.4.3-1.fc40.i386/usr/bin/pytest testing --timeout=30 -n auto -rs\r\n============================= test session starts ==============================\r\nplatform linux -- Python 3.12.0, pytest-7.4.3, pluggy-1.3.0\r\nrootdir: /builddir/build/BUILD/pytest-7.4.3\r\nconfigfile: pyproject.toml\r\nplugins: hypothesis-6.82.0, timeout-2.2.0, xdist-3.3.1\r\ntimeout: 30.0s\r\ntimeout method: signal\r\ntimeout func_only: False\r\ncreated: 5/5 workers\r\n5 workers [3468 items]\r\n...\r\n=================================== FAILURES ===================================\r\n____________ TestLocalPath.test_make_numbered_dir_multiprocess_safe ____________\r\n[gw4] linux -- Python 3.12.0 /usr/bin/python3\r\nmultiprocessing.pool.RemoteTraceback: \r\n\"\"\"\r\nTraceback (most recent call last):\r\n  File \"/builddir/build/BUILDROOT/pytest-7.4.3-1.fc40.i386/usr/lib/python3.12/site-packages/_pytest/_py/error.py\", line 85, in checked_call\r\n    return func(*args, **kwargs)\r\n           ^^^^^^^^^^^^^^^^^^^^^\r\nFileExistsError: [Errno 17] File exists: '/tmp/pytest-of-mockbuild/pytest-0/popen-gw4/test_make_numbered_dir_multipr0/repro-1229'\r\nDuring handling of the above exception, another exception occurred:\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python3.12/multiprocessing/pool.py\", line 125, in worker\r\n    result = (True, func(*args, **kwds))\r\n                    ^^^^^^^^^^^^^^^^^^^\r\n  File \"/builddir/build/BUILD/pytest-7.4.3/testing/_py/test_local.py\", line 550, in batch_make_numbered_dirs\r\n    dir_ = local.make_numbered_dir(prefix=\"repro-\", rootdir=rootdir)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/builddir/build/BUILDROOT/pytest-7.4.3-1.fc40.i386/usr/lib/python3.12/site-packages/_pytest/_py/path.py\", line 1342, in make_numbered_dir\r\n    udir = rootdir.mkdir(prefix + str(maxnum + 1))\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/builddir/build/BUILDROOT/pytest-7.4.3-1.fc40.i386/usr/lib/python3.12/site-packages/_pytest/_py/path.py\", line 887, in mkdir\r\n    error.checked_call(os.mkdir, os.fspath(p))\r\n  File \"/builddir/build/BUILDROOT/pytest-7.4.3-1.fc40.i386/usr/lib/python3.12/site-packages/_pytest/_py/error.py\", line 101, in checked_call\r\n    raise cls(f\"{func.__name__}{args!r}\")\r\npy.error.EEXIST: [File exists]: mkdir('/tmp/pytest-of-mockbuild/pytest-0/popen-gw4/test_make_numbered_dir_multipr0/repro-1229',)\r\n\"\"\"\r\nThe above exception was the direct cause of the following exception:\r\nself = <test_local.TestLocalPath object at 0xf50227c8>\r\ntmpdir = local('/tmp/pytest-of-mockbuild/pytest-0/popen-gw4/test_make_numbered_dir_multipr0')\r\n    def test_make_numbered_dir_multiprocess_safe(self, tmpdir):\r\n        # https://github.com/pytest-dev/py/issues/30\r\n        with multiprocessing.Pool() as pool:\r\n            results = [\r\n                pool.apply_async(batch_make_numbered_dirs, [tmpdir, 100])\r\n                for _ in range(20)\r\n            ]\r\n            for r in results:\r\n>               assert r.get()\r\n/builddir/build/BUILD/pytest-7.4.3/testing/_py/test_local.py:879: \r\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \r\nself = <multiprocessing.pool.ApplyResult object at 0xf4c5fe40>, timeout = None\r\n    def get(self, timeout=None):\r\n        self.wait(timeout)\r\n        if not self.ready():\r\n            raise TimeoutError\r\n        if self._success:\r\n            return self._value\r\n        else:\r\n>           raise self._value\r\nE           py.error.EEXIST: [File exists]: mkdir('/tmp/pytest-of-mockbuild/pytest-0/popen-gw4/test_make_numbered_dir_multipr0/repro-1229',)\r\n/usr/lib/python3.12/multiprocessing/pool.py:774: EEXIST\r\n...\r\n= 1 failed, 3414 passed, 35 skipped, 12 xfailed, 6 xpassed in 65.16s (0:01:05) =\r\n```\r\n\r\nHowever, the number in `repro-868` changes.\r\n\r\nWhen I submit 10 builds in the Fedora builders, usually at least one or two of them fail this way.\r\n\r\nExample logs:\r\n\r\n - [build.log.txt](https://github.com/pytest-dev/pytest/files/13312202/build.log.txt)\r\n - [root.log.txt](https://github.com/pytest-dev/pytest/files/13312203/root.log.txt) (includes versions of packages)\r\n\r\nThe [first occurrence](https://koschei.fedoraproject.org/build/16415413) I can recall (with build logs already garbage collected) was on 2023-09-29.\r\n\r\nThe above log is from i686 builder, but I've also seen it on x86_64 or ppc64le.\r\n\r\nI assumed the test is flaky, but considering this partiular test tests this does not happen, I am afraid something is broken.\r\n\r\nHowever, I've been unable to reproduce this yet outside of our build environment.\r\n\r\nI think there is a race condition somewhere, but I am out of my depth currently.","closed_by":{"login":"nicoddemus","id":1085180,"node_id":"MDQ6VXNlcjEwODUxODA=","avatar_url":"https://avatars.githubusercontent.com/u/1085180?v=4","gravatar_id":"","url":"https://api.github.com/users/nicoddemus","html_url":"https://github.com/nicoddemus","followers_url":"https://api.github.com/users/nicoddemus/followers","following_url":"https://api.github.com/users/nicoddemus/following{/other_user}","gists_url":"https://api.github.com/users/nicoddemus/gists{/gist_id}","starred_url":"https://api.github.com/users/nicoddemus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicoddemus/subscriptions","organizations_url":"https://api.github.com/users/nicoddemus/orgs","repos_url":"https://api.github.com/users/nicoddemus/repos","events_url":"https://api.github.com/users/nicoddemus/events{/privacy}","received_events_url":"https://api.github.com/users/nicoddemus/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/11603/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pytest-dev/pytest/issues/11603/timeline","performed_via_github_app":null,"state_reason":"completed"}