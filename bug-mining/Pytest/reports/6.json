{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/2957","repository_url":"https://api.github.com/repos/pytest-dev/pytest","labels_url":"https://api.github.com/repos/pytest-dev/pytest/issues/2957/labels{/name}","comments_url":"https://api.github.com/repos/pytest-dev/pytest/issues/2957/comments","events_url":"https://api.github.com/repos/pytest-dev/pytest/issues/2957/events","html_url":"https://github.com/pytest-dev/pytest/issues/2957","id":277223048,"node_id":"MDU6SXNzdWUyNzcyMjMwNDg=","number":2957,"title":"3.3.0 parametrized node IDs are not ACSII escaped :: breaks PYTEST_CURRENT_TEST in Python 3","user":{"login":"mattsb42-aws","id":23565203,"node_id":"MDQ6VXNlcjIzNTY1MjAz","avatar_url":"https://avatars.githubusercontent.com/u/23565203?v=4","gravatar_id":"","url":"https://api.github.com/users/mattsb42-aws","html_url":"https://github.com/mattsb42-aws","followers_url":"https://api.github.com/users/mattsb42-aws/followers","following_url":"https://api.github.com/users/mattsb42-aws/following{/other_user}","gists_url":"https://api.github.com/users/mattsb42-aws/gists{/gist_id}","starred_url":"https://api.github.com/users/mattsb42-aws/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattsb42-aws/subscriptions","organizations_url":"https://api.github.com/users/mattsb42-aws/orgs","repos_url":"https://api.github.com/users/mattsb42-aws/repos","events_url":"https://api.github.com/users/mattsb42-aws/events{/privacy}","received_events_url":"https://api.github.com/users/mattsb42-aws/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":224849193,"node_id":"MDU6TGFiZWwyMjQ4NDkxOTM=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/type:%20bug","name":"type: bug","color":"fc2929","default":false,"description":"problem that needs to be addressed"},{"id":224853076,"node_id":"MDU6TGFiZWwyMjQ4NTMwNzY=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/topic:%20reporting","name":"topic: reporting","color":"fef2c0","default":false,"description":"related to terminal output and user-facing messages and errors"},{"id":265779499,"node_id":"MDU6TGFiZWwyNjU3Nzk0OTk=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/status:%20critical","name":"status: critical","color":"e11d21","default":false,"description":"grave problem or usability issue that affects lots of users"},{"id":315571544,"node_id":"MDU6TGFiZWwzMTU1NzE1NDQ=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/type:%20regression","name":"type: regression","color":"f7c6c7","default":false,"description":"indicates a problem that was introduced in a release which was working previously"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2017-11-28T01:02:58Z","updated_at":"2017-12-06T00:25:31Z","closed_at":"2017-11-29T05:57:48Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Problem\r\nWith `3.3.0`, it appears that there were some conflicting changes in the formatting of parametrized node IDs which results in errors in Python 3 if the parametrized values contain null bytes.\r\n\r\nI noticed this behavior because setting the `PYTEST_CURRENT_TEST` environment variable now fails in Python 3 in this scenario. Digging deeper, it appears that the immediate reason for this error is [this commit](https://github.com/pytest-dev/pytest/commit/7703dc921ccdafb65cd32bc4b9ec4d266e2538da#diff-e1a5c52f502faf325466018a5440c400) that indicates that ascii escaping is no longer necessary because it is sanitized during the parametrization process.\r\n\r\nHowever, looking at the values that it attempts to write to the environment variable and the formatted names for the parametrized tests, it would appear that the parametrized node ID is not actually being ASCII sanitized.\r\n\r\n## Details\r\n\r\n### OS\r\n`Darwin 186590df9307.ant.amazon.com 16.7.0 Darwin Kernel Version 16.7.0: Wed Oct  4 00:17:00 PDT 2017; root:xnu-3789.71.6~1/RELEASE_X86_64 x86_64`\r\n\r\n### Isolated test code\r\n```\r\n@pytest.mark.parametrize('plaintext_source, b64_plaintext_with_whitespace, read_bytes', (\r\n    (b'\\x00\\x00\\x00', b'AAAA', 3),\r\n))\r\ndef test_base64io_decode_parametrized_null_bytes(plaintext_source, b64_plaintext_with_whitespace, read_bytes):\r\n    with Base64IO(io.BytesIO(b64_plaintext_with_whitespace)) as decoder:\r\n        test = decoder.read(read_bytes)\r\n\r\n    assert test == plaintext_source[:read_bytes]\r\n```\r\n\r\n### Test/pip list with\r\n\r\n#### pytest 3.2.5\r\n```\r\n186590df9307:aws-encryption-sdk-cli bullocm$ tox -re py36 test/unit/test_encoding.py::test_base64io_decode_parametrized_null_bytes -- -v\r\nGLOB sdist-make: /Users/bullocm/git/aws-encryption-sdk-cli/setup.py\r\npy36 recreate: /Users/bullocm/git/aws-encryption-sdk-cli/.tox/py36\r\npy36 installdeps: mock, pytest==3.2.5, pytest-catchlog, pytest-cov, pytest-mock, coverage\r\npy36 inst: /Users/bullocm/git/aws-encryption-sdk-cli/.tox/dist/aws-encryption-sdk-cli-1.1.2.zip\r\npy36 installed: asn1crypto==0.23.0,attrs==17.3.0,aws-encryption-sdk==1.3.2,aws-encryption-sdk-cli==1.1.2,boto3==1.4.8,botocore==1.8.2,cffi==1.11.2,coverage==4.4.2,cryptography==2.1.3,docutils==0.14,idna==2.6,jmespath==0.9.3,mock==2.0.0,pbr==3.1.1,py==1.5.2,pycparser==2.18,pytest==3.2.5,pytest-catchlog==1.2.2,pytest-cov==2.5.1,pytest-mock==1.6.3,python-dateutil==2.6.1,s3transfer==0.1.11,six==1.11.0,typing==3.6.2,wrapt==1.10.11\r\npy36 runtests: PYTHONHASHSEED='309851949'\r\npy36 runtests: commands[0] | coverage run -m pytest --cov aws_encryption_sdk_cli test/unit/test_encoding.py::test_base64io_decode_parametrized_null_bytes -v\r\n============================================================================================ test session starts =============================================================================================\r\nplatform darwin -- Python 3.6.2, pytest-3.2.5, py-1.5.2, pluggy-0.4.0 -- /Users/bullocm/git/aws-encryption-sdk-cli/.tox/py36/bin/python3.6\r\ncachedir: .cache\r\nrootdir: /Users/bullocm/git/aws-encryption-sdk-cli, inifile:\r\nplugins: mock-1.6.3, cov-2.5.1, catchlog-1.2.2\r\ncollected 1 item                                                                                                                                                                                              \r\n\r\ntest/unit/test_encoding.py::test_base64io_decode_parametrized_null_bytes[\\x00\\x00\\x00-AAAA-3] PASSED\r\n\r\n---------- coverage: platform darwin, python 3.6.2-final-0 -----------\r\nName                                                                                          Stmts   Miss Branch BrPart  Cover   Missing\r\n-----------------------------------------------------------------------------------------------------------------------------------------\r\n.tox/py36/lib/python3.6/site-packages/aws_encryption_sdk_cli/__init__.py                        118     89     56      0    17%   37-39, 54-59, 69-71, 84-89, 102-108, 125-147, 158-213, 232-246, 255-290\r\n.tox/py36/lib/python3.6/site-packages/aws_encryption_sdk_cli/exceptions.py                        4      0      0      0   100%\r\n.tox/py36/lib/python3.6/site-packages/aws_encryption_sdk_cli/internal/__init__.py                 1      0      0      0   100%\r\n.tox/py36/lib/python3.6/site-packages/aws_encryption_sdk_cli/internal/arg_parsing.py            182    148     56      0    14%   35-37, 51-53, 64-72, 83-86, 93-107, 125-128, 137-140, 154-358, 370-382, 393-397, 408-411, 427-445, 458-475, 489-524, 535-563\r\n.tox/py36/lib/python3.6/site-packages/aws_encryption_sdk_cli/internal/encoding.py               119     55     42      8    46%   28-30, 67, 94-95, 98, 115-119, 131, 146, 163-180, 188-189, 201-218, 230, 233, 236, 248, 268, 283, 295-300, 305-308, 313, 66->67, 93->94, 97->98, 229->230, 232->233, 235->236, 238->244, 247->248\r\n.tox/py36/lib/python3.6/site-packages/aws_encryption_sdk_cli/internal/identifiers.py             22      2      2      0    92%   18-20\r\n.tox/py36/lib/python3.6/site-packages/aws_encryption_sdk_cli/internal/io_handling.py            158    117     44      0    21%   34-36, 48-50, 59-61, 69-71, 80-91, 104-106, 121-127, 138-139, 180-187, 201-238, 251-269, 278-304, 314-348, 359-374\r\n.tox/py36/lib/python3.6/site-packages/aws_encryption_sdk_cli/internal/logging_utils.py           83     57     10      0    28%   21-23, 48-50, 60-67, 76-81, 91-99, 108-114, 123-128, 137-138, 150-151, 161, 173-181, 191-208\r\n.tox/py36/lib/python3.6/site-packages/aws_encryption_sdk_cli/internal/master_key_parsing.py      74     51     28      0    23%   31-33, 43-63, 73-75, 87-111, 133-139, 153-155, 166-177, 188-196\r\n.tox/py36/lib/python3.6/site-packages/aws_encryption_sdk_cli/internal/metadata.py                87     54     32      0    29%   29-31, 60, 71-91, 96, 101-105, 110-111, 116-124, 129, 137-141, 152, 165-186, 200-205\r\n.tox/py36/lib/python3.6/site-packages/aws_encryption_sdk_cli/internal/mypy_types.py              20      3      2      1    82%   46-49, 43->46\r\n.tox/py36/lib/python3.6/site-packages/aws_encryption_sdk_cli/key_providers.py                    31     31      4      0     0%   13-69\r\n-----------------------------------------------------------------------------------------------------------------------------------------\r\nTOTAL                                                                                           899    607    276      9    26%\r\n\r\n\r\n========================================================================================== 1 passed in 0.60 seconds ==========================================================================================\r\n__________________________________________________________________________________________________ summary ___________________________________________________________________________________________________\r\n  py36: commands succeeded\r\n  congratulations :)\r\n186590df9307:aws-encryption-sdk-cli bullocm$ source .tox/py36/bin/activate\r\n(py36) 186590df9307:aws-encryption-sdk-cli bullocm$ pip list\r\nDEPRECATION: The default format will switch to columns in the future. You can use --format=(legacy|columns) (or define a format=(legacy|columns) in your pip.conf under the [list] section) to disable this warning.\r\nasn1crypto (0.23.0)\r\nattrs (17.3.0)\r\naws-encryption-sdk (1.3.2)\r\naws-encryption-sdk-cli (1.1.2)\r\nboto3 (1.4.8)\r\nbotocore (1.8.2)\r\ncffi (1.11.2)\r\ncoverage (4.4.2)\r\ncryptography (2.1.3)\r\ndocutils (0.14)\r\nidna (2.6)\r\njmespath (0.9.3)\r\nmock (2.0.0)\r\npbr (3.1.1)\r\npip (9.0.1)\r\npy (1.5.2)\r\npycparser (2.18)\r\npytest (3.2.5)\r\npytest-catchlog (1.2.2)\r\npytest-cov (2.5.1)\r\npytest-mock (1.6.3)\r\npython-dateutil (2.6.1)\r\ns3transfer (0.1.11)\r\nsetuptools (38.2.3)\r\nsix (1.11.0)\r\ntyping (3.6.2)\r\nwheel (0.30.0)\r\nwrapt (1.10.11)\r\n```\r\n\r\n#### pytest 3.3.0\r\n```\r\n186590df9307:aws-encryption-sdk-cli bullocm$ tox -re py36 test/unit/test_encoding.py::test_base64io_decode_parametrized_null_bytes -- -v\r\nGLOB sdist-make: /Users/bullocm/git/aws-encryption-sdk-cli/setup.py\r\npy36 create: /Users/bullocm/git/aws-encryption-sdk-cli/.tox/py36\r\npy36 installdeps: mock, pytest==3.3.0, pytest-cov, pytest-mock, coverage\r\npy36 inst: /Users/bullocm/git/aws-encryption-sdk-cli/.tox/dist/aws-encryption-sdk-cli-1.1.2.zip\r\npy36 installed: asn1crypto==0.23.0,attrs==17.3.0,aws-encryption-sdk==1.3.2,aws-encryption-sdk-cli==1.1.2,boto3==1.4.8,botocore==1.8.2,cffi==1.11.2,coverage==4.4.2,cryptography==2.1.3,docutils==0.14,idna==2.6,jmespath==0.9.3,mock==2.0.0,pbr==3.1.1,pluggy==0.6.0,py==1.5.2,pycparser==2.18,pytest==3.3.0,pytest-cov==2.5.1,pytest-mock==1.6.3,python-dateutil==2.6.1,s3transfer==0.1.11,six==1.11.0,typing==3.6.2,wrapt==1.10.11\r\npy36 runtests: PYTHONHASHSEED='2217619473'\r\npy36 runtests: commands[0] | coverage run -m pytest --cov aws_encryption_sdk_cli test/unit/test_encoding.py::test_base64io_decode_parametrized_null_bytes -v\r\n============================================================================================ test session starts =============================================================================================\r\nplatform darwin -- Python 3.6.2, pytest-3.3.0, py-1.5.2, pluggy-0.6.0 -- /Users/bullocm/git/aws-encryption-sdk-cli/.tox/py36/bin/python3.6\r\ncachedir: .cache\r\nrootdir: /Users/bullocm/git/aws-encryption-sdk-cli, inifile:\r\nplugins: mock-1.6.3, cov-2.5.1\r\ncollected 1 item                                                                                                                                                                                             \r\n\r\ntest/unit/test_encoding.py::test_base64io_decode_parametrized_null_bytes[-AAAA-3] ERROR                                                                                                             [100%]\r\ntest/unit/test_encoding.py::test_base64io_decode_parametrized_null_bytes[-AAAA-3] ERROR                                                                                                             [200%]\r\n\r\n---------- coverage: platform darwin, python 3.6.2-final-0 -----------\r\nName                                                                                          Stmts   Miss Branch BrPart  Cover   Missing\r\n-----------------------------------------------------------------------------------------------------------------------------------------\r\n.tox/py36/lib/python3.6/site-packages/aws_encryption_sdk_cli/__init__.py                        118     89     56      0    17%   37-39, 54-59, 69-71, 84-89, 102-108, 125-147, 158-213, 232-246, 255-290\r\n.tox/py36/lib/python3.6/site-packages/aws_encryption_sdk_cli/exceptions.py                        4      0      0      0   100%\r\n.tox/py36/lib/python3.6/site-packages/aws_encryption_sdk_cli/internal/__init__.py                 1      0      0      0   100%\r\n.tox/py36/lib/python3.6/site-packages/aws_encryption_sdk_cli/internal/arg_parsing.py            182    148     56      0    14%   35-37, 51-53, 64-72, 83-86, 93-107, 125-128, 137-140, 154-358, 370-382, 393-397, 408-411, 427-445, 458-475, 489-524, 535-563\r\n.tox/py36/lib/python3.6/site-packages/aws_encryption_sdk_cli/internal/encoding.py               119     87     42      0    20%   28-30, 65-72, 77, 82, 93-98, 113-121, 131, 141, 146, 163-180, 188-189, 201-218, 229-261, 268, 283, 295-300, 305-308, 313\r\n.tox/py36/lib/python3.6/site-packages/aws_encryption_sdk_cli/internal/identifiers.py             22      2      2      0    92%   18-20\r\n.tox/py36/lib/python3.6/site-packages/aws_encryption_sdk_cli/internal/io_handling.py            158    117     44      0    21%   34-36, 48-50, 59-61, 69-71, 80-91, 104-106, 121-127, 138-139, 180-187, 201-238, 251-269, 278-304, 314-348, 359-374\r\n.tox/py36/lib/python3.6/site-packages/aws_encryption_sdk_cli/internal/logging_utils.py           83     57     10      0    28%   21-23, 48-50, 60-67, 76-81, 91-99, 108-114, 123-128, 137-138, 150-151, 161, 173-181, 191-208\r\n.tox/py36/lib/python3.6/site-packages/aws_encryption_sdk_cli/internal/master_key_parsing.py      74     51     28      0    23%   31-33, 43-63, 73-75, 87-111, 133-139, 153-155, 166-177, 188-196\r\n.tox/py36/lib/python3.6/site-packages/aws_encryption_sdk_cli/internal/metadata.py                87     54     32      0    29%   29-31, 60, 71-91, 96, 101-105, 110-111, 116-124, 129, 137-141, 152, 165-186, 200-205\r\n.tox/py36/lib/python3.6/site-packages/aws_encryption_sdk_cli/internal/mypy_types.py              20      3      2      1    82%   46-49, 43->46\r\n.tox/py36/lib/python3.6/site-packages/aws_encryption_sdk_cli/key_providers.py                    31     31      4      0     0%   13-69\r\n-----------------------------------------------------------------------------------------------------------------------------------------\r\nTOTAL                                                                                           899    639    276      1    23%\r\n\r\n\r\n=================================================================================================== ERRORS ===================================================================================================\r\n_________________________________________________________________ ERROR at setup of test_base64io_decode_parametrized_null_bytes[-AAAA-3] _________________________________________________________________\r\n\r\nself = environ({'PATH': '/Users/bullocm/git/aws-encryption-sdk-cli/.tox/py36/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin...ncryption_sdk_cli', 'COV_CORE_CONFIG': '', 'COV_CORE_DATAFILE': '/Users/bullocm/git/aws-encryption-sdk-cli/.coverage'})\r\nkey = b'PYTEST_CURRENT_TEST', value = b'test/unit/test_encoding.py::test_base64io_decode_parametrized_null_bytes[\\x00\\x00\\x00-AAAA-3] (setup)'\r\n\r\n    def __setitem__(self, key, value):\r\n        key = self.encodekey(key)\r\n        value = self.encodevalue(value)\r\n>       self.putenv(key, value)\r\nE       ValueError: embedded null byte\r\n\r\n.tox/py36/lib/python3.6/os.py:675: ValueError\r\n_______________________________________________________________ ERROR at teardown of test_base64io_decode_parametrized_null_bytes[-AAAA-3] ________________________________________________________________\r\n\r\nself = environ({'PATH': '/Users/bullocm/git/aws-encryption-sdk-cli/.tox/py36/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin...ncryption_sdk_cli', 'COV_CORE_CONFIG': '', 'COV_CORE_DATAFILE': '/Users/bullocm/git/aws-encryption-sdk-cli/.coverage'})\r\nkey = b'PYTEST_CURRENT_TEST', value = b'test/unit/test_encoding.py::test_base64io_decode_parametrized_null_bytes[\\x00\\x00\\x00-AAAA-3] (teardown)'\r\n\r\n    def __setitem__(self, key, value):\r\n        key = self.encodekey(key)\r\n        value = self.encodevalue(value)\r\n>       self.putenv(key, value)\r\nE       ValueError: embedded null byte\r\n\r\n.tox/py36/lib/python3.6/os.py:675: ValueError\r\n========================================================================================== 2 error in 0.71 seconds ===========================================================================================\r\nERROR: InvocationError: '/Users/bullocm/git/aws-encryption-sdk-cli/.tox/py36/bin/coverage run -m pytest --cov aws_encryption_sdk_cli test/unit/test_encoding.py::test_base64io_decode_parametrized_null_bytes -v'\r\n__________________________________________________________________________________________________ summary ___________________________________________________________________________________________________\r\nERROR:   py36: commands failed\r\n186590df9307:aws-encryption-sdk-cli bullocm$ source .tox/py36/bin/activate\r\n(py36) 186590df9307:aws-encryption-sdk-cli bullocm$ pip list\r\nDEPRECATION: The default format will switch to columns in the future. You can use --format=(legacy|columns) (or define a format=(legacy|columns) in your pip.conf under the [list] section) to disable this warning.\r\nasn1crypto (0.23.0)\r\nattrs (17.3.0)\r\naws-encryption-sdk (1.3.2)\r\naws-encryption-sdk-cli (1.1.2)\r\nboto3 (1.4.8)\r\nbotocore (1.8.2)\r\ncffi (1.11.2)\r\ncoverage (4.4.2)\r\ncryptography (2.1.3)\r\ndocutils (0.14)\r\nidna (2.6)\r\njmespath (0.9.3)\r\nmock (2.0.0)\r\npbr (3.1.1)\r\npip (9.0.1)\r\npluggy (0.6.0)\r\npy (1.5.2)\r\npycparser (2.18)\r\npytest (3.3.0)\r\npytest-cov (2.5.1)\r\npytest-mock (1.6.3)\r\npython-dateutil (2.6.1)\r\ns3transfer (0.1.11)\r\nsetuptools (38.2.3)\r\nsix (1.11.0)\r\ntyping (3.6.2)\r\nwheel (0.30.0)\r\nwrapt (1.10.11)\r\n```","closed_by":{"login":"The-Compiler","id":625793,"node_id":"MDQ6VXNlcjYyNTc5Mw==","avatar_url":"https://avatars.githubusercontent.com/u/625793?v=4","gravatar_id":"","url":"https://api.github.com/users/The-Compiler","html_url":"https://github.com/The-Compiler","followers_url":"https://api.github.com/users/The-Compiler/followers","following_url":"https://api.github.com/users/The-Compiler/following{/other_user}","gists_url":"https://api.github.com/users/The-Compiler/gists{/gist_id}","starred_url":"https://api.github.com/users/The-Compiler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/The-Compiler/subscriptions","organizations_url":"https://api.github.com/users/The-Compiler/orgs","repos_url":"https://api.github.com/users/The-Compiler/repos","events_url":"https://api.github.com/users/The-Compiler/events{/privacy}","received_events_url":"https://api.github.com/users/The-Compiler/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/2957/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pytest-dev/pytest/issues/2957/timeline","performed_via_github_app":null,"state_reason":"completed"}