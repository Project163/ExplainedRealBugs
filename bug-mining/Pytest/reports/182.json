{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/5971","repository_url":"https://api.github.com/repos/pytest-dev/pytest","labels_url":"https://api.github.com/repos/pytest-dev/pytest/issues/5971/labels{/name}","comments_url":"https://api.github.com/repos/pytest-dev/pytest/issues/5971/comments","events_url":"https://api.github.com/repos/pytest-dev/pytest/issues/5971/events","html_url":"https://github.com/pytest-dev/pytest/issues/5971","id":507635681,"node_id":"MDU6SXNzdWU1MDc2MzU2ODE=","number":5971,"title":"Test involving multiprocessing crashes when pytest 5.1.2 and xdist are used","user":{"login":"yuqian90","id":6637585,"node_id":"MDQ6VXNlcjY2Mzc1ODU=","avatar_url":"https://avatars.githubusercontent.com/u/6637585?v=4","gravatar_id":"","url":"https://api.github.com/users/yuqian90","html_url":"https://github.com/yuqian90","followers_url":"https://api.github.com/users/yuqian90/followers","following_url":"https://api.github.com/users/yuqian90/following{/other_user}","gists_url":"https://api.github.com/users/yuqian90/gists{/gist_id}","starred_url":"https://api.github.com/users/yuqian90/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yuqian90/subscriptions","organizations_url":"https://api.github.com/users/yuqian90/orgs","repos_url":"https://api.github.com/users/yuqian90/repos","events_url":"https://api.github.com/users/yuqian90/events{/privacy}","received_events_url":"https://api.github.com/users/yuqian90/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":224849193,"node_id":"MDU6TGFiZWwyMjQ4NDkxOTM=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/type:%20bug","name":"type: bug","color":"fc2929","default":false,"description":"problem that needs to be addressed"},{"id":224851053,"node_id":"MDU6TGFiZWwyMjQ4NTEwNTM=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/plugin:%20xdist","name":"plugin: xdist","color":"5319e7","default":false,"description":"related to the xdist external plugin"},{"id":315571544,"node_id":"MDU6TGFiZWwzMTU1NzE1NDQ=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/type:%20regression","name":"type: regression","color":"f7c6c7","default":false,"description":"indicates a problem that was introduced in a release which was working previously"}],"state":"closed","locked":false,"assignee":{"login":"nicoddemus","id":1085180,"node_id":"MDQ6VXNlcjEwODUxODA=","avatar_url":"https://avatars.githubusercontent.com/u/1085180?v=4","gravatar_id":"","url":"https://api.github.com/users/nicoddemus","html_url":"https://github.com/nicoddemus","followers_url":"https://api.github.com/users/nicoddemus/followers","following_url":"https://api.github.com/users/nicoddemus/following{/other_user}","gists_url":"https://api.github.com/users/nicoddemus/gists{/gist_id}","starred_url":"https://api.github.com/users/nicoddemus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicoddemus/subscriptions","organizations_url":"https://api.github.com/users/nicoddemus/orgs","repos_url":"https://api.github.com/users/nicoddemus/repos","events_url":"https://api.github.com/users/nicoddemus/events{/privacy}","received_events_url":"https://api.github.com/users/nicoddemus/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"nicoddemus","id":1085180,"node_id":"MDQ6VXNlcjEwODUxODA=","avatar_url":"https://avatars.githubusercontent.com/u/1085180?v=4","gravatar_id":"","url":"https://api.github.com/users/nicoddemus","html_url":"https://github.com/nicoddemus","followers_url":"https://api.github.com/users/nicoddemus/followers","following_url":"https://api.github.com/users/nicoddemus/following{/other_user}","gists_url":"https://api.github.com/users/nicoddemus/gists{/gist_id}","starred_url":"https://api.github.com/users/nicoddemus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicoddemus/subscriptions","organizations_url":"https://api.github.com/users/nicoddemus/orgs","repos_url":"https://api.github.com/users/nicoddemus/repos","events_url":"https://api.github.com/users/nicoddemus/events{/privacy}","received_events_url":"https://api.github.com/users/nicoddemus/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":7,"created_at":"2019-10-16T06:07:26Z","updated_at":"2020-01-20T03:14:32Z","closed_at":"2020-01-07T16:08:29Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"This simple test `testCrashXdist1` crashs pytest when xdist is used. It seems to start when pytest==5.1.2 is used. When using pytest==5.1.1, pytest does not crash and ValueError is raised correctly. My OS is linux.\r\n\r\nThe most likely cause is this change although I'm not sure: https://github.com/pytest-dev/pytest/issues/5786\r\n\r\n\r\n```python\r\ndef badFunc():\r\n    raise ValueError()\r\n\r\n\r\ndef testCrashXdist1():\r\n    import multiprocessing\r\n\r\n    with multiprocessing.Pool(1) as pool:\r\n        assert pool.apply(badFunc)\r\n\r\n\r\ndef testCrashXdist2():\r\n    assert badFunc()\r\n```\r\n\r\n```\r\n$ py.test testcrash.py -n1 -k testCrashXdist1\r\n============================================================================================================ test session starts ============================================================================================================\r\nplatform linux -- Python 3.6.5, pytest-5.1.2, py-1.8.0, pluggy-0.13.0\r\nrootdir: /tmp/crash\r\nplugins: forked-1.1.1, xdist-1.29.0\r\ngw0 [1]\r\nINTERNALERROR> Traceback (most recent call last):\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/_pytest/main.py\", line 191, in wrap_session\r\nINTERNALERROR>     session.exitstatus = doit(config, session) or 0\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/_pytest/main.py\", line 235, in _main\r\nINTERNALERROR>     config.hook.pytest_runtestloop(session=session)\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/hooks.py\", line 286, in __call__\r\nINTERNALERROR>     return self._hookexec(self, self.get_hookimpls(), kwargs)\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/manager.py\", line 92, in _hookexec\r\nINTERNALERROR>     return self._inner_hookexec(hook, methods, kwargs)\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/manager.py\", line 86, in <lambda>\r\nINTERNALERROR>     firstresult=hook.spec.opts.get(\"firstresult\") if hook.spec else False,\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/callers.py\", line 208, in _multicall\r\nINTERNALERROR>     return outcome.get_result()\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/callers.py\", line 80, in get_result\r\nINTERNALERROR>     raise ex[1].with_traceback(ex[2])\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/callers.py\", line 187, in _multicall\r\nINTERNALERROR>     res = hook_impl.function(*args)\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/xdist/remote.py\", line 71, in pytest_runtestloop\r\nINTERNALERROR>     self.run_one_test(torun)\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/xdist/remote.py\", line 85, in run_one_test\r\nINTERNALERROR>     self.config.hook.pytest_runtest_protocol(item=item, nextitem=nextitem)\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/hooks.py\", line 286, in __call__\r\nINTERNALERROR>     return self._hookexec(self, self.get_hookimpls(), kwargs)\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/manager.py\", line 92, in _hookexec\r\nINTERNALERROR>     return self._inner_hookexec(hook, methods, kwargs)\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/manager.py\", line 86, in <lambda>\r\nINTERNALERROR>     firstresult=hook.spec.opts.get(\"firstresult\") if hook.spec else False,\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/callers.py\", line 208, in _multicall\r\nINTERNALERROR>     return outcome.get_result()\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/callers.py\", line 80, in get_result\r\nINTERNALERROR>     raise ex[1].with_traceback(ex[2])\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/callers.py\", line 187, in _multicall\r\nINTERNALERROR>     res = hook_impl.function(*args)\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/_pytest/runner.py\", line 72, in pytest_runtest_protocol\r\nINTERNALERROR>     runtestprotocol(item, nextitem=nextitem)\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/_pytest/runner.py\", line 87, in runtestprotocol\r\nINTERNALERROR>     reports.append(call_and_report(item, \"call\", log))\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/_pytest/runner.py\", line 171, in call_and_report\r\nINTERNALERROR>     hook.pytest_runtest_logreport(report=report)\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/hooks.py\", line 286, in __call__\r\nINTERNALERROR>     return self._hookexec(self, self.get_hookimpls(), kwargs)\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/manager.py\", line 92, in _hookexec\r\nINTERNALERROR>     return self._inner_hookexec(hook, methods, kwargs)\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/manager.py\", line 86, in <lambda>\r\nINTERNALERROR>     firstresult=hook.spec.opts.get(\"firstresult\") if hook.spec else False,\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/callers.py\", line 208, in _multicall\r\nINTERNALERROR>     return outcome.get_result()\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/callers.py\", line 80, in get_result\r\nINTERNALERROR>     raise ex[1].with_traceback(ex[2])\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/callers.py\", line 187, in _multicall\r\nINTERNALERROR>     res = hook_impl.function(*args)\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/xdist/remote.py\", line 109, in pytest_runtest_logreport\r\nINTERNALERROR>     config=self.config, report=report\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/hooks.py\", line 286, in __call__\r\nINTERNALERROR>     return self._hookexec(self, self.get_hookimpls(), kwargs)\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/manager.py\", line 92, in _hookexec\r\nINTERNALERROR>     return self._inner_hookexec(hook, methods, kwargs)\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/manager.py\", line 86, in <lambda>\r\nINTERNALERROR>     firstresult=hook.spec.opts.get(\"firstresult\") if hook.spec else False,\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/callers.py\", line 208, in _multicall\r\nINTERNALERROR>     return outcome.get_result()\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/callers.py\", line 80, in get_result\r\nINTERNALERROR>     raise ex[1].with_traceback(ex[2])\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/callers.py\", line 187, in _multicall\r\nINTERNALERROR>     res = hook_impl.function(*args)\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/_pytest/reports.py\", line 328, in pytest_report_to_serializable\r\nINTERNALERROR>     data = report._to_json()\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/_pytest/reports.py\", line 164, in _to_json\r\nINTERNALERROR>     return _report_to_json(self)\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/_pytest/reports.py\", line 394, in _report_to_json\r\nINTERNALERROR>     d[\"longrepr\"] = serialize_longrepr(report)\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/_pytest/reports.py\", line 381, in serialize_longrepr\r\nINTERNALERROR>     serialize_repr_crash(repr_crash),\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/_pytest/reports.py\", line 367, in serialize_repr_crash\r\nINTERNALERROR>     return reprcrash.__dict__.copy()\r\nINTERNALERROR> AttributeError: 'NoneType' object has no attribute '__dict__'\r\nINTERNALERROR> Traceback (most recent call last):\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/_pytest/main.py\", line 191, in wrap_session\r\nINTERNALERROR>     session.exitstatus = doit(config, session) or 0\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/_pytest/main.py\", line 235, in _main\r\nINTERNALERROR>     config.hook.pytest_runtestloop(session=session)\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/hooks.py\", line 286, in __call__\r\nINTERNALERROR>     return self._hookexec(self, self.get_hookimpls(), kwargs)\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/manager.py\", line 92, in _hookexec\r\nINTERNALERROR>     return self._inner_hookexec(hook, methods, kwargs)\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/manager.py\", line 86, in <lambda>\r\nINTERNALERROR>     firstresult=hook.spec.opts.get(\"firstresult\") if hook.spec else False,\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/callers.py\", line 208, in _multicall\r\nINTERNALERROR>     return outcome.get_result()\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/callers.py\", line 80, in get_result\r\nINTERNALERROR>     raise ex[1].with_traceback(ex[2])\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/pluggy/callers.py\", line 187, in _multicall\r\nINTERNALERROR>     res = hook_impl.function(*args)\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/xdist/dsession.py\", line 115, in pytest_runtestloop\r\nINTERNALERROR>     self.loop_once()\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/xdist/dsession.py\", line 138, in loop_once\r\nINTERNALERROR>     call(**kwargs)\r\nINTERNALERROR>   File \"/tmp/testpytestvenv/lib/python3.6/site-packages/xdist/dsession.py\", line 180, in worker_workerfinished\r\nINTERNALERROR>     assert not crashitem, (crashitem, node)\r\nINTERNALERROR> AssertionError: ('testcrash.py::testCrashXdist1', <WorkerController gw0>)\r\nINTERNALERROR> assert not 'testcrash.py::testCrashXdist1'\r\n\r\n```\r\n\r\n```\r\n$ pip list\r\nPackage            Version\r\n------------------ -------\r\napipkg             1.5\r\natomicwrites       1.3.0\r\nattrs              19.3.0\r\nexecnet            1.7.1\r\nimportlib-metadata 0.23\r\nmore-itertools     7.2.0\r\npackaging          19.2\r\npip                19.3\r\npluggy             0.13.0\r\npy                 1.8.0\r\npyparsing          2.4.2\r\npytest             5.1.2\r\npytest-forked      1.1.1\r\npytest-xdist       1.29.0\r\nsetuptools         41.4.0\r\nsix                1.12.0\r\nwcwidth            0.1.7\r\nwheel              0.33.6\r\nzipp               0.6.0\r\n```\r\n","closed_by":{"login":"asottile","id":1810591,"node_id":"MDQ6VXNlcjE4MTA1OTE=","avatar_url":"https://avatars.githubusercontent.com/u/1810591?v=4","gravatar_id":"","url":"https://api.github.com/users/asottile","html_url":"https://github.com/asottile","followers_url":"https://api.github.com/users/asottile/followers","following_url":"https://api.github.com/users/asottile/following{/other_user}","gists_url":"https://api.github.com/users/asottile/gists{/gist_id}","starred_url":"https://api.github.com/users/asottile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/asottile/subscriptions","organizations_url":"https://api.github.com/users/asottile/orgs","repos_url":"https://api.github.com/users/asottile/repos","events_url":"https://api.github.com/users/asottile/events{/privacy}","received_events_url":"https://api.github.com/users/asottile/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/5971/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pytest-dev/pytest/issues/5971/timeline","performed_via_github_app":null,"state_reason":"completed"}