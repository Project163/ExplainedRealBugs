{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/7777","repository_url":"https://api.github.com/repos/pytest-dev/pytest","labels_url":"https://api.github.com/repos/pytest-dev/pytest/issues/7777/labels{/name}","comments_url":"https://api.github.com/repos/pytest-dev/pytest/issues/7777/comments","events_url":"https://api.github.com/repos/pytest-dev/pytest/issues/7777/events","html_url":"https://github.com/pytest-dev/pytest/issues/7777","id":705092528,"node_id":"MDU6SXNzdWU3MDUwOTI1Mjg=","number":7777,"title":"How should package collection work?","user":{"login":"bluetech","id":1223550,"node_id":"MDQ6VXNlcjEyMjM1NTA=","avatar_url":"https://avatars.githubusercontent.com/u/1223550?v=4","gravatar_id":"","url":"https://api.github.com/users/bluetech","html_url":"https://github.com/bluetech","followers_url":"https://api.github.com/users/bluetech/followers","following_url":"https://api.github.com/users/bluetech/following{/other_user}","gists_url":"https://api.github.com/users/bluetech/gists{/gist_id}","starred_url":"https://api.github.com/users/bluetech/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bluetech/subscriptions","organizations_url":"https://api.github.com/users/bluetech/orgs","repos_url":"https://api.github.com/users/bluetech/repos","events_url":"https://api.github.com/users/bluetech/events{/privacy}","received_events_url":"https://api.github.com/users/bluetech/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":240511492,"node_id":"MDU6TGFiZWwyNDA1MTE0OTI=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/topic:%20collection","name":"topic: collection","color":"006b75","default":false,"description":"related to the collection phase"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":23,"created_at":"2020-09-20T11:23:49Z","updated_at":"2023-12-30T10:51:51Z","closed_at":"2023-12-30T10:51:51Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I am working on cleaning up our collection code, but the current behavior seems odd and incidental, therefore I'd first like to discuss how it *should* behave.\r\n\r\npytest and operating system versions: pytest 6.0.2/master on Linux.\r\n\r\n### Current behavior\r\n\r\nConsider the following filesystem tree:\r\n\r\n```\r\na\r\n├── b\r\n│   ├── c\r\n│   │   ├── d\r\n│   │   │   ├── __init__.py\r\n│   │   │   └── test_d.py\r\n│   │   └── test_c.py\r\n│   ├── __init__.py\r\n│   └── test_b.py\r\n├── b2\r\n│   ├── __init__.py\r\n│   └── test_b2.py\r\n├── __init__.py\r\n└── test_a.py\r\n```\r\n\r\nThis has several nested packages, but note that the `c` level doesn't have an `__init__.py` (just to make it more interesting).\r\n\r\nThis results in the following collection tree:\r\n\r\n```\r\n$ pytest --co a/\r\ncollected 5 items\r\n\r\n<Package a>\r\n  <Module test_a.py>\r\n    <Function test_a1>\r\n<Package b>\r\n  <Module test_b.py>\r\n    <Function test_b1>\r\n<Module a/b/c/test_c.py>\r\n  <Function test_c1>\r\n<Package d>\r\n  <Module test_d.py>\r\n    <Function test_d1>\r\n<Package b2>\r\n  <Module test_b2.py>\r\n    <Function test_b21>\r\n```\r\n\r\nThe `Package`s are all flat, not nested. Namespace packages are not considered `Package`s. Files not inside packages are collected as standalone `Module`s.\r\n\r\nThis however does not reveal the real story. See what happens when `--keep-duplicates` is used:\r\n\r\n```\r\n$ pytest --co --keep-duplicates a/\r\ncollected 11 items\r\n\r\n<Package a>\r\n  <Module test_a.py>\r\n    <Function test_a1>\r\n  <Package b>\r\n    <Module test_b.py>\r\n      <Function test_b1>\r\n    <Module test_c.py>\r\n      <Function test_c1>\r\n    <Package d>\r\n      <Module test_d.py>\r\n        <Function test_d1>\r\n  <Package b2>\r\n    <Module test_b2.py>\r\n      <Function test_b21>\r\n<Package b>\r\n  <Module test_b.py>\r\n    <Function test_b1>\r\n  <Module test_c.py>\r\n    <Function test_c1>\r\n  <Package d>\r\n    <Module test_d.py>\r\n      <Function test_d1>\r\n<Module a/b/c/test_c.py>\r\n  <Function test_c1>\r\n<Package d>\r\n  <Module test_d.py>\r\n    <Function test_d1>\r\n<Package b2>\r\n  <Module test_b2.py>\r\n    <Function test_b21>\r\n```\r\n\r\nThis has all of the previous collectors, but also duplicates which are nested under each Package.\r\n\r\n### Technical details\r\n\r\nFor this interested, the code details are as follows:\r\n\r\npytest has two recursive filesystem collectors, `Session` and `Package`.\r\n\r\n[`Session.collect()`](https://github.com/pytest-dev/pytest/blob/cdfdb3a25d1033f732072d9a4d2fb700feb73a09/src/_pytest/main.py#L636) walks the entire trees (of the given command line arguments) recursively in BFS order and creates collectors for `Package`s and `Module`s. It has various obscure code to special-case `Package`s and exclude files belonging directly to the package. The `Collector`s it creates always have the `Session` as parent (i.e. flat).\r\n\r\nNote that the `Collector`s themselves are only recursively expanded to `Item`s *after* the above is finished. (This step is done by `Session.genitems()` which calls each `Collector`'s own `collect()` method).\r\n\r\n[`Package.collect()`](https://github.com/pytest-dev/pytest/blob/cdfdb3a25d1033f732072d9a4d2fb700feb73a09/src/_pytest/python.py#L692) also walks the package's directory recursively. It has some code to try to avoid collecting `Modules` belonging to sub-packages, but otherwise creates `Module`s and `Package`s with itself as parent.\r\n\r\nSince the stuff collected by `Package`s was already collected by the `Session` (with the exception of a package's own direct files) they are mostly discarded as duplicates unless `--keep-duplicates` is used.\r\n\r\n### Question\r\n\r\nMy question is, what do we *want* to happen?\r\n\r\nEvidently the nesting is not super important, otherwise we would have heard loud complaints by now (though there are some issues about this). But the nesting does have an effect on how package-scope fixtures are applied - reuse from super-package or not?\r\n\r\nThe duplication seems definitely broken.\r\n\r\nAnd there is a question on how PEP 382 namespace packages fit into this (if it all).\r\n\r\nWould be happy for any thoughts!","closed_by":{"login":"bluetech","id":1223550,"node_id":"MDQ6VXNlcjEyMjM1NTA=","avatar_url":"https://avatars.githubusercontent.com/u/1223550?v=4","gravatar_id":"","url":"https://api.github.com/users/bluetech","html_url":"https://github.com/bluetech","followers_url":"https://api.github.com/users/bluetech/followers","following_url":"https://api.github.com/users/bluetech/following{/other_user}","gists_url":"https://api.github.com/users/bluetech/gists{/gist_id}","starred_url":"https://api.github.com/users/bluetech/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bluetech/subscriptions","organizations_url":"https://api.github.com/users/bluetech/orgs","repos_url":"https://api.github.com/users/bluetech/repos","events_url":"https://api.github.com/users/bluetech/events{/privacy}","received_events_url":"https://api.github.com/users/bluetech/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/7777/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pytest-dev/pytest/issues/7777/timeline","performed_via_github_app":null,"state_reason":"completed"}