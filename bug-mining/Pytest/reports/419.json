{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/9502","repository_url":"https://api.github.com/repos/pytest-dev/pytest","labels_url":"https://api.github.com/repos/pytest-dev/pytest/issues/9502/labels{/name}","comments_url":"https://api.github.com/repos/pytest-dev/pytest/issues/9502/comments","events_url":"https://api.github.com/repos/pytest-dev/pytest/issues/9502/events","html_url":"https://github.com/pytest-dev/pytest/issues/9502","id":1099284044,"node_id":"I_kwDOAjwLdc5Bhb5M","number":9502,"title":"Add a function to detect if pytest is running","user":{"login":"adamchainz","id":857609,"node_id":"MDQ6VXNlcjg1NzYwOQ==","avatar_url":"https://avatars.githubusercontent.com/u/857609?v=4","gravatar_id":"","url":"https://api.github.com/users/adamchainz","html_url":"https://github.com/adamchainz","followers_url":"https://api.github.com/users/adamchainz/followers","following_url":"https://api.github.com/users/adamchainz/following{/other_user}","gists_url":"https://api.github.com/users/adamchainz/gists{/gist_id}","starred_url":"https://api.github.com/users/adamchainz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adamchainz/subscriptions","organizations_url":"https://api.github.com/users/adamchainz/orgs","repos_url":"https://api.github.com/users/adamchainz/repos","events_url":"https://api.github.com/users/adamchainz/events{/privacy}","received_events_url":"https://api.github.com/users/adamchainz/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":224849844,"node_id":"MDU6TGFiZWwyMjQ4NDk4NDQ=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/type:%20proposal","name":"type: proposal","color":"006b75","default":false,"description":"proposal for a new feature, often to gather opinions or design the API around the new feature"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":20,"created_at":"2022-01-11T15:15:50Z","updated_at":"2024-04-28T14:10:30Z","closed_at":"2024-04-18T10:45:49Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### What's the problem this feature will solve?\r\n\r\nDjango settings modules often load environment variables from a `.env` file:\r\n\r\n```python\r\nfrom pathlib import Path\r\n\r\nimport dotenv\r\n\r\nBASE_DIR = Path(__file__).resolve().parent.parent\r\n\r\ndotenv.load_dotenv(dotenv_path=BASE_DIR / \".env\")\r\n```\r\n\r\nLoading from `.env` is not desirable during test runs. Environment variables added for local debugging may affect the test run in unexpected ways, such as making remote API calls.\r\n\r\nThe settings module should therefore only load the `.env` file if pytest isn't running:\r\n\r\n```python\r\nfrom pathlib import Path\r\n\r\nimport dotenv\r\n\r\nBASE_DIR = Path(__file__).resolve().parent.parent\r\n\r\nif ... # pytest is not running\r\n    dotenv.load_dotenv(dotenv_path=BASE_DIR / \".env\")\r\n```\r\n\r\nChanging behaviour during tests is usually undesirable, but here it's done to isolate the test run, which is a good thing.\r\n\r\npytest documents a pattern to change behaviour using fixtures here: https://docs.pytest.org/en/latest/example/simple.html#detect-if-running-from-within-a-pytest-run . Unfortunately this techinque is incompatible with this particular problem. pytest-django's fixtures load the settings module early, before fixtures from `conftest.py` fixtures run, so the pattern cannot be applied. And environment variable changes cannot be undone after the fact.\r\n\r\nTo solve this I made [pytest-is-running](https://github.com/adamchainz/pytest-is-running), which can be used like so:\r\n\r\n```python\r\nfrom pathlib import Path\r\n\r\nimport dotenv\r\nimport pytest_is_running\r\n\r\nBASE_DIR = Path(__file__).resolve().parent.parent\r\n\r\nif not pytest_is_running.is_running():\r\n    dotenv.load_dotenv(dotenv_path=BASE_DIR / \".env\")\r\n```\r\n\r\npytest-is-running works because plugin fixtures can load early, and it uses hooks with `tryfirst=True`.\r\n\r\n#### Describe the solution you'd like\r\n\r\nRather than have a documented workaround and plugin, I'd like to see a function in core pytest that provides the ability to check if pytest is running. It could simplify things for those using the both the documented pattern and the plugin.\r\n\r\nIt would also be good if the solution could somehow avoid the cost of doing `import pytest`, so that non-test pathways do not import the heap of stuff in pytest only to ignore it because pytest isn't running. The plugin is deliberately structured to avoid this.\r\n\r\n#### Alternative Solutions\r\n\r\nI wrote the plugin.\r\n\r\n#### Additional context\r\n\r\nnone\r\n","closed_by":{"login":"nicoddemus","id":1085180,"node_id":"MDQ6VXNlcjEwODUxODA=","avatar_url":"https://avatars.githubusercontent.com/u/1085180?v=4","gravatar_id":"","url":"https://api.github.com/users/nicoddemus","html_url":"https://github.com/nicoddemus","followers_url":"https://api.github.com/users/nicoddemus/followers","following_url":"https://api.github.com/users/nicoddemus/following{/other_user}","gists_url":"https://api.github.com/users/nicoddemus/gists{/gist_id}","starred_url":"https://api.github.com/users/nicoddemus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicoddemus/subscriptions","organizations_url":"https://api.github.com/users/nicoddemus/orgs","repos_url":"https://api.github.com/users/nicoddemus/repos","events_url":"https://api.github.com/users/nicoddemus/events{/privacy}","received_events_url":"https://api.github.com/users/nicoddemus/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/9502/reactions","total_count":6,"+1":6,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pytest-dev/pytest/issues/9502/timeline","performed_via_github_app":null,"state_reason":"completed"}