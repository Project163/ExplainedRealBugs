{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/3888","repository_url":"https://api.github.com/repos/pytest-dev/pytest","labels_url":"https://api.github.com/repos/pytest-dev/pytest/issues/3888/labels{/name}","comments_url":"https://api.github.com/repos/pytest-dev/pytest/issues/3888/comments","events_url":"https://api.github.com/repos/pytest-dev/pytest/issues/3888/events","html_url":"https://github.com/pytest-dev/pytest/issues/3888","id":354152334,"node_id":"MDU6SXNzdWUzNTQxNTIzMzQ=","number":3888,"title":"doctests regression with v3.7.3 on OS-X","user":{"login":"vst","id":374793,"node_id":"MDQ6VXNlcjM3NDc5Mw==","avatar_url":"https://avatars.githubusercontent.com/u/374793?v=4","gravatar_id":"","url":"https://api.github.com/users/vst","html_url":"https://github.com/vst","followers_url":"https://api.github.com/users/vst/followers","following_url":"https://api.github.com/users/vst/following{/other_user}","gists_url":"https://api.github.com/users/vst/gists{/gist_id}","starred_url":"https://api.github.com/users/vst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vst/subscriptions","organizations_url":"https://api.github.com/users/vst/orgs","repos_url":"https://api.github.com/users/vst/repos","events_url":"https://api.github.com/users/vst/events{/privacy}","received_events_url":"https://api.github.com/users/vst/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":224849193,"node_id":"MDU6TGFiZWwyMjQ4NDkxOTM=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/type:%20bug","name":"type: bug","color":"fc2929","default":false,"description":"problem that needs to be addressed"},{"id":240592808,"node_id":"MDU6TGFiZWwyNDA1OTI4MDg=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/plugin:%20doctests","name":"plugin: doctests","color":"fad8c7","default":false,"description":"related to the doctests builtin plugin"},{"id":315571544,"node_id":"MDU6TGFiZWwzMTU1NzE1NDQ=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/type:%20regression","name":"type: regression","color":"f7c6c7","default":false,"description":"indicates a problem that was introduced in a release which was working previously"},{"id":692888040,"node_id":"MDU6TGFiZWw2OTI4ODgwNDA=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/platform:%20mac","name":"platform: mac","color":"bfdadc","default":false,"description":"mac platform-specific problem"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2018-08-27T01:48:12Z","updated_at":"2018-08-28T20:06:18Z","closed_at":"2018-08-28T20:06:18Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"- [x] Include a detailed description of the bug or suggestion\r\n\r\nAfter upgrading to v3.7.3, all doctests started failing with the exception:\r\n\r\n```\r\n<my-pyenv>/lib/python3.7/site-packages/_pytest/doctest.py:206: TypeError: cannot unpack non-iterable NoneType object\r\n```\r\n\r\nEverything is OK with v3.7.2.\r\n\r\nSlightly longer traceback (For the record, looking into the stacktrace, I see some references to \"darwin\"-specific functions):\r\n\r\n```\r\n___________________________________________________________________ [doctest] xxx ___________________________________________________________________\r\n\r\nself = <CallInfo when='call' exception: cannot unpack non-iterable NoneType object>, func = <function call_runtest_hook.<locals>.<lambda> at 0x1112f49d8>, when = 'call'\r\ntreat_keyboard_interrupt_as_exception = False\r\n\r\n    def __init__(self, func, when, treat_keyboard_interrupt_as_exception=False):\r\n        #: context of invocation: one of \"setup\", \"call\",\r\n        #: \"teardown\", \"memocollect\"\r\n        self.when = when\r\n        self.start = time()\r\n        try:\r\n>           self.result = func()\r\n\r\n<my-pyenv>/lib/python3.7/site-packages/_pytest/runner.py:201:\r\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\r\n\r\n>   lambda: ihook(item=item, **kwds),\r\n    when=when,\r\n    treat_keyboard_interrupt_as_exception=item.config.getvalue(\"usepdb\"),\r\n        )\r\n\r\n<my-pyenv>/lib/python3.7/site-packages/_pytest/runner.py:183:\r\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\r\n\r\nself = <_HookCaller 'pytest_runtest_call'>, args = (), kwargs = {'item': <DoctestItem 'somemodule.somefunction'>}, notincall = set()\r\n\r\n    def __call__(self, *args, **kwargs):\r\n        if args:\r\n            raise TypeError(\"hook calling supports only keyword arguments\")\r\n        assert not self.is_historic()\r\n        if self.argnames:\r\n            notincall = set(self.argnames) - set(['__multicall__']) - set(\r\n                kwargs.keys())\r\n            if notincall:\r\n                warnings.warn(\r\n                    \"Argument(s) {} which are declared in the hookspec \"\r\n                    \"can not be found in this hook call\"\r\n                    .format(tuple(notincall)),\r\n                    stacklevel=2,\r\n                )\r\n>       return self._hookexec(self, self._nonwrappers + self._wrappers, kwargs)\r\n\r\n<my-pyenv>/lib/python3.7/site-packages/pluggy/hooks.py:258:\r\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\r\n\r\nself = <_pytest.config.PytestPluginManager object at 0x1034317b8>, hook = <_HookCaller 'pytest_runtest_call'>\r\nmethods = [<HookImpl plugin_name='runner', plugin=<module '_pytest.runner' from '<my-pyenv......t 0x103d4f4e0>>, <HookImpl plugin_name='logging-plugin', plugin=<_pytest.logging.LoggingPlugin object at 0x10e8f9860>>]\r\nkwargs = {'item': <DoctestItem 'somemodule.somefunction'>}\r\n\r\n    def _hookexec(self, hook, methods, kwargs):\r\n        # called from all hookcaller instances.\r\n        # enable_tracing will set its own wrapping function at self._inner_hookexec\r\n>       return self._inner_hookexec(hook, methods, kwargs)\r\n\r\n<my-pyenv>/lib/python3.7/site-packages/pluggy/manager.py:67:\r\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\r\n\r\nhook = <_HookCaller 'pytest_runtest_call'>\r\nmethods = [<HookImpl plugin_name='runner', plugin=<module '_pytest.runner' from '<my-pyenv......t 0x103d4f4e0>>, <HookImpl plugin_name='logging-plugin', plugin=<_pytest.logging.LoggingPlugin object at 0x10e8f9860>>]\r\nkwargs = {'item': <DoctestItem 'somemodule.somefunction'>}\r\n\r\n    self._inner_hookexec = lambda hook, methods, kwargs: \\\r\n        hook.multicall(\r\n            methods, kwargs,\r\n>           firstresult=hook.spec_opts.get('firstresult'),\r\n        )\r\n\r\n<my-pyenv>/lib/python3.7/site-packages/pluggy/manager.py:61:\r\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\r\n\r\nhook_impls = [<HookImpl plugin_name='runner', plugin=<module '_pytest.runner' from '<my-pyenv......t 0x103d4f4e0>>, <HookImpl plugin_name='logging-plugin', plugin=<_pytest.logging.LoggingPlugin object at 0x10e8f9860>>]\r\ncaller_kwargs = {'item': <DoctestItem 'somemodule.somefunction'>}, firstresult = False\r\n\r\n    def _multicall(hook_impls, caller_kwargs, firstresult=False):\r\n        \"\"\"Execute a call into multiple python functions/methods and return the\r\n        result(s).\r\n\r\n        ``caller_kwargs`` comes from _HookCaller.__call__().\r\n        \"\"\"\r\n        __tracebackhide__ = True\r\n        results = []\r\n        excinfo = None\r\n        try:  # run impl and wrapper setup functions in a loop\r\n            teardowns = []\r\n            try:\r\n                for hook_impl in reversed(hook_impls):\r\n                    try:\r\n                        args = [caller_kwargs[argname] for argname in hook_impl.argnames]\r\n                    except KeyError:\r\n                        for argname in hook_impl.argnames:\r\n                            if argname not in caller_kwargs:\r\n                                raise HookCallError(\r\n                                    \"hook call must provide argument %r\" % (argname,))\r\n\r\n                    if hook_impl.hookwrapper:\r\n                        try:\r\n                            gen = hook_impl.function(*args)\r\n                            next(gen)   # first yield\r\n                            teardowns.append(gen)\r\n                        except StopIteration:\r\n                            _raise_wrapfail(gen, \"did not yield\")\r\n                    else:\r\n                        res = hook_impl.function(*args)\r\n                        if res is not None:\r\n                            results.append(res)\r\n                            if firstresult:  # halt further impl calls\r\n                                break\r\n            except BaseException:\r\n                excinfo = sys.exc_info()\r\n        finally:\r\n            if firstresult:  # first result hooks return a single value\r\n                outcome = _Result(results[0] if results else None, excinfo)\r\n            else:\r\n                outcome = _Result(results, excinfo)\r\n\r\n            # run all wrapper post-yield blocks\r\n            for gen in reversed(teardowns):\r\n                try:\r\n                    gen.send(outcome)\r\n                    _raise_wrapfail(gen, \"has second yield\")\r\n                except StopIteration:\r\n                    pass\r\n\r\n>           return outcome.get_result()\r\n\r\n<my-pyenv>/lib/python3.7/site-packages/pluggy/callers.py:201:\r\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\r\n\r\nself = <pluggy.callers._Result object at 0x11116efd0>\r\n\r\n    def get_result(self):\r\n        \"\"\"Get the result(s) for this hook call.\r\n\r\n            If the hook was marked as a ``firstresult`` only a single value\r\n            will be returned otherwise a list of results.\r\n            \"\"\"\r\n        __tracebackhide__ = True\r\n        if self._excinfo is None:\r\n            return self._result\r\n        else:\r\n            ex = self._excinfo\r\n            if _py3:\r\n>               raise ex[1].with_traceback(ex[2])\r\n\r\n<my-pyenv>/lib/python3.7/site-packages/pluggy/callers.py:76:\r\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\r\n\r\nhook_impls = [<HookImpl plugin_name='runner', plugin=<module '_pytest.runner' from '<my-pyenv......t 0x103d4f4e0>>, <HookImpl plugin_name='logging-plugin', plugin=<_pytest.logging.LoggingPlugin object at 0x10e8f9860>>]\r\ncaller_kwargs = {'item': <DoctestItem 'somemodule.somefunction'>}, firstresult = False\r\n\r\n    def _multicall(hook_impls, caller_kwargs, firstresult=False):\r\n        \"\"\"Execute a call into multiple python functions/methods and return the\r\n        result(s).\r\n\r\n        ``caller_kwargs`` comes from _HookCaller.__call__().\r\n        \"\"\"\r\n        __tracebackhide__ = True\r\n        results = []\r\n        excinfo = None\r\n        try:  # run impl and wrapper setup functions in a loop\r\n            teardowns = []\r\n            try:\r\n                for hook_impl in reversed(hook_impls):\r\n                    try:\r\n                        args = [caller_kwargs[argname] for argname in hook_impl.argnames]\r\n                    except KeyError:\r\n                        for argname in hook_impl.argnames:\r\n                            if argname not in caller_kwargs:\r\n                                raise HookCallError(\r\n                                    \"hook call must provide argument %r\" % (argname,))\r\n\r\n                    if hook_impl.hookwrapper:\r\n                        try:\r\n                            gen = hook_impl.function(*args)\r\n                            next(gen)   # first yield\r\n                            teardowns.append(gen)\r\n                        except StopIteration:\r\n                            _raise_wrapfail(gen, \"did not yield\")\r\n                    else:\r\n>                       res = hook_impl.function(*args)\r\n\r\n<my-pyenv>/lib/python3.7/site-packages/pluggy/callers.py:180:\r\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\r\n\r\nitem = <DoctestItem 'somemodule.somefunction'>\r\n\r\n    def pytest_runtest_call(item):\r\n        _update_current_test_var(item, \"call\")\r\n        sys.last_type, sys.last_value, sys.last_traceback = (None, None, None)\r\n        try:\r\n>           item.runtest()\r\n\r\n<my-pyenv>/lib/python3.7/site-packages/_pytest/runner.py:111:\r\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\r\n\r\nself = <DoctestItem 'somemodule.somefunction'>\r\n\r\n    def runtest(self):\r\n        _check_all_skipped(self.dtest)\r\n>       self._disable_output_capturing_for_darwin()\r\n\r\n<my-pyenv>/lib/python3.7/site-packages/_pytest/doctest.py:192:\r\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\r\n\r\nself = <DoctestItem 'somemodule.somefunction'>\r\n\r\n    def _disable_output_capturing_for_darwin(self):\r\n        \"\"\"\r\n            Disable output capturing. Otherwise, stdout is lost to doctest (#985)\r\n            \"\"\"\r\n        if platform.system() != \"Darwin\":\r\n            return\r\n        capman = self.config.pluginmanager.getplugin(\"capturemanager\")\r\n        if capman:\r\n>           out, err = capman.suspend_global_capture(in_=True)\r\nE           TypeError: cannot unpack non-iterable NoneType object\r\n\r\n<my-pyenv>/lib/python3.7/site-packages/_pytest/doctest.py:206: TypeError\r\n```\r\n\r\n- [x] `pip list` of the virtual environment you are using\r\n\r\n```\r\n...\r\nmypy                     0.620\r\npytest                   3.7.3\r\npytest-cov               2.5.1\r\npytest-django            3.4.2\r\ntox                      3.2.1\r\n...\r\n```\r\n\r\n- [x] pytest and operating system versions\r\n\r\n`pytest v3.7.3` and \r\n\r\n```\r\n$ sw_vers\r\nProductName:\tMac OS X\r\nProductVersion:\t10.13.6\r\nBuildVersion:\t17G65\r\n```\r\n\r\n- [ ] Minimal example if possible\r\n","closed_by":{"login":"nicoddemus","id":1085180,"node_id":"MDQ6VXNlcjEwODUxODA=","avatar_url":"https://avatars.githubusercontent.com/u/1085180?v=4","gravatar_id":"","url":"https://api.github.com/users/nicoddemus","html_url":"https://github.com/nicoddemus","followers_url":"https://api.github.com/users/nicoddemus/followers","following_url":"https://api.github.com/users/nicoddemus/following{/other_user}","gists_url":"https://api.github.com/users/nicoddemus/gists{/gist_id}","starred_url":"https://api.github.com/users/nicoddemus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicoddemus/subscriptions","organizations_url":"https://api.github.com/users/nicoddemus/orgs","repos_url":"https://api.github.com/users/nicoddemus/repos","events_url":"https://api.github.com/users/nicoddemus/events{/privacy}","received_events_url":"https://api.github.com/users/nicoddemus/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/3888/reactions","total_count":4,"+1":4,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pytest-dev/pytest/issues/3888/timeline","performed_via_github_app":null,"state_reason":"completed"}