{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/12112","repository_url":"https://api.github.com/repos/pytest-dev/pytest","labels_url":"https://api.github.com/repos/pytest-dev/pytest/issues/12112/labels{/name}","comments_url":"https://api.github.com/repos/pytest-dev/pytest/issues/12112/comments","events_url":"https://api.github.com/repos/pytest-dev/pytest/issues/12112/events","html_url":"https://github.com/pytest-dev/pytest/issues/12112","id":2181768700,"node_id":"I_kwDOAjwLdc6CCyX8","number":12112,"title":"`pytest==8.1.1` Import regression in some namespace package layouts","user":{"login":"aaraney","id":39420640,"node_id":"MDQ6VXNlcjM5NDIwNjQw","avatar_url":"https://avatars.githubusercontent.com/u/39420640?v=4","gravatar_id":"","url":"https://api.github.com/users/aaraney","html_url":"https://github.com/aaraney","followers_url":"https://api.github.com/users/aaraney/followers","following_url":"https://api.github.com/users/aaraney/following{/other_user}","gists_url":"https://api.github.com/users/aaraney/gists{/gist_id}","starred_url":"https://api.github.com/users/aaraney/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aaraney/subscriptions","organizations_url":"https://api.github.com/users/aaraney/orgs","repos_url":"https://api.github.com/users/aaraney/repos","events_url":"https://api.github.com/users/aaraney/events{/privacy}","received_events_url":"https://api.github.com/users/aaraney/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":240511492,"node_id":"MDU6TGFiZWwyNDA1MTE0OTI=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/topic:%20collection","name":"topic: collection","color":"006b75","default":false,"description":"related to the collection phase"}],"state":"closed","locked":false,"assignee":{"login":"nicoddemus","id":1085180,"node_id":"MDQ6VXNlcjEwODUxODA=","avatar_url":"https://avatars.githubusercontent.com/u/1085180?v=4","gravatar_id":"","url":"https://api.github.com/users/nicoddemus","html_url":"https://github.com/nicoddemus","followers_url":"https://api.github.com/users/nicoddemus/followers","following_url":"https://api.github.com/users/nicoddemus/following{/other_user}","gists_url":"https://api.github.com/users/nicoddemus/gists{/gist_id}","starred_url":"https://api.github.com/users/nicoddemus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicoddemus/subscriptions","organizations_url":"https://api.github.com/users/nicoddemus/orgs","repos_url":"https://api.github.com/users/nicoddemus/repos","events_url":"https://api.github.com/users/nicoddemus/events{/privacy}","received_events_url":"https://api.github.com/users/nicoddemus/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"nicoddemus","id":1085180,"node_id":"MDQ6VXNlcjEwODUxODA=","avatar_url":"https://avatars.githubusercontent.com/u/1085180?v=4","gravatar_id":"","url":"https://api.github.com/users/nicoddemus","html_url":"https://github.com/nicoddemus","followers_url":"https://api.github.com/users/nicoddemus/followers","following_url":"https://api.github.com/users/nicoddemus/following{/other_user}","gists_url":"https://api.github.com/users/nicoddemus/gists{/gist_id}","starred_url":"https://api.github.com/users/nicoddemus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicoddemus/subscriptions","organizations_url":"https://api.github.com/users/nicoddemus/orgs","repos_url":"https://api.github.com/users/nicoddemus/repos","events_url":"https://api.github.com/users/nicoddemus/events{/privacy}","received_events_url":"https://api.github.com/users/nicoddemus/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":16,"created_at":"2024-03-12T14:29:43Z","updated_at":"2024-04-09T16:21:52Z","closed_at":"2024-04-09T16:21:52Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"As first noted in #12074, below is an example project structure with two packages under the `ns` namespace that now fail to import after the changes introduced in `8.1.x`:\r\n\r\n```\r\nns\r\n└── python\r\n    ├── bar\r\n    │   ├── ns\r\n    │   │   ├── bar\r\n    │   │   └── test\r\n    │   │       ├── __init__.py\r\n    │   │       ├── bar.py\r\n    │   │       └── test_bar.py\r\n    │   └── pyproject.toml\r\n    └── foo\r\n        ├── ns\r\n        │   ├── foo\r\n        │   └── test\r\n        │       ├── __init__.py\r\n        │       ├── foo.py\r\n        │       └── test_foo.py\r\n        └── pyproject.toml\r\n```\r\n\r\nBelow are the contents of `test_foo.py` and `foo.py`. `test_bar.py` and `bar.py` look nearly identical.\r\n\r\n```\r\n# python/foo/ns/test/test_foo.py\r\nfrom .foo import value\r\n\r\ndef test_foo():\r\n    assert value == \"foo\"\r\n```\r\n\r\n```\r\n# python/foo/ns/test/foo.py\r\nvalue = \"foo\"\r\n```\r\n\r\nIn `pytest==8.0.2`, `python -m pytest --import-mode=importlib` correctly discovers and runs the tests from the top level `ns` directory. In `pytest==8.1.1`, `python -m pytest --import-mode=importlib -o \"consider_namespace_packages=true\"`, results in the following error during collection:\r\n\r\n```\r\n========================== test session starts ===========================\r\nplatform darwin -- Python 3.9.16, pytest-8.1.1, pluggy-1.4.0\r\nrootdir: /home/user/pytest-12074\r\ncollected 0 items / 2 errors\r\n\r\n================================= ERRORS =================================\r\n____________ ERROR collecting python/bar/ns/test/test_bar.py _____________\r\nImportError while importing test module '/home/user/pytest-12074/python/bar/ns/test/test_bar.py'.\r\nHint: make sure your test modules/packages have valid Python names.\r\nTraceback:\r\npython/bar/ns/test/test_bar.py:1: in <module>\r\n    from .bar import value\r\nE   ModuleNotFoundError: No module named 'test.bar'\r\n____________ ERROR collecting python/foo/ns/test/test_foo.py _____________\r\nImportError while importing test module '/home/user/pytest-12074/python/foo/ns/test/test_foo.py'.\r\nHint: make sure your test modules/packages have valid Python names.\r\nTraceback:\r\npython/foo/ns/test/test_foo.py:1: in <module>\r\n    from .foo import value\r\nE   ModuleNotFoundError: No module named 'test.foo'\r\n======================== short test summary info =========================\r\nERROR python/bar/ns/test/test_bar.py\r\nERROR python/foo/ns/test/test_foo.py\r\n!!!!!!!!!!!!!!!! Interrupted: 2 errors during collection !!!!!!!!!!!!!!!!!\r\n=========================== 2 errors in 0.04s ============================\r\n```\r\n\r\n\r\nTo reproduce the issue clone https://github.com/aaraney/pytest-12074, pip install `ns.foo` and `ns.bar`, pip install the different versions of `pytest` and run with the aforementioned commands.\r\n","closed_by":{"login":"nicoddemus","id":1085180,"node_id":"MDQ6VXNlcjEwODUxODA=","avatar_url":"https://avatars.githubusercontent.com/u/1085180?v=4","gravatar_id":"","url":"https://api.github.com/users/nicoddemus","html_url":"https://github.com/nicoddemus","followers_url":"https://api.github.com/users/nicoddemus/followers","following_url":"https://api.github.com/users/nicoddemus/following{/other_user}","gists_url":"https://api.github.com/users/nicoddemus/gists{/gist_id}","starred_url":"https://api.github.com/users/nicoddemus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicoddemus/subscriptions","organizations_url":"https://api.github.com/users/nicoddemus/orgs","repos_url":"https://api.github.com/users/nicoddemus/repos","events_url":"https://api.github.com/users/nicoddemus/events{/privacy}","received_events_url":"https://api.github.com/users/nicoddemus/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/12112/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pytest-dev/pytest/issues/12112/timeline","performed_via_github_app":null,"state_reason":"completed"}