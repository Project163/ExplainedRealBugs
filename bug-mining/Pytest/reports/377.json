{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/11314","repository_url":"https://api.github.com/repos/pytest-dev/pytest","labels_url":"https://api.github.com/repos/pytest-dev/pytest/issues/11314/labels{/name}","comments_url":"https://api.github.com/repos/pytest-dev/pytest/issues/11314/comments","events_url":"https://api.github.com/repos/pytest-dev/pytest/issues/11314/events","html_url":"https://github.com/pytest-dev/pytest/issues/11314","id":1851861107,"node_id":"I_kwDOAjwLdc5uYShz","number":11314,"title":"log_file_format does not default to log_format","user":{"login":"schaetzc","id":14296809,"node_id":"MDQ6VXNlcjE0Mjk2ODA5","avatar_url":"https://avatars.githubusercontent.com/u/14296809?v=4","gravatar_id":"","url":"https://api.github.com/users/schaetzc","html_url":"https://github.com/schaetzc","followers_url":"https://api.github.com/users/schaetzc/followers","following_url":"https://api.github.com/users/schaetzc/following{/other_user}","gists_url":"https://api.github.com/users/schaetzc/gists{/gist_id}","starred_url":"https://api.github.com/users/schaetzc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/schaetzc/subscriptions","organizations_url":"https://api.github.com/users/schaetzc/orgs","repos_url":"https://api.github.com/users/schaetzc/repos","events_url":"https://api.github.com/users/schaetzc/events{/privacy}","received_events_url":"https://api.github.com/users/schaetzc/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":224849195,"node_id":"MDU6TGFiZWwyMjQ4NDkxOTU=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/type:%20enhancement","name":"type: enhancement","color":"84b6eb","default":false,"description":"new feature or API change, should be merged into features branch"},{"id":763820991,"node_id":"MDU6TGFiZWw3NjM4MjA5OTE=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/plugin:%20logging","name":"plugin: logging","color":"ff5432","default":false,"description":"related to the logging builtin plugin"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2023-08-15T17:45:01Z","updated_at":"2023-09-18T18:45:57Z","closed_at":"2023-09-18T18:45:57Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"# Problem\r\n\r\n[Pytest's documentation](https://docs.pytest.org/en/7.1.x/how-to/logging.html#live-logs) states (emphasis mine)\r\n\r\n> specify `--log-cli-format` and `--log-cli-date-format` which **mirror and default to** `--log-format` and `--log-date-format` if not provided, but are applied only to the console logging handler\r\n> [...]\r\n> `--log-file-format` and `--log-file-date-format which` are **equal** to `--log-format` and `--log-date-format` but are applied to the log file logging handler\r\n\r\nThis works as intended with the `--log-cli-...` options: When I have a pytest.ini file with `log_cli = true` and run `pytest --log-format \"%(message)s\"` the console uses the specified format, even though I did not specify `--log-cli-format`, but the more general `--log-format`.\r\nFor the `--log-file-...` options, I interpreted the wording \"**equal**\" just the same as I interpreted \"**mirror and default to**\", so I was very surprised that `pytest --log-file log.txt --log-format \"%(message)s\"` did not change the log format of `log.txt`.\r\n  \r\nI debugged into _pytest and found that the option is queried using [`log_file_format = get_option_ini(config, \"log_file_format\", \"log_format\")`](https://github.com/pytest-dev/pytest/blob/73d754bd74ae8ddf86eb90cda29545cef495e927/src/_pytest/logging.py#L646) which indicates that my interpretation of the documentation is the intended behavior. However, contrary to `log_cli_format`, the `log_file_format` option is defined with a [`default=DEFAULT_LOG_FORMAT`](https://github.com/pytest-dev/pytest/blob/73d754bd74ae8ddf86eb90cda29545cef495e927/src/_pytest/logging.py#L306). This causes `get_option_ini` to return the default for `log_file_format` in every case. The additionally specified fallback `log_format` is never checked.\r\n\r\nFrom *git blame* it *seems* the commit \"[Merge the pytest-catchlog plugin](https://github.com/pytest-dev/pytest/commit/8eafbd05ca2d980b36541fbc9d547e52b6016a9a)\" introduced the bug (?) 6 years ago, affecting every version from 3.3.0 till today (). But as the name suggests, that commit did not really change the code, but only directly included it into the _pytest project. So the bug is even older than that.\r\n\r\n# Minimal Reproducible Example\r\n\r\nHere is a minimal script reproduce the unexpected behavior. I used Python 3.9 on Windows 10, but that should be irrelevant here.\r\n\r\nCreate an empty directory and add a file `test_logging.py` with content\r\n```\r\nimport logging\r\ndef test_format():\r\n    logging.error('my message')\r\n```\r\nThen run this powershell script in that directory. You should be able to run this script with minimal changes in a posix sh shell on Linux too (e.g. `python3` instead of `python` and `source venv/bin/activate` instead of `venv/Scripts/activate`).\r\n```\r\npython -m venv venv\r\nvenv\\Scripts\\activate\r\npip install pytest\r\npip freeze\r\npytest --log-file log.txt --log-format \"%(message)s\"\r\ntype log.txt\r\n```\r\nThis is the relevant output from `pytest freeze`\r\n```\r\ncolorama==0.4.6\r\nexceptiongroup==1.1.3\r\niniconfig==2.0.0\r\npackaging==23.1\r\npluggy==1.2.0\r\npytest==7.4.0\r\ntomli==2.0.1\r\n```\r\nand `type log.txt`:\r\n```\r\nERROR    root:test_logging.py:3 my message\r\n```\r\nAs you can see, the custom log format wasn't used for the file. Instead, pytest's [`DEFAULT_LOG_FORMAT`](https://github.com/pytest-dev/pytest/blob/73d754bd74ae8ddf86eb90cda29545cef495e927/src/_pytest/logging.py#L48) was used.  \r\nWhen I specify `--log-file-format \"%(message)s` instead, I get the expected `log.txt`:\r\n```\r\nmy message\r\n```\r\n\r\n# Solution\r\n\r\n**Remove the [default value for `--log-file-format`](https://github.com/pytest-dev/pytest/blob/73d754bd74ae8ddf86eb90cda29545cef495e927/src/_pytest/logging.py#L267)** so that it falls back to `--log-format` and only uses the default format if neither of them are defined. Same for [`--log-file-date-format`](https://github.com/pytest-dev/pytest/blob/73d754bd74ae8ddf86eb90cda29545cef495e927/src/_pytest/logging.py#L312).  \r\n<sub>If you want to do it like this, I can create a pull request for you. I only created this issue first, in case you wanted to keep the behavior; see below:</sub>\r\n\r\n**Alternative:** officially declare the bug as a feature, update the documentation, and remove the dead fallbacks to the general `log_format`/`log_date_format` options from the code.  \r\n<sub>I would be really sad if you went with the latter option. But it would be understandable, because the bug is ancient and I couldn't find any complains about this yet.</sub>","closed_by":{"login":"Zac-HD","id":12229877,"node_id":"MDQ6VXNlcjEyMjI5ODc3","avatar_url":"https://avatars.githubusercontent.com/u/12229877?v=4","gravatar_id":"","url":"https://api.github.com/users/Zac-HD","html_url":"https://github.com/Zac-HD","followers_url":"https://api.github.com/users/Zac-HD/followers","following_url":"https://api.github.com/users/Zac-HD/following{/other_user}","gists_url":"https://api.github.com/users/Zac-HD/gists{/gist_id}","starred_url":"https://api.github.com/users/Zac-HD/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Zac-HD/subscriptions","organizations_url":"https://api.github.com/users/Zac-HD/orgs","repos_url":"https://api.github.com/users/Zac-HD/repos","events_url":"https://api.github.com/users/Zac-HD/events{/privacy}","received_events_url":"https://api.github.com/users/Zac-HD/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/11314/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pytest-dev/pytest/issues/11314/timeline","performed_via_github_app":null,"state_reason":"completed"}