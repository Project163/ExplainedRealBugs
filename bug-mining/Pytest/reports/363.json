{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/11223","repository_url":"https://api.github.com/repos/pytest-dev/pytest","labels_url":"https://api.github.com/repos/pytest-dev/pytest/issues/11223/labels{/name}","comments_url":"https://api.github.com/repos/pytest-dev/pytest/issues/11223/comments","events_url":"https://api.github.com/repos/pytest-dev/pytest/issues/11223/events","html_url":"https://github.com/pytest-dev/pytest/issues/11223","id":1807547106,"node_id":"I_kwDOAjwLdc5rvPri","number":11223,"title":"Support __notes__ in pytest.raises","user":{"login":"ivirshup","id":8238804,"node_id":"MDQ6VXNlcjgyMzg4MDQ=","avatar_url":"https://avatars.githubusercontent.com/u/8238804?v=4","gravatar_id":"","url":"https://api.github.com/users/ivirshup","html_url":"https://github.com/ivirshup","followers_url":"https://api.github.com/users/ivirshup/followers","following_url":"https://api.github.com/users/ivirshup/following{/other_user}","gists_url":"https://api.github.com/users/ivirshup/gists{/gist_id}","starred_url":"https://api.github.com/users/ivirshup/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ivirshup/subscriptions","organizations_url":"https://api.github.com/users/ivirshup/orgs","repos_url":"https://api.github.com/users/ivirshup/repos","events_url":"https://api.github.com/users/ivirshup/events{/privacy}","received_events_url":"https://api.github.com/users/ivirshup/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2023-07-17T11:21:39Z","updated_at":"2023-07-18T11:39:41Z","closed_at":"2023-07-18T11:39:40Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I would like `pytest.raises` to have some form of support for `__notes__`.\r\n\r\n#### What's the problem this feature will solve?\r\n\r\nI am currently looking into replacing dynamic patching of error messages with the new `__notes__` feature added in [PEP-678](https://peps.python.org/pep-0678/).\r\n\r\nHowever, once I use `__notes__` my checks using `pytest.raises` now fail, and I'd like them to not. Or at least, I would like for pytest to have some features for matching these errors. Since this is a language level feature for python, I think it's usage should be covered by `pytest`.\r\n\r\n#### Describe the solution you'd like\r\n\r\nI would like the regex from `pytest.raises` to match against the notes as well as the body of the error. It would be fine for this to be specified with a keyword argument.\r\n\r\nExample of usage:\r\n\r\n```python\r\nimport pytest\r\n\r\ndef foo():\r\n    assert False\r\n\r\ndef bar():\r\n    try:\r\n        foo()\r\n    except AssertionError as e:\r\n        e.add_note(\"Raised by bar\")\r\n        raise\r\n\r\nwith pytest.raises(AssertionError, match=\"Raised by bar\"):\r\n    bar()\r\n```\r\n\r\n<!-- Provide examples of real-world use cases that this would enable and how it solves the problem described above. -->\r\n\r\n#### Alternative Solutions\r\n<!-- Have you tried to workaround the problem using a pytest plugin or other tools? Or a different approach to solving this issue? Please elaborate here. -->\r\n\r\n##### Do nothing\r\n\r\nI could manually check for notes, but I don't think python makes it obvious which part of an exception is from a note. Here is a small example of what a note looks like:\r\n\r\n<details>\r\n<summary> setup </summary>\r\n\r\n```python\r\n# Python 3.11.4 | packaged by conda-forge | (main, Jun 10 2023, 18:10:28) [Clang 15.0.7 ] on darwin\r\n# Type \"help\", \"copyright\", \"credits\" or \"license\" for more information.\r\n>>> import sys\r\n>>> \r\n>>> def add_note(err: BaseException, msg: str) -> None:\r\n...     if sys.version_info < (3, 11):\r\n...         err.__notes__ = getattr(err, \"__notes__\", []) + [msg]\r\n...     else:\r\n...         err.add_note(msg)\r\n... \r\n>>> def foo():\r\n...     raise AssertionError(\"foo is a bad function\")\r\n... \r\n>>> try:\r\n...     foo()\r\n... except AssertionError as e:\r\n...     add_note(e, \"yeah, foo is awful\")\r\n...     raise e\r\n```\r\n</details>\r\n\r\n```pytb\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 5, in <module>\r\n  File \"<stdin>\", line 2, in <module>\r\n  File \"<stdin>\", line 2, in foo\r\nAssertionError: foo is a bad function\r\nyeah, foo is awful\r\n```\r\n\r\nI think this would make it quite difficult for someone receiving an exception with notes from an upstream library to know how to match against it.\r\n\r\nI'm currently handling this with a helper function:\r\n\r\n```python\r\ndef check_error_or_notes_match(e: pytest.ExceptionInfo, pattern: str):\r\n    \"\"\"\r\n    Checks whether the printed error message or the notes contains the given pattern.\r\n\r\n    DOES NOT WORK IN IPYTHON - because of the way IPython handles exceptions\r\n    \"\"\"\r\n    import traceback\r\n\r\n    message = \"\".join(traceback.format_exception_only(e.type, e.value))\r\n    assert re.search(\r\n        pattern, message\r\n    ), f\"Could not find pattern: '{pattern}' in error:\\n\\n{message}\\n\"\r\n```\r\n\r\n\r\n#### Additional context\r\n<!-- Add any other context, links, etc. about the feature here. -->\r\n\r\nThis line would have to change: https://github.com/pytest-dev/pytest/blob/b20e7f6d0cd85f439d7963b4ae7c3c3fc908452d/src/_pytest/_code/code.py#L707.\r\n","closed_by":{"login":"nicoddemus","id":1085180,"node_id":"MDQ6VXNlcjEwODUxODA=","avatar_url":"https://avatars.githubusercontent.com/u/1085180?v=4","gravatar_id":"","url":"https://api.github.com/users/nicoddemus","html_url":"https://github.com/nicoddemus","followers_url":"https://api.github.com/users/nicoddemus/followers","following_url":"https://api.github.com/users/nicoddemus/following{/other_user}","gists_url":"https://api.github.com/users/nicoddemus/gists{/gist_id}","starred_url":"https://api.github.com/users/nicoddemus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicoddemus/subscriptions","organizations_url":"https://api.github.com/users/nicoddemus/orgs","repos_url":"https://api.github.com/users/nicoddemus/repos","events_url":"https://api.github.com/users/nicoddemus/events{/privacy}","received_events_url":"https://api.github.com/users/nicoddemus/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/11223/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pytest-dev/pytest/issues/11223/timeline","performed_via_github_app":null,"state_reason":"completed"}