{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/12659","repository_url":"https://api.github.com/repos/pytest-dev/pytest","labels_url":"https://api.github.com/repos/pytest-dev/pytest/issues/12659/labels{/name}","comments_url":"https://api.github.com/repos/pytest-dev/pytest/issues/12659/comments","events_url":"https://api.github.com/repos/pytest-dev/pytest/issues/12659/events","html_url":"https://github.com/pytest-dev/pytest/issues/12659","id":2428031170,"node_id":"I_kwDOAjwLdc6QuNDC","number":12659,"title":"pytest >=8.1.1 displays no diff for AssertionError with --import-mode=importlib","user":{"login":"devanubis","id":1054630,"node_id":"MDQ6VXNlcjEwNTQ2MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1054630?v=4","gravatar_id":"","url":"https://api.github.com/users/devanubis","html_url":"https://github.com/devanubis","followers_url":"https://api.github.com/users/devanubis/followers","following_url":"https://api.github.com/users/devanubis/following{/other_user}","gists_url":"https://api.github.com/users/devanubis/gists{/gist_id}","starred_url":"https://api.github.com/users/devanubis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/devanubis/subscriptions","organizations_url":"https://api.github.com/users/devanubis/orgs","repos_url":"https://api.github.com/users/devanubis/repos","events_url":"https://api.github.com/users/devanubis/events{/privacy}","received_events_url":"https://api.github.com/users/devanubis/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2024-07-24T16:37:40Z","updated_at":"2024-08-30T14:37:19Z","closed_at":"2024-08-30T14:37:19Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"# Description\r\n\r\nIt seems that from pytest `8.1.1` onwards, using `--import-mode=importlib` causes `AssertionError` to not render a diff in the shell output.\r\n\r\n`8.0.2` worked just fine (as did 7.x).\r\n\r\nTo reproduce, the test has to be within a package with a `__init__.py` present (which our tests are, for reasons).\r\n\r\n# Reproduction\r\n\r\nA clean environment:\r\n\r\n```shell\r\npython -m venv .venv\r\nsource .venv/bin/activate\r\npip install pytest==8.1.1\r\nmkdir tests\r\ntouch tests/__init__.py\r\n```\r\n\r\nAnd then put a simple test file in the tests dir:\r\n\r\n```python\r\ndef test():\r\n    assert \"four lights\" == \"five lights\"\r\n```\r\n\r\nAnd then run: `pytest --import-mode=importlib tests/test.py`\r\n\r\nOutputs:\r\n\r\n```\r\n=========================================== test session starts ============================================\r\nplatform linux -- Python 3.11.2, pytest-8.1.1, pluggy-1.5.0\r\nrootdir: /home/.../pytest-diff-reproduction\r\ncollected 1 item                                                                                           \r\n\r\ntests/test.py F                                                                                      [100%]\r\n\r\n================================================= FAILURES =================================================\r\n___________________________________________________ test ___________________________________________________\r\n\r\n    def test():\r\n>       assert \"four lights\" == \"five lights\"\r\nE       AssertionError\r\n\r\ntests/test.py:2: AssertionError\r\n========================================= short test summary info ==========================================\r\nFAILED tests/test.py::test - AssertionError\r\n============================================ 1 failed in 0.01s =============================================\r\n```\r\n\r\nWithout a diff after the `AssertionError`\r\n\r\nIf ran without `--import-mode=importlib` on `8.0.2` the output shows the diff:\r\n\r\n```\r\n=========================================== test session starts ============================================\r\nplatform linux -- Python 3.11.2, pytest-8.1.1, pluggy-1.5.0\r\nrootdir: /home/.../pytest-diff-reproduction\r\ncollected 1 item                                                                                           \r\n\r\ntests/test.py F                                                                                      [100%]\r\n\r\n================================================= FAILURES =================================================\r\n___________________________________________________ test ___________________________________________________\r\n\r\n    def test():\r\n>       assert \"four lights\" == \"five lights\"\r\nE       AssertionError: assert 'four lights' == 'five lights'\r\nE         \r\nE         - five lights\r\nE         + four lights\r\n\r\ntests/test.py:2: AssertionError\r\n========================================= short test summary info ==========================================\r\nFAILED tests/test.py::test - AssertionError: assert 'four lights' == 'five lights'\r\n============================================ 1 failed in 0.02s =============================================\r\n```\r\n\r\nVerbosity has no effect, no other packages need to be present (although setuptools etc from the default venv are).\r\n\r\n# Environment\r\n\r\nDebian 12, python 3.11 (but also reproduced on 3.12 too)","closed_by":{"login":"nicoddemus","id":1085180,"node_id":"MDQ6VXNlcjEwODUxODA=","avatar_url":"https://avatars.githubusercontent.com/u/1085180?v=4","gravatar_id":"","url":"https://api.github.com/users/nicoddemus","html_url":"https://github.com/nicoddemus","followers_url":"https://api.github.com/users/nicoddemus/followers","following_url":"https://api.github.com/users/nicoddemus/following{/other_user}","gists_url":"https://api.github.com/users/nicoddemus/gists{/gist_id}","starred_url":"https://api.github.com/users/nicoddemus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicoddemus/subscriptions","organizations_url":"https://api.github.com/users/nicoddemus/orgs","repos_url":"https://api.github.com/users/nicoddemus/repos","events_url":"https://api.github.com/users/nicoddemus/events{/privacy}","received_events_url":"https://api.github.com/users/nicoddemus/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/12659/reactions","total_count":5,"+1":5,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pytest-dev/pytest/issues/12659/timeline","performed_via_github_app":null,"state_reason":"completed"}