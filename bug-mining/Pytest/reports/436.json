{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/12355","repository_url":"https://api.github.com/repos/pytest-dev/pytest","labels_url":"https://api.github.com/repos/pytest-dev/pytest/issues/12355/labels{/name}","comments_url":"https://api.github.com/repos/pytest-dev/pytest/issues/12355/comments","events_url":"https://api.github.com/repos/pytest-dev/pytest/issues/12355/events","html_url":"https://github.com/pytest-dev/pytest/issues/12355","id":2310877179,"node_id":"I_kwDOAjwLdc6JvS_7","number":12355,"title":"\"Collecting\" hangs forever if mark.parametrize is used with scope session or module ","user":{"login":"adaasch","id":11362267,"node_id":"MDQ6VXNlcjExMzYyMjY3","avatar_url":"https://avatars.githubusercontent.com/u/11362267?v=4","gravatar_id":"","url":"https://api.github.com/users/adaasch","html_url":"https://github.com/adaasch","followers_url":"https://api.github.com/users/adaasch/followers","following_url":"https://api.github.com/users/adaasch/following{/other_user}","gists_url":"https://api.github.com/users/adaasch/gists{/gist_id}","starred_url":"https://api.github.com/users/adaasch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adaasch/subscriptions","organizations_url":"https://api.github.com/users/adaasch/orgs","repos_url":"https://api.github.com/users/adaasch/repos","events_url":"https://api.github.com/users/adaasch/events{/privacy}","received_events_url":"https://api.github.com/users/adaasch/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":240496914,"node_id":"MDU6TGFiZWwyNDA0OTY5MTQ=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/topic:%20parametrize","name":"topic: parametrize","color":"fbca04","default":false,"description":"related to @pytest.mark.parametrize"},{"id":288470366,"node_id":"MDU6TGFiZWwyODg0NzAzNjY=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/type:%20performance","name":"type: performance","color":"207de5","default":false,"description":"performance or memory problem/improvement"},{"id":604021555,"node_id":"MDU6TGFiZWw2MDQwMjE1NTU=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/topic:%20fixtures","name":"topic: fixtures","color":"5319e7","default":false,"description":"anything involving fixtures directly or indirectly"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2024-05-22T15:45:49Z","updated_at":"2024-06-04T07:16:20Z","closed_at":"2024-06-04T07:16:20Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"- [x] a detailed description of the bug or problem you are having\r\n\r\nIf you parametrize a test function with several parameters with `@mark.parametrize` and set scope to \"session\" or \"module\" the collection step will take forever*. Debugging shows that `_pytest/fixtures.py:fix_cache_order()` is called repeatedly:\r\n```\r\n__hash__ (/usr/lib/python3.11/enum.py:1230)\r\nfix_cache_order (.venv/lib/python3.11/site-packages/_pytest/fixtures.py:233)\r\nreorder_items_atscope (.venv/lib/python3.11/site-packages/_pytest/fixtures.py:269)\r\nreorder_items (.venv/lib/python3.11/site-packages/_pytest/fixtures.py:222)\r\npytest_collection_modifyitems (.venv/lib/python3.11/site-packages/_pytest/fixtures.py:1617)\r\n_multicall (.venv/lib/python3.11/site-packages/pluggy/_callers.py:103)\r\n_hookexec (.venv/lib/python3.11/site-packages/pluggy/_manager.py:120)\r\n__call__ (.venv/lib/python3.11/site-packages/pluggy/_hooks.py:513)\r\nperform_collect (.venv/lib/python3.11/site-packages/_pytest/main.py:814)\r\npytest_collection (.venv/lib/python3.11/site-packages/_pytest/main.py:349)\r\n_multicall (.venv/lib/python3.11/site-packages/pluggy/_callers.py:103)\r\n_hookexec (.venv/lib/python3.11/site-packages/pluggy/_manager.py:120)\r\n__call__ (.venv/lib/python3.11/site-packages/pluggy/_hooks.py:513)\r\n_main (.venv/lib/python3.11/site-packages/_pytest/main.py:338)\r\nwrap_session (.venv/lib/python3.11/site-packages/_pytest/main.py:285)\r\npytest_cmdline_main (.venv/lib/python3.11/site-packages/_pytest/main.py:332)\r\n_multicall (.venv/lib/python3.11/site-packages/pluggy/_callers.py:103)\r\n_hookexec (.venv/lib/python3.11/site-packages/pluggy/_manager.py:120)\r\n__call__ (.venv/lib/python3.11/site-packages/pluggy/_hooks.py:513)\r\nmain (.venv/lib/python3.11/site-packages/_pytest/config/__init__.py:178)\r\nconsole_main (.venv/lib/python3.11/site-packages/_pytest/config/__init__.py:206)\r\n<module> (.venv/lib/python3.11/site-packages/pytest/__main__.py:7)\r\n_run_code (/usr/lib/python3.11/runpy.py:88)\r\n_run_module_as_main (/usr/lib/python3.11/runpy.py:198)\r\n```\r\n\r\n*forever scales with the number of parameters.\r\n\r\n- [x] output of `pip list` from the virtual environment you are using\r\n```\r\nPackage                        Version   Editable project location\r\n------------------------------ --------- ------------------------------------\r\naenum                          3.1.15\r\naiohttp                        3.9.3\r\naiosignal                      1.3.1\r\nalabaster                      0.7.16\r\nastroid                        3.1.0\r\nattrs                          23.2.0\r\nBabel                          2.14.0\r\nbcrypt                         4.1.2\r\nbeautifulsoup4                 4.12.3\r\nblack                          23.12.1\r\nbuild                          1.2.1\r\nCacheControl                   0.14.0\r\ncertifi                        2024.2.2\r\ncffi                           1.16.0\r\ncfgv                           3.4.0\r\ncharset-normalizer             3.3.2\r\ncleo                           2.1.0\r\nclick                          8.1.7\r\nconstruct                      2.10.70\r\ncrashtest                      0.4.1\r\ncryptography                   42.0.5\r\ndill                           0.3.8\r\ndistlib                        0.3.8\r\ndocutils                       0.20.1\r\ndulwich                        0.21.7\r\nfastjsonschema                 2.19.1\r\nfilelock                       3.13.3\r\nfrozenlist                     1.4.1\r\nfuro                           2024.5.6\r\ngrpcio                         1.62.1\r\ngrpcio-tools                   1.62.1\r\nidentify                       2.5.35\r\nidna                           3.6\r\nimagesize                      1.4.1\r\nimportlib_metadata             7.1.0\r\niniconfig                      2.0.0\r\ninstaller                      0.7.0\r\nisort                          5.13.2\r\niterators                      0.2.0\r\njaraco.classes                 3.4.0\r\njeepney                        0.8.0\r\nJinja2                         3.1.3\r\nkeyring                        24.3.1\r\nMarkupSafe                     2.1.5\r\nmccabe                         0.7.0\r\nmore-itertools                 10.2.0\r\nmsgpack                        1.0.8\r\nmultidict                      6.0.5\r\nmypy-extensions                1.0.0\r\nnodeenv                        1.8.0\r\nnumpy                          1.26.4\r\nopencv-contrib-python-headless 4.9.0.80\r\npackaging                      24.0\r\nparamiko                       3.4.0\r\nparamiko-expect                0.3.5\r\npastel                         0.2.1\r\npathspec                       0.12.1\r\npexpect                        4.9.0\r\npip                            24.0\r\npkginfo                        1.10.0\r\nplatformdirs                   4.2.0\r\npluggy                         1.5.0\r\npoethepoet                     0.25.1\r\npoetry                         1.8.3\r\npoetry-core                    1.9.0\r\npoetry-plugin-export           1.8.0\r\npooch                          1.8.1\r\npre-commit                     3.7.0\r\nprotobuf                       4.25.3\r\nptyprocess                     0.7.0\r\npycparser                      2.22\r\npydocstyle                     6.3.0\r\nPygments                       2.17.2\r\npylint                         3.1.0\r\nPyNaCl                         1.5.0\r\npyproject_hooks                1.1.0\r\npyright                        1.1.362\r\npytest                         8.2.1\r\npytest-reportportal            5.4.1\r\nPyYAML                         6.0.1\r\nrapidfuzz                      3.9.1\r\nreportportal-client            5.5.6\r\nrequests                       2.31.0\r\nrequests-toolbelt              1.0.0\r\nrstr                           3.2.2\r\nSecretStorage                  3.3.3\r\nsetuptools                     69.2.0\r\nshellingham                    1.5.4\r\nsnowballstemmer                2.2.0\r\nsoupsieve                      2.5\r\nSphinx                         7.3.7\r\nsphinx-basic-ng                1.0.0b2\r\nsphinx-rtd-theme               2.0.0\r\nsphinxcontrib-applehelp        1.0.8\r\nsphinxcontrib-devhelp          1.0.6\r\nsphinxcontrib-htmlhelp         2.0.5\r\nsphinxcontrib-jquery           4.1\r\nsphinxcontrib-jsmath           1.0.1\r\nsphinxcontrib-qthelp           1.0.7\r\nsphinxcontrib-serializinghtml  1.1.10\r\ntimecode                       1.4.0\r\ntomli                          2.0.1\r\ntomlkit                        0.12.4\r\ntrove-classifiers              2024.5.17\r\nurllib3                        2.2.1\r\nvirtualenv                     20.25.1\r\nyarl                           1.9.4\r\nzipp                           3.18.2\r\n```\r\n\r\n- [x] pytest and operating system versions\r\n\r\n    - Linux 03b812391caf 5.10.0-29-amd64 SMP Debian 5.10.216-1 (2024-05-03) x86_64 GNU/Linux\r\n    -  Python 3.11.2\r\n    - pytest  8.2.1\r\n    - pytest 7.4.0\r\n    \r\n- [x] minimal example if possible\r\n\r\nThe issue is reproducible with pytest 7.4.0 and 8.2.1 with the following minimal example.\r\n```python\r\nfrom pytest import mark\r\n\r\nparams = ('a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z')\r\n\r\n@mark.parametrize(argnames=params, argvalues=[range(len(params))] * 3, scope=\"module\")\r\ndef test_parametrize(a, b, c, d, e, f, g, h, i, j, k, l, m, n, o, p, q, r, s, t, u, v, w, x, y, z):\r\n    pass\r\n```\r\n","closed_by":{"login":"bluetech","id":1223550,"node_id":"MDQ6VXNlcjEyMjM1NTA=","avatar_url":"https://avatars.githubusercontent.com/u/1223550?v=4","gravatar_id":"","url":"https://api.github.com/users/bluetech","html_url":"https://github.com/bluetech","followers_url":"https://api.github.com/users/bluetech/followers","following_url":"https://api.github.com/users/bluetech/following{/other_user}","gists_url":"https://api.github.com/users/bluetech/gists{/gist_id}","starred_url":"https://api.github.com/users/bluetech/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bluetech/subscriptions","organizations_url":"https://api.github.com/users/bluetech/orgs","repos_url":"https://api.github.com/users/bluetech/repos","events_url":"https://api.github.com/users/bluetech/events{/privacy}","received_events_url":"https://api.github.com/users/bluetech/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/12355/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pytest-dev/pytest/issues/12355/timeline","performed_via_github_app":null,"state_reason":"completed"}