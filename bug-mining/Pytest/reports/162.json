{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/5884","repository_url":"https://api.github.com/repos/pytest-dev/pytest","labels_url":"https://api.github.com/repos/pytest-dev/pytest/issues/5884/labels{/name}","comments_url":"https://api.github.com/repos/pytest-dev/pytest/issues/5884/comments","events_url":"https://api.github.com/repos/pytest-dev/pytest/issues/5884/events","html_url":"https://github.com/pytest-dev/pytest/issues/5884","id":499380002,"node_id":"MDU6SXNzdWU0OTkzODAwMDI=","number":5884,"title":"--setup-plan fails for yaml example in docs","user":{"login":"nedbat","id":23789,"node_id":"MDQ6VXNlcjIzNzg5","avatar_url":"https://avatars.githubusercontent.com/u/23789?v=4","gravatar_id":"","url":"https://api.github.com/users/nedbat","html_url":"https://github.com/nedbat","followers_url":"https://api.github.com/users/nedbat/followers","following_url":"https://api.github.com/users/nedbat/following{/other_user}","gists_url":"https://api.github.com/users/nedbat/gists{/gist_id}","starred_url":"https://api.github.com/users/nedbat/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nedbat/subscriptions","organizations_url":"https://api.github.com/users/nedbat/orgs","repos_url":"https://api.github.com/users/nedbat/repos","events_url":"https://api.github.com/users/nedbat/events{/privacy}","received_events_url":"https://api.github.com/users/nedbat/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":224849193,"node_id":"MDU6TGFiZWwyMjQ4NDkxOTM=","url":"https://api.github.com/repos/pytest-dev/pytest/labels/type:%20bug","name":"type: bug","color":"fc2929","default":false,"description":"problem that needs to be addressed"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2019-09-27T10:59:33Z","updated_at":"2019-09-29T01:08:37Z","closed_at":"2019-09-29T01:08:37Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I wanted to understand how custom test collection was handled.  I copied the code from [Working with non-python tests](https://docs.pytest.org/en/latest/example/nonpython.html), and tried `--setup-plan` with it.  I got an exception from inside pytest.\r\n\r\nThe files:\r\n```\r\n$ cat conftest.py\r\n# content of conftest.py\r\nimport pytest\r\n\r\n\r\ndef pytest_collect_file(parent, path):\r\n    if path.ext == \".yaml\" and path.basename.startswith(\"test\"):\r\n        return YamlFile(path, parent)\r\n\r\n\r\nclass YamlFile(pytest.File):\r\n    def collect(self):\r\n        import yaml  # we need a yaml parser, e.g. PyYAML\r\n\r\n        raw = yaml.safe_load(self.fspath.open())\r\n        for name, spec in sorted(raw.items()):\r\n            yield YamlItem(name, self, spec)\r\n\r\n\r\nclass YamlItem(pytest.Item):\r\n    def __init__(self, name, parent, spec):\r\n        super().__init__(name, parent)\r\n        self.spec = spec\r\n\r\n    def runtest(self):\r\n        for name, value in sorted(self.spec.items()):\r\n            # some custom test execution (dumb example follows)\r\n            if name != value:\r\n                raise YamlException(self, name, value)\r\n\r\n    def repr_failure(self, excinfo):\r\n        \"\"\" called when self.runtest() raises an exception. \"\"\"\r\n        if isinstance(excinfo.value, YamlException):\r\n            return \"\\n\".join(\r\n                [\r\n                    \"usecase execution failed\",\r\n                    \"   spec failed: {1!r}: {2!r}\".format(*excinfo.value.args),\r\n                    \"   no further details known at this point.\",\r\n                ]\r\n            )\r\n\r\n    def reportinfo(self):\r\n        return self.fspath, 0, \"usecase: {}\".format(self.name)\r\n\r\n\r\nclass YamlException(Exception):\r\n    \"\"\" custom exception for error reporting. \"\"\"\r\n$ cat test_simple.yaml\r\n# test_simple.yaml\r\nok:\r\n    sub1: sub1\r\n\r\nhello:\r\n    world: world\r\n    some: other\r\n```\r\nThe environment:\r\n```\r\n$ python --version\r\nPython 3.7.4\r\n\r\n$ pip list\r\nPackage            Version\r\n------------------ -------\r\natomicwrites       1.3.0\r\nattrs              19.1.0\r\nimportlib-metadata 0.23\r\nmore-itertools     7.2.0\r\npackaging          19.2\r\npip                19.2.3\r\npluggy             0.13.0\r\npy                 1.8.0\r\npyparsing          2.4.2\r\npytest             5.1.3\r\nPyYAML             5.1.2\r\nsetuptools         41.2.0\r\nsix                1.12.0\r\nwcwidth            0.1.7\r\nwheel              0.33.6\r\nzipp               0.6.0\r\n```\r\nIt behaves as shown on the page:\r\n```\r\n$ pytest\r\n==================================== test session starts =====================================\r\nplatform darwin -- Python 3.7.4, pytest-5.1.3, py-1.8.0, pluggy-0.13.0\r\nrootdir: /private/tmp/pytest_bug\r\ncollected 2 items\r\n\r\ntest_simple.yaml F.                                                                                                                                                [100%]\r\n\r\n==== FAILURES ====\r\n_______________________________________ usecase: hello _______________________________________\r\nusecase execution failed\r\n   spec failed: 'some': 'other'\r\n   no further details known at this point.\r\n================================ 1 failed, 1 passed in 0.04s =================================\r\n```\r\nBut can't show me a full plan:\r\n```\r\n$ pytest --setup-plan\r\n==================================== test session starts =====================================\r\nplatform darwin -- Python 3.7.4, pytest-5.1.3, py-1.8.0, pluggy-0.13.0\r\nrootdir: /private/tmp/pytest_bug\r\ncollected 2 items\r\n\r\ntest_simple.yaml\r\n        test_simple.yaml::hello\r\nINTERNALERROR> Traceback (most recent call last):\r\nINTERNALERROR>   File \"/usr/local/virtualenvs/tmp-68a55808020a45b9/lib/python3.7/site-packages/_pytest/main.py\", line 191, in wrap_session\r\nINTERNALERROR>     session.exitstatus = doit(config, session) or 0\r\nINTERNALERROR>   File \"/usr/local/virtualenvs/tmp-68a55808020a45b9/lib/python3.7/site-packages/_pytest/main.py\", line 235, in _main\r\nINTERNALERROR>     config.hook.pytest_runtestloop(session=session)\r\nINTERNALERROR>   File \"/usr/local/virtualenvs/tmp-68a55808020a45b9/lib/python3.7/site-packages/pluggy/hooks.py\", line 286, in __call__\r\nINTERNALERROR>     return self._hookexec(self, self.get_hookimpls(), kwargs)\r\nINTERNALERROR>   File \"/usr/local/virtualenvs/tmp-68a55808020a45b9/lib/python3.7/site-packages/pluggy/manager.py\", line 92, in _hookexec\r\nINTERNALERROR>     return self._inner_hookexec(hook, methods, kwargs)\r\nINTERNALERROR>   File \"/usr/local/virtualenvs/tmp-68a55808020a45b9/lib/python3.7/site-packages/pluggy/manager.py\", line 86, in <lambda>\r\nINTERNALERROR>     firstresult=hook.spec.opts.get(\"firstresult\") if hook.spec else False,\r\nINTERNALERROR>   File \"/usr/local/virtualenvs/tmp-68a55808020a45b9/lib/python3.7/site-packages/pluggy/callers.py\", line 208, in _multicall\r\nINTERNALERROR>     return outcome.get_result()\r\nINTERNALERROR>   File \"/usr/local/virtualenvs/tmp-68a55808020a45b9/lib/python3.7/site-packages/pluggy/callers.py\", line 80, in get_result\r\nINTERNALERROR>     raise ex[1].with_traceback(ex[2])\r\nINTERNALERROR>   File \"/usr/local/virtualenvs/tmp-68a55808020a45b9/lib/python3.7/site-packages/pluggy/callers.py\", line 187, in _multicall\r\nINTERNALERROR>     res = hook_impl.function(*args)\r\nINTERNALERROR>   File \"/usr/local/virtualenvs/tmp-68a55808020a45b9/lib/python3.7/site-packages/_pytest/main.py\", line 256, in pytest_runtestloop\r\nINTERNALERROR>     item.config.hook.pytest_runtest_protocol(item=item, nextitem=nextitem)\r\nINTERNALERROR>   File \"/usr/local/virtualenvs/tmp-68a55808020a45b9/lib/python3.7/site-packages/pluggy/hooks.py\", line 286, in __call__\r\nINTERNALERROR>     return self._hookexec(self, self.get_hookimpls(), kwargs)\r\nINTERNALERROR>   File \"/usr/local/virtualenvs/tmp-68a55808020a45b9/lib/python3.7/site-packages/pluggy/manager.py\", line 92, in _hookexec\r\nINTERNALERROR>     return self._inner_hookexec(hook, methods, kwargs)\r\nINTERNALERROR>   File \"/usr/local/virtualenvs/tmp-68a55808020a45b9/lib/python3.7/site-packages/pluggy/manager.py\", line 86, in <lambda>\r\nINTERNALERROR>     firstresult=hook.spec.opts.get(\"firstresult\") if hook.spec else False,\r\nINTERNALERROR>   File \"/usr/local/virtualenvs/tmp-68a55808020a45b9/lib/python3.7/site-packages/pluggy/callers.py\", line 208, in _multicall\r\nINTERNALERROR>     return outcome.get_result()\r\nINTERNALERROR>   File \"/usr/local/virtualenvs/tmp-68a55808020a45b9/lib/python3.7/site-packages/pluggy/callers.py\", line 80, in get_result\r\nINTERNALERROR>     raise ex[1].with_traceback(ex[2])\r\nINTERNALERROR>   File \"/usr/local/virtualenvs/tmp-68a55808020a45b9/lib/python3.7/site-packages/pluggy/callers.py\", line 187, in _multicall\r\nINTERNALERROR>     res = hook_impl.function(*args)\r\nINTERNALERROR>   File \"/usr/local/virtualenvs/tmp-68a55808020a45b9/lib/python3.7/site-packages/_pytest/runner.py\", line 72, in pytest_runtest_protocol\r\nINTERNALERROR>     runtestprotocol(item, nextitem=nextitem)\r\nINTERNALERROR>   File \"/usr/local/virtualenvs/tmp-68a55808020a45b9/lib/python3.7/site-packages/_pytest/runner.py\", line 85, in runtestprotocol\r\nINTERNALERROR>     show_test_item(item)\r\nINTERNALERROR>   File \"/usr/local/virtualenvs/tmp-68a55808020a45b9/lib/python3.7/site-packages/_pytest/runner.py\", line 103, in show_test_item\r\nINTERNALERROR>     used_fixtures = sorted(item._fixtureinfo.name2fixturedefs.keys())\r\nINTERNALERROR> AttributeError: 'YamlItem' object has no attribute '_fixtureinfo'\r\n\r\n=================================== no tests ran in 0.05s ====================================\r\n```\r\n","closed_by":{"login":"asottile","id":1810591,"node_id":"MDQ6VXNlcjE4MTA1OTE=","avatar_url":"https://avatars.githubusercontent.com/u/1810591?v=4","gravatar_id":"","url":"https://api.github.com/users/asottile","html_url":"https://github.com/asottile","followers_url":"https://api.github.com/users/asottile/followers","following_url":"https://api.github.com/users/asottile/following{/other_user}","gists_url":"https://api.github.com/users/asottile/gists{/gist_id}","starred_url":"https://api.github.com/users/asottile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/asottile/subscriptions","organizations_url":"https://api.github.com/users/asottile/orgs","repos_url":"https://api.github.com/users/asottile/repos","events_url":"https://api.github.com/users/asottile/events{/privacy}","received_events_url":"https://api.github.com/users/asottile/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/5884/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pytest-dev/pytest/issues/5884/timeline","performed_via_github_app":null,"state_reason":"completed"}