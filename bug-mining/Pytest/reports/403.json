{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/11906","repository_url":"https://api.github.com/repos/pytest-dev/pytest","labels_url":"https://api.github.com/repos/pytest-dev/pytest/issues/11906/labels{/name}","comments_url":"https://api.github.com/repos/pytest-dev/pytest/issues/11906/comments","events_url":"https://api.github.com/repos/pytest-dev/pytest/issues/11906/events","html_url":"https://github.com/pytest-dev/pytest/issues/11906","id":2112502765,"node_id":"I_kwDOAjwLdc596jvt","number":11906,"title":"Bug in 8.0.0 `pytest.warns` handling","user":{"login":"maread99","id":56914820,"node_id":"MDQ6VXNlcjU2OTE0ODIw","avatar_url":"https://avatars.githubusercontent.com/u/56914820?v=4","gravatar_id":"","url":"https://api.github.com/users/maread99","html_url":"https://github.com/maread99","followers_url":"https://api.github.com/users/maread99/followers","following_url":"https://api.github.com/users/maread99/following{/other_user}","gists_url":"https://api.github.com/users/maread99/gists{/gist_id}","starred_url":"https://api.github.com/users/maread99/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maread99/subscriptions","organizations_url":"https://api.github.com/users/maread99/orgs","repos_url":"https://api.github.com/users/maread99/repos","events_url":"https://api.github.com/users/maread99/events{/privacy}","received_events_url":"https://api.github.com/users/maread99/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2024-02-01T13:20:19Z","updated_at":"2024-02-19T12:44:04Z","closed_at":"2024-02-16T12:29:20Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\nThanks for submitting an issue!\r\n\r\nQuick check-list while reporting bugs:\r\n-->\r\n\r\nThere seems to be a handling error in 8.0.0, when `pytest.warns` fails to match the message. **Seems that the warning class itself is being called towards the end of the handling...**\r\n\r\n```python\r\nimport pytest\r\nimport warnings\r\n\r\nassert pytest.__version__ == \"8.0.0\"\r\n\r\nclass AWarning(UserWarning):\r\n    \r\n    def __init__(self, a, b):\r\n        pass\r\n\r\na, b = 1, 2\r\nwith pytest.warns(AWarning, match=\"not gonna match\"):\r\n    warnings.warn(AWarning(a, b))\r\n```\r\n```\r\n---------------------------------------------------------------------------\r\nFailed                                    Traceback (most recent call last)\r\n    [... skipping hidden 1 frame]\r\n\r\nFile ~\\...\\market_prices\\.venv\\lib\\site-packages\\_pytest\\outcomes.py:187, in fail(reason, pytrace, msg)\r\n    186 reason = _resolve_msg_to_reason(\"fail\", reason, msg)\r\n--> 187 raise Failed(msg=reason, pytrace=pytrace)\r\n\r\nFailed: DID NOT WARN. No warnings of type (<class '__main__.AWarning'>,) matching the regex were emitted.\r\n Regex: not gonna match\r\n Emitted warnings: [AWarning(1, 2)].\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTypeError                                 Traceback (most recent call last)\r\nCell In[1], line 13\r\n     11 a, b = 1, 2\r\n     12 with pytest.warns(AWarning, match=\"not gonna match\"):\r\n---> 13     warnings.warn(AWarning(a, b))\r\n\r\nFile ~\\...\\market_prices\\.venv\\lib\\site-packages\\_pytest\\recwarn.py:333, in WarningsChecker.__exit__(self, exc_type, exc_val, exc_tb)\r\n    331 for w in self:\r\n    332     if not self.matches(w):\r\n--> 333         warnings.warn_explicit(\r\n    334             str(w.message),\r\n    335             w.message.__class__,  # type: ignore[arg-type]\r\n    336             w.filename,\r\n    337             w.lineno,\r\n    338             module=w.__module__,\r\n    339             source=w.source,\r\n    340         )\r\n\r\nTypeError: __init__() missing 1 required positional argument: 'b'\r\n```\r\n\r\n**NB: only seems to happen if the Warning class takes more than one argument.** For example, if arg b is stripped from all the above then the failure to match is handled as expected.\r\n\r\nAlso, worked fine in 7.4.4:\r\n\r\n```python\r\nimport pytest\r\nimport warnings\r\n\r\nassert pytest.__version__ == \"7.4.4\"\r\n\r\nclass AWarning(UserWarning):\r\n    \r\n    def __init__(self, a, b):\r\n        pass\r\n\r\na, b = 1, 2\r\nwith pytest.warns(AWarning, match=\"not gonna match\"):\r\n    warnings.warn(AWarning(a, b))\r\n```\r\n```\r\n---------------------------------------------------------------------------\r\nFailed                                    Traceback (most recent call last)\r\nCell In[1], line 13\r\n     11 a, b = 1, 2\r\n     12 with pytest.warns(AWarning, match=\"not gonna match\"):\r\n---> 13     warnings.warn(AWarning(a, b))\r\n\r\n    [... skipping hidden 1 frame]\r\n\r\nFile ~\\...\\market_prices\\.venv\\lib\\site-packages\\_pytest\\outcomes.py:198, in fail(reason, pytrace, msg)\r\n    196 __tracebackhide__ = True\r\n    197 reason = _resolve_msg_to_reason(\"fail\", reason, msg)\r\n--> 198 raise Failed(msg=reason, pytrace=pytrace)\r\n\r\nFailed: DID NOT WARN. No warnings of type (<class '__main__.AWarning'>,) matching the regex were emitted.\r\n Regex: not gonna match\r\n Emitted warnings: [AWarning(1, 2)]\r\n```\r\n\r\nThanks is advance for looking at this!\r\n\r\nOS: 'Windows-10-10.0.22631-SP0'","closed_by":{"login":"bluetech","id":1223550,"node_id":"MDQ6VXNlcjEyMjM1NTA=","avatar_url":"https://avatars.githubusercontent.com/u/1223550?v=4","gravatar_id":"","url":"https://api.github.com/users/bluetech","html_url":"https://github.com/bluetech","followers_url":"https://api.github.com/users/bluetech/followers","following_url":"https://api.github.com/users/bluetech/following{/other_user}","gists_url":"https://api.github.com/users/bluetech/gists{/gist_id}","starred_url":"https://api.github.com/users/bluetech/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bluetech/subscriptions","organizations_url":"https://api.github.com/users/bluetech/orgs","repos_url":"https://api.github.com/users/bluetech/repos","events_url":"https://api.github.com/users/bluetech/events{/privacy}","received_events_url":"https://api.github.com/users/bluetech/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pytest-dev/pytest/issues/11906/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pytest-dev/pytest/issues/11906/timeline","performed_via_github_app":null,"state_reason":"completed"}