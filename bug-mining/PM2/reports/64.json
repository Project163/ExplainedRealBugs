{"url":"https://api.github.com/repos/Unitech/pm2/issues/1729","repository_url":"https://api.github.com/repos/Unitech/pm2","labels_url":"https://api.github.com/repos/Unitech/pm2/issues/1729/labels{/name}","comments_url":"https://api.github.com/repos/Unitech/pm2/issues/1729/comments","events_url":"https://api.github.com/repos/Unitech/pm2/issues/1729/events","html_url":"https://github.com/Unitech/pm2/issues/1729","id":114359239,"node_id":"MDU6SXNzdWUxMTQzNTkyMzk=","number":1729,"title":"0.15.8 breaks watch & restart / chokidar integration / customization.","user":{"login":"lukesneeringer","id":4346,"node_id":"MDQ6VXNlcjQzNDY=","avatar_url":"https://avatars.githubusercontent.com/u/4346?v=4","gravatar_id":"","url":"https://api.github.com/users/lukesneeringer","html_url":"https://github.com/lukesneeringer","followers_url":"https://api.github.com/users/lukesneeringer/followers","following_url":"https://api.github.com/users/lukesneeringer/following{/other_user}","gists_url":"https://api.github.com/users/lukesneeringer/gists{/gist_id}","starred_url":"https://api.github.com/users/lukesneeringer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukesneeringer/subscriptions","organizations_url":"https://api.github.com/users/lukesneeringer/orgs","repos_url":"https://api.github.com/users/lukesneeringer/repos","events_url":"https://api.github.com/users/lukesneeringer/events{/privacy}","received_events_url":"https://api.github.com/users/lukesneeringer/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":125446670,"node_id":"MDU6TGFiZWwxMjU0NDY2NzA=","url":"https://api.github.com/repos/Unitech/pm2/labels/S:%20In%20progress","name":"S: In progress","color":"9ddc80","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2015-10-30T21:28:43Z","updated_at":"2015-11-05T16:09:03Z","closed_at":"2015-11-02T10:42:26Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"The update to pm2 0.15.8 broke something in the way watching and chokidar works if you are using a JSON configuration file.\n\nGiven a configuration file such as:\n\n``` json\n{\n  \"apps\": [\n    {\n      \"autorestart\": true,\n      \"cwd\": \"/var/company_name/app_name/\",\n      \"error_file\": \"/var/log/app_name/pm2.error.log\",\n      \"exec_interpreter\": \"node\",\n      \"ignore_watch\": [\n        \".git\",\n        \".vagrant\",\n        \"node_modules\"\n      ],\n      \"name\": \"bodoni-server\",\n      \"node_args\": [\n        \"--debug=5858\"\n      ],\n      \"out_file\": \"/var/log/app_name/pm2.out.log\",\n      \"script\": \"app.js\",\n      \"watch\": true,\n      \"watch_options\": {\n        \"followSymlinks\": false,\n        \"usePolling\": true\n      }\n    }\n  ]\n}\n```\n\nThe `watch_options` are no longer passed to chokidar at all, and the `ignore_watch` is passed incorrectly.\n\nBy starting PM2 with `DEBUG=\"*\"` I was able to get the watch logs:\n\n```\n  pm2:watch Initial watch  +5ms true\n  pm2:watch Watching /var/company_name/app_name +0ms\n  pm2:watch Watch opts +0ms { ignored: '[\".git\",\".vagrant\",\"node_modules\"]',\n  persistent: true,\n  ignoreInitial: true,\n  cwd: '/var/company_name/app_name' }\n```\n\nNote that:\n- The `ignored` key is _a string that looks like an array_, rather than an actual array. This causes the `ignored` value to essentially no-op as nothing will ever match that, so your ignores do not work.\n- The `usePolling` and `followSymlinks` options are missing; they _should_ be in \"Watch opts\" since I set them in the configuration file.\n\nUsing my l33t hacking skills (also known as: being on a virtual machine and being willing to edit PM2 code on the fly to add log messages), I determined that not only is `pm2_env.ignore_watch` a string (in the context of [`lib/Watcher.js`](https://github.com/Unitech/pm2/blob/master/lib/Watcher.js) on line 35), but `pm2_env.watch_options` is also. This means that `util._extend` no-ops on line 42 and therefore `watch_options` are effectively ignored.\n\nI also confirmed that in PM2 0.5.7, `pm2_env.ignore_watch` is properly an `Array` and `pm2_env.watch_options` is properly an `Object`. Something changed in 0.5.8 to stringify them.\n\nHere's hoping this can be fixed. Watch & restart effectively does not work in pm2 0.5.8, sadly.\n\nI was not able to figure out where the env is made to submit a patch, so I took the lazy way out, gave you a bug report, and downgraded to 0.5.7.\n\nThanks for a great piece of software!\n","closed_by":{"login":"soyuka","id":1321971,"node_id":"MDQ6VXNlcjEzMjE5NzE=","avatar_url":"https://avatars.githubusercontent.com/u/1321971?v=4","gravatar_id":"","url":"https://api.github.com/users/soyuka","html_url":"https://github.com/soyuka","followers_url":"https://api.github.com/users/soyuka/followers","following_url":"https://api.github.com/users/soyuka/following{/other_user}","gists_url":"https://api.github.com/users/soyuka/gists{/gist_id}","starred_url":"https://api.github.com/users/soyuka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/soyuka/subscriptions","organizations_url":"https://api.github.com/users/soyuka/orgs","repos_url":"https://api.github.com/users/soyuka/repos","events_url":"https://api.github.com/users/soyuka/events{/privacy}","received_events_url":"https://api.github.com/users/soyuka/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/Unitech/pm2/issues/1729/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/Unitech/pm2/issues/1729/timeline","performed_via_github_app":null,"state_reason":"completed"}