{"url":"https://api.github.com/repos/Unitech/pm2/issues/3669","repository_url":"https://api.github.com/repos/Unitech/pm2","labels_url":"https://api.github.com/repos/Unitech/pm2/issues/3669/labels{/name}","comments_url":"https://api.github.com/repos/Unitech/pm2/issues/3669/comments","events_url":"https://api.github.com/repos/Unitech/pm2/issues/3669/events","html_url":"https://github.com/Unitech/pm2/issues/3669","id":323659041,"node_id":"MDU6SXNzdWUzMjM2NTkwNDE=","number":3669,"title":"Install module crash in safe mode when file used","user":{"login":"f-hj","id":11788979,"node_id":"MDQ6VXNlcjExNzg4OTc5","avatar_url":"https://avatars.githubusercontent.com/u/11788979?v=4","gravatar_id":"","url":"https://api.github.com/users/f-hj","html_url":"https://github.com/f-hj","followers_url":"https://api.github.com/users/f-hj/followers","following_url":"https://api.github.com/users/f-hj/following{/other_user}","gists_url":"https://api.github.com/users/f-hj/gists{/gist_id}","starred_url":"https://api.github.com/users/f-hj/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/f-hj/subscriptions","organizations_url":"https://api.github.com/users/f-hj/orgs","repos_url":"https://api.github.com/users/f-hj/repos","events_url":"https://api.github.com/users/f-hj/events{/privacy}","received_events_url":"https://api.github.com/users/f-hj/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2018-05-16T14:56:35Z","updated_at":"2018-07-03T12:42:54Z","closed_at":"2018-07-03T12:42:54Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## What's going wrong?\r\nSafe install module doesn't work if file is used\r\n\r\n## How could we reproduce this issue?\r\n`pm2 install myModule` when NPM servers are broken\r\nhttps://status.npmjs.org/incidents/rmv88ktdgkkr\r\n\r\n## Supporting information\r\n\r\nIf NPM servers crash, we lost the module\r\n\r\n```\r\nroot@envision-7d22e90d1977:~# PM2_HOME=/etc/pm2 pm2 install myModule\r\n[PM2][Module] Installing module myModule\r\n[PM2][Module] Module already installed. Updating.\r\nrm: could not remove directory (code ENOTEMPTY): /etc/pm2/modules/myModule/node_modules/electron/dist\r\nrm: could not remove directory (code ENOTEMPTY): /etc/pm2/modules/myModule/node_modules/electron\r\nrm: could not remove directory (code ENOTEMPTY): /etc/pm2/modules/myModule/node_modules\r\nrm: could not remove directory (code ENOTEMPTY): /etc/pm2/modules/myModule\r\n[PM2][Module] Calling [NPM] to install myModule ...\r\nnpm ERR! Unexpected end of JSON input while parsing near '...\"integrity\":\"sha512-H'\r\n\r\nnpm ERR! A complete log of this run can be found in:\r\nnpm ERR!     /home/root/.npm/_logs/2018-05-16T13_53_28_798Z-debug.log\r\n[PM2][Module] [[[[[ Module installation failure! ]]]]]\r\n[PM2][Module] [RESTORING TO PREVIOUS VERSION]\r\nrm: could not remove directory (code ENOTEMPTY): /etc/pm2/modules/myModule/node_modules/electron/dist\r\nrm: could not remove directory (code ENOTEMPTY): /etc/pm2/modules/myModule/node_modules/electron\r\nrm: could not remove directory (code ENOTEMPTY): /etc/pm2/modules/myModule/node_modules\r\nrm: could not remove directory (code ENOTEMPTY): /etc/pm2/modules/myModule\r\nmodule.js:540\r\n    throw err;\r\n    ^\r\n\r\nError: Cannot find module '/etc/pm2/modules/myModule/node_modules/myModule/package.json'\r\n    at Function.Module._resolveFilename (module.js:538:15)\r\n    at Function.Module._load (module.js:468:25)\r\n    at Module.require (module.js:587:17)\r\n    at require (/usr/lib/node_modules/pm2/node_modules/v8-compile-cache/v8-compile-cache.js:159:20)\r\n    at startModule (/usr/lib/node_modules/pm2/lib/API/Modules/Modularizer.js:268:22)\r\n    at /usr/lib/node_modules/pm2/lib/API/Modules/Modularizer.js:406:7\r\n    at /usr/lib/node_modules/pm2/lib/API/Modules/Modules.js:184:16\r\n    at /usr/lib/node_modules/pm2/lib/Client.js:648:12\r\n    at /usr/lib/node_modules/pm2/node_modules/pm2-axon-rpc/lib/client.js:45:10\r\n    at Parser.<anonymous> (/usr/lib/node_modules/pm2/node_modules/pm2-axon/lib/sockets/req.js:67:8)\r\n```\r\n```\r\nroot@envision-7d22e90d1977:~# cat /etc/pm2/pm2.log\r\n2018-05-16 06:21:04: ===============================================================================\r\n2018-05-16 06:21:04: --- New PM2 Daemon started ----------------------------------------------------\r\n2018-05-16 06:21:04: Time                 : Wed May 16 2018 06:21:04 GMT+0000 (UTC)\r\n2018-05-16 06:21:04: PM2 version          : 2.9.2-next\r\n2018-05-16 06:21:04: Node.js version      : 8.9.4\r\n2018-05-16 06:21:04: Current arch         : x64\r\n2018-05-16 06:21:04: PM2 home             : /etc/pm2\r\n2018-05-16 06:21:04: PM2 PID file         : /etc/pm2/pm2.pid\r\n2018-05-16 06:21:04: RPC socket file      : /etc/pm2/rpc.sock\r\n2018-05-16 06:21:04: BUS socket file      : /etc/pm2/pub.sock\r\n2018-05-16 06:21:04: Application log path : /etc/pm2/logs\r\n2018-05-16 06:21:04: Process dump file    : /etc/pm2/dump.pm2\r\n2018-05-16 06:21:04: Concurrent actions   : 2\r\n2018-05-16 06:21:04: SIGTERM timeout      : 1600\r\n2018-05-16 06:21:04: ===============================================================================\r\n2018-05-16 06:21:08: Starting execution sequence in -fork mode- for app name:myModule id:0\r\n2018-05-16 06:21:08: App name:myModule id:0 online\r\n2018-05-16 06:21:09: Error while getting CLK_TCK { Error: Command failed: getconf CLK_TCK\r\n/bin/sh: getconf: command not found\r\n\r\n    at ChildProcess.exithandler (child_process.js:275:12)\r\n    at emitTwo (events.js:126:13)\r\n    at ChildProcess.emit (events.js:214:7)\r\n    at maybeClose (internal/child_process.js:925:16)\r\n    at Socket.stream.socket.on (internal/child_process.js:346:11)\r\n    at emitOne (events.js:116:13)\r\n    at Socket.emit (events.js:211:7)\r\n    at Pipe._handle.close [as _onclose] (net.js:554:12) killed: false, code: 127, signal: null, cmd: 'getconf CLK_TCK' }\r\n2018-05-16 06:21:09: Error while getting PAGESIZE { Error: Command failed: getconf PAGESIZE\r\n/bin/sh: getconf: command not found\r\n\r\n    at ChildProcess.exithandler (child_process.js:275:12)\r\n    at emitTwo (events.js:126:13)\r\n    at ChildProcess.emit (events.js:214:7)\r\n    at maybeClose (internal/child_process.js:925:16)\r\n    at Socket.stream.socket.on (internal/child_process.js:346:11)\r\n    at emitOne (events.js:116:13)\r\n    at Socket.emit (events.js:211:7)\r\n    at Pipe._handle.close [as _onclose] (net.js:554:12)\r\n  killed: false,\r\n  code: 127,\r\n  signal: null,\r\n  cmd: 'getconf PAGESIZE' }\r\n2018-05-16 13:31:30: Stopping app:myModule id:0\r\n2018-05-16 13:31:30: App [myModule] with id [0] and pid [513], exited with code [1] via signal [SIGINT]\r\n2018-05-16 13:31:30: pid=513 msg=process killed\r\n```\r\nand PM2 safe mode doesn't work as expected\r\n\r\n## Solution?\r\n- Correct safe mode to ignore ENOTEMPTY when install fail?\r\n- Make `npm cache clean --force` with manual install solved the problem","closed_by":{"login":"wallet77","id":5022887,"node_id":"MDQ6VXNlcjUwMjI4ODc=","avatar_url":"https://avatars.githubusercontent.com/u/5022887?v=4","gravatar_id":"","url":"https://api.github.com/users/wallet77","html_url":"https://github.com/wallet77","followers_url":"https://api.github.com/users/wallet77/followers","following_url":"https://api.github.com/users/wallet77/following{/other_user}","gists_url":"https://api.github.com/users/wallet77/gists{/gist_id}","starred_url":"https://api.github.com/users/wallet77/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wallet77/subscriptions","organizations_url":"https://api.github.com/users/wallet77/orgs","repos_url":"https://api.github.com/users/wallet77/repos","events_url":"https://api.github.com/users/wallet77/events{/privacy}","received_events_url":"https://api.github.com/users/wallet77/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/Unitech/pm2/issues/3669/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/Unitech/pm2/issues/3669/timeline","performed_via_github_app":null,"state_reason":"completed"}