{"url":"https://api.github.com/repos/tauri-apps/tauri/issues/6375","repository_url":"https://api.github.com/repos/tauri-apps/tauri","labels_url":"https://api.github.com/repos/tauri-apps/tauri/issues/6375/labels{/name}","comments_url":"https://api.github.com/repos/tauri-apps/tauri/issues/6375/comments","events_url":"https://api.github.com/repos/tauri-apps/tauri/issues/6375/events","html_url":"https://github.com/tauri-apps/tauri/issues/6375","id":1603485266,"node_id":"I_kwDOC7lts85fkz5S","number":6375,"title":"[bug] Asset protocol crashes app with large video files","user":{"login":"mauritzn","id":11979966,"node_id":"MDQ6VXNlcjExOTc5OTY2","avatar_url":"https://avatars.githubusercontent.com/u/11979966?v=4","gravatar_id":"","url":"https://api.github.com/users/mauritzn","html_url":"https://github.com/mauritzn","followers_url":"https://api.github.com/users/mauritzn/followers","following_url":"https://api.github.com/users/mauritzn/following{/other_user}","gists_url":"https://api.github.com/users/mauritzn/gists{/gist_id}","starred_url":"https://api.github.com/users/mauritzn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mauritzn/subscriptions","organizations_url":"https://api.github.com/users/mauritzn/orgs","repos_url":"https://api.github.com/users/mauritzn/repos","events_url":"https://api.github.com/users/mauritzn/events{/privacy}","received_events_url":"https://api.github.com/users/mauritzn/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1449401604,"node_id":"MDU6TGFiZWwxNDQ5NDAxNjA0","url":"https://api.github.com/repos/tauri-apps/tauri/labels/type:%20bug","name":"type: bug","color":"B60205","default":false,"description":""},{"id":3307103594,"node_id":"MDU6TGFiZWwzMzA3MTAzNTk0","url":"https://api.github.com/repos/tauri-apps/tauri/labels/status:%20in%20progress","name":"status: in progress","color":"059372","default":false,"description":"Implementation is proceeding smoothly"},{"id":4288483270,"node_id":"LA_kwDOC7lts87_nQ_G","url":"https://api.github.com/repos/tauri-apps/tauri/labels/status:%20needs%20triage","name":"status: needs triage","color":"059372","default":false,"description":"This issue needs to triage, applied to new issues"}],"state":"closed","locked":false,"assignee":{"login":"amrbashir","id":48618675,"node_id":"MDQ6VXNlcjQ4NjE4Njc1","avatar_url":"https://avatars.githubusercontent.com/u/48618675?v=4","gravatar_id":"","url":"https://api.github.com/users/amrbashir","html_url":"https://github.com/amrbashir","followers_url":"https://api.github.com/users/amrbashir/followers","following_url":"https://api.github.com/users/amrbashir/following{/other_user}","gists_url":"https://api.github.com/users/amrbashir/gists{/gist_id}","starred_url":"https://api.github.com/users/amrbashir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/amrbashir/subscriptions","organizations_url":"https://api.github.com/users/amrbashir/orgs","repos_url":"https://api.github.com/users/amrbashir/repos","events_url":"https://api.github.com/users/amrbashir/events{/privacy}","received_events_url":"https://api.github.com/users/amrbashir/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"amrbashir","id":48618675,"node_id":"MDQ6VXNlcjQ4NjE4Njc1","avatar_url":"https://avatars.githubusercontent.com/u/48618675?v=4","gravatar_id":"","url":"https://api.github.com/users/amrbashir","html_url":"https://github.com/amrbashir","followers_url":"https://api.github.com/users/amrbashir/followers","following_url":"https://api.github.com/users/amrbashir/following{/other_user}","gists_url":"https://api.github.com/users/amrbashir/gists{/gist_id}","starred_url":"https://api.github.com/users/amrbashir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/amrbashir/subscriptions","organizations_url":"https://api.github.com/users/amrbashir/orgs","repos_url":"https://api.github.com/users/amrbashir/repos","events_url":"https://api.github.com/users/amrbashir/events{/privacy}","received_events_url":"https://api.github.com/users/amrbashir/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":23,"created_at":"2023-02-28T17:26:01Z","updated_at":"2023-05-24T19:29:58Z","closed_at":"2023-05-23T18:30:33Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\r\n\r\nWhen seeking into longer/larger videos using Tauri's asset protocol, the video will hang and eventually crash the app entirely.\r\n\r\nAfter quite a bit of testing it seems that video size is what makes Tauri's asset protocol crash the app. My original thinking was that it crashed due to the length of the video, but after generating a really long but small sized countdown video it worked fine. Then through more testing I found that videos larger than `~3.5 GiB` crashed the asset protocol when seeking roughly `80%` into the video, so when about `~3 GiB` needed to be loaded.\r\n\r\nAlso from my testing it seems that Tauri's asset protocol is seeking the entire video from `start->seek point`, which means that for longer/larger videos it takes a significant amount of time to seek into videos _(from an SSD)_. The reason I think it's seeking the entire video is due to how long the seeking takes on longer videos compared to when using a HTTP server to stream the file _(instant seeking, compared to multiple seconds sometimes with Tauri's asset protocol)_.\r\n\r\nI doubt I'm running out of memory since my computer has 32GB of RAM to use. When looking at the task manger it crashes way before all my RAM is utilized. Tauri is using around 4GB of RAM before crashing.\r\n\r\n---\r\n\r\nI have tried using the [streaming example](https://github.com/tauri-apps/tauri/tree/dev/examples/streaming), it gives the same result as the normal asset protocol.\r\n\r\n---\r\n\r\nWhen the app crashes nothing shows up in the Web DevTools or in the terminal running `tauri dev`. When running the app using `RUST_BACKTRACE` the app no longer crashes, instead the video tries to load endlessly but doesn't cause a crash anymore.\r\n\r\n---\r\n\r\n## Found temporary solution\r\n\r\nWhen I found this issue with the asset protocol I decided to embed [Rocket](https://rocket.rs/) and use it to stream the videos, sadly it had the same issue, forcing me to use a Rocket responder that handled video streaming correctly. After a while I found [rocket_seek_stream](https://github.com/rydz/rocket_seek_stream) made by [rydz](https://github.com/rydz). This fixed my issue and videos could now stream properly, seeking the video now doesn't load from `start->seek point`, instead the video is only loaded from the seek point onwards. Even though I was able to workaround the issue, I would like for Tauri's asset protocol to get fixed since I'd much rather not include Rocket in my project.\r\n\r\nWhen using `rocket_seek_stream` with Rocket the app no longer crashes and seeking inside large videos is instant.\r\n\r\n---\r\n\r\n## Crash demo\r\n\r\nhttps://user-images.githubusercontent.com/11979966/221927917-4f26e879-2950-49d2-b1f6-993d4882d15d.mp4\r\n\r\n### Reproduction\r\n\r\n_No response_\r\n\r\n### Expected behavior\r\n\r\n_No response_\r\n\r\n### Platform and versions\r\n\r\n**Environment**\r\n  - OS: Windows 10.0.22621 X64\r\n  - Webview2: 110.0.1587.57\r\n  - MSVC:\r\n      - Visual Studio Build Tools 2022\r\n      - Visual Studio Community 2019\r\n  - Node.js: 18.14.2\r\n  - npm: 9.3.1\r\n  - pnpm: Not installed!\r\n  - yarn: Not installed!\r\n  - rustup: 1.24.3\r\n  - rustc: 1.66.1\r\n  - cargo: 1.66.1\r\n  - Rust toolchain: stable-x86_64-pc-windows-msvc\r\n\r\n**Packages**\r\n  - @tauri-apps/cli [NPM]: 1.2.3\r\n  - @tauri-apps/api [NPM]: Not installed!\r\n  - tauri [RUST]: 1.2.4,\r\n  - tauri-build [RUST]: 1.2.1,\r\n  - tao [RUST]: 0.15.8,\r\n  - wry [RUST]: 0.23.4,\r\n\r\n**App**\r\n  - build-type: bundle\r\n  - CSP: default-src 'self'; style-src 'self' 'unsafe-inline'; font-src 'self' data: *; img-src 'self' asset: https://asset.localhost; media-src stream: https://stream.localhost asset: https://asset.localhost\r\n  - distDir: ../src\r\n  - devPath: ../src\r\n\r\n**App directory structure**\r\n  ├─ .git\r\n  ├─ .vscode\r\n  ├─ node_modules\r\n  ├─ src\r\n  └─ src-tauri\r\n\r\n### Stack trace\r\n\r\n_No response_\r\n\r\n### Additional context\r\n\r\nI created a [small repo](https://github.com/mauritzn/tauri-asset-bug) that allows you to pick a local video to play _(which crashes when seeking close to the end of larger files)_. I was not able to include a video file since the video file needs to be quite large _(multiple GiBs)_, as such the project allows you to pick the video file to play. The video file should be `10GiB+` to reliably crash the app, in my testing `~3.5GiB` is usually enough to crash it, but some larger video files still work _(sometimes)_, as such `10GiB+` has always been a guaranteed crash for me.\r\n\r\nThe video used should be in a format supported by browsers _(e.g. H264, VP9)_. H265 is not support since browsers do not have codec support for it.\r\n\r\nIn general the videos I've been trying to play that crash are Twitch VODs, since they are long and large _(e.g. 8+ hours, 10GiB+)_.","closed_by":{"login":"lucasfernog","id":20051258,"node_id":"MDQ6VXNlcjIwMDUxMjU4","avatar_url":"https://avatars.githubusercontent.com/u/20051258?v=4","gravatar_id":"","url":"https://api.github.com/users/lucasfernog","html_url":"https://github.com/lucasfernog","followers_url":"https://api.github.com/users/lucasfernog/followers","following_url":"https://api.github.com/users/lucasfernog/following{/other_user}","gists_url":"https://api.github.com/users/lucasfernog/gists{/gist_id}","starred_url":"https://api.github.com/users/lucasfernog/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lucasfernog/subscriptions","organizations_url":"https://api.github.com/users/lucasfernog/orgs","repos_url":"https://api.github.com/users/lucasfernog/repos","events_url":"https://api.github.com/users/lucasfernog/events{/privacy}","received_events_url":"https://api.github.com/users/lucasfernog/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/tauri-apps/tauri/issues/6375/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/tauri-apps/tauri/issues/6375/timeline","performed_via_github_app":null,"state_reason":"completed"}