{"url":"https://api.github.com/repos/tauri-apps/tauri/issues/11949","repository_url":"https://api.github.com/repos/tauri-apps/tauri","labels_url":"https://api.github.com/repos/tauri-apps/tauri/issues/11949/labels{/name}","comments_url":"https://api.github.com/repos/tauri-apps/tauri/issues/11949/comments","events_url":"https://api.github.com/repos/tauri-apps/tauri/issues/11949/events","html_url":"https://github.com/tauri-apps/tauri/issues/11949","id":2734623483,"node_id":"I_kwDOC7lts86i_wr7","number":11949,"title":"[bug] Unmanaged state panics if invoked","user":{"login":"graysonrie","id":142857749,"node_id":"U_kgDOCIPWFQ","avatar_url":"https://avatars.githubusercontent.com/u/142857749?v=4","gravatar_id":"","url":"https://api.github.com/users/graysonrie","html_url":"https://github.com/graysonrie","followers_url":"https://api.github.com/users/graysonrie/followers","following_url":"https://api.github.com/users/graysonrie/following{/other_user}","gists_url":"https://api.github.com/users/graysonrie/gists{/gist_id}","starred_url":"https://api.github.com/users/graysonrie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/graysonrie/subscriptions","organizations_url":"https://api.github.com/users/graysonrie/orgs","repos_url":"https://api.github.com/users/graysonrie/repos","events_url":"https://api.github.com/users/graysonrie/events{/privacy}","received_events_url":"https://api.github.com/users/graysonrie/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1449401604,"node_id":"MDU6TGFiZWwxNDQ5NDAxNjA0","url":"https://api.github.com/repos/tauri-apps/tauri/labels/type:%20bug","name":"type: bug","color":"B60205","default":false,"description":""},{"id":4288483270,"node_id":"LA_kwDOC7lts87_nQ_G","url":"https://api.github.com/repos/tauri-apps/tauri/labels/status:%20needs%20triage","name":"status: needs triage","color":"059372","default":false,"description":"This issue needs to triage, applied to new issues"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2024-12-12T03:10:05Z","updated_at":"2024-12-12T21:05:34Z","closed_at":"2024-12-12T21:05:34Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\r\n\r\nIn dev environments, if the frontend calls a Tauri command that uses `State<'_, T>` in its parameters and does so before `tauri::Manager::manage` gets called to manage the state, then the application will panic.\r\n\r\nMy frontend needs to perform some utility methods such as writing and reading from files as soon as it can. On many occasions, the frontend starts before the backend can fully catch up.\r\n\r\n### Reproduction\r\n\r\nTell the app to manage some state asynchronously:\r\n```rust \r\nlet some_state = SomeState::new();\r\n...\r\n.setup(|app| {\r\n    let app_handle = app.handle().clone();\r\n    tauri::async_runtime::spawn(async move {\r\n        app_handle.manage(some_state);\r\n    }\r\n    Ok(())\r\n})\r\n```\r\n\r\nMake a function that uses that state:\r\n```rust\r\n#[tauri::command]\r\nasync fn some_command(state: State<'_, SomeState>) -> Result<(), String>\r\n```\r\n\r\nCall the command as soon as possible in the frontend. In my case, I am using Angular and thus do so in my `app.component.ts`'s OnInit:\r\n```typescript\r\nasync ngOnInit() {\r\n   await invoke<void>(\"some_command\").catch(err => {console.log(err)});\r\n}\r\n```\r\nIn a dev environment, as long as the frontend started first, the app should panic.\r\n\r\n### Expected behavior\r\n\r\nIdeally, functions that return a `Result` should capture the error rather than panicking the whole program, or the user should be able to wrap the state in an `Option` in the parameters, such as:\r\n `async fn some_command(state: Option<State<'_, SomeState>>) -> Result<(), String>`\r\nand have the function deal with scenarios where the state was not managed yet.\r\n\r\n### Full `tauri info` output\r\n\r\n```text\r\n[âœ”] Environment\r\n    - OS: Windows 10.0.22631 x86_64 (X64)\r\n    âœ” WebView2: 131.0.2903.86\r\n    âœ” MSVC:\r\n        - Visual Studio Community 2019\r\n        - Visual Studio Community 2022\r\n    âœ” rustc: 1.83.0 (90b35a623 2024-11-26)\r\n    âœ” cargo: 1.83.0 (5ffbef321 2024-10-29)\r\n    âœ” rustup: 1.27.1 (54dd3d00f 2024-04-24)\r\n    âœ” Rust toolchain: stable-x86_64-pc-windows-msvc (default)\r\n    - node: 20.12.2\r\n    - yarn: 1.22.22\r\n    - npm: 10.5.0\r\n\r\n[-] Packages\r\n    - tauri ðŸ¦€: 2.1.1\r\n    - tauri-build ðŸ¦€: 2.0.3\r\n    - wry ðŸ¦€: 0.47.2\r\n    - tao ðŸ¦€: 0.30.8\r\n    - tauri-cli ðŸ¦€: 2.0.4\r\n    - @tauri-apps/api îœ˜: 2.0.3\r\n    - @tauri-apps/cli îœ˜: 2.0.5\r\n\r\n[-] Plugins\r\n    - tauri-plugin-shell ðŸ¦€: 2.0.2\r\n    - @tauri-apps/plugin-shell îœ˜: 2.0.1\r\n\r\n[-] App\r\n    - build-type: bundle\r\n    - CSP: unset\r\n    - frontendDist: ../dist/desktop-search/browser\r\n    - devUrl: http://localhost:1420/\r\n    - framework: Angular\r\n    - bundler: Webpack\r\n```\r\n\r\n\r\n### Stack trace\r\n\r\n```text\r\nthread 'main' panicked at C:\\Users\\grays\\.cargo\\registry\\src\\index.crates.io-6f17d22bba15001f\\tauri-2.1.1\\src\\state.rs:64:7:\r\nstate not managed for field `service` on command `load_json_local`. You must call `.manage()` before using this command\r\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace\r\nerror Command failed with exit code 4294967295.\r\n```\r\n\r\n\r\n### Additional context\r\n\r\nPlease let me know if there is a workaround for this. Thanks.","closed_by":{"login":"amrbashir","id":48618675,"node_id":"MDQ6VXNlcjQ4NjE4Njc1","avatar_url":"https://avatars.githubusercontent.com/u/48618675?v=4","gravatar_id":"","url":"https://api.github.com/users/amrbashir","html_url":"https://github.com/amrbashir","followers_url":"https://api.github.com/users/amrbashir/followers","following_url":"https://api.github.com/users/amrbashir/following{/other_user}","gists_url":"https://api.github.com/users/amrbashir/gists{/gist_id}","starred_url":"https://api.github.com/users/amrbashir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/amrbashir/subscriptions","organizations_url":"https://api.github.com/users/amrbashir/orgs","repos_url":"https://api.github.com/users/amrbashir/repos","events_url":"https://api.github.com/users/amrbashir/events{/privacy}","received_events_url":"https://api.github.com/users/amrbashir/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/tauri-apps/tauri/issues/11949/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/tauri-apps/tauri/issues/11949/timeline","performed_via_github_app":null,"state_reason":"completed"}