{"url":"https://api.github.com/repos/tauri-apps/tauri/issues/3883","repository_url":"https://api.github.com/repos/tauri-apps/tauri","labels_url":"https://api.github.com/repos/tauri-apps/tauri/issues/3883/labels{/name}","comments_url":"https://api.github.com/repos/tauri-apps/tauri/issues/3883/comments","events_url":"https://api.github.com/repos/tauri-apps/tauri/issues/3883/events","html_url":"https://github.com/tauri-apps/tauri/issues/3883","id":1199320230,"node_id":"I_kwDOC7lts85HfCym","number":3883,"title":"[bug] Panic on Windows if a native window is created","user":{"login":"dceddia","id":505704,"node_id":"MDQ6VXNlcjUwNTcwNA==","avatar_url":"https://avatars.githubusercontent.com/u/505704?v=4","gravatar_id":"","url":"https://api.github.com/users/dceddia","html_url":"https://github.com/dceddia","followers_url":"https://api.github.com/users/dceddia/followers","following_url":"https://api.github.com/users/dceddia/following{/other_user}","gists_url":"https://api.github.com/users/dceddia/gists{/gist_id}","starred_url":"https://api.github.com/users/dceddia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dceddia/subscriptions","organizations_url":"https://api.github.com/users/dceddia/orgs","repos_url":"https://api.github.com/users/dceddia/repos","events_url":"https://api.github.com/users/dceddia/events{/privacy}","received_events_url":"https://api.github.com/users/dceddia/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1449401604,"node_id":"MDU6TGFiZWwxNDQ5NDAxNjA0","url":"https://api.github.com/repos/tauri-apps/tauri/labels/type:%20bug","name":"type: bug","color":"B60205","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"lucasfernog","id":20051258,"node_id":"MDQ6VXNlcjIwMDUxMjU4","avatar_url":"https://avatars.githubusercontent.com/u/20051258?v=4","gravatar_id":"","url":"https://api.github.com/users/lucasfernog","html_url":"https://github.com/lucasfernog","followers_url":"https://api.github.com/users/lucasfernog/followers","following_url":"https://api.github.com/users/lucasfernog/following{/other_user}","gists_url":"https://api.github.com/users/lucasfernog/gists{/gist_id}","starred_url":"https://api.github.com/users/lucasfernog/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lucasfernog/subscriptions","organizations_url":"https://api.github.com/users/lucasfernog/orgs","repos_url":"https://api.github.com/users/lucasfernog/repos","events_url":"https://api.github.com/users/lucasfernog/events{/privacy}","received_events_url":"https://api.github.com/users/lucasfernog/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"lucasfernog","id":20051258,"node_id":"MDQ6VXNlcjIwMDUxMjU4","avatar_url":"https://avatars.githubusercontent.com/u/20051258?v=4","gravatar_id":"","url":"https://api.github.com/users/lucasfernog","html_url":"https://github.com/lucasfernog","followers_url":"https://api.github.com/users/lucasfernog/followers","following_url":"https://api.github.com/users/lucasfernog/following{/other_user}","gists_url":"https://api.github.com/users/lucasfernog/gists{/gist_id}","starred_url":"https://api.github.com/users/lucasfernog/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lucasfernog/subscriptions","organizations_url":"https://api.github.com/users/lucasfernog/orgs","repos_url":"https://api.github.com/users/lucasfernog/repos","events_url":"https://api.github.com/users/lucasfernog/events{/privacy}","received_events_url":"https://api.github.com/users/lucasfernog/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":6,"created_at":"2022-04-11T03:01:45Z","updated_at":"2022-05-13T16:47:25Z","closed_at":"2022-05-13T13:34:42Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\n\nWhen a native window is created with `AppHandle::create_tao_window`, then doing anything to the app causes it to panic. I think anything that causes a window event causes a panic.\r\n\r\nWith tauri-1.0.0-rc.4 and tao 0.6.4 this was working fine, but after updating to tauri-1.0.0-rc.6 and tao 0.7.0 it's started panicing.\n\n### Reproduction\n\nThis repo has a minimal reproduction: https://github.com/dceddia/tauri-window-hang-repro\r\n\r\nSee the stack trace below. I think the relevant part is `#5` - `tauri-runtime-wry-0.3.5\\src\\lib.rs:2447`, [here](https://github.com/tauri-apps/tauri/blob/dev/core/tauri-runtime-wry/src/lib.rs#L2447). That section looks like it's handling window events, and it seems to make the assumption that an event will definitely come from a window with a webview.\r\n\r\nThe `webview_id_map`, too, assumes that a call to `get()` will find an associated window, and unwraps the Option, which causes the panic.\r\n\r\n```rust\r\nEvent::WindowEvent {\r\n    event, window_id, ..\r\n} => {\r\n    let window_id = webview_id_map.get(&window_id);\r\n    ...\r\n```\n\n### Expected behavior\n\nNo panic :)\n\n### Platform and versions\n\n```shell\n$ yarn tauri info\r\nyarn run v1.22.17\r\n$ tauri info\r\n\r\nEnvironment\r\n  › OS: Windows 10.0.19044 X64\r\n  › Webview2: 100.0.1185.36\r\n  › MSVC:\r\n      - Visual Studio Build Tools 2019\r\n      - Visual Studio Community 2019\r\n  › Node.js: 16.9.0\r\n  › npm: 7.22.0\r\n  › pnpm: Not installed!\r\n  › yarn: 1.22.17\r\n  › rustup: 1.24.3\r\n  › rustc: 1.58.1\r\n  › cargo: 1.58.0\r\n  › Rust toolchain: stable-x86_64-pc-windows-msvc\r\n\r\nPackages\r\n  › @tauri-apps/cli [NPM]: 1.0.0-rc.7\r\n  › @tauri-apps/api [NPM]: 1.0.0-rc.3\r\n  › tauri [RUST]: 1.0.0-rc.6,\r\n  › tauri-build [RUST]: 1.0.0-rc.5,\r\n  › tao [RUST]: 0.7.0,\r\n  › wry [RUST]: 0.14.0,\r\n\r\nApp\r\n  › build-type: bundle\r\n  › CSP: unset\r\n  › distDir: ../public\r\n  › devPath: http://localhost:8080/\r\n  › framework: Svelte\r\n  › bundler: Rollup\r\n\r\nApp directory structure\r\n  ├─ .git\r\n  ├─ .vscode\r\n  ├─ node_modules\r\n  ├─ public\r\n  ├─ src\r\n  └─ src-tauri\n```\n\n\n### Stack trace\n\n```shell\nthread 'main' panicked at 'called `Option::unwrap()` on a `None` value', C:\\Users\\Dave\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tauri-runtime-wry-0.3.5\\src\\lib.rs:128:36\r\nstack backtrace:\r\n   0: std::panicking::begin_panic_handler\r\n             at /rustc/db9d1b20bba1968c1ec1fc49616d4742c1725b4b\\/library\\std\\src\\panicking.rs:498\r\n   1: core::panicking::panic_fmt\r\n             at /rustc/db9d1b20bba1968c1ec1fc49616d4742c1725b4b\\/library\\core\\src\\panicking.rs:107\r\n   2: core::panicking::panic\r\n             at /rustc/db9d1b20bba1968c1ec1fc49616d4742c1725b4b\\/library\\core\\src\\panicking.rs:48\r\n   3: enum$<core::option::Option<ref$<u64> >, 1, 18446744073709551615, Some>::unwrap<ref$<u64> >\r\n             at /rustc/db9d1b20bba1968c1ec1fc49616d4742c1725b4b\\library\\core\\src\\option.rs:746\r\n   4: tauri_runtime_wry::WebviewIdStore::get\r\n             at C:\\Users\\Dave\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tauri-runtime-wry-0.3.5\\src\\lib.rs:128\r\n   5: tauri_runtime_wry::handle_event_loop<enum$<tauri::EventLoopMessage> >\r\n             at C:\\Users\\Dave\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tauri-runtime-wry-0.3.5\\src\\lib.rs:2447\r\n   6: tauri_runtime_wry::impl$49::run::closure$0<enum$<tauri::EventLoopMessage>,tauri::app::impl$17::run::closure$0>\r\n             at C:\\Users\\Dave\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tauri-runtime-wry-0.3.5\\src\\lib.rs:1954\r\n   7: tao::platform_impl::platform::event_loop::impl$2::run_return::closure$0<enum$<tauri_runtime_wry::Message<enum$<tauri::EventLoopMessage> > >,tauri_runtime_wry::impl$49::run::closure$0>\r\n             at C:\\Users\\Dave\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tao-0.7.0\\src\\platform_impl\\windows\\event_loop.rs:225\r\n   8: alloc::boxed::impl$45::call_mut<tuple$<enum$<tao::event::Event<enum$<tauri_runtime_wry::Message<enum$<tauri::EventLoopMessage> > > > >,ref_mut$<enum$<tao::event_loop::ControlFlow> > >,dyn$<core::ops::function::FnMut<tuple$<enum$<tao::event::Event<enum$<ta\r\n             at /rustc/db9d1b20bba1968c1ec1fc49616d4742c1725b4b\\library\\alloc\\src\\boxed.rs:1701\r\n   9: tao::platform_impl::platform::event_loop::runner::impl$3::call_event_handler::closure$0<enum$<tauri_runtime_wry::Message<enum$<tauri::EventLoopMessage> > > >\r\n             at C:\\Users\\Dave\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tao-0.7.0\\src\\platform_impl\\windows\\event_loop\\runner.rs:249\r\n  10: core::panic::unwind_safe::impl$23::call_once<tuple$<>,tao::platform_impl::platform::event_loop::runner::impl$3::call_event_handler::closure$0>\r\n             at /rustc/db9d1b20bba1968c1ec1fc49616d4742c1725b4b\\library\\core\\src\\panic\\unwind_safe.rs:271\r\n  11: std::panicking::try::do_call<core::panic::unwind_safe::AssertUnwindSafe<tao::platform_impl::platform::event_loop::runner::impl$3::call_event_handler::closure$0>,tuple$<> >\r\n             at /rustc/db9d1b20bba1968c1ec1fc49616d4742c1725b4b\\library\\std\\src\\panicking.rs:406\r\n  12: core::option::impl$41::from_residual<tuple$<alloc::string::String,alloc::string::String> >\r\n  13: std::panicking::try<tuple$<>,core::panic::unwind_safe::AssertUnwindSafe<tao::platform_impl::platform::event_loop::runner::impl$3::call_event_handler::closure$0> >\r\n             at /rustc/db9d1b20bba1968c1ec1fc49616d4742c1725b4b\\library\\std\\src\\panicking.rs:370\r\n  14: std::panic::catch_unwind<core::panic::unwind_safe::AssertUnwindSafe<tao::platform_impl::platform::event_loop::runner::impl$3::call_event_handler::closure$0>,tuple$<> >\r\n             at /rustc/db9d1b20bba1968c1ec1fc49616d4742c1725b4b\\library\\std\\src\\panic.rs:133\r\n  15: tao::platform_impl::platform::event_loop::runner::EventLoopRunner<enum$<tauri_runtime_wry::Message<enum$<tauri::EventLoopMessage> > > >::catch_unwind<enum$<tauri_runtime_wry::Message<enum$<tauri::EventLoopMessage> > >,tuple$<>,tao::platform_impl::platform\r\n             at C:\\Users\\Dave\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tao-0.7.0\\src\\platform_impl\\windows\\event_loop\\runner.rs:155\r\n  16: tao::platform_impl::platform::event_loop::runner::EventLoopRunner<enum$<tauri_runtime_wry::Message<enum$<tauri::EventLoopMessage> > > >::call_event_handler<enum$<tauri_runtime_wry::Message<enum$<tauri::EventLoopMessage> > > >\r\n             at C:\\Users\\Dave\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tao-0.7.0\\src\\platform_impl\\windows\\event_loop\\runner.rs:241\r\n  17: tao::platform_impl::platform::event_loop::runner::EventLoopRunner<enum$<tauri_runtime_wry::Message<enum$<tauri::EventLoopMessage> > > >::send_event<enum$<tauri_runtime_wry::Message<enum$<tauri::EventLoopMessage> > > >\r\n             at C:\\Users\\Dave\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tao-0.7.0\\src\\platform_impl\\windows\\event_loop\\runner.rs:223\r\n  18: tao::platform_impl::platform::event_loop::SubclassInput<enum$<tauri_runtime_wry::Message<enum$<tauri::EventLoopMessage> > > >::send_event<enum$<tauri_runtime_wry::Message<enum$<tauri::EventLoopMessage> > > >\r\n             at C:\\Users\\Dave\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tao-0.7.0\\src\\platform_impl\\windows\\event_loop.rs:107\r\n  19: tao::platform_impl::platform::event_loop::public_window_callback_inner::closure$6<enum$<tauri_runtime_wry::Message<enum$<tauri::EventLoopMessage> > > >\r\n             at C:\\Users\\Dave\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tao-0.7.0\\src\\platform_impl\\windows\\event_loop.rs:1632\r\n  20: core::ops::function::FnOnce::call_once<tao::platform_impl::platform::event_loop::public_window_callback_inner::closure$6,tuple$<> >\r\n             at /rustc/db9d1b20bba1968c1ec1fc49616d4742c1725b4b\\library\\core\\src\\ops\\function.rs:227\r\n  21: core::panic::unwind_safe::impl$23::call_once<tuple$<>,tao::platform_impl::platform::event_loop::public_window_callback_inner::closure$6>\r\n             at /rustc/db9d1b20bba1968c1ec1fc49616d4742c1725b4b\\library\\core\\src\\panic\\unwind_safe.rs:271\r\n  22: std::panicking::try::do_call<core::panic::unwind_safe::AssertUnwindSafe<tao::platform_impl::platform::event_loop::public_window_callback_inner::closure$6>,tuple$<> >\r\n             at /rustc/db9d1b20bba1968c1ec1fc49616d4742c1725b4b\\library\\std\\src\\panicking.rs:406\r\n  23: core::option::impl$41::from_residual<tuple$<alloc::string::String,alloc::string::String> >\r\n  24: std::panicking::try<tuple$<>,core::panic::unwind_safe::AssertUnwindSafe<tao::platform_impl::platform::event_loop::public_window_callback_inner::closure$6> >\r\n             at /rustc/db9d1b20bba1968c1ec1fc49616d4742c1725b4b\\library\\std\\src\\panicking.rs:370\r\n  25: std::panic::catch_unwind<core::panic::unwind_safe::AssertUnwindSafe<tao::platform_impl::platform::event_loop::public_window_callback_inner::closure$6>,tuple$<> >\r\n             at /rustc/db9d1b20bba1968c1ec1fc49616d4742c1725b4b\\library\\std\\src\\panic.rs:133\r\n  26: tao::platform_impl::platform::event_loop::runner::EventLoopRunner<enum$<tauri_runtime_wry::Message<enum$<tauri::EventLoopMessage> > > >::catch_unwind<enum$<tauri_runtime_wry::Message<enum$<tauri::EventLoopMessage> > >,tuple$<>,tao::platform_impl::platform\r\n             at C:\\Users\\Dave\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tao-0.7.0\\src\\platform_impl\\windows\\event_loop\\runner.rs:155\r\n  27: tao::platform_impl::platform::event_loop::public_window_callback_inner<enum$<tauri_runtime_wry::Message<enum$<tauri::EventLoopMessage> > > >\r\n             at C:\\Users\\Dave\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tao-0.7.0\\src\\platform_impl\\windows\\event_loop.rs:1978\r\n  28: tao::platform_impl::platform::event_loop::public_window_callback<enum$<tauri_runtime_wry::Message<enum$<tauri::EventLoopMessage> > > >\r\n             at C:\\Users\\Dave\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tao-0.7.0\\src\\platform_impl\\windows\\event_loop.rs:848\r\n  29: DefSubclassProc\r\n  30: DefSubclassProc\r\n  31: CallWindowProcW\r\n  32: DispatchMessageW\r\n  33: SendMessageTimeoutW\r\n  34: KiUserCallbackDispatcher\r\n  35: NtUserGetMessage\r\n  36: GetMessageW\r\n  37: windows::Windows::Win32::UI::WindowsAndMessaging::GetMessageW<windows::Windows::Win32::Foundation::HWND>\r\n             at C:\\Users\\Dave\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\windows-0.30.0\\src\\Windows\\Win32\\UI\\WindowsAndMessaging\\mod.rs:4336\r\n  38: tao::platform_impl::platform::event_loop::EventLoop<enum$<tauri_runtime_wry::Message<enum$<tauri::EventLoopMessage> > > >::run_return<enum$<tauri_runtime_wry::Message<enum$<tauri::EventLoopMessage> > >,tauri_runtime_wry::impl$49::run::closure$0>\r\n             at C:\\Users\\Dave\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tao-0.7.0\\src\\platform_impl\\windows\\event_loop.rs:236\r\n  39: tao::platform_impl::platform::event_loop::EventLoop<enum$<tauri_runtime_wry::Message<enum$<tauri::EventLoopMessage> > > >::run<enum$<tauri_runtime_wry::Message<enum$<tauri::EventLoopMessage> > >,tauri_runtime_wry::impl$49::run::closure$0>\r\n             at C:\\Users\\Dave\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tao-0.7.0\\src\\platform_impl\\windows\\event_loop.rs:209\r\n  40: tao::event_loop::EventLoop<enum$<tauri_runtime_wry::Message<enum$<tauri::EventLoopMessage> > > >::run<enum$<tauri_runtime_wry::Message<enum$<tauri::EventLoopMessage> > >,tauri_runtime_wry::impl$49::run::closure$0>\r\n             at C:\\Users\\Dave\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tao-0.7.0\\src\\event_loop.rs:177\r\n  41: tauri_runtime_wry::impl$49::run<enum$<tauri::EventLoopMessage>,tauri::app::impl$17::run::closure$0>\r\n             at C:\\Users\\Dave\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tauri-runtime-wry-0.3.5\\src\\lib.rs:1953\r\n  42: tauri::app::App<tauri_runtime_wry::Wry<enum$<tauri::EventLoopMessage> > >::run<tauri_runtime_wry::Wry<enum$<tauri::EventLoopMessage> >,app::main::closure$0>\r\n             at C:\\Users\\Dave\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tauri-1.0.0-rc.6\\src\\app.rs:614\r\n  43: app::main\r\n             at .\\src\\main.rs:15\r\n  44: core::ops::function::FnOnce::call_once<void (*)(),tuple$<> >\r\n             at /rustc/db9d1b20bba1968c1ec1fc49616d4742c1725b4b\\library\\core\\src\\ops\\function.rs:227\r\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\n[0410/215004.211:ERROR:window_impl.cc(114)] Failed to unregister class Chrome_WidgetWin_0. Error = 0\n```\n\n\n### Additional context\n\nI'm not sure if I'm creating this window at the right time, or if I should be depending on `tao` directly here or if there's a better way, so let me know if anything could be better.\r\n\r\nThe goal of having this native window is to make an empty overlay that I can draw in with `wgpu`.","closed_by":{"login":"lucasfernog","id":20051258,"node_id":"MDQ6VXNlcjIwMDUxMjU4","avatar_url":"https://avatars.githubusercontent.com/u/20051258?v=4","gravatar_id":"","url":"https://api.github.com/users/lucasfernog","html_url":"https://github.com/lucasfernog","followers_url":"https://api.github.com/users/lucasfernog/followers","following_url":"https://api.github.com/users/lucasfernog/following{/other_user}","gists_url":"https://api.github.com/users/lucasfernog/gists{/gist_id}","starred_url":"https://api.github.com/users/lucasfernog/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lucasfernog/subscriptions","organizations_url":"https://api.github.com/users/lucasfernog/orgs","repos_url":"https://api.github.com/users/lucasfernog/repos","events_url":"https://api.github.com/users/lucasfernog/events{/privacy}","received_events_url":"https://api.github.com/users/lucasfernog/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/tauri-apps/tauri/issues/3883/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/tauri-apps/tauri/issues/3883/timeline","performed_via_github_app":null,"state_reason":"completed"}