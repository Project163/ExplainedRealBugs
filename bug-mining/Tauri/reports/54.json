{"url":"https://api.github.com/repos/tauri-apps/tauri/issues/3135","repository_url":"https://api.github.com/repos/tauri-apps/tauri","labels_url":"https://api.github.com/repos/tauri-apps/tauri/issues/3135/labels{/name}","comments_url":"https://api.github.com/repos/tauri-apps/tauri/issues/3135/comments","events_url":"https://api.github.com/repos/tauri-apps/tauri/issues/3135/events","html_url":"https://github.com/tauri-apps/tauri/issues/3135","id":1090802255,"node_id":"I_kwDOC7lts85BBFJP","number":3135,"title":"[bug] `tauri::Window` doesn't fully implement Send","user":{"login":"mihirsamdarshi","id":5462077,"node_id":"MDQ6VXNlcjU0NjIwNzc=","avatar_url":"https://avatars.githubusercontent.com/u/5462077?v=4","gravatar_id":"","url":"https://api.github.com/users/mihirsamdarshi","html_url":"https://github.com/mihirsamdarshi","followers_url":"https://api.github.com/users/mihirsamdarshi/followers","following_url":"https://api.github.com/users/mihirsamdarshi/following{/other_user}","gists_url":"https://api.github.com/users/mihirsamdarshi/gists{/gist_id}","starred_url":"https://api.github.com/users/mihirsamdarshi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mihirsamdarshi/subscriptions","organizations_url":"https://api.github.com/users/mihirsamdarshi/orgs","repos_url":"https://api.github.com/users/mihirsamdarshi/repos","events_url":"https://api.github.com/users/mihirsamdarshi/events{/privacy}","received_events_url":"https://api.github.com/users/mihirsamdarshi/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1449401604,"node_id":"MDU6TGFiZWwxNDQ5NDAxNjA0","url":"https://api.github.com/repos/tauri-apps/tauri/labels/type:%20bug","name":"type: bug","color":"B60205","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2021-12-30T00:01:16Z","updated_at":"2021-12-30T16:46:07Z","closed_at":"2021-12-30T16:46:07Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\r\n\r\nI believe there has been a regression between the last Tauri beta release and the `next` branch. \r\n\r\ni.e. this works when I set my `tauri` deps to be:\r\n```toml\r\ntauri = { version = \"1.0.0-beta.8\", features = [\"api-all\"] }\r\n```\r\nbut not:\r\n```toml\r\ntauri = { git = \"https://github.com/tauri-apps/tauri\", branch = \"next\", features = [\"api-all\"] }\r\n```\r\n\r\nWhen trying to spawn a task that requires an instance of window (in order to emit events), I am unable to send `Window` as the compiler throws a number of errors that sub-components don't to implement `Send` (see errors in stack trace section)\r\n\r\nI think that this bug is macOS only, and suspect that this may have to do more with the `tao` crate, rather than the `tauri` crate, although I am filing this bug in the `tauri` repo since I am trying to access the instance of `Window` from a `tauri::command` \r\n\r\n\r\n### Reproduction\r\nAttempt to compile the following in your `src-tauri/main.rs` file (requires Tokio)\r\n\r\n```rust\r\n#![cfg_attr(\r\nall(not(debug_assertions), target_os = \"windows\"),\r\nwindows_subsystem = \"windows\"\r\n)]\r\n\r\nuse std::time::Duration;\r\nuse tauri::Window;\r\nuse tokio::time::sleep;\r\n\r\nstruct Task {\r\n    name: String,\r\n    window: Window,\r\n}\r\n\r\nimpl Task {\r\n    fn new(name: String, window: Window) -> Task {\r\n        Task { name, window }\r\n    }\r\n\r\n    async fn run(&self) -> Result<(), String> {\r\n        println!(\"Doing task {}\", self.name);\r\n        sleep(Duration::from_secs(5)).await;\r\n        println!(\"Task {} finished\", self.name);\r\n        self.window.emit(\"taskFinished\", &self.name).expect(\"Failed to emit event\");\r\n        Ok(())\r\n    }\r\n}\r\n\r\n#[tauri::command]\r\nasync fn do_task(name: String, window: Window) -> String {\r\n    let task_name = name.clone();\r\n    tokio::spawn(async move {\r\n        let task = Task::new(task_name, window);\r\n        match task.run().await {\r\n            Ok(_) => (),\r\n            Err(e) => println!(\"Error: {}\", e),\r\n        };\r\n    });\r\n    format!(\"Task {} spawned\", name)\r\n}\r\n\r\nfn main() {\r\n    tauri::Builder::default()\r\n        .invoke_handler(tauri::generate_handler![do_task])\r\n        .run(tauri::generate_context!())\r\n        .expect(\"error while running tauri application\");\r\n}\r\n```\r\n\r\n### Expected behavior\r\n\r\n`tauri::Window` should fully implement `Send` to be allowed to be sent across threads safely, especially for long-running tasks that may need to emit events to the window that it belongs to (for example, I have written code to upload large files in a separate thread, and notifying the parent window of the progress of that upload)\r\n\r\n### Platform and versions\r\n\r\n```shell\r\nOperating System - Mac OS, version 12.1.0 X64\r\n\r\nNode.js environment\r\n  Node.js - 16.13.1\r\n  @tauri-apps/cli - 1.0.0-beta.10\r\n  @tauri-apps/api - 1.0.0-beta.8\r\n\r\nGlobal packages\r\n  npm - 8.1.2\r\n  yarn - 1.22.17\r\n\r\nRust environment\r\n  rustc - 1.59.0-nightly\r\n  cargo - 1.59.0-nightly\r\n\r\nApp directory structure\r\n/dist\r\n/node_modules\r\n/src-tauri\r\n/.idea\r\n/src\r\n\r\nApp\r\n  tauri.rs - 1.0.0-beta.8\r\n  build-type - bundle\r\n  CSP - default-src blob: data: filesystem: ws: wss: http: https: tauri: 'unsafe-eval' 'unsafe-inline' 'self' img-src: 'self'\r\n  distDir - ../dist\r\n  devPath - http://localhost:3000\r\n  framework - React\r\n```\r\n\r\n\r\n### Stack trace\r\n\r\n```shell\r\nerror: future cannot be sent between threads safely\r\n   --> src/main.rs:32:5\r\n    |\r\n32  |     tokio::spawn(async move {\r\n    |     ^^^^^^^^^^^^ future created by async block is not `Send`\r\n    |\r\n    = help: within `Task`, the trait `Sync` is not implemented for `*mut ()`\r\nnote: future is not `Send` as this value is used across an await\r\n   --> src/main.rs:34:25\r\n    |\r\n34  |         match task.run().await {\r\n    |               ----      ^^^^^^ await occurs here, with `task` maybe used later\r\n    |               |\r\n    |               has type `&Task` which is not `Send`\r\n...\r\n37  |         };\r\n    |          - `task` is later dropped here\r\nhelp: consider moving this into a `let` binding to create a shorter lived borrow\r\n   --> src/main.rs:34:15\r\n    |\r\n34  |         match task.run().await {\r\n    |               ^^^^^^^^^^\r\nnote: required by a bound in `tokio::spawn`\r\n   --> /Users/user/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.15.0/src/task/spawn.rs:127:21\r\n    |\r\n127 |         T: Future + Send + 'static,\r\n    |                     ^^^^ required by this bound in `tokio::spawn`\r\n\r\nerror: future cannot be sent between threads safely\r\n   --> src/main.rs:32:5\r\n    |\r\n32  |     tokio::spawn(async move {\r\n    |     ^^^^^^^^^^^^ future created by async block is not `Send`\r\n    |\r\n    = help: within `tao::global_shortcut::ShortcutManager`, the trait `Send` is not implemented for `*mut c_void`\r\nnote: future is not `Send` as this value is used across an await\r\n   --> src/main.rs:34:25\r\n    |\r\n34  |         match task.run().await {\r\n    |               ----      ^^^^^^ await occurs here, with `task` maybe used later\r\n    |               |\r\n    |               has type `&Task` which is not `Send`\r\n...\r\n37  |         };\r\n    |          - `task` is later dropped here\r\nhelp: consider moving this into a `let` binding to create a shorter lived borrow\r\n   --> src/main.rs:34:15\r\n    |\r\n34  |         match task.run().await {\r\n    |               ^^^^^^^^^^\r\nnote: required by a bound in `tokio::spawn`\r\n   --> /Users/user/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.15.0/src/task/spawn.rs:127:21\r\n    |\r\n127 |         T: Future + Send + 'static,\r\n    |                     ^^^^ required by this bound in `tokio::spawn`\r\n\r\nerror: future cannot be sent between threads safely\r\n   --> src/main.rs:32:5\r\n    |\r\n32  |     tokio::spawn(async move {\r\n    |     ^^^^^^^^^^^^ future created by async block is not `Send`\r\n    |\r\n    = help: within `(tao::window::WindowId, tauri_runtime_wry::WindowWrapper)`, the trait `Send` is not implemented for `Rc<tao::window::Window>`\r\nnote: future is not `Send` as this value is used across an await\r\n   --> src/main.rs:34:25\r\n    |\r\n34  |         match task.run().await {\r\n    |               ----      ^^^^^^ await occurs here, with `task` maybe used later\r\n    |               |\r\n    |               has type `&Task` which is not `Send`\r\n...\r\n37  |         };\r\n    |          - `task` is later dropped here\r\nhelp: consider moving this into a `let` binding to create a shorter lived borrow\r\n   --> src/main.rs:34:15\r\n    |\r\n34  |         match task.run().await {\r\n    |               ^^^^^^^^^^\r\nnote: required by a bound in `tokio::spawn`\r\n   --> /Users/user/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.15.0/src/task/spawn.rs:127:21\r\n    |\r\n127 |         T: Future + Send + 'static,\r\n    |                     ^^^^ required by this bound in `tokio::spawn`\r\n\r\nerror: future cannot be sent between threads safely\r\n   --> src/main.rs:32:5\r\n    |\r\n32  |     tokio::spawn(async move {\r\n    |     ^^^^^^^^^^^^ future created by async block is not `Send`\r\n    |\r\n    = help: within `(tao::window::WindowId, tauri_runtime_wry::WindowWrapper)`, the trait `Send` is not implemented for `*mut objc::runtime::Object`\r\nnote: future is not `Send` as this value is used across an await\r\n   --> src/main.rs:34:25\r\n    |\r\n34  |         match task.run().await {\r\n    |               ----      ^^^^^^ await occurs here, with `task` maybe used later\r\n    |               |\r\n    |               has type `&Task` which is not `Send`\r\n...\r\n37  |         };\r\n    |          - `task` is later dropped here\r\nhelp: consider moving this into a `let` binding to create a shorter lived borrow\r\n   --> src/main.rs:34:15\r\n    |\r\n34  |         match task.run().await {\r\n    |               ^^^^^^^^^^\r\nnote: required by a bound in `tokio::spawn`\r\n   --> /Users/user/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.15.0/src/task/spawn.rs:127:21\r\n    |\r\n127 |         T: Future + Send + 'static,\r\n    |                     ^^^^ required by this bound in `tokio::spawn`\r\n\r\nerror: future cannot be sent between threads safely\r\n   --> src/main.rs:32:5\r\n    |\r\n32  |     tokio::spawn(async move {\r\n    |     ^^^^^^^^^^^^ future created by async block is not `Send`\r\n    |\r\n    = help: within `(tao::window::WindowId, tauri_runtime_wry::WindowWrapper)`, the trait `Send` is not implemented for `*mut (Box<(dyn for<'r> Fn(&'r tao::window::Window, wry::webview::RpcRequest) -> Option<wry::webview::RpcResponse> + 'static)>, Rc<tao::window::Window>)`\r\nnote: future is not `Send` as this value is used across an await\r\n   --> src/main.rs:34:25\r\n    |\r\n34  |         match task.run().await {\r\n    |               ----      ^^^^^^ await occurs here, with `task` maybe used later\r\n    |               |\r\n    |               has type `&Task` which is not `Send`\r\n...\r\n37  |         };\r\n    |          - `task` is later dropped here\r\nhelp: consider moving this into a `let` binding to create a shorter lived borrow\r\n   --> src/main.rs:34:15\r\n    |\r\n34  |         match task.run().await {\r\n    |               ^^^^^^^^^^\r\nnote: required by a bound in `tokio::spawn`\r\n   --> /Users/user/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.15.0/src/task/spawn.rs:127:21\r\n    |\r\n127 |         T: Future + Send + 'static,\r\n    |                     ^^^^ required by this bound in `tokio::spawn`\r\n\r\nerror: future cannot be sent between threads safely\r\n   --> src/main.rs:32:5\r\n    |\r\n32  |     tokio::spawn(async move {\r\n    |     ^^^^^^^^^^^^ future created by async block is not `Send`\r\n    |\r\n    = help: within `(tao::window::WindowId, tauri_runtime_wry::WindowWrapper)`, the trait `Send` is not implemented for `*mut (Box<(dyn for<'r> Fn(&'r tao::window::Window, wry::webview::FileDropEvent) -> bool + 'static)>, Rc<tao::window::Window>)`\r\nnote: future is not `Send` as this value is used across an await\r\n   --> src/main.rs:34:25\r\n    |\r\n34  |         match task.run().await {\r\n    |               ----      ^^^^^^ await occurs here, with `task` maybe used later\r\n    |               |\r\n    |               has type `&Task` which is not `Send`\r\n...\r\n37  |         };\r\n    |          - `task` is later dropped here\r\nhelp: consider moving this into a `let` binding to create a shorter lived borrow\r\n   --> src/main.rs:34:15\r\n    |\r\n34  |         match task.run().await {\r\n    |               ^^^^^^^^^^\r\nnote: required by a bound in `tokio::spawn`\r\n   --> /Users/user/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.15.0/src/task/spawn.rs:127:21\r\n    |\r\n127 |         T: Future + Send + 'static,\r\n    |                     ^^^^ required by this bound in `tokio::spawn`\r\n\r\nerror: future cannot be sent between threads safely\r\n   --> src/main.rs:32:5\r\n    |\r\n32  |     tokio::spawn(async move {\r\n    |     ^^^^^^^^^^^^ future created by async block is not `Send`\r\n    |\r\n    = help: the trait `Send` is not implemented for `*mut Box<(dyn for<'r> Fn(&'r wry::http::request::Request) -> Result<wry::http::response::Response, wry::Error> + 'static)>`\r\nnote: future is not `Send` as this value is used across an await\r\n   --> src/main.rs:34:25\r\n    |\r\n34  |         match task.run().await {\r\n    |               ----      ^^^^^^ await occurs here, with `task` maybe used later\r\n    |               |\r\n    |               has type `&Task` which is not `Send`\r\n...\r\n37  |         };\r\n    |          - `task` is later dropped here\r\nhelp: consider moving this into a `let` binding to create a shorter lived borrow\r\n   --> src/main.rs:34:15\r\n    |\r\n34  |         match task.run().await {\r\n    |               ^^^^^^^^^^\r\nnote: required by a bound in `tokio::spawn`\r\n   --> /Users/user/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.15.0/src/task/spawn.rs:127:21\r\n    |\r\n127 |         T: Future + Send + 'static,\r\n    |                     ^^^^ required by this bound in `tokio::spawn`\r\n\r\nerror: could not compile `app` due to 7 previous errors\r\n```\r\n\r\n\r\n### Additional context\r\n\r\n_No response_","closed_by":{"login":"lucasfernog","id":20051258,"node_id":"MDQ6VXNlcjIwMDUxMjU4","avatar_url":"https://avatars.githubusercontent.com/u/20051258?v=4","gravatar_id":"","url":"https://api.github.com/users/lucasfernog","html_url":"https://github.com/lucasfernog","followers_url":"https://api.github.com/users/lucasfernog/followers","following_url":"https://api.github.com/users/lucasfernog/following{/other_user}","gists_url":"https://api.github.com/users/lucasfernog/gists{/gist_id}","starred_url":"https://api.github.com/users/lucasfernog/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lucasfernog/subscriptions","organizations_url":"https://api.github.com/users/lucasfernog/orgs","repos_url":"https://api.github.com/users/lucasfernog/repos","events_url":"https://api.github.com/users/lucasfernog/events{/privacy}","received_events_url":"https://api.github.com/users/lucasfernog/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/tauri-apps/tauri/issues/3135/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/tauri-apps/tauri/issues/3135/timeline","performed_via_github_app":null,"state_reason":"completed"}