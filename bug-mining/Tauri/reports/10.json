{"url":"https://api.github.com/repos/tauri-apps/tauri/issues/2323","repository_url":"https://api.github.com/repos/tauri-apps/tauri","labels_url":"https://api.github.com/repos/tauri-apps/tauri/issues/2323/labels{/name}","comments_url":"https://api.github.com/repos/tauri-apps/tauri/issues/2323/comments","events_url":"https://api.github.com/repos/tauri-apps/tauri/issues/2323/events","html_url":"https://github.com/tauri-apps/tauri/issues/2323","id":956071926,"node_id":"MDU6SXNzdWU5NTYwNzE5MjY=","number":2323,"title":"calling listen() emits events from the past","user":{"login":"FabianLars","id":30730186,"node_id":"MDQ6VXNlcjMwNzMwMTg2","avatar_url":"https://avatars.githubusercontent.com/u/30730186?v=4","gravatar_id":"","url":"https://api.github.com/users/FabianLars","html_url":"https://github.com/FabianLars","followers_url":"https://api.github.com/users/FabianLars/followers","following_url":"https://api.github.com/users/FabianLars/following{/other_user}","gists_url":"https://api.github.com/users/FabianLars/gists{/gist_id}","starred_url":"https://api.github.com/users/FabianLars/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/FabianLars/subscriptions","organizations_url":"https://api.github.com/users/FabianLars/orgs","repos_url":"https://api.github.com/users/FabianLars/repos","events_url":"https://api.github.com/users/FabianLars/events{/privacy}","received_events_url":"https://api.github.com/users/FabianLars/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1449401604,"node_id":"MDU6TGFiZWwxNDQ5NDAxNjA0","url":"https://api.github.com/repos/tauri-apps/tauri/labels/type:%20bug","name":"type: bug","color":"B60205","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2021-07-29T17:49:10Z","updated_at":"2021-08-09T03:10:27Z","closed_at":"2021-08-09T03:10:26Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"This will be slightly longer as i'm not able to formulate concise sentences...\r\n\r\n### **Describe the bug**\r\nFinally got the time to convert my discord message (https://discord.com/channels/616186924390023171/731495028677148753/869314406075498516) into an issue.\r\n\r\nFirst of all the steps to reproduce (with `tauri://move` as an example event):\r\n1. Have some kind of tauri app, without a event listener for the event that we want to test here. You might want to enable withGlobalTauri for this.\r\n2. Move the window around like crazy.\r\n3. Open the dev console and write `window.__TAURI__.event.listen('tauri://move', console.log)`\r\n4. Enjoy the console spam (we're talking about potentially 1000+ events)\r\n=> I didn't test this for event listeners on the rust side (yet).\r\n\r\nI found out about that while i was integrating a file-drop handler in react, where a component was able to receive files that were dropped on the window before the component was mounted (and therefore before it started listening to events).\r\n\r\nSearching for the root cause of this i found this: [event.rs](https://github.com/tauri-apps/tauri/blob/dev/core/tauri/src/endpoints/event.rs#L91-L94) and maybe this: [manager.rs](https://github.com/tauri-apps/tauri/blob/dev/core/tauri/src/manager.rs#L450) (and the loop below that).\r\nI wanted to create a PR for that, but didn't know what the best fix would be. I don't really understand why we would want to loop through the stored events on listen() anyway as it doesn't sound like expected behaviour on listener registration for me.\r\nTook me some time to realize, but what's even weirder for me is that we actually have events for that loop to iterate on.\r\n\r\nSpeaking of stored events, these also never get removed from the array, therefore the array will get realllyyyyyy big really quickly (some resizing and some moving and we're easily at 10k stored events, as these event types are quite spammy).\r\n(The array is accessible via window[some_random_id] )\r\n\r\nSo, what would be the best way to fix this?\r\nRemoving the for loop as I don't see a use case for emitting events from the past on listener registration?\r\nOnly store events in that array if there is an listener for that specific event registered?\r\nBoth?\r\nOn top of that i think it would be nice to remove events from the array after \"use\", but i'm not sure if this would be trivial as you could have multiple listeners registered for a single event.\r\n\r\n### **Expected behavior**\r\nThe event handler should only be called for events after the listen() call.\r\n\r\n### **Platform and Versions (required):**\r\ncurrent dev branch and:\r\n```\r\nOperating System - Windows, version 10.0.19043 X64\r\nWebview2 - 92.0.902.55\r\n\r\nNode.js environment\r\n  Node.js - 16.4.2\r\n  @tauri-apps/cli - 1.0.0-beta.6\r\n  @tauri-apps/api - 1.0.0-beta.5\r\n\r\nGlobal packages\r\n  npm - 7.18.1\r\n  yarn - 1.22.10\r\n\r\nRust environment\r\n  rustc - 1.53.0\r\n  cargo - 1.53.0\r\n\r\nApp\r\n  tauri.rs - 1.0.0-beta.5\r\n```","closed_by":{"login":"lucasfernog","id":20051258,"node_id":"MDQ6VXNlcjIwMDUxMjU4","avatar_url":"https://avatars.githubusercontent.com/u/20051258?v=4","gravatar_id":"","url":"https://api.github.com/users/lucasfernog","html_url":"https://github.com/lucasfernog","followers_url":"https://api.github.com/users/lucasfernog/followers","following_url":"https://api.github.com/users/lucasfernog/following{/other_user}","gists_url":"https://api.github.com/users/lucasfernog/gists{/gist_id}","starred_url":"https://api.github.com/users/lucasfernog/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lucasfernog/subscriptions","organizations_url":"https://api.github.com/users/lucasfernog/orgs","repos_url":"https://api.github.com/users/lucasfernog/repos","events_url":"https://api.github.com/users/lucasfernog/events{/privacy}","received_events_url":"https://api.github.com/users/lucasfernog/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/tauri-apps/tauri/issues/2323/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/tauri-apps/tauri/issues/2323/timeline","performed_via_github_app":null,"state_reason":"completed"}