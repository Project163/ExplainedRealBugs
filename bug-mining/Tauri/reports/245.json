{"url":"https://api.github.com/repos/tauri-apps/tauri/issues/4688","repository_url":"https://api.github.com/repos/tauri-apps/tauri","labels_url":"https://api.github.com/repos/tauri-apps/tauri/issues/4688/labels{/name}","comments_url":"https://api.github.com/repos/tauri-apps/tauri/issues/4688/comments","events_url":"https://api.github.com/repos/tauri-apps/tauri/issues/4688/events","html_url":"https://github.com/tauri-apps/tauri/issues/4688","id":1306351827,"node_id":"I_kwDOC7lts85N3VjT","number":4688,"title":"[bug] Tauri CLI does not support more than one subcommand","user":{"login":"AlexanderAni","id":52275115,"node_id":"MDQ6VXNlcjUyMjc1MTE1","avatar_url":"https://avatars.githubusercontent.com/u/52275115?v=4","gravatar_id":"","url":"https://api.github.com/users/AlexanderAni","html_url":"https://github.com/AlexanderAni","followers_url":"https://api.github.com/users/AlexanderAni/followers","following_url":"https://api.github.com/users/AlexanderAni/following{/other_user}","gists_url":"https://api.github.com/users/AlexanderAni/gists{/gist_id}","starred_url":"https://api.github.com/users/AlexanderAni/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AlexanderAni/subscriptions","organizations_url":"https://api.github.com/users/AlexanderAni/orgs","repos_url":"https://api.github.com/users/AlexanderAni/repos","events_url":"https://api.github.com/users/AlexanderAni/events{/privacy}","received_events_url":"https://api.github.com/users/AlexanderAni/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1449401604,"node_id":"MDU6TGFiZWwxNDQ5NDAxNjA0","url":"https://api.github.com/repos/tauri-apps/tauri/labels/type:%20bug","name":"type: bug","color":"B60205","default":false,"description":""},{"id":3306923091,"node_id":"MDU6TGFiZWwzMzA2OTIzMDkx","url":"https://api.github.com/repos/tauri-apps/tauri/labels/scope:%20core","name":"scope: core","color":"D4C5F9","default":false,"description":"Core packages of Tauri"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-07-15T18:17:50Z","updated_at":"2022-08-02T22:49:03Z","closed_at":"2022-08-02T22:49:03Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\r\n\r\n## Overview\r\n\r\nTauri CLI does not support more than one subcommand in command line.\r\nCurrent [CLAP](https://github.com/clap-rs/clap) implementation supports multiple subcommands.\r\n\r\nExample of multiple subcommands:\r\n\r\n```sh\r\ngit stash push\r\n```\r\n\r\nWhere:\r\n\r\n- `git` — command\r\n- `stash` — first subcommand (relative to `git`)\r\n- `push` — second subcommand (relative to `stash`)\r\n\r\n\r\n### Reproduction\r\n\r\n\r\n## 1. Create Tauri App\r\n\r\nI prefer to use [Vite](https://tauri.app/v1/guides/getting-started/setup/vite) to bootstrap Tauri App.\r\n\r\n```sh\r\nyarn create vite\r\n```\r\n\r\n## 2. Add CLI commands to Tauri config\r\n\r\nModify `tauri.conf.json` to add `git stash push` subcommands.\r\n\r\n```sh\r\ncat tauri.conf.json\r\n```\r\n\r\n```json\r\n{\r\n    \"tauri\": {\r\n        \"cli\": {\r\n            \"description\": \"Command example `git stash push`\",\r\n            \"subcommands\": {\r\n                \"git\": {\r\n                    \"subcommands\": {\r\n                        \"stash\": {\r\n                            \"subcommands\": {\r\n                                \"push\": {}\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nNote: only `cli` part of config provided.\r\n\r\n\r\n## 3. Add output on startup\r\n\r\nThis code will print raw matches and a list of subcommands in Terminal.\r\n\r\n```sh\r\ncat main.rs\r\n```\r\n\r\n```rust\r\nuse tauri::api::cli::Matches;\r\n\r\nfn main() {\r\n    let context = tauri::generate_context!();\r\n    tauri::Builder::default()\r\n        .setup(|app| {\r\n            match app.get_cli_matches() {\r\n                Ok(matches) => {\r\n                    println!(\"{:?}\", matches);\r\n                    println!(\"Subcommands:\");\r\n                    show_subcommands(matches);\r\n                },\r\n                Err(_) => panic!{\"CLI Parsing Error\"}\r\n            };\r\n            Ok(())\r\n        })\r\n        .menu(tauri::Menu::os_default(&context.package_info().name))\r\n        .run(context)\r\n        .expect(\"Error while running Tauri application.\");\r\n}\r\n\r\nfn show_subcommands(matches: Matches) {\r\n    match matches.subcommand {\r\n        Some(command) => {\r\n            println!(\"\\t`{}`\", command.name);\r\n            show_subcommands(command.matches);\r\n        },\r\n        None => {}\r\n    };\r\n}\r\n```\r\n\r\n## 4. Check the results\r\n\r\nYou can check the results without building an application.\r\n\r\n```sh\r\ncargo tauri dev git stash push\r\n```\r\n\r\n\r\n### Expected behavior\r\n\r\n## Current Result:\r\n\r\n```sh\r\nMatches { args: {}, subcommand: Some(SubcommandMatches { name: \"git\", matches: Matches { args: {}, subcommand: None } }) }\r\nSubcommands:\r\n    `git`\r\n```\r\n\r\n- Extracted only 1 subcommand `git` instead of 3 subcommands (`git`, `stash`, `push`).\r\n\r\n## Expected Result:\r\n\r\n```sh\r\nMatches { args: {}, subcommand: Some(SubcommandMatches { name: \"git\", matches: Matches { args: {}, subcommand: Some(SubcommandMatches { name: \"stash\", matches: Matches { args: {}, subcommand: Some(SubcommandMatches { name: \"push\", matches: Matches { args: {}, subcommand: None } }) } }) } }) }\r\nSubcommands:\r\n    `git`\r\n    `stash`\r\n    `push`\r\n```\r\n\r\n- Extracted all 3 subcommands: `git`, `stash`, `push`.\r\n\r\n\r\n### Platform and versions\r\n\r\n```shell\r\nEnvironment\r\n  › OS: Linux Mint 20.3 X64\r\n  › Node.js: 18.5.0\r\n  › npm: 8.12.1\r\n  › pnpm: Not installed!\r\n  › yarn: 1.22.17\r\n  › rustup: Not installed!\r\n  › rustc: 1.62.0\r\n  › cargo: 1.62.0\r\n  › Rust toolchain: \r\n\r\nPackages\r\n  › @tauri-apps/cli [NPM]: 1.0.0\r\n  › @tauri-apps/api [NPM]: 1.0.1\r\n  › tauri [RUST]: 1.0.4,\r\n  › tauri-build [RUST]: 1.0.4,\r\n  › tao [RUST]: 0.12.1,\r\n  › wry [RUST]: 0.19.0,\r\n\r\nApp\r\n  › build-type: bundle\r\n  › CSP: unset\r\n  › distDir: ../dist\r\n  › devPath: http://localhost:3000/\r\n\r\nApp directory structure\r\n  ├─ src\r\n  ├─ node_modules\r\n  └─ src-tauri\r\n```\r\n\r\n\r\n### Stack trace\r\n\r\n_not applicable_\r\n\r\n### Additional context\r\n\r\n## Reference: Current Source code\r\n\r\nCurrent commit: [7386084](https://github.com/tauri-apps/tauri/blob/73860840a6618a6f4b95bea4c1ba3622b0d922ef/core/tauri/src/api/cli.rs#L134).\r\n\r\n```rust\r\nfn get_matches_internal(config: &CliConfig, matches: &ArgMatches) -> Matches {\r\n    let mut cli_matches = Matches::default();\r\n    map_matches(config, matches, &mut cli_matches);\r\n\r\n    if let Some((subcommand_name, subcommand_matches)) = matches.subcommand() {\r\n        let mut subcommand_cli_matches = Matches::default();\r\n        map_matches(\r\n            config.subcommands().unwrap().get(subcommand_name).unwrap(),\r\n            subcommand_matches,\r\n            &mut subcommand_cli_matches,\r\n        );\r\n        cli_matches.set_subcommand(subcommand_name.to_string(), subcommand_cli_matches);\r\n    }\r\n\r\n    cli_matches\r\n}\r\n\r\nfn map_matches(config: &CliConfig, matches: &ArgMatches, cli_matches: &mut Matches) {\r\n    if let Some(args) = config.args() {\r\n        for arg in args {\r\n            #[allow(deprecated)]\r\n            let occurrences = matches.occurrences_of(arg.name.clone());\r\n            let value = if occurrences == 0 || !arg.takes_value {\r\n                Value::Bool(occurrences > 0)\r\n            } else if arg.multiple {\r\n                #[allow(deprecated)]\r\n                matches\r\n                    .values_of(arg.name.clone())\r\n                    .map(|v| {\r\n                        let mut values = Vec::new();\r\n                        for value in v {\r\n                            values.push(Value::String(value.to_string()));\r\n                        }\r\n                        Value::Array(values)\r\n                    })\r\n                    .unwrap_or(Value::Null)\r\n            } else {\r\n                #[allow(deprecated)]\r\n                matches\r\n                    .value_of(arg.name.clone())\r\n                    .map(|v| Value::String(v.to_string()))\r\n                    .unwrap_or(Value::Null)\r\n            };\r\n\r\n            cli_matches.set_arg(arg.name.clone(), ArgData { value, occurrences });\r\n        }\r\n    }\r\n}\r\n\r\n```","closed_by":{"login":"lucasfernog","id":20051258,"node_id":"MDQ6VXNlcjIwMDUxMjU4","avatar_url":"https://avatars.githubusercontent.com/u/20051258?v=4","gravatar_id":"","url":"https://api.github.com/users/lucasfernog","html_url":"https://github.com/lucasfernog","followers_url":"https://api.github.com/users/lucasfernog/followers","following_url":"https://api.github.com/users/lucasfernog/following{/other_user}","gists_url":"https://api.github.com/users/lucasfernog/gists{/gist_id}","starred_url":"https://api.github.com/users/lucasfernog/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lucasfernog/subscriptions","organizations_url":"https://api.github.com/users/lucasfernog/orgs","repos_url":"https://api.github.com/users/lucasfernog/repos","events_url":"https://api.github.com/users/lucasfernog/events{/privacy}","received_events_url":"https://api.github.com/users/lucasfernog/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/tauri-apps/tauri/issues/4688/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/tauri-apps/tauri/issues/4688/timeline","performed_via_github_app":null,"state_reason":"completed"}