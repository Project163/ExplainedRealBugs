{"url":"https://api.github.com/repos/tauri-apps/tauri/issues/7922","repository_url":"https://api.github.com/repos/tauri-apps/tauri","labels_url":"https://api.github.com/repos/tauri-apps/tauri/issues/7922/labels{/name}","comments_url":"https://api.github.com/repos/tauri-apps/tauri/issues/7922/comments","events_url":"https://api.github.com/repos/tauri-apps/tauri/issues/7922/events","html_url":"https://github.com/tauri-apps/tauri/issues/7922","id":1919465252,"node_id":"I_kwDOC7lts85yaLck","number":7922,"title":"Multipart upload to AWS S3 via Tauri HTTP API is challenging (and may not be possible with Blobs?)","user":{"login":"MGough","id":6558104,"node_id":"MDQ6VXNlcjY1NTgxMDQ=","avatar_url":"https://avatars.githubusercontent.com/u/6558104?v=4","gravatar_id":"","url":"https://api.github.com/users/MGough","html_url":"https://github.com/MGough","followers_url":"https://api.github.com/users/MGough/followers","following_url":"https://api.github.com/users/MGough/following{/other_user}","gists_url":"https://api.github.com/users/MGough/gists{/gist_id}","starred_url":"https://api.github.com/users/MGough/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MGough/subscriptions","organizations_url":"https://api.github.com/users/MGough/orgs","repos_url":"https://api.github.com/users/MGough/repos","events_url":"https://api.github.com/users/MGough/events{/privacy}","received_events_url":"https://api.github.com/users/MGough/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2023-09-29T15:15:31Z","updated_at":"2024-01-10T19:03:34Z","closed_at":"2024-01-10T19:03:34Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Tauri v1.4 with `\"http-multipart\"` and `\"reqwest-client\"` enabled.\r\n\r\nTrying to use Tauri's HTTP API for uploading a file to S3 has a few challenges. This isn't S3 specific though, it's just an example of the issue.\r\n\r\n### Body.form() item ordering\r\nWhen sending multipart form data to S3, AWS requires that the `file` key is the last element in the HTTP request body ([See AWS Docs](https://docs.aws.amazon.com/AmazonS3/latest/API/RESTObjectPOST.html) - 'When constructing your request, make sure that the file field is the last field in the form.').\r\n\r\nWhen using the browser `FormData` this is fine, as in modern javascript the order of insertion is maintained, so you just add the `file` key last:\r\n```ts\r\n  Object.keys(fieldsFromS3).forEach((key) => {\r\n    formData.append(key, fieldsFromS3[key]);\r\n  });\r\n\r\n  if (file || fileName) {\r\n    formData.append(\"file\", file, fileName);\r\n  }\r\n```\r\n\r\nHowever when using `Body.form({ ...fieldsFromS3, file })` it appears the order is not maintained, nor specifiable. [Looks like the rust side is just using a HashMap which doesn't maintain the ordering](https://github.com/tauri-apps/tauri/blob/c001a91d15fa363dad2a231cfe06d77e82b6460d/core/tauri/src/api/http.rs#L255)\r\n\r\nThe first time I ran this it was fine, however subsuquent attempts I realised (with help of a MITM proxy) that it was shuffling the form key order.\r\n\r\nThis may seem minor particularly as `FormData()` can handle it fine, and _could_ just be a documentation issue, however...\r\n\r\n### FormData throws 'no such file or directory' error\r\nSo trying to avoid the use of `Body.form` and sticking to the general approach of using the browser built in.\r\n\r\nThe challenge here is that code like this has an undesirable side effect:\r\n```ts\r\n  const fileName = \"myBlob\";\r\n  const someDataToUpload = new Blob([\"some data\"]);\r\n  const formData = new FormData();\r\n\r\n  Object.keys(uploadFields).forEach((key) => {\r\n    formData.append(key, uploadFields[key]);\r\n  });\r\n\r\n  formData.append(\"file\", someDataToUpload, fileName);\r\n\r\n   const s3Result = await fetch(uploadUrl, {\r\n     method: \"POST\",\r\n     body: Body.form(formData),\r\n     headers: {\r\n        \"content-type\": \"multipart/form-data\",\r\n     },\r\n   });\r\n```\r\nHowever something strange happens with `fileName`. It doesn't refer to an actual file, as we're using a `Blob`, but unless `myBlob` is in the `fs` scope:\r\n```\r\n      \"fs\": {\r\n        \"scope\": [\"myBlob\"]\r\n       }\r\n```\r\nThen an error will occur due to it not being in scope (`Unhandled Promise Rejection: path not allowed on the configured scope: myBlob`). However adding it to scope doesn't fix the issue, as it then throws an error as the file or directory does not exist (`Unhandled Promise Rejection: No such file or directory (os error 2)`). \r\n\r\nIt seems like the tauri side is trying to do some inspection on this file path assuming that it is a real file rather than just a filename being provided to S3.\r\n\r\nI appreciate there are ways to do this using the native browser fetch, and the only real benefit to the tauri fetch here may be CORS (or in some cases handling of native system proxies), so this may not be particularly high priority. But it is a bit of an undocumented rabbit hole where things don't work as you'd expect.\r\n","closed_by":{"login":"amrbashir","id":48618675,"node_id":"MDQ6VXNlcjQ4NjE4Njc1","avatar_url":"https://avatars.githubusercontent.com/u/48618675?v=4","gravatar_id":"","url":"https://api.github.com/users/amrbashir","html_url":"https://github.com/amrbashir","followers_url":"https://api.github.com/users/amrbashir/followers","following_url":"https://api.github.com/users/amrbashir/following{/other_user}","gists_url":"https://api.github.com/users/amrbashir/gists{/gist_id}","starred_url":"https://api.github.com/users/amrbashir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/amrbashir/subscriptions","organizations_url":"https://api.github.com/users/amrbashir/orgs","repos_url":"https://api.github.com/users/amrbashir/repos","events_url":"https://api.github.com/users/amrbashir/events{/privacy}","received_events_url":"https://api.github.com/users/amrbashir/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/tauri-apps/tauri/issues/7922/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/tauri-apps/tauri/issues/7922/timeline","performed_via_github_app":null,"state_reason":"completed"}