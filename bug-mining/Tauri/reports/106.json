{"url":"https://api.github.com/repos/tauri-apps/tauri/issues/3608","repository_url":"https://api.github.com/repos/tauri-apps/tauri","labels_url":"https://api.github.com/repos/tauri-apps/tauri/issues/3608/labels{/name}","comments_url":"https://api.github.com/repos/tauri-apps/tauri/issues/3608/comments","events_url":"https://api.github.com/repos/tauri-apps/tauri/issues/3608/events","html_url":"https://github.com/tauri-apps/tauri/issues/3608","id":1158825129,"node_id":"I_kwDOC7lts85FEkSp","number":3608,"title":"[bug] app_handle.tray_handle().set_menu() does not appear to update menu item IDs, leading to a crash when new items are selected","user":{"login":"rscarson","id":1036584,"node_id":"MDQ6VXNlcjEwMzY1ODQ=","avatar_url":"https://avatars.githubusercontent.com/u/1036584?v=4","gravatar_id":"","url":"https://api.github.com/users/rscarson","html_url":"https://github.com/rscarson","followers_url":"https://api.github.com/users/rscarson/followers","following_url":"https://api.github.com/users/rscarson/following{/other_user}","gists_url":"https://api.github.com/users/rscarson/gists{/gist_id}","starred_url":"https://api.github.com/users/rscarson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rscarson/subscriptions","organizations_url":"https://api.github.com/users/rscarson/orgs","repos_url":"https://api.github.com/users/rscarson/repos","events_url":"https://api.github.com/users/rscarson/events{/privacy}","received_events_url":"https://api.github.com/users/rscarson/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1449401604,"node_id":"MDU6TGFiZWwxNDQ5NDAxNjA0","url":"https://api.github.com/repos/tauri-apps/tauri/labels/type:%20bug","name":"type: bug","color":"B60205","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"lucasfernog","id":20051258,"node_id":"MDQ6VXNlcjIwMDUxMjU4","avatar_url":"https://avatars.githubusercontent.com/u/20051258?v=4","gravatar_id":"","url":"https://api.github.com/users/lucasfernog","html_url":"https://github.com/lucasfernog","followers_url":"https://api.github.com/users/lucasfernog/followers","following_url":"https://api.github.com/users/lucasfernog/following{/other_user}","gists_url":"https://api.github.com/users/lucasfernog/gists{/gist_id}","starred_url":"https://api.github.com/users/lucasfernog/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lucasfernog/subscriptions","organizations_url":"https://api.github.com/users/lucasfernog/orgs","repos_url":"https://api.github.com/users/lucasfernog/repos","events_url":"https://api.github.com/users/lucasfernog/events{/privacy}","received_events_url":"https://api.github.com/users/lucasfernog/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"lucasfernog","id":20051258,"node_id":"MDQ6VXNlcjIwMDUxMjU4","avatar_url":"https://avatars.githubusercontent.com/u/20051258?v=4","gravatar_id":"","url":"https://api.github.com/users/lucasfernog","html_url":"https://github.com/lucasfernog","followers_url":"https://api.github.com/users/lucasfernog/followers","following_url":"https://api.github.com/users/lucasfernog/following{/other_user}","gists_url":"https://api.github.com/users/lucasfernog/gists{/gist_id}","starred_url":"https://api.github.com/users/lucasfernog/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lucasfernog/subscriptions","organizations_url":"https://api.github.com/users/lucasfernog/orgs","repos_url":"https://api.github.com/users/lucasfernog/repos","events_url":"https://api.github.com/users/lucasfernog/events{/privacy}","received_events_url":"https://api.github.com/users/lucasfernog/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":1,"created_at":"2022-03-03T19:40:06Z","updated_at":"2022-03-04T19:00:05Z","closed_at":"2022-03-04T19:00:04Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\n\n`app_handle.tray_handle().set_menu()` does not appear to update menu item IDs, leading to a crash when new items are selected.\r\n\r\nCrash occurs at `tauri-1.0.0-rc.3\\src\\app.rs:1257:33', on unwrap() - since the ID being looked up is not in the ids HashMap\r\n\r\nMenu appears updated, but new items to the menu cause a panic when selected\n\n### Reproduction\n\nAdd a system tray to app:\r\n```rust\r\n[....]\r\nlet tray = SystemTray::new().with_menu(\r\n    SystemTrayMenu::new()\r\n        .add_item(CustomMenuItem::new(\"exit\".to_string(), \"Exit\"))\r\n);\r\nlet mut app  = tauri::Builder::default()\r\n    .system_tray(tray)\r\n[....]\r\n```\r\nUpdate the menu later:\r\n```rust\r\n[....]\r\napp.run(move |app_handle, e| match e {\r\n    RunEvent::Ready => {\r\n        let app_handle = app_handle.clone();\r\n        app_handle.tray_handle().set_menu(\r\n            SystemTrayMenu::new()\r\n                .add_item(CustomMenuItem::new(\"test\".to_string(), \"Test\"))\r\n                .add_item(CustomMenuItem::new(\"exit\".to_string(), \"Exit\"))\r\n        );\r\n[....]\r\n```\r\n\r\nThen start the application, and select 'Test' from the tray icon's context menu.\r\n\r\nPanic will occur at `tauri-1.0.0-rc.3\\src\\app.rs:1257:33`\n\n### Expected behavior\n\nUpdated menu will work as displayed, with new items being selectable when changing the context menu\n\n### Platform and versions\n\n```shell\nOperating System - Windows, version 10.0.19042 X64\r\nWebview2 - 98.0.1108.62\r\nVisual Studio Build Tools:\r\n   - Visual Studio Community 2022\r\n   - Visual Studio Enterprise 2019\r\n\r\nNode.js environment\r\n  Node.js - 16.13.0\r\n  @tauri-apps/cli - 1.0.0-rc.5\r\n  @tauri-apps/api - 1.0.0-rc.1\r\n\r\nGlobal packages\r\n  npm - 8.1.0\r\n  pnpm - Not installed\r\n  yarn - Not installed\r\n\r\nRust environment\r\n  rustup - 1.24.3\r\n  rustc - 1.58.1\r\n  cargo - 1.58.0\r\n  toolchain - stable-x86_64-pc-windows-msvc\r\n\r\nApp directory structure\r\n/.git\r\n/.vscode\r\n/build\r\n/node_modules\r\n/public\r\n/src\r\n/src-tauri\r\n\r\nApp\r\n  tauri - 1.0.0-rc.3\r\n  tauri-build - 1.0.0-rc.3\r\n  tao - 0.6.2\r\n  wry - 0.13.2\r\n  build-type - bundle\r\n  CSP - unset\r\n  distDir - ../build\r\n  devPath - http://localhost:3000/\r\n  framework - React\n```\n\n\n### Stack trace\n\n```shell\nthread 'main' panicked at 'called `Option::unwrap()` on a `None` value', C:\\Users\\redacted\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tauri-1.0.0-rc.3\\src\\app.rs:1257:33\r\nstack backtrace:\r\n   0: std::panicking::begin_panic_handler\r\n             at /rustc/db9d1b20bba1968c1ec1fc49616d4742c1725b4b\\/library\\std\\src\\panicking.rs:498\r\n   1: core::panicking::panic_fmt\r\n             at /rustc/db9d1b20bba1968c1ec1fc49616d4742c1725b4b\\/library\\core\\src\\panicking.rs:107\r\n   2: core::panicking::panic\r\n             at /rustc/db9d1b20bba1968c1ec1fc49616d4742c1725b4b\\/library\\core\\src\\panicking.rs:48\r\n   3: enum$<core::option::Option<ref$<alloc::string::String> >, 1, 18446744073709551615, Some>::unwrap<ref$<alloc::string::String> >\r\n             at /rustc/db9d1b20bba1968c1ec1fc49616d4742c1725b4b\\library\\core\\src\\option.rs:746\r\n   4: tauri::app::impl$15::build::closure$0<tauri_runtime_wry::Wry,tauri_utils::assets::EmbeddedAssets>\r\n             at C:\\Users\\redacted\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tauri-1.0.0-rc.3\\src\\app.rs:1257\r\n   5: alloc::boxed::impl$46::call<tuple$<ref$<enum$<tauri_runtime::SystemTrayEvent> > >,dyn$<core::ops::function::Fn<tuple$<ref$<enum$<tauri_runtime::SystemTrayEvent> > >,assoc$<Output,tuple$<> > >,core::marker::Send>,alloc::alloc::Global>\r\n             at /rustc/db9d1b20bba1968c1ec1fc49616d4742c1725b4b\\library\\alloc\\src\\boxed.rs:1708\r\n   6: tauri_runtime_wry::handle_event_loop\r\n             at C:\\Users\\redacted\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tauri-runtime-wry-0.3.2\\src\\lib.rs:2343\r\n   7: tauri_runtime_wry::impl$45::run::closure$0<tauri::app::impl$14::run::closure$0>\r\n             at C:\\Users\\redacted\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tauri-runtime-wry-0.3.2\\src\\lib.rs:1894\r\n   8: tao::platform_impl::platform::event_loop::impl$2::run_return::closure$0<enum$<tauri_runtime_wry::Message>,tauri_runtime_wry::impl$45::run::closure$0>\r\n             at C:\\Users\\redacted\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tao-0.6.2\\src\\platform_impl\\windows\\event_loop.rs:225\r\n   9: alloc::boxed::impl$45::call_mut<tuple$<enum$<tao::event::Event<enum$<tauri_runtime_wry::Message> > >,ref_mut$<enum$<tao::event_loop::ControlFlow> > >,dyn$<core::ops::function::FnMut<tuple$<enum$<tao::event::Event<enum$<tauri_runtime_wry::Message> > >,ref_\r\n             at /rustc/db9d1b20bba1968c1ec1fc49616d4742c1725b4b\\library\\alloc\\src\\boxed.rs:1701\r\n  10: tao::platform_impl::platform::event_loop::runner::impl$3::call_event_handler::closure$0<enum$<tauri_runtime_wry::Message> >\r\n             at C:\\Users\\redacted\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tao-0.6.2\\src\\platform_impl\\windows\\event_loop\\runner.rs:249\r\n  11: core::panic::unwind_safe::impl$23::call_once<tuple$<>,tao::platform_impl::platform::event_loop::runner::impl$3::call_event_handler::closure$0>\r\n             at /rustc/db9d1b20bba1968c1ec1fc49616d4742c1725b4b\\library\\core\\src\\panic\\unwind_safe.rs:271\r\n  12: std::panicking::try::do_call<core::panic::unwind_safe::AssertUnwindSafe<tao::platform_impl::platform::event_loop::runner::impl$3::call_event_handler::closure$0>,tuple$<> >\r\n             at /rustc/db9d1b20bba1968c1ec1fc49616d4742c1725b4b\\library\\std\\src\\panicking.rs:406\r\n  13: tauri_runtime_wry::impl$24::from<f64>\r\n  14: std::panicking::try<tuple$<>,core::panic::unwind_safe::AssertUnwindSafe<tao::platform_impl::platform::event_loop::runner::impl$3::call_event_handler::closure$0> >\r\n             at /rustc/db9d1b20bba1968c1ec1fc49616d4742c1725b4b\\library\\std\\src\\panicking.rs:370\r\n  15: std::panic::catch_unwind<core::panic::unwind_safe::AssertUnwindSafe<tao::platform_impl::platform::event_loop::runner::impl$3::call_event_handler::closure$0>,tuple$<> >\r\n             at /rustc/db9d1b20bba1968c1ec1fc49616d4742c1725b4b\\library\\std\\src\\panic.rs:133\r\n  16: tao::platform_impl::platform::event_loop::runner::EventLoopRunner<enum$<tauri_runtime_wry::Message> >::catch_unwind<enum$<tauri_runtime_wry::Message>,tuple$<>,tao::platform_impl::platform::event_loop::runner::impl$3::call_event_handler::closure$0>\r\n             at C:\\Users\\redacted\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tao-0.6.2\\src\\platform_impl\\windows\\event_loop\\runner.rs:155\r\n  17: tao::platform_impl::platform::event_loop::runner::EventLoopRunner<enum$<tauri_runtime_wry::Message> >::call_event_handler<enum$<tauri_runtime_wry::Message> >\r\n             at C:\\Users\\redacted\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tao-0.6.2\\src\\platform_impl\\windows\\event_loop\\runner.rs:241\r\n  18: tao::platform_impl::platform::event_loop::runner::EventLoopRunner<enum$<tauri_runtime_wry::Message> >::send_event<enum$<tauri_runtime_wry::Message> >\r\n             at C:\\Users\\redacted\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tao-0.6.2\\src\\platform_impl\\windows\\event_loop\\runner.rs:223\r\n  19: tao::platform_impl::platform::system_tray::impl$0::build::closure$2<enum$<tauri_runtime_wry::Message> >\r\n             at C:\\Users\\redacted\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tao-0.6.2\\src\\platform_impl\\windows\\system_tray.rs:127\r\n  20: alloc::boxed::impl$46::call<tuple$<enum$<tao::event::Event<tuple$<> > > >,dyn$<core::ops::function::Fn<tuple$<enum$<tao::event::Event<tuple$<> > > >,assoc$<Output,tuple$<> > > >,alloc::alloc::Global>\r\n             at /rustc/db9d1b20bba1968c1ec1fc49616d4742c1725b4b\\library\\alloc\\src\\boxed.rs:1708\r\n  21: tao::platform_impl::platform::menu::MenuHandler::send_menu_event\r\n             at C:\\Users\\redacted\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tao-0.6.2\\src\\platform_impl\\windows\\menu.rs:65\r\n  22: tao::platform_impl::platform::menu::subclass_proc\r\n             at C:\\Users\\redacted\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tao-0.6.2\\src\\platform_impl\\windows\\menu.rs:352\r\n  23: DefSubclassProc\r\n  24: DefSubclassProc\r\n  25: CallWindowProcW\r\n  26: DispatchMessageW\r\n  27: windows::Windows::Win32::UI::WindowsAndMessaging::DispatchMessageW\r\n             at C:\\Users\\redacted\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\windows-0.30.0\\src\\Windows\\Win32\\UI\\WindowsAndMessaging\\mod.rs:2637\r\n  28: tao::platform_impl::platform::event_loop::EventLoop<enum$<tauri_runtime_wry::Message> >::run_return<enum$<tauri_runtime_wry::Message>,tauri_runtime_wry::impl$45::run::closure$0>\r\n             at C:\\Users\\redacted\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tao-0.6.2\\src\\platform_impl\\windows\\event_loop.rs:255\r\n  29: tao::platform_impl::platform::event_loop::EventLoop<enum$<tauri_runtime_wry::Message> >::run<enum$<tauri_runtime_wry::Message>,tauri_runtime_wry::impl$45::run::closure$0>\r\n             at C:\\Users\\redacted\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tao-0.6.2\\src\\platform_impl\\windows\\event_loop.rs:209\r\n  30: tao::event_loop::EventLoop<enum$<tauri_runtime_wry::Message> >::run<enum$<tauri_runtime_wry::Message>,tauri_runtime_wry::impl$45::run::closure$0>\r\n             at C:\\Users\\redacted\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tao-0.6.2\\src\\event_loop.rs:177\r\n  31: tauri_runtime_wry::impl$45::run<tauri::app::impl$14::run::closure$0>\r\n             at C:\\Users\\redacted\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tauri-runtime-wry-0.3.2\\src\\lib.rs:1893\r\n  32: tauri::app::App<tauri_runtime_wry::Wry>::run<tauri_runtime_wry::Wry,app::main::closure$0>\r\n             at C:\\Users\\redacted\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\tauri-1.0.0-rc.3\\src\\app.rs:486\r\n  33: app::main\r\n             at .\\src\\main.rs:65\r\n  34: core::ops::function::FnOnce::call_once<void (*)(),tuple$<> >\r\n             at /rustc/db9d1b20bba1968c1ec1fc49616d4742c1725b4b\\library\\core\\src\\ops\\function.rs:227\r\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\n[0303/143840.008:ERROR:window_impl.cc(114)] Failed to unregister class Chrome_WidgetWin_0. Error = 0\r\nerror: process didn't exit successfully: `target\\debug\\app.exe` (exit code: 101)\n```\n\n\n### Additional context\n\n_No response_","closed_by":{"login":"lucasfernog","id":20051258,"node_id":"MDQ6VXNlcjIwMDUxMjU4","avatar_url":"https://avatars.githubusercontent.com/u/20051258?v=4","gravatar_id":"","url":"https://api.github.com/users/lucasfernog","html_url":"https://github.com/lucasfernog","followers_url":"https://api.github.com/users/lucasfernog/followers","following_url":"https://api.github.com/users/lucasfernog/following{/other_user}","gists_url":"https://api.github.com/users/lucasfernog/gists{/gist_id}","starred_url":"https://api.github.com/users/lucasfernog/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lucasfernog/subscriptions","organizations_url":"https://api.github.com/users/lucasfernog/orgs","repos_url":"https://api.github.com/users/lucasfernog/repos","events_url":"https://api.github.com/users/lucasfernog/events{/privacy}","received_events_url":"https://api.github.com/users/lucasfernog/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/tauri-apps/tauri/issues/3608/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/tauri-apps/tauri/issues/3608/timeline","performed_via_github_app":null,"state_reason":"completed"}