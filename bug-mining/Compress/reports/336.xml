<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:33:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[COMPRESS-499] SeekableInMemoryByteChannel sets position incorrectly if &gt; size</title>
                <link>https://issues.apache.org/jira/browse/COMPRESS-499</link>
                <project id="12310904" key="COMPRESS">Commons Compress</project>
                    <description>&lt;p&gt;Something we noticed in passing when attempting to use this class as a reference for implementing a new channel class of our own:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/commons-compress/blob/c03704d773dfa0dfc5b2e53b4c198a95d0213ca0/src/main/java/org/apache/commons/compress/utils/SeekableInMemoryByteChannel.java#L102&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-compress/blob/c03704d773dfa0dfc5b2e53b4c198a95d0213ca0/src/main/java/org/apache/commons/compress/utils/SeekableInMemoryByteChannel.java#L102&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If the size of the file/channel is 10 and I call truncate(12), the current behaviour is to set the position back to 10.&lt;/p&gt;

&lt;p&gt;The docs of SeekableByteChannel, however, require that this not be done:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/nio/channels/SeekableByteChannel.html#truncate(long&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/nio/channels/SeekableByteChannel.html#truncate(long&lt;/a&gt;)&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;If the given size is greater than or equal to the current size then the entity is not modified. In either case, if the current position is greater than the given size then &lt;b&gt;it is set to that size&lt;/b&gt;.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m not sure whether this bug means there is a bug in the compression library proper, because anyone using a channel sensibly would not be setting the position past the length anyway, but I thought I would raise the issue regardless, in case that were not the case.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13273218">COMPRESS-499</key>
            <summary>SeekableInMemoryByteChannel sets position incorrectly if &gt; size</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="trejkaz">Trejkaz</reporter>
                        <labels>
                    </labels>
                <created>Mon, 9 Dec 2019 01:22:35 +0000</created>
                <updated>Sat, 4 Jan 2020 14:54:38 +0000</updated>
                            <resolved>Sat, 4 Jan 2020 14:54:38 +0000</resolved>
                                    <version>1.19</version>
                                    <fixVersion>1.20</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="2400">40m</timespent>
                                <comments>
                            <comment id="16999675" author="peter alfred lee" created="Thu, 19 Dec 2019 02:26:52 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trejkaz&quot; class=&quot;user-hover&quot; rel=&quot;trejkaz&quot;&gt;trejkaz&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I don&apos;t think this is a bug(if I&apos;m correctly understanding the docs of SeekableByteChannel).&lt;/p&gt;

&lt;p&gt;Basing the docs:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/nio/channels/SeekableByteChannel.html#truncate(long&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/nio/channels/SeekableByteChannel.html#truncate(long&lt;/a&gt;)&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;If the given size is less than the current size then the entity is truncated, discarding any bytes beyond the new end. If the given size is greater than or equal to the current size then the entity is not modified. In either case, if the current position is greater than the given size then it is set to that size.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;My understanding of this document is :&lt;/p&gt;

&lt;p&gt;The method truncate may influence the size and position.&lt;/p&gt;

&lt;p&gt;For the part of size, if the input parameter&#160;newSize is :&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;smaller than the current size : the current size will be&#160;truncated, which means the current size would be set to the newSize.&lt;/li&gt;
	&lt;li&gt;greater than the current size :&#160;the current size would not be modified, which means we don&apos;t need to do anything on the size.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;For the part of position, it&apos;s much easier : if the current position is greater than the newSize, then it is set to that size.&lt;/p&gt;

&lt;p&gt;And that&apos;s what the code in&#160;SeekableByteChannel.truncate do :&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; SeekableByteChannel truncate(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; newSize) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (size &amp;gt; newSize) {
            size = (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) newSize;
        }
        repositionIfNecessary();
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;;
    }

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void repositionIfNecessary() {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (position &amp;gt; size) {
            position = size;
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In your case :&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;If the size of the file/channel is 10 and I call truncate(12), the current behaviour is to set the position back to 10.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The original size of the file/channel is 10. You didn&apos;t mention about the original position, but it could not be greater than 10 since it&apos;s the size of the file/channel.&lt;/p&gt;

&lt;p&gt;When calling&#160;truncate(12), since the newSize 12 is greater than current size 10, the size would not be modified. And the position would not be changed either since it must be smaller than the newSize 12. I don&apos;t see anything wrong in this.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16999719" author="trejkaz" created="Thu, 19 Dec 2019 03:43:25 +0000"  >&lt;p&gt;Is this not a contradiction?&lt;/p&gt;

&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12989158/12989158_Screen+Shot+2019-12-19+at+12.37.18+pm.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;

&lt;p&gt;Good point about the starting position not being defined though. I&apos;ll think through a couple of situations:&lt;/p&gt;

&lt;p&gt;1. Starting state: size = 10, position = 8&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;truncate(12) called&lt;/li&gt;
	&lt;li&gt;&quot;If the given size is greater than or equal to the current size then the entity is not modified&quot; so size is still 10&lt;/li&gt;
	&lt;li&gt;&quot;In either case, if the current position is greater than the given size then it is set to that size.&quot; which it is not, so it remains at 8.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;2. Starting state: size = 10, position = 14&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;truncate(12) called&lt;/li&gt;
	&lt;li&gt;&quot;If the given size is greater than or equal to the current size then the entity is not modified&quot; so size is still 10&lt;/li&gt;
	&lt;li&gt;&quot;In either case, if the current position is greater than the given size then it is set to that size.&quot; so position is set to 12&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think that with the current logic, case 1 behaves correctly, but case 2 erroneously leaves the buffer positioned at 10 instead of 12.&lt;/p&gt;

&lt;p&gt;I guess I should try to write a test case.&lt;/p&gt;</comment>
                            <comment id="16999772" author="peter alfred lee" created="Thu, 19 Dec 2019 06:28:55 +0000"  >&lt;p&gt;Ah, I see what you are talking about now.&lt;/p&gt;

&lt;p&gt;It&apos;s about the case that the current position already exceeds the size of the channel.&lt;/p&gt;

&lt;p&gt;Basing on the comment of&#160;SeekableByteChannel.position :&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/**
 * Sets &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; channel&apos;s position.
 *
 * &amp;lt;p&amp;gt; Setting the position to a value that is greater than the current size
 * is legal but does not change the size of the entity.  A later attempt to
 * read bytes at such a position will immediately &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; an end-of-file
 * indication.  A later attempt to write bytes at such a position will cause
 * the entity to grow to accommodate the &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; bytes; the values of any bytes
 * between the previous end-of-file and the newly-written bytes are
 * unspecified.
 *
 * &amp;lt;p&amp;gt; Setting the channel&apos;s position is not recommended when connected to
 * an entity, typically a file, that is opened with the {@link
 * java.nio.file.StandardOpenOption#APPEND APPEND} option. When opened &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;
 * append, the position is first advanced to the end before writing.
 *
 * @param  newPosition
 *         The &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; position, a non-negative integer counting
 *         the number of bytes from the beginning of the entity
 *
 * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;  This channel
 *
 * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt;  ClosedChannelException
 *          If &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; channel is closed
 * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt;  IllegalArgumentException
 *          If the &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; position is negative
 * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt;  IOException
 *          If some other I/O error occurs
 */
SeekableByteChannel position(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; newPosition) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It&apos;s legal when setting the position to a value greater than the size of channel.&lt;/p&gt;

&lt;p&gt;You are right. I think the code should be modified basing the java docs. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trejkaz&quot; class=&quot;user-hover&quot; rel=&quot;trejkaz&quot;&gt;trejkaz&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16999773" author="trejkaz" created="Thu, 19 Dec 2019 06:29:46 +0000"  >&lt;p&gt;Proposed test case. It fails, but I&apos;m in the middle of verifying whether the inputs and outputs I&apos;ve put in are correct.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void shouldSetProperPositionOnTruncate() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
        &lt;span class=&quot;code-comment&quot;&gt;// In absence of proper parametrised test cases :(
&lt;/span&gt;        &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;[][] testCases = {
                &lt;span class=&quot;code-comment&quot;&gt;// { Position, NewSize, ExpectedPosition }
&lt;/span&gt;
                &lt;span class=&quot;code-comment&quot;&gt;// Position == Size == NewSize
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// - Size doesn&#8217;t change
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// - Position doesn&#8217;t change
&lt;/span&gt;                { 9L, 9L, 9L },

                &lt;span class=&quot;code-comment&quot;&gt;// NewSize &amp;lt; Position == Size :
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// - Size changes to NewSize
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// - Position changes to NewSize
&lt;/span&gt;                { 4L, 9L, 4L },

                &lt;span class=&quot;code-comment&quot;&gt;// Position == Size &amp;lt; NewSize :
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// - Size changes to NewSize and you get undefined data between
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// - Position doesn&#8217;t change
&lt;/span&gt;                { 9L, 12L, 9L },

                &lt;span class=&quot;code-comment&quot;&gt;// NewSize == Position &amp;lt; Size :
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// - Size changes to NewSize
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// - Position doesn&#8217;t change
&lt;/span&gt;                { 4L, 4L, 4L },

                &lt;span class=&quot;code-comment&quot;&gt;// Size &amp;lt; Position == NewSize :
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// - Size changes to NewSize and you get undefined data between
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// - Position doesn&#8217;t change
&lt;/span&gt;                { 12L, 12L, 12L },

                &lt;span class=&quot;code-comment&quot;&gt;// Position &amp;lt; Size == NewSize :
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// - Size doesn&#8217;t change
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// - Position doesn&#8217;t change
&lt;/span&gt;                { 4L, 9L, 4L },

                &lt;span class=&quot;code-comment&quot;&gt;// NewSize == Size &amp;lt; Position :
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// - Size doesn&#8217;t change
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// - Position changes to NewSize
&lt;/span&gt;                { 12L, 9L, 9L },


                &lt;span class=&quot;code-comment&quot;&gt;// NewSize &amp;lt; Position &amp;lt; Size :
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// - Size changes to NewSize
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// - Position changes to NewSize
&lt;/span&gt;                { 6L, 4L, 4L },

                &lt;span class=&quot;code-comment&quot;&gt;// Position &amp;lt; NewSize &amp;lt; Size :
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// - Size changes to NewSize
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// - Position doesn&#8217;t change
&lt;/span&gt;                { 4L, 6L, 4L },

                &lt;span class=&quot;code-comment&quot;&gt;// Position &amp;lt; Size &amp;lt; NewSize :
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// - Size changes to NewSize and you get undefined data between
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// - Position doesn&#8217;t change
&lt;/span&gt;                { 4L, 12L, 4L },

                &lt;span class=&quot;code-comment&quot;&gt;// NewSize &amp;lt; Size &amp;lt; Position :
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// - Size changes to NewSize
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// - Position changes to NewSize
&lt;/span&gt;                { 12L, 4L, 4L },

                &lt;span class=&quot;code-comment&quot;&gt;// Size &amp;lt; NewSize &amp;lt; Position :
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// - Size changes to NewSize and you get undefined data between
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// - Position changes to NewSize
&lt;/span&gt;                { 12L, 10L, 10L },

                &lt;span class=&quot;code-comment&quot;&gt;// Size &amp;lt; Position &amp;lt; NewSize :
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// - Size changes to NewSize and you get undefined data between
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// - Position doesn&#8217;t change
&lt;/span&gt;                { 10L, 12L, 10L }

        };

        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;[] testCase : testCases) {
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; position = testCase[0];
                &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; newSize = testCase[1];
                &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; expectedPosition = testCase[2];

                &lt;span class=&quot;code-comment&quot;&gt;//given
&lt;/span&gt;                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (SeekableInMemoryByteChannel c = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SeekableInMemoryByteChannel(testData)) {
                    &lt;span class=&quot;code-comment&quot;&gt;//when
&lt;/span&gt;                    c.position(position);
                    c.truncate(newSize);
                    &lt;span class=&quot;code-comment&quot;&gt;//then
&lt;/span&gt;                    assertEquals(expectedPosition, c.position());
                    assertEquals(newSize, c.size());
                }
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (AssertionError e) {
                &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AssertionError(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed at test &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt;: &quot;&lt;/span&gt; + Arrays.toString(testCase), e);
            }
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16999777" author="peter alfred lee" created="Thu, 19 Dec 2019 06:35:22 +0000"  >&lt;p&gt;I think you could push a PR in github for this - with the code modified and the test cases.&lt;/p&gt;

&lt;p&gt;If you are busy, I will be happily helping you for this.&lt;/p&gt;</comment>
                            <comment id="16999788" author="peter alfred lee" created="Thu, 19 Dec 2019 06:57:01 +0000"  >&lt;p&gt;I noticed that the method&#160;repositionIfNecessary is also called in&#160;SeekableInMemoryByteChannel.read&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Override
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; read(ByteBuffer buf) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    ensureOpen();
    repositionIfNecessary();
    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; wanted = buf.remaining();
    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; possible = size - position;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (possible &amp;lt;= 0) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; -1;
    }
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (wanted &amp;gt; possible) {
        wanted = possible;
    }
    buf.put(data, position, wanted);
    position += wanted;
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; wanted;
}

&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void repositionIfNecessary() {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (position &amp;gt; size) {
        position = size;
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I believe this is also a potential problem and should also be modified and tested.&lt;/p&gt;

&lt;p&gt;I believe adding new test cases for all the methods in&#160;SeekableByteChannel(including read, write, position and truncate) is a good idea.&lt;/p&gt;

&lt;p&gt;And I think the other channels in commons-compress that implements&#160;SeekableByteChannel also need double checks.&lt;/p&gt;

&lt;p&gt;Considering the potential changes could be a lot, I believe it&apos;s a good idea to have a discussion in developers mailing list before we start to work - and I have opened a thread in developers&apos; mailing list(&lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/commons-dev/201912.mbox/%3cCAPnT0mcygEKkCP3jtbRnrSV_qK7mUKMBuS2BqatfpEQ8vNKBYQ@mail.gmail.com%3e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://mail-archives.apache.org/mod_mbox/commons-dev/201912.mbox/%3cCAPnT0mcygEKkCP3jtbRnrSV_qK7mUKMBuS2BqatfpEQ8vNKBYQ@mail.gmail.com%3e&lt;/a&gt;). You can refer to it and join the discussion if you want. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17000374" author="trejkaz" created="Thu, 19 Dec 2019 21:01:44 +0000"  >&lt;p&gt;I&apos;m about to head on break but I have a proposed fix ready for that one class which is actually quite simple, which should be a good start.&lt;/p&gt;</comment>
                            <comment id="17007998" author="bodewig" created="Sat, 4 Jan 2020 11:40:02 +0000"  >&lt;p&gt;FWIW I&apos;ve started to write some API compliance tests and already found our &lt;tt&gt;size&lt;/tt&gt; and &lt;tt&gt;position&lt;/tt&gt; methods violate the spec as well. They are supposed to throw {{ClosedChannelException}}s if the channel is not open. Unfortunately we can&apos;t fix that as we&apos;ve declared both methods to not throw any exceptions and adding them now would break backwards compatibility. So here I&apos;m stuck with documenting the fact.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12989158" name="Screen Shot 2019-12-19 at 12.37.18 pm.png" size="403274" author="trejkaz" created="Thu, 19 Dec 2019 03:40:19 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 45 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z09gb4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>