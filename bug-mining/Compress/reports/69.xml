<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:29:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[COMPRESS-160] TarArchiveOutputStream.getBytesWritten() returns invalid value</title>
                <link>https://issues.apache.org/jira/browse/COMPRESS-160</link>
                <project id="12310904" key="COMPRESS">Commons Compress</project>
                    <description>&lt;p&gt;It appears the TarArchiveOutputStream.getBytesWritten()returns zero or invalid value when queried.&lt;br/&gt;
In the code sample below, it returns zero, even after an sizeable file was processed.&lt;br/&gt;
I&apos;ve printed it twice, once before closing the output stream, and once after, just for the reference.&lt;br/&gt;
It is also demonstrable on multiple processed files.&lt;/p&gt;

&lt;p&gt;Within the TarArchiveOutputStream.getBytesWritten() implementation, it appears the call for count(numToWrite) is made after the numToWrite is depleted in the process of actual byte writing. When call for count(numToWrite); is moved up, the returned values for TarArchiveOutputStream.getBytesWritten() are getting equal to the sum of the sizes of processed files. This is much closer to expected value (&quot;Returns the current number of bytes written to this stream.&quot;) but still not correct, for that number should include the tar header sizes as well.&lt;/p&gt;

&lt;p&gt;At any rate, please find the proposed patch below, merely moving count(numToWrite); up a few lines. This makes TarArchiveOutputStream.getBytesWritten() closer to true value.&lt;/p&gt;


&lt;p&gt;Test code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;@Test
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void tartest() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
		
		FileOutputStream myOutputStream = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileOutputStream(&lt;span class=&quot;code-quote&quot;&gt;&quot;C:/temp/tartest.tar&quot;&lt;/span&gt;);
		
		ArchiveOutputStream sTarOut = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArchiveStreamFactory().createArchiveOutputStream(ArchiveStreamFactory.TAR, myOutputStream);
		
		File sSource = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(&lt;span class=&quot;code-quote&quot;&gt;&quot;C:/share/od_l.txt&quot;&lt;/span&gt;);
		TarArchiveEntry sEntry = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TarArchiveEntry(sSource);
		sTarOut.putArchiveEntry(sEntry);
		
		FileInputStream sInput = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileInputStream(sSource);
		&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] cpRead = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[8192];
		
		&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; iRead = 0;
		&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; ((iRead = sInput.read(cpRead)) &amp;gt; 0) {
			sTarOut.write(cpRead, 0, iRead);
		}
		
		sLog.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Processed: &quot;&lt;/span&gt;+sTarOut.getBytesWritten()+&lt;span class=&quot;code-quote&quot;&gt;&quot; bytes. File Len: &quot;&lt;/span&gt;+sSource.length());
		
		sInput.close();
		sTarOut.closeArchiveEntry();
		sTarOut.close();

		sLog.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Processed: &quot;&lt;/span&gt;+sTarOut.getBytesWritten()+&lt;span class=&quot;code-quote&quot;&gt;&quot; bytes. File Len: &quot;&lt;/span&gt;+sSource.length());

		
		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
			
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test Output:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Oct 21, 2011 9:09:28 AM com.cronsult.jndmpd.test.Backup tartest
INFO: Processed: 0 bytes. File Len: 186974208
Oct 21, 2011 9:09:28 AM com.cronsult.jndmpd.test.Backup tartest
INFO: Processed: 0 bytes. File Len: 186974208
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Proposed Patch:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Index: src/main/java/org/apache/commons/compress/archivers/tar/TarArchiveOutputStream.java
===================================================================
--- src/main/java/org/apache/commons/compress/archivers/tar/TarArchiveOutputStream.java	(revision 1187150)
+++ src/main/java/org/apache/commons/compress/archivers/tar/TarArchiveOutputStream.java	(working copy)
@@ -276,6 +276,8 @@
             &lt;span class=&quot;code-comment&quot;&gt;// eliminate some of the buffer copying.
&lt;/span&gt;             &lt;span class=&quot;code-comment&quot;&gt;//
&lt;/span&gt;         }
+        
+        count(numToWrite);
 
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (assemLen &amp;gt; 0) {
             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((assemLen + numToWrite) &amp;gt;= recordBuf.length) {
@@ -325,7 +327,7 @@
             wOffset += num;
         }
         
-        count(numToWrite);
+        
     }
 
     /**

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;java.runtime.name=Java(TM) SE Runtime Environment&lt;br/&gt;
java.runtime.version=1.6.0_27-b07&lt;br/&gt;
os.arch=x86&lt;br/&gt;
os.name=Windows 7&lt;br/&gt;
os.version=6.1&lt;br/&gt;
This issue may be unrelated to environment&lt;/p&gt;</environment>
        <key id="12528274">COMPRESS-160</key>
            <summary>TarArchiveOutputStream.getBytesWritten() returns invalid value</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="rsimac">Robert Simac</reporter>
                        <labels>
                    </labels>
                <created>Fri, 21 Oct 2011 13:23:08 +0000</created>
                <updated>Sun, 23 Oct 2011 12:13:53 +0000</updated>
                            <resolved>Sun, 23 Oct 2011 12:13:53 +0000</resolved>
                                    <version>1.2</version>
                                    <fixVersion>1.3</fixVersion>
                                    <component>Archivers</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13133624" author="bodewig" created="Sun, 23 Oct 2011 12:13:53 +0000"  >&lt;p&gt;fixed with svn revision 1187874&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>97634</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 4 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0b4ev:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>62827</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>