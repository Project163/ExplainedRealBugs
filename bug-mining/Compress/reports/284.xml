<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:32:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[COMPRESS-446] Resource Leak in ParallelScatterZipCreator#writeTo(ZipArchiveOutputStream)</title>
                <link>https://issues.apache.org/jira/browse/COMPRESS-446</link>
                <project id="12310904" key="COMPRESS">Commons Compress</project>
                    <description>&lt;p&gt;Before it does anything else, &lt;tt&gt;ParallelScatterZipCreator#writeTo(ZipArchiveOutputStream)&lt;/tt&gt; loops over all futures returned by the creator`s executor service and calls &lt;tt&gt;Future#get()&lt;/tt&gt;. This will block until the future&apos;s computation is completed, respectively - i.e., until all entries have been written to the thread-local scatter streams.&lt;/p&gt;

&lt;p&gt;However, if the computation of a future fails, then &lt;tt&gt;Future#get()&lt;/tt&gt; can also throw an exception. This exception escapes &lt;tt&gt;ParallelScatterZipCreator#writeTo(ZipArchiveOutputStream)&lt;/tt&gt; before the executor service is shut down. The latter means that also the thread-local variables in the executor service&apos;s threads and all objects referenced by them continue to exist and cannot be reclaimed by the GC.&lt;/p&gt;

&lt;p&gt;I encountered this situation when - while processing an archive with 130,000 documents - the JVM threw an &lt;tt&gt;OutOfMemoryError&lt;/tt&gt;. The application was not able to recover from this OOM error because most of the heap was occupied by objects reachable from the executor service&apos;s threads.&lt;/p&gt;

&lt;p&gt;Of course, the OOM is mostly the fault of my own code; I will be able to work around the &quot;leaked&quot; executor service because I supply it in the first place and can therefore shut it down if I detect an error situation.  &lt;/p&gt;

&lt;p&gt;The effect would be the same, though, if, say, &lt;tt&gt;Future#get()&lt;/tt&gt; throws an &lt;tt&gt;InterruptedException&lt;/tt&gt;. Therefore, &lt;tt&gt;ParallelScatterZipCreator#writeTo(ZipArchiveOutputStream)&lt;/tt&gt;  should either shut down and release all resources if it cannot complete its task due to an Exception thrown by a future or it should offer a reasonable recovery strategy. &lt;/p&gt;</description>
                <environment>&lt;p&gt;The application was running inside a Docker container, the JVM had about 1.7 GByte heap space.&lt;/p&gt;</environment>
        <key id="13145982">COMPRESS-446</key>
            <summary>Resource Leak in ParallelScatterZipCreator#writeTo(ZipArchiveOutputStream)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="ludwigc">Christoph Ludwig</reporter>
                        <labels>
                            <label>zip</label>
                    </labels>
                <created>Sat, 17 Mar 2018 20:24:00 +0000</created>
                <updated>Mon, 12 Nov 2018 16:28:40 +0000</updated>
                            <resolved>Thu, 29 Mar 2018 14:11:04 +0000</resolved>
                                    <version>1.16.1</version>
                                    <fixVersion>1.17</fixVersion>
                                    <component>Archivers</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16405985" author="bodewig" created="Tue, 20 Mar 2018 09:13:42 +0000"  >&lt;p&gt;This is ugly. An alternative would be to shutdown the executor in a finally block. Would that be sufficient?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krosenvold&quot; class=&quot;user-hover&quot; rel=&quot;krosenvold&quot;&gt;krosenvold&lt;/a&gt; any ideas?&lt;/p&gt;</comment>
                            <comment id="16406315" author="ludwigc" created="Tue, 20 Mar 2018 13:22:34 +0000"  >&lt;p&gt;I think shutting down the executor service in a finally block is fine - this way all threads are closed and the objects reachable from there get a chance to be re-claimed.&lt;/p&gt;

&lt;p&gt;In addition, I think it would be worthwhile to document explicitly that the ZIP creation fails irrecoverably if any of the  futures  throws an exception. It does not come as a surprise, of course, but It helps if the documentation is clear on this.&lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                            <comment id="16419061" author="bodewig" created="Thu, 29 Mar 2018 14:11:04 +0000"  >&lt;p&gt;should be fixed with commit 8faba699&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Many thanks.&lt;/p&gt;</comment>
                            <comment id="16419102" author="garydgregory" created="Thu, 29 Mar 2018 14:39:48 +0000"  >&lt;p&gt;Hi&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bodewig&quot; class=&quot;user-hover&quot; rel=&quot;bodewig&quot;&gt;bodewig&lt;/a&gt;: This looks important. Are you planning on cutting a release soon?&lt;/p&gt;</comment>
                            <comment id="16421249" author="bodewig" created="Sat, 31 Mar 2018 09:25:02 +0000"  >&lt;p&gt;Hmm, I don&apos;t see this as serious as you seem to do.&lt;/p&gt;

&lt;p&gt;The resource leak happens if one of the parallel threads throws an exception which will likely propagate to the caller and in code that hasn&apos;t been crafted&#160; as carefully as Christoph&apos;s will kill the whole process rendering the resource leak moot. This is an edge case in a class that isn&apos;t likely to be used by many people at all.&lt;/p&gt;

&lt;p&gt;Do you consider this more serious than the &quot;usual&quot; bugs?&lt;/p&gt;</comment>
                            <comment id="16421319" author="garydgregory" created="Sat, 31 Mar 2018 12:57:49 +0000"  >&lt;p&gt;I suppose you are correct, not as bad as I initially thought.&lt;/p&gt;</comment>
                            <comment id="16679878" author="melloware" created="Thu, 8 Nov 2018 15:03:01 +0000"  >&lt;p&gt;We are still seeing this error on Commons Compress 1.18 intermittently leaving these TMP files for ParallelScatter.  Our system runs 24/7 and is zipping files hourly so over a 1 month period we have seen it leave say 4-6 of these files around.  The problem is they don&apos;t get cleaned up and fills our /TMP eventually to 100%.&lt;/p&gt;

&lt;p&gt;Any thoughts?&lt;/p&gt;</comment>
                            <comment id="16681764" author="bodewig" created="Fri, 9 Nov 2018 17:56:32 +0000"  >&lt;p&gt;You are correct, I&apos;ve opened &lt;a href=&quot;https://issues.apache.org/jira/browse/COMPRESS-470&quot; title=&quot;ParallelScatterZipCreator leaks temporary files (and maybe more)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;COMPRESS-470&quot;&gt;&lt;del&gt;COMPRESS-470&lt;/del&gt;&lt;/a&gt; to track this other leak.&lt;/p&gt;

&lt;p&gt;Not sure whether this is an option for you, you could work around this with providing a &lt;tt&gt;ScatterGatherBackingStoreSupplier&lt;/tt&gt; of your own that cleaned up resources after a certain amount of time itself. Given you are running a process that never stops I&apos;m not even sure it would be enough to call &lt;tt&gt;close&lt;/tt&gt; on &lt;tt&gt;FileBasedScatterGatherBackingStore&lt;/tt&gt; as the call to &lt;tt&gt;delete&lt;/tt&gt; may fail as well and using &lt;tt&gt;deleteOnExit&lt;/tt&gt; as a hypothetical fallback won&apos;t help you.&lt;/p&gt;</comment>
                            <comment id="16681942" author="melloware" created="Fri, 9 Nov 2018 21:05:47 +0000"  >&lt;p&gt;I might be able to do that. Can you provide an example of ScatterGatherBackingStoreSupplier and how I would inject it into the process to clean up these temp files?   &lt;/p&gt;</comment>
                            <comment id="16682209" author="bodewig" created="Sat, 10 Nov 2018 05:19:39 +0000"  >&lt;p&gt;The one you are currently using implicitly is &lt;a href=&quot;https://github.com/apache/commons-compress/blob/master/src/main/java/org/apache/commons/compress/parallel/FileBasedScatterGatherBackingStore.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-compress/blob/master/src/main/java/org/apache/commons/compress/parallel/FileBasedScatterGatherBackingStore.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;By using the two-arg constructor of &lt;tt&gt;ParallelScatterZipCreator&lt;/tt&gt; you can plug in your own &lt;tt&gt;ScatterGatherBackingStoreSupplier&lt;/tt&gt; which has a single method that is responsible for creating a new &lt;tt&gt;ScatterGatherBackingStore&lt;/tt&gt;. This is assuming you are creating &lt;tt&gt;ParallelScatterZipCreator&lt;/tt&gt; yourself and not using a third-party library that abstracts that away from you.&lt;/p&gt;</comment>
                            <comment id="16682374" author="melloware" created="Sat, 10 Nov 2018 12:30:27 +0000"  >&lt;p&gt;OK I am using raw commons compress so we should be able to attempt this.&lt;/p&gt;</comment>
                            <comment id="16684043" author="melloware" created="Mon, 12 Nov 2018 16:28:40 +0000"  >&lt;p&gt;Just in case you were interested or wanted to review attached is what I did.  I basically start a timer and I cancel the timer if the delete succeeds.  IF the delete doesn&apos;t succeed it will try the delete again when the timer expires or if the delete was never called. &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12947850/12947850_FailSafeScatterGatherBackingStore.java&quot; title=&quot;FailSafeScatterGatherBackingStore.java attached to COMPRESS-446&quot;&gt;FailSafeScatterGatherBackingStore.java&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13197468">COMPRESS-470</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12947850" name="FailSafeScatterGatherBackingStore.java" size="3717" author="melloware" created="Mon, 12 Nov 2018 16:28:37 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3rg6n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>