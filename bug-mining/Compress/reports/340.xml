<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:33:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[COMPRESS-510] Multiple retrievals of InputStream for same SevenZFile entry fails</title>
                <link>https://issues.apache.org/jira/browse/COMPRESS-510</link>
                <project id="12310904" key="COMPRESS">Commons Compress</project>
                    <description>&lt;p&gt;I was trying out the new random access for the 7z files and have one of our tests failing where we are trying to read the same entry multiple times without closing the archive.&lt;/p&gt;

&lt;p&gt;Reproducing test case (I added this locally to the SevenZFileTest class)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void retrieveInputStreamForEntryMultipleTimes() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (SevenZFile sevenZFile = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SevenZFile(getFile(&lt;span class=&quot;code-quote&quot;&gt;&quot;bla.7z&quot;&lt;/span&gt;))) {
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (SevenZArchiveEntry entry : sevenZFile.getEntries()) {
            &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] firstRead = IOUtils.toByteArray(sevenZFile.getInputStream(entry));
            &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] secondRead = IOUtils.toByteArray(sevenZFile.getInputStream(entry));
            assertArrayEquals(firstRead, secondRead);
        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The Exception thrown is&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.ArrayIndexOutOfBoundsException: Index -1 out of bounds &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; length 2	at org.apache.commons.compress.archivers.sevenz.SevenZFile.buildDecodingStream(SevenZFile.java:1183)
	at org.apache.commons.compress.archivers.sevenz.SevenZFile.getInputStream(SevenZFile.java:1436)
	at org.apache.commons.compress.archivers.sevenz.SevenZFileTest.retrieveInputStreamForEntryMultipleTimes(SevenZFileTest.java:688)
	...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;A similar test case for e.g. zip works fine&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void retrieveInputStreamForEntryMultipleTimes() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (ZipFile zipFile = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ZipFile(getFile(&lt;span class=&quot;code-quote&quot;&gt;&quot;bla.zip&quot;&lt;/span&gt;))) {
        Enumeration&amp;lt;ZipArchiveEntry&amp;gt; entry = zipFile.getEntries();
        &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (entry.hasMoreElements()) {
            ZipArchiveEntry e = entry.nextElement();
            &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] firstRead = IOUtils.toByteArray(zipFile.getInputStream(e));
            &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] secondRead = IOUtils.toByteArray(zipFile.getInputStream(e));
            assertArrayEquals(firstRead, secondRead);
        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13299003">COMPRESS-510</key>
            <summary>Multiple retrievals of InputStream for same SevenZFile entry fails</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="peterlee">Peter Lee</assignee>
                                    <reporter username="rschimpf">Robin Schimpf</reporter>
                        <labels>
                    </labels>
                <created>Fri, 17 Apr 2020 08:09:00 +0000</created>
                <updated>Sun, 7 Mar 2021 15:03:26 +0000</updated>
                            <resolved>Sun, 7 Mar 2021 15:03:26 +0000</resolved>
                                    <version>1.20</version>
                                    <fixVersion>1.21</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17086340" author="peterlee" created="Sat, 18 Apr 2020 06:42:30 +0000"  >&lt;p&gt;This is a bug that happens when reading the first entry using random access multiable times.&lt;/p&gt;

&lt;p&gt;Thank you for your testcases.&lt;/p&gt;</comment>
                            <comment id="17086344" author="peterlee" created="Sat, 18 Apr 2020 06:59:06 +0000"  >&lt;p&gt;I just pushed a fix for this. The test is also included.&lt;/p&gt;

&lt;p&gt;Thanks again for your contribution.&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rschimpf&quot; class=&quot;user-hover&quot; rel=&quot;rschimpf&quot;&gt;rschimpf&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17086417" author="rschimpf" created="Sat, 18 Apr 2020 11:23:19 +0000"  >&lt;p&gt;Thanks for the quick fix!&lt;/p&gt;</comment>
                            <comment id="17087411" author="rschimpf" created="Mon, 20 Apr 2020 06:32:41 +0000"  >&lt;p&gt;Sorry to come back at this issue. The testcase I provided works now fine but my application testcase now fails with a different exception.&lt;br/&gt;
I generate a 7z file with commons-compress and then try to read the content multiple times. So this error seems to be archive dependent.&lt;/p&gt;

&lt;p&gt;Some reduced sample code to recreate the error&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void retrieveInputStreamForAllEntriesMultipleTimes() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; SevenZOutputFile out = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SevenZOutputFile(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(dir, &lt;span class=&quot;code-quote&quot;&gt;&quot;test.7z&quot;&lt;/span&gt;))) {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Path inputFile = Files.createTempFile(&lt;span class=&quot;code-quote&quot;&gt;&quot;SevenZTestTemp&quot;&lt;/span&gt;, &quot;&quot;);

        SevenZArchiveEntry entry = out.createArchiveEntry(inputFile.toFile(), &lt;span class=&quot;code-quote&quot;&gt;&quot;test.txt&quot;&lt;/span&gt;);
        out.putArchiveEntry(entry);
        out.write(&lt;span class=&quot;code-quote&quot;&gt;&quot;Test&quot;&lt;/span&gt;.getBytes(StandardCharsets.UTF_8));
        out.closeArchiveEntry();

        Files.deleteIfExists(inputFile);
    }

    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (SevenZFile sevenZFile = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SevenZFile(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(dir, &lt;span class=&quot;code-quote&quot;&gt;&quot;test.7z&quot;&lt;/span&gt;))) {
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (SevenZArchiveEntry entry : sevenZFile.getEntries()) {
            &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] firstRead = IOUtils.toByteArray(sevenZFile.getInputStream(entry));
            &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] secondRead = IOUtils.toByteArray(sevenZFile.getInputStream(entry));
            assertArrayEquals(firstRead, secondRead);
        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This fails now with the following exception on Java 8&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.ClassCastException: org.apache.commons.compress.utils.BoundedInputStream cannot be &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; to org.apache.commons.compress.utils.CRC32VerifyingInputStream

	at org.apache.commons.compress.archivers.sevenz.SevenZFile.skipEntriesWhenNeeded(SevenZFile.java:1278)
	at org.apache.commons.compress.archivers.sevenz.SevenZFile.buildDecodingStream(SevenZFile.java:1204)
	at org.apache.commons.compress.archivers.sevenz.SevenZFile.getInputStream(SevenZFile.java:1437)
	at org.apache.commons.compress.archivers.sevenz.SevenZFileTest.retrieveInputStreamForAllEntriesMultipleTimes(SevenZFileTest.java:712)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And with the following exception on Java 11&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.ClassCastException: &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.commons.compress.utils.BoundedInputStream cannot be &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; to &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.commons.compress.utils.CRC32VerifyingInputStream (org.apache.commons.compress.utils.BoundedInputStream and org.apache.commons.compress.utils.CRC32VerifyingInputStream are in unnamed module of loader &lt;span class=&quot;code-quote&quot;&gt;&apos;app&apos;&lt;/span&gt;)

	at org.apache.commons.compress.archivers.sevenz.SevenZFile.skipEntriesWhenNeeded(SevenZFile.java:1278)
	at org.apache.commons.compress.archivers.sevenz.SevenZFile.buildDecodingStream(SevenZFile.java:1204)
	at org.apache.commons.compress.archivers.sevenz.SevenZFile.getInputStream(SevenZFile.java:1437)
	at org.apache.commons.compress.archivers.sevenz.SevenZFileTest.retrieveInputStreamForAllEntriesMultipleTimes(SevenZFileTest.java:712)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17089211" author="peterlee" created="Wed, 22 Apr 2020 02:07:44 +0000"  >&lt;p&gt;This is intersting. Trying to figure out why some 7z can work but some 7z can not.&lt;/p&gt;</comment>
                            <comment id="17089250" author="peterlee" created="Wed, 22 Apr 2020 03:13:13 +0000"  >&lt;p&gt;I have find out the difference : the created 7z test archive did not use CRC32.&lt;/p&gt;

&lt;p&gt;This is definitely a bug in 7z random acces. I have just fixed this and pushed to the master.&lt;/p&gt;

&lt;p&gt;Thank you so much.&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rschimpf&quot; class=&quot;user-hover&quot; rel=&quot;rschimpf&quot;&gt;rschimpf&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17089302" author="rschimpf" created="Wed, 22 Apr 2020 05:40:01 +0000"  >&lt;p&gt;Thanks again for fixing the problem.&lt;/p&gt;

&lt;p&gt;Your explanation surprised me a bit and so I was going to check the file which is created by my test. Commons-compress does not get a CRC in the SevenZFile#readFilesInfo method. But the 7z GUI shows me a CRC (784DD132 for test.txt).&lt;/p&gt;

&lt;p&gt;Now I am confused. Do I need to create the 7z archive in a different way to include a CRC checksum? Since I used the default constructor I thought this will be automatically added. Or could it be that the reading code of the CRChas an unknown problem?&lt;/p&gt;</comment>
                            <comment id="17089342" author="peterlee" created="Wed, 22 Apr 2020 06:39:42 +0000"  >&lt;p&gt;&amp;gt;&#160;Commons-compress does not get a CRC in the SevenZFile#readFilesInfo method. But the 7z GUI shows me a CRC (784DD132 for test.txt).&lt;/p&gt;

&lt;p&gt;Intersting. I will double check in this.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&amp;gt;&#160;Do I need to create the 7z archive in a different way to include a CRC checksum?&lt;/p&gt;

&lt;p&gt;No. It&apos;s OK to create 7z with or without a CRC - either is fine.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&amp;gt; Or could it be that the reading code of the CRChas an unknown problem?&lt;/p&gt;

&lt;p&gt;Yes, this is a problem in random access reading of 7z - and it&apos;s caused by my recently pushed code. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17090153" author="peterlee" created="Thu, 23 Apr 2020 01:45:33 +0000"  >&lt;p&gt;&amp;gt;&#160;Commons-compress does not get a CRC in the SevenZFile#readFilesInfo method. But the 7z GUI shows me a CRC (784DD132 for test.txt).&lt;/p&gt;

&lt;p&gt;Actually the&#160;784DD132 is the CRC checksum for the &apos;folder&apos;(which is in the coders info), not the CRC for the file(which is in the substreams info). Currently Commons Compress won&apos;t write the CRC in substreams info(but we can read and valid the CRC in substream info).&lt;/p&gt;

&lt;p&gt;When I talk about &apos;folder&apos; in 7z, it&apos;s not a directory - it&apos;s nothing special but a bunch of files. All the files in the same &apos;folder&apos; will be regarded as a single file and be compressed together. This is different from Zip and that&apos;s why it&apos;s difficult to have random access in 7z. And the compressed &apos;folder&apos; has a CRC checksum.&lt;/p&gt;

&lt;p&gt;Seems the 7z GUI is showing the CRC of the folder in coders info if the CRC in substreams info is absent.&lt;/p&gt;

&lt;p&gt;This may looks complicated but it&apos;s legal according to the 7z format specification.&lt;/p&gt;</comment>
                            <comment id="17090829" author="rschimpf" created="Thu, 23 Apr 2020 18:33:59 +0000"  >&lt;p&gt;Thank you for the detailed explanation. Now I know what that folder this is I came across while debugging &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I tested with some other 7z files I had laying around and everything worked fine!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13000808" name="image-2020-04-22-16-55-08-369.png" size="4484" author="peterlee" created="Wed, 22 Apr 2020 08:55:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 29 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0dqns:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>