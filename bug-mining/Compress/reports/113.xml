<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:30:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[COMPRESS-221] Compress cannot run without XZ included</title>
                <link>https://issues.apache.org/jira/browse/COMPRESS-221</link>
                <project id="12310904" key="COMPRESS">Commons Compress</project>
                    <description>&lt;p&gt;In previous versions of Compress, we used the Compress library in our application without requiring any other libraries.  Since the introduction of XZ, the library crashes because it does not dynamically try to find the XZ classes. Our application does not use or need XZ, and we &lt;em&gt;cannot&lt;/em&gt; add another ~100KB file to our application.&lt;/p&gt;

&lt;p&gt;To reproduce:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;// &amp;lt;properties&amp;gt;&amp;lt;mimeTypeRepository resource=&lt;span class=&quot;code-quote&quot;&gt;&quot;/etc/tika-mimetypes.xml&quot;&lt;/span&gt; magic=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;/&amp;gt;&amp;lt;/properties&amp;gt;
&lt;/span&gt;            tika = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TikaConfig(getClass().getClassLoader().getResourceAsStream(&lt;span class=&quot;code-quote&quot;&gt;&quot;etc/tika-config.xml&quot;&lt;/span&gt;));
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable t) {
            t.printStackTrace();
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MimeTypeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Cannot load tika-config.xml&quot;&lt;/span&gt;, t);
        }
        detector = tika.getDetector();
        MediaType contentType = MediaType.OCTET_STREAM;
        contentType = detector.detect(tika, metadata); &lt;span class=&quot;code-comment&quot;&gt;// error here&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Calling &lt;tt&gt;Detector.detect(InputStream, Metadata)&lt;/tt&gt; causes a &lt;tt&gt;NoClassDefFoundError&lt;/tt&gt; because it is trying to find the XZ files using a direct reference to the XZ classes.  &lt;tt&gt;Detector.detect:61&lt;/tt&gt; uses &lt;tt&gt;ZipContainerDetector.detect&lt;/tt&gt; to use &lt;tt&gt;CompressorInputStream createCompressorInputStream(InputStream)&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The problem in &lt;tt&gt;public CompressorInputStream createCompressorInputStream(InputStream)&lt;/tt&gt; is it directly calls static methods on the &lt;tt&gt;XZCompressorInputStream&lt;/tt&gt; class which aren&apos;t in the classpath.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (BZip2CompressorInputStream.matches(signature, signatureLength)) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BZip2CompressorInputStream(in);
      }
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (GzipCompressorInputStream.matches(signature, signatureLength)) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GzipCompressorInputStream(in);
      }
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (XZCompressorInputStream.matches(signature, signatureLength)) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; XZCompressorInputStream(in);
      }
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (Pack200CompressorInputStream.matches(signature, signatureLength))
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Pack200CompressorInputStream(in);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ass you can see, the &lt;tt&gt;XZCompressorInputStream.matches()&lt;/tt&gt; method is a static method.  When the class loader loads this class, it tries to load the import statements at the top of &lt;tt&gt;XZCompressorInputStream&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.commons.compress.compressors.CompressorInputStream;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.tukaani.xz.SingleXZInputStream;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.tukaani.xz.XZ;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.tukaani.xz.XZInputStream;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;And, since these &lt;tt&gt;org.tukaani.xz&lt;/tt&gt; classes don&apos;t exist, a &lt;tt&gt;NoClassDefFoundError&lt;/tt&gt; exception is thrown.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.NoClassDefFoundError: org/tukaani/xz/XZInputStream
at org.apache.commons.compress.compressors.CompressorStreamFactory.createCompressorInputStream(CompressorStreamFactory.java:120)
at org.apache.tika.parser.pkg.ZipContainerDetector.detectCompressorFormat(ZipContainerDetector.java:95)
at org.apache.tika.parser.pkg.ZipContainerDetector.detect(ZipContainerDetector.java:81)
at org.apache.tika.detect.CompositeDetector.detect(CompositeDetector.java:61)
at com.lookout.mimetype.TikaResourceMetadataFactory.createMetadata(TikaResourceMetadataFactory.java:166)
at com.lookout.mimetype.TikaResourceMetadataFactory.createMetadata(TikaResourceMetadataFactory.java:112)
(...)
Caused by: java.lang.ClassNotFoundException: org.tukaani.xz.XZInputStream
at java.net.URLClassLoader$1.run(URLClassLoader.java:202)
at java.security.AccessController.doPrivileged(Native Method)
at java.net.URLClassLoader.findClass(URLClassLoader.java:190)
at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.loadClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:306)
at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:301)
at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.loadClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:247)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The appropriate approach is to see if the classes exist before trying to use them.  If they fail, then XZ is not supported and &lt;tt&gt;ZipContainerDetector.detect&lt;/tt&gt; will not support XZ files.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12635392">COMPRESS-221</key>
            <summary>Compress cannot run without XZ included</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="mquigley">Matt Quigley</reporter>
                        <labels>
                    </labels>
                <created>Tue, 5 Mar 2013 18:27:11 +0000</created>
                <updated>Thu, 7 Mar 2013 16:17:24 +0000</updated>
                            <resolved>Thu, 7 Mar 2013 16:17:24 +0000</resolved>
                                    <version>1.4.1</version>
                                    <fixVersion>1.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13594040" author="mquigley" created="Tue, 5 Mar 2013 22:41:38 +0000"  >&lt;p&gt;Note that a possible solution is to have a try-catch on a static method which will fail when the class loader tries loading a class.&lt;/p&gt;


&lt;p&gt;For example, &lt;tt&gt;XZUtils&lt;/tt&gt; does not import any classes not in the Compress project, so we can add a static method &lt;tt&gt;isAvailable()&lt;/tt&gt; which calls a class which does import classes not in the Compress project:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    /**
     * This is a helper method to see &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the XZ library is available.
     * 
     * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; {@code &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;} &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the XZ library is available.
     */
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isAvailable() {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            XZCompressorInputStream.isAvailable();
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable t) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The following will always return &lt;tt&gt;true&lt;/tt&gt; when the class loader can load the XZ library, but will throw a &lt;tt&gt;NoClassDefFoundError&lt;/tt&gt; when its class cannot be loaded due to the imports problem.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    /**
     * This is a helper method to see &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the XZ library is available. If the library is not available, then the class
     * loader will &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; a {@code NoClassDefFoundError}.
     * 
     * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; {@code &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;} &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the XZ library is available.
     */
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isAvailable() {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And then before the XZ library is used, we can simply check to see if it is available:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (XZUtils.isAvailable()) {
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (XZCompressorInputStream.matches(signature, signatureLength)) {
                    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; XZCompressorInputStream(in);
                }
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13596013" author="bodewig" created="Thu, 7 Mar 2013 16:17:24 +0000"  >&lt;p&gt;Thanks!&lt;/p&gt;

&lt;p&gt;fixed with svn revision 1453941&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>315885</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 37 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1iibj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>316228</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>