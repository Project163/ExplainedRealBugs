<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:32:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[COMPRESS-424] [bzip2] Multiple ArrayIndexOutOfBoundsException(s) when decompressing malformed input</title>
                <link>https://issues.apache.org/jira/browse/COMPRESS-424</link>
                <project id="12310904" key="COMPRESS">Commons Compress</project>
                    <description>&lt;p&gt;Encountered multiple unchecked exceptions thrown from &lt;tt&gt;BZip2CompressorInputStream.&amp;lt;init&amp;gt;&lt;/tt&gt; when parsing malformed files. &lt;/p&gt;

&lt;p&gt;&lt;tt&gt;ArrayIndexOutOfBoundsException&lt;/tt&gt; is an unchecked exception that is not documented in this API; therefore, such exceptions can cause stability issues in applications that are not expecting them. Instead, an &lt;tt&gt;IOException&lt;/tt&gt; should be thrown indicating that the input stream contains malformed data.&lt;/p&gt;

&lt;p&gt;Stack traces for three distinct (but possibly related) sources of exceptions follow:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.ArrayIndexOutOfBoundsException: 65536
	at org.apache.commons.compress.compressors.bzip2.BZip2CompressorInputStream.hbCreateDecodeTables(BZip2CompressorInputStream.java:422)
	at org.apache.commons.compress.compressors.bzip2.BZip2CompressorInputStream.createHuffmanDecodingTables(BZip2CompressorInputStream.java:546)
	at org.apache.commons.compress.compressors.bzip2.BZip2CompressorInputStream.recvDecodingTables(BZip2CompressorInputStream.java:518)
	at org.apache.commons.compress.compressors.bzip2.BZip2CompressorInputStream.getAndMoveToFrontDecode(BZip2CompressorInputStream.java:555)
	at org.apache.commons.compress.compressors.bzip2.BZip2CompressorInputStream.initBlock(BZip2CompressorInputStream.java:324)
	at org.apache.commons.compress.compressors.bzip2.BZip2CompressorInputStream.&amp;lt;init&amp;gt;(BZip2CompressorInputStream.java:135)
	at org.apache.commons.compress.compressors.bzip2.BZip2CompressorInputStream.&amp;lt;init&amp;gt;(BZip2CompressorInputStream.java:112)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.ArrayIndexOutOfBoundsException: 6
	at org.apache.commons.compress.compressors.bzip2.BZip2CompressorInputStream.recvDecodingTables(BZip2CompressorInputStream.java:493)
	at org.apache.commons.compress.compressors.bzip2.BZip2CompressorInputStream.getAndMoveToFrontDecode(BZip2CompressorInputStream.java:555)
	at org.apache.commons.compress.compressors.bzip2.BZip2CompressorInputStream.initBlock(BZip2CompressorInputStream.java:324)
	at org.apache.commons.compress.compressors.bzip2.BZip2CompressorInputStream.&amp;lt;init&amp;gt;(BZip2CompressorInputStream.java:135)
	at org.apache.commons.compress.compressors.bzip2.BZip2CompressorInputStream.&amp;lt;init&amp;gt;(BZip2CompressorInputStream.java:112)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.ArrayIndexOutOfBoundsException: 18002
	at org.apache.commons.compress.compressors.bzip2.BZip2CompressorInputStream.getAndMoveToFrontDecode(BZip2CompressorInputStream.java:605)
	at org.apache.commons.compress.compressors.bzip2.BZip2CompressorInputStream.initBlock(BZip2CompressorInputStream.java:324)
	at org.apache.commons.compress.compressors.bzip2.BZip2CompressorInputStream.&amp;lt;init&amp;gt;(BZip2CompressorInputStream.java:135)
	at org.apache.commons.compress.compressors.bzip2.BZip2CompressorInputStream.&amp;lt;init&amp;gt;(BZip2CompressorInputStream.java:112)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The inputs were found by mutating random bytes in a simple well-formed file (a compressed string of zeros).&lt;/p&gt;
</description>
                <environment></environment>
        <key id="13110581">COMPRESS-424</key>
            <summary>[bzip2] Multiple ArrayIndexOutOfBoundsException(s) when decompressing malformed input</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="rohanpadhye">Rohan Padhye</reporter>
                        <labels>
                    </labels>
                <created>Thu, 19 Oct 2017 06:25:52 +0000</created>
                <updated>Sat, 30 Dec 2017 09:58:10 +0000</updated>
                            <resolved>Sat, 30 Dec 2017 09:58:10 +0000</resolved>
                                    <version>1.14</version>
                    <version>1.15</version>
                                    <fixVersion>1.16</fixVersion>
                                    <component>Compressors</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16266973" author="bodewig" created="Mon, 27 Nov 2017 15:54:17 +0000"  >&lt;p&gt;The code is a kind of hand-optimized mimic C as close as possible port and I&apos;m afraid adding explicit bounds checks would slow it down considerably - at least once we&apos;d get far enough to enter the decompression part and reach code that is run repeatedly. While I could tweak the three cases you&apos;ve found easily there probably are a few (or not so few) more cases where indexes get derived from input data.&lt;/p&gt;

&lt;p&gt;Maybe we should catch &lt;tt&gt;ArrayIndexOutOfBounds&lt;/tt&gt; inside the constructor and and &lt;tt&gt;read&lt;/tt&gt; and turn it into {{IOException}}s?&lt;/p&gt;</comment>
                            <comment id="16267172" author="rohanpadhye" created="Mon, 27 Nov 2017 18:12:46 +0000"  >&lt;p&gt;To be fair, the JVM does insert those bounds checks anyway in order to decide whether or not throw an exception, so I am not sure how &lt;em&gt;considerable&lt;/em&gt; the slow down would be with additional bounds check in Java.&lt;/p&gt;

&lt;p&gt;That said, if several sources of &lt;tt&gt;ArrayIndexOutOfBounds&lt;/tt&gt; are expected, then indeed catching them and throwing an &lt;tt&gt;IOException&lt;/tt&gt; instead would make the implementation consistent with the API specification. My primary concern is that applications that process user-derived input files should expect the decompression to either succeed or to fail using an &lt;tt&gt;IOException&lt;/tt&gt;, such that they can handle either case in an application-specific way (e.g. show an error message to the end-user). Throwing an undocumented unchecked exception would probably lead such an application to crash unexpectedly or log the error in a top-level exception handling mechanism instead of gracefully interacting with the end-user. Consequently, developers using the bzip2 API would be forced to explicitly handle &lt;tt&gt;ArrayIndexOutOfBounds&lt;/tt&gt;, but this seems like an implementation detail that is being leaked outside.&lt;/p&gt;

&lt;p&gt;The risk with this approach, of course, is that any &lt;tt&gt;ArrayIndexOutOfBounds&lt;/tt&gt; would be wrapped in an &lt;tt&gt;IOException&lt;/tt&gt;, even if there was a genuine bug in processing a well-formed file (and would thus make such a hypothetical bug slightly harder to detect).&lt;/p&gt;</comment>
                            <comment id="16268989" author="bodewig" created="Tue, 28 Nov 2017 16:24:17 +0000"  >&lt;p&gt;Well, my &quot;considerable&quot; is a guess and maybe I should just try it (I do have a JMH setup to look at the effects). For three places you&apos;ve found there is no big problem to expect as this is setup code that is run once per &quot;block&quot; of 900kB so the effects are probably minor.&lt;/p&gt;

&lt;p&gt;For the code that really gets hit a lot we&apos;ll need some time to review it, it is not an easy read and it&apos;s been quite some time since I last tried to wrap my head around it.&lt;/p&gt;

&lt;p&gt;I understand where you are coming from but won&apos;t rule out you may find similar errors within the other compressors or archivers as well.&lt;/p&gt;</comment>
                            <comment id="16305571" author="bodewig" created="Thu, 28 Dec 2017 16:21:12 +0000"  >&lt;p&gt;for some reason I cannot explain the effect - if one exists - rather says things have sped up &lt;a href=&quot;https://github.com/bodewig/commons-compress-benchmarks/wiki/COMPRESS-424&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/bodewig/commons-compress-benchmarks/wiki/COMPRESS-424&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The change is &lt;a href=&quot;https://github.com/apache/commons-compress/commit/ccf4ce767a6cc07f1a88a0c33393e394af3c328b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-compress/commit/ccf4ce767a6cc07f1a88a0c33393e394af3c328b&lt;/a&gt; which I&apos;ll need to triple-check before merging it to master.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12892996" name="bad1.bz2" size="32" author="rohanpadhye" created="Thu, 19 Oct 2017 06:26:47 +0000"/>
                            <attachment id="12892995" name="bad2.bz2" size="32" author="rohanpadhye" created="Thu, 19 Oct 2017 06:26:52 +0000"/>
                            <attachment id="12892994" name="bad3.bz2" size="32" author="rohanpadhye" created="Thu, 19 Oct 2017 06:26:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 46 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3lg6v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>