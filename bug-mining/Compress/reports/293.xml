<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:33:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[COMPRESS-454] Bug in determination of Signature for STORED ZipArchive with data descriptor</title>
                <link>https://issues.apache.org/jira/browse/COMPRESS-454</link>
                <project id="12310904" key="COMPRESS">Commons Compress</project>
                    <description>&lt;p&gt;The archive file contains a data descriptor, which is not recognized and lead to&#160;&quot;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.util.zip.ZipException: Unexpected record signature: 0X302D3831&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The process to check if one block contains a signature(ZipArchiveInputStream -&amp;gt;&#160;bufferContainsSignature) seems to be a little buggy.&lt;/p&gt;

&lt;p&gt;The following block is processed when the exception comes up, for the file.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;13, 10, 60, 73, 66, 65, 78, 62, 65, 84, 52, 48, 54, 48, 48, 48, 48, 48, 48, 48, 48, 55, 53, 48, 48, 48, 53, 51, 60, 47, 73, 66, 65, 78, 62, 13, 10, 60, 47, 73, 100, 62, 13, 10, 60, 47, 67, 100, 116, 114, 65, 99, 99, 116, 62, 13, 10, 60, 47, 82, 108, 116, 100, 80, 116, 105, 101, 115, 62, 13, 10, 60, 82, 108, 116, 100, 65, 103, 116, 115, 62, 13, 10, 60, 68, 98, 116, 114, 65, 103, 116, 62, 13, 10, 60, 70, 105, 110, 73, 110, 115, 116, 110, 73, 100, 62, 13, 10, 60, 66, 73, 67, 62, 66, 65, 87, 65, 65, 84, 87, 87, 88, 88, 88, 60, 47, 66, 73, 67, 62, 13, 10, 60, 47, 70, 105, 110, 73, 110, 115, 116, 110, 73, 100, 62, 13, 10, 60, 47, 68, 98, 116, 114, 65, 103, 116, 62, 13, 10, 60, 67, 100, 116, 114, 65, 103, 116, 62, 13, 10, 60, 70, 105, 110, 73, 110, 115, 116, 110, 73, 100, 62, 13, 10, 60, 66, 73, 67, 62, 66, 65, 87, 65, 65, 84, 87, 87, 88, 88, 88, 60, 47, 66, 73, 67, 62, 13, 10, 60, 47, 70, 105, 110, 73, 110, 115, 116, 110, 73, 100, 62, 13, 10, 60, 47, 67, 100, 116, 114, 65, 103, 116, 62, 13, 10, 60, 47, 82, 108, 116, 100, 65, 103, 116, 115, 62, 13, 10, 60, 80, 117, 114, 112, 62, 13, 10, 60, 67, 100, 62, 79, 84, 72, 82, 60, 47, 67, 100, 62, 13, 10, 60, 47, 80, 117, 114, 112, 62, 13, 10, 60, 82, 109, 116, 73, 110, 102, 62, 13, 10, 60, 83, 116, 114, 100, 62, 13, 10, 60, 67, 100, 116, 114, 82, 101, 102, 73, 110, 102, 62, 13, 10, 60, 84, 112, 62, 13, 10, 60, 67, 100, 79, 114, 80, 114, 116, 114, 121, 62, 13, 10, 60, 67, 100, 62, 83, 67, 79, 82, 60, 47, 67, 100, 62, 13, 10, 60, 47, 67, 100, 79, 114, 80, 114, 116, 114, 121, 62, 13, 10, 60, 47, 84, 112, 62, 13, 10, 60, 82, 101, 102, 62, 53, 48, 49, 48, 54, 52, 55, 52, 49, 52, 60, 47, 82, 101, 102, 62, 13, 10, 60, 47, 67, 100, 116, 114, 82, 101, 102, 73, 110, 102, 62, 13, 10, 60, 47, 83, 116, 114, 100, 62, 13, 10, 60, 47, 82, 109, 116, 73, 110, 102, 62, 13, 10, 60, 47, 84, 120, 68, 116, 108, 115, 62, 13, 10, 60, 47, 78, 116, 114, 121, 68, 116, 108, 115, 62, 13, 10, 60, 47, 78, 116, 114, 121, 62, 13, 10, 60, 47, 83, 116, 109, 116, 62, 13, 10, 60, 47, 66, 107, 84, 111, 67, 115, 116, 109, 114, 83, 116, 109, 116, 62, 13, 10, 60, 47, 68, 111, 99, 117, 109, 101, 110, 116, 62, 80, 75, 7, 8, -70, -19, -86, -114, -92, 11, 0, 0, -92, 11, 0, 0&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;The lastRead variable is set to 497. The offset is 15.&lt;/p&gt;

&lt;p&gt;The &lt;b&gt;for&lt;/b&gt; in &lt;b&gt;bufferContainsSignature&lt;/b&gt; do not recognize the&#160;data descriptor because it goes only to the &lt;b&gt;lastRead - 4&lt;/b&gt;.&lt;/p&gt;

&lt;p&gt;In the following method&#160;&lt;b&gt;cacheBytesRead&lt;/b&gt; only 15 bytes from 497 to 512 are cached, so the P((byte)80) on position 496 is not&#160;cached in the next block.&lt;/p&gt;

&lt;p&gt;My suggestion for the solution is to check all bytes(&lt;b&gt;buf.array().length - 4&lt;/b&gt;) in&#160;ZipArchiveInputStream -&amp;gt;&#160;bufferContainsSignature, if they contain the&#160;ZipArchiveInputStream.LFH,&#160;ZipArchiveInputStream.CFH or&#160;ZipArchiveInputStream.DD bytes, but maybe I miss something.&#160;&lt;/p&gt;

&lt;p&gt;However, seems to work for the example files.&lt;/p&gt;

&lt;p&gt;Sorry not to share the example files&#160;they are created by a customer.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Windows,&#160;JDK 9.0.4&lt;/p&gt;</environment>
        <key id="13162625">COMPRESS-454</key>
            <summary>Bug in determination of Signature for STORED ZipArchive with data descriptor</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="mikegike">Mike Scholl</reporter>
                        <labels>
                            <label>zip</label>
                    </labels>
                <created>Tue, 29 May 2018 15:44:46 +0000</created>
                <updated>Wed, 30 May 2018 09:33:44 +0000</updated>
                            <resolved>Wed, 30 May 2018 09:31:42 +0000</resolved>
                                    <version>1.16.1</version>
                                    <fixVersion>1.17</fixVersion>
                                    <component>Archivers</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16494910" author="bodewig" created="Wed, 30 May 2018 09:09:20 +0000"  >&lt;p&gt;At first glance the upper bound of the &lt;tt&gt;for&lt;/tt&gt; in &lt;tt&gt;bufferContainsSignature&lt;/tt&gt; is indeed wrong and should probably be &lt;tt&gt;offset + lastread - 4&lt;/tt&gt;, I&apos;ll need to think this through once again and run a few tests. We cannot read until the buffer&apos;s array length as everything behind &lt;tt&gt;offset + lastRead - 1&lt;/tt&gt; is not a result of things we&apos;ve just read from the stream.&lt;/p&gt;</comment>
                            <comment id="16494920" author="mikegike" created="Wed, 30 May 2018 09:15:27 +0000"  >&lt;p&gt;I&apos;ve done some more debugging with other files, and saw these lines in the code in&#160;ZipArchiveInputStream -&amp;gt;&#160;readStoredEntry.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// length of DD without signature
&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; ddLen = current.usesZip64 ? WORD + 2 * DWORD : 3 * WORD;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Is there is a reason why the signature not considered? Changing 3 to 4 works also with several files with data descriptor and without.&#160;&lt;/p&gt;</comment>
                            <comment id="16494922" author="bodewig" created="Wed, 30 May 2018 09:20:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mikegike&quot; class=&quot;user-hover&quot; rel=&quot;mikegike&quot;&gt;mikegike&lt;/a&gt; can you try the change I suggest above?&lt;/p&gt;

&lt;p&gt;Unfortunately there are ZIP implementations out there that don&apos;t use a signature for the DD. The PKWare spec didn&apos;t define a signature and the InfoZIP folks invented one. So the code needs to deal with DDs that either contain a signature or not. It assumes it has found a DD without signature if a LFH or CFH has been hit.&lt;/p&gt;</comment>
                            <comment id="16494926" author="mikegike" created="Wed, 30 May 2018 09:28:05 +0000"  >&lt;p&gt;Adding the offset also solve the problem.&#160;&lt;/p&gt;</comment>
                            <comment id="16494931" author="bodewig" created="Wed, 30 May 2018 09:31:42 +0000"  >&lt;p&gt;Many thanks!&lt;/p&gt;

&lt;p&gt;Fixed in master with commit c2ace886 .&lt;/p&gt;</comment>
                            <comment id="16494933" author="mikegike" created="Wed, 30 May 2018 09:33:44 +0000"  >&lt;p&gt;Thanks alot!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 24 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3u9lz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>