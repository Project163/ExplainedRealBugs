<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:33:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[COMPRESS-455] Cannot open certain APK file (Unexpected record signature)</title>
                <link>https://issues.apache.org/jira/browse/COMPRESS-455</link>
                <project id="12310904" key="COMPRESS">Commons Compress</project>
                    <description>&lt;p&gt;I&apos;m developing a file manager for Android and&#160;noticed that&#160;ZipArchiveInputStream throws an exception for certain APK files (but not all) I have at hand:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;06-12 23:01:03.043 26960-4050/me.zhanghai.android.materialfilemanager W/System.err: java.util.zip.ZipException: Unexpected record signature: 0X621
06-12 23:01:03.044 26960-4050/me.zhanghai.android.materialfilemanager W/System.err: at org.apache.commons.compress.archivers.zip.ZipArchiveInputStream.getNextZipEntry(ZipArchiveInputStream.java:258)
 at org.apache.commons.compress.archivers.zip.ZipArchiveInputStream.getNextEntry(ZipArchiveInputStream.java:406)
 at me.zhanghai.android.materialfilemanager.filesystem.Archive.readEntries(Archive.java:79)
 at me.zhanghai.android.materialfilemanager.filesystem.Archive.read(Archive.java:36)
 at me.zhanghai.android.materialfilemanager.filesystem.ArchiveFile.loadFileList(ArchiveFile.java:112)
 at me.zhanghai.android.materialfilemanager.filelist.FileLiveData$1.doInBackground(FileLiveData.java:32)
 at me.zhanghai.android.materialfilemanager.filelist.FileLiveData$1.doInBackground(FileLiveData.java:28)
 at android.os.AsyncTask$2.call(AsyncTask.java:333)
 at java.util.concurrent.FutureTask.run(FutureTask.java:266)
 at android.os.AsyncTask$SerialExecutor$1.run(AsyncTask.java:245)
 at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1162)
 at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:636)
 at java.lang.Thread.run(Thread.java:764)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;However, these APKs installs fine, and can be viewed by&#160;the system&#160;Files app (by changing extension to zip) and&#160;some other opensource&#160;file managers built upon java.util.zip.&lt;/p&gt;

&lt;p&gt;Some links to APKs I found with this problem:&lt;/p&gt;

&lt;p&gt;1. &lt;a href=&quot;https://github.com/paphonb/PixelLauncherModV5/releases/download/5.3_23/Pixel.2.Launcher.modded.5.3.build.23.apk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/paphonb/PixelLauncherModV5/releases/download/5.3_23/Pixel.2.Launcher.modded.5.3.build.23.apk&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;2. &lt;a href=&quot;https://github.com/Yink/Amadeus/releases/download/0.9.6-alpha.5/amadeus.apk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/Yink/Amadeus/releases/download/0.9.6-alpha.5/amadeus.apk&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;My code for reading the APK archive entries:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void readEntries(InputStream inputStream, List&amp;lt;ArchiveEntry&amp;gt; entries)
        &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; ArchiveException, IOException {
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (ArchiveInputStream archiveInputStream = sArchiveStreamFactory.createArchiveInputStream(
&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BufferedInputStream(inputStream))) {
        &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
            ArchiveEntry entry = archiveInputStream.getNextEntry();
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (entry == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
            }
            entries.add(entry);
        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Also note that if I catch the exception while keeping the list of already-read entries, it seems that&#160;(almost) all entries have been read.&lt;/p&gt;

&lt;p&gt;I wonder how this can be fixed, or if this is because those&#160;files&#160;have some kind of weird format, how can I possibly work around this?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Android 8.1.0&lt;/p&gt;</environment>
        <key id="13165597">COMPRESS-455</key>
            <summary>Cannot open certain APK file (Unexpected record signature)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="dreamingincode">Hai Zhang</reporter>
                        <labels>
                    </labels>
                <created>Tue, 12 Jun 2018 15:27:47 +0000</created>
                <updated>Sat, 16 Jan 2021 08:10:37 +0000</updated>
                            <resolved>Mon, 6 Aug 2018 17:32:26 +0000</resolved>
                                    <version>1.17</version>
                                    <fixVersion>1.18</fixVersion>
                                    <component>Archivers</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16509784" author="bodewig" created="Tue, 12 Jun 2018 15:53:30 +0000"  >&lt;p&gt;The signature consisting of only two bytes looks strange (I&apos;d expect the usual &quot;PK&quot; bytes if this simply was some kind of unsupported feature inside of a regular archive. Have you tried using &lt;tt&gt;ZipFile&lt;/tt&gt; rather than &lt;tt&gt;ZipArchiveInputStream&lt;/tt&gt;? This has the benefit of being able to read the central directory and doesn&apos;t have to scan the archive sequentially performing pattern matching on suspect header signatures.&lt;/p&gt;</comment>
                            <comment id="16510779" author="dreamingincode" created="Wed, 13 Jun 2018 08:28:20 +0000"  >&lt;p&gt;Thanks for the answer; using &lt;tt&gt;ZipFile&lt;/tt&gt; did work well for those files (except that I need to fallback to &lt;tt&gt;java.util.zip.ZipFile&lt;/tt&gt; on versions before Android Oreo). I wonder if &lt;tt&gt;ZipArchiveInputStream&lt;/tt&gt; can also read the central directory so that such most files (except 7z which don&apos;t support the stream) can be read in a uniform way?&lt;/p&gt;</comment>
                            <comment id="16514171" author="bodewig" created="Fri, 15 Jun 2018 17:55:58 +0000"  >&lt;p&gt;Unfortunately this really requires random access which is not possible with a stream based API (unless you capture the whole stream to a file or in memory, that is). The &quot;central directory&quot; of a ZIP archive is at the end of the archive while all entry content is before it. &lt;tt&gt;ZipFile&lt;/tt&gt; has several advantages over &lt;tt&gt;ZipArchiveInputStream&lt;/tt&gt; - see &lt;a href=&quot;https://commons.apache.org/proper/commons-compress/zip.html#ZipArchiveInputStream_vs_ZipFile&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://commons.apache.org/proper/commons-compress/zip.html#ZipArchiveInputStream_vs_ZipFile&lt;/a&gt; - so I can only recommend to special case the ZIP format as you have to do for 7z as well.&lt;/p&gt;

&lt;p&gt;I&apos;m not familiar enough with Android but curious. Why can you use Commons Compress&apos; &lt;tt&gt;ZipArchiveInputStream&lt;/tt&gt; but not &lt;tt&gt;ZipFile&lt;/tt&gt; on Oreo - they should require the same Java VM version.&lt;/p&gt;

&lt;p&gt;Please don&apos;t close this issue as I intend to look into the archives you&apos;ve linked in order to see whether they are really broken or there is anything we can do to make &lt;tt&gt;ZipArchiveInputStream&lt;/tt&gt; handle them.&lt;/p&gt;</comment>
                            <comment id="16514601" author="dreamingincode" created="Sat, 16 Jun 2018 01:05:43 +0000"  >&lt;p&gt;Thanks for the answer! I didn&apos;t&#160;realize the central directory is actually at the end of a zip file.&lt;/p&gt;

&lt;p&gt;Regarding Android, ZipFile is not usable before Android Oreo because the nio file package is &lt;a href=&quot;https://developer.android.com/reference/java/nio/file/Files#newByteChannel(java.nio.file.Path,%20java.nio.file.OpenOption...)&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;not available before it&lt;/a&gt; (you can see &quot;added in API level 26&quot;), so that calling&#160;&lt;tt&gt;Files.newByteChannel()&lt;/tt&gt; results in an exception on earlier Android versions. The &lt;tt&gt;java.util.zip.ZipFile&lt;/tt&gt; on Android don&apos;t have such problem because it is &lt;a href=&quot;https://android.googlesource.com/platform/libcore/+/master/ojluni/src/main/java/java/util/zip/ZipFile.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;using some native calls and mmap for this&lt;/a&gt;, so that I&apos;m falling back to it before Oreo.&lt;/p&gt;</comment>
                            <comment id="16514777" author="bodewig" created="Sat, 16 Jun 2018 13:28:24 +0000"  >&lt;p&gt;java.util.zip has other problems which made us - actually ant-dev - implement a replacement in the first place. If it works for your use case, then things are fine &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Thank you for the explanation, this probably means you cant&apos;t use 7z in Oreo at all as it also relies on nio.&lt;/p&gt;</comment>
                            <comment id="16529044" author="bodewig" created="Sun, 1 Jul 2018 10:44:32 +0000"  >&lt;p&gt;I think what you see is the APK signing block &lt;a href=&quot;https://source.android.com/security/apksigning/v2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://source.android.com/security/apksigning/v2&lt;/a&gt; which sits between all local file headers and the central directory. Commons Compress doesn&apos;t know how to parse the block or just to detect it and skip over it.&lt;/p&gt;

&lt;p&gt;Unfortunately the block does not start with a signature (but rather ends with it) so it is difficult to know whether what we see is such a block. The block starts with eight bytes holding the length, so we could try to interpret the next eight bytes as a length, skip over a block of that size, see whether we find the &quot;APK Sig Block 42&#8221; and call it a day.&lt;/p&gt;

&lt;p&gt;In order to have a testcase we probably need a very small apk that is signed and can be distributed as part of our source tree.&lt;/p&gt;</comment>
                            <comment id="16529048" author="dreamingincode" created="Sun, 1 Jul 2018 11:00:11 +0000"  >&lt;p&gt;What you described reminds me of &lt;a href=&quot;https://github.com/fractalwrench/ApkGolf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;apk-golf&lt;/a&gt;. It provides a signed APK file &lt;a href=&quot;https://github.com/fractalwrench/ApkGolf/blob/master/signed-release.apk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, and accroding to the &lt;a href=&quot;https://github.com/fractalwrench/ApkGolf/blob/master/build.sh&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build script&lt;/a&gt; it uses only APK signature V2. The only problem is I didn&apos;t see a license at first glance.&lt;/p&gt;</comment>
                            <comment id="16529054" author="bodewig" created="Sun, 1 Jul 2018 11:48:58 +0000"  >&lt;p&gt;The current master branch can now read both APKs, but the code lacks all tests and contains two branches I haven&apos;t even run, yet. I&apos;ll need to find a way to write tests before I can close this issue.&lt;/p&gt;</comment>
                            <comment id="16529056" author="bodewig" created="Sun, 1 Jul 2018 11:52:04 +0000"  >&lt;p&gt;At least apk-golf will provide me with ideas how to create such an APK, which probably means I first need to install an Android SDK. I&apos;ll leave that for another day &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16570527" author="bodewig" created="Mon, 6 Aug 2018 17:32:26 +0000"  >&lt;p&gt;I&apos;ve split creating a test case into &lt;a href=&quot;https://issues.apache.org/jira/browse/COMPRESS-461&quot; title=&quot;Add test for APK signing block&quot; class=&quot;issue-link&quot; data-issue-key=&quot;COMPRESS-461&quot;&gt;COMPRESS-461&lt;/a&gt; as I&apos;m unlikely to find time for setting up an Android dev environment soon.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13352587">COMPRESS-562</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 14 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3urxb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>