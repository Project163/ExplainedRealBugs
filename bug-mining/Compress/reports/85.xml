<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:30:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[COMPRESS-176] ArchiveInputStream#getNextEntry(): Problems with WinZip directories with Umlauts</title>
                <link>https://issues.apache.org/jira/browse/COMPRESS-176</link>
                <project id="12310904" key="COMPRESS">Commons Compress</project>
                    <description>&lt;p&gt;There is a problem when handling a WinZip-created zip with Umlauts in directories.&lt;/p&gt;

&lt;p&gt;I&apos;m accessing a zip file created with WinZip containing a directory with an umlaut (&quot;&#228;&quot;) with ArchiveInputStream. When creating the zip file the unicode-flag of winzip had been active.&lt;/p&gt;

&lt;p&gt;The following problem occurs when accessing the entries of the zip:&lt;br/&gt;
the ArchiveEntry for a directory containing an umlaut is not marked as a directory and the file names for the directory and all files contained in that directory contain backslashes instead of slashes (i.e. completely different to all other files in directories with no umlaut in their path).&lt;/p&gt;

&lt;p&gt;There is no difference when letting the ArchiveStreamFactory decide which ArchiveInputStream to create or when using the ZipArchiveInputStream constructor with the correct encoding (I&apos;ve tried different encodings CP437, CP850, ISO-8859-15, but still the problem persisted).&lt;/p&gt;

&lt;p&gt;This problem does not occur when using the very same zip file but compressed by 7zip or the built-in Windows 7 zip functionality.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Windows 7&lt;/p&gt;</environment>
        <key id="12543041">COMPRESS-176</key>
            <summary>ArchiveInputStream#getNextEntry(): Problems with WinZip directories with Umlauts</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bodewig">Stefan Bodewig</assignee>
                                    <reporter username="wurstbrot">Wurstbrot mit Senf</reporter>
                        <labels>
                    </labels>
                <created>Fri, 17 Feb 2012 12:05:24 +0000</created>
                <updated>Tue, 28 Feb 2012 14:06:30 +0000</updated>
                            <resolved>Tue, 28 Feb 2012 14:06:30 +0000</resolved>
                                    <version>1.3</version>
                                    <fixVersion>1.4</fixVersion>
                                    <component>Archivers</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13211794" author="sebb@apache.org" created="Mon, 20 Feb 2012 11:54:04 +0000"  >&lt;p&gt;Could you attach minimal sample archives which show the problem?&lt;/p&gt;</comment>
                            <comment id="13212635" author="wurstbrot" created="Tue, 21 Feb 2012 14:59:39 +0000"  >&lt;p&gt;Minimum test zip attached.&lt;/p&gt;</comment>
                            <comment id="13212641" author="sebb@apache.org" created="Tue, 21 Feb 2012 15:08:28 +0000"  >&lt;p&gt;Thanks, but you have not granted the ASF licence to use the file, which means we cannot include it in our test suite.&lt;/p&gt;

&lt;p&gt;Please could you delete and reattach it?&lt;/p&gt;

&lt;p&gt;Also, we will need the equivalent 7zip and Win7 archives for comparison.&lt;/p&gt;</comment>
                            <comment id="13212656" author="wurstbrot" created="Tue, 21 Feb 2012 15:28:11 +0000"  >&lt;p&gt;re-added winzip zip file plus identical ones packed with 7zip and windows built-in zip facility.&lt;/p&gt;</comment>
                            <comment id="13213223" author="sebb@apache.org" created="Wed, 22 Feb 2012 03:03:11 +0000"  >&lt;p&gt;Thanks.&lt;/p&gt;

&lt;p&gt;I&apos;m beginning to wonder if Winzip is faulty.&lt;br/&gt;
The unicode filename that is stored uses \ whereas the base name uses /.&lt;/p&gt;</comment>
                            <comment id="13215664" author="wurstbrot" created="Fri, 24 Feb 2012 15:14:43 +0000"  >&lt;p&gt;Btw.: I have no problems to handle this jar using java.util.zip (Java 6) for some reason &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13215704" author="bodewig" created="Fri, 24 Feb 2012 15:58:23 +0000"  >&lt;p&gt;This is what InfoZIP&apos;s zip on Linux says:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;stefanb@brick:~$ zip -Tv Desktop/test-winzip.zip 
Archive:  Desktop/test-winzip.zip
    testing: doc.txt.gz               OK
    testing: doc2.txt                 OK
    testing: ??\                      OK
    testing: ??\??zip.zip             OK
    testing: ??\??.txt                OK
No errors detected in compressed data of Desktop/test-winzip.zip.
test of Desktop/test-winzip.zip OK
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The entry for the directory contains a Unicode extra field with 0xc3 0xa4 0x5c as UTF-8 encoded name.  This actually is &quot;&#228;\&quot;.&lt;/p&gt;

&lt;p&gt;Since directory names in ZIP archives must end with &quot;/&quot; Compress doesn&apos;t detect this as a directory.  It may be possible to create a workaround like &quot;if the &apos;plain name ends with a / and the unicode name uses a \ then bend it&quot;, but I can&apos;t say I&apos;d like that.&lt;/p&gt;

&lt;p&gt;Java6 likely works because it doesn&apos;t have any idea about unicode extra fields and simply uses the &quot;plain&quot; name.  You&apos;d get the same behavior from ZipArchiveInputStream by setting useUnicodeExtraFields to false in the constructor.&lt;/p&gt;</comment>
                            <comment id="13215732" author="sebb@apache.org" created="Fri, 24 Feb 2012 16:48:03 +0000"  >&lt;p&gt;The plain names use / and look OK when using CP437.&lt;/p&gt;

&lt;p&gt;For some odd reason, the unicode extra fields use \ instead of /&lt;br/&gt;
I think that may be a Winzip bug - it does not make sense to use a different separator for the extra fields.&lt;/p&gt;

&lt;p&gt;To confirm this is a bug, it would be useful to see how other zip tools use the extra fields - are there any?&lt;br/&gt;
Apart from Ant or other code based on Commons Compress, of course!&lt;/p&gt;

&lt;p&gt;Alternatively, find some documentation as to the correct contents of the field.&lt;/p&gt;

&lt;p&gt;My version of Winzip is too old to support the fields; if you have purchased a more recent one perhaps you could e-mail their support desk?&lt;/p&gt;

&lt;p&gt;A possible work-round would be to make the \ =&amp;gt; / behaviour optional; I agree we should not do this by default&lt;/p&gt;</comment>
                            <comment id="13216446" author="bodewig" created="Sat, 25 Feb 2012 13:41:45 +0000"  >&lt;p&gt;AFAIK what we have written down based on findings by Wolfgang Glas in &lt;a href=&quot;http://commons.apache.org/compress/zip.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://commons.apache.org/compress/zip.html&lt;/a&gt; still stands, WinZIP is the only one using Unicode extra fields, all other implementations have switched to the language encoding flag.  The only exceptions are Windows compressed folders - which doesn&apos;t understand either - and InfoZIP based tools if they are compiled to use the extra fields.&lt;/p&gt;

&lt;p&gt;A question to the original reporter (I&apos;m German so I know the name&apos;s a fake 8-): since you also have an installation of 7zip, what does 7zip think of your WinZIP created archive?&lt;/p&gt;</comment>
                            <comment id="13216468" author="sebb@apache.org" created="Sat, 25 Feb 2012 14:38:08 +0000"  >&lt;p&gt;I have 7zip installed, and it reads the archive OK.&lt;/p&gt;

&lt;p&gt;However, I don&apos;t think that proves anything, since the plain names are correct.&lt;/p&gt;

&lt;p&gt;I guess we could look at the 7zip source code to see if it uses the extra fields.&lt;/p&gt;

&lt;p&gt;A better test would be to create a zip file using a filename that cannot be represented in CP437, i.e. only the extra field would show the correct name.&lt;/p&gt;</comment>
                            <comment id="13216609" author="sebb@apache.org" created="Sun, 26 Feb 2012 01:34:24 +0000"  >&lt;p&gt;Copy of test-winzip.zip, but with plain file name changed from 3zip.zip to 3zap.zap.&lt;/p&gt;

&lt;p&gt;This shows only the plain file name in 7zip and in my copy of Winzip (9.0).&lt;/p&gt;

&lt;p&gt;This suggests that neither is processing the unicode extra fields.&lt;/p&gt;</comment>
                            <comment id="13216647" author="bodewig" created="Sun, 26 Feb 2012 06:42:02 +0000"  >&lt;p&gt;OK, this means nobody except for Commons Compress and InfoZIP tools seems to read the Unicode extra field.&lt;/p&gt;

&lt;p&gt;This is what I get when trying to extract the original ZIP on Linux:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;stefan@birdy:~/Desktop$ unzip test-winzip.zip 
Archive:  test-winzip.zip
  inflating: doc.txt.gz              
 extracting: doc2.txt                
warning:  test-winzip.zip appears to use backslashes as path separators
   creating: ??/
  inflating: ??/??zip.zip            
 extracting: ??/??.txt  
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and it creates an &quot;&#228;&quot; directory.  I&apos;ll try to look through InfoZIPs sources what it bases it heuristics on, maybe we can use the same in Commons Compress to turn backslashes into slashes.&lt;/p&gt;</comment>
                            <comment id="13216652" author="bodewig" created="Sun, 26 Feb 2012 07:04:20 +0000"  >&lt;p&gt;In extract.c of unzip60 line 1310ff there is this code that replaces backslashes with slashes.  It only replaces them in names that don&apos;t contain forward slashes (MBSCHR looks up a character in a character array) and only if &quot;hostnum&quot; indicates a FAT system.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;            /* for files from DOS FAT, check for use of backslash instead
             *  of slash as directory separator (bug in some zipper(s); so
             *  far, not a problem in HPFS, NTFS or VFAT systems)
             */
#ifndef SFX
            if (G.pInfo-&amp;gt;hostnum == FS_FAT_ &amp;amp;&amp;amp; !MBSCHR(G.filename, &apos;/&apos;)) {
                char *p=G.filename;

                if (*p) do {
                    if (*p == &apos;\\&apos;) {
                        if (!G.reported_backslash) {
                            Info(slide, 0x21, ((char *)slide,
                              LoadFarString(BackslashPathSep), G.zipfn));
                            G.reported_backslash = TRUE;
                            if (!error_in_archive)
                                error_in_archive = PK_WARN;
                        }
                        *p = &apos;/&apos;;
                    }
                } while (*PREINCSTR(p));
            }
#endif /* !SFX */
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&quot;hostnum&quot; is the upper byte of &quot;version made by&quot; inside the central directory header - this is ZipArchiveEntry&apos;s get/setPlatform - and FS_FAT_ is 0 (ZipArchiveEntry#PLATFORM_FAT).  We&apos;d have all pieces together to emulate this.&lt;/p&gt;</comment>
                            <comment id="13216739" author="sebb@apache.org" created="Sun, 26 Feb 2012 13:18:06 +0000"  >&lt;p&gt;Excellent!&lt;br/&gt;
Since \ and / are not allowed in file or folder names on Windows systems, there should be no case where a \ is incorrectly replaced.&lt;br/&gt;
And it would still work if Winzip fixes its implementation to use /, and would also work with other applications that use / for the extra fields.&lt;/p&gt;

&lt;p&gt;==&lt;/p&gt;

&lt;p&gt;There&apos;s still potentially the reverse problem - can Winzip handle / in the unicode extra field, or does it expect only \ ?&lt;br/&gt;
If so, then I guess we might need to make the generated extra fields configurable to use \.&lt;br/&gt;
I don&apos;t have the required version of Winzip to check that.&lt;/p&gt;</comment>
                            <comment id="13217122" author="bodewig" created="Mon, 27 Feb 2012 09:10:53 +0000"  >&lt;p&gt;Whether we need forward slashes in Unicode extra fields can only be answered by somebody using WinZIP.  The best would be creating a test archive with a directory that contains a character in its name that is not part of CP437 - and to be safe not part of the platform&apos;s default encoding either.&lt;/p&gt;</comment>
                            <comment id="13217899" author="bodewig" created="Tue, 28 Feb 2012 05:01:30 +0000"  >&lt;p&gt;Workaround and tests are in svn revision 1294460&lt;/p&gt;

&lt;p&gt;I&apos;ll look into creating a test archive for the opposite direction today.&lt;/p&gt;</comment>
                            <comment id="13217974" author="wurstbrot" created="Tue, 28 Feb 2012 07:17:38 +0000"  >&lt;p&gt;Hi all, sounds promising. Thanks a lot, I&apos;m looking forward to the next release.&lt;/p&gt;

&lt;p&gt;And by the way, how could you tell that the name&apos;s a fake? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13218062" author="bodewig" created="Tue, 28 Feb 2012 10:46:30 +0000"  >&lt;p&gt;The attached ZIP (created by the trivial attached class) contains a file named &#8214;.txt and its parent directory &#8214; (that&apos;s a double vertical bar) using Unicode extra fields (and nothing else) and forward slashes.&lt;/p&gt;

&lt;p&gt;Can you please verify WinZIP is able to extract it?&lt;/p&gt;</comment>
                            <comment id="13218158" author="wurstbrot" created="Tue, 28 Feb 2012 13:32:06 +0000"  >&lt;p&gt;Seems to be OK. Got a directory &#8214; with the file &#8214;.txt in it.&lt;/p&gt;</comment>
                            <comment id="13218161" author="wurstbrot" created="Tue, 28 Feb 2012 13:33:52 +0000"  >&lt;p&gt;But 7Zip and windows built in zip both create a directory named %U2016 with a file named %U2016.txt in it.&lt;/p&gt;</comment>
                            <comment id="13218197" author="bodewig" created="Tue, 28 Feb 2012 14:06:30 +0000"  >&lt;p&gt;Great.&lt;/p&gt;

&lt;p&gt;I explicitly told ZipArchiveOutputStream to not use the language encoding flag to ensure WinZIP uses the Unicode extra field.  Otherwise 7Zip would have worked.  Windows Conmpressed Folders simply doesn&apos;t support file names with characters that are not part of the platform&apos;s namtive encoding.&lt;/p&gt;

&lt;p&gt;For a more complete discussion see &lt;a href=&quot;http://commons.apache.org/compress/zip.html#encoding&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://commons.apache.org/compress/zip.html#encoding&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12516310" name="MkZip.java" size="650" author="bodewig" created="Tue, 28 Feb 2012 10:46:30 +0000"/>
                            <attachment id="12515364" name="test-7zip.zip" size="800" author="wurstbrot" created="Tue, 21 Feb 2012 15:28:11 +0000"/>
                            <attachment id="12516311" name="test-doublevertical.zip" size="332" author="bodewig" created="Tue, 28 Feb 2012 10:46:30 +0000"/>
                            <attachment id="12515363" name="test-windows.zip" size="699" author="wurstbrot" created="Tue, 21 Feb 2012 15:28:11 +0000"/>
                            <attachment id="12515365" name="test-winzip.zip" size="903" author="wurstbrot" created="Tue, 21 Feb 2012 15:28:11 +0000"/>
                            <attachment id="12516072" name="testzap-winzip.zip" size="903" author="sebb" created="Sun, 26 Feb 2012 01:34:24 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>228327</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 38 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0b4bj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>62812</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>