<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:33:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[COMPRESS-514] SevenZFile fails with encoded header over 2GiB</title>
                <link>https://issues.apache.org/jira/browse/COMPRESS-514</link>
                <project id="12310904" key="COMPRESS">Commons Compress</project>
                    <description>&lt;p&gt;When reading what some may call a large encrypted 7zip file (1.2TB with 22 million files), the read fails at the header stage with the trace below. Is this within the spec? I&apos;ve written some code to handle it, because I did actually need to extract the file in java. If that&apos;s of any use I can provide it (it&apos;s a naive wrapper that just pages in a buffer at a time).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; java.io.IOException: Cannot handle unpackSize2416988886
at org.apache.commons.compress.archivers.sevenz.SevenZFile.assertFitsIntoInt(SevenZFile.java:1523)
at org.apache.commons.compress.archivers.sevenz.SevenZFile.readEncodedHeader(SevenZFile.java:622)
at org.apache.commons.compress.archivers.sevenz.SevenZFile.initializeArchive(SevenZFile.java:532)
at org.apache.commons.compress.archivers.sevenz.SevenZFile.readHeaders(SevenZFile.java:468)
at org.apache.commons.compress.archivers.sevenz.SevenZFile.&amp;lt;init&amp;gt;(SevenZFile.java:337)
at org.apache.commons.compress.archivers.sevenz.SevenZFile.&amp;lt;init&amp;gt;(SevenZFile.java:129)
at org.apache.commons.compress.archivers.sevenz.SevenZFile.&amp;lt;init&amp;gt;(SevenZFile.java:116)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;7zip itself can also open it (and display/extract etc.), here are the stats:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Size: 2 489 903 580 875
Packed Size: 1 349 110 308 832
Folders: 40 005
Files: 22 073 957
CRC: E26F6A96
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13303721">COMPRESS-514</key>
            <summary>SevenZFile fails with encoded header over 2GiB</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="akelday">A Kelday</reporter>
                        <labels>
                    </labels>
                <created>Fri, 8 May 2020 19:37:27 +0000</created>
                <updated>Fri, 6 May 2022 15:07:26 +0000</updated>
                                            <version>1.20</version>
                                                    <component>Archivers</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="9000">2.5h</timespent>
                                <comments>
                            <comment id="17104168" author="peterlee" created="Mon, 11 May 2020 07:47:45 +0000"  >&lt;p&gt;Unfortunately your 7zip file is too big for Commons Compress to handle.&lt;/p&gt;

&lt;p&gt;The maximum unpack size of the encorded header that Commons Compress can handle is&#160;2,147,483,647 bytes, which is 2GB. In your case, the unpack size 2,416,988,886, which is larger than the data Commons Compress can handle.&lt;/p&gt;

&lt;p&gt;Commons Compress will try to read all the unpack data of encorded header into a byte array, which has a size limit of 2GB.&lt;/p&gt;

&lt;p&gt;Actually it&apos;s a little surprised for me that there are 7zip archives with headers that a larger than 2GB. For most cases, the headers are very small, as they are only the meta data of the compressed info, not the compressed file data.&lt;/p&gt;

&lt;p&gt;I can not provide any good suggestions. Maybe you can try to divide the large 7z archive into 2 small ones(I&apos;m not talking about creating split 7z archive, it&apos;s not helping)?&lt;/p&gt;</comment>
                            <comment id="17104320" author="akelday" created="Mon, 11 May 2020 11:07:52 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=peterlee&quot; class=&quot;user-hover&quot; rel=&quot;peterlee&quot;&gt;peterlee&lt;/a&gt; ,&lt;/p&gt;

&lt;p&gt;There&apos;s no problem for me - as I said above, I patched commons compress to make it work. My question is whether you would expect this to be possible or not (e.g. maybe it&apos;s been decided not to support it).&lt;/p&gt;

&lt;p&gt;If you would prefer to support it then I have code to do so, which I&apos;m happy to share&#160;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;There are however some questions regarding CRC checks if we follow that path...&lt;/p&gt;</comment>
                            <comment id="17104879" author="garydgregory" created="Mon, 11 May 2020 20:21:32 +0000"  >&lt;p&gt;Why don&apos;t we change our code to handle larger entries and also add some configurable limits to avoid zip bombs?&lt;/p&gt;</comment>
                            <comment id="17104904" author="akelday" created="Mon, 11 May 2020 21:01:51 +0000"  >&lt;p&gt;Hi&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt;&#160;,&lt;/p&gt;

&lt;p&gt;Attached now is the main class I patched in (in place of direct ByteBuffer usage). There&apos;s obviously more to it so a diff or PR would make more sense, but I expect you folks will have a nicer solution anyway!&lt;/p&gt;</comment>
                            <comment id="17104920" author="garydgregory" created="Mon, 11 May 2020 21:40:03 +0000"  >&lt;p&gt;A PR is best since it will be tested by the CI system.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17104944" author="akelday" created="Mon, 11 May 2020 22:31:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt;&#160;for what it&apos;s worth, that the PR in.&lt;/p&gt;

&lt;p&gt;Argh, helps if the tests are in the correct location!&lt;/p&gt;

&lt;p&gt;What happens when rushing to get to bed... sorted now. JDK 14 doesn&apos;t appear to build, the rest do.&lt;/p&gt;</comment>
                            <comment id="17104997" author="peterlee" created="Tue, 12 May 2020 01:18:18 +0000"  >&lt;p&gt;&amp;gt;&#160;JDK 14 doesn&apos;t appear to build, the rest do.&lt;/p&gt;

&lt;p&gt;Easy. It&apos;s not your problem. The failure of build in JDK 14 is caused by some other things.&lt;/p&gt;</comment>
                            <comment id="17106270" author="akelday" created="Wed, 13 May 2020 12:49:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt;&#160;I think the current PR fixes this issue without any new problems.&lt;/p&gt;

&lt;p&gt;It sidesteps the problem of the end header being fully in memory for the CRC check (that&apos;s what current master branch does anyway), but should make it easier to tackle that later. I think that ought to be a separate issue. I might have time to work on that myself at some point if nobody else does.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=peterlee&quot; class=&quot;user-hover&quot; rel=&quot;peterlee&quot;&gt;peterlee&lt;/a&gt;&#160;thanks very much for your PR comments so far, it&apos;s been most helpful!&lt;/p&gt;</comment>
                            <comment id="17110652" author="akelday" created="Mon, 18 May 2020 22:16:28 +0000"  >&lt;p&gt;Hi&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=peterlee&quot; class=&quot;user-hover&quot; rel=&quot;peterlee&quot;&gt;peterlee&lt;/a&gt; ,&lt;/p&gt;

&lt;p&gt;As mentioned in the PR the resource close is not handled correctly for encoded headers, so that&apos;s definitely not fit to merge (sorry about that). The main reason is `readEncodedHeader` now returns with an open inputstream.&lt;/p&gt;

&lt;p&gt;A quick fix would be to add `Closeable` for `HeaderBuffer`, but would need to ensure `close()` is called only when an &lt;em&gt;encoded&lt;/em&gt; header was read (otherwise the underlying file channel would be closed!). I&apos;ll go with that plan if nothing else springs to mind.&lt;/p&gt;

&lt;p&gt;If you have better ideas I&apos;d be glad to hear them.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17113466" author="akelday" created="Thu, 21 May 2020 18:52:18 +0000"  >&lt;p&gt;After digging in a bit more this takes me back to the same CRC problem as before, but with some new info after looking at the 7zip source.&lt;/p&gt;

&lt;p&gt;It looks like 7zip does nearly the same as the current Commons Compress; read the whole header buffer into ram and CRC before parsing. The difference is that&apos;s an unsigned int, so maximum 4GiB (above that is unsupported). Indeed 7zip uses over 5GiB ram simply to show the files list of this 1.2TB archive.&lt;/p&gt;

&lt;p&gt;That leads to at least three options:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;7zip method: read all into ram (with multiple buffers up to 4G) for CRC and parse&lt;/li&gt;
	&lt;li&gt;Read the header twice if necessary: once streamed for CRC, the next using a small buffer to parse. If the header fits in our small buffer entirely no extra read is required.&lt;/li&gt;
	&lt;li&gt;Read/parse the header and compute CRC at the same time (bad because you don&apos;t find out the data is wrong until it&apos;s too late)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;It would be great to have some opinion here, because this is more than I&apos;d hoped it would require to fix. There&apos;s always the choice to just not support over 2G...&lt;/p&gt;</comment>
                            <comment id="17114860" author="bodewig" created="Sat, 23 May 2020 16:02:58 +0000"  >&lt;p&gt;There are a few places where the 7z format says a certain value is a UINT64 and we store it inside of a Java long at best. Even if we fix this particular case in some way there will be more problems lurking (that I hope we all catch before they cause ArrayIndexOutOufBoundsExceptions or similar things). Because of this I&apos;d be fine with listing the known limitations.&lt;/p&gt;

&lt;p&gt;If we decide to deal with this specific problem then I&apos;d prefer a solution that doesn&apos;t penalize the normal case too much and doesn&apos;t hide problems we can find early with the existing code. As long as we detect a bad CRC inside of SevenZFile&apos;s constructor, your option 3 sounds reasonable. Nobody would see and use the &quot;bad&quot; data, or am I overlooking something?&lt;/p&gt;</comment>
                            <comment id="17120104" author="peterlee" created="Sat, 30 May 2020 04:05:41 +0000"  >&lt;p&gt;&amp;gt;&#160;&lt;em&gt;There are a few places where the 7z format says a certain value is a UINT64 and we store it inside of a Java long at best. Even if we fix this particular case in some way there will be more problems lurking (that I hope we all catch before they cause ArrayIndexOutOufBoundsExceptions or similar things). Because of this I&apos;d be fine with listing the known limitations.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;I think you are talking about the&#160;&lt;em&gt;assertFitsIntoInt&lt;/em&gt; in SevenZFile(caused we are using arrays and java has a limitation of array length).&lt;/p&gt;

&lt;p&gt;That&apos;s a comlicated problem and I will try to find a solution.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&amp;gt;&#160;&#160;&lt;em&gt;As long as we detect a bad CRC inside of SevenZFile&apos;s constructor, your option 3 sounds reasonable.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;+1 for this. We are doing the similiar thing in&#160;&lt;em&gt;CRC32VerifyingInputStream&lt;/em&gt;. I think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=akelday&quot; class=&quot;user-hover&quot; rel=&quot;akelday&quot;&gt;akelday&lt;/a&gt;&#160;is worried that the result of CRC check can only be known if all the data in&#160;&lt;em&gt;HeaderChannelBuffer&lt;/em&gt;&#160;is exhausted - and it means we have done a lot of work on the corrupted data. But it seems we do not have other options if we are handling a giant amout of data.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;And for this particular issue, I&apos;m not sure if we should merge the PR# 98 or not : for encoded header the PR is OK cause it&apos;s hard to image the header for the encoded header (header of header LOL &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;) is bigger than 16MB, but it may cause some problems for normal header(not encoded) cause we can no longer obtain the CRC if its size is more than 16MB.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure if this is a good idea or not : we could pass the expected CRC to&#160;HeaderChannelBuffer&apos;s constructor and throw exception when the data in&#160;HeaderChannelBuffer is exhausted - acting similiar to the&#160;&lt;em&gt;CRC32VerifyingInputStream.&lt;/em&gt;&lt;/p&gt;</comment>
                            <comment id="17121361" author="akelday" created="Mon, 1 Jun 2020 21:53:56 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bodewig&quot; class=&quot;user-hover&quot; rel=&quot;bodewig&quot;&gt;bodewig&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=peterlee&quot; class=&quot;user-hover&quot; rel=&quot;peterlee&quot;&gt;peterlee&lt;/a&gt;&#160;for the input. Happy to work on it more at some point if you choose an option (I&apos;ll keep thinking about it anyway and do some more checks).&lt;/p&gt;

&lt;p&gt;Peter explained my concern exactly: that in most cases given corrupt data, we could expect an exception other than the one triggered by the CRC check to happen &lt;em&gt;before&lt;/em&gt; the end of stream is ever reached (because we aren&apos;t just transferring data, we&apos;re branching based on it). That&apos;s really a best case, because worse than that is some garbage filename list being created. What I&apos;m very conscious of is making the common use case code worse.&lt;/p&gt;</comment>
                            <comment id="17362915" author="akelday" created="Mon, 14 Jun 2021 12:08:43 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I see there&apos;s a new github comment about rebasing the current (very old) PR. I&apos;ll hopefully have some time to look at this again soon, but I no longer have the &quot;test case&quot; 7zip to work with. It contained 3rd party data which cannot be retained or shared, plus it was over 1TB.&lt;/p&gt;

&lt;p&gt;I&apos;ll attempt to create a smaller test case 7zip which reproduces the original problem, but it could take some time since it probably requires at least 20 million central directory paths.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13441231">COMPRESS-619</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13002655" name="HeaderChannelBuffer.java" size="6252" author="akelday" created="Mon, 11 May 2020 20:59:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 21 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ej3c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>