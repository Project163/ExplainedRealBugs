<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:19:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOGGING-192] NoClassDefFoundError: org/apache/logging/log4j/spi/LoggerAdapter when using custom classloader</title>
                <link>https://issues.apache.org/jira/browse/LOGGING-192</link>
                <project id="12310484" key="LOGGING">Commons Logging</project>
                    <description>&lt;p&gt;If you have:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;A web application running in Tomcat which contains commons-logging:1.2&lt;/li&gt;
	&lt;li&gt;That web application contains a custom classloader for loading a seperately distributed software component (whose dependencies will conflict with the dependencies of the web application).&lt;/li&gt;
	&lt;li&gt;The software component uses commons-logging:1.3.2&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;When the web application attempts use software component, the code &lt;a href=&quot;https://github.com/apache/commons-logging/blob/rel/commons-logging-1.3.2/src/main/java/org/apache/commons/logging/LogFactory.java#L918-L938&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; looks for the presence of different logging implementation classes on the thread context classloader&apos;s (TCCL) classpath to select an optimal implementation.&#160; It seems like what is happening is that the LogFactory class looking for implementation class on the TCCL&apos;s classpath and the trying to load the selected factory from the web application&apos;s custom classloader (the loader for the instance of LogFactory that is running).&#160; This is the result:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; java.lang.NoClassDefFoundError: org/apache/logging/log4j/spi/LoggerAdapter
&#160; &#160; &#160; &#160; at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName0(Native Method)
&#160; &#160; &#160; &#160; at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.java:315)
&#160; &#160; &#160; &#160; at org.apache.commons.logging.LogFactory.createFactory(LogFactory.java:419)
&#160; &#160; &#160; &#160; at org.apache.commons.logging.LogFactory.lambda$newFactory$3(LogFactory.java:1431)
&#160; &#160; &#160; &#160; at java.base/java.security.AccessController.doPrivileged(Native Method)
&#160; &#160; &#160; &#160; at org.apache.commons.logging.LogFactory.newFactory(LogFactory.java:1431)
&#160; &#160; &#160; &#160; at org.apache.commons.logging.LogFactory.getFactory(LogFactory.java:928)
&#160; &#160; &#160; &#160; at org.apache.commons.logging.LogFactory.getLog(LogFactory.java:987)
&#160; &#160; &#160; &#160; at org.component.ClassLoadedComponent.&amp;lt;clinit&amp;gt;(ClassLoadedComponent.java:7)
&#160; &#160; &#160; &#160; at java.base/jdk.internal.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
&#160; &#160; &#160; &#160; at java.base/jdk.internal.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)
&#160; &#160; &#160; &#160; at java.base/jdk.internal.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
&#160; &#160; &#160; &#160; at java.base/java.lang.reflect.Constructor.newInstance(Constructor.java:490)
&#160; &#160; &#160; &#160; at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.newInstance(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.java:584)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This occurs when the web application has commons-logging:1.2 and the software component has commons-logging:1.3.x.&#160; This does not occur when both are using version 1.2.&#160;&lt;/p&gt;

&lt;p&gt;Unfortunately, changing the web application&apos;s version of commons-logging is outside is not something I can influence.&lt;/p&gt;

&lt;p&gt;An isolated reproduction case is attached.&#160; It requires Java 11.&#160; To run it:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Unzip it to a directory.&lt;/li&gt;
	&lt;li&gt;Run&#160;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
./gradlew reproduceIssue&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&#160;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment>&lt;p&gt;This behavior was observed while running Adopt Open JDK 11 and the latest version of Tomcat 9.&#160; The behavior can be reproduced outside of tomcat (see attached reproduction case).&lt;/p&gt;</environment>
        <key id="13580310">LOGGING-192</key>
            <summary>NoClassDefFoundError: org/apache/logging/log4j/spi/LoggerAdapter when using custom classloader</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="misterdorito">Dave Dority</reporter>
                        <labels>
                    </labels>
                <created>Thu, 23 May 2024 20:55:44 +0000</created>
                <updated>Thu, 15 Aug 2024 13:44:14 +0000</updated>
                            <resolved>Thu, 15 Aug 2024 01:07:52 +0000</resolved>
                                    <version>1.3.0</version>
                    <version>1.3.1</version>
                    <version>1.3.2</version>
                                    <fixVersion>1.3.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17849119" author="garydgregory" created="Thu, 23 May 2024 21:01:20 +0000"  >&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pkarwasz&quot; class=&quot;user-hover&quot; rel=&quot;pkarwasz&quot;&gt;pkarwasz&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17873281" author="vampire" created="Tue, 13 Aug 2024 19:11:16 +0000"  >&lt;p&gt;This can also be reproduce relatively simple.&lt;/p&gt;

&lt;p&gt;Open a Gradle Kotlin DSL build script, paste in&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val jasperReportsAnt = configurations.dependencyScope(&lt;span class=&quot;code-quote&quot;&gt;&quot;jasperReportsAnt&quot;&lt;/span&gt;)
val jasperReportsAntRuntimeClasspath = configurations.resolvable(&lt;span class=&quot;code-quote&quot;&gt;&quot;jasperReportsAntRuntimeClasspath&quot;&lt;/span&gt;) {
    extendsFrom(jasperReportsAnt.get())
}
dependencies {
    jasperReportsAnt(&lt;span class=&quot;code-quote&quot;&gt;&quot;net.sf.jasperreports:jasperreports-ant:7.0.0&quot;&lt;/span&gt;)
}
AntBuilder().apply {
    isSaveStreams = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
}.withGroovyBuilder {
    &lt;span class=&quot;code-quote&quot;&gt;&quot;taskdef&quot;&lt;/span&gt;(
        &lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt; to &lt;span class=&quot;code-quote&quot;&gt;&quot;jcr&quot;&lt;/span&gt;,
        &lt;span class=&quot;code-quote&quot;&gt;&quot;classname&quot;&lt;/span&gt; to &lt;span class=&quot;code-quote&quot;&gt;&quot;net.sf.jasperreports.ant.JRAntCompileTask&quot;&lt;/span&gt;,
        &lt;span class=&quot;code-quote&quot;&gt;&quot;classpath&quot;&lt;/span&gt; to jasperReportsAntRuntimeClasspath.get().asPath,
        &lt;span class=&quot;code-quote&quot;&gt;&quot;uri&quot;&lt;/span&gt; to &lt;span class=&quot;code-quote&quot;&gt;&quot;antlib:net.sf.jasperreports.ant&quot;&lt;/span&gt;
    )

    &lt;span class=&quot;code-quote&quot;&gt;&quot;antlib:net.sf.jasperreports.ant:jcr&quot;&lt;/span&gt;(
        &lt;span class=&quot;code-quote&quot;&gt;&quot;srcdir&quot;&lt;/span&gt; to file(&lt;span class=&quot;code-quote&quot;&gt;&quot;.&quot;&lt;/span&gt;),
        &lt;span class=&quot;code-quote&quot;&gt;&quot;includes&quot;&lt;/span&gt; to &lt;span class=&quot;code-quote&quot;&gt;&quot;none&quot;&lt;/span&gt;
    )
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and run any task, it will fail searching for &lt;tt&gt;org.slf4j.MarkerFactory&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Add in front&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
buildscript {
    repositories {
        mavenCentral()
    }
    dependencies {
        classpath(&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.logging.log4j:log4j-api:2.+&quot;&lt;/span&gt;)
    }
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and run any task again, it will fail searching for &lt;tt&gt;org.apache.logging.log4j.spi.LoggerAdapter&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;It does not happen with &lt;tt&gt;ant.withGroovyBuilder { ... }{&lt;/tt&gt;}, but you cannot use that everywhere in Groovy, for example within worker actions where you have to use the standard Groovy &lt;tt&gt;AntBuilder&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The problem is like this (using slf4j as example):&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;tt&gt;LogFactory&lt;/tt&gt; searches on the context classloader for &lt;tt&gt;org.slf4j.Logger&lt;/tt&gt; (in my example the Gradle build script classpath)&lt;/li&gt;
	&lt;li&gt;It finds the class so wants to use its &lt;tt&gt;org.apache.commons.logging.impl.Slf4jLogFactory&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Then it tries to load &lt;tt&gt;Slf4jLogFactory&lt;/tt&gt; from the context classloader but of course does not find it there as &lt;tt&gt;commons-logging&lt;/tt&gt; is not present there&lt;/li&gt;
	&lt;li&gt;Then as fallback tries to load &lt;tt&gt;Slf4jLogFactory&lt;/tt&gt; from the current classloader, which also fails, as there &lt;tt&gt;slf4j&lt;/tt&gt; is not present and so the &lt;tt&gt;Slf4jLogFactory&lt;/tt&gt; class cannot be initialized&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I guess the appropriate solution would be that when going the fallback route of not using the context classloader but the current classloader, that then the detection also has to be redone as the previous result is stale and possibly wrong.&lt;/p&gt;</comment>
                            <comment id="17873282" author="garydgregory" created="Tue, 13 Aug 2024 19:22:33 +0000"  >&lt;p&gt;Is there a way to reproduce this in a PR with a unit test, without Gradle? I personally plan on staying as far away as possible from Gradle.&lt;/p&gt;</comment>
                            <comment id="17873306" author="vampire" created="Tue, 13 Aug 2024 21:45:50 +0000"  >&lt;p&gt;Just as I would not touch Maven with a five-foot pole if I can prevent it. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/biggrin.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Sure, from what I analyzed and wrote it should be simple to reproduce.&lt;br/&gt;
Just have&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;a context class loader with &lt;tt&gt;log4j-api&lt;/tt&gt; or &lt;tt&gt;slf4j-api&lt;/tt&gt; but without &lt;tt&gt;commons-logging&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;a current class loader with &lt;tt&gt;commons-logging&lt;/tt&gt; but without&#160;&lt;tt&gt;log4j-api&lt;/tt&gt; or &lt;tt&gt;slf4j-api&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;then do &lt;tt&gt;org.apache.commons.logging.LogFactory.getLog(&quot;&quot;)&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This should replicate the exact situation and cause the error as &lt;tt&gt;...-api&lt;/tt&gt; will be found on the TCCL,&lt;br/&gt;
while &lt;tt&gt;commons-logging&lt;/tt&gt; will not be found and then will be load from the current class loader but missing the dependency detected on the other class loader.&lt;/p&gt;</comment>
                            <comment id="17873337" author="vampire" created="Tue, 13 Aug 2024 22:04:23 +0000"  >&lt;p&gt;This simple Groovy snippet also reproduces the problem: &lt;a href=&quot;https://groovyconsole.dev/?g=groovy_4_0&amp;amp;codez=eNqlkE9Lw0AQxe_7KXJLFuxAG08BoaLoJSj45xRymG6maUKyEyZbtd_eSSxSBEHswu7ymJn3fsz6XnCgMSlMpGetapPEjvue_bjouK4bX2c_9RJSSGN7cTrDUgMO6HYEx7bpv2yz-V3g0GQrWKWwjK0prWn6gSVELb4hdKjNj5uWXDCmom0UnOuiq8jTe_T6lN90OI45Y0WSFLOALcsD9vR7KuSqSGILg3BQ44b9LffYeHBc0TPvxU0jDqdKCYGvRfCQaFxRZpkmWzuj_IfkuK5vImW5QxdYDufxmJedEFbg9iLkw5dKrDr4QB_hhE6Rpx0avWqK1Vz6O2NNQXUSx_YTnYm8QQ&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;MCVE&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-groovy&quot;&gt;
@Grapes([
    @Grab(&lt;span class=&quot;code-quote&quot;&gt;&apos;commons-logging:commons-logging:1.3.3&apos;&lt;/span&gt;),
    @Grab(&lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.logging.log4j:log4j-api:2.23.1&apos;&lt;/span&gt;)
])
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;

&lt;span class=&quot;code-keyword&quot;&gt;def&lt;/span&gt; tccl = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; URLClassLoader([&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName(&lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.logging.log4j.Logger&apos;&lt;/span&gt;).protectionDomain.codeSource.location].toArray(URL[]::&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;))
&lt;span class=&quot;code-keyword&quot;&gt;def&lt;/span&gt; ccl = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; URLClassLoader([&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName(&lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.commons.logging.LogFactory&apos;&lt;/span&gt;).protectionDomain.codeSource.location].toArray(URL[]::&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;))

&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().contextClassLoader = tccl
ccl.loadClass(&lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.commons.logging.LogFactory&apos;&lt;/span&gt;).getLog(&apos;&apos;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17873351" author="vampire" created="Tue, 13 Aug 2024 23:55:42 +0000"  >&lt;p&gt;Here as patch to the project:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;
diff --git a/pom.xml b/pom.xml
index 9f0a998..c3b092d 100644
--- a/pom.xml
+++ b/pom.xml
@@ -285,6 +285,7 @@ under the License.
                 &amp;lt;log4j12&amp;gt;${org.apache.logging.log4j:log4j-1.2-api:jar}&amp;lt;/log4j12&amp;gt;
                 &amp;lt;logkit&amp;gt;${logkit:logkit:jar}&amp;lt;/logkit&amp;gt;
                 &amp;lt;servlet-api&amp;gt;${javax.servlet:javax.servlet-api:jar}&amp;lt;/servlet-api&amp;gt;
+                &amp;lt;slf4j-api&amp;gt;${org.slf4j:slf4j-api:jar}&amp;lt;/slf4j-api&amp;gt;
                 &amp;lt;commons-logging&amp;gt;target/${project.build.finalName}.jar&amp;lt;/commons-logging&amp;gt;
                 &amp;lt;commons-logging-api&amp;gt;target/${project.build.finalName}-api.jar&amp;lt;/commons-logging-api&amp;gt;
                 &amp;lt;commons-logging-adapters&amp;gt;target/${project.build.finalName}-adapters.jar&amp;lt;/commons-logging-adapters&amp;gt;
diff --git a/src/test/java/org/apache/commons/logging/tccl/logfactory/BadTCCLTestCase.java b/src/test/java/org/apache/commons/logging/tccl/logfactory/BadTCCLTestCase.java
new file mode 100644
index 0000000..6341493
--- /dev/null
+++ b/src/test/java/org/apache/commons/logging/tccl/logfactory/BadTCCLTestCase.java
@@ -0,0 +1,113 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the &quot;License&quot;); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.commons.logging.tccl.logfactory;
+
+import junit.framework.Test;
+import junit.framework.TestCase;
+import org.apache.commons.logging.LogFactory;
+import org.apache.commons.logging.PathableClassLoader;
+import org.apache.commons.logging.PathableTestSuite;
+
+/**
+ * Verify that if a log framework was detected on tccl but commons-logging cannot be loaded from it
+ * detection happens again on the current class loader before trying to load commons-logging.
+ */
+
+public class BadTCCLTestCase extends TestCase {
+
+    /**
+     * Return the tests included in this test suite.
+     */
+    public static Test suite() throws Exception {
+        final Class thisClass = BadTCCLTestCase.class;
+
+        final PathableClassLoader emptyLoader = new PathableClassLoader(null);
+
+        final PathableClassLoader parentLoader = new PathableClassLoader(emptyLoader);
+        parentLoader.useExplicitLoader(&quot;junit.&quot;, Test.class.getClassLoader());
+        parentLoader.addLogicalLib(&quot;commons-logging&quot;);
+        parentLoader.addLogicalLib(&quot;testclasses&quot;);
+
+        final PathableClassLoader tccl = new PathableClassLoader(emptyLoader);
+        tccl.addLogicalLib(&quot;slf4j-api&quot;);
+
+        final Class testClass = parentLoader.loadClass(thisClass.getName());
+        return new PathableTestSuite(testClass, tccl);
+    }
+
+    /**
+     * Sets up instance variables required by this test case.
+     */
+    @Override
+    public void setUp() throws Exception {
+        LogFactory.releaseAll();
+    }
+
+    /**
+     * Tear down instance variables required by this test case.
+     */
+    @Override
+    public void tearDown() {
+        LogFactory.releaseAll();
+    }
+
+    public void testLoader() throws Exception {
+
+        final ClassLoader thisClassLoader = this.getClass().getClassLoader();
+        final ClassLoader tccl = Thread.currentThread().getContextClassLoader();
+
+        // the tccl should NOT be the same as the loader that loaded this test class.
+        assertNotSame(&quot;tccl is the same as test class loader&quot;, thisClassLoader, tccl);
+
+        // org.slf4j.Logger should not be loadable via this loader
+        try {
+            thisClassLoader.loadClass(&quot;org.slf4j.Logger&quot;);
+            fail(&quot;Unexpectedly able to load org.slf4j.Logger via test class loader&quot;);
+        } catch (final ClassNotFoundException ex) {
+            // ok, expected
+        }
+
+        // org.slf4j.Logger should be loadable via tccl
+        try {
+            final Class clazz = tccl.loadClass(&quot;org.slf4j.Logger&quot;);
+            assertNotNull(clazz);
+        } catch (final ClassNotFoundException ex) {
+            fail(&quot;Unexpectedly unable to load org.slf4j.Logger via tccl&quot;);
+        }
+
+        // org.apache.commons.logging.Log should not be loadable via tccl
+        try {
+            tccl.loadClass(&quot;org.apache.commons.logging.Log&quot;);
+            fail(&quot;Unexpectedly able to load org.apache.commons.logging.Log via tccl&quot;);
+        } catch (final ClassNotFoundException ex) {
+            // ok, expected
+        }
+
+        // org.apache.commons.logging.Log should be loadable via this loader
+        try {
+            final Class clazz = thisClassLoader.loadClass(&quot;org.apache.commons.logging.Log&quot;);
+            assertNotNull(clazz);
+        } catch (final ClassNotFoundException ex) {
+            fail(&quot;Unexpectedly unable to load org.apache.commons.logging.Log via test class loader&quot;);
+        }
+
+        // getting a Logger from this loader should not throw an exception
+        final Class clazz = thisClassLoader.loadClass(&quot;org.apache.commons.logging.LogFactory&quot;);
+        clazz.getMethod(&quot;getLog&quot;, String.class).invoke(null, &quot;&quot;);
+    }
+}
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17873526" author="garydgregory" created="Wed, 14 Aug 2024 13:18:30 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vampire&quot; class=&quot;user-hover&quot; rel=&quot;vampire&quot;&gt;vampire&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thank you for the patch! We&apos;ll take a look over the next day or so.&lt;/p&gt;</comment>
                            <comment id="17873545" author="pkarwasz" created="Wed, 14 Aug 2024 13:57:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vampire&quot; class=&quot;user-hover&quot; rel=&quot;vampire&quot;&gt;vampire&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Let&apos;s call the two classloaders &lt;em&gt;custom&lt;/em&gt; and &lt;em&gt;web&lt;/em&gt; for simplicity. What is happening is:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The &lt;tt&gt;LogFactory&lt;/tt&gt; class from &lt;em&gt;custom&lt;/em&gt; looks for Log4j API.&lt;/li&gt;
	&lt;li&gt;Log4j API is available in &lt;em&gt;web&lt;/em&gt;.&lt;/li&gt;
	&lt;li&gt;The &lt;tt&gt;LogFactory&lt;/tt&gt; tries to instantiate &lt;tt&gt;Log4jApiLogFactory&lt;/tt&gt; from &lt;em&gt;web&lt;/em&gt; and fails (no such class).&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;LogFactory.newFactory&lt;/tt&gt; falls back to instantiating &lt;tt&gt;Log4jApiLogFactory&lt;/tt&gt; from &lt;em&gt;custom&lt;/em&gt; and fails (missing Log4j API).&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The fallback breaks the selection logic and prevents &lt;tt&gt;LogFactory&lt;/tt&gt; from trying alternative factory implementations.&lt;/p&gt;

&lt;p&gt;Before fixing it, we should probably decide what the selection logic should be: we have 3 &lt;tt&gt;LogFactory&lt;/tt&gt; (Log4j API, SLF4J and Legacy) implementations that we can try loading from 2 different classloaders (TCCL and the one that loaded &lt;tt&gt;LogFactory&lt;/tt&gt;). What should be the correct selection order:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Should try to load all 3 implementation from the TCCL and only if it fails try the other classloader?&lt;/li&gt;
	&lt;li&gt;Should we first try Log4j API from both classloaders, then SLF4J from both classloaders and finally the Legacy implementation?&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The first option makes more sense, since it allows a single &lt;tt&gt;commons-logging&lt;/tt&gt; copy to drive different logging backends for different web applications (that is assuming each web app bundles &lt;tt&gt;commons-logging-adapters&lt;/tt&gt; instead of the whole library).&lt;/p&gt;</comment>
                            <comment id="17873554" author="garydgregory" created="Wed, 14 Aug 2024 14:16:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pkarwasz&quot; class=&quot;user-hover&quot; rel=&quot;pkarwasz&quot;&gt;pkarwasz&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I like option 1 as well, it feels simpler: &quot;try one class loader at a time&quot;.&lt;/p&gt;</comment>
                            <comment id="17873567" author="vampire" created="Wed, 14 Aug 2024 14:35:04 +0000"  >&lt;blockquote&gt;&lt;p&gt;What is happening is:&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Exactly, as I already wrote above, together with a solution suggestion. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The question is whether your option 1 makes sense.&lt;br/&gt;
Wouldn&apos;t it then be:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;log4j is detected on web&lt;/li&gt;
	&lt;li&gt;log4j log factory fails to load on web as commons-logging is missing&lt;/li&gt;
	&lt;li&gt;slf4j is detected on web&lt;/li&gt;
	&lt;li&gt;slf4j log factory fails to load on web as commons-logging is missing&lt;/li&gt;
	&lt;li&gt;legacy log factory fails to load on web as commons-logging is missing&lt;/li&gt;
	&lt;li&gt;slf4j is detected on custom&lt;/li&gt;
	&lt;li&gt;slf4j log factory is loaded on custom&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Unless there are situations where the log4j log factory cannot be loaded on web,&lt;br/&gt;
but one of the others can be loaded on web, i.e. it does not fail because commons-logging is missing,&lt;br/&gt;
I&apos;d say it is just wasted time and should be&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;log4j is detected on web&lt;/li&gt;
	&lt;li&gt;log4j log factory fails to load on web as commons-logging is missing&lt;/li&gt;
	&lt;li&gt;slf4j is detected on custom&lt;/li&gt;
	&lt;li&gt;slf4j log factory is loaded on custom&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17873587" author="pkarwasz" created="Wed, 14 Aug 2024 15:13:47 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Unless there are situations where the log4j log factory cannot be loaded on web,&lt;br/&gt;
but one of the others can be loaded on web, i.e. it does not fail because commons-logging is missing,&lt;br/&gt;
I&apos;d say it is just wasted time and should be&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good point if &lt;tt&gt;LogFactory.class&lt;/tt&gt; in &lt;em&gt;web&lt;/em&gt; is not the same class as &lt;tt&gt;LogFactory.class&lt;/tt&gt; in &lt;em&gt;custom&lt;/em&gt;, there is no point to use the TCCL at all.&lt;br/&gt;
However if the classes are equal, I would check all factories in &lt;em&gt;web&lt;/em&gt; and then in &lt;em&gt;custom&lt;/em&gt;. The legacy factory basically can never fail (it will almost always detect at least JUL), so in your case this procedure will use JUL instead of the SLF4J implementation. I think this should be OK, since there is a system property to disable the use of TCCL.&lt;/p&gt;</comment>
                            <comment id="17873595" author="vampire" created="Wed, 14 Aug 2024 15:27:08 +0000"  >&lt;p&gt;It would not use JUL in my case, because the reason factory loading fails is because commons-logging is not present on web.&lt;br/&gt;
So the legacy will also not work, because it is not present.&lt;/p&gt;



&lt;p&gt;If commons-logging would be present on web it would use log4j, as the loading would have worked.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Actually, thinking about it, maybe the procedure could be simplified to:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;is commons-logging found on web use web, otherwise use custom&lt;/li&gt;
	&lt;li&gt;detect only on the one from step above&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Again, given that the only reason it would fail after successful detection is, that commons-logging is not present on web.&lt;br/&gt;
If factory loading could fail due to some other legit reason where the logic should go on, it might be different.&lt;br/&gt;
But this check for whether commons-logging is present on the tccl would probably also be much easier to add.&lt;/p&gt;</comment>
                            <comment id="17873629" author="vampire" created="Wed, 14 Aug 2024 16:55:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/commons-logging/pull/280&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-logging/pull/280&lt;/a&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17873638" author="vampire" created="Wed, 14 Aug 2024 17:05:31 +0000"  >&lt;p&gt;Of course you can do additional logic changes, but that should at least fix the problem at hand.&lt;/p&gt;</comment>
                            <comment id="17873760" author="garydgregory" created="Thu, 15 Aug 2024 01:09:38 +0000"  >&lt;p&gt;PR &lt;a href=&quot;https://github.com/apache/commons-logging/pull/281&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-logging/pull/281&lt;/a&gt; has been merged.&lt;/p&gt;

&lt;p&gt;TY &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pkarwasz&quot; class=&quot;user-hover&quot; rel=&quot;pkarwasz&quot;&gt;pkarwasz&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vampire&quot; class=&quot;user-hover&quot; rel=&quot;vampire&quot;&gt;vampire&lt;/a&gt;, Please verify your use case with the git master branch or a snapshot build from &lt;a href=&quot;https://repository.apache.org/content/repositories/snapshots/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/repositories/snapshots/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;TY All!&lt;/p&gt;</comment>
                            <comment id="17873944" author="vampire" created="Thu, 15 Aug 2024 13:03:55 +0000"  >&lt;p&gt;Thanks for the quick handling.&lt;br/&gt;
I verified that with &lt;tt&gt;1.3.3&lt;/tt&gt; it fails and just changing to &lt;tt&gt;1.3.4-SNAPSHOT&lt;/tt&gt; made it working.&lt;/p&gt;</comment>
                            <comment id="17873960" author="garydgregory" created="Thu, 15 Aug 2024 13:44:14 +0000"  >&lt;p&gt;OK, great. You can expect a release candidate this week.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13069064" name="commons-logging-classloading-issue.zip" size="351262" author="misterdorito" created="Thu, 23 May 2024 20:04:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10431"><![CDATA[Important]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12314421" key="com.atlassian.jira.plugin.system.customfieldtypes:labels">
                        <customfieldname>Language</customfieldname>
                        <customfieldvalues>
                                        <label>Java</label>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 12 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1pee0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>