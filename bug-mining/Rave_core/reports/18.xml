<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:25:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[RAVE-845] Cannot delete a user which has one or more friend associations</title>
                <link>https://issues.apache.org/jira/browse/RAVE-845</link>
                <project id="12311290" key="RAVE">Rave</project>
                    <description>&lt;p&gt;As reported  on the dev@ list:&lt;/p&gt;

&lt;p&gt;On 11/05/2012 02:20 PM, Franklin, Matthew B. wrote:&lt;br/&gt;
&amp;gt; I went through the release and everything looks good except that I can&apos;t&lt;br/&gt;
&amp;gt; seem to delete users.  I get the following exception with the demo binary&lt;br/&gt;
&amp;gt; as well as the built source:&lt;br/&gt;
&amp;gt; &lt;br/&gt;
&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;WARNING&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;talledLocalContainer&amp;#93;&lt;/span&gt; SEVERE: Servlet.service() for servlet&lt;br/&gt;
&amp;gt; dispatcher threw exception&lt;br/&gt;
&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;WARNING&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;talledLocalContainer&amp;#93;&lt;/span&gt;&lt;br/&gt;
&amp;gt; org.apache.rave.persistence.impl.TranslatedH2Exception: Unknown Database&lt;br/&gt;
&amp;gt; Error&lt;br/&gt;
&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;WARNING&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;talledLocalContainer&amp;#93;&lt;/span&gt; 	at&lt;br/&gt;
&amp;gt; org.apache.rave.persistence.jpa.impl.H2OpenJpaDialect.translateExceptionIfP&lt;br/&gt;
&amp;gt; ossible(H2OpenJpaDialect.java:60)&lt;br/&gt;
&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;WARNING&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;talledLocalContainer&amp;#93;&lt;/span&gt; 	at&lt;br/&gt;
&amp;gt; org.springframework.orm.jpa.JpaTransactionManager.doCommit(JpaTransactionMa&lt;br/&gt;
&amp;gt; nager.java:516)&lt;br/&gt;
&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;WARNING&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;talledLocalContainer&amp;#93;&lt;/span&gt; 	at&lt;br/&gt;
&amp;gt; org.springframework.transaction.support.AbstractPlatformTransactionManager.&lt;br/&gt;
&amp;gt; processCommit(AbstractPlatformTransactionManager.java:754)&lt;br/&gt;
&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;WARNING&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;talledLocalContainer&amp;#93;&lt;/span&gt; 	at&lt;br/&gt;
&amp;gt; org.springframework.transaction.support.AbstractPlatformTransactionManager.&lt;br/&gt;
&amp;gt; commit(AbstractPlatformTransactionManager.java:723)&lt;br/&gt;
&amp;gt; &lt;/p&gt;

&lt;p&gt;Followed up by:&lt;/p&gt;

&lt;p&gt;On 11/05/2012 04:47 PM, Franklin, Matthew B. wrote:&lt;br/&gt;
&amp;gt; I confirmed that I was working with a clean database and dug a little&lt;br/&gt;
&amp;gt; deeper to find that it only occurs when you are deleting a user that has&lt;br/&gt;
&amp;gt; one or more associations.  The exact exception is as follows:&lt;br/&gt;
&amp;gt; &lt;br/&gt;
&amp;gt; Referential integrity constraint violation: &quot;CONSTRAINT_43:&lt;br/&gt;
&amp;gt; PUBLIC.PERSON_ASSOCIATION FOREIGN KEY(FOLLOWEDBY_ID) REFERENCES&lt;br/&gt;
&amp;gt; PUBLIC.PERSON(ENTITY_ID) (3)&quot;; SQL statement:&lt;br/&gt;
&amp;gt; DELETE FROM person WHERE entity_id = ? &lt;span class=&quot;error&quot;&gt;&amp;#91;23503-167&amp;#93;&lt;/span&gt; &lt;/p&gt;
{prepstmnt 1230081703
&amp;gt; DELETE FROM person WHERE entity_id = ? [params=?]}
&lt;p&gt; [code=23503,&lt;br/&gt;
&amp;gt; state=23503]&lt;br/&gt;
&amp;gt; &lt;/p&gt;

&lt;p&gt;and:&lt;/p&gt;

&lt;p&gt;On 11/05/2012 04:57 PM, Chris Geer wrote:&lt;br/&gt;
&amp;gt; Ok, this probably makes sense. Since we did the model split, I bet JPA no&lt;br/&gt;
&amp;gt; longer enforces referential integrity. We probably need to add in business&lt;br/&gt;
&amp;gt; level checks for related entities.&lt;/p&gt;

&lt;p&gt;and: &lt;/p&gt;

&lt;p&gt;On 11/05/2012 05:09 PM, Ate Douma wrote:&lt;br/&gt;
&amp;gt; Confirmed. I just tried this with a mysql database and hit the same error.&lt;br/&gt;
&amp;gt; &lt;br/&gt;
&amp;gt; As Chris mentioned on his rely, most likely the referential integrity no longer &lt;br/&gt;
&amp;gt; is &apos;managed&apos; through JPA after the model split. Which means this might not be &lt;br/&gt;
&amp;gt; the only case behavior is broken.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12614855">RAVE-845</key>
            <summary>Cannot delete a user which has one or more friend associations</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="viknesb">Viknes Balasubramanee</assignee>
                                    <reporter username="ate">Ate Douma</reporter>
                        <labels>
                    </labels>
                <created>Mon, 5 Nov 2012 21:36:20 +0000</created>
                <updated>Thu, 14 Feb 2013 13:35:59 +0000</updated>
                            <resolved>Mon, 26 Nov 2012 20:55:09 +0000</resolved>
                                    <version>0.18</version>
                                    <fixVersion>0.18</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13491126" author="geerzo" created="Tue, 6 Nov 2012 02:16:38 +0000"  >&lt;p&gt;I finally got some time to look into this and there is some good news and bad news...&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Bad News: This same problem exists in 0.16, it&apos;s not new to 0.17 and model-split&lt;/li&gt;
	&lt;li&gt;Good News: If it wasn&apos;t caused by model-split the risk of have the same issue in lots of other places is more limited but we&apos;ll still test in another ticket.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I believe this is caused because there is a relationship from JpaPersonAssociation -&amp;gt; JpaPerson but not the other way. In User Service we should check for any associations and delete them. Right now there is no way in the repositories to delete all known associations, only loop through the existing friends and remove one-by-one.&lt;/p&gt;</comment>
                            <comment id="13491184" author="viknesb" created="Tue, 6 Nov 2012 03:39:06 +0000"  >&lt;p&gt;As a quick solution to this problem, I guess we could write the following query to find the associations of a particular user by username and delete all the JpaPersonAssociations while deleting a particular JpaPerson. &lt;br/&gt;
&quot;select a from JpaPersonAssociation a where a.follower.username = :username or a.followedby.username = :username&quot;.&lt;br/&gt;
A long term solution would be to find a way to add a meaningful 2 way association between JpaPersonAssociation and JpaPerson and delete it through JPA cascade delete.&lt;/p&gt;</comment>
                            <comment id="13492548" author="viknesb" created="Wed, 7 Nov 2012 18:00:21 +0000"  >&lt;p&gt;I spent some more time looking into this and I think we are in a position to use only queries to delete the associations.&lt;br/&gt;
The reason is&lt;br/&gt;
1) If we have a field called &apos;friends&apos; in JpaPerson that maps to the items in JpaPersonAssociation, it would not make much sense when we do a person.getFriends() because whether a particular user is friend or not is defined by the status of the association and there is now way to specify it when we are joining tables using annotations.&lt;br/&gt;
And yet one more problem would be, when a friend relationship is established, we insert 2 rows into JpaPersonAssociation. One is from A to B and other is from B to A. Having a single field of JpaPerson associated to a column in JpaPersonAssociation would remove the A to B record but not the B to A one(which is again a problem). &lt;br/&gt;
2) Other thing that can be done is having 2 new fields called &apos;followerOf&apos; and &apos;followedBy&apos; in JpaPerson which would map to each of the columns in JpaPersonAssociation, and then when a person is deleted, the corresponding association would be deleted. But the downside is, we dont have the concept of followerof or followedby anywhere in Rave and this would just add more confusion.&lt;/p&gt;

&lt;p&gt;So the only way that seems plausible to me is using a query to delete the associations when a user is deleted. If no one has any problem with it, i can go ahead and do it.&lt;/p&gt;</comment>
                            <comment id="13492564" author="geerzo" created="Wed, 7 Nov 2012 18:13:25 +0000"  >&lt;p&gt;Sounds reasonable to me. I think this is better than the JPA relationship from Person unless we can get lazy loading working, otherwise it would require loading a lot of data.&lt;/p&gt;</comment>
                            <comment id="13494514" author="viknesb" created="Sat, 10 Nov 2012 01:58:30 +0000"  >&lt;p&gt;Attached patch. Checked on both H2 and MySQL DB by deleting john.doe user.&lt;/p&gt;</comment>
                            <comment id="13504079" author="geerzo" created="Mon, 26 Nov 2012 20:55:09 +0000"  >&lt;p&gt;Committed revision 1413830 - Thanks Viknes&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12552950" name="Rave-845.patch" size="10000" author="viknesb" created="Sat, 10 Nov 2012 01:58:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>255352</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 51 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0er8n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>84175</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>