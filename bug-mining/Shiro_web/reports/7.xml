<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:35:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SHIRO-159] ThreadLocal is not cleared upon the unloading of the webapp and the SHiro Servlet</title>
                <link>https://issues.apache.org/jira/browse/SHIRO-159</link>
                <project id="12310950" key="SHIRO">Shiro</project>
                    <description>&lt;p&gt;Tomcat 6.0.26 reports a severe error when unloading a web app that uses org.apache.shiro.web.servlet.IniShiroFilter&lt;/p&gt;

&lt;p&gt;SEVERE: A web application created a ThreadLocal with key of type &lt;span class=&quot;error&quot;&gt;&amp;#91;null&amp;#93;&lt;/span&gt; (value &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.shiro.util.ThreadContext$1@c0c66a&amp;#93;&lt;/span&gt;) and a value of type &lt;span class=&quot;error&quot;&gt;&amp;#91;java.util.HashMap&amp;#93;&lt;/span&gt; (value &lt;span class=&quot;error&quot;&gt;&amp;#91;{}&amp;#93;&lt;/span&gt;) but failed to remove it when the web application was stopped. To prevent a memory leak, the ThreadLocal has been forcibly removed.&lt;br/&gt;
May 13, 2010 9:29:51 PM org.apache.catalina.loader.WebappClassLoader clearThreadLocalMap&lt;/p&gt;</description>
                <environment>&amp;nbsp;Model Name:	MacBook Pro&lt;br/&gt;
&amp;nbsp;&amp;nbsp;Model Identifier:	MacBookPro5,1&lt;br/&gt;
&amp;nbsp;&amp;nbsp;Processor Name:	Intel Core 2 Duo&lt;br/&gt;
&amp;nbsp;&amp;nbsp;Processor Speed:	2.8 GHz&lt;br/&gt;
&amp;nbsp;&amp;nbsp;Number Of Processors:	1&lt;br/&gt;
&amp;nbsp;&amp;nbsp;Total Number Of Cores:	2&lt;br/&gt;
&amp;nbsp;&amp;nbsp;L2 Cache:	6 MB&lt;br/&gt;
&amp;nbsp;&amp;nbsp;Memory:	4 GB&lt;br/&gt;
&amp;nbsp;&amp;nbsp;Bus Speed:	1.07 GHz&lt;br/&gt;
&amp;nbsp;System Version:	Mac OS X 10.6.3 (10D573)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;Kernel Version:	Darwin 10.3.0&lt;br/&gt;
&amp;nbsp;</environment>
        <key id="12464499">SHIRO-159</key>
            <summary>ThreadLocal is not cleared upon the unloading of the webapp and the SHiro Servlet</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lhazlewood">Les Hazlewood</assignee>
                                    <reporter username="berryware">david e. berry</reporter>
                        <labels>
                            <label>threadlocal</label>
                    </labels>
                <created>Fri, 14 May 2010 01:55:08 +0000</created>
                <updated>Wed, 30 Apr 2014 14:06:48 +0000</updated>
                            <resolved>Fri, 14 May 2010 19:05:32 +0000</resolved>
                                    <version>1.0.0</version>
                                    <fixVersion>1.0.0</fixVersion>
                                    <component>Integration: JEE</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12867357" author="kaosko" created="Fri, 14 May 2010 02:03:48 +0000"  >&lt;p&gt;Initially scheduling this to be fixed for 1.0.0 though I&apos;m not sure how to clean ThreadLocals consistently in all environments. We could probably implement a contextListener but it&apos;d likely have to be user&apos;s responsibility to make sure its configured.&lt;/p&gt;</comment>
                            <comment id="12867367" author="lhazlewood" created="Fri, 14 May 2010 03:06:01 +0000"  >&lt;p&gt;I just committed a minor change to the AbstractShiroFilter.doFilterInternal method.  The thread binding of a Subject now occurs inside the try/catch block (it existed just outside of it previously).&lt;/p&gt;

&lt;p&gt;This guarantees that the ThreadContext will be cleared for every request thread that executes the filter no matter where a failure might occur.&lt;/p&gt;

&lt;p&gt;The only other way that this could be happening that I know of is if SecurityUtils.getSubject() is being called outside of a request thread.  The getSubject() call was changed recently to bind an automatically-created Subject to the ThreadContext.  This is the only other thing I can think of that would bind to a thread.  If it is not getSubject(), it must be user initiated.&lt;/p&gt;</comment>
                            <comment id="12867386" author="kaosko" created="Fri, 14 May 2010 04:19:46 +0000"  >&lt;p&gt;I was thinking exactly of those other cases... but should we just leave it at that with your fix, close this issue and claim anything else is users&apos; responsibility?&lt;/p&gt;</comment>
                            <comment id="12867395" author="lhazlewood" created="Fri, 14 May 2010 05:04:19 +0000"  >&lt;p&gt;I&apos;m not sure of what to do about the getSubject() call - all the other areas in the framework are covered from a responsibility perspective I think:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The AbstractShiroFilter binds and unbinds for an incoming request&lt;/li&gt;
	&lt;li&gt;The Spring RemoteInvocationExecutor binds and unbinds for an incoming remote method invocation&lt;/li&gt;
	&lt;li&gt;The Executor/ExecutorService/ScheduledExecutorService implementations bind/unbind for async/&apos;other thread&apos; execution.&lt;/li&gt;
	&lt;li&gt;Subject.associateWith* guarantees cleanup&lt;/li&gt;
	&lt;li&gt;Subject.execute* guarantees cleanup&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The getSubject() auto-creation is the only area where we can&apos;t guarantee cleanup.  But the idea is if you call that method in the course of execution with any of the above 5 mechanisms, then everything should be ok.  I don&apos;t know of any other way to guarantee cleanup.  Even a ContextListener probably wouldn&apos;t do the job - you&apos;d only be able to clear the thread that calls the listener - not any of the other threads that are in the request thread pool.&lt;/p&gt;</comment>
                            <comment id="12867402" author="kaosko" created="Fri, 14 May 2010 05:28:52 +0000"  >&lt;p&gt;Yeah, it gets complicated quickly if we want to do anything more. I&apos;d say close for now and we&apos;ll enhance later if somebody comes up with a decent proposal.&lt;/p&gt;</comment>
                            <comment id="12867426" author="lhazlewood" created="Fri, 14 May 2010 06:43:50 +0000"  >&lt;p&gt;Recent changes to AbstractShiroFilter are committed to guarantee thread clean-up in a filtered request environment.&lt;/p&gt;

&lt;p&gt;Note that using Shiro APIs in web app during requests that are NOT filtered by the ShiroFilter will cause the problem message shown by Tomcat.  Please ensure that all requests that will use the Shiro APIs are filtered by the ShiroFilter properly.&lt;/p&gt;</comment>
                            <comment id="12867470" author="berryware" created="Fri, 14 May 2010 10:44:30 +0000"  >&lt;p&gt;Thanks for all the immediate attention to this. I will do a build and let you know what I find. I use getSubject all over the place, but they should all as a part of a web request.&lt;/p&gt;

&lt;p&gt;Some Comments:&lt;/p&gt;

&lt;p&gt;In looking through the code, you unbind, by emptying the values out of the HashMap that you have stored as a ThreadLocal variable. &lt;/p&gt;

&lt;p&gt;I could not find where you actually remove the HashMap from the ThreadLocal with a call to resources.remove().&lt;/p&gt;

&lt;p&gt;The messages I posted from Tomcat is complaining about the HashMap that is stored in ThreadLocal:&lt;/p&gt;

&lt;p&gt;SEVERE: A web application created a ThreadLocal with key of type &lt;span class=&quot;error&quot;&gt;&amp;#91;null&amp;#93;&lt;/span&gt; (value &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.shiro.util.ThreadContext$1@c0c66a&amp;#93;&lt;/span&gt;) and a value of type &lt;span class=&quot;error&quot;&gt;&amp;#91;java.util.HashMap&amp;#93;&lt;/span&gt; (value &lt;span class=&quot;error&quot;&gt;&amp;#91;{}&amp;#93;&lt;/span&gt;) but failed to remove it when the web application was stopped. To prevent a memory leak, the ThreadLocal has been forcibly removed. &lt;/p&gt;

&lt;p&gt;Perhaps there should be a release method on ThreadContext like this:&lt;/p&gt;

&lt;p&gt;    public static void release() &lt;/p&gt;
{
			// clear the map
                        resources.get().clear();
			// clear the ThreadLocal()
			resources.remove();
			// clear the reference to the ThreadLocal
			resources=null;
    }

&lt;p&gt;and then call it in AbstractFilter.destroy()&lt;/p&gt;

&lt;p&gt;    public void destroy() &lt;/p&gt;
{
			ThreadContext.release();
    }

&lt;p&gt;I am going to test your changes first. If that does not clear it up I will give the above a try as well.&lt;/p&gt;</comment>
                            <comment id="12867598" author="lhazlewood" created="Fri, 14 May 2010 17:54:46 +0000"  >&lt;p&gt;Hi David,&lt;/p&gt;

&lt;p&gt;This helps me understand what you were talking about - thanks! (Things weren&apos;t as clear at 2am &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;)  &lt;/p&gt;

&lt;p&gt;Yes, we should probably definitely be removing the ThreadLocal entirely.  I&apos;ll make those changes as soon as I can.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Les&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12867639" author="lhazlewood" created="Fri, 14 May 2010 19:05:32 +0000"  >&lt;p&gt;Updated ThreadContext and ThreadState implementations to use remove() in all cases.  Everything should be good now (with the same caveat that SecurityUtils.getSubject() must still be called downstream from some other Shiro component that does the thread binding/cleanup).  All tests, sample apps, etc. pass.&lt;/p&gt;</comment>
                            <comment id="12878094" author="lhazlewood" created="Fri, 11 Jun 2010 22:01:07 +0000"  >&lt;p&gt;Closing all resolved issues due to a successful 1.0.0-incubating release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12711468">SHIRO-498</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>174890</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 24 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i106x3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>209255</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>