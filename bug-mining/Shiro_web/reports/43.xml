<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:35:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SHIRO-646] Unable to login a DelegatingSubject on a DefaultWebSecurityManager</title>
                <link>https://issues.apache.org/jira/browse/SHIRO-646</link>
                <project id="12310950" key="SHIRO">Shiro</project>
                    <description>&lt;p&gt;When&#160;programatically creating a&#160;DefaultWebSecurityManager, it is not possible to login a DelegatingSubject, for example built through Subject.Builder.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Pull request:&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SHIRO-646&quot; title=&quot;Unable to login a DelegatingSubject on a DefaultWebSecurityManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SHIRO-646&quot;&gt;&lt;del&gt;SHIRO-646&lt;/del&gt;&lt;/a&gt; Allow a DelegatingSubject to login Statelessly on a DefaultWebSecurityManager&#160;#82&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The problem is twofold.&lt;/p&gt;

&lt;p&gt;First, in&#160;DefaultWebSecurityManager, no SessionManager is set for the&#160;DefaultWebSessionStorageEvaluator unless the DefaultSubjectDAO is set through the&#160;DefaultWebSecurityManager.setSubjectDAO method. The&#160;DefaultSubjectDAO and&#160;DefaultWebSessionStorageEvaluator set in the noargs constructor in&#160;DefaultWebSecurityManager does not set a SessionManager for the&#160;DefaultWebSessionStorageEvaluator. The null SessionManager&#160;means that the&#160;DefaultWebSessionStorageEvaluator will always decide to create a Session for the DelegatingSubject, which will fail due to it not having a&#160; a HTTP compatible session. The error occurs in&#160;ServletContainerSessionManager here:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;protected Session createSession(SessionContext sessionContext) throws AuthorizationException {&lt;br/&gt;
 if (!WebUtils.isHttp(sessionContext))&lt;/p&gt;

{ String msg = &quot;SessionContext must be an HTTP compatible implementation.&quot;; throw new IllegalArgumentException(msg); }&lt;br/&gt;
&lt;br/&gt;
&#160;&lt;br/&gt;
&lt;br/&gt;
Second, The&#160;DefaultWebSubjectFactory will ALWAYS create a&#160;WebDelegatingSubject when logging in a Subject, no matter if the Subject was, for example a Delegating Subject to begin with.&lt;br/&gt;
&lt;br/&gt;
The order of events is a follows:&lt;br/&gt;
 DelegatingSubject is created through Subject.Builder.&lt;br/&gt;
&lt;br/&gt;
DelegatingSubject.login(AuthToken) is called.&lt;br/&gt;
&lt;br/&gt;
DefaultSecurityManager.login(Subject, AuthenticationToken) is called which in turn calls&#160;createSubject(AuthenticationToken, AuthenticationInfo, Subject).&lt;br/&gt;
&lt;br/&gt;
Since we are using a DefaultWebSecurityManager,&#160;createSubjectContext() returns a&#160;DefaultWebSubjectContext.&lt;br/&gt;
&lt;br/&gt;
When&#160;DefaultWebSubjectFactory is then called on to create a new Subject, it recieves a DefaultWebSubjectContext even though the DelegatingSubject was the caller.&lt;br/&gt;
&lt;br/&gt;
That means that a&#160;WebDelegatingSubject is created with a null&#160;ServletRequest and&#160;ServletResponse.&lt;br/&gt;
&lt;br/&gt;
That fails when again in the&#160;ServletContainerSessionManager here (The same place as before):&lt;br/&gt;
&lt;br/&gt;
&#160;&lt;br/&gt;
&lt;br/&gt;
protected Session createSession(SessionContext sessionContext) throws AuthorizationException {&lt;br/&gt;
 if (!WebUtils.isHttp(sessionContext))&lt;br/&gt;
{ String msg = &quot;SessionContext must be an HTTP compatible implementation.&quot;; throw new IllegalArgumentException(msg); }

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The fix is twofold:&lt;/p&gt;

&lt;p&gt;Change the noargs constructor in&#160;DefaultWebSecurityManager so the&#160;DefaultWebSessionStorageEvaluator has a SessionManager set.&lt;/p&gt;

&lt;p&gt;Introduce a check in&#160;DefaultWebSubjectFactory which checks if the existing Subject was NOT a WebSubject, and call the super.createSubject(context) method if so.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13150992">SHIRO-646</key>
            <summary>Unable to login a DelegatingSubject on a DefaultWebSecurityManager</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="10003">Resolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="mnybon">Martin Nybo Nielsen</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test</label>
                    </labels>
                <created>Mon, 9 Apr 2018 10:00:17 +0000</created>
                <updated>Mon, 26 Sep 2022 08:30:22 +0000</updated>
                            <resolved>Mon, 26 Sep 2022 08:30:22 +0000</resolved>
                                    <version>1.4.0-RC2</version>
                                    <fixVersion>2.0.0-alpha</fixVersion>
                                    <component>Authentication (log-in)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16431956" author="mnybon" created="Tue, 10 Apr 2018 08:58:03 +0000"  >&lt;p&gt;I added a new test&#160;&lt;a href=&quot;https://github.com/apache/shiro/pull/82/files/30aed884db2372ee113467ae3174c85ba3cf79dc#diff-2043f461c75e7cb3fbea5f96761fd14b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;NonIniWebSecurityManagerTest&lt;/a&gt;&#160;which&#160;programatically instantiates a&#160;DefaultWebSecurityManager without setting&#160;sm.setSessionMode(DefaultWebSecurityManager.NATIVE_SESSION_MODE);&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The purpose is to be able to test the DefaultWebSecurityManager in its default state, as setting NATIVE_SESSION_MODE results in the error in this issue to not appear.&lt;/p&gt;</comment>
                            <comment id="16461145" author="githubbot" created="Wed, 2 May 2018 15:07:38 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/shiro/pull/82&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/shiro/pull/82&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 28 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3sayn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>