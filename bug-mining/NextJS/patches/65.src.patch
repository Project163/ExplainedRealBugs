diff --git a/packages/next/src/build/templates/app-page.ts b/packages/next/src/build/templates/app-page.ts
index 042454bef9..d636182649 100644
--- a/packages/next/src/build/templates/app-page.ts
+++ b/packages/next/src/build/templates/app-page.ts
@@ -89,6 +89,7 @@ import * as entryBase from '../../server/app-render/entry-base' with { 'turbopac
 import { RedirectStatusCode } from '../../client/components/redirect-status-code'
 import { InvariantError } from '../../shared/lib/invariant-error'
 import { scheduleOnNextTick } from '../../lib/scheduler'
+import { isInterceptionRouteAppPath } from '../../shared/lib/router/utils/interception-routes'
 
 export * from '../../server/app-render/entry-base' with { 'turbopack-transition': 'next-server-utility' }
 
@@ -150,7 +151,6 @@ export async function handler(
     buildId,
     query,
     params,
-    parsedUrl,
     pageIsDynamic,
     buildManifest,
     nextFontManifest,
@@ -167,12 +167,24 @@ export async function handler(
     interceptionRoutePatterns,
   } = prepareResult
 
-  const pathname = parsedUrl.pathname || '/'
   const normalizedSrcPage = normalizeAppPath(srcPage)
 
   let { isOnDemandRevalidate } = prepareResult
 
-  const prerenderInfo = routeModule.match(pathname, prerenderManifest)
+  // We use the resolvedPathname instead of the parsedUrl.pathname because it
+  // is not rewritten as resolvedPathname is. This will ensure that the correct
+  // prerender info is used instead of using the original pathname as the
+  // source. If however PPR is enabled and cacheComponents is disabled, we
+  // treat the pathname as dynamic. Currently, there's a bug in the PPR
+  // implementation that incorrectly leaves %%drp placeholders in the output of
+  // parallel routes. This is addressed with cacheComponents.
+  const prerenderInfo =
+    nextConfig.experimental.ppr &&
+    !nextConfig.experimental.cacheComponents &&
+    isInterceptionRouteAppPath(resolvedPathname)
+      ? null
+      : routeModule.match(resolvedPathname, prerenderManifest)
+
   const isPrerendered = !!prerenderManifest.routes[resolvedPathname]
 
   const userAgent = req.headers['user-agent'] || ''
diff --git a/test/e2e/app-dir/sub-shell-generation-middleware/app/[first]/[second]/[third]/layout.tsx b/test/e2e/app-dir/sub-shell-generation-middleware/app/[first]/[second]/[third]/layout.tsx
new file mode 100644
index 0000000000..dc40de0722
--- /dev/null
+++ b/test/e2e/app-dir/sub-shell-generation-middleware/app/[first]/[second]/[third]/layout.tsx
@@ -0,0 +1,20 @@
+import { Suspense } from 'react'
+import SharedComponent from '../../../shared'
+
+export default async function ThirdLayout({
+  children,
+  params,
+}: {
+  children: React.ReactNode
+  params: Promise<Record<string, string>>
+}) {
+  const current = await params
+
+  return (
+    <>
+      <pre>{JSON.stringify(current)}</pre>
+      <SharedComponent layout={`/[first]/[second]/[third]`} />
+      <Suspense>{children}</Suspense>
+    </>
+  )
+}
diff --git a/test/e2e/app-dir/sub-shell-generation-middleware/app/[first]/[second]/[third]/page.tsx b/test/e2e/app-dir/sub-shell-generation-middleware/app/[first]/[second]/[third]/page.tsx
new file mode 100644
index 0000000000..7109986a87
--- /dev/null
+++ b/test/e2e/app-dir/sub-shell-generation-middleware/app/[first]/[second]/[third]/page.tsx
@@ -0,0 +1,16 @@
+export default async function NotRewritePage({
+  params,
+}: {
+  params: Promise<{ first: string; second: string; third: string }>
+}) {
+  const { first, second, third } = await params
+  return (
+    <div data-slug={`${first}/${second}/${third}`}>
+      Page /{first}/{second}/{third}
+    </div>
+  )
+}
+
+export async function generateStaticParams() {
+  return [{ first: 'first', second: 'second', third: 'third' }]
+}
diff --git a/test/e2e/app-dir/sub-shell-generation-middleware/app/[first]/[second]/layout.tsx b/test/e2e/app-dir/sub-shell-generation-middleware/app/[first]/[second]/layout.tsx
new file mode 100644
index 0000000000..17d0144b87
--- /dev/null
+++ b/test/e2e/app-dir/sub-shell-generation-middleware/app/[first]/[second]/layout.tsx
@@ -0,0 +1,20 @@
+import { Suspense } from 'react'
+import SharedComponent from '../../shared'
+
+export default async function SecondLayout({
+  children,
+  params,
+}: {
+  children: React.ReactNode
+  params: Promise<Record<string, string>>
+}) {
+  const current = await params
+
+  return (
+    <>
+      <pre>{JSON.stringify(current)}</pre>
+      <SharedComponent layout={`/[first]/[second]`} />
+      <Suspense>{children}</Suspense>
+    </>
+  )
+}
diff --git a/test/e2e/app-dir/sub-shell-generation-middleware/app/[first]/layout.tsx b/test/e2e/app-dir/sub-shell-generation-middleware/app/[first]/layout.tsx
new file mode 100644
index 0000000000..08b2c52dfc
--- /dev/null
+++ b/test/e2e/app-dir/sub-shell-generation-middleware/app/[first]/layout.tsx
@@ -0,0 +1,20 @@
+import { Suspense } from 'react'
+import SharedComponent from '../shared'
+
+export default async function FirstLayout({
+  children,
+  params,
+}: {
+  children: React.ReactNode
+  params: Promise<Record<string, string>>
+}) {
+  const current = await params
+
+  return (
+    <>
+      <pre>{JSON.stringify(current)}</pre>
+      <SharedComponent layout={`/[first]`} />
+      <Suspense>{children}</Suspense>
+    </>
+  )
+}
diff --git a/test/e2e/app-dir/sub-shell-generation-middleware/app/layout.tsx b/test/e2e/app-dir/sub-shell-generation-middleware/app/layout.tsx
new file mode 100644
index 0000000000..6a86e06b20
--- /dev/null
+++ b/test/e2e/app-dir/sub-shell-generation-middleware/app/layout.tsx
@@ -0,0 +1,13 @@
+import { type ReactNode, Suspense } from 'react'
+import SharedComponent from './shared'
+
+export default function Root({ children }: { children: ReactNode }) {
+  return (
+    <html>
+      <body>
+        <SharedComponent layout="/" />
+        <Suspense fallback={<div>Loading...</div>}>{children}</Suspense>
+      </body>
+    </html>
+  )
+}
diff --git a/test/e2e/app-dir/sub-shell-generation-middleware/app/page.tsx b/test/e2e/app-dir/sub-shell-generation-middleware/app/page.tsx
new file mode 100644
index 0000000000..ff7159d914
--- /dev/null
+++ b/test/e2e/app-dir/sub-shell-generation-middleware/app/page.tsx
@@ -0,0 +1,3 @@
+export default function Page() {
+  return <p>hello world</p>
+}
diff --git a/test/e2e/app-dir/sub-shell-generation-middleware/app/rewrite/[slug]/layout.tsx b/test/e2e/app-dir/sub-shell-generation-middleware/app/rewrite/[slug]/layout.tsx
new file mode 100644
index 0000000000..3d71bdb00f
--- /dev/null
+++ b/test/e2e/app-dir/sub-shell-generation-middleware/app/rewrite/[slug]/layout.tsx
@@ -0,0 +1,20 @@
+import { Suspense } from 'react'
+import SharedComponent from '../../shared'
+
+export default async function RewriteSlugLayout({
+  children,
+  params,
+}: {
+  params: Promise<Record<string, string>>
+  children: React.ReactNode
+}) {
+  const current = await params
+
+  return (
+    <>
+      <pre>{JSON.stringify(current)}</pre>
+      <SharedComponent layout={`/rewrite/[slug]`} />
+      <Suspense>{children}</Suspense>
+    </>
+  )
+}
diff --git a/test/e2e/app-dir/sub-shell-generation-middleware/app/rewrite/[slug]/page.tsx b/test/e2e/app-dir/sub-shell-generation-middleware/app/rewrite/[slug]/page.tsx
new file mode 100644
index 0000000000..e2ec0be795
--- /dev/null
+++ b/test/e2e/app-dir/sub-shell-generation-middleware/app/rewrite/[slug]/page.tsx
@@ -0,0 +1,12 @@
+export default async function RewritePage({
+  params,
+}: {
+  params: Promise<{ slug: string }>
+}) {
+  const { slug } = await params
+  return <div data-rewrite-slug={slug}>Page /rewrite/{slug}</div>
+}
+
+export async function generateStaticParams() {
+  return []
+}
diff --git a/test/e2e/app-dir/sub-shell-generation-middleware/app/rewrite/layout.tsx b/test/e2e/app-dir/sub-shell-generation-middleware/app/rewrite/layout.tsx
new file mode 100644
index 0000000000..f1e80574e3
--- /dev/null
+++ b/test/e2e/app-dir/sub-shell-generation-middleware/app/rewrite/layout.tsx
@@ -0,0 +1,20 @@
+import { Suspense } from 'react'
+import SharedComponent from '../shared'
+
+export default async function RewriteLayout({
+  children,
+  params,
+}: {
+  params: Promise<Record<string, string>>
+  children: React.ReactNode
+}) {
+  const current = await params
+
+  return (
+    <div>
+      <pre>{JSON.stringify(current)}</pre>
+      <SharedComponent layout={`/rewrite`} />
+      <Suspense>{children}</Suspense>
+    </div>
+  )
+}
diff --git a/test/e2e/app-dir/sub-shell-generation-middleware/app/shared.tsx b/test/e2e/app-dir/sub-shell-generation-middleware/app/shared.tsx
new file mode 100644
index 0000000000..831ddb0a16
--- /dev/null
+++ b/test/e2e/app-dir/sub-shell-generation-middleware/app/shared.tsx
@@ -0,0 +1,19 @@
+const { PHASE_PRODUCTION_BUILD } = require('next/constants')
+
+function getSentinelValue() {
+  return process.env.NEXT_PHASE === PHASE_PRODUCTION_BUILD
+    ? 'buildtime'
+    : 'runtime'
+}
+
+type Props = {
+  layout: string
+}
+
+export default function SharedComponent({ layout }: Props) {
+  return (
+    <div data-layout={layout} data-sentinel={getSentinelValue()}>
+      SharedComponent {layout} â†’ {getSentinelValue()}
+    </div>
+  )
+}
diff --git a/test/e2e/app-dir/sub-shell-generation-middleware/middleware.ts b/test/e2e/app-dir/sub-shell-generation-middleware/middleware.ts
new file mode 100644
index 0000000000..0889cab36a
--- /dev/null
+++ b/test/e2e/app-dir/sub-shell-generation-middleware/middleware.ts
@@ -0,0 +1,17 @@
+import { type NextRequest, NextResponse } from 'next/server'
+
+export const middleware = (request: NextRequest) => {
+  if (request.nextUrl.pathname.includes('/not-broken')) {
+    const destination = new URL(
+      '/rewrite' + request.nextUrl.pathname + request.nextUrl.search,
+      request.url
+    )
+
+    return NextResponse.rewrite(destination)
+  }
+  return NextResponse.next()
+}
+
+export const config = {
+  matcher: ['/not-broken'],
+}
diff --git a/test/e2e/app-dir/sub-shell-generation-middleware/next.config.js b/test/e2e/app-dir/sub-shell-generation-middleware/next.config.js
new file mode 100644
index 0000000000..807126e4cf
--- /dev/null
+++ b/test/e2e/app-dir/sub-shell-generation-middleware/next.config.js
@@ -0,0 +1,6 @@
+/**
+ * @type {import('next').NextConfig}
+ */
+const nextConfig = {}
+
+module.exports = nextConfig
diff --git a/test/e2e/app-dir/sub-shell-generation-middleware/sub-shell-generation-middleware.test.ts b/test/e2e/app-dir/sub-shell-generation-middleware/sub-shell-generation-middleware.test.ts
new file mode 100644
index 0000000000..386c0d6c48
--- /dev/null
+++ b/test/e2e/app-dir/sub-shell-generation-middleware/sub-shell-generation-middleware.test.ts
@@ -0,0 +1,167 @@
+import { nextTestSetup } from 'e2e-utils'
+import * as cheerio from 'cheerio'
+import { retry } from 'next-test-utils'
+
+describe('middleware-static-rewrite', () => {
+  const { next, isNextDeploy, isNextDev } = nextTestSetup({
+    files: __dirname,
+  })
+
+  if (isNextDev) {
+    it.skip('skipping dev test', () => {})
+    return
+  }
+
+  if (
+    process.env.__NEXT_EXPERIMENTAL_CACHE_COMPONENTS === 'true' ||
+    process.env.__NEXT_EXPERIMENTAL_PPR === 'true'
+  ) {
+    // Here we're validating that the correct fallback shell was used for
+    // rendering.
+    it('should use the correct fallback route', async () => {
+      // First try to load a page that'll use the base fallback route with the
+      // `/[first]/[second]/[third]` fallback.
+      let $ = await next.render$('/first/second/third')
+
+      expect($('[data-slug]').data('slug')).toBe('first/second/third')
+
+      // Get the sentinel value that was generated at build time or runtime.
+      expect($('[data-layout="/"]').data('sentinel')).toBe('buildtime')
+      expect($('[data-layout="/[first]"]').data('sentinel')).toBe('buildtime')
+      expect($('[data-layout="/[first]/[second]"]').data('sentinel')).toBe(
+        'buildtime'
+      )
+      expect(
+        $('[data-layout="/[first]/[second]/[third]"]').data('sentinel')
+      ).toBe('buildtime')
+
+      // Then we try to load a page that'll use the `/first/second/[third]`
+      // fallback.
+      $ = await next.render$('/first/second/not-third')
+
+      expect($('[data-slug]').data('slug')).toBe('first/second/not-third')
+
+      expect($('[data-layout="/"]').data('sentinel')).toBe('buildtime')
+      expect($('[data-layout="/[first]"]').data('sentinel')).toBe('buildtime')
+      expect($('[data-layout="/[first]/[second]"]').data('sentinel')).toBe(
+        'buildtime'
+      )
+      expect(
+        $('[data-layout="/[first]/[second]/[third]"]').data('sentinel')
+      ).toBe('runtime')
+
+      // Then we try to load a page that'll use the `/first/[second]/[third]`
+      $ = await next.render$('/first/not-second/not-third')
+
+      expect($('[data-slug]').data('slug')).toBe('first/not-second/not-third')
+
+      expect($('[data-layout="/"]').data('sentinel')).toBe('buildtime')
+      expect($('[data-layout="/[first]"]').data('sentinel')).toBe('buildtime')
+      expect($('[data-layout="/[first]/[second]"]').data('sentinel')).toBe(
+        'runtime'
+      )
+      expect(
+        $('[data-layout="/[first]/[second]/[third]"]').data('sentinel')
+      ).toBe('runtime')
+
+      // Then we try to load a page that'll use the `/[first]/[second]/[third]`
+      $ = await next.render$('/not-first/not-second/not-third')
+
+      expect($('[data-slug]').data('slug')).toBe(
+        'not-first/not-second/not-third'
+      )
+
+      expect($('[data-layout="/"]').data('sentinel')).toBe('buildtime')
+      expect($('[data-layout="/[first]"]').data('sentinel')).toBe('runtime')
+      expect($('[data-layout="/[first]/[second]"]').data('sentinel')).toBe(
+        'runtime'
+      )
+      expect(
+        $('[data-layout="/[first]/[second]/[third]"]').data('sentinel')
+      ).toBe('runtime')
+    })
+
+    it('should handle middleware rewrites as well', async () => {
+      let res = await next.fetch('/not-broken')
+
+      expect(res.status).toBe(200)
+
+      if (isNextDeploy) {
+        expect(res.headers.get('x-vercel-cache')).toMatch(/MISS|HIT|PRERENDER/)
+      } else {
+        expect(res.headers.get('x-nextjs-cache')).toBe(null)
+      }
+
+      let html = await res.text()
+      let $ = cheerio.load(html)
+
+      expect($('[data-layout="/"]').data('sentinel')).toBe('buildtime')
+      expect($('[data-layout="/rewrite"]').data('sentinel')).toBe('buildtime')
+      expect($('[data-layout="/rewrite/[slug]"]').data('sentinel')).toBe(
+        'runtime'
+      )
+
+      await retry(async () => {
+        res = await next.fetch('/not-broken')
+
+        expect(res.status).toBe(200)
+        if (isNextDeploy) {
+          expect(res.headers.get('x-vercel-cache')).toBe('HIT')
+        } else {
+          expect(res.headers.get('x-nextjs-cache')).toBe(null)
+        }
+      })
+
+      html = await res.text()
+      $ = cheerio.load(html)
+
+      expect($('[data-rewrite-slug]').data('rewrite-slug')).toBe('not-broken')
+
+      expect($('[data-layout="/"]').data('sentinel')).toBe('buildtime')
+      expect($('[data-layout="/rewrite"]').data('sentinel')).toBe('buildtime')
+      expect($('[data-layout="/rewrite/[slug]"]').data('sentinel')).toBe(
+        'runtime'
+      )
+    })
+  } else {
+    // Here we're validating that there is a static page generated for the
+    // rewritten path.
+    it('should eventually result in a cache hit', async () => {
+      let res = await next.fetch('/not-broken')
+
+      expect(res.status).toBe(200)
+      expect(
+        res.headers.get(isNextDeploy ? 'x-vercel-cache' : 'x-nextjs-cache')
+      ).toMatch(/MISS|HIT|PRERENDER/)
+
+      let html = await res.text()
+      let $ = cheerio.load(html)
+
+      expect($('[data-layout="/"]').data('sentinel')).toBe('runtime')
+      expect($('[data-layout="/rewrite"]').data('sentinel')).toBe('runtime')
+      expect($('[data-layout="/rewrite/[slug]"]').data('sentinel')).toBe(
+        'runtime'
+      )
+
+      await retry(async () => {
+        res = await next.fetch('/not-broken')
+
+        expect(res.status).toBe(200)
+        expect(
+          res.headers.get(isNextDeploy ? 'x-vercel-cache' : 'x-nextjs-cache')
+        ).toBe('HIT')
+      })
+
+      html = await res.text()
+      $ = cheerio.load(html)
+
+      expect($('[data-rewrite-slug]').data('rewrite-slug')).toBe('not-broken')
+
+      expect($('[data-layout="/"]').data('sentinel')).toBe('runtime')
+      expect($('[data-layout="/rewrite"]').data('sentinel')).toBe('runtime')
+      expect($('[data-layout="/rewrite/[slug]"]').data('sentinel')).toBe(
+        'runtime'
+      )
+    })
+  }
+})
diff --git a/test/lib/next-modes/next-deploy.ts b/test/lib/next-modes/next-deploy.ts
index f262290166..e69b9ede98 100644
--- a/test/lib/next-modes/next-deploy.ts
+++ b/test/lib/next-modes/next-deploy.ts
@@ -120,6 +120,10 @@ export class NextDeployInstance extends NextInstance {
         cwd: this.testDir,
         env: vercelEnv,
         reject: false,
+        // This will print deployment information earlier to the console so we
+        // don't have to wait until the deployment is complete to get the
+        // inspect URL.
+        stderr: 'inherit',
       }
     )
 
