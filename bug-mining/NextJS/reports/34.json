{"url":"https://api.github.com/repos/vercel/next.js/issues/78815","repository_url":"https://api.github.com/repos/vercel/next.js","labels_url":"https://api.github.com/repos/vercel/next.js/issues/78815/labels{/name}","comments_url":"https://api.github.com/repos/vercel/next.js/issues/78815/comments","events_url":"https://api.github.com/repos/vercel/next.js/issues/78815/events","html_url":"https://github.com/vercel/next.js/issues/78815","id":3037753711,"node_id":"I_kwDOBC3Cis61EHFv","number":78815,"title":"CSP header missing in 304 responses for static assets served by next/dist/compiled/send","user":{"login":"nicole0707","id":103509584,"node_id":"U_kgDOBituUA","avatar_url":"https://avatars.githubusercontent.com/u/103509584?v=4","gravatar_id":"","url":"https://api.github.com/users/nicole0707","html_url":"https://github.com/nicole0707","followers_url":"https://api.github.com/users/nicole0707/followers","following_url":"https://api.github.com/users/nicole0707/following{/other_user}","gists_url":"https://api.github.com/users/nicole0707/gists{/gist_id}","starred_url":"https://api.github.com/users/nicole0707/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicole0707/subscriptions","organizations_url":"https://api.github.com/users/nicole0707/orgs","repos_url":"https://api.github.com/users/nicole0707/repos","events_url":"https://api.github.com/users/nicole0707/events{/privacy}","received_events_url":"https://api.github.com/users/nicole0707/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":5721224978,"node_id":"LA_kwDOBC3Cis8AAAABVQL3Eg","url":"https://api.github.com/repos/vercel/next.js/labels/locked","name":"locked","color":"ededed","default":false,"description":null},{"id":8259487517,"node_id":"LA_kwDOBC3Cis8AAAAB7E3HHQ","url":"https://api.github.com/repos/vercel/next.js/labels/Headers","name":"Headers","color":"0052cc","default":false,"description":"Related to the async headers() function."}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2025-05-04T03:39:18Z","updated_at":"2025-05-22T00:05:57Z","closed_at":"2025-05-07T15:21:06Z","author_association":"CONTRIBUTOR","type":{"id":1930995,"node_id":"IT_kwDOAOSnPM4AHXbz","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T15:36:35Z","updated_at":"2024-07-26T10:33:22Z","is_enabled":true},"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Link to the code that reproduces this issue\n\nhttps://github.com/nicole0707/nextjs-304-csp-example\n\n### To Reproduce\n\n* Serve a static file (e.g., /trusted-lib.js) with a valid Content-Security-Policy header.\n* Load it once in the browser.\n* Refresh the page or re-request the asset after it is cached.\n* Observe that the 304 response omits the CSP header.\n\n### Current vs. Expected behavior\n\nWhen a static asset is served with a 304 Not Modified response, the Content-Security-Policy (CSP) header is not included, even if it was present in the original 200 OK response.\n\nThis causes the CSP header to be missing in the response, or fallback to the default CSP policy from the CDN or browser context. As a result, some browsers may block the asset or apply unintended restrictions under strict CSP enforcement.\n\nThe issue appears to stem from the internal usage of a precompiled version of [send](https://www.npmjs.com/package/send) under `next/dist/compiled/send`, which omits custom headers for 304 responses by default.\n\nThe official send package addressed this issue years ago - https://github.com/pillarjs/send/commit/f53edbb7f4f7ebdd936d3d714d84d52f2d3d00f3 , but the version bundled with Next.js seems outdated or modified.\n\n### Provide environment information\n\n```bash\nOperating System:\n  Platform: darwin\n  Arch: arm64\n  Version: Darwin Kernel Version 24.4.0: Fri Apr 11 18:32:05 PDT 2025; root:xnu-11417.101.15~117/RELEASE_ARM64_T8132\n  Available memory (MB): 32768\n  Available CPU cores: 10\nBinaries:\n  Node: 23.11.0\n  npm: 10.9.2\n  Yarn: N/A\n  pnpm: N/A\nRelevant Packages:\n  next: 15.3.1 // Latest available version is detected (15.3.1).\n  eslint-config-next: N/A\n  react: 19.1.0\n  react-dom: 19.1.0\n  typescript: 5.8.3\nNext.js Config:\n  output: N/A\n```\n\n### Which area(s) are affected? (Select all that apply)\n\nHeaders\n\n### Which stage(s) are affected? (Select all that apply)\n\nnext dev (local), next start (local)\n\n### Additional context\n\nPlease consider updating the internal version of send used in next/dist/compiled/send to the latest official version, which supports preserving headers in 304 responses.\n\n","closed_by":{"login":"ijjk","id":22380829,"node_id":"MDQ6VXNlcjIyMzgwODI5","avatar_url":"https://avatars.githubusercontent.com/u/22380829?v=4","gravatar_id":"","url":"https://api.github.com/users/ijjk","html_url":"https://github.com/ijjk","followers_url":"https://api.github.com/users/ijjk/followers","following_url":"https://api.github.com/users/ijjk/following{/other_user}","gists_url":"https://api.github.com/users/ijjk/gists{/gist_id}","starred_url":"https://api.github.com/users/ijjk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ijjk/subscriptions","organizations_url":"https://api.github.com/users/ijjk/orgs","repos_url":"https://api.github.com/users/ijjk/repos","events_url":"https://api.github.com/users/ijjk/events{/privacy}","received_events_url":"https://api.github.com/users/ijjk/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/vercel/next.js/issues/78815/reactions","total_count":3,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/vercel/next.js/issues/78815/timeline","performed_via_github_app":null,"state_reason":"completed"}