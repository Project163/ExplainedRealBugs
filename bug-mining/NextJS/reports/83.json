{"url":"https://api.github.com/repos/vercel/next.js/issues/85172","repository_url":"https://api.github.com/repos/vercel/next.js","labels_url":"https://api.github.com/repos/vercel/next.js/issues/85172/labels{/name}","comments_url":"https://api.github.com/repos/vercel/next.js/issues/85172/comments","events_url":"https://api.github.com/repos/vercel/next.js/issues/85172/events","html_url":"https://github.com/vercel/next.js/issues/85172","id":3536532058,"node_id":"I_kwDOBC3Cis7SyzJa","number":85172,"title":"Turbopack tree-shaking generates invalid output for some pages router SSR chunks","user":{"login":"marcelltoth","id":543372,"node_id":"MDQ6VXNlcjU0MzM3Mg==","avatar_url":"https://avatars.githubusercontent.com/u/543372?v=4","gravatar_id":"","url":"https://api.github.com/users/marcelltoth","html_url":"https://github.com/marcelltoth","followers_url":"https://api.github.com/users/marcelltoth/followers","following_url":"https://api.github.com/users/marcelltoth/following{/other_user}","gists_url":"https://api.github.com/users/marcelltoth/gists{/gist_id}","starred_url":"https://api.github.com/users/marcelltoth/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marcelltoth/subscriptions","organizations_url":"https://api.github.com/users/marcelltoth/orgs","repos_url":"https://api.github.com/users/marcelltoth/repos","events_url":"https://api.github.com/users/marcelltoth/events{/privacy}","received_events_url":"https://api.github.com/users/marcelltoth/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":3499651836,"node_id":"LA_kwDOBC3Cis7QmHL8","url":"https://api.github.com/repos/vercel/next.js/labels/Output","name":"Output","color":"31A7C3","default":false,"description":"Related to the the output configuration option."},{"id":4771244046,"node_id":"LA_kwDOBC3Cis8AAAABHGNoDg","url":"https://api.github.com/repos/vercel/next.js/labels/Turbopack","name":"Turbopack","color":"FF1E56","default":false,"description":"Related to Turbopack with Next.js."},{"id":5484123250,"node_id":"LA_kwDOBC3Cis8AAAABRuEUcg","url":"https://api.github.com/repos/vercel/next.js/labels/linear:%20turbopack","name":"linear: turbopack","color":"290F77","default":false,"description":"Confirmed issue that is tracked by the Turbopack team."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2025-10-21T13:18:59Z","updated_at":"2025-11-04T10:15:14Z","closed_at":"2025-11-04T09:24:07Z","author_association":"NONE","type":{"id":1930995,"node_id":"IT_kwDOAOSnPM4AHXbz","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T15:36:35Z","updated_at":"2024-07-26T10:33:22Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Link to the code that reproduces this issue\n\nhttps://github.com/marcelltoth/turbopack-optimization-bug-demo\n\n### To Reproduce\n\nTake a look at the linked repository.\n1. Build the project - `npm run build`\n2. [Copy the standalone files](https://nextjs.org/docs/pages/api-reference/config/next-config-js/output#automatically-copying-traced-files) so we can run it locally without a CDN - `cp -r .next/static .next/standalone/.next/` \n3. Run the standalone artifact - `HOSTNAME=localhost node .next/standalone/server.js`\n4. Visit `http://localhost:3000`\n5. Observe the 500 Internal server error.\n    \n\n### Current vs. Expected behavior\n\nExpected behavior is that the (empty) page loads successfully. \n\nThe current is that it renders a 500 error page and prints the following into the terminal:\n>  тип Error: Failed to load external module aws-amplify: Error [ERR_MODULE_NOT_FOUND]: Cannot find module 'C:\\<project-location>\\.next\\standalone\\node_modules\\@aws-amplify\\core\\dist\\esm\\providers\\pinpoint\\types\\errors.mjs' imported from C:\\<project-location>\\.next\\standalone\\node_modules\\@aws-amplify\\core\\dist\\esm\\ServiceWorker\\ServiceWorker.mjs\n    at Context.externalImport [as y] (C:\\<project-location>\\.next\\standalone\\.next\\server\\chunks\\ssr\\[turbopack]_runtime.js:497:15)\n    at async (C:\\<project-location>\\.next\\standalone\\.next\\server\\chunks\\ssr\\[root-of-the-server]__3e1fdc6a._.js:1:52)\n\n### Provide environment information\n\n```bash\nOperating System:\n  Platform: win32\n  Arch: x64\n  Version: Windows 11 Pro N\n  Available memory (MB): 64630\n  Available CPU cores: 24\nBinaries:\n  Node: 20.9.0\n  npm: 10.1.0\n  Yarn: 1.22.22\n  pnpm: 10.17.1\nRelevant Packages:\n  next: 16.0.0-canary.16 // Latest available version is detected (16.0.0-canary.16).\n  eslint-config-next: N/A\n  react: 19.2.0\n  react-dom: 19.2.0\n  typescript: 5.9.3\nNext.js Config:\n  output: standalone\n```\n\n### Which area(s) are affected? (Select all that apply)\n\nTurbopack, Output\n\n### Which stage(s) are affected? (Select all that apply)\n\nnext build (local)\n\n### Additional context\n\nI narrowed it down to the following:\n\n1. It only happens with Turbopack prod builds. Not with Webpack prod builds or Turbopack dev builds.\n2. I wasn't able to reproduce the issue with the App router (server or client components), or with static pregenerated pages router pages. It has to be an SSR chunk, which is why I added the empty `getInitialProps` to the example.\n3. It happens both with current stable and canary.\n\nThe issue seems to be the tree-shaking behavior of Turbopack, I found this by looking at the build output and `node_modules`.\n\n1. If you look at the input file `node_modules/@aws-amplify/core/dist/esm/ServiceWorker/ServiceWorker.mjs` you can see it does have the import `import '../providers/pinpoint/types/errors.mjs';`\n2. The `package.json` for `@aws-amplify/core` says `sideEffects` is only true for 4 particular files, that does not include the above.\n3. Probably for this reason Turbopack decides to drop `node_modules\\@aws-amplify\\core\\dist\\esm\\providers\\pinpoint\\types\\errors.mjs` from the output.\n4. At the same time it fails to drop the import itself, which will result in the failure we're seeing.\n\nForcing the file to be included by adding this to `next.config.ts` acts as a valid workaround:\n```js\noutputFileTracingIncludes: {\n    '/*': [\n      'node_modules/@aws-amplify/core/dist/esm/providers/pinpoint/types/*',\n    ],\n  }\n```","closed_by":{"login":"mischnic","id":4586894,"node_id":"MDQ6VXNlcjQ1ODY4OTQ=","avatar_url":"https://avatars.githubusercontent.com/u/4586894?v=4","gravatar_id":"","url":"https://api.github.com/users/mischnic","html_url":"https://github.com/mischnic","followers_url":"https://api.github.com/users/mischnic/followers","following_url":"https://api.github.com/users/mischnic/following{/other_user}","gists_url":"https://api.github.com/users/mischnic/gists{/gist_id}","starred_url":"https://api.github.com/users/mischnic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mischnic/subscriptions","organizations_url":"https://api.github.com/users/mischnic/orgs","repos_url":"https://api.github.com/users/mischnic/repos","events_url":"https://api.github.com/users/mischnic/events{/privacy}","received_events_url":"https://api.github.com/users/mischnic/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/vercel/next.js/issues/85172/reactions","total_count":3,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/vercel/next.js/issues/85172/timeline","performed_via_github_app":null,"state_reason":"completed"}