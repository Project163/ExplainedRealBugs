{"url":"https://api.github.com/repos/vercel/next.js/issues/74181","repository_url":"https://api.github.com/repos/vercel/next.js","labels_url":"https://api.github.com/repos/vercel/next.js/issues/74181/labels{/name}","comments_url":"https://api.github.com/repos/vercel/next.js/issues/74181/comments","events_url":"https://api.github.com/repos/vercel/next.js/issues/74181/events","html_url":"https://github.com/vercel/next.js/issues/74181","id":2752212464,"node_id":"I_kwDOBC3Cis6kC23w","number":74181,"title":"Valid `this` in server actions","user":{"login":"maciej-ka","id":5403694,"node_id":"MDQ6VXNlcjU0MDM2OTQ=","avatar_url":"https://avatars.githubusercontent.com/u/5403694?v=4","gravatar_id":"","url":"https://api.github.com/users/maciej-ka","html_url":"https://github.com/maciej-ka","followers_url":"https://api.github.com/users/maciej-ka/followers","following_url":"https://api.github.com/users/maciej-ka/following{/other_user}","gists_url":"https://api.github.com/users/maciej-ka/gists{/gist_id}","starred_url":"https://api.github.com/users/maciej-ka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maciej-ka/subscriptions","organizations_url":"https://api.github.com/users/maciej-ka/orgs","repos_url":"https://api.github.com/users/maciej-ka/repos","events_url":"https://api.github.com/users/maciej-ka/events{/privacy}","received_events_url":"https://api.github.com/users/maciej-ka/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2471906168,"node_id":"MDU6TGFiZWwyNDcxOTA2MTY4","url":"https://api.github.com/repos/vercel/next.js/labels/bug","name":"bug","color":"fddf99","default":true,"description":"Issue was opened via the bug report template."},{"id":5721224978,"node_id":"LA_kwDOBC3Cis8AAAABVQL3Eg","url":"https://api.github.com/repos/vercel/next.js/labels/locked","name":"locked","color":"ededed","default":false,"description":null}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2024-12-20T08:29:19Z","updated_at":"2025-01-04T00:04:58Z","closed_at":"2024-12-20T14:11:24Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Link to the code that reproduces this issue\r\n\r\nhttps://github.com/maciej-ka/next-server-action-valid-this\r\n\r\n### To Reproduce\r\n\r\n1. `npm run dev`\r\n2. visit\r\n\r\n### Current vs. Expected behavior\r\n\r\n#### Current\r\n<img width=\"800\" alt=\"server-action-this-error\" src=\"https://github.com/user-attachments/assets/b2f8566a-1e3b-4a75-9f8f-6578920c7a0b\" />\r\n\r\n#### Expected\r\n<img width=\"749\" alt=\"Screenshot 2024-12-20 at 09 10 34\" src=\"https://github.com/user-attachments/assets/8e7551f3-299d-48a2-95c7-19ad7d479663\" />\r\n\r\n\r\n### Provide environment information\r\n\r\n```bash\r\nOperating System:\r\n  Platform: darwin\r\n  Arch: arm64\r\n  Version: Darwin Kernel Version 24.1.0: Thu Oct 10 21:03:15 PDT 2024; root:xnu-11215.41.3~2/RELEASE_ARM64_T6000\r\n  Available memory (MB): 65536\r\n  Available CPU cores: 10\r\nBinaries:\r\n  Node: 22.9.0\r\n  npm: 10.8.3\r\n  Yarn: 1.22.17\r\n  pnpm: 9.15.0\r\nRelevant Packages:\r\n  next: 15.0.4 // There is a newer version (15.1.2) available, upgrade recommended!\r\n  eslint-config-next: 15.1.2\r\n  react: 19.0.0\r\n  react-dom: 19.0.0\r\n  typescript: 5.7.2\r\nNext.js Config:\r\n  output: N/A\r\n```\r\n\r\n\r\n### Which area(s) are affected? (Select all that apply)\r\n\r\nNot sure\r\n\r\n### Which stage(s) are affected? (Select all that apply)\r\n\r\nnext dev (local), next build (local), next start (local), Vercel (Deployed), Other (Deployed)\r\n\r\n### Additional context\r\n\r\n#### Debug\r\nWhen debugging on Next.js version before forbidding `this`\r\n(available on [branch](https://github.com/maciej-ka/next-server-action-valid-this/tree/debug-this) of reproduction repo)\r\n```ts\r\nexport const createItem = async () => {\r\n  return new Promise<number>((resolve, reject) => {\r\n    console.dir(this);\r\n    db.run('INSERT INTO items (title) VALUES (?)', [\"foo\"], function(err) {\r\n      if (err) reject(err)\r\n      console.dir(this);\r\n      resolve(this.lastID)\r\n    })\r\n  });\r\n};\r\n```\r\n\r\nResults are\r\n<img width=\"367\" alt=\"Screenshot 2024-12-19 at 23 10 37\" src=\"https://github.com/user-attachments/assets/0662a8b6-4a63-47cd-b0e7-6bea2f47de38\" />\r\n\r\n#### Motivation\r\nWhile the first case could be forbidden,\r\nsecond case, where `this` is a `Statement` should be allowed.\r\n\r\n#### Links\r\nForbidden `this` introduced in: https://github.com/vercel/next.js/pull/73059\r\nTicket created from discussion: https://github.com/vercel/next.js/discussions/74124\r\nSolution PR by changing a function visitor: https://github.com/vercel/next.js/pull/74179","closed_by":{"login":"unstubbable","id":761683,"node_id":"MDQ6VXNlcjc2MTY4Mw==","avatar_url":"https://avatars.githubusercontent.com/u/761683?v=4","gravatar_id":"","url":"https://api.github.com/users/unstubbable","html_url":"https://github.com/unstubbable","followers_url":"https://api.github.com/users/unstubbable/followers","following_url":"https://api.github.com/users/unstubbable/following{/other_user}","gists_url":"https://api.github.com/users/unstubbable/gists{/gist_id}","starred_url":"https://api.github.com/users/unstubbable/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/unstubbable/subscriptions","organizations_url":"https://api.github.com/users/unstubbable/orgs","repos_url":"https://api.github.com/users/unstubbable/repos","events_url":"https://api.github.com/users/unstubbable/events{/privacy}","received_events_url":"https://api.github.com/users/unstubbable/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/vercel/next.js/issues/74181/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/vercel/next.js/issues/74181/timeline","performed_via_github_app":null,"state_reason":"completed"}