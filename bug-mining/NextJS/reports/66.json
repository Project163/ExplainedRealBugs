{"url":"https://api.github.com/repos/vercel/next.js/issues/82610","repository_url":"https://api.github.com/repos/vercel/next.js","labels_url":"https://api.github.com/repos/vercel/next.js/issues/82610/labels{/name}","comments_url":"https://api.github.com/repos/vercel/next.js/issues/82610/comments","events_url":"https://api.github.com/repos/vercel/next.js/issues/82610/events","html_url":"https://github.com/vercel/next.js/issues/82610","id":3318204540,"node_id":"I_kwDOBC3Cis7Fx8h8","number":82610,"title":"[Regression] Image optimizer fails to serve images on routes requiring autorization","user":{"login":"jakobmerrild","id":2920412,"node_id":"MDQ6VXNlcjI5MjA0MTI=","avatar_url":"https://avatars.githubusercontent.com/u/2920412?v=4","gravatar_id":"","url":"https://api.github.com/users/jakobmerrild","html_url":"https://github.com/jakobmerrild","followers_url":"https://api.github.com/users/jakobmerrild/followers","following_url":"https://api.github.com/users/jakobmerrild/following{/other_user}","gists_url":"https://api.github.com/users/jakobmerrild/gists{/gist_id}","starred_url":"https://api.github.com/users/jakobmerrild/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jakobmerrild/subscriptions","organizations_url":"https://api.github.com/users/jakobmerrild/orgs","repos_url":"https://api.github.com/users/jakobmerrild/repos","events_url":"https://api.github.com/users/jakobmerrild/events{/privacy}","received_events_url":"https://api.github.com/users/jakobmerrild/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":3499448196,"node_id":"LA_kwDOBC3Cis7QlVeE","url":"https://api.github.com/repos/vercel/next.js/labels/Image%20(next/image)","name":"Image (next/image)","color":"45ADE8","default":false,"description":"Related to Next.js Image Optimization."},{"id":5721224978,"node_id":"LA_kwDOBC3Cis8AAAABVQL3Eg","url":"https://api.github.com/repos/vercel/next.js/labels/locked","name":"locked","color":"ededed","default":false,"description":null}],"state":"closed","locked":true,"assignee":{"login":"icyJoseph","id":21013447,"node_id":"MDQ6VXNlcjIxMDEzNDQ3","avatar_url":"https://avatars.githubusercontent.com/u/21013447?v=4","gravatar_id":"","url":"https://api.github.com/users/icyJoseph","html_url":"https://github.com/icyJoseph","followers_url":"https://api.github.com/users/icyJoseph/followers","following_url":"https://api.github.com/users/icyJoseph/following{/other_user}","gists_url":"https://api.github.com/users/icyJoseph/gists{/gist_id}","starred_url":"https://api.github.com/users/icyJoseph/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icyJoseph/subscriptions","organizations_url":"https://api.github.com/users/icyJoseph/orgs","repos_url":"https://api.github.com/users/icyJoseph/repos","events_url":"https://api.github.com/users/icyJoseph/events{/privacy}","received_events_url":"https://api.github.com/users/icyJoseph/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"icyJoseph","id":21013447,"node_id":"MDQ6VXNlcjIxMDEzNDQ3","avatar_url":"https://avatars.githubusercontent.com/u/21013447?v=4","gravatar_id":"","url":"https://api.github.com/users/icyJoseph","html_url":"https://github.com/icyJoseph","followers_url":"https://api.github.com/users/icyJoseph/followers","following_url":"https://api.github.com/users/icyJoseph/following{/other_user}","gists_url":"https://api.github.com/users/icyJoseph/gists{/gist_id}","starred_url":"https://api.github.com/users/icyJoseph/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icyJoseph/subscriptions","organizations_url":"https://api.github.com/users/icyJoseph/orgs","repos_url":"https://api.github.com/users/icyJoseph/repos","events_url":"https://api.github.com/users/icyJoseph/events{/privacy}","received_events_url":"https://api.github.com/users/icyJoseph/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":30,"created_at":"2025-08-13T12:08:37Z","updated_at":"2025-09-23T00:05:17Z","closed_at":"2025-09-08T14:47:18Z","author_association":"NONE","type":{"id":1930995,"node_id":"IT_kwDOAOSnPM4AHXbz","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T15:36:35Z","updated_at":"2024-07-26T10:33:22Z","is_enabled":true},"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Link to the code that reproduces this issue\n\nhttps://github.com/jakobmerrild/next-15.4.5-public-image-issue\n\n### To Reproduce\n\n1. Enable `corepack` if not already enabled\n2. Install packages `yarn install`\n3. Build using `yarn build`\n4. Build docker image `docker build . -t my-tag`\n5. Run docker image `docker run -p 3000:3000 my-tag`\n5. Open http://localhost:3000\n6. Log in with _any_ credentials (resolver doesn't check them)\n  a. Notice console output from the server: `The requested resource isn't a valid image for /us.png received null`\n\nIf `docker` isn't available you can replace steps 4-5 with\n1. Copy public folder and static resource to standalone server `cp -r ./public .next/standalone && cp -r .next/static .next/standalone`\n2. Start standalone server `node .next/standalone/server.js`\n\n### Current vs. Expected behavior\nImages that are served from a route protected in the `middleware.ts` by using `AuthJS` are not served because the image optimizer fails to forward the auth headers when trying to fetch the image.\n\nRegression introduced in https://github.com/vercel/next.js/pull/82114 (backported in https://github.com/vercel/next.js/pull/82175)\n\nInstead those images are broken and the server logs \n```\nThe requested resource isn't a valid image for /us.png received null\nThe requested resource isn't a valid image for /potato.jpg received null\n```\n\n### Provide environment information\n\n```bash\nInfo from application where we saw this issue, not the replication repo\n\nOperating System:\n  Platform: darwin\n  Arch: arm64\n  Version: Darwin Kernel Version 24.6.0: Mon Jul 14 11:30:29 PDT 2025; root:xnu-11417.140.69~1/RELEASE_ARM64_T6000\n  Available memory (MB): 32768\n  Available CPU cores: 10\nBinaries:\n  Node: 24.0.2\n  npm: 11.3.0\n  Yarn: 4.9.2\n  pnpm: 10.6.4\nRelevant Packages:\n  next: 15.4.6\n  eslint-config-next: 15.4.6\n  react: 19.1.1\n  react-dom: 19.1.1\n  typescript: 5.9.2\nNext.js Config:\n  output: standalone\n```\n\n### Which area(s) are affected? (Select all that apply)\n\nImage (next/image)\n\n### Which stage(s) are affected? (Select all that apply)\n\nOther (Deployed), next build (local)\n\n### Additional context\n\nThe issue started after upgrading from Next 15.3.5 to 15.4.5 in my project.\n\nSee comment: https://github.com/vercel/next.js/issues/82610#issuecomment-3190843941\n\n### Potential workaround\n\n_If_ the images can be safely served without authorization then moving the images to a route that can be safely ignored by the middleware, e.g. `/public/images` and updating the middleware matcher to ignore that route e.g.\n```typescript\nexport const config = {\n    matcher: [\n        /*\n         * Match all request paths except for the ones starting with:\n         * - api (API routes)\n         * - login (The login page)\n         * - health (Health check route)\n         * - _next/static (static files)\n         * - _next/image (image optimization files)\n         * - favicon.ico (favicon file)\n         * - images (public images)\n         */\n        '/((?!login|api|health|_next/static|_next/image|images|favicon.ico).*)',\n    ],\n};\n```\nWill allow the images to be served though obviously with the loss of authorization for the route.","closed_by":{"login":"styfle","id":229881,"node_id":"MDQ6VXNlcjIyOTg4MQ==","avatar_url":"https://avatars.githubusercontent.com/u/229881?v=4","gravatar_id":"","url":"https://api.github.com/users/styfle","html_url":"https://github.com/styfle","followers_url":"https://api.github.com/users/styfle/followers","following_url":"https://api.github.com/users/styfle/following{/other_user}","gists_url":"https://api.github.com/users/styfle/gists{/gist_id}","starred_url":"https://api.github.com/users/styfle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/styfle/subscriptions","organizations_url":"https://api.github.com/users/styfle/orgs","repos_url":"https://api.github.com/users/styfle/repos","events_url":"https://api.github.com/users/styfle/events{/privacy}","received_events_url":"https://api.github.com/users/styfle/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/vercel/next.js/issues/82610/reactions","total_count":3,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/vercel/next.js/issues/82610/timeline","performed_via_github_app":null,"state_reason":"completed"}