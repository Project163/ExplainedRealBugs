{"url":"https://api.github.com/repos/vercel/next.js/issues/85520","repository_url":"https://api.github.com/repos/vercel/next.js","labels_url":"https://api.github.com/repos/vercel/next.js/issues/85520/labels{/name}","comments_url":"https://api.github.com/repos/vercel/next.js/issues/85520/comments","events_url":"https://api.github.com/repos/vercel/next.js/issues/85520/events","html_url":"https://github.com/vercel/next.js/issues/85520","id":3566916690,"node_id":"I_kwDOBC3Cis7UmtRS","number":85520,"title":"Route Attributes are not propagated to the handleRequest span when nextjs is used with a custom server","user":{"login":"eli0shin","id":22717000,"node_id":"MDQ6VXNlcjIyNzE3MDAw","avatar_url":"https://avatars.githubusercontent.com/u/22717000?v=4","gravatar_id":"","url":"https://api.github.com/users/eli0shin","html_url":"https://github.com/eli0shin","followers_url":"https://api.github.com/users/eli0shin/followers","following_url":"https://api.github.com/users/eli0shin/following{/other_user}","gists_url":"https://api.github.com/users/eli0shin/gists{/gist_id}","starred_url":"https://api.github.com/users/eli0shin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eli0shin/subscriptions","organizations_url":"https://api.github.com/users/eli0shin/orgs","repos_url":"https://api.github.com/users/eli0shin/repos","events_url":"https://api.github.com/users/eli0shin/events{/privacy}","received_events_url":"https://api.github.com/users/eli0shin/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":6834839951,"node_id":"LA_kwDOBC3Cis8AAAABl2Nhjw","url":"https://api.github.com/repos/vercel/next.js/labels/Instrumentation","name":"Instrumentation","color":"fef2c0","default":false,"description":"Related to Next.js Instrumentation."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2025-10-29T16:36:49Z","updated_at":"2025-11-07T23:43:27Z","closed_at":"2025-11-07T23:43:27Z","author_association":"CONTRIBUTOR","type":{"id":1930995,"node_id":"IT_kwDOAOSnPM4AHXbz","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T15:36:35Z","updated_at":"2024-07-26T10:33:22Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Link to the code that reproduces this issue\n\nhttps://github.com/eli0shin/next-js-custom-server-repro\n\n### To Reproduce\n\n1. build the server\n2. run npm run start to run nextjs with the custom server\n3. open the page in your browser\n4. the otel spans will be logged in the console. the handleRequest span is missing the http.route and next.route attributes\n5. stop the server\n6. start the regular server with npm run start:regular\n7. open the page in your browser\n8. the spans are logged to the console. the http.route and next.route attributes are on the handleRequest span\n\n### Current vs. Expected behavior\n\n### Current\nWhen a custom server is used no span contains the http.route attribute for the matched nextjs route\n\n### Expected\nWhen a custom server is used the handleRequest route contains the http.route attribute for the matched route\n\n### Provide environment information\n\n```bash\nThis behavior is entirely independent of the environment.\n```\n\n### Which area(s) are affected? (Select all that apply)\n\nInstrumentation\n\n### Which stage(s) are affected? (Select all that apply)\n\nOther (Deployed)\n\n### Additional context\n\nWhen Next.js is used with a custom server that creates its own root span, Next.js still creates its own `handleRequest` span, but it fails to propagate attributes (like `next.route` and `http.route`) to the span that **it creates** because the attribute propagation mechanism requires `isRootSpan = true`.\nThe impact of this issue is that no server span in the trace contains the http.route attribute breaking trace visibility and trace derived metrics. Next.js is the router in this case and there is no way to set the matched route on either the next.js server span or the custom server's server span.\n\n## The Actual Issue\n\nNext.js creates the `handleRequest` span at `packages/next/src/server/base-server.ts:869-871`:\n\n```typescript\nreturn tracer.withPropagatedContext(req.headers, () => {\n  return tracer.trace(BaseServerSpan.handleRequest, {...}, async (span) => {\n    // This span IS created, but...\n```\n\nHowever, the `rootSpanAttributesStore` is only initialized when `isRootSpan = true` at `packages/next/src/server/lib/trace/tracer.ts:337-347`:\n\n```typescript\nif (isRootSpan) {\n  rootSpanAttributesStore.set(spanId, new Map(...))\n}\n```\n\nWith a custom server parent span:\n\n- `isRootSpan = false` (because there's a parent context)\n- No entry is added to `rootSpanAttributesStore` for this spanId\n- The spanId is never stored in the context via `rootSpanIdKey`\n\n## Root Span Detection Logic\n\n`packages/next/src/server/lib/trace/tracer.ts:284-295`:\n\n```typescript\nlet spanContext = this.getSpanContext(\n  options?.parentSpan ?? this.getActiveScopeSpan()\n)\nlet isRootSpan = false\n\nif (!spanContext) {\n  spanContext = context?.active() ?? ROOT_CONTEXT\n  isRootSpan = true\n} else if (trace.getSpanContext(spanContext)?.isRemote) {\n  isRootSpan = true\n}\n```\n\nWhen a custom server propagates its span:\n\n1. Next.js extracts the remote context via `withPropagatedContext()` at `packages/next/src/server/base-server.ts:867`\n2. `spanContext` is NOT falsy because there's a parent span from the custom server\n3. The `isRemote` check may not properly identify the extracted context, OR the span is not marked as remote\n4. `isRootSpan` remains `false`\n\n## Why Attribute Propagation Fails\n\nWhen child spans call `setRootSpanAttribute('next.route', pathname)` at these locations:\n\n- `packages/next/src/server/base-server.ts:2458`\n- `packages/next/src/server/render.tsx:1427`\n- `packages/next/src/server/app-render/app-render.tsx:1710`\n- `packages/next/src/server/route-modules/app-route/module.ts:781`\n- `packages/next/src/server/api-utils/index.ts:77`\n\nThey try to retrieve the root span ID from context at `packages/next/src/server/lib/trace/tracer.ts:456-462`:\n\n```typescript\npublic setRootSpanAttribute(key: AttributeNames, value: AttributeValue) {\n  const spanId = context.active().getValue(rootSpanIdKey) as number  // undefined!\n  const attributes = rootSpanAttributesStore.get(spanId)  // store has no entry\n  if (attributes && !attributes.has(key)) {\n    attributes.set(key, value)\n  }\n}\n```\n\nSince `rootSpanIdKey` was never set in the context (only happens at `packages/next/src/server/lib/trace/tracer.ts:305` when `isRootSpan = true`), and the store has no entry for this span, the attributes can't be propagated to the Next.js span.\n\n## Failed Attribute Retrieval\n\nWhen the request completes, `packages/next/src/server/base-server.ts:898-899` tries to retrieve the attributes:\n\n```typescript\nconst rootSpanAttributes = tracer.getRootSpanAttributes()\nif (!rootSpanAttributes) return // Returns early, route never gets set\n```\n\n`getRootSpanAttributes()` at `packages/next/src/server/lib/trace/tracer.ts:451-454`:\n\n```typescript\npublic getRootSpanAttributes() {\n  const spanId = context.active().getValue(rootSpanIdKey) as number  // undefined!\n  return rootSpanAttributesStore.get(spanId)  // returns undefined\n}\n```\n\n## Root Cause\n\nNext.js conflates \"root span\" (no parent) with \"span where we should store propagated attributes\". With a custom server:\n\n- Next.js's `handleRequest` span has a parent (the custom server's span)\n- So it's not treated as a root span (`isRootSpan = false`)\n- But it still needs the attribute store initialized to collect route information from child spans\n- The attributes should be going to Next.js's `handleRequest` span, but the propagation mechanism is disabled because that span isn't flagged as a root span\n\n## Impact\n\nThe Next.js `handleRequest` span is created but lacks critical attributes:\n\n- `next.route` is not set\n- `http.route` is not set\n- Span name remains generic (e.g., `GET` instead of `GET /api/users`)\n- Observability is significantly degraded and breaks trace metrics in providers like Datadog","closed_by":{"login":"ijjk","id":22380829,"node_id":"MDQ6VXNlcjIyMzgwODI5","avatar_url":"https://avatars.githubusercontent.com/u/22380829?v=4","gravatar_id":"","url":"https://api.github.com/users/ijjk","html_url":"https://github.com/ijjk","followers_url":"https://api.github.com/users/ijjk/followers","following_url":"https://api.github.com/users/ijjk/following{/other_user}","gists_url":"https://api.github.com/users/ijjk/gists{/gist_id}","starred_url":"https://api.github.com/users/ijjk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ijjk/subscriptions","organizations_url":"https://api.github.com/users/ijjk/orgs","repos_url":"https://api.github.com/users/ijjk/repos","events_url":"https://api.github.com/users/ijjk/events{/privacy}","received_events_url":"https://api.github.com/users/ijjk/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/vercel/next.js/issues/85520/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/vercel/next.js/issues/85520/timeline","performed_via_github_app":null,"state_reason":"completed"}