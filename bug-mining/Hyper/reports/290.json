{"url":"https://api.github.com/repos/hyperium/hyper/issues/3253","repository_url":"https://api.github.com/repos/hyperium/hyper","labels_url":"https://api.github.com/repos/hyperium/hyper/issues/3253/labels{/name}","comments_url":"https://api.github.com/repos/hyperium/hyper/issues/3253/comments","events_url":"https://api.github.com/repos/hyperium/hyper/issues/3253/events","html_url":"https://github.com/hyperium/hyper/issues/3253","id":1760916483,"node_id":"I_kwDOAWaYQc5o9XQD","number":3253,"title":"Missing error when reading stream of data out of an interrupted chunked-encoded request","user":{"login":"Lupus","id":105348,"node_id":"MDQ6VXNlcjEwNTM0OA==","avatar_url":"https://avatars.githubusercontent.com/u/105348?v=4","gravatar_id":"","url":"https://api.github.com/users/Lupus","html_url":"https://github.com/Lupus","followers_url":"https://api.github.com/users/Lupus/followers","following_url":"https://api.github.com/users/Lupus/following{/other_user}","gists_url":"https://api.github.com/users/Lupus/gists{/gist_id}","starred_url":"https://api.github.com/users/Lupus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Lupus/subscriptions","organizations_url":"https://api.github.com/users/Lupus/orgs","repos_url":"https://api.github.com/users/Lupus/repos","events_url":"https://api.github.com/users/Lupus/events{/privacy}","received_events_url":"https://api.github.com/users/Lupus/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":125710197,"node_id":"MDU6TGFiZWwxMjU3MTAxOTc=","url":"https://api.github.com/repos/hyperium/hyper/labels/C-bug","name":"C-bug","color":"d93f0b","default":false,"description":"Category: bug. Something is wrong. This is bad!"},{"id":694496799,"node_id":"MDU6TGFiZWw2OTQ0OTY3OTk=","url":"https://api.github.com/repos/hyperium/hyper/labels/E-medium","name":"E-medium","color":"c2e0c6","default":false,"description":"Effort: medium. Some knowledge of how hyper internal works would be useful."},{"id":956795692,"node_id":"MDU6TGFiZWw5NTY3OTU2OTI=","url":"https://api.github.com/repos/hyperium/hyper/labels/A-http1","name":"A-http1","color":"fbca04","default":false,"description":"Area: HTTP/1 specific."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2023-06-16T16:07:55Z","updated_at":"2023-06-20T05:33:22Z","closed_at":"2023-06-19T18:31:24Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Version**\r\nhyper 0.14.26\r\ntokio 1.28.1\r\n\r\n**Platform**\r\n```Linux my-hostname 5.10.0-18-amd64 #1 SMP Debian 5.10.140-1 (2022-09-02) x86_64 GNU/Linux```\r\n\r\n\r\n**Description**\r\n\r\nError is not propagated via stream in some cases when client drops the connection during chunked-encoding stream.\r\n\r\nI tried this code:\r\n\r\n```rust\r\nuse futures_util::stream::StreamExt;\r\nuse hyper::service::{make_service_fn, service_fn};\r\nuse hyper::{Body, Request, Response, Server};\r\nuse tokio::sync::mpsc;\r\nuse tokio::time::{sleep, Duration};\r\n\r\nasync fn echo(mut req: Request<Body>) -> Result<Response<Body>, hyper::Error> {\r\n    println!(\"reading body!\");\r\n\r\n    // Create a channel to communicate between the reading and responding tasks\r\n    let (tx, rx) = mpsc::channel::<Vec<u8>>(1);\r\n\r\n    // Spawn a task to read the request body and discard it\r\n    tokio::spawn(async move {\r\n        while let Some(maybe_chunk) = req.body_mut().next().await {\r\n            match maybe_chunk {\r\n                Ok(chunk) => {\r\n                    // Uncomment me!\r\n                    // sleep(Duration::from_millis(100)).await;\r\n                    let _ = tx.send(chunk.to_vec()).await;\r\n                }\r\n\r\n                Err(err) => {\r\n                    println!(\"Got error: {}\", err);\r\n                }\r\n            }\r\n        }\r\n        println!(\"finished reading body!\");\r\n    });\r\n\r\n    // Create a response with a data stream that is filled by the reading task\r\n    let stream = tokio_stream::wrappers::ReceiverStream::new(rx);\r\n    let response = Response::builder()\r\n        .body(Body::wrap_stream(stream.map(Result::<_, hyper::Error>::Ok)))\r\n        .expect(\"Failed to build response\");\r\n\r\n    Ok(response)\r\n}\r\n\r\n#[tokio::main]\r\nasync fn main() -> Result<(), Box<dyn std::error::Error + Send + Sync>> {\r\n    let addr = ([0, 0, 0, 0], 3000).into();\r\n\r\n    let service = make_service_fn(|_| async { Ok::<_, hyper::Error>(service_fn(echo)) });\r\n\r\n    let server = Server::bind(&addr).serve(service);\r\n\r\n    println!(\"Listening on http://{}\", addr);\r\n\r\n    server.await?;\r\n\r\n    Ok(())\r\n}\r\n```\r\n\r\nCargo.toml dependencies:\r\n\r\n```toml\r\n[dependencies]\r\ntokio = { version = \"1\", features = [\"full\"] }\r\nhyper = { version=\"0.14\", features=[\"full\"] }\r\nhttp = \"*\"\r\nfutures = \"*\"\r\nfutures-util = \"0.3.28\"\r\ntokio-stream = \"0.1.14\"\r\n```\r\n\r\nService above is an echo-server, which sends back the stream of data that it receives. To get the repro, please launch the service, and on another terminal start the \"endless\" curl command like this:\r\n\r\n```\r\n$ cat /dev/zero | curl -XPOST http://127.0.0.1:3000/ -H \"Transfer-Encoding: chunked\" -T - -o /dev/null\r\n```\r\n\r\nIt will read `/dev/zero`, pipe it to curl, which will send it as data stream with chunked transfer encoding, sending the output stream to `/dev/null`.\r\n\r\nAfter some time, terminate curl with `Ctrl+C`. Service reports the error on the stream as expected, terminal output will look like this:\r\n\r\n```\r\nListening on http://0.0.0.0:3000\r\nreading body!\r\nGot error: error reading a body from connection: Connection reset by peer (os error 104)\r\nfinished reading body!\r\n```\r\n\r\nBut if we uncomment the sleep line, and repeat the experiment, there will be no error, as indicated by service output:\r\n\r\n```\r\nListening on http://0.0.0.0:3000\r\nreading body!\r\nfinished reading body!\r\n```\r\n\r\nI'm observing this weird behavior on a larger codebase that does approximately the same as sample server presented above.\r\n\r\nOne more interesting observation, even when sleep is in place, it does not repro (i.e. error is reported properly) with this netcat:\r\n\r\n```\r\n$ echo -ne \"GET /echo-buffer HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\nTransfer-Encoding: chunked\\r\\n\\r\\n6\\r\\naabbcc\" | nc localhos\r\nt 3000; echo\r\nHTTP/1.1 200 OK\r\ntransfer-encoding: chunked\r\ndate: Fri, 16 Jun 2023 16:04:58 GMT\r\n\r\n6\r\naabbcc\r\n^C\r\n```\r\n\r\nMy larger codebase also works as expected with netcat. Is there a race somewhere?","closed_by":{"login":"seanmonstar","id":51479,"node_id":"MDQ6VXNlcjUxNDc5","avatar_url":"https://avatars.githubusercontent.com/u/51479?v=4","gravatar_id":"","url":"https://api.github.com/users/seanmonstar","html_url":"https://github.com/seanmonstar","followers_url":"https://api.github.com/users/seanmonstar/followers","following_url":"https://api.github.com/users/seanmonstar/following{/other_user}","gists_url":"https://api.github.com/users/seanmonstar/gists{/gist_id}","starred_url":"https://api.github.com/users/seanmonstar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/seanmonstar/subscriptions","organizations_url":"https://api.github.com/users/seanmonstar/orgs","repos_url":"https://api.github.com/users/seanmonstar/repos","events_url":"https://api.github.com/users/seanmonstar/events{/privacy}","received_events_url":"https://api.github.com/users/seanmonstar/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/hyperium/hyper/issues/3253/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/hyperium/hyper/issues/3253/timeline","performed_via_github_app":null,"state_reason":"completed"}