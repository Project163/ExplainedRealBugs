{"url":"https://api.github.com/repos/hyperium/hyper/issues/3369","repository_url":"https://api.github.com/repos/hyperium/hyper","labels_url":"https://api.github.com/repos/hyperium/hyper/issues/3369/labels{/name}","comments_url":"https://api.github.com/repos/hyperium/hyper/issues/3369/comments","events_url":"https://api.github.com/repos/hyperium/hyper/issues/3369/events","html_url":"https://github.com/hyperium/hyper/issues/3369","id":1957336599,"node_id":"I_kwDOAWaYQc50qpYX","number":3369,"title":"C API deadlock in hyper_executor::poll_next","user":{"login":"jsha","id":220205,"node_id":"MDQ6VXNlcjIyMDIwNQ==","avatar_url":"https://avatars.githubusercontent.com/u/220205?v=4","gravatar_id":"","url":"https://api.github.com/users/jsha","html_url":"https://github.com/jsha","followers_url":"https://api.github.com/users/jsha/followers","following_url":"https://api.github.com/users/jsha/following{/other_user}","gists_url":"https://api.github.com/users/jsha/gists{/gist_id}","starred_url":"https://api.github.com/users/jsha/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jsha/subscriptions","organizations_url":"https://api.github.com/users/jsha/orgs","repos_url":"https://api.github.com/users/jsha/repos","events_url":"https://api.github.com/users/jsha/events{/privacy}","received_events_url":"https://api.github.com/users/jsha/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":125710197,"node_id":"MDU6TGFiZWwxMjU3MTAxOTc=","url":"https://api.github.com/repos/hyperium/hyper/labels/C-bug","name":"C-bug","color":"d93f0b","default":false,"description":"Category: bug. Something is wrong. This is bad!"},{"id":154002675,"node_id":"MDU6TGFiZWwxNTQwMDI2NzU=","url":"https://api.github.com/repos/hyperium/hyper/labels/E-easy","name":"E-easy","color":"0e8a16","default":false,"description":"Effort: easy. A task that would be a great starting point for a new contributor."},{"id":2640844074,"node_id":"MDU6TGFiZWwyNjQwODQ0MDc0","url":"https://api.github.com/repos/hyperium/hyper/labels/A-ffi","name":"A-ffi","color":"fbca04","default":false,"description":"Area: ffi (C API)"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2023-10-23T14:39:51Z","updated_at":"2024-01-12T17:50:25Z","closed_at":"2023-10-23T17:53:52Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Version: current master, dd638b5b34225d2c5ad0bd01de0ecf738f9a0e12\r\nPlatform: Linux 6.2.0-34-generic #34-Ubuntu SMP PREEMPT_DYNAMIC Mon Sep  4 13:06:55 UTC 2023 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\nIn https://github.com/curl/curl/issues/11203#issuecomment-1733313614, @marlonbaeten reported that removing `hyper_clientconn_free(client);` from curl's c-hyper code caused curl to never send the request.\r\n\r\nI did a little poking around and I believe what's happening is a deadlock. I'm not sure yet why freeing the client triggers the deadlock, but I can see in the Hyper code where it happens.\r\n\r\nIn hyper_executor::poll_next, `self.driver` is locked and then `drain_queue` is called :\r\n\r\nhttps://github.com/hyperium/hyper/blob/dd638b5b34225d2c5ad0bd01de0ecf738f9a0e12/src/ffi/task.rs#L129-L134\r\n\r\n`drain_queue` then tries to lock `self.driver` a second time:\r\n\r\nhttps://github.com/hyperium/hyper/blob/dd638b5b34225d2c5ad0bd01de0ecf738f9a0e12/src/ffi/task.rs#L151-L156\r\n\r\nThe docs for [Mutex::lock](https://doc.rust-lang.org/std/sync/struct.Mutex.html#method.lock) say:\r\n\r\n> The exact behavior on locking a mutex in the thread which already holds the lock is left unspecified. However, this function will not return on the second call (it might panic or deadlock, for example).\r\n\r\nSteps to reproduce:\r\n\r\nBuild Hyper's FFI library using this patch to add some println debugging lines:\r\n\r\n```patch\r\ndiff --git a/src/ffi/task.rs b/src/ffi/task.rs\r\nindex e75dfc1a..e868f39d 100644\r\n--- a/src/ffi/task.rs\r\n+++ b/src/ffi/task.rs\r\n@@ -131,6 +131,7 @@ impl hyper_executor {\r\n                 Poll::Pending => {\r\n                     // Check if any of the pending tasks tried to spawn\r\n                     // some new tasks. If so, drain into the driver and loop.\r\n+                    eprintln!(\"draining queue??\");\r\n                     if self.drain_queue() {\r\n                         continue;\r\n                     }\r\n@@ -149,11 +150,14 @@ impl hyper_executor {\r\n \r\n     fn drain_queue(&self) -> bool {\r\n         let mut queue = self.spawn_queue.lock().unwrap();\r\n+        eprintln!(\"locked spawn queue :D\");\r\n         if queue.is_empty() {\r\n             return false;\r\n         }\r\n \r\n+        eprintln!(\"trying to lock driver. this might deadlock :/\");\r\n         let driver = self.driver.lock().unwrap();\r\n+        eprintln!(\"locked driver! :D :D :D\");\r\n \r\n         for task in queue.drain(..) {\r\n             driver.push(task);\r\n```\r\n\r\nBuild curl against that version of Hyper's FFI library, using this patch against curl:\r\n\r\n```patch\r\ndiff --git a/lib/c-hyper.c b/lib/c-hyper.c\r\nindex 5726ff1cc..7a5e764c8 100644\r\n--- a/lib/c-hyper.c\r\n+++ b/lib/c-hyper.c\r\n@@ -1214,9 +1214,6 @@ CURLcode Curl_http(struct Curl_easy *data, bool *done)\r\n   }\r\n   sendtask = NULL; /* ownership passed on */\r\n \r\n-  hyper_clientconn_free(client);\r\n-  client = NULL;\r\n-\r\n   if((httpreq == HTTPREQ_GET) || (httpreq == HTTPREQ_HEAD)) {\r\n     /* HTTP GET/HEAD download */\r\n     Curl_pgrsSetUploadSize(data, 0); /* nothing */\r\n```\r\n\r\nObserve this output, followed by a hang:\r\n\r\n```\r\n$ ~/curl/src/curl https://example.com/\r\nlocked spawn queue :D\r\ntrying to lock driver. this might deadlock :/\r\nlocked driver! :D :D :D\r\nlocked spawn queue :D\r\ntrying to lock driver. this might deadlock :/\r\nlocked driver! :D :D :D\r\ndraining queue??\r\nlocked spawn queue :D\r\ntrying to lock driver. this might deadlock :/\r\n```","closed_by":{"login":"seanmonstar","id":51479,"node_id":"MDQ6VXNlcjUxNDc5","avatar_url":"https://avatars.githubusercontent.com/u/51479?v=4","gravatar_id":"","url":"https://api.github.com/users/seanmonstar","html_url":"https://github.com/seanmonstar","followers_url":"https://api.github.com/users/seanmonstar/followers","following_url":"https://api.github.com/users/seanmonstar/following{/other_user}","gists_url":"https://api.github.com/users/seanmonstar/gists{/gist_id}","starred_url":"https://api.github.com/users/seanmonstar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/seanmonstar/subscriptions","organizations_url":"https://api.github.com/users/seanmonstar/orgs","repos_url":"https://api.github.com/users/seanmonstar/repos","events_url":"https://api.github.com/users/seanmonstar/events{/privacy}","received_events_url":"https://api.github.com/users/seanmonstar/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/hyperium/hyper/issues/3369/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":1,"eyes":0},"timeline_url":"https://api.github.com/repos/hyperium/hyper/issues/3369/timeline","performed_via_github_app":null,"state_reason":"completed"}