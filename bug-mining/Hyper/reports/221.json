{"url":"https://api.github.com/repos/hyperium/hyper/issues/2114","repository_url":"https://api.github.com/repos/hyperium/hyper","labels_url":"https://api.github.com/repos/hyperium/hyper/issues/2114/labels{/name}","comments_url":"https://api.github.com/repos/hyperium/hyper/issues/2114/comments","events_url":"https://api.github.com/repos/hyperium/hyper/issues/2114/events","html_url":"https://github.com/hyperium/hyper/issues/2114","id":554472694,"node_id":"MDU6SXNzdWU1NTQ0NzI2OTQ=","number":2114,"title":"'assertion failed: self.upgrade.is_none()' when reusing connection with ignored upgrade header","user":{"login":"ggriffiniii","id":7447,"node_id":"MDQ6VXNlcjc0NDc=","avatar_url":"https://avatars.githubusercontent.com/u/7447?v=4","gravatar_id":"","url":"https://api.github.com/users/ggriffiniii","html_url":"https://github.com/ggriffiniii","followers_url":"https://api.github.com/users/ggriffiniii/followers","following_url":"https://api.github.com/users/ggriffiniii/following{/other_user}","gists_url":"https://api.github.com/users/ggriffiniii/gists{/gist_id}","starred_url":"https://api.github.com/users/ggriffiniii/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ggriffiniii/subscriptions","organizations_url":"https://api.github.com/users/ggriffiniii/orgs","repos_url":"https://api.github.com/users/ggriffiniii/repos","events_url":"https://api.github.com/users/ggriffiniii/events{/privacy}","received_events_url":"https://api.github.com/users/ggriffiniii/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":125710197,"node_id":"MDU6TGFiZWwxMjU3MTAxOTc=","url":"https://api.github.com/repos/hyperium/hyper/labels/C-bug","name":"C-bug","color":"d93f0b","default":false,"description":"Category: bug. Something is wrong. This is bad!"},{"id":956795692,"node_id":"MDU6TGFiZWw5NTY3OTU2OTI=","url":"https://api.github.com/repos/hyperium/hyper/labels/A-http1","name":"A-http1","color":"fbca04","default":false,"description":"Area: HTTP/1 specific."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2020-01-23T23:48:51Z","updated_at":"2020-01-24T17:51:41Z","closed_at":"2020-01-24T00:41:41Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hyper threads panic (though the server remains running) when a client makes multiple requests with an upgrade header (which hyper ignores). The first request is handled without issue, but when the second request is made the hyper thread panics and the connection is terminated.\r\n\r\nSteps to reproduce:\r\n\r\n * Run the hello world example\r\n   * `cargo run --example hello`\r\n * issue multiple requests over the same connection with an Upgrade header.\r\n  * `curl -v -H \"Connection: Upgrade\" -H \"Upgrade: foo\" http://127.0.0.1:3000 http://127.0.0.1:3000`\r\n\r\nThe hyper output:\r\n```\r\nListening on http://127.0.0.1:3000\r\nthread 'main' panicked at 'assertion failed: self.upgrade.is_none()', src/proto/h1/conn.rs:905:9\r\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace.\r\n```\r\n\r\nThe curl output:\r\n```\r\n*   Trying 127.0.0.1:3000...\r\n* TCP_NODELAY set\r\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\r\n                                 Dload  Upload   Total   Spent    Left  Speed\r\n\r\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0* Connected to 127.0.0.1 (127.0.0.1) port 3000 (#0)\r\n> GET / HTTP/1.1\r\n> Host: 127.0.0.1:3000\r\n> User-Agent: curl/7.66.0\r\n> Accept: */*\r\n> Connection: Upgrade\r\n> Upgrade: foo\r\n> \r\n* Mark bundle as not supporting multiuse\r\n< HTTP/1.1 200 OK\r\n< content-length: 12\r\n< date: Thu, 23 Jan 2020 23:45:26 GMT\r\n< \r\n{ [12 bytes data]\r\n\r\n100    12  100    12    0     0  12000      0 --:--:-- --:--:-- --:--:-- 12000\r\n* Connection #0 to host 127.0.0.1 left intact\r\nHello World!* Found bundle for host 127.0.0.1: 0x5649a99f0170 [serially]\r\n* Can not multiplex, even if we wanted to!\r\n* Re-using existing connection! (#0) with host 127.0.0.1\r\n* Connected to 127.0.0.1 (127.0.0.1) port 3000 (#0)\r\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\r\n                                 Dload  Upload   Total   Spent    Left  Speed\r\n\r\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0> GET / HTTP/1.1\r\n> Host: 127.0.0.1:3000\r\n> User-Agent: curl/7.66.0\r\n> Accept: */*\r\n> Connection: Upgrade\r\n> Upgrade: foo\r\n> \r\n* Connection died, retrying a fresh connect\r\n\r\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0\r\n* Closing connection 0\r\n* Issue another request to this URL: 'http://127.0.0.1:3000/'\r\n* Hostname 127.0.0.1 was found in DNS cache\r\n*   Trying 127.0.0.1:3000...\r\n* TCP_NODELAY set\r\n* Connected to 127.0.0.1 (127.0.0.1) port 3000 (#1)\r\n> GET / HTTP/1.1\r\n> Host: 127.0.0.1:3000\r\n> User-Agent: curl/7.66.0\r\n> Accept: */*\r\n> Connection: Upgrade\r\n> Upgrade: foo\r\n> \r\n* Mark bundle as not supporting multiuse\r\n< HTTP/1.1 200 OK\r\n< content-length: 12\r\n< date: Thu, 23 Jan 2020 23:45:26 GMT\r\n< \r\n{ [12 bytes data]\r\n\r\n100    12  100    12    0     0  12000      0 --:--:-- --:--:-- --:--:-- 12000\r\n* Connection #1 to host 127.0.0.1 left intact\r\nHello World!\r\n```\r\n\r\nYou can see that the connection dies when the second request is issued (corresponding to the panic in the hyper output), curl then establishes a new connection and reissues the request which succeeds.","closed_by":{"login":"seanmonstar","id":51479,"node_id":"MDQ6VXNlcjUxNDc5","avatar_url":"https://avatars.githubusercontent.com/u/51479?v=4","gravatar_id":"","url":"https://api.github.com/users/seanmonstar","html_url":"https://github.com/seanmonstar","followers_url":"https://api.github.com/users/seanmonstar/followers","following_url":"https://api.github.com/users/seanmonstar/following{/other_user}","gists_url":"https://api.github.com/users/seanmonstar/gists{/gist_id}","starred_url":"https://api.github.com/users/seanmonstar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/seanmonstar/subscriptions","organizations_url":"https://api.github.com/users/seanmonstar/orgs","repos_url":"https://api.github.com/users/seanmonstar/repos","events_url":"https://api.github.com/users/seanmonstar/events{/privacy}","received_events_url":"https://api.github.com/users/seanmonstar/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/hyperium/hyper/issues/2114/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/hyperium/hyper/issues/2114/timeline","performed_via_github_app":null,"state_reason":"completed"}