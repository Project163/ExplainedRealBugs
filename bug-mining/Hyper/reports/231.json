{"url":"https://api.github.com/repos/hyperium/hyper/issues/2310","repository_url":"https://api.github.com/repos/hyperium/hyper","labels_url":"https://api.github.com/repos/hyperium/hyper/issues/2310/labels{/name}","comments_url":"https://api.github.com/repos/hyperium/hyper/issues/2310/comments","events_url":"https://api.github.com/repos/hyperium/hyper/issues/2310/events","html_url":"https://github.com/hyperium/hyper/issues/2310","id":728873007,"node_id":"MDU6SXNzdWU3Mjg4NzMwMDc=","number":2310,"title":"Only one HTTP2 Ping is sent with keep alive enabled","user":{"login":"pdcalado","id":1388991,"node_id":"MDQ6VXNlcjEzODg5OTE=","avatar_url":"https://avatars.githubusercontent.com/u/1388991?v=4","gravatar_id":"","url":"https://api.github.com/users/pdcalado","html_url":"https://github.com/pdcalado","followers_url":"https://api.github.com/users/pdcalado/followers","following_url":"https://api.github.com/users/pdcalado/following{/other_user}","gists_url":"https://api.github.com/users/pdcalado/gists{/gist_id}","starred_url":"https://api.github.com/users/pdcalado/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pdcalado/subscriptions","organizations_url":"https://api.github.com/users/pdcalado/orgs","repos_url":"https://api.github.com/users/pdcalado/repos","events_url":"https://api.github.com/users/pdcalado/events{/privacy}","received_events_url":"https://api.github.com/users/pdcalado/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":125710197,"node_id":"MDU6TGFiZWwxMjU3MTAxOTc=","url":"https://api.github.com/repos/hyperium/hyper/labels/C-bug","name":"C-bug","color":"d93f0b","default":false,"description":"Category: bug. Something is wrong. This is bad!"},{"id":956796120,"node_id":"MDU6TGFiZWw5NTY3OTYxMjA=","url":"https://api.github.com/repos/hyperium/hyper/labels/A-http2","name":"A-http2","color":"fbca04","default":false,"description":"Area: HTTP/2 specific."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2020-10-24T20:43:15Z","updated_at":"2020-10-29T16:02:29Z","closed_at":"2020-10-29T16:02:29Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I believe there is a bug in the HTTP2 keep alive implementation, more concretely in `src/proto/h2/ping.rs`.\r\n\r\nThis issue was originally detected in https://github.com/hyperium/tonic/issues/474, credits to @alce.\r\n\r\nIt seems that when enabling HTTP2 server keep alive, only the first Ping is sent after the configured interval.\r\nAfterwards, no more Pings seem to be sent.\r\n\r\n## How to reproduce\r\n\r\nI'm applying the following changes to the `echo` example:\r\n\r\n```diff\r\n--- a/examples/echo.rs\r\n+++ b/examples/echo.rs\r\n@@ -14,7 +14,10 @@ async fn echo(req: Request<Body>) -> Result<Response<Body>, hyper::Er>\r\n         ))),\r\n \r\n         // Simply echo the body back to the client.\r\n-        (&Method::POST, \"/echo\") => Ok(Response::new(req.into_body())),\r\n+        (&Method::POST, \"/echo\") => {\r\n+           tokio::time::delay_for(std::time::Duration::from_secs(60)).await;\r\n+           Ok(Response::new(req.into_body()))\r\n+       },\r\n \r\n         // Convert to uppercase before sending back to client using a stream.\r\n         (&Method::POST, \"/echo/uppercase\") => {\r\n@@ -55,7 +58,10 @@ async fn main() -> Result<(), Box<dyn std::error::Error + Send + Sync>\r\n \r\n     let service = make_service_fn(|_| async { Ok::<_, hyper::Error>(service_fn(echo)) }>\r\n \r\n-    let server = Server::bind(&addr).serve(service);\r\n+    let server = Server::bind(&addr)\r\n+       .http2_keep_alive_interval(std::time::Duration::from_secs(10))\r\n+       .http2_keep_alive_timeout(std::time::Duration::from_secs(5))\r\n+       .serve(service);\r\n \r\n     println!(\"Listening on http://{}\", addr);\r\n```\r\n\r\nRunning the example with `cargo run --example echo`, sniffing with `tcpdump -i lo port 3000`, and making a request with `curl -v --http2-prior-knowledge http://localhost:3000/echo --data \"foo\"`, I get the following:\r\n\r\n```tcpdump\r\n20:03:21.621105 IP localhost.hbci > localhost.46506: Flags [P.], seq 22:44, ack 160, win 512, options [nop,nop,TS val 2305866698 ecr 2305866696], length 22\r\n20:03:21.621120 IP localhost.46506 > localhost.hbci: Flags [.], ack 44, win 512, options [nop,nop,TS val 2305866698 ecr 2305866698], length 0\r\n\r\n20:03:31.623825 IP localhost.hbci > localhost.46506: Flags [P.], seq 44:61, ack 160, win 512, options [nop,nop,TS val 2305876700 ecr 2305866698], length 17\r\n20:03:31.623854 IP localhost.46506 > localhost.hbci: Flags [.], ack 61, win 512, options [nop,nop,TS val 2305876700 ecr 2305876700], length 0\r\n20:03:31.623926 IP localhost.46506 > localhost.hbci: Flags [P.], seq 160:177, ack 61, win 512, options [nop,nop,TS val 2305876701 ecr 2305876700], length 17\r\n20:03:31.623948 IP localhost.hbci > localhost.46506: Flags [.], ack 177, win 512, options [nop,nop,TS val 2305876701 ecr 2305876701], length 0\r\n\r\n20:04:21.624549 IP localhost.hbci > localhost.46506: Flags [P.], seq 61:111, ack 177, win 512, options [nop,nop,TS val 2305926701 ecr 2305876701], length 50\r\n20:04:21.624593 IP localhost.46506 > localhost.hbci: Flags [.], ack 111, win 512, options [nop,nop,TS val 2305926701 ecr 2305926701], length 0\r\n20:04:21.625177 IP localhost.46506 > localhost.hbci: Flags [F.], seq 177, ack 111, win 512, options [nop,nop,TS val 2305926702 ecr 2305926701], length 0\r\n20:04:21.625825 IP localhost.hbci > localhost.46506: Flags [F.], seq 111, ack 178, win 512, options [nop,nop,TS val 2305926702 ecr 2305926702], length 0\r\n20:04:21.625858 IP localhost.46506 > localhost.hbci: Flags [.], ack 112, win 512, options [nop,nop,TS val 2305926702 ecr 2305926702], length 0\r\n```\r\n\r\nThe **first batch** of packets belongs to the start of the request, the **second batch** is the first Ping+Pong, the **third batch** is the end of the request. As you can see the keep alive interval of 10seconds separates the first two batches. However no more pings occur between the second and last batch, as I would expect.\r\n\r\nAfter taking a look at `src/proto/h2/ping.rs` and debugging a bit, it seems that once `KeepAlive` enters the state `KeepAliveState::PingSent` it does not go back to `KeepAliveState::Scheduled`, even after a Pong is received.\r\n\r\nA possible fix would be to check if `ping_sent_at` has been cleared when the `KeepAlive::scheduled()` method is called:\r\n\r\n```diff\r\n--- a/src/proto/h2/ping.rs\r\n+++ b/src/proto/h2/ping.rs\r\n@@ -442,7 +442,16 @@ impl KeepAlive {\r\n                 let interval = shared.last_read_at() + self.interval;\r\n                 self.timer.reset(interval);\r\n             }\r\n-            KeepAliveState::Scheduled | KeepAliveState::PingSent => (),\r\n+            KeepAliveState::PingSent => {\r\n+                if shared.is_ping_sent() {\r\n+                    return;\r\n+                }\r\n+\r\n+                self.state = KeepAliveState::Scheduled;\r\n+                let interval = shared.last_read_at() + self.interval;\r\n+                self.timer.reset(interval);\r\n+            }\r\n+            KeepAliveState::Scheduled => (),\r\n         }\r\n     }\r\n```\r\n\r\nI'm not sure if this was the intended behavior of the original implementation.\r\nI'll be happy to submit a PR if agreed.\r\n\r\nThanks in advance and keep up the good work!\r\n","closed_by":{"login":"seanmonstar","id":51479,"node_id":"MDQ6VXNlcjUxNDc5","avatar_url":"https://avatars.githubusercontent.com/u/51479?v=4","gravatar_id":"","url":"https://api.github.com/users/seanmonstar","html_url":"https://github.com/seanmonstar","followers_url":"https://api.github.com/users/seanmonstar/followers","following_url":"https://api.github.com/users/seanmonstar/following{/other_user}","gists_url":"https://api.github.com/users/seanmonstar/gists{/gist_id}","starred_url":"https://api.github.com/users/seanmonstar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/seanmonstar/subscriptions","organizations_url":"https://api.github.com/users/seanmonstar/orgs","repos_url":"https://api.github.com/users/seanmonstar/repos","events_url":"https://api.github.com/users/seanmonstar/events{/privacy}","received_events_url":"https://api.github.com/users/seanmonstar/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/hyperium/hyper/issues/2310/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/hyperium/hyper/issues/2310/timeline","performed_via_github_app":null,"state_reason":"completed"}