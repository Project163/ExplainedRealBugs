{"url":"https://api.github.com/repos/hyperium/hyper/issues/2483","repository_url":"https://api.github.com/repos/hyperium/hyper","labels_url":"https://api.github.com/repos/hyperium/hyper/issues/2483/labels{/name}","comments_url":"https://api.github.com/repos/hyperium/hyper/issues/2483/comments","events_url":"https://api.github.com/repos/hyperium/hyper/issues/2483/events","html_url":"https://github.com/hyperium/hyper/issues/2483","id":842548224,"node_id":"MDU6SXNzdWU4NDI1NDgyMjQ=","number":2483,"title":"Errors running gen_header.sh","user":{"login":"kevinburke","id":234019,"node_id":"MDQ6VXNlcjIzNDAxOQ==","avatar_url":"https://avatars.githubusercontent.com/u/234019?v=4","gravatar_id":"","url":"https://api.github.com/users/kevinburke","html_url":"https://github.com/kevinburke","followers_url":"https://api.github.com/users/kevinburke/followers","following_url":"https://api.github.com/users/kevinburke/following{/other_user}","gists_url":"https://api.github.com/users/kevinburke/gists{/gist_id}","starred_url":"https://api.github.com/users/kevinburke/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kevinburke/subscriptions","organizations_url":"https://api.github.com/users/kevinburke/orgs","repos_url":"https://api.github.com/users/kevinburke/repos","events_url":"https://api.github.com/users/kevinburke/events{/privacy}","received_events_url":"https://api.github.com/users/kevinburke/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2021-03-27T16:12:58Z","updated_at":"2021-04-06T21:46:15Z","closed_at":"2021-04-06T21:46:15Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I'm trying to fix some of the errors you get when you run the curl test suite with the Hyper backend. I tried to pick an easy one to start - Curl expects you to return CURLE_UNSUPPORTED_PROTOCOL when a server returns HTTP/1.2, but Hyper/c-hyper.c currently doesn't. \r\n\r\nSo I wanted to add an extra constant to ffi/error.rs, which would let me read that constant in hyper-c.c in the Curl code and return the appropriate error.\r\n\r\n```diff\r\n--- a/src/ffi/error.rs\r\n+++ b/src/ffi/error.rs\r\n@@ -24,6 +24,8 @@ pub enum hyper_code {\r\n     HYPERE_FEATURE_NOT_ENABLED,\r\n     /// The peer sent an HTTP message that could not be parsed.\r\n     HYPERE_INVALID_PEER_MESSAGE,\r\n+    /// The peer sent an HTTP version header that we cannot parse\r\n+    HYPERE_INVALID_HTTP_VERSION,\r\n }\r\n\r\n // ===== impl hyper_error =====\r\n@@ -31,9 +33,11 @@ pub enum hyper_code {\r\n impl hyper_error {\r\n     fn code(&self) -> hyper_code {\r\n         use crate::error::Kind as ErrorKind;\r\n+        use crate::error::Parse;\r\n         use crate::error::User;\r\n\r\n         match self.0.kind() {\r\n+            ErrorKind::Parse(Parse::Version) => hyper_code::HYPERE_INVALID_HTTP_VERSION,\r\n             ErrorKind::Parse(_) => hyper_code::HYPERE_INVALID_PEER_MESSAGE,\r\n             ErrorKind::IncompleteMessage => hyper_code::HYPERE_UNEXPECTED_EOF,\r\n             ErrorKind::User(User::AbortedByCallback) => hyper_code::HYPERE_ABORTED_BY_CALLBACK,\r\n```\r\n\r\nHowever, in order to pick this up I need to run gen_header.sh. I ran into some errors running this script.\r\n\r\nFirst I wasn't using the nightly but because `cargo rustc -- -Z unstable-options --pretty=expanded` swallows errors I didn't see that that was the issue - I had to modify the script in order to get it to work. \r\n\r\nNow I'm running into this issue: \r\n\r\n```\r\n+ cargo rustc -- -Z unstable-options --pretty=expanded\r\n   Compiling hyper v0.0.0 (/private/var/folders/s1/909yt58s4wj8h_7v7frr8rkm0000gn/T/tmp.O3fSWUSrBt)\r\nerror: The `ffi` feature currently requires the `client` and `http1` features.\r\n  --> /Users/kevin/src/github.com/hyperium/hyper/capi/../src/ffi/mod.rs:37:1\r\n   |\r\n37 | compile_error!(\"The `ffi` feature currently requires the `client` and `http1` features.\");\r\n   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n```\r\n\r\nWhich I think is due to a poor interaction between the \"fake\" module and the \"real\" ffi module - I've been unsuccessful at modifying the `cargo rustc` to add those features. I can keep trying but my guess is that this is something that would take me an hour to fix and someone else two minutes to tell me the right place to look.","closed_by":{"login":"seanmonstar","id":51479,"node_id":"MDQ6VXNlcjUxNDc5","avatar_url":"https://avatars.githubusercontent.com/u/51479?v=4","gravatar_id":"","url":"https://api.github.com/users/seanmonstar","html_url":"https://github.com/seanmonstar","followers_url":"https://api.github.com/users/seanmonstar/followers","following_url":"https://api.github.com/users/seanmonstar/following{/other_user}","gists_url":"https://api.github.com/users/seanmonstar/gists{/gist_id}","starred_url":"https://api.github.com/users/seanmonstar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/seanmonstar/subscriptions","organizations_url":"https://api.github.com/users/seanmonstar/orgs","repos_url":"https://api.github.com/users/seanmonstar/repos","events_url":"https://api.github.com/users/seanmonstar/events{/privacy}","received_events_url":"https://api.github.com/users/seanmonstar/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/hyperium/hyper/issues/2483/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/hyperium/hyper/issues/2483/timeline","performed_via_github_app":null,"state_reason":"completed"}