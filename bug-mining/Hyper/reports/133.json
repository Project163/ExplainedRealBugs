{"url":"https://api.github.com/repos/hyperium/hyper/issues/1383","repository_url":"https://api.github.com/repos/hyperium/hyper","labels_url":"https://api.github.com/repos/hyperium/hyper/issues/1383/labels{/name}","comments_url":"https://api.github.com/repos/hyperium/hyper/issues/1383/comments","events_url":"https://api.github.com/repos/hyperium/hyper/issues/1383/events","html_url":"https://github.com/hyperium/hyper/issues/1383","id":276219900,"node_id":"MDU6SXNzdWUyNzYyMTk5MDA=","number":1383,"title":"All client connections are leaked when keep_alive(false)","user":{"login":"sfackler","id":1455697,"node_id":"MDQ6VXNlcjE0NTU2OTc=","avatar_url":"https://avatars.githubusercontent.com/u/1455697?v=4","gravatar_id":"","url":"https://api.github.com/users/sfackler","html_url":"https://github.com/sfackler","followers_url":"https://api.github.com/users/sfackler/followers","following_url":"https://api.github.com/users/sfackler/following{/other_user}","gists_url":"https://api.github.com/users/sfackler/gists{/gist_id}","starred_url":"https://api.github.com/users/sfackler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sfackler/subscriptions","organizations_url":"https://api.github.com/users/sfackler/orgs","repos_url":"https://api.github.com/users/sfackler/repos","events_url":"https://api.github.com/users/sfackler/events{/privacy}","received_events_url":"https://api.github.com/users/sfackler/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2017-11-22T22:20:26Z","updated_at":"2017-11-28T22:53:16Z","closed_at":"2017-11-28T22:53:16Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"```rust\r\nextern crate hyper;\r\nextern crate tokio_core;\r\nextern crate tokio_io;\r\nextern crate futures;\r\nextern crate env_logger;\r\n\r\nuse tokio_core::reactor::{Core, Timeout};\r\nuse tokio_core::net::TcpStream;\r\nuse tokio_io::{AsyncRead, AsyncWrite};\r\nuse hyper::{Client, Uri};\r\nuse hyper::client::HttpConnector;\r\nuse hyper::server::Service;\r\nuse std::time::Duration;\r\nuse std::cell::Cell;\r\nuse futures::{Future, Stream, stream};\r\nuse std::io::{self, Read, Write};\r\n\r\nfn main() {\r\n    env_logger::init().unwrap();\r\n\r\n    let mut core = Core::new().unwrap();\r\n    let handle = core.handle();\r\n\r\n    let client = Client::configure()\r\n        .connector(DebugConnector(HttpConnector::new(1, &handle), Cell::new(0)))\r\n        .no_proto()\r\n        .keep_alive(false)\r\n        .build(&handle);\r\n\r\n    let fut = stream::repeat(()).for_each(|()| {\r\n        client.get(\"http://www.google.com\".parse().unwrap())\r\n            .and_then(|resp| {\r\n                resp.body().collect()\r\n            })\r\n            .and_then(|_| {\r\n                let timeout = Timeout::new(Duration::from_secs(1), &handle).unwrap();\r\n                timeout.map_err(|e| e.into())\r\n            })\r\n            .map_err(|e| println!(\"error {}\", e))\r\n    });\r\n\r\n    core.run(fut).unwrap();\r\n}\r\n\r\nstruct DebugConnector(HttpConnector, Cell<u32>);\r\n\r\nimpl Service for DebugConnector {\r\n    type Request = Uri;\r\n    type Response = DebugStream;\r\n    type Error = io::Error;\r\n    type Future = Box<Future<Item = DebugStream, Error = io::Error>>;\r\n\r\n    fn call(&self, uri: Uri) -> Self::Future {\r\n        let id = self.1.get();\r\n        self.1.set(id + 1);\r\n        println!(\"new connection {}\", id);\r\n        Box::new(self.0.call(uri).map(move |s| DebugStream(s, id)))\r\n    }\r\n}\r\n\r\nstruct DebugStream(TcpStream, u32);\r\n\r\nimpl Drop for DebugStream {\r\n    fn drop(&mut self) {\r\n        println!(\"socket {} dropping\", self.1);\r\n    }\r\n}\r\n\r\nimpl Write for DebugStream {\r\n    fn write(&mut self, buf: &[u8]) -> io::Result<usize> {\r\n        self.0.write(buf)\r\n    }\r\n\r\n    fn flush(&mut self) -> io::Result<()> {\r\n        self.0.flush()\r\n    }\r\n}\r\n\r\nimpl AsyncWrite for DebugStream {\r\n    fn shutdown(&mut self) -> futures::Poll<(), io::Error> {\r\n        AsyncWrite::shutdown(&mut self.0)\r\n    }\r\n}\r\n\r\nimpl Read for DebugStream {\r\n    fn read(&mut self, buf: &mut [u8]) -> io::Result<usize> {\r\n        self.0.read(buf)\r\n    }\r\n}\r\n\r\nimpl AsyncRead for DebugStream {}\r\n```\r\n\r\n```\r\n~/foo ‚ùØ cargo run                                                                                                                                                                            [foo/master +%]\r\n   Compiling foo v0.1.0 (file:///Users/sfackler/foo)\r\n    Finished dev [unoptimized + debuginfo] target(s) in 5.28 secs\r\n     Running `target/debug/foo`\r\nnew connection 0\r\nnew connection 1\r\nnew connection 2\r\nnew connection 3\r\nnew connection 4\r\nnew connection 5\r\nnew connection 6\r\nnew connection 7\r\nnew connection 8\r\nnew connection 9\r\nnew connection 10\r\nnew connection 11\r\nnew connection 12\r\nnew connection 13\r\nnew connection 14\r\n...\r\n```\r\n\r\nThis happens both with and without no_proto","closed_by":{"login":"seanmonstar","id":51479,"node_id":"MDQ6VXNlcjUxNDc5","avatar_url":"https://avatars.githubusercontent.com/u/51479?v=4","gravatar_id":"","url":"https://api.github.com/users/seanmonstar","html_url":"https://github.com/seanmonstar","followers_url":"https://api.github.com/users/seanmonstar/followers","following_url":"https://api.github.com/users/seanmonstar/following{/other_user}","gists_url":"https://api.github.com/users/seanmonstar/gists{/gist_id}","starred_url":"https://api.github.com/users/seanmonstar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/seanmonstar/subscriptions","organizations_url":"https://api.github.com/users/seanmonstar/orgs","repos_url":"https://api.github.com/users/seanmonstar/repos","events_url":"https://api.github.com/users/seanmonstar/events{/privacy}","received_events_url":"https://api.github.com/users/seanmonstar/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/hyperium/hyper/issues/1383/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/hyperium/hyper/issues/1383/timeline","performed_via_github_app":null,"state_reason":"completed"}