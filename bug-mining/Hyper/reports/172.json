{"url":"https://api.github.com/repos/hyperium/hyper/issues/1566","repository_url":"https://api.github.com/repos/hyperium/hyper","labels_url":"https://api.github.com/repos/hyperium/hyper/issues/1566/labels{/name}","comments_url":"https://api.github.com/repos/hyperium/hyper/issues/1566/comments","events_url":"https://api.github.com/repos/hyperium/hyper/issues/1566/events","html_url":"https://github.com/hyperium/hyper/issues/1566","id":331761930,"node_id":"MDU6SXNzdWUzMzE3NjE5MzA=","number":1566,"title":"Change calls to tokio::spawn to use DefaultExecutor::current().execute() instead","user":{"login":"kpcyrd","id":7763184,"node_id":"MDQ6VXNlcjc3NjMxODQ=","avatar_url":"https://avatars.githubusercontent.com/u/7763184?v=4","gravatar_id":"","url":"https://api.github.com/users/kpcyrd","html_url":"https://github.com/kpcyrd","followers_url":"https://api.github.com/users/kpcyrd/followers","following_url":"https://api.github.com/users/kpcyrd/following{/other_user}","gists_url":"https://api.github.com/users/kpcyrd/gists{/gist_id}","starred_url":"https://api.github.com/users/kpcyrd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kpcyrd/subscriptions","organizations_url":"https://api.github.com/users/kpcyrd/orgs","repos_url":"https://api.github.com/users/kpcyrd/repos","events_url":"https://api.github.com/users/kpcyrd/events{/privacy}","received_events_url":"https://api.github.com/users/kpcyrd/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":154002675,"node_id":"MDU6TGFiZWwxNTQwMDI2NzU=","url":"https://api.github.com/repos/hyperium/hyper/labels/E-easy","name":"E-easy","color":"0e8a16","default":false,"description":"Effort: easy. A task that would be a great starting point for a new contributor."},{"id":694496598,"node_id":"MDU6TGFiZWw2OTQ0OTY1OTg=","url":"https://api.github.com/repos/hyperium/hyper/labels/C-feature","name":"C-feature","color":"f9d0c4","default":false,"description":"Category: feature. This is adding a new feature."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2018-06-12T21:32:44Z","updated_at":"2018-06-18T23:03:13Z","closed_at":"2018-06-18T23:03:13Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"This is the http code I hacked together\r\n\r\n```rust\r\npub fn get(&self, url: &str) -> Result<Response> {\r\n    let mut request = Request::builder();\r\n    let request = request.uri(url)\r\n           .header(\"User-Agent\", \"my-awesome-agent/1.0\")\r\n           .body(Body::empty())?;\r\n\r\n    let mut core = reactor::Core::new()?;\r\n    let (parts, body) = core.run(self.client.request(request).and_then(|res| {\r\n        println!(\"{:?}\", res);\r\n        let (parts, body) = res.into_parts();\r\n        let body = body.concat2();\r\n        (future::ok(parts), body)\r\n    }))?;\r\n\r\n    println!(\"parts: {:?}\", parts);\r\n    let body = String::from_utf8_lossy(&body);\r\n    println!(\"body: {:?}\", body);\r\n\r\n    Ok(Response::from((parts, body.to_string())))\r\n}\r\n```\r\n\r\nHere are my tests:\r\n```rust\r\n#[test]\r\n#[ignore]\r\nfn verify_200_http() {\r\n    let client = Client::new();\r\n    let reply = client.get(\"http://httpbin.org/anything\").expect(\"request failed\");\r\n    assert_eq!(reply.status, 200);\r\n}\r\n\r\n#[test]\r\n#[ignore]\r\nfn verify_200_https() {\r\n    let client = Client::new();\r\n    let reply = client.get(\"https://httpbin.org/anything\").expect(\"request failed\");\r\n    assert_eq!(reply.status, 200);\r\n}\r\n\r\n#[test]\r\n#[ignore]\r\nfn verify_302() {\r\n    let client = Client::new();\r\n    let reply = client.get(\"https://httpbin.org/redirect-to?url=/anything&status=302\").expect(\"request failed\");\r\n    assert_eq!(reply.status, 302);\r\n}\r\n```\r\n\r\nThe 200 tests are working nicely, but the 302 test keeps failing with a panic from hyper/tokio. It seems this is because the url in the 302 test has no response body (`Content-Lenght: 0`) which may cause issues with `body.concat2()`. Note that this doesn't happen every time, but very often.\r\n\r\n```\r\nrunning 3 tests\r\ntest web::tests::verify_200_http ... ok\r\ntest web::tests::verify_200_https ... ok\r\nthread 'tokio-runtime-worker-0' panicked at 'called `Result::unwrap()` on an `Err` value: SpawnError { is_shutdown: true }', libcore/result.rs:945:5\r\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\nstack backtrace:\r\n   0: std::sys::unix::backtrace::tracing::imp::unwind_backtrace\r\n             at libstd/sys/unix/backtrace/tracing/gcc_s.rs:49\r\n   1: std::sys_common::backtrace::print\r\n             at libstd/sys_common/backtrace.rs:71\r\n             at libstd/sys_common/backtrace.rs:59\r\n   2: std::panicking::default_hook::{{closure}}\r\n             at libstd/panicking.rs:207\r\n   3: std::panicking::default_hook\r\n             at libstd/panicking.rs:223\r\n   4: std::panicking::rust_panic_with_hook\r\n             at libstd/panicking.rs:402\r\n   5: std::panicking::begin_panic_fmt\r\n             at libstd/panicking.rs:349\r\n   6: rust_begin_unwind\r\n             at libstd/panicking.rs:325\r\n   7: core::panicking::panic_fmt\r\n             at libcore/panicking.rs:72\r\n   8: core::result::unwrap_failed\r\n             at /checkout/src/libcore/macros.rs:26\r\n   9: <core::result::Result<T, E>>::unwrap\r\n             at /checkout/src/libcore/result.rs:782\r\n  10: tokio_executor::global::spawn\r\n             at /home/user/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-executor-0.1.2/src/global.rs:128\r\n  11: hyper::common::exec::Exec::execute\r\n             at /home/user/.cargo/registry/src/github.com-1ecc6299db9ec823/hyper-0.12.1/src/common/exec.rs:24\r\n  12: <hyper::client::pool::Connections<T>>::spawn_idle_interval\r\n             at /home/user/.cargo/registry/src/github.com-1ecc6299db9ec823/hyper-0.12.1/src/client/pool.rs:411\r\n  13: <hyper::client::pool::Connections<T>>::put\r\n             at /home/user/.cargo/registry/src/github.com-1ecc6299db9ec823/hyper-0.12.1/src/client/pool.rs:369\r\n  14: <hyper::client::pool::Pooled<T> as core::ops::drop::Drop>::drop\r\n             at /home/user/.cargo/registry/src/github.com-1ecc6299db9ec823/hyper-0.12.1/src/client/pool.rs:531\r\n  15: core::ptr::drop_in_place\r\n             at /checkout/src/libcore/ptr.rs:59\r\n  16: core::ptr::drop_in_place\r\n             at /checkout/src/libcore/ptr.rs:59\r\n  17: core::ptr::drop_in_place\r\n             at /checkout/src/libcore/ptr.rs:59\r\n  18: core::ptr::drop_in_place\r\n             at /checkout/src/libcore/ptr.rs:59\r\n  19: core::ptr::drop_in_place\r\n             at /checkout/src/libcore/ptr.rs:59\r\n  20: core::ptr::drop_in_place\r\n             at /checkout/src/libcore/ptr.rs:59\r\n  21: core::ptr::drop_in_place\r\n             at /checkout/src/libcore/ptr.rs:59\r\n  22: core::ptr::drop_in_place\r\n             at /checkout/src/libcore/ptr.rs:59\r\n  23: core::ptr::drop_in_place\r\n             at /checkout/src/libcore/ptr.rs:59\r\n  24: core::ptr::drop_in_place\r\n             at /checkout/src/libcore/ptr.rs:59\r\n  25: core::ptr::drop_in_place\r\n             at /checkout/src/libcore/ptr.rs:59\r\n  26: core::ptr::drop_in_place\r\n             at /checkout/src/libcore/ptr.rs:59\r\n  27: <alloc::arc::Arc<T>>::drop_slow\r\n             at /checkout/src/liballoc/arc.rs:520\r\n  28: <alloc::arc::Arc<T> as core::ops::drop::Drop>::drop\r\n             at /checkout/src/liballoc/arc.rs:971\r\n  29: core::ptr::drop_in_place\r\n             at /checkout/src/libcore/ptr.rs:59\r\n  30: core::ptr::drop_in_place\r\n             at /checkout/src/libcore/ptr.rs:59\r\n  31: tokio_threadpool::worker::entry::WorkerEntry::drain_tasks\r\n             at /home/user/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-threadpool-0.1.4/src/worker/entry.rs:204\r\n  32: <tokio_threadpool::worker::Worker as core::ops::drop::Drop>::drop\r\n             at /home/user/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-threadpool-0.1.4/src/worker/mod.rs:812\r\n  33: core::ptr::drop_in_place\r\n             at /checkout/src/libcore/ptr.rs:59\r\n  34: tokio_threadpool::pool::Pool::spawn_thread::{{closure}}\r\n             at /home/user/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-threadpool-0.1.4/src/pool/mod.rs:453\r\n^C\r\n```","closed_by":{"login":"seanmonstar","id":51479,"node_id":"MDQ6VXNlcjUxNDc5","avatar_url":"https://avatars.githubusercontent.com/u/51479?v=4","gravatar_id":"","url":"https://api.github.com/users/seanmonstar","html_url":"https://github.com/seanmonstar","followers_url":"https://api.github.com/users/seanmonstar/followers","following_url":"https://api.github.com/users/seanmonstar/following{/other_user}","gists_url":"https://api.github.com/users/seanmonstar/gists{/gist_id}","starred_url":"https://api.github.com/users/seanmonstar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/seanmonstar/subscriptions","organizations_url":"https://api.github.com/users/seanmonstar/orgs","repos_url":"https://api.github.com/users/seanmonstar/repos","events_url":"https://api.github.com/users/seanmonstar/events{/privacy}","received_events_url":"https://api.github.com/users/seanmonstar/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/hyperium/hyper/issues/1566/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/hyperium/hyper/issues/1566/timeline","performed_via_github_app":null,"state_reason":"completed"}