{"url":"https://api.github.com/repos/hyperium/hyper/issues/519","repository_url":"https://api.github.com/repos/hyperium/hyper","labels_url":"https://api.github.com/repos/hyperium/hyper/issues/519/labels{/name}","comments_url":"https://api.github.com/repos/hyperium/hyper/issues/519/comments","events_url":"https://api.github.com/repos/hyperium/hyper/issues/519/events","html_url":"https://github.com/hyperium/hyper/issues/519","id":74735760,"node_id":"MDU6SXNzdWU3NDczNTc2MA==","number":519,"title":"Hyper client after v0.3.15 can't connect to some nginx servers with ConnectionOption::Close","user":{"login":"amoskvin","id":79843,"node_id":"MDQ6VXNlcjc5ODQz","avatar_url":"https://avatars.githubusercontent.com/u/79843?v=4","gravatar_id":"","url":"https://api.github.com/users/amoskvin","html_url":"https://github.com/amoskvin","followers_url":"https://api.github.com/users/amoskvin/followers","following_url":"https://api.github.com/users/amoskvin/following{/other_user}","gists_url":"https://api.github.com/users/amoskvin/gists{/gist_id}","starred_url":"https://api.github.com/users/amoskvin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/amoskvin/subscriptions","organizations_url":"https://api.github.com/users/amoskvin/orgs","repos_url":"https://api.github.com/users/amoskvin/repos","events_url":"https://api.github.com/users/amoskvin/events{/privacy}","received_events_url":"https://api.github.com/users/amoskvin/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2015-05-09T19:04:14Z","updated_at":"2015-05-10T05:44:43Z","closed_at":"2015-05-10T05:44:43Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Starting with commit 1e72a8ab3a00, Hyper errors out when trying to connect to some servers with ConnectionOption::Close header set. A common pattern seems to be that they're running nginx.\n\nHere's a modified version of the example client:\n\n``` Rust\nextern crate hyper;\n\nuse std::io::Read;\n\nuse hyper::Client;\nuse hyper::header::Connection;\nuse hyper::header::ConnectionOption;\n\nfn main() {\n    for url in vec![\n            \"http://doc.rust-lang.org\",\n            \"http://www.linode.com\",\n            \"http://digitalocean.com\",\n            \"http://www.reddit.com\",\n            \"http://www.kernel.org\",\n            \"http://www.gooogle.com\",\n        ]\n    {\n        run(url);\n    }\n}\n\nfn run(url: &str) {\n    println!(\"Retrieve {}:\", url);\n    let mut client = Client::new();\n    let result = client.get(url)\n        .header(Connection(vec![ConnectionOption::Close]))\n        .send();\n\n    match result {\n        Ok(mut res) => {\n                let mut body = String::new();\n                res.read_to_string(&mut body).unwrap();\n                println!(\"Success: {} bytes\", body.len());\n            },\n        Err(_) => {\n                println!(\"Failed: {:?}\", result);\n            },\n    }\n    println!(\"\");\n}\n```\n\n```\n$ cargo update; cargo run\n    Updating registry `https://github.com/rust-lang/crates.io-index`\n   Compiling hyper v0.4.0 (file:///home/alec/test1)\n   Compiling test1 v0.1.0 (file:///home/alec/test1)\n     Running `target/debug/test1`\nRetrieve http://doc.rust-lang.org:\nFailed: Err(Io(Error { repr: Custom(Custom { kind: ConnectionAborted, error: StringError(\"Connection closed\") }) }))\n\nRetrieve http://www.linode.com:\nFailed: Err(Io(Error { repr: Custom(Custom { kind: ConnectionAborted, error: StringError(\"Connection closed\") }) }))\n\nRetrieve http://digitalocean.com:\nFailed: Err(Io(Error { repr: Custom(Custom { kind: ConnectionAborted, error: StringError(\"Connection closed\") }) }))\n\nRetrieve http://www.reddit.com:\nFailed: Err(Io(Error { repr: Custom(Custom { kind: ConnectionAborted, error: StringError(\"Connection closed\") }) }))\n\nRetrieve http://www.kernel.org:\nFailed: Err(Io(Error { repr: Custom(Custom { kind: ConnectionAborted, error: StringError(\"Connection closed\") }) }))\n\nRetrieve http://www.gooogle.com:\nSuccess: 52184 bytes\n\n$ cargo update; cargo run\n    Updating registry `https://github.com/rust-lang/crates.io-index`\n   Compiling hyper v0.3.15 (file:///home/alec/test1)\n   Compiling test1 v0.1.0 (file:///home/alec/test1)\n     Running `target/debug/test1`\nRetrieve http://doc.rust-lang.org:\nSuccess: 6414 bytes\n\nRetrieve http://www.linode.com:\nSuccess: 19898 bytes\n\nRetrieve http://digitalocean.com:\nSuccess: 19559 bytes\n\nRetrieve http://www.reddit.com:\nSuccess: 114095 bytes\n\nRetrieve http://www.kernel.org:\nSuccess: 19090 bytes\n\nRetrieve http://www.gooogle.com:\nSuccess: 52216 bytes\n\n$ rustc --version\nrustc 1.0.0-beta.4 (built 2015-05-09)\n```\n","closed_by":{"login":"seanmonstar","id":51479,"node_id":"MDQ6VXNlcjUxNDc5","avatar_url":"https://avatars.githubusercontent.com/u/51479?v=4","gravatar_id":"","url":"https://api.github.com/users/seanmonstar","html_url":"https://github.com/seanmonstar","followers_url":"https://api.github.com/users/seanmonstar/followers","following_url":"https://api.github.com/users/seanmonstar/following{/other_user}","gists_url":"https://api.github.com/users/seanmonstar/gists{/gist_id}","starred_url":"https://api.github.com/users/seanmonstar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/seanmonstar/subscriptions","organizations_url":"https://api.github.com/users/seanmonstar/orgs","repos_url":"https://api.github.com/users/seanmonstar/repos","events_url":"https://api.github.com/users/seanmonstar/events{/privacy}","received_events_url":"https://api.github.com/users/seanmonstar/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/hyperium/hyper/issues/519/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/hyperium/hyper/issues/519/timeline","performed_via_github_app":null,"state_reason":"completed"}