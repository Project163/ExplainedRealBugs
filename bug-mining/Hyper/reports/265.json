{"url":"https://api.github.com/repos/hyperium/hyper/issues/2780","repository_url":"https://api.github.com/repos/hyperium/hyper","labels_url":"https://api.github.com/repos/hyperium/hyper/issues/2780/labels{/name}","comments_url":"https://api.github.com/repos/hyperium/hyper/issues/2780/comments","events_url":"https://api.github.com/repos/hyperium/hyper/issues/2780/events","html_url":"https://github.com/hyperium/hyper/issues/2780","id":1171707600,"node_id":"I_kwDOAWaYQc5F1tbQ","number":2780,"title":"Hyper Curl test 580 and 580 Root cause","user":{"login":"liamwarfield","id":32559457,"node_id":"MDQ6VXNlcjMyNTU5NDU3","avatar_url":"https://avatars.githubusercontent.com/u/32559457?v=4","gravatar_id":"","url":"https://api.github.com/users/liamwarfield","html_url":"https://github.com/liamwarfield","followers_url":"https://api.github.com/users/liamwarfield/followers","following_url":"https://api.github.com/users/liamwarfield/following{/other_user}","gists_url":"https://api.github.com/users/liamwarfield/gists{/gist_id}","starred_url":"https://api.github.com/users/liamwarfield/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/liamwarfield/subscriptions","organizations_url":"https://api.github.com/users/liamwarfield/orgs","repos_url":"https://api.github.com/users/liamwarfield/repos","events_url":"https://api.github.com/users/liamwarfield/events{/privacy}","received_events_url":"https://api.github.com/users/liamwarfield/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":125710197,"node_id":"MDU6TGFiZWwxMjU3MTAxOTc=","url":"https://api.github.com/repos/hyperium/hyper/labels/C-bug","name":"C-bug","color":"d93f0b","default":false,"description":"Category: bug. Something is wrong. This is bad!"},{"id":2640844074,"node_id":"MDU6TGFiZWwyNjQwODQ0MDc0","url":"https://api.github.com/repos/hyperium/hyper/labels/A-ffi","name":"A-ffi","color":"fbca04","default":false,"description":"Area: ffi (C API)"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2022-03-17T00:05:00Z","updated_at":"2022-04-23T16:05:41Z","closed_at":"2022-04-23T16:05:41Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Version**\r\nhyper::ffi  current version\r\n\r\n**Platform**\r\nAll?\r\n\r\n**Description**\r\nFound the RC of failing curl tests 580 and 581!\r\n\r\n[short summary of the bug]\r\n[hyper_headers_foreach](https://docs.rs/hyper/0.14.17/hyper/ffi/fn.hyper_headers_foreach.html#) iterates through headers in by header name, not by order recieved! The smoking gun for for curl tests 580 and 581 is [this](https://docs.rs/hyper/0.14.17/src/hyper/ffi/http_types.rs.html#410) line.\r\n\r\nFor test 581:\r\nRaw response sent by server:\r\n```\r\nHTTP/1.1 200 OK\r\nContent-Length: 18\r\n\r\nWE ROOLZ: 118369\r\nHTTP/1.1 200 all good!\r\nDate: Tue, 09 Nov 2010 14:49:00 GMT\r\nServer: test-server/fake\r\nContent-Type: text/html\r\nContent-Length: 0\r\nConnection: close\r\nContent-Type: changed/my/mind\r\n```\r\n\r\nCurl is expecting an iterator that returns headers in the order that they were received:\r\n```\r\nHTTP/1.1 200 all good![CR][LF]\r\nDate: Tue, 09 Nov 2010 14:49:00 GMT[CR][LF]\r\nServer: test-server/fake[CR][LF]\r\nContent-Type: text/html[CR][LF]\r\nContent-Length: 0[CR][LF]\r\nConnection: close[CR][LF]\r\nContent-Type: changed/my/mind[CR][LF]\r\n[CR][LF]\r\n```\r\nbut hyper is returning ALL of the `Content-Type` headers before moving onto the `Connection` header. Results in:\r\n```\r\nHTTP/1.1 200 all good![CR][LF]\r\nDate: Tue, 09 Nov 2010 14:49:00 GMT[CR][LF]\r\nServer: test-server/fake[CR][LF]\r\nContent-Type: text/html[CR][LF]\r\nContent-Type: changed/my/mind[CR][LF]  <------ comes to early!\r\nContent-Length: 0[CR][LF]\r\nConnection: close[CR][LF]\r\n[CR][LF]\r\n```\r\n\r\n**Hyper Code Responcible**\r\n```rust\r\nhyper_headers_foreach_callback, userdata: *mut c_void) {\r\n        let headers = non_null!(&*headers ?= ());\r\n        for name in headers.headers.keys() {\r\n            let mut names = headers.orig_casing.get_all(name);\r\n\r\n            /// HERE is the bug, this iterates through all headers with the\r\n            /// same name before moving on to the next header name.\r\n            for value in headers.headers.get_all(name) {\r\n                let (name_ptr, name_len) = if let Some(orig_name) = names.next() {\r\n                    (orig_name.as_ref().as_ptr(), orig_name.as_ref().len())\r\n                } else {\r\n                    (\r\n                        name.as_str().as_bytes().as_ptr(),\r\n                        name.as_str().as_bytes().len(),\r\n                    )\r\n                };\r\n\r\n                let val_ptr = value.as_bytes().as_ptr();\r\n                let val_len = value.as_bytes().len();\r\n\r\n                if HYPER_ITER_CONTINUE != func(userdata, name_ptr, name_len, val_ptr, val_len) {\r\n                    return;\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n\r\n@seanmonstar \r\n","closed_by":{"login":"seanmonstar","id":51479,"node_id":"MDQ6VXNlcjUxNDc5","avatar_url":"https://avatars.githubusercontent.com/u/51479?v=4","gravatar_id":"","url":"https://api.github.com/users/seanmonstar","html_url":"https://github.com/seanmonstar","followers_url":"https://api.github.com/users/seanmonstar/followers","following_url":"https://api.github.com/users/seanmonstar/following{/other_user}","gists_url":"https://api.github.com/users/seanmonstar/gists{/gist_id}","starred_url":"https://api.github.com/users/seanmonstar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/seanmonstar/subscriptions","organizations_url":"https://api.github.com/users/seanmonstar/orgs","repos_url":"https://api.github.com/users/seanmonstar/repos","events_url":"https://api.github.com/users/seanmonstar/events{/privacy}","received_events_url":"https://api.github.com/users/seanmonstar/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/hyperium/hyper/issues/2780/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/hyperium/hyper/issues/2780/timeline","performed_via_github_app":null,"state_reason":"completed"}