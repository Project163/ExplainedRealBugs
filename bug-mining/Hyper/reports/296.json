{"url":"https://api.github.com/repos/hyperium/hyper/issues/2872","repository_url":"https://api.github.com/repos/hyperium/hyper","labels_url":"https://api.github.com/repos/hyperium/hyper/issues/2872/labels{/name}","comments_url":"https://api.github.com/repos/hyperium/hyper/issues/2872/comments","events_url":"https://api.github.com/repos/hyperium/hyper/issues/2872/events","html_url":"https://github.com/hyperium/hyper/issues/2872","id":1250126950,"node_id":"I_kwDOAWaYQc5Kg2xm","number":2872,"title":"Client: handle `RST_STREAM` with `NO_ERROR` set for the reason","user":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":125710197,"node_id":"MDU6TGFiZWwxMjU3MTAxOTc=","url":"https://api.github.com/repos/hyperium/hyper/labels/C-bug","name":"C-bug","color":"d93f0b","default":false,"description":"Category: bug. Something is wrong. This is bad!"},{"id":956796120,"node_id":"MDU6TGFiZWw5NTY3OTYxMjA=","url":"https://api.github.com/repos/hyperium/hyper/labels/A-http2","name":"A-http2","color":"fbca04","default":false,"description":"Area: HTTP/2 specific."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-05-26T21:47:40Z","updated_at":"2023-10-12T13:13:07Z","closed_at":"2023-07-26T19:47:08Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Version**\r\n```\r\nhyper = \"0.14.18\"\r\nh2 = \"0.3.13\"\r\n```\r\n\r\n**Platform**\r\n```\r\n> uname -a\r\nLinux <REDACTED> 5.17.5-76051705-generic #202204271406~1651504840~22.04~63e51bd SMP PREEMPT Mon May 2 15: x86_64 x86_64 x86_64 GNU/Linux\r\n```\r\n\r\n**Description**\r\nI've found that Google Cloud Storage's API can respond with HTTP/2 `RST_STREAM` frame with `NO_ERROR` set for the reason, which appears to mean \"stop sending the request body and read my response\" according to https://datatracker.ietf.org/doc/html/rfc7540#section-8.1\r\n\r\n> A server can send a complete response prior to the client sending an entire\r\n   request if the response does not depend on any portion of the request\r\n   that has not been sent and received.  When this is true, a server MAY\r\n   request that the client abort transmission of a request without error\r\n   by sending a RST_STREAM with an error code of NO_ERROR after sending\r\n   a complete response (i.e., a frame with the END_STREAM flag).\r\n   Clients MUST NOT discard responses as a result of receiving such a\r\n   RST_STREAM, though clients can always discard responses at their\r\n   discretion for other reasons.\r\n\r\nI believe this is happening in response to a `PutObject` request when the bucket is being rate limited for writes. The server is trying to tell the client to stop sending the request body because it won't be processed, and instead it should immediately read the response to discover the `429 Too Many Requests` error code.\r\n\r\nHowever, Hyper's client implementation appears to just return the `RST_STREAM` message as an error and discards the response instead of handling it, which gives a hilariously confusing error message of:\r\n```\r\nerror reading a body from connection: stream error received: not a result of an error\r\n```\r\n\r\nTo be compliant with the spec, the implementation should stop sending the body and immediately read the response and return it.\r\n\r\nFor context, I'm using the Gcloud Storage API via https://crates.io/crates/aws-sdk-s3 (because the Gcloud Rust SDK doesn't support streaming bodies, but thankfully Gcloud Storage exposes an S3-compatible API), which uses Hyper internally. `aws-sdk-s3` appears to be returning the error from Hyper verbatim, however.","closed_by":{"login":"seanmonstar","id":51479,"node_id":"MDQ6VXNlcjUxNDc5","avatar_url":"https://avatars.githubusercontent.com/u/51479?v=4","gravatar_id":"","url":"https://api.github.com/users/seanmonstar","html_url":"https://github.com/seanmonstar","followers_url":"https://api.github.com/users/seanmonstar/followers","following_url":"https://api.github.com/users/seanmonstar/following{/other_user}","gists_url":"https://api.github.com/users/seanmonstar/gists{/gist_id}","starred_url":"https://api.github.com/users/seanmonstar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/seanmonstar/subscriptions","organizations_url":"https://api.github.com/users/seanmonstar/orgs","repos_url":"https://api.github.com/users/seanmonstar/repos","events_url":"https://api.github.com/users/seanmonstar/events{/privacy}","received_events_url":"https://api.github.com/users/seanmonstar/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/hyperium/hyper/issues/2872/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/hyperium/hyper/issues/2872/timeline","performed_via_github_app":null,"state_reason":"completed"}