{"url":"https://api.github.com/repos/hyperium/hyper/issues/197","repository_url":"https://api.github.com/repos/hyperium/hyper","labels_url":"https://api.github.com/repos/hyperium/hyper/issues/197/labels{/name}","comments_url":"https://api.github.com/repos/hyperium/hyper/issues/197/comments","events_url":"https://api.github.com/repos/hyperium/hyper/issues/197/events","html_url":"https://github.com/hyperium/hyper/issues/197","id":51895352,"node_id":"MDU6SXNzdWU1MTg5NTM1Mg==","number":197,"title":"`request error = HttpMethodError` logs","user":{"login":"rictic","id":1659,"node_id":"MDQ6VXNlcjE2NTk=","avatar_url":"https://avatars.githubusercontent.com/u/1659?v=4","gravatar_id":"","url":"https://api.github.com/users/rictic","html_url":"https://github.com/rictic","followers_url":"https://api.github.com/users/rictic/followers","following_url":"https://api.github.com/users/rictic/following{/other_user}","gists_url":"https://api.github.com/users/rictic/gists{/gist_id}","starred_url":"https://api.github.com/users/rictic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rictic/subscriptions","organizations_url":"https://api.github.com/users/rictic/orgs","repos_url":"https://api.github.com/users/rictic/repos","events_url":"https://api.github.com/users/rictic/events{/privacy}","received_events_url":"https://api.github.com/users/rictic/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":125710197,"node_id":"MDU6TGFiZWwxMjU3MTAxOTc=","url":"https://api.github.com/repos/hyperium/hyper/labels/C-bug","name":"C-bug","color":"d93f0b","default":false,"description":"Category: bug. Something is wrong. This is bad!"},{"id":128399797,"node_id":"MDU6TGFiZWwxMjgzOTk3OTc=","url":"https://api.github.com/repos/hyperium/hyper/labels/A-server","name":"A-server","color":"fbca04","default":false,"description":"Area: server."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2014-12-13T18:23:03Z","updated_at":"2015-02-14T22:36:46Z","closed_at":"2015-02-14T22:36:46Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I'm finding the following in my server logs with some frequency:\n\n```\nERROR:hyper::server: request error = HttpMethodError\n```\n\nAfter spending some time on this, I've found a simple reproduction that seems to hinge on requests with a chunked transfer encoding, though I couldn't tell if it was the hyper client or the server that was incorrect. Wireshark hinted that it may be the client, but I believe that I've encountered this log message in the wild and not just when testing the hyper server with the hyper client.\n\nThe log message is produced when the server is trying to read the http method of a request but encounters unexpected characters. In the case of the error reproduction below, the server appears to be trying to read for a second request on the connection, and it encounters \\r\\n instead of the expected http method.\n\n``` rust\nextern crate test;\nextern crate hyper;\n\nuse std::io;\nuse std::rand;\nuse hyper::method::Method;\nuse hyper::client::Request;\nuse hyper::server;\nuse hyper::status::StatusCode;\n\n#[test]\nfn http_method_error_is_logged() {\n    let ts = TestServer::new();\n    Request::new(Method::Post, ts.get_url())\n        .unwrap().start().unwrap().send().unwrap();\n    io::stdio::stderr().write_line(\n        \"^^^^^^^     That ERROR log message there     ^^^^^^^\").unwrap();\n\n    // I couldn't work out how to capture the error logs, stdio::set_stderr()\n    // only catches messages sent with panic! I think. As a result this \"test\" \n    // doesn't assert, you just have to look at the printed output.\n\n    // Things which cause this error to not reproduce:\n    //   * changing the request to one with no body, like a GET\n    //   * providing a Content-Length on the request\n}\n\nfn hello(_: server::Request, mut res: server::Response) {\n    *res.status_mut() = StatusCode::Ok;\n    let mut res = res.start().unwrap();\n    res.write(b\"Hello World!\").unwrap();\n    res.end().unwrap();\n}\n\n\nstruct TestServer {\n    listen_serv : hyper::server::Listening,\n    port : u16,\n}\n\nimpl TestServer {\n    fn new() -> TestServer {\n        let host = from_str(\"127.0.0.1\").unwrap();\n        // Try to guess a free port that we can bind to:\n        for _ in range(0, 100u) {\n            let port = rand::random();\n            let server = hyper::server::Server::http(host, port);\n\n            match server.listen(hello) {\n                Ok(listening) => {\n                    return TestServer {\n                        listen_serv: listening,\n                        port: port\n                    }\n                },\n                Err(_) => (),\n            };\n        }\n\n        panic!(\"Could not find a port to bind the test server to!\");\n    }\n\n    fn get_url(&self) -> hyper::Url {\n        let mut url = \"http://127.0.0.1:\".to_string();\n        url.push_str(self.port.to_string().as_slice());\n        url.push_str(\"/\");\n        hyper::Url::parse(url.as_slice()).unwrap()\n    }\n}\n\nimpl Drop for TestServer {\n    fn drop(&mut self) {\n        self.listen_serv.close().unwrap();\n    }\n}\n```\n","closed_by":{"login":"reem","id":4745181,"node_id":"MDQ6VXNlcjQ3NDUxODE=","avatar_url":"https://avatars.githubusercontent.com/u/4745181?v=4","gravatar_id":"","url":"https://api.github.com/users/reem","html_url":"https://github.com/reem","followers_url":"https://api.github.com/users/reem/followers","following_url":"https://api.github.com/users/reem/following{/other_user}","gists_url":"https://api.github.com/users/reem/gists{/gist_id}","starred_url":"https://api.github.com/users/reem/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reem/subscriptions","organizations_url":"https://api.github.com/users/reem/orgs","repos_url":"https://api.github.com/users/reem/repos","events_url":"https://api.github.com/users/reem/events{/privacy}","received_events_url":"https://api.github.com/users/reem/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/hyperium/hyper/issues/197/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/hyperium/hyper/issues/197/timeline","performed_via_github_app":null,"state_reason":"completed"}