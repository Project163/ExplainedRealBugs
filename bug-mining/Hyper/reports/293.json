{"url":"https://api.github.com/repos/hyperium/hyper/issues/2730","repository_url":"https://api.github.com/repos/hyperium/hyper","labels_url":"https://api.github.com/repos/hyperium/hyper/issues/2730/labels{/name}","comments_url":"https://api.github.com/repos/hyperium/hyper/issues/2730/comments","events_url":"https://api.github.com/repos/hyperium/hyper/issues/2730/events","html_url":"https://github.com/hyperium/hyper/issues/2730","id":1091841410,"node_id":"I_kwDOAWaYQc5BFC2C","number":2730,"title":"Connection::graceful_shutdown always waits for the first request.","user":{"login":"sfackler","id":1455697,"node_id":"MDQ6VXNlcjE0NTU2OTc=","avatar_url":"https://avatars.githubusercontent.com/u/1455697?v=4","gravatar_id":"","url":"https://api.github.com/users/sfackler","html_url":"https://github.com/sfackler","followers_url":"https://api.github.com/users/sfackler/followers","following_url":"https://api.github.com/users/sfackler/following{/other_user}","gists_url":"https://api.github.com/users/sfackler/gists{/gist_id}","starred_url":"https://api.github.com/users/sfackler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sfackler/subscriptions","organizations_url":"https://api.github.com/users/sfackler/orgs","repos_url":"https://api.github.com/users/sfackler/repos","events_url":"https://api.github.com/users/sfackler/events{/privacy}","received_events_url":"https://api.github.com/users/sfackler/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":125710197,"node_id":"MDU6TGFiZWwxMjU3MTAxOTc=","url":"https://api.github.com/repos/hyperium/hyper/labels/C-bug","name":"C-bug","color":"d93f0b","default":false,"description":"Category: bug. Something is wrong. This is bad!"},{"id":128399797,"node_id":"MDU6TGFiZWwxMjgzOTk3OTc=","url":"https://api.github.com/repos/hyperium/hyper/labels/A-server","name":"A-server","color":"fbca04","default":false,"description":"Area: server."},{"id":694496799,"node_id":"MDU6TGFiZWw2OTQ0OTY3OTk=","url":"https://api.github.com/repos/hyperium/hyper/labels/E-medium","name":"E-medium","color":"c2e0c6","default":false,"description":"Effort: medium. Some knowledge of how hyper internal works would be useful."},{"id":1361563623,"node_id":"MDU6TGFiZWwxMzYxNTYzNjIz","url":"https://api.github.com/repos/hyperium/hyper/labels/B-breaking-change","name":"B-breaking-change","color":"1d76db","default":false,"description":"Blocked: this is an \"API breaking change\"."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/hyperium/hyper/milestones/12","html_url":"https://github.com/hyperium/hyper/milestone/12","labels_url":"https://api.github.com/repos/hyperium/hyper/milestones/12/labels","id":9086227,"node_id":"MI_kwDOAWaYQc4AiqUT","number":12,"title":"1.0 RC4","description":"","creator":{"login":"seanmonstar","id":51479,"node_id":"MDQ6VXNlcjUxNDc5","avatar_url":"https://avatars.githubusercontent.com/u/51479?v=4","gravatar_id":"","url":"https://api.github.com/users/seanmonstar","html_url":"https://github.com/seanmonstar","followers_url":"https://api.github.com/users/seanmonstar/followers","following_url":"https://api.github.com/users/seanmonstar/following{/other_user}","gists_url":"https://api.github.com/users/seanmonstar/gists{/gist_id}","starred_url":"https://api.github.com/users/seanmonstar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/seanmonstar/subscriptions","organizations_url":"https://api.github.com/users/seanmonstar/orgs","repos_url":"https://api.github.com/users/seanmonstar/repos","events_url":"https://api.github.com/users/seanmonstar/events{/privacy}","received_events_url":"https://api.github.com/users/seanmonstar/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":6,"state":"closed","created_at":"2023-02-24T15:36:53Z","updated_at":"2023-07-26T18:59:52Z","due_on":null,"closed_at":"2023-07-26T18:59:52Z"},"comments":10,"created_at":"2022-01-01T16:00:06Z","updated_at":"2023-07-06T19:23:31Z","closed_at":"2023-07-06T19:23:30Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Version**\r\nhyper 0.14.16\r\n\r\n**Platform**\r\nLinux DESKTOP-DHO88R7 4.19.104-microsoft-standard #1 SMP Wed Feb 19 06:37:35 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description**\r\nIf you gracefully shut down a server connection future before the first request, Hyper will not actually shut the connection down until a request is processed:\r\n\r\n```rust\r\nuse hyper::server::conn::Http;\r\nuse hyper::Response;\r\nuse tokio::io::AsyncReadExt;\r\nuse tokio::net::{TcpListener, TcpStream};\r\nuse tokio::pin;\r\n\r\n#[tokio::main]\r\nasync fn main() {\r\n    let listener = TcpListener::bind(\"127.0.0.1:0\").await.unwrap();\r\n    let addr = listener.local_addr().unwrap();\r\n\r\n    tokio::spawn(server(listener));\r\n\r\n    let mut stream = TcpStream::connect(addr).await.unwrap();\r\n    println!(\"connected\");\r\n    let mut buf = vec![];\r\n    stream.read_to_end(&mut buf).await.unwrap();\r\n}\r\n\r\nasync fn server(listener: TcpListener) {\r\n    let socket = listener.accept().await.unwrap().0;\r\n\r\n    let service = hyper::service::service_fn(|_: hyper::Request<hyper::Body>| async {\r\n        Err::<Response<hyper::Body>, _>(\"no\")\r\n    });\r\n\r\n    let future = Http::new()\r\n        .http1_only(true)\r\n        .serve_connection(socket, service);\r\n    pin!(future);\r\n    future.as_mut().graceful_shutdown();\r\n\r\n    future.await.unwrap();\r\n}\r\n```\r\n\r\nI would expect this program to exit almost instantly since there is no request being processed when the graceful_shutdown is invoked. However, it instead blocks forever waiting on the client to send headers.\r\n\r\nThe behavior actually appears to be that the shutdown is processed immediately after the first request is fully handled.","closed_by":{"login":"seanmonstar","id":51479,"node_id":"MDQ6VXNlcjUxNDc5","avatar_url":"https://avatars.githubusercontent.com/u/51479?v=4","gravatar_id":"","url":"https://api.github.com/users/seanmonstar","html_url":"https://github.com/seanmonstar","followers_url":"https://api.github.com/users/seanmonstar/followers","following_url":"https://api.github.com/users/seanmonstar/following{/other_user}","gists_url":"https://api.github.com/users/seanmonstar/gists{/gist_id}","starred_url":"https://api.github.com/users/seanmonstar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/seanmonstar/subscriptions","organizations_url":"https://api.github.com/users/seanmonstar/orgs","repos_url":"https://api.github.com/users/seanmonstar/repos","events_url":"https://api.github.com/users/seanmonstar/events{/privacy}","received_events_url":"https://api.github.com/users/seanmonstar/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/hyperium/hyper/issues/2730/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/hyperium/hyper/issues/2730/timeline","performed_via_github_app":null,"state_reason":"completed"}