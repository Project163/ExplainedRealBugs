{"url":"https://api.github.com/repos/hyperium/hyper/issues/1315","repository_url":"https://api.github.com/repos/hyperium/hyper","labels_url":"https://api.github.com/repos/hyperium/hyper/issues/1315/labels{/name}","comments_url":"https://api.github.com/repos/hyperium/hyper/issues/1315/comments","events_url":"https://api.github.com/repos/hyperium/hyper/issues/1315/events","html_url":"https://github.com/hyperium/hyper/issues/1315","id":256537181,"node_id":"MDU6SXNzdWUyNTY1MzcxODE=","number":1315,"title":"Memory leak when using client.clone() for server (proxy)","user":{"login":"klausi","id":213229,"node_id":"MDQ6VXNlcjIxMzIyOQ==","avatar_url":"https://avatars.githubusercontent.com/u/213229?v=4","gravatar_id":"","url":"https://api.github.com/users/klausi","html_url":"https://github.com/klausi","followers_url":"https://api.github.com/users/klausi/followers","following_url":"https://api.github.com/users/klausi/following{/other_user}","gists_url":"https://api.github.com/users/klausi/gists{/gist_id}","starred_url":"https://api.github.com/users/klausi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/klausi/subscriptions","organizations_url":"https://api.github.com/users/klausi/orgs","repos_url":"https://api.github.com/users/klausi/repos","events_url":"https://api.github.com/users/klausi/events{/privacy}","received_events_url":"https://api.github.com/users/klausi/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":125710197,"node_id":"MDU6TGFiZWwxMjU3MTAxOTc=","url":"https://api.github.com/repos/hyperium/hyper/labels/C-bug","name":"C-bug","color":"d93f0b","default":false,"description":"Category: bug. Something is wrong. This is bad!"},{"id":128399841,"node_id":"MDU6TGFiZWwxMjgzOTk4NDE=","url":"https://api.github.com/repos/hyperium/hyper/labels/A-client","name":"A-client","color":"fbca04","default":false,"description":"Area: client."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2017-09-10T20:19:30Z","updated_at":"2017-09-18T21:43:27Z","closed_at":"2017-09-18T21:43:27Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I'm writing a reverse proxy and use the HTTP client to connect to any upstream server. Code is in https://github.com/klausi/rustnish/blob/goal-06/src/lib.rs#L150 . The server is leaking memory so I must be doing something wrong.\r\n\r\nSteps to reproduce:\r\n\r\n1. Make sure you have any upstream HTTP service running locally on port 80, for example the default Apache install on Ubuntu which will give you a dummy page at http://localhost/\r\n   ```\r\n   sudo apt install apache2\r\n   ```\r\n\r\n2. Run rustnish reverse proxy on port 9090:\r\n   ```\r\n   git clone --branch goal-06 git@github.com:klausi/rustnish.git\r\n   cd rustnish\r\n   cargo run --release\r\n   ```\r\n\r\n3. Get PID of rustnish process and memory usage:\r\n\r\n   ```\r\n   ps aux | grep rustnish\r\n   ```\r\n   The 6th column is the memory usage of the process, something like 20124 (~20MB)\r\n   \r\n4. Fire 1 million requests at the reverse proxy with Apache Bench:\r\n   ```\r\n   ab -c 4 -n 1000000 http://localhost:9090/\r\n   ```\r\n   (This takes ~130 seconds on my computer)\r\n   \r\n5. Check memory usage again:\r\n   ```\r\n   ps aux | grep rustnish\r\n   ```\r\n   The 6th column should show something like 284920, which is ~280MB!\r\n   \r\nSo although we do not cache any requests or keep them around otherwise memory usage is growing without freeing up anymore.\r\n\r\nOne solution to the problem is this patch:\r\n\r\n```\r\ndiff --git a/src/lib.rs b/src/lib.rs\r\nindex 520dd24..a591b99 100644\r\n--- a/src/lib.rs\r\n+++ b/src/lib.rs\r\n@@ -170,7 +170,6 @@ pub fn start_server_background(\r\n             let http = Http::new();\r\n             let listener = TcpListener::bind(&address, &handle)\r\n                 .chain_err(|| format!(\"Failed to bind server to address {}\", address))?;\r\n-            let client = Client::new(&handle);\r\n \r\n             let server = listener.incoming().for_each(move |(sock, addr)| {\r\n                 http.bind_connection(\r\n@@ -180,7 +179,7 @@ pub fn start_server_background(\r\n                     Proxy {\r\n                         port: port,\r\n                         upstream_port: upstream_port,\r\n-                        client: client.clone(),\r\n+                        client: Client::new(&handle),\r\n                     },\r\n                 );\r\n                 Ok(())\r\n```\r\n\r\nAvoiding the client.clone() call fixes the memory leak but degrades the runtime performance. Apache Bench with 1 million requests took 220 seconds instead of 130 seconds before. So the client_clone() call seems to be the right thing to do, but the clones are not dropped correctly when one request handling is done?","closed_by":{"login":"seanmonstar","id":51479,"node_id":"MDQ6VXNlcjUxNDc5","avatar_url":"https://avatars.githubusercontent.com/u/51479?v=4","gravatar_id":"","url":"https://api.github.com/users/seanmonstar","html_url":"https://github.com/seanmonstar","followers_url":"https://api.github.com/users/seanmonstar/followers","following_url":"https://api.github.com/users/seanmonstar/following{/other_user}","gists_url":"https://api.github.com/users/seanmonstar/gists{/gist_id}","starred_url":"https://api.github.com/users/seanmonstar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/seanmonstar/subscriptions","organizations_url":"https://api.github.com/users/seanmonstar/orgs","repos_url":"https://api.github.com/users/seanmonstar/repos","events_url":"https://api.github.com/users/seanmonstar/events{/privacy}","received_events_url":"https://api.github.com/users/seanmonstar/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/hyperium/hyper/issues/1315/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/hyperium/hyper/issues/1315/timeline","performed_via_github_app":null,"state_reason":"completed"}