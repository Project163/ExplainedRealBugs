{"url":"https://api.github.com/repos/hyperium/hyper/issues/1010","repository_url":"https://api.github.com/repos/hyperium/hyper","labels_url":"https://api.github.com/repos/hyperium/hyper/issues/1010/labels{/name}","comments_url":"https://api.github.com/repos/hyperium/hyper/issues/1010/comments","events_url":"https://api.github.com/repos/hyperium/hyper/issues/1010/events","html_url":"https://github.com/hyperium/hyper/issues/1010","id":201125473,"node_id":"MDU6SXNzdWUyMDExMjU0NzM=","number":1010,"title":"[tokio] process exiting when returning Response with large string","user":{"login":"radix","id":227068,"node_id":"MDQ6VXNlcjIyNzA2OA==","avatar_url":"https://avatars.githubusercontent.com/u/227068?v=4","gravatar_id":"","url":"https://api.github.com/users/radix","html_url":"https://github.com/radix","followers_url":"https://api.github.com/users/radix/followers","following_url":"https://api.github.com/users/radix/following{/other_user}","gists_url":"https://api.github.com/users/radix/gists{/gist_id}","starred_url":"https://api.github.com/users/radix/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/radix/subscriptions","organizations_url":"https://api.github.com/users/radix/orgs","repos_url":"https://api.github.com/users/radix/repos","events_url":"https://api.github.com/users/radix/events{/privacy}","received_events_url":"https://api.github.com/users/radix/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2017-01-16T21:47:26Z","updated_at":"2017-01-16T22:49:34Z","closed_at":"2017-01-16T22:49:34Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I'm on Windows 10 using this version of hyper (from my Cargo.lock)\r\n\r\n```\r\nsource = \"git+https://github.com/hyperium/hyper?branch=tokio#2cbb7471fa0e2da28987536bdaf850c24aa373ed\"\r\n```\r\n\r\nWhen I run the following program, it listens on port 1337. When I make a request, the process dies. First, the code:\r\n\r\n```rust\r\nextern crate hyper;\r\nextern crate futures;\r\n\r\nuse std::env;\r\n\r\nuse futures::{finished, Future, BoxFuture};\r\n\r\nuse hyper::server::{Server, Service, Request, Response};\r\n\r\n#[derive(Clone)]\r\nstruct Bug(String);\r\n\r\nimpl Service for Bug {\r\n    type Request = Request;\r\n    type Response = Response;\r\n    type Error = hyper::Error;\r\n    type Future = BoxFuture<Response, hyper::Error>;\r\n\r\n    fn call(&self, req: Request) -> Self::Future {\r\n        println!(\"Handling {:?} {:?}\", req.method(), req.path());\r\n        finished(Response::new().with_body(self.0.clone())).boxed()\r\n    }\r\n}\r\n\r\nfn main() {\r\n    let addr = format!(\"0.0.0.0:{}\",\r\n                       env::args().nth(1).unwrap_or(String::from(\"1337\")))\r\n        .parse()\r\n        .unwrap();\r\n\r\n    let bug = Bug((0..10000).map(|_| \"X\").collect::<String>());\r\n    let (listening, server) = Server::standalone(|tokio| {\r\n            let bug = bug.clone();\r\n            Server::http(&addr, tokio)\r\n                ?\r\n                .handle(move || Ok(bug.clone()), tokio)\r\n        })\r\n        .unwrap();\r\n    println!(\"Listening on http://{}\", listening);\r\n    server.run();\r\n}\r\n```\r\n\r\nIt dies with exit code `3221226356`.\r\n\r\n\r\nI modified the tokio-core echo example to write a similarly large string, but it's not blowing up. However, maybe I'm not using the same APIs that Hyper is, so it could still be a bug in Tokio.\r\n\r\n\r\n\r\n```rust\r\nextern crate futures;\r\nextern crate tokio_core;\r\n\r\nuse futures::{Future, Stream};\r\nuse tokio_core::io::{copy, Io, write_all};\r\nuse tokio_core::net::TcpListener;\r\nuse tokio_core::reactor::Core;\r\n\r\nuse std::io::Write;\r\n\r\nfn main() {\r\n    // Create the event loop that will drive this server\r\n    let mut core = Core::new().unwrap();\r\n    let handle = core.handle();\r\n\r\n    // Bind the server's socket\r\n    let addr = \"127.0.0.1:12345\".parse().unwrap();\r\n    let sock = TcpListener::bind(&addr, &handle).unwrap();\r\n\r\n    // Pull out a stream of sockets for incoming connections\r\n    let server = sock.incoming().for_each(|(sock, _)| {\r\n        // Split up the reading and writing parts of the\r\n        // socket\r\n        let (reader, writer) = sock.split();\r\n\r\n        // A future that echos the data and returns how\r\n        // many bytes were copied...\r\n        let big_string = (0..1000000).map(|_| \"X\").collect::<String>();\r\n        let bytes_copied = write_all(writer, big_string);\r\n        // sock.write(&big_string.into_bytes());\r\n        // let bytes_copied = copy(reader, writer);\r\n\r\n        // ... after which we'll print what happened\r\n        let handle_conn = bytes_copied.map(|_| println!(\"wrote bytes\"))\r\n            .map_err(|err| println!(\"IO error {:?}\", err));\r\n\r\n        // Spawn the future as a concurrent task\r\n        handle.spawn(handle_conn);\r\n\r\n        Ok(())\r\n    });\r\n\r\n    println!(\"Starting up server on {:?}.\", addr);\r\n    // Spin up the server on the event loop\r\n    core.run(server).unwrap();\r\n}\r\n```\r\n","closed_by":{"login":"radix","id":227068,"node_id":"MDQ6VXNlcjIyNzA2OA==","avatar_url":"https://avatars.githubusercontent.com/u/227068?v=4","gravatar_id":"","url":"https://api.github.com/users/radix","html_url":"https://github.com/radix","followers_url":"https://api.github.com/users/radix/followers","following_url":"https://api.github.com/users/radix/following{/other_user}","gists_url":"https://api.github.com/users/radix/gists{/gist_id}","starred_url":"https://api.github.com/users/radix/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/radix/subscriptions","organizations_url":"https://api.github.com/users/radix/orgs","repos_url":"https://api.github.com/users/radix/repos","events_url":"https://api.github.com/users/radix/events{/privacy}","received_events_url":"https://api.github.com/users/radix/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/hyperium/hyper/issues/1010/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/hyperium/hyper/issues/1010/timeline","performed_via_github_app":null,"state_reason":"completed"}