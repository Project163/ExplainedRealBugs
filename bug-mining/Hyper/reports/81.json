{"url":"https://api.github.com/repos/hyperium/hyper/issues/774","repository_url":"https://api.github.com/repos/hyperium/hyper","labels_url":"https://api.github.com/repos/hyperium/hyper/issues/774/labels{/name}","comments_url":"https://api.github.com/repos/hyperium/hyper/issues/774/comments","events_url":"https://api.github.com/repos/hyperium/hyper/issues/774/events","html_url":"https://github.com/hyperium/hyper/issues/774","id":151432130,"node_id":"MDU6SXNzdWUxNTE0MzIxMzA=","number":774,"title":"Proxy handling does not properly set destination Host header","user":{"login":"shaleh","id":1377996,"node_id":"MDQ6VXNlcjEzNzc5OTY=","avatar_url":"https://avatars.githubusercontent.com/u/1377996?v=4","gravatar_id":"","url":"https://api.github.com/users/shaleh","html_url":"https://github.com/shaleh","followers_url":"https://api.github.com/users/shaleh/followers","following_url":"https://api.github.com/users/shaleh/following{/other_user}","gists_url":"https://api.github.com/users/shaleh/gists{/gist_id}","starred_url":"https://api.github.com/users/shaleh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shaleh/subscriptions","organizations_url":"https://api.github.com/users/shaleh/orgs","repos_url":"https://api.github.com/users/shaleh/repos","events_url":"https://api.github.com/users/shaleh/events{/privacy}","received_events_url":"https://api.github.com/users/shaleh/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"seanmonstar","id":51479,"node_id":"MDQ6VXNlcjUxNDc5","avatar_url":"https://avatars.githubusercontent.com/u/51479?v=4","gravatar_id":"","url":"https://api.github.com/users/seanmonstar","html_url":"https://github.com/seanmonstar","followers_url":"https://api.github.com/users/seanmonstar/followers","following_url":"https://api.github.com/users/seanmonstar/following{/other_user}","gists_url":"https://api.github.com/users/seanmonstar/gists{/gist_id}","starred_url":"https://api.github.com/users/seanmonstar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/seanmonstar/subscriptions","organizations_url":"https://api.github.com/users/seanmonstar/orgs","repos_url":"https://api.github.com/users/seanmonstar/repos","events_url":"https://api.github.com/users/seanmonstar/events{/privacy}","received_events_url":"https://api.github.com/users/seanmonstar/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"seanmonstar","id":51479,"node_id":"MDQ6VXNlcjUxNDc5","avatar_url":"https://avatars.githubusercontent.com/u/51479?v=4","gravatar_id":"","url":"https://api.github.com/users/seanmonstar","html_url":"https://github.com/seanmonstar","followers_url":"https://api.github.com/users/seanmonstar/followers","following_url":"https://api.github.com/users/seanmonstar/following{/other_user}","gists_url":"https://api.github.com/users/seanmonstar/gists{/gist_id}","starred_url":"https://api.github.com/users/seanmonstar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/seanmonstar/subscriptions","organizations_url":"https://api.github.com/users/seanmonstar/orgs","repos_url":"https://api.github.com/users/seanmonstar/repos","events_url":"https://api.github.com/users/seanmonstar/events{/privacy}","received_events_url":"https://api.github.com/users/seanmonstar/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":2,"created_at":"2016-04-27T16:39:51Z","updated_at":"2016-05-04T17:53:24Z","closed_at":"2016-05-04T17:53:24Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Here is a script transcript of a working proxy session\n\n```\nScript started on Wed 27 Apr 2016 09:32:58 AM PDT\n[~/repos/rust/hyper-upstream]\n~$ telnet my-proxy 8080\nTrying x.x.x.x...\nConnected to my-proxy.\nEscape character is '^]'.\nGET http://xkcd.com http/1.1\nhost: xkcd.com:80\n\nHTTP/1.1 200 OK\nCache-Control: public, max-age=300\nExpires: Wed, 27 Apr 2016 16:23:15 GMT\nContent-Type: text/html; charset=utf-8\nETag: \"1703862119\"\nLast-Modified: Wed, 27 Apr 2016 05:16:40 GMT\nServer: lighttpd/1.4.28\nContent-Length: 6196\nAccept-Ranges: bytes\nDate: Wed, 27 Apr 2016 16:18:15 GMT\nVia: 1.1 varnish\nX-Served-By: cache-dfw1838-DFW\nX-Cache: HIT\nX-Cache-Hits: 1\nX-Timer: S1461772234.306036,VS0,VE0\nVary: Accept-Encoding\nProxy-Connection: Keep-Alive\nConnection: Keep-Alive\nAge: 971\n```\n\nNote the destination is specified TWICE. Once on the GET and once again in the Host line. The current client code does not set the Host correctly.\n\nHere is the diff needed to fix it:\n\n```\ndiff --git a/src/client/mod.rs b/src/client/mod.rs\nindex 4ad5c2d..ad0b14d 100644\n--- a/src/client/mod.rs\n+++ b/src/client/mod.rs\n@@ -271,10 +271,10 @@ impl<'a> RequestBuilder<'a> {\n\n         loop {\n             let mut req = {\n+                let hp = try!(get_host_and_port(&url));\n                 let (scheme, host, port) = match client.proxy {\n                     Some(ref proxy) => (proxy.0.as_ref(), proxy.1.as_ref(), proxy.2),\n                     None => {\n-                        let hp = try!(get_host_and_port(&url));\n                         (url.scheme(), hp.0, hp.1)\n                     }\n                 };\n@@ -282,11 +282,14 @@ impl<'a> RequestBuilder<'a> {\n                     Some(ref headers) => headers.clone(),\n                     None => Headers::new(),\n                 };\n+                // Host needs to be the destination host not the proxy\n                 headers.set(Host {\n-                    hostname: host.to_owned(),\n-                    port: Some(port),\n+                    hostname: hp.0.to_owned(),\n+                    port: Some(hp.1),\n                 });\n+                // now connect to the proxy\n                 let message = try!(client.protocol.new_message(&host, port, scheme));\n+                // and make a request for the destination\n                 Request::with_headers_and_message(method.clone(), url.clone(), headers, messag\\\n```\n\ne)\n                 };\n","closed_by":{"login":"seanmonstar","id":51479,"node_id":"MDQ6VXNlcjUxNDc5","avatar_url":"https://avatars.githubusercontent.com/u/51479?v=4","gravatar_id":"","url":"https://api.github.com/users/seanmonstar","html_url":"https://github.com/seanmonstar","followers_url":"https://api.github.com/users/seanmonstar/followers","following_url":"https://api.github.com/users/seanmonstar/following{/other_user}","gists_url":"https://api.github.com/users/seanmonstar/gists{/gist_id}","starred_url":"https://api.github.com/users/seanmonstar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/seanmonstar/subscriptions","organizations_url":"https://api.github.com/users/seanmonstar/orgs","repos_url":"https://api.github.com/users/seanmonstar/repos","events_url":"https://api.github.com/users/seanmonstar/events{/privacy}","received_events_url":"https://api.github.com/users/seanmonstar/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/hyperium/hyper/issues/774/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/hyperium/hyper/issues/774/timeline","performed_via_github_app":null,"state_reason":"completed"}