<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:22:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HTTPCLIENT-2152] I/O reactor shutdown when endpoint is closed</title>
                <link>https://issues.apache.org/jira/browse/HTTPCLIENT-2152</link>
                <project id="12310360" key="HTTPCLIENT">HttpComponents HttpClient</project>
                    <description>&lt;p&gt;I am using async http client for real time bidding project in a cluster of servers. Each server execute around 6K request per second and sometimes each server restarted becase I/O reactor is shutdown. It seems that there is a race condition in the code that produces this behavior.&lt;/p&gt;

&lt;p&gt;It seems that the race condition appears between this method:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;org.apache.hc.client5.http.impl.async.AsyncConnectExec$1.completed()&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;and this method:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;org.apache.hc.client5.http.impl.nio.PoolingAsyncClientConnectionManager$InternalConnectionEndpoint.setSocketTimeout()&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;because in the first method the endpoint is connected but in the second one this code fails:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ManagedHttpClientConnection getValidatedConnection() { &#160; &#160;
   &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ManagedHttpClientConnection conn = getConnection(); &#160; &#160;
   Asserts.check(conn.isOpen(), &lt;span class=&quot;code-quote&quot;&gt;&quot;Endpoint is not connected&quot;&lt;/span&gt;); &#160; &#160;
   &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; conn; 
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13373490">HTTPCLIENT-2152</key>
            <summary>I/O reactor shutdown when endpoint is closed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="Acabanillas">Abraham Cabanillas</reporter>
                        <labels>
                    </labels>
                <created>Mon, 19 Apr 2021 07:17:03 +0000</created>
                <updated>Sat, 1 May 2021 14:08:45 +0000</updated>
                            <resolved>Sat, 1 May 2021 14:08:45 +0000</resolved>
                                    <version>5.0.3</version>
                    <version>5.1-beta1</version>
                                    <fixVersion>5.0.4</fixVersion>
                    <fixVersion>5.1</fixVersion>
                                    <component>HttpClient (async)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="13800">3h 50m</timespent>
                                <comments>
                            <comment id="17324899" author="olegk" created="Mon, 19 Apr 2021 09:20:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Acabanillas&quot; class=&quot;user-hover&quot; rel=&quot;Acabanillas&quot;&gt;Acabanillas&lt;/a&gt; I will see what I can do just by looking at the exception stack trace. A test case with a reproducer would be really nice.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17326354" author="acabanillas" created="Wed, 21 Apr 2021 08:20:46 +0000"  >&lt;p&gt;I have been trying to reproduce it but it is quite difficult. This is something happening once or twice per day in severs with around 6K request per second.&lt;/p&gt;

&lt;p&gt;But what it seems clear is that this method `setSocketTimeout()` shouldn&apos;t shutdown I/O reactor when endpoint is closed.&lt;/p&gt;

&lt;p&gt;This method generate a&#160;java.lang.IllegalStateException exception that is caught in org.apache.hc.core5.reactor.InternalChannel.handleIOEvent() and closing the I/O reactor.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; void handleIOEvent(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; ops) {
  &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
    onIOEvent(ops);
  } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; CancelledKeyException ex) {
    close(CloseMode.GRACEFUL);
  } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Exception ex) {
    onException(ex);
    close(CloseMode.IMMEDIATE);
  }
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17326435" author="olegk" created="Wed, 21 Apr 2021 10:58:46 +0000"  >&lt;p&gt;&amp;gt; org.apache.hc.core5.reactor.InternalChannel.handleIOEvent() and closing the I/O reactor&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Acabanillas&quot; class=&quot;user-hover&quot; rel=&quot;Acabanillas&quot;&gt;Acabanillas&lt;/a&gt; I do not think this is the case. The `InternalChannel#handleIOEvent()` method would only close the I/O session associated with the channel, not the entire I/O reactor.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17326508" author="olegk" created="Wed, 21 Apr 2021 12:54:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Acabanillas&quot; class=&quot;user-hover&quot; rel=&quot;Acabanillas&quot;&gt;Acabanillas&lt;/a&gt; I think I know what the problem is. Essentially it appears the automatic asyc request re-execution in its present form is broken. As a temporary work-around I recommend using a noop `HttpRequestRetryStrategy` implementation that always returns false from `#retryRequest`&lt;/p&gt;

&lt;p&gt;I am working on a proper fix for the defect.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17326567" author="acabanillas" created="Wed, 21 Apr 2021 14:12:54 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;. In the meantime I am going to try with the work-around you recommend.&lt;/p&gt;</comment>
                            <comment id="17329014" author="jira-bot" created="Thu, 22 Apr 2021 12:24:59 +0000"  >&lt;p&gt;Commit 35e16297976afc1dba9427837d6b1b0928f249bc in httpcomponents-client&apos;s branch refs/heads/5.0.x from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=35e1629&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=35e1629&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2152&quot; title=&quot;I/O reactor shutdown when endpoint is closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2152&quot;&gt;&lt;del&gt;HTTPCLIENT-2152&lt;/del&gt;&lt;/a&gt;: Fixed handling of unexpected unchecked exception by the async request retry exec interceptor&lt;/p&gt;</comment>
                            <comment id="17329082" author="jira-bot" created="Thu, 22 Apr 2021 12:30:18 +0000"  >&lt;p&gt;Commit a024eaab70f0bc9f1fac7d306f7c5fabf89422c1 in httpcomponents-client&apos;s branch refs/heads/5.0.x from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=a024eaa&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=a024eaa&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2152&quot; title=&quot;I/O reactor shutdown when endpoint is closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2152&quot;&gt;&lt;del&gt;HTTPCLIENT-2152&lt;/del&gt;&lt;/a&gt;: Fixed handling of unexpected unchecked exception by the async request retry exec interceptor&lt;/p&gt;</comment>
                            <comment id="17329083" author="olegk" created="Thu, 22 Apr 2021 12:33:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Acabanillas&quot; class=&quot;user-hover&quot; rel=&quot;Acabanillas&quot;&gt;Acabanillas&lt;/a&gt; I found a way to fix the immediate problem with the exception handling code in the async request retry exec interceptor &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;. Please try out the latest HttpClient 5.0.x snapshot and let me know if that resolves the problem for you. I will be working on a better fix for 5.1.x and 5.2.x.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/httpcomponents-client/commit/a024eaab70f0bc9f1fac7d306f7c5fabf89422c1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/commit/a024eaab70f0bc9f1fac7d306f7c5fabf89422c1&lt;/a&gt;&lt;/p&gt;
</comment>
                            <comment id="17329169" author="acabanillas" created="Thu, 22 Apr 2021 14:47:34 +0000"  >&lt;p&gt;Ok, I am going to check it, thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;.&#160;&lt;/p&gt;</comment>
                            <comment id="17331522" author="olegk" created="Sun, 25 Apr 2021 13:45:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Acabanillas&quot; class=&quot;user-hover&quot; rel=&quot;Acabanillas&quot;&gt;Acabanillas&lt;/a&gt; I would really appreciate if you could also test this fix for the 5.1.x / 5.2.x branches.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/httpcomponents-client/pull/304&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/pull/304&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17331861" author="acabanillas" created="Mon, 26 Apr 2021 07:27:03 +0000"  >&lt;p&gt;No problem, I can check it, of course. Give me some days to be sure every branch is working fine.&lt;/p&gt;</comment>
                            <comment id="17332932" author="jira-bot" created="Tue, 27 Apr 2021 05:13:25 +0000"  >&lt;p&gt;Commit e10ba0873b1a123a8f3dae96389b14b81428d0ed in httpcomponents-client&apos;s branch refs/heads/master from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=e10ba08&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=e10ba08&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2152&quot; title=&quot;I/O reactor shutdown when endpoint is closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2152&quot;&gt;&lt;del&gt;HTTPCLIENT-2152&lt;/del&gt;&lt;/a&gt;: Fixed handling of unexpected unchecked exception by the async request retry exec interceptor&lt;/p&gt;</comment>
                            <comment id="17333031" author="acabanillas" created="Tue, 27 Apr 2021 08:22:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;&#160;it is working fine on 5.0.x. Let me check it in&#160;5.1.x / 5.2.x branches&lt;/p&gt;</comment>
                            <comment id="17333136" author="jira-bot" created="Tue, 27 Apr 2021 11:08:44 +0000"  >&lt;p&gt;Commit 09f50cd80c9cabc9f7532b6063fe67695f5484fa in httpcomponents-client&apos;s branch refs/heads/master from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=09f50cd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=09f50cd&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2152&quot; title=&quot;I/O reactor shutdown when endpoint is closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2152&quot;&gt;&lt;del&gt;HTTPCLIENT-2152&lt;/del&gt;&lt;/a&gt;: Fixed handling of unexpected unchecked exception by the async request retry exec interceptor&lt;/p&gt;</comment>
                            <comment id="17333141" author="jira-bot" created="Tue, 27 Apr 2021 11:13:08 +0000"  >&lt;p&gt;Commit 09f50cd80c9cabc9f7532b6063fe67695f5484fa in httpcomponents-client&apos;s branch refs/heads/5.2.x from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=09f50cd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=09f50cd&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2152&quot; title=&quot;I/O reactor shutdown when endpoint is closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2152&quot;&gt;&lt;del&gt;HTTPCLIENT-2152&lt;/del&gt;&lt;/a&gt;: Fixed handling of unexpected unchecked exception by the async request retry exec interceptor&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13024267" name="httpclient_error_traces.txt" size="18644" author="Acabanillas" created="Mon, 19 Apr 2021 07:15:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 28 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0q6mw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>