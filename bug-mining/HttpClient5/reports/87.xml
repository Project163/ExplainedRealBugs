<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:22:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HTTPCLIENT-2184] Leased Connection Leak after upgrade to 5.1.1</title>
                <link>https://issues.apache.org/jira/browse/HTTPCLIENT-2184</link>
                <project id="12310360" key="HTTPCLIENT">HttpComponents HttpClient</project>
                    <description>&lt;p&gt;Unfortunately I haven&apos;t had a chance to build a local reproducer yet, nor have I had a chance to profile a system experiencing this failure &#8211; I intend to add additional data to this ticket later on as I debug.&lt;/p&gt;


&lt;p&gt;I do have a system deployed where the issue does not reproduce on 5.1, but I can redeploy only changing the httpcomponents-client jar to 5.1.1 (no other transitive dependency changes, etc) and the leak appears. This should rule out bad application code as a root cause, I also have metrics which capture any time a response is not closed, which reports zero leaks in both cases.&lt;/p&gt;

&lt;p&gt;I have attached a graph of my connection pool leased-connections metric, the blue line in the middle represents the first version which took httpcomponents-client 5.1.1, where previously leased connections sat right around zero. There&apos;s a short gap after the blue line ends where we rolled back to the previous release, followed by a few smaller successful attempts to reproduce the issue resulting in large sets of leased connections.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13411326">HTTPCLIENT-2184</key>
            <summary>Leased Connection Leak after upgrade to 5.1.1</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ckozak">Carter Kozak</assignee>
                                    <reporter username="ckozak">Carter Kozak</reporter>
                        <labels>
                    </labels>
                <created>Thu, 11 Nov 2021 17:09:45 +0000</created>
                <updated>Sat, 13 Nov 2021 10:59:05 +0000</updated>
                            <resolved>Fri, 12 Nov 2021 22:44:27 +0000</resolved>
                                    <version>5.1.1</version>
                                    <fixVersion>5.1.2</fixVersion>
                                    <component>HttpClient (classic)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3000">50m</timespent>
                                <comments>
                            <comment id="17442399" author="olegk" created="Thu, 11 Nov 2021 18:50:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ckozak&quot; class=&quot;user-hover&quot; rel=&quot;ckozak&quot;&gt;ckozak&lt;/a&gt; What version of HttpCore does the application use?&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17442402" author="ckozak" created="Thu, 11 Nov 2021 18:53:20 +0000"  >&lt;p&gt;5.1.2 in both cases&lt;/p&gt;</comment>
                            <comment id="17442445" author="olegk" created="Thu, 11 Nov 2021 20:32:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ckozak&quot; class=&quot;user-hover&quot; rel=&quot;ckozak&quot;&gt;ckozak&lt;/a&gt; Can you run your application with connection management logging &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; turned on? &lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://hc.apache.org/httpcomponents-client-5.1.x/logging.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hc.apache.org/httpcomponents-client-5.1.x/logging.html&lt;/a&gt;&lt;/p&gt;
</comment>
                            <comment id="17442462" author="ckozak" created="Thu, 11 Nov 2021 21:54:56 +0000"  >&lt;p&gt;I&apos;m working on getting additional logging enabled and accessible, unfortunately the environments where this occurs make the task more challenging than one would hope, so it will take some time to pull logs. I realize that this ticket is very light on details, and I plan to add more information when I can get it. I filed the ticket early in my investigation in case there are other reports of similar issues on 5.1.1.&lt;/p&gt;</comment>
                            <comment id="17442900" author="ckozak" created="Fri, 12 Nov 2021 18:47:05 +0000"  >&lt;p&gt;I&apos;ve done a code dive, built a reproducer, and believe I understand the problem. There was a regression introduced by 5164a4e7b4 (&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2170&quot; title=&quot;NTLM Authentication not working when sending multiple request concurrently&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2170&quot;&gt;&lt;del&gt;HTTPCLIENT-2170&lt;/del&gt;&lt;/a&gt;) which changes the behavior of streamed response entities such that closing the entity (rather than the response object itself) no longer returns the connection to the connection pool, however this only impacts requests with non-repeatable entities (and possibly TRACE requests which receive a response body due to an exceptional response status or non-standard server).&lt;br/&gt;
&#160;&lt;br/&gt;
I&apos;ve added a failing test and a fix in &lt;a href=&quot;https://github.com/apache/httpcomponents-client/pull/325&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/pull/325&lt;/a&gt;&lt;br/&gt;
We may want to prioritize releasing a fix for this, as it&apos;s fairly confusing and subtle, and in most cases will leave connection pools permanently unusable.&lt;/p&gt;</comment>
                            <comment id="17442952" author="jira-bot" created="Fri, 12 Nov 2021 22:35:49 +0000"  >&lt;p&gt;Commit e09c5d0691a23ef06e36bae6986c8fe373580eb7 in httpcomponents-client&apos;s branch refs/heads/master from Carter Kozak&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=e09c5d0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=e09c5d0&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2184&quot; title=&quot;Leased Connection Leak after upgrade to 5.1.1&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2184&quot;&gt;&lt;del&gt;HTTPCLIENT-2184&lt;/del&gt;&lt;/a&gt;: Fix classic client connection reuse&lt;/p&gt;

&lt;p&gt;This fixes an issue in which connections were not returned to the&lt;br/&gt;
pool when requests contained non-repeatable bodies AND responses&lt;br/&gt;
were streamed. When both of these criteria were met, responses&lt;br/&gt;
were returned without ResponseEntityProxy enhancements so that&lt;br/&gt;
closing the response entity or stream no longer completed the&lt;br/&gt;
exchange, thus leaking the connection which forever lived in the&lt;br/&gt;
`leased` state in the connection pool.&lt;/p&gt;</comment>
                            <comment id="17442977" author="jira-bot" created="Fri, 12 Nov 2021 22:42:50 +0000"  >&lt;p&gt;Commit c2240d501be6fbd6796e8ecfa98140bb185090fb in httpcomponents-client&apos;s branch refs/heads/5.1.x from Carter Kozak&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=c2240d5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=c2240d5&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2184&quot; title=&quot;Leased Connection Leak after upgrade to 5.1.1&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2184&quot;&gt;&lt;del&gt;HTTPCLIENT-2184&lt;/del&gt;&lt;/a&gt;: Fix classic client connection reuse&lt;/p&gt;

&lt;p&gt;This fixes an issue in which connections were not returned to the&lt;br/&gt;
pool when requests contained non-repeatable bodies AND responses&lt;br/&gt;
were streamed. When both of these criteria were met, responses&lt;br/&gt;
were returned without ResponseEntityProxy enhancements so that&lt;br/&gt;
closing the response entity or stream no longer completed the&lt;br/&gt;
exchange, thus leaking the connection which forever lived in the&lt;br/&gt;
`leased` state in the connection pool.&lt;/p&gt;</comment>
                            <comment id="17442979" author="ckozak" created="Fri, 12 Nov 2021 22:44:27 +0000"  >&lt;p&gt;I&apos;ve applied the fix to the master and 5.1.x branches. Thanks again for the quick review!&lt;/p&gt;</comment>
                            <comment id="17443048" author="olegk" created="Sat, 13 Nov 2021 09:40:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ckozak&quot; class=&quot;user-hover&quot; rel=&quot;ckozak&quot;&gt;ckozak&lt;/a&gt; Do we need an emergency release?&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17443081" author="ckozak" created="Sat, 13 Nov 2021 10:59:05 +0000"  >&lt;p&gt;I think an emergency release is the best option in this case, otherwise a lot of users will be impacted when they upgrade&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13035985" name="2021-11-11_1095x517_screen.png" size="37518" author="ckozak" created="Thu, 11 Nov 2021 17:02:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0wnpc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>