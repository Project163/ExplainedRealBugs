<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:23:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HTTPCLIENT-2364] Close IMMEDIATE does not work properly on HTTPS-upgraded connection through proxy</title>
                <link>https://issues.apache.org/jira/browse/HTTPCLIENT-2364</link>
                <project id="12310360" key="HTTPCLIENT">HttpComponents HttpClient</project>
                    <description>&lt;p&gt;We are using Apache HTTPClient 5.4.3 to connect in HTTPS to different remote servers through a corporate proxy (connecting in HTTP to the proxy)&lt;/p&gt;

&lt;p&gt;Our application currently need to recreate the httpclient in some cases and before that : it closes the previous &lt;tt&gt;org.apache.hc.client5.http.impl.classic.CloseableHttpClient&lt;/tt&gt; using the IMMEDIATE mode : &lt;tt&gt;httpClient.close(CloseMode.IMMEDIATE&lt;/tt&gt;) :&lt;br/&gt;
however for some remote servers : the close is not immediate at all and take 2 minutes.&lt;/p&gt;

&lt;p&gt;I don&apos;t know which aspect of the remote servers configuration triggers that, but it occurs consistently on specific target servers.&lt;br/&gt;
It happens only when there is &lt;ins&gt;recently used&lt;/ins&gt; http connection in the connection pool (less than 2 minutes apparently)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Trying to figure out the problem :&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;When I enable TLS debug log : I can see that our app is blocked waiting for the response to a TLS close (see trace below)&lt;/li&gt;
	&lt;li&gt;However, from the code of &lt;tt&gt;org.apache.hc.core5.http.impl.io.BHttpConnectionBase#close(org.apache.hc.core5.io.CloseMode)&lt;/tt&gt;, its seems that in IMMEDIATE mode, the SSL socket should be bypassed and that the physical socket should be directly close instead.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Debugging even further it appears that in my use case, the SocketHolder object on the connection does not hold two different sockets but only the ssl one :&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;socketHolder.getSSLSocket() is null&lt;/li&gt;
	&lt;li&gt;socketHolder.getBaseSocket() returns the SSL Socket&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;=&amp;gt; which explains why the Socket.close() is called on a SSLSocket and not the underlying physical one&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;It appears that this situation is linked to the use a proxy :&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the initial connection toward the proxy is plain HTTP =&amp;gt; so initially the socketHolder has only a baseSocket pointing to the physical socket&lt;/li&gt;
	&lt;li&gt;then after the CONNECT operation to the remote server through the proxy : the connection is upgraded to TLS in this method : &lt;tt&gt;org.apache.hc.client5.http.impl.io.DefaultHttpClientConnectionOperator#upgrade&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This method seems to fail to attach both sockets to the connection retaining only the TLS one : &#160; &#160; &#160; &#160; &#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
SSLSocket upgradedSocket = tlsSocketStrategy.upgrade(socket, tlsName.getHostName(), tlsName.getPort(), attachment, context);

conn.bind(upgradedSocket);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I would have expect this instead &lt;ins&gt;(at least for my specific use case)&lt;/ins&gt; :&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
SSLSocket upgradedSocket = tlsSocketStrategy.upgrade(socket, tlsName.getHostName(), tlsName.getPort(), attachment, context);

conn.bind(upgradedSocket, socket);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;Here the TLS log on close (with only one connection in the pool) :&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;18:11:23.498 [main] DEBUG org.apache.hc.client5.http.impl.io.PoolingHttpClientConnectionManager - Shutdown connection pool IMMEDIATE
18:11:23.498 [main] DEBUG org.apache.hc.client5.http.impl.io.DefaultManagedHttpClientConnection - http-outgoing-0 close connection IMMEDIATE
javax.net.ssl|DEBUG|10|main|2025-03-28 18:11:23.498 CET|SSLSocketImpl.java:577|duplex close of SSLSocket
javax.net.ssl|DEBUG|10|main|2025-03-28 18:11:23.500 CET|SSLSocketOutputRecord.java:71|WRITE: TLSv1.2 alert(close_notify), length = 10
javax.net.ssl|DEBUG|10|main|2025-03-28 18:11:23.500 CET|SSLCipher.java:1773|Plaintext before ENCRYPTION (
&#160; 0000: 01 00 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;..
)
javax.net.ssl|DEBUG|10|main|2025-03-28 18:11:23.501 CET|SSLSocketOutputRecord.java:85|Raw write (
&#160; 0000: 15 03 03 00 1A 00 00 00 &#160; 00 00 00 00 02 7B C3 9A &#160;................
&#160; 0010: 10 31 40 75 4D C5 AA 32 &#160; A9 C3 4A 3F 77 F1 80 &#160; &#160; .1@uM..2..J?w..
)
javax.net.ssl|DEBUG|10|main|2025-03-28 18:11:23.501 CET|SSLSocketImpl.java:1759|close the underlying socket
javax.net.ssl|DEBUG|10|main|2025-03-28 18:11:23.502 CET|SSLSocketImpl.java:1785|close the SSL connection (initiative)
javax.net.ssl|DEBUG|10|main|2025-03-28 18:11:23.502 CET|SSLSocketImpl.java:1837|wait for close_notify or alert
javax.net.ssl|DEBUG|10|main|2025-03-28 18:13:23.530 CET|SSLSocketInputRecord.java:487|Raw read: EOF
javax.net.ssl|DEBUG|10|main|2025-03-28 18:13:23.531 CET|SSLSocketImpl.java:837|close inbound of SSLSocket
javax.net.ssl|ALL|10|main|2025-03-28 18:13:23.532 CET|SSLSocketImpl.java:1847|discard plaintext while waiting for close (
contentType: 0/majorVersion: 0/minorVersion: 0/recordEpoch: -1/recordSN: 0xffffffffffffffff/fragment: null
)
18:13:23.532 [main] DEBUG org.apache.hc.client5.http.impl.io.PoolingHttpClientConnectionManager - Connection pool shut down&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Those traces has been captured on Windows.&lt;br/&gt;
But the issue also occurs in linux-based production server.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13613491">HTTPCLIENT-2364</key>
            <summary>Close IMMEDIATE does not work properly on HTTPS-upgraded connection through proxy</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="farraultdedge">Fabien Arrault</reporter>
                        <labels>
                    </labels>
                <created>Fri, 28 Mar 2025 17:58:32 +0000</created>
                <updated>Mon, 31 Mar 2025 11:47:55 +0000</updated>
                            <resolved>Mon, 31 Mar 2025 11:47:55 +0000</resolved>
                                    <version>5.4.3</version>
                                    <fixVersion>5.4.4</fixVersion>
                    <fixVersion>5.5</fixVersion>
                                    <component>HttpClient (classic)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17939476" author="olegk" created="Sun, 30 Mar 2025 11:36:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=farraultdedge&quot; class=&quot;user-hover&quot; rel=&quot;farraultdedge&quot;&gt;farraultdedge&lt;/a&gt; Your analysis is absolutely correct. Please review / test test the proposed fix:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/httpcomponents-client/compare/5.4.x...ok2c:HTTPCLIENT-2364&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/compare/5.4.x...ok2c:HTTPCLIENT-2364&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17939587" author="JIRAUSER308482" created="Mon, 31 Mar 2025 08:21:24 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;I tested with your branch and it works correctly with it : the close is really immediate.&lt;/p&gt;


&lt;p&gt;Thanks for your fix.&lt;/p&gt;</comment>
                            <comment id="17939654" author="jira-bot" created="Mon, 31 Mar 2025 11:46:53 +0000"  >&lt;p&gt;Commit 93a87be7f6a9e91740fdd7ba0f4788870bdaecc8 in httpcomponents-client&apos;s branch refs/heads/5.4.x from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=93a87be7f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=93a87be7f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2364&quot; title=&quot;Close IMMEDIATE does not work properly on HTTPS-upgraded connection through proxy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2364&quot;&gt;&lt;del&gt;HTTPCLIENT-2364&lt;/del&gt;&lt;/a&gt;: Fixed incorrect re-binding of the upgraded SSL socket to the HTTP connection by the #upgrade method of the DefaultHttpClientConnectionOperator&lt;/p&gt;</comment>
                            <comment id="17939655" author="jira-bot" created="Mon, 31 Mar 2025 11:47:11 +0000"  >&lt;p&gt;Commit f3b153684320344ca000aada210b9130d422ff0c in httpcomponents-client&apos;s branch refs/heads/master from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=f3b153684&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=f3b153684&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2364&quot; title=&quot;Close IMMEDIATE does not work properly on HTTPS-upgraded connection through proxy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2364&quot;&gt;&lt;del&gt;HTTPCLIENT-2364&lt;/del&gt;&lt;/a&gt;: Fixed incorrect re-binding of the upgraded SSL socket to the HTTP connection by the #upgrade method of the DefaultHttpClientConnectionOperator&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            31 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1v25s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>