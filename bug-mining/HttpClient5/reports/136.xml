<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:23:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HTTPCLIENT-2379] Multiple removal of same PoolEntry causes IllegalStateException in H2SharingConnPool</title>
                <link>https://issues.apache.org/jira/browse/HTTPCLIENT-2379</link>
                <project id="12310360" key="HTTPCLIENT">HttpComponents HttpClient</project>
                    <description>&lt;p&gt;After enabling messageMultiplexing, the H2SharingConnPool is used to reuse PoolEntry.&lt;br/&gt;
When making more than one request using the same connection, if the connection is closed,&lt;br/&gt;
the pool.release(entry, reusable) method at H2SharingConnPool.java:183 will throw the following exception:&lt;/p&gt;

&lt;p&gt;~~~java&lt;br/&gt;
throw new IllegalStateException(&quot;Pool entry is not present in the set of leased entries&quot;);&lt;br/&gt;
~~~&lt;/p&gt;

&lt;p&gt;This occurs because the same connection is being removed multiple times.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/yhzdys/httpcomponents-client/commit/c8256b33c3adb45cfa2a49efb2dacfb611da9ac1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/yhzdys/httpcomponents-client/commit/c8256b33c3adb45cfa2a49efb2dacfb611da9ac1&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13622297">HTTPCLIENT-2379</key>
            <summary>Multiple removal of same PoolEntry causes IllegalStateException in H2SharingConnPool</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="yhzdys">yhzdys</reporter>
                        <labels>
                    </labels>
                <created>Wed, 2 Jul 2025 06:28:32 +0000</created>
                <updated>Sun, 6 Jul 2025 14:26:30 +0000</updated>
                            <resolved>Sun, 6 Jul 2025 12:00:27 +0000</resolved>
                                    <version>5.5</version>
                                    <fixVersion>5.5.1</fixVersion>
                    <fixVersion>5.6-alpha1</fixVersion>
                                    <component>HttpClient (async)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="9600">2h 40m</timespent>
                                <comments>
                            <comment id="17987376" author="olegk" created="Wed, 2 Jul 2025 08:47:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhzdys&quot; class=&quot;user-hover&quot; rel=&quot;yhzdys&quot;&gt;yhzdys&lt;/a&gt; Many thanks for reporting the defect. Would you be willing to contribute the test to the project?&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17987378" author="JIRAUSER307428" created="Wed, 2 Jul 2025 08:55:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt; Sure, I&apos;ll help. Should I submit a PR on GitHub?&lt;/p&gt;</comment>
                            <comment id="17987422" author="olegk" created="Wed, 2 Jul 2025 09:10:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhzdys&quot; class=&quot;user-hover&quot; rel=&quot;yhzdys&quot;&gt;yhzdys&lt;/a&gt; Please do so. You are also welcome to propose a fix as well.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17988065" author="jira-bot" created="Thu, 3 Jul 2025 06:05:18 +0000"  >&lt;p&gt;Commit 5c6c135a8b33eadd3b6867fe280c7fd9b69dc1d9 in httpcomponents-client&apos;s branch refs/heads/master from yhzdys&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=5c6c135a8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=5c6c135a8&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2379&quot; title=&quot;Multiple removal of same PoolEntry causes IllegalStateException in H2SharingConnPool&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2379&quot;&gt;&lt;del&gt;HTTPCLIENT-2379&lt;/del&gt;&lt;/a&gt;: Add H2SharingConnPool test for multiple removal of same PoolEntry (#665)&lt;/p&gt;
</comment>
                            <comment id="17992856" author="jira-bot" created="Thu, 3 Jul 2025 09:13:29 +0000"  >&lt;p&gt;Commit 2c159a572a6ba46e147cf4acc582e16405d82b01 in httpcomponents-client&apos;s branch refs/heads/5.5.x from yhzdys&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=2c159a572&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=2c159a572&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2379&quot; title=&quot;Multiple removal of same PoolEntry causes IllegalStateException in H2SharingConnPool&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2379&quot;&gt;&lt;del&gt;HTTPCLIENT-2379&lt;/del&gt;&lt;/a&gt;: Add H2SharingConnPool test for multiple removal of same PoolEntry (#665)&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 5c6c135a8b33eadd3b6867fe280c7fd9b69dc1d9)&lt;/p&gt;</comment>
                            <comment id="17993102" author="olegk" created="Thu, 3 Jul 2025 14:43:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhzdys&quot; class=&quot;user-hover&quot; rel=&quot;yhzdys&quot;&gt;yhzdys&lt;/a&gt; Many thanks for contributing the test case. Here is the problem though. Per design the same PoolEntry should be released exactly the same number of times as it has been leased from `H2SharingConnPool`. There is an atomic counter for it. Therefore it should reach count zero only once and should be released back to the parent pool only once.&lt;/p&gt;

&lt;p&gt;What is it exactly you are doing that causes the same PoolEntry&#160; to be released more times than it has been leased?&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;

&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=abernal&quot; class=&quot;user-hover&quot; rel=&quot;abernal&quot;&gt;abernal&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17993121" author="JIRAUSER307428" created="Thu, 3 Jul 2025 16:06:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt; This is the scenario where I encountered the problem:&lt;/p&gt;


&lt;p&gt;When multiple HTTP requests (two or more) are executed concurrently, they may reuse the same poolEntry (connection).&lt;/p&gt;

&lt;p&gt;After this poolEntry (connection) is leased and then CLOSED by the server side, the release method of H2SharingConnPool is called.&lt;/p&gt;

&lt;p&gt;However, the release method checks if the connection is already closed &#8212; if so, it directly removes the entry and returns 0, without decreasing the counter of the poolEntry.&lt;/p&gt;

&lt;p&gt;As a result, the same poolEntry (connection) may be released multiple times by the underlying ManagedConnPool.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/httpcomponents-client/blob/6e0a18f2c2a6f976773b911869340b97545c632c/httpclient5/src/main/java/org/apache/hc/client5/http/impl/nio/H2SharingConnPool.java#L293&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/blob/6e0a18f2c2a6f976773b911869340b97545c632c/httpclient5/src/main/java/org/apache/hc/client5/http/impl/nio/H2SharingConnPool.java#L293&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17993123" author="JIRAUSER307428" created="Thu, 3 Jul 2025 16:19:14 +0000"  >&lt;p&gt;I believe this is a serious issue, because once the IllegalStateException occurs during execution, the IOReactor thread of the HttpClient instance will be shut down. As a result, the HttpClient instance becomes completely unavailable.&lt;/p&gt;

&lt;p&gt;See: &lt;a href=&quot;https://github.com/apache/httpcomponents-core/blob/9e338c853630f1e02b66b033b3edd3c6cd10aa6d/httpcore5/src/main/java/org/apache/hc/core5/reactor/AbstractSingleCoreIOReactor.java#L103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-core/blob/9e338c853630f1e02b66b033b3edd3c6cd10aa6d/httpcore5/src/main/java/org/apache/hc/core5/reactor/AbstractSingleCoreIOReactor.java#L103&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17993128" author="abernal" created="Thu, 3 Jul 2025 16:41:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;The counter logic itself looks fine IMO&#8212;the issue seems to be in the &lt;b&gt;second call&lt;/b&gt; to &lt;tt&gt;release()&lt;/tt&gt; on the same &lt;tt&gt;PoolEntry&lt;/tt&gt; after it has already been handed back to the parent pool.&lt;br/&gt;
Adding this one-line guard in &lt;tt&gt;H2SharingConnPool#release&lt;/tt&gt; turns that duplicate call into a no-op and keeps the &#8220;count-zero-only-once&#8221; invariant intact:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (perRoutePool != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; perRoutePool.getCount(entry) == 0) {
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;; &#160; &lt;span class=&quot;code-comment&quot;&gt;// duplicate release &#8211; ignore
&lt;/span&gt;} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;With this check the first release delegates once (as designed); later releases are ignored, so the delegate pool never sees the entry again and the &lt;tt&gt;IllegalStateException&lt;/tt&gt; disappears.&#160; I&apos;m saying something stupid??&#160;&lt;/p&gt;</comment>
                            <comment id="17993400" author="JIRAUSER307428" created="Fri, 4 Jul 2025 03:37:29 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (perRoutePool != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; perRoutePool.getCount(entry) == 0) {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;; &lt;span class=&quot;code-comment&quot;&gt;// duplicate release &#8211; ignore
&lt;/span&gt;}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=abernal&quot; class=&quot;user-hover&quot; rel=&quot;abernal&quot;&gt;abernal&lt;/a&gt; This fix &lt;b&gt;LGTM&lt;/b&gt; for now.&lt;/p&gt;</comment>
                            <comment id="17995760" author="olegk" created="Fri, 4 Jul 2025 12:32:28 +0000"  >&lt;p&gt;&amp;gt; I believe this is a serious issue&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhzdys&quot; class=&quot;user-hover&quot; rel=&quot;yhzdys&quot;&gt;yhzdys&lt;/a&gt; Nowhere did I say it was not serious. In fact I find it so serious so I want to take time and come up with a proper solution&lt;/p&gt;

&lt;p&gt;&amp;gt; With this check the first release delegates once (as designed); later releases are ignored, so the delegate pool never sees the entry again and the &lt;tt&gt;IllegalStateException&lt;/tt&gt; disappears.&#160; I&apos;m saying something stupid??&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=abernal&quot; class=&quot;user-hover&quot; rel=&quot;abernal&quot;&gt;abernal&lt;/a&gt; No, you are not. This is a fairly obvious and straight-forward of making the immediate problem go disappear. But please consider this: with the proposed change every time the pool gets a PoolEntry that looks not OK it &lt;em&gt;has&lt;/em&gt; to assume this PoolEntry has been previously released. What if it is not? What if there was a defect in the caller code?&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17995790" author="abernal" created="Fri, 4 Jul 2025 16:37:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&#8217;ve trimmed the fix to two minimal checks:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;PerRoutePool.release&lt;br/&gt;
decrement first; evict only when the counter reaches 0; throw if the entry was never tracked&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; AtomicLong counter = entryMap.get(entry);
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (counter == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) { &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// caller defect
&lt;/span&gt;&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalStateException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Untracked PoolEntry released&quot;&lt;/span&gt;);
}
&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; remaining = counter.decrementAndGet();
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (remaining == 0) {
&#160; &#160; entryMap.remove(entry); &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// delegate once, on last release
&lt;/span&gt;}
&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; remaining; &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and H2SharingConnPool.release&lt;br/&gt;
ignore only the duplicate call that comes after the counter hit 0&lt;br/&gt;
&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (perRoutePool != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; perRoutePool.getCount(entry) == 0) {
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// duplicate release &#8211; no-op
&lt;/span&gt;} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;First (real) release delegates exactly once. Subsequent releases of the same entry are ignored, so the parent pool is not hit again. If an entry is released that was never tracked, we still fail fast. Does this look acceptable?&lt;/p&gt;</comment>
                            <comment id="17995798" author="olegk" created="Fri, 4 Jul 2025 17:53:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=abernal&quot; class=&quot;user-hover&quot; rel=&quot;abernal&quot;&gt;abernal&lt;/a&gt; What I have in mind is to continue counting even if the underlying connection had been closed but fail if the counter is at zero (by releasing the entry to the ConnPool and letting it take a decision). I do not quite like the idea of just ignoting duplicate releases.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17995843" author="abernal" created="Sat, 5 Jul 2025 06:36:49 +0000"  >&lt;p&gt;Got it,.&lt;/p&gt;

&lt;p&gt;I&#8217;ll update the code to keep counting until zero and modify the current &#160;a PR with that implementation.&lt;/p&gt;</comment>
                            <comment id="17997752" author="olegk" created="Sat, 5 Jul 2025 10:33:51 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13077316/13077316_HTTPCLIENT-2379__release_of_closed___ivalid_pool_entries_by_H2SharingConnPool_can_cause_in.patch&quot; title=&quot;HTTPCLIENT-2379__release_of_closed___ivalid_pool_entries_by_H2SharingConnPool_can_cause_in.patch attached to HTTPCLIENT-2379&quot;&gt;HTTPCLIENT-2379_&lt;em&gt;release_of_closed&lt;/em&gt;__ivalid_pool_entries_by_H2SharingConnPool_can_cause_in.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; This patch should fix the immediate problem. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=abernal&quot; class=&quot;user-hover&quot; rel=&quot;abernal&quot;&gt;abernal&lt;/a&gt; Please take a look.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhzdys&quot; class=&quot;user-hover&quot; rel=&quot;yhzdys&quot;&gt;yhzdys&lt;/a&gt; Could you please try it out in your environment?&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17997756" author="abernal" created="Sat, 5 Jul 2025 10:58:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt; Confirmed&#8212;applied your patch, all unit tests are green and the duplicate-release issue is gone. Looks good to me.&lt;/p&gt;</comment>
                            <comment id="17997757" author="olegk" created="Sat, 5 Jul 2025 11:00:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=abernal&quot; class=&quot;user-hover&quot; rel=&quot;abernal&quot;&gt;abernal&lt;/a&gt; Feel free to incorporate my changes into your PR.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17997758" author="JIRAUSER307428" created="Sat, 5 Jul 2025 11:03:21 +0000"  >&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhzdys&quot; class=&quot;user-hover&quot; rel=&quot;yhzdys&quot;&gt;yhzdys&lt;/a&gt;&#160;Could you please try it out in your environment?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;ok.&lt;/p&gt;</comment>
                            <comment id="17997759" author="JIRAUSER307428" created="Sat, 5 Jul 2025 11:20:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;I haven&apos;t tested this patch in my environment yet, but from what I can see, simply removing the following code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!reusable || connection == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || !connection.isOpen()) {
&#160; &#160; entryMap.remove(entry);
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; 0;
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;may introduce new issues.&lt;/p&gt;

&lt;p&gt;If unreusable or already closed poolEntrys (connections) are not removed, they may be leased again unexpectedly, which could lead to further problems.&lt;/p&gt;</comment>
                            <comment id="17997760" author="JIRAUSER307428" created="Sat, 5 Jul 2025 11:24:29 +0000"  >&lt;p&gt;Maybe we should consider adding a `usable` state flag for PoolEntry, in addition to the counter, to better manage this case.&lt;/p&gt;</comment>
                            <comment id="17997766" author="olegk" created="Sat, 5 Jul 2025 12:29:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhzdys&quot; class=&quot;user-hover&quot; rel=&quot;yhzdys&quot;&gt;yhzdys&lt;/a&gt; Good catch. I think a better solution may be to make sure closed pool entries do not get leased in the first place.&#160;&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17997767" author="abernal" created="Sat, 5 Jul 2025 12:53:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Added an &lt;tt&gt;isOpen()&lt;/tt&gt; filter inside &lt;tt&gt;PerRoutePool.lease()&lt;/tt&gt; so closed entries are skipped; the &#8220;reuse existing connection&#8221;&#160; WDYT?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
PoolEntry&amp;lt;T, C&amp;gt; lease() {
&#160; &#160; lock.lock();
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; entryMap.entrySet().stream()
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; .filter(e -&amp;gt; {
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; C conn = e.getKey().getConnection();
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; conn != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; conn.isOpen();
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; })
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; .min(Comparator.comparingLong(e -&amp;gt; e.getValue().get()))
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; .map(Map.Entry::getKey)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; .map(e -&amp;gt; {
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; entryMap.get(e).incrementAndGet();
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; e;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; })
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; .orElse(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
&#160; &#160; } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
&#160; &#160; &#160; &#160; lock.unlock();
&#160; &#160; }
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17997768" author="olegk" created="Sat, 5 Jul 2025 12:59:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=abernal&quot; class=&quot;user-hover&quot; rel=&quot;abernal&quot;&gt;abernal&lt;/a&gt; Yes, exactly! That makes sense, does it not?&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17998270" author="JIRAUSER307428" created="Sat, 5 Jul 2025 13:12:15 +0000"  >&lt;p&gt;There&apos;s also another case that might be overlooked: even if the connection is still open, if the `reusable` flag is passed as false to the release method, the connection should not be leased again.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/**
&#160;* Releases the pool entry back to the pool.
&#160;*
&#160;* @param entry pool entry leased from the pool
&#160;* @param reusable flag indicating whether or not the released connection is in a consistent state and is safe &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; further use.
&#160;*/
&#160;void release(PoolEntry&amp;lt;T, C&amp;gt; entry, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; reusable);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17998376" author="olegk" created="Sat, 5 Jul 2025 15:07:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhzdys&quot; class=&quot;user-hover&quot; rel=&quot;yhzdys&quot;&gt;yhzdys&lt;/a&gt; Another good catch. Thank you.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17999322" author="olegk" created="Sat, 5 Jul 2025 19:22:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhzdys&quot; class=&quot;user-hover&quot; rel=&quot;yhzdys&quot;&gt;yhzdys&lt;/a&gt; Could you please test the proposed fix &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; locally and let us know if that resolves the problem?&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/httpcomponents-client/pull/663&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/pull/663&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17999737" author="JIRAUSER307428" created="Sun, 6 Jul 2025 05:42:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;&#160;&lt;br/&gt;
I&apos;ve tested this &lt;a href=&quot;https://github.com/apache/httpcomponents-client/pull/663&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR&lt;/a&gt;&#160;in my environment, and the fix works well.&lt;/p&gt;</comment>
                            <comment id="18000461" author="olegk" created="Sun, 6 Jul 2025 09:39:33 +0000"  >&lt;p&gt;&amp;gt; I&apos;ve tested this &lt;a href=&quot;https://github.com/apache/httpcomponents-client/pull/663&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR&lt;/a&gt;&#160;in my environment, and the fix works well.&lt;/p&gt;

&lt;p&gt;Great! Good team work &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhzdys&quot; class=&quot;user-hover&quot; rel=&quot;yhzdys&quot;&gt;yhzdys&lt;/a&gt; &#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=abernal&quot; class=&quot;user-hover&quot; rel=&quot;abernal&quot;&gt;abernal&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="18000674" author="jira-bot" created="Sun, 6 Jul 2025 11:58:03 +0000"  >&lt;p&gt;Commit b1efda3a35e5b991353c54e0d2ec17d7c6dcc299 in httpcomponents-client&apos;s branch refs/heads/master from Arturo Bernal&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=b1efda3a3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=b1efda3a3&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2379&quot; title=&quot;Multiple removal of same PoolEntry causes IllegalStateException in H2SharingConnPool&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2379&quot;&gt;&lt;del&gt;HTTPCLIENT-2379&lt;/del&gt;&lt;/a&gt;: PerRoutePool.release now decrements the counter first and keeps the entry in the map until the count reaches zero, regardless of whether the connection is still open. The entry is handed back to the parent pool exactly once&#8212;on that final release&#8212;and any attempt to release an entry that was never leased now raises an IllegalStateException. (#663)&lt;/p&gt;
</comment>
                            <comment id="18001229" author="jira-bot" created="Sun, 6 Jul 2025 14:26:30 +0000"  >&lt;p&gt;Commit 4086951973ef9c83e8340e1eca88e3cb61dacea5 in httpcomponents-client&apos;s branch refs/heads/5.5.x from Arturo Bernal&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=408695197&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=408695197&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2379&quot; title=&quot;Multiple removal of same PoolEntry causes IllegalStateException in H2SharingConnPool&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2379&quot;&gt;&lt;del&gt;HTTPCLIENT-2379&lt;/del&gt;&lt;/a&gt;: PerRoutePool.release now decrements the counter first and keeps the entry in the map until the count reaches zero, regardless of whether the connection is still open. The entry is handed back to the parent pool exactly once&#8212;on that final release&#8212;and any attempt to release an entry that was never leased now raises an IllegalStateException. (#663)&lt;/p&gt;

&lt;p&gt;(cherry picked from commit b1efda3a35e5b991353c54e0d2ec17d7c6dcc299)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13077316" name="HTTPCLIENT-2379__release_of_closed___ivalid_pool_entries_by_H2SharingConnPool_can_cause_in.patch" size="4815" author="olegk" created="Sat, 5 Jul 2025 10:32:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            17 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1wkhk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>