<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:23:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HTTPCLIENT-2328] Request hangs if TLS 1.3 connection is half-closed </title>
                <link>https://issues.apache.org/jira/browse/HTTPCLIENT-2328</link>
                <project id="12310360" key="HTTPCLIENT">HttpComponents HttpClient</project>
                    <description>&lt;p&gt;If a server with TLS 1.3 support closes the connection during the request, more specifically, sending close_notify while the client is still writing to socket,&#160; the request will hang indefinitely. It&apos;s not an issue with TLS 1.2 because it uses duplex-close policy. With TLS 1.3&apos;s half-closed connection policy, it seems Apache HTTP client is not able to detect connection closure properly. We are able to reproduce the issue with both 4.x and 5.x. I should note that HTTP URL connection does not have this issue.&lt;/p&gt;

&lt;p&gt;The workaround it to set `jdk.tls.acknowledgeCloseNotify` to true (see &lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8208526&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://bugs.openjdk.org/browse/JDK-8208526&lt;/a&gt;), but that would require a lot of users to make changes on their side.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Steps to repro:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Download the attached keystore file&lt;/li&gt;
	&lt;li&gt;Update ksPath in the server code HalfCloseServer.java&#160;to where you download the keystore&lt;/li&gt;
	&lt;li&gt;Run the server, the server will begin listening on &lt;tt&gt;localhost:8081&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Create a random file of size 128MB and update client code &quot;testFile&quot; to where the file is.&lt;/li&gt;
	&lt;li&gt;Run the client, it should hang
	&lt;ul&gt;
		&lt;li&gt;If System.setProperty(&quot;jdk.tls.acknowledgeCloseNotify&quot;, &quot;true&quot;) is uncommented, it will not hang&lt;/li&gt;
		&lt;li&gt;It also won&#8217;t hang if we we force TLS1.2&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13580173">HTTPCLIENT-2328</key>
            <summary>Request hangs if TLS 1.3 connection is half-closed </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="Zoe Wang">Zoe Wang</reporter>
                        <labels>
                    </labels>
                <created>Wed, 22 May 2024 23:41:35 +0000</created>
                <updated>Fri, 23 Aug 2024 12:36:10 +0000</updated>
                            <resolved>Sun, 9 Jun 2024 11:59:14 +0000</resolved>
                                    <version>4.5.14</version>
                    <version>5.3.1</version>
                                    <fixVersion>5.4-beta1</fixVersion>
                                    <component>HttpClient (classic)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17848888" author="olegk" created="Thu, 23 May 2024 08:57:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Zoe+Wang&quot; class=&quot;user-hover&quot; rel=&quot;Zoe Wang&quot;&gt;Zoe Wang&lt;/a&gt; The Java classic i/o model has a well-known limitation: there is no &lt;em&gt;efficient&lt;/em&gt; way of reading from and writing to the same socket at the same time. While the process is busy writing out data it is unable to react to &lt;em&gt;any&lt;/em&gt; incoming events on the same socket. What one can do is solve the problem is to perform an extra short read after each chunk of data written to the socket but this has a substantial performance penalty. &lt;/p&gt;

&lt;p&gt;We provide a ResponseOutOfOrderStrategy so one can configure HttpClient to monitor connection for out-of-sequence events, but it is disabled (no op) by default. It needs to be explicitly enabled.  &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; PoolingHttpClientConnectionManager cm = PoolingHttpClientConnectionManagerBuilder.create()
        .setConnectionFactory(ManagedHttpClientConnectionFactory.builder()
                .responseOutOfOrderStrategy(MonitoringResponseOutOfOrderStrategy.INSTANCE)
                .build())
        .build();
&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (CloseableHttpClient httpclient = HttpClients.custom()
        .setConnectionManager(cm)
        .build()) {

    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; URIScheme uriScheme : URIScheme.values()) {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ClassicHttpRequest request = ClassicRequestBuilder.get()
                .setHttpHost(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HttpHost(uriScheme.id, &lt;span class=&quot;code-quote&quot;&gt;&quot;httpbin.org&quot;&lt;/span&gt;))
                .setPath(&lt;span class=&quot;code-quote&quot;&gt;&quot;/headers&quot;&lt;/span&gt;)
                .build();
        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Executing request &quot;&lt;/span&gt; + request);
        httpclient.execute(request, response -&amp;gt; {
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;----------------------------------------&quot;&lt;/span&gt;);
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(request + &lt;span class=&quot;code-quote&quot;&gt;&quot;-&amp;gt;&quot;&lt;/span&gt; + &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StatusLine(response));
            EntityUtils.consume(response.getEntity());
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        });
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Oleg&lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                            <comment id="17849830" author="zoe wang" created="Mon, 27 May 2024 20:58:00 +0000"  >&lt;p&gt;Hi Oleg, thank you for your response. I just tried enabling responseOutOfOrderStrategy and the request still got stuck. When I enabled SSL logs, it was able to receive close_notify, however, since per TLS 1.3 half-closed connection, the client side is not required to close the outbound connection upon receiving close_notify, the client side kept sending data and got stuck.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;javax.net.ssl|DEBUG|01|main|2024-05-27 13:44:23.111 PDT|Alert.java:238|Received alert message (
&quot;Alert&quot;: {
&#160; &quot;level&quot; &#160; &#160; &#160;: &quot;warning&quot;,
&#160; &quot;description&quot;: &quot;close_notify&quot;
}
)javax.net.ssl|DEBUG|01|main|2024-05-27 13:48:53.165 PDT|SSLSocketOutputRecord.java:334|WRITE: TLSv1.3 application_data, length = 8192
javax.net.ssl|DEBUG|01|main|2024-05-27 13:48:53.168 PDT|SSLCipher.java:2062|Plaintext before ENCRYPTION (
&#160; 0000: 00 00 00 00 00 00 00 00 &#160; 00 00 00 00 00 00 00 00 &#160;................
&#160; 0010: 00 00 00 00 00 00 00 00 &#160; 00 00 00 00 00 00 00 00 &#160;................
&#160; 0020: 00 00 00 00 00 00 00 00 &#160; 00 00 00 00 00 00 00 00 &#160;................
&#160; 0030: 00 00 00 00 00 00 00 00 &#160; 00 00 00 00 00 00 00 00 &#160;................
... keep sending data, request hangs&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;For comparison, this is the SSL log if I use the workaround by enabling jdk.tls.acknowledgeCloseNotify. The request did not hang because the client side sends a close_notify alert back, which caused the connection to be duplex closed.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;javax.net.ssl|DEBUG|01|main|2024-05-27 13:51:54.791 PDT|Alert.java:238|Received alert message (
&quot;Alert&quot;: {
&#160; &quot;level&quot; &#160; &#160; &#160;: &quot;warning&quot;,
&#160; &quot;description&quot;: &quot;close_notify&quot;
}
)
javax.net.ssl|DEBUG|01|main|2024-05-27 13:51:54.791 PDT|SSLSocketOutputRecord.java:71|WRITE: TLSv1.3 alert(close_notify), length = 2
javax.net.ssl|DEBUG|01|main|2024-05-27 13:51:54.791 PDT|SSLCipher.java:2062|Plaintext before ENCRYPTION (
&#160; 0000: 01 00 15 00 00 00 00 00 &#160; 00 00 00 00 00 00 00 00 &#160;................
&#160; 0010: 00 00 00 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; ...
)
javax.net.ssl|DEBUG|01|main|2024-05-27 13:51:54.791 PDT|SSLSocketOutputRecord.java:85|Raw write (
&#160; 0000: 17 03 03 00 23 D5 FB 81 &#160; 70 03 7A 4B AD DF D6 D1 &#160;....#...p.zK....
&#160; 0010: BE 42 49 AB 09 44 82 A2 &#160; D8 47 A2 08 8D 34 86 3B &#160;.BI..D...G...4.;
&#160; 0020: 10 56 CF FB 9F A3 8B 80 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;.V......
)
javax.net.ssl|DEBUG|01|main|2024-05-27 13:51:54.792 PDT|SSLSocketImpl.java:578|duplex close of SSLSocket
javax.net.ssl|DEBUG|01|main|2024-05-27 13:51:54.792 PDT|SSLSocketImpl.java:1760|close the SSL connection (passive)
Exception in thread &quot;main&quot; java.net.SocketException: Connection or outbound has closed
&#160; &#160; at java.base/sun.security.ssl.SSLSocketImpl$AppOutputStream.write(SSLSocketImpl.java:1302)
&#160; &#160; at org.apache.hc.core5.http.impl.io.DefaultBHttpClientConnection$1.write(DefaultBHttpClientConnection.java:231)
&#160; &#160; at org.apache.hc.core5.http.impl.io.SessionOutputBufferImpl.flushBuffer(SessionOutputBufferImpl.java:117)
&#160; &#160; at org.apache.hc.core5.http.impl.io.SessionOutputBufferImpl.write(SessionOutputBufferImpl.java:150)
&#160; &#160; at org.apache.hc.core5.http.impl.io.ContentLengthOutputStream.write(ContentLengthOutputStream.java:112)
&#160; &#160; at org.apache.hc.core5.http.io.entity.InputStreamEntity.writeTo(InputStreamEntity.java:106)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.RequestEntityProxy.writeTo(RequestEntityProxy.java:106)
&#160; &#160; at org.apache.hc.core5.http.impl.io.DefaultBHttpClientConnection.sendRequestEntity(DefaultBHttpClientConnection.java:252)
&#160; &#160; at org.apache.hc.core5.http.impl.io.HttpRequestExecutor.execute(HttpRequestExecutor.java:170)
&#160; &#160; at org.apache.hc.core5.http.impl.io.HttpRequestExecutor.execute(HttpRequestExecutor.java:218)
&#160; &#160; at org.apache.hc.client5.http.impl.io.PoolingHttpClientConnectionManager$InternalConnectionEndpoint.execute(PoolingHttpClientConnectionManager.java:594)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.InternalExecRuntime.execute(InternalExecRuntime.java:219)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.MainClientExec.execute(MainClientExec.java:107)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.ExecChainElement.execute(ExecChainElement.java:51)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.ExecChainElement$1.proceed(ExecChainElement.java:57)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.ConnectExec.execute(ConnectExec.java:182)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.ExecChainElement.execute(ExecChainElement.java:51)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.ExecChainElement$1.proceed(ExecChainElement.java:57)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.ProtocolExec.execute(ProtocolExec.java:165)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.ExecChainElement.execute(ExecChainElement.java:51)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.ExecChainElement$1.proceed(ExecChainElement.java:57)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.ContentCompressionExec.execute(ContentCompressionExec.java:133)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.ExecChainElement.execute(ExecChainElement.java:51)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.ExecChainElement$1.proceed(ExecChainElement.java:57)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.RedirectExec.execute(RedirectExec.java:115)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.ExecChainElement.execute(ExecChainElement.java:51)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.InternalHttpClient.doExecute(InternalHttpClient.java:179)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:75)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:89)
&#160; &#160; at software.amazon.awssdk.services.s3.internal.HalfCloseApache5Client.main(HalfCloseApache5Client.java:71)
&#160; &#160; Suppressed: java.net.SocketException: Connection or outbound has closed
&#160; &#160; &#160; &#160; at java.base/sun.security.ssl.SSLSocketImpl$AppOutputStream.write(SSLSocketImpl.java:1302)
&#160; &#160; &#160; &#160; at org.apache.hc.core5.http.impl.io.DefaultBHttpClientConnection$1.write(DefaultBHttpClientConnection.java:231)
&#160; &#160; &#160; &#160; at org.apache.hc.core5.http.impl.io.SessionOutputBufferImpl.flushBuffer(SessionOutputBufferImpl.java:117)
&#160; &#160; &#160; &#160; at org.apache.hc.core5.http.impl.io.SessionOutputBufferImpl.flush(SessionOutputBufferImpl.java:126)
&#160; &#160; &#160; &#160; at org.apache.hc.core5.http.impl.io.ContentLengthOutputStream.close(ContentLengthOutputStream.java:92)
&#160; &#160; &#160; &#160; at org.apache.hc.core5.http.impl.io.DefaultBHttpClientConnection.sendRequestEntity(DefaultBHttpClientConnection.java:253)
&#160; &#160; &#160; &#160; ... 22 more&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17849832" author="zoe wang" created="Mon, 27 May 2024 20:59:25 +0000"  >&lt;p&gt;Re-opening the issue since the workaround proposed doesn&apos;t seem to work.&lt;/p&gt;</comment>
                            <comment id="17849909" author="olegk" created="Tue, 28 May 2024 07:18:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Zoe+Wang&quot; class=&quot;user-hover&quot; rel=&quot;Zoe Wang&quot;&gt;Zoe Wang&lt;/a&gt; What is it &lt;em&gt;specifically&lt;/em&gt; you expect me to do? As I tried to explain in my previous response the classic i/o can either efficiently read from the socket or efficiently write to the socket but not both. If need the client to be able to efficiently react to asynchronous events you should consider switching to the async transport provided by HttpClient. Alternatively, enable `jdk.tls.acknowledgeCloseNotify`. I think this is the reason it exists in the first place.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17850172" author="zoe wang" created="Tue, 28 May 2024 20:36:41 +0000"  >&lt;p&gt;The root cause seems to be that the client is not able to handle half-closed connection (outbound closed) properly, and not that it can&apos;t efficiently perform socket read and write at the same time because as shown in the SSL logs provided above, the client did receive close_notify from the server.&lt;/p&gt;

&lt;p&gt;The issue with `jdk.tls.acknowledgeCloseNotify` is that it&apos;s a global setting and it may cause issues for other applications in the same JVM relying on the half-closed connection. I understand if there is nothing you can do on the Apache HTTP client side and I just wanted to check if you can think of other workaround. If not, feel free to resolve the issue.&lt;/p&gt;</comment>
                            <comment id="17850218" author="zoe wang" created="Wed, 29 May 2024 00:34:26 +0000"  >&lt;p&gt;I did test with async HTTP client (CloseableHttpAsyncClient) and verified it was not affected. Looking at the &lt;a href=&quot;https://github.com/apache/httpcomponents-core/blob/master/httpcore5/src/main/java/org/apache/hc/core5/http/impl/nio/AbstractHttp1StreamDuplexer.java#L347-L351&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;AbstractHttp1StreamDuplexer code&lt;/a&gt;, it seems the client just closes the connection and throws ConnectionClosedException when `close_notify` is received in this case, which is not technically compliant to the TCP 1.3 spec (outbound and inbound close_notify should be independent) if I understand the code right. I was wondering if there is a way override the behavior to close the socket directly when `close_notify` it received in the sync HTTP client.&lt;/p&gt;</comment>
                            <comment id="17850280" author="olegk" created="Wed, 29 May 2024 07:32:34 +0000"  >&lt;p&gt;&amp;gt; which is not technically compliant to the TCP 1.3 spec (outbound and inbound close_notify should be independent)&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Zoe+Wang&quot; class=&quot;user-hover&quot; rel=&quot;Zoe Wang&quot;&gt;Zoe Wang&lt;/a&gt; With all due respect what you are saying make no sense to me. HTTP/1.1 is a request / response oriented protocol. It defines no semantic meaning for half-closed connections. Moreover, the server half-closing its endpoint while receiving a request message from the client would essentially be in violation of the HTTP spec. The client can half-close its endpoint when writing out requests in the pipeline mode. Even that, however, goes counter to the spec that states that HTTP/1.1 are to be kept persistent.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17850527" author="zoe wang" created="Thu, 30 May 2024 00:03:52 +0000"  >&lt;p&gt;&amp;gt;Moreover, the server half-closing its endpoint while receiving a request message from the client would essentially be in violation of the HTTP spec.&lt;/p&gt;

&lt;p&gt;I&apos;m not saying sending data on a half-closed connection is a good practice; I just don&apos;t see how it&apos;s violating HTTP spec.&#160; Also, half-closed connection has been clarified in &lt;a href=&quot;https://github.com/httpwg/http-core/issues/22&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/httpwg/http-core/issues/22&lt;/a&gt;.&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;To avoid the TCP reset problem, servers typically close a connection in stages. First, the server performs a half-close by closing only the write side of the read/write connection. The server then continues to read from the connection until it receives a corresponding close by the client, or until the server is reasonably certain that its own TCP stack has received the client&apos;s acknowledgement of the packet(s) containing the server&apos;s last response. Finally, the server fully closes the connection.&lt;/p&gt;

&lt;p&gt;&#160;&lt;br/&gt;
It is unknown whether the reset problem is exclusive to TCP or might also be found in other transport connection protocols.&lt;/p&gt;

&lt;p&gt;&#160;&lt;br/&gt;
Note that a TCP connection that is half-closed by the client does not delimit a request message, nor does it imply that the client is no longer interested in a response. In general, transport signals cannot be relied upon to signal edge cases, since HTTP/1.1 is independent of transport.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;What I see here is inconsistent behavior between Apache sync client and async client in the sense that connection received `close_notify` gets closed in async but not in sync with TLS 1.3.&lt;/p&gt;

&lt;p&gt;For anyone who stumbles across this issue, the root cause is that client does not close the connection upon receiving `close_notify` anymore with TLS 1.3. The workaround we tried that seems to be working is do a &quot;sock.getInputStream().read(new byte&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;);&quot; before each write, which will check `conContext.isInboundClosed()` and raise SocketException if inbound is closed.&lt;/p&gt;</comment>
                            <comment id="17850613" author="olegk" created="Thu, 30 May 2024 07:26:56 +0000"  >&lt;p&gt;&amp;gt; I just don&apos;t see how it&apos;s violating HTTP spec.&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Zoe+Wang&quot; class=&quot;user-hover&quot; rel=&quot;Zoe Wang&quot;&gt;Zoe Wang&lt;/a&gt; HTTP is defined as a &lt;b&gt;request / response&lt;/b&gt; based protocol. HTTP servers are expected to respond with a response message to a request message, If the server does not want the client to continue sending content of the request message body it must still respond with an out of sequence response message and not just half-close connections in the middle of message exchange. That is how.&lt;/p&gt;

&lt;p&gt;&amp;gt; The workaround we tried that seems to be working is do a &quot;sock.getInputStream().read(new byte&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;);&quot; before each write, which will check `conContext.isInboundClosed()` and raise SocketException if inbound is closed.&lt;/p&gt;

&lt;p&gt;This is precisely what ResponseOutOfOrderStrategy does (which completely decimates the i/o performance of the client, by the way). Feel free to use a custom implementation or enhance the default one shipped with HttpClient.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17851326" author="olegk" created="Sat, 1 Jun 2024 18:52:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Zoe+Wang&quot; class=&quot;user-hover&quot; rel=&quot;Zoe Wang&quot;&gt;Zoe Wang&lt;/a&gt; I can reproduce the defect with the following code snippet using HttpCore. Please note the fix will still require the user to explicitly configure the client to use `MonitoringResponseOutOfOrderStrategy`.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
SSLContext sslContext = SSLContextBuilder.create()
        .loadTrustMaterial(Paths.get(&lt;span class=&quot;code-quote&quot;&gt;&quot;keystore.jks&quot;&lt;/span&gt;), &lt;span class=&quot;code-quote&quot;&gt;&quot;password&quot;&lt;/span&gt;.toCharArray())
        .build();
HttpRequester requester = RequesterBootstrap.bootstrap()
        .setSslContext(sslContext)
        .setSslSetupHandler(sslParameters -&amp;gt; {
            sslParameters.setProtocols(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[]{TLS.V_1_3.id});
        })
        .setConnectionFactory(DefaultBHttpClientConnectionFactory.builder()
                .responseOutOfOrderStrategy(MonitoringResponseOutOfOrderStrategy.INSTANCE)
                .build())
        .create();
HttpHost target = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HttpHost(&lt;span class=&quot;code-quote&quot;&gt;&quot;https&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;localhost&quot;&lt;/span&gt;, 8081);
&lt;span class=&quot;code-comment&quot;&gt;// It needs to be a large file (128mb)
&lt;/span&gt;ClassicHttpRequest request = ClassicRequestBuilder.put(&lt;span class=&quot;code-quote&quot;&gt;&quot;/&quot;&lt;/span&gt;)
        .setHttpHost(target)
        .setEntity(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PathEntity(Paths.get(&lt;span class=&quot;code-quote&quot;&gt;&quot;output.dat&quot;&lt;/span&gt;), ContentType.APPLICATION_OCTET_STREAM))
        .build();
HttpCoreContext context = HttpCoreContext.create();
&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (ClassicHttpResponse response = requester.execute(target, request, Timeout.ofMinutes(1), context)) {
    EntityUtils.consume(response.getEntity());
}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17851984" author="olegk" created="Tue, 4 Jun 2024 09:53:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Zoe+Wang&quot; class=&quot;user-hover&quot; rel=&quot;Zoe Wang&quot;&gt;Zoe Wang&lt;/a&gt; Ultimately the fix itself is fairly simple &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;. However it requires quite a bit of refactoring in the blocking connection and TLS code &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;. For one, it was no longer possible to use SSL socket auto-close mode and SSL sockets now must be managed independently from their underling network socket. This allows for greater control over TLS protocol at the price of greater complexity.&lt;/p&gt;

&lt;p&gt;These changes fix the problem for me locally. The use of `MonitoringResponseOutOfOrderStrategy` is not necessary.&lt;/p&gt;

&lt;p&gt;Please review / test locally/&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1 &amp;#93;&lt;/span&gt;https://github.com/apache/httpcomponents-core/pull/468/commits/fc093c403ef4cbee9e0c6100fabe5a5e2ff73efc&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/httpcomponents-core/pull/468/commits/3277ffe85c76be0f0c6cefeec4d1b1412d5e256d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-core/pull/468/commits/3277ffe85c76be0f0c6cefeec4d1b1412d5e256d&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17853756" author="zoe wang" created="Mon, 10 Jun 2024 17:48:38 +0000"  >&lt;p&gt;Sorry for the delay, just came back from vacation.&lt;/p&gt;

&lt;p&gt;Thanks for the fix. I tested it and verified it worked (w/o MonitoringResponseOutOfOrderStrategy).&lt;/p&gt;</comment>
                            <comment id="17854103" author="zoe wang" created="Tue, 11 Jun 2024 15:41:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;, I did more testing, and it seems the fix only works for the test case using HttpRequester with `DefaultBHttpClientConnectionFactory` directly to send the request and not for the one using the `CloseableHttpClient` with `ManagedHttpClientConnectionFactory`.&#160; You can replicate the issue by using the repro code I provided.&#160;&lt;/p&gt;</comment>
                            <comment id="17854161" author="olegk" created="Tue, 11 Jun 2024 18:47:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Zoe+Wang&quot; class=&quot;user-hover&quot; rel=&quot;Zoe Wang&quot;&gt;Zoe Wang&lt;/a&gt; Has `ManagedHttpClientConnectionFactory` been upgraded to use new core APIs?&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17854190" author="zoe wang" created="Tue, 11 Jun 2024 20:43:02 +0000"  >&lt;p&gt;Yeah, doesn&apos;t seem so (didn&apos;t realize `ManagedHttpClientConnectionFactory` is in httpcomponents-client). LMK when it&apos;s updated and I can test again.&lt;/p&gt;</comment>
                            <comment id="17856942" author="olegk" created="Sat, 22 Jun 2024 15:27:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Zoe+Wang&quot; class=&quot;user-hover&quot; rel=&quot;Zoe Wang&quot;&gt;Zoe Wang&lt;/a&gt; Please test the following change-set &lt;a href=&quot;https://github.com/apache/httpcomponents-client/commit/ee0a102104d03a8d1cfe18e571d179c41242182c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/commit/ee0a102104d03a8d1cfe18e571d179c41242182c&lt;/a&gt; from master. You will likely need to build HttpClient from the source.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17860914" author="zoe wang" created="Sat, 29 Jun 2024 00:45:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt; I tested it and verified it worked. I had to change the repro code to use `setTlsSocketStrategy` instead of `setSSLSocketFactory` (deprecated API).&lt;/p&gt;

&lt;p&gt;Thanks for the fix!&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17876251" author="jira-bot" created="Fri, 23 Aug 2024 12:36:10 +0000"  >&lt;p&gt;Commit ee0a102104d03a8d1cfe18e571d179c41242182c in httpcomponents-client&apos;s branch refs/heads/dependabot/maven/com.googlecode.maven-download-plugin-download-maven-plugin-1.9.0 from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=ee0a10210&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=ee0a10210&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2328&quot; title=&quot;Request hangs if TLS 1.3 connection is half-closed &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2328&quot;&gt;&lt;del&gt;HTTPCLIENT-2328&lt;/del&gt;&lt;/a&gt;: Blocking i/o connections to check if the opposite TLS endpoint has been closed by the opposite endpoint while writing out request body&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13069047" name="HalfCloseApache5Client.Java" size="3424" author="Zoe Wang" created="Wed, 22 May 2024 23:38:12 +0000"/>
                            <attachment id="13069050" name="HalfCloseServer.java" size="2674" author="Zoe Wang" created="Wed, 22 May 2024 23:26:52 +0000"/>
                            <attachment id="13069048" name="TlsHalfCloseApache4.java" size="2878" author="Zoe Wang" created="Wed, 22 May 2024 23:35:32 +0000"/>
                            <attachment id="13069049" name="keystore.jks" size="2249" author="Zoe Wang" created="Wed, 22 May 2024 23:27:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 11 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1pdjk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>