<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:22:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HTTPCLIENT-2118] Difference in behavior between 4.5.x and 5.0.x - CloseableHttpClient returns 403 after NoHttpResponseException</title>
                <link>https://issues.apache.org/jira/browse/HTTPCLIENT-2118</link>
                <project id="12310360" key="HTTPCLIENT">HttpComponents HttpClient</project>
                    <description>&lt;p&gt;My application reuses an instance of CloseableHttpClient to retrieve the content from a list of URLs. After upgrading HttpClient from 4.5.x to 5.0.2 (also 5.0 and 5.0.1), it always gets a NoHttpResponseException followed by a response code of 403 for a particular URL in the list.&#160; When using 4.5.x, it always gets a 200 or 304 for that particular URL.&lt;/p&gt;

&lt;p&gt;The behavior may be different if the order of the URLs in the list is changed.&lt;/p&gt;

&lt;p&gt;To illustrate the problem, I have extracted code from my application into the sample Maven project attached. In the JUnit test, testHttpClient4() will get either 200 or 304 for all the URLs. On the other hand, testHttpClient5() always gets 403 for the last URL in the list. In this project, I intentionally added a If-Modified-Since header with the value being current time minus 1 minute so that we should get a 304 from most of the URLs.&lt;/p&gt;

&lt;p&gt;Can you investigate if this is really an obscure bug or an undocumented behavior change related to how CloseableHttpClient handles redirects?&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</description>
                <environment>Microsoft Windows 10 version 2004 [10.0.19041.508]&lt;br/&gt;
Oracle JDK 11.0.8</environment>
        <key id="13330293">HTTPCLIENT-2118</key>
            <summary>Difference in behavior between 4.5.x and 5.0.x - CloseableHttpClient returns 403 after NoHttpResponseException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="10004">Not A Bug</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="jkmlee">Michael Lee</reporter>
                        <labels>
                    </labels>
                <created>Thu, 1 Oct 2020 06:15:56 +0000</created>
                <updated>Mon, 5 Oct 2020 23:43:25 +0000</updated>
                            <resolved>Mon, 5 Oct 2020 17:27:24 +0000</resolved>
                                    <version>5.0.2</version>
                                                    <component>HttpClient (classic)</component>
                    <component>HttpClient (Windows)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17205287" author="jkmlee" created="Thu, 1 Oct 2020 06:20:36 +0000"  >&lt;p&gt;Attached output of the JUnit tests on my machine (test_output.txt). The error (403) is at the very end.&lt;/p&gt;</comment>
                            <comment id="17205304" author="michael-o" created="Thu, 1 Oct 2020 07:01:52 +0000"  >&lt;p&gt;Not helpful. Provide a wirelog with headers for both 4.5.x and 5.0.x. Does 5.1.x from master work for you?&lt;/p&gt;</comment>
                            <comment id="17205446" author="jkmlee" created="Thu, 1 Oct 2020 12:09:44 +0000"  >&lt;p&gt;I&apos;ve updated my demo project a bit (re-attached) to output the wire log (newly attached). It&apos;s about 20 MB in size unzipped because one of the URLs is a large file and the server actually returns 200 together with the file in the response body instead of just 304, despite my If-Modified-Since header value being later than the server&apos;s Last-Modified header value.&lt;/p&gt;

&lt;p&gt;I&apos;ve also reduced the list of URLs a bit and still manged to reproduce the error. Interestingly, if you remove the 2nd URL from the list (that big file), both 4.5.x and 5.0.x return 304 for the last URL. Else 4.5.x returns 304 and 5.0.x returns 403 for the last URL:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/notepad-plus-plus/notepad-plus-plus/releases/download/v7.9/npp.7.9.Installer.x64.exe&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/notepad-plus-plus/notepad-plus-plus/releases/download/v7.9/npp.7.9.Installer.x64.exe&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://nginx.org/download/nginx-1.19.3.zip&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://nginx.org/download/nginx-1.19.3.zip&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://winscp.net/eng/download.php&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://winscp.net/eng/download.php&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://curl.haxx.se/windows/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://curl.haxx.se/windows/&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/git-for-windows/git/releases/download/v2.28.0.windows.1/Git-2.28.0-64-bit.exe&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/git-for-windows/git/releases/download/v2.28.0.windows.1/Git-2.28.0-64-bit.exe&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17205447" author="jkmlee" created="Thu, 1 Oct 2020 12:11:13 +0000"  >&lt;p&gt;I&apos;ll try to build 5.1.x from master and see if it solves the problem.&lt;/p&gt;</comment>
                            <comment id="17205464" author="olegk" created="Thu, 1 Oct 2020 12:30:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jkmlee&quot; class=&quot;user-hover&quot; rel=&quot;jkmlee&quot;&gt;jkmlee&lt;/a&gt; I will take a look at it over the weekend unless &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=michael-o&quot; class=&quot;user-hover&quot; rel=&quot;michael-o&quot;&gt;michael-o&lt;/a&gt; beats me to it.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17205499" author="michael-o" created="Thu, 1 Oct 2020 13:08:54 +0000"  >&lt;p&gt;The log output is not helpful again. I requested for &lt;b&gt;both&lt;/b&gt; 4.5.x &lt;b&gt;and&lt;/b&gt; 5.0.x with headers only. I don&apos;t need the payload. Please recreate. After that I will happily analyze them. &lt;/p&gt;</comment>
                            <comment id="17205574" author="jkmlee" created="Thu, 1 Oct 2020 14:48:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=michael-o&quot; class=&quot;user-hover&quot; rel=&quot;michael-o&quot;&gt;michael-o&lt;/a&gt; - I tweaked my demo project a bit (re-attached) and ran &quot;mvn clean test&quot; to output the headers log to headers.log (also attached). The sole JUnit test class in the project fetched the 6 URLs using 4.5.12 first and then again using 5.0.2. You can see that 4.5.12 returned 304 for the last URL but 5.0.2 returned 403.&lt;/p&gt;

&lt;p&gt;Thanks for your patience!&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt; - Thank you as well.&lt;/p&gt;</comment>
                            <comment id="17205624" author="michael-o" created="Thu, 1 Oct 2020 15:42:24 +0000"  >&lt;p&gt;I am inclined to close this one because your input is fishy:&lt;/p&gt;

&lt;p&gt;1. HC 5.0.x: Where is the response to &lt;tt&gt;http-outgoing-1 &amp;gt;&amp;gt;&lt;/tt&gt; at the end?&lt;br/&gt;
2. curl tells me the same:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ curl -H &quot;If-Modified-Since: Thu, 01 Oct 2020 14:37:03 GMT&quot; &quot;https://github-production-release-asset-2e65be.s3.amazonaws.com/23216272/1a38ec80-d0ce-11ea-9065-30a975f676ad?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;amp;X-Amz-Credential=AKIAIWNJYAX4CSVEH53A%2F20201001%2Fus-east-1%2Fs3%2Faws4_request&amp;amp;X-Amz-Date=20201001T143803Z&amp;amp;X-Amz-Expires=300&amp;amp;X-Amz-Signature=548ad8027c753ae28032a14bb520d40740e971bfa30993944e6287a897333c7e&amp;amp;X-Amz-SignedHeaders=host&amp;amp;actor_id=0&amp;amp;key_id=0&amp;amp;repo_id=23216272&amp;amp;response-content-disposition=attachment%3B%20filename%3DGit-2.28.0-64-bit.exe&amp;amp;response-content-type=application%2Foctet-stream&quot; --verbose -H &quot;User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36&quot;
* Uses proxy env variable NO_PROXY == &apos;localhost .siemens.net .siemens.com .siemens.de&apos;
* Uses proxy env variable HTTPS_PROXY == &apos;http://194.145.60.1:9400&apos;
*   Trying 194.145.60.1:9400...
* Connected to 194.145.60.1 (194.145.60.1) port 9400 (#0)
* allocate connect buffer!
* Establish HTTP proxy tunnel to github-production-release-asset-2e65be.s3.amazonaws.com:443
&amp;gt; CONNECT github-production-release-asset-2e65be.s3.amazonaws.com:443 HTTP/1.1
&amp;gt; Host: github-production-release-asset-2e65be.s3.amazonaws.com:443
&amp;gt; User-Agent: curl/7.72.0
&amp;gt; Proxy-Connection: Keep-Alive
&amp;gt;
&amp;lt; HTTP/1.1 200 Connection Established
&amp;lt; Proxy-Agent: Zscaler/6.0
&amp;lt;
* Proxy replied 200 to CONNECT request
* CONNECT phase completed!
* ALPN, offering h2
* ALPN, offering http/1.1
* successfully set certificate verify locations:
*   CAfile: none
  CApath: /etc/ssl/certs/
* TLSv1.3 (OUT), TLS handshake, Client hello (1):
* CONNECT phase completed!
* CONNECT phase completed!
* TLSv1.3 (IN), TLS handshake, Server hello (2):
* TLSv1.2 (IN), TLS handshake, Certificate (11):
* TLSv1.2 (IN), TLS handshake, Server key exchange (12):
* TLSv1.2 (IN), TLS handshake, Server finished (14):
* TLSv1.2 (OUT), TLS handshake, Client key exchange (16):
* TLSv1.2 (OUT), TLS change cipher, Change cipher spec (1):
* TLSv1.2 (OUT), TLS handshake, Finished (20):
* TLSv1.2 (IN), TLS handshake, Finished (20):
* SSL connection using TLSv1.2 / ECDHE-RSA-AES128-GCM-SHA256
* ALPN, server did not agree to a protocol
* Server certificate:
*  subject: C=US; ST=Washington; L=Seattle; O=Amazon.com, Inc.; CN=*.s3.amazonaws.com
*  start date: Nov  9 00:00:00 2019 GMT
*  expire date: Mar 12 12:00:00 2021 GMT
*  subjectAltName: host &quot;github-production-release-asset-2e65be.s3.amazonaws.com&quot; matched cert&apos;s &quot;*.s3.amazonaws.com&quot;
*  issuer: C=US; O=DigiCert Inc; OU=www.digicert.com; CN=DigiCert Baltimore CA-2 G2
*  SSL certificate verify ok.
&amp;gt; GET /23216272/1a38ec80-d0ce-11ea-9065-30a975f676ad?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;amp;X-Amz-Credential=AKIAIWNJYAX4CSVEH53A%2F20201001%2Fus-east-1%2Fs3%2Faws4_request&amp;amp;X-Amz-Date=20201001T143803Z&amp;amp;X-Amz-Expires=300&amp;amp;X-Amz-Signature=548ad8027c753ae28032a14bb520d40740e971bfa30993944e6287a897333c7e&amp;amp;X-Amz-SignedHeaders=host&amp;amp;actor_id=0&amp;amp;key_id=0&amp;amp;repo_id=23216272&amp;amp;response-content-disposition=attachment%3B%20filename%3DGit-2.28.0-64-bit.exe&amp;amp;response-content-type=application%2Foctet-stream HTTP/1.1
&amp;gt; Host: github-production-release-asset-2e65be.s3.amazonaws.com
&amp;gt; Accept: */*
&amp;gt; If-Modified-Since: Thu, 01 Oct 2020 14:37:03 GMT
&amp;gt; User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36
&amp;gt;
* Mark bundle as not supporting multiuse
&amp;lt; HTTP/1.1 403 Forbidden
&amp;lt; x-amz-request-id: 084EAF292161BA29
&amp;lt; x-amz-id-2: nbKs7FOel7l/pv0j86ARNkMWx9Cgy6X348mAj5VQbIrs6kPu9EeUscNtSr4xQrNL670UrGN5z8A=
&amp;lt; Content-Type: application/xml
&amp;lt; Transfer-Encoding: chunked
&amp;lt; Date: Thu, 01 Oct 2020 15:37:46 GMT
&amp;lt; Server: AmazonS3
&amp;lt;
&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;
* Connection #0 to host 194.145.60.1 left intact
&amp;lt;Error&amp;gt;&amp;lt;Code&amp;gt;AccessDenied&amp;lt;/Code&amp;gt;&amp;lt;Message&amp;gt;Request has expired&amp;lt;/Message&amp;gt;&amp;lt;X-Amz-Expires&amp;gt;300&amp;lt;/X-Amz-Expires&amp;gt;&amp;lt;Expires&amp;gt;2020-10-01T14:43:03Z&amp;lt;/Expires&amp;gt;&amp;lt;ServerTime&amp;gt;2020-10-01T15:37:47Z&amp;lt;/ServerTime&amp;gt;&amp;lt;RequestId&amp;gt;084EAF292161BA29&amp;lt;/RequestId&amp;gt;&amp;lt;HostId&amp;gt;nbKs7FOel7l/pv0j86ARNkMWx9Cgy6X348mAj5VQbIrs6kPu9EeUscNtSr4xQrNL670UrGN5z8A=&amp;lt;/HostId&amp;gt;&amp;lt;/Error&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Your request has expired: &lt;tt&gt;2020-10-01T14:43:03Z&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="17205634" author="jkmlee" created="Thu, 1 Oct 2020 15:55:31 +0000"  >&lt;p&gt;The headers log does not tell the whole story. As mentioned in the original description of this issue, 5.0.x returned a NoHttpResponseException. After that, it retried the GET request and then got a 403. You can refer to the attached test_output.txt that captured this event/exception:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2020-10-01 14:07:33.826 INFO  [main] demo.HttpClientTests                     : Link:   https://github.com/git-for-windows/git/releases/download/v2.28.0.windows.1/Git-2.28.0-64-bit.exe
2020-10-01 14:07:34.111 INFO  [main] o.a.h.c.h.i.c.HttpRequestRetryExec       : Recoverable I/O exception (org.apache.hc.core5.http.NoHttpResponseException) caught when processing request to {s}-&amp;gt;https://github-production-release-asset-2e65be.s3.amazonaws.com:443
2020-10-01 14:07:35.397 INFO  [main] demo.HttpClientTests                     : Status: 403&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;On the other hand, 4.1.x handled the redirect, did not throw the ResponseException and returned 304.&lt;/p&gt;</comment>
                            <comment id="17205645" author="michael-o" created="Thu, 1 Oct 2020 16:04:09 +0000"  >&lt;p&gt;OK, I see what you are after. Thanks, let me evaluate that.&lt;/p&gt;</comment>
                            <comment id="17205648" author="michael-o" created="Thu, 1 Oct 2020 16:10:35 +0000"  >&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ JAVA_VERSION=11 mvn package -V
Apache Maven 3.5.4 (1edded0938998edf8bf061f1ceb3cfdeccf443fe; 2018-06-17T20:33:14+02:00)
Maven home: /usr/local/apache-maven-3.5.4
Java version: 11.0.8, vendor: OpenJDK BSD Porting Team, runtime: /usr/local/openjdk11
Default locale: de_DE, platform encoding: UTF-8
OS name: &quot;freebsd&quot;, version: &quot;12.2-stable&quot;, arch: &quot;amd64&quot;, family: &quot;unix&quot;
[INFO] Scanning for projects...
[INFO]
[INFO] -----------------------------&amp;lt; demo:demo &amp;gt;------------------------------
[INFO] Building demo 1.0.0
[INFO] --------------------------------[ jar ]---------------------------------
[INFO]
[INFO] --- maven-resources-plugin:2.6:resources (default-resources) @ demo ---
[INFO] Using &apos;UTF-8&apos; encoding to copy filtered resources.
[INFO] Copying 1 resource
[INFO]
[INFO] --- maven-compiler-plugin:3.1:compile (default-compile) @ demo ---
[INFO] Nothing to compile - all classes are up to date
[INFO]
[INFO] --- maven-resources-plugin:2.6:testResources (default-testResources) @ demo ---
[INFO] Using &apos;UTF-8&apos; encoding to copy filtered resources.
[INFO] Copying 1 resource
[INFO]
[INFO] --- maven-compiler-plugin:3.1:testCompile (default-testCompile) @ demo ---
[INFO] Nothing to compile - all classes are up to date
[INFO]
[INFO] --- maven-surefire-plugin:2.22.2:test (default-test) @ demo ---
[INFO]
[INFO] -------------------------------------------------------
[INFO]  T E S T S
[INFO] -------------------------------------------------------
[INFO] Running demo.HttpClientTests
2020-10-01 18:08:18.889 INFO  [main] demo.HttpClientTests                     : # Testing HttpClient 4
2020-10-01 18:08:19.188 INFO  [main] demo.HttpClientTests                     : Link:   https://github.com/notepad-plus-plus/notepad-plus-plus/releases/download/v7.9/npp.7.9.Installer.x64.exe
2020-10-01 18:08:19.474 WARN  [main] o.a.h.c.protocol.ResponseProcessCookies  : Invalid cookie header: &quot;Set-Cookie: _octo=GH1.1.381107936.1601568499; Path=/; Domain=github.com; Expires=Fri, 01 Oct 2021 16:08:19 GMT; Secure; SameSite=Lax&quot;. Invalid &apos;expires&apos; attribute: Fri, 01 Oct 2021 16:08:19 GMT
2020-10-01 18:08:19.475 WARN  [main] o.a.h.c.protocol.ResponseProcessCookies  : Invalid cookie header: &quot;Set-Cookie: logged_in=no; Path=/; Domain=github.com; Expires=Fri, 01 Oct 2021 16:08:19 GMT; HttpOnly; Secure; SameSite=Lax&quot;. Invalid &apos;expires&apos; attribute: Fri, 01 Oct 2021 16:08:19 GMT
2020-10-01 18:08:19.992 INFO  [main] demo.HttpClientTests                     : Status: 304
2020-10-01 18:08:19.996 INFO  [main] demo.HttpClientTests                     : Link:   https://nginx.org/download/nginx-1.19.3.zip
2020-10-01 18:08:20.513 INFO  [main] demo.HttpClientTests                     : Status: 200
2020-10-01 18:08:20.513 INFO  [main] demo.HttpClientTests                     : Link:   https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html
2020-10-01 18:08:20.733 INFO  [main] demo.HttpClientTests                     : Status: 304
2020-10-01 18:08:20.733 INFO  [main] demo.HttpClientTests                     : Link:   https://winscp.net/eng/download.php
2020-10-01 18:08:20.837 INFO  [main] demo.HttpClientTests                     : Status: 200
2020-10-01 18:08:20.837 INFO  [main] demo.HttpClientTests                     : Link:   https://curl.haxx.se/windows/
2020-10-01 18:08:20.949 INFO  [main] demo.HttpClientTests                     : Status: 304
2020-10-01 18:08:20.949 INFO  [main] demo.HttpClientTests                     : Link:   https://github.com/git-for-windows/git/releases/download/v2.28.0.windows.1/Git-2.28.0-64-bit.exe
2020-10-01 18:08:20.968 WARN  [main] o.a.h.c.protocol.ResponseProcessCookies  : Invalid cookie header: &quot;Set-Cookie: _octo=GH1.1.1127395529.1601568500; Path=/; Domain=github.com; Expires=Fri, 01 Oct 2021 16:08:20 GMT; Secure; SameSite=Lax&quot;. Invalid &apos;expires&apos; attribute: Fri, 01 Oct 2021 16:08:20 GMT
2020-10-01 18:08:20.969 WARN  [main] o.a.h.c.protocol.ResponseProcessCookies  : Invalid cookie header: &quot;Set-Cookie: logged_in=no; Path=/; Domain=github.com; Expires=Fri, 01 Oct 2021 16:08:20 GMT; HttpOnly; Secure; SameSite=Lax&quot;. Invalid &apos;expires&apos; attribute: Fri, 01 Oct 2021 16:08:20 GMT
2020-10-01 18:08:21.089 INFO  [main] demo.HttpClientTests                     : Status: 304
2020-10-01 18:08:21.090 INFO  [main] demo.HttpClientTests                     :
2020-10-01 18:08:21.105 INFO  [main] demo.HttpClientTests                     : # Testing HttpClient 5
2020-10-01 18:08:21.217 INFO  [main] demo.HttpClientTests                     : Link:   https://github.com/notepad-plus-plus/notepad-plus-plus/releases/download/v7.9/npp.7.9.Installer.x64.exe
2020-10-01 18:08:21.854 INFO  [main] demo.HttpClientTests                     : Status: 304
2020-10-01 18:08:21.854 INFO  [main] demo.HttpClientTests                     : Link:   https://nginx.org/download/nginx-1.19.3.zip
2020-10-01 18:08:22.351 INFO  [main] demo.HttpClientTests                     : Status: 200
2020-10-01 18:08:22.351 INFO  [main] demo.HttpClientTests                     : Link:   https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html
2020-10-01 18:08:22.560 INFO  [main] demo.HttpClientTests                     : Status: 304
2020-10-01 18:08:22.560 INFO  [main] demo.HttpClientTests                     : Link:   https://winscp.net/eng/download.php
2020-10-01 18:08:22.661 INFO  [main] demo.HttpClientTests                     : Status: 200
2020-10-01 18:08:22.661 INFO  [main] demo.HttpClientTests                     : Link:   https://curl.haxx.se/windows/
2020-10-01 18:08:22.739 INFO  [main] demo.HttpClientTests                     : Status: 304
2020-10-01 18:08:22.740 INFO  [main] demo.HttpClientTests                     : Link:   https://github.com/git-for-windows/git/releases/download/v2.28.0.windows.1/Git-2.28.0-64-bit.exe
2020-10-01 18:08:22.875 INFO  [main] demo.HttpClientTests                     : Status: 304
2020-10-01 18:08:22.875 INFO  [main] demo.HttpClientTests                     :
[INFO] Tests run: 2, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 4.199 s - in demo.HttpClientTests
[INFO]
[INFO] Results:
[INFO]
[INFO] Tests run: 2, Failures: 0, Errors: 0, Skipped: 0
[INFO]
[INFO]
[INFO] --- maven-jar-plugin:2.4:jar (default-jar) @ demo ---
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 7.054 s
[INFO] Finished at: 2020-10-01T18:08:23+02:00
[INFO] ------------------------------------------------------------------------
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Same with 8 and 14.&lt;/p&gt;

&lt;p&gt;What now?&lt;/p&gt;</comment>
                            <comment id="17205664" author="jkmlee" created="Thu, 1 Oct 2020 16:26:52 +0000"  >&lt;p&gt;Unfortunately I don&apos;t have a Linux box at home, and the Linux boxes at work are behind proxy which might skew the result.&lt;/p&gt;

&lt;p&gt;I ran the test again after tweaking the logback config file in the demo project. The newly attached &quot;all_except_wire.log&quot; should have all DEBUG log messages (including headers but excluding wire) from my PC. It shows the NoHttpResponseException and the stack trace. Hope it provides some clues...&lt;/p&gt;</comment>
                            <comment id="17205676" author="michael-o" created="Thu, 1 Oct 2020 17:02:54 +0000"  >&lt;p&gt;That is weird. &lt;tt&gt;http-outgoing-1&lt;/tt&gt; lived only for 7 seconds &lt;tt&gt;2020-10-02 00:32:30.960/2020-10-02 00:32:37.538&lt;/tt&gt;. Can you create a Wirshark/tcpdump from this? Maybe the peer is sending a &lt;tt&gt;RST&lt;/tt&gt;. As you can see, as soon as all headers are sent, the connection gets dropped.&lt;/p&gt;</comment>
                            <comment id="17205679" author="michael-o" created="Thu, 1 Oct 2020 17:04:14 +0000"  >&lt;p&gt;Btw, this also works on Windows 10 for me. Waiting for the Wireshark dump.&lt;/p&gt;</comment>
                            <comment id="17205917" author="jkmlee" created="Fri, 2 Oct 2020 01:35:20 +0000"  >&lt;p&gt;Attached wireshark.pcapng. It does look like the server sent a RST. But the question is why it only happens to me when GETting the URLs in that order, and only when I am using 5.0.x.&lt;/p&gt;

&lt;p&gt;If I GET that problematic URL by itself, 5.0.x would return a 304 as expected. Could it be related to how PoolingHttpClientConnectionManager works? Does the default configuration has any platform dependent logic?&lt;/p&gt;</comment>
                            <comment id="17206050" author="jkmlee" created="Fri, 2 Oct 2020 09:02:51 +0000"  >&lt;p&gt;More info. I get 304 if I use BasicHttpClientConnectionManager.&lt;/p&gt;

&lt;p&gt;Using PoolingHttpClientConnectionManager, I get 304 if maxTotal is set to 5 and 403 if maxTotal is set to 6 or above (I tried 6, 7 and 8).&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
RequestConfig requestConfig = RequestConfig.custom()
		.setConnectTimeout(Timeout.ofSeconds(30))
		.setConnectionKeepAlive(TimeValue.ofMinutes(1))
		.build();

PoolingHttpClientConnectionManager connManager = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PoolingHttpClientConnectionManager();
connManager.setMaxTotal(5);

client = HttpClients.custom()
		.setDefaultRequestConfig(requestConfig)
		.setUserAgent(USER_AGENT)
		.setConnectionManager(connManager)
		.build();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Attached log files from my experiments with maxTotal=5 and maxTotal=6:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;all_except_wire.setMaxTotal5.log&lt;/li&gt;
	&lt;li&gt;all_except_wire.setMaxTotal6.log&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17206095" author="michael-o" created="Fri, 2 Oct 2020 10:56:48 +0000"  >&lt;p&gt;Thanks, this will need more investigation. Surprisingly enough why I cannot reproduce it.&lt;/p&gt;</comment>
                            <comment id="17206319" author="michael-o" created="Fri, 2 Oct 2020 16:34:31 +0000"  >&lt;p&gt;This is truly fishy, now we have:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2020-10-02 16:48:32.096 DEBUG [main] o.a.h.c.http.impl.classic.ProtocolExec   : ex-00000006: target auth state: UNCHALLENGED
2020-10-02 16:48:32.096 DEBUG [main] o.a.h.c.http.impl.classic.ProtocolExec   : ex-00000006: proxy auth state: UNCHALLENGED
2020-10-02 16:48:32.096 DEBUG [main] o.a.h.c.http.impl.classic.ConnectExec    : ex-00000006: acquiring connection with route {s}-&amp;gt;https://github-production-release-asset-2e65be.s3.amazonaws.com:443
2020-10-02 16:48:32.096 DEBUG [main] o.a.h.c.h.i.classic.InternalHttpClient   : ex-00000006: acquiring endpoint (3 MINUTES)
2020-10-02 16:48:32.096 DEBUG [main] h.i.i.PoolingHttpClientConnectionManager : ex-00000006: endpoint lease request (3 MINUTES) [route: {s}-&amp;gt;https://github-production-release-asset-2e65be.s3.amazonaws.com:443][total available: 6; route allocated: 1 of 5; total allocated: 6 of 6]
2020-10-02 16:48:32.097 DEBUG [main] h.i.i.PoolingHttpClientConnectionManager : ex-00000006: endpoint leased [route: {s}-&amp;gt;https://github-production-release-asset-2e65be.s3.amazonaws.com:443][total available: 5; route allocated: 1 of 5; total allocated: 6 of 6]
2020-10-02 16:48:32.097 DEBUG [main] h.i.i.PoolingHttpClientConnectionManager : ex-00000006: acquired ep-00000007
2020-10-02 16:48:32.097 DEBUG [main] o.a.h.c.h.i.classic.InternalHttpClient   : ex-00000006: acquired endpoint ep-00000007
2020-10-02 16:48:32.097 DEBUG [main] o.a.h.c.h.impl.classic.MainClientExec    : ex-00000006: executing GET /23216272/1a38ec80-d0ce-11ea-9065-30a975f676ad?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;amp;X-Amz-Credential=AKIAIWNJYAX4CSVEH53A%2F20201002%2Fus-east-1%2Fs3%2Faws4_request&amp;amp;X-Amz-Date=20201002T084720Z&amp;amp;X-Amz-Expires=300&amp;amp;X-Amz-Signature=85155cda2ff7f56e5b04e3f8b7d46d1ed5710d6fb53cc79cbfe44c20ab19b1be&amp;amp;X-Amz-SignedHeaders=host&amp;amp;actor_id=0&amp;amp;key_id=0&amp;amp;repo_id=23216272&amp;amp;response-content-disposition=attachment%3B%20filename%3DGit-2.28.0-64-bit.exe&amp;amp;response-content-type=application%2Foctet-stream HTTP/1.1
2020-10-02 16:48:32.097 DEBUG [main] o.a.h.c.h.i.classic.InternalHttpClient   : ep-00000007: start execution ex-00000006
2020-10-02 16:48:32.097 DEBUG [main] h.i.i.PoolingHttpClientConnectionManager : ep-00000007: executing exchange ex-00000006 over http-outgoing-1
2020-10-02 16:48:32.097 DEBUG [main] org.apache.hc.client5.http.headers       : http-outgoing-1 &amp;gt;&amp;gt; GET /23216272/1a38ec80-d0ce-11ea-9065-30a975f676ad?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;amp;X-Amz-Credential=AKIAIWNJYAX4CSVEH53A%2F20201002%2Fus-east-1%2Fs3%2Faws4_request&amp;amp;X-Amz-Date=20201002T084720Z&amp;amp;X-Amz-Expires=300&amp;amp;X-Amz-Signature=85155cda2ff7f56e5b04e3f8b7d46d1ed5710d6fb53cc79cbfe44c20ab19b1be&amp;amp;X-Amz-SignedHeaders=host&amp;amp;actor_id=0&amp;amp;key_id=0&amp;amp;repo_id=23216272&amp;amp;response-content-disposition=attachment%3B%20filename%3DGit-2.28.0-64-bit.exe&amp;amp;response-content-type=application%2Foctet-stream HTTP/1.1
2020-10-02 16:48:32.097 DEBUG [main] org.apache.hc.client5.http.headers       : http-outgoing-1 &amp;gt;&amp;gt; If-Modified-Since: Fri, 02 Oct 2020 08:47:31 GMT
2020-10-02 16:48:32.097 DEBUG [main] org.apache.hc.client5.http.headers       : http-outgoing-1 &amp;gt;&amp;gt; Accept-Encoding: gzip, x-gzip, deflate
2020-10-02 16:48:32.097 DEBUG [main] org.apache.hc.client5.http.headers       : http-outgoing-1 &amp;gt;&amp;gt; Host: github-production-release-asset-2e65be.s3.amazonaws.com
2020-10-02 16:48:32.097 DEBUG [main] org.apache.hc.client5.http.headers       : http-outgoing-1 &amp;gt;&amp;gt; Connection: keep-alive
2020-10-02 16:48:32.097 DEBUG [main] org.apache.hc.client5.http.headers       : http-outgoing-1 &amp;gt;&amp;gt; User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36
2020-10-02 16:48:32.099 DEBUG [main] h.i.i.DefaultManagedHttpClientConnection : http-outgoing-1: Close connection
2020-10-02 16:48:32.100 DEBUG [main] o.a.h.c.h.i.classic.InternalHttpClient   : ep-00000007: endpoint closed
2020-10-02 16:48:32.100 DEBUG [main] o.a.h.c.h.i.classic.InternalHttpClient   : ep-00000007: discarding endpoint
2020-10-02 16:48:32.100 DEBUG [main] h.i.i.PoolingHttpClientConnectionManager : ep-00000007: releasing endpoint
2020-10-02 16:48:32.100 DEBUG [main] h.i.i.PoolingHttpClientConnectionManager : ep-00000007: connection is not kept alive
2020-10-02 16:48:32.100 DEBUG [main] h.i.i.PoolingHttpClientConnectionManager : ep-00000007: connection released [route: {s}-&amp;gt;https://github-production-release-asset-2e65be.s3.amazonaws.com:443][total available: 5; route allocated: 0 of 5; total allocated: 5 of 6]
2020-10-02 16:48:32.103 DEBUG [main] o.a.h.c.h.i.c.HttpRequestRetryExec       : ex-00000006: The target server failed to respond
org.apache.hc.core5.http.NoHttpResponseException: The target server failed to respond
	at org.apache.hc.core5.http.impl.io.DefaultHttpResponseParser.createConnectionClosedException(DefaultHttpResponseParser.java:87)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and the counterpart in Wireshark is:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;...
1959	10.750711	192.168.11.3	52.216.114.219	TLSv1.2	882	Application Data
1960	10.754755	192.168.11.3	52.216.114.219	TLSv1.2	85	Encrypted Alert
1961	10.756275	192.168.11.3	52.216.114.219	TCP	54	49900 &#8594; 443 [FIN, ACK] Seq=2274 Ack=3828 Win=130560 Len=0
1962	10.769308	192.168.11.3	52.216.114.219	TCP	66	49905 &#8594; 443 [SYN] Seq=0 Win=64240 Len=0 MSS=1460 WS=256 SACK_PERM=1
1963	11.011468	52.216.114.219	192.168.11.3	TCP	54	443 &#8594; 49900 [RST] Seq=3828 Win=0 Len=0
1964	11.013167	52.216.114.219	192.168.11.3	TCP	54	443 &#8594; 49900 [RST] Seq=3828 Win=0 Len=0
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So we are actively closing the connection as you can see by the FIN/ACK right after the requests headers have been sent. The servers sends a reset. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;, feel free to correct me if I am wrong.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jkmlee&quot; class=&quot;user-hover&quot; rel=&quot;jkmlee&quot;&gt;jkmlee&lt;/a&gt;, can you enable &lt;tt&gt;-Djavax.net.debug=all&lt;/tt&gt; and run the test again along with a new Wireshark dump? I current do not understand who is actually calling the close on our connection and why. Can you also try another Java version? 8, 13, 14, 15 or maybe from another network connection?&lt;/p&gt;</comment>
                            <comment id="17206323" author="michael-o" created="Fri, 2 Oct 2020 16:40:27 +0000"  >&lt;p&gt;Wait a second, I have left out:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;...
59	1.978067	52.216.114.219	192.168.11.3	TLSv1.2	450	Application Data
1914	8.027513	52.216.114.219	192.168.11.3	TLSv1.2	85	Encrypted Alert
1915	8.082430	192.168.11.3	52.216.114.219	TCP	54	49900 &#8594; 443 [ACK] Seq=1415 Ack=3827 Win=130560 Len=0
1949	10.061705	52.216.114.219	192.168.11.3	TCP	54	443 &#8594; 49900 [FIN, ACK] Seq=3827 Ack=1415 Win=32000 Len=0
1950	10.061798	192.168.11.3	52.216.114.219	TCP	54	49900 &#8594; 443 [ACK] Seq=1415 Ack=3828 Win=130560 Len=0
1951...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After the last communication, before we reuse the connection the server already signals what he&apos;s going to close the connection we notice this, but react only after the headers?&lt;/p&gt;</comment>
                            <comment id="17206340" author="olegk" created="Fri, 2 Oct 2020 17:04:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;After the last communication, before we reuse the connection the server already signals what he&apos;s going to close the connection we notice this, but react only after the headers?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=michael-o&quot; class=&quot;user-hover&quot; rel=&quot;michael-o&quot;&gt;michael-o&lt;/a&gt; That is quite possible because the previous message on the same connection was &lt;tt&gt;HTTP/1.1 304 Not Modified&lt;/tt&gt;, which consists of a message head only. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jkmlee&quot; class=&quot;user-hover&quot; rel=&quot;jkmlee&quot;&gt;jkmlee&lt;/a&gt; The difference in behavior is due to the stale check, which is on by default in 4.5.x and off in 5.0.x. Tweak the period of inactivity after which HttpClient 5.0 i supposed to validate persistent connections and the problem should go away.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17206396" author="jkmlee" created="Fri, 2 Oct 2020 18:30:52 +0000"  >&lt;p&gt;Yes, problem solved after I set the period of inactivity after which a connection is validated to 2000 ms (the default value in 4.5.x according to &lt;a href=&quot;https://github.com/apache/httpcomponents-client/blob/4.5.x/httpclient/src/main/java/org/apache/http/impl/conn/PoolingHttpClientConnectionManager.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;its source code&lt;/a&gt;) while keeping other settings unchanged:&lt;br/&gt;
 &#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
PoolingHttpClientConnectionManager connManager = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PoolingHttpClientConnectionManager();
connManager.setValidateAfterInactivity(TimeValue.ofMilliseconds(2000));

client = HttpClients.custom()
		.setDefaultRequestConfig(requestConfig)
		.setUserAgent(USER_AGENT)
		.setConnectionManager(connManager)
		.build();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The javadoc of &lt;a href=&quot;https://hc.apache.org/httpcomponents-client-5.0.x/httpclient5/apidocs/org/apache/hc/client5/http/impl/io/PoolingHttpClientConnectionManager.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PoolingHttpClientConnectionManager&lt;/a&gt; is a bit confusing. It says:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;The handling of stale connections was changed in version 4.4. Previously, the code would check every connection by default before re-using it. The code now only checks the connection if the elapsed time since the last use of the connection exceeds the timeout that has been set. The default timeout is set to 5000ms.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;To be really conservative, I think I should set it to 0 so that a connection is validated every time before it is reused? There is no guarantee that the server will honor any keep-alive time and may close a connection at any time.&lt;/p&gt;</comment>
                            <comment id="17206402" author="michael-o" created="Fri, 2 Oct 2020 18:43:51 +0000"  >&lt;p&gt;This seems to be completely gone, hasn&apos;t it? I can&apos;t find any 5000 at least. I thin the entire document block should go.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;To be really conservative, I think I should set it to 0 so that a connection is validation every time before it is reused?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Maybe, yes.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;There is no guarantee that the server will honor any keep-alive time and may close a connection at any time.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Correct. It would have been nice in this case when the server have signaled &lt;tt&gt;Connection: close&lt;/tt&gt; on the previous 304.&lt;/p&gt;</comment>
                            <comment id="17206403" author="jkmlee" created="Fri, 2 Oct 2020 18:49:37 +0000"  >&lt;p&gt;Okay, thank you both. I think I can finally switch to 5.0.x now with this additional non-default setting added. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I assume it is a design decision to not validate by default in 5.0.x - will leave it to you guys to decide whether to revert this change, or update the javadoc.&lt;/p&gt;

&lt;p&gt;Thanks again!&lt;/p&gt;</comment>
                            <comment id="17206404" author="michael-o" created="Fri, 2 Oct 2020 18:52:03 +0000"  >&lt;p&gt;The problem with default validation is that&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;it incurs overhead&lt;/li&gt;
	&lt;li&gt;it is not 100% reliable&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If we can&apos;t make it 100% reliable, why make it default?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;, is my analysis correct regarding the Javadoc block?&lt;/p&gt;</comment>
                            <comment id="17206490" author="ckozak" created="Fri, 2 Oct 2020 20:00:51 +0000"  >&lt;p&gt;&amp;gt;&#160;&#160;I think I should set it to 0 so that a connection is validation every time before it is reused&lt;/p&gt;

&lt;p&gt;Please make sure you&apos;re using 5.0.2, otherwise you may be impacted by &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2094&quot; title=&quot;setValidateAfterInactivity disagreement between classic/async for duration zero&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2094&quot;&gt;&lt;del&gt;HTTPCLIENT-2094&lt;/del&gt;&lt;/a&gt; which disabled the checks entirely when 0 is configured.&lt;/p&gt;

&lt;p&gt;I have an optimization (or hack, depending on perspective) in a project I work on which disables these checks when the server responds with a &quot;Keep-Alive: timeout=&amp;lt;seconds&amp;gt;&quot;. In my case we trust the server not to close these connections prematurely, and have generally strong support for retries if they happen to fail (metrics will alert us if this occurs frequently). We require relatively low latency, so the 1ms sleep incurred by the check isn&apos;t something we could realistically allow before each request. I&apos;m certainly wouldn&apos;t recommend that behavior by default for a general purpose http client, but could be interesting to provide an interface that allows greater control over when the check is executed. For example, always validating after a non-2xx response, but after some interval of inactivity when a 2xx is received, or based on whether or not the next request is repeatable (though that part might break some abstractions that are better left intact).&lt;/p&gt;</comment>
                            <comment id="17206593" author="jkmlee" created="Sat, 3 Oct 2020 03:09:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ckozak&quot; class=&quot;user-hover&quot; rel=&quot;ckozak&quot;&gt;ckozak&lt;/a&gt; Yes I am using 5.0.2 now. In my use case, the 1ms is insignificant and getting a correct response (200 or 304) is more important.&lt;/p&gt;

&lt;p&gt;May be it is a good idea to at least update the Javadoc of&#160;PoolingHttpClientConnectionManager to alert users of this change?&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;The difference in behavior is due to the stale check, which is on by default in 4.5.x and off in 5.0.x.&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="17206648" author="michael-o" created="Sat, 3 Oct 2020 09:09:05 +0000"  >&lt;p&gt;I would replace the block with the following:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;In contrast to 4.x, no stale check is employed by default.&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="17206663" author="olegk" created="Sat, 3 Oct 2020 09:52:08 +0000"  >&lt;blockquote&gt;&lt;p&gt;This seems to be completely gone, hasn&apos;t it? I can&apos;t find any 5000 at least. I thin the entire document block should go.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=michael-o&quot; class=&quot;user-hover&quot; rel=&quot;michael-o&quot;&gt;michael-o&lt;/a&gt; Agreed&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;In contrast to 4.x, no stale check is employed by default.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=michael-o&quot; class=&quot;user-hover&quot; rel=&quot;michael-o&quot;&gt;michael-o&lt;/a&gt; Agreed&lt;/p&gt;</comment>
                            <comment id="17206667" author="jira-bot" created="Sat, 3 Oct 2020 10:15:30 +0000"  >&lt;p&gt;Commit 0ba8edc94605b05650351daa18bb3e6b01cf2faa in httpcomponents-client&apos;s branch refs/heads/5.0.x from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=0ba8edc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=0ba8edc&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2118&quot; title=&quot;Difference in behavior between 4.5.x and 5.0.x - CloseableHttpClient returns 403 after NoHttpResponseException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2118&quot;&gt;&lt;del&gt;HTTPCLIENT-2118&lt;/del&gt;&lt;/a&gt;: Corrected PoolingHttpClientConnectionManager javadocs&lt;/p&gt;</comment>
                            <comment id="17206668" author="jira-bot" created="Sat, 3 Oct 2020 10:17:46 +0000"  >&lt;p&gt;Commit 12a6579513ffc9f36ef41a8d18fc456ab8ccf7e8 in httpcomponents-client&apos;s branch refs/heads/master from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=12a6579&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=12a6579&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2118&quot; title=&quot;Difference in behavior between 4.5.x and 5.0.x - CloseableHttpClient returns 403 after NoHttpResponseException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2118&quot;&gt;&lt;del&gt;HTTPCLIENT-2118&lt;/del&gt;&lt;/a&gt;: Corrected PoolingHttpClientConnectionManager javadocs&lt;/p&gt;</comment>
                            <comment id="17208148" author="michael-o" created="Mon, 5 Oct 2020 15:51:58 +0000"  >&lt;p&gt;Can we close this since this is expected behavior.&lt;/p&gt;</comment>
                            <comment id="17208417" author="jkmlee" created="Mon, 5 Oct 2020 23:43:25 +0000"  >&lt;p&gt;Yes, you can close this - let me know if I should hit the Close Issue button or if it is usually someone from the project team doing that. Thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13012402" name="all_except_wire.log" size="171854" author="jkmlee" created="Thu, 1 Oct 2020 16:33:47 +0000"/>
                            <attachment id="13012423" name="all_except_wire.setMaxTotal5.log" size="88611" author="jkmlee" created="Fri, 2 Oct 2020 09:04:59 +0000"/>
                            <attachment id="13012422" name="all_except_wire.setMaxTotal6.log" size="100198" author="jkmlee" created="Fri, 2 Oct 2020 09:04:59 +0000"/>
                            <attachment id="13012396" name="demo.zip" size="5709" author="jkmlee" created="Thu, 1 Oct 2020 14:42:08 +0000"/>
                            <attachment id="13012397" name="headers.log" size="50902" author="jkmlee" created="Thu, 1 Oct 2020 14:42:20 +0000"/>
                            <attachment id="13012375" name="test_output.txt" size="6595" author="jkmlee" created="Thu, 1 Oct 2020 06:20:40 +0000"/>
                            <attachment id="13012412" name="wireshark.pcapng" size="1956588" author="jkmlee" created="Fri, 2 Oct 2020 01:31:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 5 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0j2ig:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>