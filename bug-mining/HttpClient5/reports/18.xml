<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:21:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HTTPCLIENT-1855] Digest auth: Nonce counter not incremented after reuse</title>
                <link>https://issues.apache.org/jira/browse/HTTPCLIENT-1855</link>
                <project id="12310360" key="HTTPCLIENT">HttpComponents HttpClient</project>
                    <description>&lt;p&gt;I have a client app using httpclient 4.5.2 with BasicCredentialsProvider and BasicAuthCache. and web server that requires HTTP digest authentication. &lt;/p&gt;

&lt;p&gt;The client sends 3 requests to the web server. &lt;/p&gt;

&lt;p&gt;When the app sends the first request, the server returns an HTTP 401 with a digest challenge. httpclient automatically retries the request with the Authorization header. The header contains the nonce returned by the server and a nonce counter (nc) of 1. The retry succeeds and httpclient caches the DigestScheme.&lt;/p&gt;

&lt;p&gt;For the second request, httpclient uses the cached DigestScheme to calculate the Authorization header pre-emptively. The header contains the same nonce and specifies a nonce counter of 2. The request succeed without requiring a retry.&lt;/p&gt;

&lt;p&gt;For the third request, httpclient uses the cached DigestScheme to calculate the Authorization header pre-emptively. Even though the header contains the same nonce, the nonce counter is set to 2 again. This causes the server to return a 401. httpclient should have incremented the nonce counter to 3.&lt;/p&gt;

&lt;p&gt;I believe that the root cause of this problem is that, although DigestScheme increases the nonceCount field every time the authenticate() method is called, HttpAuthenticator does not re-cache DigestScheme after reusing it. The re-cache is needed because BasicAuthCache stores DigestScheme in serialized format.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13079300">HTTPCLIENT-1855</key>
            <summary>Digest auth: Nonce counter not incremented after reuse</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="2">Won&apos;t Fix</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="alessandro.gherardi@yahoo.com">Alessandro Gherardi</reporter>
                        <labels>
                    </labels>
                <created>Mon, 12 Jun 2017 20:09:05 +0000</created>
                <updated>Wed, 13 Mar 2019 11:48:57 +0000</updated>
                            <resolved>Fri, 20 Oct 2017 10:01:06 +0000</resolved>
                                    <version>4.5.2</version>
                                                    <component>HttpClient (classic)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16047015" author="alessandro.gherardi@yahoo.com" created="Mon, 12 Jun 2017 20:15:42 +0000"  >&lt;p&gt;I have attached the client app and a snippet of the wireshark capture.&lt;/p&gt;</comment>
                            <comment id="16188100" author="alessandro.gherardi@yahoo.com" created="Mon, 2 Oct 2017 14:17:57 +0000"  >&lt;p&gt;I believe fixing this issue may be as simple as making the following change in org\apache\http\client\protocol\RequestAuthCache.java:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;138c135
&amp;lt;             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-quote&quot;&gt;&quot;BASIC&quot;&lt;/span&gt;.equalsIgnoreCase(authScheme.getSchemeName())) {
---
&amp;gt;             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-quote&quot;&gt;&quot;BASIC&quot;&lt;/span&gt;.equalsIgnoreCase(authScheme.getSchemeName()) || &lt;span class=&quot;code-quote&quot;&gt;&quot;DIGEST&quot;&lt;/span&gt;.equalsIgnoreCase(authScheme.getSchemeName())) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16188105" author="garydgregory" created="Mon, 2 Oct 2017 14:19:29 +0000"  >&lt;p&gt;I would be nice to see &quot;BASIC&quot; and so on as an enum.&lt;/p&gt;</comment>
                            <comment id="16188359" author="githubbot" created="Mon, 2 Oct 2017 16:07:06 +0000"  >&lt;p&gt;GitHub user agherardi opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/httpcomponents-client/pull/86&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/pull/86&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-1855&quot; title=&quot;Digest auth: Nonce counter not incremented after reuse&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-1855&quot;&gt;&lt;del&gt;HTTPCLIENT-1855&lt;/del&gt;&lt;/a&gt; - Update nonce counter in auth cache after using&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/agherardi/httpcomponents-client&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/agherardi/httpcomponents-client&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-1855&quot; title=&quot;Digest auth: Nonce counter not incremented after reuse&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-1855&quot;&gt;&lt;del&gt;HTTPCLIENT-1855&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/httpcomponents-client/pull/86.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/pull/86.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #86&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 2e929bcc7e47d89d5955bf6e91972b5d27806ecb&lt;br/&gt;
Author: alessandro.gherardi &amp;lt;alessandro.gherardi@schneider-electric.com&amp;gt;&lt;br/&gt;
Date:   2017-10-02T16:06:07Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-1855&quot; title=&quot;Digest auth: Nonce counter not incremented after reuse&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-1855&quot;&gt;&lt;del&gt;HTTPCLIENT-1855&lt;/del&gt;&lt;/a&gt; - Update nonce counter in auth cache after using&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16188360" author="alessandro.gherardi@yahoo.com" created="Mon, 2 Oct 2017 16:07:24 +0000"  >&lt;p&gt;I submitted a pull request &lt;a href=&quot;https://github.com/apache/httpcomponents-client/pull/86&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/pull/86&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16189463" author="jira-bot" created="Tue, 3 Oct 2017 09:41:16 +0000"  >&lt;p&gt;Commit c82799f1eb29e3f74bac0c7be61c8f3e37d702e4 in httpcomponents-client&apos;s branch refs/heads/4.6.x from alessandro.gherardi&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=httpcomponents-client.git;h=c82799f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=httpcomponents-client.git;h=c82799f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-1855&quot; title=&quot;Digest auth: Nonce counter not incremented after reuse&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-1855&quot;&gt;&lt;del&gt;HTTPCLIENT-1855&lt;/del&gt;&lt;/a&gt;: Update DIGEST nonce counter in auth cache after auth challenge&lt;/p&gt;</comment>
                            <comment id="16189467" author="jira-bot" created="Tue, 3 Oct 2017 09:43:24 +0000"  >&lt;p&gt;Commit 7e44b9635e5de8ffce100f4ce4fc3e5d0dedb63b in httpcomponents-client&apos;s branch refs/heads/4.5.x from alessandro.gherardi&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=httpcomponents-client.git;h=7e44b96&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=httpcomponents-client.git;h=7e44b96&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-1855&quot; title=&quot;Digest auth: Nonce counter not incremented after reuse&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-1855&quot;&gt;&lt;del&gt;HTTPCLIENT-1855&lt;/del&gt;&lt;/a&gt;: Update DIGEST nonce counter in auth cache after auth challenge&lt;/p&gt;</comment>
                            <comment id="16189486" author="githubbot" created="Tue, 3 Oct 2017 09:57:16 +0000"  >&lt;p&gt;Github user ok2c commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/httpcomponents-client/pull/86&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/pull/86&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Committed to branches 4.5.x and 4.6.x. Please review and close.&lt;/p&gt;</comment>
                            <comment id="16189489" author="olegk" created="Tue, 3 Oct 2017 10:01:02 +0000"  >&lt;p&gt;Patch committed to branches 4.5.x and 4.6.x. The authentication code has changed substantially in 5.x, but as far as I can tell it does not appear to be affected. However I appreciate if you could re-test with the latest 5.0 code as well.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="16189744" author="alessandro.gherardi@yahoo.com" created="Tue, 3 Oct 2017 14:05:00 +0000"  >&lt;p&gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt; However I appreciate if you could re-test with the latest 5.0 code as well.&lt;/p&gt;

&lt;p&gt;Will do. Thank you.&lt;/p&gt;</comment>
                            <comment id="16196066" author="githubbot" created="Sun, 8 Oct 2017 11:04:57 +0000"  >&lt;p&gt;Github user ok2c commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/httpcomponents-client/pull/86&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/pull/86&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @agherardi Please close this PR. &lt;/p&gt;</comment>
                            <comment id="16196242" author="githubbot" created="Sun, 8 Oct 2017 17:21:38 +0000"  >&lt;p&gt;Github user agherardi closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/httpcomponents-client/pull/86&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/pull/86&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16196323" author="alessandro.gherardi@yahoo.com" created="Sun, 8 Oct 2017 20:20:44 +0000"  >&lt;p&gt;This still appears to be a problem in 5.0. See attached sample program HttpClient5Digest .&lt;/p&gt;</comment>
                            <comment id="16196331" author="olegk" created="Sun, 8 Oct 2017 21:00:56 +0000"  >&lt;p&gt;Could you please send me the wirelog of the session? HttpClient 5 uses log4j2. Here is the logging config&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&amp;lt;Configuration status=&quot;WARN&quot; name=&quot;XMLConfigTest&quot;&amp;gt;
    &amp;lt;Appenders&amp;gt;
        &amp;lt;Console name=&quot;STDOUT&quot;&amp;gt;
            &amp;lt;PatternLayout pattern=&quot;%d %-5level [%t][%logger]%notEmpty{[%markerSimpleName]} %msg%n%xThrowable&quot;/&amp;gt;
        &amp;lt;/Console&amp;gt;
    &amp;lt;/Appenders&amp;gt;
    &amp;lt;Loggers&amp;gt;
        &amp;lt;Root level=&quot;warn&quot;&amp;gt;
            &amp;lt;AppenderRef ref=&quot;STDOUT&quot;/&amp;gt;
        &amp;lt;/Root&amp;gt;
        &amp;lt;Logger name=&quot;org.apache.hc.core5.reactor&quot; level=&quot;debug&quot;/&amp;gt;
        &amp;lt;Logger name=&quot;org.apache.hc.core5.http&quot; level=&quot;debug&quot;/&amp;gt;
        &amp;lt;Logger name=&quot;org.apache.hc.core5.http.wire&quot; level=&quot;warn&quot;/&amp;gt;
        &amp;lt;Logger name=&quot;org.apache.hc.core5.http.headers&quot; level=&quot;debug&quot;/&amp;gt;
        &amp;lt;Logger name=&quot;org.apache.hc.core5.http2.frame&quot; level=&quot;debug&quot;/&amp;gt;
        &amp;lt;Logger name=&quot;org.apache.hc.core5.http2.frame.payload&quot; level=&quot;warn&quot;/&amp;gt;
        &amp;lt;Logger name=&quot;org.apache.hc.core5.http2.flow&quot; level=&quot;debug&quot;/&amp;gt;
        &amp;lt;Logger name=&quot;org.apache.hc.client5.http&quot; level=&quot;debug&quot;/&amp;gt;
        &amp;lt;Logger name=&quot;org.apache.hc.client5.http.impl.io&quot; level=&quot;debug&quot;/&amp;gt;
        &amp;lt;Logger name=&quot;org.apache.hc.client5.http.impl.nio&quot; level=&quot;debug&quot;/&amp;gt;
        &amp;lt;Logger name=&quot;org.apache.hc.client5.http.wire&quot; level=&quot;warn&quot;/&amp;gt;
        &amp;lt;Logger name=&quot;org.apache.hc.client5.http2&quot; level=&quot;debug&quot;/&amp;gt;
        &amp;lt;Logger name=&quot;org.apache.hc.client5.http2.frame.payload&quot; level=&quot;warn&quot;/&amp;gt;
    &amp;lt;/Loggers&amp;gt;
&amp;lt;/Configuration&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16197040" author="alessandro.gherardi@yahoo.com" created="Mon, 9 Oct 2017 14:20:49 +0000"  >&lt;p&gt;Attached log output file httpclient5.log.&lt;/p&gt;</comment>
                            <comment id="16197059" author="olegk" created="Mon, 9 Oct 2017 14:30:12 +0000"  >&lt;p&gt;@&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alessandro.gherardi%40yahoo.com&quot; class=&quot;user-hover&quot; rel=&quot;alessandro.gherardi@yahoo.com&quot;&gt;alessandro.gherardi@yahoo.com&lt;/a&gt; Many thanks for the log. I am not sure I understand what the problem is. As far as I can tell HttpClient successfully re-authenticates after a new challenge and updates the cache. What should HttpClient be doing differently?&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="16197105" author="alessandro.gherardi@yahoo.com" created="Mon, 9 Oct 2017 14:53:08 +0000"  >&lt;p&gt;&amp;gt; What should HttpClient be doing differently?&lt;/p&gt;

&lt;p&gt;It&apos;s a performance problem.&lt;/p&gt;

&lt;p&gt;The sample app HttpClient5Digest.java sends 3 requests to the server. I expected httpclient to use the same server-provided nonce on all 3 requests, each time incrementing the nonce counter nc by 1. That is the case for the 1st and 2nd request, which have nc=1 and nc=2, respectively. For the 3rd request, httpclient sends nc=2 again, instead of nc=3. This results in the server rejecting the request - since the server has already received a request for that nonce with nc=2 - and responding with an HTTP 401 with a new challenge and nonce. This causes httpclient to have to resend the 3rd request with a different (and this time correct) authorization header.&lt;/p&gt;

&lt;p&gt;I copy-and-pasted the Authorization headers from the log - notice the 2nd and 3rd headers both having nonce=eafa1174b88ee53b85744f2c8f6f7307 and nc=00000002:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Authorization: Digest username=&lt;span class=&quot;code-quote&quot;&gt;&quot;admin&quot;&lt;/span&gt;, realm=&lt;span class=&quot;code-quote&quot;&gt;&quot;Sarix&quot;&lt;/span&gt;, nonce=&lt;span class=&quot;code-quote&quot;&gt;&quot;eafa1174b88ee53b85744f2c8f6f7307&quot;&lt;/span&gt;, uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;/control/SoftwareUpdate-1&quot;&lt;/span&gt;, response=&lt;span class=&quot;code-quote&quot;&gt;&quot;067deae08d92d60ef44b0f6a044700dc&quot;&lt;/span&gt;, qop=auth-&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, nc=00000001, cnonce=&lt;span class=&quot;code-quote&quot;&gt;&quot;103ca2350da1ca4a&quot;&lt;/span&gt;, algorithm=MD5

Authorization: Digest username=&lt;span class=&quot;code-quote&quot;&gt;&quot;admin&quot;&lt;/span&gt;, realm=&lt;span class=&quot;code-quote&quot;&gt;&quot;Sarix&quot;&lt;/span&gt;, nonce=&lt;span class=&quot;code-quote&quot;&gt;&quot;eafa1174b88ee53b85744f2c8f6f7307&quot;&lt;/span&gt;, uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;/control/StreamDiscovery-1&quot;&lt;/span&gt;, response=&lt;span class=&quot;code-quote&quot;&gt;&quot;d5ebfb273477ec64c4a76d790648bf34&quot;&lt;/span&gt;, qop=auth-&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, nc=00000002, cnonce=&lt;span class=&quot;code-quote&quot;&gt;&quot;103ca2350da1ca4a&quot;&lt;/span&gt;, algorithm=MD5

Authorization: Digest username=&lt;span class=&quot;code-quote&quot;&gt;&quot;admin&quot;&lt;/span&gt;, realm=&lt;span class=&quot;code-quote&quot;&gt;&quot;Sarix&quot;&lt;/span&gt;, nonce=&lt;span class=&quot;code-quote&quot;&gt;&quot;eafa1174b88ee53b85744f2c8f6f7307&quot;&lt;/span&gt;, uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;/control/SoftwareUpdate-1&quot;&lt;/span&gt;, response=&lt;span class=&quot;code-quote&quot;&gt;&quot;1f12344c596fd3dd7f1af3f56697d537&quot;&lt;/span&gt;, qop=auth-&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, nc=00000002, cnonce=&lt;span class=&quot;code-quote&quot;&gt;&quot;103ca2350da1ca4a&quot;&lt;/span&gt;, algorithm=MD5

Authorization: Digest username=&lt;span class=&quot;code-quote&quot;&gt;&quot;admin&quot;&lt;/span&gt;, realm=&lt;span class=&quot;code-quote&quot;&gt;&quot;Sarix&quot;&lt;/span&gt;, nonce=&lt;span class=&quot;code-quote&quot;&gt;&quot;20e689c2d679afbee962e69595a5da77&quot;&lt;/span&gt;, uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;/control/SoftwareUpdate-1&quot;&lt;/span&gt;, response=&lt;span class=&quot;code-quote&quot;&gt;&quot;5da037b112721b2c56596098c5932343&quot;&lt;/span&gt;, qop=auth-&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, nc=00000001, cnonce=&lt;span class=&quot;code-quote&quot;&gt;&quot;384513b98a74bbb4&quot;&lt;/span&gt;, algorithm=MD5
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16197159" author="olegk" created="Mon, 9 Oct 2017 15:33:52 +0000"  >&lt;p&gt;And how did PR #86 fix thus problem in 4.5.x?&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="16197192" author="alessandro.gherardi@yahoo.com" created="Mon, 9 Oct 2017 16:01:16 +0000"  >&lt;p&gt;The code change is here: &lt;a href=&quot;https://github.com/apache/httpcomponents-client/pull/86/commits/2e929bcc7e47d89d5955bf6e91972b5d27806ecb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/pull/86/commits/2e929bcc7e47d89d5955bf6e91972b5d27806ecb&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;During a pre-emptive digest authentication, RequestAuthCache sets the authentication state to AuthProtocolState.CHALLENGED. This causes httpclient to store the updated DigestScheme - with the incremented nonce counter - into the auth cache.&lt;/p&gt;</comment>
                            <comment id="16197225" author="olegk" created="Mon, 9 Oct 2017 16:21:58 +0000"  >&lt;p&gt;So, you are saying the auth cache now gets written into on each and every message exchange potentially by multiple competing threads? This sounds like a much bigger problem to me that not supporting DIGEST auth caching at all.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="16197447" author="alessandro.gherardi@yahoo.com" created="Mon, 9 Oct 2017 18:27:33 +0000"  >&lt;p&gt;BasicAuthCache is thread safe, so no data corruption should occur.&lt;/p&gt;

&lt;p&gt;It is true that if multiple threads share the same AuthCache and talk to the same server at the same time, they could overwrite each other&apos;s DigestScheme. Solving that problem would probably require a lot of rework: Currently, the auth cache is keyed on HttpHost, so there is only room for one DigestScheme per host.&lt;/p&gt;

&lt;p&gt;The change I&apos;m proposing optimizes the single-AuthCache-per-HttpHost-per-concurrent thread usecase, by effectively reusing the same server nonce multiple times. If multiple threads must share the same AuthCache, more network roundtrips/auth challenges will be needed, so performance won&apos;t be optimal. But things will still work.&lt;/p&gt;

&lt;p&gt;I believe that saving network roundtrips/auth challenges is worth the cost of updating the auth cache on every request.&lt;/p&gt;</comment>
                            <comment id="16197513" author="olegk" created="Mon, 9 Oct 2017 19:06:33 +0000"  >&lt;p&gt;The fix is still not right. Instead of forcing a rewrite of the cache entry on every request it would likely make more sense to update nonce count upon retrieval from the cache.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="16197607" author="alessandro.gherardi@yahoo.com" created="Mon, 9 Oct 2017 19:57:12 +0000"  >&lt;p&gt;Currently, the cache stores AuthSchemes in serialized format. So even if we increment the nonce count on retrieval, a cache write still needs to occur.&lt;/p&gt;

&lt;p&gt;If the cached stored AuthSchemes in non-serialized format, we could increment the nonce count on retrieval - or even better, when authenticate() is called.&lt;/p&gt;

&lt;p&gt;That approach is more complex. I can certainly give it a try, but before doing that, I need your approval to switch to storing AuthSchemes in non-serialized format. Is that OK with you?&lt;/p&gt;</comment>
                            <comment id="16197700" author="olegk" created="Mon, 9 Oct 2017 21:06:58 +0000"  >&lt;p&gt;The internal representation of cache entries is not very important. The approach would likely mean more work but it also looks like a better thing to do.&lt;/p&gt;

&lt;p&gt;Oleg &lt;/p&gt;</comment>
                            <comment id="16212440" author="jira-bot" created="Fri, 20 Oct 2017 09:52:47 +0000"  >&lt;p&gt;Commit 722490c68c6437daa0604f7e3fbd25b8473c656a in httpcomponents-client&apos;s branch refs/heads/4.6.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=httpcomponents-client.git;h=722490c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=httpcomponents-client.git;h=722490c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-1855&quot; title=&quot;Digest auth: Nonce counter not incremented after reuse&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-1855&quot;&gt;&lt;del&gt;HTTPCLIENT-1855&lt;/del&gt;&lt;/a&gt;: Removed code causing unnecessary auth cache updated; Reverted c82799f1e&lt;/p&gt;</comment>
                            <comment id="16212441" author="jira-bot" created="Fri, 20 Oct 2017 09:52:48 +0000"  >&lt;p&gt;Commit ba47719c3adcc328fd800296ab5189d965ee216c in httpcomponents-client&apos;s branch refs/heads/4.6.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=httpcomponents-client.git;h=ba47719&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=httpcomponents-client.git;h=ba47719&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-1855&quot; title=&quot;Digest auth: Nonce counter not incremented after reuse&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-1855&quot;&gt;&lt;del&gt;HTTPCLIENT-1855&lt;/del&gt;&lt;/a&gt;: disabled caching of DIGEST auth scheme instances due to unreliability of nonce counter when the auth cache is shared by multiple sessions&lt;/p&gt;</comment>
                            <comment id="16212442" author="jira-bot" created="Fri, 20 Oct 2017 09:53:00 +0000"  >&lt;p&gt;Commit aa81865776f4d664b829981071fbd9fd83203d6f in httpcomponents-client&apos;s branch refs/heads/4.5.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=httpcomponents-client.git;h=aa81865&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=httpcomponents-client.git;h=aa81865&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-1855&quot; title=&quot;Digest auth: Nonce counter not incremented after reuse&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-1855&quot;&gt;&lt;del&gt;HTTPCLIENT-1855&lt;/del&gt;&lt;/a&gt;: Removed code causing unnecessary auth cache updated; Reverted 7e44b96&lt;/p&gt;</comment>
                            <comment id="16212443" author="jira-bot" created="Fri, 20 Oct 2017 09:53:01 +0000"  >&lt;p&gt;Commit 1383e1f781012e767c0cc811aeef77e28264682d in httpcomponents-client&apos;s branch refs/heads/4.5.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=httpcomponents-client.git;h=1383e1f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=httpcomponents-client.git;h=1383e1f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-1855&quot; title=&quot;Digest auth: Nonce counter not incremented after reuse&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-1855&quot;&gt;&lt;del&gt;HTTPCLIENT-1855&lt;/del&gt;&lt;/a&gt;: disabled caching of DIGEST auth scheme instances due to unreliability of nonce counter when the auth cache is shared by multiple sessions&lt;/p&gt;</comment>
                            <comment id="16212451" author="olegk" created="Fri, 20 Oct 2017 10:01:06 +0000"  >&lt;p&gt;I found no solution that would allow DIGEST scheme instances to be cached and re-used by multiple sessions. I ended up disabling automatic caching of DIGEST scheme instances.&lt;/p&gt;

&lt;p&gt;Instead of caching DIGEST scheme it is recommended to use the same &lt;tt&gt;HttpContext&lt;/tt&gt; for HTTP exchanges within the same logical session. This will ensure correctness of DIGEST scheme state across multiple sessions.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="16212455" author="jira-bot" created="Fri, 20 Oct 2017 10:06:33 +0000"  >&lt;p&gt;Commit 9368c5f5c830e3c57c8a0e4f2183b4165f0fe056 in httpcomponents-client&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=httpcomponents-client.git;h=9368c5f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=httpcomponents-client.git;h=9368c5f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-1855&quot; title=&quot;Digest auth: Nonce counter not incremented after reuse&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-1855&quot;&gt;&lt;del&gt;HTTPCLIENT-1855&lt;/del&gt;&lt;/a&gt;: disabled caching of DIGEST auth scheme instances due to unreliability of nonce counter when the auth cache is shared by multiple sessions&lt;/p&gt;</comment>
                            <comment id="16218697" author="githubbot" created="Wed, 25 Oct 2017 14:09:45 +0000"  >&lt;p&gt;GitHub user agherardi opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/httpcomponents-client/pull/88&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/pull/88&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-1855&quot; title=&quot;Digest auth: Nonce counter not incremented after reuse&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-1855&quot;&gt;&lt;del&gt;HTTPCLIENT-1855&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/agherardi/httpcomponents-client&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/agherardi/httpcomponents-client&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-1855&quot; title=&quot;Digest auth: Nonce counter not incremented after reuse&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-1855&quot;&gt;&lt;del&gt;HTTPCLIENT-1855&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/httpcomponents-client/pull/88.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/pull/88.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #88&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 8a107d6ff40edfe2f83c6655ae1d816584deb0c4&lt;br/&gt;
Author: alessandro.gherardi &amp;lt;alessandro.gherardi@schneider-electric.com&amp;gt;&lt;br/&gt;
Date:   2017-10-23T00:02:11Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-1855&quot; title=&quot;Digest auth: Nonce counter not incremented after reuse&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-1855&quot;&gt;&lt;del&gt;HTTPCLIENT-1855&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16218706" author="alessandro.gherardi@yahoo.com" created="Wed, 25 Oct 2017 14:14:08 +0000"  >&lt;p&gt;I submitted a new pull request &lt;a href=&quot;https://github.com/apache/httpcomponents-client/pull/88&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/pull/88&lt;/a&gt; against the master branch. The changes I&apos;m proposing are:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Re-enable caching of DigestSchemes&lt;/li&gt;
	&lt;li&gt;Refactor BasicAuthCache to: (1) Store AuthSchemes un-serialized; (2) The cache supports multiple DigestSchemes per host key; (3) The get() method removes DigestSchemes from the cache, so that the same server nonce can only be used by a single request at a time; (4) Allow the application to specify the maximum number of entries to store in the cache and use an LRU policy to evict older entries.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16237015" author="alessandro.gherardi@yahoo.com" created="Fri, 3 Nov 2017 02:53:48 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt; - any feedback? Thank you.&lt;/p&gt;</comment>
                            <comment id="16237872" author="olegk" created="Fri, 3 Nov 2017 16:38:25 +0000"  >&lt;p&gt;@&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alessandro.gherardi%40yahoo.com&quot; class=&quot;user-hover&quot; rel=&quot;alessandro.gherardi@yahoo.com&quot;&gt;alessandro.gherardi@yahoo.com&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;1. I am quite convinced now DIGEST scheme caching was a mistake to begin with. For related requests / sessions people ought to be using the same &lt;tt&gt;HttpContext&lt;/tt&gt; instance. However I am fine with making this behavior customizable / pluggable.&lt;br/&gt;
2. You fix involves setting auth exchange state to CHALLENGED even though there has been no auth challenge. This sounds conceptually wrong to me.&lt;/p&gt;

&lt;p&gt;Oleg &lt;/p&gt;</comment>
                            <comment id="16238886" author="olegk" created="Sat, 4 Nov 2017 10:13:18 +0000"  >&lt;p&gt;@&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alessandro.gherardi%40yahoo.com&quot; class=&quot;user-hover&quot; rel=&quot;alessandro.gherardi@yahoo.com&quot;&gt;alessandro.gherardi@yahoo.com&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ll push this commit to the official repo in a day or so, if I hear no complaints from you.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/ok2c/httpclient/commit/d88e32f9525f36bbbb46dc212648fd484e70a072&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ok2c/httpclient/commit/d88e32f9525f36bbbb46dc212648fd484e70a072&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="16239000" author="alessandro.gherardi@yahoo.com" created="Sat, 4 Nov 2017 13:19:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt; thanks for continuing to look into this.&lt;/p&gt;

&lt;p&gt;My thoughts:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Reusing the same HttpContexts may be problematic for some applications. For instance, consider an application with a worker thread pool. When the application receives a request from a client, it processes the request on a worker thread. As part of the processing, the thread makes a call to an HTTP server that requires authentication. The next time the application needs to talk to the HTTP server, it may do so on a different worker thread. To reuse the HttpContext, the application would have to implement some sort of HttpContext cache. That&apos;s effectively the same as using an auth cache&lt;/li&gt;
	&lt;li&gt;Allowing an application to decide whether or not to cache DigestSchemes depending on some configuration parameter would be great&lt;/li&gt;
	&lt;li&gt;No issues with &lt;a href=&quot;https://github.com/ok2c/httpclient/commit/d88e32f9525f36bbbb46dc212648fd484e70a072&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ok2c/httpclient/commit/d88e32f9525f36bbbb46dc212648fd484e70a072&lt;/a&gt;, although that commit by itself doesn&apos;t allow the application to decide whether or not to cache DigestSchemes&lt;/li&gt;
	&lt;li&gt;Regarding setting the auth exchange state to CHALLENGED in RequestAuthCache, that is to force an updated DigestScheme - with an incremented nonce counter - to be re-cached after reuse.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Basically, the desired outcome is as follows:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The first time we successfully authenticate to an HTTP server that requires digest authentication, cache the DigestScheme&lt;/li&gt;
	&lt;li&gt;The next time we need to talk to that server, retrieve a DigestScheme from the cache (if available), remove it from the cache so that no other thread can reuse it until the request is complete, and use the DigestScheme to preemptively build an authorization header. As part of this, the nonce counter within the DigestScheme is incremented.&lt;/li&gt;
	&lt;li&gt;If authentication is successful, re-cache the updated DigestScheme so it can be later reused for another request&lt;/li&gt;
	&lt;li&gt;If authentication is not successful, don&apos;t re-cache the updated DigestScheme - probably the nonce has expired. Instead, create a new DigestScheme using the digest challenge we receive from the servers and the credentials, retry the request using the new DigestScheme to authenticate and if successful cache the DigestScheme.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16240482" author="olegk" created="Mon, 6 Nov 2017 16:04:20 +0000"  >&lt;blockquote&gt;&lt;p&gt;Reusing the same HttpContexts may be problematic for some applications&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Why? Why should it be problematic for any application? &lt;tt&gt;HttpContext&lt;/tt&gt; represents a shared conversational state or a session state. Whether or not it is safe to mutate the session state concurrently is up to individual applications to decide, but generally &lt;tt&gt;HttpContext&lt;/tt&gt; attributes can be threading unsafe. For instance, &lt;tt&gt;AuthScheme&lt;/tt&gt; instances are not threading state. &lt;/p&gt;

&lt;p&gt;This issue has nothing to do with caching. In my opinion you are approaching the problem from a completely wrong angle. You want multiple threads to share the same DIGEST state? Fine, make DigestScheme threading safe. But this problem has &lt;em&gt;nothing&lt;/em&gt; to do with caching as such.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="16243368" author="alessandro.gherardi@yahoo.com" created="Wed, 8 Nov 2017 04:46:35 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Why should it be problematic for any application?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Consider a webservice application which processes requests from one or more webservice clients. To service multiple client requests concurrently, the application uses a pool of worker threads. Each request is processed by a separate worker thread. When a worker thread has finished processing a request, the thread goes back to to the pool of available threads. This is a very common design pattern for webservices.&lt;/p&gt;

&lt;p&gt;As part of processing client requests, the application must communicate with one or more network devices via HTTP. The devices require digest authentication. The application stores credentials for the various devices in its database.&lt;/p&gt;

&lt;p&gt;Let&apos;s suppose the webservice application receives a request that requires it to communicate with device A. The request is assigned to a worker thread. The worker thread creates a new HttpContext. If this is the first time that the application communicates with A, httpclient receives a HTTP 401 with a digest challenge, creates a digest scheme containing device A&apos;s nonce and uses the scheme and the device credentials to re-send the request with an Authorization header containing the challenge response. The device validates the Authorization header and replies successfully.&lt;/p&gt;

&lt;p&gt;The worker thread is now done processing the client response and returns to the pool of available threads.&lt;/p&gt;

&lt;p&gt;In order for the digest scheme containing device A&apos;s nonce to be reused by a worker thread the next time the application needs to communicate with device A, the application must store either the HttpContext or the digest scheme in some kind of cache, using device A&apos;s IP as the cache key.&lt;/p&gt;

&lt;p&gt;In summary, re-using HttpContext is not complicated, but basically requires implementing something very similar to httpclient&apos;s auth cache. It would be nice if that functionality was provided by httpclient via its auth cache so applications don&apos;t have to reinvent the wheel.&lt;/p&gt;

&lt;p&gt;Hope the above makes sense.&lt;/p&gt;</comment>
                            <comment id="16247432" author="olegk" created="Fri, 10 Nov 2017 12:48:28 +0000"  >&lt;p&gt;Fundamentally the issue is about some state information shared by multiple contexts / execution threads, not about caching. Essentially what you want to multiple contexts to share is not the DIGEST scheme state, but only a count associated with a particular nonce. Misusing or abusing the auth cache functionality sounds wrong to me, especially given it requires forcing a cache update on each request / response exchange. There are better ways of achieving the same goal, for instance, by making DigestScheme instances share some common structure.&lt;/p&gt;

&lt;p&gt;Oleg &lt;/p&gt;</comment>
                            <comment id="16248738" author="alessandro.gherardi@yahoo.com" created="Sun, 12 Nov 2017 00:05:02 +0000"  >&lt;blockquote&gt;
&lt;p&gt;There are better ways of achieving the same goal, for instance, by making DigestScheme instances share some common structure.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I have a preliminary question: Are you planning on implementing the approach above? If yes, I&apos;ll stop bugging you and look forward&lt;br/&gt;
to your implementation. If not and you&apos;d like for me to try and implement this, I need some guidance.&lt;/p&gt;

&lt;p&gt;I believe we agree that reusing HttpContexts across multiple execution threads would require the application to implement a&lt;br/&gt;
HttpContext cache, and that&apos;s not an ideal option.&lt;/p&gt;

&lt;p&gt;If multiple execution threads use different HttpContexts, pre-emptive digest authentication requires the DigestScheme to be cached.&lt;br/&gt;
So rolling back&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/httpcomponents-client/commit/9368c5f5c830e3c57c8a0e4f2183b4165f0fe056&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/commit/9368c5f5c830e3c57c8a0e4f2183b4165f0fe056&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/httpcomponents-client/commit/1383e1f781012e767c0cc811aeef77e28264682d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/commit/1383e1f781012e767c0cc811aeef77e28264682d&lt;/a&gt; is a prerequisite. Do you agree?&lt;/p&gt;

&lt;p&gt;Please let me know.&lt;/p&gt;</comment>
                            <comment id="16258136" author="olegk" created="Sat, 18 Nov 2017 18:13:19 +0000"  >&lt;p&gt;@&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alessandro.gherardi%40yahoo.com&quot; class=&quot;user-hover&quot; rel=&quot;alessandro.gherardi@yahoo.com&quot;&gt;alessandro.gherardi@yahoo.com&lt;/a&gt; I have my hands full with 5.x development, so I ideally I would like you to scratch your own itch. But I put together a patch that should help you get going. Please have a look at &lt;a href=&quot;https://github.com/ok2c/httpclient/commit/935ddb935383083a50a65eb67cd889b6d0bcdb97&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;935ddb935383083a50a65eb67cd889b6d0bcdb97&lt;/a&gt;. It should resolve the problem with having to abuse auth state management logic in order to trigger auth cache update on every request / response exchange. If it looks reasonable to you I&apos;ll push it to the official master branch.&lt;/p&gt;

&lt;p&gt;There is no need to revert anything because with &lt;a href=&quot;https://github.com/apache/httpcomponents-client/commit/d88e32f9525f36bbbb46dc212648fd484e70a072&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;d88e32f9525f36bbbb46dc212648fd484e70a072&lt;/a&gt; one can annotate any arbitrary &lt;tt&gt;AuthScheme&lt;/tt&gt; with &lt;tt&gt;@AuthStateCacheable&lt;/tt&gt; to make it cacheable.&lt;/p&gt;

&lt;p&gt;Oleg &lt;/p&gt;</comment>
                            <comment id="16258503" author="alessandro.gherardi@yahoo.com" created="Sun, 19 Nov 2017 14:49:26 +0000"  >&lt;p&gt;I updated &lt;a href=&quot;https://github.com/apache/httpcomponents-client/pull/88&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/pull/88&lt;/a&gt; per the comments in &lt;a href=&quot;https://github.com/ok2c/httpclient/commit/935ddb935383083a50a65eb67cd889b6d0bcdb97&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ok2c/httpclient/commit/935ddb935383083a50a65eb67cd889b6d0bcdb97&lt;/a&gt; . Please take a look when you have a chance.&lt;/p&gt;</comment>
                            <comment id="16258540" author="githubbot" created="Sun, 19 Nov 2017 17:38:54 +0000"  >&lt;p&gt;Github user ok2c commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/httpcomponents-client/pull/88#discussion_r151871562&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/pull/88#discussion_r151871562&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: httpclient5/src/main/java/org/apache/hc/client5/http/auth/AuthCache.java &amp;#8212;&lt;br/&gt;
    @@ -45,4 +45,8 @@&lt;/p&gt;

&lt;p&gt;         void clear();&lt;/p&gt;

&lt;p&gt;    +    boolean canCache(String name);&lt;br/&gt;
    +&lt;br/&gt;
    +    boolean needsUpdatingAfterReusing(String name);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    @agherardi  So, you still insist on needing to update the cache on each and every message exchange? &lt;/p&gt;</comment>
                            <comment id="16258571" author="githubbot" created="Sun, 19 Nov 2017 19:12:36 +0000"  >&lt;p&gt;Github user agherardi commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/httpcomponents-client/pull/88#discussion_r151874368&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/pull/88#discussion_r151874368&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: httpclient5/src/main/java/org/apache/hc/client5/http/auth/AuthCache.java &amp;#8212;&lt;br/&gt;
    @@ -45,4 +45,8 @@&lt;/p&gt;

&lt;p&gt;         void clear();&lt;/p&gt;

&lt;p&gt;    +    boolean canCache(String name);&lt;br/&gt;
    +&lt;br/&gt;
    +    boolean needsUpdatingAfterReusing(String name);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Yes. Consider the following scenario:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The auth cache contains a DigestScheme for host H, with nonce=N and nonce count=1&lt;/li&gt;
	&lt;li&gt;Thread A needs to send a request to host H. The thread retrieves the DigestScheme from the cache, increments nonce count to 2 and uses N to create an Authorization header for its HTTP request.&lt;/li&gt;
	&lt;li&gt;Thread B also needs to send a request to host H. If the cache returns the same DigestScheme, thread B creates an Authorization header for its HTTP request with nonce=N and nonce count=3.&lt;/li&gt;
	&lt;li&gt;If thread B sends its HTTP request before thread A sends its HTTP request, host H rejects thread B&apos;s request because the nonce count is 3 instead of 2.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    IMO, a DigestScheme needs to be removed from the cache until a response is received from the server, so that no other thread can use the same nonce. If a successful response is received from the server, the DigestScheme can be re-cached with an updated nonce count.&lt;/p&gt;

&lt;p&gt;    I wrote a custom AuthCache that implements the behavior above. The cache stores AuthSchemes unserialized. The cost of un-caching and re-caching  DigestSchemes for every message exchange is minimal, especially when  compared to the cost of a network roundtrip if the request needs to be resent due to the nonce count being out-of-sequence.&lt;/p&gt;

&lt;p&gt;    The needsUpdatingAfterReusing method allowed me to implement the custom AuthCache, which is not part of this merge request. BasicAuthCache&apos;s implementation of needsUpdatingAfterReusing returns FALSE, so BasicAuthCache is not updated on very message exchange - which is what you want.&lt;/p&gt;</comment>
                            <comment id="16259015" author="githubbot" created="Mon, 20 Nov 2017 09:37:31 +0000"  >&lt;p&gt;Github user ok2c commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/httpcomponents-client/pull/88#discussion_r151940280&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/pull/88#discussion_r151940280&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: httpclient5/src/main/java/org/apache/hc/client5/http/auth/AuthCache.java &amp;#8212;&lt;br/&gt;
    @@ -45,4 +45,8 @@&lt;/p&gt;

&lt;p&gt;         void clear();&lt;/p&gt;

&lt;p&gt;    +    boolean canCache(String name);&lt;br/&gt;
    +&lt;br/&gt;
    +    boolean needsUpdatingAfterReusing(String name);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    @agherardi So, we are happily back to the same point where we have started: a cache that requires an update on each and every operation is probably not a cache.&lt;/p&gt;</comment>
                            <comment id="16259383" author="githubbot" created="Mon, 20 Nov 2017 15:42:36 +0000"  >&lt;p&gt;Github user agherardi commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/httpcomponents-client/pull/88#discussion_r152026284&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/pull/88#discussion_r152026284&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: httpclient5/src/main/java/org/apache/hc/client5/http/auth/AuthCache.java &amp;#8212;&lt;br/&gt;
    @@ -45,4 +45,8 @@&lt;/p&gt;

&lt;p&gt;         void clear();&lt;/p&gt;

&lt;p&gt;    +    boolean canCache(String name);&lt;br/&gt;
    +&lt;br/&gt;
    +    boolean needsUpdatingAfterReusing(String name);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    &amp;gt; a cache that requires an update on each and every operation is probably not a cache.&lt;/p&gt;

&lt;p&gt;    I disagree. Caching digest authentication information is useful to avoid network roundtrips, which are much mostly costly than updating a cache. Unfortunately, unlike &quot;standard&quot; caching usecases, reusing cached digest authentication information requires the cache to be updated.&lt;/p&gt;

&lt;p&gt;    I understand you disagree with me, and that&apos;s totally fine. All I&apos;m asking for it the hooks into httpclient that allow me to add my custom auth cache. &lt;/p&gt;
</comment>
                            <comment id="16259440" author="githubbot" created="Mon, 20 Nov 2017 16:32:30 +0000"  >&lt;p&gt;Github user ok2c commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/httpcomponents-client/pull/88#discussion_r152042431&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/pull/88#discussion_r152042431&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: httpclient5/src/main/java/org/apache/hc/client5/http/auth/AuthCache.java &amp;#8212;&lt;br/&gt;
    @@ -45,4 +45,8 @@&lt;/p&gt;

&lt;p&gt;         void clear();&lt;/p&gt;

&lt;p&gt;    +    boolean canCache(String name);&lt;br/&gt;
    +&lt;br/&gt;
    +    boolean needsUpdatingAfterReusing(String name);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    @agherardi I do not have a problem with us not agreeing with one another but I do feel uncomfortable about adding two methods to a public interface that are specific to one particular auth scheme and completely unnecessary to start with.   &lt;/p&gt;</comment>
                            <comment id="16259676" author="githubbot" created="Mon, 20 Nov 2017 19:06:39 +0000"  >&lt;p&gt;Github user agherardi commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/httpcomponents-client/pull/88#discussion_r152082458&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/pull/88#discussion_r152082458&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: httpclient5/src/main/java/org/apache/hc/client5/http/auth/AuthCache.java &amp;#8212;&lt;br/&gt;
    @@ -45,4 +45,8 @@&lt;/p&gt;

&lt;p&gt;         void clear();&lt;/p&gt;

&lt;p&gt;    +    boolean canCache(String name);&lt;br/&gt;
    +&lt;br/&gt;
    +    boolean needsUpdatingAfterReusing(String name);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    canCache() is not specific to a particular auth scheme. I think it&apos;s better than using an annotation because it allows one to control which schemes an auth cache implementation can store, without having to write a new scheme class and a new scheme factory. But since you&apos;re the man, if you would rather use the annotation that&apos;s fine by me.&lt;/p&gt;

&lt;p&gt;    needsUpdatingAfterReusing() is needed to have the system re-cache a digest scheme after reuse. As I explained in the scenario above, when a digest scheme is allocated to a request, it should not be reused until a successful response to that request is received.&lt;/p&gt;

&lt;p&gt;    The alternative is to change RequestAuthCache like in here &lt;a href=&quot;https://github.com/apache/httpcomponents-client/pull/88/commits/8a107d6ff40edfe2f83c6655ae1d816584deb0c4#diff-9ba10ad1fe707824930ac6fb842c871b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/pull/88/commits/8a107d6ff40edfe2f83c6655ae1d816584deb0c4#diff-9ba10ad1fe707824930ac6fb842c871b&lt;/a&gt;. That code I added calls targetAuthExchange.setState(AuthExchange.State.CHALLENGED). I can put that call inside an if (scheme is digest), so it&apos;s digest specific. The point is that either the cache or the DigestScheme need to be told when the scheme has been reused successfully and can be made available for new requests. Please let me know if you have a different suggestion.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12890984" name="HttpClient5Digest.java" size="3776" author="alessandro.gherardi@yahoo.com" created="Sun, 8 Oct 2017 20:19:12 +0000"/>
                            <attachment id="12872767" name="HttpClientDigest.java" size="3600" author="alessandro.gherardi@yahoo.com" created="Mon, 12 Jun 2017 20:09:49 +0000"/>
                            <attachment id="12891063" name="httpclient5.log" size="22045" author="alessandro.gherardi@yahoo.com" created="Mon, 9 Oct 2017 14:20:19 +0000"/>
                            <attachment id="12872769" name="wireshark.txt" size="2963" author="alessandro.gherardi@yahoo.com" created="Mon, 12 Jun 2017 20:15:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 51 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3g6lr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>