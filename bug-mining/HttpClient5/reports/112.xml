<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:22:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HTTPCLIENT-2314] IllegalStateException: Endpoint is not connected</title>
                <link>https://issues.apache.org/jira/browse/HTTPCLIENT-2314</link>
                <project id="12310360" key="HTTPCLIENT">HttpComponents HttpClient</project>
                    <description>&lt;p&gt;Using `PoolingHttpClientConnectionManager`, under high traffic situations it occurs consistently that the exception &quot;Endpoint is not connected&quot; is invoked.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The full stacktrace looks like this:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;Caused by: java.lang.IllegalStateException: Endpoint is not connected&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; at org.apache.hc.core5.util.Asserts.check(Asserts.java:38) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;httpcore5-5.2.4.jar:5.2.4&amp;#93;&lt;/span&gt;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; at org.apache.hc.client5.http.impl.io.PoolingHttpClientConnectionManager$InternalConnectionEndpoint.getValidatedPoolEntry(PoolingHttpClientConnectionManager.java:664) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;httpclient5-5.3.jar:5.3&amp;#93;&lt;/span&gt;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; at org.apache.hc.client5.http.impl.io.PoolingHttpClientConnectionManager$InternalConnectionEndpoint.setSocketTimeout(PoolingHttpClientConnectionManager.java:697) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;httpclient5-5.3.jar:5.3&amp;#93;&lt;/span&gt;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; at org.apache.hc.client5.http.impl.classic.InternalExecRuntime.execute(InternalExecRuntime.java:211) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;httpclient5-5.3.jar:5.3&amp;#93;&lt;/span&gt;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; at org.apache.hc.client5.http.impl.classic.MainClientExec.execute(MainClientExec.java:116) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;httpclient5-5.3.jar:5.3&amp;#93;&lt;/span&gt;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; at org.apache.hc.client5.http.impl.classic.ExecChainElement.execute(ExecChainElement.java:51) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;httpclient5-5.3.jar:5.3&amp;#93;&lt;/span&gt;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; at org.apache.hc.client5.http.impl.classic.ConnectExec.execute(ConnectExec.java:188) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;httpclient5-5.3.jar:5.3&amp;#93;&lt;/span&gt;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; at org.apache.hc.client5.http.impl.classic.ExecChainElement.execute(ExecChainElement.java:51) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;httpclient5-5.3.jar:5.3&amp;#93;&lt;/span&gt;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; at org.apache.hc.client5.http.impl.classic.ProtocolExec.execute(ProtocolExec.java:192) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;httpclient5-5.3.jar:5.3&amp;#93;&lt;/span&gt;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; at org.apache.hc.client5.http.impl.classic.ExecChainElement.execute(ExecChainElement.java:51) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;httpclient5-5.3.jar:5.3&amp;#93;&lt;/span&gt;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; at org.apache.hc.client5.http.impl.classic.HttpRequestRetryExec.execute(HttpRequestRetryExec.java:113) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;httpclient5-5.3.jar:5.3&amp;#93;&lt;/span&gt;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; at org.apache.hc.client5.http.impl.classic.ExecChainElement.execute(ExecChainElement.java:51) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;httpclient5-5.3.jar:5.3&amp;#93;&lt;/span&gt;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; at org.apache.hc.client5.http.impl.classic.ContentCompressionExec.execute(ContentCompressionExec.java:152) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;httpclient5-5.3.jar:5.3&amp;#93;&lt;/span&gt;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; at org.apache.hc.client5.http.impl.classic.ExecChainElement.execute(ExecChainElement.java:51) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;httpclient5-5.3.jar:5.3&amp;#93;&lt;/span&gt;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; at org.apache.hc.client5.http.impl.classic.RedirectExec.execute(RedirectExec.java:116) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;httpclient5-5.3.jar:5.3&amp;#93;&lt;/span&gt;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; at org.apache.hc.client5.http.impl.classic.ExecChainElement.execute(ExecChainElement.java:51) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;httpclient5-5.3.jar:5.3&amp;#93;&lt;/span&gt;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; at org.apache.hc.client5.http.impl.classic.InternalHttpClient.doExecute(InternalHttpClient.java:170) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;httpclient5-5.3.jar:5.3&amp;#93;&lt;/span&gt;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:245) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;httpclient5-5.3.jar:5.3&amp;#93;&lt;/span&gt;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:188) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;httpclient5-5.3.jar:5.3&amp;#93;&lt;/span&gt;&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Unfortunately I don&apos;t have a standalone example to reproduce it.&lt;/p&gt;

&lt;p&gt;Any suggestions for a workaround????&lt;/p&gt;</description>
                <environment></environment>
        <key id="13563621">HTTPCLIENT-2314</key>
            <summary>IllegalStateException: Endpoint is not connected</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="phax">Philip Helger</reporter>
                        <labels>
                    </labels>
                <created>Thu, 4 Jan 2024 18:24:43 +0000</created>
                <updated>Sun, 7 Jan 2024 14:48:21 +0000</updated>
                            <resolved>Sun, 7 Jan 2024 14:48:21 +0000</resolved>
                                    <version>5.2</version>
                    <version>5.3</version>
                                    <fixVersion>5.3.1</fixVersion>
                    <fixVersion>5.4-alpha2</fixVersion>
                                    <component>HttpClient (classic)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="17803464" author="olegk" created="Fri, 5 Jan 2024 08:47:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phax&quot; class=&quot;user-hover&quot; rel=&quot;phax&quot;&gt;phax&lt;/a&gt; This is not necessarily a bug. This can happen if one aborts the request while HttpClient is trying to execute a redirect or respond to a authentication challenge within the same message exchange.&lt;/p&gt;

&lt;p&gt;Does your code abort requests?&lt;/p&gt;

&lt;p&gt;&amp;gt; Unfortunately I don&apos;t have a standalone example to reproduce it.&lt;/p&gt;

&lt;p&gt;I am not going to be able to do much without a reproducer and will have to close the issue as non-reproducible.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17803545" author="jira-bot" created="Fri, 5 Jan 2024 13:29:05 +0000"  >&lt;p&gt;Commit 67519a1a89fce9cf0edd870d2344217c811b27f8 in httpcomponents-client&apos;s branch refs/heads/5.3.x from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=67519a1a8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=67519a1a8&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2314&quot; title=&quot;IllegalStateException: Endpoint is not connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2314&quot;&gt;&lt;del&gt;HTTPCLIENT-2314&lt;/del&gt;&lt;/a&gt;: Throw ConnectionShutdownException in case of pooled connection having been closed or discarded instead of plain IllegalStateException&lt;/p&gt;</comment>
                            <comment id="17803547" author="jira-bot" created="Fri, 5 Jan 2024 13:34:41 +0000"  >&lt;p&gt;Commit e2385f7d9a7994b3359b224d5454b18ec2b1fc0a in httpcomponents-client&apos;s branch refs/heads/master from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=e2385f7d9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=e2385f7d9&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2314&quot; title=&quot;IllegalStateException: Endpoint is not connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2314&quot;&gt;&lt;del&gt;HTTPCLIENT-2314&lt;/del&gt;&lt;/a&gt;: Throw ConnectionShutdownException in case of pooled connection having been closed or discarded instead of plain IllegalStateException&lt;/p&gt;</comment>
                            <comment id="17803550" author="olegk" created="Fri, 5 Jan 2024 13:38:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phax&quot; class=&quot;user-hover&quot; rel=&quot;phax&quot;&gt;phax&lt;/a&gt;&#160;Please&lt;/p&gt;

&lt;p&gt;(1) upgrade to HttpClient 5.3.1-SNAPSHOT in order to pick the small tweak I have just committed The easiest way to do so is to clone the project at GitHub, build it locally and install the snapshot to your local Maven repo.&lt;/p&gt;

&lt;p&gt;(2) Try to create a reproducer&lt;/p&gt;

&lt;p&gt;(3) Failing that try to run your code with the context logging on described here and attach the log to this ticket&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://hc.apache.org/httpcomponents-client-5.3.x/logging.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://hc.apache.org/httpcomponents-client-5.3.x/logging.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(4) Otherwise this is all I can do for you here.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17803572" author="phax" created="Fri, 5 Jan 2024 15:19:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;&#160; thanks for your feedback - I will do as proposed and try to produce decent logs &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17803623" author="phax" created="Fri, 5 Jan 2024 16:52:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;&#160; please find attached the debug log - it contains a bit more then just httpclient logs, but I think it might be helpful. Please let me know, if you need more.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Server details in case you care:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;Server Version: &#160; &#160; &#160; &#160;Apache Tomcat/10.1.8&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;Server built: &#160; &#160; &#160; &#160; &#160;Apr 14 2023 19:40:29 UTC&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;Server version number: 10.1.8.0&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;OS Name: &#160; &#160; &#160; &#160; &#160; &#160; &#160; Linux&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;OS Version: &#160; &#160; &#160; &#160; &#160; &#160;3.10.0-1160.105.1.el7.x86_64&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;Architektur: &#160; &#160; &#160; &#160; &#160; amd64&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;Java Home: &#160; &#160; &#160; &#160; &#160; &#160; /usr/lib/jvm/jdk-17-oracle-x64&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;JVM Version: &#160; &#160; &#160; &#160; &#160; 17.0.8+9-LTS-211&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;JVM Hersteller: &#160; &#160; &#160; &#160;Oracle Corporation&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;CATALINA_BASE: &#160; &#160; &#160; &#160; /usr/share/apache-tomcat-10.1.8&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;CATALINA_HOME: &#160; &#160; &#160; &#160; /usr/share/apache-tomcat-10.1.8&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;Command line argument: -Djava.util.logging.config.file=/usr/share/tomcat10/conf/logging.properties&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;Command line argument: -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;Command line argument: -Djdk.tls.ephemeralDHKeySize=2048&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;Command line argument: -Djava.protocol.handler.pkgs=org.apache.catalina.webresources&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;Command line argument: -Dorg.apache.catalina.security.SecurityListener.UMASK=0027&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;Command line argument: --add-opens=java.base/java.lang=ALL-UNNAMED&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;Command line argument: --add-opens=java.base/java.io=ALL-UNNAMED&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;Command line argument: --add-opens=java.base/java.util=ALL-UNNAMED&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;Command line argument: --add-opens=java.base/java.util.concurrent=ALL-UNNAMED&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;Command line argument: --add-opens=java.rmi/sun.rmi.transport=ALL-UNNAMED&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;Command line argument: -Xmx3g&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;Command line argument: -Dcatalina.base=/usr/share/tomcat10&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;Command line argument: -Dcatalina.home=/usr/share/tomcat10&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;Command line argument: -Djava.io.tmpdir=/usr/share/tomcat10/temp&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="17803628" author="olegk" created="Fri, 5 Jan 2024 17:00:37 +0000"  >&lt;blockquote&gt;&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2024-01-05T16:45:24,984&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;PP&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;DEBUG&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;ajp-nio-0:0:0:0:0:0:0:1-8110-exec-5&amp;#93;&lt;/span&gt; Shutdown connection pool GRACEFUL &amp;#8211; org.apache.hc.client5.http.impl.io.PoolingHttpClientConnectionManager.close(PoolingHttpClientConnectionManager.java:246)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phax&quot; class=&quot;user-hover&quot; rel=&quot;phax&quot;&gt;phax&lt;/a&gt; For all that is sacred, why are you shutting down the connection pool? No wonder some requests fail.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17803633" author="phax" created="Fri, 5 Jan 2024 17:10:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;&#160; well in this particular case I am not reusing an &lt;tt&gt;HttpClient&lt;/tt&gt; heavily but instead create new ones when I need them.&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;HttpClient&lt;/tt&gt; implicitly closes the &lt;tt&gt;PoolingHttpClientConnectionManager&lt;/tt&gt; when closed (as a &lt;tt&gt;ModalCloseable&lt;/tt&gt;).&lt;/p&gt;

&lt;p&gt;So each new connection creates a new PoolingHttpClientConnectionManager and destroys it when it doesn&apos;t need it anymore. That worked beautifiully in prior versions. It seems to me that, that might be something introduced in 5.2 but I cannot confirm it yet. Did you add some ThreadLocal or so?&lt;/p&gt;</comment>
                            <comment id="17803638" author="phax" created="Fri, 5 Jan 2024 17:27:50 +0000"  >&lt;p&gt;Okay, I stirred in my old logs and the error occurs for me (every now and then) since 19.08.2022, so it has nothing to do with 5.2 or so. This was the first time I used httpclient 5.1.3 (after upgrading from 4.5.13).&lt;/p&gt;

&lt;p&gt;It&apos;s just that since December 2023 it occurs so often that it became annoying and I started digging into it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17803639" author="olegk" created="Fri, 5 Jan 2024 17:31:22 +0000"  >&lt;p&gt;&amp;gt; well in this particular case I am not reusing an &lt;tt&gt;HttpClient&lt;/tt&gt; heavily but instead create new ones when I need them.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phax&quot; class=&quot;user-hover&quot; rel=&quot;phax&quot;&gt;phax&lt;/a&gt; Well, there appears to be a race condition in your code that leads to execution of requests with an HttpClient instance whose connection pool has already been shut down.&lt;/p&gt;

&lt;p&gt;Instead of throwing away a perfectly valid HttpClient along with its pool you would be better off just flushing all persistent connections from the pool instead.&lt;/p&gt;

&lt;p&gt;&amp;gt; Did you add some ThreadLocal or so?&lt;/p&gt;

&lt;p&gt;No, I did not. ThreadLocal can be very evil. We use them extremely sparingly .&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17803665" author="phax" created="Fri, 5 Jan 2024 18:34:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt; I added some more debug logging and stumbled upon an interesting this.&lt;/p&gt;

&lt;p&gt;Is it normal, that &quot;connect&quot; is called twice on a request?&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;See attached logfile &quot;httpclient-2314-1.txt&quot;&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;I am trying to find the callstacks when this happens....&lt;/p&gt;</comment>
                            <comment id="17803671" author="olegk" created="Fri, 5 Jan 2024 18:51:16 +0000"  >&lt;p&gt;&amp;gt; Is it normal, that &quot;connect&quot; is called twice on a request?&lt;/p&gt;

&lt;p&gt;Yes, it is, if the target host has a multi-home DNS and one of the nodes is not responding.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17803685" author="phax" created="Fri, 5 Jan 2024 19:08:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;&#160; thanks for your patience &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I added another log file excerpt (httpclient-2314-2.txt) that seems to be interesting in regards to DNS issues.&lt;/p&gt;

&lt;p&gt;Lines 18 and 27 read &quot;B-9172695604f7a4f789cbf7a6c4fee38e.iso6523-actorid-upis.edelivery.tech.ec.europa.eu resolved to []&quot; - I interprete that as &quot;DNS resolution failed&quot;.&lt;/p&gt;

&lt;p&gt;So is it possible, that you are not handling these kind of DNS lookup failures properly, resulting in this weird error message?&lt;/p&gt;

&lt;p&gt;Edit: this was done with the 5.3 release build&lt;/p&gt;

&lt;p&gt;Edit 2: I am using the &lt;font color=&quot;#000000&quot;&gt;SystemDefaultDnsResolver.INSTANCE&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;Edit 3: I have dnsjava 3.5.3 in my ClassPath that overrides the Java Runtime DNS resolution, if I am not mistaken.&lt;/font&gt;&lt;/p&gt;</comment>
                            <comment id="17803699" author="olegk" created="Fri, 5 Jan 2024 20:32:06 +0000"  >&lt;p&gt;&amp;gt; &lt;font color=&quot;#000000&quot;&gt;Edit 3: I have dnsjava 3.5.3 in my ClassPath that overrides the Java Runtime DNS resolution, if I am not mistaken.&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phax&quot; class=&quot;user-hover&quot; rel=&quot;phax&quot;&gt;phax&lt;/a&gt; This is something that should have been mentioned from the very beginning. I will take another look. Having said that I still think that your approach is conceptually wrong or sub-optimal at the very least.&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;Oleg&lt;/font&gt;&lt;/p&gt;</comment>
                            <comment id="17803703" author="phax" created="Fri, 5 Jan 2024 20:52:48 +0000"  >&lt;p&gt;If I&apos;d only knew from the beginning what is important and what isn&apos;t... Sorry for the inconvenience caused&lt;/p&gt;</comment>
                            <comment id="17803822" author="jira-bot" created="Sat, 6 Jan 2024 14:40:11 +0000"  >&lt;p&gt;Commit 8996465fcacdad2f4a658df43f6f1984f3656109 in httpcomponents-client&apos;s branch refs/heads/&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2314&quot; title=&quot;IllegalStateException: Endpoint is not connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2314&quot;&gt;&lt;del&gt;HTTPCLIENT-2314&lt;/del&gt;&lt;/a&gt; from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=8996465fc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=8996465fc&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2314&quot; title=&quot;IllegalStateException: Endpoint is not connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2314&quot;&gt;&lt;del&gt;HTTPCLIENT-2314&lt;/del&gt;&lt;/a&gt;: better handling of DNS failure to resolve an address resulting in an empty result set more&lt;/p&gt;</comment>
                            <comment id="17803824" author="olegk" created="Sat, 6 Jan 2024 14:43:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phax&quot; class=&quot;user-hover&quot; rel=&quot;phax&quot;&gt;phax&lt;/a&gt; Please test the fix &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; in the &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2314&quot; title=&quot;IllegalStateException: Endpoint is not connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2314&quot;&gt;&lt;del&gt;HTTPCLIENT-2314&lt;/del&gt;&lt;/a&gt; branch and let me know if resolves the problem for you.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/httpcomponents-client/compare/master...HTTPCLIENT-2314&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/compare/master...HTTPCLIENT-2314&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17803932" author="phax" created="Sun, 7 Jan 2024 10:46:04 +0000"  >&lt;p&gt;Edit:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt; I backported the commit into my local &lt;tt&gt;5.3.x&lt;/tt&gt; branch and the Exception is still thrown &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Updated logfiles will be provided asap&lt;/p&gt;</comment>
                            <comment id="17803936" author="phax" created="Sun, 7 Jan 2024 11:53:37 +0000"  >&lt;p&gt;I think the problem is in this debug log in PoolingHttpClientConnectionManager:&lt;br/&gt;
&lt;font color=&quot;#000000&quot;&gt; &lt;/font&gt;&lt;font color=&quot;#7f0055&quot;&gt;if&lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt; (&lt;/font&gt;&lt;font color=&quot;#0000c0&quot;&gt;LOG&lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt;.isDebugEnabled()) {&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt; &lt;/font&gt;&lt;font color=&quot;#0000c0&quot;&gt;LOG&lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt;.debug(&lt;/font&gt;&lt;font color=&quot;#2a00ff&quot;&gt;&quot;{} connection is not kept alive(isConsistent:{})&quot;&lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt;, ConnPoolSupport.&lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt;getId&lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt;(&lt;/font&gt;&lt;font color=&quot;#6a3e3e&quot;&gt;endpoint&lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt;), &lt;/font&gt;&lt;font color=&quot;#6a3e3e&quot;&gt;conn&lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt;.isConsistent());&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt; }&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;Because &quot;conn&quot; is null.&lt;/p&gt;

&lt;p&gt;Trying to create a PR on the 5.3.x branch&lt;/p&gt;</comment>
                            <comment id="17803938" author="olegk" created="Sun, 7 Jan 2024 12:12:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phax&quot; class=&quot;user-hover&quot; rel=&quot;phax&quot;&gt;phax&lt;/a&gt; That defect has been fixed:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/httpcomponents-client/commit/9e3d79bedeee494d24bdb03cc598bae5184a3abf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/commit/9e3d79bedeee494d24bdb03cc598bae5184a3abf&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17803957" author="phax" created="Sun, 7 Jan 2024 13:07:47 +0000"  >&lt;p&gt;Okay thanks . Sorry, it gets a bit more messy, but I found a way to reproduce it locally.&lt;/p&gt;

&lt;p&gt;I mixed the 5.4-alpha branch with the 5.3.x branch for the issue on the debug log - that is not present in 5.3.x but good to have it fixed.&lt;/p&gt;

&lt;p&gt;Additionally I found out, that I am using a custom DNS resolver which indeed returns an empty array instead of throwing an UnknownHostException.&lt;/p&gt;

&lt;p&gt;{{That means, that the following code in }}&quot;DefaultHttpClientConnectionOperator&quot; (line 143 in 5.3.x branch) gets an empty array:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&lt;font color=&quot;#6a3e3e&quot;&gt;remoteAddresses&lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt; = &lt;/font&gt;&lt;font color=&quot;#7f0055&quot;&gt;this&lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt;.&lt;/font&gt;&lt;font color=&quot;#0000c0&quot;&gt;dnsResolver&lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt;.resolve(&lt;/font&gt;&lt;font color=&quot;#6a3e3e&quot;&gt;host&lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt;.getHostName());&lt;/font&gt;&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&lt;font color=&quot;#7f0055&quot;&gt;if&lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt; (&lt;/font&gt;&lt;font color=&quot;#0000c0&quot;&gt;LOG&lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt;.isDebugEnabled()) {&lt;/font&gt;&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&lt;font color=&quot;#000000&quot;&gt;&#160; &lt;/font&gt;&lt;font color=&quot;#0000c0&quot;&gt;LOG&lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt;.debug(&lt;/font&gt;&lt;font color=&quot;#2a00ff&quot;&gt;&quot;{} resolved to {}&quot;&lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt;, &lt;/font&gt;&lt;font color=&quot;#6a3e3e&quot;&gt;host&lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt;.getHostName(), Arrays.&lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt;asList&lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt;(&lt;/font&gt;&lt;font color=&quot;#6a3e3e&quot;&gt;remoteAddresses&lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt;));&lt;/font&gt;&lt;/tt&gt;&lt;/p&gt;


&lt;p&gt;(btw. &lt;tt&gt;Arrays.asList(remoteAddresses)&lt;/tt&gt; will throw an Exception if param is null)&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;I create a fork of httpclient with my local changes at &lt;a href=&quot;https://github.com/phax/httpcomponents-client/tree/5.3.x&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/phax/httpcomponents-client/tree/5.3.x&lt;/a&gt; - is it okay to make a PR, or is there a better way to resolve it?&lt;/font&gt;&lt;/p&gt;</comment>
                            <comment id="17803959" author="olegk" created="Sun, 7 Jan 2024 13:20:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phax&quot; class=&quot;user-hover&quot; rel=&quot;phax&quot;&gt;phax&lt;/a&gt; It is perfectly okay to create a PR with the changes you would like to propose, though, I am not sure I understand what exactly you intent to fix given I have already fixed the problem with handling of empty resolved address list in `SystemDefaultDnsResolver`.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17803961" author="phax" created="Sun, 7 Jan 2024 13:33:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;&#160; thanks. You fixed the problem in the &quot;SystemDefaultDnsResolver&quot;.&lt;/p&gt;

&lt;p&gt;But if a custom implementation of &quot;DnsResolver&quot; is used, your fix will not help.&lt;/p&gt;

&lt;p&gt;My fix works in this particular case as well.&lt;/p&gt;

&lt;p&gt;See &lt;a href=&quot;https://github.com/apache/httpcomponents-client/pull/533&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/pull/533&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17803970" author="jira-bot" created="Sun, 7 Jan 2024 14:44:46 +0000"  >&lt;p&gt;Commit 16508314d1aefc3b1b978125da9855998d6c2921 in httpcomponents-client&apos;s branch refs/heads/5.3.x from Philip Helger&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=16508314d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=16508314d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2314&quot; title=&quot;IllegalStateException: Endpoint is not connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2314&quot;&gt;&lt;del&gt;HTTPCLIENT-2314&lt;/del&gt;&lt;/a&gt;: Handle gracefully a failure of DnsResolver to return a list of resolved addresses (#533)&lt;/p&gt;
</comment>
                            <comment id="17803971" author="jira-bot" created="Sun, 7 Jan 2024 14:47:12 +0000"  >&lt;p&gt;Commit 8228ddf28a58015f842bebd4e2ab6269f92608dc in httpcomponents-client&apos;s branch refs/heads/master from Philip Helger&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=8228ddf28&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=8228ddf28&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2314&quot; title=&quot;IllegalStateException: Endpoint is not connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2314&quot;&gt;&lt;del&gt;HTTPCLIENT-2314&lt;/del&gt;&lt;/a&gt;: Handle gracefully a failure of DnsResolver to return a list of resolved addresses (#533)&lt;/p&gt;
</comment>
                            <comment id="17803972" author="olegk" created="Sun, 7 Jan 2024 14:48:21 +0000"  >&lt;p&gt;Fix committed to 5.3.x and master.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13065757" name="debuglog-httpclient-2314.txt" size="185993" author="phax" created="Fri, 5 Jan 2024 16:51:43 +0000"/>
                            <attachment id="13065764" name="httpclient-2314-1.txt" size="4506" author="phax" created="Fri, 5 Jan 2024 18:35:06 +0000"/>
                            <attachment id="13065765" name="httpclient-2314-2.txt" size="20674" author="phax" created="Fri, 5 Jan 2024 19:06:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 43 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1mkf4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>