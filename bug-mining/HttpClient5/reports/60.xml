<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:22:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HTTPCLIENT-2086] NTLM Message parse Error</title>
                <link>https://issues.apache.org/jira/browse/HTTPCLIENT-2086</link>
                <project id="12310360" key="HTTPCLIENT">HttpComponents HttpClient</project>
                    <description>&lt;p&gt;My Authentication endpoint returns an NTLM Message header like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;WWW-Authenticate: NTLM TlRMTVNTUAACAAAABgAGADgAAAAF.....QByAGcALgBkAGUABwAIAMG9LHviQtYBAAAAAA==&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Upon reading this header with &lt;tt&gt;AuthChallengeParser&lt;/tt&gt; hc parses this field using the code in &lt;a href=&quot;https://github.com/apache/httpcomponents-client/blob/3730b03a99308ff99769fdd60e80a43230cf5aac/httpclient5/src/main/java/org/apache/hc/client5/http/impl/auth/AuthChallengeParser.java#L70&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;line 70&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!cursor.atEnd() &amp;amp;&amp;amp; buffer.charAt(cursor.getPos()) == EQUAL_CHAR) {
                cursor.updatePos(cursor.getPos() + 1);
                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; value = tokenParser.parseValue(buffer, cursor, DELIMITER);
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BasicNameValuePair(token, value);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When reading the first &quot;=&quot; char of the message, it interprets the value as a key-value pair. The first part of the NTLM message being the key and the second &quot;=&quot; the value. &lt;a href=&quot;https://github.com/apache/httpcomponents-client/blob/3730b03a99308ff99769fdd60e80a43230cf5aac/httpclient5/src/main/java/org/apache/hc/client5/http/impl/auth/AuthChallengeParser.java#L126&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Later&lt;/a&gt; an AuthChallenge is later created with&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AuthChallenge(challengeType, schemeName, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, params.size() &amp;gt; 0 ? params : &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;where &lt;tt&gt;value&lt;/tt&gt; is null and params a list containing the NTLM message without the equals signs. &lt;/p&gt;

&lt;p&gt;Without the &quot;==&quot; the next auth step fails.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13311345">HTTPCLIENT-2086</key>
            <summary>NTLM Message parse Error</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="maffelbaffel">Michael Wagner</reporter>
                        <labels>
                    </labels>
                <created>Sun, 14 Jun 2020 16:21:49 +0000</created>
                <updated>Mon, 24 Jan 2022 15:17:42 +0000</updated>
                            <resolved>Wed, 1 Jul 2020 10:30:05 +0000</resolved>
                                    <version>5.0</version>
                                    <fixVersion>5.0.2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="6000">1h 40m</timespent>
                                <comments>
                            <comment id="17135233" author="michael-o" created="Sun, 14 Jun 2020 17:08:01 +0000"  >&lt;p&gt;Something is wrong here. &lt;tt&gt;Authorization&lt;/tt&gt; is sent by the client, not pased the mentioned class. How is this subject to cient-side parsing?&lt;/p&gt;</comment>
                            <comment id="17135508" author="maffelbaffel" created="Mon, 15 Jun 2020 07:02:55 +0000"  >&lt;p&gt;Ops, you are right of course. I copied the wrong header. The endpoint returns a &quot;&lt;tt&gt;WWW-Authenticate: NTLM TlRMTVNTUAACAAAABgAG....IAMG9LHviQtYBAAAAAA==&lt;/tt&gt;&quot; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&#160; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13005687/13005687_screenshot-1.png&quot; height=&quot;373&quot; width=&quot;720&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Notice how in my screenshot &lt;tt&gt;tokenOrParameter&lt;/tt&gt; has a &lt;tt&gt;value&lt;/tt&gt; of &lt;tt&gt;=&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17135575" author="olegk" created="Mon, 15 Jun 2020 08:13:16 +0000"  >&lt;p&gt;We should have dropped support for NTLM in 5.0 when we had a chance. Now I will have to put NTLM specific logic into &lt;tt&gt;AuthChallengeParser&lt;/tt&gt; code in order to work the problem around.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17135652" author="michael-o" created="Mon, 15 Jun 2020 09:17:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;, I think we aren&apos;t properly handling &lt;a href=&quot;https://tools.ietf.org/html/rfc7235#section-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;RFC 7235&lt;/a&gt;:&lt;/p&gt;

 &lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;challenge   = auth-scheme [ 1*SP ( token68 / #auth-param ) ]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Are you certian that there is this edge case we aren&apos;t handling proper difference between token68 and auth-param? I think the parsing depends on the auth scheme, unfortunately. WDYT?&lt;/p&gt;</comment>
                            <comment id="17135679" author="olegk" created="Mon, 15 Jun 2020 09:37:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=michael-o&quot; class=&quot;user-hover&quot; rel=&quot;michael-o&quot;&gt;michael-o&lt;/a&gt;&#160;HttpClient 5.0 is not yet&#160;&#160;&lt;a href=&quot;https://tools.ietf.org/html/rfc7235#section-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;RFC 7235&lt;/a&gt;&#160;compliant. Someone has to review the entire code base for conformance with&#160;&lt;a href=&quot;https://tools.ietf.org/html/rfc7235#section-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;RFC 7235&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17135741" author="michael-o" created="Mon, 15 Jun 2020 10:56:50 +0000"  >&lt;p&gt;Yes, that&apos;s the reason. Infact, RFC 2617 defines:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;challenge   = auth-scheme 1*SP 1#auth-param
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;which differs from what RFC 7235 does. This bascially means that NTLM and SPNEGO broke the RFC before 7235.&lt;/p&gt;</comment>
                            <comment id="17135763" author="michael-o" created="Mon, 15 Jun 2020 11:19:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maffelbaffel&quot; class=&quot;user-hover&quot; rel=&quot;maffelbaffel&quot;&gt;maffelbaffel&lt;/a&gt;, if you want this fixed you like need to do what Oleg said. Review the code for the newest RFC.&lt;/p&gt;</comment>
                            <comment id="17135804" author="olegk" created="Mon, 15 Jun 2020 12:09:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=michael-o&quot; class=&quot;user-hover&quot; rel=&quot;michael-o&quot;&gt;michael-o&lt;/a&gt;&#160;This might be too much to ask of a casual contributor. I will likely have time in July to work on RFC&#160;7235 compliance.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17135826" author="maffelbaffel" created="Mon, 15 Jun 2020 12:51:06 +0000"  >&lt;p&gt;Thank you everyone for the very quick responses and thanks for keeping NTLM supported!&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;&#160;If there is anything I can do even if only testing, please feel free to tell me.&lt;/p&gt;</comment>
                            <comment id="17135893" author="michael-o" created="Mon, 15 Jun 2020 14:04:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;, I agree, but the work cold be limited to the parser only for this case.&lt;/p&gt;</comment>
                            <comment id="17135913" author="olegk" created="Mon, 15 Jun 2020 14:23:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=michael-o&quot; class=&quot;user-hover&quot; rel=&quot;michael-o&quot;&gt;michael-o&lt;/a&gt;&#160;I am not a big fan of partial RFC compliance, but I will see what I can do.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17135946" author="michael-o" created="Mon, 15 Jun 2020 15:02:46 +0000"  >&lt;p&gt;You are absolutely right, it should be either all or nothing!&lt;/p&gt;</comment>
                            <comment id="17137874" author="ekerwin" created="Tue, 16 Jun 2020 19:23:44 +0000"  >&lt;p&gt;I believe I am hitting this as well. For the moment, I am able to address the parser&apos;s output in a custom NTLMScheme that doesn&apos;t just look at challenge value, but also looks at params.&lt;/p&gt;

&lt;p&gt;I have no idea if that&apos;s acceptable, but here&apos;s how I&apos;m doing it... (I don&apos;t claim it is good...)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Override
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void processChallenge(
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; AuthChallenge authChallenge,
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; HttpContext context) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; MalformedChallengeException {
    Args.notNull(authChallenge, &lt;span class=&quot;code-quote&quot;&gt;&quot;AuthChallenge&quot;&lt;/span&gt;);

    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.challenge = authChallenge.getValue();
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.challenge == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; authChallenge.getParams() != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; authChallenge.getParams().size() &amp;gt; 0) {
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.challenge = authChallenge.getParams().get(0).getName();
    }
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.challenge == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.challenge.isEmpty()) {
...

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17139378" author="olegk" created="Thu, 18 Jun 2020 12:14:14 +0000"  >&lt;p&gt;I am working on it but at the moment I am not sure if we can bring it into 5.0 release or it will have to wait until 5.1.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17139525" author="ekerwin" created="Thu, 18 Jun 2020 16:02:40 +0000"  >&lt;p&gt;I&apos;d love to assist if I could actually help. I&apos;ve been looking at the parser and it seems like you might want the scheme, as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=michael-o&quot; class=&quot;user-hover&quot; rel=&quot;michael-o&quot;&gt;michael-o&lt;/a&gt;&#160;mentions above, control the parsing.&lt;/p&gt;

&lt;p&gt;I am not an expert on NTLM at all, but it looks like its challenge response should not be tokenized, here&apos;s my challenge:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
NTLM TlRMTVNTUAACAAAAAAAAADgAAAABggiiS0u2y+0O6WIAAAAAAAAAAAAAAAA4AAAABgEAAAAAAA8=&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I&apos;m currently working on a forked version so I can provide a PR once I have an NTLM parser ready. Is this a waste of my (and more importantly, your) time?&lt;/p&gt;</comment>
                            <comment id="17139538" author="michael-o" created="Thu, 18 Jun 2020 16:29:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ekerwin&quot; class=&quot;user-hover&quot; rel=&quot;ekerwin&quot;&gt;ekerwin&lt;/a&gt;, please note that this was a quick proposal. I should not be tied to the auth scheme. RFC 7235 does not tie the logic to a specific one. I would expect a generic approach can detect either token68 or auth params.&lt;/p&gt;</comment>
                            <comment id="17139540" author="ekerwin" created="Thu, 18 Jun 2020 16:35:20 +0000"  >&lt;p&gt;Ah, tragic. Figuring out what that means is a bit more than I feel confident biting off. But I&apos;ll keep reading the RFC&apos;s and maybe insight will come. Thank you for the feedback!&lt;/p&gt;</comment>
                            <comment id="17140645" author="olegk" created="Fri, 19 Jun 2020 15:41:55 +0000"  >&lt;p&gt;There are no surprises. The RFC 7235 basically institutionalizes the mess that has always been there. It is still legal to cram multiple challenges into a single message header, making them impossible to parse efficiently with a single pass parser. &lt;/p&gt;

&lt;p&gt;Whatever changes I will have to make to &lt;tt&gt;AuthChallengeParser&lt;/tt&gt; we can release them from the 5.0.x branch.&lt;/p&gt;

&lt;p&gt;Oleg &lt;/p&gt;</comment>
                            <comment id="17141217" author="maffelbaffel" created="Sat, 20 Jun 2020 21:41:43 +0000"  >&lt;blockquote&gt;&lt;p&gt;Whatever changes I will have to make to&#160;&lt;tt&gt;AuthChallengeParser&lt;/tt&gt;&#160;we can release them from the 5.0.x branch.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Sounds great! HC is still my go-to client for NTLM auth. Your effort is really appreciated!&lt;/p&gt;

&lt;p&gt;Thanks, a lot Oleg!&lt;/p&gt;</comment>
                            <comment id="17147733" author="olegk" created="Mon, 29 Jun 2020 12:18:38 +0000"  >&lt;p&gt;RFC 7235 is a **** travesty. How one is supposed to parse the following header value? &lt;/p&gt;

&lt;p&gt;&lt;tt&gt;scheme1 aaaa  , scheme2 aaaa==,  scheme3 aaaa=aaaa, scheme4 aaaa=&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;`scheme1` is likely token68 based. `scheme3` is likely parameter based. What am I supposed to do with `scheme2` and `scheme4`?&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17147754" author="maffelbaffel" created="Mon, 29 Jun 2020 12:45:00 +0000"  >&lt;p&gt;Not sure if that&apos;s an option for you but you could write an ANTLR grammar/parser and hand off the complexity to ANTLR.&lt;/p&gt;

&lt;p&gt;Aren&apos;t scheme2 and 4 also token68 based?&lt;/p&gt;

&lt;p&gt;So I guess if a &quot;=&quot; occurs, you need to also check the next character.&lt;/p&gt;

&lt;p&gt;If next char (= | EOF | ,) -&amp;gt;&#160;current value is token68&lt;/p&gt;

&lt;p&gt;else -&amp;gt; parameter&lt;/p&gt;</comment>
                            <comment id="17147863" author="michael-o" created="Mon, 29 Jun 2020 15:05:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;, couldn&apos;t have said it better. Especially because schemes and auth paramus use both commas. In your case, both are token68 because a sole token requires 1*tchar which is not satisfied after the first equals sign.&lt;/p&gt;</comment>
                            <comment id="17147876" author="olegk" created="Mon, 29 Jun 2020 15:20:37 +0000"  >&lt;blockquote&gt;&lt;p&gt;you could write an ANTLR grammar/parser and hand off the complexity to ANTLR&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maffelbaffel&quot; class=&quot;user-hover&quot; rel=&quot;maffelbaffel&quot;&gt;maffelbaffel&lt;/a&gt; Apache Mime4j has been down that road. Thank you, but no, thank you.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17147942" author="olegk" created="Mon, 29 Jun 2020 16:42:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maffelbaffel&quot; class=&quot;user-hover&quot; rel=&quot;maffelbaffel&quot;&gt;maffelbaffel&lt;/a&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ekerwin&quot; class=&quot;user-hover&quot; rel=&quot;ekerwin&quot;&gt;ekerwin&lt;/a&gt; Here my proposed fix. If you could take it for a spin or do a code review, it would be awesome.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/httpcomponents-client/pull/230&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/pull/230&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17148242" author="ekerwin" created="Tue, 30 Jun 2020 01:27:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;&#160;I&apos;m still getting the 407, but it does seem to be coming from a different place. I&apos;m no longer getting in to the AuthChallengeParser a second time. NTLMScheme, line 103, is throwing a MalformedChallengeException.&lt;/p&gt;

&lt;p&gt;How can I better capture what I&apos;m doing? I could record a debugging session, or perhaps set up a screen share?&#160; I have a project to test 4.5.12 and 5 using my company&apos;s NTLM proxy. Hope that helps!&lt;/p&gt;</comment>
                            <comment id="17148403" author="michael-o" created="Tue, 30 Jun 2020 08:00:14 +0000"  >&lt;p&gt;These days, I tend to log everything. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ekerwin&quot; class=&quot;user-hover&quot; rel=&quot;ekerwin&quot;&gt;ekerwin&lt;/a&gt;, can you add more debug messages to the PR? You could follow the code flow then.&lt;/p&gt;</comment>
                            <comment id="17148405" author="maffelbaffel" created="Tue, 30 Jun 2020 08:04:52 +0000"  >&lt;p&gt;As for me, the PR fixed the problem, and authentication works!&lt;/p&gt;</comment>
                            <comment id="17148519" author="olegk" created="Tue, 30 Jun 2020 10:35:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ekerwin&quot; class=&quot;user-hover&quot; rel=&quot;ekerwin&quot;&gt;ekerwin&lt;/a&gt; Please post the complete stack trace of  `MalformedChallengeException` and the wire / log context of the session.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17148578" author="ekerwin" created="Tue, 30 Jun 2020 11:51:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;&#160;I&apos;ve attached&#160;ntlm 407 log and stacktrace.txt, and the MalformedChallengeException stacktrace is at line 117.&lt;/p&gt;</comment>
                            <comment id="17148615" author="michael-o" created="Tue, 30 Jun 2020 12:31:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ekerwin&quot; class=&quot;user-hover&quot; rel=&quot;ekerwin&quot;&gt;ekerwin&lt;/a&gt;, this case should be covered now by &lt;a href=&quot;https://github.com/apache/httpcomponents-client/pull/230/files#diff-666dcab82cf111d038450d11385cadedR130-R132&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/pull/230/files#diff-666dcab82cf111d038450d11385cadedR130-R132&lt;/a&gt;. The exception does not make sense. There is no throw for this exception message. Build from master please, 76a12fc4c680b25b1c3820b78069967fd0901a22 fixes this issue.&lt;/p&gt;</comment>
                            <comment id="17148617" author="ekerwin" created="Tue, 30 Jun 2020 12:35:41 +0000"  >&lt;p&gt;Ah, I was building from the PR. I will merge master locally and try that.&lt;/p&gt;</comment>
                            <comment id="17148620" author="ekerwin" created="Tue, 30 Jun 2020 12:38:02 +0000"  >&lt;p&gt;Also, I should have said, I added the ex.printStacktrace() to get the output.&lt;/p&gt;</comment>
                            <comment id="17148625" author="ekerwin" created="Tue, 30 Jun 2020 12:42:47 +0000"  >&lt;p&gt;I merged apache master into Oleg&apos;s branch - there are some conflicts to resolve. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;This will take me some time.&lt;/p&gt;</comment>
                            <comment id="17148657" author="ekerwin" created="Tue, 30 Jun 2020 13:10:59 +0000"  >&lt;p&gt;Still getting errors. The parser DOES now get invoked twice, once with &quot;NTLM&quot; as the buffer and a second time with &quot;NTLM TlRMTVNTUAACAAAAAAAAADgAAAABggiin2c+jmXtqkAAAAAAAAAAAAAAAAA4AAAABgEAAAAAAA8=&quot; as the buffer.&lt;/p&gt;

&lt;p&gt;This second invocation results in this state:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;authChallenges = {ArrayList@1983}  size = 1
 0 = {AuthChallenge@2024} &quot;NTLM [TlRMTVNTUAACAAAAAAAAADgAAAABggiin2c+jmXtqkAAAAAAAAAAAAAAAAA4AAAABgEAAAAAAA8=]&quot;
  challengeType = {ChallengeType@1930} &quot;PROXY&quot;
  schemeName = &quot;NTLM&quot;
  value = null
  params = {Collections$UnmodifiableRandomAccessList@2026}  size = 1
   0 = {BasicNameValuePair@2028} &quot;TlRMTVNTUAACAAAAAAAAADgAAAABggiin2c+jmXtqkAAAAAAAAAAAAAAAAA4AAAABgEAAAAAAA8=&quot;
    name = &quot;TlRMTVNTUAACAAAAAAAAADgAAAABggiin2c+jmXtqkAAAAAAAAAAAAAAAAA4AAAABgEAAAAAAA8&quot;
    value = &quot;&quot;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This AuthChallenge gets passed down to the NTLMScheme, which has this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.challenge = authChallenge.getValue();
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.challenge == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.challenge.isEmpty()) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.state == State.UNINITIATED) {
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.state = State.CHALLENGE_RECEIVED;
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.state = State.FAILED;
    }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;which, because value is null, results in State.FAILED.&lt;/p&gt;</comment>
                            <comment id="17148678" author="ekerwin" created="Tue, 30 Jun 2020 13:33:52 +0000"  >&lt;p&gt;For some reason...I&apos;m not using the PR code any longer. Disregard my last comment...I need to figure out what happend.&lt;/p&gt;</comment>
                            <comment id="17148709" author="ekerwin" created="Tue, 30 Jun 2020 14:07:08 +0000"  >&lt;p&gt;When you actually USE Oleg&apos;s code, everything is fine. This fixes the issue for me, sorry for adding useless confusion!&lt;/p&gt;</comment>
                            <comment id="17148751" author="michael-o" created="Tue, 30 Jun 2020 15:02:19 +0000"  >&lt;p&gt;Can you now provide another debug log file with properly fixed code?&lt;/p&gt;</comment>
                            <comment id="17148757" author="ekerwin" created="Tue, 30 Jun 2020 15:08:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=michael-o&quot; class=&quot;user-hover&quot; rel=&quot;michael-o&quot;&gt;michael-o&lt;/a&gt;&#160;added &quot;ntlm working.txt&quot; to show it now works. Thanks!&lt;/p&gt;</comment>
                            <comment id="17148769" author="michael-o" created="Tue, 30 Jun 2020 15:21:38 +0000"  >&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;11:06:05.280 [main] DEBUG org.apache.hc.client5.http.headers - http-outgoing-0 &amp;lt;&amp;lt; HTTP/1.0 200 Connection established
11:06:05.280 [main] DEBUG org.apache.hc.client5.http.impl.classic.ConnectExec - Authentication succeeded
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Looks perfect to me. The type 3 message has been successfully generated and accepted.&lt;/p&gt;</comment>
                            <comment id="17149304" author="jira-bot" created="Wed, 1 Jul 2020 10:28:14 +0000"  >&lt;p&gt;Commit da28440a58c381abcbd34d648372a819902fabfd in httpcomponents-client&apos;s branch refs/heads/master from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=da28440&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=da28440&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;RFC 7235 compliance, &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2086&quot; title=&quot;NTLM Message parse Error&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2086&quot;&gt;&lt;del&gt;HTTPCLIENT-2086&lt;/del&gt;&lt;/a&gt;: fixed parsing of token68 based (base64-encoded) auth schemes.&lt;/p&gt;</comment>
                            <comment id="17156022" author="jira-bot" created="Sat, 11 Jul 2020 15:38:44 +0000"  >&lt;p&gt;Commit da28440a58c381abcbd34d648372a819902fabfd in httpcomponents-client&apos;s branch refs/heads/5.1.x from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=da28440&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=da28440&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;RFC 7235 compliance, &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2086&quot; title=&quot;NTLM Message parse Error&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2086&quot;&gt;&lt;del&gt;HTTPCLIENT-2086&lt;/del&gt;&lt;/a&gt;: fixed parsing of token68 based (base64-encoded) auth schemes.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310361">
                    <name>Blocked</name>
                                            <outwardlinks description="Blocked">
                                        <issuelink>
            <issuekey id="13424421">HTTPCLIENT-2199</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13006749" name="ntlm 407 log and stacktrace.txt" size="29435" author="ekerwin" created="Tue, 30 Jun 2020 11:49:54 +0000"/>
                            <attachment id="13006762" name="ntlm working.txt" size="207765" author="ekerwin" created="Tue, 30 Jun 2020 15:07:35 +0000"/>
                            <attachment id="13005687" name="screenshot-1.png" size="418815" author="maffelbaffel" created="Mon, 15 Jun 2020 07:02:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 18 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0fu1s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>