<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:21:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HTTPCLIENT-1767] Null pointer dereference in EofSensorInputStream and ResponseEntityProxy</title>
                <link>https://issues.apache.org/jira/browse/HTTPCLIENT-1767</link>
                <project id="12310360" key="HTTPCLIENT">HttpComponents HttpClient</project>
                    <description>&lt;p&gt;The close implementation in EofSensorInputStream objects which are created from ResponseEntityProxy.getContent signals that it is closed and in &quot;EOF mode&quot; internally when its wrapped InputStream variable changes to null. There are null guards present, but these can fail sporadically even in single-threaded situations, due to the lack of a volatile label on the instance variable and because the instance variable is dereferenced again after the null guard within the method.&lt;/p&gt;

&lt;p&gt;ResponseEntityProxy.streamClosed (which is called back from EofSensorInputStream.checkClose) then operates on its parameter without a null check, causing an NPE to be thrown.&lt;/p&gt;

&lt;p&gt;The resulting stack trace has the following at its top:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.NullPointerException: null
	at org.apache.http.impl.execchain.ResponseEntityProxy.streamClosed(ResponseEntityProxy.java:140)
	at org.apache.http.conn.EofSensorInputStream.checkClose(EofSensorInputStream.java:228)
	at org.apache.http.conn.EofSensorInputStream.close(EofSensorInputStream.java:174)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The EofSensorInputStream class is labelled as @NotThreadSafe, but this issue can be fixed without synchronisation, just by dereferencing to a local variable before the null guard and using that local variable throughout the rest of the method. This will also work without setting the variable to volatile, which may be part of the issue but doesn&apos;t need to be fixed to stop this occurring.&lt;/p&gt;

&lt;p&gt;For context, I am not intentionally trying to access the EofInputStream from multiple threads and this issue is fairly difficult to reproduce but has happened enough to want to report it and propose a fix. The code that is reproducing the issue should have locked down access to the close method using the following pattern which I have never had issues with in the past, but is still managing to trigger this NPE in unusual circumstances:&lt;/p&gt;

&lt;p&gt;At minimum I only really need the close method fixed, as its general contract in java.io.Closeable says that it can be called multiple times without issue, but the same changes could be propagated to other methods if necessary.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;private final AtomicBoolean closed = new AtomicBoolean(false);

....
@Override
public void close() throws IOException {
  // This is the only time closed is accessed or modified
  if(closed.compareAndSet(false, true)) {
    inputStream.close();
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I will open a Pull Request on GitHub with a patch to fix this for the 4.5.x series.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13004461">HTTPCLIENT-1767</key>
            <summary>Null pointer dereference in EofSensorInputStream and ResponseEntityProxy</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="ansell">Peter Ansell</reporter>
                        <labels>
                    </labels>
                <created>Tue, 13 Sep 2016 00:39:14 +0000</created>
                <updated>Tue, 13 Sep 2016 22:58:32 +0000</updated>
                            <resolved>Tue, 13 Sep 2016 18:35:59 +0000</resolved>
                                    <version>4.5.2</version>
                                    <fixVersion>4.5.3</fixVersion>
                    <fixVersion>5.0 Alpha2</fixVersion>
                                    <component>HttpClient (classic)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15485867" author="githubbot" created="Tue, 13 Sep 2016 01:14:32 +0000"  >&lt;p&gt;GitHub user ansell opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/httpclient/pull/61&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpclient/pull/61&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-1767&quot; title=&quot;Null pointer dereference in EofSensorInputStream and ResponseEntityProxy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-1767&quot;&gt;&lt;del&gt;HTTPCLIENT-1767&lt;/del&gt;&lt;/a&gt;: Null pointer dereference in EofSensorInputStream and ResponseEntityProxy&lt;/p&gt;

&lt;p&gt;    This fixes &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-1767&quot; title=&quot;Null pointer dereference in EofSensorInputStream and ResponseEntityProxy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-1767&quot;&gt;&lt;del&gt;HTTPCLIENT-1767&lt;/del&gt;&lt;/a&gt; by adding null checks to ResponseEntityProxy and dereferencing instance variables before null checks in EofSensorInputStream.&lt;/p&gt;

&lt;p&gt;    For reference here, the stacktrace, against httpclient-4.5.2, which I can&apos;t reproduce reliably, but which should be fixed by these changes is:&lt;/p&gt;

&lt;p&gt;    ```&lt;br/&gt;
    java.lang.NullPointerException: null&lt;br/&gt;
    	at org.apache.http.impl.execchain.ResponseEntityProxy.streamClosed(ResponseEntityProxy.java:140)&lt;br/&gt;
    	at org.apache.http.conn.EofSensorInputStream.checkClose(EofSensorInputStream.java:228)&lt;br/&gt;
    	at org.apache.http.conn.EofSensorInputStream.close(EofSensorInputStream.java:174)&lt;br/&gt;
    ```&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/ansell/httpclient&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ansell/httpclient&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-1767&quot; title=&quot;Null pointer dereference in EofSensorInputStream and ResponseEntityProxy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-1767&quot;&gt;&lt;del&gt;HTTPCLIENT-1767&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/httpclient/pull/61.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpclient/pull/61.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #61&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 56b37dfdab78d651f95f7825b1c0f7daa166e8c5&lt;br/&gt;
Author: Peter Ansell &amp;lt;p_ansell@yahoo.com&amp;gt;&lt;br/&gt;
Date:   2016-09-13T01:05:21Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-1767&quot; title=&quot;Null pointer dereference in EofSensorInputStream and ResponseEntityProxy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-1767&quot;&gt;&lt;del&gt;HTTPCLIENT-1767&lt;/del&gt;&lt;/a&gt;: Fix null pointer dereference after guard&lt;/p&gt;

&lt;p&gt;    EofSensorInputStream is generating NullPointerExceptions in some rare situations. This commit fixes that behaviour for the check methods by dereferencing the instance variable to a final local variable to ensure that if it is not null at the null guard, that it will be not null after that point also to successfully close/abort the stream&lt;/p&gt;

&lt;p&gt;    Signed-off-by: Peter Ansell &amp;lt;p_ansell@yahoo.com&amp;gt;&lt;/p&gt;

&lt;p&gt;commit b4a82de6a65fabc1cbbb57988fce046dd87b7e1e&lt;br/&gt;
Author: Peter Ansell &amp;lt;p_ansell@yahoo.com&amp;gt;&lt;br/&gt;
Date:   2016-09-13T01:09:37Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-1767&quot; title=&quot;Null pointer dereference in EofSensorInputStream and ResponseEntityProxy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-1767&quot;&gt;&lt;del&gt;HTTPCLIENT-1767&lt;/del&gt;&lt;/a&gt;: Check parameters for null in ResponseEntityProxy&lt;/p&gt;

&lt;p&gt;    In some rare cases, null parameters are sent to ReponseEntityProxy methods, this adds checks on those to ensure that the connections are still released, but the null variable is not dereferenced.&lt;/p&gt;

&lt;p&gt;    Signed-off-by: Peter Ansell &amp;lt;p_ansell@yahoo.com&amp;gt;&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15488016" author="githubbot" created="Tue, 13 Sep 2016 18:34:29 +0000"  >&lt;p&gt;Github user ok2c commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/httpclient/pull/61&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpclient/pull/61&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Committed to SVN trunk and 4.5.x branch. Please review and close.&lt;/p&gt;</comment>
                            <comment id="15488727" author="githubbot" created="Tue, 13 Sep 2016 22:58:32 +0000"  >&lt;p&gt;Github user ansell closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/httpclient/pull/61&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpclient/pull/61&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15488728" author="githubbot" created="Tue, 13 Sep 2016 22:58:32 +0000"  >&lt;p&gt;Github user ansell commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/httpclient/pull/61&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpclient/pull/61&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for patching this so promptly! The commit you applied looks correct.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 9 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i33jon:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>