<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:22:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HTTPCLIENT-2195] [regression] Logic error in proxy connection error handling in ConnectExec.createTunnelToTarget</title>
                <link>https://issues.apache.org/jira/browse/HTTPCLIENT-2195</link>
                <project id="12310360" key="HTTPCLIENT">HttpComponents HttpClient</project>
                    <description>&lt;p&gt;This moved block seems suspect:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/httpcomponents-client/commit/90d89af98e6cb9e4437d178acf084259607a20c3#diff-81d61e0ba1700fd4dcfb00bf8a8943beec35d825546d1a6b8e35fc5796902656R230&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/commit/90d89af98e6cb9e4437d178acf084259607a20c3#diff-81d61e0ba1700fd4dcfb00bf8a8943beec35d825546d1a6b8e35fc5796902656R230&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It always consumes the response and/or disconnects the connection (code apparently moved from proxy auth challenge retry handling?), but the error handling block below (code != SC_OK) attempts to read the response, triggering a non-informative StreamClosedException. The original, useful error (i.e. the response + code) is lost in the process.&lt;/p&gt;

&lt;p&gt;I&apos;m not clear on what the moved block does, but it seems like the response content should be saved for later use or only conditionally-consumed later (when the response is known to be successful). Maybe instead of moving the block out of proxy-auth-retry, it should be duplicated at the end of the function instead (after error handling)?&lt;/p&gt;

&lt;p&gt;Example stacktrace from a proxy tunneling error:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Caused by: org.apache.hc.core5.http.StreamClosedException: Stream already closed
&#160; &#160; at org.apache.hc.core5.http.impl.io.ContentLengthInputStream.read(ContentLengthInputStream.java:162)
&#160; &#160; at sun.nio.cs.StreamDecoder.readBytes(StreamDecoder.java:284)
&#160; &#160; at sun.nio.cs.StreamDecoder.implRead(StreamDecoder.java:326)
&#160; &#160; at sun.nio.cs.StreamDecoder.read(StreamDecoder.java:178)
&#160; &#160; at java.io.InputStreamReader.read(InputStreamReader.java:181)
&#160; &#160; at java.io.Reader.read(Reader.java:229)
&#160; &#160; at org.apache.hc.core5.http.io.entity.EntityUtils.toCharArrayBuffer(EntityUtils.java:178)
&#160; &#160; at org.apache.hc.core5.http.io.entity.EntityUtils.toString(EntityUtils.java:221)
&#160; &#160; at org.apache.hc.core5.http.io.entity.EntityUtils.toString(EntityUtils.java:361)
&#160; &#160; at org.apache.hc.core5.http.io.entity.EntityUtils.toString(EntityUtils.java:341)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.ConnectExec.createTunnelToTarget(ConnectExec.java:258)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.ConnectExec.execute(ConnectExec.java:145)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.ExecChainElement.execute(ExecChainElement.java:51)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.ExecChainElement$1.proceed(ExecChainElement.java:57)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.ProtocolExec.execute(ProtocolExec.java:175)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.ExecChainElement.execute(ExecChainElement.java:51)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.ExecChainElement$1.proceed(ExecChainElement.java:57)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.RedirectExec.execute(RedirectExec.java:115)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.ExecChainElement.execute(ExecChainElement.java:51)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.InternalHttpClient.doExecute(InternalHttpClient.java:170)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:75)
&#160; &#160; at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:89)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13422061">HTTPCLIENT-2195</key>
            <summary>[regression] Logic error in proxy connection error handling in ConnectExec.createTunnelToTarget</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="henryptung">Henry Tung</reporter>
                        <labels>
                            <label>regresion</label>
                    </labels>
                <created>Tue, 11 Jan 2022 23:21:19 +0000</created>
                <updated>Thu, 13 Jan 2022 14:43:41 +0000</updated>
                            <resolved>Thu, 13 Jan 2022 14:43:41 +0000</resolved>
                                    <version>5.1.2</version>
                                    <fixVersion>5.1.3</fixVersion>
                    <fixVersion>5.2-beta1</fixVersion>
                                    <component>HttpClient (classic)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17473214" author="ckozak" created="Wed, 12 Jan 2022 00:05:57 +0000"  >&lt;p&gt;Any chance you can provide a reproducer? Thanks!&lt;/p&gt;</comment>
                            <comment id="17474353" author="henryptung" created="Wed, 12 Jan 2022 08:19:28 +0000"  >&lt;p&gt;Here are some examples of different success and failure modes with this code, using a local ConnectHandler to handle HTTPS tunneling:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/henryptung/httpclient-2195&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/henryptung/httpclient-2195&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;If the response is empty/zero-length, an EmptyInputStream is used and TunnelRefusedException is thrown (as expected)&lt;/li&gt;
	&lt;li&gt;If the response body is short enough (to fit in initial fetch buffer) and Connection: close is supplied, TunnelRefusedException is thrown (as expected, with response body attached)&lt;/li&gt;
	&lt;li&gt;All other cases:
	&lt;ul&gt;
		&lt;li&gt;If Connection: close is supplied, a SocketException is thrown&lt;/li&gt;
		&lt;li&gt;If Connection: close is not supplied, a StreamClosedException is thrown&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17474397" author="olegk" created="Wed, 12 Jan 2022 09:41:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=henryptung&quot; class=&quot;user-hover&quot; rel=&quot;henryptung&quot;&gt;henryptung&lt;/a&gt; It looks like I f**ed it up. I am looking into it.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17474415" author="jira-bot" created="Wed, 12 Jan 2022 10:03:40 +0000"  >&lt;p&gt;Commit 7ce11963849228b0c9e5f7d9f04aa11528a460c9 in httpcomponents-client&apos;s branch refs/heads/&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2195&quot; title=&quot;[regression] Logic error in proxy connection error handling in ConnectExec.createTunnelToTarget&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2195&quot;&gt;&lt;del&gt;HTTPCLIENT-2195&lt;/del&gt;&lt;/a&gt; from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=7ce1196&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=7ce1196&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2195&quot; title=&quot;[regression] Logic error in proxy connection error handling in ConnectExec.createTunnelToTarget&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2195&quot;&gt;&lt;del&gt;HTTPCLIENT-2195&lt;/del&gt;&lt;/a&gt;, regression: classic ConnectExec incorrectly discards the proxy response body even if the request cannot be executed and the response is final&lt;/p&gt;</comment>
                            <comment id="17474416" author="olegk" created="Wed, 12 Jan 2022 10:04:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=henryptung&quot; class=&quot;user-hover&quot; rel=&quot;henryptung&quot;&gt;henryptung&lt;/a&gt; The change reverted. Please re-test:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/httpcomponents-client/tree/HTTPCLIENT-2195&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/tree/HTTPCLIENT-2195&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17474966" author="henryptung" created="Wed, 12 Jan 2022 21:22:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt; Confirmed that all the bad-hostname cases throw TunnelRefusedException (as expected) now, using the linked branch.&lt;/p&gt;</comment>
                            <comment id="17475401" author="jira-bot" created="Thu, 13 Jan 2022 14:37:06 +0000"  >&lt;p&gt;Commit b4b84291295a1d93129c3f4da2f84adb9a193057 in httpcomponents-client&apos;s branch refs/heads/5.1.x from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=b4b8429&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=b4b8429&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2195&quot; title=&quot;[regression] Logic error in proxy connection error handling in ConnectExec.createTunnelToTarget&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2195&quot;&gt;&lt;del&gt;HTTPCLIENT-2195&lt;/del&gt;&lt;/a&gt;, regression: classic ConnectExec incorrectly discards the proxy response body even if the request cannot be executed and the response is final&lt;/p&gt;</comment>
                            <comment id="17475407" author="jira-bot" created="Thu, 13 Jan 2022 14:42:41 +0000"  >&lt;p&gt;Commit 3ee994b25c9974f9de16c71506b15ea1991febf5 in httpcomponents-client&apos;s branch refs/heads/master from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=3ee994b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=3ee994b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2195&quot; title=&quot;[regression] Logic error in proxy connection error handling in ConnectExec.createTunnelToTarget&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2195&quot;&gt;&lt;del&gt;HTTPCLIENT-2195&lt;/del&gt;&lt;/a&gt;, regression: classic ConnectExec incorrectly discards the proxy response body even if the request cannot be executed and the response is final&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 43 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0yhdc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>