<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:22:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HTTPCLIENT-2200] Protocol interceptors are executed before the connection route has been fully established</title>
                <link>https://issues.apache.org/jira/browse/HTTPCLIENT-2200</link>
                <project id="12310360" key="HTTPCLIENT">HttpComponents HttpClient</project>
                    <description>&lt;p&gt;Currently, a user is able to add HttpRequestInterceptor when building a new client using HttpAsyncClientBuilder. However, when executing a request, these interceptors are called at point when the final application protocol has not been established yet. The protocol returned by httpcontext is always http/1.1, the protocol of the initial CONNECT request. Since the interceptors do not have access to the final protocol, then the user must commit to an application protocol pre-emptively when constructing their request in terms of header capitalization, including the Host/Connection header or not, how cookies are appended, etc. This is clearly problematic since it cannot be known pre-emptively what protocol the server on the other end will end up choosing when a connection is established. &lt;/p&gt;

&lt;p&gt;On line 925 of HttpAsyncClientBuilder, I can see that a DefaultHttpProcessor is provided to the IOEventHandlerFactory, which contains HttpRequestInterceptors that DO have access to the final application protocol information, because they are called at a later point in time when this information has been fully established. I see that if the protocol was assumed by the user to be H2, but the final connection ends up using 1.1, then a Host and Connection header are added to the request if they are missing. However, the opposite is not provided. That is, if the protocol is assumed to be 1.1 and the Host / Connection headers are included by the user, but the connection upgrades to H2, it results in an illegal request due to invalid headers.&lt;/p&gt;

&lt;p&gt;To solve this issue, it would be nice if a user was able to add additional interceptors to the DefaultHttpProcessor on line 925, so that they too are able to have access to protocol information and potentially augment their request where needed.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/httpcomponents-client/blob/master/httpclient5/src/main/java/org/apache/hc/client5/http/impl/async/HttpAsyncClientBuilder.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-client/blob/master/httpclient5/src/main/java/org/apache/hc/client5/http/impl/async/HttpAsyncClientBuilder.java&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13424784">HTTPCLIENT-2200</key>
            <summary>Protocol interceptors are executed before the connection route has been fully established</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="avasilev">Andrei Vasilev</reporter>
                        <labels>
                    </labels>
                <created>Tue, 25 Jan 2022 22:08:51 +0000</created>
                <updated>Thu, 17 Mar 2022 16:46:58 +0000</updated>
                            <resolved>Thu, 17 Mar 2022 16:46:58 +0000</resolved>
                                    <version>5.1.2</version>
                    <version>5.2-alpha1</version>
                                    <fixVersion>5.2-beta1</fixVersion>
                                    <component>HttpClient (async)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17482610" author="olegk" created="Wed, 26 Jan 2022 16:33:59 +0000"  >&lt;p&gt;&amp;gt; However, when executing a request, these interceptors are called at point when the application protocol has not been established yet.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=avasilev&quot; class=&quot;user-hover&quot; rel=&quot;avasilev&quot;&gt;avasilev&lt;/a&gt; This actually looks like a defect. The protocol interceptors should be able to find out the actual protocol version by querying their HttpContext#protocolVersion.&#160;&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17482721" author="avasilev" created="Wed, 26 Jan 2022 20:08:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt; &lt;br/&gt;
&amp;gt; However, when executing a request, these interceptors are called at point when the application protocol has not been established yet.&lt;/p&gt;

&lt;p&gt;Sorry, I should have clarified that I meant the FINAL protocol hasn&apos;t been established yet. The protocol version is available from HttpContext, but it seems that the interceptors are always called prior to the connection ever being upgraded to h2 if it does end up being upgraded. So the protocol returned is always http/1.1, just the protocol of the initial CONNECT request.&lt;/p&gt;</comment>
                            <comment id="17482761" author="olegk" created="Wed, 26 Jan 2022 22:19:10 +0000"  >&lt;p&gt;&amp;gt; The protocol version is available from HttpContext, but it seems that the interceptors are always called prior to the connection ever being upgraded to h2 if it does end up being upgraded&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=avasilev&quot; class=&quot;user-hover&quot; rel=&quot;avasilev&quot;&gt;avasilev&lt;/a&gt; This is wrong. I intend to fix that.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17484315" author="olegk" created="Sun, 30 Jan 2022 09:08:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=avasilev&quot; class=&quot;user-hover&quot; rel=&quot;avasilev&quot;&gt;avasilev&lt;/a&gt;&#160;This issue turned out to be much more complex that I had initially anticipated. Please bear with me. I am not entirely happy with the way the connection negotiation logic works at present and am looking into redesigning it. This may take time.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17486012" author="olegk" created="Wed, 2 Feb 2022 18:30:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=avasilev&quot; class=&quot;user-hover&quot; rel=&quot;avasilev&quot;&gt;avasilev&lt;/a&gt; I had to make some fairly substantial changes to the core protocol handlers in order to fix the problem &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;. Do feel free to review / test them. The proposed fix itself can be found here in my private fork &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;. I am going to merge it as soon as the next version of HttpCore has been released.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/httpcomponents-core/commit/8561cbd45335cd373844cdae42fccc725ad41111&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-core/commit/8561cbd45335cd373844cdae42fccc725ad41111&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/ok2c/httpcomponents-client/tree/HTTPCLIENT-2200&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ok2c/httpcomponents-client/tree/HTTPCLIENT-2200&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17488457" author="avasilev" created="Mon, 7 Feb 2022 22:32:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt; Sounds good. I will try to test the changes out this week. Thanks for all the effort. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17508285" author="jira-bot" created="Thu, 17 Mar 2022 16:46:04 +0000"  >&lt;p&gt;Commit f00ce5da9ef8b0de42717e62ccdbf30765e25af3 in httpcomponents-client&apos;s branch refs/heads/master from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=f00ce5d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-client.git;h=f00ce5d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-2200&quot; title=&quot;Protocol interceptors are executed before the connection route has been fully established&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCLIENT-2200&quot;&gt;&lt;del&gt;HTTPCLIENT-2200&lt;/del&gt;&lt;/a&gt;: Protocol interceptors are executed before the connection route has been fully established&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 34 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0yy4o:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>