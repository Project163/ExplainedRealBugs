{"url":"https://api.github.com/repos/pydantic/pydantic/issues/3807","repository_url":"https://api.github.com/repos/pydantic/pydantic","labels_url":"https://api.github.com/repos/pydantic/pydantic/issues/3807/labels{/name}","comments_url":"https://api.github.com/repos/pydantic/pydantic/issues/3807/comments","events_url":"https://api.github.com/repos/pydantic/pydantic/issues/3807/events","html_url":"https://github.com/pydantic/pydantic/issues/3807","id":1132305649,"node_id":"I_kwDOBWBCuM5DfZzx","number":3807,"title":"Unexpected behaviour if the prefix contains the env_nested_delimiter","user":{"login":"josebama","id":2027580,"node_id":"MDQ6VXNlcjIwMjc1ODA=","avatar_url":"https://avatars.githubusercontent.com/u/2027580?v=4","gravatar_id":"","url":"https://api.github.com/users/josebama","html_url":"https://github.com/josebama","followers_url":"https://api.github.com/users/josebama/followers","following_url":"https://api.github.com/users/josebama/following{/other_user}","gists_url":"https://api.github.com/users/josebama/gists{/gist_id}","starred_url":"https://api.github.com/users/josebama/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/josebama/subscriptions","organizations_url":"https://api.github.com/users/josebama/orgs","repos_url":"https://api.github.com/users/josebama/repos","events_url":"https://api.github.com/users/josebama/events{/privacy}","received_events_url":"https://api.github.com/users/josebama/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":597426502,"node_id":"MDU6TGFiZWw1OTc0MjY1MDI=","url":"https://api.github.com/repos/pydantic/pydantic/labels/bug%20V1","name":"bug V1","color":"ee0701","default":false,"description":"Bug related to Pydantic V1.X"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-02-11T10:31:52Z","updated_at":"2022-08-11T10:35:05Z","closed_at":"2022-08-11T10:35:05Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Checks\r\n\r\n* [x] I added a descriptive title to this issue\r\n* [x] I have searched (google, github) for similar issues and couldn't find anything\r\n* [x] I have read and followed [the docs](https://pydantic-docs.helpmanual.io/) and still think this is a bug\r\n\r\n<!-- Sorry to sound so draconian, but every second saved replying to issues is time spend improving pydantic :-) -->\r\n\r\n# Bug\r\n\r\nOutput of `python -c \"import pydantic.utils; print(pydantic.utils.version_info())\"`:\r\n```\r\n$ python -c \"import pydantic.utils; print(pydantic.utils.version_info())\"\r\n             pydantic version: 1.9.0\r\n            pydantic compiled: True\r\n                 install path: /usr/local/lib/python3.8/site-packages/pydantic\r\n               python version: 3.8.12 (default, Oct 12 2021, 03:05:25)  [GCC 10.2.1 20210110]\r\n                     platform: Linux-5.13.0-28-generic-x86_64-with-glibc2.2.5\r\n     optional deps. installed: ['dotenv', 'typing-extensions']\r\n```\r\n<!-- or if you're using pydantic prior to v1.3, manually include: OS, python version and pydantic version -->\r\n\r\n<!-- Please read the [docs](https://pydantic-docs.helpmanual.io/) and search through issues to\r\nconfirm your bug hasn't already been reported. -->\r\n\r\n<!-- Where possible please include a self-contained code snippet describing your bug: -->\r\n\r\n```py\r\nimport os\r\nimport pydantic\r\nimport pytest\r\n\r\n\r\n@pytest.fixture\r\ndef env():\r\n    original_env = os.environ.copy()\r\n    yield os.environ\r\n    os.environ.clear()\r\n    os.environ.update(original_env)\r\n\r\n\r\ndef test_env_nested_delimiter_in_prefix(env):\r\n    \"\"\"Test pydantic fails to set value where the prefix has the delimiter.\r\n\r\n    Pydantic will break down `settings_sub_value` to\r\n    `{sub: {value: ...}}` and it will pass it to `settings.sub`, so it will fail to\r\n    populate `settings.sub.value` and it will try to set `settings.sub.sub`.\r\n    \"\"\"\r\n\r\n    class SubSettings(pydantic.BaseSettings):\r\n        value: str\r\n\r\n    class Settings(pydantic.BaseSettings):\r\n        sub: SubSettings\r\n\r\n        class Config:\r\n            env_prefix = \"settings_\"\r\n            env_nested_delimiter = \"_\"\r\n\r\n    env[\"settings_sub_value\"] = \"won't be set\"\r\n\r\n    expected_error = (\r\n        # settings.sub.value doesn't get set\r\n        r\".*sub -> value.*\\n?.*value_error\\.missing.*\\n?\"\r\n        # Tries to assign settings.sub.sub\r\n        r\".*sub -> sub.*\\n?.*value_error\\.extra\"\r\n    )\r\n\r\n    with pytest.raises(pydantic.ValidationError, match=expected_error):\r\n        Settings()\r\n\r\n\r\ndef test_env_nested_delimiter_in_field(env):\r\n    \"\"\"Test pydantic fails to set value where the field has the delimiter.\r\n\r\n    Pydantic will break down `with_delimiter_value` to\r\n    `{delimiter: {value: ...}}` and it will pass it to `settings.with_delimiter`,\r\n    so it will fail to populate `settings.with_delimiter.value` and it will try \r\n    to set `settings.with_delimiter.delimiter`.\r\n    \"\"\"\r\n\r\n    class SubSettings(pydantic.BaseSettings):\r\n        value: str\r\n\r\n    class Settings(pydantic.BaseSettings):\r\n        with_delimiter: SubSettings\r\n\r\n        class Config:\r\n            env_nested_delimiter = \"_\"\r\n\r\n    env[\"with_delimiter_value\"] = \"won't be set\"\r\n\r\n    expected_error = (\r\n        # settings.with_delimiter.value doesn't get set\r\n        r\".*with_delimiter -> value.*\\n?.*value_error\\.missing.*\\n?\"\r\n        # Tries to set settings.with_delimiter.delimiter\r\n        r\".*with_delimiter -> delimiter.*\\n?.*value_error\\.extra\"\r\n    )\r\n\r\n    with pytest.raises(pydantic.ValidationError, match=expected_error):\r\n        Settings()\r\n```\r\nIn my opinion this behaviour is wrong. Pydantic should either support this or raise an error that the class is wrongly configured. But the way it behaves right now is confusing since there's no error of wrong class setup, but the fields don't get set as expected from the environment variables.\r\n\r\nHere's a possible solution on adding support for allowing to have the delimiter in both in the prefix and in the field name:\r\n\r\n```py\r\nclass PrefixFixedEnvSettingsSource(EnvSettingsSource):\r\n    def explode_env_vars(\r\n        self, field: ModelField, env_vars: Mapping[str, Optional[str]]\r\n    ) -> Dict[str, Any]:\r\n        \"\"\"\r\n        Fix original explode_env_vars which splits the prefix with\r\n        env_nested_delimiter. This implemetation doesn't split the prefix.\r\n        \"\"\"\r\n        prefixes = [\r\n            f\"{env_name}{self.env_nested_delimiter}\"\r\n            for env_name in field.field_info.extra[\"env_names\"]\r\n        ]\r\n        result: Dict[str, Any] = {}\r\n        for env_name, env_val in env_vars.items():\r\n            matching_prefixes = [\r\n                prefix for prefix in prefixes if env_name.startswith(prefix)\r\n            ]\r\n            if not matching_prefixes:\r\n                continue\r\n            longest_prefix = max(len(prefix) for prefix in matching_prefixes)\r\n            *keys, last_key = env_name[longest_prefix:].split(self.env_nested_delimiter)\r\n            env_var = result\r\n            for key in keys:\r\n                env_var = env_var.setdefault(key, {})\r\n            env_var[last_key] = env_val\r\n\r\n        return result\r\n```","closed_by":{"login":"samuelcolvin","id":4039449,"node_id":"MDQ6VXNlcjQwMzk0NDk=","avatar_url":"https://avatars.githubusercontent.com/u/4039449?v=4","gravatar_id":"","url":"https://api.github.com/users/samuelcolvin","html_url":"https://github.com/samuelcolvin","followers_url":"https://api.github.com/users/samuelcolvin/followers","following_url":"https://api.github.com/users/samuelcolvin/following{/other_user}","gists_url":"https://api.github.com/users/samuelcolvin/gists{/gist_id}","starred_url":"https://api.github.com/users/samuelcolvin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/samuelcolvin/subscriptions","organizations_url":"https://api.github.com/users/samuelcolvin/orgs","repos_url":"https://api.github.com/users/samuelcolvin/repos","events_url":"https://api.github.com/users/samuelcolvin/events{/privacy}","received_events_url":"https://api.github.com/users/samuelcolvin/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pydantic/pydantic/issues/3807/reactions","total_count":4,"+1":4,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pydantic/pydantic/issues/3807/timeline","performed_via_github_app":null,"state_reason":"completed"}