{"url":"https://api.github.com/repos/pydantic/pydantic/issues/3583","repository_url":"https://api.github.com/repos/pydantic/pydantic","labels_url":"https://api.github.com/repos/pydantic/pydantic/issues/3583/labels{/name}","comments_url":"https://api.github.com/repos/pydantic/pydantic/issues/3583/comments","events_url":"https://api.github.com/repos/pydantic/pydantic/issues/3583/events","html_url":"https://github.com/pydantic/pydantic/issues/3583","id":1088941536,"node_id":"I_kwDOBWBCuM5A5-3g","number":3583,"title":"V1.9 Name Collisions JSON model_as_dict","user":{"login":"zrothberg","id":13908315,"node_id":"MDQ6VXNlcjEzOTA4MzE1","avatar_url":"https://avatars.githubusercontent.com/u/13908315?v=4","gravatar_id":"","url":"https://api.github.com/users/zrothberg","html_url":"https://github.com/zrothberg","followers_url":"https://api.github.com/users/zrothberg/followers","following_url":"https://api.github.com/users/zrothberg/following{/other_user}","gists_url":"https://api.github.com/users/zrothberg/gists{/gist_id}","starred_url":"https://api.github.com/users/zrothberg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zrothberg/subscriptions","organizations_url":"https://api.github.com/users/zrothberg/orgs","repos_url":"https://api.github.com/users/zrothberg/repos","events_url":"https://api.github.com/users/zrothberg/events{/privacy}","received_events_url":"https://api.github.com/users/zrothberg/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":597426502,"node_id":"MDU6TGFiZWw1OTc0MjY1MDI=","url":"https://api.github.com/repos/pydantic/pydantic/labels/bug%20V1","name":"bug V1","color":"ee0701","default":false,"description":"Bug related to Pydantic V1.X"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2021-12-27T03:59:50Z","updated_at":"2021-12-31T14:44:09Z","closed_at":"2021-12-31T14:44:09Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Checks\r\n\r\n* [ ] I added a descriptive title to this issue\r\n* [ ] I have searched (google, github) for similar issues and couldn't find anything\r\n* [ ] I have read and followed [the docs](https://pydantic-docs.helpmanual.io/) and still think this is a bug\r\n\r\n<!-- Sorry to sound so draconian, but every second saved replying to issues is time spend improving pydantic :-) -->\r\n\r\n# Bug\r\n\r\nIn 1.9 Code changed in this merge #2650 The \"models_as_dict\" option for json has collision issues when the class names are the same but in multiple files. This is because of the change to __name__ in custom_pydantic_encoder. In the following code this will result in an error as DBUser.User does not have the field Address. If we force the encoder to be defined after the class this issue does not happen. The other option would be modification of update_forward_refs but that seems a lot worse. \r\n\r\nOutput of `python -c \"import pydantic.utils; print(pydantic.utils.version_info())\"`:\r\n```\r\n  pydantic version: 1.9.0a2\r\n  pydantic compiled: True\r\n  install path: /PycharmProjects/pythonProject/venv/lib/python3.8/site-packages/pydantic\r\n  python version: 3.8.9 (default, Oct 26 2021, 07:25:53)  [Clang 13.0.0 (clang-1300.0.29.30)]\r\n \r\n Tried it in 3.10 as well. \r\n ```\r\n<!-- or if you're using pydantic prior to v1.3, manually include: OS, python version and pydantic version -->\r\n\r\n<!-- Please read the [docs](https://pydantic-docs.helpmanual.io/) and search through issues to\r\nconfirm your bug hasn't already been reported. -->\r\n\r\n<!-- Where possible please include a self-contained code snippet describing your bug: -->\r\n\r\n```py\r\n##DBusers.py\r\nfrom pydantic import BaseModel\r\nfrom uuid import UUID\r\n\r\nclass User(BaseModel):\r\n    name: str\r\n    user_id: UUID\r\n\r\n\r\n```\r\n\r\n\r\n```py\r\n##this one throws Exception\r\nfrom typing import List, Optional\r\n\r\nfrom pydantic import BaseModel\r\nfrom DBUser import User as DBUser\r\nfrom uuid import uuid4\r\n\r\nclass Address(BaseModel):\r\n    city: str\r\n    country: str\r\n\r\n\r\nclass User(BaseModel):\r\n    name: str\r\n    address: Address\r\n    friends: Optional[List['User']] = None\r\n    connections: Optional[List[DBUser]]=None\r\n\r\n    class Config:\r\n        json_encoders = {\r\n            Address: lambda a: f'{a.city} ({a.country})',\r\n            \"User\": lambda u: f'{u.name} in {u.address.city} '\r\n                              f'({u.address.country[:2].upper()})',\r\n        }\r\n\r\n\r\nUser.update_forward_refs()\r\n\r\nwolfgang = User(\r\n    name='Wolfgang',\r\n    address=Address(city='Berlin', country='Deutschland'),\r\n    friends=[\r\n        User(name='Pierre', address=Address(city='Paris', country='France')),\r\n        User(name='John', address=Address(city='London', country='UK')),\r\n    ],\r\n    connections=[\r\n        DBUser(name=\"joe\",user_id=uuid4()),\r\n        DBUser(name=\"Jeff\", user_id=uuid4()),\r\n    ]\r\n)\r\nwolfgang.json(indent=2,models_as_dict=False) ##Raises AttributeError: 'User' object has no attribute 'address'\r\n\r\n\r\n```\r\n\r\n```py\r\n##this one does not throw Exception\r\n\r\nfrom typing import List, Optional\r\nfrom pydantic import BaseModel\r\nfrom DBUser import User as DBUser\r\nfrom uuid import uuid4\r\n\r\nclass Address(BaseModel):\r\n    city: str\r\n    country: str\r\n\r\n\r\nclass User(BaseModel):\r\n    name: str\r\n    address: Address\r\n    friends: Optional[List[\"User\"]] = None\r\n    connections: Optional[List[DBUser]]=None\r\n\r\n    class Config:\r\n        json_encoders = {\r\n            Address: lambda a: f'{a.city} ({a.country})',\r\n        }\r\n\r\n\r\nUser.update_forward_refs()\r\n\r\nUser.Config.json_encoders[User] =lambda u: f'{u.name} in {u.address.city} ' f'({u.address.country[:2].upper()})'\r\n\r\n\r\nwolfgang = User(\r\n    name='Wolfgang',\r\n    address=Address(city='Berlin', country='Deutschland'),\r\n    friends=[\r\n        User(name='Pierre', address=Address(city='Paris', country='France')),\r\n        User(name='John', address=Address(city='London', country='UK')),\r\n    ],\r\n    connections=[\r\n        DBUser(name=\"joe\",user_id=uuid4()),\r\n        DBUser(name=\"Jeff\", user_id=uuid4()),\r\n    ]\r\n)\r\nprint(wolfgang.json(indent=2,models_as_dict=False)) ##Does not explode\r\n\r\n\r\n```\r\n","closed_by":{"login":"samuelcolvin","id":4039449,"node_id":"MDQ6VXNlcjQwMzk0NDk=","avatar_url":"https://avatars.githubusercontent.com/u/4039449?v=4","gravatar_id":"","url":"https://api.github.com/users/samuelcolvin","html_url":"https://github.com/samuelcolvin","followers_url":"https://api.github.com/users/samuelcolvin/followers","following_url":"https://api.github.com/users/samuelcolvin/following{/other_user}","gists_url":"https://api.github.com/users/samuelcolvin/gists{/gist_id}","starred_url":"https://api.github.com/users/samuelcolvin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/samuelcolvin/subscriptions","organizations_url":"https://api.github.com/users/samuelcolvin/orgs","repos_url":"https://api.github.com/users/samuelcolvin/repos","events_url":"https://api.github.com/users/samuelcolvin/events{/privacy}","received_events_url":"https://api.github.com/users/samuelcolvin/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pydantic/pydantic/issues/3583/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pydantic/pydantic/issues/3583/timeline","performed_via_github_app":null,"state_reason":"completed"}