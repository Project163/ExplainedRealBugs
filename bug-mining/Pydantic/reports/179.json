{"url":"https://api.github.com/repos/pydantic/pydantic/issues/1458","repository_url":"https://api.github.com/repos/pydantic/pydantic","labels_url":"https://api.github.com/repos/pydantic/pydantic/issues/1458/labels{/name}","comments_url":"https://api.github.com/repos/pydantic/pydantic/issues/1458/comments","events_url":"https://api.github.com/repos/pydantic/pydantic/issues/1458/events","html_url":"https://github.com/pydantic/pydantic/issues/1458","id":609448148,"node_id":"MDU6SXNzdWU2MDk0NDgxNDg=","number":1458,"title":"Settings: Custom parsing of environment variables (non-JSON)","user":{"login":"pjbull","id":1799186,"node_id":"MDQ6VXNlcjE3OTkxODY=","avatar_url":"https://avatars.githubusercontent.com/u/1799186?v=4","gravatar_id":"","url":"https://api.github.com/users/pjbull","html_url":"https://github.com/pjbull","followers_url":"https://api.github.com/users/pjbull/followers","following_url":"https://api.github.com/users/pjbull/following{/other_user}","gists_url":"https://api.github.com/users/pjbull/gists{/gist_id}","starred_url":"https://api.github.com/users/pjbull/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pjbull/subscriptions","organizations_url":"https://api.github.com/users/pjbull/orgs","repos_url":"https://api.github.com/users/pjbull/repos","events_url":"https://api.github.com/users/pjbull/events{/privacy}","received_events_url":"https://api.github.com/users/pjbull/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":597426504,"node_id":"MDU6TGFiZWw1OTc0MjY1MDQ=","url":"https://api.github.com/repos/pydantic/pydantic/labels/feature%20request","name":"feature request","color":"84b6eb","default":false,"description":""},{"id":597426505,"node_id":"MDU6TGFiZWw1OTc0MjY1MDU=","url":"https://api.github.com/repos/pydantic/pydantic/labels/help%20wanted","name":"help wanted","color":"128A0C","default":true,"description":"Pull Request welcome"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":15,"created_at":"2020-04-29T23:58:02Z","updated_at":"2025-02-03T07:56:34Z","closed_at":"2022-08-22T16:06:15Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"# Settings: Custom parsing of environment variables (non-JSON)\r\n\r\nOften we want complex environment variables that are not represented as JSON. One example is a list of items. It's not uncommon to comma-delimit lists like this in bash:\r\n\r\n```python\r\nimport os\r\nfrom typing import List\r\n\r\nfrom pydantic import BaseSettings\r\n\r\nos.environ['options'] = \"a,b,c\"\r\n\r\nclass Settings(BaseSettings):\r\n    options: List\r\n\r\ns = Settings()\r\n```\r\n\r\nThis results in a `JSONDecodeError`. Writing a list of items as valid json is error prone and not human friendly to read in the context of environment variables.\r\n\r\n### Workaround\r\n\r\nOne workaround is to store the variable as valid json, which is tricky to type correctly in lots of systems where you have to enter environment variables:\r\n\r\n```\r\nOPTIONS='[\"a\",\"b\",\"c\"]'\r\n```\r\n\r\nAnother (simplified) workaround is to set `json_loads`. but its not very elegant since `json_loads` doesn't know what field its is parsing, which could be error prone:\r\n\r\n```python\r\nimport json\r\nimport os\r\nfrom typing import List\r\n\r\nfrom pydantic import BaseSettings, BaseModel, root_validator\r\n\r\nos.environ['options'] = \"a,b,c\"\r\n    \r\ndef list_parse_fallback(v):\r\n    try:\r\n        return json.loads(v)\r\n    except Exception as e:\r\n        return v.split(\",\")\r\n\r\nclass Settings(BaseSettings):\r\n    options: List\r\n        \r\n    class Config:\r\n        json_loads = list_parse_fallback\r\n       \r\ns = Settings()\r\n```\r\n\r\nI can see a couple options for implementing the fix:\r\n\r\n### 1. Store the parsing method in the field info extra:\r\n\r\n```python\r\nparse_func = lambda x: x.split(\",\")\r\n\r\nclass Settings(BaseSettings):\r\n    options: List = Field(..., env_parse=parse_func)\r\n```\r\n\r\nIf we take this approach, I think that we can update this logic branch:\r\nhttps://github.com/samuelcolvin/pydantic/blob/42395056e18dfaa3ef299373374ab3b12bb196ac/pydantic/env_settings.py#L170-L174\r\n\r\nAdding something like the following:\r\n\r\n```python\r\nif field.is_complex():\r\n    if field.extra.get(\"env_parse\", None) is not None:\r\n        try:\r\n            env_val = field.extra[\"env_parse\"](env_val)  # type: ignore\r\n        except ValueError as e:\r\n            raise SettingsError(f'error with custom parsing function for \"{env_name}\"') from e\r\n    else:\r\n        try:\r\n            env_val = self.__config__.json_loads(env_val)  # type: ignore\r\n        except ValueError as e:\r\n            raise SettingsError(f'error parsing JSON for \"{env_name}\"') from e\r\nd[field.alias] = env_val\r\n```\r\n\r\n### 2. Add a new config option just for Settings for overriding how env vars are parsed\r\nAnother implementation option is to add a new property like `Settings.Config.parse_env_var` which takes the `field` and the value so that it can be overridden to handle dispatching to different parsing methods for different names/properties of `field` (currently, just overriding `json_loads` means you are passed a value without knowing where it will be stored so you have to test for and handle all of the possible settings values.\r\n\r\n```python\r\nclass BaseSettings:\r\n    ...\r\n    class Config:\r\n         ...\r\n        @classmethod\r\n        def parse_env_var(cls, field, raw_val):\r\n            return cls.json_loads(raw_val)\r\n```\r\n\r\nThen the following line is the only change that is needed:\r\nhttps://github.com/samuelcolvin/pydantic/blob/master/pydantic/env_settings.py#L62\r\n\r\nChanges to `self.__config__.parse_env_var(field, env_val)`\r\n\r\n\r\n### 3. Call field validators on the raw string instead of trying to load from json first\r\n\r\nChange the same line to:\r\n```\r\nenv_val, ee = field.validate(env_val)\r\n\r\n# collect ee and raise errors\r\n```\r\n\r\nPros:\r\n - Adding validators for fields is well documented / understood\r\n\r\nCons:\r\n - Breaks existing JSON functionality if those fields already have validators\r\n - Mixes up the abstractions in that the functions would now do parsing and validation\r\n\r\n### 4. Custom (de)serialization\r\n\r\nLet fields implement custom serialization/deserialization methods. Currently there is `json_encoders` but not an equivalent `json_decoders` for use per-field.\r\n\r\nThere's some discussion of this here: https://github.com/samuelcolvin/pydantic/issues/951\r\n\r\n### 5. Something else\r\n\r\nOther ideas? Happy to implement a different suggestion.\r\n\r\n--------------\r\n\r\nOutput of `python -c \"import pydantic.utils; print(pydantic.utils.version_info())\"`:\r\n```\r\n             pydantic version: 1.5.1\r\n            pydantic compiled: True\r\n                 install path: /Users/bull/miniconda3/envs/sandbox/lib/python3.7/site-packages/pydantic\r\n               python version: 3.7.6 (default, Jan  8 2020, 13:42:34)  [Clang 4.0.1 (tags/RELEASE_401/final)]\r\n                     platform: Darwin-19.4.0-x86_64-i386-64bit\r\n     optional deps. installed: []\r\n\r\n```\r\n\r\n","closed_by":{"login":"samuelcolvin","id":4039449,"node_id":"MDQ6VXNlcjQwMzk0NDk=","avatar_url":"https://avatars.githubusercontent.com/u/4039449?v=4","gravatar_id":"","url":"https://api.github.com/users/samuelcolvin","html_url":"https://github.com/samuelcolvin","followers_url":"https://api.github.com/users/samuelcolvin/followers","following_url":"https://api.github.com/users/samuelcolvin/following{/other_user}","gists_url":"https://api.github.com/users/samuelcolvin/gists{/gist_id}","starred_url":"https://api.github.com/users/samuelcolvin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/samuelcolvin/subscriptions","organizations_url":"https://api.github.com/users/samuelcolvin/orgs","repos_url":"https://api.github.com/users/samuelcolvin/repos","events_url":"https://api.github.com/users/samuelcolvin/events{/privacy}","received_events_url":"https://api.github.com/users/samuelcolvin/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pydantic/pydantic/issues/1458/reactions","total_count":40,"+1":40,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pydantic/pydantic/issues/1458/timeline","performed_via_github_app":null,"state_reason":"completed"}