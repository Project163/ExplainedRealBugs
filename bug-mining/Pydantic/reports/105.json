{"url":"https://api.github.com/repos/pydantic/pydantic/issues/1410","repository_url":"https://api.github.com/repos/pydantic/pydantic","labels_url":"https://api.github.com/repos/pydantic/pydantic/issues/1410/labels{/name}","comments_url":"https://api.github.com/repos/pydantic/pydantic/issues/1410/comments","events_url":"https://api.github.com/repos/pydantic/pydantic/issues/1410/events","html_url":"https://github.com/pydantic/pydantic/issues/1410","id":604007498,"node_id":"MDU6SXNzdWU2MDQwMDc0OTg=","number":1410,"title":"Const validation applied before type validation/parsing","user":{"login":"selimb","id":6503002,"node_id":"MDQ6VXNlcjY1MDMwMDI=","avatar_url":"https://avatars.githubusercontent.com/u/6503002?v=4","gravatar_id":"","url":"https://api.github.com/users/selimb","html_url":"https://github.com/selimb","followers_url":"https://api.github.com/users/selimb/followers","following_url":"https://api.github.com/users/selimb/following{/other_user}","gists_url":"https://api.github.com/users/selimb/gists{/gist_id}","starred_url":"https://api.github.com/users/selimb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/selimb/subscriptions","organizations_url":"https://api.github.com/users/selimb/orgs","repos_url":"https://api.github.com/users/selimb/repos","events_url":"https://api.github.com/users/selimb/events{/privacy}","received_events_url":"https://api.github.com/users/selimb/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":597426502,"node_id":"MDU6TGFiZWw1OTc0MjY1MDI=","url":"https://api.github.com/repos/pydantic/pydantic/labels/bug%20V1","name":"bug V1","color":"ee0701","default":false,"description":"Bug related to Pydantic V1.X"},{"id":597426507,"node_id":"MDU6TGFiZWw1OTc0MjY1MDc=","url":"https://api.github.com/repos/pydantic/pydantic/labels/question","name":"question","color":"cc317c","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2020-04-21T13:40:25Z","updated_at":"2020-04-30T18:05:43Z","closed_at":"2020-04-30T18:05:43Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"# Question\r\n\r\nOutput of `python -c \"import pydantic.utils; print(pydantic.utils.version_info())\"`:\r\n```\r\n             pydantic version: 1.5\r\n            pydantic compiled: False\r\n                 install path: D:\\dev\\github\\pydantic\\issues\\.venv\\Lib\\site-packages\\pydantic\r\n               python version: 3.7.6 (tags/v3.7.6:43364a7ae0, Dec 18 2019, 23:46:00) [MSC v.1916 32 bit (Intel)]\r\n                     platform: Windows-10-10.0.19559-SP0\r\n     optional deps. installed: []\r\n```\r\n\r\n```py\r\nimport os\r\nfrom pathlib import Path\r\nimport pydantic\r\n\r\nclass Config1(pydantic.BaseSettings):\r\n    port: int = pydantic.Field(1234, const=True)\r\n\r\nclass Config2(pydantic.BaseSettings):\r\n    port: int = pydantic.Field(\"1234\", const=True)\r\n\r\nprint(\"No env\")\r\nprint(\"Config1\", Config1().dict())\r\nprint(\"Config2\", Config2().dict())\r\n\r\nprint(\"With .env\")\r\nPath(\".env\").write_text(\"port=1234\\n\")\r\nprint(\"Config1\", Config1(_env_file=\".env\").dict())  # FAILS\r\nprint(\"Config2\", Config2(_env_file=\".env\").dict())\r\n\r\nprint(\"With os.environ\")\r\nos.environ[\"port\"] = \"1234\"\r\nprint(\"Config1\", Config1().dict())  # FAILS\r\nprint(\"Config2\", Config2().dict())\r\n```\r\nCopy-paste in the Python REPL to continue on errors:\r\n```python\r\n>>> import os\r\n>>> from pathlib import Path\r\n>>> import pydantic\r\n>>> \r\n>>> class Config1(pydantic.BaseSettings):\r\n...     port: int = pydantic.Field(1234, const=True)  \r\n...\r\n>>> class Config2(pydantic.BaseSettings):\r\n...     port: int = pydantic.Field(\"1234\", const=True)\r\n...\r\n>>> print(\"No env\")\r\nNo env\r\n>>> print(\"Config1\", Config1().dict())\r\nConfig1 {'port': 1234}\r\n>>> print(\"Config2\", Config2().dict())\r\nConfig2 {'port': 1234}\r\n>>>\r\n>>> print(\"With .env\")\r\nWith .env\r\n>>> Path(\".env\").write_text(\"port=1234\\n\")\r\n10\r\n>>> print(\"Config1\", Config1(_env_file=\".env\").dict())  # FAILS\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \"D:\\dev\\github\\pydantic\\issues\\.venv\\lib\\site-packages\\pydantic\\env_settings.py\", line 28, in __init__\r\n    super().__init__(**__pydantic_self__._build_values(values, _env_file=_env_file))\r\n  File \"D:\\dev\\github\\pydantic\\issues\\.venv\\lib\\site-packages\\pydantic\\main.py\", line 338, in __init__\r\n    raise validation_error\r\npydantic.error_wrappers.ValidationError: 1 validation error for Config1\r\nport\r\n  unexpected value; permitted: 1234 (type=value_error.const; given=1234; permitted=[1234])\r\n>>> print(\"Config2\", Config2(_env_file=\".env\").dict())\r\nConfig2 {'port': 1234}\r\n>>>\r\n>>> print(\"With os.environ\")\r\nWith os.environ\r\n>>> os.environ[\"port\"] = \"1234\"\r\n>>> print(\"Config1\", Config1().dict())  # FAILS\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \"D:\\dev\\github\\pydantic\\issues\\.venv\\lib\\site-packages\\pydantic\\env_settings.py\", line 28, in __init__\r\n    super().__init__(**__pydantic_self__._build_values(values, _env_file=_env_file))\r\n  File \"D:\\dev\\github\\pydantic\\issues\\.venv\\lib\\site-packages\\pydantic\\main.py\", line 338, in __init__\r\n    raise validation_error\r\npydantic.error_wrappers.ValidationError: 1 validation error for Config1\r\nport\r\n  unexpected value; permitted: 1234 (type=value_error.const; given=1234; permitted=[1234])\r\n>>> print(\"Config2\", Config2().dict())\r\nConfig2 {'port': 1234}\r\n```\r\n\r\nLooked at the code, and noticed that `constant_validator` was applied with `pre_validators` -- before the type validators -- which explains the behaviour.\r\n\r\nMy question is: is this by design? It looks odd to have the default value be of a different type than the annotation. Additionally, if the value comes from a JSON object instead, then using `const` means the input type is now constrained to the type of the default value. For instance:\r\n```python\r\n>>> import pydantic\r\n>>>\r\n>>> class Config1(pydantic.BaseSettings):\r\n...     port_const: int = pydantic.Field(1234, const=True)\r\n...     port: int = pydantic.Field(1234)\r\n...\r\n>>> print(Config1())\r\nport_const=1234 port=1234\r\n>>> print(Config1(port_const=1234, port=1234))\r\nport_const=1234 port=1234\r\n>>> print(Config1(port_const=\"1234\", port=\"1234\"))\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \"D:\\dev\\github\\pydantic\\issues\\.venv\\lib\\site-packages\\pydantic\\env_settings.py\", line 28, in __init__\r\n    super().__init__(**__pydantic_self__._build_values(values, _env_file=_env_file))\r\n  File \"D:\\dev\\github\\pydantic\\issues\\.venv\\lib\\site-packages\\pydantic\\main.py\", line 338, in __init__\r\n    raise validation_error\r\npydantic.error_wrappers.ValidationError: 1 validation error for Config1\r\nport_const\r\n  unexpected value; permitted: 1234 (type=value_error.const; given=1234; permitted=[1234])\r\n```","closed_by":{"login":"samuelcolvin","id":4039449,"node_id":"MDQ6VXNlcjQwMzk0NDk=","avatar_url":"https://avatars.githubusercontent.com/u/4039449?v=4","gravatar_id":"","url":"https://api.github.com/users/samuelcolvin","html_url":"https://github.com/samuelcolvin","followers_url":"https://api.github.com/users/samuelcolvin/followers","following_url":"https://api.github.com/users/samuelcolvin/following{/other_user}","gists_url":"https://api.github.com/users/samuelcolvin/gists{/gist_id}","starred_url":"https://api.github.com/users/samuelcolvin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/samuelcolvin/subscriptions","organizations_url":"https://api.github.com/users/samuelcolvin/orgs","repos_url":"https://api.github.com/users/samuelcolvin/repos","events_url":"https://api.github.com/users/samuelcolvin/events{/privacy}","received_events_url":"https://api.github.com/users/samuelcolvin/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pydantic/pydantic/issues/1410/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pydantic/pydantic/issues/1410/timeline","performed_via_github_app":null,"state_reason":"completed"}