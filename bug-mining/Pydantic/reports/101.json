{"url":"https://api.github.com/repos/pydantic/pydantic/issues/1397","repository_url":"https://api.github.com/repos/pydantic/pydantic","labels_url":"https://api.github.com/repos/pydantic/pydantic/issues/1397/labels{/name}","comments_url":"https://api.github.com/repos/pydantic/pydantic/issues/1397/comments","events_url":"https://api.github.com/repos/pydantic/pydantic/issues/1397/events","html_url":"https://github.com/pydantic/pydantic/issues/1397","id":600745786,"node_id":"MDU6SXNzdWU2MDA3NDU3ODY=","number":1397,"title":"Excludes for aliased nested fields are skipped when using model.dict() with by_alias=True","user":{"login":"AlexECX","id":33321263,"node_id":"MDQ6VXNlcjMzMzIxMjYz","avatar_url":"https://avatars.githubusercontent.com/u/33321263?v=4","gravatar_id":"","url":"https://api.github.com/users/AlexECX","html_url":"https://github.com/AlexECX","followers_url":"https://api.github.com/users/AlexECX/followers","following_url":"https://api.github.com/users/AlexECX/following{/other_user}","gists_url":"https://api.github.com/users/AlexECX/gists{/gist_id}","starred_url":"https://api.github.com/users/AlexECX/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AlexECX/subscriptions","organizations_url":"https://api.github.com/users/AlexECX/orgs","repos_url":"https://api.github.com/users/AlexECX/repos","events_url":"https://api.github.com/users/AlexECX/events{/privacy}","received_events_url":"https://api.github.com/users/AlexECX/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":597426502,"node_id":"MDU6TGFiZWw1OTc0MjY1MDI=","url":"https://api.github.com/repos/pydantic/pydantic/labels/bug%20V1","name":"bug V1","color":"ee0701","default":false,"description":"Bug related to Pydantic V1.X"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2020-04-16T04:50:49Z","updated_at":"2020-04-18T16:05:22Z","closed_at":"2020-04-18T16:05:22Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"# Bug\r\n\r\nOutput of `python -c \"import pydantic.utils; print(pydantic.utils.version_info())\"`:\r\n```\r\n             pydantic version: 1.5a1\r\n            pydantic compiled: False\r\n                 install path: /home/acox/.local/share/virtualenvs/google-people-python-client-H9fvGxOj/src/pydantic/pydantic\r\n               python version: 3.7.5 (default, Feb 28 2020, 23:28:26)  [GCC 7.4.0]\r\n                     platform: Linux-4.4.0-18362-Microsoft-x86_64-with-debian-buster-sid\r\n     optional deps. installed: ['typing-extensions']\r\n\r\n```\r\n\r\nExemple demonstrating the problem:\r\n\r\n```py\r\nfrom pydantic import BaseModel, Field\r\n\r\n\r\nclass NestedModel(BaseModel):\r\n    to_exclude: str\r\n\r\n\r\nclass MyModel(BaseModel):\r\n    aliased: NestedModel = Field(None, alias=\"an_alias\")\r\n    not_aliased: NestedModel = None\r\n\r\n\r\ndata = {\r\n    \"an_alias\": {\"to_exclude\": \"hello\"},\r\n    \"not_aliased\": {\"to_exclude\": \"hello\"}\r\n}\r\n\r\nmodel = MyModel(**data)\r\nassert model.aliased\r\nassert model.not_aliased\r\n\r\n# Case 1 using a top-level Ellipsis with a nested aliased field, all is well.\r\n\r\nexcludes = {\r\n    \"aliased\": ...,\r\n    \"not_aliased\": {\"to_exclude\"},\r\n}\r\n\r\nmodel_dict = MyModel(**data).dict(exclude=excludes, by_alias=True)\r\nassert \"to_exclude\" not in model_dict[\"not_aliased\"]\r\nassert \"an_alias\" not in model_dict  # <-- This works fine\r\n\r\n# Case 2 using a Set or Dict with a nested aliased field, problem.\r\n\r\nexcludes = {\r\n    \"aliased\": {\"to_exclude\"},\r\n    \"not_aliased\": {\"to_exclude\"},\r\n}\r\n\r\nmodel_dict = MyModel(**data).dict(exclude=excludes, by_alias=True)\r\nassert \"to_exclude\" not in model_dict[\"an_alias\"]\r\nassert \"to_exclude\" not in model_dict[\"not_aliased\"]  # <-- This will fail\r\n```\r\n\r\nCode where the problem could be solved:\r\n\r\n#### Before (for context)\r\n\r\n```py\r\n# pydantic/main.py:671 in BaseModel._iter()\r\n        allowed_keys = self._calculate_keys(include=include, exclude=exclude, exclude_unset=exclude_unset)\r\n        if allowed_keys is None and not (to_dict or by_alias or exclude_unset or exclude_defaults or exclude_none):\r\n            # huge boost for plain _iter()\r\n            yield from self.__dict__.items()\r\n            return\r\n\r\n        value_exclude = ValueItems(self, exclude) if exclude else None\r\n        value_include = ValueItems(self, include) if include else None\r\n\r\n        for k, v in self.__dict__.items():\r\n            if (\r\n                (allowed_keys is not None and k not in allowed_keys)\r\n                or (exclude_none and v is None)\r\n                or (exclude_defaults and self.__field_defaults__.get(k, _missing) == v)\r\n            ):\r\n                continue\r\n            if by_alias and k in self.__fields__:\r\n                k = self.__fields__[k].alias\r\n            if to_dict or value_include or value_exclude:\r\n                v = self._get_value(\r\n                    v,\r\n                    to_dict=to_dict,\r\n                    by_alias=by_alias,\r\n                    include=value_include and value_include.for_element(k),\r\n                    exclude=value_exclude and value_exclude.for_element(k),\r\n                    exclude_unset=exclude_unset,\r\n                    exclude_defaults=exclude_defaults,\r\n                    exclude_none=exclude_none,\r\n                )\r\n            yield k, v\r\n```\r\n\r\nThe problem seems to be that `allowed_keys` needs the model's field real names, so `exclude` must contain real field names, while `value_exclude.for_element(k)` is passed either an alias when `by_alias=True`, or a real field name when `by_alias=False`. This makes `value_exclude.for_element()` fetch the wrong name when `by_alias=True`.\r\n\r\nThis could be fixed by always passing the real field name to `value_exclude.for_element()`, regardless of `by_alias`.\r\n\r\n#### Changes\r\n\r\n```py\r\n# pydantic/main.py:680 in BaseModel._iter()\r\n        for field_key, v in self.__dict__.items():\r\n            if (\r\n                (allowed_keys is not None and field_key not in allowed_keys)\r\n                or (exclude_none and v is None)\r\n                or (exclude_defaults and self.__field_defaults__.get(field_key, _missing) == v)\r\n            ):\r\n                continue\r\n            if by_alias and field_key in self.__fields__:\r\n                dict_key = self.__fields__[field_key].alias\r\n            else:\r\n                dict_key = field_key\r\n            if to_dict or value_include or value_exclude:\r\n                v = self._get_value(\r\n                    v,\r\n                    to_dict=to_dict,\r\n                    by_alias=by_alias,\r\n                    include=value_include and value_include.for_element(field_key),\r\n                    exclude=value_exclude and value_exclude.for_element(field_key),\r\n                    exclude_unset=exclude_unset,\r\n                    exclude_defaults=exclude_defaults,\r\n                    exclude_none=exclude_none,\r\n                )\r\n            yield dict_key, v\r\n```\r\n\r\nI'll try and make a proper PR later today, hopefully this can be fixed before the 1.5 release. ","closed_by":{"login":"samuelcolvin","id":4039449,"node_id":"MDQ6VXNlcjQwMzk0NDk=","avatar_url":"https://avatars.githubusercontent.com/u/4039449?v=4","gravatar_id":"","url":"https://api.github.com/users/samuelcolvin","html_url":"https://github.com/samuelcolvin","followers_url":"https://api.github.com/users/samuelcolvin/followers","following_url":"https://api.github.com/users/samuelcolvin/following{/other_user}","gists_url":"https://api.github.com/users/samuelcolvin/gists{/gist_id}","starred_url":"https://api.github.com/users/samuelcolvin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/samuelcolvin/subscriptions","organizations_url":"https://api.github.com/users/samuelcolvin/orgs","repos_url":"https://api.github.com/users/samuelcolvin/repos","events_url":"https://api.github.com/users/samuelcolvin/events{/privacy}","received_events_url":"https://api.github.com/users/samuelcolvin/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pydantic/pydantic/issues/1397/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pydantic/pydantic/issues/1397/timeline","performed_via_github_app":null,"state_reason":"completed"}