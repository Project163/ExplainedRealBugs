{"url":"https://api.github.com/repos/pydantic/pydantic/issues/2293","repository_url":"https://api.github.com/repos/pydantic/pydantic","labels_url":"https://api.github.com/repos/pydantic/pydantic/issues/2293/labels{/name}","comments_url":"https://api.github.com/repos/pydantic/pydantic/issues/2293/comments","events_url":"https://api.github.com/repos/pydantic/pydantic/issues/2293/events","html_url":"https://github.com/pydantic/pydantic/issues/2293","id":795273648,"node_id":"MDU6SXNzdWU3OTUyNzM2NDg=","number":2293,"title":"Can't roundtrip json encode/prase properly with ConstrainedDecimal","user":{"login":"Hultner","id":2669034,"node_id":"MDQ6VXNlcjI2NjkwMzQ=","avatar_url":"https://avatars.githubusercontent.com/u/2669034?v=4","gravatar_id":"","url":"https://api.github.com/users/Hultner","html_url":"https://github.com/Hultner","followers_url":"https://api.github.com/users/Hultner/followers","following_url":"https://api.github.com/users/Hultner/following{/other_user}","gists_url":"https://api.github.com/users/Hultner/gists{/gist_id}","starred_url":"https://api.github.com/users/Hultner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Hultner/subscriptions","organizations_url":"https://api.github.com/users/Hultner/orgs","repos_url":"https://api.github.com/users/Hultner/repos","events_url":"https://api.github.com/users/Hultner/events{/privacy}","received_events_url":"https://api.github.com/users/Hultner/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":597426502,"node_id":"MDU6TGFiZWw1OTc0MjY1MDI=","url":"https://api.github.com/repos/pydantic/pydantic/labels/bug%20V1","name":"bug V1","color":"ee0701","default":false,"description":"Bug related to Pydantic V1.X"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2021-01-27T16:55:23Z","updated_at":"2021-02-24T13:27:31Z","closed_at":"2021-02-24T11:50:24Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Checks\r\n\r\n* [x] I added a descriptive title to this issue\r\n* [x] I have searched (google, github) for similar issues and couldn't find anything\r\n* [x] I have read and followed [the docs](https://pydantic-docs.helpmanual.io/) and still think this is a bug\r\n\r\n<!-- Sorry to sound so draconian, but every second saved replying to issues is time spend improving pydantic :-) -->\r\n\r\n# Bug\r\n\r\nOutput of `python -c \"import pydantic.utils; print(pydantic.utils.version_info())\"`:\r\n```\r\n             pydantic version: 1.7.3\r\n            pydantic compiled: True\r\n                 install path: /Users/hultner/Library/Caches/pypoetry/virtualenvs/hantera-backend-5YPPF0bI-py3.9/lib/python3.9/site-packages/pydantic\r\n               python version: 3.9.0 (default, Oct 10 2020, 11:40:52)  [Clang 11.0.3 (clang-1103.0.32.62)]\r\n                     platform: macOS-10.15.7-x86_64-i386-64bit\r\n     optional deps. installed: ['typing-extensions', 'email-validator', 'devtools']\r\n```\r\n<!-- or if you're using pydantic prior to v1.3, manually include: OS, python version and pydantic version -->\r\n\r\n<!-- Please read the [docs](https://pydantic-docs.helpmanual.io/) and search through issues to\r\nconfirm your bug hasn't already been reported. -->\r\n\r\n<!-- Where possible please include a self-contained code snippet describing your bug: -->\r\n\r\nWhen using a `ConstrainedDecimal` with zero decimal_places (as provided in example below), pydantic incorrectly encodes the value as a float, thus resulting in failure if one tries to parse the recently encoded json object. \r\n\r\nUsing a decimal with `max_digits = x` and `decimal_places = 0` is a great way of representing for instance a `Numeric(22,0)` (where x is 22) from many SQL database schemas. Certain database engines like the popular pyodbc will properly handle and convert such a Decimal value, but won't handle it as an int as this is implicitly interpreted as a 32 bit int by pyodbc. Having a fixed number of max_digits also allows ones query-engine to pre-compile reusable query plans, which other wise would have to be recomputed for every length of of the given number.\r\nIn other words, using a ConstrainedDecimal for this type of data is ideal.\r\n\r\nI have provided a minimal test/example which can both be executed directly but also ran with pytest to showcase the issue at hand.\r\n\r\n```py\r\n\"\"\"\r\nSelf contained example showcasing problem with decimals using pydantics\r\ndefault encoder. \r\n\"\"\"\r\nfrom pydantic import ConstrainedDecimal, BaseModel\r\nfrom decimal import Decimal\r\n\r\n\r\nclass Id(ConstrainedDecimal):\r\n    max_digits = 22\r\n    decimal_places = 0\r\n    ge = 0\r\n\r\n\r\nObjId = Id\r\n\r\n\r\nclass Obj(BaseModel):\r\n    id: ObjId\r\n    name: str\r\n    price: Decimal = Decimal(0.00)\r\n\r\n\r\nclass ObjWithEncoder(BaseModel):\r\n    id: ObjId\r\n    name: str\r\n    price: Decimal = Decimal(0.00)\r\n\r\n    class Config:\r\n        json_encoders = {\r\n            Id: int,\r\n        }\r\n\r\n\r\ndef test_con_decimal_encode() -> None:\r\n    test_obj = Obj(id=1, name=\"Test Obj\")\r\n    cycled_obj = Obj.parse_raw(test_obj.json())\r\n    assert test_obj == cycled_obj\r\n\r\n\r\ndef test_con_decimal_encode_custom_encoder() -> None:\r\n    test_obj = ObjWithEncoder(id=1, name=\"Test Obj\")\r\n    cycled_obj = ObjWithEncoder.parse_raw(test_obj.json())\r\n    assert test_obj == cycled_obj\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    from pprint import pprint\r\n\r\n    print_obj = Obj(id=1, name=\"Test Obj\", price=1.23)\r\n    json_obj = print_obj.json()\r\n    pprint(json_obj)\r\n```\r\n\r\nI have a small patch for pydantic.json-module which I can provide as a pull-request. When using said patch all the tests above will pass, notice that I both handle the case where Decimals do have an negative exponent (decimal_places) and the case where it doesn't. The patch handles both these cases as expected and is written in a minimal, and of course readable fashion. \r\n\r\nI am right now in the process of reading through the contributor guidelines to ensure that my patch is up to the standards which the project holds for contributions.","closed_by":{"login":"samuelcolvin","id":4039449,"node_id":"MDQ6VXNlcjQwMzk0NDk=","avatar_url":"https://avatars.githubusercontent.com/u/4039449?v=4","gravatar_id":"","url":"https://api.github.com/users/samuelcolvin","html_url":"https://github.com/samuelcolvin","followers_url":"https://api.github.com/users/samuelcolvin/followers","following_url":"https://api.github.com/users/samuelcolvin/following{/other_user}","gists_url":"https://api.github.com/users/samuelcolvin/gists{/gist_id}","starred_url":"https://api.github.com/users/samuelcolvin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/samuelcolvin/subscriptions","organizations_url":"https://api.github.com/users/samuelcolvin/orgs","repos_url":"https://api.github.com/users/samuelcolvin/repos","events_url":"https://api.github.com/users/samuelcolvin/events{/privacy}","received_events_url":"https://api.github.com/users/samuelcolvin/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pydantic/pydantic/issues/2293/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pydantic/pydantic/issues/2293/timeline","performed_via_github_app":null,"state_reason":"completed"}