{"url":"https://api.github.com/repos/pydantic/pydantic/issues/1616","repository_url":"https://api.github.com/repos/pydantic/pydantic","labels_url":"https://api.github.com/repos/pydantic/pydantic/issues/1616/labels{/name}","comments_url":"https://api.github.com/repos/pydantic/pydantic/issues/1616/comments","events_url":"https://api.github.com/repos/pydantic/pydantic/issues/1616/events","html_url":"https://github.com/pydantic/pydantic/issues/1616","id":635029551,"node_id":"MDU6SXNzdWU2MzUwMjk1NTE=","number":1616,"title":"Make ValidationError unpicklable","user":{"login":"abadger","id":209242,"node_id":"MDQ6VXNlcjIwOTI0Mg==","avatar_url":"https://avatars.githubusercontent.com/u/209242?v=4","gravatar_id":"","url":"https://api.github.com/users/abadger","html_url":"https://github.com/abadger","followers_url":"https://api.github.com/users/abadger/followers","following_url":"https://api.github.com/users/abadger/following{/other_user}","gists_url":"https://api.github.com/users/abadger/gists{/gist_id}","starred_url":"https://api.github.com/users/abadger/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abadger/subscriptions","organizations_url":"https://api.github.com/users/abadger/orgs","repos_url":"https://api.github.com/users/abadger/repos","events_url":"https://api.github.com/users/abadger/events{/privacy}","received_events_url":"https://api.github.com/users/abadger/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":597426504,"node_id":"MDU6TGFiZWw1OTc0MjY1MDQ=","url":"https://api.github.com/repos/pydantic/pydantic/labels/feature%20request","name":"feature request","color":"84b6eb","default":false,"description":""},{"id":597426505,"node_id":"MDU6TGFiZWw1OTc0MjY1MDU=","url":"https://api.github.com/repos/pydantic/pydantic/labels/help%20wanted","name":"help wanted","color":"128A0C","default":true,"description":"Pull Request welcome"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2020-06-09T00:57:40Z","updated_at":"2020-06-27T18:31:24Z","closed_at":"2020-06-27T18:31:24Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"# Bug\r\n\r\nOutput of `python -c \"import pydantic.utils; print(pydantic.utils.version_info())\"`:\r\n```\r\n             pydantic version: 1.5.1\r\n            pydantic compiled: False\r\n                 install path: /home/badger/.cache/pypoetry/virtualenvs/antsibull-F3umzYPl-py3.8/lib/python3.8/site-packages/pydantic\r\n               python version: 3.8.3 (default, Feb 26 2020, 00:00:00)  [GCC 9.3.1 20200408 (Red Hat 9.3.1-2)]\r\n                     platform: Linux-5.6.15-200.fc31.x86_64-x86_64-with-glibc2.2.5\r\n     optional deps. installed: ['typing-extensions']\r\n...\r\n```\r\n<!-- or if you're using pydantic prior to v1.3, manually include: OS, python version and pydantic version -->\r\n\r\n<!-- Please read the [docs](https://pydantic-docs.helpmanual.io/) and search through issues to\r\nconfirm your bug hasn't already been reported. -->\r\n\r\n<!-- Where possible please include a self-contained code snippet describing your bug: -->\r\n\r\n## Use case\r\nI'm going to give you two code snippets because it might not be obvious from the simplest case why I would want to do it.\r\n\r\nA simple approximation of my use case is here: https://gist.github.com/abadger/bfd55741c281ccb534f7bbc8fe9b6202\r\n\r\nI am trying to use pydantic to validate and normalize data from a large number of data sources I need to run each validation separately so that I can know which data sources are providing invalid data. I decided to split it up amongst multiple CPUs by using asyncio's run_in_executor with a ProcessPoolExecutor.  However, when the pydantic.constr validation failed, I would get a BrokenProcessPool error on everything that had been queued but not run rather than a pydantic ValidationError on the specific task which failed.\r\n\r\n## Root cause\r\n\r\nI was able to workaround the problem by catching the pydantic exception and raising a ValueError with all of the information I needed.  This lead me to the root cause: pydantic errors are not **un**picklable.  Because of that, the exception raised in the worker process is pickled there and sent back to the parent process.  The parent process attempts to unpickle it, encounters the error, and then gives the generic, unhelpful BrokenProcessPool error and cancels the other pending tasks.\r\n\r\nHere's a reproducer for the root cause:\r\n```python\r\nimport pickle\r\nfrom pydantic.errors import StrRegexError\r\n\r\np = pickle.dumps(StrRegexError(pattern='test'))\r\nprint(pickle.loads(p))\r\n\r\n# Traceback (most recent call last):\r\n#   File \"<stdin>\", line 1, in <module>\r\n# TypeError: __init__() missing 1 required positional argument: 'pattern'\r\n```\r\n\r\nLooking at the python stdlib bugtracker there are many open bugs with interactions between pickle and exceptions.  I didn't see this one so I added this: https://bugs.python.org/issue40917  Some others that might cause different bugs with pydantics exceptions:\r\n\r\n* https://bugs.python.org/issue32696\r\n* https://bugs.python.org/issue30005\r\n\r\nGiven so many potential bugs, I'm not sure if this is solvable in pydantic code or has to wait for pickle fixes.  However, if it's not solvable, adding my workaround and an explanation of what's happening to the docs would be nice.  That way searching for pydantic, ProcessPoolExecutor, pickle, multiprocessing might save the next person some time wondering why only a portion of their data was being converted.","closed_by":{"login":"samuelcolvin","id":4039449,"node_id":"MDQ6VXNlcjQwMzk0NDk=","avatar_url":"https://avatars.githubusercontent.com/u/4039449?v=4","gravatar_id":"","url":"https://api.github.com/users/samuelcolvin","html_url":"https://github.com/samuelcolvin","followers_url":"https://api.github.com/users/samuelcolvin/followers","following_url":"https://api.github.com/users/samuelcolvin/following{/other_user}","gists_url":"https://api.github.com/users/samuelcolvin/gists{/gist_id}","starred_url":"https://api.github.com/users/samuelcolvin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/samuelcolvin/subscriptions","organizations_url":"https://api.github.com/users/samuelcolvin/orgs","repos_url":"https://api.github.com/users/samuelcolvin/repos","events_url":"https://api.github.com/users/samuelcolvin/events{/privacy}","received_events_url":"https://api.github.com/users/samuelcolvin/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pydantic/pydantic/issues/1616/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pydantic/pydantic/issues/1616/timeline","performed_via_github_app":null,"state_reason":"completed"}