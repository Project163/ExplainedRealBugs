{"url":"https://api.github.com/repos/curl/curl/issues/11564","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/11564/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/11564/comments","events_url":"https://api.github.com/repos/curl/curl/issues/11564/events","html_url":"https://github.com/curl/curl/issues/11564","id":1831197452,"node_id":"I_kwDOAAiu0c5tJdsM","number":11564,"title":"Curl does use the ipv4 address if it doesn't receive the ipv6 address","user":{"login":"JosephTharayil","id":24209665,"node_id":"MDQ6VXNlcjI0MjA5NjY1","avatar_url":"https://avatars.githubusercontent.com/u/24209665?v=4","gravatar_id":"","url":"https://api.github.com/users/JosephTharayil","html_url":"https://github.com/JosephTharayil","followers_url":"https://api.github.com/users/JosephTharayil/followers","following_url":"https://api.github.com/users/JosephTharayil/following{/other_user}","gists_url":"https://api.github.com/users/JosephTharayil/gists{/gist_id}","starred_url":"https://api.github.com/users/JosephTharayil/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JosephTharayil/subscriptions","organizations_url":"https://api.github.com/users/JosephTharayil/orgs","repos_url":"https://api.github.com/users/JosephTharayil/repos","events_url":"https://api.github.com/users/JosephTharayil/events{/privacy}","received_events_url":"https://api.github.com/users/JosephTharayil/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":975635480,"node_id":"MDU6TGFiZWw5NzU2MzU0ODA=","url":"https://api.github.com/repos/curl/curl/labels/name%20lookup","name":"name lookup","color":"0052cc","default":false,"description":"DNS and related tech"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2023-08-01T12:41:15Z","updated_at":"2023-08-02T04:46:16Z","closed_at":"2023-08-01T22:49:37Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\r\n\r\nHi Team,\r\n\r\nI am using curl 7.79.1 with c-ares 1.17.2. \r\n\r\nI use this command \"curl -v -m4 https://www.google.com\" to test how curl responds in various changes in responses to dns queries made by curl. To do this i am using a very simple dns server which responds to queries which are only \"www.google.com\" . \r\nThe first case is i try to execute the above command what i notice is in this case is that both ipv4 and ipv6 queries are sent from the c-ares library. But if ipv6 is not received before the timeout occurs the command fails even though the ipv4 response is obtained .\r\n\r\n curl -v -m4 https://www.google.com\r\n* STATE: INIT => CONNECT handle 0x563c74ff8998; line 1789 (connection #-5000)\r\n* Added connection 0. The cache now contains 1 members\r\n**15:29:38.735975 IP 6a5a2727f400.34325 > 10.174.75.167.domain: 63432+ A? www.google.com. (32)**\r\n15:29:38.736177 IP 6a5a2727f400.34325 > 10.174.75.167.domain: 56463+ AAAA? www.google.com. (32)\r\n* STATE: CONNECT => RESOLVING handle 0x563c74ff8998; line 1835 (connection #0)\r\n**15:29:38.736618 IP 10.174.75.167.domain > 6a5a2727f400.34325: 63432* 1/0/0 A 142.250.195.228 (49)**\r\n15:29:38.736834 IP 10.174.75.167.domain > 6a5a2727f400.34325: 63432* 1/0/0 A 142.250.195.228 (49)\r\n\r\n* Resolving timed out after 4001 milliseconds\r\n* multi_done\r\n* The cache now contains 0 members\r\n* Closing connection 0\r\n* Expire cleared (transfer 0x563c74ff8998)\r\ncurl: (28) Resolving timed out after 4001 milliseconds\r\n\r\nOk now what i do is i only try to send the ipv4 request using the -4 option but this also doesn't work with this curl version of 7.79.1. \r\n\r\n curl -v -m4 -4 https://www.google.com\r\n* STATE: INIT => CONNECT handle 0x565138d20998; line 1789 (connection #-5000)\r\n* Added connection 0. The cache now contains 1 members\r\n15:29:31.722618 IP 6a5a2727f400.38880 > 10.174.75.167.domain: 60498+ A? www.google.com. (32)\r\n15:29:31.722853 IP 6a5a2727f400.38880 > 10.174.75.167.domain: 50175+ AAAA? www.google.com. (32)\r\n* STATE: CONNECT => RESOLVING handle 0x565138d20998; line 1835 (connection #0)\r\n15:29:31.723211 IP 10.174.75.167.domain > 6a5a2727f400.38880: 60498* 1/0/0 A 142.250.195.228 (49)\r\n15:29:31.723230 IP 10.174.75.167.domain > 6a5a2727f400.38880: 60498* 1/0/0 A 142.250.195.228 (49)\r\n* Resolving timed out after 4001 milliseconds\r\n* multi_done\r\n* The cache now contains 0 members\r\n* Closing connection 0\r\n* Expire cleared (transfer 0x565138d20998)\r\ncurl: (28) Resolving timed out after 4001 milliseconds\r\n\r\nin this cases also both queries are sent out. Now if i do it just for ipv6 also the similar issue occurs both queries are sent out. \r\n\r\nIf i changed the curl version  to 7.87.0  then the \"-4\" option works here it only sends the query for ipv4 and doesn't initiate for ipv6 . But even in that version if i execute \"-6\" option then both ipv4 and ipv6 dns queries are sent out. \r\n\r\nCould you help me with this?\r\n\r\n### I expected the following\r\n\r\ncurl should return after the timeout and use what ever ip is obtained from the dns query response. To initiate the connection.  \r\n\r\n### curl/libcurl version\r\n\r\nroot@6a5a2727f400:/# curl -V curl 7.79.1 (x86_64-pc-linux-gnu) libcurl/7.79.1 OpenSSL/1.1.1f c-ares/1.17.2 Release-Date: 2021-09-22 Protocols: dict file ftp ftps gopher gophers http https imap imaps mqtt pop3 pop3s rtsp smb smbs smtp smtps telnet tftp Features: alt-svc AsynchDNS Debug HSTS HTTPS-proxy IPv6 Largefile NTLM NTLM_WB SSL TLS-SRP TrackMemory UnixSockets\r\n\r\n### operating system\r\n\r\nuname -a Linux 6a5a2727f400 5.4.0-136-generic #153~18.04.1-Ubuntu SMP Wed Nov 30 15:47:57 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/11564/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/11564/timeline","performed_via_github_app":null,"state_reason":"completed"}