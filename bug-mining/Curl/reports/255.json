{"url":"https://api.github.com/repos/curl/curl/issues/11231","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/11231/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/11231/comments","events_url":"https://api.github.com/repos/curl/curl/issues/11231/events","html_url":"https://github.com/curl/curl/issues/11231","id":1734854072,"node_id":"I_kwDOAAiu0c5nZ8W4","number":11231,"title":"Two test servers, one lock","user":{"login":"dfandrich","id":228259,"node_id":"MDQ6VXNlcjIyODI1OQ==","avatar_url":"https://avatars.githubusercontent.com/u/228259?v=4","gravatar_id":"","url":"https://api.github.com/users/dfandrich","html_url":"https://github.com/dfandrich","followers_url":"https://api.github.com/users/dfandrich/followers","following_url":"https://api.github.com/users/dfandrich/following{/other_user}","gists_url":"https://api.github.com/users/dfandrich/gists{/gist_id}","starred_url":"https://api.github.com/users/dfandrich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dfandrich/subscriptions","organizations_url":"https://api.github.com/users/dfandrich/orgs","repos_url":"https://api.github.com/users/dfandrich/repos","events_url":"https://api.github.com/users/dfandrich/events{/privacy}","received_events_url":"https://api.github.com/users/dfandrich/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":887227423,"node_id":"MDU6TGFiZWw4ODcyMjc0MjM=","url":"https://api.github.com/repos/curl/curl/labels/tests","name":"tests","color":"a7a8e8","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"dfandrich","id":228259,"node_id":"MDQ6VXNlcjIyODI1OQ==","avatar_url":"https://avatars.githubusercontent.com/u/228259?v=4","gravatar_id":"","url":"https://api.github.com/users/dfandrich","html_url":"https://github.com/dfandrich","followers_url":"https://api.github.com/users/dfandrich/followers","following_url":"https://api.github.com/users/dfandrich/following{/other_user}","gists_url":"https://api.github.com/users/dfandrich/gists{/gist_id}","starred_url":"https://api.github.com/users/dfandrich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dfandrich/subscriptions","organizations_url":"https://api.github.com/users/dfandrich/orgs","repos_url":"https://api.github.com/users/dfandrich/repos","events_url":"https://api.github.com/users/dfandrich/events{/privacy}","received_events_url":"https://api.github.com/users/dfandrich/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"dfandrich","id":228259,"node_id":"MDQ6VXNlcjIyODI1OQ==","avatar_url":"https://avatars.githubusercontent.com/u/228259?v=4","gravatar_id":"","url":"https://api.github.com/users/dfandrich","html_url":"https://github.com/dfandrich","followers_url":"https://api.github.com/users/dfandrich/followers","following_url":"https://api.github.com/users/dfandrich/following{/other_user}","gists_url":"https://api.github.com/users/dfandrich/gists{/gist_id}","starred_url":"https://api.github.com/users/dfandrich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dfandrich/subscriptions","organizations_url":"https://api.github.com/users/dfandrich/orgs","repos_url":"https://api.github.com/users/dfandrich/repos","events_url":"https://api.github.com/users/dfandrich/events{/privacy}","received_events_url":"https://api.github.com/users/dfandrich/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":3,"created_at":"2023-05-31T19:19:16Z","updated_at":"2023-06-08T00:13:11Z","closed_at":"2023-06-08T00:13:11Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"The test servers use a single file `serverlogs.lock` to indicate when a test server is still writing its logs to prevent the test harness from looking at them too soon. However, many tests use more than one server running in parallel (e.g. http and http-proxy) and the first one to finish clears the lock for both of them. This means that the test harness can look at the logs before they are all ready. I believe this is what causes many of the flaky test failures we often see in the CI tests.\r\n\r\nFor example, in one particular test failure I looked at in test 1904, the `proxy.input` file started with the line `[DISCONNECT]`. This should never happen because there is no client connected when the test starts. Furthermore, test 1904 does NOT set `connection-monitor` without which `[DISCONNECT]` should not be printed. What must have happened was that a previous test set `connection-monitor` but the other server cleared the log lock before it had a chance to write that final message and only write it after the log files were deleted and the next test (1904) had already started.\r\n\r\nMany other flaky test failures occur because a final `QUIT` command is not logged. This may also be explained if another server clears the log lock (causing the test harness to look at all the log files too soon) before that server gets a chance to write the final command.\r\n\r\nMore evidence for this is the server log line:\r\n\r\n    Error removing lock file log9/serverlogs.lock error: 2 No such file or directory\r\n\r\nindicating that the lock file is expected to exist but was somehow deleted without the server doing it. The most likely explanation is that the other server deleted it.\r\n\r\nOne problem with this theory in the general case is that this kind of problem also happens on tests that only have a single server (e.g. ftp test 135). Some of these use `sockfilt` in addition to the main test server, but it doesn't appear that `sockfilt` engages in the log file locking scheme.\r\n\r\nOne solution to this problem is to allow multiple lock files, probably one fixed lock file per server, and have the test harness look for and wait for them all. Another is to have all servers set `fcntl(1)` locks on a single file, but this may not be portable enough and is probably why the file approach was chosen from the start.","closed_by":{"login":"dfandrich","id":228259,"node_id":"MDQ6VXNlcjIyODI1OQ==","avatar_url":"https://avatars.githubusercontent.com/u/228259?v=4","gravatar_id":"","url":"https://api.github.com/users/dfandrich","html_url":"https://github.com/dfandrich","followers_url":"https://api.github.com/users/dfandrich/followers","following_url":"https://api.github.com/users/dfandrich/following{/other_user}","gists_url":"https://api.github.com/users/dfandrich/gists{/gist_id}","starred_url":"https://api.github.com/users/dfandrich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dfandrich/subscriptions","organizations_url":"https://api.github.com/users/dfandrich/orgs","repos_url":"https://api.github.com/users/dfandrich/repos","events_url":"https://api.github.com/users/dfandrich/events{/privacy}","received_events_url":"https://api.github.com/users/dfandrich/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/11231/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/11231/timeline","performed_via_github_app":null,"state_reason":"completed"}