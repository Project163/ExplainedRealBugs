{"url":"https://api.github.com/repos/curl/curl/issues/10245","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/10245/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/10245/comments","events_url":"https://api.github.com/repos/curl/curl/issues/10245/events","html_url":"https://github.com/curl/curl/issues/10245","id":1521741223,"node_id":"I_kwDOAAiu0c5as-2n","number":10245,"title":"curl http/3 segmentation fault","user":{"login":"divydal","id":5424832,"node_id":"MDQ6VXNlcjU0MjQ4MzI=","avatar_url":"https://avatars.githubusercontent.com/u/5424832?v=4","gravatar_id":"","url":"https://api.github.com/users/divydal","html_url":"https://github.com/divydal","followers_url":"https://api.github.com/users/divydal/followers","following_url":"https://api.github.com/users/divydal/following{/other_user}","gists_url":"https://api.github.com/users/divydal/gists{/gist_id}","starred_url":"https://api.github.com/users/divydal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/divydal/subscriptions","organizations_url":"https://api.github.com/users/divydal/orgs","repos_url":"https://api.github.com/users/divydal/repos","events_url":"https://api.github.com/users/divydal/events{/privacy}","received_events_url":"https://api.github.com/users/divydal/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118205,"node_id":"MDU6TGFiZWwxODQxMTgyMDU=","url":"https://api.github.com/repos/curl/curl/labels/crash","name":"crash","color":"bfe5bf","default":false,"description":null},{"id":1141438010,"node_id":"MDU6TGFiZWwxMTQxNDM4MDEw","url":"https://api.github.com/repos/curl/curl/labels/HTTP/3","name":"HTTP/3","color":"97fceb","default":false,"description":"h3 or quic related"}],"state":"closed","locked":false,"assignee":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":3,"created_at":"2023-01-06T01:53:50Z","updated_at":"2023-01-09T14:25:13Z","closed_at":"2023-01-09T14:25:13Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!-- Only file bugs here! Ask questions on the mailing lists https://curl.se/mail/\r\n\r\n     SECURITY RELATED? Post it here: https://hackerone.com/curl\r\n\r\n     There are collections of known issues to be aware of:\r\n     https://curl.se/docs/knownbugs.html\r\n     https://curl.se/docs/todo.html       -->\r\n\r\n### I did this\r\nI compiled curl in a docker container following the steps described in https://curl.se/docs/http3.html.\r\nHere are the relevant Dockerfile lines:\r\n```\r\nFROM ubuntu:20.04\r\n\r\n# Run apt-get update at each install step because of docker cache\r\nARG PKGINSTALL=\"apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y\"\r\n...\r\nRUN mkdir /usr/local/openssl_3\r\nWORKDIR /usr/src\r\nRUN git clone --depth 1 -b openssl-3.0.7+quic https://github.com/quictls/openssl\r\nWORKDIR /usr/src/openssl\r\nRUN CFLAGS=\"-Og -ggdb\" ./config enable-tls1_3 --prefix=/usr/local/openssl_3 && make && make install\r\n\r\nRUN mkdir /usr/local/nghttp3\r\nWORKDIR /usr/src\r\nRUN git clone https://github.com/ngtcp2/nghttp3\r\nWORKDIR /usr/src/nghttp3\r\nRUN autoreconf -fi\r\nRUN ./configure CFLAGS=\"-Og -ggdb\"  --prefix=/usr/local/nghttp3 --enable-lib-only && make && make install\r\n\r\nRUN mkdir /usr/local/ngtcp2\r\nWORKDIR /usr/src\r\nRUN git clone https://github.com/ngtcp2/ngtcp2\r\nWORKDIR /usr/src/ngtcp2\r\nRUN autoreconf -fi\r\nRUN ./configure PKG_CONFIG_PATH=/usr/local/openssl_3/lib64/pkgconfig:/usr/local/nghttp3/lib64/pkgconfig \\\r\n    LDFLAGS=\"-Wl,-rpath,/usr/local/openssl_3/lib64\" \\\r\n    CFLAGS=\"-Og -ggdb\" \\\r\n    --with-openssl=/usr/local/openssl_3 \\\r\n    --prefix=/usr/local/ngtcp2 --enable-lib-only \\\r\n    && make && make install\r\n\r\nRUN mkdir /usr/local/curl_quic\r\nWORKDIR /usr/src\r\nRUN git clone https://github.com/curl/curl\r\nWORKDIR /usr/src/curl\r\nRUN autoreconf -fi\r\nRUN LDFLAGS=\"-Wl,-rpath,/usr/local/openssl_3/lib64\" CFLAGS=\"-Og -ggdb\" \\\r\n    ./configure --with-openssl=/usr/local/openssl_3 \\\r\n    --with-nghttp3=/usr/local/nghttp3 --with-ngtcp2=/usr/local/ngtcp2 --prefix=/usr/local/curl_quic \\\r\n    && make && make install\r\n\r\n# default cmd\r\nCMD bash -i\r\n``` \r\n\r\nI then ran:\r\n```\r\n(DOCKER:data-divy-spod-master-device-3rdparty-plume-docker)divy@fw-opensync-02:/usr/local/curl_quic/bin$ ./curl --http3 https://nghttp2.org:4433/\r\nSegmentation fault\r\n```\r\n\r\nHere is the gdb output:\r\n```\r\n(DOCKER:data-divy-spod-master-device-3rdparty-plume-docker)divy@fw-opensync-02:/usr/local/curl_quic/bin$ gdb\r\nGNU gdb (Ubuntu 9.2-0ubuntu1~20.04.1) 9.2\r\nCopyright (C) 2020 Free Software Foundation, Inc.\r\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\r\nThis is free software: you are free to change and redistribute it.\r\nThere is NO WARRANTY, to the extent permitted by law.\r\nType \"show copying\" and \"show warranty\" for details.\r\nThis GDB was configured as \"x86_64-linux-gnu\".\r\nType \"show configuration\" for configuration details.\r\nFor bug reporting instructions, please see:\r\n<http://www.gnu.org/software/gdb/bugs/>.\r\nFind the GDB manual and other documentation resources online at:\r\n    <http://www.gnu.org/software/gdb/documentation/>.\r\n\r\nFor help, type \"help\".\r\nType \"apropos word\" to search for commands related to \"word\".\r\n(gdb) file ./curl\r\nReading symbols from ./curl...\r\n(gdb) run ./curl --http3 https://nghttp2.org:4433/\r\nStarting program: /usr/local/curl_quic/bin/curl ./curl --http3 https://nghttp2.org:4433/\r\n[Thread debugging using libthread_db enabled]\r\nUsing host libthread_db library \"/lib/x86_64-linux-gnu/libthread_db.so.1\".\r\ncurl: (3) HTTP/3 requested for non-HTTPS URL\r\n[New Thread 0x7ffff7765700 (LWP 17)]\r\n[Thread 0x7ffff7765700 (LWP 17) exited]\r\n\r\nThread 1 \"curl\" received signal SIGSEGV, Segmentation fault.\r\nngtcp2_conn_get_streams_bidi_left (conn=conn@entry=0x0) at ngtcp2_conn.c:13334\r\n13334\t  uint64_t n = ngtcp2_ord_stream_id(conn->local.bidi.next_stream_id);\r\n(gdb) bt\r\n#0  ngtcp2_conn_get_streams_bidi_left (conn=conn@entry=0x0) at ngtcp2_conn.c:13334\r\n#1  0x00007ffff7c95843 in ngtcp2_conn_open_bidi_stream (conn=0x0, pstream_id=pstream_id@entry=0x7fffffffe380, stream_user_data=stream_user_data@entry=0x0) at ngtcp2_conn.c:11508\r\n#2  0x00007ffff7f94e10 in h3_stream_open (cf=<optimized out>, data=0x5555555a6df0, mem=0x5555556eed60, len=82) at vquic/curl_ngtcp2.c:1352\r\n#3  0x00007ffff7f95147 in cf_ngtcp2_send (cf=0x5555556c6d10, data=0x5555555a6df0, buf=<optimized out>, len=82, err=0x7fffffffe454) at vquic/curl_ngtcp2.c:1453\r\n#4  0x00007ffff7f3822f in Curl_cf_def_send (cf=<optimized out>, data=<optimized out>, buf=<optimized out>, len=<optimized out>, err=<optimized out>) at cfilters.c:120\r\n#5  0x00007ffff7f3822f in Curl_cf_def_send (cf=<optimized out>, data=<optimized out>, buf=<optimized out>, len=<optimized out>, err=<optimized out>) at cfilters.c:120\r\n#6  0x00007ffff7f38405 in Curl_conn_send (data=<optimized out>, num=<optimized out>, mem=<optimized out>, len=<optimized out>, code=0x7fffffffe454) at cfilters.c:232\r\n#7  0x00007ffff7f6d404 in Curl_write (data=data@entry=0x5555555a6df0, sockfd=sockfd@entry=6, mem=mem@entry=0x5555556eed60, len=len@entry=82, written=written@entry=0x7fffffffe490) at sendf.c:318\r\n#8  0x00007ffff7f52c1c in Curl_buffer_send (in=in@entry=0x7fffffffe580, data=data@entry=0x5555555a6df0, http=0x5555555a2e80, bytes_written=bytes_written@entry=0x5555555a81a0, included_body_bytes=included_body_bytes@entry=0, socketindex=socketindex@entry=0) at http.c:1407\r\n#9  0x00007ffff7f5479a in Curl_http_bodysend (data=data@entry=0x5555555a6df0, conn=conn@entry=0x55555559e010, r=r@entry=0x7fffffffe580, httpreq=<optimized out>) at http.c:2660\r\n#10 0x00007ffff7f5574e in Curl_http (data=0x5555555a6df0, done=<optimized out>) at http.c:3225\r\n#11 0x00007ffff7f63032 in multi_do (data=data@entry=0x5555555a6df0, done=done@entry=0x7fffffffe604) at multi.c:1563\r\n#12 0x00007ffff7f664ce in multi_runsingle (multi=multi@entry=0x5555555a21e0, nowp=nowp@entry=0x7fffffffe660, data=data@entry=0x5555555a6df0) at multi.c:2161\r\n#13 0x00007ffff7f670c6 in curl_multi_perform (multi=multi@entry=0x5555555a21e0, running_handles=running_handles@entry=0x7fffffffe760) at multi.c:2689\r\n#14 0x00007ffff7f42e67 in easy_transfer (multi=multi@entry=0x5555555a21e0) at easy.c:663\r\n#15 0x00007ffff7f42fd6 in easy_perform (data=0x5555555a6df0, events=events@entry=false) at easy.c:762\r\n#16 0x00007ffff7f43575 in curl_easy_perform (data=<optimized out>) at easy.c:772\r\n#17 0x000055555556fe57 in serial_transfers (global=0x7fffffffe980, share=0x55555559f680) at tool_operate.c:2439\r\n#18 0x000055555556ffa3 in run_all_transfers (global=global@entry=0x7fffffffe980, share=share@entry=0x55555559f680, result=CURLE_OK) at tool_operate.c:2627\r\n#19 0x000055555557028f in operate (global=0x7fffffffe980, argc=<optimized out>, argv=<optimized out>) at tool_operate.c:2741\r\n#20 0x0000555555569d86 in main (argc=4, argv=0x7fffffffeb28) at tool_main.c:283\r\n```\r\n### I expected the following\r\nI did not expect a crash :)\r\n\r\n### curl/libcurl version\r\n```\r\n(DOCKER:data-divy-spod-master-device-3rdparty-plume-docker)divy@fw-opensync-02:/usr/local/curl_quic/bin$ ./curl -V\r\ncurl 7.87.1-DEV (x86_64-pc-linux-gnu) libcurl/7.87.1-DEV OpenSSL/3.0.7 zlib/1.2.11 ngtcp2/0.13.0-DEV nghttp3/0.9.0-DEV\r\nRelease-Date: [unreleased]\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps mqtt pop3 pop3s rtsp smb smbs smtp smtps telnet tftp\r\nFeatures: alt-svc AsynchDNS HSTS HTTP3 HTTPS-proxy IPv6 Largefile libz NTLM NTLM_WB SSL threadsafe TLS-SRP UnixSockets\r\n```\r\n\r\nHere are the various git heads:\r\ncurl:\r\n```\r\n(DOCKER:data-divy-spod-master-device-3rdparty-plume-docker)divy@fw-opensync-02:/usr/src/curl$ git log  -1\r\ncommit 1f693e0acac420b80984cbd90988ea6dd9a32bdb (HEAD -> master, origin/master, origin/HEAD)\r\nAuthor: Jon Rumsey <jrumsey@uk.ibm.com>\r\nDate:   Thu Jan 5 15:26:50 2023 +0000\r\n\r\n    x509asn1: fix compile errors and warnings\r\n\r\n    Various small issues when built for GSKit\r\n\r\n    Closes #10238\r\n```\r\n\r\nopenssl:\r\n```\r\n(DOCKER:data-divy-spod-master-device-3rdparty-plume-docker)divy@fw-opensync-02:/usr/src/openssl$ git log  -1\r\ncommit 247bb4dbd1d327ff9ed852ca53402249db5db486 (grafted, HEAD -> openssl-3.0.7+quic, tag: openssl-3.0.7+quic1, origin/openssl-3.0.7+quic, origin/HEAD)\r\nAuthor: Todd Short <tshort@akamai.com>\r\nDate:   Tue Nov 1 12:55:46 2022 -0400\r\n\r\n    QUIC: Fix extension test\r\n```\r\n\r\nnghttp3:\r\n```\r\n(DOCKER:data-divy-spod-master-device-3rdparty-plume-docker)divy@fw-opensync-02:/usr/src/nghttp3$ git log  -1\r\ncommit 8191bc57442274dbcc9518198c77ae89876b0bdb (HEAD -> main, origin/main, origin/HEAD)\r\nMerge: 472c4d3 0765787\r\nAuthor: Tatsuhiro Tsujikawa <404610+tatsuhiro-t@users.noreply.github.com>\r\nDate:   Thu Dec 22 15:54:35 2022 +0900\r\n\r\n    Merge pull request #99 from vszakats/warnfix\r\n\r\n    add casts to silence implicit conversion warnings\r\n```\r\n\r\nngtcp2:\r\n```\r\n(DOCKER:data-divy-spod-master-device-3rdparty-plume-docker)divy@fw-opensync-02:/usr/src/ngtcp2$ git log  -1\r\ncommit 8d4627f1c27553c4a4cababe192df9d088113542 (HEAD -> main, origin/main, origin/HEAD)\r\nMerge: 9492659f 6accbc36\r\nAuthor: Tatsuhiro Tsujikawa <404610+tatsuhiro-t@users.noreply.github.com>\r\nDate:   Sun Jan 1 16:38:41 2023 +0900\r\n\r\n    Merge pull request #648 from ngtcp2/picotls-keylog\r\n\r\n    Picotls keylog\r\n```\r\n\r\n[curl -V output]\r\n\r\n### operating system\r\n```\r\n(DOCKER:data-divy-spod-master-device-3rdparty-plume-docker)divy@fw-opensync-02:/usr/local/curl_quic/bin$ uname -a\r\nLinux fw-opensync-02 5.15.0-1021-aws #25~20.04.1-Ubuntu SMP Thu Sep 22 13:59:08 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux\r\n```\r\n<!-- On Unix please post the output of \"uname -a\" -->\r\n","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/10245/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/10245/timeline","performed_via_github_app":null,"state_reason":"completed"}