{"url":"https://api.github.com/repos/curl/curl/issues/9664","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/9664/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/9664/comments","events_url":"https://api.github.com/repos/curl/curl/issues/9664/events","html_url":"https://github.com/curl/curl/issues/9664","id":1400881370,"node_id":"I_kwDOAAiu0c5Tf8Da","number":9664,"title":"Issue when using UNIX socket: Connection #0 is still name resolving, can't reuse","user":{"login":"vasiliy-ul","id":75380525,"node_id":"MDQ6VXNlcjc1MzgwNTI1","avatar_url":"https://avatars.githubusercontent.com/u/75380525?v=4","gravatar_id":"","url":"https://api.github.com/users/vasiliy-ul","html_url":"https://github.com/vasiliy-ul","followers_url":"https://api.github.com/users/vasiliy-ul/followers","following_url":"https://api.github.com/users/vasiliy-ul/following{/other_user}","gists_url":"https://api.github.com/users/vasiliy-ul/gists{/gist_id}","starred_url":"https://api.github.com/users/vasiliy-ul/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vasiliy-ul/subscriptions","organizations_url":"https://api.github.com/users/vasiliy-ul/orgs","repos_url":"https://api.github.com/users/vasiliy-ul/repos","events_url":"https://api.github.com/users/vasiliy-ul/events{/privacy}","received_events_url":"https://api.github.com/users/vasiliy-ul/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":370011580,"node_id":"MDU6TGFiZWwzNzAwMTE1ODA=","url":"https://api.github.com/repos/curl/curl/labels/connecting%20&%20proxies","name":"connecting & proxies","color":"c2e0c6","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-10-07T09:24:11Z","updated_at":"2022-10-08T17:23:58Z","closed_at":"2022-10-08T09:45:41Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hello. I observe an issue while running some tests that use curl with a unix socket: https://gitlab.com/nbdkit/nbdkit/-/blob/master/tests/test-curl-header-script.c\r\n\r\nThe tests trigger several HTTP requests. The first one goes well:\r\n\r\n```\r\nnbdkit: debug: curl: load\r\nnbdkit: debug: curl: config key=url, value=http://localhost/disk\r\nnbdkit: debug: curl: config key=header-script, value=if [ $iteration -eq 0 ]; then echo X-Test: hello; fi\r\necho X-Iteration: $iteration\r\necho 'X-Empty;'\r\n\r\nnbdkit: debug: curl: config key=header-script-renew, value=1\r\nnbdkit: debug: curl: config key=unix-socket-path, value=/tmp/wswOJAjw/sock\r\nnbdkit: debug: curl: config_complete\r\nnbdkit: debug: using thread model: serialize_requests\r\nnbdkit: debug: curl: get_ready\r\nnbdkit: debug: curl: after_fork\r\nnbdkit: curl: debug: curl: preconnect\r\nnbdkit: curl: debug: newstyle negotiation: flags: global 0x3\r\nnbdkit: curl: debug: newstyle negotiation: client flags: 0x3\r\nnbdkit: curl: debug: newstyle negotiation: NBD_OPT_STRUCTURED_REPLY: client requested structured replies\r\nnbdkit: curl: debug: newstyle negotiation: NBD_OPT_GO: client requested export ''\r\nnbdkit: curl: debug: curl: open readonly=0 exportname=\"\" tls=0\r\nnbdkit: curl: debug: curl: default_export readonly=0 tls=0\r\nnbdkit: curl: debug: curl: running header-script\r\nnbdkit: curl: debug: header-script returned 3 header(s)\r\nnbdkit: curl: debug:   Trying /tmp/wswOJAjw/sock:0...\r\nnbdkit: curl: debug: Connected to localhost () port 80 (#0)\r\nnbdkit: curl: debug: C: HEAD /disk HTTP/1.1\r\n``` \r\nwhile on the second I see error message `Connection #0 is still name resolving, can't reuse`:\r\n\r\n```\r\nnbdkit: curl: debug: Mark bundle as not supporting multiuse\r\nnbdkit: curl: debug: S: HTTP/1.1 200 OK\r\nnbdkit: curl: debug: S: Accept-rANGES:     bytes\r\nnbdkit: curl: debug: S: Connection: keep-alive\r\nnbdkit: curl: debug: S: Content-Type: application/octet-stream\r\nnbdkit: curl: debug: S: Content-Length: 105923072\r\nnbdkit: curl: debug: S: \r\nnbdkit: curl: debug: Connection #0 to host localhost left intact\r\nnbdkit: curl: debug: content length: 105923072\r\nnbdkit: curl: debug: accept range supported (for HTTP/HTTPS)\r\nnbdkit: curl: debug: curl: open returned handle 0x55fe754678c0\r\nnbdkit: curl: debug: curl: prepare readonly=0\r\nnbdkit: curl: debug: curl: get_size\r\nnbdkit: curl: debug: curl: can_write\r\nnbdkit: curl: debug: curl: can_zero\r\nnbdkit: curl: debug: curl: can_fast_zero\r\nnbdkit: curl: debug: curl: can_trim\r\nnbdkit: curl: debug: curl: can_fua\r\nnbdkit: curl: debug: curl: can_flush\r\nnbdkit: curl: debug: curl: is_rotational\r\nnbdkit: curl: debug: curl: can_multi_conn\r\nnbdkit: curl: debug: curl: can_cache\r\nnbdkit: curl: debug: curl: can_extents\r\nnbdkit: curl: debug: newstyle negotiation: flags: export 0x8c1\r\nnbdkit: curl: debug: curl: block_size\r\nnbdkit: curl: debug: newstyle negotiation: NBD_OPT_GO: NBD_INFO_BLOCK_SIZE: client requested but no plugin or filter provided block size information, ignoring client request\r\nnbdkit: curl: debug: handshake complete, processing requests serially\r\nnbdkit: curl: debug: curl: pread count=512 offset=0\r\nnbdkit: curl: debug: curl: running header-script\r\nnbdkit: curl: debug: header-script returned 2 header(s)\r\nnbdkit: curl: debug: Found bundle for host: 0x55fe75469050 [serially]\r\nnbdkit: curl: debug: Can not multiplex, even if we wanted to\r\nnbdkit: curl: debug: Connection #0 is still name resolving, can't reuse\r\nnbdkit: curl: debug:   Trying /tmp/wswOJAjw/sock:0...\r\nnbdkit: curl: debug: Connected to localhost () port 80 (#1)\r\nnbdkit: curl: debug: C: GET /disk HTTP/1.1\r\n```\r\nThis eventually causes problems with the test execution. I can reproduce this with libcurl `7.85.0`.\r\n\r\nAfter running with a couple of previous versions, eventually I was able to bisect the commit 0f23341953.\r\n\r\nI am very new to the curl codebase, but it seems to me that after the mentioned change, the `primay_ip` field is not properly updated anymore when UNIX sockets are used:\r\n\r\nhttps://github.com/curl/curl/blob/83de62babc6d54da033477f3e6ba6af5b6c68663/lib/url.c#L1253-L1258\r\n\r\nAlso in the log, the output of `Curl_verboseconnect` is `Connected to localhost () port 80 (#1)` and here the `primary_ip` is empty as well (in `()`).\r\n\r\nI was able to fix the problem with the bellow patch by handling the newly introduced  `TRNSPRT_UNIX` in `Curl_updateconninfo`:\r\n\r\n```diff\r\ndiff --git a/lib/connect.c b/lib/connect.c\r\nindex c1d8cfd39..d830c00fc 100644\r\n--- a/lib/connect.c\r\n+++ b/lib/connect.c\r\n@@ -774,6 +774,11 @@ void Curl_updateconninfo(struct Curl_easy *data, struct connectdata *conn,\r\n     Curl_conninfo_local(data, sockfd, local_ip, &local_port);\r\n   }\r\n #endif\r\n+  else if(conn->transport == TRNSPRT_UNIX) {\r\n+    if(!conn->bits.reuse)\r\n+      Curl_conninfo_remote(data, conn, sockfd);\r\n+    Curl_conninfo_local(data, sockfd, local_ip, &local_port);\r\n+  }\r\n \r\n   /* persist connection info in session handle */\r\n   Curl_persistconninfo(data, conn, local_ip, local_port);\r\n```\r\n\r\nI just wanted to share the patch and get some feedback. Would that be a proper way to fix the issue?\r\n\r\n<!-- Only file bugs here! Ask questions on the mailing lists https://curl.se/mail/\r\n\r\n     SECURITY RELATED? Post it here: https://hackerone.com/curl\r\n\r\n     There are collections of known issues to be aware of:\r\n     https://curl.se/docs/knownbugs.html\r\n     https://curl.se/docs/todo.html       -->\r\n\r\n### I did this\r\n\r\n### I expected the following\r\n\r\n### curl/libcurl version\r\n\r\n[curl -V output]\r\n\r\n### operating system\r\n\r\n<!-- On Unix please post the output of \"uname -a\" -->\r\n","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/9664/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/9664/timeline","performed_via_github_app":null,"state_reason":"completed"}