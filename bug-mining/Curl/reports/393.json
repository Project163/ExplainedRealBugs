{"url":"https://api.github.com/repos/curl/curl/issues/12833","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/12833/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/12833/comments","events_url":"https://api.github.com/repos/curl/curl/issues/12833/events","html_url":"https://github.com/curl/curl/issues/12833","id":2111073432,"node_id":"I_kwDOAAiu0c591GyY","number":12833,"title":"libcurl links with libnghttp3 even when http3 support is off","user":{"login":"ryandesign","id":429209,"node_id":"MDQ6VXNlcjQyOTIwOQ==","avatar_url":"https://avatars.githubusercontent.com/u/429209?v=4","gravatar_id":"","url":"https://api.github.com/users/ryandesign","html_url":"https://github.com/ryandesign","followers_url":"https://api.github.com/users/ryandesign/followers","following_url":"https://api.github.com/users/ryandesign/following{/other_user}","gists_url":"https://api.github.com/users/ryandesign/gists{/gist_id}","starred_url":"https://api.github.com/users/ryandesign/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ryandesign/subscriptions","organizations_url":"https://api.github.com/users/ryandesign/orgs","repos_url":"https://api.github.com/users/ryandesign/repos","events_url":"https://api.github.com/users/ryandesign/events{/privacy}","received_events_url":"https://api.github.com/users/ryandesign/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118182,"node_id":"MDU6TGFiZWwxODQxMTgxODI=","url":"https://api.github.com/repos/curl/curl/labels/build","name":"build","color":"bfdadc","default":false,"description":null},{"id":1141438010,"node_id":"MDU6TGFiZWwxMTQxNDM4MDEw","url":"https://api.github.com/repos/curl/curl/labels/HTTP/3","name":"HTTP/3","color":"97fceb","default":false,"description":"h3 or quic related"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2024-01-31T22:17:50Z","updated_at":"2024-02-05T22:48:41Z","closed_at":"2024-02-05T22:48:41Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nHello! A user's [bug report to MacPorts](https://trac.macports.org/ticket/69251) revealed that libcurl is linking with libnghttp3 even when http3 support is not enabled and this seemed incorrect to me.\r\n\r\nWe use the autotools build system. If ngtcp2 and nghttp3 are both installed and curl is configured with no flags relating to ngtcp2 or nghttp3, then I expected that http3 support would not be enabled and libnghttp3 would not be used. Output from configure is:\r\n\r\n```\r\nchecking for libnghttp3 options with pkg-config... found\r\nconfigure: -l is -lnghttp3\r\nconfigure: -I is \r\nconfigure: -L is -L/opt/local/lib\r\nchecking for nghttp3_conn_client_new_versioned in -lnghttp3... yes\r\nchecking for nghttp3/nghttp3.h... yes\r\n…\r\n   LIBS:            -lnghttp3 -lnghttp2 -lidn2 -lpsl -lssl -lcrypto -lssl -lcrypto -lzstd -lzstd -lbrotlidec -lbrotlidec -lz\r\n…\r\n  HTTP3:            no      (--with-ngtcp2 --with-nghttp3, --with-quiche, --with-openssl-quic, --with-msh3)\r\n```\r\n\r\nAfter installation curl reports:\r\n\r\n```\r\n% curl --version\r\ncurl 8.6.0 (x86_64-apple-darwin21.6.0) libcurl/8.6.0 OpenSSL/3.2.1 zlib/1.3.1 brotli/1.1.0 zstd/1.5.5 libidn2/2.3.7 libpsl/0.21.2 nghttp2/1.59.0\r\nRelease-Date: 2024-01-31\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps ipfs ipns mqtt pop3 pop3s rtsp smb smbs smtp smtps telnet tftp\r\nFeatures: alt-svc AsynchDNS brotli HSTS HTTP2 HTTPS-proxy IDN IPv6 Largefile libz NTLM PSL SSL threadsafe TLS-SRP UnixSockets zstd\r\n```\r\n\r\nSo the first line correctly omits `ngtcp2/1.2.0 nghttp3/1.1.0` from the list of libraries used and the last line correctly omits `HTTP3` from the list of features however libcurl is still linked with libnghttp3 (but not with libngtcp2):\r\n\r\n```\r\n% otool -L /opt/local/lib/libcurl.dylib\r\n/opt/local/lib/libcurl.dylib:\r\n\t/opt/local/lib/libcurl.4.dylib (compatibility version 13.0.0, current version 13.0.0)\r\n\t/opt/local/lib/libnghttp3.9.dylib (compatibility version 11.0.0, current version 11.0.0)\r\n\t/opt/local/lib/libnghttp2.14.dylib (compatibility version 41.0.0, current version 41.0.0)\r\n\t/opt/local/lib/libidn2.0.dylib (compatibility version 5.0.0, current version 5.0.0)\r\n\t/opt/local/lib/libpsl.5.dylib (compatibility version 9.0.0, current version 9.4.0)\r\n\t/opt/local/libexec/openssl3/lib/libssl.3.dylib (compatibility version 3.0.0, current version 3.0.0)\r\n\t/opt/local/libexec/openssl3/lib/libcrypto.3.dylib (compatibility version 3.0.0, current version 3.0.0)\r\n\t/opt/local/lib/libzstd.1.dylib (compatibility version 1.0.0, current version 1.5.5)\r\n\t/opt/local/lib/libbrotlidec.1.dylib (compatibility version 1.0.0, current version 1.1.0)\r\n\t/opt/local/lib/libz.1.dylib (compatibility version 1.0.0, current version 1.3.1)\r\n\t/System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation (compatibility version 150.0.0, current version 1856.105.0)\r\n\t/System/Library/Frameworks/CoreServices.framework/Versions/A/CoreServices (compatibility version 1.0.0, current version 1141.1.0)\r\n\t/System/Library/Frameworks/SystemConfiguration.framework/Versions/A/SystemConfiguration (compatibility version 1.0.0, current version 1163.60.3)\r\n\t/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1311.0.0)\r\n```\r\n\r\nIt correctly links with libngtcp2 and libnghttp3 and enables http3 support if I use the `--with-ngtcp2` and `--with-nghttp3` configure flags, and it correctly does not link with libngtcp2 or libnghttp3 if I use the `--without-ngtcp2` and `--without-nghttp3` configure flags.\n\n### I expected the following\n\nI expected the configure script not to check for libnghttp3 and for libcurl not to be linked with libnghttp3 unless http3 support was enabled with the `--with-ngtcp2` and `--with-nghttp3` configure flags.\n\n### curl/libcurl version\n\ncurl 8.6.0\n\n### operating system\n\nmacOS 12.7.2","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/12833/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/12833/timeline","performed_via_github_app":null,"state_reason":"completed"}