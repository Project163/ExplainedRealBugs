{"url":"https://api.github.com/repos/curl/curl/issues/17120","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/17120/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/17120/comments","events_url":"https://api.github.com/repos/curl/curl/issues/17120/events","html_url":"https://github.com/curl/curl/issues/17120","id":3009309780,"node_id":"I_kwDOAAiu0c6zXmxU","number":17120,"title":"vquic.c HAVE_SENDMSG recvmsg_packets missing msg_iov reset","user":{"login":"piru","id":1134152,"node_id":"MDQ6VXNlcjExMzQxNTI=","avatar_url":"https://avatars.githubusercontent.com/u/1134152?v=4","gravatar_id":"","url":"https://api.github.com/users/piru","html_url":"https://github.com/piru","followers_url":"https://api.github.com/users/piru/followers","following_url":"https://api.github.com/users/piru/following{/other_user}","gists_url":"https://api.github.com/users/piru/gists{/gist_id}","starred_url":"https://api.github.com/users/piru/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/piru/subscriptions","organizations_url":"https://api.github.com/users/piru/orgs","repos_url":"https://api.github.com/users/piru/repos","events_url":"https://api.github.com/users/piru/events{/privacy}","received_events_url":"https://api.github.com/users/piru/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141438010,"node_id":"MDU6TGFiZWwxMTQxNDM4MDEw","url":"https://api.github.com/repos/curl/curl/labels/HTTP/3","name":"HTTP/3","color":"97fceb","default":false,"description":"h3 or quic related"}],"state":"closed","locked":false,"assignee":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":7,"created_at":"2025-04-21T21:08:02Z","updated_at":"2025-04-22T13:01:50Z","closed_at":"2025-04-22T11:47:09Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nIt seems that vquic.c `HAVE_SENDMSG` `recvmsg_packets` fails to reset the `msg_iov.iov_base` and `msg_iov.iov_len` back to `buf` values when the buffer is been fully filled (that is inficated by `msg_iov.iov_len` becoming 0):\nhttps://github.com/curl/curl/blob/23bed347b38922779382599f8b72c4d762add7bd/lib/vquic/vquic.c#L497\n\nIn this case the code will call `recvmsg` with `iov_len` of 0. Depending on the specific of the operating system network stack, this can lead to 0 being returned. If 0 is returned the loop will never terminate as `pkts` can't advance.\n\nI believe the correct thing to do is to reset the `iov_base` and `iov_len` when the whole buffer has been consumed, something like this:\n\n```\ndiff --git a/lib/vquic/vquic.c b/lib/vquic/vquic.c\nindex c1963b473..dedb4e891 100644\n--- a/lib/vquic/vquic.c\n+++ b/lib/vquic/vquic.c\n@@ -494,6 +494,10 @@ static CURLcode recvmsg_packets(struct Curl_cfilter *cf,\n     msg.msg_name = &remote_addr;\n     msg.msg_namelen = sizeof(remote_addr);\n     msg.msg_controllen = sizeof(msg_ctrl);\n+    if(msg_iov.iov_len == 0) {\n+      msg_iov.iov_base = buf;\n+      msg_iov.iov_len = (int)sizeof(buf);\n+    }\n     while((nread = recvmsg(qctx->sockfd, &msg, 0)) == -1 &&\n           SOCKERRNO == SOCKEINTR)\n       ;\n```\n\nThis seems to work for me, at least, but I am not 100% is this is what should be done here. Note that this codepath is not used on platforms that have `HAVE_SENDMMSG`.\n\nBonus idea: Perhaps this and similar fallback codepaths should be exercised by testsuite by explicitly disabling configure flags?\n\n### I expected the following\n\n`recvmsg_packets` not getting stuck in a busyloop.\n\n### curl/libcurl version\n\ncurl 8.13.0\n\n### operating system\n\nMorphOS (network stack is a bsd variant that has recvmsg returning 0 when total iov_len is 0)","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/17120/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/17120/timeline","performed_via_github_app":null,"state_reason":"completed"}