{"url":"https://api.github.com/repos/curl/curl/issues/15801","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/15801/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/15801/comments","events_url":"https://api.github.com/repos/curl/curl/issues/15801/events","html_url":"https://github.com/curl/curl/issues/15801","id":2754737182,"node_id":"I_kwDOAAiu0c6kMfQe","number":15801,"title":"Incorrect mbedtls_ssl_write usage causes ranges of bytes to get lost","user":{"login":"LBPHacker","id":3286587,"node_id":"MDQ6VXNlcjMyODY1ODc=","avatar_url":"https://avatars.githubusercontent.com/u/3286587?v=4","gravatar_id":"","url":"https://api.github.com/users/LBPHacker","html_url":"https://github.com/LBPHacker","followers_url":"https://api.github.com/users/LBPHacker/followers","following_url":"https://api.github.com/users/LBPHacker/following{/other_user}","gists_url":"https://api.github.com/users/LBPHacker/gists{/gist_id}","starred_url":"https://api.github.com/users/LBPHacker/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/LBPHacker/subscriptions","organizations_url":"https://api.github.com/users/LBPHacker/orgs","repos_url":"https://api.github.com/users/LBPHacker/repos","events_url":"https://api.github.com/users/LBPHacker/events{/privacy}","received_events_url":"https://api.github.com/users/LBPHacker/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118221,"node_id":"MDU6TGFiZWwxODQxMTgyMjE=","url":"https://api.github.com/repos/curl/curl/labels/TLS","name":"TLS","color":"bfdadc","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":12,"created_at":"2024-12-22T16:33:12Z","updated_at":"2024-12-30T09:20:40Z","closed_at":"2024-12-30T09:20:40Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nUsing mbedtls 3.6.2 = Mbed-TLS/mbedtls@107ea89daaef and nghttp2 1.50.0 = nghttp2/nghttp2@87fef4ab71be, HTTP/2 requests with large-ish (600kB+) request bodies often fail with `HTTP/2 stream 1 was not closed cleanly: PROTOCOL_ERROR (err 1)`. Wireshark traces I have taken show that the data stream ends sooner than the content-length header would suggest, and the server gives up after some inactivity and fails the request. Matching up frames with known data shows that ranges of bytes inside the TLS stream occasionally get lost.\r\n\r\nThis has prompted me to look at how data is passed to mbedtls:\r\n\r\nhttps://github.com/curl/curl/blob/7eb8c048470ed2cc14dca75be9c1cdae7ac8498b/lib/vtls/mbedtls.c#L1169-L1194\r\n\r\nGiven [the documentation on mbedtls_ssl_write](https://mbed-tls.readthedocs.io/projects/api/en/v3.6.2/api/file/ssl_8h/#ssl_8h_1a5bbda87d484de82df730758b475f32e5), which states that when `MBEDTLS_ERR_SSL_WANT_WRITE` is returned, the same arguments must be passed the next time, this seems incorrect: simply returning `CURLE_AGAIN` allows for *more* data to be given to this function than the amount given at the previous call.\r\n\r\nI have made a change locally that makes sure that when `MBEDTLS_ERR_SSL_WANT_WRITE` is returned, the exact same arguments are passed the next time around, even if `mbed_send` has more data to send than the last time (and return an appropriate `ret`), and indeed, this fixes my issue.\r\n\r\nThis is not a pull request because the underlying issue seems to be one of design, and I am not willing to tackle fixing it: as far as I can tell, libcurl is designed with [write(2)](https://linux.die.net/man/2/write)-like behaviour in mind, i.e. ranges of bytes that are reported sent *have been* sent (or the stream breaks later, etc.), and ranges reported to have been left unsent are not sent, but also *not committed* anywhere. The issue with mbedtls seems to be that it effectively commits ranges of bytes internally, which is not compatible with this design.\n\n### I expected the following\n\nI expected the aforementioned requests to succeed. Excuse me for filling this field with such an abstract answer; the issue I am facing is also abstract.\n\n### curl/libcurl version\n\ncurl 8.10.1 = 7eb8c048470e\n\n### operating system\n\nWindows 10.0.19045.3570","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/15801/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/15801/timeline","performed_via_github_app":null,"state_reason":"completed"}