{"url":"https://api.github.com/repos/curl/curl/issues/9335","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/9335/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/9335/comments","events_url":"https://api.github.com/repos/curl/curl/issues/9335/events","html_url":"https://github.com/curl/curl/issues/9335","id":1344699120,"node_id":"I_kwDOAAiu0c5QJnrw","number":9335,"title":"Connection not cleanly closed with CURLOPT_CONNECT_ONLY","user":{"login":"Thalhammer","id":7987999,"node_id":"MDQ6VXNlcjc5ODc5OTk=","avatar_url":"https://avatars.githubusercontent.com/u/7987999?v=4","gravatar_id":"","url":"https://api.github.com/users/Thalhammer","html_url":"https://github.com/Thalhammer","followers_url":"https://api.github.com/users/Thalhammer/followers","following_url":"https://api.github.com/users/Thalhammer/following{/other_user}","gists_url":"https://api.github.com/users/Thalhammer/gists{/gist_id}","starred_url":"https://api.github.com/users/Thalhammer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Thalhammer/subscriptions","organizations_url":"https://api.github.com/users/Thalhammer/orgs","repos_url":"https://api.github.com/users/Thalhammer/repos","events_url":"https://api.github.com/users/Thalhammer/events{/privacy}","received_events_url":"https://api.github.com/users/Thalhammer/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":370011580,"node_id":"MDU6TGFiZWwzNzAwMTE1ODA=","url":"https://api.github.com/repos/curl/curl/labels/connecting%20&%20proxies","name":"connecting & proxies","color":"c2e0c6","default":false,"description":null},{"id":1117926199,"node_id":"MDU6TGFiZWwxMTE3OTI2MTk5","url":"https://api.github.com/repos/curl/curl/labels/libcurl%20API","name":"libcurl API","color":"fef2c0","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2022-08-19T17:13:00Z","updated_at":"2022-08-23T11:44:36Z","closed_at":"2022-08-23T11:44:36Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\r\nMy intention is to use a combination of `CURLOPT_CONNECT_ONLY`, `curl_multi_*` and `curl_easy_send`/`curl_easy_recv` to implement a custom protocol while leveraging the proxy and ssl handling of libcurl (together with the libcurl multi workers I already have for async http). Despite many warnings and false claims (e.g. `curl_waitfd.revents` has a unsupported comment, despite being supported on at least windows and posix) this works fine in my case.\r\n\r\nHowever I think I found a issue when it comes to closing connections, which might be related to #4426 but I am not 100% sure.\r\nWhen I open a connection with CURLOPT_CONNECT_ONLY it seems to outlive the `curl_easy_close` call despite being removed from all multi handles. Looking at a wireshark capture it seems like the connection is keep alive until the multi handle it was associated with gets closed.\r\n\r\nAnother issue is that even though the connection is closed after the multi handle is gone, its not close cleanly but rather just reset, which (while usually not a problem) is not a clean tcp shutdown.\r\n\r\nAnother thing of note is that if I use ssl encryption everything seems to work correctly.\r\n\r\n### I expected the following\r\nThe connection should get closed cleanly using a fin packet as soon as I dispose of the curl_easy handle.\r\n\r\n### curl/libcurl version\r\nlibcurl 7.74.0 built using CMAKE with `HTTP_ONLY=ON CURL_DISABLE_CRYPTO_AUTH=ON`.\r\n\r\n### operating system\r\n`Linux <redacted> 5.15.0-46-generic #49~20.04.1-Ubuntu SMP Thu Aug 4 19:15:44 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux`\r\n\r\nEDIT: If I try to open a second connection to any other host after closing the first handle.has been removed for a while, then curl will actually notice that the first connection has no handle anymore and close it (still not cleanly).\r\nEDIT2: A workaround seems to be to use the synchronous `curl_easy_perform` method to establish the connection and never call `curl_multi_add_handle` for the handle, in which case the connection is closed as soon as I cleanup the handle (still not cleanly though). I assume libcurl creates an implicit multi handle inside and drops it along with the easy handle, causing the connection to get closed. This however is not really good workaround cause the connection establishment is now synchronous.","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/9335/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/9335/timeline","performed_via_github_app":null,"state_reason":"completed"}