{"url":"https://api.github.com/repos/curl/curl/issues/16237","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/16237/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/16237/comments","events_url":"https://api.github.com/repos/curl/curl/issues/16237/events","html_url":"https://github.com/curl/curl/issues/16237","id":2837933895,"node_id":"I_kwDOAAiu0c6pJ29H","number":16237,"title":"curl dns resolution broken on x32","user":{"login":"jengelh","id":8861948,"node_id":"MDQ6VXNlcjg4NjE5NDg=","avatar_url":"https://avatars.githubusercontent.com/u/8861948?v=4","gravatar_id":"","url":"https://api.github.com/users/jengelh","html_url":"https://github.com/jengelh","followers_url":"https://api.github.com/users/jengelh/followers","following_url":"https://api.github.com/users/jengelh/following{/other_user}","gists_url":"https://api.github.com/users/jengelh/gists{/gist_id}","starred_url":"https://api.github.com/users/jengelh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jengelh/subscriptions","organizations_url":"https://api.github.com/users/jengelh/orgs","repos_url":"https://api.github.com/users/jengelh/repos","events_url":"https://api.github.com/users/jengelh/events{/privacy}","received_events_url":"https://api.github.com/users/jengelh/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":975635480,"node_id":"MDU6TGFiZWw5NzU2MzU0ODA=","url":"https://api.github.com/repos/curl/curl/labels/name%20lookup","name":"name lookup","color":"0052cc","default":false,"description":"DNS and related tech"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":12,"created_at":"2025-02-07T11:31:59Z","updated_at":"2025-02-07T15:45:33Z","closed_at":"2025-02-07T15:45:33Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nVersion: curl 8.12 tarball from most recent github tag\n\n### Observed:\n\n```\n$ autoreconf -fi && ./configure --with-openssl --enable-ipv6 && make\n[…]\n  CC       ../lib/curl-version_win32.o\n  CC       ../lib/curl-warnless.o\necho 'extern const void *curl_ca_embed; const void *curl_ca_embed;' > tool_ca_embed.c\n  HUGE     tool_hugehelp.c\n  CC       curl-tool_ca_embed.o\n  CC       curl-tool_hugehelp.o\n  CCLD     curl\nmake[1]: Leaving directory '/home/ej/curl-curl-8_12_0/src'\nMaking all in scripts\nmake[1]: Entering directory '/home/ej/curl-curl-8_12_0/scripts'\nmake[1]: Nothing to be done for 'all'.\nmake[1]: Leaving directory '/home/ej/curl-curl-8_12_0/scripts'\nmake[1]: Entering directory '/home/ej/curl-curl-8_12_0'\nmake[1]: Nothing to be done for 'all-am'.\nmake[1]: Leaving directory '/home/ej/curl-curl-8_12_0'\n\nej@a4:~/curl-curl-8_12_0$ ./src/curl inai.de\ncurl: (6) Could not resolve host: inai.de\n\nej@a4:~/curl-curl-8_12_0$ libtool --mode=execute gdb src/curl\n(gdb) b getaddrinfo\n(gdb) r inai.de\n[…]\nThread 2 \"curl\" hit Breakpoint 1, __GI_getaddrinfo (name=0x47aa00 \"inai.de\", service=0xf6d65f14 \"80\", hints=0x47bc84, pai=0xf6d65ec0)\n    at ./nss/getaddrinfo.c:2297\nwarning: 2297   ./nss/getaddrinfo.c: No such file or directory\n(gdb) fin\nRun till exit from #0  __GI_getaddrinfo (name=0x47aa00 \"inai.de\", service=0xf6d65f14 \"80\", hints=0x47bc84, pai=0xf6d65ec0)\n    at ./nss/getaddrinfo.c:2297\n0xf7ecf079 in Curl_getaddrinfo_ex (nodename=0x47aa00 \"inai.de\", servname=0xf6d65f14 \"80\", hints=0x47bc84, result=0x47bc80)\n    at curl_addrinfo.c:121\n121       error = getaddrinfo(nodename, servname, hints, &aihead);\nValue returned is $1 = 0\n(gdb) p aihead[0]\n$2 = {ai_flags = 0, ai_family = 10, ai_socktype = 1, ai_protocol = 6, ai_addrlen = 28, ai_addr = 0xf64008a0, ai_canonname = 0x0, \n  ai_next = 0xf6400840}\n(gdb) p aihead[0].ai_next[0]\n$3 = {ai_flags = 0, ai_family = 2, ai_socktype = 1, ai_protocol = 6, ai_addrlen = 16, ai_addr = 0xf6400860, ai_canonname = 0x0, \n  ai_next = 0x0}\n```\n\ngetaddrinfo in thread2 even succeeds, but it appears the dnscache in thread1 remains empty (h->table = NULL).\n\n\n```\nmulti_runsingle (multi=0x47b970, nowp=0xffffd9a0, data=0x4800b0) at multi.c:2346\n2346      struct Curl_message *msg = NULL;\n(gdb) n\n2348      bool protocol_connected = FALSE;\n(gdb) \n2349      bool dophase_done = FALSE;\n(gdb) \n2351      CURLcode result = CURLE_OK;\n(gdb) \n2354      if(!GOOD_EASY_HANDLE(data))\n(gdb) \n2357      if(multi->dead) {\n(gdb) \n2371        bool stream_error = FALSE;\n(gdb) \n2372        rc = CURLM_OK;\n(gdb) \n2374        if(multi_ischanged(multi, TRUE)) {\n(gdb) \n2379        if(data->mstate > MSTATE_CONNECT &&\n(gdb) \n2380           data->mstate < MSTATE_COMPLETED) {\n(gdb) \n2379        if(data->mstate > MSTATE_CONNECT &&\n(gdb) \n2383          if(!data->conn)\n(gdb) \n2389        if((data->mstate >= MSTATE_CONNECT) && (data->mstate < MSTATE_COMPLETED) &&\n(gdb) \n2390           multi_handle_timeout(data, nowp, &stream_error, &result))\n(gdb) \n2389        if((data->mstate >= MSTATE_CONNECT) && (data->mstate < MSTATE_COMPLETED) &&\n(gdb) \n2394        switch(data->mstate) {\n(gdb) \n2428          rc = state_resolving(multi, data, &stream_error, &result);\n(gdb) s\nstate_resolving (multi=0x47b970, data=0x4800b0, stream_errorp=0xffffd8bf, resultp=0xffffd8c4) at multi.c:2219\n2219      struct Curl_dns_entry *dns = NULL;\n(gdb) n\n2220      struct connectdata *conn = data->conn;\n(gdb) \n2222      CURLcode result = CURLE_OK;\n(gdb) \n2223      CURLMcode rc = CURLM_OK;\n(gdb) \n2227      if(conn->bits.httpproxy)\n(gdb) \n2231        if(conn->bits.conn_to_host)\n(gdb) \n2234          hostname = conn->host.name;\n(gdb) \n2237      dns = Curl_fetch_addr(data, hostname, conn->primary.remote_port);\n(gdb) s\nCurl_fetch_addr (data=0x4800b0, hostname=0x479b70 \"inai.de\", port=80) at hostip.c:360\n360       struct Curl_dns_entry *dns = NULL;\n(gdb) n\n362       if(data->share)\n(gdb) \n363         Curl_share_lock(data, CURL_LOCK_DATA_DNS, CURL_LOCK_ACCESS_SINGLE);\n(gdb) \n365       dns = fetch_addr(data, hostname, port);\n(gdb) s\nfetch_addr (data=0x4800b0, hostname=0x479b70 \"inai.de\", port=80) at hostip.c:280\n280       struct Curl_dns_entry *dns = NULL;\n(gdb) n\n284       size_t entry_len = create_hostcache_id(hostname, 0, port,\n(gdb) n\n288       dns = Curl_hash_pick(data->dns.hostcache, entry_id, entry_len + 1);\n(gdb) s\nCurl_hash_pick (h=0x47d630, key=0xffffd700, key_len=11) at hash.c:199\n199       if(h->table) {\n(gdb) n\n212       return NULL;\n(gdb) \n213     }\n```\n\n### I expected the following\n\nsucceed, given DNS *is* functioning properly.\n\n```\nej@a4:~/curl-curl-8_12_0$ getent hosts inai.de\n2a01:4f8:202:600a::a3 inai.de\n```\n\n### curl/libcurl version\n\nhttps://github.com/curl/curl/archive/refs/tags/curl-8_12_0.tar.gz\n\n### operating system\n\n```\nej@a4:~/curl-curl-8_12_0$ cat /etc/os-release \nPRETTY_NAME=\"Debian GNU/Linux trixie/sid\"\nNAME=\"Debian GNU/Linux\"\nVERSION_CODENAME=trixie\nID=debian\nHOME_URL=\"https://www.debian.org/\"\nSUPPORT_URL=\"https://www.debian.org/support\"\nBUG_REPORT_URL=\"https://bugs.debian.org/\"\n\nej@a4:~/curl-curl-8_12_0$ cat /etc/apt/sources.list\ndeb https://deb.debian.org/debian-ports sid main\ndeb-src http://ftp.debian.org/debian sid main contrib non-free\n\nej@a4:~/curl-curl-8_12_0$ uname -a\nLinux a4 6.13.0 #6 SMP PREEMPT_DYNAMIC Sat Jan 25 14:29:25 CET 2025 x86_64 GNU/Linux\n\nej@a4:~/curl-curl-8_12_0$ gcc -v\nUsing built-in specs.\nCOLLECT_GCC=gcc\nCOLLECT_LTO_WRAPPER=/usr/libexec/gcc/x86_64-linux-gnux32/14/lto-wrapper\nTarget: x86_64-linux-gnux32\nConfigured with: ../src/configure -v --with-pkgversion='Debian 14.2.0-16' --with-bugurl=file:///usr/share/doc/gcc-14/README.Bugs --enable-languages=c,ada,c++,go,d,fortran,objc,obj-c++,m2 --prefix=/usr --with-gcc-major-version-only --program-suffix=-14 --program-prefix=x86_64-linux-gnux32- --enable-shared --enable-linker-build-id --libexecdir=/usr/libexec --without-included-gettext --enable-threads=posix --libdir=/usr/lib --enable-nls --enable-clocale=gnu --enable-libstdcxx-debug --enable-libstdcxx-time=yes --with-default-libstdcxx-abi=new --enable-libstdcxx-backtrace --enable-gnu-unique-object --disable-vtable-verify --enable-plugin --with-system-zlib --enable-libphobos-checking=release --with-target-system-zlib=auto --enable-objc-gc=auto --enable-multiarch --disable-werror --enable-cet --with-abi=mx32 --with-multilib-list=mx32,m64,m32 --enable-multilib --enable-checking=release --build=x86_64-linux-gnux32 --host=x86_64-linux-gnux32 --target=x86_64-linux-gnux32\nThread model: posix\nSupported LTO compression algorithms: zlib zstd\ngcc version 14.2.0 (Debian 14.2.0-16)\n```\n","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/16237/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/16237/timeline","performed_via_github_app":null,"state_reason":"completed"}