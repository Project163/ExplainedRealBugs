{"url":"https://api.github.com/repos/curl/curl/issues/12823","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/12823/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/12823/comments","events_url":"https://api.github.com/repos/curl/curl/issues/12823/events","html_url":"https://github.com/curl/curl/issues/12823","id":2109681941,"node_id":"I_kwDOAAiu0c59vzEV","number":12823,"title":"test 596 flakiness","user":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118265,"node_id":"MDU6TGFiZWwxODQxMTgyNjU=","url":"https://api.github.com/repos/curl/curl/labels/FTP","name":"FTP","color":"bfd4f2","default":false,"description":null},{"id":887227423,"node_id":"MDU6TGFiZWw4ODcyMjc0MjM=","url":"https://api.github.com/repos/curl/curl/labels/tests","name":"tests","color":"a7a8e8","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2024-01-31T09:41:46Z","updated_at":"2024-02-01T21:33:31Z","closed_at":"2024-02-01T21:33:31Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nI ran:\r\n\r\n```\r\nmake -j20 && (cd tests && make -j20 && ./runtests.pl --repeat=100 596)\r\n```\r\n\r\nwhich eventually fails the test with:\r\n\r\n```\r\n 596: protocol FAILED:\r\n--- log/check-expected\t2024-01-31 10:29:38\r\n+++ log/check-generated\t2024-01-31 10:29:38\r\n@@ -5,4 +5,3 @@\r\n TYPE I[CR][LF]\r\n SIZE 596[CR][LF]\r\n RETR 596[CR][LF]\r\n-QUIT[CR][LF]\r\n\r\n - abort tests\r\n```\r\n\r\nwhat I see then in the log file is:\r\n\r\n```\r\n0000: 150 Binary data connection for 596 () (4 bytes).\r\n10:29:38.694577 == Info: Maxdownload = -1\r\n10:29:38.694686 == Info: Getting file with size: 4\r\n10:29:38.694807 == Info: Preparing for accepting server on data port\r\n10:29:38.694969 == Info: Checking for server connect\r\n10:29:38.695129 == Info: Ctrl conn has data while waiting for data conn\r\n10:29:38.695299 <= Recv header, 28 bytes (0x1c)\r\n0000: 226 File transfer complete\r\n10:29:38.695516 == Info: [FTP] recv 0 bytes, ftpcode=226\r\n10:29:38.695667 == Info: ftp AllowServerConnect() -> 8\r\n...\r\n```\r\n\r\nwhich is the error code `CURLE_WEIRD_SERVER_REPLY` on seeing the `226` response on the control connection before curl has retrieved the file. See ftp.c:421.\r\n\r\nWhat I believe happens here is that the POLL event on the control socket arrives sometimes before the event on the data socket. The server probably has sent the 4 data bytes of the \"file\" and directly wrote the 226 response on the control. Since the OS makes no guarantee in what order socket event arrive at the peer, this seems to point to a bug in the curl code.\n\n### I expected the following\n\nThe test to work reliably.\n\n### curl/libcurl version\n\n8.7.0-DEV\n\n### operating system\n\nmacOS","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/12823/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/12823/timeline","performed_via_github_app":null,"state_reason":"completed"}