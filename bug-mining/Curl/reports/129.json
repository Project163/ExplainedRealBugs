{"url":"https://api.github.com/repos/curl/curl/issues/10148","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/10148/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/10148/comments","events_url":"https://api.github.com/repos/curl/curl/issues/10148/events","html_url":"https://github.com/curl/curl/issues/10148","id":1509118719,"node_id":"I_kwDOAAiu0c5Z81L_","number":10148,"title":"curl 7.87.0 breaks zabbix' use of curl_easy_setopt","user":{"login":"0-wiz-0","id":2221844,"node_id":"MDQ6VXNlcjIyMjE4NDQ=","avatar_url":"https://avatars.githubusercontent.com/u/2221844?v=4","gravatar_id":"","url":"https://api.github.com/users/0-wiz-0","html_url":"https://github.com/0-wiz-0","followers_url":"https://api.github.com/users/0-wiz-0/followers","following_url":"https://api.github.com/users/0-wiz-0/following{/other_user}","gists_url":"https://api.github.com/users/0-wiz-0/gists{/gist_id}","starred_url":"https://api.github.com/users/0-wiz-0/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/0-wiz-0/subscriptions","organizations_url":"https://api.github.com/users/0-wiz-0/orgs","repos_url":"https://api.github.com/users/0-wiz-0/repos","events_url":"https://api.github.com/users/0-wiz-0/events{/privacy}","received_events_url":"https://api.github.com/users/0-wiz-0/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118182,"node_id":"MDU6TGFiZWwxODQxMTgxODI=","url":"https://api.github.com/repos/curl/curl/labels/build","name":"build","color":"bfdadc","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-12-23T09:35:39Z","updated_at":"2022-12-26T09:05:31Z","closed_at":"2022-12-26T09:05:31Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!-- Only file bugs here! Ask questions on the mailing lists https://curl.se/mail/\r\n\r\n     SECURITY RELATED? Post it here: https://hackerone.com/curl\r\n\r\n     There are collections of known issues to be aware of:\r\n     https://curl.se/docs/knownbugs.html\r\n     https://curl.se/docs/todo.html       -->\r\n\r\n### I did this\r\nCompile zabbix-5.0.17 after updating curl from 7.86.0 to 7.87.0.\r\n\r\nzabbix uses the following piece of code to set options:\r\n```\r\n        if (CURLE_OK != (err = curl_easy_setopt(easyhandle, opt = CURLOPT_USERAGENT, \"Zabbix \" ZABBIX_VERSION)) ||\r\n                CURLE_OK != (err = curl_easy_setopt(easyhandle, opt = CURLOPT_URL, https_host)) ||\r\n                CURLE_OK != (err = curl_easy_setopt(easyhandle, opt = CURLOPT_PORT, (long)port)) ||\r\n                CURLE_OK != (err = curl_easy_setopt(easyhandle, opt = CURLOPT_NOBODY, 1L)) ||\r\n                CURLE_OK != (err = curl_easy_setopt(easyhandle, opt = CURLOPT_SSL_VERIFYPEER, 0L)) ||\r\n                CURLE_OK != (err = curl_easy_setopt(easyhandle, opt = CURLOPT_SSL_VERIFYHOST, 0L)) ||\r\n                CURLE_OK != (err = curl_easy_setopt(easyhandle, opt = CURLOPT_TIMEOUT, (long)timeout)))\r\n        {\r\n                zabbix_log(LOG_LEVEL_DEBUG, \"%s: could not set cURL option [%d]: %s\",\r\n                                __func__, (int)opt, curl_easy_strerror(err));\r\n                goto clean;\r\n        }\r\n```\r\ni.e. it sets a variable for the value it passes to have better error messages if one of them fails by using that variable, in a compact way.\r\n\r\nThis code broke with the recent deprecation macro changes. zabbix now fails to compile with:\r\n```\r\nIn file included from /home/pbulk/build/sysutils/zabbix50-agent/work/.buildlink/include/curl/curl.h:3195,\r\n                 from ../../../../include/sysinc.h:384,\r\n                 from ../../../../include/common.h:23,\r\n                 from simple.c:20:\r\nsimple.c: In function 'check_https':\r\nsimple.c:167:65: error: invalid use of void expression\r\n  167 |         if (CURLE_OK != (err = curl_easy_setopt(easyhandle, opt = CURLOPT_USERAGENT, \"Zabbix \" ZABBIX_VERSION)) ||\r\n      |                                                                 ^\r\n/home/pbulk/build/sysutils/zabbix50-agent/work/.buildlink/include/curl/typecheck-gcc.h:47:16: note: in definition of macro 'curl_easy_setopt'\r\n   47 |         (void) option;                                                  \\\r\n      |                ^~~~~~\r\nsimple.c:168:69: error: invalid use of void expression\r\n  168 |                 CURLE_OK != (err = curl_easy_setopt(easyhandle, opt = CURLOPT_URL, https_host)) ||\r\n      |                                                                     ^\r\n/home/pbulk/build/sysutils/zabbix50-agent/work/.buildlink/include/curl/typecheck-gcc.h:47:16: note: in definition of macro 'curl_easy_setopt'\r\n   47 |         (void) option;                                                  \\\r\n      |                ^~~~~~\r\nsimple.c:169:69: error: invalid use of void expression\r\n  169 |                 CURLE_OK != (err = curl_easy_setopt(easyhandle, opt = CURLOPT_PORT, (long)port)) ||\r\n      |                                                                     ^\r\n/home/pbulk/build/sysutils/zabbix50-agent/work/.buildlink/include/curl/typecheck-gcc.h:47:16: note: in definition of macro 'curl_easy_setopt'\r\n   47 |         (void) option;                                                  \\\r\n      |                ^~~~~~\r\nsimple.c:170:69: error: invalid use of void expression\r\n  170 |                 CURLE_OK != (err = curl_easy_setopt(easyhandle, opt = CURLOPT_NOBODY, 1L)) ||\r\n      |                                                                     ^\r\n/home/pbulk/build/sysutils/zabbix50-agent/work/.buildlink/include/curl/typecheck-gcc.h:47:16: note: in definition of macro 'curl_easy_setopt'\r\n   47 |         (void) option;                                                  \\\r\n      |                ^~~~~~\r\nsimple.c:171:69: error: invalid use of void expression\r\n  171 |                 CURLE_OK != (err = curl_easy_setopt(easyhandle, opt = CURLOPT_SSL_VERIFYPEER, 0L)) ||\r\n      |                                                                     ^\r\n/home/pbulk/build/sysutils/zabbix50-agent/work/.buildlink/include/curl/typecheck-gcc.h:47:16: note: in definition of macro 'curl_easy_setopt'\r\n   47 |         (void) option;                                                  \\\r\n      |                ^~~~~~\r\nsimple.c:172:69: error: invalid use of void expression\r\n  172 |                 CURLE_OK != (err = curl_easy_setopt(easyhandle, opt = CURLOPT_SSL_VERIFYHOST, 0L)) ||\r\n      |                                                                     ^\r\n/home/pbulk/build/sysutils/zabbix50-agent/work/.buildlink/include/curl/typecheck-gcc.h:47:16: note: in definition of macro 'curl_easy_setopt'\r\n   47 |         (void) option;                                                  \\\r\n      |                ^~~~~~\r\nsimple.c:173:69: error: invalid use of void expression\r\n  173 |                 CURLE_OK != (err = curl_easy_setopt(easyhandle, opt = CURLOPT_TIMEOUT, (long)timeout)))\r\n      |                                                                     ^\r\n/home/pbulk/build/sysutils/zabbix50-agent/work/.buildlink/include/curl/typecheck-gcc.h:47:16: note: in definition of macro 'curl_easy_setopt'\r\n   47 |         (void) option;                                                  \\\r\n      |                ^~~~~~\r\nsimple.c:182:73: error: invalid use of void expression\r\n  182 |                 if (CURLE_OK != (err = curl_easy_setopt(easyhandle, opt = CURLOPT_INTERFACE, CONFIG_SOURCE_IP)))\r\n      |                                                                         ^\r\n/home/pbulk/build/sysutils/zabbix50-agent/work/.buildlink/include/curl/typecheck-gcc.h:47:16: note: in definition of macro 'curl_easy_setopt'\r\n   47 |         (void) option;                                                  \\\r\n      |                ^~~~~~\r\n```\r\n\r\nPerhaps there's a way to write the deprecation macro that doesn't break zabbix' code?\r\n\r\n(My workaround was to remove the 'opt' assignments.)\r\n\r\n### I expected the following\r\nzabbix to still build.\r\n\r\n### curl/libcurl version\r\n\r\n```\r\n# curl -V\r\ncurl 7.87.0 (x86_64--netbsd) libcurl/7.87.0 OpenSSL/1.1.1n zlib/1.2.13 libidn2/2.3.4 nghttp2/1.51.0\r\nRelease-Date: 2022-12-21\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps mqtt pop3 pop3s rtsp smb smbs smtp smtps telnet tftp\r\nFeatures: alt-svc AsynchDNS GSS-API HSTS HTTP2 HTTPS-proxy IDN IPv6 Kerberos Largefile libz NTLM NTLM_WB SPNEGO SSL threadsafe TLS-SRP UnixSockets\r\n```\r\n\r\n### operating system\r\n\r\nNetBSD 9.99.106/amd64, but I don't think that's relevant here, this is with gcc 10.4.0 and will most probably happen on other platforms as well.","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/10148/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/10148/timeline","performed_via_github_app":null,"state_reason":"completed"}