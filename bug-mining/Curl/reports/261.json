{"url":"https://api.github.com/repos/curl/curl/issues/11357","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/11357/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/11357/comments","events_url":"https://api.github.com/repos/curl/curl/issues/11357/events","html_url":"https://github.com/curl/curl/issues/11357","id":1766956871,"node_id":"I_kwDOAAiu0c5pUZ9H","number":11357,"title":"HTTP/2 downgrade to HTTP/1.1 not working","user":{"login":"jay","id":965580,"node_id":"MDQ6VXNlcjk2NTU4MA==","avatar_url":"https://avatars.githubusercontent.com/u/965580?v=4","gravatar_id":"","url":"https://api.github.com/users/jay","html_url":"https://github.com/jay","followers_url":"https://api.github.com/users/jay/followers","following_url":"https://api.github.com/users/jay/following{/other_user}","gists_url":"https://api.github.com/users/jay/gists{/gist_id}","starred_url":"https://api.github.com/users/jay/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jay/subscriptions","organizations_url":"https://api.github.com/users/jay/orgs","repos_url":"https://api.github.com/users/jay/repos","events_url":"https://api.github.com/users/jay/events{/privacy}","received_events_url":"https://api.github.com/users/jay/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118197,"node_id":"MDU6TGFiZWwxODQxMTgxOTc=","url":"https://api.github.com/repos/curl/curl/labels/regression","name":"regression","color":"33aa3f","default":false,"description":null},{"id":194601710,"node_id":"MDU6TGFiZWwxOTQ2MDE3MTA=","url":"https://api.github.com/repos/curl/curl/labels/HTTP/2","name":"HTTP/2","color":"009800","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2023-06-21T07:41:06Z","updated_at":"2023-06-22T15:08:33Z","closed_at":"2023-06-22T15:08:33Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\r\n\r\nInvestigating #11034 which has a URL that when requested via HTTP/2 replies with RST_STREAM error HTTP_1_1_REQUIRED. libcurl should retry the transfer with HTTP/1.1 but doesn't. _(Note the reporter in that issue builds libcurl without HTTP/2 so it is an unrelated issue)._\r\n\r\n~~~\r\ncurld -v https://wsnfse.vitoria.es.gov.br/producao/NotaFiscalService.asmx?WSDL\r\n\r\n...\r\n* HTTP/2 stream 1 was reset\r\n* [CONN-0] readwrite_data() -> 56\r\n* [CONN-0] Curl_readwrite() -> 56\r\n* multi_done: status: 56 prem: 1 done: 0\r\n* Connection #0 to host wsnfse.vitoria.es.gov.br left intact\r\n* Expire cleared (transfer 0x526ee8)\r\ncurl: (56) HTTP/2 stream 1 was reset\r\n~~~\r\n\r\nBisected to cab2d56e @icing\r\n\r\nThat commit changes http2_handle_stream_close to return a generic error before checking for CURLE_HTTP2_STREAM, which means CURLE_HTTP2_STREAM is never returned, the error is no longer properly output in verbose mode as HTTP_1_1_REQUIRED, and later code in libcurl to handle the downgrade is never reached:\r\n\r\nhttps://github.com/curl/curl/blob/51f6a0dc1af2d597566d597695da54098b8e6119/lib/http2.c#L1579-L1598\r\n\r\nhttps://github.com/curl/curl/blob/51f6a0dc1af2d597566d597695da54098b8e6119/lib/multi.c#L2479-L2500\r\n\r\nIt's unclear to me why `else if(stream->reset)` block needs to come before. Changing it back works but I don't know why it was changed in the first place there may be a good reason.\r\n\r\n~~~diff\r\ndiff --git a/lib/http2.c b/lib/http2.c\r\nindex 9da3cae..0894561 100644\r\n--- a/lib/http2.c\r\n+++ b/lib/http2.c\r\n@@ -1523,22 +1523,22 @@ static ssize_t http2_handle_stream_close(struct Curl_cfilter *cf,\r\n     connclose(cf->conn, \"REFUSED_STREAM\"); /* don't use this anymore */\r\n     data->state.refused_stream = TRUE;\r\n     *err = CURLE_SEND_ERROR; /* trigger Curl_retry_request() later */\r\n     return -1;\r\n   }\r\n-  else if(stream->reset) {\r\n-    failf(data, \"HTTP/2 stream %u was reset\", stream->id);\r\n-    *err = stream->bodystarted? CURLE_PARTIAL_FILE : CURLE_RECV_ERROR;\r\n-    return -1;\r\n-  }\r\n   else if(stream->error != NGHTTP2_NO_ERROR) {\r\n     failf(data, \"HTTP/2 stream %u was not closed cleanly: %s (err %u)\",\r\n           stream->id, nghttp2_http2_strerror(stream->error),\r\n           stream->error);\r\n     *err = CURLE_HTTP2_STREAM;\r\n     return -1;\r\n   }\r\n+  else if(stream->reset) {\r\n+    failf(data, \"HTTP/2 stream %u was reset\", stream->id);\r\n+    *err = stream->bodystarted? CURLE_PARTIAL_FILE : CURLE_RECV_ERROR;\r\n+    return -1;\r\n+  }\r\n \r\n   if(!stream->bodystarted) {\r\n     failf(data, \"HTTP/2 stream %u was closed cleanly, but before getting \"\r\n           \" all response header fields, treated as error\",\r\n           stream->id);\r\n~~~\r\n\r\n\r\n/cc @icing\r\n\r\n","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/11357/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/11357/timeline","performed_via_github_app":null,"state_reason":"completed"}