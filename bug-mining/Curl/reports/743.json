{"url":"https://api.github.com/repos/curl/curl/issues/17471","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/17471/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/17471/comments","events_url":"https://api.github.com/repos/curl/curl/issues/17471/events","html_url":"https://github.com/curl/curl/issues/17471","id":3096468168,"node_id":"I_kwDOAAiu0c64kFrI","number":17471,"title":"\"OpenSSL SSL_read: SSL_ERROR_SYSCALL\" with OpenSSL â‰¥ 3.2 + old servers","user":{"login":"mkauf","id":12849992,"node_id":"MDQ6VXNlcjEyODQ5OTky","avatar_url":"https://avatars.githubusercontent.com/u/12849992?v=4","gravatar_id":"","url":"https://api.github.com/users/mkauf","html_url":"https://github.com/mkauf","followers_url":"https://api.github.com/users/mkauf/followers","following_url":"https://api.github.com/users/mkauf/following{/other_user}","gists_url":"https://api.github.com/users/mkauf/gists{/gist_id}","starred_url":"https://api.github.com/users/mkauf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mkauf/subscriptions","organizations_url":"https://api.github.com/users/mkauf/orgs","repos_url":"https://api.github.com/users/mkauf/repos","events_url":"https://api.github.com/users/mkauf/events{/privacy}","received_events_url":"https://api.github.com/users/mkauf/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118221,"node_id":"MDU6TGFiZWwxODQxMTgyMjE=","url":"https://api.github.com/repos/curl/curl/labels/TLS","name":"TLS","color":"bfdadc","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":15,"created_at":"2025-05-28T08:13:36Z","updated_at":"2025-06-11T08:45:14Z","closed_at":"2025-06-11T08:45:14Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nWhen using a server that does not shut down the SSL connection properly (no \"close notify\"), depending on the OpenSSL version, curl reports an error when closing the connection. The problem has started to appear with OpenSSL 3.2.0 and is also present with OpenSSL 3.5.0.\n\nI'm not sure whether this is a bug in curl or in OpenSSL. With `git bisect` I have found this OpenSSL commit: https://github.com/openssl/openssl/commit/e2d5742b1460c45bf39094ea08e4e85a8f507ea8\n\n**How to reproduce**\n\nThe server is an `openssl s_server` 1.1.1 (or 1.0.2, same result). It does not send a \"close notify\" when closing the connection.\n\nCreate a certificate:\n```\nopenssl genrsa -out server.key.pem 2048\nopenssl req -new -x509 -key server.key.pem -out server.crt.pem -days 365\n```\nStart `openssl s_server`:\n```\nopenssl s_server -cert server.crt.pem -key server.key.pem -accept 8443 -www\n```\n\nWith OpenSSL 3.0.16 + curl master (or curl 8.13.0, same result):\n```\n</BODY></HTML>\n\n* shutting down connection #0\n```\n\nWith OpenSSL 3.5.0 + curl master (or curl 8.13.0, same result):\n```\ncurl -k -v https://localhost:8443/\n...\n</BODY></HTML>\n\n* OpenSSL SSL_read: SSL_ERROR_SYSCALL, errno 0\n* closing connection #0\ncurl: (56) OpenSSL SSL_read: SSL_ERROR_SYSCALL, errno 0\n```\n\nSo no error is reported with OpenSSL 3.0 but an error is reported with OpenSSL 3.5.\n\n**Notes about the flag `SSL_OP_IGNORE_UNEXPECTED_EOF`**\n\nI have tried to set the OpenSSL flag `SSL_OP_IGNORE_UNEXPECTED_EOF` but the result is the same:\n```\ndiff --git a/lib/vtls/openssl.c b/lib/vtls/openssl.c\nindex ffdae2399..f21f6140c 100644\n--- a/lib/vtls/openssl.c\n+++ b/lib/vtls/openssl.c\n@@ -4109,6 +4109,7 @@ CURLcode Curl_ossl_ctx_init(struct ossl_ctx *octx,\n     return CURLE_SSL_CONNECT_ERROR;\n   }\n \n+  ctx_options |= SSL_OP_IGNORE_UNEXPECTED_EOF;\n   SSL_CTX_set_options(octx->ssl_ctx, ctx_options);\n \n #ifdef SSL_MODE_ACCEPT_MOVING_WRITE_BUFFER\n```\n\nFor `openssl s_client`, the flag `-ignore_unexpected_eof` works:\n```\nopenssl s_client -crlf -ignore_unexpected_eof -connect localhost:8443\nGET / HTTP/1.0\n...\nclosed\n```\n\nIt's strange that the flag works for `openssl s_client` but does not work for curl.\n\n### I expected the following\n\ncurl should not report an error with OpenSSL 3.5.0 + old servers, or there should be a way to ignore the error, e.g. with the OpenSSL flag `SSL_OP_IGNORE_UNEXPECTED_EOF`\n\n### curl/libcurl version\n\ncurl 8.14.0-DEV (x86_64-pc-linux-gnu) libcurl/8.14.0-DEV OpenSSL/3.2.4 zlib/1.3.1.zlib-ng nghttp2/1.64.0\nRelease-Date: [unreleased]\nProtocols: dict file ftp ftps gopher gophers http https imap imaps ipfs ipns mqtt pop3 pop3s rtsp smb smbs smtp smtps telnet tftp ws wss\nFeatures: alt-svc AsynchDNS HSTS HTTP2 HTTPS-proxy IPv6 Largefile libz NTLM SSL threadsafe TLS-SRP UnixSockets\n\n### operating system\n\nFedora Linux 42","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/17471/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/17471/timeline","performed_via_github_app":null,"state_reason":"completed"}