{"url":"https://api.github.com/repos/curl/curl/issues/17371","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/17371/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/17371/comments","events_url":"https://api.github.com/repos/curl/curl/issues/17371/events","html_url":"https://github.com/curl/curl/issues/17371","id":3069252336,"node_id":"I_kwDOAAiu0c628RLw","number":17371,"title":"curl --retry N -o /dev/null will not retry properly if there is a response body","user":{"login":"moyix","id":34380,"node_id":"MDQ6VXNlcjM0Mzgw","avatar_url":"https://avatars.githubusercontent.com/u/34380?v=4","gravatar_id":"","url":"https://api.github.com/users/moyix","html_url":"https://github.com/moyix","followers_url":"https://api.github.com/users/moyix/followers","following_url":"https://api.github.com/users/moyix/following{/other_user}","gists_url":"https://api.github.com/users/moyix/gists{/gist_id}","starred_url":"https://api.github.com/users/moyix/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/moyix/subscriptions","organizations_url":"https://api.github.com/users/moyix/orgs","repos_url":"https://api.github.com/users/moyix/repos","events_url":"https://api.github.com/users/moyix/events{/privacy}","received_events_url":"https://api.github.com/users/moyix/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":192912238,"node_id":"MDU6TGFiZWwxOTI5MTIyMzg=","url":"https://api.github.com/repos/curl/curl/labels/cmdline%20tool","name":"cmdline tool","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":1,"created_at":"2025-05-16T15:02:04Z","updated_at":"2025-05-19T07:43:13Z","closed_at":"2025-05-19T07:43:13Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nOn Linux, while implementing a health check, we did:\n\n```\ncurl --retry 2 http://127.0.0.1:8000 -o /dev/null\n```\n\nHowever, the server responded with a 503 and a response body. This led curl to try to call `ftruncate` on the output file (so that a bad response wouldn't be written to the output), but since `/dev/null` does not support `ftruncate` the call failed with `EINVAL` and curl exited with code 23 instead of retrying.\n\nRelevant code:\nhttps://github.com/curl/curl/blob/f97d372703a08d2690b75e5f016fb7b19f109e86/src/tool_operate.c#L598-L608\n\nFull repro script:\n```bash\n#!/bin/sh\n\n# Start a server that just returns a 503 with a body that says \"Not working right now\"\npython << 'EOF' &\nfrom http.server import HTTPServer, BaseHTTPRequestHandler\n\nclass ServiceUnavailableHandler(BaseHTTPRequestHandler):\n    def do_GET(self):\n        self.send_response(503)\n        self.send_header('Content-type', 'text/plain')\n        self.end_headers()\n        self.wfile.write(b\"Not working right now\\n\")\n\nif __name__ == '__main__':\n    server_address = ('', 8000)\n    httpd = HTTPServer(server_address, ServiceUnavailableHandler)\n    httpd.serve_forever()\nEOF\n\nPID=$!\ntrap 'kill $PID' EXIT\n\n# Wait for the server to start\nsleep .5\n\n# Make a request that will be retried. The initial request fails,\n# but curl does not retry properly because the body has been written\n# to /dev/null, which causes curl to call ftruncate on the file. But\n# on Linux ftruncate fails with EINVAL because the file is not a regular\n# file and so curl exits with code 23 instead of retrying.\ncurl --retry 2 http://127.0.0.1:8000 -o /dev/null\n```\n\n### I expected the following\n\nIf being able to seek/truncate the output file is a requirement, curl should fail early if given an output file that is not a regular file.\n\n### curl/libcurl version\n\n```\ncurl 8.5.0 (x86_64-pc-linux-gnu) libcurl/8.5.0 OpenSSL/3.0.13 zlib/1.3 brotli/1.1.0 zstd/1.5.5 libidn2/2.3.7 libpsl/0.21.2 (+libidn2/2.3.7) libssh/0.10.6/openssl/zlib nghttp2/1.59.0 librtmp/2.3 OpenLDAP/2.6.7\nRelease-Date: 2023-12-06, security patched: 8.5.0-2ubuntu10.6\nProtocols: dict file ftp ftps gopher gophers http https imap imaps ldap ldaps mqtt pop3 pop3s rtmp rtsp scp sftp smb smbs smtp smtps telnet tftp\nFeatures: alt-svc AsynchDNS brotli GSS-API HSTS HTTP2 HTTPS-proxy IDN IPv6 Kerberos Largefile libz NTLM PSL SPNEGO SSL threadsafe TLS-SRP UnixSockets zstd\n```\n\n### operating system\n\n```\nLinux 3b31693121c6 6.10.14-linuxkit #1 SMP Thu Mar 20 16:32:56 UTC 2025 x86_64 x86_64 x86_64 GNU/Linux\n```","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/17371/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/17371/timeline","performed_via_github_app":null,"state_reason":"completed"}