{"url":"https://api.github.com/repos/curl/curl/issues/18206","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/18206/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/18206/comments","events_url":"https://api.github.com/repos/curl/curl/issues/18206/events","html_url":"https://github.com/curl/curl/issues/18206","id":3296610011,"node_id":"I_kwDOAAiu0c7Efkbb","number":18206,"title":"curl_easy_reset() does not reset rewind failure","user":{"login":"oxan","id":197154,"node_id":"MDQ6VXNlcjE5NzE1NA==","avatar_url":"https://avatars.githubusercontent.com/u/197154?v=4","gravatar_id":"","url":"https://api.github.com/users/oxan","html_url":"https://github.com/oxan","followers_url":"https://api.github.com/users/oxan/followers","following_url":"https://api.github.com/users/oxan/following{/other_user}","gists_url":"https://api.github.com/users/oxan/gists{/gist_id}","starred_url":"https://api.github.com/users/oxan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/oxan/subscriptions","organizations_url":"https://api.github.com/users/oxan/orgs","repos_url":"https://api.github.com/users/oxan/repos","events_url":"https://api.github.com/users/oxan/events{/privacy}","received_events_url":"https://api.github.com/users/oxan/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1117926199,"node_id":"MDU6TGFiZWwxMTE3OTI2MTk5","url":"https://api.github.com/repos/curl/curl/labels/libcurl%20API","name":"libcurl API","color":"fef2c0","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":3,"created_at":"2025-08-06T12:56:34Z","updated_at":"2025-08-06T15:58:57Z","closed_at":"2025-08-06T15:58:57Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nWe're experiencing the following sequence of events:\n1. We perform a request that fails with `CURLE_SEND_FAIL_REWIND` (errno 65).\n2. We reset the handle using `curl_easy_reset()`.\n3. We perform another request, which immediately returns with the same `CURLE_SEND_FAIL_REWIND` error, before curl has even tried to connect. \n\nWe would expect that the `curl_easy_reset()` call would completely reset the handle, clearing the rewind failure on the request, so that subsequent requests using this handle work. I've created a failing [testcase](https://github.com/oxan/curl/compare/master...reset-on-retry-failure) that reproduces this behaviour.\n\nFor the request in the first step, we're using the `CURLOPT_UPLOAD` option, and to supply the request body we have set `CURLOPT_READFUNCTION` but *not* `CURLOPT_SEEKFUNCTION` (this is due to `ext-curl` in PHP, which always sets the read function but doesn't support setting the seek function). We have enabled following redirects on this request using `CURLOPT_FOLLOWLOCATION`, and the server returns a HTTP 307 redirect. In this situation, it makes total sense that curl can't rewind the body to follow the redirect and returns a `CURLE_SEND_FAIL_REWIND` - that's not the bug.\n\nNext, we call `curl_easy_reset()` to reset the handle. According to the documentation, this should bring the handle to the same state as when it was just created with `curl_easy_init()`. To validate this is a problem with `curl_easy_reset()`, we've tried replacing this call with a new call to `curl_easy_init()`, and that fixes the problem.\n\nIt doesn't matter what kind of request the request in the third step is: a GET will fail, as will a request using `CURLOPT_POSTFIELDS` or `CURLOPT_READFUNCTION`.\n\nI tried to debug this a little bit, and I can confirm that adding `req->rewind_read = FALSE;` (like [this](https://github.com/oxan/curl/commit/66c0131a4341fcba98ee6e3cc61312874f535d43)) in `Curl_req_hard_reset()` fixes the problem. However, I'm not familiar enough with the curl code to say whether this is the best way to fix this, and whether this wouldn't break other scenarios. I'm happy to submit a PR with this change and the testcase if you agree this is the way to go.\n\n### I expected the following\n\nSee above - for the curl handle to be usable for a second request again after a `CURLE_SEND_FAIL_REWIND` error.\n\n### curl/libcurl version\n\nReproduced both on curl v8.14.1 and latest master (commit 034612cd515f).\n\n### operating system\n\n```\nLinux L-F4FWVJ 6.8.0-71-generic #71-Ubuntu SMP PREEMPT_DYNAMIC Tue Jul 22 16:52:38 UTC 2025 x86_64 x86_64 x86_64 GNU/Linux\n```\n\nAlso reproducable using the curl inside Alpine v3.22 Docker containers.","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/18206/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/18206/timeline","performed_via_github_app":null,"state_reason":"completed"}