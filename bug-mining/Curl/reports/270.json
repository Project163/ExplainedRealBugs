{"url":"https://api.github.com/repos/curl/curl/issues/11431","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/11431/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/11431/comments","events_url":"https://api.github.com/repos/curl/curl/issues/11431/events","html_url":"https://github.com/curl/curl/issues/11431","id":1801454302,"node_id":"I_kwDOAAiu0c5rYALe","number":11431,"title":"Regression on parsing large config files","user":{"login":"aduh95","id":14309773,"node_id":"MDQ6VXNlcjE0MzA5Nzcz","avatar_url":"https://avatars.githubusercontent.com/u/14309773?v=4","gravatar_id":"","url":"https://api.github.com/users/aduh95","html_url":"https://github.com/aduh95","followers_url":"https://api.github.com/users/aduh95/followers","following_url":"https://api.github.com/users/aduh95/following{/other_user}","gists_url":"https://api.github.com/users/aduh95/gists{/gist_id}","starred_url":"https://api.github.com/users/aduh95/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aduh95/subscriptions","organizations_url":"https://api.github.com/users/aduh95/orgs","repos_url":"https://api.github.com/users/aduh95/repos","events_url":"https://api.github.com/users/aduh95/events{/privacy}","received_events_url":"https://api.github.com/users/aduh95/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118197,"node_id":"MDU6TGFiZWwxODQxMTgxOTc=","url":"https://api.github.com/repos/curl/curl/labels/regression","name":"regression","color":"33aa3f","default":false,"description":null},{"id":192912238,"node_id":"MDU6TGFiZWwxOTI5MTIyMzg=","url":"https://api.github.com/repos/curl/curl/labels/cmdline%20tool","name":"cmdline tool","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":5,"created_at":"2023-07-12T17:39:44Z","updated_at":"2023-07-13T22:01:31Z","closed_at":"2023-07-13T13:17:03Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!-- Only file bugs here! Ask questions on the mailing lists https://curl.se/mail/\r\n\r\n     SECURITY RELATED? Post it here: https://hackerone.com/curl\r\n\r\n     There are collections of known issues to be aware of:\r\n     https://curl.se/docs/knownbugs.html\r\n     https://curl.se/docs/todo.html       -->\r\n\r\n### I did this\r\n\r\nWe noticed the issue as sometimes requests with very large payload were failing on production when trying to bump the cURL version. I was able to create a minimal repro using a Node.js script:\r\n\r\n```js\r\nimport assert from 'node:assert'\r\nimport http from 'node:http'\r\nimport child_process from 'node:child_process'\r\n\r\nconst server = http\r\n  .createServer((req, res) => {\r\n    const { url, method } = req\r\n    console.log({ url, method })\r\n    let length = 0\r\n    req.on('data', (chunk) => {\r\n      length += chunk.length\r\n      for (let i = 0; i < chunk.length; i++) {\r\n        assert.strictEqual(chunk[i], 97)\r\n      }\r\n    })\r\n    req.on('close', () => {\r\n      assert.strictEqual(length, 0x400 * 99 + 1014)\r\n      res.writeHead(200, { 'Content-Type': 'text/plain' })\r\n      res.end('sure\\n')\r\n    })\r\n  })\r\n  .listen(8080)\r\n  .unref()\r\n\r\nawait new Promise((resolve, reject) => {\r\n  const cp = child_process.spawn('curl', ['--config', '-', 'http://[::1]:8080'])\r\n\r\n  cp.on('exit', (code) => (code === 0 ? resolve() : reject(code)))\r\n\r\n  cp.stdin.write('data = \"')\r\n  for (let j = 0; j < 99; j++) cp.stdin.write('a'.repeat(0x400))\r\n  cp.stdin.write('a'.repeat(1014)) // When I pass 1013 here, everything works on all versions.\r\n  cp.stdin.end('\"\\n')\r\n})\r\n```\r\n\r\nThe failure seems to appear as soon as the config file is strictly larger than 102399 bytes (≥100kiB), at which point curl ignores the data and sends an empty GET request instead of a POST request with the payload.\r\n\r\n### I expected the following\r\n\r\nPasses on 7.72.0:\r\n\r\n```console\r\n$ curl --version\r\ncurl 7.72.0 (aarch64-unknown-linux-gnu) libcurl/7.72.0 OpenSSL/1.0.2l zlib/1.2.11 c-ares/1.13.0 libssh2/1.8.0 nghttp2/1.20.0\r\nRelease-Date: 2020-08-19\r\nProtocols: dict file ftp ftps gopher http https imap imaps pop3 pop3s rtsp scp sftp smb smbs smtp smtps telnet tftp\r\nFeatures: AsynchDNS HTTP2 HTTPS-proxy IPv6 Largefile libz NTLM NTLM_WB SSL TLS-SRP UnixSockets\r\n$ node repro.mjs\r\n{ url: '/', method: 'POST' }\r\n```\r\n\r\nStarting from 7.73.0 and up (I didn't try all versions, only a few up to 8.1.1):\r\n\r\n```console\r\n$ curl --version\r\ncurl 7.73.0 (aarch64-unknown-linux-gnu) libcurl/7.73.0 OpenSSL/1.0.2l zlib/1.2.11 c-ares/1.13.0 libssh2/1.8.0 nghttp2/1.20.0\r\nRelease-Date: 2020-10-14\r\nProtocols: dict file ftp ftps gopher http https imap imaps mqtt pop3 pop3s rtsp scp sftp smb smbs smtp smtps telnet tftp\r\nFeatures: AsynchDNS HTTP2 HTTPS-proxy IPv6 Largefile libz NTLM NTLM_WB SSL TLS-SRP UnixSockets\r\n$ node repro.mjs\r\n{ url: '/', method: 'GET' }\r\nnode:assert:124\r\n  throw new AssertionError(obj);\r\n  ^\r\n\r\nAssertionError [ERR_ASSERTION]: Expected values to be strictly equal:\r\n\r\n0 !== 102390\r\n…\r\n```\r\n\r\nTried with cURL 8.1.1 on macOS, the failure is a bit different – but I would still expect the code to succeed:\r\n\r\n```console\r\n$ curl --version\r\ncurl 8.1.1 (aarch64-apple-darwin22.3.0) libcurl/8.1.1 OpenSSL/3.0.9 zlib/1.2.13 brotli/1.0.9 zstd/1.5.5 libidn2/2.3.4 libssh2/1.11.0 nghttp2/1.51.0\r\nRelease-Date: 2023-05-23\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps mqtt pop3 pop3s rtsp scp sftp smb smbs smtp smtps telnet tftp\r\nFeatures: alt-svc AsynchDNS brotli GSS-API HSTS HTTP2 HTTPS-proxy IDN IPv6 Kerberos Largefile libz NTLM NTLM_WB SPNEGO SSL threadsafe TLS-SRP UnixSockets zstd\r\n$ node repro.mjs\r\nError: \"curl --config -\" exited with code 26\r\n```\r\n\r\n### curl/libcurl version\r\n\r\nSee above.\r\n\r\nhttps://github.com/curl/curl/compare/curl-7_72_0..curl-7_73_0\r\n\r\n### operating system\r\n\r\n<!-- On Unix please post the output of \"uname -a\" -->\r\nBisected on Ubuntu to pin point which version introduced the regression. I was able to reproduce on macOS with cURL v8.1.1 as well\r\n","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/11431/reactions","total_count":2,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":2,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/11431/timeline","performed_via_github_app":null,"state_reason":"completed"}