{"url":"https://api.github.com/repos/curl/curl/issues/17621","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/17621/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/17621/comments","events_url":"https://api.github.com/repos/curl/curl/issues/17621/events","html_url":"https://github.com/curl/curl/issues/17621","id":3146647221,"node_id":"I_kwDOAAiu0c67jga1","number":17621,"title":"curl_easy_perform() waits full response with CURLOPT_CONNECT_ONLY enabled","user":{"login":"KirillObukhov","id":1196665,"node_id":"MDQ6VXNlcjExOTY2NjU=","avatar_url":"https://avatars.githubusercontent.com/u/1196665?v=4","gravatar_id":"","url":"https://api.github.com/users/KirillObukhov","html_url":"https://github.com/KirillObukhov","followers_url":"https://api.github.com/users/KirillObukhov/followers","following_url":"https://api.github.com/users/KirillObukhov/following{/other_user}","gists_url":"https://api.github.com/users/KirillObukhov/gists{/gist_id}","starred_url":"https://api.github.com/users/KirillObukhov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/KirillObukhov/subscriptions","organizations_url":"https://api.github.com/users/KirillObukhov/orgs","repos_url":"https://api.github.com/users/KirillObukhov/repos","events_url":"https://api.github.com/users/KirillObukhov/events{/privacy}","received_events_url":"https://api.github.com/users/KirillObukhov/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1117926199,"node_id":"MDU6TGFiZWwxMTE3OTI2MTk5","url":"https://api.github.com/repos/curl/curl/labels/libcurl%20API","name":"libcurl API","color":"fef2c0","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2025-06-14T19:39:15Z","updated_at":"2025-06-20T21:24:48Z","closed_at":"2025-06-20T21:24:48Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nI'm trying to receive Server-Sent Events using libcurl. I've found [CURLOPT_CONNECT_ONLY](https://curl.se/libcurl/c/CURLOPT_CONNECT_ONLY.html) option which\n> can be set to '2' and if HTTP or WebSocket are used, libcurl performs the request and reads all response headers before handing over control to the application\n\nbut `curl_easy_perform()` call blocks while connection alive.\n\nFor demonstration, I have attached a simple server and client applications.\n[demo.zip](https://github.com/user-attachments/files/20740975/demo.zip)\n\nThe server (Kotlin) sends 5 messages every 3 seconds and terminates the connection.\n```\n           sse {\n                repeat(5) {\n                    delay(3.seconds)\n                    send(LocalTime.now().toString())\n                }\n            }\n```\n\nThe client (C) connects to the server, exchange HTTP headers, report the execution time and should exit without waiting events.\n```\n  CURL *curl = curl_easy_init();\n  if (!curl)\n    goto cleanup;\n  if (curl_easy_setopt(curl, CURLOPT_URL, \"http://localhost:8080\"))\n    goto cleanup;\n  if (curl_easy_setopt(curl, CURLOPT_CONNECT_ONLY, 2L))\n    goto cleanup;\n\n  time_t start_time = time(NULL);\n  if (curl_easy_perform(curl))\n    goto cleanup;\n  time_t end_time = time(NULL);\n\n  double duration = difftime(end_time, start_time);\n  printf(\"perform takes %.2f seconds\\n\", duration);\n```\nbut outputs\n>perform takes 15.00 seconds\n\n\nHow-to build & run server:\n```\ncd server\ngradle build\ncd build/distributions\ntar -xf server.tar\n./server/bin/server\n```\n\ncurl -v http://localhost:8080\n```\n* Host localhost:8080 was resolved.\n* IPv6: ::1\n* IPv4: 127.0.0.1\n*   Trying [::1]:8080...\n* Connected to localhost (::1) port 8080\n* using HTTP/1.x\n> GET / HTTP/1.1\n> Host: localhost:8080\n> User-Agent: curl/8.12.1\n> Accept: */*\n> \n* Request completely sent off\n< HTTP/1.1 200 OK\n< Content-Type: text/event-stream\n< Cache-Control: no-store\n< Connection: keep-alive\n< X-Accel-Buffering: no\n< Transfer-Encoding: chunked\n< \ndata: 22:22:18.489580323\n\ndata: 22:22:21.490710433\n\ndata: 22:22:24.491684059\n\ndata: 22:22:27.492930039\n\ndata: 22:22:30.494157034\n\n* Connection #0 to host localhost left intact\n```\n\n### I expected the following\n\n_No response_\n\n### curl/libcurl version\n\n> curl 8.12.1 (x86_64-pc-linux-gnu) libcurl/8.12.1 OpenSSL/3.4.1 zlib/1.3.1 brotli/1.1.0 zstd/1.5.6 libidn2/2.3.8 libpsl/0.21.2 libssh2/1.11.1 nghttp2/1.64.0 librtmp/2.3 OpenLDAP/2.6.9\n> Release-Date: 2025-02-13, security patched: 8.12.1-3ubuntu1\n> Protocols: dict file ftp ftps gopher gophers http https imap imaps ipfs ipns ldap ldaps mqtt pop3 pop3s rtmp rtsp scp sftp smb smbs smtp smtps telnet tftp ws wss\n> Features: alt-svc AsynchDNS brotli GSS-API HSTS HTTP2 HTTPS-proxy IDN IPv6 Kerberos Largefile libz NTLM PSL SPNEGO SSL threadsafe TLS-SRP UnixSockets zstd\n\n### operating system\n\n> Linux lpc 6.14.0-15-generic #15-Ubuntu SMP PREEMPT_DYNAMIC Sun Apr  6 15:05:05 UTC 2025 x86_64 x86_64 x86_64 GNU/Linux","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/17621/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/17621/timeline","performed_via_github_app":null,"state_reason":"completed"}