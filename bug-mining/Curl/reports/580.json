{"url":"https://api.github.com/repos/curl/curl/issues/15500","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/15500/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/15500/comments","events_url":"https://api.github.com/repos/curl/curl/issues/15500/events","html_url":"https://github.com/curl/curl/issues/15500","id":2638812036,"node_id":"I_kwDOAAiu0c6dSROE","number":15500,"title":"Curl should make sure mbedtls having threading support","user":{"login":"wxiaoguang","id":2114189,"node_id":"MDQ6VXNlcjIxMTQxODk=","avatar_url":"https://avatars.githubusercontent.com/u/2114189?v=4","gravatar_id":"","url":"https://api.github.com/users/wxiaoguang","html_url":"https://github.com/wxiaoguang","followers_url":"https://api.github.com/users/wxiaoguang/followers","following_url":"https://api.github.com/users/wxiaoguang/following{/other_user}","gists_url":"https://api.github.com/users/wxiaoguang/gists{/gist_id}","starred_url":"https://api.github.com/users/wxiaoguang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wxiaoguang/subscriptions","organizations_url":"https://api.github.com/users/wxiaoguang/orgs","repos_url":"https://api.github.com/users/wxiaoguang/repos","events_url":"https://api.github.com/users/wxiaoguang/events{/privacy}","received_events_url":"https://api.github.com/users/wxiaoguang/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118221,"node_id":"MDU6TGFiZWwxODQxMTgyMjE=","url":"https://api.github.com/repos/curl/curl/labels/TLS","name":"TLS","color":"bfdadc","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":2,"created_at":"2024-11-06T17:48:38Z","updated_at":"2024-11-07T13:05:31Z","closed_at":"2024-11-07T12:14:56Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"When building libcurl with mbedtls, by default the mbedtls library doesn't enable its `MBEDTLS_THREADING_C`.\r\n\r\nHowever, according to https://mbed-tls.readthedocs.io/en/latest/kb/development/thread-safety-and-multi-threading/#thread-safety , mbedtls PSA is not thread-safe.\r\n\r\nAnd it seems that `THREADING_SUPPORT` in `vtls/mbedtls.c` doesn't really help, the concurrency crash still occurs in mbedtls library when using libcurl+mbedtls in a multiple-thread program without MBEDTLS_THREADING_C\r\n\r\nSo maybe it's good to require `defined(MBEDTLS_THREADING_C)` in curl's `vtls/mbedtls.c` when there is threading support?\r\n\r\nOr at least, `psa_crypto_init` should be protected by the mutex? Actually I am not sure whether it is enough, I think requiring  `defined(MBEDTLS_THREADING_C)` is the best approach.\r\n\r\nSome related crash stacks:\r\n\r\n<details>\r\n\r\n```\r\n0   libsystem_kernel.dylib        \t0x00000001d24c02ec __pthread_kill + 8 (:-1)\r\n1   libsystem_pthread.dylib       \t0x00000001e62b3c0c pthread_kill + 268 (pthread.c:1721)\r\n2   libsystem_c.dylib             \t0x00000001917bfba0 abort + 180 (abort.c:118)\r\n3   libsystem_malloc.dylib        \t0x0000000199a03588 malloc_vreport + 896 (malloc_printf.c:251)\r\n4   libsystem_malloc.dylib        \t0x0000000199a031f8 malloc_report + 64 (malloc_printf.c:290)\r\n5   libsystem_malloc.dylib        \t0x0000000199a027b0 find_zone_and_free + 528 (malloc.c:2793)\r\n6   xxxxxxxxxxxxxxx              \t0x000000010287b200 mbedtls_md_free + 296\r\n7   xxxxxxxxxxxxxxx              \t0x0000000102875504 mbedtls_entropy_func + 520\r\n8   xxxxxxxxxxxxxxx              \t0x00000001028616c0 mbedtls_ctr_drbg_reseed_internal + 248\r\n9   xxxxxxxxxxxxxxx              \t0x000000010286197c mbedtls_ctr_drbg_seed + 272\r\n10  xxxxxxxxxxxxxxx              \t0x000000010289424c mbedtls_psa_drbg_seed + 56\r\n11  xxxxxxxxxxxxxxx              \t0x00000001028941d8 mbedtls_psa_random_seed + 60\r\n12  xxxxxxxxxxxxxxx              \t0x000000010288f4b8 mbedtls_psa_crypto_init_subsystem + 300\r\n13  xxxxxxxxxxxxxxx              \t0x000000010288f2bc psa_crypto_init + 120\r\n14  xxxxxxxxxxxxxxx              \t0x00000001027dc484 mbed_connect_step1 + 392\r\n15  xxxxxxxxxxxxxxx              \t0x00000001027dbfd8 mbed_connect_common + 224\r\n16  xxxxxxxxxxxxxxx              \t0x00000001027db814 mbedtls_connect_nonblocking + 48\r\n17  xxxxxxxxxxxxxxx              \t0x00000001027e47dc ssl_connect_nonblocking + 80\r\n18  xxxxxxxxxxxxxxx              \t0x00000001027e2dd0 ssl_cf_connect + 696\r\n19  xxxxxxxxxxxxxxx              \t0x0000000102767920 Curl_conn_cf_connect + 92\r\n20  xxxxxxxxxxxxxxx              \t0x000000010276e874 cf_setup_connect + 188\r\n21  xxxxxxxxxxxxxxx              \t0x0000000102767920 Curl_conn_cf_connect + 92\r\n22  xxxxxxxxxxxxxxx              \t0x00000001027612dc cf_hc_baller_connect + 84\r\n23  xxxxxxxxxxxxxxx              \t0x000000010275ffcc cf_hc_connect + 1084\r\n24  xxxxxxxxxxxxxxx              \t0x0000000102767bf0 Curl_conn_connect + 312\r\n25  xxxxxxxxxxxxxxx              \t0x00000001027a8888 multi_runsingle + 1820\r\n26  xxxxxxxxxxxxxxx              \t0x00000001027a7f34 curl_multi_perform + 280\r\n27  xxxxxxxxxxxxxxx              \t0x000000010278201c easy_transfer + 148\r\n28  xxxxxxxxxxxxxxx              \t0x0000000102781e64 easy_perform + 496\r\n29  xxxxxxxxxxxxxxx              \t0x0000000102781c68 curl_easy_perform + 32\r\n\r\n\r\n0   xxxxxxxxxxxxxxx              \t0x000000010489ff64 mbedtls_sha512_update + 64\r\n1   xxxxxxxxxxxxxxx              \t0x000000010486bbd0 mbedtls_md_update + 332\r\n2   xxxxxxxxxxxxxxx              \t0x0000000104865078 entropy_update + 320\r\n3   xxxxxxxxxxxxxxx              \t0x0000000104865224 entropy_gather_internal + 308\r\n4   xxxxxxxxxxxxxxx              \t0x0000000104865384 mbedtls_entropy_func + 136\r\n5   xxxxxxxxxxxxxxx              \t0x00000001048516c0 mbedtls_ctr_drbg_reseed_internal + 248\r\n6   xxxxxxxxxxxxxxx              \t0x000000010485197c mbedtls_ctr_drbg_seed + 272\r\n7   xxxxxxxxxxxxxxx              \t0x000000010488424c mbedtls_psa_drbg_seed + 56\r\n8   xxxxxxxxxxxxxxx              \t0x00000001048841d8 mbedtls_psa_random_seed + 60\r\n9   xxxxxxxxxxxxxxx              \t0x000000010487f4b8 mbedtls_psa_crypto_init_subsystem + 300\r\n10  xxxxxxxxxxxxxxx              \t0x000000010487f2bc psa_crypto_init + 120\r\n11  xxxxxxxxxxxxxxx              \t0x00000001047cc484 mbed_connect_step1 + 392\r\n12  xxxxxxxxxxxxxxx              \t0x00000001047cbfd8 mbed_connect_common + 224\r\n13  xxxxxxxxxxxxxxx              \t0x00000001047cb814 mbedtls_connect_nonblocking + 48\r\n14  xxxxxxxxxxxxxxx              \t0x00000001047d47dc ssl_connect_nonblocking + 80\r\n15  xxxxxxxxxxxxxxx              \t0x00000001047d2dd0 ssl_cf_connect + 696\r\n16  xxxxxxxxxxxxxxx              \t0x0000000104757920 Curl_conn_cf_connect + 92\r\n17  xxxxxxxxxxxxxxx              \t0x000000010475e874 cf_setup_connect + 188\r\n18  xxxxxxxxxxxxxxx              \t0x0000000104757920 Curl_conn_cf_connect + 92\r\n19  xxxxxxxxxxxxxxx              \t0x00000001047512dc cf_hc_baller_connect + 84\r\n20  xxxxxxxxxxxxxxx              \t0x000000010474ffcc cf_hc_connect + 1084\r\n21  xxxxxxxxxxxxxxx              \t0x0000000104757bf0 Curl_conn_connect + 312\r\n22  xxxxxxxxxxxxxxx              \t0x0000000104798888 multi_runsingle + 1820\r\n23  xxxxxxxxxxxxxxx              \t0x0000000104797f34 curl_multi_perform + 280\r\n24  xxxxxxxxxxxxxxx              \t0x000000010477201c easy_transfer + 148\r\n25  xxxxxxxxxxxxxxx              \t0x0000000104771e64 easy_perform + 496\r\n26  xxxxxxxxxxxxxxx              \t0x0000000104771c68 curl_easy_perform + 32\r\n```\r\n</details>","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/15500/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/15500/timeline","performed_via_github_app":null,"state_reason":"completed"}