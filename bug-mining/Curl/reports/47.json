{"url":"https://api.github.com/repos/curl/curl/issues/9274","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/9274/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/9274/comments","events_url":"https://api.github.com/repos/curl/curl/issues/9274/events","html_url":"https://github.com/curl/curl/issues/9274","id":1331446497,"node_id":"I_kwDOAAiu0c5PXELh","number":9274,"title":"DNS cache bug about ai_socktype and ai_protocol","user":{"login":"Cering","id":9027486,"node_id":"MDQ6VXNlcjkwMjc0ODY=","avatar_url":"https://avatars.githubusercontent.com/u/9027486?v=4","gravatar_id":"","url":"https://api.github.com/users/Cering","html_url":"https://github.com/Cering","followers_url":"https://api.github.com/users/Cering/followers","following_url":"https://api.github.com/users/Cering/following{/other_user}","gists_url":"https://api.github.com/users/Cering/gists{/gist_id}","starred_url":"https://api.github.com/users/Cering/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Cering/subscriptions","organizations_url":"https://api.github.com/users/Cering/orgs","repos_url":"https://api.github.com/users/Cering/repos","events_url":"https://api.github.com/users/Cering/events{/privacy}","received_events_url":"https://api.github.com/users/Cering/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141438010,"node_id":"MDU6TGFiZWwxMTQxNDM4MDEw","url":"https://api.github.com/repos/curl/curl/labels/HTTP/3","name":"HTTP/3","color":"97fceb","default":false,"description":"h3 or quic related"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-08-08T07:23:20Z","updated_at":"2022-08-08T11:29:42Z","closed_at":"2022-08-08T11:29:42Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!-- Only file bugs here! Ask questions on the mailing lists https://curl.se/mail/\r\n\r\n     SECURITY RELATED? Post it here: https://hackerone.com/curl\r\n\r\n     There are collections of known issues to be aware of:\r\n     https://curl.se/docs/knownbugs.html\r\n     https://curl.se/docs/todo.html       -->\r\n\r\n### I did this\r\n- Send an http3 request first and set `CURLOPT_FRESH_CONNECT` and `CURLOPT_FORBID_REUSE` to 1, for avoid reusing http3 connection\r\n- After that, send an http(tcp) request. This will not reuse the http3 connection, but will use the dns cache\r\n- However, the second request return fail because of error 7(Couldn't connect to server)\r\n- The demo code is [demo.cpp.txt](https://github.com/curl/curl/files/9279417/demo.cpp.txt), and major output info: \r\n```\r\nNew Request[0]: https://www.google.com\r\ncurl_debug[0]: STATE: INIT => CONNECT handle 0x13c2a68; line 1833 (connection #-5000)\r\ncurl_debug[0]: Added connection 0. The cache now contains 1 members\r\ncurl_debug[0]: STATE: CONNECT => RESOLVING handle 0x13c2a68; line 1879 (connection #0)\r\ncurl_debug[0]: family0 == v4, family1 == v6\r\ncurl_debug[0]:   Trying 142.251.42.228:443...\r\ncurl_debug[0]:  CAfile: /etc/pki/tls/certs/ca-bundle.crt\r\ncurl_debug[0]:  CApath: none\r\ncurl_debug[0]: Connect socket 5 over QUIC to 142.251.42.228:443\r\ncurl_debug[0]: Sent QUIC client Initial, ALPN: h3,h3-29,h3-28,h3-27\r\n...\r\ncurl_debug[0]: multi_done: status: 0 prem: 0 done: 0\r\ncurl_debug[0]: The cache now contains 0 members\r\ncurl_debug[0]: Closing connection 2\r\ncurl_debug[0]: Expire cleared (transfer 0x13c2a68)\r\nmycurl_process: https://www.google.com.hk/, curl_code: 0(No error), http_version: 30, total_time: 0.760068, connect_time: 0.618590, download_bytes: 49727, download_speed: 65424\r\n\r\n\r\nNew Request[1]: https://www.google.com\r\ncurl_debug[0]: STATE: INIT => CONNECT handle 0x13c2a68; line 1833 (connection #-5000)\r\ncurl_debug[0]: Added connection 3. The cache now contains 1 members\r\ncurl_debug[0]: Hostname www.google.com was found in DNS cache\r\ncurl_debug[0]: family0 == v4, family1 == v6\r\ncurl_debug[0]: The cache now contains 0 members\r\ncurl_debug[0]: Closing connection 3\r\ncurl_debug[0]: Expire cleared (transfer 0x13c2a68)\r\nmycurl_process: https://www.google.com/, curl_code: 7(Couldn't connect to server), http_version: 0, total_time: 0.000000, connect_time: 0.000000, download_bytes: 0, download_speed: 0\r\n```\r\n\r\n### I expected the following\r\n- I add some output and find the error occured in `Curl_socket()`:\r\n```\r\nif(*sockfd == CURL_SOCKET_BAD) {\r\n  int err = errno;\r\n  const char* errinfo = strerror(err);\r\n  //output is 'error socket: 93, Protocol not supported'\r\n  infof(conn->data, \"error socket: %d, %s\\n\", err, errinfo);  \r\n  /* no socket, no connection */\r\n  return CURLE_COULDNT_CONNECT;\r\n}\r\n```\r\n- Then output the dns cache info in `Curl_resolv()` and `Curl_socket()`\r\n```\r\n//in Curl_resolv()\r\nif(dns) {\r\n  infof(data, \"Hostname %s was found in DNS cache\\n\", hostname);\r\n  dns->inuse++; /* we use it! */\r\n  rc = CURLRESOLV_RESOLVED;\r\n\r\n  const struct Curl_addrinfo *ai = dns->addr;\r\n  while(ai)\r\n  {\r\n      char buf[INET6_ADDRSTRLEN];\r\n      Curl_printable_address(ai, buf, sizeof(buf));\r\n      //output is 'dns cache ai_info[111.206.72.219] - flags: 0, family: 2, socktype: 2, protocol: 17'\r\n      infof(data, \"dns cache ai_info[%s] - flags: %d, family: %d, socktype: %d, protocol: %d\\n\", buf, ai->ai_flags, ai->ai_family, ai->ai_socktype, ai->ai_protocol);\r\n      ai = ai->ai_next;\r\n  }\r\n}\r\n\r\n//in Curl_socket()\r\nmemcpy(&addr->sa_addr, ai->ai_addr, addr->addrlen);\r\n\r\n{\r\n    char ipaddress[MAX_IPADR_LEN];\r\n    long port;\r\n    Curl_addr2string((struct sockaddr*)&addr->sa_addr, addr->addrlen, ipaddress, &port);\r\n    //output is 'create socket[111.206.72.219] - ai_family: 2, socktype: 1, protocol: 17'\r\n    infof(conn->data, \"create socket[%s] - ai_family: %d, socktype: %d, protocol: %d\\n\", ipaddress, addr->family, addr->socktype, addr->protocol);\r\n}\r\n\r\nif(data->set.fopensocket) {\r\n```\r\n- It seems that when send an http3 request firstly, the dns result is `ai_socktype=1(SOCK_DGRAM)`  and `ai_protocol=17(IPPROTO_UDP)` and was cached. Then use this dns cache to create a tcp socket, the params is `ai_socktype=1(SOCK_STREAM)` and `ai_protocol=17(IPPROTO_UDP)`, which is an error input(a stream socket can't use for udp protocol). So system return error - Protocol not supported.\r\n\r\n### curl/libcurl version\r\n```\r\ncurl 7.83.0 (x86_64-pc-linux-gnu) libcurl/7.83.0 BoringSSL zlib/1.2.7 brotli/1.0.9 nghttp2/1.41.0 quiche/0.12.0 OpenLDAP/2.4.44\r\nRelease-Date: 2022-04-27\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps ldap ldaps mqtt pop3 pop3s rtsp smb smbs smtp smtps telnet tftp\r\nFeatures: alt-svc AsynchDNS brotli Debug HSTS HTTP2 HTTP3 HTTPS-proxy IPv6 Largefile libz NTLM NTLM_WB SSL TrackMemory UnixSockets\r\n```\r\n\r\n### operating system\r\n```\r\nLinux mylinux 3.10.0-693.el7.x86_64 #1 SMP Tue Aug 22 21:09:27 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n```","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/9274/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/9274/timeline","performed_via_github_app":null,"state_reason":"completed"}