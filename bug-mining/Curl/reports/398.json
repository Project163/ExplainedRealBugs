{"url":"https://api.github.com/repos/curl/curl/issues/12901","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/12901/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/12901/comments","events_url":"https://api.github.com/repos/curl/curl/issues/12901/events","html_url":"https://github.com/curl/curl/issues/12901","id":2125377132,"node_id":"I_kwDOAAiu0c5-rq5s","number":12901,"title":"Version 8.6.0 adds 1s delay for FTP SSL connections","user":{"login":"Vogtinator","id":1622084,"node_id":"MDQ6VXNlcjE2MjIwODQ=","avatar_url":"https://avatars.githubusercontent.com/u/1622084?v=4","gravatar_id":"","url":"https://api.github.com/users/Vogtinator","html_url":"https://github.com/Vogtinator","followers_url":"https://api.github.com/users/Vogtinator/followers","following_url":"https://api.github.com/users/Vogtinator/following{/other_user}","gists_url":"https://api.github.com/users/Vogtinator/gists{/gist_id}","starred_url":"https://api.github.com/users/Vogtinator/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Vogtinator/subscriptions","organizations_url":"https://api.github.com/users/Vogtinator/orgs","repos_url":"https://api.github.com/users/Vogtinator/repos","events_url":"https://api.github.com/users/Vogtinator/events{/privacy}","received_events_url":"https://api.github.com/users/Vogtinator/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118221,"node_id":"MDU6TGFiZWwxODQxMTgyMjE=","url":"https://api.github.com/repos/curl/curl/labels/TLS","name":"TLS","color":"bfdadc","default":false,"description":""},{"id":184118265,"node_id":"MDU6TGFiZWwxODQxMTgyNjU=","url":"https://api.github.com/repos/curl/curl/labels/FTP","name":"FTP","color":"bfd4f2","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2024-02-08T14:59:36Z","updated_at":"2024-02-09T14:58:16Z","closed_at":"2024-02-09T14:58:15Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\n`time curl -k -l --ssl-reqd ftp://127.0.0.1`\n\n### I expected the following\n\nWith 8.5.0 it's always below 0.1s:\r\n\r\n```\r\nreal    0m0,024s\r\nuser    0m0,012s\r\nsys     0m0,003s\r\n```\r\n\r\nWith 8.6.0 or git master it's reproducably 1s slower:\r\n\r\n```\r\nreal    0m1,038s\r\nuser    0m0,024s\r\nsys     0m0,010s\r\n```\r\n\r\nLooking at the `--trace-config all --trace -` output, the delay happens during the control channel handshake:\r\n\r\n```\r\n15:57:27.472329 [0-0] == Info: Connecting to 127.0.0.1 (127.0.0.1) port 43310\r\n15:57:27.472335 [0-0] == Info: [HAPPY-EYEBALLS] created ipv4 (timeout 299989ms)\r\n15:57:27.472339 [0-0] == Info: [HAPPY-EYEBALLS] ipv4 starting (timeout=299989ms)\r\n15:57:27.472358 [0-0] == Info:   Trying 127.0.0.1:43310...\r\n15:57:27.472367 [0-0] == Info: [TCP] cf_socket_open() -> 0, fd=6\r\n15:57:27.472428 [0-0] == Info: [TCP] local address 127.0.0.1 port 35198...\r\n15:57:27.472434 [0-0] == Info: [HAPPY-EYEBALLS] ipv4 connect -> 0, connected=0\r\n15:57:27.472440 [0-0] == Info: [TCP] adjust_pollset(!connected) -> 1 socks\r\n15:57:27.472444 [0-0] == Info: [HAPPY-EYEBALLS] adjust_pollset -> 1 socks\r\n15:57:27.472448 [0-0] == Info: [TCP] adjust_pollset(!connected) -> 1 socks\r\n15:57:27.472462 [0-0] == Info: [HAPPY-EYEBALLS] adjust_pollset -> 1 socks\r\n15:57:27.472473 [0-0] == Info: [TCP] connected\r\n15:57:27.472477 [0-0] == Info: [HAPPY-EYEBALLS] ipv4 connect -> 0, connected=1\r\n15:57:27.472481 [0-0] == Info: Connected to 127.0.0.1 (127.0.0.1) port 21\r\n15:57:27.472485 [0-0] == Info: [SSL] cf_connect()\r\n15:57:27.472834 [0-0] == Info: SSL reusing session ID\r\n15:57:27.473016 [0-0] => Send SSL data, 5 bytes (0x5)\r\n0000: 16 03 01 02 31                                  ....1\r\n15:57:27.473036 [0-0] == Info: TLSv1.3 (OUT), TLS handshake, Client hello (1):\r\n15:57:27.473040 [0-0] => Send SSL data, 561 bytes (0x231)\r\n0000: 01 00 02 2d 03 03 cb c0 af c8 70 02 a7 b7 d2 c3 ...-......p.....\r\n0010: 0e 43 7b 0a b9 8a be 85 1a 98 b1 c1 53 03 dd 54 .C{.........S..T\r\n0020: ab dd 14 01 11 46 20 16 4f 1e 90 3a e4 a3 bc c5 .....F .O..:....\r\n0030: d8 d6 50 52 e5 a5 69 4e d3 ac 0d 79 25 18 aa 42 ..PR..iN...y%..B\r\n0040: da 21 27 ae 53 db 5a 00 48 13 02 13 03 13 01 13 .!'.S.Z.H.......\r\n0050: 04 c0 2c c0 30 cc a9 cc a8 c0 ad c0 2b c0 2f c0 ..,.0.......+./.\r\n0060: ac c0 23 c0 27 c0 0a c0 14 c0 09 c0 13 00 9d c0 ..#.'...........\r\n0070: 9d 00 9c c0 9c 00 3d 00 3c 00 35 00 2f 00 9f cc ......=.<.5./...\r\n0080: aa c0 9f 00 9e c0 9e 00 6b 00 67 00 39 00 33 00 ........k.g.9.3.\r\n0090: ff 01 00 01 9c 00 0b 00 04 03 00 01 02 00 0a 00 ................\r\n00a0: 16 00 14 00 1d 00 17 00 1e 00 19 00 18 01 00 01 ................\r\n00b0: 01 01 02 01 03 01 04 00 16 00 00 00 17 00 00 00 ................\r\n00c0: 31 00 00 00 0d 00 22 00 20 04 03 05 03 06 03 08 1.....\". .......\r\n00d0: 07 08 08 08 09 08 0a 08 0b 08 04 08 05 08 06 04 ................\r\n00e0: 01 05 01 06 01 03 03 03 01 00 2b 00 05 04 03 04 ..........+.....\r\n00f0: 03 03 00 2d 00 02 01 01 00 33 00 26 00 24 00 1d ...-.....3.&.$..\r\n0100: 00 20 54 58 a6 77 30 cc 7f 56 6c ee 28 d6 7b b0 . TX.w0..Vl.(.{.\r\n0110: fc 3f b4 f1 24 ce 0c ac 24 4c 61 fc 8f d4 cb 89 .?..$...$La.....\r\n0120: 5e 38 00 29 01 0b 00 d6 00 d0 93 c8 d1 bc 6a 9f ^8.)..........j.\r\n0130: 65 66 73 43 75 41 0c 2d 7a 0d a8 0b 4d 19 13 6a efsCuA.-z...M..j\r\n0140: 95 e9 26 84 b9 ee 92 d8 a2 b5 15 2b 3d 5b 7b 8c ..&........+=[{.\r\n0150: 61 1f a9 94 ac ed 56 3e ad 7f dc 28 14 f0 0d 30 a.....V>...(...0\r\n0160: 4c 30 53 e0 14 79 f1 10 f0 2d a2 02 9e 94 c0 08 L0S..y...-......\r\n0170: b4 6e f8 6a 47 70 31 3d c7 16 91 8a 04 6b 34 e5 .n.jGp1=.....k4.\r\n0180: 74 4b f3 68 96 1b ed f1 f4 8c e1 ca e3 e2 7d d6 tK.h..........}.\r\n0190: 6e 4a f5 f2 ec 4b 0a 60 b2 37 33 9a a9 87 de 01 nJ...K.`.73.....\r\n01a0: 49 34 bf f0 2e 5b 2f 7c 8c 46 44 a1 4f 0f 98 44 I4...[/|.FD.O..D\r\n01b0: 6a 81 22 d1 1e 57 74 c8 dd 9e d6 6d e5 04 cd 2e j.\"..Wt....m....\r\n01c0: ba f1 6a 73 01 1d dd 2c 9c c3 61 55 a6 41 7e 60 ..js...,..aU.A~`\r\n01d0: a2 f5 cd e2 03 9c 0e a8 74 5c 3b eb 92 e9 5f 84 ........t\\;..._.\r\n01e0: 65 32 88 16 db d3 64 d4 ae 08 35 1b d5 be f6 08 e2....d...5.....\r\n01f0: 5b dc 7d bc 01 2e 15 09 63 4b 05 08 fe ca 00 31 [.}.....cK.....1\r\n0200: 30 47 35 f7 fc 81 c8 be 81 f6 6e 16 ce 1a 11 cc 0G5.......n.....\r\n0210: 9b a5 84 55 fa 0f 5c 4e e9 ae 50 4a 84 bb 9a ae ...U..\\N..PJ....\r\n0220: aa 93 26 04 40 8e 57 37 01 94 15 2e 8d 7e 4f 5f ..&.@.W7.....~O_\r\n0230: fa                                              .\r\n15:57:27.473238 [0-0] == Info: [TCP] send(len=566) -> 566, err=0\r\n15:57:27.473243 [0-0] == Info: [SSL] ossl_bio_cf_out_write(len=566) -> 566, err=0\r\n15:57:27.473255 [0-0] == Info: [TCP] nw_in_read(len=5) -> -1, err=81\r\n15:57:27.473259 [0-0] == Info: [TCP] recv(len=5) -> -1, err=81\r\n15:57:27.473262 [0-0] == Info: [SSL] ossl_bio_cf_in_read(len=5) -> -1, err=81\r\n15:57:27.473266 [0-0] == Info: [SSL] populate_x509_store, path=none, blob=0\r\n15:57:27.473271 [0-0] == Info: [SSL] cf_connect() -> 0, done=0\r\n15:57:27.473282 [0-0] => Send SSL data, 5 bytes (0x5)\r\n0000: 17 03 03 00 19                                  .....\r\n15:57:27.473289 [0-0] => Send SSL data, 1 bytes (0x1)\r\n0000: 17                                              .\r\n15:57:27.473317 [0-0] == Info: [TCP] send(len=30) -> 30, err=0\r\n15:57:27.473321 [0-0] == Info: [SSL] ossl_bio_cf_out_write(len=30) -> 30, err=0\r\n15:57:27.473325 [0-0] => Send header, 8 bytes (0x8)\r\n0000: 54 59 50 45 20 41 0d 0a                         TYPE A..\r\n\r\n** 1s delay here**\r\n\r\n15:57:28.474445 [0-0] == Info: [SSL] cf_connect()\r\n15:57:28.474521 [0-0] == Info: [TCP] nw_in_read(len=5) -> -1, err=81\r\n15:57:28.474530 [0-0] == Info: [TCP] recv(len=5) -> -1, err=81\r\n15:57:28.474539 [0-0] == Info: [SSL] ossl_bio_cf_in_read(len=5) -> -1, err=81\r\n15:57:28.474552 [0-0] == Info: [SSL] cf_connect() -> 0, done=0\r\n15:57:28.474576 [0-0] == Info: [TCP] nw_in_read(len=5) -> 5, err=0\r\n15:57:28.474584 [0-0] == Info: [TCP] recv(len=5) -> 5, err=0\r\n15:57:28.474594 [0-0] == Info: [SSL] ossl_bio_cf_in_read(len=5) -> 5, err=0\r\n15:57:28.474603 [0-0] <= Recv SSL data, 5 bytes (0x5)\r\n0000: 17 03 03 00 2f                                  ..../\r\n15:57:28.474627 [0-0] == Info: [TCP] nw_in_read(len=47) -> 47, err=0\r\n15:57:28.474635 [0-0] == Info: [TCP] recv(len=47) -> 47, err=0\r\n15:57:28.474643 [0-0] == Info: [SSL] ossl_bio_cf_in_read(len=47) -> 47, err=0\r\n15:57:28.474668 [0-0] <= Recv SSL data, 1 bytes (0x1)\r\n0000: 17\r\n```\r\n\r\nUnfortunately it appears to be a bit fragile: It is not reproducible when using `localhost` instead of `127.0.0.1` (I guess because of SNI) or when using strace (which slows down syscalls slightly). git bisect points to a0f94800d507de580f04a447cf14edc9f52697dc.\n\n### curl/libcurl version\n\ncurl 8.6.0-DEV (x86_64-suse-linux-gnu) libcurl/8.6.0-DEV OpenSSL/3.1.4 zlib/1.3 brotli/1.1.0 zstd/1.5.5 libidn2/2.3.4 libpsl/0.21.2 (+libidn2/2.3.4)\r\nRelease-Date: [unreleased]\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps ipfs ipns mqtt pop3 pop3s rtsp smb smbs smtp smtps telnet tftp\r\nFeatures: alt-svc AsynchDNS brotli HSTS HTTPS-proxy IDN IPv6 Largefile libz NTLM PSL SSL threadsafe TLS-SRP UnixSockets zst\n\n### operating system\n\nopenSUSE Tumbleweed","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/12901/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/12901/timeline","performed_via_github_app":null,"state_reason":"completed"}