{"url":"https://api.github.com/repos/curl/curl/issues/17061","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/17061/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/17061/comments","events_url":"https://api.github.com/repos/curl/curl/issues/17061/events","html_url":"https://github.com/curl/curl/issues/17061","id":2996083297,"node_id":"I_kwDOAAiu0c6ylJph","number":17061,"title":"HTTP connection closed seemingly related to ioctl(0, TIOCGWINSZ)","user":{"login":"nigoroll","id":1528104,"node_id":"MDQ6VXNlcjE1MjgxMDQ=","avatar_url":"https://avatars.githubusercontent.com/u/1528104?v=4","gravatar_id":"","url":"https://api.github.com/users/nigoroll","html_url":"https://github.com/nigoroll","followers_url":"https://api.github.com/users/nigoroll/followers","following_url":"https://api.github.com/users/nigoroll/following{/other_user}","gists_url":"https://api.github.com/users/nigoroll/gists{/gist_id}","starred_url":"https://api.github.com/users/nigoroll/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nigoroll/subscriptions","organizations_url":"https://api.github.com/users/nigoroll/orgs","repos_url":"https://api.github.com/users/nigoroll/repos","events_url":"https://api.github.com/users/nigoroll/events{/privacy}","received_events_url":"https://api.github.com/users/nigoroll/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2025-04-15T11:20:00Z","updated_at":"2025-04-15T15:29:26Z","closed_at":"2025-04-15T15:29:26Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\n#### Only for context, feel free to skip \n\nI am using curl for regression testing of [SLASH/](https://gitlab.com/uplex/varnish/slash) with a delivery filter (VDP) on the varnish-cache end which [deliberately panics when the written http body length does not match the expected value](https://github.com/varnishcache/varnish-cache/commit/48cf8867c201976ccc1b2ac08ae43690420ad2fa). The testing goal is to ensure that the storage engine always delivers the right amount of data, so for this testing scenario errors which are otherwise completely normal (like a short body write due to a connection closure from the client side) can not safely be ignored, as doing so would hide actual errors. In other words, for this testing regime I need a client which always does the right thing.\n\n#### Calling curl\n\nThe main part of the test script executes 30 parallel instances of curl with 50001 urls in the argument list:\n\n```\n\"${CURL_ARGS[@]}\" -sSo /dev/null 127.0.0.1:8081/${p}{{5500..50000},{1..5500}}${l} 2>${p}${pp}2.curlerr &\n```\n\nThe details regarding the `p`, `l` and `pp` variables should not matter, but feel free to look at the [full script](https://gist.github.com/nigoroll/1d5b9e9628c22ff23c7a034c9807e96c).\n\n### I expected the following\n\nI expected curl to always read the full response body and not close the connection prematurely.\n\nSometimes and seemingly random, the curl invocation triggers a short write on the server side:\n\n```\n-   ReqStart       127.0.0.1 46424 a0\n-   ReqMethod      GET\n-   ReqURL         /I5690\n-   ReqProtocol    HTTP/1.1\n-   ReqHeader      Host: 127.0.0.1:8081\n-   ReqHeader      User-Agent: curl/8.13.1-DEV\n...\n-   VCL_return     deliver\n-   Timestamp      Process: 1744713049.557025 0.017923 0.000031\n-   Filters         debug.chklen\n-   RespHeader     Connection: keep-alive\n-   Debug          \"Write error, retval = -1, len = 36544, errno = Broken pipe%00\"\n-   VSL            flush\n-   End            synth\n```\n\nOriginally, I would see `client returned ERROR on write of ...` with curl.\n\nTo better understand the issue, I patched it slightly:\n\n```diff\ndiff --git a/lib/cw-out.c b/lib/cw-out.c\nindex af8f1b9e5..30d079732 100644\n--- a/lib/cw-out.c\n+++ b/lib/cw-out.c\n@@ -241,7 +241,8 @@ static CURLcode cw_out_ptr_flush(struct cw_out_ctx *ctx,\n       break;\n     }\n     else if(CURL_WRITEFUNC_ERROR == nwritten) {\n-      failf(data, \"client returned ERROR on write of %zu bytes\", wlen);\n+      failf(data, \"client returned ERROR %d on write of %zu/%zu bytes\",\n+            errno, nwritten, wlen);\n       return CURLE_WRITE_ERROR;\n     }\n     else if(nwritten != wlen) {\n```\n\nWith this, the error message is:\n\n```\nI22.curlerr:> GET /I5690 HTTP/1.1\nI22.curlerr-> Host: 127.0.0.1:8081\nI22.curlerr-> User-Agent: curl/8.13.1-DEV\nI22.curlerr-> Accept: */*\nI22.curlerr-> ttl: 1s\nI22.curlerr-> \nI22.curlerr-* Request completely sent off\nI22.curlerr-< HTTP/1.1 200 OK\nI22.curlerr-< Date: Tue, 15 Apr 2025 10:30:49 GMT\nI22.curlerr-< Server: Varnish\nI22.curlerr-< len: 126824\nI22.curlerr-< Cache-Control: public, max-age=1\nI22.curlerr-< X-Varnish: 329919\nI22.curlerr-< Content-Length: 126824\nI22.curlerr-< storage: storage.fellow\nI22.curlerr-< filters: \nI22.curlerr-< X-Varnish: 2097973\nI22.curlerr-< Age: 0\nI22.curlerr-< Via: 1.1 haggis21 (Varnish/trunk), 1.1 haggis21 (Varnish/trunk)\nI22.curlerr-< Accept-Ranges: bytes\nI22.curlerr-< Connection: keep-alive\nI22.curlerr-< \nI22.curlerr-* client returned ERROR 25 on write of 4294967295/16384 bytes\nI22.curlerr-* closing connection #16176 \n```\n\nSo `errno=ENOTTY` with a signed return value of `-1`.\n\nTo be sure about the error, I also ran curl in strace:\n\n```\npoll([{fd=4, events=POLLIN|POLLPRI|POLLRDNORM|POLLRDBAND}], 1, 0) = 0 (Timeout)\nwrite(2, \"* \", 2)                       = 2\nwrite(2, \"Re-using existing http: connecti\"..., 55) = 55\nsendto(4, \"GET /I5501 HTTP/1.1\\r\\nHost: 127.0\"..., 96, MSG_NOSIGNAL, NULL, 0) = 96\nwrite(2, \"> \", 2)                       = 2\nwrite(2, \"GET /I5501 HTTP/1.1\\r\\n\", 21) = 21\nwrite(2, \"> \", 2)                       = 2\n...\nwrite(2, \"> \", 2)                       = 2\nwrite(2, \"\\r\\n\", 2)                     = 2\nrecvfrom(4, \"HTTP/1.1 200 OK\\r\\nDate: Tue, 15 A\"..., 102400, 0, NULL, NULL) = 65536\nwrite(2, \"< \", 2)                       = 2\nwrite(2, \"HTTP/1.1 200 OK\\r\\n\", 17)     = 17\nwrite(2, \"< \", 2)                       = 2\n...\nwrite(2, \"Connection: keep-alive\\r\\n\", 24) = 24\nwrite(2, \"< \", 2)                       = 2\nwrite(2, \"\\r\\n\", 2)                     = 2\nioctl(0, TIOCGWINSZ, 0x7ffe1d09cf48)    = -1 ENOTTY (Inappropriate ioctl for device)\nwrite(2, \"* \", 2)                       = 2\nwrite(2, \"client returned ERROR 25 on writ\"..., 60) = 60\nwrite(2, \"* \", 2)                       = 2\nwrite(2, \"closing connection #0\\n\", 22) = 22\nclose(4)                                = 0\n```\n\nSo it really looks like the issue would indeed be caused by `ioctl(0, TIOCGWINSZ)` seemingly called at random.\n\nI see where this is happening in the code base, but I do not understand why apparently out of nowhere and at random points in time.\n\n### curl/libcurl version\n\nOriginally seen with stock-debian:\n\n```\ncurl 7.88.1 (x86_64-pc-linux-gnu) libcurl/7.88.1 OpenSSL/3.0.15 zlib/1.2.13 brotli/1.0.9 zstd/1.5.4 libidn2/2.3.3 libpsl/0.21.2 (+libidn2/2.3.3) libssh2/1.10.0 nghttp2/1.52.0 librtmp/2.3 OpenLDAP/2.5.13\nRelease-Date: 2023-02-20, security patched: 7.88.1-10+deb12u8\nProtocols: dict file ftp ftps gopher gophers http https imap imaps ldap ldaps mqtt pop3 pop3s rtmp rtsp scp sftp smb smbs smtp smtps telnet tftp\nFeatures: alt-svc AsynchDNS brotli GSS-API HSTS HTTP2 HTTPS-proxy IDN IPv6 Kerberos Largefile libz NTLM NTLM_WB PSL SPNEGO SSL threadsafe TLS-SRP UnixSockets zstd\n```\n\nThen reproduced with current HEAD 3fbabec53cda14fb095a366f59e5b8b7a3d193e6:\n\n```\ncurl 8.13.1-DEV (x86_64-pc-linux-gnu) libcurl/7.88.1 OpenSSL/3.0.15 zlib/1.2.13 brotli/1.0.9 zstd/1.5.4 libidn2/2.3.3 libpsl/0.21.2 (+libidn2/2.3.3) libssh2/1.10.0 nghttp2/1.52.0 librtmp/2.3 OpenLDAP/2.5.13\nRelease-Date: [unreleased]\nProtocols: dict file ftp ftps gopher gophers http https imap imaps ipfs ipns ldap ldaps mqtt pop3 pop3s rtmp rtsp scp sftp smb smbs smtp smtps telnet tftp\nFeatures: alt-svc AsynchDNS brotli GSS-API HSTS HTTP2 HTTPS-proxy IDN IPv6 Kerberos Largefile libz NTLM NTLM_WB PSL SPNEGO SSL threadsafe TLS-SRP UnixSockets zstd\nWARNING: curl and libcurl versions do not match. Functionality may be affected.\n```\n\n### operating system\n\n```\n$ cat /etc/debian_version \n12.9\n```","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/17061/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/17061/timeline","performed_via_github_app":null,"state_reason":"completed"}