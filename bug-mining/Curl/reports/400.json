{"url":"https://api.github.com/repos/curl/curl/issues/12971","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/12971/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/12971/comments","events_url":"https://api.github.com/repos/curl/curl/issues/12971/events","html_url":"https://github.com/curl/curl/issues/12971","id":2148160203,"node_id":"I_kwDOAAiu0c6AClLL","number":12971,"title":"HTTP2 requests through multi interface might not properly finish","user":{"login":"5533asdg","id":128343962,"node_id":"U_kgDOB6Zfmg","avatar_url":"https://avatars.githubusercontent.com/u/128343962?v=4","gravatar_id":"","url":"https://api.github.com/users/5533asdg","html_url":"https://github.com/5533asdg","followers_url":"https://api.github.com/users/5533asdg/followers","following_url":"https://api.github.com/users/5533asdg/following{/other_user}","gists_url":"https://api.github.com/users/5533asdg/gists{/gist_id}","starred_url":"https://api.github.com/users/5533asdg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/5533asdg/subscriptions","organizations_url":"https://api.github.com/users/5533asdg/orgs","repos_url":"https://api.github.com/users/5533asdg/repos","events_url":"https://api.github.com/users/5533asdg/events{/privacy}","received_events_url":"https://api.github.com/users/5533asdg/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2024-02-22T04:20:34Z","updated_at":"2024-02-22T13:17:00Z","closed_at":"2024-02-22T13:16:59Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nThe issue is observed after upgrading curl from 8.5.0 to 8.6.0.\r\nSpecifically, the behavior change is seen from https://github.com/curl/curl/commit/d7b6ce64ce0ad787ad2ed3ee05c94938a6b4f551.\r\n\r\nWhen issuing queries, we might not get the state change from PERFORMING to DONE.\r\n\r\nThe currently seen behavior on failure is*:\r\n1. HTTPS/2 request is sent through `curl_multi_add_handle(...)`.\r\n2. The request is completed and `drain_steam(...)` (https://github.com/curl/curl/blob/master/lib/http2.c#L212) is called.\r\n    - `data->state.select_bits` is set to `CURL_CSELECT_IN`.\r\n    - `Curl_expire(data, 0, EXPIRE_RUN_NOW);` is called.\r\n3. Client's `epoll` returns the socket to be writable but not readable.\r\n4. `curl_multi_socket_action(..., CURL_CSELECT_OUT, ...)` is called by the client.\r\n    - `data->state.select_bits` is set to `CURL_CSELECT_OUT` (overriding libcurl operation on step 2).\r\n5. `CURLMOPT_TIMERFUNCTION` is called as a result of step 2.\r\n6. `readwrite_data(...)` is not called because `data->state.select_bits == CURL_CSELECT_OUT` and `k->keepon == KEEP_RECV`.\r\n\r\nThe currently seen behavior on success is*:\r\n1. HTTPS/2 request is sent through `curl_multi_add_handle(...)`.\r\n2. The request is completed and `drain_steam(...)` (https://github.com/curl/curl/blob/master/lib/http2.c#L212) is called.\r\n    - `data->state.select_bits` is set to `CURL_CSELECT_IN`.\r\n    - `Curl_expire(data, 0, EXPIRE_RUN_NOW);` is called.\r\n3. `CURLMOPT_TIMERFUNCTION` is called as a result of step 2.\r\n4. `readwrite_data(...)` is called because `data->state.select_bits == CURL_CSELECT_IN` and `k->keepon == KEEP_RECV`.\r\n    - Curl gets `EndOfSteam` (EOS) / `nread == 0` from  `readwrite_data(...)`.\r\n5. Curl updated the state from PERFORMING to DONE.\r\n\r\n*The difference is whether `curl_multi_socket_action(..., CURL_CSELECT_OUT, ...)` or `CURLMOPT_TIMERFUNCTION` is called first.\r\n\r\nThe previous behavior is (< 8.6.0):\r\n1. HTTPS/2 request is sent through `curl_multi_add_handle(...)`.\r\n2. The request is completed and `drain_steam(...)` (https://github.com/curl/curl/blob/master/lib/http2.c#L212) is called.\r\n    - `data->state.select_bits` is set to `CURL_CSELECT_IN`.\r\n    - `Curl_expire(data, 0, EXPIRE_RUN_NOW);` is called.\r\n3. Curl updated the state from PERFORMING to DONE within the same `multi_socket(...)` calls as step 2.\r\n    - As such, it is not possible for the client to call `curl_multi_socket_action(..., CURL_CSELECT_OUT, ...)`.\r\n\r\n\r\nFrom my understanding, the behavior change is the result of https://github.com/curl/curl/pull/12480/commits/2944e467a6d64639e572d4b0f6750fa94e5ed6bc.\n\n### I expected the following\n\nCurl to always finish the request even if `curl_multi_socket_action(..., CURL_CSELECT_OUT, ...)` is called.\n\n### curl/libcurl version\n\nWARNING: this libcurl is Debug-enabled, do not use in production\r\n\r\ncurl 8.6.0-DEV (x86_64-cros-linux-gnu) libcurl/8.6.0-DEV OpenSSL/3.2.0 zlib/1.2.13 c-ares/1.19.1 libpsl/0.21.1 nghttp2/1.57.0\r\nRelease-Date: [unreleased]\r\nProtocols: dict file http https ipfs ipns mqtt\r\nFeatures: alt-svc AsynchDNS Debug GSS-API HSTS HTTP2 HTTPS-proxy IPv6 Kerberos Largefile libz NTLM PSL SPNEGO SSL threadsafe TLS-SRP TrackMemory UnixSockets\n\n### operating system\n\nChromeOS\r\n\r\n$ uname -a\r\nLinux localhost 5.15.147-21486-g7e7afc4ef5b4 #1 SMP PREEMPT Tue, 16 Jan 2024 22:08:30 +0000 x86_64 Intel(R) Core(TM) i3-10110U CPU @ 2.10GHz GenuineIntel GNU/Linux\r\n","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/12971/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/12971/timeline","performed_via_github_app":null,"state_reason":"completed"}