{"url":"https://api.github.com/repos/curl/curl/issues/18518","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/18518/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/18518/comments","events_url":"https://api.github.com/repos/curl/curl/issues/18518/events","html_url":"https://github.com/curl/curl/issues/18518","id":3404471865,"node_id":"I_kwDOAAiu0c7K7B45","number":18518,"title":"ngtcp2+quictls build of curl 8.16.0 fails HTTP/3 connection to Caddy web server with \"Weird server reply\"","user":{"login":"fds242","id":274402,"node_id":"MDQ6VXNlcjI3NDQwMg==","avatar_url":"https://avatars.githubusercontent.com/u/274402?v=4","gravatar_id":"","url":"https://api.github.com/users/fds242","html_url":"https://github.com/fds242","followers_url":"https://api.github.com/users/fds242/followers","following_url":"https://api.github.com/users/fds242/following{/other_user}","gists_url":"https://api.github.com/users/fds242/gists{/gist_id}","starred_url":"https://api.github.com/users/fds242/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fds242/subscriptions","organizations_url":"https://api.github.com/users/fds242/orgs","repos_url":"https://api.github.com/users/fds242/repos","events_url":"https://api.github.com/users/fds242/events{/privacy}","received_events_url":"https://api.github.com/users/fds242/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141438010,"node_id":"MDU6TGFiZWwxMTQxNDM4MDEw","url":"https://api.github.com/repos/curl/curl/labels/HTTP/3","name":"HTTP/3","color":"97fceb","default":false,"description":"h3 or quic related"}],"state":"closed","locked":false,"assignee":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":3,"created_at":"2025-09-11T02:11:53Z","updated_at":"2025-09-11T13:59:42Z","closed_at":"2025-09-11T13:59:42Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nGoing from version 8.15.0 to 8.16.0, curl is now unable to connect via QUIC + HTTP/3 to any Caddy web server instance I tried (eg. running locally on my Mac, Caddy v2.10.2, or even the https://caddyserver.com official website).\n\nRunning\n`curl -vv --http3-only https://caddyserver.com`\n\nresults in the following output, repeated until timeout:\n```\n* Host caddyserver.com:443 was resolved.\n* IPv6: (none)\n* IPv4: 165.227.20.207\n* [HTTPS-CONNECT] adding wanted h3\n* [HTTPS-CONNECT] added\n* [HTTPS-CONNECT] connect, init\n*   Trying 165.227.20.207:443...\n* [HTTP/3] vquic_send(len=1200, gso=1200) -> 0, sent=1200\n* [HTTPS-CONNECT] connect -> 0, done=0\n* [HTTPS-CONNECT] Curl_conn_connect(block=0) -> 0, done=0\n* [HTTPS-CONNECT] adjust_pollset -> 0, 1 socks\n* [HTTP/3] ossl_populate_x509_store, path=none, blob=0\n* [HTTPS-CONNECT] connect -> 0, done=0\n* [HTTPS-CONNECT] Curl_conn_connect(block=0) -> 0, done=0\n* [HTTPS-CONNECT] adjust_pollset -> 0, 1 socks\n* [HTTP/3] ingress, read_pkt -> ERR_DRAINING (-224)\n* [HTTP/3] recvd 1 packets with 57 bytes -> 56\n* QUIC connect to 165.227.20.207 port 443 failed: Weird server reply\n* [HTTP/3] connect -> 8, done=0\n* [HTTPS-CONNECT] connect -> 0, done=0\n* [HTTPS-CONNECT] Curl_conn_connect(block=0) -> 0, done=0\n* [HTTPS-CONNECT] adjust_pollset -> 0, 0 socks\n*   Trying 165.227.20.207:443...\n* [HTTP/3] vquic_send(len=1200, gso=1200) -> 0, sent=1200\n* [HTTP/3] destroy\n* [HTTP/3] start shutdown(err_type=0, err_code=10) -> 0\n* [HTTP/3] shutdown completely sent off, done\n* [HTTP/3] close\n* [HTTPS-CONNECT] connect -> 0, done=0\n* [HTTPS-CONNECT] Curl_conn_connect(block=0) -> 0, done=0\n* [HTTPS-CONNECT] adjust_pollset -> 0, 1 socks\n* [HTTP/3] ingress, read_pkt -> ERR_DRAINING (-224)\n* [HTTP/3] recvd 1 packets with 57 bytes -> 56\n* QUIC connect to 165.227.20.207 port 443 failed: Weird server reply\n* [HTTP/3] connect -> 8, done=0\n* [HTTPS-CONNECT] connect -> 0, done=0\n* [HTTPS-CONNECT] Curl_conn_connect(block=0) -> 0, done=0\n* [HTTPS-CONNECT] adjust_pollset -> 0, 0 socks\n```\n\nThe same curl 8.16.0 is still able to make a successful HTTP/3 connection to Cloudflare servers or an nginx instance I have running, but fails with any instance of Caddy I have tried, whether running on Mac or Linux.\n\n### I expected the following\n\ncurl 8.15.0, freshly rebuilt using the exact same configuration and external library versions, continues to connect to the same servers without issue.\n\n```\n* Host caddyserver.com:443 was resolved.\n* IPv6: (none)\n* IPv4: 165.227.20.207\n* [HTTPS-CONNECT] adding wanted h3\n* [HTTPS-CONNECT] added\n* [HTTPS-CONNECT] connect, init\n*   Trying 165.227.20.207:443...\n* [HTTP/3] vquic_send(len=1200, gso=1200) -> 0, sent=1200\n* [HTTPS-CONNECT] connect -> 0, done=0\n* [HTTPS-CONNECT] Curl_conn_connect(block=0) -> 0, done=0\n* [HTTPS-CONNECT] adjust_pollset -> 1 socks\n* [HTTP/3] ossl_populate_x509_store, path=none, blob=0\n* [HTTPS-CONNECT] connect -> 0, done=0\n* [HTTPS-CONNECT] Curl_conn_connect(block=0) -> 0, done=0\n* [HTTPS-CONNECT] adjust_pollset -> 1 socks\n* SSL connection using TLSv1.3 / TLS_AES_128_GCM_SHA256 / X25519 / id-ecPublicKey\n* Server certificate:\n*  subject: CN=caddyserver.com\n*  start date: Aug 19 16:03:27 2025 GMT\n*  expire date: Nov 17 16:03:26 2025 GMT\n*  subjectAltName: host \"caddyserver.com\" matched cert's \"caddyserver.com\"\n*  issuer: C=US; O=Let's Encrypt; CN=E6\n*  SSL certificate verify ok.\n*   Certificate level 0: Public key type EC/prime256v1 (256/128 Bits/secBits), signe\n*   Certificate level 1: Public key type EC/secp384r1 (384/192 Bits/secBits), signed\ntion\n*   Certificate level 2: Public key type RSA (4096/152 Bits/secBits), signed using s\n* [HTTP/3] handshake complete after 183ms\n* [HTTP/3] max bidi streams now 100, used 0\n* [HTTP/3] [3] read_stream(len=3) -> 3\n* [HTTP/3] recvd 4 packets with 2714 bytes -> 0\n* [HTTP/3] vquic_send_tail_split: [1200 gso=1200][1406 gso=1406]\n* [HTTP/3] vquic_send(len=1200, gso=1200) -> 0, sent=1200\n* [HTTP/3] vquic_send(len=1406, gso=1406) -> 0, sent=1406\n* [HTTP/3] peer verified\n* [HTTP/3] connect -> 0, done=1\n* [HTTPS-CONNECT] connect+handshake h3: 183ms, 1st data: 3ms\n* [HTTPS-CONNECT] connect -> 0, done=1\n* [HTTPS-CONNECT] Curl_conn_connect(block=0) -> 0, done=1\n* Connected to caddyserver.com (165.227.20.207) port 443\n* using HTTP/3\n* [HTTP/3] peer idle timeout is 30000ms, set keep-alive to 15000 ms.\n* [HTTP/3] [0] OPENED stream for https://caddyserver.com/\n* [HTTP/3] [0] [:method: GET]\n* [HTTP/3] [0] [:scheme: https]\n* [HTTP/3] [0] [:authority: caddyserver.com]\n* [HTTP/3] [0] [:path: /]\n* [HTTP/3] [0] [user-agent: curl/8.15.0]\n* [HTTP/3] [0] [accept: */*]\n* [HTTP/3] vquic_send(len=57, gso=57) -> 0, sent=57\n* [HTTP/3] [0] cf_send(len=77) -> 0, 77\n> GET / HTTP/3\n> Host: caddyserver.com\n> User-Agent: curl/8.15.0\n> Accept: */*\n[ … output of correct functionality continues … ]\n```\n\n### curl/libcurl version\n\ncurl 8.16.0 (x86_64-apple-darwin) libcurl/8.16.0 quictls/3.0.15 zlib/1.2.12 brotli/1.1.0 zstd/1.5.7 libidn2/2.3.8 libpsl/0.21.5 libssh/0.11.2/openssl/zlib nghttp2/1.67.0 ngtcp2/1.15.1 nghttp3/1.11.0\nRelease-Date: 2025-09-10\nProtocols: dict file ftp ftps gopher gophers http https imap imaps ipfs ipns ldap ldaps mqtt pop3 pop3s rtsp scp sftp smb smbs smtp smtps telnet tftp ws wss\nFeatures: alt-svc AsynchDNS brotli GSS-API HSTS HTTP2 HTTP3 HTTPS-proxy IDN IPv6 Kerberos Largefile libz NTLM PSL SPNEGO SSL threadsafe TLS-SRP UnixSockets zstd\n\n### operating system\n\nDarwin hostname 24.6.0 Darwin Kernel Version 24.6.0: Mon Jul 14 11:28:17 PDT 2025; root:xnu-11417.140.69~1/RELEASE_X86_64 x86_64","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/18518/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/curl/curl/issues/18518/timeline","performed_via_github_app":null,"state_reason":"completed"}