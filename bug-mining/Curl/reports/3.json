{"url":"https://api.github.com/repos/curl/curl/issues/8841","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/8841/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/8841/comments","events_url":"https://api.github.com/repos/curl/curl/issues/8841/events","html_url":"https://github.com/curl/curl/issues/8841","id":1234835349,"node_id":"I_kwDOAAiu0c5JmheV","number":8841,"title":"Memory leak in CURLOPT_XOAUTH2_BEARER","user":{"login":"Tachi107","id":34214253,"node_id":"MDQ6VXNlcjM0MjE0MjUz","avatar_url":"https://avatars.githubusercontent.com/u/34214253?v=4","gravatar_id":"","url":"https://api.github.com/users/Tachi107","html_url":"https://github.com/Tachi107","followers_url":"https://api.github.com/users/Tachi107/followers","following_url":"https://api.github.com/users/Tachi107/following{/other_user}","gists_url":"https://api.github.com/users/Tachi107/gists{/gist_id}","starred_url":"https://api.github.com/users/Tachi107/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Tachi107/subscriptions","organizations_url":"https://api.github.com/users/Tachi107/orgs","repos_url":"https://api.github.com/users/Tachi107/repos","events_url":"https://api.github.com/users/Tachi107/events{/privacy}","received_events_url":"https://api.github.com/users/Tachi107/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":182083182,"node_id":"MDU6TGFiZWwxODIwODMxODI=","url":"https://api.github.com/repos/curl/curl/labels/memory-leak","name":"memory-leak","color":"c7def8","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":8,"created_at":"2022-05-13T07:16:26Z","updated_at":"2024-09-24T07:28:33Z","closed_at":"2022-05-14T16:05:32Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!-- Only file bugs here! Ask questions on the mailing lists https://curl.se/mail/\r\n\r\n     SECURITY RELATED? Post it here: https://hackerone.com/curl\r\n\r\n     There are collections of known issues to be aware of:\r\n     https://curl.se/docs/knownbugs.html\r\n     https://curl.se/docs/todo.html       -->\r\n\r\n### I did this\r\n\r\nGiven the following code:\r\n\r\n```c\r\n#include <curl/curl.h>\r\n\r\nint main(void) {\r\n  curl_global_init(CURL_GLOBAL_ALL);\r\n\r\n  CURL* curl = curl_easy_init();\r\n\r\n  curl_easy_setopt(curl, CURLOPT_HTTPAUTH, CURLAUTH_BEARER);\r\n  curl_easy_setopt(curl, CURLOPT_XOAUTH2_BEARER, \"c4e448d652a961fda0ab64f882c8c161d5985f805d45d80c9ddca108f8e2fde3\");\r\n  curl_easy_setopt(curl, CURLOPT_HTTPGET, 1L);\r\n  curl_easy_setopt(curl, CURLOPT_URL, \"https://andrea.pappacoda.it\");\r\n\r\n  for (int i = 0; i < 5; i++) {\r\n    curl_easy_perform(curl);\r\n  }\r\n\r\n  curl_easy_cleanup(curl);\r\n\r\n  curl_global_cleanup();\r\n}\r\n```\r\n\r\nAddressSanitizer reports a memory leak:\r\n\r\n```text\r\n$ cc -g -fsanitize=address main.c $(pkg-config --cflags --libs libcurl) -o asan && ./asan\r\n=================================================================\r\n==41730==ERROR: LeakSanitizer: detected memory leaks\r\n\r\nDirect leak of 260 byte(s) in 4 object(s) allocated from:\r\n    #0 0x7f52f54d97a7 in __interceptor_strdup ../../../../src/libsanitizer/asan/asan_interceptors.cpp:454\r\n    #1 0x7f52f54423cd  (/lib/x86_64-linux-gnu/libcurl.so.4+0x673cd)\r\n\r\nSUMMARY: AddressSanitizer: 260 byte(s) leaked in 4 allocation(s).\r\n```\r\n\r\nand valgrind does too:\r\n\r\n```text\r\n$ cc -g main.c $(pkg-config --cflags --libs libcurl) -o valgrind && valgrind --leak-check=full ./valgrind\r\n==41878== \r\n==41878== HEAP SUMMARY:\r\n==41878==     in use at exit: 3,710 bytes in 12 blocks\r\n==41878==   total heap usage: 32,937 allocs, 32,925 frees, 3,397,085 bytes allocated\r\n==41878== \r\n==41878== 260 bytes in 4 blocks are definitely lost in loss record 5 of 8\r\n==41878==    at 0x483F7B5: malloc (in /usr/libexec/valgrind/vgpreload_memcheck-amd64-linux.so)\r\n==41878==    by 0x499331A: strdup (strdup.c:42)\r\n==41878==    by 0x48CB3CD: ??? (in /usr/lib/x86_64-linux-gnu/libcurl.so.4.8.0)\r\n==41878==    by 0x48AB9B7: ??? (in /usr/lib/x86_64-linux-gnu/libcurl.so.4.8.0)\r\n==41878==    by 0x48AC81D: curl_multi_perform (in /usr/lib/x86_64-linux-gnu/libcurl.so.4.8.0)\r\n==41878==    by 0x4884AE2: curl_easy_perform (in /usr/lib/x86_64-linux-gnu/libcurl.so.4.8.0)\r\n==41878==    by 0x1092FB: main (main.c:15)\r\n==41878== \r\n==41878== LEAK SUMMARY:\r\n==41878==    definitely lost: 260 bytes in 4 blocks\r\n==41878==    indirectly lost: 0 bytes in 0 blocks\r\n==41878==      possibly lost: 0 bytes in 0 blocks\r\n==41878==    still reachable: 3,450 bytes in 8 blocks\r\n==41878==         suppressed: 0 bytes in 0 blocks\r\n==41878== Reachable blocks (those to which a pointer was found) are not shown.\r\n==41878== To see them, rerun with: --leak-check=full --show-leak-kinds=all\r\n==41878== \r\n==41878== For lists of detected and suppressed errors, rerun with: -s\r\n==41878== ERROR SUMMARY: 1 errors from 1 contexts (suppressed: 0 from 0)\r\n```\r\n\r\nThe size of the leak depends on the value of `CURLOPT_XOAUTH2_BEARER`; in this example it is 260 because the token is 65 characters long (including `'\\0'`) times 4.\r\n\r\n### I expected the following\r\n\r\nRepeatedly performing HTTP requests with the same handle when a bearer token is set with the `CURLOPT_XOAUTH2_BEARER` option should not leak the token on each request.\r\n\r\n### curl/libcurl version\r\n\r\ncurl 7.83.0 (x86_64-pc-linux-gnu) libcurl/7.83.0 OpenSSL/1.1.1o zlib/1.2.11 brotli/1.0.9 zstd/1.5.2 libidn2/2.3.2 libpsl/0.21.0 (+libidn2/2.3.0) libssh2/1.10.0 nghttp2/1.43.0 librtmp/2.3 OpenLDAP/2.5.11\r\nRelease-Date: 2022-04-27\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps ldap ldaps mqtt pop3 pop3s rtmp rtsp scp sftp smb smbs smtp smtps telnet tftp \r\nFeatures: alt-svc AsynchDNS brotli GSS-API HSTS HTTP2 HTTPS-proxy IDN IPv6 Kerberos Largefile libz NTLM NTLM_WB PSL SPNEGO SSL TLS-SRP UnixSockets zstd\r\n\r\n### operating system\r\n\r\n`Linux debian 5.17.0-1-amd64 #1 SMP PREEMPT Debian 5.17.3-1 (2022-04-18) x86_64 GNU/Linux`\r\n","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/8841/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/8841/timeline","performed_via_github_app":null,"state_reason":"completed"}