{"url":"https://api.github.com/repos/curl/curl/issues/16706","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/16706/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/16706/comments","events_url":"https://api.github.com/repos/curl/curl/issues/16706/events","html_url":"https://github.com/curl/curl/issues/16706","id":2916976302,"node_id":"I_kwDOAAiu0c6t3Yau","number":16706,"title":"ws: auto-pong reply does not account for chunked sending","user":{"login":"viscruocco","id":175393447,"node_id":"U_kgDOCnRKpw","avatar_url":"https://avatars.githubusercontent.com/u/175393447?v=4","gravatar_id":"","url":"https://api.github.com/users/viscruocco","html_url":"https://github.com/viscruocco","followers_url":"https://api.github.com/users/viscruocco/followers","following_url":"https://api.github.com/users/viscruocco/following{/other_user}","gists_url":"https://api.github.com/users/viscruocco/gists{/gist_id}","starred_url":"https://api.github.com/users/viscruocco/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/viscruocco/subscriptions","organizations_url":"https://api.github.com/users/viscruocco/orgs","repos_url":"https://api.github.com/users/viscruocco/repos","events_url":"https://api.github.com/users/viscruocco/events{/privacy}","received_events_url":"https://api.github.com/users/viscruocco/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":352090567,"node_id":"MDU6TGFiZWwzNTIwOTA1Njc=","url":"https://api.github.com/repos/curl/curl/labels/KNOWN_BUGS%20material","name":"KNOWN_BUGS material","color":"d93f0b","default":false,"description":null},{"id":4294582278,"node_id":"LA_kwDOAAiu0c7_-iAG","url":"https://api.github.com/repos/curl/curl/labels/WebSocket","name":"WebSocket","color":"A51BBC","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2025-03-13T12:25:24Z","updated_at":"2025-09-05T11:17:50Z","closed_at":"2025-09-05T11:17:50Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nWhile reviewing the libcurl code I noticed this:\n\nLibcurl automatically responds to incoming WebSocket PINGs with an\nimmediate PONG reply. Here is the code block executed by `curl_ws_recv()`\nwhen a PING is received:\n[Link](https://github.com/curl/curl/blob/5273ab4e6d41b2097651982c96ad356ffd667ba6/lib/ws.c#L435-L441)\n```\n/* auto-respond to PINGs, only works for single-frame payloads atm */\nsize_t bytes;\ninfof(data, \"WS: auto-respond to PING with a PONG\");\n/* send back the exact same content as a PONG */\n*err = curl_ws_send(data, buf, buflen, &bytes, 0, CURLWS_PONG);\nif(*err)\n  return -1;\n```\n\nI'm seeing two issues with the ways this is handled, both caused by the possibility\nthat `curl_ws_send()` might not completely send the data in a single call.\n\n1. An application that is using the WebSocket connection in a \"duplex\" fashion\n   might perform the following sequence of operations:\n   1. First it calls `curl_ws_send()`, but either gets CURLE_AGAIN or gets\n      CURLE_OK with only partially sent data.\n   2. Then the application does not wait to complete sending, but instead calls\n      `curl_ws_recv()`.\n      - During `curl_ws_recv()` an incoming PING frame is detected\n        by the auto-pong logic, so it will immediately try to send the PONG\n        reply. Now the `curl_ws_send()` call from within `curl_ws_recv()` will\n        break the encoder state, because `curl_ws_send()` is not able to handle\n        (let alone detect) two competing send operations given to it.\n2. If the `curl_ws_send()` call in `curl_ws_recv()` fails to send the complete PONG\n   frame at once, then this remains undetected because the return value for such\n   a case is CURLE_OK (02edae54e8b3953b8aeb0ff91be86d5db2169670) and the\n   `bytes` output parameter is not checked here.\n   (I'm not sure whether this problem might have been already fixed through\n   3e64569a9e1d7e8a1dd6d9a1637d1ec3f6c81ad9 somehow?)\n\n\n### I expected the following\n\n## Potential fix\n\nTo fix both problems in a backwards compatible way and not risk dropping any PONG\nreplies, a possible solutions seems to be:\n1. Before sending the PONG `curl_ws_recv()` must detect whether it is in the first\n   situation (i.e. `curl_ws_send()` is currently busy sending application data).\n     - If yes: Return CURLE_AGAIN from `curl_ws_recv()` and put `curl_ws_recv()`\n       into a \"wait state\", where it always returns CURLE_AGAIN until `curl_ws_send()`\n       is available again. Then continue with sending the PONG.\n       (Note that the application might accidentally congest `curl_ws_send()`\n       in such a way that this \"wait state\" will never be left.)\n2. After attempting to send the PONG frame `curl_ws_recv()` must check whether \n   it is in the second situation (i.e. sending the PONG frame only partially completed).\n     - If yes: Return CURLE_AGAIN from `curl_ws_recv()` and put `curl_ws_recv()`\n       into a \"wait state\", where is always returns CURLE_AGAIN until `curl_ws_send()`\n       has finished to send the PONG frame. Additionally `curl_ws_send()` must be\n       put into a \"wait state\" where it performs the PONG sending and returns\n       CURLE_AGAIN on calls with other data by the application. (To reliably\n       distinguish between calls made by the application versus internal calls\n       a new flag might potentially be useful/necessary?)\n\n## Disabling auto-pong reply\n\n#12220 / #16744 adds the option to disable the auto-pong reply feature. This is the\nsolution we are looking for to use in our application!\n\nOf course this doesn't fix the issue itself and especially does not fix any\nexisting applications that use the feature today.\n\n### curl/libcurl version\n\nmaster (d4f9788, curl 8.12.1)\n\n### operating system\n\nN/A\n\n## EDIT\n\nEDIT: Added reference to #16744","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/16706/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/16706/timeline","performed_via_github_app":null,"state_reason":"completed"}