{"url":"https://api.github.com/repos/curl/curl/issues/10157","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/10157/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/10157/comments","events_url":"https://api.github.com/repos/curl/curl/issues/10157/events","html_url":"https://github.com/curl/curl/issues/10157","id":1510216315,"node_id":"I_kwDOAAiu0c5aBBJ7","number":10157,"title":"Websockets - 150 seconds to connect to the endpoint","user":{"login":"mahisnghrwt","id":47043422,"node_id":"MDQ6VXNlcjQ3MDQzNDIy","avatar_url":"https://avatars.githubusercontent.com/u/47043422?v=4","gravatar_id":"","url":"https://api.github.com/users/mahisnghrwt","html_url":"https://github.com/mahisnghrwt","followers_url":"https://api.github.com/users/mahisnghrwt/followers","following_url":"https://api.github.com/users/mahisnghrwt/following{/other_user}","gists_url":"https://api.github.com/users/mahisnghrwt/gists{/gist_id}","starred_url":"https://api.github.com/users/mahisnghrwt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mahisnghrwt/subscriptions","organizations_url":"https://api.github.com/users/mahisnghrwt/orgs","repos_url":"https://api.github.com/users/mahisnghrwt/repos","events_url":"https://api.github.com/users/mahisnghrwt/events{/privacy}","received_events_url":"https://api.github.com/users/mahisnghrwt/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":4294582278,"node_id":"LA_kwDOAAiu0c7_-iAG","url":"https://api.github.com/repos/curl/curl/labels/WebSocket","name":"WebSocket","color":"A51BBC","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-12-25T00:34:34Z","updated_at":"2022-12-27T22:45:06Z","closed_at":"2022-12-27T09:49:54Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\r\nI am using the `multi_socket` interface with `libev` to connect to a WebSocket endpoint. I have observed an intermittent bug where curl gets stuck `CURLMstate::MSTATE_CONNECTING` stage for around 150 seconds because the underlying socket wasn't writable(`is_connected` `done` out parameter is `false`) when curl checked. And, nearest timeout set is for `EXPIRE_DNS_PER_NAME` which defaults to 200 seconds. But, every single time, eventually, curl connects to the endpoint.\r\n\r\n### I expected the following\r\nI'd expect curl to routinely check the underlying socket until it becomes writable.\r\n\r\n### This might help in reproducing the bug\r\n- Websocket endpoint - `wss://fstream.binance.com/stream?streams=btcusdt@depth5`\r\n- Set `CURLOPT_HAPPY_EYEBALLS_TIMEOUT_MS` to `100`(ms) (Not sure how this is related.)\r\n- Only add a single easy handle to the multi interface.\r\n- Log\r\n    ```\r\n   [Thread debugging using libthread_db enabled]\r\n    Using host libthread_db library \"/lib/x86_64-linux-gnu/libthread_db.so.1\".\r\n    [Detaching after vfork from child process 7672]\r\n    OpenSSL 1.1.1s  1 Nov 2022\r\n    libcurl version: 7.87.0\r\n    * STATE: INIT => CONNECT handle 0x1346808; line 1909 (connection #-5000)\r\n    * Added connection 0. The cache now contains 1 members\r\n    [New Thread 0x7ffff76a1700 (LWP 7674)]\r\n    * STATE: CONNECT => RESOLVING handle 0x1346808; line 1955 (connection #0)\r\n    * [CONN-0-0] setup, init filter chain\r\n    * [CONN-0-0] cf_add(filter=SOCKET)\r\n    * [CONN-0-0] cf_add(filter=SSL)\r\n    * [CONN-0-0][CF-SOCKET] setup(remotehost=fstream.binance.com)\r\n    * STATE: RESOLVING => CONNECTING handle 0x1346808; line 2029 (connection #0)\r\n    * family0 == v4, family1 == v6\r\n    *   Trying 3.113.111.236:443...\r\n    [Thread 0x7ffff76a1700 (LWP 7674) exited]\r\n    * [CONN-0-0] connect(block=0)-> 0, done=0\r\n    * [CONN-0-0] connect(block=0)-> 0, done=0\r\n    * [CONN-0-0] connect(block=0)-> 0, done=0\r\n    * [CONN-0-0] connect(block=0)-> 0, done=0\r\n    [New Thread 0x7ffff76a1700 (LWP 7677)]\r\n    // Stuck for 150 seconds\r\n    ```\r\n- Log from gdb\r\n    ```\r\n    [Detaching after vfork from child process 13557]\r\n    OpenSSL 1.1.1s  1 Nov 2022\r\n    libcurl version: 7.87.0\r\n    \r\n    Breakpoint 1, Curl_expire (data=0x1346808, milli=0, id=EXPIRE_RUN_NOW) at multi.c:3517\r\n    3517\tin multi.c\r\n    data = 0x1346808\r\n    milli = 0\r\n    id = EXPIRE_RUN_NOW\r\n    * STATE: INIT => CONNECT handle 0x1346808; line 1909 (connection #-5000)\r\n    * Added connection 0. The cache now contains 1 members\r\n    [New Thread 0x7ffff76a1700 (LWP 13559)]\r\n    \r\n    Thread 1 \"url_test.bin\" hit Breakpoint 1, Curl_expire (data=0x1346808, milli=1, id=EXPIRE_ASYNC_NAME) at multi.c:3517\r\n    3517\tin multi.c\r\n    data = 0x1346808\r\n    milli = 1\r\n    id = EXPIRE_ASYNC_NAME\r\n    * STATE: CONNECT => RESOLVING handle 0x1346808; line 1955 (connection #0)\r\n    \r\n    Thread 1 \"url_test.bin\" hit Breakpoint 1, Curl_expire (data=0x1346808, milli=2, id=EXPIRE_ASYNC_NAME) at multi.c:3517\r\n    3517\tin multi.c\r\n    data = 0x1346808\r\n    milli = 2\r\n    id = EXPIRE_ASYNC_NAME\r\n    \r\n    Thread 1 \"url_test.bin\" hit Breakpoint 1, Curl_expire (data=0x1346808, milli=4, id=EXPIRE_ASYNC_NAME) at multi.c:3517\r\n    3517\tin multi.c\r\n    data = 0x1346808\r\n    milli = 4\r\n    id = EXPIRE_ASYNC_NAME\r\n    \r\n    Thread 1 \"url_test.bin\" hit Breakpoint 1, Curl_expire (data=0x1346808, milli=8, id=EXPIRE_ASYNC_NAME) at multi.c:3517\r\n    3517\tin multi.c\r\n    data = 0x1346808\r\n    milli = 8\r\n    id = EXPIRE_ASYNC_NAME\r\n    \r\n    Thread 1 \"url_test.bin\" hit Breakpoint 1, Curl_expire (data=0x1346808, milli=16, id=EXPIRE_ASYNC_NAME) at multi.c:3517\r\n    3517\tin multi.c\r\n    data = 0x1346808\r\n    milli = 16\r\n    id = EXPIRE_ASYNC_NAME\r\n    [Thread 0x7ffff76a1700 (LWP 13559) exited]\r\n    \r\n    Thread 1 \"url_test.bin\" hit Breakpoint 1, Curl_expire (data=0x1346808, milli=0, id=EXPIRE_RUN_NOW) at multi.c:3517\r\n    3517\tin multi.c\r\n    data = 0x1346808\r\n    milli = 0\r\n    id = EXPIRE_RUN_NOW\r\n    \r\n    Thread 1 \"url_test.bin\" hit Breakpoint 1, Curl_expire (data=0x1346808, milli=7, id=EXPIRE_ASYNC_NAME) at multi.c:3517\r\n    3517\tin multi.c\r\n    data = 0x1346808\r\n    milli = 7\r\n    id = EXPIRE_ASYNC_NAME\r\n    * [CONN-0-0] setup, init filter chain\r\n    * [CONN-0-0] cf_add(filter=SOCKET)\r\n    * [CONN-0-0] cf_add(filter=SSL)\r\n    * [CONN-0-0][CF-SOCKET] setup(remotehost=fstream.binance.com)\r\n    * STATE: RESOLVING => CONNECTING handle 0x1346808; line 2029 (connection #0)\r\n    * family0 == v4, family1 == v6\r\n    *   Trying 52.197.50.89:443...\r\n    \r\n    Thread 1 \"url_test.bin\" hit Breakpoint 1, Curl_expire (data=0x1346808, milli=149988, id=EXPIRE_DNS_PER_NAME) at multi.c:3517\r\n    3517\tin multi.c\r\n    data = 0x1346808\r\n    milli = 149988\r\n    id = EXPIRE_DNS_PER_NAME\r\n    \r\n    Thread 1 \"url_test.bin\" hit Breakpoint 1, Curl_expire (data=0x1346808, milli=149988, id=EXPIRE_DNS_PER_NAME2) at multi.c:3517\r\n    3517\tin multi.c\r\n    data = 0x1346808\r\n    milli = 149988\r\n    id = EXPIRE_DNS_PER_NAME2\r\n    \r\n    Thread 1 \"url_test.bin\" hit Breakpoint 1, Curl_expire (data=0x1346808, milli=100, id=EXPIRE_HAPPY_EYEBALLS) at multi.c:3517\r\n    3517\tin multi.c\r\n    data = 0x1346808\r\n    milli = 100\r\n    id = EXPIRE_HAPPY_EYEBALLS\r\n    * [CONN-0-0] connect(block=0)-> 0, done=0\r\n    * [CONN-0-0] connect(block=0)-> 0, done=0\r\n    * [CONN-0-0] connect(block=0)-> 0, done=0\r\n    [New Thread 0x7ffff76a1700 (LWP 13560)]\r\n\r\n    ```\r\n### curl/libcurl version\r\n```\r\ncurl 7.87.0 (x86_64-pc-linux-gnu) libcurl/7.87.0 OpenSSL/1.1.1s zlib/1.2.11\r\nRelease-Date: 2022-12-21\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps mqtt pop3 pop3s rtsp smb smbs smtp smtps telnet tftp ws wss\r\nFeatures: alt-svc AsynchDNS Debug HSTS HTTPS-proxy IPv6 Largefile libz NTLM NTLM_WB SSL threadsafe TLS-SRP TrackMemory UnixSockets\r\n```\r\n\r\n### operating system\r\n```\r\nLinux mahi 5.13.0-30-generic #33~20.04.1-Ubuntu SMP Mon Feb 7 14:25:10 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux\r\n```\r\n","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/10157/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/10157/timeline","performed_via_github_app":null,"state_reason":"completed"}