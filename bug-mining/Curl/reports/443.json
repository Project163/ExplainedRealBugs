{"url":"https://api.github.com/repos/curl/curl/issues/13321","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/13321/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/13321/comments","events_url":"https://api.github.com/repos/curl/curl/issues/13321/events","html_url":"https://github.com/curl/curl/issues/13321","id":2232609903,"node_id":"I_kwDOAAiu0c6FEuxv","number":13321,"title":"mbedtls: trace with double-lines","user":{"login":"gvanem","id":945271,"node_id":"MDQ6VXNlcjk0NTI3MQ==","avatar_url":"https://avatars.githubusercontent.com/u/945271?v=4","gravatar_id":"","url":"https://api.github.com/users/gvanem","html_url":"https://github.com/gvanem","followers_url":"https://api.github.com/users/gvanem/followers","following_url":"https://api.github.com/users/gvanem/following{/other_user}","gists_url":"https://api.github.com/users/gvanem/gists{/gist_id}","starred_url":"https://api.github.com/users/gvanem/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gvanem/subscriptions","organizations_url":"https://api.github.com/users/gvanem/orgs","repos_url":"https://api.github.com/users/gvanem/repos","events_url":"https://api.github.com/users/gvanem/events{/privacy}","received_events_url":"https://api.github.com/users/gvanem/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118221,"node_id":"MDU6TGFiZWwxODQxMTgyMjE=","url":"https://api.github.com/repos/curl/curl/labels/TLS","name":"TLS","color":"bfdadc","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2024-04-09T05:05:57Z","updated_at":"2024-04-12T16:28:10Z","closed_at":"2024-04-12T16:28:10Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nI built libcurl for multiple SSL-backends (including MBedTLS) **and** with \r\n`-DMBEDTLS_DEBUG=1 -DMBEDTLS_DEBUG_C=1 -DCURLDEBUG=1` in my `CFLAGS`. \r\nBut the result of running:\r\n```c\r\n  set CURL_SSL_BACKEND=mbedtls\r\n  curl --trace-ascii mbedtls-trace.txt https://example.com\r\n```\r\nor:\r\n```\r\n  curl --trace-ascii - https://example.com > mbedtls-trace.txt\r\n```\r\n\r\nlooks awful:\r\n```\r\n  ...\r\n  == Info: Didn't find Session ID in cache for host HTTPS://example.com:443\r\n  == Info: ALPN: curl offers h2,http/1.1\r\n  == Info: => handshake\r\n\r\n  == Info: => flush output\r\n\r\n  == Info: <= flush output\r\n\r\n  == Info: client state: MBEDTLS_SSL_HELLO_REQUEST\r\n  ...\r\n\r\n```\r\nSince the function `mbed_debug()` already gets the line with `\\n` termination. \r\nAnd then `infof()` adds another `\\n` to the output. Hence I stripped off the last `\\n` and it looks better:\r\n```diff\r\n--- a/vtls/mbedtls.c 2024-04-08 15:10:01\r\n+++ b/vtls/mbedtls.c 2024-04-09 06:42:19\r\n@@ -164,13 +164,25 @@\r\n                        int line_nb, const char *line)\r\n {\r\n   struct Curl_easy *data = NULL;\r\n+  const char *nl;\r\n+  int   len;\r\n\r\n   if(!context)\r\n     return;\r\n\r\n   data = (struct Curl_easy *)context;\r\n+  nl = strrchr (line, '\\n');\r\n+  if (nl)\r\n+     len = nl - line;\r\n+  else\r\n+     len = strlen(line);\r\n+  infof(data, \"%.*s\", len, line);\r\n-  infof(data, \"%s\", line);\r\n   (void) level;\r\n }\r\n #endif\r\n```\r\n\r\nBut as an added bonus, I'd like that a `curl -vv  https://example.com 2> mbedtls-trace.txt` (verbose level 2), to\r\ninclude the filename and line from MBedTls:\r\n```c\r\n  if (data->set.verbose >= 2)\r\n     infof(data, \"%s(%u): %.*s\", f_name, line_nb, len, line);\r\n  else\r\n     infof(data, \"%.*s\", len, line);\r\n```\r\n\r\nBut that seems impossible now. How is this supposed to be handled?\n\n### I expected the following\n\nNo empty lines (like for other SSL-backends),\n\n### curl/libcurl version\n\n`curl 8.7.2-DEV (x86_64-pc-win32)` from `git master` yesterday.\n\n### operating system\n\nWin-10.","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/13321/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/13321/timeline","performed_via_github_app":null,"state_reason":"completed"}