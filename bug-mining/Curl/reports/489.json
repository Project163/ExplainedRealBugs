{"url":"https://api.github.com/repos/curl/curl/issues/12177","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/12177/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/12177/comments","events_url":"https://api.github.com/repos/curl/curl/issues/12177/events","html_url":"https://github.com/curl/curl/issues/12177","id":1955558971,"node_id":"I_kwDOAAiu0c50j3Y7","number":12177,"title":"`-T /dev/stdin`/`-T /dev/fd/$n` may upload with an incorrect content length on BSDs","user":{"login":"emanuele6","id":20175435,"node_id":"MDQ6VXNlcjIwMTc1NDM1","avatar_url":"https://avatars.githubusercontent.com/u/20175435?v=4","gravatar_id":"","url":"https://api.github.com/users/emanuele6","html_url":"https://github.com/emanuele6","followers_url":"https://api.github.com/users/emanuele6/followers","following_url":"https://api.github.com/users/emanuele6/following{/other_user}","gists_url":"https://api.github.com/users/emanuele6/gists{/gist_id}","starred_url":"https://api.github.com/users/emanuele6/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/emanuele6/subscriptions","organizations_url":"https://api.github.com/users/emanuele6/orgs","repos_url":"https://api.github.com/users/emanuele6/repos","events_url":"https://api.github.com/users/emanuele6/events{/privacy}","received_events_url":"https://api.github.com/users/emanuele6/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":192912238,"node_id":"MDU6TGFiZWwxOTI5MTIyMzg=","url":"https://api.github.com/repos/curl/curl/labels/cmdline%20tool","name":"cmdline tool","color":"006b75","default":false,"description":null},{"id":352090567,"node_id":"MDU6TGFiZWwzNTIwOTA1Njc=","url":"https://api.github.com/repos/curl/curl/labels/KNOWN_BUGS%20material","name":"KNOWN_BUGS material","color":"d93f0b","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2023-10-21T16:19:52Z","updated_at":"2024-06-27T14:50:59Z","closed_at":"2024-06-27T14:50:59Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\r\n\r\n`-T path` will stat `path` to figure out its size in bytes to use it as `Content-Length` if it is a regular file.\r\n\r\nThe problem with that is that, on BSDs and some other UNIXes (not Linux), `open(path)` may not give you a file descriptor with a 0 offset from the start of the file.\r\n\r\nOn BSDs, if the path given to open is to a `/dev/fd/*` file or `/dev/stdin`, `/dev/stdout`, `/dev/stderr`, that will trigger a special behaviour for `open`: `open` on BSD, instead of reopening the file related to that file descriptor with different open modes like in Linux, will actually duplicate the file descriptor specified by that path if its open modes are compatible with the ones requested by `open`, and otherwise fail.\r\n\r\nSince `-T /dev/fd/4` for example, will effectively just be a `dup(4)`, when `curl` will open the path it thinks is for a regular file (because fd 4 is indeed a file descriptor for a regular file, `myfile`), it will not find itself at byte offset 0 into the file, and will send less data than `Content-Length`.\r\n\r\n```sh\r\nprintf 'NAME\\tJOB\\nTom\\tCarpenter\\nAlice\\tMechanic\\n' > myfile\r\n{\r\n   read -r skip_firstline <&4 &&\r\n   curl -T /dev/fd/4 localhost:43000\r\n} 4< myfile\r\n```\r\n```console\r\n$ nc -l localhost:43000\r\nPUT /4 HTTP/1.1\r\nHost: localhost:43000\r\nUser-Agent: curl/8.2.1\r\nAccept: */*\r\nContent-Length: 38\r\n\r\nTom     Carpenter\r\nAlice   Mechanic\r\n```\r\n\r\n### I expected the following\r\n\r\nI expected:\r\n```console\r\n$ nc -l 43000\r\nPUT /4 HTTP/1.1\r\nHost: localhost:43000\r\nUser-Agent: curl/8.2.1\r\nAccept: */*\r\nContent-Length: 29\r\n\r\nTom     Carpenter\r\nAlice   Mechanic\r\n```\r\n`curl` should checked the current offset into the regular file and use its `size - offset` as content length instead of just using its size.\r\n\r\n---\r\nOther possible alternatives:\r\n* check if the offset into the file is not 0 after operning it, and perform a chunked upload in that case\r\n```console\r\n$ nc -l 43000\r\nPUT /4 HTTP/1.1\r\nHost: localhost:43000\r\nUser-Agent: curl/8.2.1\r\nAccept: */*\r\nTransfer-Encoding: chunked\r\nExpect: 100-continue\r\n\r\n1d\r\nTom     Carpenter\r\nAlice   Mechanic\r\n\r\n0\r\n[...]\r\n```\r\n* seek to offset 0 after opening the regular file and send the entire file:\r\n```console\r\n$ nc -l 43000\r\nPUT /4 HTTP/1.1\r\nHost: localhost:43000\r\nUser-Agent: curl/8.2.1\r\nAccept: */*\r\nContent-Length: 38\r\n\r\nNAME    JOB\r\nTom     Carpenter\r\nAlice   Mechanic\r\n```\r\n\r\n---\r\nThose solutions are all fairly easy to implement. I, personally, would prefer either the first or the second approach, I don't really like the idea of `curl` seeking back to 0 after opening.\r\n\r\n### curl/libcurl version\r\n\r\ncurl 8.2.1 (I am using my <https://sdf.org/> shell account to test this)\r\n```\r\ncurl 8.2.1 (x86_64--netbsd) libcurl/8.2.1 OpenSSL/1.1.1u zlib/1.2.13 libidn2/2.3.4 nghttp2/1.52.0\r\nRelease-Date: 2023-07-26\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps mqtt pop3 pop3s rtsp smb smbs smtp smtps telnet tftp\r\nFeatures: alt-svc AsynchDNS GSS-API HSTS HTTP2 HTTPS-proxy IDN IPv6 Kerberos Largefile libz NTLM NTLM_WB SPNEGO SSL threadsafe TLS-SRP UnixSocket\r\n```\r\n\r\n### operating system\r\n\r\n```\r\nNetBSD sdf 9.3 NetBSD 9.3 (GENERIC) #0: Thu Aug  4 15:30:37 UTC 2022  mkrepro@mkrepro.NetBSD.org:/usr/src/sys/arch/amd64/compile/GENERIC amd64\r\n```","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/12177/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/12177/timeline","performed_via_github_app":null,"state_reason":"completed"}