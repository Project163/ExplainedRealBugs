{"url":"https://api.github.com/repos/curl/curl/issues/10704","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/10704/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/10704/comments","events_url":"https://api.github.com/repos/curl/curl/issues/10704/events","html_url":"https://github.com/curl/curl/issues/10704","id":1613686697,"node_id":"I_kwDOAAiu0c5gLuep","number":10704,"title":"header_json emits incorrect JSON with multi-value headers ","user":{"login":"inca","id":118196,"node_id":"MDQ6VXNlcjExODE5Ng==","avatar_url":"https://avatars.githubusercontent.com/u/118196?v=4","gravatar_id":"","url":"https://api.github.com/users/inca","html_url":"https://github.com/inca","followers_url":"https://api.github.com/users/inca/followers","following_url":"https://api.github.com/users/inca/following{/other_user}","gists_url":"https://api.github.com/users/inca/gists{/gist_id}","starred_url":"https://api.github.com/users/inca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/inca/subscriptions","organizations_url":"https://api.github.com/users/inca/orgs","repos_url":"https://api.github.com/users/inca/repos","events_url":"https://api.github.com/users/inca/events{/privacy}","received_events_url":"https://api.github.com/users/inca/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":192912238,"node_id":"MDU6TGFiZWwxOTI5MTIyMzg=","url":"https://api.github.com/repos/curl/curl/labels/cmdline%20tool","name":"cmdline tool","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":0,"created_at":"2023-03-07T15:26:59Z","updated_at":"2023-03-08T23:14:20Z","closed_at":"2023-03-08T23:14:20Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\r\n\r\nThere is a backend that returns several multi-value headers in overlapping order:\r\n\r\n```\r\n< HTTP/2 200 \r\n< server: nginx\r\n< date: Tue, 07 Mar 2023 15:14:41 GMT\r\n< content-type: application/json\r\n< content-length: 12265\r\n< vary: Accept-Encoding\r\n< access-control-allow-origin: *\r\n< vary: Accept-Encoding\r\n< referrer-policy: strict-origin-when-cross-origin\r\n< access-control-allow-methods: GET, POST, PUT, DELETE, OPTIONS\r\n< access-control-max-age: 1728000\r\n< access-control-allow-headers: Authorization, Content-Type, AuthorizationOauth, X-EARLY-ACCESS\r\n< access-control-expose-headers: \r\n< vary: Accept\r\n< etag: W/\"2678f9ab2ba550d164e7cc014aefd31e\"\r\n< cache-control: max-age=0, private, must-revalidate\r\n< x-request-id: 375b343b3d2ecf9b442c0daf00fc4a9a\r\n< strict-transport-security: max-age=31536000; includeSubDomains\r\n< x-content-type-options: nosniff\r\n< x-xss-protection: 1; mode=block\r\n< referrer-policy: strict-origin-when-cross-origin\r\n< feature-policy: accelerometer 'none'; camera 'none'; geolocation 'none'; gyroscope 'none'; magnetometer 'none'; microphone 'none'; payment 'none'; usb 'none'\r\n```\r\n\r\nYou can see the `vary` and `referrer-policy` occurring multiple times. With `-w %{header_json}` option the JSON produced becomes incorrect:\r\n\r\n```json\r\n{\r\n\t\"server\": [\"nginx\"],\r\n\t\"date\": [\"Tue, 07 Mar 2023 11:31:47 GMT\"],\r\n\t\"content-type\": [\"application/json\"],\r\n\t\"content-length\": [\"12265\"],\r\n\t\"vary\": [\"Accept-Encoding\", \"Accept-Encoding\", \"Accept\"],\r\n\t\"etag\": [\"W/\\\"2678f9ab2ba550d164e7cc014aefd31e\\\"\"],\r\n\t\"cache-control\": [\"max-age=0, private, must-revalidate\"],\r\n\t\"x-request-id\": [\"ad2176d584f1c5b1a56b564af1969efa\"],\r\n\t\"strict-transport-security\": [\"max-age=31536000; includeSubDomains\"],\r\n\t\"x-content-type-options\": [\"nosniff\"],\r\n\t\"x-xss-protection\": [\"1; mode=block\"],\r\n\t\"referrer-policy\": ],\r\n\t\"feature-policy\": [\"accelerometer 'none'; camera 'none'; geolocation 'none'; gyroscope 'none'; magnetometer 'none'; microphone 'none'; payment 'none'; usb 'none'\"]\r\n}\r\n```\r\n\r\nNotice the `\t\"referrer-policy\": ],`. Also notice that headers between the first occurrence of the first multi-value header (vary) are also missing.\r\n\r\nHere's the cURL command to reproduce the issue (note: the token is taken from the official docs, so feel free to use it).\r\n\r\n```\r\ncurl https://api.pagerduty.com/oncalls -H \"Accept: application/vnd.pagerduty+json;version=2\" -H \"Content-Type: application/json\" -H \"Authorization: Token token=y_NbAkKc66ryYTWUXYEu\" -w %{header_json}\r\n```\r\n\r\nI managed to track it down to `headerJSON` right here: https://github.com/curl/curl/blob/a26418cf14b987d6c3221a8084600a2ee463609d/src/tool_writeout_json.c#L131-L132 â€” I suspect that `prev` pointer gets overwritten by that last call to `curl_easy_header` before breaking from the loop; therefore the next iteration of the `while` starts from `etag` (which is the next header after the last occurrence of `vary`) and therefore misses the first occurrence of another multi-value header `referrer-policy` (along with all other headers in between the first and the last occurrence of `vary`). By the time the outer loop reaches `referrer-policy` it actually sees the second occurrence (with index `1`) and that causes the method to only [emit a closing bracket](https://github.com/curl/curl/blob/a26418cf14b987d6c3221a8084600a2ee463609d/src/tool_writeout_json.c#L136) because [the branch before it](https://github.com/curl/curl/blob/a26418cf14b987d6c3221a8084600a2ee463609d/src/tool_writeout_json.c#L119-L134) is never entered.\r\n\r\n### I expected the following\r\n\r\nJSON should be valid. All headers should be present.\r\n\r\n### curl/libcurl version\r\n\r\n7.88.1\r\n\r\n### operating system\r\n\r\nmacOS 12.5.1\r\n\r\n/cc @christellevs\r\n","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/10704/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":1,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/10704/timeline","performed_via_github_app":null,"state_reason":"completed"}