{"url":"https://api.github.com/repos/curl/curl/issues/11007","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/11007/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/11007/comments","events_url":"https://api.github.com/repos/curl/curl/issues/11007/events","html_url":"https://github.com/curl/curl/issues/11007","id":1678352650,"node_id":"I_kwDOAAiu0c5kCaEK","number":11007,"title":"--aws-sigv4 does not behave well with AWS VPC Lattice services","user":{"login":"ajoga","id":37543966,"node_id":"MDQ6VXNlcjM3NTQzOTY2","avatar_url":"https://avatars.githubusercontent.com/u/37543966?v=4","gravatar_id":"","url":"https://api.github.com/users/ajoga","html_url":"https://github.com/ajoga","followers_url":"https://api.github.com/users/ajoga/followers","following_url":"https://api.github.com/users/ajoga/following{/other_user}","gists_url":"https://api.github.com/users/ajoga/gists{/gist_id}","starred_url":"https://api.github.com/users/ajoga/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajoga/subscriptions","organizations_url":"https://api.github.com/users/ajoga/orgs","repos_url":"https://api.github.com/users/ajoga/repos","events_url":"https://api.github.com/users/ajoga/events{/privacy}","received_events_url":"https://api.github.com/users/ajoga/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118243,"node_id":"MDU6TGFiZWwxODQxMTgyNDM=","url":"https://api.github.com/repos/curl/curl/labels/HTTP","name":"HTTP","color":"207de5","default":false,"description":null},{"id":352090567,"node_id":"MDU6TGFiZWwzNTIwOTA1Njc=","url":"https://api.github.com/repos/curl/curl/labels/KNOWN_BUGS%20material","name":"KNOWN_BUGS material","color":"d93f0b","default":false,"description":null},{"id":538402904,"node_id":"MDU6TGFiZWw1Mzg0MDI5MDQ=","url":"https://api.github.com/repos/curl/curl/labels/authentication","name":"authentication","color":"e99695","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2023-04-21T11:16:34Z","updated_at":"2025-05-20T23:05:59Z","closed_at":"2023-08-06T21:39:05Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\r\n\r\nDownloaded curl curl-8.0.1, patched like:\r\n\r\n```\r\n~/environment/curl-8.0.1 $ diff lib/http_aws_sigv4.c*\r\n350c350\r\n<   if(false) {\r\n---\r\n>   if(empty_payload || post_payload) {\r\n488c488\r\n<                 strcasecompare(service, \"vpc-lattice-svcs\"));\r\n---\r\n>                 strcasecompare(service, \"s3\"));\r\n```\r\n\r\nSo I could run:\r\n\r\n```\r\n$ ./src/curl --aws-sigv4 \"aws:amz:eu-west-1:vpc-lattice-svcs\" --user \"${ACCESS_KEY_ID}:${SECRET_ACCESS_KEY}\" -H \"x-amz-security-token: $SESSION_TOKEN\" http://helloworld-XXXXXXX.XXXXXXX.vpc-lattice-svcs.eu-west-1.on.aws/hello \r\nyes this is patrick\r\n```\r\n\r\n### I expected the following\r\n\r\nSame thing without the patch :)\r\n\r\n### curl/libcurl version\r\n\r\n```\r\n$ ./src/curl -V\r\ncurl 8.0.1 (x86_64-pc-linux-gnu) libcurl/8.0.1 OpenSSL/1.0.2k-fips zlib/1.2.7\r\nRelease-Date: 2023-03-20\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps mqtt pop3 pop3s rtsp smb smbs smtp smtps telnet tftp\r\nFeatures: alt-svc AsynchDNS HSTS HTTPS-proxy IPv6 Largefile libz NTLM NTLM_WB SSL threadsafe UnixSockets\r\n```\r\n\r\n### operating system\r\n\r\n```\r\n$ uname -a\r\nLinux xxxxxxxxxx 4.14.311-233.529.amzn2.x86_64 #1 SMP Thu Mar 23 09:54:12 UTC 2023 x86_64 x86_64 x86_64 GNU/Linux\r\n```\r\n\r\n### More details\r\n\r\nOur of the box, a `curl --aws-sigv4 \"aws:amz:eu-west-1:vpc-lattice-svcs\" --user \"${ACCESS_KEY_ID}:${SECRET_ACCESS_KEY}\" -H \"x-amz-security-token: $SESSION_TOKEN\" http://helloworld-XXXXXXX.XXXXXXX.vpc-lattice-svcs.eu-west-1.on.aws/hello` gave me the following error:\r\n\r\n```\r\nIncompleteSignatureException: Missing the 'x-amz-content-sha256' in canonical headers\r\n```\r\n\r\nUpon reading https://github.com/curl/curl/pull/8935#issuecomment-1329440791, I modified just the `strcasecompare` so vpc-lattice-svcs would get the same logic for signature than s3. It was not enough, as `curl` gave me `InvalidSignatureException: Signed payloads are not supported` (which is correct [according to this service's documentation: \"VPC Lattice does not support payload signing, therefore you must send x-amz-content-sha256 header with value set to \"UNSIGNED-PAYLOAD\".\"](https://docs.aws.amazon.com/vpc-lattice/latest/ug/sigv4-authenticated-requests.html)), hence my dirty bypass with the `if(false)` to the payload signing block. \r\n\r\nRelates to #8810 #8935","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/11007/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/11007/timeline","performed_via_github_app":null,"state_reason":"completed"}