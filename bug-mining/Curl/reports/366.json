{"url":"https://api.github.com/repos/curl/curl/issues/12481","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/12481/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/12481/comments","events_url":"https://api.github.com/repos/curl/curl/issues/12481/events","html_url":"https://github.com/curl/curl/issues/12481","id":2030544198,"node_id":"I_kwDOAAiu0c55B6VG","number":12481,"title":"Async DNS resolution on Win8+ with GetAddrInfoExW","user":{"login":"pps83","id":1614246,"node_id":"MDQ6VXNlcjE2MTQyNDY=","avatar_url":"https://avatars.githubusercontent.com/u/1614246?v=4","gravatar_id":"","url":"https://api.github.com/users/pps83","html_url":"https://github.com/pps83","followers_url":"https://api.github.com/users/pps83/followers","following_url":"https://api.github.com/users/pps83/following{/other_user}","gists_url":"https://api.github.com/users/pps83/gists{/gist_id}","starred_url":"https://api.github.com/users/pps83/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pps83/subscriptions","organizations_url":"https://api.github.com/users/pps83/orgs","repos_url":"https://api.github.com/users/pps83/repos","events_url":"https://api.github.com/users/pps83/events{/privacy}","received_events_url":"https://api.github.com/users/pps83/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":182083182,"node_id":"MDU6TGFiZWwxODIwODMxODI=","url":"https://api.github.com/repos/curl/curl/labels/memory-leak","name":"memory-leak","color":"c7def8","default":false,"description":null},{"id":202160321,"node_id":"MDU6TGFiZWwyMDIxNjAzMjE=","url":"https://api.github.com/repos/curl/curl/labels/feature-request","name":"feature-request","color":"5319e7","default":false,"description":null},{"id":940032249,"node_id":"MDU6TGFiZWw5NDAwMzIyNDk=","url":"https://api.github.com/repos/curl/curl/labels/Windows","name":"Windows","color":"0e8a16","default":false,"description":"Windows-specific"},{"id":975635480,"node_id":"MDU6TGFiZWw5NzU2MzU0ODA=","url":"https://api.github.com/repos/curl/curl/labels/name%20lookup","name":"name lookup","color":"0052cc","default":false,"description":"DNS and related tech"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2023-12-07T11:21:30Z","updated_at":"2023-12-21T22:27:08Z","closed_at":"2023-12-21T22:27:08Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nI tried to run a test on Windows under [asan](https://learn.microsoft.com/en-us/cpp/sanitizers/asan?view=msvc-170) where many fetches are tried when there is no internet. It appears that [starting/exiting threads under asan leaks memory badly](https://developercommunity.visualstudio.com/t/ASAN-causes-OOM-error-when-many-threads/10508715), it takes only a few seconds before all ram gets consumed.\r\n\r\n\n\n### I expected the following\n\nAlthough, this isn't a bug in libcurl, but in my case I had to fix the issue. It seems that libcurl without c-ares always starts a thread for dns requests since dns was always blocking before Win8. Starting from Win8 there is a non-blocking version is available with [GetAddrInfoExW](https://learn.microsoft.com/en-us/windows/win32/api/ws2tcpip/nf-ws2tcpip-getaddrinfoexw).\r\nAlternatively, libcurl could have cached failed dns results for a very short time to avoid redoing the same requests multiple times: for example, if 1000 requests are made to the same host while there is no connection instead of starting 1000 threads in 10ms doing the same failing dns request it would be better to cache failures for 10ms or 1ms.\r\n\r\nIn my case, I ended up writing [code that uses GetAddrInfoExW on Win8](https://github.com/pps83/curl/commit/046c78285d64ff8c620c6b50299f59539357bf0e). Let me know if it's something worth to add to libcurl, and I'll make a PR.\n\n### curl/libcurl version\n\ncurl 8.5.0\n\n### operating system\n\nWIndows 8+","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/12481/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/12481/timeline","performed_via_github_app":null,"state_reason":"completed"}