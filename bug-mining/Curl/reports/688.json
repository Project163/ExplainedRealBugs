{"url":"https://api.github.com/repos/curl/curl/issues/16966","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/16966/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/16966/comments","events_url":"https://api.github.com/repos/curl/curl/issues/16966/events","html_url":"https://github.com/curl/curl/issues/16966","id":2972702395,"node_id":"I_kwDOAAiu0c6xL9a7","number":16966,"title":"HTTPS RR from DoH is ignored","user":{"login":"pkropachev","id":34160907,"node_id":"MDQ6VXNlcjM0MTYwOTA3","avatar_url":"https://avatars.githubusercontent.com/u/34160907?v=4","gravatar_id":"","url":"https://api.github.com/users/pkropachev","html_url":"https://github.com/pkropachev","followers_url":"https://api.github.com/users/pkropachev/followers","following_url":"https://api.github.com/users/pkropachev/following{/other_user}","gists_url":"https://api.github.com/users/pkropachev/gists{/gist_id}","starred_url":"https://api.github.com/users/pkropachev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pkropachev/subscriptions","organizations_url":"https://api.github.com/users/pkropachev/orgs","repos_url":"https://api.github.com/users/pkropachev/repos","events_url":"https://api.github.com/users/pkropachev/events{/privacy}","received_events_url":"https://api.github.com/users/pkropachev/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":2,"created_at":"2025-04-04T15:20:04Z","updated_at":"2025-04-04T19:31:14Z","closed_at":"2025-04-04T19:31:14Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nHello team!\n\nI use DoH to resolve the HTTP server.\n\n```\ncurl -v --doh-insecure --doh-url https://dns.testdomain.com/dns-query https://caddy.testdomain.com -k --trace-config dns\n```\n\nHTTP server supports `h3` protocol, DNS and DoH provides corresponding resource record.\n\n```\ndig +https @dns.testdomain.com caddy.testdomain.com HTTPS\n\n; <<>> DiG 9.18.30-0ubuntu0.20.04.2-Ubuntu <<>> +https @dns.testdomain.com caddy.testdomain.com HTTPS\n; (1 server found)\n;; global options: +cmd\n;; Got answer:\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 61212\n;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 2\n\n;; OPT PSEUDOSECTION:\n; EDNS: version: 0, flags:; udp: 1232\n; COOKIE: 5cae24108992288a0100000067eff66c85679ebea66a93e9 (good)\n;; QUESTION SECTION:\n;caddy.testdomain.com.\t\tIN\tHTTPS\n\n;; ANSWER SECTION:\ncaddy.testdomain.com.\t172800\tIN\tHTTPS\t1 . alpn=\"h3,h2\"\n\n;; ADDITIONAL SECTION:\ncaddy.testdomain.com.\t172800\tIN\tA\t192.168.222.100\n\n;; Query time: 0 msec\n;; SERVER: 192.168.222.3#443(dns.testdomain.com) (HTTPS)\n;; WHEN: Fri Apr 04 18:10:36 MSK 2025\n;; MSG SIZE  rcvd: 118\n```\n\nBut by some reason `curl` uses `h2` protocol to work with HTTP server. It looks like `curl` ignores HTTPS RR from DoH.\n\n```\n* [DNS] asyn-ares: fire off query for HTTPSRR\n* [DNS] Connection #1 is not open enough, cannot reuse\n* [DNS] Found pending candidate for reuse and CURLOPT_PIPEWAIT is set\n* [DNS] No connections available.\n* [DNS] Connection #1 is not open enough, cannot reuse\n* [DNS] Found pending candidate for reuse and CURLOPT_PIPEWAIT is set\n* [DNS] No connections available.\n* [DNS] Host dns.testdomain.com:443 was resolved.\n* [DNS] IPv6: (none)\n* [DNS] IPv4: 192.168.222.3\n* [DNS]   Trying 192.168.222.3:443...\n* [DNS] ALPN: curl offers h2,http/1.1\n* TLSv1.3 (OUT), TLS handshake, Client hello (1):\n* TLSv1.3 (IN), TLS handshake, Server hello (2):\n* TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8):\n* TLSv1.3 (IN), TLS handshake, Certificate (11):\n* TLSv1.3 (IN), TLS handshake, CERT verify (15):\n* TLSv1.3 (IN), TLS handshake, Finished (20):\n* TLSv1.3 (OUT), TLS change cipher, Change cipher spec (1):\n* TLSv1.3 (OUT), TLS handshake, Finished (20):\n* [DNS] SSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384 / X25519 / RSASSA-PSS\n* [DNS] ALPN: server accepted h2\n* [DNS] Server certificate:\n...\n* [DNS]  SSL certificate verify result: self-signed certificate (18), continuing anyway.\n* [DNS]   Certificate level 0: Public key type RSA (2048/112 Bits/secBits), signed using sha256WithRSAEncryption\n* [DNS] Connected to dns.testdomain.com (192.168.222.3) port 443\n* [DNS] using HTTP/2\n* [DNS] [HTTP/2] [1] OPENED stream for https://dns.testdomain.com/dns-query\n* [DNS] [HTTP/2] [1] [:method: POST]\n* [DNS] [HTTP/2] [1] [:scheme: https]\n* [DNS] [HTTP/2] [1] [:authority: dns.testdomain.com]\n* [DNS] [HTTP/2] [1] [:path: /dns-query]\n* [DNS] [HTTP/2] [1] [accept: */*]\n* [DNS] [HTTP/2] [1] [content-type: application/dns-message]\n* [DNS] [HTTP/2] [1] [content-length: 38]\n> POST /dns-query HTTP/2\n> Host: dns.testdomain.com\n> Accept: */*\n> Content-Type: application/dns-message\n> Content-Length: 38\n> \n* [DNS] upload completely sent off: 38 bytes\n* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):\n* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):\n* [DNS] Multiplexed connection found\n* [DNS] Re-using existing https: connection with host dns.testdomain.com\n* [DNS] [HTTP/2] [3] OPENED stream for https://dns.testdomain.com/dns-query\n* [DNS] [HTTP/2] [3] [:method: POST]\n* [DNS] [HTTP/2] [3] [:scheme: https]\n* [DNS] [HTTP/2] [3] [:authority: dns.testdomain.com]\n* [DNS] [HTTP/2] [3] [:path: /dns-query]\n* [DNS] [HTTP/2] [3] [accept: */*]\n* [DNS] [HTTP/2] [3] [content-type: application/dns-message]\n* [DNS] [HTTP/2] [3] [content-length: 38]\n> POST /dns-query HTTP/2\n> Host: dns.testdomain.com\n> Accept: */*\n> Content-Type: application/dns-message\n> Content-Length: 38\n> \n* [DNS] upload completely sent off: 38 bytes\n* [DNS] Multiplexed connection found\n* [DNS] Re-using existing https: connection with host dns.testdomain.com\n* [DNS] [HTTP/2] [5] OPENED stream for https://dns.testdomain.com/dns-query\n* [DNS] [HTTP/2] [5] [:method: POST]\n* [DNS] [HTTP/2] [5] [:scheme: https]\n* [DNS] [HTTP/2] [5] [:authority: dns.testdomain.com]\n* [DNS] [HTTP/2] [5] [:path: /dns-query]\n* [DNS] [HTTP/2] [5] [accept: */*]\n* [DNS] [HTTP/2] [5] [content-type: application/dns-message]\n* [DNS] [HTTP/2] [5] [content-length: 38]\n> POST /dns-query HTTP/2\n> Host: dns.testdomain.com\n> Accept: */*\n> Content-Type: application/dns-message\n> Content-Length: 38\n> \n* [DNS] upload completely sent off: 38 bytes\n< HTTP/2 200 \n< content-type: application/dns-message\n< content-length: 54\n< cache-control: max-age=172800\n< \n* [DNS] a DoH request is completed, 2 to go\n< HTTP/2 200 \n< content-type: application/dns-message\n< content-length: 89\n< cache-control: max-age=7200\n< \n* [DNS] a DoH request is completed, 1 to go\n< HTTP/2 200 \n< content-type: application/dns-message\n< content-length: 79\n< cache-control: max-age=172800\n< \n* [DNS] Connection #1 to host dns.testdomain.com left intact\n* [DNS] a DoH request is completed, 0 to go\n* [DNS] hostname: caddy.testdomain.com\n* [DoH] TTL: 172800 seconds\n* [DoH] A: 192.168.222.100\n* DoH HTTPS RR: length 13\n* [DNS] HTTPS RR ALPN: 32 16 0 0\n* Some HTTPS RR to process\n* Host caddy.testdomain.com:443 was resolved.\n* IPv6: (none)\n* IPv4: 192.168.222.100\n*   Trying 192.168.222.100:443...\n* ALPN: curl offers h2,http/1.1\n* TLSv1.3 (OUT), TLS handshake, Client hello (1):\n* TLSv1.3 (IN), TLS handshake, Server hello (2):\n* TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8):\n* TLSv1.3 (IN), TLS handshake, Certificate (11):\n* TLSv1.3 (IN), TLS handshake, CERT verify (15):\n* TLSv1.3 (IN), TLS handshake, Finished (20):\n* TLSv1.3 (OUT), TLS change cipher, Change cipher spec (1):\n* TLSv1.3 (OUT), TLS handshake, Finished (20):\n* SSL connection using TLSv1.3 / TLS_AES_128_GCM_SHA256 / X25519 / RSASSA-PSS\n* ALPN: server accepted h2\n* Server certificate:\n...\n*  SSL certificate verify result: unable to get local issuer certificate (20), continuing anyway.\n*   Certificate level 0: Public key type RSA (2048/112 Bits/secBits), signed using sha256WithRSAEncryption\n* Connected to caddy.testdomain.com (192.168.222.100) port 443\n* using HTTP/2\n* [HTTP/2] [1] OPENED stream for https://caddy.testdomain.com/\n* [HTTP/2] [1] [:method: GET]\n* [HTTP/2] [1] [:scheme: https]\n* [HTTP/2] [1] [:authority: caddy.testdomain.com]\n* [HTTP/2] [1] [:path: /]\n* [HTTP/2] [1] [user-agent: curl/8.13.1-DEV]\n* [HTTP/2] [1] [accept: */*]\n> GET / HTTP/2\n> Host: caddy.testdomain.com\n> User-Agent: curl/8.13.1-DEV\n> Accept: */*\n> \n* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):\n* Request completely sent off\n< HTTP/2 200 \n< alt-svc: h3=\":443\"; ma=2592000\n< content-type: text/plain; charset=utf-8\n< server: Caddy\n< content-length: 36\n< date: Fri, 04 Apr 2025 15:06:08 GMT\n< \n* Connection #0 to host caddy.testdomain.com left intact\nHello, world! you are using HTTP/2.0\n```\n\nAccording to Wireshark, `curl` sends query for HTTPS type and gets response from DoH.\n\n![Image](https://github.com/user-attachments/assets/b4095e06-96e0-4151-b8ca-86dc7b3fbd62)\n\n![Image](https://github.com/user-attachments/assets/1294557f-7913-4b46-bd4c-32d5d0570727)\n\n### I expected the following\n\n`curl` handles response from DoH and uses the corresponding HTTP protocol.\n\n### curl/libcurl version\n\ncurl 8.13.1-DEV\n\n### operating system\n\nUbuntu 20.04.6","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/16966/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/16966/timeline","performed_via_github_app":null,"state_reason":"completed"}