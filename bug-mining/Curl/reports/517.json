{"url":"https://api.github.com/repos/curl/curl/issues/14405","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/14405/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/14405/comments","events_url":"https://api.github.com/repos/curl/curl/issues/14405/events","html_url":"https://github.com/curl/curl/issues/14405","id":2449575301,"node_id":"I_kwDOAAiu0c6SAY2F","number":14405,"title":"Windows CMake build fails with OpenSSL unresolved external symbols","user":{"login":"val-ms","id":30635813,"node_id":"MDQ6VXNlcjMwNjM1ODEz","avatar_url":"https://avatars.githubusercontent.com/u/30635813?v=4","gravatar_id":"","url":"https://api.github.com/users/val-ms","html_url":"https://github.com/val-ms","followers_url":"https://api.github.com/users/val-ms/followers","following_url":"https://api.github.com/users/val-ms/following{/other_user}","gists_url":"https://api.github.com/users/val-ms/gists{/gist_id}","starred_url":"https://api.github.com/users/val-ms/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/val-ms/subscriptions","organizations_url":"https://api.github.com/users/val-ms/orgs","repos_url":"https://api.github.com/users/val-ms/repos","events_url":"https://api.github.com/users/val-ms/events{/privacy}","received_events_url":"https://api.github.com/users/val-ms/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118182,"node_id":"MDU6TGFiZWwxODQxMTgxODI=","url":"https://api.github.com/repos/curl/curl/labels/build","name":"build","color":"bfdadc","default":false,"description":null},{"id":184123162,"node_id":"MDU6TGFiZWwxODQxMjMxNjI=","url":"https://api.github.com/repos/curl/curl/labels/cmake","name":"cmake","color":"d4c5f9","default":false,"description":null},{"id":940032249,"node_id":"MDU6TGFiZWw5NDAwMzIyNDk=","url":"https://api.github.com/repos/curl/curl/labels/Windows","name":"Windows","color":"0e8a16","default":false,"description":"Windows-specific"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":26,"created_at":"2024-08-05T22:22:30Z","updated_at":"2024-08-12T19:44:55Z","closed_at":"2024-08-09T21:36:15Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nI compiled libcurl 8.9.1 on Windows 11 using cmake with the OpenSSL backend (version 3.3.1, though I also observed the issue with 3.2.0). \r\n\r\nBuild command:\r\n`cmake.exe .. -G \"Visual Studio 17 2022\" -A x64  -D CMAKE_INSTALL_PREFIX=\"C:/Users/micasnyd/dev/clamav-deps/x64\"  -D BUILD_LIBCURL_DOCS=OFF  -D BUILD_SHARED_LIBS=ON  -D CURL_USE_OPENSSL=ON  -D OPENSSL_INCLUDE_DIR=\"C:/Users/micasnyd/dev/clamav-deps/x64/include\"  -D LIB_EAY_RELEASE=\"C:/Users/micasnyd/dev/clamav-deps/x64/lib/libcrypto.lib\"  -D SSL_EAY_RELEASE=\"C:/Users/micasnyd/dev/clamav-deps/x64/lib/libssl.lib\"  -D ZLIB_INCLUDE_DIR=\"C:/Users/micasnyd/dev/clamav-deps/x64/include\"  -D ZLIB_LIBRARY_RELEASE=\"C:/Users/micasnyd/dev/clamav-deps/x64/lib/zlibstatic.lib\"  -D LIBSSH2_INCLUDE_DIR=\"C:/Users/micasnyd/dev/clamav-deps/x64/include\"  -D LIBSSH2_LIBRARY=\"C:/Users/micasnyd/dev/clamav-deps/x64/lib/libssh2.lib\"  -D USE_NGHTTP2=ON  -D NGHTTP2_INCLUDE_DIR=\"C:/Users/micasnyd/dev/clamav-deps/x64/include\"  -D NGHTTP2_LIBRARY=\"C:/Users/micasnyd/dev/clamav-deps/x64/lib/nghttp2.lib\"  -D BUILD_CURL_EXE=OFF`\r\n\r\nI encountered a build failure due to unresolved external symbols. \r\n```\r\ncmake.exe .. -G \"Visual Studio 17 2022\" -A x64  -D CMAKE_INSTALL_PREFIX=\"C:/Users/micasnyd/dev/clamav-deps/x64\"  -D BUILD_LIBCURL_DOCS=OFF  -D BUILD_SHARED_LIBS=ON  -D CURL_USE_OPENSSL=ON  -D OPENSSL_INCLUDE_DIR=\"C:/Users/micasnyd/dev/clamav-deps/x64/include\"  -D LIB_EAY_RELEASE=\"C:/Users/micasnyd/dev/clamav-deps/x64/lib/libcrypto.lib\"  -D SSL_EAY_RELEASE=\"C:/Users/micasnyd/dev/clamav-deps/x64/lib/libssl.lib\"  -D ZLIB_INCLUDE_DIR=\"C:/Users/micasnyd/dev/clamav-deps/x64/include\"  -D ZLIB_LIBRARY_RELEASE=\"C:/Users/micasnyd/dev/clamav-deps/x64/lib/zlibstatic.lib\"  -D LIBSSH2_INCLUDE_DIR=\"C:/Users/micasnyd/dev/clamav-deps/x64/include\"  -D LIBSSH2_LIBRARY=\"C:/Users/micasnyd/dev/clamav-deps/x64/lib/libssh2.lib\"  -D USE_NGHTTP2=ON  -D NGHTTP2_INCLUDE_DIR=\"C:/Users/micasnyd/dev/clamav-deps/x64/include\"  -D NGHTTP2_LIBRARY=\"C:/Users/micasnyd/dev/clamav-deps/x64/lib/nghttp2.lib\"  -D BUILD_CURL_EXE=OFF\r\n-- Using CMake version 3.29.0\r\n-- The C compiler identification is MSVC 19.39.33523.0\r\n-- Detecting C compiler ABI info\r\n-- Detecting C compiler ABI info - done\r\n-- Check for working C compiler: C:/Program Files/Microsoft Visual Studio/2022/Community/VC/Tools/MSVC/14.39.33519/bin/Hostx64/x64/cl.exe - skipped\r\n-- Detecting C compile features\r\n-- Detecting C compile features - done\r\n-- curl version=[8.9.0]\r\n-- Found Perl: C:/Strawberry/perl/bin/perl.exe (found version \"5.38.2\")\r\n-- Found OpenSSL: C:/Users/micasnyd/dev/clamav-deps/x64/lib/libcrypto.lib (found version \"3.3.1\")\r\n-- Looking for OPENSSL_IS_BORINGSSL\r\n-- Looking for OPENSSL_IS_BORINGSSL - not found\r\n-- Looking for OPENSSL_IS_AWSLC\r\n-- Looking for OPENSSL_IS_AWSLC - not found\r\n-- Found ZLIB: C:/Users/micasnyd/dev/clamav-deps/x64/lib/zlibstatic.lib (found version \"1.3.1\")\r\n-- Looking for SSL_set0_wbio\r\n-- Looking for SSL_set0_wbio - found\r\n-- Looking for SSL_CTX_set_srp_username\r\n-- Looking for SSL_CTX_set_srp_username - found\r\n-- Found NGHTTP2: C:/Users/micasnyd/dev/clamav-deps/x64/lib/nghttp2.lib\r\n-- Looking for idn2_lookup_ul in idn2\r\n-- Looking for idn2_lookup_ul in idn2 - not found\r\n-- Checking for module 'libidn2'\r\n--   Found libidn2, version 2.1.1\r\n-- Could NOT find LibPSL (missing: LIBPSL_LIBRARY LIBPSL_INCLUDE_DIR)\r\n-- Found LibSSH2: C:/Users/micasnyd/dev/clamav-deps/x64/lib/libssh2.lib (found version \"1.11.0\")\r\n-- Performing Test HAVE_WIN32_WINNT\r\n-- Performing Test HAVE_WIN32_WINNT - Success\r\n-- Found _WIN32_WINNT=0x0a00\r\n-- Looking for stdint.h\r\n-- Looking for stdint.h - found\r\n-- Check size of size_t\r\n-- Check size of size_t - done\r\n-- Check size of ssize_t\r\n-- Check size of ssize_t - failed\r\n-- Check size of long long\r\n-- Check size of long long - done\r\n-- Check size of long\r\n-- Check size of long - done\r\n-- Check size of int\r\n-- Check size of int - done\r\n-- Check size of __int64\r\n-- Check size of __int64 - done\r\n-- Check size of time_t\r\n-- Check size of time_t - done\r\n-- Check size of ADDRESS_FAMILY\r\n-- Check size of ADDRESS_FAMILY - done\r\n-- Check size of off_t\r\n-- Check size of off_t - done\r\n-- Check size of curl_off_t\r\n-- Check size of curl_off_t - done\r\n-- Check size of curl_socket_t\r\n-- Check size of curl_socket_t - done\r\n-- Protocols: dict file ftp ftps gopher gophers http https imap imaps ipfs ipns ldap ldaps mqtt pop3 pop3s rtsp scp sftp smb smbs smtp smtps telnet tftp\r\n-- Features: alt-svc AsynchDNS HSTS HTTP2 HTTPS-proxy IDN IPv6 Largefile libz NTLM SSL threadsafe TLS-SRP UnixSockets\r\n-- Enabled SSL backends: OpenSSL\r\n-- Configuring done (40.6s)\r\n-- Generating done (4.6s)\r\n-- Build files have been written to: C:/Users/micasnyd/dev/work/x64/curl-8.9.0/build\r\nC:\\Users\\micasnyd\\dev\\work\\x64\\curl-8.9.0>cd build\r\nC:\\Users\\micasnyd\\dev\\work\\x64\\curl-8.9.0\\build>CALL cmake.exe --build . --config Release\r\nMSBuild version 17.9.8+b34f75857 for .NET Framework\r\n1>Checking Build System\r\nGenerating curl-config.1\r\nBuilding Custom Rule C:/Users/micasnyd/dev/work/x64/curl-8.9.0/docs/CMakeLists.txt\r\nGenerating mk-ca-bundle.1\r\nBuilding Custom Rule C:/Users/micasnyd/dev/work/x64/curl-8.9.0/docs/CMakeLists.txt\r\nBuilding Custom Rule C:/Users/micasnyd/dev/work/x64/curl-8.9.0/lib/CMakeLists.txt\r\naltsvc.c\r\namigaos.c\r\nasyn-ares.c\r\nasyn-thread.c\r\nbase64.c\r\nbufq.c\r\nbufref.c\r\nc-hyper.c\r\ncf-h1-proxy.c\r\ncf-h2-proxy.c\r\ncf-haproxy.c\r\ncf-https-connect.c\r\ncf-socket.c\r\ncfilters.c\r\nconncache.c\r\nconnect.c\r\ncontent_encoding.c\r\ncookie.c\r\ncurl_addrinfo.c\r\ncurl_des.c\r\ncurl_endian.c\r\ncurl_fnmatch.c\r\ncurl_get_line.c\r\ncurl_gethostname.c\r\ncurl_gssapi.c\r\ncurl_memrchr.c\r\ncurl_multibyte.c\r\ncurl_ntlm_core.c\r\ncurl_path.c\r\ncurl_range.c\r\ncurl_rtmp.c\r\ncurl_sasl.c\r\ncurl_sha512_256.c\r\ncurl_sspi.c\r\ncurl_threads.c\r\ncurl_trc.c\r\ncw-out.c\r\ndict.c\r\ndoh.c\r\ndynbuf.c\r\ndynhds.c\r\neasy.c\r\neasygetopt.c\r\neasyoptions.c\r\nescape.c\r\nfile.c\r\nfileinfo.c\r\nfopen.c\r\nformdata.c\r\nftp.c\r\nftplistparser.c\r\ngetenv.c\r\ngetinfo.c\r\ngopher.c\r\nhash.c\r\nheaders.c\r\nhmac.c\r\nhostasyn.c\r\nhostip.c\r\nhostip4.c\r\nhostip6.c\r\nhostsyn.c\r\nhsts.c\r\nhttp.c\r\nhttp1.c\r\nhttp2.c\r\nhttp_aws_sigv4.c\r\nhttp_chunks.c\r\nhttp_digest.c\r\nhttp_negotiate.c\r\nhttp_ntlm.c\r\nhttp_proxy.c\r\nidn.c\r\nif2ip.c\r\nimap.c\r\ninet_ntop.c\r\ninet_pton.c\r\nkrb5.c\r\nldap.c\r\nllist.c\r\nmacos.c\r\nmd4.c\r\nmd5.c\r\nmemdebug.c\r\nmime.c\r\nmprintf.c\r\nmqtt.c\r\nmulti.c\r\nnetrc.c\r\nnonblock.c\r\nnoproxy.c\r\nopenldap.c\r\nparsedate.c\r\npingpong.c\r\npop3.c\r\nprogress.c\r\npsl.c\r\nrand.c\r\nrename.c\r\nrequest.c\r\nrtsp.c\r\nselect.c\r\nsendf.c\r\nsetopt.c\r\nsha256.c\r\nshare.c\r\nslist.c\r\nsmb.c\r\nsmtp.c\r\nsocketpair.c\r\nsocks.c\r\nsocks_gssapi.c\r\nsocks_sspi.c\r\nspeedcheck.c\r\nsplay.c\r\nstrcase.c\r\nstrdup.c\r\nstrerror.c\r\nstrtok.c\r\nstrtoofft.c\r\nsystem_win32.c\r\ntelnet.c\r\ntftp.c\r\ntimediff.c\r\ntimeval.c\r\ntransfer.c\r\nurl.c\r\nurlapi.c\r\nversion.c\r\nversion_win32.c\r\nwarnless.c\r\nws.c\r\ncleartext.c\r\ncram.c\r\ndigest.c\r\ndigest_sspi.c\r\ngsasl.c\r\nkrb5_gssapi.c\r\nkrb5_sspi.c\r\nntlm.c\r\nntlm_sspi.c\r\noauth2.c\r\nspnego_gssapi.c\r\nspnego_sspi.c\r\nvauth.c\r\nbearssl.c\r\ncipher_suite.c\r\ngtls.c\r\nhostcheck.c\r\nkeylog.c\r\nmbedtls.c\r\nmbedtls_threadlock.c\r\nopenssl.c\r\nrustls.c\r\nschannel.c\r\nschannel_verify.c\r\nsectransp.c\r\nvtls.c\r\nwolfssl.c\r\nx509asn1.c\r\ncurl_msh3.c\r\ncurl_ngtcp2.c\r\ncurl_osslq.c\r\ncurl_quiche.c\r\nvquic.c\r\nvquic-tls.c\r\nlibssh.c\r\nlibssh2.c\r\nwolfssh.c\r\nlibcurl_object.vcxproj -> C:\\Users\\micasnyd\\dev\\work\\x64\\curl-8.9.0\\build\\lib\\libcurl_object.dir\\Release\\libcurl_object.lib\r\nBuilding Custom Rule C:/Users/micasnyd/dev/work/x64/curl-8.9.0/lib/CMakeLists.txt\r\ndllmain.c\r\nCreating library C:/Users/micasnyd/dev/work/x64/curl-8.9.0/build/lib/Release/libcurl_imp.lib and object C:/Users/micasnyd/dev/work/x64/curl-8.9.0/build/lib/Release/libcurl_imp.exp\r\nopenssl.obj : error LNK2019: unresolved external symbol EVP_PKEY_id referenced in function Curl_ossl_certchain [C:\\Users\\micasnyd\\dev\\work\\x64\\curl-8.9.0\\build\\lib\\libcurl_shared.vcxproj]\r\nopenssl.obj : error LNK2019: unresolved external symbol EVP_PKEY_bits referenced in function Curl_oss_check_peer_cert [C:\\Users\\micasnyd\\dev\\work\\x64\\curl-8.9.0\\build\\lib\\libcurl_shared.vcxproj]\r\nopenssl.obj : error LNK2019: unresolved external symbol EVP_PKEY_security_bits referenced in function Curl_oss_check_peer_cert [C:\\Users\\micasnyd\\dev\\work\\x64\\curl-8.9.0\\build\\lib\\libcurl_shared.vcxproj]\r\nopenssl.obj : error LNK2019: unresolved external symbol SSL_get_peer_certificate referenced in function Curl_oss_check_peer_cert [C:\\Users\\micasnyd\\dev\\work\\x64\\curl-8.9.0\\build\\lib\\libcurl_shared.vcxproj]\r\nC:\\Users\\micasnyd\\dev\\work\\x64\\curl-8.9.0\\build\\lib\\Release\\libcurl.dll : fatal error LNK1120: 4 unresolved externals [C:\\Users\\micasnyd\\dev\\work\\x64\\curl-8.9.0\\build\\lib\\libcurl_shared.vcxproj]\r\nlibcurl-8.9.0 x64 build failed!\r\nCommand:\r\ncd build\r\nCALL cmake.exe --build . --config Release\r\nExit code: 1\r\n\"make\" script failed for x64 build\r\n```\r\n\r\nI think the unresolved symbols in question were renamed in OpenSSL 3.x and the original names were converted to macros for backwards compatibility. So I suspect there's a header issue of some sort, and the macros aren't being included. \r\n\r\nI checked with previous versions:\r\n- 8.9.0: fails with this same issue\r\n- 8.8.0: build succeeds\n\n### I expected the following\n\nbuild should complete successfully\n\n### curl/libcurl version\n\ncurl 8.9.0\n\n### operating system\n\nWindows 11 x64","closed_by":{"login":"jay","id":965580,"node_id":"MDQ6VXNlcjk2NTU4MA==","avatar_url":"https://avatars.githubusercontent.com/u/965580?v=4","gravatar_id":"","url":"https://api.github.com/users/jay","html_url":"https://github.com/jay","followers_url":"https://api.github.com/users/jay/followers","following_url":"https://api.github.com/users/jay/following{/other_user}","gists_url":"https://api.github.com/users/jay/gists{/gist_id}","starred_url":"https://api.github.com/users/jay/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jay/subscriptions","organizations_url":"https://api.github.com/users/jay/orgs","repos_url":"https://api.github.com/users/jay/repos","events_url":"https://api.github.com/users/jay/events{/privacy}","received_events_url":"https://api.github.com/users/jay/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/14405/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/14405/timeline","performed_via_github_app":null,"state_reason":"completed"}