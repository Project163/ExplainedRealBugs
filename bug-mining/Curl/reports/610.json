{"url":"https://api.github.com/repos/curl/curl/issues/15725","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/15725/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/15725/comments","events_url":"https://api.github.com/repos/curl/curl/issues/15725/events","html_url":"https://github.com/curl/curl/issues/15725","id":2733469888,"node_id":"I_kwDOAAiu0c6i7XDA","number":15725,"title":"Regression: File descriptor / Assertion error when using curl via nvchecker","user":{"login":"christian-heusel","id":26827864,"node_id":"MDQ6VXNlcjI2ODI3ODY0","avatar_url":"https://avatars.githubusercontent.com/u/26827864?v=4","gravatar_id":"","url":"https://api.github.com/users/christian-heusel","html_url":"https://github.com/christian-heusel","followers_url":"https://api.github.com/users/christian-heusel/followers","following_url":"https://api.github.com/users/christian-heusel/following{/other_user}","gists_url":"https://api.github.com/users/christian-heusel/gists{/gist_id}","starred_url":"https://api.github.com/users/christian-heusel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/christian-heusel/subscriptions","organizations_url":"https://api.github.com/users/christian-heusel/orgs","repos_url":"https://api.github.com/users/christian-heusel/repos","events_url":"https://api.github.com/users/christian-heusel/events{/privacy}","received_events_url":"https://api.github.com/users/christian-heusel/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":11,"created_at":"2024-12-11T16:45:13Z","updated_at":"2024-12-22T13:00:20Z","closed_at":"2024-12-12T14:59:17Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\r\n\r\nI have a few local configs for [lilydjwg/nvchecker](https://github.com/lilydjwg/nvchecker) which I regularily run via systemd-timers and the following commandline invocation:\r\n```\r\n$ for nvcheckerfile in ~/Documents/shared_projects/{packages,aur-packages}/packages.toml ~/Documents/shared_projects/arch-infrastructure/nvchecker.toml; do nvchecker -c $nvcheckerfile; done\r\n[I 12-11 17:40:21.160 core:416] rofi-emoji: updated from 3.4.0 to 4.0.0\r\n[I 12-11 17:40:22.541 core:416] molly-guard: updated from 0.8.1 to 0.8.4 url=https://sources.debian.org/src/molly-guard/0.8.4/\r\n```\r\nSince today this gives me the following errors every few runs (although the assert is more prominently faced):\r\n```\r\nAssertion 'close_nointr(fd) != -EBADF' failed at src/basic/fd-util.c:75, function safe_close(). Aborting.\r\n\r\nOR \r\n\r\nUnexpected error 9 on netlink descriptor 10.\r\n```\r\nI have also seen the error with the `pacman` package manager once so far.\r\n\r\nI then looked into the issue in a bit more detail and found that bisecting the issue between 8.11.0 and 8.11.1 lead me to [`92124838c` (\"socketpair: fix enabling `USE_EVENTFD`\")](https://github.com/curl/curl/commit/92124838c6b7e09e3f35ff84e1eb63cf0105c9b5) as a culprit which in turn fixes enabling of the functionality in [`23fe1a52d` (\"socketpair: add `eventfd` and use `SOCK_NONBLOCK` for `socketpair()`\")](https://github.com/curl/curl/commit/23fe1a52dc8a2ffd74e19b956927bbccdc07f15f). Reverting 92124838c on top of reliably fixes the issue on my machine.\r\n\r\nI also found that the issue does not reproduce every time and seems to be more prevalent when I clear my DNS cache via `resolvectl flush-caches`.\r\n\r\nThe backtrace for the crash is the following:\r\n```\r\n(gdb) bt\r\n#0  __pthread_kill_implementation (threadid=<optimized out>, signo=signo@entry=6, no_tid=no_tid@entry=0) at pthread_kill.c:44\r\n#1  0x00007fcc816a5463 in __pthread_kill_internal (threadid=<optimized out>, signo=6) at pthread_kill.c:78\r\n#2  0x00007fcc8164c120 in __GI_raise (sig=sig@entry=6) at ../sysdeps/posix/raise.c:26\r\n#3  0x00007fcc816334c3 in __GI_abort () at abort.c:79\r\n#4  0x00007fcc79cc3596 in log_assert_failed (text=text@entry=0x7fcc79ce8f80 \"close_nointr(fd) != -EBADF\", \r\n    file=file@entry=0x7fcc79ce6e5b \"src/basic/fd-util.c\", line=line@entry=75, func=func@entry=0x7fcc79ceafa8 <__func__.35> \"safe_close\")\r\n    at ../systemd/src/basic/log.c:996\r\n#5  0x00007fcc79cd1cb1 in safe_close (fd=9) at ../systemd/src/basic/fd-util.c:75\r\n#6  0x00007fcc79ccff2d in varlink_clear (v=0x7fcc44000d80) at ../systemd/src/libsystemd/sd-varlink/sd-varlink.c:612\r\n#7  0x00007fcc79ce2c1c in varlink_destroy (v=0x7fcc44000d80) at ../systemd/src/libsystemd/sd-varlink/sd-varlink.c:651\r\n#8  sd_varlink_unref.isra.0 (p=0x7fcc44000d80) at ../systemd/src/libsystemd/sd-varlink/sd-varlink.c:657\r\n#9  0x00007fcc79cc7517 in sd_varlink_unrefp (p=0x7fcc4dffc178) at ../systemd/src/systemd/sd-varlink.h:279\r\n#10 _nss_resolve_gethostbyname4_r (name=name@entry=0x562ab267ad00 \"sources.debian.org\", pat=pat@entry=0x7fcc4dffc3b0, buffer=0x7fcc4dffc4c0 \"\", buflen=1024, \r\n    errnop=0x7fcc4dffd638, h_errnop=h_errnop@entry=0x7fcc4dffd688, ttlp=0x0) at ../systemd/src/nss-resolve/nss-resolve.c:219\r\n#11 0x00007fcc81756891 in get_nss_addresses (name=<optimized out>, req=<optimized out>, tmpbuf=0x7fcc4dffc4b0, res=0x7fcc4dffc3b0) at getaddrinfo.c:652\r\n#12 gaih_inet (name=<optimized out>, service=<optimized out>, req=<optimized out>, pai=0x7fcc4dffc380, naddrs=<synthetic pointer>, tmpbuf=0x7fcc4dffc4b0)\r\n    at getaddrinfo.c:1185\r\n#13 __GI_getaddrinfo (name=<optimized out>, service=<optimized out>, service@entry=0x7fcc4dffce5c \"443\", hints=<optimized out>, hints@entry=0x562ab267ac90, \r\n    pai=pai@entry=0x7fcc4dffce50) at getaddrinfo.c:2391\r\n#14 0x00007fcc7f82fd1f in Curl_getaddrinfo_ex (nodename=<optimized out>, servname=0x7fcc4dffce5c \"443\", hints=0x562ab267ac90, result=0x562ab267ac88)\r\n    at /usr/src/debug/curl/curl/lib/curl_addrinfo.c:121\r\n#15 getaddrinfo_thread (arg=arg@entry=0x562ab267ac58) at /usr/src/debug/curl/curl/lib/asyn-thread.c:311\r\n#16 0x00007fcc7f83119d in curl_thread_create_thunk (arg=<optimized out>) at /usr/src/debug/curl/curl/lib/curl_threads.c:59\r\n#17 0x00007fcc816a339d in start_thread (arg=<optimized out>) at pthread_create.c:447\r\n#18 0x00007fcc8172849c in __GI___clone3 () at ../sysdeps/unix/sysv/linux/x86_64/clone3.S:78\r\n```\r\n\r\nIf you think this is a bug in systemd rather than curl please tell me, so far it looked plausible that it's an issue with the curl codebase. Also if you have any idea about a minimal reproducer I'm happy to test things.\r\n\r\n### I expected the following\r\n\r\nI expected these command to just continue working as usual.\r\n\r\n### curl/libcurl version\r\n\r\n```\r\ncurl --version\r\ncurl 8.11.1 (x86_64-pc-linux-gnu) libcurl/8.11.1 OpenSSL/3.4.0 zlib/1.3.1 brotli/1.1.0 zstd/1.5.6 libidn2/2.3.7 libpsl/0.21.5 libssh2/1.11.0 nghttp2/1.64.0 nghttp3/1.6.0\r\nRelease-Date: 2024-12-11\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps ipfs ipns mqtt pop3 pop3s rtsp scp sftp smb smbs smtp smtps telnet tftp ws wss\r\nFeatures: alt-svc AsynchDNS brotli GSS-API HSTS HTTP2 HTTP3 HTTPS-proxy IDN IPv6 Kerberos Largefile libz NTLM PSL SPNEGO SSL threadsafe TLS-SRP UnixSockets zstd\r\n```\r\n\r\n### operating system\r\n\r\nArch Linux (rolling)\r\n\r\n`uname -a`:\r\n```\r\nLinux meterpeter 6.13.0-rc2-1-mainline #1 SMP PREEMPT_DYNAMIC Sun, 08 Dec 2024 23:31:29 +0000 x86_64 GNU/Linux\r\n```\r\n\r\nsystemd version: `257-1`","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/15725/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/15725/timeline","performed_via_github_app":null,"state_reason":"completed"}