{"url":"https://api.github.com/repos/curl/curl/issues/11678","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/11678/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/11678/comments","events_url":"https://api.github.com/repos/curl/curl/issues/11678/events","html_url":"https://github.com/curl/curl/issues/11678","id":1851982887,"node_id":"I_kwDOAAiu0c5uYwQn","number":11678,"title":"curl reuses connection when non-chunked data has not entirely been sent","user":{"login":"dfandrich","id":228259,"node_id":"MDQ6VXNlcjIyODI1OQ==","avatar_url":"https://avatars.githubusercontent.com/u/228259?v=4","gravatar_id":"","url":"https://api.github.com/users/dfandrich","html_url":"https://github.com/dfandrich","followers_url":"https://api.github.com/users/dfandrich/followers","following_url":"https://api.github.com/users/dfandrich/following{/other_user}","gists_url":"https://api.github.com/users/dfandrich/gists{/gist_id}","starred_url":"https://api.github.com/users/dfandrich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dfandrich/subscriptions","organizations_url":"https://api.github.com/users/dfandrich/orgs","repos_url":"https://api.github.com/users/dfandrich/repos","events_url":"https://api.github.com/users/dfandrich/events{/privacy}","received_events_url":"https://api.github.com/users/dfandrich/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118243,"node_id":"MDU6TGFiZWwxODQxMTgyNDM=","url":"https://api.github.com/repos/curl/curl/labels/HTTP","name":"HTTP","color":"207de5","default":false,"description":null},{"id":370011580,"node_id":"MDU6TGFiZWwzNzAwMTE1ODA=","url":"https://api.github.com/repos/curl/curl/labels/connecting%20&%20proxies","name":"connecting & proxies","color":"c2e0c6","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2023-08-15T19:14:26Z","updated_at":"2023-08-22T22:35:49Z","closed_at":"2023-08-22T22:35:49Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nI caught a case where test 357 hung, while running the test suite under CPU starvation conditions. What seems to happen is this:\r\n\r\n1. curl sends a PUT request with `Expect: 100-continue` with HTTP/1.1\r\n2. it waits a moment for a 100 Continue response which doesn't come\r\n3. it starts sending its ~1 MiB payload in non-chunked mode\r\n4. while sending that payload (in 64 KiB blocks) the server returns a 417 \"expectation failed\" code\r\n5. curl *immediately* stops sending the remaining payload bytes, in order to start again without the `Expect: 100-continue` (again, in non-chunked mode)\r\n6. curl improperly **reuses the existing connection** to send the new response\r\n7. the server treats the start of the new request as part of the payload of the first request, and finishes reading the remaining bytes that it expected\r\n8. the server then finds itself in the middle of the payload of the second request, gets confused and just sits there\r\n9. curl completes sending the data of the second request and starts waiting for the HTTP response, which never comes\r\n\r\nHere is an annotated excerpt from the trace log for the hanging test 357:\r\n\r\n```\r\n10:15:31.811080 == Info: !!! WARNING !!!\r\n10:15:31.811167 == Info: This is a debug build of libcurl, do not use in production.\r\n10:15:31.811171 == Info: processing: http://127.0.0.1:44697/we/want/357\r\n10:15:31.811190 == Info: STATE: INIT => CONNECT handle 0x19dbde8; line 1974\r\n10:15:31.811405 == Info: Added connection 0. The cache now contains 1 members\r\n10:15:31.811451 == Info: STATE: CONNECT => CONNECTING handle 0x19dbde8; line 2027\r\n10:15:31.811647 == Info:   Trying 127.0.0.1:44697...\r\n10:15:31.811776 == Info: Connected to 127.0.0.1 (127.0.0.1) port 44697\r\n10:15:31.811784 == Info: STATE: CONNECTING => PROTOCONNECT handle 0x19dbde8; line 2135\r\n10:15:31.811789 == Info: STATE: PROTOCONNECT => DO handle 0x19dbde8; line 2165\r\n10:15:31.811852 => Send header, 140 bytes (0x8c)\r\n0000: PUT /we/want/357 HTTP/1.1\r\n001b: Host: 127.0.0.1:44697\r\n0032: User-Agent: curl/8.3.0-DEV\r\n004e: Accept: */*\r\n005b: Content-Length: 1053701\r\n0074: Expect: 100-continue\r\n008a:\r\n10:15:31.811888 == Info: STATE: DO => DID handle 0x19dbde8; line 2259\r\n10:15:31.811893 == Info: STATE: DID => PERFORMING handle 0x19dbde8; line 2377\r\n10:15:32.889446 == Info: Done waiting for 100-continue\r\n10:15:32.889863 => Send data, 65536 bytes (0x10000)\r\n0000: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\r\n0040: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\r\n0080: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\r\n(more of this, to reach exactly 65536 bytes of payload)\r\nff40: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\r\nff80: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\r\nffc0: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\r\n```\r\nThat's 65536 bytes, when the server is expecting 1053701 bytes.\r\n```\r\n10:15:33.872300 == Info: HTTP 1.1 or later with persistent connection\r\n10:15:33.872316 <= Recv header, 26 bytes (0x1a)\r\n0000: HTTP/1.1 417 OK swsbounce.\r\n10:15:33.872359 <= Recv header, 36 bytes (0x24)\r\n0000: Date: Tue, 09 Nov 2010 14:49:00 GMT.\r\n10:15:33.872374 <= Recv header, 25 bytes (0x19)\r\n0000: Server: test-server/fake.\r\n10:15:33.872385 <= Recv header, 18 bytes (0x12)\r\n0000: Content-Length: 0.\r\n10:15:33.872398 == Info: Got 417 while waiting for a 100\r\n10:15:33.872404 <= Recv header, 1 bytes (0x1)\r\n0000: .\r\n10:15:33.872412 == Info: multi_done: status: 0 prem: 0 done: 0\r\n10:15:33.872476 == Info: Connection #0 to host 127.0.0.1 left intact\r\n10:15:33.872540 == Info: Issue another request to this URL: 'http://127.0.0.1:44697/we/want/357'\r\n10:15:33.872545 == Info: STATE: PERFORMING => CONNECT handle 0x19dbde8; line 2553\r\n10:15:33.872655 == Info: Found bundle for host: 0x19d77b8 [serially]\r\n10:15:33.872659 == Info: Can not multiplex, even if we wanted to\r\n10:15:33.872679 == Info: Re-using existing connection with host 127.0.0.1\r\n```\r\nThat's the smoking gun ^^^\r\n```\r\n10:15:33.872685 == Info: STATE: CONNECT => CONNECTING handle 0x19dbde8; line 2027\r\n10:15:33.872690 == Info: STATE: CONNECTING => PROTOCONNECT handle 0x19dbde8; line 2135\r\n10:15:33.872694 == Info: STATE: PROTOCONNECT => DO handle 0x19dbde8; line 2154\r\n10:15:33.873002 => Send header, 118 bytes (0x76)\r\n0000: PUT /we/want/357 HTTP/1.1\r\n001b: Host: 127.0.0.1:44697\r\n0032: User-Agent: curl/8.3.0-DEV\r\n004e: Accept: */*\r\n005b: Content-Length: 1053701\r\n0074:\r\n10:15:33.873029 == Info: STATE: DO => DID handle 0x19dbde8; line 2259\r\n10:15:33.873034 == Info: STATE: DID => PERFORMING handle 0x19dbde8; line 2377\r\n10:15:33.873367 => Send data, 65536 bytes (0x10000)\r\n0000: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\r\n0040: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\r\nâ€¦\r\n```\r\n\n\n### I expected the following\n\nIn step 6, curl should close the existing connection (since it is incomplete) and start a new one instead.\n\n### curl/libcurl version\n\n8.3.0-DEV\n\n### operating system\n\nLinux x86_64","closed_by":{"login":"dfandrich","id":228259,"node_id":"MDQ6VXNlcjIyODI1OQ==","avatar_url":"https://avatars.githubusercontent.com/u/228259?v=4","gravatar_id":"","url":"https://api.github.com/users/dfandrich","html_url":"https://github.com/dfandrich","followers_url":"https://api.github.com/users/dfandrich/followers","following_url":"https://api.github.com/users/dfandrich/following{/other_user}","gists_url":"https://api.github.com/users/dfandrich/gists{/gist_id}","starred_url":"https://api.github.com/users/dfandrich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dfandrich/subscriptions","organizations_url":"https://api.github.com/users/dfandrich/orgs","repos_url":"https://api.github.com/users/dfandrich/repos","events_url":"https://api.github.com/users/dfandrich/events{/privacy}","received_events_url":"https://api.github.com/users/dfandrich/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/11678/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/11678/timeline","performed_via_github_app":null,"state_reason":"completed"}