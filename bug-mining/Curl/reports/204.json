{"url":"https://api.github.com/repos/curl/curl/issues/10726","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/10726/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/10726/comments","events_url":"https://api.github.com/repos/curl/curl/issues/10726/events","html_url":"https://github.com/curl/curl/issues/10726","id":1618217363,"node_id":"I_kwDOAAiu0c5gdAmT","number":10726,"title":"In curl 7.88.1, wrapping curl_easy_setopt in macro is broken when compiling with GCC <12.1","user":{"login":"kchow-FTNT","id":127456993,"node_id":"U_kgDOB5jW4Q","avatar_url":"https://avatars.githubusercontent.com/u/127456993?v=4","gravatar_id":"","url":"https://api.github.com/users/kchow-FTNT","html_url":"https://github.com/kchow-FTNT","followers_url":"https://api.github.com/users/kchow-FTNT/followers","following_url":"https://api.github.com/users/kchow-FTNT/following{/other_user}","gists_url":"https://api.github.com/users/kchow-FTNT/gists{/gist_id}","starred_url":"https://api.github.com/users/kchow-FTNT/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kchow-FTNT/subscriptions","organizations_url":"https://api.github.com/users/kchow-FTNT/orgs","repos_url":"https://api.github.com/users/kchow-FTNT/repos","events_url":"https://api.github.com/users/kchow-FTNT/events{/privacy}","received_events_url":"https://api.github.com/users/kchow-FTNT/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118182,"node_id":"MDU6TGFiZWwxODQxMTgxODI=","url":"https://api.github.com/repos/curl/curl/labels/build","name":"build","color":"bfdadc","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2023-03-10T01:24:32Z","updated_at":"2023-03-24T18:23:56Z","closed_at":"2023-03-17T16:53:22Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\r\n\r\nOur project is currently using GCC 10.3 and as far as I know, this should be supported by curl 7.88.1. However, upon trying to upgrade curl from 7.86.0 to 7.88.1 we get some compilation errors in our existing code. The issue is known and appears to be fixed in GCC 12.1; `#pragma` statements in macros can be reordered and this interferes with disabling `-Wdeprecated-declarations`.\r\n\r\nThis is a rough simplification of what our code looks like, and a highly simplified version of the current logic within curl 7.88:\r\n```\r\ntypedef enum {\r\n    CURLOPT_DEPRECATED __attribute__((__deprecated__)),\r\n    CURLOPT_OKAY,\r\n} CURLoption;\r\n\r\nint curl_easy_setopt(CURLoption val);\r\n\r\n#define CURL_IGNORE_DEPRECATION(statement) \\\r\n  _Pragma(\"GCC diagnostic push\") \\\r\n  _Pragma(\"GCC diagnostic ignored \\\"-Wdeprecated-declarations\\\"\") \\\r\n  statement \\\r\n  _Pragma(\"GCC diagnostic pop\")\r\n\r\nstatic void __attribute__((__warning__(\"bad\"))) __attribute__((__unused__)) __attribute__((__noinline__)) curl_warn(void) {\r\n                __asm__(\"\");\r\n}\r\n\r\n#define curl_easy_setopt(_expr) \\\r\n  __extension__ ({ \\\r\n    CURLoption _internal_opt = (_expr); \\\r\n    if (__builtin_constant_p(_internal_opt)) { \\\r\n        CURL_IGNORE_DEPRECATION( \\\r\n            if (_internal_opt == CURLOPT_DEPRECATED) { \\\r\n                curl_warn(); \\\r\n            } \\\r\n        ) \\\r\n    } \\\r\n    curl_easy_setopt(_internal_opt);\\\r\n  })\r\n\r\n#define SPRINGBOARD4(_expr) \\\r\n    ({ \\\r\n        int ret = (_expr); \\\r\n        ret; \\\r\n    })\r\n\r\n#define SPRINTBOARD3(_expr) \\\r\n    ({ \\\r\n        if (SPRINGBOARD4(_expr) < 0) { \\\r\n            return -1; \\\r\n        } \\\r\n    })\r\n\r\n#define SPRINGBOARD2(_expr) \\\r\n  SPRINTBOARD3(_expr)\r\n\r\n#define SPRINGBOARD1(_expr) \\\r\n  SPRINGBOARD4(_expr)\r\n\r\nint test(void) {\r\n    SPRINGBOARD2(curl_easy_setopt(CURLOPT_OKAY));\r\n    if (SPRINGBOARD1(curl_easy_setopt(CURLOPT_OKAY)) < 0) {\r\n        return -1;\r\n    }\r\n    return 0;\r\n}\r\n```\r\nPlease try this code snippet out on godbolt.org under GCC < 12.1 The compiler output should look something like this:\r\n```\r\n<source>: In function 'test':\r\n<source>:51:5: warning: 'CURLOPT_DEPRECATED' is deprecated [-Wdeprecated-declarations]\r\n   51 |     SPRINGBOARD2(curl_easy_setopt(CURLOPT_OKAY));\r\n      |     ^~~~~~~~~~~~\r\n<source>:2:5: note: declared here\r\n    2 |     CURLOPT_DEPRECATED __attribute__((__deprecated__)),\r\n      |     ^~~~~~~~~~~~~~~~~~\r\n<source>:52:1: error: expected expression before '#pragma'\r\n   52 |     if (SPRINGBOARD1(curl_easy_setopt(CURLOPT_OKAY)) < 0) {\r\n      | ^  \r\nCompiler returned: 1\r\n```\r\n\r\nAnd the preprocessor output should look something like this:\r\n```\r\nint test(void) {\r\n   \r\n#pragma GCC diagnostic push\r\n   \r\n#pragma GCC diagnostic ignored \"-Wdeprecated-declarations\"\r\n   \r\n#pragma GCC diagnostic pop\r\n    do { if (({ int ret = (__extension__ ({ CURLoption _internal_opt = (CURLOPT_OKAY); if (__builtin_constant_p(_internal_opt)) { if (_internal_opt == CURLOPT_DEPRECATED) { curl_warn(); } } curl_easy_setopt(_internal_opt); })); ret; }) < 0) { return -1; } } while (0);\r\n    if (\r\n#pragma GCC diagnostic push\r\n   \r\n#pragma GCC diagnostic ignored \"-Wdeprecated-declarations\"\r\n   \r\n#pragma GCC diagnostic pop\r\n   ({ int ret = (__extension__ ({ CURLoption _internal_opt = (CURLOPT_OKAY); if (__builtin_constant_p(_internal_opt)) { if (_internal_opt == CURLOPT_DEPRECATED) { curl_warn(); } } curl_easy_setopt(_internal_opt); })); ret; }) < 0) {\r\n        return -1;\r\n    }\r\n    return 0;\r\n}\r\n```\r\n\r\nCompilation will fail on every macro wrapping `curl_easy_setopt`. Take a look at the preprocessor output for both to see the reason why; In GCC < 12.1 the `#pragma` directives are placed in odd positions and depending on how the macro is structured we either get a deprecation warning on the unused deprecated CURLOPT, or the code gets completely mangled and we get the weird `expected expression before '#pragma'` error.\r\n\r\nIf you try this same code block with >=12.1 the #pragmas are correctly placed and compilation is fine.\r\n\r\n### I expected the following\r\n\r\nlibcurl macros need to be rewritten to handle this case for GCC < 12.1\r\n\r\n### curl/libcurl version\r\n\r\n7.88.1\r\n\r\n### operating system\r\n\r\nProprietary platform, however this is a compilation issue so that shouldn't matter.\r\n","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/10726/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/10726/timeline","performed_via_github_app":null,"state_reason":"completed"}