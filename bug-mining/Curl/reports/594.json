{"url":"https://api.github.com/repos/curl/curl/issues/15624","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/15624/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/15624/comments","events_url":"https://api.github.com/repos/curl/curl/issues/15624/events","html_url":"https://github.com/curl/curl/issues/15624","id":2681982663,"node_id":"I_kwDOAAiu0c6f287H","number":15624,"title":"RTSP: RECEIVE operation still returns CURLE_OK when the connection is broken","user":{"login":"dengjfzh","id":76604422,"node_id":"MDQ6VXNlcjc2NjA0NDIy","avatar_url":"https://avatars.githubusercontent.com/u/76604422?v=4","gravatar_id":"","url":"https://api.github.com/users/dengjfzh","html_url":"https://github.com/dengjfzh","followers_url":"https://api.github.com/users/dengjfzh/followers","following_url":"https://api.github.com/users/dengjfzh/following{/other_user}","gists_url":"https://api.github.com/users/dengjfzh/gists{/gist_id}","starred_url":"https://api.github.com/users/dengjfzh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dengjfzh/subscriptions","organizations_url":"https://api.github.com/users/dengjfzh/orgs","repos_url":"https://api.github.com/users/dengjfzh/repos","events_url":"https://api.github.com/users/dengjfzh/events{/privacy}","received_events_url":"https://api.github.com/users/dengjfzh/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":7,"created_at":"2024-11-22T06:40:10Z","updated_at":"2024-11-25T17:38:02Z","closed_at":"2024-11-25T17:38:02Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\r\n\r\nI use libcurl to download a RTSP stream from a server, then restart the server, libcurl cannot report an error (the connection was broken).\r\n\r\nThis is my test code:\r\n\r\n```c\r\n#include <stdio.h>\r\n#include <stdlib.h>\r\n#include <string.h>\r\n#include <curl/curl.h>\r\n\r\nsize_t curl_write_cb(void *data, size_t size, size_t nmemb, void *userp);\r\nsize_t curl_interleave_cb(void *data, size_t size, size_t nmemb, void *userp);\r\n\r\nchar resp_body[1024*4];\r\nsize_t resp_len = 0;\r\n\r\nint main(int argc, char *argv[])\r\n{\r\n    const char * const url = (argc>1) ? argv[1] : \"rtsp://localhost/test/test\";\r\n    char errbuf[CURL_ERROR_SIZE] = {0};\r\n    \r\n    CURL *curl = curl_easy_init();\r\n    if ( curl == NULL ) {\r\n        fprintf(stderr, \"Error: call curl_easy_init failed!\\n\");\r\n        return 1;\r\n    }\r\n    curl_easy_setopt(curl, CURLOPT_VERBOSE, 1L);\r\n    curl_easy_setopt(curl, CURLOPT_NOPROGRESS, 1L);\r\n    curl_easy_setopt(curl, CURLOPT_WRITEFUNCTION, curl_write_cb);\r\n    curl_easy_setopt(curl, CURLOPT_INTERLEAVEFUNCTION, curl_interleave_cb);\r\n    curl_easy_setopt(curl, CURLOPT_URL, url);\r\n    curl_easy_setopt(curl, CURLOPT_RTSP_STREAM_URI, url);\r\n    curl_easy_setopt(curl, CURLOPT_REDIR_PROTOCOLS, CURLPROTO_RTSP);\r\n    curl_easy_setopt(curl, CURLOPT_ERRORBUFFER, errbuf);\r\n\r\n    // options\r\n    curl_easy_setopt(curl, CURLOPT_RTSP_REQUEST, CURL_RTSPREQ_OPTIONS);\r\n    CURLcode res = curl_easy_perform(curl);\r\n    if ( res != CURLE_OK ) {\r\n        fprintf(stderr, \"Error: call curl_easy_perform() failed: %s\\n\", curl_easy_strerror(res));\r\n        return 1;\r\n    }\r\n\r\n    // describe\r\n    curl_easy_setopt(curl, CURLOPT_RTSP_REQUEST, CURL_RTSPREQ_DESCRIBE);\r\n    resp_len = 0;\r\n    res = curl_easy_perform(curl);\r\n    if ( res != CURLE_OK ) {\r\n        fprintf(stderr, \"Error: call curl_easy_perform() failed: %s\\n\", curl_easy_strerror(res));\r\n        return 1;\r\n    }\r\n    resp_body[resp_len] = '\\0';\r\n    printf(\"SDP:\\n%s\\n\", resp_body);\r\n\r\n    // setup\r\n    char buf[1024];\r\n    snprintf(buf, sizeof(buf), \"%s/streamid=0\", url);\r\n    curl_easy_setopt(curl, CURLOPT_RTSP_STREAM_URI, buf);\r\n    curl_easy_setopt(curl, CURLOPT_RTSP_TRANSPORT, \"RTP/AVP/TCP;unicast;interleaved=0-1\");\r\n    curl_easy_setopt(curl, CURLOPT_RTSP_REQUEST, CURL_RTSPREQ_SETUP);\r\n    res = curl_easy_perform(curl);\r\n    if ( res != CURLE_OK ) {\r\n        fprintf(stderr, \"Error: call curl_easy_perform() failed: %s\\n\", curl_easy_strerror(res));\r\n        return 1;\r\n    }\r\n    curl_easy_setopt(curl, CURLOPT_RTSP_STREAM_URI, url);\r\n    curl_easy_setopt(curl, CURLOPT_RTSP_TRANSPORT, \"\");\r\n\r\n    // play\r\n    curl_easy_setopt(curl, CURLOPT_RTSP_REQUEST, CURL_RTSPREQ_PLAY);\r\n    res = curl_easy_perform(curl);\r\n    if ( res != CURLE_OK ) {\r\n        fprintf(stderr, \"Error: call curl_easy_perform() failed: %s\\n\", curl_easy_strerror(res));\r\n        return 1;\r\n    }\r\n\r\n    // receive loop\r\n    while ( true ) {\r\n        curl_easy_setopt(curl, CURLOPT_RTSP_REQUEST, CURL_RTSPREQ_RECEIVE);\r\n        res = curl_easy_perform(curl);\r\n        if ( res != CURLE_OK ) { // <== When the connection is broken, it still returns CURLE_OK!\r\n            fprintf(stderr, \"Error: call curl_easy_perform() failed: %s\\n\", curl_easy_strerror(res));\r\n            break;\r\n        }\r\n    }\r\n\r\n    // teardown\r\n    curl_easy_setopt(curl, CURLOPT_RTSP_REQUEST, CURL_RTSPREQ_TEARDOWN);\r\n    res = curl_easy_perform(curl);\r\n    if ( res != CURLE_OK ) {\r\n        fprintf(stderr, \"Error: call curl_easy_perform() failed: %s\\n\", curl_easy_strerror(res));\r\n        return 1;\r\n    }\r\n    \r\n    printf(\"done.\\n\");\r\n    return 0;\r\n}\r\n\r\nsize_t curl_write_cb(void *data, size_t size, size_t nmemb, void *userp)\r\n{\r\n    size_t len = size * nmemb;\r\n    if ( (resp_len + len + 1) > sizeof(resp_body) ) {\r\n        fprintf(stderr, \"Warning: response too long! %lu+%lu\\n\", resp_len, len);\r\n    } else {\r\n        memcpy(resp_body+resp_len, data, len);\r\n        resp_len += len;\r\n    }\r\n    return len;\r\n}\r\n\r\nsize_t curl_interleave_cb(void *data, size_t size, size_t nmemb, void *userp)\r\n{\r\n    size_t len = size * nmemb;\r\n    unsigned char *p = (unsigned char*)data;\r\n    if ( p[0] == '$' ) {\r\n        int channel = p[1];\r\n        int framelen = p[2]*256 + p[3];\r\n        printf(\"Recv %lu bytes of interleave frame, channel:%d, framelen:%d\\n\", len, channel, framelen);\r\n    } else {\r\n        fprintf(stderr, \"Warning: not an interleave frame! p[0]=0x%x\\n\", p[0]);\r\n    }\r\n    return len;\r\n}\r\n```\r\n\r\nNote that in this test code, when the connection is broken, the curl_easy_perform() call will immediately return CURLE_OK, resulting in 100% CPU usage.\r\n\r\nAttached is the log.\r\n[log.txt](https://github.com/user-attachments/files/17865993/log.txt)\r\n\r\n\r\n### I expected the following\r\n\r\nWhen the connection is broken, curl_easy_perform() should return an error code so that the application can handle it accordingly.\r\n\r\n### curl/libcurl version\r\n\r\ncurl 8.11.0\r\n\r\n### operating system\r\n\r\nUbuntu 24.04","closed_by":{"login":"vszakats","id":1446897,"node_id":"MDQ6VXNlcjE0NDY4OTc=","avatar_url":"https://avatars.githubusercontent.com/u/1446897?v=4","gravatar_id":"","url":"https://api.github.com/users/vszakats","html_url":"https://github.com/vszakats","followers_url":"https://api.github.com/users/vszakats/followers","following_url":"https://api.github.com/users/vszakats/following{/other_user}","gists_url":"https://api.github.com/users/vszakats/gists{/gist_id}","starred_url":"https://api.github.com/users/vszakats/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vszakats/subscriptions","organizations_url":"https://api.github.com/users/vszakats/orgs","repos_url":"https://api.github.com/users/vszakats/repos","events_url":"https://api.github.com/users/vszakats/events{/privacy}","received_events_url":"https://api.github.com/users/vszakats/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/15624/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/15624/timeline","performed_via_github_app":null,"state_reason":"completed"}