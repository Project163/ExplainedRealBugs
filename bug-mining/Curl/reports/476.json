{"url":"https://api.github.com/repos/curl/curl/issues/12037","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/12037/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/12037/comments","events_url":"https://api.github.com/repos/curl/curl/issues/12037/events","html_url":"https://github.com/curl/curl/issues/12037","id":1928349878,"node_id":"I_kwDOAAiu0c5y8Ei2","number":12037,"title":"http3 quiche: QUIC connection is draining","user":{"login":"mb","id":36711370,"node_id":"MDQ6VXNlcjM2NzExMzcw","avatar_url":"https://avatars.githubusercontent.com/u/36711370?v=4","gravatar_id":"","url":"https://api.github.com/users/mb","html_url":"https://github.com/mb","followers_url":"https://api.github.com/users/mb/followers","following_url":"https://api.github.com/users/mb/following{/other_user}","gists_url":"https://api.github.com/users/mb/gists{/gist_id}","starred_url":"https://api.github.com/users/mb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mb/subscriptions","organizations_url":"https://api.github.com/users/mb/orgs","repos_url":"https://api.github.com/users/mb/repos","events_url":"https://api.github.com/users/mb/events{/privacy}","received_events_url":"https://api.github.com/users/mb/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":192515830,"node_id":"MDU6TGFiZWwxOTI1MTU4MzA=","url":"https://api.github.com/repos/curl/curl/labels/needs-info","name":"needs-info","color":"fbca04","default":false,"description":""},{"id":352090567,"node_id":"MDU6TGFiZWwzNTIwOTA1Njc=","url":"https://api.github.com/repos/curl/curl/labels/KNOWN_BUGS%20material","name":"KNOWN_BUGS material","color":"d93f0b","default":false,"description":null},{"id":1141438010,"node_id":"MDU6TGFiZWwxMTQxNDM4MDEw","url":"https://api.github.com/repos/curl/curl/labels/HTTP/3","name":"HTTP/3","color":"97fceb","default":false,"description":"h3 or quic related"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":11,"created_at":"2023-10-05T13:52:21Z","updated_at":"2024-06-03T08:46:25Z","closed_at":"2024-06-03T08:46:25Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nRunning curl3 (curl with quiche) from AUR: https://aur.archlinux.org/packages/curl-http3\r\nConnecting to the mozilla-central http3 test server using the first port outputted by the http3server.\r\n\r\n    $ SSLKEYLOGFILE=~/tmp/test.keys curl3 -i --http3-only https://127.0.0.1:41996/hello --insecure -vv\r\n    * processing: https://127.0.0.1:41996/hello\r\n    *   Trying 127.0.0.1:41996...\r\n    * Connected to 127.0.0.1 (127.0.0.1) port 41996\r\n    * using HTTP/3\r\n    * Using HTTP/3 Stream ID: 0\r\n    > GET /hello HTTP/3\r\n    > Host: 127.0.0.1:41996\r\n    > User-Agent: curl/8.2.1\r\n    > Accept: */*\r\n    > \r\n    * QUIC connection is draining\r\n    * Connection #0 to host 127.0.0.1 left intact\r\n    curl: (95) QUIC connection is draining\r\n\r\nThe error is coming from:\r\n\r\n* <https://github.com/curl/curl/blob/5ee0b9dd6eeea6ec66085fee128aa8173a60f0f6/lib/vquic/curl_quiche.c#L927>\r\n* https://docs.rs/quiche/0.18.0/quiche/struct.Connection.html#method.is_draining\r\n  > Returns true if the connection is draining.\r\n  > \r\n  > If this returns true, the connection object cannot yet be dropped, but no new application data can be sent or received. An application should continue calling the recv(), timeout(), and on_timeout() methods as normal, until the is_closed() method returns true.\r\n  >\r\n  > In contrast, once is_draining() returns true, calling send() is not required because no new outgoing packets will be generated.\r\n\r\ndraining is not an error to drop the connection. As far as I can tell the connection is terminated on that error.\r\n\r\nTest server binaries and wireshark capture including the SSLKEYLOGFILE: [test-setup.zip](https://github.com/curl/curl/files/12819131/test-setup.zip)\r\n\n\n### I expected the following\n\nI would expect the connection not to be terminated, but to be continued. I hope I understand it correctly and this is really a bug here, sorry if not.\n\n### curl/libcurl version\n\n```\r\n$ curl3 --version\r\ncurl 8.2.1 (x86_64-pc-linux-gnu) libcurl/8.2.1 BoringSSL zlib/1.3 brotli/1.1.0 zstd/1.5.5 libidn2/2.3.4 libpsl/0.21.2 (+libidn2/2.3.4) libssh2/1.11.0 nghttp2/1.56.0 quiche/0.17.2 librtmp/2.3\r\nRelease-Date: 2023-07-26\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps mqtt pop3 pop3s rtmp rtsp scp sftp smb smbs smtp smtps telnet tftp\r\nFeatures: alt-svc AsynchDNS brotli GSS-API HSTS HTTP2 HTTP3 HTTPS-proxy IDN IPv6 Kerberos Largefile libz NTLM NTLM_WB PSL SPNEGO SSL threadsafe UnixSockets zstd\r\n```\n\n### operating system\n\n```\r\n$ uname -a\r\nLinux archlinux 6.5.5-arch1-1 #1 SMP PREEMPT_DYNAMIC Sat, 23 Sep 2023 22:55:13 +0000 x86_64 GNU/Linux\r\n```","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/12037/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/12037/timeline","performed_via_github_app":null,"state_reason":"completed"}