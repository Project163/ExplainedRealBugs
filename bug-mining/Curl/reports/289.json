{"url":"https://api.github.com/repos/curl/curl/issues/9194","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/9194/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/9194/comments","events_url":"https://api.github.com/repos/curl/curl/issues/9194/events","html_url":"https://github.com/curl/curl/issues/9194","id":1315286050,"node_id":"I_kwDOAAiu0c5OZawi","number":9194,"title":"libcurl with Secure Transport and --enable-optimize crashes when settings CURLOPT_SSLCERT to an inexistant cert","user":{"login":"guillaumealgis","id":1041337,"node_id":"MDQ6VXNlcjEwNDEzMzc=","avatar_url":"https://avatars.githubusercontent.com/u/1041337?v=4","gravatar_id":"","url":"https://api.github.com/users/guillaumealgis","html_url":"https://github.com/guillaumealgis","followers_url":"https://api.github.com/users/guillaumealgis/followers","following_url":"https://api.github.com/users/guillaumealgis/following{/other_user}","gists_url":"https://api.github.com/users/guillaumealgis/gists{/gist_id}","starred_url":"https://api.github.com/users/guillaumealgis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/guillaumealgis/subscriptions","organizations_url":"https://api.github.com/users/guillaumealgis/orgs","repos_url":"https://api.github.com/users/guillaumealgis/repos","events_url":"https://api.github.com/users/guillaumealgis/events{/privacy}","received_events_url":"https://api.github.com/users/guillaumealgis/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118205,"node_id":"MDU6TGFiZWwxODQxMTgyMDU=","url":"https://api.github.com/repos/curl/curl/labels/crash","name":"crash","color":"bfe5bf","default":false,"description":null},{"id":184118221,"node_id":"MDU6TGFiZWwxODQxMTgyMjE=","url":"https://api.github.com/repos/curl/curl/labels/TLS","name":"TLS","color":"bfdadc","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":19,"created_at":"2022-07-22T18:07:39Z","updated_at":"2023-08-01T06:17:57Z","closed_at":"2023-08-01T06:17:57Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\r\n\r\n- Compiled libcurl with Secure Transport on Darwin platform (tested on macOS and iOS).\r\n- Used `--enable-optimize` during configuration (this bellow for the full options list).\r\n- Tried to make a request while using a non-existent client SSL certificate (eg. `curl_easy_setopt(handle, CURLOPT_SSLCERT, \"thisdoesnotexistinkeychain\");`).\r\n\r\n### I expected the following\r\n\r\n- The request fails and `curl_easy_perform` returns an error.\r\n\r\n### What I got\r\n\r\n- `curl_easy_perform` crashes on a `CFRelease` call.\r\n\r\n### curl/libcurl version\r\n\r\n```\r\ncurl 7.84.0 (arm-apple-darwin) libcurl/7.84.0 SecureTransport zlib/1.2.11 nghttp2/1.47.0\r\nRelease-Date: 2022-06-27\r\nProtocols: http https mqtt \r\nFeatures: alt-svc AsynchDNS HSTS HTTP2 IPv6 Largefile libz SSL threadsafe UnixSockets\r\n```\r\n\r\n### Operating system\r\n\r\n```\r\nmacOS Monterey 12.4 (21F79)\r\nXcode 13.4.1 (13F100)\r\n\r\nDarwin 21.5.0 Darwin Kernel Version 21.5.0: Tue Apr 26 21:08:37 PDT 2022; root:xnu-8020.121.3~4/RELEASE_ARM64_T6000 arm64\r\n```\r\n\r\n### Details\r\n\r\n#### libcurl ./configure options\r\n\r\n```\r\n./configure \\\r\n    --disable-dependency-tracking \\\r\n    --disable-shared \\\r\n    --enable-static \\\r\n    \\\r\n    --disable-debug \\\r\n    --disable-curldebug \\\r\n    --enable-optimize \\\r\n    --enable-warnings \\\r\n    --enable-symbol-hiding \\\r\n    \\\r\n    --disable-ares \\\r\n    \\\r\n    --enable-http \\\r\n    --disable-ftp \\\r\n    --disable-file \\\r\n    --disable-ldap \\\r\n    --disable-ldaps \\\r\n    --disable-rtsp \\\r\n    --disable-proxy \\\r\n    --disable-dict \\\r\n    --disable-telnet \\\r\n    --disable-tftp \\\r\n    --disable-pop3 \\\r\n    --disable-imap \\\r\n    --disable-smb \\\r\n    --disable-smtp \\\r\n    --disable-gopher \\\r\n    --disable-manual \\\r\n    --disable-libcurl-option \\\r\n    --enable-ipv6 \\\r\n    \\\r\n    --enable-threaded-resolver \\\r\n    --disable-sspi \\\r\n    --disable-crypto-auth \\\r\n    --disable-tls-srp \\\r\n    \\\r\n    --without-schannel \\\r\n    --with-secure-transport \\\r\n    \\\r\n    --without-libidn2 \\\r\n    \\\r\n    --host=\"arm-apple-darwin\" --prefix=\"dist\"\r\n```\r\n\r\n#### Minimal sample reproducing the issue\r\n\r\n```c\r\n#include <stdlib.h>\r\n#include <printf.h>\r\n\r\n#include \"curl-7.84.0/dist/include/curl/curl.h\"\r\n\r\nint main() {\r\n    CURL *handle = curl_easy_init();\r\n\r\n    if (!handle) {\r\n        exit(1);\r\n    }\r\n\r\n    char errbuf[CURL_ERROR_SIZE];\r\n    curl_easy_setopt(handle, CURLOPT_ERRORBUFFER, errbuf);\r\n    errbuf[0] = 0;\r\n\r\n    curl_easy_setopt(handle, CURLOPT_HTTP_VERSION, CURL_HTTP_VERSION_1_1);\r\n\r\n    curl_easy_setopt(handle, CURLOPT_SSLCERTTYPE, \"P12\");\r\n    curl_easy_setopt(handle, CURLOPT_SSLCERT, \"thisdoesnotexistinkeychain\");\r\n    curl_easy_setopt(handle, CURLOPT_KEYPASSWD, \"foobar\");\r\n\r\n    curl_easy_setopt(handle, CURLOPT_ACCEPT_ENCODING, \"gzip,deflate\");\r\n    curl_easy_setopt(handle, CURLOPT_URL, \"https://example.com\");\r\n\r\n    CURLcode res = curl_easy_perform(handle);\r\n\r\n    long http_code = 0;\r\n    curl_easy_getinfo(handle, CURLINFO_RESPONSE_CODE, &http_code);\r\n\r\n    if (res != CURLE_OK) {\r\n        size_t len = strlen(errbuf);\r\n        printf(\"\\nlibcurl: (%d) \", res);\r\n        if(len)\r\n            printf(\"%s%s\", errbuf, ((errbuf[len - 1] != '\\n') ? \"\\n\" : \"\"));\r\n        else\r\n            printf(\"%s\\n\", curl_easy_strerror(res));\r\n    } else {\r\n        printf(\"OK\");\r\n    }\r\n}\r\n\r\n```\r\n\r\n```\r\nxcrun clang -g test.c -I curl-7.84.0/dist/include -L curl-7.84.0/dist/lib -lcurl -lnghttp2 -lz -framework Security -framework CoreFoundation -framework SystemConfiguration\r\n```\r\n\r\nThe program will crash on : \r\n\r\n```\r\n* thread #1, queue = 'com.apple.main-thread', stop reason = EXC_BREAKPOINT (code=1, subcode=0x1b925544c)\r\n  * frame #0: 0x00000001b925544c CoreFoundation`CFRelease.cold.1 + 16\r\n    frame #1: 0x00000001b908838c CoreFoundation`CFRelease + 268\r\n    frame #2: 0x0000000100060574 a.out`CopyIdentityWithLabel(label=\"thisdoesnotexistinkeychain\", out_cert_and_key=0x000000016fdfea00) at sectransp.c:1185:11\r\n    frame #3: 0x000000010005de80 a.out`sectransp_connect_step1(data=0x0000000101808208, conn=0x000000010180ec08, sockindex=0) at sectransp.c:1890:13\r\n    frame #4: 0x000000010005d440 a.out`sectransp_connect_common(data=0x0000000101808208, conn=0x000000010180ec08, sockindex=0, nonblocking=true, done=0x000000016fdfef15) at sectransp.c:3068:14\r\n    frame #5: 0x000000010005d114 a.out`sectransp_connect_nonblocking(data=0x0000000101808208, conn=0x000000010180ec08, sockindex=0, done=0x000000016fdfef15) at sectransp.c:3157:10\r\n    frame #6: 0x0000000100063a94 a.out`Curl_ssl_connect_nonblocking(data=0x0000000101808208, conn=0x000000010180ec08, isproxy=false, sockindex=0, done=0x000000016fdfef15) at vtls.c:371:12\r\n    frame #7: 0x00000001000200d0 a.out`https_connecting(data=0x0000000101808208, done=0x000000016fdfef15) at http.c:1597:12\r\n    frame #8: 0x000000010001ffbc a.out`Curl_http_connect(data=0x0000000101808208, done=0x000000016fdfef15) at http.c:1523:14\r\n    frame #9: 0x000000010003e49c a.out`protocol_connect(data=0x0000000101808208, protocol_done=0x000000016fdfef15) at multi.c:1731:16\r\n    frame #10: 0x000000010003b274 a.out`multi_runsingle(multi=0x0000000100504088, nowp=0x000000016fdfef70, data=0x0000000101808208) at multi.c:2047:16\r\n    frame #11: 0x000000010003aa8c a.out`curl_multi_perform(multi=0x0000000100504088, running_handles=0x000000016fdfefd8) at multi.c:2640:14\r\n    frame #12: 0x0000000100014c04 a.out`easy_transfer(multi=0x0000000100504088) at easy.c:662:15\r\n    frame #13: 0x0000000100013b10 a.out`easy_perform(data=0x0000000101808208, events=false) at easy.c:752:42\r\n    frame #14: 0x0000000100013970 a.out`curl_easy_perform(data=0x0000000101808208) at easy.c:771:10\r\n    frame #15: 0x0000000100000e84 a.out`main at test.c:27:20\r\n    frame #16: 0x00000001000e108c dyld`start + 520\r\n```\r\n\r\nApparently curl is releasing the `keys_list` pointer even if nothing has been found by `SecItemCopyMatching`, which causes the crash. I spent a good few hours on this trying to figure out why `keys_list` was not NULL, but apparently my C is too rusty to solve this :(\r\n\r\nAny help would be greatly appreciated ! ","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/9194/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/9194/timeline","performed_via_github_app":null,"state_reason":"completed"}