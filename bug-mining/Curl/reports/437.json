{"url":"https://api.github.com/repos/curl/curl/issues/13284","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/13284/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/13284/comments","events_url":"https://api.github.com/repos/curl/curl/issues/13284/events","html_url":"https://github.com/curl/curl/issues/13284","id":2226497707,"node_id":"I_kwDOAAiu0c6Etair","number":13284,"title":"mysterious failures and IPv6 problems for macOS GitHub actions jobs","user":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2252760348,"node_id":"MDU6TGFiZWwyMjUyNzYwMzQ4","url":"https://api.github.com/repos/curl/curl/labels/CI","name":"CI","color":"ffb7ca","default":false,"description":"Continuous Integration"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2024-04-04T20:56:04Z","updated_at":"2024-04-05T06:31:41Z","closed_at":"2024-04-05T06:31:41Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\r\n\r\nOver the last several days, CI jobs running on GitHub actions have turned flaky. Sometimes one of the macOS jobs fails, sometimes 10 of them fail. Rerunning the same code again may result in a different outcome.\r\n\r\nThe failures seem IPv6 related somehow. [example job](https://github.com/curl/curl/actions/runs/8528433634/job/23362051611?pr=13250), [another example](https://github.com/curl/curl/actions/runs/8528433634/job/23362059353?pr=13250)\r\n\r\nThe most obvious symptom seems to be that when it has problems, it can't \"resolve\" `::1`. It can be noted that for macOS we call `getaddrinfo` even on plain numerical IP addresses\r\n\r\n## failures\r\n\r\nWhen this problem happens, usually the following test cases fail: 1085 1400 1401 1402 1403 1404 1405 1406 1407 1420 1465 1467 1468 2100\r\n\r\nLooking at test logs in a failed run , we can see that all HTTP-IPv6 tests are skipped because curl cannot verify the IPv6 server:\r\n~~~\r\n2024-04-02T19:43:36.1057020Z  * Added connection 0. The cache now contains 1 members\r\n2024-04-02T19:43:36.1057900Z  * STATE: CONNECT => RESOLVING handle 0x7fc26980be08; line 1954\r\n2024-04-02T19:43:36.1058690Z  * Could not resolve host: ::1\r\n~~~\r\n\r\n## test 1085\r\n\r\nTries to use an IPv6 address for `--interface` but the resolving of the host (`::1`) fails, which makes the test return an unexpected return code.\r\n\r\n## test 1400-1468\r\n\r\nThese tests verify `--libcurl` - outputting generated libcurl using source code for a curl command line.\r\n\r\nThese tests mysteriously get an extra line of libcurl code added:\r\n\r\n~~~c\r\ncurl_easy_setopt(hnd, CURLOPT_IPRESOLVE, 1L);\r\n~~~\r\n\r\nThe only way `CURLOPT_IPRESOLVE` is set by the curl command line tool is when the `-4/--ipv4` option is used. And it is not used in any of these tests.\r\n\r\n## test 2100\r\n\r\nUses DoH. When failing, the request does not ask for an IPv6 address (only IPv4) which makes the protocol check fail. Because it deems IPv6 not working?\r\n\r\n## macOS runner image\r\n~~~\r\nImage: macos-12\r\n  Version: 20240329.1\r\n  Included Software: https://github.com/actions/runner-images/blob/macOS-12/20240329.1/images/macos/macos-12-Readme.md\r\n  Image Release: https://github.com/actions/runner-images/releases/tag/macOS-12%2F20240329.1\r\n~~~\r\n\r\n### I expected the following\r\n\r\nThe tests should just work.\r\n\r\n### curl/libcurl version\r\n\r\ncurrent git\r\n\r\n### operating system\r\n\r\nmacOS only","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/13284/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/13284/timeline","performed_via_github_app":null,"state_reason":"completed"}