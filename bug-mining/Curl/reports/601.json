{"url":"https://api.github.com/repos/curl/curl/issues/15472","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/15472/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/15472/comments","events_url":"https://api.github.com/repos/curl/curl/issues/15472/events","html_url":"https://github.com/curl/curl/issues/15472","id":2629165971,"node_id":"I_kwDOAAiu0c6cteOT","number":15472,"title":"Unexpected errors if smtp support is disabled (on RHEL-9)","user":{"login":"jeroen","id":216319,"node_id":"MDQ6VXNlcjIxNjMxOQ==","avatar_url":"https://avatars.githubusercontent.com/u/216319?v=4","gravatar_id":"","url":"https://api.github.com/users/jeroen","html_url":"https://github.com/jeroen","followers_url":"https://api.github.com/users/jeroen/followers","following_url":"https://api.github.com/users/jeroen/following{/other_user}","gists_url":"https://api.github.com/users/jeroen/gists{/gist_id}","starred_url":"https://api.github.com/users/jeroen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeroen/subscriptions","organizations_url":"https://api.github.com/users/jeroen/orgs","repos_url":"https://api.github.com/users/jeroen/repos","events_url":"https://api.github.com/users/jeroen/events{/privacy}","received_events_url":"https://api.github.com/users/jeroen/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":352090567,"node_id":"MDU6TGFiZWwzNTIwOTA1Njc=","url":"https://api.github.com/repos/curl/curl/labels/KNOWN_BUGS%20material","name":"KNOWN_BUGS material","color":"d93f0b","default":false,"description":null},{"id":1117926199,"node_id":"MDU6TGFiZWwxMTE3OTI2MTk5","url":"https://api.github.com/repos/curl/curl/labels/libcurl%20API","name":"libcurl API","color":"fef2c0","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2024-11-01T14:35:42Z","updated_at":"2024-12-04T06:08:00Z","closed_at":"2024-12-04T06:08:00Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## RHEL 9: dual configuration\r\n\r\nUsers of the R bindings reported weird errors when sending sending emails on RHEL/Rockylinux version 9. It turns out the folks at Redhat have [packaged](https://src.fedoraproject.org/rpms/curl/blob/f34/f/curl.spec) libcurl in a unusual way.\r\n\r\nRHEL version 9 ships a single `curl-devel` package, but two different `libcurl` runtime builds. The default version installed on most systems is called `libcurl-minimal` and it disables several protocols including smtp. An alternative more complete build is available in the `libcurl` package, but most servers don't have this installed.\r\n\r\n## The problem\r\n\r\nWhen a user of libcurl bindings has the `libcurl-minimal` package (which does __not__ support smtp) installed on the server,  we see the following behavior:\r\n - Setting `CURLOPT_URL` to a `smtp://` url does __not error__\r\n - The `curl_easyoption` option API makes it seem `CURLOPT_MAIL_RCPT` is supported, however:\r\n - Setting the `CURLOPT_MAIL_RCPT` gives a confusing error message __*An unknown option was passed in to libcurl*__\r\n\r\n## Example program\r\n\r\nAn example `test.c` program to demonstrate this:\r\n\r\n```c\r\n#include <stdio.h>\r\n#include <string.h>\r\n#include <curl/curl.h>\r\n \r\nint main(void){\r\n  curl_global_init(CURL_GLOBAL_DEFAULT);\r\n  CURL *curl = curl_easy_init();\r\n  CURLcode err = 0;\r\n\r\n  // Check if SMTP supported is enabled\r\n  int has_smtp = 0;\r\n  const curl_version_info_data *data = curl_version_info(CURLVERSION_NOW);\r\n  const char *const * temp = data->protocols;\r\n  while(*++temp)\r\n    if(strcmp(*temp, \"smtp\") == 0) has_smtp=1;\r\n  printf(\"SMTP support: %s\\n\", has_smtp ? \"YES\" : \"NO\");\r\n\r\n  // Test if CURLOPT_MAIL_RCPT exists\r\n  const struct curl_easyoption *o = curl_easy_option_by_id(CURLOPT_MAIL_RCPT);\r\n  printf(\"Found %s: type %d flags %d\\n\", o->name, o->type, o->flags);\r\n\r\n  // should this not error if smtp is not supported?\r\n  err = curl_easy_setopt(curl, CURLOPT_URL, \"smtp://mail.example.com\");\r\n  printf(\"Setting CURLOPT_URL: %s\\n\",curl_easy_strerror(err));\r\n\r\n  struct curl_slist *recipients = NULL;\r\n  recipients = curl_slist_append(recipients, \"<addressee@example.net>\");\r\n  err = curl_easy_setopt(curl, CURLOPT_MAIL_RCPT, recipients);\r\n  printf(\"Setting CURLOPT_MAIL_RCPT: %s\\n\",curl_easy_strerror(err));\r\n  return 0;\r\n}\r\n```\r\n\r\nYou can easily run a RHEL-9 container in docker:\r\n\r\n```sh\r\ndocker run --rm -it rockylinux/rockylinux:9\r\n```\r\n\r\nThen in docker you need to install the compiler and curl headers:\r\n\r\n```sh\r\ndnf install -y gcc curl-devel\r\ngcc test.c -lcurl\r\n./a.out\r\n```\r\n\r\n\r\n\r\n### curl/libcurl version\r\n\r\ncurl 7.76.1 (x86_64-redhat-linux-gnu) libcurl/7.76.1 OpenSSL/3.0.7 zlib/1.2.11 nghttp2/1.43.0\r\n\r\n### operating system\r\n\r\nRedhat 9 / RockyLinux 9","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/15472/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/15472/timeline","performed_via_github_app":null,"state_reason":"completed"}