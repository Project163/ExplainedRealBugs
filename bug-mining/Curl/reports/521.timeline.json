[{"id":13776282372,"node_id":"RTE_lADOAAiu0c6SD53TzwAAAAM1IWME","url":"https://api.github.com/repos/curl/curl/issues/events/13776282372","actor":{"login":"luozhaohui","id":12403610,"node_id":"MDQ6VXNlcjEyNDAzNjEw","avatar_url":"https://avatars.githubusercontent.com/u/12403610?v=4","gravatar_id":"","url":"https://api.github.com/users/luozhaohui","html_url":"https://github.com/luozhaohui","followers_url":"https://api.github.com/users/luozhaohui/followers","following_url":"https://api.github.com/users/luozhaohui/following{/other_user}","gists_url":"https://api.github.com/users/luozhaohui/gists{/gist_id}","starred_url":"https://api.github.com/users/luozhaohui/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/luozhaohui/subscriptions","organizations_url":"https://api.github.com/users/luozhaohui/orgs","repos_url":"https://api.github.com/users/luozhaohui/repos","events_url":"https://api.github.com/users/luozhaohui/events{/privacy}","received_events_url":"https://api.github.com/users/luozhaohui/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"renamed","commit_id":null,"commit_url":null,"created_at":"2024-08-06T10:14:38Z","rename":{"from":"[DOH] Since v8.5.0, a change in API behavior causes curl_multi_poll() to return error code","to":"[DOH] Since v8.5.0, a change in API behavior causes curl_multi_poll() or curl_multi_perform() to return error code"},"performed_via_github_app":null},{"id":13777084534,"node_id":"LE_lADOAAiu0c6SD53TzwAAAAM1LaB2","url":"https://api.github.com/repos/curl/curl/issues/events/13777084534","actor":{"login":"vszakats","id":1446897,"node_id":"MDQ6VXNlcjE0NDY4OTc=","avatar_url":"https://avatars.githubusercontent.com/u/1446897?v=4","gravatar_id":"","url":"https://api.github.com/users/vszakats","html_url":"https://github.com/vszakats","followers_url":"https://api.github.com/users/vszakats/followers","following_url":"https://api.github.com/users/vszakats/following{/other_user}","gists_url":"https://api.github.com/users/vszakats/gists{/gist_id}","starred_url":"https://api.github.com/users/vszakats/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vszakats/subscriptions","organizations_url":"https://api.github.com/users/vszakats/orgs","repos_url":"https://api.github.com/users/vszakats/repos","events_url":"https://api.github.com/users/vszakats/events{/privacy}","received_events_url":"https://api.github.com/users/vszakats/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2024-08-06T11:20:08Z","label":{"name":"name lookup","color":"0052cc"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/curl/curl/issues/comments/2271406164","html_url":"https://github.com/curl/curl/issues/14414#issuecomment-2271406164","issue_url":"https://api.github.com/repos/curl/curl/issues/14414","id":2271406164,"node_id":"IC_kwDOAAiu0c6HYuhU","user":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-06T14:15:06Z","updated_at":"2024-08-06T14:15:06Z","body":"Instead of trying to figure out what your code actually does, I decided to write a (simpler) version in plain C and it just works. Any idea what differences there are between them?\r\n\r\n~~~c\r\n#include <stdio.h>\r\n#include <string.h>\r\n\r\n/* curl stuff */\r\n#include <curl/curl.h>\r\n\r\n/*\r\n * Simply download an HTTP file.\r\n */\r\nint main(void)\r\n{\r\n  CURL *http_handle;\r\n  CURLM *multi_handle;\r\n  int still_running = 1; /* keep number of running handles */\r\n\r\n  curl_global_init(CURL_GLOBAL_DEFAULT);\r\n\r\n  http_handle = curl_easy_init();\r\n\r\n  curl_easy_setopt(http_handle, CURLOPT_URL, \"https://httpbin.org/delay/5\");\r\n  curl_easy_setopt(http_handle, CURLOPT_DOH_URL, \"https://1.1.1.1/dns-query\");\r\n\r\n  /* init a multi stack */\r\n  multi_handle = curl_multi_init();\r\n\r\n  /* add the individual transfers */\r\n  curl_multi_add_handle(multi_handle, http_handle);\r\n\r\n  do {\r\n    CURLMcode mc = curl_multi_perform(multi_handle, &still_running);\r\n\r\n    if(!mc)\r\n      /* wait for activity, timeout or \"nothing\" */\r\n      mc = curl_multi_poll(multi_handle, NULL, 0, 1000, NULL);\r\n\r\n    if(mc) {\r\n      fprintf(stderr, \"curl_multi_poll() failed, code %d.\\n\", (int)mc);\r\n      break;\r\n    }\r\n\r\n  } while(still_running);\r\n\r\n  curl_multi_remove_handle(multi_handle, http_handle);\r\n\r\n  curl_easy_cleanup(http_handle);\r\n\r\n  curl_multi_cleanup(multi_handle);\r\n\r\n  curl_global_cleanup();\r\n\r\n  return 0;\r\n}\r\n","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/curl/curl/issues/comments/2271406164/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/curl/curl/issues/comments/2272557375","html_url":"https://github.com/curl/curl/issues/14414#issuecomment-2272557375","issue_url":"https://api.github.com/repos/curl/curl/issues/14414","id":2272557375,"node_id":"IC_kwDOAAiu0c6HdHk_","user":{"login":"luozhaohui","id":12403610,"node_id":"MDQ6VXNlcjEyNDAzNjEw","avatar_url":"https://avatars.githubusercontent.com/u/12403610?v=4","gravatar_id":"","url":"https://api.github.com/users/luozhaohui","html_url":"https://github.com/luozhaohui","followers_url":"https://api.github.com/users/luozhaohui/followers","following_url":"https://api.github.com/users/luozhaohui/following{/other_user}","gists_url":"https://api.github.com/users/luozhaohui/gists{/gist_id}","starred_url":"https://api.github.com/users/luozhaohui/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/luozhaohui/subscriptions","organizations_url":"https://api.github.com/users/luozhaohui/orgs","repos_url":"https://api.github.com/users/luozhaohui/repos","events_url":"https://api.github.com/users/luozhaohui/events{/privacy}","received_events_url":"https://api.github.com/users/luozhaohui/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-07T03:44:30Z","updated_at":"2024-08-07T04:08:01Z","body":"@bagder Thank you for your response and for taking the time to write sample code. \r\n\r\nI would like to share more test results. This issue only occurs when DOH is enabled and [curl_multi_remove_handle()](https://curl.se/libcurl/c/curl_multi_remove_handle.html) is called to remove handles during the execution of curl. This problem started appearing from version v8.5.0. The test program is simplified from the product code (which works with versions v7.68.0 to v8.4.0). It primarily implements two features: *setting up DOH* and *canceling requests*.\r\n\r\n- The following test code only sets up DOH and does not cancel requests, the issue does not occur.\r\n\r\n```\r\n    auto url = \"https://httpbin.org/delay/5\";\r\n    auto dnsServer = \"https://1.1.1.1/dns-query\";\r\n\r\n    auto test_abort_func = [=](IClient& cli, const std::string& dnsServer, int abortAfterMs) {\r\n        auto flag = std::make_shared<std::atomic_bool>(false);\r\n\r\n        std::cout << \"\\n>> start a request.\" << std::endl;\r\n        auto session = cli.get(url, dnsServer, flag);\r\n\r\n        std::cout << \"\\n>> start another request.\" << std::endl;\r\n        cli.get(url, dnsServer, flag);\r\n    };\r\n```\r\n\r\n- The following test code only cancels requests and does not set up DOH, the issue does not occur.\r\n\r\n```\r\n    auto url = \"https://httpbin.org/delay/5\";\r\n    auto dnsServer = \"https://1.1.1.1/dns-query\";\r\n    dnsServer = \"\"; // disable DoH\r\n\r\n    auto test_abort_func = [=](IClient& cli, const std::string& dnsServer, int abortAfterMs) {\r\n        auto abortFlag = std::make_shared<std::atomic_bool>(false);\r\n        auto th = std::thread{[&]()\r\n        {\r\n            std::this_thread::sleep_for(std::chrono::milliseconds(abortAfterMs));\r\n            abortFlag->store(true);\r\n        }};\r\n\r\n        std::cout << \"\\n>> start a request that will be aborted.\" << std::endl;\r\n        try\r\n        {\r\n            auto session = cli.get(url, dnsServer, abortFlag);\r\n            std::cout << \">> abort test \" << abortAfterMs << \" ms: \" << session->getStatusStr() << std::endl;\r\n        }\r\n        catch(RequestError& error)\r\n        {\r\n            std::cout << \">> abort test \" << error.response().url() << \". status: \" << error.response().getStatusStr() << std::endl;\r\n        }\r\n\r\n        std::cout << \"\\n>> start another request.\" << std::endl;\r\n        auto flag = std::make_shared<std::atomic_bool>(false);\r\n        cli.get(url, \"\", flag);\r\n        th.join();\r\n    };\r\n```\r\n\r\nBased on the program run and version test results, I speculate that this is likely related to some changes in DoH in v8.5.0. I hope the information provided will be helpful.\r\n","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/curl/curl/issues/comments/2272557375/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"luozhaohui","id":12403610,"node_id":"MDQ6VXNlcjEyNDAzNjEw","avatar_url":"https://avatars.githubusercontent.com/u/12403610?v=4","gravatar_id":"","url":"https://api.github.com/users/luozhaohui","html_url":"https://github.com/luozhaohui","followers_url":"https://api.github.com/users/luozhaohui/followers","following_url":"https://api.github.com/users/luozhaohui/following{/other_user}","gists_url":"https://api.github.com/users/luozhaohui/gists{/gist_id}","starred_url":"https://api.github.com/users/luozhaohui/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/luozhaohui/subscriptions","organizations_url":"https://api.github.com/users/luozhaohui/orgs","repos_url":"https://api.github.com/users/luozhaohui/repos","events_url":"https://api.github.com/users/luozhaohui/events{/privacy}","received_events_url":"https://api.github.com/users/luozhaohui/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":13786210992,"node_id":"MEE_lADOAAiu0c6SD53TzwAAAAM1uOKw","url":"https://api.github.com/repos/curl/curl/issues/events/13786210992","actor":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-08-07T03:44:31Z","performed_via_github_app":null},{"id":13786210994,"node_id":"SE_lADOAAiu0c6SD53TzwAAAAM1uOKy","url":"https://api.github.com/repos/curl/curl/issues/events/13786210994","actor":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-08-07T03:44:31Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/curl/curl/issues/comments/2272832896","html_url":"https://github.com/curl/curl/issues/14414#issuecomment-2272832896","issue_url":"https://api.github.com/repos/curl/curl/issues/14414","id":2272832896,"node_id":"IC_kwDOAAiu0c6HeK2A","user":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-07T07:44:43Z","updated_at":"2024-08-07T07:44:43Z","body":"I did some fixes in regard to DoH handle cleanup in #14212. Maybe there is more lurking?","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/curl/curl/issues/comments/2272832896/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/curl/curl/issues/comments/2272864810","html_url":"https://github.com/curl/curl/issues/14414#issuecomment-2272864810","issue_url":"https://api.github.com/repos/curl/curl/issues/14414","id":2272864810,"node_id":"IC_kwDOAAiu0c6HeSoq","user":{"login":"luozhaohui","id":12403610,"node_id":"MDQ6VXNlcjEyNDAzNjEw","avatar_url":"https://avatars.githubusercontent.com/u/12403610?v=4","gravatar_id":"","url":"https://api.github.com/users/luozhaohui","html_url":"https://github.com/luozhaohui","followers_url":"https://api.github.com/users/luozhaohui/followers","following_url":"https://api.github.com/users/luozhaohui/following{/other_user}","gists_url":"https://api.github.com/users/luozhaohui/gists{/gist_id}","starred_url":"https://api.github.com/users/luozhaohui/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/luozhaohui/subscriptions","organizations_url":"https://api.github.com/users/luozhaohui/orgs","repos_url":"https://api.github.com/users/luozhaohui/repos","events_url":"https://api.github.com/users/luozhaohui/events{/privacy}","received_events_url":"https://api.github.com/users/luozhaohui/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-07T08:02:51Z","updated_at":"2024-08-07T08:07:31Z","body":"@icing Good to hear from you again. \r\nI thought the commit in that PR was already included in v8.9.1. If not, I'll cherry-pick it and give it a try.\r\n\r\n---\r\nUpdates:\r\nBad luck. v8.9.1 already includes those changes, see: https://github.com/curl/curl/commit/d8696dc8c0a8879e2673870d09adc5fa9ab1af22, so there may be more hidden issues.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/curl/curl/issues/comments/2272864810/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"luozhaohui","id":12403610,"node_id":"MDQ6VXNlcjEyNDAzNjEw","avatar_url":"https://avatars.githubusercontent.com/u/12403610?v=4","gravatar_id":"","url":"https://api.github.com/users/luozhaohui","html_url":"https://github.com/luozhaohui","followers_url":"https://api.github.com/users/luozhaohui/followers","following_url":"https://api.github.com/users/luozhaohui/following{/other_user}","gists_url":"https://api.github.com/users/luozhaohui/gists{/gist_id}","starred_url":"https://api.github.com/users/luozhaohui/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/luozhaohui/subscriptions","organizations_url":"https://api.github.com/users/luozhaohui/orgs","repos_url":"https://api.github.com/users/luozhaohui/repos","events_url":"https://api.github.com/users/luozhaohui/events{/privacy}","received_events_url":"https://api.github.com/users/luozhaohui/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":13788396437,"node_id":"MEE_lADOAAiu0c6SD53TzwAAAAM12juV","url":"https://api.github.com/repos/curl/curl/issues/events/13788396437","actor":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-08-07T08:02:52Z","performed_via_github_app":null},{"id":13788396453,"node_id":"SE_lADOAAiu0c6SD53TzwAAAAM12jul","url":"https://api.github.com/repos/curl/curl/issues/events/13788396453","actor":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-08-07T08:02:52Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/curl/curl/issues/comments/2272872704","html_url":"https://github.com/curl/curl/issues/14414#issuecomment-2272872704","issue_url":"https://api.github.com/repos/curl/curl/issues/14414","id":2272872704,"node_id":"IC_kwDOAAiu0c6HeUkA","user":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-07T08:06:54Z","updated_at":"2024-08-07T08:06:54Z","body":"The commit *should* be in 8.9.1. Maybe there is a code path that it has not covered?\r\n\r\nThe error indicates that there is an easy handle found that is no longer valid, e.g. was released. The question is what kind of handle it is. If you build libcurl yourself, maybe you could extend the GOOD_EASY_HANDLE check to give some more information if the memory had not been overwritten yet.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/curl/curl/issues/comments/2272872704/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/curl/curl/issues/comments/2272932457","html_url":"https://github.com/curl/curl/issues/14414#issuecomment-2272932457","issue_url":"https://api.github.com/repos/curl/curl/issues/14414","id":2272932457,"node_id":"IC_kwDOAAiu0c6HejJp","user":{"login":"luozhaohui","id":12403610,"node_id":"MDQ6VXNlcjEyNDAzNjEw","avatar_url":"https://avatars.githubusercontent.com/u/12403610?v=4","gravatar_id":"","url":"https://api.github.com/users/luozhaohui","html_url":"https://github.com/luozhaohui","followers_url":"https://api.github.com/users/luozhaohui/followers","following_url":"https://api.github.com/users/luozhaohui/following{/other_user}","gists_url":"https://api.github.com/users/luozhaohui/gists{/gist_id}","starred_url":"https://api.github.com/users/luozhaohui/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/luozhaohui/subscriptions","organizations_url":"https://api.github.com/users/luozhaohui/orgs","repos_url":"https://api.github.com/users/luozhaohui/repos","events_url":"https://api.github.com/users/luozhaohui/events{/privacy}","received_events_url":"https://api.github.com/users/luozhaohui/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-07T08:37:39Z","updated_at":"2024-08-07T08:57:40Z","body":"I enabled both `enable-curldebug` and `enable-debug` options but had no luck. The assert() checks on the handle were successful. By the way, error code 12 means CURLM_UNRECOVERABLE_POLL. It only returns from the following code. This issue is consistently reproducible since v8.5.0, and if you could run the test program and look into this, I would greatly appreciate it.\r\n\r\nFile: `multi.c`\r\n```\r\n    int pollrc;\r\n#ifdef USE_WINSOCK\r\n    if(cpfds.n)         /* just pre-check with WinSock */\r\n      pollrc = Curl_poll(cpfds.pfds, cpfds.n, 0);\r\n    else\r\n      pollrc = 0;\r\n#else\r\n    pollrc = Curl_poll(cpfds.pfds, cpfds.n, timeout_ms); /* wait... */\r\n#endif\r\n    if(pollrc < 0) {\r\n      result = CURLM_UNRECOVERABLE_POLL;\r\n      goto out;\r\n    }\r\n```\r\n\r\n---\r\n\r\nPlease note the different test results for the different versions.\r\n* v8.3.0, v8.4.0: Good.\r\n* v8.5.0, v8.6.0, v8.7.1: Bad, return [curl error 2], curl_multi_perform: Invalid easy handle.\r\n* v8.8.0, v8.9.1: Bad, return [curl error 12], curl_multi_poll: Unrecoverable error in select/poll.\r\n","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/curl/curl/issues/comments/2272932457/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"luozhaohui","id":12403610,"node_id":"MDQ6VXNlcjEyNDAzNjEw","avatar_url":"https://avatars.githubusercontent.com/u/12403610?v=4","gravatar_id":"","url":"https://api.github.com/users/luozhaohui","html_url":"https://github.com/luozhaohui","followers_url":"https://api.github.com/users/luozhaohui/followers","following_url":"https://api.github.com/users/luozhaohui/following{/other_user}","gists_url":"https://api.github.com/users/luozhaohui/gists{/gist_id}","starred_url":"https://api.github.com/users/luozhaohui/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/luozhaohui/subscriptions","organizations_url":"https://api.github.com/users/luozhaohui/orgs","repos_url":"https://api.github.com/users/luozhaohui/repos","events_url":"https://api.github.com/users/luozhaohui/events{/privacy}","received_events_url":"https://api.github.com/users/luozhaohui/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/curl/curl/issues/comments/2273290619","html_url":"https://github.com/curl/curl/issues/14414#issuecomment-2273290619","issue_url":"https://api.github.com/repos/curl/curl/issues/14414","id":2273290619,"node_id":"IC_kwDOAAiu0c6Hf6l7","user":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-07T11:53:22Z","updated_at":"2024-08-07T11:53:22Z","body":"So, my current thinking is that you app does abort transfers which have DoH request ongoing and the cleanup of those is not handled properly:\r\n\r\n- without DoH, everything works fine, as I understand\r\n- v8.5.0 introduced a change that did not cleanup DoH handles, leading to \"Invalid easy handle.\" errors\r\n- v8.8.0 somehow fixed that, but the - probably closed - sockets of the DoH requests ended up in the `Curl_poll()` and cause that to fail.\r\n\r\nSounds reasonable?","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/curl/curl/issues/comments/2273290619/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/curl/curl/issues/comments/2274956513","html_url":"https://github.com/curl/curl/issues/14414#issuecomment-2274956513","issue_url":"https://api.github.com/repos/curl/curl/issues/14414","id":2274956513,"node_id":"IC_kwDOAAiu0c6HmRTh","user":{"login":"luozhaohui","id":12403610,"node_id":"MDQ6VXNlcjEyNDAzNjEw","avatar_url":"https://avatars.githubusercontent.com/u/12403610?v=4","gravatar_id":"","url":"https://api.github.com/users/luozhaohui","html_url":"https://github.com/luozhaohui","followers_url":"https://api.github.com/users/luozhaohui/followers","following_url":"https://api.github.com/users/luozhaohui/following{/other_user}","gists_url":"https://api.github.com/users/luozhaohui/gists{/gist_id}","starred_url":"https://api.github.com/users/luozhaohui/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/luozhaohui/subscriptions","organizations_url":"https://api.github.com/users/luozhaohui/orgs","repos_url":"https://api.github.com/users/luozhaohui/repos","events_url":"https://api.github.com/users/luozhaohui/events{/privacy}","received_events_url":"https://api.github.com/users/luozhaohui/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-08T05:01:55Z","updated_at":"2024-08-08T05:01:55Z","body":"@icing  I think your reasoning makes sense. This issue only happens when canceling an ongoing DoH request.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/curl/curl/issues/comments/2274956513/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"luozhaohui","id":12403610,"node_id":"MDQ6VXNlcjEyNDAzNjEw","avatar_url":"https://avatars.githubusercontent.com/u/12403610?v=4","gravatar_id":"","url":"https://api.github.com/users/luozhaohui","html_url":"https://github.com/luozhaohui","followers_url":"https://api.github.com/users/luozhaohui/followers","following_url":"https://api.github.com/users/luozhaohui/following{/other_user}","gists_url":"https://api.github.com/users/luozhaohui/gists{/gist_id}","starred_url":"https://api.github.com/users/luozhaohui/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/luozhaohui/subscriptions","organizations_url":"https://api.github.com/users/luozhaohui/orgs","repos_url":"https://api.github.com/users/luozhaohui/repos","events_url":"https://api.github.com/users/luozhaohui/events{/privacy}","received_events_url":"https://api.github.com/users/luozhaohui/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":13801112778,"node_id":"MEE_lADOAAiu0c6SD53TzwAAAAM2nETK","url":"https://api.github.com/repos/curl/curl/issues/events/13801112778","actor":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-08-08T05:01:56Z","performed_via_github_app":null},{"id":13801112785,"node_id":"SE_lADOAAiu0c6SD53TzwAAAAM2nETR","url":"https://api.github.com/repos/curl/curl/issues/events/13801112785","actor":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-08-08T05:01:56Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/curl/curl/issues/comments/2283627478","html_url":"https://github.com/curl/curl/issues/14414#issuecomment-2283627478","issue_url":"https://api.github.com/repos/curl/curl/issues/14414","id":2283627478,"node_id":"IC_kwDOAAiu0c6IHWPW","user":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-12T10:39:22Z","updated_at":"2024-08-12T10:39:22Z","body":"@luozhaohui thanks for your patience. I made #14499 to manage the dependencies between a transfer and its DoH requests better. I am not sure this will fix the issue you observer, but I would be interested if this changes anything in your setup.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/curl/curl/issues/comments/2283627478/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":13846041928,"node_id":"MEE_lADOAAiu0c6SD53TzwAAAAM5SdVI","url":"https://api.github.com/repos/curl/curl/issues/events/13846041928","actor":{"login":"luozhaohui","id":12403610,"node_id":"MDQ6VXNlcjEyNDAzNjEw","avatar_url":"https://avatars.githubusercontent.com/u/12403610?v=4","gravatar_id":"","url":"https://api.github.com/users/luozhaohui","html_url":"https://github.com/luozhaohui","followers_url":"https://api.github.com/users/luozhaohui/followers","following_url":"https://api.github.com/users/luozhaohui/following{/other_user}","gists_url":"https://api.github.com/users/luozhaohui/gists{/gist_id}","starred_url":"https://api.github.com/users/luozhaohui/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/luozhaohui/subscriptions","organizations_url":"https://api.github.com/users/luozhaohui/orgs","repos_url":"https://api.github.com/users/luozhaohui/repos","events_url":"https://api.github.com/users/luozhaohui/events{/privacy}","received_events_url":"https://api.github.com/users/luozhaohui/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-08-12T10:39:23Z","performed_via_github_app":null},{"id":13846041942,"node_id":"SE_lADOAAiu0c6SD53TzwAAAAM5SdVW","url":"https://api.github.com/repos/curl/curl/issues/events/13846041942","actor":{"login":"luozhaohui","id":12403610,"node_id":"MDQ6VXNlcjEyNDAzNjEw","avatar_url":"https://avatars.githubusercontent.com/u/12403610?v=4","gravatar_id":"","url":"https://api.github.com/users/luozhaohui","html_url":"https://github.com/luozhaohui","followers_url":"https://api.github.com/users/luozhaohui/followers","following_url":"https://api.github.com/users/luozhaohui/following{/other_user}","gists_url":"https://api.github.com/users/luozhaohui/gists{/gist_id}","starred_url":"https://api.github.com/users/luozhaohui/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/luozhaohui/subscriptions","organizations_url":"https://api.github.com/users/luozhaohui/orgs","repos_url":"https://api.github.com/users/luozhaohui/repos","events_url":"https://api.github.com/users/luozhaohui/events{/privacy}","received_events_url":"https://api.github.com/users/luozhaohui/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-08-12T10:39:23Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/curl/curl/issues/comments/2285713757","html_url":"https://github.com/curl/curl/issues/14414#issuecomment-2285713757","issue_url":"https://api.github.com/repos/curl/curl/issues/14414","id":2285713757,"node_id":"IC_kwDOAAiu0c6IPTld","user":{"login":"luozhaohui","id":12403610,"node_id":"MDQ6VXNlcjEyNDAzNjEw","avatar_url":"https://avatars.githubusercontent.com/u/12403610?v=4","gravatar_id":"","url":"https://api.github.com/users/luozhaohui","html_url":"https://github.com/luozhaohui","followers_url":"https://api.github.com/users/luozhaohui/followers","following_url":"https://api.github.com/users/luozhaohui/following{/other_user}","gists_url":"https://api.github.com/users/luozhaohui/gists{/gist_id}","starred_url":"https://api.github.com/users/luozhaohui/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/luozhaohui/subscriptions","organizations_url":"https://api.github.com/users/luozhaohui/orgs","repos_url":"https://api.github.com/users/luozhaohui/repos","events_url":"https://api.github.com/users/luozhaohui/events{/privacy}","received_events_url":"https://api.github.com/users/luozhaohui/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-13T08:51:27Z","updated_at":"2024-08-13T08:51:27Z","body":"@icing Thank you for the update. I tested your branch([multi-id](https://github.com/icing/curl/tree/multi-id)), and the issue has been resolved, with no side effects observed so far.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/curl/curl/issues/comments/2285713757/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":1,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"luozhaohui","id":12403610,"node_id":"MDQ6VXNlcjEyNDAzNjEw","avatar_url":"https://avatars.githubusercontent.com/u/12403610?v=4","gravatar_id":"","url":"https://api.github.com/users/luozhaohui","html_url":"https://github.com/luozhaohui","followers_url":"https://api.github.com/users/luozhaohui/followers","following_url":"https://api.github.com/users/luozhaohui/following{/other_user}","gists_url":"https://api.github.com/users/luozhaohui/gists{/gist_id}","starred_url":"https://api.github.com/users/luozhaohui/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/luozhaohui/subscriptions","organizations_url":"https://api.github.com/users/luozhaohui/orgs","repos_url":"https://api.github.com/users/luozhaohui/repos","events_url":"https://api.github.com/users/luozhaohui/events{/privacy}","received_events_url":"https://api.github.com/users/luozhaohui/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":13859993426,"node_id":"MEE_lADOAAiu0c6SD53TzwAAAAM6HrdS","url":"https://api.github.com/repos/curl/curl/issues/events/13859993426","actor":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-08-13T08:51:29Z","performed_via_github_app":null},{"id":13859993443,"node_id":"SE_lADOAAiu0c6SD53TzwAAAAM6Hrdj","url":"https://api.github.com/repos/curl/curl/issues/events/13859993443","actor":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-08-13T08:51:29Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/curl/curl/issues/comments/2285723518","html_url":"https://github.com/curl/curl/issues/14414#issuecomment-2285723518","issue_url":"https://api.github.com/repos/curl/curl/issues/14414","id":2285723518,"node_id":"IC_kwDOAAiu0c6IPV9-","user":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-13T08:56:12Z","updated_at":"2024-08-13T08:56:12Z","body":"I am very happy to hear that!","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/curl/curl/issues/comments/2285723518/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":13860127548,"node_id":"CE_lADOAAiu0c6SD53TzwAAAAM6IMM8","url":"https://api.github.com/repos/curl/curl/issues/events/13860127548","actor":{"login":"luozhaohui","id":12403610,"node_id":"MDQ6VXNlcjEyNDAzNjEw","avatar_url":"https://avatars.githubusercontent.com/u/12403610?v=4","gravatar_id":"","url":"https://api.github.com/users/luozhaohui","html_url":"https://github.com/luozhaohui","followers_url":"https://api.github.com/users/luozhaohui/followers","following_url":"https://api.github.com/users/luozhaohui/following{/other_user}","gists_url":"https://api.github.com/users/luozhaohui/gists{/gist_id}","starred_url":"https://api.github.com/users/luozhaohui/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/luozhaohui/subscriptions","organizations_url":"https://api.github.com/users/luozhaohui/orgs","repos_url":"https://api.github.com/users/luozhaohui/repos","events_url":"https://api.github.com/users/luozhaohui/events{/privacy}","received_events_url":"https://api.github.com/users/luozhaohui/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2024-08-13T09:01:13Z","state_reason":null,"performed_via_github_app":null},{"id":13877037241,"node_id":"REFE_lADOAAiu0c6SD53TzwAAAAM7Isi5","url":"https://api.github.com/repos/curl/curl/issues/events/13877037241","actor":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"22d292b3eca1dcbdc590f07e7fe07d1132312a1c","commit_url":"https://api.github.com/repos/curl/curl/commits/22d292b3eca1dcbdc590f07e7fe07d1132312a1c","created_at":"2024-08-14T09:22:06Z","performed_via_github_app":null},{"actor":{"login":"grahamc","id":76716,"node_id":"MDQ6VXNlcjc2NzE2","avatar_url":"https://avatars.githubusercontent.com/u/76716?v=4","gravatar_id":"","url":"https://api.github.com/users/grahamc","html_url":"https://github.com/grahamc","followers_url":"https://api.github.com/users/grahamc/followers","following_url":"https://api.github.com/users/grahamc/following{/other_user}","gists_url":"https://api.github.com/users/grahamc/gists{/gist_id}","starred_url":"https://api.github.com/users/grahamc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/grahamc/subscriptions","organizations_url":"https://api.github.com/users/grahamc/orgs","repos_url":"https://api.github.com/users/grahamc/repos","events_url":"https://api.github.com/users/grahamc/events{/privacy}","received_events_url":"https://api.github.com/users/grahamc/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-30T15:32:20Z","updated_at":"2024-08-30T15:32:20Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/NixOS/nix/issues/11387","repository_url":"https://api.github.com/repos/NixOS/nix","labels_url":"https://api.github.com/repos/NixOS/nix/issues/11387/labels{/name}","comments_url":"https://api.github.com/repos/NixOS/nix/issues/11387/comments","events_url":"https://api.github.com/repos/NixOS/nix/issues/11387/events","html_url":"https://github.com/NixOS/nix/issues/11387","id":2497544047,"node_id":"I_kwDOADOq6M6U3X9v","number":11387,"title":"Nix 2.24.4 has an increase of CURLM_UNRECOVERABLE_POLL errors","user":{"login":"grahamc","id":76716,"node_id":"MDQ6VXNlcjc2NzE2","avatar_url":"https://avatars.githubusercontent.com/u/76716?v=4","gravatar_id":"","url":"https://api.github.com/users/grahamc","html_url":"https://github.com/grahamc","followers_url":"https://api.github.com/users/grahamc/followers","following_url":"https://api.github.com/users/grahamc/following{/other_user}","gists_url":"https://api.github.com/users/grahamc/gists{/gist_id}","starred_url":"https://api.github.com/users/grahamc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/grahamc/subscriptions","organizations_url":"https://api.github.com/users/grahamc/orgs","repos_url":"https://api.github.com/users/grahamc/repos","events_url":"https://api.github.com/users/grahamc/events{/privacy}","received_events_url":"https://api.github.com/users/grahamc/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":3709158,"node_id":"MDU6TGFiZWwzNzA5MTU4","url":"https://api.github.com/repos/NixOS/nix/labels/bug","name":"bug","color":"e10c02","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2024-08-30T15:32:20Z","updated_at":"2024-09-03T18:45:32Z","closed_at":"2024-09-03T18:45:32Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":3386088,"node_id":"MDEwOlJlcG9zaXRvcnkzMzg2MDg4","name":"nix","full_name":"NixOS/nix","private":false,"owner":{"login":"NixOS","id":487568,"node_id":"MDEyOk9yZ2FuaXphdGlvbjQ4NzU2OA==","avatar_url":"https://avatars.githubusercontent.com/u/487568?v=4","gravatar_id":"","url":"https://api.github.com/users/NixOS","html_url":"https://github.com/NixOS","followers_url":"https://api.github.com/users/NixOS/followers","following_url":"https://api.github.com/users/NixOS/following{/other_user}","gists_url":"https://api.github.com/users/NixOS/gists{/gist_id}","starred_url":"https://api.github.com/users/NixOS/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/NixOS/subscriptions","organizations_url":"https://api.github.com/users/NixOS/orgs","repos_url":"https://api.github.com/users/NixOS/repos","events_url":"https://api.github.com/users/NixOS/events{/privacy}","received_events_url":"https://api.github.com/users/NixOS/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/NixOS/nix","description":"Nix, the purely functional package manager","fork":false,"url":"https://api.github.com/repos/NixOS/nix","forks_url":"https://api.github.com/repos/NixOS/nix/forks","keys_url":"https://api.github.com/repos/NixOS/nix/keys{/key_id}","collaborators_url":"https://api.github.com/repos/NixOS/nix/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/NixOS/nix/teams","hooks_url":"https://api.github.com/repos/NixOS/nix/hooks","issue_events_url":"https://api.github.com/repos/NixOS/nix/issues/events{/number}","events_url":"https://api.github.com/repos/NixOS/nix/events","assignees_url":"https://api.github.com/repos/NixOS/nix/assignees{/user}","branches_url":"https://api.github.com/repos/NixOS/nix/branches{/branch}","tags_url":"https://api.github.com/repos/NixOS/nix/tags","blobs_url":"https://api.github.com/repos/NixOS/nix/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/NixOS/nix/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/NixOS/nix/git/refs{/sha}","trees_url":"https://api.github.com/repos/NixOS/nix/git/trees{/sha}","statuses_url":"https://api.github.com/repos/NixOS/nix/statuses/{sha}","languages_url":"https://api.github.com/repos/NixOS/nix/languages","stargazers_url":"https://api.github.com/repos/NixOS/nix/stargazers","contributors_url":"https://api.github.com/repos/NixOS/nix/contributors","subscribers_url":"https://api.github.com/repos/NixOS/nix/subscribers","subscription_url":"https://api.github.com/repos/NixOS/nix/subscription","commits_url":"https://api.github.com/repos/NixOS/nix/commits{/sha}","git_commits_url":"https://api.github.com/repos/NixOS/nix/git/commits{/sha}","comments_url":"https://api.github.com/repos/NixOS/nix/comments{/number}","issue_comment_url":"https://api.github.com/repos/NixOS/nix/issues/comments{/number}","contents_url":"https://api.github.com/repos/NixOS/nix/contents/{+path}","compare_url":"https://api.github.com/repos/NixOS/nix/compare/{base}...{head}","merges_url":"https://api.github.com/repos/NixOS/nix/merges","archive_url":"https://api.github.com/repos/NixOS/nix/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/NixOS/nix/downloads","issues_url":"https://api.github.com/repos/NixOS/nix/issues{/number}","pulls_url":"https://api.github.com/repos/NixOS/nix/pulls{/number}","milestones_url":"https://api.github.com/repos/NixOS/nix/milestones{/number}","notifications_url":"https://api.github.com/repos/NixOS/nix/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/NixOS/nix/labels{/name}","releases_url":"https://api.github.com/repos/NixOS/nix/releases{/id}","deployments_url":"https://api.github.com/repos/NixOS/nix/deployments","created_at":"2012-02-08T10:17:59Z","updated_at":"2025-11-10T08:02:24Z","pushed_at":"2025-11-10T07:04:17Z","git_url":"git://github.com/NixOS/nix.git","ssh_url":"git@github.com:NixOS/nix.git","clone_url":"https://github.com/NixOS/nix.git","svn_url":"https://github.com/NixOS/nix","homepage":"https://nixos.org/","size":127988,"stargazers_count":15413,"watchers_count":15413,"language":"C++","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":false,"forks_count":1753,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":3783,"license":{"key":"lgpl-2.1","name":"GNU Lesser General Public License v2.1","spdx_id":"LGPL-2.1","url":"https://api.github.com/licenses/lgpl-2.1","node_id":"MDc6TGljZW5zZTEx"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["c-plus-plus","declarative-language","functional-programming","nix","package-manager"],"visibility":"public","forks":1753,"open_issues":3783,"watchers":15413,"default_branch":"master","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"**Describe the bug**\r\n\r\nIn our testing and monitoring at Determinate Systems, we've identified an increase in CURLM_UNRECOVERABLE_POLL errors while substituting. This is especially prevalent when a derivation has a large number of direct dependencies that are all substitutable, where Nix is able to substitute dozens to hundreds of paths at once.\r\n\r\nWe believe this problem is the same identified by https://github.com/curl/curl/issues/14414. This is corroborated by our internal data:\r\n\r\n* We didn't see this issue at all on 2.23.3, which uses curl 8.4.0.\r\n* We do see this issue on 2.24.4, which uses curl 8.7.1.\r\n\r\nThis issue seems to be mitigated by increasing the daemon's NOFILE limit from the Nix default of 1,048,576 to something larger, for example 536,870,912. However, this is not recommended for performance reasons.\r\n\r\nNote: we have primarily observed this on macOS.\r\n\r\n**Steps To Reproduce**\r\n\r\n1. Install a Nix version greater than or equal to 2.24.0\r\n2. Set the NOFILE limit to 1,048,576\r\n3. Evaluate and build a derivation with hundreds of inputs that can all be immediately substituted\r\n4. Observe the error:\r\n\r\n```\r\nunexpected error in download thread: error: unexpected error from curl_multi_wait(): Unrecoverable error in select/poll\r\n```","reactions":{"url":"https://api.github.com/repos/NixOS/nix/issues/11387/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/NixOS/nix/issues/11387/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"}]