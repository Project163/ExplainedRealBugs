{"url":"https://api.github.com/repos/curl/curl/issues/12618","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/12618/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/12618/comments","events_url":"https://api.github.com/repos/curl/curl/issues/12618/events","html_url":"https://github.com/curl/curl/issues/12618","id":2062164697,"node_id":"I_kwDOAAiu0c566iLZ","number":12618,"title":"clang UBSAN issue in 'check_gzip_header()'","user":{"login":"gvanem","id":945271,"node_id":"MDQ6VXNlcjk0NTI3MQ==","avatar_url":"https://avatars.githubusercontent.com/u/945271?v=4","gravatar_id":"","url":"https://api.github.com/users/gvanem","html_url":"https://github.com/gvanem","followers_url":"https://api.github.com/users/gvanem/followers","following_url":"https://api.github.com/users/gvanem/following{/other_user}","gists_url":"https://api.github.com/users/gvanem/gists{/gist_id}","starred_url":"https://api.github.com/users/gvanem/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gvanem/subscriptions","organizations_url":"https://api.github.com/users/gvanem/orgs","repos_url":"https://api.github.com/users/gvanem/repos","events_url":"https://api.github.com/users/gvanem/events{/privacy}","received_events_url":"https://api.github.com/users/gvanem/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2024-01-02T09:42:16Z","updated_at":"2024-01-05T10:17:56Z","closed_at":"2024-01-02T22:28:44Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nThis is not an issue with libcurl per-se. But it seems clang + UBSAN is sensitive to a syntax\r\nlike `enum { a, b, c } func (args) ...` See below.\r\n\r\nBut trying to build libcurl with clang-cl and UBSAN (*\"Undefined Behaviour AddressSanitizer\"*), caused this internal error in\r\nclang while compiling the [**check_gzip_header()**](https://github.com/curl/curl/blob/master/lib/content_encoding.c#L372)function.  Clang report:\r\n```\r\nclang-cl @clang-cl.args -Fo./objects/x64/content_encoding.obj content_encoding.c\r\nPLEASE submit a bug report to https://github.com/llvm/llvm-project/issues/ and include the crash backtrace, \r\npreprocessed source, and associated run script.\r\nStack dump:\r\n0.      Program arguments: f:\\\\ProgramFiler\\\\LLVM-17.0\\\\win64\\\\bin\\\\clang-cl.exe @clang-cl.args -Fo./objects/x64/content_encoding.obj content_encoding.c\r\n1.      <eof> parser at end of file\r\n2.      Per-file LLVM IR generation\r\n3.      content_encoding.c:372:3: Generating code for declaration 'check_gzip_header'\r\nException Code: 0xC0000005\r\n #0 0x00007ff6c0c7dfc7 (F:\\ProgramFiler\\LLVM-17.0\\win64\\bin\\clang-cl.exe+0x155dfc7)\r\n #1 0x00007ff6c223f961 (F:\\ProgramFiler\\LLVM-17.0\\win64\\bin\\clang-cl.exe+0x2b1f961)\r\n...\r\n#33 0x00007ff6c3cbf130 (F:\\ProgramFiler\\LLVM-17.0\\win64\\bin\\clang-cl.exe+0x459f130)\r\n#34 0x00007ff9bca77344 (C:\\Windows\\System32\\KERNEL32.DLL+0x17344)\r\n#35 0x00007ff9bcc226b1 (C:\\Windows\\SYSTEM32\\ntdll.dll+0x526b1)\r\nclang-cl: error: clang frontend command failed due to signal (use -v to see invocation)\r\nclang version 17.0.1\r\nTarget: x86_64-pc-windows-msvc\r\nThread model: posix\r\nInstalledDir: f:\\ProgramFiler\\LLVM-17.0\\win64\\bin\r\nclang-cl: note: diagnostic msg:\r\n********************\r\n\r\nPLEASE ATTACH THE FOLLOWING FILES TO THE BUG REPORT:\r\nPreprocessed source(s) and associated run script(s) are located at:\r\nclang-cl: note: diagnostic msg: c:\\temp\\content_encoding-6786a6.c\r\nclang-cl: note: diagnostic msg: c:\\temp\\content_encoding-6786a6.sh\r\nclang-cl: note: diagnostic msg:\r\n\r\n********************\r\n```\r\n\r\nAttached is `c:\\temp\\content_encoding-6786a6.sh`:  [content_encoding-6786a6.sh.txt](https://github.com/curl/curl/files/13808594/content_encoding-6786a6.sh.txt)\r\n\r\nTrying to understand why, I modified the file into:\r\n```diff\r\n--- a/lib/content_encoding.c 2023-11-13 11:47:41\r\n+++ b/lib/content_encoding.c 2024-01-02 10:33:55\r\n@@ -365,11 +365,13 @@\r\n\r\n #ifdef OLD_ZLIB_SUPPORT\r\n /* Skip over the gzip header */\r\n-static enum {\r\n+typedef enum {\r\n   GZIP_OK,\r\n   GZIP_BAD,\r\n   GZIP_UNDERFLOW\r\n-} check_gzip_header(unsigned char const *data, ssize_t len, ssize_t *headerlen)\r\n+} gzip_status;\r\n+\r\n+static gzip_status check_gzip_header(unsigned char const *data, ssize_t len, ssize_t *headerlen)\r\n {\r\n   int method, flags;\r\n   const ssize_t totallen = len;\r\n```\r\n\r\nall is well. The same is commenting out `#define OLD_ZLIB_SUPPORT 1`.\r\n\r\nNot sure which of flags triggered this *internal-error*. But these were the ASAN/UBSAN flags I used:\r\n```\r\n-fsanitize=address\r\n-fsanitize-recover=address\r\n-fsanitize=undefined\r\n```\r\n\r\n\n\n### I expected the following\n\nA successful compilation of `content_encoding.c`.\n\n### curl/libcurl version\n\nLatest from `git master`\n\n### operating system\n\nWin-10 22H2.","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/12618/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/12618/timeline","performed_via_github_app":null,"state_reason":"completed"}