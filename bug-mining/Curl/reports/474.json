{"url":"https://api.github.com/repos/curl/curl/issues/13351","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/13351/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/13351/comments","events_url":"https://api.github.com/repos/curl/curl/issues/13351/events","html_url":"https://github.com/curl/curl/issues/13351","id":2237999414,"node_id":"I_kwDOAAiu0c6FZSk2","number":13351,"title":"aws-sigv4 failing to calculate the right signature when using \"content-type: multipart/form-data\"","user":{"login":"Viphor","id":14273319,"node_id":"MDQ6VXNlcjE0MjczMzE5","avatar_url":"https://avatars.githubusercontent.com/u/14273319?v=4","gravatar_id":"","url":"https://api.github.com/users/Viphor","html_url":"https://github.com/Viphor","followers_url":"https://api.github.com/users/Viphor/followers","following_url":"https://api.github.com/users/Viphor/following{/other_user}","gists_url":"https://api.github.com/users/Viphor/gists{/gist_id}","starred_url":"https://api.github.com/users/Viphor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Viphor/subscriptions","organizations_url":"https://api.github.com/users/Viphor/orgs","repos_url":"https://api.github.com/users/Viphor/repos","events_url":"https://api.github.com/users/Viphor/events{/privacy}","received_events_url":"https://api.github.com/users/Viphor/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118243,"node_id":"MDU6TGFiZWwxODQxMTgyNDM=","url":"https://api.github.com/repos/curl/curl/labels/HTTP","name":"HTTP","color":"207de5","default":false,"description":null},{"id":352090567,"node_id":"MDU6TGFiZWwzNTIwOTA1Njc=","url":"https://api.github.com/repos/curl/curl/labels/KNOWN_BUGS%20material","name":"KNOWN_BUGS material","color":"d93f0b","default":false,"description":null},{"id":538402904,"node_id":"MDU6TGFiZWw1Mzg0MDI5MDQ=","url":"https://api.github.com/repos/curl/curl/labels/authentication","name":"authentication","color":"e99695","default":false,"description":""},{"id":657824945,"node_id":"MDU6TGFiZWw2NTc4MjQ5NDU=","url":"https://api.github.com/repos/curl/curl/labels/help%20wanted","name":"help wanted","color":"fbca04","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2024-04-11T15:21:57Z","updated_at":"2024-06-03T08:45:46Z","closed_at":"2024-06-03T08:45:45Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\r\n\r\nNOTE: Changing the actual paths and hashes to some redacted values.\r\n\r\n```sh\r\ncurl -vvv -X POST \\\r\n    \"https://my-api-gateway-endpoint.com/my-resource?my_query=param\" \\\r\n    --user \"$AWS_ACCESS_KEY_ID:$AWS_SECRET_ACCESS_KEY\" \\\r\n    --aws-sigv4 \"aws:amz:${AWS_REGION}:execute-api\" \\\r\n    --header \"x-amz-security-token: $AWS_SESSION_TOKEN\" \\\r\n    -H \"accept: application/json\" \\\r\n    -H \"Content-Type: multipart/form-data\" \\\r\n    -F \"content=@${FILE};type=application/x-zip-compressed\" \\\r\n    -F \"extra_metadata=@${JSON_META};type=application/json\"\r\n```\r\n\r\nWhich gave me the following output:\r\n```\r\nNote: Unnecessary use of -X or --request, POST is already inferred.\r\n* Host my-api-gateway-endpoint.com:443 was resolved.\r\n* IPv6: (none)\r\n* IPv4: x.x.x.x, x.x.x.x\r\n*   Trying x.x.x.x:443...\r\n* Connected to my-api-gateway-endpoint.com (x.x.x.x) port 443\r\n* ALPN: curl offers h2,http/1.1\r\n* TLSv1.3 (OUT), TLS handshake, Client hello (1):\r\n* TLSv1.3 (IN), TLS handshake, Server hello (2):\r\n* TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8):\r\n* TLSv1.3 (IN), TLS handshake, Certificate (11):\r\n* TLSv1.3 (IN), TLS handshake, CERT verify (15):\r\n* TLSv1.3 (IN), TLS handshake, Finished (20):\r\n* TLSv1.3 (OUT), TLS change cipher, Change cipher spec (1):\r\n* TLSv1.3 (OUT), TLS handshake, Finished (20):\r\n* SSL connection using TLSv1.3 / TLS_AES_128_GCM_SHA256 / x25519 / RSASSA-PSS\r\n* ALPN: server accepted h2\r\n* Server certificate:\r\n*  subject: CN=my-api-gateway-endpoint.com\r\n*  start date: Apr  4 00:00:00 2024 GMT\r\n*  expire date: May  3 23:59:59 2025 GMT\r\n*  subjectAltName: host \"my-api-gateway-endpoint.com\" matched cert's \"my-api-gateway-endpoint.com\"\r\n*  issuer: C=US; O=Amazon; CN=Amazon RSA 2048 M03\r\n*  SSL certificate verify ok.\r\n*   Certificate level 0: Public key type RSA (2048/112 Bits/secBits), signed using sha256WithRSAEncryption\r\n*   Certificate level 1: Public key type RSA (2048/112 Bits/secBits), signed using sha256WithRSAEncryption\r\n*   Certificate level 2: Public key type RSA (2048/112 Bits/secBits), signed using sha256WithRSAEncryption\r\n* using HTTP/2\r\n* Server auth using AWS_SIGV4 with user 'ASIA*******'\r\n* [HTTP/2] [1] OPENED stream for https://my-api-gateway-endpoint.com/my-resource?my_query=param\r\n* [HTTP/2] [1] [:method: POST]\r\n* [HTTP/2] [1] [:scheme: https]\r\n* [HTTP/2] [1] [:authority: my-api-gateway-endpoint.com]\r\n* [HTTP/2] [1] [:path: /my-resource?my_query=param]\r\n* [HTTP/2] [1] [authorization: AWS4-HMAC-SHA256 Credential=ASIA*******/20240411/eu-central-1/execute-api/aws4_request, SignedHeaders=accept;host;x-amz-date;x-amz-security-token, Signature=2fee53*****]\r\n* [HTTP/2] [1] [x-amz-date: 20240411T130311Z]\r\n* [HTTP/2] [1] [user-agent: curl/8.7.1]\r\n* [HTTP/2] [1] [x-amz-security-token: IQoJb3JpZ********+la3yaTN6lr9AH+3JJCPquZB2VoKT]\r\n* [HTTP/2] [1] [accept: application/json]\r\n* [HTTP/2] [1] [content-length: 655]\r\n* [HTTP/2] [1] [content-type: multipart/form-data; boundary=------------------------GlkWoiCdSW4YuTzdI6B8TJ]\r\n> POST /my-resource?my_query=param HTTP/2\r\n> Host: my-api-gateway-endpoint.com\r\n> Authorization: AWS4-HMAC-SHA256 Credential=ASIA*******/20240411/eu-central-1/execute-api/aws4_request, SignedHeaders=accept;host;x-amz-date;x-amz-security-token, Signature=2fee53******\r\n> X-Amz-Date: 20240411T130311Z\r\n> User-Agent: curl/8.7.1\r\n> x-amz-security-token: IQoJb3JpZ************+oSscHqSd+la3yaTN6lr9AH+3JJCPquZB2VoKT\r\n> accept: application/json\r\n> Content-Length: 655\r\n> Content-Type: multipart/form-data; boundary=------------------------GlkWoiCdSW4YuTzdI6B8TJ\r\n> \r\n* upload completely sent off: 655 bytes\r\n* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):\r\n< HTTP/2 403 \r\n< date: Thu, 11 Apr 2024 13:03:11 GMT\r\n< content-type: application/json\r\n< content-length: 1701\r\n< x-amzn-requestid: 050dbcba-4d82-46df-9c16-5b96fbeeb2b4\r\n< x-amzn-errortype: InvalidSignatureException\r\n< x-amz-apigw-id: WD_****Eaqg=\r\n< \r\n{\"message\":\"The request signature we calculated does not match the signature you provided. Check your AWS Secret Access Key and signing method. Consult the service documentation for details.\\n\\nThe Canonical String for this request should have been\\n'POST\\n/my-resource\\nmy_query=param\\naccept:application/json\\nhost:my-api-gateway-endpoint.com\\nx-amz-date:20240411T130311Z\\nx-amz-security-token:IQoJb3JpZ*******+oSscHqSd+la3yaTN6lr9AH+3JJCPquZB2VoKT\\n\\naccept;host;x-amz-date;x-amz-security-token\\n2fa2cc887bff*******c9d22cce'\\n\\nThe String-to-Sign should have been\\n'AWS4-HMAC-SHA256\\n20240411T130311Z\\n20240411/eu-central-1/execute-api/aws4_request\\n6b6f17fc5e653b********c952640aa3d66'\\n\"}\r\n* Connection #0 to host my-api-gateway-endpoint.com left intact\r\n```\r\n\r\nWhen using the curl command with only a single file and without `Content-Type: multipart/form-data` everything works as expected, but fails to sign properly when given `Content-Type: multipart/form-data`.\r\n\r\n### I expected the following\r\n\r\nI expect for the signing to work and hit the logic behind my endpoint.\r\n\r\n### curl/libcurl version\r\n\r\n```\r\ncurl 8.7.1 (aarch64-apple-darwin23.4.0) libcurl/8.7.1 (SecureTransport) OpenSSL/3.2.1 zlib/1.2.12 brotli/1.1.0 zstd/1.5.6 libidn2/2.3.7 libssh2/1.11.0 nghttp2/1.60.0 librtmp/2.3 OpenLDAP/2.6.7\r\nRelease-Date: 2024-03-27\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps ipfs ipns ldap ldaps mqtt pop3 pop3s rtmp rtsp scp sftp smb smbs smtp smtps telnet tftp\r\nFeatures: alt-svc AsynchDNS brotli GSS-API HSTS HTTP2 HTTPS-proxy IDN IPv6 Kerberos Largefile libz MultiSSL NTLM SPNEGO SSL threadsafe TLS-SRP UnixSockets zstd\r\n```\r\n\r\n### operating system\r\n\r\n```\r\nDarwin M-01619 23.4.0 Darwin Kernel Version 23.4.0: Fri Mar 15 00:12:49 PDT 2024; root:xnu-10063.101.17~1/RELEASE_ARM64_T6020 arm64\r\n```","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/13351/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/13351/timeline","performed_via_github_app":null,"state_reason":"completed"}