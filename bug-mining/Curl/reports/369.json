{"url":"https://api.github.com/repos/curl/curl/issues/10936","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/10936/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/10936/comments","events_url":"https://api.github.com/repos/curl/curl/issues/10936/events","html_url":"https://github.com/curl/curl/issues/10936","id":1663189265,"node_id":"I_kwDOAAiu0c5jIkER","number":10936,"title":"SIGSEGV in on_stream_close() from multi in combination with nghttp2","user":{"login":"egtvedt","id":582486,"node_id":"MDQ6VXNlcjU4MjQ4Ng==","avatar_url":"https://avatars.githubusercontent.com/u/582486?v=4","gravatar_id":"","url":"https://api.github.com/users/egtvedt","html_url":"https://github.com/egtvedt","followers_url":"https://api.github.com/users/egtvedt/followers","following_url":"https://api.github.com/users/egtvedt/following{/other_user}","gists_url":"https://api.github.com/users/egtvedt/gists{/gist_id}","starred_url":"https://api.github.com/users/egtvedt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/egtvedt/subscriptions","organizations_url":"https://api.github.com/users/egtvedt/orgs","repos_url":"https://api.github.com/users/egtvedt/repos","events_url":"https://api.github.com/users/egtvedt/events{/privacy}","received_events_url":"https://api.github.com/users/egtvedt/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118205,"node_id":"MDU6TGFiZWwxODQxMTgyMDU=","url":"https://api.github.com/repos/curl/curl/labels/crash","name":"crash","color":"bfe5bf","default":false,"description":null},{"id":194601710,"node_id":"MDU6TGFiZWwxOTQ2MDE3MTA=","url":"https://api.github.com/repos/curl/curl/labels/HTTP/2","name":"HTTP/2","color":"009800","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":51,"created_at":"2023-04-11T20:44:12Z","updated_at":"2024-01-11T12:20:03Z","closed_at":"2023-12-22T09:06:46Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Trying to upgrade to latest curl releases causes very sporadic crashes for me. I have yet to be able to find a consistent method to reproduce this. It happens on random systems \"in the field\", hence currently hard to analyze from my point of view.\r\n\r\nI am creating this issue in case this corresponds to other observations, or if people with better knowledge of the sources can see where things might go wrong.\r\n\r\nI am happy to apply debug patches or test potentional changes to see if things behave better.\r\n\r\nCurrently I am running curl 7.86.0 release, since all later releases appear to trigger this behavior for me.\r\n\r\n### I did this\r\n\r\ncurl_multi_perform(), and it ended with SIGSEGV in on_stream_close()\r\n\r\n### I got the following backtrace from the crash\r\n\r\n```\r\n#0  0x0000007fa08b58e4 in (/lib/libcurl.so.4.8.0 @ 0x000358e4) on_stream_close + 0x54\r\n#1  0x0000007f9f8fbd74 in (/lib/libnghttp2.so.14.24.1 @ 0x0000bd74) nghttp2_session_close_stream + 0x84\r\n#2  0x0000007f9f900490 in (/lib/libnghttp2.so.14.24.1 @ 0x00010490) nghttp2_session_mem_send_internal + 0x730\r\n#3  0x0000007f9f9010a8 in (/lib/libnghttp2.so.14.24.1 @ 0x000110a8) nghttp2_session_send + 0x78\r\n#4  0x0000007fa08b5bbc in (/lib/libcurl.so.4.8.0 @ 0x00035bbc) h2_session_send + 0xbc\r\n#5  0x0000007fa08b6c30 in (/lib/libcurl.so.4.8.0 @ 0x00036c30) cf_h2_send + 0x90\r\n#6  0x0000007fa08ce1f4 in (/lib/libcurl.so.4.8.0 @ 0x0004e1f4) Curl_write + 0x54\r\n#7  0x0000007fa08dd9c8 in (/lib/libcurl.so.4.8.0 @ 0x0005d9c8) Curl_readwrite + 0x538\r\n#8  0x0000007fa08c62dc in (/lib/libcurl.so.4.8.0 @ 0x000462dc) multi_runsingle + 0x37c\r\n#9  0x0000007fa08c7a88 in (/lib/libcurl.so.4.8.0 @ 0x00047a88) curl_multi_perform + 0xf8\r\n```\r\n\r\nLooking into the on_stream_close() function at offset 0x54, I suspect this corresponds to the code:\r\n```\r\nstream = data_s->req.p.http;\r\n```\r\n\r\n### curl/libcurl version\r\n\r\n```\r\ncurl 8.0.1-DEV (aarch64-unknown-linux-gnu) libcurl/8.0.1-DEV OpenSSL/1.1.1t-fips zlib/1.2.13 c-ares/1.19.0 nghttp2/1.52.0\r\nRelease-Date: [unreleased]\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps mqtt pop3 pop3s rtsp smb smbs smtp smtps telnet tftp\r\nFeatures: alt-svc AsynchDNS HSTS HTTP2 HTTPS-proxy IPv6 Largefile libz NTLM NTLM_WB SSL threadsafe TLS-SRP UnixSockets\r\n```\r\n\r\n### operating system\r\n\r\nLinux 4.9.337 based embedded system, aarch64 GNU/Linux. Toolchain based upon GCC 11.3.0.","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/10936/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/10936/timeline","performed_via_github_app":null,"state_reason":"completed"}