{"url":"https://api.github.com/repos/curl/curl/issues/14899","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/14899/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/14899/comments","events_url":"https://api.github.com/repos/curl/curl/issues/14899/events","html_url":"https://github.com/curl/curl/issues/14899","id":2525121254,"node_id":"I_kwDOAAiu0c6Wgkrm","number":14899,"title":"HTTP --max-filesize counts ignored body data","user":{"login":"jay","id":965580,"node_id":"MDQ6VXNlcjk2NTU4MA==","avatar_url":"https://avatars.githubusercontent.com/u/965580?v=4","gravatar_id":"","url":"https://api.github.com/users/jay","html_url":"https://github.com/jay","followers_url":"https://api.github.com/users/jay/followers","following_url":"https://api.github.com/users/jay/following{/other_user}","gists_url":"https://api.github.com/users/jay/gists{/gist_id}","starred_url":"https://api.github.com/users/jay/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jay/subscriptions","organizations_url":"https://api.github.com/users/jay/orgs","repos_url":"https://api.github.com/users/jay/repos","events_url":"https://api.github.com/users/jay/events{/privacy}","received_events_url":"https://api.github.com/users/jay/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118243,"node_id":"MDU6TGFiZWwxODQxMTgyNDM=","url":"https://api.github.com/repos/curl/curl/labels/HTTP","name":"HTTP","color":"207de5","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2024-09-13T15:34:50Z","updated_at":"2025-09-26T04:45:13Z","closed_at":"2024-09-14T20:52:53Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"From https://github.com/curl/curl/issues/14440#issuecomment-2346734573 user @MasterInQuestion reports that --max-filesize is applied to the ignored content of a redirect response. For example `curl -v -L --max-filesize 1 http://localhost:8080` and the server's redirect reply has 5 content bytes:\r\n\r\n~~~\r\nwhile true; \\\r\ndo perl -e 'print (\"HTTP/1.1 301\\r\\nContent-Length: 5\\r\\nLocation: http://localhost:8080/abc\\r\\n\\r\\napple\")' | nc -4l localhost 8080; \\\r\ndone\r\n~~~\r\n\r\ncurl will fail because 5 bytes of content (even though it's ignored) is more than 1:\r\n\r\n~~~\r\n* STATE: DO => DID handle 0x76bd88; line 2164\r\n* STATE: DID => PERFORMING handle 0x76bd88; line 2282\r\n< HTTP/1.1 301\r\n< Content-Length: 5\r\n< Location: http://localhost:8080/abc\r\n* Maximum file size exceeded\r\n~~~\r\n\r\nThe failure is caused by a check in `Curl_http_size` which AFAICT compares even for body bytes that are not \"real\" so to speak:\r\n\r\nhttps://github.com/curl/curl/blob/a3bd1dda12ec79cd63e0d81df4ec4b1fbbbcfa1b/lib/http.c#L3273-L3294\r\n\r\nThere is a separate check that is done in `cw_download_write` which deals with real body bytes, however by that point the download is already taking place.\r\n\r\nhttps://github.com/curl/curl/blob/a3bd1dda12ec79cd63e0d81df4ec4b1fbbbcfa1b/lib/sendf.c#L326-L344\r\n\r\nIn other words, the former check causes curl to error immediately after the headers are received and the content length is known. The user may want this behavior because if they, say, limit to 1MB then maybe they don't want to download the first 1MB of a 100MB file. OTOH it seems that cw_download_write works in exactly that way, it will allow downloading to the maximum file size.\r\n\r\nSo if the former check is removed, which is my initial inclination, there will be a change in behavior.","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/14899/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/14899/timeline","performed_via_github_app":null,"state_reason":"completed"}