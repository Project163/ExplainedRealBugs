{"url":"https://api.github.com/repos/curl/curl/issues/18216","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/18216/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/18216/comments","events_url":"https://api.github.com/repos/curl/curl/issues/18216/events","html_url":"https://github.com/curl/curl/issues/18216","id":3299471848,"node_id":"I_kwDOAAiu0c7EqfHo","number":18216,"title":"CURL is stuck in invalid state after DNS resolution failure","user":{"login":"devgs","id":1633661,"node_id":"MDQ6VXNlcjE2MzM2NjE=","avatar_url":"https://avatars.githubusercontent.com/u/1633661?v=4","gravatar_id":"","url":"https://api.github.com/users/devgs","html_url":"https://github.com/devgs","followers_url":"https://api.github.com/users/devgs/followers","following_url":"https://api.github.com/users/devgs/following{/other_user}","gists_url":"https://api.github.com/users/devgs/gists{/gist_id}","starred_url":"https://api.github.com/users/devgs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/devgs/subscriptions","organizations_url":"https://api.github.com/users/devgs/orgs","repos_url":"https://api.github.com/users/devgs/repos","events_url":"https://api.github.com/users/devgs/events{/privacy}","received_events_url":"https://api.github.com/users/devgs/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":5,"created_at":"2025-08-07T08:07:31Z","updated_at":"2025-08-07T09:36:25Z","closed_at":"2025-08-07T09:36:25Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nThere seems to be some broken state in `CURL` handle. To enter this state the request must fail in DNS resolution. Specifically in our case the DNS server goes down and doesn't respond for some time.\n\nIn older versions of cURL the subsequent attempt to reuse handle (keep-alive) in this broken state immediately (no delays) leads to an `CURLE_BAD_FUNCTION_ARGUMENT` error. The only option is to just drop this state, because the `curl_easy_reset()` doesn't have any effect.\n\nIn the most recent version (and several earlier versions that I checked, as well) behavior is a bit different. Request fails with timeout in DNS but then all subsequent requests to the same `CURL` handle, again hang for a duration of configured timeout value and then fail with `CURLE_OPERATION_TIMEDOUT`. As in older versions, `curl_easy_reset()` has no effect and the only option is to discard such `CURL` handle.\n\nI've tracked down the issue to `ares`. It seems that after the original failure on timeout and call to `ares_cancel()` the ares channel itself stays in an invalid state. Seems that its internal socket is still open but isn't operable. On call to `Curl_ares_getsock()` we get its file descriptor and a request to poll it to become readable. But it never does and we basically always wait until the timeout is exhausted.\n\nIt seems that in this specific case, when DNS resolution is timed out, the ares channel must be closed, at least in `curl_easy_reset()`. Otherwise we may end up with a permanently broken state.\n\n### I expected the following\n\nI expect `CURL` handle to not become broken.\n\n### curl/libcurl version\n\ncurl 8.5.0\ncurl 8.14.1\ncurl 8.15.0\n\n### operating system\n\nFreeBSD 14.0\nFreeBSD 14.2","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/18216/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/18216/timeline","performed_via_github_app":null,"state_reason":"completed"}