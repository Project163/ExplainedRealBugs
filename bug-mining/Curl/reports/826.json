{"url":"https://api.github.com/repos/curl/curl/issues/19227","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/19227/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/19227/comments","events_url":"https://api.github.com/repos/curl/curl/issues/19227/events","html_url":"https://github.com/curl/curl/issues/19227","id":3550778164,"node_id":"I_kwDOAAiu0c7TpJM0","number":19227,"title":"Header-name length mismatch","user":{"login":"MegaManSec","id":2505339,"node_id":"MDQ6VXNlcjI1MDUzMzk=","avatar_url":"https://avatars.githubusercontent.com/u/2505339?v=4","gravatar_id":"","url":"https://api.github.com/users/MegaManSec","html_url":"https://github.com/MegaManSec","followers_url":"https://api.github.com/users/MegaManSec/followers","following_url":"https://api.github.com/users/MegaManSec/following{/other_user}","gists_url":"https://api.github.com/users/MegaManSec/gists{/gist_id}","starred_url":"https://api.github.com/users/MegaManSec/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MegaManSec/subscriptions","organizations_url":"https://api.github.com/users/MegaManSec/orgs","repos_url":"https://api.github.com/users/MegaManSec/repos","events_url":"https://api.github.com/users/MegaManSec/events{/privacy}","received_events_url":"https://api.github.com/users/MegaManSec/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":370011580,"node_id":"MDU6TGFiZWwzNzAwMTE1ODA=","url":"https://api.github.com/repos/curl/curl/labels/connecting%20&%20proxies","name":"connecting & proxies","color":"c2e0c6","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":1,"created_at":"2025-10-24T19:36:13Z","updated_at":"2025-10-27T08:52:17Z","closed_at":"2025-10-27T08:52:17Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nIn `lib/http_proxy.c`, an incorrect comparison makes a header comparison fail.\n\nThis is the description from ZeroPath:\n\n>dynhds_add_custom parses header names by locating ':' and computing namelen as the number of characters before the colon (namelen excludes the colon). Later the code checks for Authorization: and Cookie: using hd_name_eq(name, namelen, STRCONST(\"Authorization:\")) / STRCONST(\"Cookie:\"). hd_name_eq first requires the two lengths to be equal before performing a case-insensitive compare. Because the constant includes the colon in its length but namelen excludes it, the length comparison fails and the intended suppression branch is skipped.\n\nIt can be confirmed with the following patch:\n\n```diff\ndiff --git a/lib/http_proxy.c b/lib/http_proxy.c\nindex 845ba2e8f..5ccd656bf 100644\n--- a/lib/http_proxy.c\n+++ b/lib/http_proxy.c\n@@ -54,6 +54,19 @@ static bool hd_name_eq(const char *n1, size_t n1len,\n   return (n1len == n2len) ? curl_strnequal(n1, n2, n1len) : FALSE;\n }\n \n+/* DEBUG helper: show what we are comparing.\n+   Only useful with -v since infof prints in verbose mode. */\n+static void debug_hdrcmp(struct Curl_easy *data,\n+                         const char *name, size_t namelen,\n+                         const char *label,\n+                         const char *cstr, size_t clen)\n+{\n+  infof(data,\n+        \"DEBUG hdrcmp %-18s name='%.*s' len=%zu  const='%s' len=%zu  => %s\",\n+        label, (int)namelen, name, namelen, cstr, clen,\n+        hd_name_eq(name, namelen, cstr, clen) ? \"MATCH\" : \"NO MATCH\");\n+}\n+\n static CURLcode dynhds_add_custom(struct Curl_easy *data,\n                                   bool is_connect, int httpversion,\n                                   struct dynhds *hds)\n@@ -143,6 +156,21 @@ static CURLcode dynhds_add_custom(struct Curl_easy *data,\n       }\n \n       DEBUGASSERT(name && value);\n+      /* Show comparisons so we can see why branches are or are not taken. */\n+      if(data->set.verbose) {\n+        debug_hdrcmp(data, name, namelen, \"Host:\",\n+                     STRCONST(\"Host:\"));\n+        debug_hdrcmp(data, name, namelen, \"Content-Type:\",\n+                     STRCONST(\"Content-Type:\"));\n+        debug_hdrcmp(data, name, namelen, \"Content-Length:\",\n+                     STRCONST(\"Content-Length:\"));\n+        debug_hdrcmp(data, name, namelen, \"Transfer-Encoding:\",\n+                     STRCONST(\"Transfer-Encoding:\"));\n+        debug_hdrcmp(data, name, namelen, \"Authorization:\",\n+                     STRCONST(\"Authorization:\"));\n+        debug_hdrcmp(data, name, namelen, \"Cookie:\",\n+                     STRCONST(\"Cookie:\"));\n+      }\n       if(data->state.aptr.host &&\n          /* a Host: header was sent already, do not pass on any custom Host:\n             header as that will produce *two* in the same request! */\n\n```\n\n...\n\n```\n$ ./src/curl -vkL --http1.1   --proxy http://127.0.0.1:8080   https://a.test:4443/   --resolve a.test:4443:127.0.0.1   --resolve b.test:4444:127.0.0.1   --cacert cert.pem   --proxy-header 'Authorization: Bearer LEAK'   --proxy-header 'Cookie: a=1'\n* Added a.test:4443:127.0.0.1 to DNS cache\n* Added b.test:4444:127.0.0.1 to DNS cache\n*   Trying 127.0.0.1:8080...\n* CONNECT: no ALPN negotiated\n* allocate connect buffer\n* DEBUG hdrcmp Host:              name='Authorization' len=13  const='Host:' len=5  => NO MATCH\n* DEBUG hdrcmp Content-Type:      name='Authorization' len=13  const='Content-Type:' len=13  => NO MATCH\n* DEBUG hdrcmp Content-Length:    name='Authorization' len=13  const='Content-Length:' len=15  => NO MATCH\n* DEBUG hdrcmp Transfer-Encoding: name='Authorization' len=13  const='Transfer-Encoding:' len=18  => NO MATCH\n* DEBUG hdrcmp Authorization:     name='Authorization' len=13  const='Authorization:' len=14  => NO MATCH\n* DEBUG hdrcmp Cookie:            name='Authorization' len=13  const='Cookie:' len=7  => NO MATCH\n* DEBUG hdrcmp Host:              name='Cookie' len=6  const='Host:' len=5  => NO MATCH\n* DEBUG hdrcmp Content-Type:      name='Cookie' len=6  const='Content-Type:' len=13  => NO MATCH\n* DEBUG hdrcmp Content-Length:    name='Cookie' len=6  const='Content-Length:' len=15  => NO MATCH\n* DEBUG hdrcmp Transfer-Encoding: name='Cookie' len=6  const='Transfer-Encoding:' len=18  => NO MATCH\n* DEBUG hdrcmp Authorization:     name='Cookie' len=6  const='Authorization:' len=14  => NO MATCH\n* DEBUG hdrcmp Cookie:            name='Cookie' len=6  const='Cookie:' len=7  => NO MATCH\n```\n\nNote the extra `:` in the latter part of the lines.\n\nThis bug was found with ZeroPath.\n\n### I expected the following\n\n_No response_\n\n### curl/libcurl version\n\nmost recent\n\n### operating system\n\nall","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/19227/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/19227/timeline","performed_via_github_app":null,"state_reason":"completed"}