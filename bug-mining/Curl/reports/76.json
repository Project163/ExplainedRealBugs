{"url":"https://api.github.com/repos/curl/curl/issues/9513","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/9513/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/9513/comments","events_url":"https://api.github.com/repos/curl/curl/issues/9513/events","html_url":"https://github.com/curl/curl/issues/9513","id":1374851097,"node_id":"I_kwDOAAiu0c5R8pAZ","number":9513,"title":"no access to HTTP CONNECT proxy error response body content","user":{"login":"aathan","id":24279435,"node_id":"MDQ6VXNlcjI0Mjc5NDM1","avatar_url":"https://avatars.githubusercontent.com/u/24279435?v=4","gravatar_id":"","url":"https://api.github.com/users/aathan","html_url":"https://github.com/aathan","followers_url":"https://api.github.com/users/aathan/followers","following_url":"https://api.github.com/users/aathan/following{/other_user}","gists_url":"https://api.github.com/users/aathan/gists{/gist_id}","starred_url":"https://api.github.com/users/aathan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aathan/subscriptions","organizations_url":"https://api.github.com/users/aathan/orgs","repos_url":"https://api.github.com/users/aathan/repos","events_url":"https://api.github.com/users/aathan/events{/privacy}","received_events_url":"https://api.github.com/users/aathan/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118243,"node_id":"MDU6TGFiZWwxODQxMTgyNDM=","url":"https://api.github.com/repos/curl/curl/labels/HTTP","name":"HTTP","color":"207de5","default":false,"description":null},{"id":228248612,"node_id":"MDU6TGFiZWwyMjgyNDg2MTI=","url":"https://api.github.com/repos/curl/curl/labels/enhancement","name":"enhancement","color":"FCFD96","default":true,"description":null},{"id":370011580,"node_id":"MDU6TGFiZWwzNzAwMTE1ODA=","url":"https://api.github.com/repos/curl/curl/labels/connecting%20&%20proxies","name":"connecting & proxies","color":"c2e0c6","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":18,"created_at":"2022-09-15T17:21:06Z","updated_at":"2022-10-11T09:04:32Z","closed_at":"2022-09-23T21:31:33Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\r\n\r\nSee https://github.com/curl/curl/discussions/9508, the first part of which I quote here for convenience:\r\n\r\nI have proxy that returns a 503 with application/json content:\r\n```\r\n$ curl -o - -I -x 'http://x:y@localhost:1234' https://ipinfo.io/ip\r\nHTTP/1.1 503 Service Unavailable\r\nContent-Type: application/problem+json\r\nDate: Thu, 15 Sep 2022 00:22:02 GMT\r\nContent-Length: 214\r\n```\r\n\r\nHowever, curl does not show the content returned with the error. Is that a bug or some aspect of the HTTP spec that states such content should be ignored?\r\n\r\n```\r\n$ tcpdump -Ai lo port 1234\r\n...\r\nHTTP/1.1 503 Service Unavailable\r\nContent-Type: application/problem+json\r\nDate: Thu, 15 Sep 2022 00:22:02 GMT\r\nContent-Length: 214\r\n\r\n{\"type\":\"https://xxx.com/problems/xxx-no-clients\",\"title\":\"xxx\",\"status\":503,\"detail\":\"xxx\"}\r\n```\r\n\r\n... the content is definitely returned to curl...\r\n\r\nCurl reports:\r\n\r\n```\r\nerror code 56, \"Received HTTP code 500 from proxy after CONNECT\"\r\n```\r\n\r\n\r\n### I expected the following\r\n\r\nSo, this \"error code 56\" is apparently not an *HTTP* error code because (1) HTTP error codes are defined as 3 digits and (2) I cannot find any reference to HTTP error code 56 (including at https://en.wikipedia.org/wiki/List_of_HTTP_status_codes, https://en.wikipedia.org/wiki/List_of_HTTP_status_codes, or https://datatracker.ietf.org/doc/html/rfc7231#section-6).\r\n\r\nIn usr/include/asm-generic/errno.h we have:\r\n\r\n```\r\n#define EBADRQC         56      /* Invalid request code */\r\n```\r\n\r\nI do see that Chrome takes a similar approach to reporting a proxy error.\r\n\r\nThus, while I do understand the point made by @dfandrich, by that logic, neither is the 503 \"what the transfer is about\" yet it is in fact reported by curl (even if encapsulated by the message into an error code 56). The 503 error and its associated headers is what's actually returned by proxies in the HTTP envelope, as proven by tcpdump and (importantly) emitted by -I output. I.e., -I  shows the headers of the proxy connection not the content connection.\r\n\r\nIt seems the standard leaves open the possibility for proxies to return content together with an error response; and curl does pass through the 503 headers with -I. Therefore, the issue may be as much about what facilities curl *wants* to provide as what the standard says. I suspect it may be silent on this point, but I have not chased that down.\r\n\r\nEven though the 503 is \"not what the transfer is about\", it's relevant to the transfer that was requested and I would argue curl should provide a mechanism to pass that content through. Ultimately, the fact is that proxies \"can\" return data with a proxy sourced error (\"can\" as in it's provably technically feasible and does occur in the wild, per google searches). That being said, I did not chase down the full spec on HTTP CONNECT to see if there may be a \"MAY NOT\" statement about body content (but I doubt it).\r\n\r\nThat being said, if I'm not mistaken, the spec at https://datatracker.ietf.org/doc/html/rfc7231 clearly shows that content may be returned in any HTTP response bearing any status code, including 503.\r\n\r\nTherefore, I would argue that it is appropriate to pass through the body even for errors generated by a proxy or, failing that, that there should be a mechanism for retrieving that content (an additional flag? inclusion in -w %{json}? etc) and/or reporting of that content (or at the very least, that the content exists) in the same message that says \"error code 56\"\r\n\r\nThe current behavior can be rather frustrating, when you see that the content-length !=0, yet there's no apparent content, and the only way to see it is via tcpdump.\r\n\r\n\r\n### curl/libcurl version\r\n\r\n```\r\ncurl 7.81.0 (x86_64-pc-linux-gnu) libcurl/7.81.0 OpenSSL/3.0.2 zlib/1.2.11 brotli/1.0.9 zstd/1.4.8 libidn2/2.3.2 libpsl/0.21.0 (+libidn2/2.3.2) libssh/0.9.6/openssl/zlib nghttp2/1.43.0 librtmp/2.3 OpenLDAP/2.5.12\r\nRelease-Date: 2022-01-05\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps ldap ldaps mqtt pop3 pop3s rtmp rtsp scp sftp smb smbs smtp smtps telnet tftp\r\nFeatures: alt-svc AsynchDNS brotli GSS-API HSTS HTTP2 HTTPS-proxy IDN IPv6 Kerberos Largefile libz NTLM NTLM_WB PSL SPNEGO SSL TLS-SRP UnixSockets zstd\r\n```\r\n\r\n### operating system\r\nall\r\n\r\n","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/9513/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/9513/timeline","performed_via_github_app":null,"state_reason":"completed"}