{"url":"https://api.github.com/repos/curl/curl/issues/15547","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/15547/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/15547/comments","events_url":"https://api.github.com/repos/curl/curl/issues/15547/events","html_url":"https://github.com/curl/curl/issues/15547","id":2649376589,"node_id":"I_kwDOAAiu0c6d6kdN","number":15547,"title":"mk-ca-bundle.pl does not handle CKA_NSS_SERVER_DISTRUST_AFTER properly","user":{"login":"AGWA","id":321605,"node_id":"MDQ6VXNlcjMyMTYwNQ==","avatar_url":"https://avatars.githubusercontent.com/u/321605?v=4","gravatar_id":"","url":"https://api.github.com/users/AGWA","html_url":"https://github.com/AGWA","followers_url":"https://api.github.com/users/AGWA/followers","following_url":"https://api.github.com/users/AGWA/following{/other_user}","gists_url":"https://api.github.com/users/AGWA/gists{/gist_id}","starred_url":"https://api.github.com/users/AGWA/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AGWA/subscriptions","organizations_url":"https://api.github.com/users/AGWA/orgs","repos_url":"https://api.github.com/users/AGWA/repos","events_url":"https://api.github.com/users/AGWA/events{/privacy}","received_events_url":"https://api.github.com/users/AGWA/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118221,"node_id":"MDU6TGFiZWwxODQxMTgyMjE=","url":"https://api.github.com/repos/curl/curl/labels/TLS","name":"TLS","color":"bfdadc","default":false,"description":""},{"id":3405978577,"node_id":"LA_kwDOAAiu0c7LAxvR","url":"https://api.github.com/repos/curl/curl/labels/script","name":"script","color":"379DD5","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":4,"created_at":"2024-11-11T13:38:03Z","updated_at":"2025-02-08T14:10:42Z","closed_at":"2024-11-12T07:35:02Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\n_No response_\n\n### I expected the following\n\nWhen parsing certdata.txt, mk-ca-bundle.pl excludes roots whose `CKA_NSS_SERVER_DISTRUST_AFTER` time is [after the current time](https://github.com/curl/curl/blob/8b76a8aeb21c8ae2261147af1bddd0d4637c252c/scripts/mk-ca-bundle.pl#L586).\r\n\r\nThis is incorrect behavior. `CKA_NSS_SERVER_DISTRUST_AFTER` is supposed to be compared against the leaf certificate's NotBefore time, not the current time:\r\n\r\n> If a builtin certificate has a CKA_NSS_SERVER_DISTRUST_AFTER timestamp before the SCT or NotBefore date of a certificate that builtin issued, then clients can elect not to trust it.\r\n\r\n[Source](https://nss-crypto.org/reference/security/nss/legacy/nss_releases/nss_3.53_release_notes/index.html)\r\n\r\nSee also https://bugzilla.mozilla.org/show_bug.cgi?id=1618404 and https://bugzilla.mozilla.org/show_bug.cgi?id=1621159\r\n\r\n[Mozilla intends](https://groups.google.com/a/mozilla.org/g/dev-security-policy/c/jCvkhBjg9Yw/m/dzO2v1AtAQAJ) to set the `CKA_NSS_SERVER_DISTRUST_AFTER` date of Entrust roots to November 30, 2024. mk-ca-bundle.pl's current behavior will cause consumers of mk-ca-bundle.pl to reject Entrust certificates that Firefox would have accepted, causing breakage that Mozilla did not intend.\r\n\r\nInstead, mk-ca-bundle.pl should just ignore the `CKA_NSS_SERVER_DISTRUST_AFTER` date.  Although this would cause consumers of mk-ca-bundle.pl to accept certificates that Firefox would have rejected, in practice this is not any less secure than Firefox.  This is because roots with a `CKA_NSS_SERVER_DISTRUST_AFTER` date still have the ability to issue new certificates that are accepted by Firefox, by simply backdating the certificate's NotBefore date.  The point of `CKA_NSS_SERVER_DISTRUST_AFTER` is not to provide security from an untrustworthy root, but to [gracefully sunset trust in a root](https://medium.com/@sleevi_/path-building-vs-path-verifying-the-chain-of-pain-9fbab861d7d6#2bf8).  When Mozilla adds `CKA_NSS_SERVER_DISTRUST_AFTER` to a root, they're not saying that certificates issued after that date are untrustworthy.  Instead, they are saying that they would like to remove the root at some point in the future.  Combined with enforcement of the 398 day maximum certificate lifetime, `CKA_NSS_SERVER_DISTRUST_AFTER` ensures that all certificates issued by a root are expired 398 days after the `CKA_NSS_SERVER_DISTRUST_AFTER` date, allowing for the root's removal without breakage. Consequentially, it is appropriate for mk-ca-bundle.pl to ignore `CKA_NSS_SERVER_DISTRUST_AFTER` and wait for Mozilla to fully remove the root.\n\n### curl/libcurl version\n\nN/A\n\n### operating system\n\nN/A","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/15547/reactions","total_count":2,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":2,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/15547/timeline","performed_via_github_app":null,"state_reason":"completed"}