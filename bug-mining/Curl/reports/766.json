{"url":"https://api.github.com/repos/curl/curl/issues/17225","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/17225/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/17225/comments","events_url":"https://api.github.com/repos/curl/curl/issues/17225/events","html_url":"https://github.com/curl/curl/issues/17225","id":3027942671,"node_id":"I_kwDOAAiu0c60er0P","number":17225,"title":"connection reuse lead to continuous timout after network changed","user":{"login":"Cering","id":9027486,"node_id":"MDQ6VXNlcjkwMjc0ODY=","avatar_url":"https://avatars.githubusercontent.com/u/9027486?v=4","gravatar_id":"","url":"https://api.github.com/users/Cering","html_url":"https://github.com/Cering","followers_url":"https://api.github.com/users/Cering/followers","following_url":"https://api.github.com/users/Cering/following{/other_user}","gists_url":"https://api.github.com/users/Cering/gists{/gist_id}","starred_url":"https://api.github.com/users/Cering/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Cering/subscriptions","organizations_url":"https://api.github.com/users/Cering/orgs","repos_url":"https://api.github.com/users/Cering/repos","events_url":"https://api.github.com/users/Cering/events{/privacy}","received_events_url":"https://api.github.com/users/Cering/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184239806,"node_id":"MDU6TGFiZWwxODQyMzk4MDY=","url":"https://api.github.com/repos/curl/curl/labels/known-issue","name":"known-issue","color":"eb6420","default":false,"description":null},{"id":370011580,"node_id":"MDU6TGFiZWwzNzAwMTE1ODA=","url":"https://api.github.com/repos/curl/curl/labels/connecting%20&%20proxies","name":"connecting & proxies","color":"c2e0c6","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2025-04-29T11:16:43Z","updated_at":"2025-07-29T09:18:57Z","closed_at":"2025-07-29T09:18:57Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\n- Hello, I found a continuous timout error in my iphone, when its network from wifi change to cellular, the reproduce steps is:\n\n1. send https request(https://msg.qy.net) in wifi network, it succeed and will keep in the connection pool\n```\n2025-04-29 17:41:38.173   STATE: INIT => CONNECT handle 0x12256f008; line 1940 (connection #-5000)\n2025-04-29 17:41:38.173   Added connection 8. The cache now contains 5 members\n2025-04-29 17:41:38.176   STATE: CONNECT => RESOLVING handle 0x12256f008; line 1986 (connection #8)\n2025-04-29 17:41:38.201   STATE: RESOLVING => CONNECTING handle 0x12256f008; line 2060 (connection #8)\n2025-04-29 17:41:38.217   Connected to msg.qy.net (111.202.15.31) port 443 (#8)\n2025-04-29 17:41:38.217   ALPN: offers h2,http/1.1\n2025-04-29 17:41:38.217   [CONN-8] Didn't find Session ID in cache for host HTTPS://msg.qy.net:443\n2025-04-29 17:41:38.217   TLSv1.3 (OUT), TLS handshake, Client hello (1):\n2025-04-29 17:41:38.289   TLSv1.3 (IN), TLS handshake, Server hello (2):\n2025-04-29 17:41:38.290   TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8):\n2025-04-29 17:41:38.290   TLSv1.3 (IN), TLS handshake, Certificate (11):\n2025-04-29 17:41:38.290   TLSv1.3 (IN), TLS handshake, CERT verify (15):\n2025-04-29 17:41:38.292   TLSv1.3 (IN), TLS handshake, Finished (20):\n2025-04-29 17:41:38.292   TLSv1.3 (OUT), TLS change cipher, Change cipher spec (1):\n2025-04-29 17:41:38.292   TLSv1.3 (OUT), TLS handshake, Finished (20):\n2025-04-29 17:41:38.292   SSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384\n2025-04-29 17:41:38.292   ALPN: server accepted h2\n2025-04-29 17:41:38.292   Server certificate:\n2025-04-29 17:41:38.292   using HTTP/2\n2025-04-29 17:41:38.292   STATE: CONNECTING => PROTOCONNECT handle 0x12256f008; line 2104 (connection #8)\n2025-04-29 17:41:38.292   multi changed, check CONNECT_PEND queue\n2025-04-29 17:41:38.292   STATE: PROTOCONNECT => DO handle 0x12256f008; line 2134 (connection #8)\n2025-04-29 17:41:38.292   Using Stream ID: 1 (easy handle 0x12256f008)\n2025-04-29 17:41:38.293   STATE: DO => DID handle 0x12256f008; line 2230 (connection #8)\n2025-04-29 17:41:38.293   STATE: DID => PERFORMING handle 0x12256f008; line 2349 (connection #8)\n2025-04-29 17:41:38.339   TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):\n2025-04-29 17:41:38.339   [CONN-8] Didn't find Session ID in cache for host HTTPS://msg.qy.net:443\n2025-04-29 17:41:38.339   [CONN-8] Added Session ID to cache for HTTPS://msg.qy.net:443 [server]\n2025-04-29 17:41:38.339   TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):\n2025-04-29 17:41:38.339   [CONN-8] Found Session ID in cache for host HTTPS://msg.qy.net:443\n2025-04-29 17:41:38.339   old SSL session ID is stale, removing\n2025-04-29 17:41:38.339   [CONN-8] Added Session ID to cache for HTTPS://msg.qy.net:443 [server]\n2025-04-29 17:41:38.340   HTTP/2 found, allow multiplexing\n2025-04-29 17:41:38.380   multi changed, check CONNECT_PEND queue\n2025-04-29 17:41:38.380   Curl_readwrite: forcibly told to drain data\n2025-04-29 17:41:38.380   STATE: PERFORMING => DONE handle 0x12256f008; line 2548 (connection #8)\n2025-04-29 17:41:38.380   multi_done: status: 0 prem: 0 done: 0\n2025-04-29 17:41:38.380   Connection #8 to host msg.qy.net left intact\n2025-04-29 17:41:38.380   Expire cleared (transfer 0x12256f008)\n```\n\n2. send another same request in wifi network, the connection is reused(multiplexing) and still ok\n```\n2025-04-29 17:41:40.492   STATE: INIT => CONNECT handle 0x155790808; line 1940 (connection #-5000)\n2025-04-29 17:41:40.492   Found bundle for host: 0x302439888 [can multiplex]\n2025-04-29 17:41:40.492   Re-using existing connection #8 with host msg.qy.net\n2025-04-29 17:41:40.493   STATE: CONNECT => CONNECTING handle 0x155790808; line 1996 (connection #8)\n2025-04-29 17:41:40.493   STATE: CONNECTING => PROTOCONNECT handle 0x155790808; line 2104 (connection #8)\n2025-04-29 17:41:40.493   STATE: PROTOCONNECT => DO handle 0x155790808; line 2123 (connection #8)\n2025-04-29 17:41:40.493   Using Stream ID: 3 (easy handle 0x155790808)\n2025-04-29 17:41:40.493   STATE: DO => DID handle 0x155790808; line 2230 (connection #8)\n2025-04-29 17:41:40.493   STATE: DID => PERFORMING handle 0x155790808; line 2349 (connection #8)\n2025-04-29 17:41:40.493   We are completely uploaded and fine\n2025-04-29 17:41:40.511   HTTP/2 found, allow multiplexing\n2025-04-29 17:41:40.511   Curl_readwrite: forcibly told to drain data\n2025-04-29 17:41:40.511   STATE: PERFORMING => DONE handle 0x155790808; line 2548 (connection #8)\n2025-04-29 17:41:40.511   multi_done: status: 0 prem: 0 done: 0\n2025-04-29 17:41:40.511   Connection #8 to host msg.qy.net left intact\n2025-04-29 17:41:40.512   Expire cleared (transfer 0x155790808)\n```\n\n3. in 2025-04-29 17:42:39.423, I close the phone's wifi netowrk and swith to use cellular network.   \n Send same request again, and found that it still try to reuse(multiplexing) the invalid connection which was built in wifi network, and get a timeout error(28).   \n Moreover,if I keep retry this request(the interval is less than timeout),  it will always get a timeout error after change to cellulat network. It seems that curl prefer to try `Re-using existing connection #8 with host msg.qy.net`, and this invalid connection can not be deleted because of `Connection still in use 3, no more multi_done now!` \n```\n2025-04-29 17:42:40.177    STATE: INIT => CONNECT handle 0x168056808; line 1940 (connection #-5000)\n2025-04-29 17:42:40.177    Found bundle for host: 0x302439888 [can multiplex]\n2025-04-29 17:42:40.177    Multiplexed connection found\n2025-04-29 17:42:40.177    Re-using existing connection #8 with host msg.qy.net\n2025-04-29 17:42:40.177    STATE: CONNECT => PROTOCONNECT handle 0x168056808; line 1994 (connection #8)\n2025-04-29 17:42:40.177    STATE: PROTOCONNECT => DO handle 0x168056808; line 2123 (connection #8)\n2025-04-29 17:42:40.177    Using Stream ID: 129 (easy handle 0x168056808)\n2025-04-29 17:42:40.177    STATE: DO => DID handle 0x168056808; line 2230 (connection #8)\n2025-04-29 17:42:40.177    STATE: DID => PERFORMING handle 0x168056808; line 2349 (connection #8)\n2025-04-29 17:42:40.177    We are completely uploaded and fine\n2025-04-29 17:42:43.204    Operation timed out after 3027 milliseconds with 0 bytes received\n2025-04-29 17:42:43.204    multi_done: status: 28 prem: 1 done: 0\n2025-04-29 17:42:43.204    Connection still in use 3, no more multi_done now!\n2025-04-29 17:42:43.204    Expire cleared (transfer 0x168056808)\n```\n\n\n### I expected the following\n\n- if change to http request, it will also try reuse connection in pool, and get timeout after change network. But without multiplex, the connection will be closed after timeout error, like below, and next retry request will create a new connection from cellular network and then succeed\n```\n2025-04-29 17:42:46.075    Operation timed out after 6000 milliseconds with 0 bytes received\n2025-04-29 17:42:46.076    multi_done: status: 28 prem: 1 done: 0\n2025-04-29 17:42:46.076    multi_done, not re-using connection=53, forbid=0, close=1, premature=1, conn_multiplex=0\n2025-04-29 17:42:46.076    The cache now contains 9 members\n2025-04-29 17:42:46.076    Curl_disconnect(conn #53, dead=1)\n2025-04-29 17:42:46.076    Closing connection 53\n2025-04-29 17:42:46.076    Expire cleared (transfer 0x167fb1808)\n```\n - Although set a `CURLOPT_FRESH_CONNECT` option for the https request after network changed, it will force to create a new connection and succeed. But is there a graceful method to adapt the network changing scene? Thanks\n\n### curl/libcurl version\n\nlibcurl/8.0.1 OpenSSL/1.1.1w zlib/1.2.12 nghttp2/1.41.0\n\n### operating system\n\niphone","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/17225/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/17225/timeline","performed_via_github_app":null,"state_reason":"completed"}