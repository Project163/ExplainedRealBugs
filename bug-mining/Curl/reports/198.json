{"url":"https://api.github.com/repos/curl/curl/issues/10666","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/10666/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/10666/comments","events_url":"https://api.github.com/repos/curl/curl/issues/10666/events","html_url":"https://github.com/curl/curl/issues/10666","id":1608513888,"node_id":"I_kwDOAAiu0c5f3_lg","number":10666,"title":"Issue with active FTPS connection after updating to libcurl 7.87.0/7.88.0","user":{"login":"SandakovMM","id":4586815,"node_id":"MDQ6VXNlcjQ1ODY4MTU=","avatar_url":"https://avatars.githubusercontent.com/u/4586815?v=4","gravatar_id":"","url":"https://api.github.com/users/SandakovMM","html_url":"https://github.com/SandakovMM","followers_url":"https://api.github.com/users/SandakovMM/followers","following_url":"https://api.github.com/users/SandakovMM/following{/other_user}","gists_url":"https://api.github.com/users/SandakovMM/gists{/gist_id}","starred_url":"https://api.github.com/users/SandakovMM/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SandakovMM/subscriptions","organizations_url":"https://api.github.com/users/SandakovMM/orgs","repos_url":"https://api.github.com/users/SandakovMM/repos","events_url":"https://api.github.com/users/SandakovMM/events{/privacy}","received_events_url":"https://api.github.com/users/SandakovMM/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118197,"node_id":"MDU6TGFiZWwxODQxMTgxOTc=","url":"https://api.github.com/repos/curl/curl/labels/regression","name":"regression","color":"33aa3f","default":false,"description":null},{"id":184118221,"node_id":"MDU6TGFiZWwxODQxMTgyMjE=","url":"https://api.github.com/repos/curl/curl/labels/TLS","name":"TLS","color":"bfdadc","default":false,"description":""},{"id":184118265,"node_id":"MDU6TGFiZWwxODQxMTgyNjU=","url":"https://api.github.com/repos/curl/curl/labels/FTP","name":"FTP","color":"bfd4f2","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":5,"created_at":"2023-03-03T12:04:14Z","updated_at":"2023-03-07T14:23:01Z","closed_at":"2023-03-07T14:23:01Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hello\r\nI am experiencing issues with FTP connection after updating to libcurl 7.87.0 and 7.88.0. Unable to reproduce the issue on 7.86.0.\r\n\r\n### I did this\r\nThere is a simple C utility to reproduce the issue:\r\n```C\r\nint debug_curl(CURL* handle, curl_infotype type, char* data, size_t size, void* userptr)\r\n{\r\n    switch (type) {\r\n    case CURLINFO_TEXT:\r\n        printf(\"Curl output: * %s\\n\", data);\r\n        break;\r\n    case CURLINFO_HEADER_IN:\r\n        printf(\"Curl output: < %s\\n\", data);\r\n        break;\r\n    case CURLINFO_HEADER_OUT:\r\n        printf(\"Curl output: > %s\\n\", data);\r\n        break;\r\n    case CURLINFO_DATA_IN:\r\n    case CURLINFO_DATA_OUT:\r\n    case CURLINFO_SSL_DATA_IN:\r\n    case CURLINFO_SSL_DATA_OUT:\r\n    case CURLINFO_END:\r\n        break;\r\n    }\r\n    return 0;\r\n}\r\n\r\nint result(char *buf, size_t size, size_t nmemb, void *context)\r\n{\r\n    printf(\"result: %s\\n\", buf);\r\n    return 0;\r\n}\r\n\r\nint main(int argc, char **argv)\r\n{\r\n    char *url_with_user = argv[1];\r\n    char *password = argv[2];\r\n\r\n    CURL *curl = curl_easy_init();\r\n    struct curl_slist *m_headers = NULL;\r\n    if (!curl) {\r\n        printf(\"unable to init curl\");\r\n        return 1;\r\n    }\r\n\r\n    curl_easy_setopt(curl, CURLOPT_TIMEOUT, 300);\r\n    curl_easy_setopt(curl, CURLOPT_CONNECTTIMEOUT, 30);\r\n    curl_easy_setopt(curl, CURLOPT_FTP_RESPONSE_TIMEOUT, 60);\r\n    curl_easy_setopt(curl, CURLOPT_TCP_KEEPALIVE, 1);\r\n    curl_easy_setopt(curl, CURLOPT_TCP_KEEPIDLE, 60);\r\n    curl_easy_setopt(curl, CURLOPT_TCP_KEEPINTVL, 60);\r\n\r\n    curl_easy_setopt(curl, CURLOPT_DEBUGFUNCTION, debug_curl);\r\n    curl_easy_setopt(curl, CURLOPT_DEBUGDATA, NULL);\r\n    curl_easy_setopt(curl, CURLOPT_VERBOSE, 1L);\r\n\r\n    curl_easy_setopt(curl, CURLOPT_FTPPORT, \"-\");\r\n    curl_easy_setopt(curl, CURLOPT_FTP_USE_EPRT, 1L);\r\n\r\n    curl_easy_setopt(curl, CURLOPT_SSL_VERIFYPEER, 0);\r\n    curl_easy_setopt(curl, CURLOPT_SSL_VERIFYHOST, 0);\r\n    curl_easy_setopt(curl, CURLOPT_FTP_SSL, CURLFTPSSL_TRY);\r\n    curl_easy_setopt(curl, CURLOPT_SSLVERSION, CURL_SSLVERSION_MAX_TLSv1_3);\r\n\r\n    curl_easy_setopt(curl, CURLOPT_URL, url_with_user);\r\n    curl_easy_setopt(curl, CURLOPT_USERPWD, password);\r\n\r\n    curl_easy_setopt(curl, CURLOPT_DIRLISTONLY, 0L);\r\n    curl_easy_setopt(curl, CURLOPT_NOBODY, 0);\r\n    curl_easy_setopt(curl, CURLOPT_WRITEFUNCTION, result);\r\n    curl_easy_setopt(curl, CURLOPT_WRITEDATA, NULL);\r\n    curl_easy_perform(curl);\r\n    return 0;\r\n}\r\n```\r\nIt works fine with 7.86.0, but when I build it with 7.87.0 or 7.88.0, the connection hangs for a wait timeout and closes without output.\r\nThere is the output of the program with libcurl 7.87.0:\r\n```\r\nCurl output: *   Trying 10.69.41.135:21...\r\n\r\nCurl output: * Connected to 10.69.41.135 (10.69.41.135) port 21 (#0)\r\n\r\nCurl output: < 220 ProFTPD Server (ProFTPD) [10.69.41.135]\r\n\r\nCurl output: > AUTH SSL\r\n\r\nCurl output: < 234 AUTH SSL successful\r\nPD) [10.69.41.135]\r\nCurl output: * [CONN-0-0][CF-SSL] TLSv1.3 (OUT), TLS handshake, Client hello (1):\r\n\r\nCurl output: * [CONN-0-0][CF-SSL] TLSv1.3 (IN), TLS handshake, Server hello (2):\r\n\r\nCurl output: * [CONN-0-0][CF-SSL] TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8):\r\n\r\nCurl output: * [CONN-0-0][CF-SSL] TLSv1.3 (IN), TLS handshake, Certificate (11):\r\n\r\nCurl output: * [CONN-0-0][CF-SSL] TLSv1.3 (IN), TLS handshake, CERT verify (15):\r\n\r\nCurl output: * [CONN-0-0][CF-SSL] TLSv1.3 (IN), TLS handshake, Finished (20):\r\n\r\nCurl output: * [CONN-0-0][CF-SSL] TLSv1.3 (OUT), TLS change cipher, Change cipher spec (1):\r\n\r\nCurl output: * [CONN-0-0][CF-SSL] TLSv1.3 (OUT), TLS handshake, Finished (20):\r\n\r\nCurl output: * SSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384\r\n\r\nCurl output: * Server certificate:\r\n\r\nCurl output: *  subject: C=CH; L=Schaffhausen; O=Plesk; CN=Plesk; emailAddress=info@plesk.com\r\n\r\nCurl output: *  start date: Feb 28 06:04:14 2023 GMT\r\n\r\nCurl output: *  expire date: Feb 28 06:04:14 2024 GMT\r\n\r\nCurl output: *  issuer: C=CH; L=Schaffhausen; O=Plesk; CN=Plesk; emailAddress=info@plesk.com\r\n\r\nCurl output: *  SSL certificate verify result: self signed certificate (18), continuing anyway.\r\n\r\nCurl output: > USER tftp\r\n\r\nCurl output: * [CONN-0-0][CF-SSL] TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):\r\n\r\nCurl output: * [CONN-0-0][CF-SSL] TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):\r\n\r\nCurl output: * old SSL session ID is stale, removing\r\n\r\nCurl output: < 331 Password required for tftp\r\n.69.41.135]\r\nCurl output: > PASS 1qazxsw2\r\n\r\nCurl output: < 230 User tftp logged in\r\n tftp\r\nCurl output: > PBSZ 0\r\n\r\nCurl output: < 200 PBSZ 0 successful\r\n\r\nCurl output: > PROT P\r\n\r\nCurl output: < 200 Protection set to Private\r\n\r\nCurl output: > PWD\r\n\r\nCurl output: < 257 \"/home/tftp\" is the current directory\r\n\r\nCurl output: * Entry path is '/home/tftp'\r\n\r\nCurl output: * Request has same path as previous transfer\r\n\r\nCurl output: > EPRT |1|10.69.41.80|38691|\r\n\r\nCurl output: * ftp_perform ends with SECONDARY: 1\r\n\r\nCurl output: < 200 EPRT command successful\r\nnt directory\r\nCurl output: * Connect data stream actively\r\n\r\nCurl output: > TYPE A\r\n\r\nCurl output: < 200 Type set to A\r\nccessful\r\nCurl output: > LIST\r\n\r\nCurl output: < 150 Opening ASCII mode data connection for file list\r\n\r\nCurl output: * Maxdownload = -1\r\n\r\nCurl output: * Preparing for accepting server on data port\r\n\r\nCurl output: * Checking for server connect\r\n\r\nCurl output: * Ready to accept data connection from server\r\n\r\nCurl output: * Connection accepted from server\r\n\r\nCurl output: * Operation timed out after 300001 milliseconds with 0 bytes received\r\n\r\nCurl output: * Closing connection 0\r\n\r\nCurl output: * [CONN-0-0][CF-SSL] TLSv1.3 (OUT), TLS alert, close notify (256):\r\n```\r\n\r\n**The issue disappears when I remove SSL parts of the code.** So likely the problem somewhere in this part. Unfortunately, I can't see where exactly.\r\n\r\n### I expected the following\r\nI expect to see the line:\r\n```\r\nresult: drwxr-xr-x   2 tftp     root         4096 Feb 28 10:46 tftpboot\r\n```\r\nReceived from the other side.\r\nFor example this is the utility output built with libcurl 7.86.0:\r\n```\r\nCurl output: *   Trying 10.69.41.135:21...\r\n\r\nCurl output: * Connected to 10.69.41.135 (10.69.41.135) port 21 (#0)\r\n\r\nCurl output: < 220 ProFTPD Server (ProFTPD) [10.69.41.135]\r\n\r\nCurl output: > AUTH SSL\r\n\r\nCurl output: < 234 AUTH SSL successful\r\nPD) [10.69.41.135]\r\nCurl output: * TLSv1.3 (OUT), TLS handshake, Client hello (1):\r\n\r\nCurl output: * TLSv1.3 (IN), TLS handshake, Server hello (2):\r\n\r\nCurl output: * TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8):\r\n\r\nCurl output: * TLSv1.3 (IN), TLS handshake, Certificate (11):\r\n\r\nCurl output: * TLSv1.3 (IN), TLS handshake, CERT verify (15):\r\n\r\nCurl output: * TLSv1.3 (IN), TLS handshake, Finished (20):\r\n\r\nCurl output: * TLSv1.3 (OUT), TLS change cipher, Change cipher spec (1):\r\n\r\nCurl output: * TLSv1.3 (OUT), TLS handshake, Finished (20):\r\n\r\nCurl output: * SSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384\r\n\r\nCurl output: * Server certificate:\r\n\r\nCurl output: *  subject: C=CH; L=Schaffhausen; O=Plesk; CN=Plesk; emailAddress=info@plesk.com\r\n\r\nCurl output: *  start date: Feb 28 06:04:14 2023 GMT\r\n\r\nCurl output: *  expire date: Feb 28 06:04:14 2024 GMT\r\n\r\nCurl output: *  issuer: C=CH; L=Schaffhausen; O=Plesk; CN=Plesk; emailAddress=info@plesk.com\r\n\r\nCurl output: *  SSL certificate verify result: self signed certificate (18), continuing anyway.\r\n\r\nCurl output: > USER tftp\r\n\r\nCurl output: * TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):\r\n\r\nCurl output: * TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):\r\n\r\nCurl output: * old SSL session ID is stale, removing\r\n\r\nCurl output: < 331 Password required for tftp\r\n.69.41.135]\r\nCurl output: > PASS 1qazxsw2\r\n\r\nCurl output: < 230 User tftp logged in\r\n tftp\r\nCurl output: > PBSZ 0\r\n\r\nCurl output: < 200 PBSZ 0 successful\r\n\r\nCurl output: > PROT P\r\n\r\nCurl output: < 200 Protection set to Private\r\n\r\nCurl output: > PWD\r\n\r\nCurl output: < 257 \"/home/tftp\" is the current directory\r\n\r\nCurl output: * Entry path is '/home/tftp'\r\n\r\nCurl output: * Request has same path as previous transfer\r\n\r\nCurl output: > EPRT |1|10.69.41.80|39219|\r\n\r\nCurl output: * ftp_perform ends with SECONDARY: 1\r\n\r\nCurl output: < 200 EPRT command successful\r\nnt directory\r\nCurl output: * Connect data stream actively\r\n\r\nCurl output: > TYPE A\r\n\r\nCurl output: < 200 Type set to A\r\nccessful\r\nCurl output: > LIST\r\n\r\nCurl output: < 150 Opening ASCII mode data connection for file list\r\n\r\nCurl output: * Maxdownload = -1\r\n\r\nCurl output: * Preparing for accepting server on data port\r\n\r\nCurl output: * Checking for server connect\r\n\r\nCurl output: * Ready to accept data connection from server\r\n\r\nCurl output: * Connection accepted from server\r\n\r\nCurl output: * Doing the SSL/TLS handshake on the data stream\r\n\r\nCurl output: * SSL re-using session ID\r\n\r\nCurl output: * TLSv1.3 (OUT), TLS handshake, Client hello (1):\r\n\r\nCurl output: * TLSv1.3 (IN), TLS handshake, Server hello (2):\r\n\r\nCurl output: * TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8):\r\n\r\nCurl output: * TLSv1.3 (IN), TLS handshake, Finished (20):\r\n\r\nCurl output: * TLSv1.3 (OUT), TLS change cipher, Change cipher spec (1):\r\n\r\nCurl output: * TLSv1.3 (OUT), TLS handshake, Finished (20):\r\n\r\nCurl output: * SSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384\r\n\r\nCurl output: * Server certificate:\r\n\r\nCurl output: *  subject: C=CH; L=Schaffhausen; O=Plesk; CN=Plesk; emailAddress=info@plesk.com\r\n\r\nCurl output: *  start date: Feb 28 06:04:14 2023 GMT\r\n\r\nCurl output: *  expire date: Feb 28 06:04:14 2024 GMT\r\n\r\nCurl output: *  issuer: C=CH; L=Schaffhausen; O=Plesk; CN=Plesk; emailAddress=info@plesk.com\r\n\r\nCurl output: *  SSL certificate verify result: self signed certificate (18), continuing anyway.\r\n\r\nCurl output: * TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):\r\n\r\nCurl output: * old SSL session ID is stale, removing\r\n\r\nresult: drwxr-xr-x   2 tftp     root         4096 Feb 28 10:46 tftpboot <------------------------------- THE LINE\r\n\r\nCurl output: * Failure writing output to destination\r\n\r\nCurl output: * TLSv1.3 (IN), TLS alert, close notify (256):\r\n\r\nCurl output: * TLSv1.3 (OUT), TLS alert, close notify (256):\r\n\r\nCurl output: * Closing connection 0\r\n```\r\n\r\n### curl/libcurl version\r\nlibcurl 7.87.0 and 7.88.0\r\n\r\n### operating system\r\nUbuntu 20","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/10666/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/10666/timeline","performed_via_github_app":null,"state_reason":"completed"}