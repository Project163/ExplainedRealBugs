{"url":"https://api.github.com/repos/curl/curl/issues/15258","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/15258/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/15258/comments","events_url":"https://api.github.com/repos/curl/curl/issues/15258/events","html_url":"https://github.com/curl/curl/issues/15258","id":2579616642,"node_id":"I_kwDOAAiu0c6ZwdOC","number":15258,"title":"Race condition in parallel automake build with checksrc and lib1521.c","user":{"login":"dfandrich","id":228259,"node_id":"MDQ6VXNlcjIyODI1OQ==","avatar_url":"https://avatars.githubusercontent.com/u/228259?v=4","gravatar_id":"","url":"https://api.github.com/users/dfandrich","html_url":"https://github.com/dfandrich","followers_url":"https://api.github.com/users/dfandrich/followers","following_url":"https://api.github.com/users/dfandrich/following{/other_user}","gists_url":"https://api.github.com/users/dfandrich/gists{/gist_id}","starred_url":"https://api.github.com/users/dfandrich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dfandrich/subscriptions","organizations_url":"https://api.github.com/users/dfandrich/orgs","repos_url":"https://api.github.com/users/dfandrich/repos","events_url":"https://api.github.com/users/dfandrich/events{/privacy}","received_events_url":"https://api.github.com/users/dfandrich/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118182,"node_id":"MDU6TGFiZWwxODQxMTgxODI=","url":"https://api.github.com/repos/curl/curl/labels/build","name":"build","color":"bfdadc","default":false,"description":null},{"id":887227423,"node_id":"MDU6TGFiZWw4ODcyMjc0MjM=","url":"https://api.github.com/repos/curl/curl/labels/tests","name":"tests","color":"a7a8e8","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2024-10-10T19:03:12Z","updated_at":"2024-10-17T21:00:53Z","closed_at":"2024-10-17T21:00:53Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\n[This build](https://github.com/curl/curl/actions/runs/11279562995/job/31370608883?pr=15257) failed with `./lib1521.c:1:1: error: Missing copyright statement (COPYRIGHT)` despite the mk-lib1521.pl script being designed to write a copyright statement at the beginning of the file.\n\n### I expected the following\n\nThere should be no such false error.\r\n\r\nI suspect what's happening is that the mk-lib1521.pl and checksrc targets are running at the same time and in parallel, and since the former creates the lib1521.c file using shell redirection, an empty lib1521.c is created immediately, before the script even starts to run. Meanwhile, checksrc sees the .c file, doesn't find a copyright line inside and raises an error. If it checked a few milliseconds later, it would have been fine.\r\n\r\nI'm not sure the best way to fix this. Some possibilities that came to mind:\r\n* Making checksrc wait until the test target is done would work, unless tests are not being built at all. That would also make the checksrc test happen at the end, after everything else is built.\r\n* Adding an explicit make dependency on lib1521.c would work, but it will spuriously break again the next time a new generated file is added and adding the new dependency is forgotten.\r\n* Giving checksrc an explicit ignore list would work, but has the same problem.\r\n* Changing mk-lib1521.pl to create the lib1521.c file internally would reduce the window where there is a problem, but not eliminate it.\r\n* Making checksrc ignore empty files would probably usually work, but it's possible on some platforms a buffer's worth of data could be flushed into the file before checksrc checks it, which makes the file non-empty but contains the start of the copyright header only and not the whole thing, which would still cause it to fail.\r\n* Creating lib1521.c in two stages, writing it first to a temporary file (not ending in .c) then renaming it to the final name after it's written. This makes the run jobs inconsistent (because checksrc will sometimes check lib1521.c and sometimes not) but with reproduceable results (because the checksrc check, if run, will always succeed).\r\n\r\nDespite the slight imperfection of the latter solution, I see it as being the cleanest.\n\n### curl/libcurl version\n\ncurl 8.11.0-DEV\n\n### operating system\n\nUbuntu 22.04","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/15258/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/15258/timeline","performed_via_github_app":null,"state_reason":"completed"}