{"url":"https://api.github.com/repos/curl/curl/issues/11669","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/11669/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/11669/comments","events_url":"https://api.github.com/repos/curl/curl/issues/11669/events","html_url":"https://github.com/curl/curl/issues/11669","id":1848379850,"node_id":"I_kwDOAAiu0c5uLAnK","number":11669,"title":"time_starttransfer reported wrong timestamp","user":{"login":"JazJas","id":29362280,"node_id":"MDQ6VXNlcjI5MzYyMjgw","avatar_url":"https://avatars.githubusercontent.com/u/29362280?v=4","gravatar_id":"","url":"https://api.github.com/users/JazJas","html_url":"https://github.com/JazJas","followers_url":"https://api.github.com/users/JazJas/followers","following_url":"https://api.github.com/users/JazJas/following{/other_user}","gists_url":"https://api.github.com/users/JazJas/gists{/gist_id}","starred_url":"https://api.github.com/users/JazJas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JazJas/subscriptions","organizations_url":"https://api.github.com/users/JazJas/orgs","repos_url":"https://api.github.com/users/JazJas/repos","events_url":"https://api.github.com/users/JazJas/events{/privacy}","received_events_url":"https://api.github.com/users/JazJas/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":200869765,"node_id":"MDU6TGFiZWwyMDA4Njk3NjU=","url":"https://api.github.com/repos/curl/curl/labels/documentation","name":"documentation","color":"f7c6c7","default":true,"description":null}],"state":"closed","locked":false,"assignee":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":6,"created_at":"2023-08-13T03:23:41Z","updated_at":"2023-08-15T12:25:13Z","closed_at":"2023-08-15T12:25:12Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\r\n\r\nAccording to the man page below, the server response time can be: time_starttransfer - time_starttransfer\r\n\r\ntime_starttransfer:　The time, in seconds, it took from the start until the first byte was just about to be transferred. This includes time_pretransfer and also the  time the server needed to calculate the result.\r\n\r\nHowever, curl (all versions) actually set the time_starttransfer incorrectly. \r\n\r\nI used curl to send a large text file (134M) as a payload of a POST request to a HTTP server using the following syntax:\r\ncurl -s -w \"%{time_pretransfer}\\n%{time_starttransfer}\\n\" -o /dev/null --data-binary @file.txt --header @$headers_file $server_url --insecure\r\n\r\nAt the same time,  tcpdump was used to capture all network packets.\r\n\r\nWhen the curl command finished, I got:\r\n\r\ntime_pretransfer: 0.017484\r\ntime_starttransfer: 1.018670 \r\n\r\nHowever, when analyzing the captured packets, Time 0.017484 is roughly the point when the client sent the first packet of the request (ie Packet 4) and Time 1.018670 is when the client started sending the large post payload (ie Packet 6). \r\nAn in fact, the entire POST request is sent over the wire completely at Time 1.156250 (ie Packet 175), and the first packet of the response from the server is at Time 3.041776 (Packet 184).\r\n~~~\r\n    1   0.000000 192.168.46.132 → 192.168.70.34 TCP 80 59664 → 80 [SYN] Seq=0 Win=64240 Len=0 MSS=1460 SACK_PERM TSval=3381780598 TSecr=0 WS=128\r\n    2   0.017261 192.168.70.34 → 192.168.46.132 TCP 66 80 → 59664 [SYN, ACK] Seq=0 Ack=1 Win=64240 Len=0 MSS=1460\r\n    3   0.017298 192.168.46.132 → 192.168.70.34 TCP 60 59664 → 80 [ACK] Seq=1 Ack=1 Win=64240 Len=0\r\n    4   0.017377 192.168.46.132 → 192.168.70.34 TCP 848 POST / HTTP/1.1  [TCP segment of a reassembled PDU]\r\n    5   0.017506 192.168.70.34 → 192.168.46.132 TCP 66 80 → 59664 [ACK] Seq=1 Ack=789 Win=64240 Len=0\r\n    6   1.018656 192.168.46.132 → 192.168.70.34 HTTP 7360 POST / HTTP/1.1  (application/x-www-form-urlencoded)Continuation\r\n    7   1.018717 192.168.46.132 → 192.168.70.34 HTTP 7360 Continuation\r\n    8   1.018914 192.168.70.34 → 192.168.46.132 TCP 66 80 → 59664 [ACK] Seq=1 Ack=2249 Win=64240 Len=0\r\n    9   1.018914 192.168.70.34 → 192.168.46.132 TCP 66 80 → 59664 [ACK] Seq=1 Ack=3709 Win=64240 Len=0\r\n   10   1.018914 192.168.70.34 → 192.168.46.132 TCP 66 80 → 59664 [ACK] Seq=1 Ack=5169 Win=64240 Len=0\r\n   11   1.018915 192.168.70.34 → 192.168.46.132 TCP 66 80 → 59664 [ACK] Seq=1 Ack=6629 Win=64240 Len=0\r\n   12   1.018915 192.168.70.34 → 192.168.46.132 TCP 66 80 → 59664 [ACK] Seq=1 Ack=8089 Win=64240 Len=0\r\n   13   1.018915 192.168.70.34 → 192.168.46.132 TCP 66 80 → 59664 [ACK] Seq=1 Ack=9549 Win=64240 Len=0\r\n   14   1.018934 192.168.46.132 → 192.168.70.34 HTTP 2980 Continuation\r\n   15   1.018978 192.168.46.132 → 192.168.70.34 HTTP 2980 Continuation\r\n   16   1.019120 192.168.70.34 → 192.168.46.132 TCP 66 80 → 59664 [ACK] Seq=1 Ack=11009 Win=64240 Len=0\r\n   17   1.019121 192.168.70.34 → 192.168.46.132 TCP 66 80 → 59664 [ACK] Seq=1 Ack=12469 Win=64240 Len=0\r\n...\r\n...\r\n  173   1.096653 192.168.70.34 → 192.168.46.132 TCP 66 [TCP ZeroWindow] 80 → 59664 [ACK] Seq=1 Ack=193509 Win=0 Len=0\r\n  174   1.156231 192.168.70.34 → 192.168.46.132 TCP 66 [TCP Window Update] 80 → 59664 [ACK] Seq=1 Ack=193509 Win=4380 Len=0\r\n  175   1.156250 192.168.46.132 → 192.168.70.34 HTTP 4440 [TCP Window Full] Continuation\r\n  176   1.156344 192.168.70.34 → 192.168.46.132 TCP 66 80 → 59664 [ACK] Seq=1 Ack=194969 Win=2920 Len=0\r\n  177   1.156344 192.168.70.34 → 192.168.46.132 TCP 66 80 → 59664 [ACK] Seq=1 Ack=196429 Win=1460 Len=0\r\n  178   1.156416 192.168.70.34 → 192.168.46.132 TCP 66 [TCP ZeroWindow] 80 → 59664 [ACK] Seq=1 Ack=197889 Win=0 Len=0\r\n  179   1.364067 192.168.46.132 → 192.168.70.34 TCP 60 [TCP Keep-Alive] 59664 → 80 [ACK] Seq=197888 Ack=1 Win=64240 Len=0\r\n  180   1.804074 192.168.46.132 → 192.168.70.34 TCP 60 [TCP Keep-Alive] 59664 → 80 [ACK] Seq=197888 Ack=1 Win=64240 Len=0\r\n  181   1.804404 192.168.70.34 → 192.168.46.132 TCP 66 [TCP ZeroWindow] 80 → 59664 [ACK] Seq=1 Ack=197889 Win=0 Len=0\r\n  182   2.635608 192.168.46.132 → 192.168.70.34 TCP 60 [TCP Keep-Alive] 59664 → 80 [ACK] Seq=197888 Ack=1 Win=64240 Len=0\r\n  183   2.635759 192.168.70.34 → 192.168.46.132 TCP 66 [TCP ZeroWindow] 80 → 59664 [ACK] Seq=1 Ack=197889 Win=0 Len=0\r\n  184   3.041776 192.168.70.34 → 192.168.46.132 TCP 181 [TCP ZeroWindow] HTTP/1.0 200 OK  [TCP segment of a reassembled PDU]\r\n  185   3.041810 192.168.46.132 → 192.168.70.34 TCP 60 59664 → 80 [ACK] Seq=197889 Ack=122 Win=64119 Len=0\r\n  186   3.345284 192.168.70.34 → 192.168.46.132 TCP 2540 [TCP ZeroWindow] 80 → 59664 [PSH, ACK] Seq=122 Ack=197889 Win=0 Len=2480 [TCP segment of a reassembled PDU]\r\n  187   3.345363 192.168.46.132 → 192.168.70.34 TCP 60 59664 → 80 [ACK] Seq=197889 Ack=2602 Win=62780 Len=0\r\n  188   3.345602 192.168.70.34 → 192.168.46.132 TCP 5020 [TCP ZeroWindow] 80 → 59664 [PSH, ACK] Seq=2602 Ack=197889 Win=0 Len=4960 [TCP segment of a reassembled PDU]\r\n  189   3.345631 192.168.46.132 → 192.168.70.34 TCP 60 59664 → 80 [ACK] Seq=197889 Ack=7562 Win=61320 Len=0\r\n~~~\r\n\r\n### I expected the following\r\n\r\nFirst, the time_starttransfer is expected to be the timestamp of Packet 184. and the description of it should be made clear to something like: The time, in seconds, it took from the start until the first byte was just about to be transferred from **the server**. This includes time_pretransfer and also the  time the server needed to calculate the result.\r\n\r\nSecond, the description of time_pretransfer needs to be made clearer. More details are given below:\r\n\r\nAccording to my test results above, it looks like time_pretransfer is the time when the file transfer is just about to begin by a **client**. If this is indeed the intended result, then time_starttransfer should include time_pretransfer, the time the server needed to calculate the result, and the time the client needed to send the entire request. However, this will give users no idea how to calculate the server response time as the time the client needed to send the entire request is unknown.\r\n\r\nTherefore:\r\nIf time_pretransfer is the time when the file transfer is just about to begin by a **client**:\r\n1. make the description of time_pretransfer clear\r\n2. introduce a new variable to track the time the client needs to send an entire request, and \r\n3. update the description of time_starttransfer to be something like: The time, in seconds, it took from the start until the first byte was just about to be transferred from the **server**. This includes time_pretransfer, time to complete sending a request, and also the  time the server needed to calculate the result.\r\n\r\nIf time_pretransfer is the time when the client complete sending the entire request:\r\n1. make the description of time_pretransfer clear.\r\n2. re-implement time_pretransfer so that it will return the correct timestamp. \r\n\r\n\r\n### curl/libcurl version\r\n\r\ncurl 8.2.1 (x86_64-pc-linux-gnu) libcurl/8.2.1 OpenSSL/3.0.9 zlib/1.2.13\r\nRelease-Date: 2023-07-26\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps mqtt pop3 pop3s rtsp smb smbs smtp smtps telnet tftp\r\nFeatures: alt-svc AsynchDNS HSTS HTTPS-proxy IPv6 Largefile libz NTLM NTLM_WB SSL threadsafe TLS-SRP UnixSockets\r\n\r\n\r\n### operating system\r\n\r\nLinux kali 6.1.0-kali9-amd64 #1 SMP PREEMPT_DYNAMIC Debian 6.1.27-1kali1 (2023-05-12) x86_64 GNU/Linux\r\n","closed_by":{"login":"JazJas","id":29362280,"node_id":"MDQ6VXNlcjI5MzYyMjgw","avatar_url":"https://avatars.githubusercontent.com/u/29362280?v=4","gravatar_id":"","url":"https://api.github.com/users/JazJas","html_url":"https://github.com/JazJas","followers_url":"https://api.github.com/users/JazJas/followers","following_url":"https://api.github.com/users/JazJas/following{/other_user}","gists_url":"https://api.github.com/users/JazJas/gists{/gist_id}","starred_url":"https://api.github.com/users/JazJas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JazJas/subscriptions","organizations_url":"https://api.github.com/users/JazJas/orgs","repos_url":"https://api.github.com/users/JazJas/repos","events_url":"https://api.github.com/users/JazJas/events{/privacy}","received_events_url":"https://api.github.com/users/JazJas/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/11669/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/11669/timeline","performed_via_github_app":null,"state_reason":"completed"}