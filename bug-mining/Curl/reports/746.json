{"url":"https://api.github.com/repos/curl/curl/issues/17611","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/17611/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/17611/comments","events_url":"https://api.github.com/repos/curl/curl/issues/17611/events","html_url":"https://github.com/curl/curl/issues/17611","id":3142895225,"node_id":"I_kwDOAAiu0c67VMZ5","number":17611,"title":"HTTP/2: After a timeout, RST_STREAM is not sent immediately","user":{"login":"mkauf","id":12849992,"node_id":"MDQ6VXNlcjEyODQ5OTky","avatar_url":"https://avatars.githubusercontent.com/u/12849992?v=4","gravatar_id":"","url":"https://api.github.com/users/mkauf","html_url":"https://github.com/mkauf","followers_url":"https://api.github.com/users/mkauf/followers","following_url":"https://api.github.com/users/mkauf/following{/other_user}","gists_url":"https://api.github.com/users/mkauf/gists{/gist_id}","starred_url":"https://api.github.com/users/mkauf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mkauf/subscriptions","organizations_url":"https://api.github.com/users/mkauf/orgs","repos_url":"https://api.github.com/users/mkauf/repos","events_url":"https://api.github.com/users/mkauf/events{/privacy}","received_events_url":"https://api.github.com/users/mkauf/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":194601710,"node_id":"MDU6TGFiZWwxOTQ2MDE3MTA=","url":"https://api.github.com/repos/curl/curl/labels/HTTP/2","name":"HTTP/2","color":"009800","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":3,"created_at":"2025-06-13T09:26:19Z","updated_at":"2025-06-17T09:58:25Z","closed_at":"2025-06-17T09:58:25Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nWhen a curl transfer times out (`CURLOPT_TIMEOUT`), an `RST_STREAM` frame should be sent to the server immediately to notify the server. This worked with curl 7.87.0 but broke with curl 7.88.0. It's still broken in the current master branch.\n\n\"git bisect\" points to the commit ead2b2d4f65ef433b2505b61c547baa106557100.\n\nTest program to reproduce this (based on `multi-single.c`):\n```\n#include <stdio.h>\n#include <string.h>\n#include <unistd.h>\n\n#include <curl/curl.h>\n\nint main(void)\n{\n  CURL *http_handle;\n  CURLM *multi_handle;\n  int still_running = 1;\n\n  curl_global_init(CURL_GLOBAL_DEFAULT);\n\n  http_handle = curl_easy_init();\n\n  curl_easy_setopt(http_handle, CURLOPT_URL, \"https://localhost/?sleep=10s\");\n  curl_easy_setopt(http_handle, CURLOPT_SSL_VERIFYPEER, 0L);\n  curl_easy_setopt(http_handle, CURLOPT_SSL_VERIFYHOST, 0L);\n  curl_easy_setopt(http_handle, CURLOPT_TIMEOUT, 5L);\n  curl_easy_setopt(http_handle, CURLOPT_VERBOSE, 1L);\n\n  multi_handle = curl_multi_init();\n\n  curl_multi_add_handle(multi_handle, http_handle);\n\n  do {\n    CURLMcode mc = curl_multi_perform(multi_handle, &still_running);\n\n    if(!mc)\n      mc = curl_multi_poll(multi_handle, NULL, 0, 1000, NULL);\n\n    if(mc) {\n      fprintf(stderr, \"curl_multi_poll() failed, code %d.\\n\", (int)mc);\n      break;\n    }\n\n  } while(still_running);\n\n  curl_multi_remove_handle(multi_handle, http_handle);\n\n  curl_easy_cleanup(http_handle);\n\n  sleep(4);\n\n  curl_multi_cleanup(multi_handle);\n\n  curl_global_cleanup();\n\n  return 0;\n}\n```\n\nThe server sleeps for 10 seconds before sending the response.\n\nTo test it, set the environment variable `SSLKEYLOGFILE` and capture + analyze the network traffic with Wireshark: https://everything.curl.dev/usingcurl/tls/sslkeylogfile.html\n* With curl 7.87.0, an `RST_STREAM` frame is sent approximately after 5 seconds (timeout).\n* curl 7.88.0 does not send an `RST_STREAM` frame at all.\n* The current master branch sends an `RST_STREAM` frame after approximately 9 seconds (timeout of 5 seconds + sleep time of 4 seconds).\n\n### I expected the following\n\nAfter a timeout, curl notifies HTTP/2 servers immediately by sending an `RST_STREAM` frame.\n\n### curl/libcurl version\n\ncurrent master branch (commit 1cdac95e2e1022c298c1e4e551c7e8b5bd8fd5df)\n\n### operating system\n\nFedora Linux 42","closed_by":{"login":"vszakats","id":1446897,"node_id":"MDQ6VXNlcjE0NDY4OTc=","avatar_url":"https://avatars.githubusercontent.com/u/1446897?v=4","gravatar_id":"","url":"https://api.github.com/users/vszakats","html_url":"https://github.com/vszakats","followers_url":"https://api.github.com/users/vszakats/followers","following_url":"https://api.github.com/users/vszakats/following{/other_user}","gists_url":"https://api.github.com/users/vszakats/gists{/gist_id}","starred_url":"https://api.github.com/users/vszakats/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vszakats/subscriptions","organizations_url":"https://api.github.com/users/vszakats/orgs","repos_url":"https://api.github.com/users/vszakats/repos","events_url":"https://api.github.com/users/vszakats/events{/privacy}","received_events_url":"https://api.github.com/users/vszakats/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/17611/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/17611/timeline","performed_via_github_app":null,"state_reason":"completed"}