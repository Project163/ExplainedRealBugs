{"url":"https://api.github.com/repos/curl/curl/issues/10144","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/10144/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/10144/comments","events_url":"https://api.github.com/repos/curl/curl/issues/10144/events","html_url":"https://github.com/curl/curl/issues/10144","id":1508384445,"node_id":"I_kwDOAAiu0c5Z6B69","number":10144,"title":"MITM program breaks socketpair, causes getaddrinfo() thread fail to start","user":{"login":"SerusDev","id":13630111,"node_id":"MDQ6VXNlcjEzNjMwMTEx","avatar_url":"https://avatars.githubusercontent.com/u/13630111?v=4","gravatar_id":"","url":"https://api.github.com/users/SerusDev","html_url":"https://github.com/SerusDev","followers_url":"https://api.github.com/users/SerusDev/followers","following_url":"https://api.github.com/users/SerusDev/following{/other_user}","gists_url":"https://api.github.com/users/SerusDev/gists{/gist_id}","starred_url":"https://api.github.com/users/SerusDev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SerusDev/subscriptions","organizations_url":"https://api.github.com/users/SerusDev/orgs","repos_url":"https://api.github.com/users/SerusDev/repos","events_url":"https://api.github.com/users/SerusDev/events{/privacy}","received_events_url":"https://api.github.com/users/SerusDev/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":940032249,"node_id":"MDU6TGFiZWw5NDAwMzIyNDk=","url":"https://api.github.com/repos/curl/curl/labels/Windows","name":"Windows","color":"0e8a16","default":false,"description":"Windows-specific"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-12-22T18:41:16Z","updated_at":"2022-12-28T08:27:42Z","closed_at":"2022-12-28T08:27:42Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\r\n`curl https://www.google.com/`\r\n\r\n### I expected the following\r\nInstead of a success, curl always returns:\r\n`curl: (6) getaddrinfo() thread failed to start`\r\n\r\n### curl/libcurl version\r\n```\r\ncurl 7.83.1 (Windows) libcurl/7.83.1 Schannel\r\nRelease-Date: 2022-05-13\r\nProtocols: dict file ftp ftps http https imap imaps pop3 pop3s smtp smtps telnet tftp\r\nFeatures: AsynchDNS HSTS IPv6 Kerberos Largefile NTLM SPNEGO SSL SSPI UnixSockets\r\n```\r\n\r\n### operating system\r\nWindows 10 x64\r\n\r\n### possible cause\r\nI was able to trace this problem to https://github.com/curl/curl/blob/master/lib/socketpair.c#L126\r\n\r\nApparently, curl on Windows simulates unix socket pair with a pair of regular TCP sockets on 127.0.0.1.\r\nIf the system (like in my case) runs a program that works as a proxy for this connection, socket addresses (ports) mismatch and Curl_socketpair fails.\r\n\r\nI guess, the problem is widespread and cryptic. There is a number of antiviruses, firewalls, tunneling and monitoring software that proxy 127.0.0.1 connections and can cause this problem. At the same time, Curl_socketpair call does not provide any error messages. The top level getaddrinfo() error is very hard to track to this.\r\nI experienced this problem when using git for Windows (curl based) together with Proxifier tool.\r\n\r\nI propose to remove `a.inaddr.sin_port != a2.inaddr.sin_port` condition or perform peer validation with a chunk of a random data transmitted over the socket (recv/send calls).\r\n","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/10144/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/10144/timeline","performed_via_github_app":null,"state_reason":"completed"}