{"url":"https://api.github.com/repos/curl/curl/issues/13174","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/13174/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/13174/comments","events_url":"https://api.github.com/repos/curl/curl/issues/13174/events","html_url":"https://github.com/curl/curl/issues/13174","id":2203257513,"node_id":"I_kwDOAAiu0c6DUwqp","number":13174,"title":"High CPU usage with -T .","user":{"login":"magisterquis","id":499530,"node_id":"MDQ6VXNlcjQ5OTUzMA==","avatar_url":"https://avatars.githubusercontent.com/u/499530?v=4","gravatar_id":"","url":"https://api.github.com/users/magisterquis","html_url":"https://github.com/magisterquis","followers_url":"https://api.github.com/users/magisterquis/followers","following_url":"https://api.github.com/users/magisterquis/following{/other_user}","gists_url":"https://api.github.com/users/magisterquis/gists{/gist_id}","starred_url":"https://api.github.com/users/magisterquis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/magisterquis/subscriptions","organizations_url":"https://api.github.com/users/magisterquis/orgs","repos_url":"https://api.github.com/users/magisterquis/repos","events_url":"https://api.github.com/users/magisterquis/events{/privacy}","received_events_url":"https://api.github.com/users/magisterquis/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":192912238,"node_id":"MDU6TGFiZWwxOTI5MTIyMzg=","url":"https://api.github.com/repos/curl/curl/labels/cmdline%20tool","name":"cmdline tool","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":4,"created_at":"2024-03-22T20:27:48Z","updated_at":"2024-05-02T07:43:49Z","closed_at":"2024-05-02T07:43:49Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\n```sh\r\n./long_running_command | curl -T. https://my_server\r\n```\r\nThe idea is to have output from the command sent to my server as it's produced.\r\n\r\nReproduces with\r\n```sh\r\ncurl -T. https://example.com\r\n```\n\n### I expected the following\n\nOutput to show up server-side, which it did.\r\n\r\nClient-side, the curl's CPU usage to be nearly 0 most of the time, which it wasn't.  After a while, it hits nearly 100%.\r\n\r\nIt seems to be hitting a tight loop which calls `poll`, `read`, and `recvfrom`:\r\n```\r\n 86911 curl     CALL  poll(0x7d6f6c2b2c80,2,0)\r\n 86911 curl     STRU  struct pollfd [2] { fd=5, events=0x5<POLLIN|POLLOUT>, revents=0x4<POLLOUT> } { fd=3, events=0x1<POLLIN>, revents=0<> }\r\n 86911 curl     RET   poll 1\r\n 86911 curl     CALL  sigaction(SIGPIPE,0,0x7d6f6c2b2d70)\r\n 86911 curl     STRU  struct sigaction { handler=SIG_IGN, mask=0<>, flags=0x2<SA_RESTART> }\r\n 86911 curl     RET   sigaction 0\r\n 86911 curl     CALL  sigaction(SIGPIPE,0x7d6f6c2b2d40,0)\r\n 86911 curl     STRU  struct sigaction { handler=SIG_IGN, mask=0<>, flags=0x2<SA_RESTART> }\r\n 86911 curl     RET   sigaction 0\r\n 86911 curl     CALL  recvfrom(5,0x61af75375c0,0x5,0,0,0)\r\n 86911 curl     RET   recvfrom -1 errno 35 Resource temporarily unavailable\r\n 86911 curl     CALL  read(0,0x61af1ca4020,0x10000)\r\n 86911 curl     RET   read -1 errno 35 Resource temporarily unavailable\r\n 86911 curl     CALL  sigaction(SIGPIPE,0x7d6f6c2b2d70,0)\r\n 86911 curl     STRU  struct sigaction { handler=SIG_IGN, mask=0<>, flags=0x2<SA_RESTART> }\r\n 86911 curl     RET   sigaction 0\r\n 86911 curl     CALL  poll(0x7d6f6c2b2c80,2,0)\r\n 86911 curl     STRU  struct pollfd [2] { fd=5, events=0x5<POLLIN|POLLOUT>, revents=0x4<POLLOUT> } { fd=3, events=0x1<POLLIN>, revents=0<> }\r\n 86911 curl     RET   poll 1\r\n```\r\n\r\nFile descriptor 5 is the network socket:\r\n\r\n```\r\n$ fstat -p 86911\r\nUSER     CMD          PID   FD MOUNT        INUM  MODE         R/W    SZ|DV\r\nstuart   curl       86911 text /        109747340  -rwxr-xr-x     r   321296\r\nstuart   curl       86911   wd /        109670073  drwxr-xr-x     r     1536\r\nstuart   curl       86911   tr /        109670150  -rw-------    rw 335611000\r\nstuart   curl       86911    0 /        104276665  crw--w----    rw    ttyp5\r\nstuart   curl       86911    1 /        104277329  crw-rw-rw-     w     null\r\nstuart   curl       86911    2 /        104277329  crw-rw-rw-     w     null\r\nstuart   curl       86911    3 pipe 0x0 state:\r\nstuart   curl       86911    4 pipe 0x0 state:\r\nstuart   curl       86911    5* internet stream tcp 0x0 [Internal_IP]:24787 --> 93.184.216.34:443\r\n```\r\n\r\nIt's more or less the same on Linux, according to `strace`.\n\n### curl/libcurl version\n\n```\r\ncurl 8.7.0-DEV (x86_64-unknown-openbsd7.4) libcurl/8.7.0-DEV LibreSSL/3.8.2 zlib/1.3 libidn2/2.3.0 nghttp2/1.57.0\r\nRelease-Date: [unreleased]\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps ipfs ipns mqtt pop3 pop3s rtsp smb smbs smtp smtps telnet tftp\r\nFeatures: alt-svc AsynchDNS HSTS HTTP2 HTTPS-proxy IDN IPv6 Largefile libz NTLM SSL threadsafe UnixSockets\r\n```\r\n\r\nAs well as\r\n```\r\ncurl 8.5.0 (x86_64-unknown-openbsd7.4) libcurl/8.5.0 LibreSSL/3.8.2 zlib/1.3 nghttp2/1.57.0 ngtcp2/0.19.1 nghttp3/0.15.0\r\nRelease-Date: 2023-12-06\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps mqtt pop3 pop3s rtsp smb smbs smtp smtps telnet tftp\r\nFeatures: alt-svc AsynchDNS HSTS HTTP2 HTTP3 HTTPS-proxy IPv6 Largefile libz NTLM NTLM_WB SSL threadsafe UnixSockets\r\n```\r\n```\r\ncurl 7.88.1 (aarch64-unknown-linux-gnu) libcurl/7.88.1 OpenSSL/3.0.11 zlib/1.2.13 brotli/1.0.9 zstd/1.5.4 libidn2/2.3.3 libpsl/0.21.2 (+libidn2/2.3.3) libssh2/1.10.0 nghttp2/1.52.0 librtmp/2.3 OpenLDAP/2.5.13\r\nRelease-Date: 2023-02-20, security patched: 7.88.1-10+deb12u5\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps ldap ldaps mqtt pop3 pop3s rtmp rtsp scp sftp smb smbs smtp smtps telnet tftp\r\nFeatures: alt-svc AsynchDNS brotli GSS-API HSTS HTTP2 HTTPS-proxy IDN IPv6 Kerberos Largefile libz NTLM NTLM_WB PSL SPNEGO SSL threadsafe TLS-SRP UnixSockets zstd\r\n```\r\n```\r\ncurl 8.6.0 (aarch64-unknown-openbsd7.4) libcurl/8.6.0 LibreSSL/3.8.2 zlib/1.3 nghttp2/1.57.0 ngtcp2/0.19.1 nghttp3/0.15.0\r\nRelease-Date: 2024-01-31\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps ipfs ipns mqtt pop3 pop3s rtsp smb smbs smtp smtps telnet tftp\r\nFeatures: alt-svc AsynchDNS HSTS HTTP2 HTTP3 HTTPS-proxy IPv6 Largefile libz NTLM NTLM_WB SSL threadsafe UnixSockets\r\n```\r\n```\r\ncurl 8.4.0 (x86_64-apple-darwin23.0) libcurl/8.4.0 (SecureTransport) LibreSSL/3.3.6 zlib/1.2.12 nghttp2/1.55.1\r\nRelease-Date: 2023-10-11\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps ldap ldaps mqtt pop3 pop3s rtsp smb smbs smtp smtps telnet tftp\r\nFeatures: alt-svc AsynchDNS GSS-API HSTS HTTP2 HTTPS-proxy IPv6 Kerberos Largefile libz MultiSSL NTLM NTLM_WB SPNEGO SSL threadsafe UnixSockets\r\n```\n\n### operating system\n\n```\r\nOpenBSD [hostname] 7.4 GENERIC.MP#2 amd64\r\n```\r\n```\r\nLinux [hostname] 6.1.0-18-arm64 #1 SMP Debian 6.1.76-1 (2024-02-01) aarch64 GNU/Linux\r\n```\r\n```\r\nOpenBSD [hostname] 7.4 GENERIC.MP#2 arm64\r\n```\r\n```\r\nDarwin [hostname] 23.2.0 Darwin Kernel Version 23.2.0: Wed Nov 15 21:53:18 PST 2023; root:xnu-10002.61.3~2/RELEASE_ARM64_T6000 arm64\r\n```","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/13174/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/13174/timeline","performed_via_github_app":null,"state_reason":"completed"}