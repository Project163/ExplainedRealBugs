{"url":"https://api.github.com/repos/curl/curl/issues/11449","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/11449/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/11449/comments","events_url":"https://api.github.com/repos/curl/curl/issues/11449/events","html_url":"https://github.com/curl/curl/issues/11449","id":1807125926,"node_id":"I_kwDOAAiu0c5rto2m","number":11449,"title":"Segmentation fault when sending http3-only request by multi interface","user":{"login":"Cering","id":9027486,"node_id":"MDQ6VXNlcjkwMjc0ODY=","avatar_url":"https://avatars.githubusercontent.com/u/9027486?v=4","gravatar_id":"","url":"https://api.github.com/users/Cering","html_url":"https://github.com/Cering","followers_url":"https://api.github.com/users/Cering/followers","following_url":"https://api.github.com/users/Cering/following{/other_user}","gists_url":"https://api.github.com/users/Cering/gists{/gist_id}","starred_url":"https://api.github.com/users/Cering/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Cering/subscriptions","organizations_url":"https://api.github.com/users/Cering/orgs","repos_url":"https://api.github.com/users/Cering/repos","events_url":"https://api.github.com/users/Cering/events{/privacy}","received_events_url":"https://api.github.com/users/Cering/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141438010,"node_id":"MDU6TGFiZWwxMTQxNDM4MDEw","url":"https://api.github.com/repos/curl/curl/labels/HTTP/3","name":"HTTP/3","color":"97fceb","default":false,"description":"h3 or quic related"},{"id":5296224172,"node_id":"LA_kwDOAAiu0c8AAAABO633rA","url":"https://api.github.com/repos/curl/curl/labels/quiche","name":"quiche","color":"953CA8","default":false,"description":"Cloudflare's QUIC and HTTP/3 library"}],"state":"closed","locked":false,"assignee":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":17,"created_at":"2023-07-17T07:04:10Z","updated_at":"2023-07-19T14:39:09Z","closed_at":"2023-07-19T14:39:08Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!-- Only file bugs here! Ask questions on the mailing lists https://curl.se/mail/\r\n\r\n     SECURITY RELATED? Post it here: https://hackerone.com/curl\r\n\r\n     There are collections of known issues to be aware of:\r\n     https://curl.se/docs/knownbugs.html\r\n     https://curl.se/docs/todo.html       -->\r\n\r\n### I did this\r\n- Send `CURL_HTTP_VERSION_3ONLY` request parallelly by using multi interface\r\n- After some requests finished, a segmentation fault occurred\r\n- This segmentation fault occurred when using the **latest** release version(`libcurl/8.1.2+quiche/0.17.1`), but not found in previous version(`libcurl/8.0.1+quiche/0.16.0`)\r\n\r\n### I expected the following\r\n- Running the test code(see below) in `gdb`, the segmentation fault info: \r\n```\r\nProgram received signal SIGSEGV, Segmentation fault.\r\nbufcp_take (pchunk=<synthetic pointer>, pool=0xc783a8) at bufq.c:191\r\n191         pool->spare = chunk->next;\r\n\r\n(gdb) bt\r\n#0  bufcp_take (pchunk=<synthetic pointer>, pool=0xc783a8) at bufq.c:191\r\n#1  get_spare (q=0xfd67f8) at bufq.c:338\r\n#2  get_non_full_tail (q=q@entry=0xfd67f8) at bufq.c:387\r\n#3  0x00007ffff76818b0 in Curl_bufq_write (q=0xfd67f8, buf=buf@entry=0x7ffff79f19e0 \"HTTP/3 \", len=len@entry=7, err=err@entry=0x7fffffffdabc) at bufq.c:412\r\n#4  0x00007ffff76e6adb in write_resp_raw (data=<optimized out>, mem=mem@entry=0x7ffff79f19e0, memlen=memlen@entry=7, cf=<optimized out>) at vquic/curl_quiche.c:356\r\n#5  0x00007ffff76e6bbc in cb_each_header (name=<optimized out>, name_len=<optimized out>, value=0x139ab50 \"200\", value_len=3, argp=0x7fffffffdb60) at vquic/curl_quiche.c:384\r\n#6  0x00007ffff76fba3c in quiche_h3_event_for_each_header () from /data/yldata/git_workspace/ThirdPartyLibs/libcurl/demo/deps/curl/lib/libcurl.so.4\r\n#7  0x00007ffff76e6fc8 in h3_process_event (ev=0x1373860, stream3_id=0, data=0x615370, cf=0x125ba00) at vquic/curl_quiche.c:515\r\n#8  cf_poll_events (data=0x615370, cf=0x125ba00) at vquic/curl_quiche.c:591\r\n#9  cf_process_ingress (cf=cf@entry=0x125ba00, data=data@entry=0x615370) at vquic/curl_quiche.c:680\r\n#10 0x00007ffff76e709f in cf_quiche_recv () at vquic/curl_quiche.c:841\r\n#11 0x00007ffff76c1117 in Curl_read (data=data@entry=0x615370, sockfd=<optimized out>, buf=buf@entry=0x610430 \"\\210\\235\\337\\366\\377\\177\", \r\n    sizerequested=sizerequested@entry=16384, n=n@entry=0x7fffffffdca0) at sendf.c:415\r\n#12 0x00007ffff76d2950 in readwrite_data (comeback=0x7fffffffdd1f, done=0x7fffffffdd1d, didwhat=<synthetic pointer>, k=0x615440, conn=0x6216f0, data=0x615370)\r\n    at transfer.c:461\r\n#13 Curl_readwrite (conn=0x6216f0, data=data@entry=0x615370, done=done@entry=0x7fffffffdd1d, comeback=comeback@entry=0x7fffffffdd1f) at transfer.c:1115\r\n#14 0x00007ffff76b89e4 in multi_runsingle (multi=multi@entry=0x605010, nowp=nowp@entry=0x7fffffffdd80, data=0x615370) at multi.c:2448\r\n#15 0x00007ffff76ba3aa in curl_multi_perform (multi=0x605010, running_handles=0x7fffffffde9c) at multi.c:2745\r\n#16 0x000000000040275b in main () at /data/yldata/git_workspace/ThirdPartyLibs/libcurl/demo/test.cpp:60\r\n```\r\n\r\n### Test code\r\n```c++\r\n#include <string>\r\n#include <vector>\r\n#include <sstream>\r\n#include <unistd.h>\r\n#include \"curl/curl.h\"\r\n\r\nsize_t mycurl_onrecv_body(char *ptr, size_t size, size_t nmemb, void *userdata)\r\n{\r\n    return size * nmemb;\r\n}\r\n\r\nvoid mycurl_process(CURLM *multi_handle)\r\n{\r\n    CURLMsg *curl_msg = nullptr;\r\n    int msgs_left = 0;\r\n    while((curl_msg = curl_multi_info_read(multi_handle, &msgs_left))) {\r\n        if(curl_msg->msg == CURLMSG_DONE) {\r\n            CURL *http_handle = curl_msg->easy_handle;\r\n            CURLcode code = curl_msg->data.result;\r\n            curl_multi_remove_handle(multi_handle, http_handle);\r\n            printf(\"handle %p finished\\n\", http_handle);\r\n            curl_easy_cleanup(http_handle);\r\n        }\r\n    }\r\n    return;\r\n}\r\n\r\nint main()\r\n{\r\n    curl_global_init(CURL_GLOBAL_ALL);\r\n    printf(\"%s\\n\", curl_version());\r\n\r\n    CURLM *multi_handle = curl_multi_init();\r\n\r\n    int reqid = 0;\r\n    std::vector<std::string> url_list {\r\n        \"https://cloudflare-quic.com/\",\r\n        \"https://cloudflare-quic.com/\",\r\n        \"https://cloudflare-quic.com/\",\r\n    };\r\n\r\n    int count = 5;\r\n    while(count--) {\r\n        int still_running = 0;\r\n        for(auto url : url_list) {\r\n            printf(\"New Request[%d]: %s\\n\", reqid++, url.c_str());\r\n            CURL *http_handle = curl_easy_init();\r\n            curl_easy_setopt(http_handle, CURLOPT_URL, url.c_str());\r\n            curl_easy_setopt(http_handle, CURLOPT_VERBOSE, 1L);\r\n            curl_easy_setopt(http_handle, CURLOPT_WRITEFUNCTION, mycurl_onrecv_body);\r\n            curl_easy_setopt(http_handle, CURLOPT_CONNECTTIMEOUT_MS, 5000L);\r\n            curl_easy_setopt(http_handle, CURLOPT_TIMEOUT_MS, 10000L);\r\n            curl_easy_setopt(http_handle, CURLOPT_HTTP_VERSION, CURL_HTTP_VERSION_3ONLY);\r\n            curl_multi_add_handle(multi_handle, http_handle);\r\n        }\r\n\r\n        do {\r\n            int numfds = 0;\r\n            curl_multi_wait(multi_handle, NULL, 0, 10, &numfds);\r\n            curl_multi_perform(multi_handle, &still_running);\r\n            mycurl_process(multi_handle);\r\n        } while(still_running);\r\n        sleep(5);\r\n    }\r\n\r\n    curl_multi_cleanup(multi_handle);\r\n    return 0;\r\n}\r\n```\r\n\r\n### curl/libcurl version\r\n```bash\r\ncurl 8.1.2 (x86_64-pc-linux-gnu) libcurl/8.1.2 BoringSSL zlib/1.2.7 brotli/1.0.9 nghttp2/1.41.0 quiche/0.17.1\r\nRelease-Date: 2023-05-30\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps mqtt pop3 pop3s rtsp smb smbs smtp smtps telnet tftp\r\nFeatures: alt-svc AsynchDNS brotli HSTS HTTP2 HTTP3 HTTPS-proxy IPv6 Largefile libz NTLM NTLM_WB SSL threadsafe UnixSockets\r\n```\r\n\r\n### operating system\r\n`Linux mylinux 3.10.0-693.21.1.el7.x86_64 #1 SMP Wed Mar 7 19:03:37 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux`\r\n","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/11449/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/11449/timeline","performed_via_github_app":null,"state_reason":"completed"}