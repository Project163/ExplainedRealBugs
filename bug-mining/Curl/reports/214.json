{"url":"https://api.github.com/repos/curl/curl/issues/10879","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/10879/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/10879/comments","events_url":"https://api.github.com/repos/curl/curl/issues/10879/events","html_url":"https://github.com/curl/curl/issues/10879","id":1650467446,"node_id":"I_kwDOAAiu0c5iYCJ2","number":10879,"title":"command \"pytest\" run tests fail---\"connect to 127.0.0.1 port 62651 failed: Connection refused\"","user":{"login":"kwind","id":48575673,"node_id":"MDQ6VXNlcjQ4NTc1Njcz","avatar_url":"https://avatars.githubusercontent.com/u/48575673?v=4","gravatar_id":"","url":"https://api.github.com/users/kwind","html_url":"https://github.com/kwind","followers_url":"https://api.github.com/users/kwind/followers","following_url":"https://api.github.com/users/kwind/following{/other_user}","gists_url":"https://api.github.com/users/kwind/gists{/gist_id}","starred_url":"https://api.github.com/users/kwind/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kwind/subscriptions","organizations_url":"https://api.github.com/users/kwind/orgs","repos_url":"https://api.github.com/users/kwind/repos","events_url":"https://api.github.com/users/kwind/events{/privacy}","received_events_url":"https://api.github.com/users/kwind/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":887227423,"node_id":"MDU6TGFiZWw4ODcyMjc0MjM=","url":"https://api.github.com/repos/curl/curl/labels/tests","name":"tests","color":"a7a8e8","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":1,"created_at":"2023-04-01T13:07:01Z","updated_at":"2023-04-04T12:38:48Z","closed_at":"2023-04-04T12:38:48Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"@bagder hi，like \"https://github.com/curl/curl/issues/10863#issue-1645326971\"\r\nI have similar problem, when run test in directory “curl/tests/http”,such as,\r\n\r\n**I did this**\r\n> \r\ncurl/tests/http % sudo pytest -k \"test_01_basic\" -vvv\r\nPassword:\r\n================================================ test session starts ================================================\r\nplatform darwin -- Python 3.10.10, pytest-7.2.2, pluggy-1.0.0 -- /usr/local/opt/python@3.10/bin/python3.10\r\ncachedir: .pytest_cache\r\nTesting curl 8.1.0-DEV\r\n  httpd: 2.4.56, http:60852 https:60853\r\n  httpd-proxy: 2.4.56, http:60854 https:60855\r\nrootdir: /Users/zhangfugang/code/curl/curl/tests/http\r\ncollected 122 items / 117 deselected / 5 selected                                                                   \r\n\r\ntest_01_basic.py::TestBasic::test_01_01_http_get ERROR                                                        [ 20%]\r\ntest_01_basic.py::TestBasic::test_01_02_https_get ERROR                                                       [ 40%]\r\ntest_01_basic.py::TestBasic::test_01_03_h2_get ERROR                                                          [ 60%]\r\ntest_01_basic.py::TestBasic::test_01_04_h2_unsupported ERROR                                                  [ 80%]\r\ntest_01_basic.py::TestBasic::test_01_05_h3_get SKIPPED (h3 not supported)                                     [100%]\r\n\r\n====================================================== ERRORS =======================================================\r\n__________________________________ ERROR at setup of TestBasic.test_01_01_http_get __________________________________\r\n\r\nenv = <testenv.env.Env object at 0x109945750>\r\n\r\n    @pytest.fixture(scope='package')\r\n    def httpd(env) -> Httpd:\r\n        httpd = Httpd(env=env)\r\n        assert httpd.exists(), f'httpd not found: {env.httpd}'\r\n        httpd.clear_logs()\r\n>       assert httpd.start()\r\nE       assert False\r\nE        +  where False = <bound method Httpd.start of <testenv.httpd.Httpd object at 0x109a0a3e0>>()\r\nE        +    where <bound method Httpd.start of <testenv.httpd.Httpd object at 0x109a0a3e0>> = <testenv.httpd.Httpd object at 0x109a0a3e0>.start\r\n\r\nconftest.py:62: AssertionError\r\n------------------------------------------------ Captured log setup -------------------------------------------------\r\nDEBUG    testenv.httpd:httpd.py:182 Server still not responding after 0:00:05\r\n_________________________________ ERROR at setup of TestBasic.test_01_02_https_get __________________________________\r\n\r\nenv = <testenv.env.Env object at 0x109945750>\r\n\r\n    @pytest.fixture(scope='package')\r\n    def httpd(env) -> Httpd:\r\n        httpd = Httpd(env=env)\r\n        assert httpd.exists(), f'httpd not found: {env.httpd}'\r\n        httpd.clear_logs()\r\n>       assert httpd.start()\r\nE       assert False\r\nE        +  where False = <bound method Httpd.start of <testenv.httpd.Httpd object at 0x109a0a3e0>>()\r\nE        +    where <bound method Httpd.start of <testenv.httpd.Httpd object at 0x109a0a3e0>> = <testenv.httpd.Httpd object at 0x109a0a3e0>.start\r\n\r\nconftest.py:62: AssertionError\r\n___________________________________ ERROR at setup of TestBasic.test_01_03_h2_get ___________________________________\r\n\r\nenv = <testenv.env.Env object at 0x109945750>\r\n\r\n    @pytest.fixture(scope='package')\r\n    def httpd(env) -> Httpd:\r\n        httpd = Httpd(env=env)\r\n        assert httpd.exists(), f'httpd not found: {env.httpd}'\r\n        httpd.clear_logs()\r\n>       assert httpd.start()\r\nE       assert False\r\nE        +  where False = <bound method Httpd.start of <testenv.httpd.Httpd object at 0x109a0a3e0>>()\r\nE        +    where <bound method Httpd.start of <testenv.httpd.Httpd object at 0x109a0a3e0>> = <testenv.httpd.Httpd object at 0x109a0a3e0>.start\r\n\r\nconftest.py:62: AssertionError\r\n_______________________________ ERROR at setup of TestBasic.test_01_04_h2_unsupported _______________________________\r\n\r\nenv = <testenv.env.Env object at 0x109945750>\r\n\r\n    @pytest.fixture(scope='package')\r\n    def httpd(env) -> Httpd:\r\n        httpd = Httpd(env=env)\r\n        assert httpd.exists(), f'httpd not found: {env.httpd}'\r\n        httpd.clear_logs()\r\n>       assert httpd.start()\r\nE       assert False\r\nE        +  where False = <bound method Httpd.start of <testenv.httpd.Httpd object at 0x109a0a3e0>>()\r\nE        +    where <bound method Httpd.start of <testenv.httpd.Httpd object at 0x109a0a3e0>> = <testenv.httpd.Httpd object at 0x109a0a3e0>.start\r\n\r\nconftest.py:62: AssertionError\r\n============================================== short test summary info ==============================================\r\nERROR test_01_basic.py::TestBasic::test_01_01_http_get - assert False\r\nERROR test_01_basic.py::TestBasic::test_01_02_https_get - assert False\r\nERROR test_01_basic.py::TestBasic::test_01_03_h2_get - assert False\r\nERROR test_01_basic.py::TestBasic::test_01_04_h2_unsupported - assert False\r\n=================================== 1 skipped, 117 deselected, 4 errors in 11.96s ==...\r\n\r\n**The curl code branch**\r\n curl/tests/http % git branch -a\r\n* master\r\nremotes/origin/HEAD -> origin/master\r\n......\r\n\r\n**the commit id:**\r\ncurl/tests/http % git log\r\ncommit 0409f633202abf064d070008b5832cc240f110db (HEAD -> master, origin/master, origin/HEAD)\r\nAuthor: Viktor Szakats <commit@vsz.me>\r\nDate:   Fri Mar 31 18:03:43 2023 +0000\r\n\r\n    cmake: do not add zlib headers for openssl\r\n......\r\n\r\n**But runtests.pl is success，as follows**：\r\ncurl/tests % ./runtests.pl 3 -s\r\n********* System characteristics ******** \r\n* curl 8.1.0-DEV (x86_64-apple-darwin22.1.0) \r\n* libcurl/8.1.0-DEV OpenSSL/3.1.0 zlib/1.2.11 libidn2/2.3.4 nghttp2/1.52.0\r\n* Features: alt-svc AsynchDNS Debug HSTS HTTP2 HTTPS-proxy IDN IPv6 Largefile libz NTLM NTLM_WB SSL threadsafe TLS-SRP TrackMemory UnixSockets\r\n* Disabled: \r\n* Host: B-Q1BDMD6R-2034.local\r\n* System: Darwin B-Q1BDMD6R-2034.local 22.1.0 Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64 x86_64\r\n* OS: darwin\r\n*\r\n*** DISABLES memory tracking when using threaded resolver\r\n*\r\n* Servers: SSL HTTP-IPv6 HTTP-unix FTP-IPv6 \r\n* Env: \r\n* Seed: 206474\r\n***************************************** \r\ntest 0003...OK (1   out of 1  , remaining: 00:00, took 1.417s, duration: 00:01)\r\nTESTDONE: 1 tests were considered during 1 seconds.\r\nTESTDONE: 1 tests out of 1 reported OK: 100%\r\n\r\n\r\n**the curl.trace:**\r\n15:19:37.125160 == Info: !!! WARNING !!!\r\n15:19:37.125763 == Info: This is a debug build of libcurl, do not use in production.\r\n15:19:37.125789 == Info: Added one.http.curl.se:60852:127.0.0.1 to DNS cache\r\n15:19:37.125802 == Info: STATE: INIT => CONNECT handle 0x7f8ab1011c08; line 1950 (connection #-5000)\r\n15:19:37.125853 == Info: Added connection 0. The cache now contains 1 members\r\n15:19:37.125863 == Info: Hostname one.http.curl.se was found in DNS cache\r\n15:19:37.125874 == Info: STATE: CONNECT => CONNECTING handle 0x7f8ab1011c08; line 2003 (connection #0)\r\n15:19:37.125951 == Info: Trying 127.0.0.1:60852...\r\n15:19:37.126069 == Info: connect to 127.0.0.1 port 60852 failed: Connection refused\r\n15:19:37.126083 == Info: Failed to connect to one.http.curl.se port 60852 after 0 ms: Couldn't connect to server\r\n15:19:37.126092 == Info: multi_done: status: 7 prem: 1 done: 0\r\n15:19:37.126101 == Info: multi_done, not re-using connection=0, forbid=0, close=0, premature=1, conn_multiplex=0\r\n15:19:37.126109 == Info: The cache now contains 0 members\r\n15:19:37.126114 == Info: Curl_disconnect(conn #0, dead=1)\r\n15:19:37.126123 == Info: Closing connection 0\r\n15:19:37.126132 == Info: Expire cleared (transfer 0x7f8ab1011c08)\r\n\r\n**I expected the following**\r\nThe pytest command is successful.\r\n\r\n**curl/libcurl version**\r\ncurl 8.0.1-DEV (x86_64-apple-darwin22.1.0) libcurl/8.0.1-DEV OpenSSL/3.1.0 zlib/1.2.11 libidn2/2.3.4 nghttp2/1.52.0\r\nRelease-Date: [unreleased]\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps ldap ldaps mqtt pop3 pop3s rtsp smb smbs smtp smtps telnet tftp\r\nFeatures: alt-svc AsynchDNS HSTS HTTP2 HTTPS-proxy IDN IPv6 Largefile libz NTLM NTLM_WB SSL threadsafe TLS-SRP UnixSockets\r\n\r\n**operating system**\r\nDarwin B-Q1BDMD6R-2034.local 22.1.0 Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64 x86_64","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/10879/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/10879/timeline","performed_via_github_app":null,"state_reason":"completed"}