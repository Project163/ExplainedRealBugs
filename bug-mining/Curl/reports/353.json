{"url":"https://api.github.com/repos/curl/curl/issues/12367","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/12367/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/12367/comments","events_url":"https://api.github.com/repos/curl/curl/issues/12367/events","html_url":"https://github.com/curl/curl/issues/12367","id":2002210591,"node_id":"I_kwDOAAiu0c53V08f","number":12367,"title":"Bug when reusing CURL handle which was used for FTP download before","user":{"login":"ohyeaah","id":56166150,"node_id":"MDQ6VXNlcjU2MTY2MTUw","avatar_url":"https://avatars.githubusercontent.com/u/56166150?v=4","gravatar_id":"","url":"https://api.github.com/users/ohyeaah","html_url":"https://github.com/ohyeaah","followers_url":"https://api.github.com/users/ohyeaah/followers","following_url":"https://api.github.com/users/ohyeaah/following{/other_user}","gists_url":"https://api.github.com/users/ohyeaah/gists{/gist_id}","starred_url":"https://api.github.com/users/ohyeaah/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ohyeaah/subscriptions","organizations_url":"https://api.github.com/users/ohyeaah/orgs","repos_url":"https://api.github.com/users/ohyeaah/repos","events_url":"https://api.github.com/users/ohyeaah/events{/privacy}","received_events_url":"https://api.github.com/users/ohyeaah/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":192515830,"node_id":"MDU6TGFiZWwxOTI1MTU4MzA=","url":"https://api.github.com/repos/curl/curl/labels/needs-info","name":"needs-info","color":"fbca04","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2023-11-20T13:28:21Z","updated_at":"2023-11-26T16:51:08Z","closed_at":"2023-11-26T16:51:08Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\r\n\r\n**In short**\r\nIf you reuse a CURL handle in PHP the HTTP code (CURLINFO_HTTP_CODE) may come from a previous FTP request.\r\n\r\n**Long description**\r\nI use CURL to download an FTP file in PHP. Later I reuse the handle to download an HTTPS file from a completely different host.\r\n\r\nThe HTTPS connection successfully downloads the file but the HTTP return code reported by CURL is 221 which comes from the FTP connection of the previous request.\r\n\r\nI traced the FTP connection in Wireshark and it looks like this:\r\n\r\n```\r\n226 Transfer completed.\r\nQUIT\r\n221 Goodbye.\r\n```\r\n\r\nSo here again what I do and what probably happens behind the scenes:\r\n\r\n1. I use CURL to download a file from an FTP server. CURLINFO_HTTP_CODE is 226 (everything good).\r\n2. CURL will leave the FTP connection open because it may be needed again later (everything good).\r\n3. I reuse the CURL handle to download a file from an HTTPS server of a completely different host (everything good).\r\n4. CURL receives the HTTP header and after that it downloads let's say 50% of the file (everything good).\r\n5. While the HTTP download is running, CURL decides to close the FTP connection of the previous request (everything good).\r\n6. The FTP server replies \"221 Goodbye.\" This overwrites the valid HTTP code with an invalid value of a previous request (221) (not good).\r\n7. The HTTP download finishes but the CURLINFO_HTTP_CODE (221) is invalid and of a previous FTP request (not good).\r\n\r\nI am using PHP 8.2.10-2ubuntu1 and curl_version() reports 8.2.1.\r\n\r\nI reported this here because I thought it's probably more a CURL bug than a PHP bug.\r\n\r\n\r\n### I expected the following\r\n\r\nAt the end I expected CURLINFO_HTTP_CODE to report the HTTP code of the last request.\r\n\r\n### curl/libcurl version\r\n\r\nPHP curl plugin 8.2.1\r\n\r\n### operating system\r\n\r\nKUbuntu 23.10","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/12367/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/12367/timeline","performed_via_github_app":null,"state_reason":"completed"}