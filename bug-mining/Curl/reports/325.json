{"url":"https://api.github.com/repos/curl/curl/issues/12002","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/12002/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/12002/comments","events_url":"https://api.github.com/repos/curl/curl/issues/12002/events","html_url":"https://github.com/curl/curl/issues/12002","id":1920552739,"node_id":"I_kwDOAAiu0c5yeU8j","number":12002,"title":"Data race in ftp test server","user":{"login":"dfandrich","id":228259,"node_id":"MDQ6VXNlcjIyODI1OQ==","avatar_url":"https://avatars.githubusercontent.com/u/228259?v=4","gravatar_id":"","url":"https://api.github.com/users/dfandrich","html_url":"https://github.com/dfandrich","followers_url":"https://api.github.com/users/dfandrich/followers","following_url":"https://api.github.com/users/dfandrich/following{/other_user}","gists_url":"https://api.github.com/users/dfandrich/gists{/gist_id}","starred_url":"https://api.github.com/users/dfandrich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dfandrich/subscriptions","organizations_url":"https://api.github.com/users/dfandrich/orgs","repos_url":"https://api.github.com/users/dfandrich/repos","events_url":"https://api.github.com/users/dfandrich/events{/privacy}","received_events_url":"https://api.github.com/users/dfandrich/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118265,"node_id":"MDU6TGFiZWwxODQxMTgyNjU=","url":"https://api.github.com/repos/curl/curl/labels/FTP","name":"FTP","color":"bfd4f2","default":false,"description":null},{"id":887227423,"node_id":"MDU6TGFiZWw4ODcyMjc0MjM=","url":"https://api.github.com/repos/curl/curl/labels/tests","name":"tests","color":"a7a8e8","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"dfandrich","id":228259,"node_id":"MDQ6VXNlcjIyODI1OQ==","avatar_url":"https://avatars.githubusercontent.com/u/228259?v=4","gravatar_id":"","url":"https://api.github.com/users/dfandrich","html_url":"https://github.com/dfandrich","followers_url":"https://api.github.com/users/dfandrich/followers","following_url":"https://api.github.com/users/dfandrich/following{/other_user}","gists_url":"https://api.github.com/users/dfandrich/gists{/gist_id}","starred_url":"https://api.github.com/users/dfandrich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dfandrich/subscriptions","organizations_url":"https://api.github.com/users/dfandrich/orgs","repos_url":"https://api.github.com/users/dfandrich/repos","events_url":"https://api.github.com/users/dfandrich/events{/privacy}","received_events_url":"https://api.github.com/users/dfandrich/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"dfandrich","id":228259,"node_id":"MDQ6VXNlcjIyODI1OQ==","avatar_url":"https://avatars.githubusercontent.com/u/228259?v=4","gravatar_id":"","url":"https://api.github.com/users/dfandrich","html_url":"https://github.com/dfandrich","followers_url":"https://api.github.com/users/dfandrich/followers","following_url":"https://api.github.com/users/dfandrich/following{/other_user}","gists_url":"https://api.github.com/users/dfandrich/gists{/gist_id}","starred_url":"https://api.github.com/users/dfandrich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dfandrich/subscriptions","organizations_url":"https://api.github.com/users/dfandrich/orgs","repos_url":"https://api.github.com/users/dfandrich/repos","events_url":"https://api.github.com/users/dfandrich/events{/privacy}","received_events_url":"https://api.github.com/users/dfandrich/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":3,"created_at":"2023-10-01T04:32:20Z","updated_at":"2023-10-07T18:57:08Z","closed_at":"2023-10-07T18:21:14Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nI've seen many FTP tests failing that have appear to result in a control message intended for one FTP client to be given to the next client. This results in a test log like [this one](https://ci.appveyor.com/project/curlorg/curl/builds/48163187/job/2w2p45db69fhenor?fullLog=true) (test 1091). The client errors out with `curl: (8) Got a 226 ftp-server response when 220 was expected` in this case.\r\n\r\nWhat appears to happen (with timestamps from the sample `ftp_server.log` in the log above) is as follows:\r\n\r\n1.  06:55:04.575219 the test server verification runs to perform a dummy FTP transfer (downloading \"verifiedserver\") as a client and start requesting a transfer.\r\n2. 06:55:04.616714 client connects to data socket\r\n3. 06:55:21.341029 client downloads \"verifiedserver\" and server closes the data socket\r\n4. (speculation) client immediately closes control socket, since verification is complete\r\n5. 06:55:21.341158 server sends the `226 File transfer complete` status code on the control connection (which was just closedâ€”race is somewhere here)\r\n6. server is delayed due to overloaded server (?)\r\n7. test harness starts running the new curl FTP client which connects to the test server control port\r\n8. 06:55:21.341270 test server finally gets scheduled to run and sends the 226 response on the control socket, but it's a new socket so it goes to the new client. Is it then immediately notified that the client has DISConnected.\r\n9. client expects the 220 welcome banner message as the first thing it gets and not 226 so it errors out and exits.\r\n10. 06:55:21.344454 test server is notified that client has disconnected\r\n\r\nThere are some problems with the simple explanation of this scenario:\r\n- The timestamps make it unlikely to be completely accurate. Step 6 (server delayed) happens between two log messages only 112 microseconds apart.  It's more likely an issue with bad buffering or reusing sockets.\r\n- Step 4. could only be true if curl does not wait for a 226 response after a transfer (I don't know offhand if it does or not).\r\n- The \"verifiedserver\" check takes 17 seconds (!) between the client requesting EPSV and the 226 response from the server. This is pretty suspicious, and leads credence to the theory that there's actually some bad connection lifetime management going on in the test server.\r\n\r\nThe  `ftp_sockctrl.log` is probably the most explicit in showing what's going on. Some excerpts:\r\n- 06:55:17.140000 Client disconnect\r\n- 06:55:17.203000 Client connect\r\n- 06:55:20.890000 '226 File transfer complete\\r\\n'\r\n\r\nI'm not sure if the client here is actually the test server or curl, but it doesn't really matter. It's showing that it's sending a 226 code (response to a completed file transfer) as the first thing to a new client that just connected.\r\n\n\n### I expected the following\n\nTest servers should not have race conditions.\n\n### curl/libcurl version\n\n8.4.0-DEV\n\n### operating system\n\nThe sample log comes from mingw-w64, and this problem likely happens more often on Windows, but it may have happen on other OSes as well.","closed_by":{"login":"dfandrich","id":228259,"node_id":"MDQ6VXNlcjIyODI1OQ==","avatar_url":"https://avatars.githubusercontent.com/u/228259?v=4","gravatar_id":"","url":"https://api.github.com/users/dfandrich","html_url":"https://github.com/dfandrich","followers_url":"https://api.github.com/users/dfandrich/followers","following_url":"https://api.github.com/users/dfandrich/following{/other_user}","gists_url":"https://api.github.com/users/dfandrich/gists{/gist_id}","starred_url":"https://api.github.com/users/dfandrich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dfandrich/subscriptions","organizations_url":"https://api.github.com/users/dfandrich/orgs","repos_url":"https://api.github.com/users/dfandrich/repos","events_url":"https://api.github.com/users/dfandrich/events{/privacy}","received_events_url":"https://api.github.com/users/dfandrich/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/12002/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/12002/timeline","performed_via_github_app":null,"state_reason":"completed"}