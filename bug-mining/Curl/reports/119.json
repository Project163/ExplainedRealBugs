{"url":"https://api.github.com/repos/curl/curl/issues/9017","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/9017/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/9017/comments","events_url":"https://api.github.com/repos/curl/curl/issues/9017/events","html_url":"https://github.com/curl/curl/issues/9017","id":1272153209,"node_id":"I_kwDOAAiu0c5L04R5","number":9017,"title":"Cannot compile with CMake on macOS 12.2.1 if option `CURL_USE_GSSAPI` is On","user":{"login":"kuklinistvan","id":19473224,"node_id":"MDQ6VXNlcjE5NDczMjI0","avatar_url":"https://avatars.githubusercontent.com/u/19473224?v=4","gravatar_id":"","url":"https://api.github.com/users/kuklinistvan","html_url":"https://github.com/kuklinistvan","followers_url":"https://api.github.com/users/kuklinistvan/followers","following_url":"https://api.github.com/users/kuklinistvan/following{/other_user}","gists_url":"https://api.github.com/users/kuklinistvan/gists{/gist_id}","starred_url":"https://api.github.com/users/kuklinistvan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kuklinistvan/subscriptions","organizations_url":"https://api.github.com/users/kuklinistvan/orgs","repos_url":"https://api.github.com/users/kuklinistvan/repos","events_url":"https://api.github.com/users/kuklinistvan/events{/privacy}","received_events_url":"https://api.github.com/users/kuklinistvan/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184123162,"node_id":"MDU6TGFiZWwxODQxMjMxNjI=","url":"https://api.github.com/repos/curl/curl/labels/cmake","name":"cmake","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-06-15T12:22:05Z","updated_at":"2022-12-02T22:43:07Z","closed_at":"2022-12-02T22:43:07Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\r\n\r\nI attempted to compile Curl in a CMake project by adding the repository as a subproject. After seemingly successful configuration I've encountered the following error:\r\n\r\n```\r\n/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/include/sys/_types/_in_addr_t.h:31:25: error: 'type-name' cannot be signed or unsigned\r\ntypedef __uint32_t      in_addr_t;      /* base type for internet address */\r\n                        ^\r\n/Users/ikuklin/Desktop/BMOD_4310_src/curl_api_client_build/deps/curl/lib/curl_config.h:994:19: note: expanded from macro 'in_addr_t'\r\n#define in_addr_t unsigned long\r\n```\r\n\r\nI began investigating and I traced back the issue as follows:\r\n\r\n1. I noticed a high amount of platform checking tests failing on which I first thought Xcode was not correctly installed. Among them there were these lines:\r\n\r\n```\r\n-- Performing Curl Test HAVE_IN_ADDR_T\r\n-- Performing Curl Test HAVE_IN_ADDR_T - Failed\r\n```\r\n\r\nIf my perception is right then these are done to ensure compatibility among the supported platforms and provide the missing features through the generated portions of `curl_config.h` in case if something is missing. In my case `in_addr_t` was falsely assumed missing and therefore a define was generated to aid that which clashed with the already existing `in_addr_t` type on my system.\r\n\r\n2. I examined how `CurlTests.c` and `curl_internal_test` macro works to find out why that happened. For context initially I set `CURL_USE_GSSAPI` On for the reason the [version of curl forked by Apple](https://opensource.apple.com/tarballs/curl/curl-121.40.2.tar.gz) suggested so in `README.Apple` inside the tarball. \r\n\r\nI printed out in `Macros.cmake` at `try_compile()` call `MACRO_CHECK_FUNCTION_DEFINITIONS` \r\n\r\n```cmake\r\n    try_compile(${CURL_TEST}\r\n      ${CMAKE_BINARY_DIR}\r\n      ${CMAKE_CURRENT_SOURCE_DIR}/CMake/CurlTests.c\r\n      CMAKE_FLAGS -DCOMPILE_DEFINITIONS:STRING=${MACRO_CHECK_FUNCTION_DEFINITIONS}\r\n      \"${CURL_TEST_ADD_LIBRARIES}\"\r\n      OUTPUT_VARIABLE OUTPUT)\r\n```\r\n\r\nand it looked like so (notice the end):\r\n\r\n```\r\n-- -DCOMPILE_DEFINITIONS:STRING=-DHAVE_IN_ADDR_T  -DHAVE_LDAP_H -DHAVE_LBER_H -DHAVE_GSSAPI_GSSAPI_H -DHAVE_GSSAPI_GSSAPI_GENERIC_H -DHAVE_GSSAPI_GSSAPI_KRB5_H -DHAVE_INTTYPES_H -DHAVE_SYS_SOCKET_H -DHAVE_SYS_TIME_H -DHAVE_SYS_TYPES_H -DHAVE_ARPA_INET_H -DHAVE_FCNTL_H -DHAVE_NETDB_H -DHAVE_NETINET_IN_H -DHAVE_PWD_H -DHAVE_STDINT_H -DHAVE_TIME_H -DHAVE_UNISTD_H -DHAVE_STDDEF_H -DHAVE_STDINT_H  -dynamic -Wl,-search_paths_first\r\n```\r\n\r\nSince this is passed to argument `CMAKE_FLAGS` of `try_compile()` it turns out that it fails (silently I think) and instead of skipping the one garbage part that it cannot handle (`-dynamic -Wl,-search_paths_first`) or cause a fatal error, it just omits the compiler flags.\r\n\r\nTo prove this I intentionally caused a fatal error just after the test `HAVE_IN_ADDR_T` failed and with `--debug-trycompile` enabled and examined the build environment for the feature test. None of the defines were passed over to the compiler. After I quickly have found a way to prevent the part `-dynamic -Wl,-search_paths_first` being passed to `CMAKE_FLAGS` not only the test passed but the whole build process has healed itself.\r\n\r\n3. With `variable_watch` I traced back where `-dynamic -Wl,-search_paths_first` came from:\r\n\r\n* Into `CMAKE_FLAGS` it was passed through the variable `${MACRO_CHECK_FUNCTION_DEFINITIONS}`, \r\n* a couple lines earlier it was concatenated from `${CMAKE_REQUIRED_FLAGS}`,\r\n\r\n```\r\n      foreach(_dir ${GSS_LINK_DIRECTORIES})\r\n        set(_LINKER_FLAGS_STR \"${_LINKER_FLAGS_STR} -L\\\"${_dir}\\\"\")\r\n      endforeach()\r\n\r\n      set(CMAKE_REQUIRED_FLAGS \"${_COMPILER_FLAGS_STR} ${_LINKER_FLAGS_STR}\")\r\n```\r\n\r\n* which was set in the top `CMakeLists.txt` by concatenating `${_LINKER_FLAGS_STR}`,\r\n\r\n```cmake\r\n      string(REPLACE \";\" \" \" _COMPILER_FLAGS_STR \"${GSS_COMPILER_FLAGS}\")\r\n      string(REPLACE \";\" \" \" _LINKER_FLAGS_STR \"${GSS_LINKER_FLAGS}\")\r\n```\r\n\r\n* which came from `{GSS_LINKER_FLAGS}`,\r\n* that is set by `FindGSS`.\r\n\r\n### curl/libcurl version\r\n\r\nIt both affects master at the time of writing (`134963a5efdc3906257c88ce62dba8d46c292908`) and tag `curl-7_83_1`.\r\n\r\n### operating system\r\n\r\nDarwin MYHOSTNAMEREMOVED 21.3.0 Darwin Kernel Version 21.3.0: Wed Jan  5 21:37:58 PST 2022; root:xnu-8019.80.24~20/RELEASE_X86_64 x86_64\r\n\r\nmacOS 12.2.1 Monterey\r\n\r\nUnfortunately in a couple days I'll no longer have access to this computer so I did my best assemble all the information that should be enough to reproduce the issue.","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/9017/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/9017/timeline","performed_via_github_app":null,"state_reason":"completed"}