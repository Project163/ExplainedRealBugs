{"url":"https://api.github.com/repos/curl/curl/issues/15185","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/15185/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/15185/comments","events_url":"https://api.github.com/repos/curl/curl/issues/15185/events","html_url":"https://github.com/curl/curl/issues/15185","id":2572152673,"node_id":"I_kwDOAAiu0c6ZT-9h","number":15185,"title":"connection bundle use-after-free in Curl_cpool_check_limits when CURLMOPT_MAX_HOST_CONNECTIONS=1","user":{"login":"syntax-case","id":151622651,"node_id":"U_kgDOCQmT-w","avatar_url":"https://avatars.githubusercontent.com/u/151622651?v=4","gravatar_id":"","url":"https://api.github.com/users/syntax-case","html_url":"https://github.com/syntax-case","followers_url":"https://api.github.com/users/syntax-case/followers","following_url":"https://api.github.com/users/syntax-case/following{/other_user}","gists_url":"https://api.github.com/users/syntax-case/gists{/gist_id}","starred_url":"https://api.github.com/users/syntax-case/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/syntax-case/subscriptions","organizations_url":"https://api.github.com/users/syntax-case/orgs","repos_url":"https://api.github.com/users/syntax-case/repos","events_url":"https://api.github.com/users/syntax-case/events{/privacy}","received_events_url":"https://api.github.com/users/syntax-case/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":0,"created_at":"2024-10-08T05:49:50Z","updated_at":"2024-10-08T09:07:25Z","closed_at":"2024-10-08T09:07:24Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\r\n\r\n#### Summary:\r\nIn Curl_cpool_check_limits, there's a loop (conncache.c:319) that removes connections from a bundle until the number of connections is less than the configured maximum.\r\nHowever, if the maximum is 1, the loop will remove all connections, causing the bundle to be deleted in the call to Curl_cpool_disconnect (conncache.c:331).\r\nThis leaves the pointer in Curl_cpool_check_limits dangling, and when the loop condition is checked the freed bundle is accessed.\r\n#### Steps To Reproduce:\r\nWe first noticed this in our valgrind testruns.\r\nA simple way to reproduce it is to hardcode the dest_limit to 1 in Curl_cpool_check_limits, and run a test that exercises this, for example 2032.\r\nIt should fail with valgrind warnings about invalid reads.\r\nThe test stderr should show: * Discarding Connection [#0](https://hackerone.com/reports/0) from 1 to reach destination limit of 1\r\n\r\n### I expected the following\r\n\r\n_No response_\r\n\r\n### curl/libcurl version\r\n\r\ncommit d9a9233afac2000ccf315f6f760e3a016e794b84\r\n\r\n### operating system\r\n\r\nLinux *** 6.8.0-45-generic #45-Ubuntu SMP PREEMPT_DYNAMIC Fri Aug 30 12:02:04 UTC 2024 x86_64 x86_64 x86_64 GNU/Linux\r\n","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/15185/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/15185/timeline","performed_via_github_app":null,"state_reason":"completed"}