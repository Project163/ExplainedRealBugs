{"url":"https://api.github.com/repos/curl/curl/issues/16166","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/16166/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/16166/comments","events_url":"https://api.github.com/repos/curl/curl/issues/16166/events","html_url":"https://github.com/curl/curl/issues/16166","id":2830388841,"node_id":"I_kwDOAAiu0c6otE5p","number":16166,"title":"pop3:// hangs with commit 25b445e4796","user":{"login":"ralfjunker","id":1552416,"node_id":"MDQ6VXNlcjE1NTI0MTY=","avatar_url":"https://avatars.githubusercontent.com/u/1552416?v=4","gravatar_id":"","url":"https://api.github.com/users/ralfjunker","html_url":"https://github.com/ralfjunker","followers_url":"https://api.github.com/users/ralfjunker/followers","following_url":"https://api.github.com/users/ralfjunker/following{/other_user}","gists_url":"https://api.github.com/users/ralfjunker/gists{/gist_id}","starred_url":"https://api.github.com/users/ralfjunker/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ralfjunker/subscriptions","organizations_url":"https://api.github.com/users/ralfjunker/orgs","repos_url":"https://api.github.com/users/ralfjunker/repos","events_url":"https://api.github.com/users/ralfjunker/events{/privacy}","received_events_url":"https://api.github.com/users/ralfjunker/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2025-02-04T14:11:26Z","updated_at":"2025-02-04T22:02:25Z","closed_at":"2025-02-04T22:02:25Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nI identified that starting with commit [25b445e4796bcbf9f842de686a8c384b30f6c2a2] the following causes `curl_easy_perform()` to hang for least a minute (not measured exactly) and eventually returns a timeout.\n\n```C\ncurl_easy_setopt(CURL, CURLOPT_URL, \"pop3://pop.gmx.net\");\ncurl_easy_setopt(CURL, CURLOPT_USE_SSL, CURLUSESSL_ALL);\n\ncurl_easy_setopt(CURL, CURLOPT_CAINFO, CACERT_PEM);\n\ncurl_easy_setopt(CURL, CURLOPT_USERNAME, \"username\");\ncurl_easy_setopt(CURL, CURLOPT_PASSWORD, \"password\");\n\ncurl_easy_setopt(CURL, CURLOPT_CUSTOMREQUEST, \"LIST\");\ncurl_easy_setopt(CURL, CURLOPT_NOBODY, 0);\ncurl_easy_perform(CURL);\n```\n\nIt is important to notice that the problem only happens with the `pop3://` protocol but not with `pop3s://`. Before commit [25b445e4796bcbf9f842de686a8c384b30f6c2a2], `curl_easy_perform()` returned all right for both protocols.\n\nIf I undo https://github.com/curl/curl/commit/25b445e4796bcbf9f842de686a8c384b30f6c2a2#diff-01c026e7bf98e46bfe6f5e8ade0807c917f3ce49d16ab05f415353194e02ac98L1113-R1113, all is fine as well.\n\nHere is the debug output:\n\n```\nlibcurl/8.12.0-DEV OpenSSL/3.4.0 zlib/1.3.1 brotli/1.1.0 zstd/1.5.6 WinIDN libssh2/1.11.1 nghttp2/1.64.0 nghttp3/1.7.0\nProtocols: dict file ftp ftps gopher gophers http https imap imaps ldap ldaps mqtt pop3 pop3s rtsp scp sftp smb smbs smtp smtps telnet tftp ws wss\nFeatures: alt-svc AsynchDNS brotli HSTS HTTP2 HTTP3 HTTPS-proxy IDN IPv6 Kerberos Largefile libz NTLM SPNEGO SSL SSPI threadsafe TLS-SRP Unicode UnixSockets zstd\nSSL backends: openssl\n[READ] client_reset, clear readers\nHost pop.gmx.net:110 was resolved.\nIPv6: (none)\nIPv4: 212.227.17.169, 212.227.17.185\n[SETUP] added\n[HAPPY-EYEBALLS] created ipv4 (timeout 149976ms)\n[HAPPY-EYEBALLS] ipv4 starting (timeout=149976ms)\n  Trying 212.227.17.169:110...\n[TCP] cf_socket_open() -> 0, fd=704\n[TCP] local address 0.0.0.0 port 50270...\n[HAPPY-EYEBALLS] ipv4 connect -> 0, connected=0\n[TCP] adjust_pollset, !connected, POLLOUT fd=704\n[HAPPY-EYEBALLS] adjust_pollset -> 1 socks\n[TCP] not connected yet\n[HAPPY-EYEBALLS] ipv4 connect -> 0, connected=0\n[TCP] adjust_pollset, !connected, POLLOUT fd=704\n[HAPPY-EYEBALLS] adjust_pollset -> 1 socks\n[TCP] not connected yet\n[HAPPY-EYEBALLS] ipv4 connect -> 0, connected=0\n[TCP] adjust_pollset, !connected, POLLOUT fd=704\n[HAPPY-EYEBALLS] adjust_pollset -> 1 socks\n[TCP] not connected yet\n[HAPPY-EYEBALLS] ipv4 connect -> 0, connected=0\n[TCP] adjust_pollset, !connected, POLLOUT fd=704\n[HAPPY-EYEBALLS] adjust_pollset -> 1 socks\n[TCP] connected\n[HAPPY-EYEBALLS] ipv4 connect -> 0, connected=1\n[HAPPY-EYEBALLS] Connected to pop.gmx.net (212.227.17.169) port 110\nConnected to pop.gmx.net (212.227.17.169) port 110\n[TCP] recv(len=900) -> 58, err=0\n< +OK POP server ready H migmx106 1MYe2F-1tsKC001xb-00Wo0z\n[WRITE] download_write header(type=2, blen=58) -> 0\n[WRITE] client_write(type=2, len=58) -> 0\n[TCP] send(len=6) -> 6, err=0\n> CAPA\n[TCP] recv(len=900) -> 79, err=0\n< +OK Capability list follows\n[WRITE] download_write header(type=2, blen=29) -> 0\n[WRITE] client_write(type=2, len=29) -> 0\n< TOP\n[WRITE] download_write header(type=2, blen=5) -> 0\n[WRITE] client_write(type=2, len=5) -> 0\n< UIDL\n[WRITE] download_write header(type=2, blen=6) -> 0\n[WRITE] client_write(type=2, len=6) -> 0\n< STLS\n[WRITE] download_write header(type=2, blen=6) -> 0\n[WRITE] client_write(type=2, len=6) -> 0\n< SASL\n[WRITE] download_write header(type=2, blen=6) -> 0\n[WRITE] client_write(type=2, len=6) -> 0\n< IMPLEMENTATION trinity\n[WRITE] download_write header(type=2, blen=24) -> 0\n[WRITE] client_write(type=2, len=24) -> 0\n< .\n[WRITE] download_write header(type=2, blen=3) -> 0\n[WRITE] client_write(type=2, len=3) -> 0\n[TCP] send(len=6) -> 6, err=0\n> STLS\n[TCP] recv(len=900) -> 27, err=0\n< +OK Begin TLS negotiation\n[WRITE] download_write header(type=2, blen=27) -> 0\n[WRITE] client_write(type=2, len=27) -> 0\n[SSL] added\n[SSL] cf_connect()\n[SSLS] peer not found for pop.gmx.net:110:CA-D:\\path\\cacert.pem:IMPL-OpenSSL/3.4.0\n[SSLS] no cached session for pop.gmx.net:110:CA-D:\\path\\cacert.pem:IMPL-OpenSSL/3.4.0\nTLSv1.3 (OUT), TLS handshake, Client hello (1):\n[TCP] send(len=517) -> 517, err=0\n[SSL] ossl_bio_cf_out_write(len=517) -> 517, err=0\n[TCP] recv(len=5) -> -1, err=81\n[SSL] ossl_bio_cf_in_read(len=5) -> -1, err=81\n[SSL] ossl_populate_x509_store, path=..\\demos\\cacert.pem, blob=0\n CAfile: ..\\demos\\cacert.pem\n CApath: none\n[SSL] SSL_connect() -> err=-1, detail=2\n[SSL] SSL_connect() -> want recv\n[SSL] cf_connect() -> 0, done=0\n[SSL] adjust_pollset, POLLIN fd=704\n[SSL] cf_connect()\n[TCP] recv(len=5) -> 5, err=0\n[SSL] ossl_bio_cf_in_read(len=5) -> 5, err=0\n[TCP] recv(len=122) -> 122, err=0\n[SSL] ossl_bio_cf_in_read(len=122) -> 122, err=0\nTLSv1.3 (IN), TLS handshake, Server hello (2):\n[TCP] recv(len=5) -> 5, err=0\n[SSL] ossl_bio_cf_in_read(len=5) -> 5, err=0\n[TCP] recv(len=1) -> 1, err=0\n[SSL] ossl_bio_cf_in_read(len=1) -> 1, err=0\nTLSv1.3 (IN), TLS change cipher, Change cipher spec (1):\n[TCP] recv(len=5) -> 5, err=0\n[SSL] ossl_bio_cf_in_read(len=5) -> 5, err=0\n[TCP] recv(len=23) -> 23, err=0\n[SSL] ossl_bio_cf_in_read(len=23) -> 23, err=0\nTLSv1.3 (IN), TLS handshake, Encrypted Extensions (8):\n[TCP] recv(len=5) -> 5, err=0\n[SSL] ossl_bio_cf_in_read(len=5) -> 5, err=0\n[TCP] recv(len=3653) -> 3653, err=0\n[SSL] ossl_bio_cf_in_read(len=3653) -> 3653, err=0\nTLSv1.3 (IN), TLS handshake, Certificate (11):\n[TCP] recv(len=5) -> 5, err=0\n[SSL] ossl_bio_cf_in_read(len=5) -> 5, err=0\n[TCP] recv(len=281) -> 281, err=0\n[SSL] ossl_bio_cf_in_read(len=281) -> 281, err=0\nTLSv1.3 (IN), TLS handshake, CERT verify (15):\n[TCP] recv(len=5) -> 5, err=0\n[SSL] ossl_bio_cf_in_read(len=5) -> 5, err=0\n[TCP] recv(len=69) -> 69, err=0\n[SSL] ossl_bio_cf_in_read(len=69) -> 69, err=0\nTLSv1.3 (IN), TLS handshake, Finished (20):\nTLSv1.3 (OUT), TLS change cipher, Change cipher spec (1):\nTLSv1.3 (OUT), TLS handshake, Finished (20):\n[TCP] send(len=80) -> 80, err=0\n[SSL] ossl_bio_cf_out_write(len=80) -> 80, err=0\nSSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384 / x25519 / RSASSA-PSS\nServer certificate:\n subject: C=DE; ST=Rheinland-Pfalz; L=Montabaur; O=1&1 Mail & Media GmbH; CN=mail.gmx.net\n start date: Feb 19 11:27:07 2024 GMT\n expire date: Feb 23 23:59:59 2025 GMT\n subjectAltName: host \"pop.gmx.net\" matched cert's \"pop.gmx.net\"\n issuer: C=DE; O=Deutsche Telekom Security GmbH; CN=Telekom Security ServerID OV Class 2 CA\n SSL certificate verify ok.\n  Certificate level 0: Public key type RSA (2048/112 Bits/secBits), signed using sha256WithRSAEncryption\n  Certificate level 1: Public key type RSA (3072/128 Bits/secBits), signed using sha256WithRSAEncryption\n  Certificate level 2: Public key type RSA (2048/112 Bits/secBits), signed using sha256WithRSAEncryption\n[SSL] cf_connect() -> 0, done=1\nConnected to pop.gmx.net (212.227.17.169) port 110\nserver response timeout\n[WRITE] cw-out done\nclosing connection #0\n[SETUP] close\n[HAPPY-EYEBALLS] close\n[TCP] cf_socket_close(704)\n[TCP] destroy\n[HAPPY-EYEBALLS] destroy\n[SETUP] destroy\n```\n\n### I expected the following\n\n_No response_\n\n### curl/libcurl version\n\nCommit [25b445e4796bcbf9f842de686a8c384b30f6c2a2] and later.\n\n### operating system\n\nWindows 11.","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/16166/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/16166/timeline","performed_via_github_app":null,"state_reason":"completed"}