{"url":"https://api.github.com/repos/curl/curl/issues/10501","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/10501/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/10501/comments","events_url":"https://api.github.com/repos/curl/curl/issues/10501/events","html_url":"https://github.com/curl/curl/issues/10501","id":1583036822,"node_id":"I_kwDOAAiu0c5eWzmW","number":10501,"title":"Windows, Curl_socket_check function will incorrectly report an error on sockets that have data available to read.","user":{"login":"opensslonzos-github","id":53868211,"node_id":"MDQ6VXNlcjUzODY4MjEx","avatar_url":"https://avatars.githubusercontent.com/u/53868211?v=4","gravatar_id":"","url":"https://api.github.com/users/opensslonzos-github","html_url":"https://github.com/opensslonzos-github","followers_url":"https://api.github.com/users/opensslonzos-github/followers","following_url":"https://api.github.com/users/opensslonzos-github/following{/other_user}","gists_url":"https://api.github.com/users/opensslonzos-github/gists{/gist_id}","starred_url":"https://api.github.com/users/opensslonzos-github/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/opensslonzos-github/subscriptions","organizations_url":"https://api.github.com/users/opensslonzos-github/orgs","repos_url":"https://api.github.com/users/opensslonzos-github/repos","events_url":"https://api.github.com/users/opensslonzos-github/events{/privacy}","received_events_url":"https://api.github.com/users/opensslonzos-github/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":192515830,"node_id":"MDU6TGFiZWwxOTI1MTU4MzA=","url":"https://api.github.com/repos/curl/curl/labels/needs-info","name":"needs-info","color":"fbca04","default":false,"description":""},{"id":940032249,"node_id":"MDU6TGFiZWw5NDAwMzIyNDk=","url":"https://api.github.com/repos/curl/curl/labels/Windows","name":"Windows","color":"0e8a16","default":false,"description":"Windows-specific"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2023-02-13T20:45:53Z","updated_at":"2023-02-23T22:42:48Z","closed_at":"2023-02-23T22:42:48Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"On Windows, the Curl_socket_check function will incorrectly report an error on sockets that have data available to read. \r\nThis is because on Windows, the value for POLLIN is 768 and the value for POLLRDBAND is 512. \r\nIn the function Curl_socket_check in select.c, curl checks [pollfd.revents & POLLRDBAND] to determine whether the socket is broken. But, if pollfd.revents = POLLIN, pollfd.revents & POLLRDBAND != 0. This leads to many connections being wrongfully terminated.\r\n\r\nThe bug can be fixed by changing lines 233 and 240 in lib/select.c from \r\n`if(pfd[num].revents & (POLLRDBAND|POLLPRI|POLLNVAL))` \r\nto\r\n `if(pfd[num].revents & (POLLPRI|POLLNVAL))` // (removing the POLLRDBAND check). \r\n\r\nThose lines check whether the socket is dead based on a call to poll. \r\nIf poll sets POLLIN, curl identifies that as an error because on Windows POLLIN =  POLLRDNORM | POLLRDBAND.\r\n\r\n### curl/libcurl version\r\n7.86\r\n\r\n[curl -V output]\r\ncurl 7.86.0 (x86_64-pc-win32) libcurl/7.86.0 OpenSSL/1.1.1n zlib/1.2.12 WinIDN nghttp2/1.42.0\r\nRelease-Date: 2022-10-26\r\nProtocols: http https smtp smtps\r\nFeatures: alt-svc AsynchDNS HSTS HTTP2 HTTPS-proxy IDN IPv6 Largefile libz NTLM SSL threadsafe UnixSockets\r\n\r\n### operating system\r\nWindows 10\r\n<!-- On Unix please post the output of \"uname -a\" -->\r\n","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/10501/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/10501/timeline","performed_via_github_app":null,"state_reason":"completed"}