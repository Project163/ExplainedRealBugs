{"url":"https://api.github.com/repos/curl/curl/issues/10135","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/10135/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/10135/comments","events_url":"https://api.github.com/repos/curl/curl/issues/10135/events","html_url":"https://github.com/curl/curl/issues/10135","id":1507820330,"node_id":"I_kwDOAAiu0c5Z34Mq","number":10135,"title":"curl 7.87.0 test 0313 [CRL test] failing on EL-9","user":{"login":"pghmcfc","id":947224,"node_id":"MDQ6VXNlcjk0NzIyNA==","avatar_url":"https://avatars.githubusercontent.com/u/947224?v=4","gravatar_id":"","url":"https://api.github.com/users/pghmcfc","html_url":"https://github.com/pghmcfc","followers_url":"https://api.github.com/users/pghmcfc/followers","following_url":"https://api.github.com/users/pghmcfc/following{/other_user}","gists_url":"https://api.github.com/users/pghmcfc/gists{/gist_id}","starred_url":"https://api.github.com/users/pghmcfc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pghmcfc/subscriptions","organizations_url":"https://api.github.com/users/pghmcfc/orgs","repos_url":"https://api.github.com/users/pghmcfc/repos","events_url":"https://api.github.com/users/pghmcfc/events{/privacy}","received_events_url":"https://api.github.com/users/pghmcfc/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118221,"node_id":"MDU6TGFiZWwxODQxMTgyMjE=","url":"https://api.github.com/repos/curl/curl/labels/TLS","name":"TLS","color":"bfdadc","default":false,"description":""},{"id":887227423,"node_id":"MDU6TGFiZWw4ODcyMjc0MjM=","url":"https://api.github.com/repos/curl/curl/labels/tests","name":"tests","color":"a7a8e8","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2022-12-22T12:46:16Z","updated_at":"2023-12-16T04:26:16Z","closed_at":"2022-12-26T08:48:59Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\r\nUpdated my curl packaging from 7.86.0 to 7.87.0 and built for current Fedora and RHEL releases (RHEL builds on Rocky Linux, an RHEL clone).\r\n\r\n### I expected the following\r\nAll builds completing successfully. And they did, except for the build on Rocky Linux 9.\r\n\r\n### curl/libcurl version\r\n7.87.0\r\n\r\n[curl -V output]\r\nDon't get as far as a built curl package but here are the system characteristics from the start of the test run:\r\n```\r\n ********* System characteristics ******** \r\n* curl 7.87.0 (x86_64-redhat-linux-gnu)\r\n* libcurl/7.87.0 OpenSSL/3.0.1 zlib/1.2.11 libidn2/2.3.0 nghttp2/1.43.0 \r\n* Features: alt-svc AsynchDNS GSS-API HSTS HTTP2 HTTPS-proxy IDN IPv6 Kerberos Largefile libz SPNEGO SSL threadsafe UnixSockets\r\n* Disabled: \r\n* Host: 329c6f4b6550494fa67371c7360baef3 \r\n* System: Linux 329c6f4b6550494fa67371c7360baef3 6.0.12-300.fc37.x86_64 #1 SMP PREEMPT_DYNAMIC Thu Dec 8 16:58:47 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux\r\n* OS: linux\r\n* Servers: SSL HTTP-IPv6 HTTP-unix FTP-IPv6  \r\n* Env: \r\n* Seed: 264484 \r\n* Unix socket paths:\r\n*   HTTP-Unix:http71383.sock\r\n*   Socks-Unix:/builddir/build/BUILD/curl-7.87.0/build-minimal/tests/socks71383.sock\r\n*****************************************\r\n```\r\n\r\n### operating system\r\nI am building on a Fedora 37 (x86_64) host using a chroot-based build system targeting Rocky Linux 9 (x86_64).\r\n\r\nHere is the build output from the failing test:\r\n```\r\n-------e--- OK (312 out of 1544, remaining: 09:00, took 7.351s, duration: 02:16)\r\nRUN: Process with pid 75961 signalled to die\r\nRUN: Process with pid 75977 signalled to die\r\nRUN: Process with pid 75981 signalled to die\r\nRUN: Process with pid 75981 gracefully died\r\nRUN: Process with pid 75961 forced to die with SIGKILL\r\nRUN: Process with pid 75977 forced to die with SIGKILL \r\nstartnew: perl -I../../tests ../../tests/httpserver.pl --pidfile \".http_server.pid\" --logfile \"log/http_server.log\" --portfile .http_server.port --ipv4 --port 0 --srcdir \"../../tests/data/..\" \r\nRUN: ../src/curl --max-time 13 --output log/http_verify.out --silent --verbose --globoff \"http://127.0.0.1:35713/verifiedserver\" 2>log/http_verify.log\r\nCMD (0): ../src/curl --max-time 13 --output log/http_verify.out --silent --verbose --globoff \"http://127.0.0.1:35713/verifiedserver\" 2>log/http_verify.log\r\nRUN: HTTP server is on PID 76002 port 35713\r\n* pid http => 76002 76002\r\nstartnew: perl -I../../tests ../../tests/secureserver.pl --pidfile \".https_server.pid\" --logfile \"log/https_stunnel.log\" --ipv4 --proto https --certfile \"Server-localhost-sv.pem\" --stunnel \"/usr/bin/stunnel\" --srcdir \"../../tests\" --connect 35713 --accept 25073\r\nRUN: HTTPS server is PID 76018 port 25073\r\n* pid https => 76018 76022\r\nprechecked /usr/bin/perl -e \"print 'Test requires default test server host' if ( '127.0.0.1' ne '127.0.0.1' );\"\r\ntest 0313...[CRL test]\r\n../src/curl --output log/curl313.out  --include --trace-ascii log/trace313 --trace-time --cacert ../../tests/certs/EdelCurlRoot-ca.crt --crlfile ../../tests/certs/Server-localhost-sv.crl https://localhost:25073/313 >log/stdout313 2>log/stderr313\r\nCMD (8960): ../src/curl --output log/curl313.out  --include --trace-ascii log/trace313 --trace-time --cacert ../../tests/certs/EdelCurlRoot-ca.crt --crlfile ../../tests/certs/Server-localhost-sv.crl https://localhost:25073/313 >log/stdout313 2>log/stderr313\r\ncurl returned 35, when expecting 60\r\n exit FAILED \r\n== Contents of files in the log/ dir after test 313\r\n=== Start of file commands.log\r\n ../src/curl --output log/curl313.out  --include --trace-ascii log/trace313 --trace-time --cacert ../../tests/certs/EdelCurlRoot-ca.crt --crlfile ../../tests/certs/Server-localhost-sv.crl https://localhost:25073/313 >log/stdout313 2>log/stderr313\r\n=== End of file commands.log \r\n=== Start of file ftpserver.cmd\r\n Testnum 313\r\n=== End of file ftpserver.cmd\r\n=== Start of file http_server.log\r\n 22:21:17.184802 exit_signal_handler: 15\r\n 22:21:17.185144 signalled to die\r\n 22:21:17.185232 ========> IPv4 sws (port 37921 pid: 75961) exits with signal (15)\r\n 22:21:22.245861 Running HTTP IPv4 version on port 35713\r\n 22:21:22.245946 Wrote pid 76002 to .http_server.pid\r\n 22:21:22.245973 Wrote port 35713 to .http_server.port\r\n 22:21:23.244589 ====> Client connect\r\n 22:21:23.244675 accept_connection 3 returned 4\r\n 22:21:23.244725 accept_connection 3 returned 0\r\n 22:21:23.244766 Read 93 bytes\r\n 22:21:23.244797 Process 93 bytes request\r\n 22:21:23.244845 Got request: GET /verifiedserver HTTP/1.1\r\n 22:21:23.244872 Are-we-friendly question received\r\n 22:21:23.244922 Wrote request (93 bytes) input to log/server.input\r\n 22:21:23.244981 Identifying ourselves as friends\r\n 22:21:23.245205 Response sent (56 bytes) and written to log/server.response\r\n 22:21:23.245244 special request received, no persistency\r\n 22:21:23.245266 ====> Client disconnect 0\r\n=== End of file http_server.log\r\n=== Start of file http_verify.log\r\n *   Trying 127.0.0.1:35713...\r\n * Connected to 127.0.0.1 (127.0.0.1) port 35713 (#0)\r\n > GET /verifiedserver HTTP/1.1\r\n > Host: 127.0.0.1:35713\r\n > User-Agent: curl/7.87.0\r\n > Accept: */*\r\n >\r\n * Mark bundle as not supporting multiuse\r\n < HTTP/1.1 200 OK\r\n < Content-Length: 17\r\n <\r\n { [1 bytes data]\r\n * Connection #0 to host 127.0.0.1 left intact\r\n=== End of file http_verify.log\r\n=== Start of file http_verify.out\r\n WE ROOLZ: 76002\r\n=== End of file http_verify.out\r\n=== Start of file https_stunnel.log\r\n 2022.12.21 22:21:23 LOG5[ui]: stunnel 5.62 on x86_64-redhat-linux-gnu platform\r\n 2022.12.21 22:21:23 LOG5[ui]: Compiled/running with OpenSSL 3.0.1 14 Dec 2021\r\n 2022.12.21 22:21:23 LOG5[ui]: Threading:PTHREAD Sockets:POLL,IPv6 TLS:ENGINE,FIPS,OCSP,PSK,SNI\r\n 2022.12.21 22:21:23 LOG5[ui]: Reading configuration from file /builddir/build/BUILD/curl-7.87.0/build-minimal/tests/https_stunnel.conf\r\n 2022.12.21 22:21:23 LOG5[ui]: UTF-8 byte order mark not detected\r\n 2022.12.21 22:21:23 LOG5[ui]: FIPS mode disabled\r\n 2022.12.21 22:21:23 LOG5[ui]: Configuration successful\r\n 2022.12.21 22:21:23 LOG5[ui]: Binding service [curltest] to :::25073: Address already in use (98)\r\n 2022.12.21 22:21:23 LOG5[cron]: Updating DH parameters\r\n 2022.12.21 22:21:24 LOG5[0]: Service [curltest] accepted connection from 127.0.0.1:47430\r\n 2022.12.21 22:21:24 LOG3[0]: SSL_accept: ssl/record/rec_layer_s3.c:1584: error:0A00041B:SSL routines::tlsv1 alert decrypt error\r\n 2022.12.21 22:21:24 LOG5[0]: Connection reset: 0 byte(s) sent to TLS, 0 byte(s) sent to socket\r\n=== End of file https_stunnel.log\r\n=== Start of file server.response\r\n HTTP/1.1 200 OK\r\n Content-Length: 17\r\n WE ROOLZ: 76002\r\n=== End of file server.response\r\n=== Start of file stderr313\r\n   % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\r\n                                  Dload  Upload   Total   Spent    Left  Speed\r\n \r\n   0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0\r\n   0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0\r\n curl: (35) OpenSSL/3.0.1: error:03000098:digital envelope routines::invalid digest\r\n=== End of file stderr313\r\n=== Start of file trace313\r\n 22:21:24.309341 == Info:   Trying 127.0.0.1:25073...\r\n 22:21:24.508941 == Info: Connected to localhost (127.0.0.1) port 25073 (#0)\r\n 22:21:24.514959 == Info: ALPN: offers h2\r\n 22:21:24.514984 == Info: ALPN: offers http/1.1\r\n 22:21:24.517003 == Info:  CAfile: ../../tests/certs/EdelCurlRoot-ca.crt\r\n 22:21:24.517026 == Info:  CApath: none\r\n 22:21:24.517228 == Info: successfully loaded CRL file:\r\n 22:21:24.517245 == Info:   CRLfile: ../../tests/certs/Server-localhost-sv.crl\r\n 22:21:24.517786 == Info: [CONN-0-0][CF-SSL] TLSv1.0 (OUT), TLS header, Certificate Status (22):\r\n 22:21:24.517804 => Send SSL data, 5 bytes (0x5)\r\n 0000: .....\r\n 22:21:24.517847 == Info: [CONN-0-0][CF-SSL] TLSv1.3 (OUT), TLS handshake, Client hello (1):\r\n 22:21:24.517858 => Send SSL data, 512 bytes (0x200)\r\n 0000: ............F.......J..y............[9 .H=s.#.1p.U.;.c..p..-..5.\r\n 0040: ..OR....>.......,.0.........+./...$.(.k.#.'.g.....9.....3.....=.\r\n 0080: <.5./.....u.........localhost...................................\r\n 00c0: ......h2.http/1.1.........1.....*.(.............................\r\n 0100: ............+............-.....3.&.$... X.3...#..2A.....7.,0....\r\n 0140: :H..d.\\q........................................................\r\n 0180: ................................................................\r\n 01c0: ................................................................\r\n 22:21:24.524820 == Info: [CONN-0-0][CF-SSL] TLSv1.2 (IN), TLS header, Certificate Status (22):\r\n22:21:24.524852 <= Recv SSL data, 5 bytes (0x5)\r\n 0000: ....z\r\n 22:21:24.524893 == Info: [CONN-0-0][CF-SSL] TLSv1.3 (IN), TLS handshake, Server hello (2):\r\n 22:21:24.524905 <= Recv SSL data, 122 bytes (0x7a)\r\n 0000: ...v..sVH..C...is.m30..i\"......!....6= .H=s.#.1p.U.;.c..p..-..5.\r\n 0040: ..OR.........+.....3.$... W~..c.kzw70..........Uz..@v.X`SH\r\n 22:21:24.525642 == Info: [CONN-0-0][CF-SSL] TLSv1.2 (IN), TLS header, Finished (20):\r\n 22:21:24.525661 <= Recv SSL data, 5 bytes (0x5)\r\n 0000: .....\r\n 22:21:24.525688 == Info: [CONN-0-0][CF-SSL] TLSv1.2 (IN), TLS header, Supplemental data (23):\r\n 22:21:24.525699 <= Recv SSL data, 5 bytes (0x5)\r\n 0000: .....\r\n 22:21:24.525724 <= Recv SSL data, 1 bytes (0x1)\r\n 0000: .\r\n 22:21:24.525766 == Info: [CONN-0-0][CF-SSL] TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8):\r\n 22:21:24.525777 <= Recv SSL data, 10 bytes (0xa)\r\n 0000: ..........\r\n 22:21:24.525804 == Info: [CONN-0-0][CF-SSL] TLSv1.2 (IN), TLS header, Supplemental data (23):\r\n 22:21:24.525814 <= Recv SSL data, 5 bytes (0x5)\r\n 0000: ....f\r\n 22:21:24.525845 <= Recv SSL data, 1 bytes (0x1)\r\n 0000: .\r\n 22:21:24.525872 == Info: [CONN-0-0][CF-SSL] TLSv1.3 (IN), TLS handshake, Certificate (11):\r\n 22:21:24.525881 <= Recv SSL data, 1109 bytes (0x455)\r\n 0000: ...Q...M..H0..D0..,............f0...*.H........0h1.0...U....NN11\r\n 0040: 0/..U...(Edel Curl Arctic Illudium Research Cloud1&0$..U....Nort\r\n 0080: hern Nowhere Trust Anchor0...221125123246Z..310211123246Z0T1.0..\r\n 00c0: .U....NN110/..U...(Edel Curl Arctic Illudium Research Cloud1.0..\r\n 0100: .U....localhost0..\"0...*.H.............0.........h2O..O}2.......\r\n 0140: d|-...+.T..r]..9..u.......G.......(&& ,|*...)x-.>o.........v..Xj\r\n 0180: 9.....=.GYQ_....B..B..O[V../.c{......>..N...D..N...bj6cP....\".#.\r\n 01c0: ...\\...c.....F...R..{.[......9..P.....`..&Y.\"..W.1....jZ......q.\r\n 0200: ..*..z.....s..r.....7s..^.....fK..\\....k.................0...0..\r\n 0240: .U....0...localhost0...U........0...U.%..0...+.......0...U......\r\n 0280: dg......A.b.v...).2A0...U.#..0...R@..O.X)..g.........0...U....0.\r\n 02c0: 0C..+........70503..+.....0..'http://test.curl.se/ca/EdelCurlRoo\r\n 0300: t.cer08..U...10/0-.+.).'http://test.curl.se/ca/EdelCurlRoot.crl0\r\n 0340: ...*.H.............1.c.../.Z.....I...........3v.....T..M.S....Q.\r\n 0380: l82..V...\"E......,6A..X..~TA..`..T.g..+......(..=...O3....4...3X\r\n 03c0: .#..9.\"..1.GqM.&kP.M._.m<..-..=...>.[...1.......g.4.z..W...>....\r\n 0400: 0VM1.e}j:o&...;...Z...j.,....l.._v......7.....t.ST..B.@..H.../|.\r\n 0440: .......q....Ps*\"..V..\r\n 22:21:24.527991 == Info: [CONN-0-0][CF-SSL] TLSv1.2 (OUT), TLS header, Unknown (21):\r\n 22:21:24.528013 => Send SSL data, 5 bytes (0x5)\r\n 0000: .....\r\n 22:21:24.528106 == Info: [CONN-0-0][CF-SSL] TLSv1.3 (OUT), TLS alert, decrypt error (563):\r\n 22:21:24.528120 => Send SSL data, 2 bytes (0x2)\r\n 0000: .3\r\n 22:21:24.528164 == Info: OpenSSL/3.0.1: error:03000098:digital envelope routines::invalid digest\r\n 22:21:24.528309 == Info: Closing connection 0\r\n=== End of file trace313\r\n```\r\nThe equivalent test in 7.86.0 still passes in the same build environment. At first I suspected that this would be related to the more strict crypto policies in RHEL9 that disallow SHA1 signatures etc., but the certificates in this test look to be using SHA256, which should be fine. Then, whilst pasting in the build log above I noticed this in`https_stunnel.log`:\r\n```\r\n 2022.12.21 22:21:23 LOG5[ui]: Binding service [curltest] to :::25073: Address already in use (98)\r\n```\r\nThis is a type of error I've seen many times before, usually when running a second iteration of the test suite for a differently-configured curl build in the same environment, where a test server from the original test run was still running. That's not the case here though, because this is the first test run. Also, I don't see any mention of the use of port 25073 earlier in the build log. That would usually lead me to suspect a service running on that port on the build host but I can't see anything there either.\r\n\r\nI suspect that if I could persuade the test to run stunnel on a different port that it might work, but since the port numbers seem to be selected at random and based on the build environment somehow, I don't know how to do that. Any suggestions?\r\n\r\nIdeally, the test suite could be made a bit more robust about this sort of thing if it could check that the ports needed for a test were not already in use, and pick different ports if necessary. Clearly that would be racy but better than nothing.\r\n\r\n","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/10135/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/10135/timeline","performed_via_github_app":null,"state_reason":"completed"}