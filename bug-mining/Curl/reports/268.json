{"url":"https://api.github.com/repos/curl/curl/issues/11252","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/11252/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/11252/comments","events_url":"https://api.github.com/repos/curl/curl/issues/11252/events","html_url":"https://github.com/curl/curl/issues/11252","id":1742152901,"node_id":"I_kwDOAAiu0c5n1yTF","number":11252,"title":"lib/hostip.c: SCDynamicStoreCopyProxies is not safe to run in a fork","user":{"login":"stanhu","id":963826,"node_id":"MDQ6VXNlcjk2MzgyNg==","avatar_url":"https://avatars.githubusercontent.com/u/963826?v=4","gravatar_id":"","url":"https://api.github.com/users/stanhu","html_url":"https://github.com/stanhu","followers_url":"https://api.github.com/users/stanhu/followers","following_url":"https://api.github.com/users/stanhu/following{/other_user}","gists_url":"https://api.github.com/users/stanhu/gists{/gist_id}","starred_url":"https://api.github.com/users/stanhu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/stanhu/subscriptions","organizations_url":"https://api.github.com/users/stanhu/orgs","repos_url":"https://api.github.com/users/stanhu/repos","events_url":"https://api.github.com/users/stanhu/events{/privacy}","received_events_url":"https://api.github.com/users/stanhu/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2023-06-05T16:43:24Z","updated_at":"2024-01-23T23:55:11Z","closed_at":"2023-07-09T17:18:08Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\r\n\r\nThe Elasticsearch Ruby client uses the [`Typhoeus` Ruby gem](https://github.com/typhoeus/typhoeus), which uses `libcurl`. If you do something like this:\r\n\r\n```ruby\r\nrequire 'typhoeus'\r\n\r\nfork {\r\n  Typhoeus.head('https://wwww.google.com')\r\n}\r\n```\r\n\r\nThe process crashes with this warning:\r\n\r\n```\r\nobjc[73067]: +[__NSCFConstantString initialize] may have been in progress in another thread when fork() was called.\r\nobjc[73067]: +[__NSCFConstantString initialize] may have been in progress in another thread when fork() was called. We cannot safely call it or ignore it in the fork() child process. Crashing instead. Set a breakpoint on objc_initializeAfterForkError to debug.\r\n```\r\n\r\n### I expected the following\r\n\r\nNo error.\r\n\r\nFor simple applications, you can work around the problem by making the `libcurl` call outside of the fork:\r\n\r\n```ruby\r\nrequire 'typhoeus'\r\n \r\nTyphoeus.head('http://localhost')\r\n\r\nfork {\r\n  Typhoeus.head('http://localhost')\r\n}\r\n```\r\n\r\nHowever, this doesn't always work. As discussed in the links below, these macOS system calls are not thread-safe. Under some circumstances calling `SCDynamicStoreCopyProxiesWithOptions` can crash with a backtrace as the following:\r\n\r\n```\r\nTarget 0: (ruby) stopped.\r\n(lldb) bt\r\n* thread #1, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x109be0b22)\r\n  * frame #0: 0x0000000186ed66a0 libsystem_trace.dylib`_os_log_preferences_refresh + 64\r\n    frame #1: 0x0000000186ed710c libsystem_trace.dylib`os_log_type_enabled + 712\r\n    frame #2: 0x00000001871ea430 CoreFoundation`-[CFPrefsSearchListSource alreadylocked_copyValueForKey:] + 204\r\n    frame #3: 0x00000001871ea344 CoreFoundation`-[CFPrefsSource copyValueForKey:] + 52\r\n    frame #4: 0x00000001871ea2f8 CoreFoundation`__76-[_CFXPreferences copyAppValueForKey:identifier:container:configurationURL:]_block_invoke + 32\r\n    frame #5: 0x00000001871e3260 CoreFoundation`__108-[_CFXPreferences(SearchListAdditions) withSearchListForIdentifier:container:cloudConfigurationURL:perform:]_block_invoke + 376\r\n    frame #6: 0x000000018735fc78 CoreFoundation`-[_CFXPreferences withSearchListForIdentifier:container:cloudConfigurationURL:perform:] + 384\r\n    frame #7: 0x00000001871e2b30 CoreFoundation`-[_CFXPreferences copyAppValueForKey:identifier:container:configurationURL:] + 168\r\n    frame #8: 0x00000001871e2a4c CoreFoundation`_CFPreferencesCopyAppValueWithContainerAndConfiguration + 112\r\n    frame #9: 0x0000000187e23f24 SystemConfiguration`SCDynamicStoreCopyProxiesWithOptions + 180\r\n    frame #10: 0x000000019d29c01c libcurl.4.dylib`Curl_resolv + 288\r\n    frame #11: 0x000000019d2cd40c libcurl.4.dylib`resolve_server + 320\r\n    frame #12: 0x000000019d2cba80 libcurl.4.dylib`Curl_connect + 5764\r\n    frame #13: 0x000000019d2b3344 libcurl.4.dylib`multi_runsingle + 580\r\n    frame #14: 0x000000019d2b2fdc libcurl.4.dylib`curl_multi_perform + 124\r\n    frame #15: 0x000000019d290bcc libcurl.4.dylib`curl_easy_perform + 276\r\n    frame #16: 0x0000000111a68044 ffi_c.bundle`ffi_call_SYSV + 68\r\n    frame #17: 0x0000000111a639fc ffi_c.bundle`ffi_call_int + 1560\r\n    frame #18: 0x0000000111a633d8 ffi_c.bundle`ffi_call + 52\r\n    frame #19: 0x0000000111a56ef0 ffi_c.bundle`call_blocking_function(data=<unavailable>) at Call.c:336:5\r\n    frame #20: 0x0000000105167cd0 libruby.3.1.dylib`rb_nogvl + 268\r\n    frame #21: 0x0000000111a56ec8 ffi_c.bundle`rbffi_do_blocking_call(data=<unavailable>) at Call.c:344:5\r\n    frame #22: 0x0000000105019af8 libruby.3.1.dylib`rb_vrescue2 + 368\r\n    frame #23: 0x0000000105019960 libruby.3.1.dylib`rb_rescue2 + 44\r\n    frame #24: 0x0000000111a5715c ffi_c.bundle`rbffi_CallFunction(argc=<unavailable>, argv=<unavailable>, function=0x000000019d290ab8, fnInfo=0x00006000037bad60) at Call.c:387:9\r\n    frame #25: 0x0000000111a5ace8 ffi_c.bundle`attached_method_invoke(cif=<unavailable>, mretval=0x000000016b2cdc90, parameters=<unavailable>, user_data=<unavailable>) at MethodHandle.c:174:26\r\n    frame #26: 0x0000000111a63f08 ffi_c.bundle`ffi_closure_SYSV_inner + 988\r\n    frame #27: 0x0000000111a681b4 ffi_c.bundle`.Ldo_closure + 20\r\n    frame #28: 0x00000001051b64e4 libruby.3.1.dylib`vm_call_cfunc_with_frame + 232\r\n    frame #29: 0x00000001051b8c08 libruby.3.1.dylib`vm_sendish + 1336\r\n    frame #30: 0x000000010519b53c libruby.3.1.dylib`vm_exec_core + 8128\r\n```\r\n\r\n1. https://blog.phusion.nl/2017/10/13/why-ruby-app-servers-break-on-macos-high-sierra-and-what-can-be-done-about-it/\r\n1. https://bugs.python.org/issue33725\r\n\r\nThis system call was introduced in https://github.com/curl/curl/pull/7121 by @zajdee. I'm wondering: can we avoid calling this system call more than once? For example, I'm wondering if we can move this into `curl_global_init()` instead.\r\n\r\n### curl/libcurl version\r\n\r\n```\r\ncurl 7.88.1 (x86_64-apple-darwin22.0) libcurl/7.88.1 (SecureTransport) LibreSSL/3.3.6 zlib/1.2.11 nghttp2/1.51.0\r\nRelease-Date: 2023-02-20\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps ldap ldaps mqtt pop3 pop3s rtsp smb smbs smtp smtps telnet tftp\r\nFeatures: alt-svc AsynchDNS GSS-API HSTS HTTP2 HTTPS-proxy IPv6 Kerberos Largefile libz MultiSSL NTLM NTLM_WB SPNEGO SSL threadsafe UnixSockets\r\n```\r\n\r\n### operating system\r\n\r\nmacOS Ventura 13.4\r\n\r\n<!-- On Unix please post the output of \"uname -a\" -->\r\n","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/11252/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/11252/timeline","performed_via_github_app":null,"state_reason":"completed"}