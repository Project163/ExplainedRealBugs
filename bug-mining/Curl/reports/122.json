{"url":"https://api.github.com/repos/curl/curl/issues/8896","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/8896/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/8896/comments","events_url":"https://api.github.com/repos/curl/curl/issues/8896/events","html_url":"https://github.com/curl/curl/issues/8896","id":1244235187,"node_id":"I_kwDOAAiu0c5KKYWz","number":8896,"title":"hyper: root cause of curl test 565 failure","user":{"login":"pmk21","id":32909711,"node_id":"MDQ6VXNlcjMyOTA5NzEx","avatar_url":"https://avatars.githubusercontent.com/u/32909711?v=4","gravatar_id":"","url":"https://api.github.com/users/pmk21","html_url":"https://github.com/pmk21","followers_url":"https://api.github.com/users/pmk21/followers","following_url":"https://api.github.com/users/pmk21/following{/other_user}","gists_url":"https://api.github.com/users/pmk21/gists{/gist_id}","starred_url":"https://api.github.com/users/pmk21/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pmk21/subscriptions","organizations_url":"https://api.github.com/users/pmk21/orgs","repos_url":"https://api.github.com/users/pmk21/repos","events_url":"https://api.github.com/users/pmk21/events{/privacy}","received_events_url":"https://api.github.com/users/pmk21/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2620316181,"node_id":"MDU6TGFiZWwyNjIwMzE2MTgx","url":"https://api.github.com/repos/curl/curl/labels/Hyper","name":"Hyper","color":"006b75","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-05-22T12:08:18Z","updated_at":"2022-12-11T13:16:32Z","closed_at":"2022-12-11T13:16:32Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!-- Only file bugs here! Ask questions on the mailing lists https://curl.se/mail/\r\n\r\n     SECURITY RELATED? Post it here: https://hackerone.com/curl\r\n\r\n     There are collections of known issues to be aware of:\r\n     https://curl.se/docs/knownbugs.html\r\n     https://curl.se/docs/todo.html       -->\r\n\r\n### I did this\r\n\r\nRan curl test 565, analyzed the debug trace and generated logs, concluded that the first POST request seems to be missing the terminating chunk which has to be inputted during the read callback. This is possibly causing some issues in hyper.\r\n\r\nInitial request from `server.input` -\r\n\r\n```log\r\nPOST /565 HTTP/1.1\r\nHost: 127.0.0.1:37051\r\nAccept: */*\r\nTransfer-Encoding: chunked\r\nContent-Type: application/x-www-form-urlencoded\r\n\r\n3\r\none\r\n3\r\ntwo\r\n5\r\nthree\r\n1D\r\nand a final longer crap: four\r\n0\r\n\r\n```\r\nRequests after fix -\r\n```log\r\nPOST /565 HTTP/1.1\r\nHost: 127.0.0.1:42461\r\nAccept: */*\r\nTransfer-Encoding: chunked\r\nContent-Type: application/x-www-form-urlencoded\r\n\r\n0\r\n\r\nPOST /565 HTTP/1.1\r\nHost: 127.0.0.1:42461\r\nAuthorization: Digest username=\"foo\", realm=\"testrealm\", nonce=\"1053604144\", uri=\"/565\", response=\"877424f750af047634dbd94f9933217b\"\r\nAccept: */*\r\nTransfer-Encoding: chunked\r\nContent-Type: application/x-www-form-urlencoded\r\nExpect: 100-continue\r\n\r\n3\r\none\r\n3\r\ntwo\r\n5\r\nthree\r\n1D\r\nand a final longer crap: four\r\n0\r\n```\r\nPatched the `lib510.c` file to allow the test to pass -\r\n\r\n```diff\r\ndiff --git a/tests/libtest/lib510.c b/tests/libtest/lib510.c\r\nindex 2b8da207d..a5bd06a9c 100644\r\n--- a/tests/libtest/lib510.c\r\n+++ b/tests/libtest/lib510.c\r\n@@ -36,6 +36,7 @@ struct WriteThis {\r\n   int counter;\r\n };\r\n \r\n+#if defined(USE_HYPER) && defined(LIB565)\r\n static size_t read_callback(char *ptr, size_t size, size_t nmemb, void *userp)\r\n {\r\n   struct WriteThis *pooh = (struct WriteThis *)userp;\r\n@@ -44,6 +45,11 @@ static size_t read_callback(char *ptr, size_t size, size_t nmemb, void *userp)\r\n   if(size*nmemb < 1)\r\n     return 0;\r\n \r\n+  if(pooh->counter == -1) {\r\n+    pooh->counter++;\r\n+    return 0;\r\n+  }\r\n+\r\n   data = post[pooh->counter];\r\n \r\n   if(data) {\r\n@@ -58,6 +64,30 @@ static size_t read_callback(char *ptr, size_t size, size_t nmemb, void *userp)\r\n   }\r\n   return 0;                         /* no more data left to deliver */\r\n }\r\n+#else\r\n+static size_t read_callback(char *ptr, size_t size, size_t nmemb, void *userp)\r\n+{\r\n+  struct WriteThis *pooh = (struct WriteThis *)userp;\r\n+  const char *data;\r\n+\r\n+  if(size*nmemb < 1)\r\n+    return 0;\r\n+\r\n+  data = post[pooh->counter];\r\n+\r\n+  if(data) {\r\n+    size_t len = strlen(data);\r\n+    if(size*nmemb < len) {\r\n+      fprintf(stderr, \"read buffer is too small to run test\\n\");\r\n+      return 0;\r\n+    }\r\n+    memcpy(ptr, data, len);\r\n+    pooh->counter++; /* advance pointer */\r\n+    return len;\r\n+  }\r\n+  return 0;                         /* no more data left to deliver */\r\n+}\r\n+#endif\r\n \r\n int test(char *URL)\r\n {\r\n@@ -65,7 +95,11 @@ int test(char *URL)\r\n   CURLcode res = CURLE_OK;\r\n   struct curl_slist *slist = NULL;\r\n   struct WriteThis pooh;\r\n+#if defined(USE_HYPER) && defined(LIB565)\r\n+  pooh.counter = -1;\r\n+#else\r\n   pooh.counter = 0;\r\n+#endif\r\n \r\n   if(curl_global_init(CURL_GLOBAL_ALL) != CURLE_OK) {\r\n     fprintf(stderr, \"curl_global_init() failed\\n\");\r\n\r\n```\r\n\r\n### curl/libcurl version\r\n\r\n```output\r\ncurl 7.83.1-DEV (x86_64-pc-linux-gnu) libcurl/7.83.1-DEV OpenSSL/1.1.1o zlib/1.2.12 brotli/1.0.9 zstd/1.5.2 libidn2/2.3.2 libpsl/0.21.1 (+libidn2/2.3.0) librtmp/2.3 Hyper/0.14.18 OpenLDAP/2.6.1\r\nRelease-Date: [unreleased]\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps ldap ldaps mqtt pop3 pop3s rtmp smb smbs smtp smtps telnet tftp \r\nFeatures: alt-svc AsynchDNS brotli Debug HSTS HTTP2 HTTPS-proxy IDN Largefile libz NTLM NTLM_WB PSL SSL TLS-SRP TrackMemory UnixSockets zstd\r\n```\r\n\r\n### operating system\r\n\r\n<!-- On Unix please post the output of \"uname -a\" -->\r\n```output\r\nLinux msi 5.15.38-1-MANJARO #1 SMP PREEMPT Mon May 9 07:52:21 UTC 2022 x86_64 GNU/Linux\r\n```","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/8896/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/8896/timeline","performed_via_github_app":null,"state_reason":"completed"}