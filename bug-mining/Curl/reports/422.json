{"url":"https://api.github.com/repos/curl/curl/issues/10290","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/10290/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/10290/comments","events_url":"https://api.github.com/repos/curl/curl/issues/10290/events","html_url":"https://github.com/curl/curl/issues/10290","id":1531844295,"node_id":"I_kwDOAAiu0c5bThbH","number":10290,"title":"SSL session closes with RST","user":{"login":"dfdity","id":122448166,"node_id":"U_kgDOB0xpJg","avatar_url":"https://avatars.githubusercontent.com/u/122448166?v=4","gravatar_id":"","url":"https://api.github.com/users/dfdity","html_url":"https://github.com/dfdity","followers_url":"https://api.github.com/users/dfdity/followers","following_url":"https://api.github.com/users/dfdity/following{/other_user}","gists_url":"https://api.github.com/users/dfdity/gists{/gist_id}","starred_url":"https://api.github.com/users/dfdity/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dfdity/subscriptions","organizations_url":"https://api.github.com/users/dfdity/orgs","repos_url":"https://api.github.com/users/dfdity/repos","events_url":"https://api.github.com/users/dfdity/events{/privacy}","received_events_url":"https://api.github.com/users/dfdity/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118221,"node_id":"MDU6TGFiZWwxODQxMTgyMjE=","url":"https://api.github.com/repos/curl/curl/labels/TLS","name":"TLS","color":"bfdadc","default":false,"description":""},{"id":657824945,"node_id":"MDU6TGFiZWw2NTc4MjQ5NDU=","url":"https://api.github.com/repos/curl/curl/labels/help%20wanted","name":"help wanted","color":"fbca04","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":34,"created_at":"2023-01-13T07:33:31Z","updated_at":"2024-03-15T08:20:31Z","closed_at":"2024-03-15T08:20:31Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\r\n```curl -v -H \"Connection: close\" https://httpd.apache.org/ > /dev/null```\r\n\r\nOn latest 7.87 curl and before \r\n\r\nIn the tcpdump of the conversation I have observed race condition on session closure both server and client are trying\r\nto close simultaneously which causes RST instead of clean session closing (whomever first started the session close will send the RST to the other party). Usually curl tries to close the session before the server. This only affects SSL; workaround used in FTPS issue ```--tls-max 1.2``` doesn't help. Examples from separate machines (note the adjastent FIN-ACKs from server(151.101.2.132) and client(192.x) and final RSTs from client):\r\n![image](https://user-images.githubusercontent.com/122448166/212261159-f66eac7a-b0ac-44fc-a09c-b5037cc8c0f8.png)\r\nand\r\n![image](https://user-images.githubusercontent.com/122448166/212261371-b593802c-f8b1-41bb-8f8e-86097ea04002.png)\r\n\r\nI think this is related to https://github.com/curl/curl/pull/7095\r\n\r\n### I expected the following\r\nClean session closure with 4 packets. FIN-ACK, FIN-ACK, ACK, ACK\r\n\r\n### curl/libcurl version\r\nTried following:\r\ncurl 7.87.0-DEV (x86_64-pc-linux-gnu) libcurl/7.87.0-DEV OpenSSL/1.1.1n zlib/1.2.8\r\nRelease-Date: [unreleased]\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps mqtt pop3 pop3s rtsp smb smbs smtp smtps telnet tftp\r\nFeatures: alt-svc AsynchDNS HSTS HTTPS-proxy IPv6 Largefile libz NTLM NTLM_WB SSL threadsafe TLS-SRP UnixSockets\r\n\r\ncurl 7.52.1 (x86_64-pc-linux-gnu) libcurl/7.52.1 OpenSSL/1.0.2u zlib/1.2.8 libidn2/2.0.5 libpsl/0.21.0 (+libidn2/2.0.5) libssh2/1.7.0 nghttp2/1.36.0 librtm\r\np/2.3\r\nProtocols: dict file ftp ftps gopher http https imap imaps ldap ldaps pop3 pop3s rtmp rtsp scp sftp smb smbs smtp smtps telnet tftp \r\nFeatures: AsynchDNS IDN IPv6 Largefile GSS-API Kerberos SPNEGO NTLM NTLM_WB SSL libz TLS-SRP HTTP2 UnixSockets HTTPS-proxy PSL \r\n\r\ncurl 7.78.0 (x86_64-pc-linux-gnu) libcurl/7.78.0 OpenSSL/1.1.1n zlib/1.2.8\r\nRelease-Date: 2021-07-21\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps mqtt pop3 pop3s rtsp smb smbs smtp smtps telnet tftp \r\nFeatures: alt-svc AsynchDNS HSTS HTTPS-proxy IPv6 Largefile libz NTLM NTLM_WB SSL TLS-SRP UnixSockets\r\n\r\n### operating system\r\nLinux 5.16.0 SMP Debian 5.16.7 (2022-02-10) x86_64 GNU/Linux\r\nLinux 5.10.0-1057-hardened SMP Wed Jul 20 13:08:44 UTC 2022 x86_64 GNU/Linux\r\n\r\n### this might be related to\r\nhttps://github.com/curl/curl/issues/6149\r\nhttps://github.com/curl/curl/pull/7095","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/10290/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/10290/timeline","performed_via_github_app":null,"state_reason":"completed"}