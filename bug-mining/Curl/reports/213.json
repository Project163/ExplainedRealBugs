{"url":"https://api.github.com/repos/curl/curl/issues/10832","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/10832/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/10832/comments","events_url":"https://api.github.com/repos/curl/curl/issues/10832/events","html_url":"https://github.com/curl/curl/issues/10832","id":1640160096,"node_id":"I_kwDOAAiu0c5hwttg","number":10832,"title":"undefined reference for zlib symbols when building with static dependencies and BUILD_SHARED_LIBS=OFF","user":{"login":"val-ms","id":30635813,"node_id":"MDQ6VXNlcjMwNjM1ODEz","avatar_url":"https://avatars.githubusercontent.com/u/30635813?v=4","gravatar_id":"","url":"https://api.github.com/users/val-ms","html_url":"https://github.com/val-ms","followers_url":"https://api.github.com/users/val-ms/followers","following_url":"https://api.github.com/users/val-ms/following{/other_user}","gists_url":"https://api.github.com/users/val-ms/gists{/gist_id}","starred_url":"https://api.github.com/users/val-ms/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/val-ms/subscriptions","organizations_url":"https://api.github.com/users/val-ms/orgs","repos_url":"https://api.github.com/users/val-ms/repos","events_url":"https://api.github.com/users/val-ms/events{/privacy}","received_events_url":"https://api.github.com/users/val-ms/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184123162,"node_id":"MDU6TGFiZWwxODQxMjMxNjI=","url":"https://api.github.com/repos/curl/curl/labels/cmake","name":"cmake","color":"d4c5f9","default":false,"description":null},{"id":192515830,"node_id":"MDU6TGFiZWwxOTI1MTU4MzA=","url":"https://api.github.com/repos/curl/curl/labels/needs-info","name":"needs-info","color":"fbca04","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2023-03-24T22:59:36Z","updated_at":"2023-03-30T21:22:29Z","closed_at":"2023-03-30T08:56:02Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\r\n\r\nWe build libcurl and all our other dependencies as static libraries.  Our build script for libcurl also builds the curl program, which in retrospect we don't need.  Anyhow, it runs this for our static build:\r\n```\r\ncmake .. \\\r\n  -D CMAKE_BUILD_TYPE=Release \\\r\n  -D CMAKE_POSITION_INDEPENDENT_CODE=ON \\\r\n  -D CURL_USE_OPENSSL=ON \\\r\n  -D OPENSSL_INCLUDE_DIR=\"/home/micah/.mussels/install/host-static/include\" \\\r\n  -D OPENSSL_LIBRARIES=\"/home/micah/.mussels/install/host-static/lib\" \\\r\n  -D OPENSSL_CRYPTO_LIBRARY=\"/home/micah/.mussels/install/host-static/lib/libcrypto.a\" \\\r\n  -D OPENSSL_SSL_LIBRARY=\"/home/micah/.mussels/install/host-static/lib/libssl.a\" \\\r\n  -D ZLIB_INCLUDE_DIR=\"/home/micah/.mussels/install/host-static/include\" \\\r\n  -D ZLIB_LIBRARY_RELEASE=\"/home/micah/.mussels/install/host-static/lib/libz.a\" \\\r\n  -D LIBSSH2_INCLUDE_DIR=\"/home/micah/.mussels/install/host-static/include\" \\\r\n  -D LIBSSH2_LIBRARY=\"/home/micah/.mussels/install/host-static/lib/libssh2.a\" \\\r\n  -D USE_NGHTTP2=ON \\\r\n  -D NGHTTP2_INCLUDE_DIR=\"/home/micah/.mussels/install/host-static/include\" \\\r\n  -D NGHTTP2_LIBRARY=\"/home/micah/.mussels/install/host-static/lib/libnghttp2.a\" \\\r\n  -D CMAKE_INSTALL_PREFIX=\"/home/micah/.mussels/install/host-static\" \\\r\n  -D BUILD_SHARED_LIBS=OFF \\\r\n  -D CMAKE_INSTALL_LIBDIR=lib\r\n```\r\n\r\nThis worked fine with curl-7.87.0, but failed when we updated to curl-8.0.1 with this:\r\n```\r\n‚ùØ make\r\n[ 76%] Built target libcurl\r\n[ 76%] Linking C executable curl\r\n/usr/bin/ld: /home/micah/.mussels/install/host-static/lib/libcrypto.a(c_zlib.o): in function `zlib_stateful_compress_block':\r\nc_zlib.c:(.text+0xba): undefined reference to `deflate'\r\n/usr/bin/ld: /home/micah/.mussels/install/host-static/lib/libcrypto.a(c_zlib.o): in function `zlib_stateful_finish':\r\nc_zlib.c:(.text+0xf6): undefined reference to `deflateEnd'\r\n/usr/bin/ld: /home/micah/.mussels/install/host-static/lib/libcrypto.a(c_zlib.o): in function `zlib_stateful_init':\r\nc_zlib.c:(.text+0x230): undefined reference to `deflateInit_'\r\n/usr/bin/ld: /home/micah/.mussels/install/host-static/lib/libcrypto.a(c_zlib.o): in function `bio_zlib_ctrl':\r\nc_zlib.c:(.text+0x394): undefined reference to `deflate'\r\n/usr/bin/ld: /home/micah/.mussels/install/host-static/lib/libcrypto.a(c_zlib.o): in function `bio_zlib_write':\r\nc_zlib.c:(.text+0x73a): undefined reference to `deflate'\r\n/usr/bin/ld: c_zlib.c:(.text+0x85b): undefined reference to `deflateInit_'\r\n/usr/bin/ld: /home/micah/.mussels/install/host-static/lib/libcrypto.a(c_zlib.o): in function `bio_zlib_free':\r\nc_zlib.c:(.text+0xb07): undefined reference to `deflateEnd'\r\n/usr/bin/ld: /home/micah/.mussels/install/host-static/lib/libssh2.a(comp.c.o): in function `comp_method_zlib_dtor':\r\ncomp.c:(.text+0xa1): undefined reference to `deflateEnd'\r\n/usr/bin/ld: /home/micah/.mussels/install/host-static/lib/libssh2.a(comp.c.o): in function `comp_method_zlib_comp':\r\ncomp.c:(.text+0x272): undefined reference to `deflate'\r\n/usr/bin/ld: /home/micah/.mussels/install/host-static/lib/libssh2.a(comp.c.o): in function `comp_method_zlib_init':\r\ncomp.c:(.text+0x355): undefined reference to `deflateInit_'\r\ncollect2: error: ld returned 1 exit status\r\nmake[2]: *** [src/CMakeFiles/curl.dir/build.make:784: src/curl] Error 1\r\nmake[1]: *** [CMakeFiles/Makefile2:541: src/CMakeFiles/curl.dir/all] Error 2\r\nmake: *** [Makefile:130: all] Error 2\r\n```\r\n\r\nAdditional info, we're building with a tool called Mussels that I made to automate our dependency builds for linux/mac/windows/freebsd. So this came up in https://github.com/Cisco-Talos/clamav-mussels-cookbook/pull/32 where these are the full instructions used for that \"host-static\" build that failed: https://github.com/Cisco-Talos/clamav-mussels-cookbook/blob/157d31d952a832403895254220f3847a27fa0c61/recipes/libcurl-7.yaml#L150-L170\r\n\r\n### I expected the following\r\n\r\nI expected the build to succeed ;-).  Seems like the curl application is no longer being linked with `ZLIB::ZLIB` in 8.0.1 in this particular situation. \r\n\r\n### curl/libcurl version\r\n\r\n8.0.1\r\n\r\n### operating system\r\n\r\n`Linux DESKTOP-N3L21K2 5.15.90.1-microsoft-standard-WSL2 #1 SMP Fri Jan 27 02:56:13 UTC 2023 x86_64 x86_64 x86_64 GNU/Linux`\r\n","closed_by":{"login":"vszakats","id":1446897,"node_id":"MDQ6VXNlcjE0NDY4OTc=","avatar_url":"https://avatars.githubusercontent.com/u/1446897?v=4","gravatar_id":"","url":"https://api.github.com/users/vszakats","html_url":"https://github.com/vszakats","followers_url":"https://api.github.com/users/vszakats/followers","following_url":"https://api.github.com/users/vszakats/following{/other_user}","gists_url":"https://api.github.com/users/vszakats/gists{/gist_id}","starred_url":"https://api.github.com/users/vszakats/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vszakats/subscriptions","organizations_url":"https://api.github.com/users/vszakats/orgs","repos_url":"https://api.github.com/users/vszakats/repos","events_url":"https://api.github.com/users/vszakats/events{/privacy}","received_events_url":"https://api.github.com/users/vszakats/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/10832/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/10832/timeline","performed_via_github_app":null,"state_reason":"completed"}