{"url":"https://api.github.com/repos/curl/curl/issues/18621","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/18621/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/18621/comments","events_url":"https://api.github.com/repos/curl/curl/issues/18621/events","html_url":"https://github.com/curl/curl/issues/18621","id":3434328322,"node_id":"I_kwDOAAiu0c7Ms7EC","number":18621,"title":"COOKIEFILE+COOKIEJAR may truncate cookie jar when no transfer occurs","user":{"login":"divinity76","id":1874996,"node_id":"MDQ6VXNlcjE4NzQ5OTY=","avatar_url":"https://avatars.githubusercontent.com/u/1874996?v=4","gravatar_id":"","url":"https://api.github.com/users/divinity76","html_url":"https://github.com/divinity76","followers_url":"https://api.github.com/users/divinity76/followers","following_url":"https://api.github.com/users/divinity76/following{/other_user}","gists_url":"https://api.github.com/users/divinity76/gists{/gist_id}","starred_url":"https://api.github.com/users/divinity76/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/divinity76/subscriptions","organizations_url":"https://api.github.com/users/divinity76/orgs","repos_url":"https://api.github.com/users/divinity76/repos","events_url":"https://api.github.com/users/divinity76/events{/privacy}","received_events_url":"https://api.github.com/users/divinity76/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":4809646275,"node_id":"LA_kwDOAAiu0c8AAAABHq1gww","url":"https://api.github.com/repos/curl/curl/labels/cookies","name":"cookies","color":"bfdadc","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":0,"created_at":"2025-09-19T13:12:54Z","updated_at":"2025-09-19T14:40:43Z","closed_at":"2025-09-19T14:40:43Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\n```c\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <unistd.h>     // mkstemp, close\n#include <fcntl.h>      // write\n#include <curl/curl.h>\n#include <stdbool.h>\n\nvoid xcurl_setopt(CURL *curl, CURLoption option, const char *value) {\n    CURLcode rc = curl_easy_setopt(curl, option, value);\n    if (rc != CURLE_OK) {\n        fprintf(stderr, \"curl_easy_setopt failed: %s\\n\", curl_easy_strerror(rc));\n        curl_easy_cleanup(curl);\n        curl_global_cleanup();\n        exit(1);\n    }\n}\nint main(int argc, char **argv) {\n    const bool reload = argc > 1 && strcmp(argv[1], \"RELOAD\") == 0;\n    // 1) Create a temp file path safely (mkstemp creates the file)\n    char tmpl[] = \"/tmp/cookieXXXXXX\";\n    int fd = mkstemp(tmpl);\n    if (fd == -1) {\n        perror(\"mkstemp\");\n        return 1;\n    }\n\n    // 2) Prepare cookie file contents\n    const char *cookie =\n        \"# Netscape HTTP Cookie File\\n\"\n        \"# https://curl.se/docs/http-cookies.html\\n\"\n        \"# This file was generated by libcurl! Edit at your own risk.\\n\"\n        \"\\n\"\n        \"example.com\\tFALSE\\t/\\tFALSE\\t0\\thas_js\\t1\\n\";\n\n    ssize_t to_write = (ssize_t)strlen(cookie);\n    if (write(fd, cookie, to_write) != to_write) {\n        perror(\"write\");\n        close(fd);\n        unlink(tmpl);\n        return 1;\n    }\n\n    // Ensure data hits disk\n    if (fsync(fd) != 0) {\n        perror(\"fsync\");\n        close(fd);\n        unlink(tmpl);\n        return 1;\n    }\n    close(fd);\n\n    // 3) Initialize libcurl\n    CURLcode rc;\n    rc = curl_global_init(CURL_GLOBAL_DEFAULT);\n    if (rc != CURLE_OK) {\n        fprintf(stderr, \"curl_global_init failed: %s\\n\", curl_easy_strerror(rc));\n        unlink(tmpl);\n        return 1;\n    }\n\n    CURL *curl = curl_easy_init();\n    if (!curl) {\n        fprintf(stderr, \"curl_easy_init failed\\n\");\n        curl_global_cleanup();\n        unlink(tmpl);\n        return 1;\n    }\n\n    // Point both options at the cookie file we just created\n    xcurl_setopt(curl, CURLOPT_COOKIEFILE, tmpl);\n    xcurl_setopt(curl, CURLOPT_COOKIEJAR,  tmpl);\n    if (reload) {\n        xcurl_setopt(curl, CURLOPT_COOKIELIST, \"RELOAD\");\n    }\n\n    // Do not perform any actual network operation,\n    // the issue occur when not calling curl.*perform\n    curl_easy_cleanup(curl);\n    curl_global_cleanup();\n\n    // 4) Read the cookie file back and print it (like PHP's var_dump(file_get_contents))\n    FILE *fp = fopen(tmpl, \"rb\");\n    if (!fp) {\n        perror(\"fopen\");\n        unlink(tmpl);\n        return 1;\n    }\n\n    fseek(fp, 0, SEEK_END);\n    long size = ftell(fp);\n    fseek(fp, 0, SEEK_SET);\n\n    char *buf = (char *)malloc((size_t)size + 1);\n    if (!buf) {\n        fprintf(stderr, \"malloc failed\\n\");\n        fclose(fp);\n        unlink(tmpl);\n        return 1;\n    }\n\n    fread(buf, 1, (size_t)size, fp);\n    buf[size] = '\\0';\n    fclose(fp);\n    printf(\"strlen %ld\\n%s\", size, buf);\n    free(buf);\n    unlink(tmpl);\n    return 0;\n}\n```\nand\n```\nhans@DESKTOP-EE15SLU:~/projects/autodata/hans$ gcc repro.c -lcurl\nhans@DESKTOP-EE15SLU:~/projects/autodata/hans$ ./a.out RELOAD\nstrlen 168\n# Netscape HTTP Cookie File\n# https://curl.se/docs/http-cookies.html\n# This file was generated by libcurl! Edit at your own risk.\n\nexample.com\tFALSE\t/\tFALSE\t0\thas_js\t1\nhans@DESKTOP-EE15SLU:~/projects/autodata/hans$ ./a.out\nstrlen 131\n# Netscape HTTP Cookie File\n# https://curl.se/docs/http-cookies.html\n# This file was generated by libcurl! Edit at your own risk.\n\n```\n\n### I expected the following\n\nI expected curl to not erase my cookiejar.\n\n### curl/libcurl version\n\ncurl version: libcurl/8.5.0 OpenSSL/3.0.13 zlib/1.3 brotli/1.1.0 zstd/1.5.5 libidn2/2.3.7 libpsl/0.21.2 (+libidn2/2.3.7) libssh/0.10.6/openssl/zlib nghttp2/1.59.0 librtmp/2.3 OpenLDAP/2.6.7\n\n\n### operating system\n\nUbuntu 24.04 x86-64","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/18621/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/18621/timeline","performed_via_github_app":null,"state_reason":"completed"}