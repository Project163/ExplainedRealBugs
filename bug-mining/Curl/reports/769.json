{"url":"https://api.github.com/repos/curl/curl/issues/18121","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/18121/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/18121/comments","events_url":"https://api.github.com/repos/curl/curl/issues/18121/events","html_url":"https://github.com/curl/curl/issues/18121","id":3280861041,"node_id":"I_kwDOAAiu0c7Djfdx","number":18121,"title":"very long urls and openssl and curl_easy_perform fails","user":{"login":"adamse","id":75746,"node_id":"MDQ6VXNlcjc1NzQ2","avatar_url":"https://avatars.githubusercontent.com/u/75746?v=4","gravatar_id":"","url":"https://api.github.com/users/adamse","html_url":"https://github.com/adamse","followers_url":"https://api.github.com/users/adamse/followers","following_url":"https://api.github.com/users/adamse/following{/other_user}","gists_url":"https://api.github.com/users/adamse/gists{/gist_id}","starred_url":"https://api.github.com/users/adamse/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adamse/subscriptions","organizations_url":"https://api.github.com/users/adamse/orgs","repos_url":"https://api.github.com/users/adamse/repos","events_url":"https://api.github.com/users/adamse/events{/privacy}","received_events_url":"https://api.github.com/users/adamse/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118221,"node_id":"MDU6TGFiZWwxODQxMTgyMjE=","url":"https://api.github.com/repos/curl/curl/labels/TLS","name":"TLS","color":"bfdadc","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":15,"created_at":"2025-07-31T15:20:36Z","updated_at":"2025-08-01T15:54:24Z","closed_at":"2025-08-01T15:54:24Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nThis test program fails with `CURLE_SEND_ERROR` if the *https* url in the file in `argv[1]` is longer than ~u16 max.\n\n```\nCURLE_SEND_ERROR curl_easy_perform() failed: Failed sending data to the peer\nSSL_write() error: error:0A00010F:SSL routines::bad length\n```\n\n(Please excuse the C++)\n\n```\n#include <iostream>\n#include <fstream>\n#include <string>\n#include <cassert>\n\n#include <curl/curl.h>\n\nsize_t WriteCallback(void* contents, size_t size, size_t nmemb, void* userp) {\n    ((std::string*)userp)->append((char*)contents, size * nmemb);\n    return size * nmemb;\n}\n\nint main(int argc, char* argv[]) {\n    if (argc < 2) {\n        std::cerr << \"Usage: \" << argv[0] << \" <url_file>\" << std::endl;\n        return 1;\n    }\n\n    std::ifstream urlFile(argv[1]);\n    if (!urlFile.is_open()) {\n        std::cerr << \"Failed to open file: \" << argv[1] << std::endl;\n        return 1;\n    }\n\n    std::string url;\n    std::getline(urlFile, url);\n    urlFile.close();\n\n    CURL* curl;\n    CURLcode res;\n    std::string response;\n\n    curl = curl_easy_init();\n    assert(curl && \"Failed to initialize CURL.\");\n\n    char* err = (char*)malloc(CURL_ERROR_SIZE);\n    assert(err && \"Failed to alloc err buf\");\n\n    curl_easy_setopt(curl, CURLOPT_URL, url.c_str());\n    curl_easy_setopt(curl, CURLOPT_WRITEFUNCTION, WriteCallback);\n    curl_easy_setopt(curl, CURLOPT_WRITEDATA, &response);\n    curl_easy_setopt(curl, CURLOPT_SSL_OPTIONS, CURLSSLOPT_NATIVE_CA);\n    curl_easy_setopt(curl, CURLOPT_ERRORBUFFER, err);\n\n    res = curl_easy_perform(curl);\n    if (res == CURLE_SEND_ERROR) {\n        std::cerr << \"CURLE_SEND_ERROR curl_easy_perform() failed: \" << curl_easy_strerror(res) << std::endl;\n        std::cerr << err << std::endl;\n    } else if (res != CURLE_OK) {\n        std::cerr << \"curl_easy_perform() failed: \" << curl_easy_strerror(res) << std::endl;\n        std::cerr << std::string(err) << std::endl;\n    } else {\n        std::cout << \"Successful\" << std::endl;\n    }\n\n    curl_easy_cleanup(curl);\n    free(err);\n\n    return 0;\n}\n```\n\nI think this is an issue with how openssl `SSL_write` is used, where it errors with `SSL_ERROR_WANT_WRITE` and expects to be presented with the same buffer again until it succeeds, but curl's openssl integration does something that is not exactly that.\n\nI tried a hacky workaround to confirm if this could be the issue, and it seems to work.\n\n```\ndiff --git a/lib/vtls/openssl.c b/lib/vtls/openssl.c\nindex 6ded5f3c0..712c70657 100644\n--- a/lib/vtls/openssl.c\n+++ b/lib/vtls/openssl.c\n@@ -5086,9 +5086,22 @@ static ssize_t ossl_send(struct Curl_cfilter *cf,\n   memlen = (len > (size_t)INT_MAX) ? INT_MAX : (int)len;\n   rc = SSL_write(octx->ssl, mem, memlen);\n\n-  if(rc <= 0) {\n+  while (rc <= 0) {\n     err = SSL_get_error(octx->ssl, rc);\n+    if (err == SSL_ERROR_WANT_WRITE) {\n+      // HACK: when erroring with SSL_ERROR_WANT_WRITE openssl wants you to\n+      // present the same buffer again once the underlying socket is ready.\n+      // Here we just try in a loop instead of polling the socket.\n+      //\n+      // This works around an issue with curl and https and _very_ long urls\n+      // (u16 max seems to be the breaking point for the size of the headers).\n+      rc = SSL_write(octx->ssl, mem, memlen);\n+    } else {\n+      break;\n+    }\n+  }\n\n+  if(rc <= 0) {\n     switch(err) {\n     case SSL_ERROR_WANT_READ:\n       connssl->io_need = CURL_SSL_IO_NEED_RECV;\n```\n\n### I expected the following\n\n_No response_\n\n### curl/libcurl version\n\nlibcurl 8.12.1 & libcurl 8.15.0\nopenssl 3.4.1\n\n### operating system\n\nWindows 10","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/18121/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/18121/timeline","performed_via_github_app":null,"state_reason":"completed"}