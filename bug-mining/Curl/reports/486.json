{"url":"https://api.github.com/repos/curl/curl/issues/13998","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/13998/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/13998/comments","events_url":"https://api.github.com/repos/curl/curl/issues/13998/events","html_url":"https://github.com/curl/curl/issues/13998","id":2369549511,"node_id":"I_kwDOAAiu0c6NPHTH","number":13998,"title":"LDAP not working with libcurl multi_socket interface","user":{"login":"saurabhsingh-dev","id":80470436,"node_id":"MDQ6VXNlcjgwNDcwNDM2","avatar_url":"https://avatars.githubusercontent.com/u/80470436?v=4","gravatar_id":"","url":"https://api.github.com/users/saurabhsingh-dev","html_url":"https://github.com/saurabhsingh-dev","followers_url":"https://api.github.com/users/saurabhsingh-dev/followers","following_url":"https://api.github.com/users/saurabhsingh-dev/following{/other_user}","gists_url":"https://api.github.com/users/saurabhsingh-dev/gists{/gist_id}","starred_url":"https://api.github.com/users/saurabhsingh-dev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/saurabhsingh-dev/subscriptions","organizations_url":"https://api.github.com/users/saurabhsingh-dev/orgs","repos_url":"https://api.github.com/users/saurabhsingh-dev/repos","events_url":"https://api.github.com/users/saurabhsingh-dev/events{/privacy}","received_events_url":"https://api.github.com/users/saurabhsingh-dev/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118197,"node_id":"MDU6TGFiZWwxODQxMTgxOTc=","url":"https://api.github.com/repos/curl/curl/labels/regression","name":"regression","color":"33aa3f","default":false,"description":null},{"id":462488871,"node_id":"MDU6TGFiZWw0NjI0ODg4NzE=","url":"https://api.github.com/repos/curl/curl/labels/LDAP","name":"LDAP","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2024-06-24T08:13:53Z","updated_at":"2024-06-26T06:45:28Z","closed_at":"2024-06-25T11:16:09Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\r\n\r\nIn my Ldap multi interface program, Ldap request started failing once i upgraded from curl-7.69.0 to curl-8.4.0. \r\n\r\nSo i tried latest curl version 8.8.0, where still seeing the same issue. \r\n\r\nTo rule out my program specific issues, i used standalone program for same from curl examples here [multi-uv](https://curl.se/libcurl/c/multi-uv.html)\r\n\r\ncompiled:\r\n`gcc -g -o multi-uv multi-uv.c -luv -lcurl`\r\n\r\nRun with licurl complied with debug mode: \r\n```\r\nroot@100-65-8-98:/tmp# ./multi-uv ldap://100.66.51.22:10389/ou=consumers,ou=system\r\n./multi-uv: /opt/avi/lib/libcurl.so.4: no version information available (required by ./multi-uv)\r\nCURL_OPENLDAP_TRACE = 65535\r\ncurl version: 8.8.0 OpenSSL/1.1.1f\r\n* !!! WARNING !!!\r\n* This is a debug build of libcurl, do not use in production.\r\nAdded download ldap://100.66.51.22:10389/ou=consumers,ou=system -> 1.download\r\n* STATE: INIT => SETUP handle 0x55c66c5999f8; line 1971\r\n* STATE: SETUP => CONNECT handle 0x55c66c5999f8; line 1987\r\n* Added connection 0. The cache now contains 1 members\r\n* STATE: CONNECT => CONNECTING handle 0x55c66c5999f8; line 2023\r\n*   Trying 100.66.51.22:10389...\r\n* Connected to 100.66.51.22 (100.66.51.22) port 10389\r\n* STATE: CONNECTING => PROTOCONNECT handle 0x55c66c5999f8; line 2131\r\n* LDAP 0x55c66c594bf8 state change from STOP to BIND\r\n* STATE: PROTOCONNECT => PROTOCONNECTING handle 0x55c66c5999f8; line 2155\r\n* Operation timed out after 10008 milliseconds with 0 bytes received\r\n* multi_done[PROTOCONNECTING]: status: 28 prem: 1 done: 0\r\n* multi_done, not reusing connection=0, forbid=0, close=1, premature=1, conn_multiplex=0\r\n* The cache now contains 0 members\r\n* Curl_disconnect(conn #0, dead=1)\r\n* Closing connection\r\nldap://100.66.51.22:10389/ou=consumers,ou=system DONE\r\n```\r\n\r\nThings i added in mentioned standalone program for testing: \r\n```\r\ncurl_easy_setopt(handle, CURLOPT_VERBOSE, 1L); // debug enable\r\ncurl_easy_setopt(handle, CURLOPT_TIMEOUT, 10L); // 2 sec\r\n//added before curl_multi_add_handle\r\n\r\ng_version = curl_version_info(CURLVERSION_NOW);\r\nfprintf(stderr, \"curl version: %s %s\\n\", g_version->version, g_version->ssl_version);\r\n// added in main and printed\r\n```\r\n\r\nPoints from my debugging using gdb: \r\n1. oldap_connecting is been called immediately after oldap_connect, since response is not received yet, ldap_result returns 0, which is timeout. \r\n2. multi_runsingle is not calling oldap_connecting again for response check. \r\n3. looks multi_runsingle -> oldp_connecting should be called when data is available or repeated calls should be made. \r\n\r\n### I expected the following\r\n\r\nFollowing run with curl 7.69.0, works fine. \r\n```\r\nroot@100-65-8-98:/tmp# ./multi-uv ldap://100.66.51.22:10389/ou=consumers,ou=system\r\n./multi-uv: /opt/avi/lib/libcurl.so.4: no version information available (required by ./multi-uv)\r\nCURL_OPENLDAP_TRACE = 65535\r\ncurl version: 7.69.0 OpenSSL/1.1.1f\r\nAdded download ldap://100.66.51.22:10389/ou=consumers,ou=system -> 1.download\r\n* STATE: INIT => CONNECT handle 0x564c5f4ca888; line 1617 (connection #-5000)\r\n* Marked for [keep alive]: OpenLDAP default\r\n* Added connection 0. The cache now contains 1 members\r\n*   Trying 100.66.51.22:10389...\r\n* STATE: CONNECT => WAITCONNECT handle 0x564c5f4ca888; line 1673 (connection #0)\r\n* Connected to 100.66.51.22 (100.66.51.22) port 10389 (#0)\r\n* STATE: WAITCONNECT => SENDPROTOCONNECT handle 0x564c5f4ca888; line 1791 (connection #0)\r\n* STATE: SENDPROTOCONNECT => PROTOCONNECT handle 0x564c5f4ca888; line 1808 (connection #0)\r\n* STATE: PROTOCONNECT => DO handle 0x564c5f4ca888; line 1827 (connection #0)\r\n* LDAP local: ldap://100.66.51.22:10389/ou=consumers,ou=system\r\n* STATE: DO => DO_DONE handle 0x564c5f4ca888; line 1882 (connection #0)\r\n* STATE: DO_DONE => PERFORM handle 0x564c5f4ca888; line 2003 (connection #0)\r\n* STATE: PERFORM => DONE handle 0x564c5f4ca888; line 2193 (connection #0)\r\n* multi_done\r\n* Connection #0 to host 100.66.51.22 left intact\r\n* Expire cleared (transfer 0x564c5f4ca888)\r\nldap://100.66.51.22:10389/ou=consumers,ou=system DONE\r\n```\r\n\r\n### curl/libcurl version\r\n\r\n```\r\nroot@100-65-8-98:/opt/avi/lib# curl -V\r\nWARNING: this libcurl is Debug-enabled, do not use in production\r\n\r\ncurl 8.8.0 (x86_64-pc-linux-gnu) libcurl/8.8.0 OpenSSL/1.1.1f zlib/1.2.11 libidn2/2.2.0 nghttp2/1.40.0 OpenLDAP/2.4.49\r\nRelease-Date: 2024-05-22\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps ipfs ipns ldap ldaps mqtt pop3 pop3s rtsp smb smbs smtp smtps telnet tftp\r\nFeatures: alt-svc AsynchDNS Debug HSTS HTTP2 HTTPS-proxy IDN IPv6 Largefile libz NTLM SSL threadsafe TLS-SRP TrackMemory UnixSockets\r\n```\r\n\r\n\r\n### operating system\r\n\r\nLinux 100-65-8-98 5.4.0-174-generic #193-Ubuntu SMP Thu Mar 7 14:29:28 UTC 2024 x86_64 x86_64 x86_64 GNU/Linux","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/13998/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/13998/timeline","performed_via_github_app":null,"state_reason":"completed"}