{"url":"https://api.github.com/repos/curl/curl/issues/18177","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/18177/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/18177/comments","events_url":"https://api.github.com/repos/curl/curl/issues/18177/events","html_url":"https://github.com/curl/curl/issues/18177","id":3292366277,"node_id":"I_kwDOAAiu0c7EPYXF","number":18177,"title":"Process stuck on http/2 multiplex negotiate after previous request timeout","user":{"login":"IoannisGS","id":8382457,"node_id":"MDQ6VXNlcjgzODI0NTc=","avatar_url":"https://avatars.githubusercontent.com/u/8382457?v=4","gravatar_id":"","url":"https://api.github.com/users/IoannisGS","html_url":"https://github.com/IoannisGS","followers_url":"https://api.github.com/users/IoannisGS/followers","following_url":"https://api.github.com/users/IoannisGS/following{/other_user}","gists_url":"https://api.github.com/users/IoannisGS/gists{/gist_id}","starred_url":"https://api.github.com/users/IoannisGS/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/IoannisGS/subscriptions","organizations_url":"https://api.github.com/users/IoannisGS/orgs","repos_url":"https://api.github.com/users/IoannisGS/repos","events_url":"https://api.github.com/users/IoannisGS/events{/privacy}","received_events_url":"https://api.github.com/users/IoannisGS/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":194601710,"node_id":"MDU6TGFiZWwxOTQ2MDE3MTA=","url":"https://api.github.com/repos/curl/curl/labels/HTTP/2","name":"HTTP/2","color":"009800","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":5,"created_at":"2025-08-05T09:42:35Z","updated_at":"2025-08-05T14:01:51Z","closed_at":"2025-08-05T14:01:51Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nHello,\nWe run into a very strange race condition after upgrading curl from version 8.12.1 to version 8.13.0. We tested even by building the library with the latest commits and the behaviour remains the same. It seems that it makes the curl library to wait forever a multiplex negotiation. \n\nThe following test is done with curl 8.15.0 with these curl settings:\n- CURLOPT_HTTP_VERSION : CURL_HTTP_VERSION_2_PRIOR_KNOWLEDGE\n- CURLOPT_PIPEWAIT : 1\n- CURLOPT_PROTOCOLS : CURLPROTO_HTTP | CURLPROTO_HTTPS\n- CURLOPT_TCP_KEEPALIVE : 1\n- CURLOPT_TIMEOUT_MS : 1\n- CURLMOPT_PIPELINING : CURLPIPE_MULTIPLEX\n\nAs our service connects to [envoy](https://www.envoyproxy.io/) on the same VM, which we know it supports http/2, we set the \"CURL_HTTP_VERSION_2_PRIOR_KNOWLEDGE\" header.\n\nBecause we set the \"CURLOPT_TIMEOUT_MS\" option there is a possibility that the request will timeout before the service responds. In that case curl with debug enabled will give us the following message:\n```\nOperation timed out after 1 milliseconds with 0 bytes received\n```\n\nEverything fine until now. The problem is that if the request that timeouts is the very **1st** request to that service, when the next request will stuck. Below are the messages that we see from curl before the process stuck:\n```\n[x-x] [MULTI] multi_timeout() says this has expired\n[1-x] [MULTI] [INIT] added to multi, mid=2, running=1, total=2\n1-x] [MULTI] [INIT] multi_run_dirty\n[1-x] [MULTI] [INIT] -> [SETUP] (line 2364)\n[1-x] [MULTI] [SETUP] set expire[10] in 1000ns\n[1-x] [MULTI] [SETUP] -> [CONNECT] (line 2380)\n[1-x] [READ] client_reset, clear readers\n[1-x] Connecting to hostname: 127.0.0.1\n[1-x] Connecting to port: 1234\n[1-x] Server upgrade does not support multiplex yet, wait\n[1-x] Waiting on connection to negotiate possible multiplexing.\n[1-x] [MULTI] [CONNECT] -> [PENDING] (line 2260)\n[1-x] [MULTI] [PENDING] multi_run_dirty\n```\n\nBy changing any of these curl settings to another value than the used ones, the issue goes away:\n- CURLOPT_HTTP_VERSION\n- CURLOPT_PIPEWAIT\n- CURLMOPT_PIPELINING\n\nI checked the changes and it seems that the issue started after https://github.com/curl/curl/pull/16073 due to:\n```\n--- a/lib/url.c\n+++ b/lib/url.c\n@@ -1002,7 +1002,7 @@ static bool url_match_conn(struct connectdata *conn, void *userdata)\n   if(match->may_multiplex &&\n      (data->state.httpwant == CURL_HTTP_VERSION_2_0) &&\n      (needle->handler->protocol & CURLPROTO_HTTP) &&\n-     !conn->httpversion) {\n+     !conn->httpversion_seen) {\n```\n\nIf the 1st request succeeds, the `httpversion_seen` is set, so this codepath is not triggered. The connection that was created on the 1st request and it will be reused on the 2nd request.\nIf the 1st request fails due to timeout and it does not get a response, the `httpversion_seen` is not set. The previous connection is left intact, but for some reason it is not reuse on the 2nd request.\n\n### I expected the following\n\nI would expect one of the following 2 scenarios:\n- The connection is closed after the 1st failed request and it is recreated on the 2nd one. Similar to what the code does if the connection does not use multiplex.\n- The connection can be reused on the second request, similar to the case that there are no issues.\n\nI tested the following patch on top of commit b2e6dae and it solves the problem by closing the connection. As I am new to the curl code, I do not know if there is a better way to handle this issue or if there are any side-effects due to this change.\n```\n--- a/lib/multi.c\n+++ b/lib/multi.c\n@@ -596,7 +596,9 @@ static void multi_done_locked(struct connectdata *conn,\n            conn->proxy_negotiate_state == GSS_AUTHRECV)\n #endif\n      ) || conn->bits.close\n-       || (mdctx->premature && !Curl_conn_is_multiplex(conn, FIRSTSOCKET))) {\n+       || (mdctx->premature && !Curl_conn_is_multiplex(conn, FIRSTSOCKET))\n+       || (mdctx->premature && Curl_conn_is_multiplex(conn, FIRSTSOCKET)\n+            && !conn->httpversion_seen)) {\n #ifndef CURL_DISABLE_VERBOSE_STRINGS\n```\n\n### curl/libcurl version\n\nIssue started from curl 8.13.0 until the latest commit\n\n### operating system\n\nCentOS Stream release 9\nKernel 5.14.0-596.el9.x86_64","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/18177/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/18177/timeline","performed_via_github_app":null,"state_reason":"completed"}