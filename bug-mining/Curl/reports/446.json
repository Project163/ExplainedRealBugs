{"url":"https://api.github.com/repos/curl/curl/issues/13439","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/13439/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/13439/comments","events_url":"https://api.github.com/repos/curl/curl/issues/13439/events","html_url":"https://github.com/curl/curl/issues/13439","id":2255255271,"node_id":"I_kwDOAAiu0c6GbHbn","number":13439,"title":"Quiche CI job occasionally fails during a download abort test","user":{"login":"jay","id":965580,"node_id":"MDQ6VXNlcjk2NTU4MA==","avatar_url":"https://avatars.githubusercontent.com/u/965580?v=4","gravatar_id":"","url":"https://api.github.com/users/jay","html_url":"https://github.com/jay","followers_url":"https://api.github.com/users/jay/followers","following_url":"https://api.github.com/users/jay/following{/other_user}","gists_url":"https://api.github.com/users/jay/gists{/gist_id}","starred_url":"https://api.github.com/users/jay/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jay/subscriptions","organizations_url":"https://api.github.com/users/jay/orgs","repos_url":"https://api.github.com/users/jay/repos","events_url":"https://api.github.com/users/jay/events{/privacy}","received_events_url":"https://api.github.com/users/jay/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2252760348,"node_id":"MDU6TGFiZWwyMjUyNzYwMzQ4","url":"https://api.github.com/repos/curl/curl/labels/CI","name":"CI","color":"ffb7ca","default":false,"description":"Continuous Integration"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2024-04-21T20:46:07Z","updated_at":"2024-06-18T15:59:55Z","closed_at":"2024-06-18T15:59:55Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"For the last few days there are occasional CI failures in the [quiche job](https://github.com/curl/curl/actions/workflows/quiche-linux.yml). It is hard to diagnose them because the logs are so large due to millions of \"curl_multi_poll() -> 0\" output (from [h2-download.c](https://github.com/curl/curl/blob/727c946d823750f4e7f33e3136a60aa8cda7ae95/tests/http/clients/h2-download.c#L376-L457)). The output is truncated and downloading the raw archive fails repeatedly.\r\n\r\nThe most recent commit to have the failure: \"[http: acknowledge a returned error code](https://github.com/curl/curl/actions/runs/8771459833)\". After repeated attempts github finally gave me the whole file. I stripped out most of the excess `curl_multi_poll() -> 0` to make it readable: [log.txt](https://github.com/curl/curl/files/15053465/log.txt). Excerpt:\r\n\r\n~~~\r\n2024-04-19T13:23:10.4146231Z =================================== FAILURES ===================================\r\n2024-04-19T13:23:10.4147994Z _______________ TestDownload.test_02_23a_lib_abort_paused[0-h3] ________________\r\n2024-04-19T13:23:10.4148530Z \r\n2024-04-19T13:23:10.4148762Z self = <test_02_download.TestDownload object at 0x7f6229f10220>\r\n2024-04-19T13:23:10.4149272Z env = <testenv.env.Env object at 0x7f622a029de0>\r\n2024-04-19T13:23:10.4151755Z httpd = <testenv.httpd.Httpd object at 0x7f622a0c8cd0>\r\n2024-04-19T13:23:10.4152554Z nghttpx = <testenv.nghttpx.NghttpxQuic object at 0x7f6229e01a50>, proto = 'h3'\r\n2024-04-19T13:23:10.4153075Z repeat = 0\r\n2024-04-19T13:23:10.4153232Z \r\n2024-04-19T13:23:10.4153536Z     @pytest.mark.parametrize(\"proto\", ['http/1.1', 'h2', 'h3'])\r\n2024-04-19T13:23:10.4154389Z     def test_02_23a_lib_abort_paused(self, env: Env, httpd, nghttpx, proto, repeat):\r\n2024-04-19T13:23:10.4155785Z         if proto == 'h3' and env.curl_uses_ossl_quic():\r\n2024-04-19T13:23:10.4156581Z             pytest.skip('OpenSSL QUIC fails here')\r\n2024-04-19T13:23:10.4157297Z         if proto in ['h2', 'h3']:\r\n2024-04-19T13:23:10.4157859Z             count = 200\r\n2024-04-19T13:23:10.4158352Z             max_parallel = 100\r\n2024-04-19T13:23:10.4158884Z             pause_offset = 64 * 1024\r\n2024-04-19T13:23:10.4159411Z         else:\r\n2024-04-19T13:23:10.4159791Z             count = 10\r\n2024-04-19T13:23:10.4160242Z             max_parallel = 5\r\n2024-04-19T13:23:10.4160735Z             pause_offset = 12 * 1024\r\n2024-04-19T13:23:10.4161363Z         docname = 'data-1m'\r\n2024-04-19T13:23:10.4162094Z         url = f'https://localhost:{env.https_port}/{docname}'\r\n2024-04-19T13:23:10.4162969Z         client = LocalClient(name='h2-download', env=env)\r\n2024-04-19T13:23:10.4163644Z         if not client.exists():\r\n2024-04-19T13:23:10.4164444Z             pytest.skip(f'example client not built: {client.name}')\r\n2024-04-19T13:23:10.4165217Z         r = client.run(args=[\r\n2024-04-19T13:23:10.4165944Z             '-n', f'{count}', '-m', f'{max_parallel}', '-a',\r\n2024-04-19T13:23:10.4166849Z             '-P', f'{pause_offset}', '-V', proto, url\r\n2024-04-19T13:23:10.4167483Z         ])\r\n2024-04-19T13:23:10.4167901Z >       r.check_exit_code(0)\r\n2024-04-19T13:23:10.4168254Z \r\n2024-04-19T13:23:10.4168463Z tests/http/test_02_download.py:352: \r\n2024-04-19T13:23:10.4169267Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \r\n2024-04-19T13:23:10.4169846Z \r\n2024-04-19T13:23:10.4171917Z self = ExecResult[code=-1, exception=TimeoutExpired, args=['/home/runner/work/curl/curl/tests/http/clients/h2-download', '-n'... 0\\n', 'curl_multi_poll() -> 0\\n', 'curl_multi_poll() -> 0\\n', 'curl_multi_poll() -> 0\\n', 'curl_multi_poll() -> 0\\n']]\r\n2024-04-19T13:23:10.4174046Z code = 0\r\n2024-04-19T13:23:10.4174270Z \r\n2024-04-19T13:23:10.4174793Z     def check_exit_code(self, code: Union[int, bool]):\r\n2024-04-19T13:23:10.4175484Z         if code is True:\r\n2024-04-19T13:23:10.4176298Z             assert self.exit_code == 0, f'expected exit code {code}, '\\\r\n2024-04-19T13:23:10.4177313Z                                         f'got {self.exit_code}\\n{self.dump_logs()}'\r\n2024-04-19T13:23:10.4178041Z         elif code is False:\r\n2024-04-19T13:23:10.4178857Z             assert self.exit_code != 0, f'expected exit code {code}, '\\\r\n2024-04-19T13:23:10.4179893Z                                                 f'got {self.exit_code}\\n{self.dump_logs()}'\r\n2024-04-19T13:23:10.4180599Z         else:\r\n2024-04-19T13:23:10.4181334Z >           assert self.exit_code == code, f'expected exit code {code}, '\\\r\n2024-04-19T13:23:10.4182380Z                                            f'got {self.exit_code}\\n{self.dump_logs()}'\r\n2024-04-19T13:23:10.4183260Z E           AssertionError: expected exit code 0, got -1\r\n~~~\r\n\r\nProbably related to 08d10d2a even though its quiche job passed. I'm not finding failures before then and I don't know what else it could be.\r\n\r\n/cc @icing","closed_by":{"login":"jay","id":965580,"node_id":"MDQ6VXNlcjk2NTU4MA==","avatar_url":"https://avatars.githubusercontent.com/u/965580?v=4","gravatar_id":"","url":"https://api.github.com/users/jay","html_url":"https://github.com/jay","followers_url":"https://api.github.com/users/jay/followers","following_url":"https://api.github.com/users/jay/following{/other_user}","gists_url":"https://api.github.com/users/jay/gists{/gist_id}","starred_url":"https://api.github.com/users/jay/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jay/subscriptions","organizations_url":"https://api.github.com/users/jay/orgs","repos_url":"https://api.github.com/users/jay/repos","events_url":"https://api.github.com/users/jay/events{/privacy}","received_events_url":"https://api.github.com/users/jay/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/13439/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/13439/timeline","performed_via_github_app":null,"state_reason":"not_planned"}