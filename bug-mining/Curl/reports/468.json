{"url":"https://api.github.com/repos/curl/curl/issues/13754","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/13754/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/13754/comments","events_url":"https://api.github.com/repos/curl/curl/issues/13754/events","html_url":"https://github.com/curl/curl/issues/13754","id":2312073043,"node_id":"I_kwDOAAiu0c6Jz29T","number":13754,"title":"aws-sigv4 does not work with URLs containing \"=\" and other special characters","user":{"login":"ashtuchkin","id":627997,"node_id":"MDQ6VXNlcjYyNzk5Nw==","avatar_url":"https://avatars.githubusercontent.com/u/627997?v=4","gravatar_id":"","url":"https://api.github.com/users/ashtuchkin","html_url":"https://github.com/ashtuchkin","followers_url":"https://api.github.com/users/ashtuchkin/followers","following_url":"https://api.github.com/users/ashtuchkin/following{/other_user}","gists_url":"https://api.github.com/users/ashtuchkin/gists{/gist_id}","starred_url":"https://api.github.com/users/ashtuchkin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ashtuchkin/subscriptions","organizations_url":"https://api.github.com/users/ashtuchkin/orgs","repos_url":"https://api.github.com/users/ashtuchkin/repos","events_url":"https://api.github.com/users/ashtuchkin/events{/privacy}","received_events_url":"https://api.github.com/users/ashtuchkin/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118243,"node_id":"MDU6TGFiZWwxODQxMTgyNDM=","url":"https://api.github.com/repos/curl/curl/labels/HTTP","name":"HTTP","color":"207de5","default":false,"description":null},{"id":538402904,"node_id":"MDU6TGFiZWw1Mzg0MDI5MDQ=","url":"https://api.github.com/repos/curl/curl/labels/authentication","name":"authentication","color":"e99695","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2024-05-23T06:34:08Z","updated_at":"2024-08-05T07:33:22Z","closed_at":"2024-05-29T11:03:16Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nI'm trying to use --aws-sigv4 to download S3 objects containing \"=\" in their key. Example `data/asset_id=my-asset/dt=2024-05-22/data.parquet` - this is called hive partitioning scheme and is popular in data lakes.\r\n\r\nHere's how I call it:\r\n```shell\r\nBUCKET=\"lasca-prod\"\r\nKEY=\"data/asset_id=my-asset/dt=2024-05-22/data.parquet\"\r\ncurl --aws-sigv4 \"aws:amz:us-west-2:s3\" \\\r\n    --user \"${AWS_ACCESS_KEY_ID}:${AWS_SECRET_ACCESS_KEY}\" \\\r\n    -H \"x-amz-security-token: ${AWS_SESSION_TOKEN}\" \\\r\n    \"https://s3.us-west-2.amazonaws.com/$BUCKET/$KEY\"\r\n```\r\n\r\nCurl 8.8 returns the following error (formatted for readability):\r\n```xml\r\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<Error>\r\n    <Code>SignatureDoesNotMatch</Code>\r\n    <Message>The request signature we calculated does not match the signature you provided. Check your key and signing method.</Message>\r\n    <AWSAccessKeyId>snip</AWSAccessKeyId>\r\n    <StringToSign>AWS4-HMAC-SHA256\r\n20240523T061547Z\r\n20240523/us-west-2/s3/aws4_request\r\nce199afb9ea57628628a3d3254934e1ee480977872d06b3da40baa5ae4d2f9a7</StringToSign>\r\n    <SignatureProvided>snip</SignatureProvided>\r\n    <StringToSignBytes>snip</StringToSignBytes>\r\n    <CanonicalRequest>GET\r\n/lasca-prod/data/asset_id%3Dmy-asset/dt%3D2024-05-22/data.parquet\r\n\r\nhost:s3.us-west-2.amazonaws.com\r\nx-amz-content-sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855\r\nx-amz-date:20240523T061547Z\r\nx-amz-security-token:snip \r\n\r\nhost;x-amz-content-sha256;x-amz-date;x-amz-security-token\r\ne3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855</CanonicalRequest>\r\n  ...\r\n</Error>\r\n```\r\n\r\nNote that the path in CanonicalRequest is supposed to be quoted (\"=\" changed to \"%3D\"), whereas curl is not quoting it (confirmed by debug tracing). [AWS docs](https://docs.aws.amazon.com/AmazonS3/latest/API/sigv4-query-string-auth.html) say we need to apply their special URIEncode function to all the components of the canonical request.\r\n\r\nI've created a basic patch to see if this is the actual problem and after applying it, the signature is accepted by AWS S3:\r\n```patch\r\ndiff --git a/lib/http_aws_sigv4.c b/lib/http_aws_sigv4.c\r\nindex 98cc033..18567b4 100644\r\n--- a/lib/http_aws_sigv4.c\r\n+++ b/lib/http_aws_sigv4.c\r\n@@ -423,6 +423,19 @@ static int compare_func(const void *a, const void *b)\r\n\r\n #define MAX_QUERYPAIRS 64\r\n\r\n+static CURLcode canon_path(struct Curl_easy *data, const char *path, struct dynbuf *dq)\r\n+{\r\n+  CURLcode result = CURLE_OK;\r\n+  for (const char *p = path; *p && !result; p++) {\r\n+    if (*p == '=') {\r\n+        result = Curl_dyn_addn(dq, \"%3D\", 3);\r\n+    } else {\r\n+        result = Curl_dyn_addn(dq, p, 1);\r\n+    }\r\n+  }\r\n+  return result;\r\n+}\r\n+\r\n static CURLcode canon_query(struct Curl_easy *data,\r\n                             const char *query, struct dynbuf *dq)\r\n {\r\n@@ -540,6 +553,7 @@ CURLcode Curl_output_aws_sigv4(struct Curl_easy *data, bool proxy)\r\n   struct dynbuf canonical_headers;\r\n   struct dynbuf signed_headers;\r\n   struct dynbuf canonical_query;\r\n+  struct dynbuf canonical_path;\r\n   char *date_header = NULL;\r\n   Curl_HttpReq httpreq;\r\n   const char *method = NULL;\r\n@@ -569,6 +583,7 @@ CURLcode Curl_output_aws_sigv4(struct Curl_easy *data, bool proxy)\r\n   /* we init those buffers here, so goto fail will free initialized dynbuf */\r\n   Curl_dyn_init(&canonical_headers, CURL_MAX_HTTP_HEADER);\r\n   Curl_dyn_init(&canonical_query, CURL_MAX_HTTP_HEADER);\r\n+  Curl_dyn_init(&canonical_path, CURL_MAX_HTTP_HEADER);\r\n   Curl_dyn_init(&signed_headers, CURL_MAX_HTTP_HEADER);\r\n\r\n   /*\r\n@@ -696,6 +711,10 @@ CURLcode Curl_output_aws_sigv4(struct Curl_easy *data, bool proxy)\r\n   date[sizeof(date) - 1] = 0;\r\n\r\n   result = canon_query(data, data->state.up.query, &canonical_query);\r\n+  if(result)\r\n+    goto fail;\r\n+\r\n+  result = canon_path(data, data->state.up.path, &canonical_path);\r\n   if(result)\r\n     goto fail;\r\n   result = CURLE_OUT_OF_MEMORY;\r\n@@ -708,7 +727,7 @@ CURLcode Curl_output_aws_sigv4(struct Curl_easy *data, bool proxy)\r\n                   \"%s\\n\" /* SignedHeaders */\r\n                   \"%.*s\",  /* HashedRequestPayload in hex */\r\n                   method,\r\n-                  data->state.up.path,\r\n+                  Curl_dyn_ptr(&canonical_path),\r\n                   Curl_dyn_ptr(&canonical_query) ?\r\n                   Curl_dyn_ptr(&canonical_query) : \"\",\r\n                   Curl_dyn_ptr(&canonical_headers),\r\n```\r\n\r\nThis seems similar to a known problem [16.1 aws-sigv4 does not sign requests with * correctly](https://github.com/curl/curl/issues/7559). I see that there [was a PR](https://github.com/curl/curl/pull/7600) to fix it, but it's now dead. \r\n\r\nMy intent with creating this issue is 1) to say that the scope of the bug is not limited to \"*\", but applies to any URL with any characters except alphanumeric and `-`, `.`, `_` and `~`, 2) hopefully resurrect the push to fix it.\n\n### I expected the following\n\nThe command above should work as-is.\n\n### curl/libcurl version\n\ncurl 8.8.0 (x86_64-pc-linux-gnu) libcurl/8.8.0 OpenSSL/3.3.0 zlib/1.3.1 brotli/1.1.0 zstd/1.5.6 c-ares/1.28.1 libidn2/2.3.7 libpsl/0.21.5 libssh2/1.11.0 nghttp2/1.62.1 nghttp3/1.3.0\r\nRelease-Date: 2024-05-22\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps ipfs ipns mqtt pop3 pop3s rtsp scp sftp smb smbs smtp smtps telnet tftp ws wss\r\nFeatures: alt-svc AsynchDNS brotli HSTS HTTP2 HTTP3 HTTPS-proxy IDN IPv6 Largefile libz NTLM PSL SSL threadsafe TLS-SRP TrackMemory UnixSockets zstd\r\n\n\n### operating system\n\nLinux 5.15.0-1058-aws #64~20.04.1-Ubuntu SMP Tue Apr 9 11:12:27 UTC 2024 x86_64 x86_64 x86_64 GNU/Linux\r\n","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/13754/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/13754/timeline","performed_via_github_app":null,"state_reason":"completed"}