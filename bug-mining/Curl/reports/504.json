{"url":"https://api.github.com/repos/curl/curl/issues/14278","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/14278/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/14278/comments","events_url":"https://api.github.com/repos/curl/curl/issues/14278/events","html_url":"https://github.com/curl/curl/issues/14278","id":2432055984,"node_id":"I_kwDOAAiu0c6Q9jqw","number":14278,"title":"wolfSSL X509_STORE use after free due to CA caching","user":{"login":"alexsn","id":987019,"node_id":"MDQ6VXNlcjk4NzAxOQ==","avatar_url":"https://avatars.githubusercontent.com/u/987019?v=4","gravatar_id":"","url":"https://api.github.com/users/alexsn","html_url":"https://github.com/alexsn","followers_url":"https://api.github.com/users/alexsn/followers","following_url":"https://api.github.com/users/alexsn/following{/other_user}","gists_url":"https://api.github.com/users/alexsn/gists{/gist_id}","starred_url":"https://api.github.com/users/alexsn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alexsn/subscriptions","organizations_url":"https://api.github.com/users/alexsn/orgs","repos_url":"https://api.github.com/users/alexsn/repos","events_url":"https://api.github.com/users/alexsn/events{/privacy}","received_events_url":"https://api.github.com/users/alexsn/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":12,"created_at":"2024-07-26T11:43:12Z","updated_at":"2024-07-29T17:54:42Z","closed_at":"2024-07-29T17:54:42Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\r\n\r\nTried upgrading curl to 8.9.0 which triggered a use-after-free bug in wolfssl X509_STORE caching code (added in 80aa5195458869aa42040bef0c7f38be6846b470):\r\n```\r\nstderr:\r\n=================================================================\r\n==3959875==ERROR: AddressSanitizer: heap-use-after-free on address 0x61d000005850 at pc 0x0000029b33e4 bp 0x7ffdd7d77d50 sp 0x7ffdd7d77d48\r\nREAD of size 4 at 0x61d000005850 thread T0\r\n    #0 0x29b33e3 in wolfSSL_X509_STORE_free fbsource/src/x509_str.c:800:33\r\n    #1 0x275e59f in wssl_x509_share_free arvr/third-party/curl/curl-8.9.0/lib/vtls/wolfssl.c:461:5\r\n    #2 0x264cd74 in hash_element_dtor arvr/third-party/curl/curl-8.9.0/lib/hash.c:44:7\r\n    #3 0x269f125 in Curl_llist_remove arvr/third-party/curl/curl-8.9.0/lib/llist.c:146:5\r\n    #4 0x269f380 in Curl_llist_destroy arvr/third-party/curl/curl-8.9.0/lib/llist.c:154:7\r\n    #5 0x264d512 in Curl_hash_destroy arvr/third-party/curl/curl-8.9.0/lib/hash.c:219:7\r\n    #6 0x26b10c5 in curl_multi_cleanup arvr/third-party/curl/curl-8.9.0/lib/multi.c:2847:5\r\n    #7 0x2708a81 in Curl_close arvr/third-party/curl/curl-8.9.0/lib/url.c:251:7\r\n    #8 0x25e6f9c in curl_easy_cleanup arvr/third-party/curl/curl-8.9.0/lib/easy.c:813:5\r\n0x61d000005850 is located 2000 bytes inside of 2304-byte region [0x61d000005080,0x61d000005980)\r\nfreed by thread T0 here:\r\n    #0 0x21dc157 in __interceptor_free.part.0 crtstuff.c\r\n    #1 0x2ab6438 in wolfSSL_Free third-party/wolfssl/wolfcrypt/src/memory.c:437:9\r\n    #2 0x28df33d in FreeSSL_Ctx third-party/wolfssl/src/internal.c:2757:9\r\n    #3 0x29631fd in wolfSSL_CTX_free third-party/wolfssl/src/ssl.c:1401:9\r\n    #4 0x275c729 in wolfssl_close arvr/third-party/curl/curl-8.9.0/lib/vtls/wolfssl.c:1472:5\r\n    #5 0x275895d in cf_close arvr/third-party/curl/curl-8.9.0/lib/vtls/vtls.c:1544:5\r\n    #6 0x2753862 in ssl_cf_close arvr/third-party/curl/curl-8.9.0/lib/vtls/vtls.c:1656:3\r\n    #7 0x260af41 in cf_setup_close arvr/third-party/curl/curl-8.9.0/lib/connect.c:1382:5\r\n    #8 0x267e1f3 in cf_h2_close arvr/third-party/curl/curl-8.9.0/lib/http2.c:2450:5\r\n    #9 0x261bc68 in cf_hc_close arvr/third-party/curl/curl-8.9.0/lib/cf-https-connect.c:459:5\r\n    #10 0x25fb52c in Curl_conn_close arvr/third-party/curl/curl-8.9.0/lib/cfilters.c:176:5\r\n    #11 0x260f5b3 in connc_disconnect arvr/third-party/curl/curl-8.9.0/lib/conncache.c:992:3\r\n    #12 0x2612e35 in connc_shutdown_discard_all arvr/third-party/curl/curl-8.9.0/lib/conncache.c:570:5\r\n    #13 0x260ffee in connc_shutdown_all arvr/third-party/curl/curl-8.9.0/lib/conncache.c:1134:3\r\n    #14 0x260ffee in connc_close_all arvr/third-party/curl/curl-8.9.0/lib/conncache.c:611:3\r\n    #15 0x2612771 in Curl_conncache_multi_close_all arvr/third-party/curl/curl-8.9.0/lib/conncache.c:1058:3\r\n    #16 0x26b10ad in curl_multi_cleanup arvr/third-party/curl/curl-8.9.0/lib/multi.c:2844:5\r\n    #17 0x2708a81 in Curl_close arvr/third-party/curl/curl-8.9.0/lib/url.c:251:7\r\n    #18 0x25e6f9c in curl_easy_cleanup arvr/third-party/curl/curl-8.9.0/lib/easy.c:813:5\r\npreviously allocated by thread T0 here:\r\n    #0 0x21dd31f in malloc (...) \r\n    #1 0x2ab6418 in wolfSSL_Malloc third-party/wolfssl/wolfcrypt/src/memory.c:352:15\r\n    #2 0x2962c41 in wolfSSL_CTX_new_ex third-party/wolfssl/src/ssl.c:1304:25\r\n    #3 0x298a48a in wolfSSL_CTX_new third-party/wolfssl/src/ssl.c:1367:12\r\n    #4 0x2760322 in wolfssl_connect_step1 arvr/third-party/curl/curl-8.9.0/lib/vtls/wolfssl.c:697:18\r\n    #5 0x2760322 in wolfssl_connect_common arvr/third-party/curl/curl-8.9.0/lib/vtls/wolfssl.c:1608:14\r\n    #6 0x275c580 in wolfssl_connect_nonblocking arvr/third-party/curl/curl-8.9.0/lib/vtls/wolfssl.c:1689:10\r\n    #7 0x2758c0f in ssl_connect_nonblocking arvr/third-party/curl/curl-8.9.0/lib/vtls/vtls.c:512:10\r\n    #8 0x27531cf in ssl_cf_connect arvr/third-party/curl/curl-8.9.0/lib/vtls/vtls.c:1697:14\r\n    #9 0x25fd232 in Curl_conn_cf_connect arvr/third-party/curl/curl-8.9.0/lib/cfilters.c:371:12\r\n    #10 0x2609859 in cf_setup_connect arvr/third-party/curl/curl-8.9.0/lib/connect.c:1284:14\r\n    #11 0x25fd232 in Curl_conn_cf_connect arvr/third-party/curl/curl-8.9.0/lib/cfilters.c:371:12\r\n    #12 0x261e05d in cf_hc_baller_connect arvr/third-party/curl/curl-8.9.0/lib/cf-https-connect.c:136:15\r\n    #13 0x261a6d8 in cf_hc_connect arvr/third-party/curl/curl-8.9.0/lib/cf-https-connect.c:288:16\r\n    #14 0x25fd66d in Curl_conn_connect arvr/third-party/curl/curl-8.9.0/lib/cfilters.c:419:14\r\n    #15 0x26b88aa in multi_runsingle arvr/third-party/curl/curl-8.9.0/lib/multi.c:2107:16\r\n    #16 0x26b6cc0 in curl_multi_perform arvr/third-party/curl/curl-8.9.0/lib/multi.c:2742:16\r\n    #17 0x25e6b0b in easy_transfer arvr/third-party/curl/curl-8.9.0/lib/easy.c:676:15\r\n    #18 0x25e6b0b in easy_perform arvr/third-party/curl/curl-8.9.0/lib/easy.c:770:42\r\n    #19 0x25e6b0b in curl_easy_perform arvr/third-party/curl/curl-8.9.0/lib/easy.c:789:10\r\nSUMMARY: AddressSanitizer: heap-use-after-free fbsource/src/x509_str.c:800:33 in wolfSSL_X509_STORE_free\r\nShadow bytes around the buggy address:\r\n  0x0c3a7fff8ab0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd\r\n  0x0c3a7fff8ac0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd\r\n  0x0c3a7fff8ad0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd\r\n  0x0c3a7fff8ae0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd\r\n  0x0c3a7fff8af0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd\r\n=>0x0c3a7fff8b00: fd fd fd fd fd fd fd fd fd fd[fd]fd fd fd fd fd\r\n  0x0c3a7fff8b10: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\r\n  0x0c3a7fff8b20: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\r\n  0x0c3a7fff8b30: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\r\n  0x0c3a7fff8b40: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\r\n  0x0c3a7fff8b50: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd\r\nShadow byte legend (one shadow byte represents 8 application bytes):\r\n  Addressable:           00\r\n  Partially addressable: 01 02 03 04 05 06 07 \r\n  Heap left redzone:       fa\r\n  Freed heap region:       fd\r\n  Stack left redzone:      f1\r\n  Stack mid redzone:       f2\r\n  Stack right redzone:     f3\r\n  Stack after return:      f5\r\n  Stack use after scope:   f8\r\n  Global redzone:          f9\r\n  Global init order:       f6\r\n  Poisoned by user:        f7\r\n  Container overflow:      fc\r\n  Array cookie:            ac\r\n  Intra object redzone:    bb\r\n  ASan internal:           fe\r\n  Left alloca redzone:     ca\r\n  Right alloca redzone:    cb\r\n==3959875==ABORTING\r\n```\r\n\r\nThe issue here being that X509_STORE in question is actually embedded in wolfSSL_CTX [here](https://github.com/wolfSSL/wolfssl/blob/92f1c6e339e3b77258f70b4dee89da0f690210d0/wolfssl/internal.h#L3926) as we get it from wolfSSL_CTX_get_cert_store [here](https://github.com/curl/curl/blob/11e248b782d9a7919f0b138a81ea4c4b693dc91e/lib/vtls/wolfssl.c#L589).\r\n\r\nThe point here is that we need to check whether `WOLFSSL_X509_STORE->isDynamic == TRUE` before we can do this (isDynamic is defined [here](https://github.com/wolfSSL/wolfssl/blob/92f1c6e339e3b77258f70b4dee89da0f690210d0/wolfssl/ssl.h#L581) but is under an ifdef). In any case, is it possible to disable this CA caching thing via some API call?\r\n\r\n\r\n\r\n\r\n\r\n### I expected the following\r\n\r\n_No response_\r\n\r\n### curl/libcurl version\r\n\r\ncurl 8.9.0 with wolfSSL\r\n\r\n### operating system\r\n\r\nLinux","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/14278/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":1,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/14278/timeline","performed_via_github_app":null,"state_reason":"completed"}