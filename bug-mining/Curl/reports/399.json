{"url":"https://api.github.com/repos/curl/curl/issues/12181","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/12181/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/12181/comments","events_url":"https://api.github.com/repos/curl/curl/issues/12181/events","html_url":"https://github.com/curl/curl/issues/12181","id":1956274481,"node_id":"I_kwDOAAiu0c50mmEx","number":12181,"title":"FTP upload fails if remebered dir is deleted","user":{"login":"JayDommaschk","id":68367976,"node_id":"MDQ6VXNlcjY4MzY3OTc2","avatar_url":"https://avatars.githubusercontent.com/u/68367976?v=4","gravatar_id":"","url":"https://api.github.com/users/JayDommaschk","html_url":"https://github.com/JayDommaschk","followers_url":"https://api.github.com/users/JayDommaschk/followers","following_url":"https://api.github.com/users/JayDommaschk/following{/other_user}","gists_url":"https://api.github.com/users/JayDommaschk/gists{/gist_id}","starred_url":"https://api.github.com/users/JayDommaschk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JayDommaschk/subscriptions","organizations_url":"https://api.github.com/users/JayDommaschk/orgs","repos_url":"https://api.github.com/users/JayDommaschk/repos","events_url":"https://api.github.com/users/JayDommaschk/events{/privacy}","received_events_url":"https://api.github.com/users/JayDommaschk/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118265,"node_id":"MDU6TGFiZWwxODQxMTgyNjU=","url":"https://api.github.com/repos/curl/curl/labels/FTP","name":"FTP","color":"bfd4f2","default":false,"description":null},{"id":352090567,"node_id":"MDU6TGFiZWwzNTIwOTA1Njc=","url":"https://api.github.com/repos/curl/curl/labels/KNOWN_BUGS%20material","name":"KNOWN_BUGS material","color":"d93f0b","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2023-10-23T03:19:50Z","updated_at":"2024-02-10T17:49:01Z","closed_at":"2024-02-10T17:49:01Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nI have some server application which would upload files to some FTP server upon certain events. The user sets the path to which the file should be uploaded. If the target folder doesn't already exists, curl creates the folder and then \"remembers we are in dir ...\", which is all good. However, if someone, for whatever reason, where to delete the target folder from the server, then subsequent uploads will fail.\r\n\r\nThis can be seen with the following super simple test code:\r\n\r\n```c\r\n#include <curl/curl.h>\r\n#include <sys/stat.h>\r\n#include <unistd.h>\r\n\r\n#define TEST_FILE_PATH \"/tmp/testfile\"\r\n#define TEST_FOLDER \"/folder/\"\r\n\r\nint main()\r\n{\r\n    FILE *file = fopen(TEST_FILE_PATH, \"rb\");\r\n    struct stat file_info;\r\n    stat(TEST_FILE_PATH, &file_info);\r\n\r\n    char SERVER_URL[512];\r\n    CURLcode res = CURLE_OK;\r\n    CURL *curl = curl_easy_init();\r\n\r\n    curl_version_info_data *ver = curl_version_info(CURLVERSION_NOW);\r\n    printf(\"curl version: %u.%u.%u\\n\", (ver->version_num >> 16) & 0xff,\r\n                                       (ver->version_num >> 8) & 0xff,\r\n                                       ver->version_num & 0xff);\r\n\r\n    curl_easy_setopt(curl, CURLOPT_USERNAME, \"test\");\r\n    curl_easy_setopt(curl, CURLOPT_PASSWORD, \"testtest\");\r\n\r\n    snprintf(SERVER_URL, sizeof(SERVER_URL), \"ftp://%s:%s/%s%s\", \"192.168.0.104\", \"21\", TEST_FOLDER, \"curltest.txt\");\r\n    curl_easy_setopt(curl, CURLOPT_URL, SERVER_URL);\r\n    curl_easy_setopt(curl, CURLOPT_INFILESIZE_LARGE, (curl_off_t)(file_info.st_size));\r\n    curl_easy_setopt(curl, CURLOPT_FTP_CREATE_MISSING_DIRS, CURLFTP_CREATE_DIR_RETRY);\r\n    curl_easy_setopt(curl, CURLOPT_READDATA, file);\r\n    curl_easy_setopt(curl, CURLOPT_UPLOAD, 1L);\r\n\r\n    curl_easy_setopt(curl, CURLOPT_VERBOSE, 1L);\r\n\r\n    for (int i = 0; i < 10; ++i)\r\n    {\r\n        res = curl_easy_perform(curl);\r\n        printf(\"curl result: %s (%d)\\n\", curl_easy_strerror(res), res);\r\n        if (res != CURLE_OK)\r\n            break;\r\n        sleep(10);\r\n        fseek(file, 0, SEEK_SET);\r\n    }\r\n    fclose(file);\r\n    curl_easy_cleanup(curl);\r\n}\r\n```\r\n\r\nwhich produces the following output, where between the second and third upload, I went to the file system of my FTP server and deleted the folder \"folder\":\r\n```console\r\ncurl version: 8.4.0\r\n*   Trying 192.168.0.104:21...\r\n* Connected to 192.168.0.104 (192.168.0.104) port 21\r\n< 220-FileZilla Server 1.4.1\r\n< 220 Please visit https://filezilla-project.org/\r\n> USER test\r\n< 331 Please, specify the password.\r\n> PASS testtest\r\n< 230 Login successful.\r\n> PWD\r\n< 257 \"/\" is current directory.\r\n* Entry path is '/'\r\n> CWD /\r\n* ftp_perform ends with SECONDARY: 0\r\n< 250 CWD command successful\r\n> CWD Folder\r\n< 550 Couldn't open the file or directory\r\n> MKD Folder\r\n< 257 \"/Folder\" created successfully.\r\n> CWD Folder\r\n< 250 CWD command successful\r\n> EPSV\r\n* Connect data stream passively\r\n< 229 Entering Extended Passive Mode (|||49211|)\r\n* Connecting to 192.168.0.104 (192.168.0.104) port 49211\r\n*   Trying 192.168.0.104:49211...\r\n* Connected to 192.168.0.104 (192.168.0.104) port 21\r\n> TYPE I\r\n< 200 Type set to I\r\n> STOR curltest.txt\r\n< 150 Starting data transfer.\r\n* We are completely uploaded and fine\r\n* Remembering we are in dir \"/Folder/\"\r\n< 226 Operation successful\r\n* Connection #0 to host 192.168.0.104 left intact\r\ncurl result: No error (0)\r\n\r\n* Found bundle for host: 0x1af9c70 [serially]\r\n* Re-using existing connection with host 192.168.0.104\r\n* Request has same path as previous transfer\r\n> EPSV\r\n* Connect data stream passively\r\n* ftp_perform ends with SECONDARY: 0\r\n< 229 Entering Extended Passive Mode (|||49212|)\r\n* Connecting to 192.168.0.104 (192.168.0.104) port 49212\r\n*   Trying 192.168.0.104:49212...\r\n* Connected to 192.168.0.104 (192.168.0.104) port 21\r\n> STOR curltest.txt\r\n< 150 Starting data transfer.\r\n* We are completely uploaded and fine\r\n* Remembering we are in dir \"/Folder/\"\r\n< 226 Operation successful\r\n* Connection #0 to host 192.168.0.104 left intact\r\ncurl result: No error (0)\r\n\r\n* Found bundle for host: 0x1af9c70 [serially]\r\n* Re-using existing connection with host 192.168.0.104\r\n* Request has same path as previous transfer\r\n> EPSV\r\n* Connect data stream passively\r\n* ftp_perform ends with SECONDARY: 0\r\n< 229 Entering Extended Passive Mode (|||49213|)\r\n* Connecting to 192.168.0.104 (192.168.0.104) port 49213\r\n*   Trying 192.168.0.104:49213...\r\n* Connected to 192.168.0.104 (192.168.0.104) port 21\r\n> STOR curltest.txt\r\n< 550 Couldn't open the file or directory\r\n* Failed FTP upload: 550\r\n* Remembering we are in dir \"/Folder/\"\r\n* Uploaded unaligned file size (0 out of 7 bytes)\r\n* Connection #0 to host 192.168.0.104 left intact\r\ncurl result: Upload failed (at start/before it took off) (25)\r\n```\n\n### I expected the following\n\nI think it would make more sense for curl to just re-create the folder and continue the upload normally.\n\n### curl/libcurl version\n\ncurl 8.4.0\n\n### operating system\n\nLinux NVTEVM 4.19.91 #5 SMP PREEMPT Mon Jun 12 12:34:00 UTC 2023 armv7l GNU/Linux\r\n(I've been testing this on some embedded device)","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/12181/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/12181/timeline","performed_via_github_app":null,"state_reason":"completed"}