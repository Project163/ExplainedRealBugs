{"url":"https://api.github.com/repos/curl/curl/issues/13416","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/13416/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/13416/comments","events_url":"https://api.github.com/repos/curl/curl/issues/13416/events","html_url":"https://github.com/curl/curl/issues/13416","id":2251684977,"node_id":"I_kwDOAAiu0c6GNfxx","number":13416,"title":"HTTP/2 + TLS spends a lot of time in recv  (buffering issue)","user":{"login":"laramiel","id":9807819,"node_id":"MDQ6VXNlcjk4MDc4MTk=","avatar_url":"https://avatars.githubusercontent.com/u/9807819?v=4","gravatar_id":"","url":"https://api.github.com/users/laramiel","html_url":"https://github.com/laramiel","followers_url":"https://api.github.com/users/laramiel/followers","following_url":"https://api.github.com/users/laramiel/following{/other_user}","gists_url":"https://api.github.com/users/laramiel/gists{/gist_id}","starred_url":"https://api.github.com/users/laramiel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/laramiel/subscriptions","organizations_url":"https://api.github.com/users/laramiel/orgs","repos_url":"https://api.github.com/users/laramiel/repos","events_url":"https://api.github.com/users/laramiel/events{/privacy}","received_events_url":"https://api.github.com/users/laramiel/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":194601710,"node_id":"MDU6TGFiZWwxOTQ2MDE3MTA=","url":"https://api.github.com/repos/curl/curl/labels/HTTP/2","name":"HTTP/2","color":"009800","default":false,"description":null},{"id":352090567,"node_id":"MDU6TGFiZWwzNTIwOTA1Njc=","url":"https://api.github.com/repos/curl/curl/labels/KNOWN_BUGS%20material","name":"KNOWN_BUGS material","color":"d93f0b","default":false,"description":null},{"id":865591047,"node_id":"MDU6TGFiZWw4NjU1OTEwNDc=","url":"https://api.github.com/repos/curl/curl/labels/performance","name":"performance","color":"d306dd","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":9,"created_at":"2024-04-18T22:27:10Z","updated_at":"2024-06-15T08:03:56Z","closed_at":"2024-06-15T08:03:56Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\r\n\r\nAs in https://github.com/curl/curl/issues/13403\r\n\r\nIn [tensorstore](https://github.com/google/tensorstore) we (currently) use a single multi-handle to multiplex a lot of http/2 transfers.  Those transfers appear to be slower than expected.\r\n\r\nThe following benchmark, which downloads 1000 files over http/2 (limited to 32 concurrently), where each file is 64MB, demonstrates an issue with an excess of `::recvfrom` calls:\r\n\r\nAt the lowest level of the stack, `nw_in_read` calls `recv` with a sequence of buffers of (typically) <5>, <1403> ... repeatedly.\r\nThere is special handling for \"small\" buffers in `cf_socket_recv`, however that is defined as < 1024 bytes, which relies on `ctx->buffer_recv` to be set, however I cannot see how it is ever TRUE.\r\n\r\n\r\nRelevant stack trace & buffer lengths.\r\n\r\n```\r\nnw_in_read (curl/src/lib/cf-socket.c:863)   len = 1403\r\ncf_socket_recv (curl/src/lib/cf-socket.c:1370)   len = 1403\r\nCurl_cf_def_recv (curl/src/lib/cfilters.c:103)\r\nCurl_conn_cf_recv (curl/src/lib/cfilters.c:322)\r\nossl_bio_cf_in_read (curl/src/lib/vtls/openssl.c:763)\r\n\r\nBIO_read (openssl/boringssl/src/crypto/bio/bio.c:139)   len = 1403\r\nbssl::tls_read_buffer_extend_to(ssl_st*, unsigned long) (openssl/boringssl/src/ssl/ssl_buffer.cc:157)   buf.size = 5, buf.capacity = 1408\r\nbssl::ssl_read_buffer_extend_to(ssl_st*, unsigned long) (openssl/boringssl/src/ssl/ssl_buffer.cc:196)\r\nbssl::ssl_handle_open_record(ssl_st*, bool*, bssl::ssl_open_record_t, unsigned long, unsigned char) (openssl/boringssl/src/ssl/ssl_buffer.cc:222)\r\nssl_read_impl(ssl_st*) (openssl/boringssl/src/ssl/ssl_lib.cc:1019)    <no buffer size>\r\n::SSL_peek(SSL *, void *, int) (openssl/boringssl/src/ssl/ssl_lib.cc:1053)  bufsize = 15914\r\n::SSL_read(SSL *, void *, int) (openssl/boringssl/src/ssl/ssl_lib.cc:1033) \r\n\r\nossl_recv (curl/src/lib/vtls/openssl.c:4670)   \r\nssl_cf_recv (curl/src/lib/vtls/vtls.c:1725)\r\nCurl_cf_def_recv (curl/src/lib/cfilters.c:103)\r\nCurl_conn_cf_recv (curl/src/lib/cfilters.c:322)\r\nnw_in_reader (curl/src/lib/http2.c:362)     buflen = 16384\r\nchunk_slurpn (curl/src/lib/bufq.c:109)\r\nCurl_bufq_sipn (curl/src/lib/bufq.c:594)\r\nbufq_slurpn (curl/src/lib/bufq.c:623)\r\nCurl_bufq_slurp (curl/src/lib/bufq.c:655)\r\nh2_progress_ingress (curl/src/lib/http2.c:1911)\r\ncf_h2_recv (curl/src/lib/http2.c:1969)\r\nCurl_cf_def_recv (curl/src/lib/cfilters.c:103)\r\nCurl_conn_recv (curl/src/lib/cfilters.c:183)\r\nCurl_read (curl/src/lib/sendf.c:813)\r\nCurl_xfer_recv_resp (curl/src/lib/transfer.c:450)\r\nreadwrite_data (curl/src/lib/transfer.c:504)\r\n```\r\n\r\nRepro:\r\n\r\n```\r\ngit clone https://github.com/google/tensorstore.git\r\n\r\n./bazelisk.py build -c opt --copt=-g tensorstore/internal/benchmark:kvstore_benchmark\r\n\r\nstrace -e recvfrom -f \\\r\n./bazel-bin/tensorstore/internal/benchmark/kvstore_benchmark \\\r\n   --kvstore_spec='{\"driver\": \"gcs\", \"bucket\":\"<MY_GCS_BUCKET>\", \"path\":\"default\"}' \\\r\n   --chunk_size=67108864 \\\r\n   --total_bytes=67108864000 \\\r\n   --repeat_reads=1 \\\r\n   --repeat_writes=0\r\n   \r\n```\r\n\r\nExample strace output:\r\n\r\n```\r\n[pid 3324193] recvfrom(46, \"\\27\\3\\3\\5{\", 5, 0, NULL, NULL) = 5\r\n[pid 3324193] recvfrom(46, \"\\313\\265\\v?\\343\\346=?\\272&e\\220\\342V\\322\\207\\35X6C\\203\\203V\\250\\346\\346\\301\\2067W\\204\\252\"..., 1403, 0, NULL, NULL) = 1403\r\n[pid 3324193] recvfrom(46, \"\\27\\3\\3\\5{\", 5, 0, NULL, NULL) = 5\r\n[pid 3324193] recvfrom(46, \"O\\1\\210\\301\\307x(f\\321\\337\\3469f\\323\\nAUtS\\326\\234\\364|\\244\\\\\\275\\275)K.\\250H\"..., 1403, 0, NULL, NULL) = 1403\r\n[pid 3324193] recvfrom(46, \"\\27\\3\\3\\5{\", 5, 0, NULL, NULL) = 5\r\n[pid 3324193] recvfrom(46, \"\\224\\255\\317Uj\\274W\\310J\\344\\32\\264\\243\\254\\224(v\\262\\261\\214Y\\253}`\\374R\\323\\316nj\\222u\"..., 1403, 0, NULL, NULL) = 1403\r\n[pid 3324193] recvfrom(46, \"\\27\\3\\3\\5{\", 5, 0, NULL, NULL) = 5\r\n[pid 3324193] recvfrom(46, \"\\\"\\21\\3606\\3106Y5Z/\\233\\236\\211\\261\\305~\\v\\17\\272<\\351\\225Qx\\303\\177p\\331\\2035o,\"..., 1403, 0, NULL, NULL) = 1403\r\n[pid 3324193] recvfrom(46, \"\\27\\3\\3\\5{\", 5, 0, NULL, NULL) = 5\r\n[pid 3324193] recvfrom(46, \"\\326\\352\\224bU5\\337\\23\\342p`\\0342\\327\\31\\313?R\\33rb\\34M\\237)U\\204\\302\\f\\215'P\"..., 1403, 0, NULL, NULL) = 1403\r\n[pid 3324193] recvfrom(46, \"\\27\\3\\3\\5\\10\", 5, 0, NULL, NULL) = 5\r\n[pid 3324193] recvfrom(46, \"\\331\\214\\17\\352C\\23K\\232\\34\\374\\275\\357\\220\\227\\16\\250\\360\\355e\\342\\22$j|\\35\\313>\\274\\237N\\311\\210\"..., 1288, 0, NULL, NULL) = 1288\r\n[pid 3324193] recvfrom(46, \"\\27\\3\\3\\5{\", 5, 0, NULL, NULL) = 5\r\n[pid 3324193] recvfrom(46, \"B\\312\\345 \\314\\7\\302s\\2346u>\\262\\r\\226'\\317\\256\\3515\\311\\26\\2O\\220fr\\21\\264-\\345[\"..., 1403, 0, NULL, NULL) = 1403\r\n```\r\n\r\nHere we clearly see the TLS header then the TLS body reads as separate `::recv` calls.\r\n\r\n\r\nI took the histogram of recvfrom calls; here are all the calls with more than 500 occurences in the download.\r\nNotice that about 1/2 the calls are for 5 bytes (TLS headers), while the others vary, but a large number are for\r\nactual 8k blocks.  The average recv call size is about 4090 bytes.\r\n\r\n|count|buffer_size\r\n|------|--------\r\n|    516|28\r\n|    548|8203\r\n|    552|8212\r\n|    558|29\r\n|    569|6980\r\n|    664|8202\r\n|    753|8201\r\n|    988|8204\r\n|    993|8206\r\n|   1012|26\r\n|   1140|34\r\n|   1158|27\r\n|   1653|8210\r\n|   2476|8208\r\n|   2496|1288\r\n|   2750|8207\r\n|   12715|1403\r\n| 8183520|8218\r\n| 8228072|5\r\n\r\n\r\n\r\n### I expected the following\r\n\r\nFewer calls to `recvfrom`; buffering at the lowest layer for fewer context switches.\r\n\r\n### curl/libcurl version\r\n\r\ncurl 8.7.1\r\n\r\n### operating system\r\n\r\n5.10.0-26-cloud-amd64 #1 SMP Debian 5.10.197-1 (2023-09-29) x86_64 GNU/Linux","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/13416/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/13416/timeline","performed_via_github_app":null,"state_reason":"completed"}