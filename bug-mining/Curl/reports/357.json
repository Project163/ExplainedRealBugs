{"url":"https://api.github.com/repos/curl/curl/issues/12399","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/12399/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/12399/comments","events_url":"https://api.github.com/repos/curl/curl/issues/12399/events","html_url":"https://github.com/curl/curl/issues/12399","id":2009352149,"node_id":"I_kwDOAAiu0c53xEfV","number":12399,"title":"libcurl: OCSP stapling fails when SSL context is reused","user":{"login":"zinzila","id":13702805,"node_id":"MDQ6VXNlcjEzNzAyODA1","avatar_url":"https://avatars.githubusercontent.com/u/13702805?v=4","gravatar_id":"","url":"https://api.github.com/users/zinzila","html_url":"https://github.com/zinzila","followers_url":"https://api.github.com/users/zinzila/followers","following_url":"https://api.github.com/users/zinzila/following{/other_user}","gists_url":"https://api.github.com/users/zinzila/gists{/gist_id}","starred_url":"https://api.github.com/users/zinzila/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zinzila/subscriptions","organizations_url":"https://api.github.com/users/zinzila/orgs","repos_url":"https://api.github.com/users/zinzila/repos","events_url":"https://api.github.com/users/zinzila/events{/privacy}","received_events_url":"https://api.github.com/users/zinzila/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118221,"node_id":"MDU6TGFiZWwxODQxMTgyMjE=","url":"https://api.github.com/repos/curl/curl/labels/TLS","name":"TLS","color":"bfdadc","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2023-11-24T09:01:08Z","updated_at":"2023-11-28T21:59:32Z","closed_at":"2023-11-28T21:59:32Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nI've tried to reuse SSL context of the `easy` handle for a TLS connection with OCSP stapling. When doing so, certificate status verification fails. The reason is that when TLS session is reused OCSP response is not sent by the server, as required by TLS specification.\r\n\r\nThe code to reproduce the issue (the server must support OCSP stapling) :\r\n```\r\nint main(int argc, char* argv[])\r\n{\r\n    (void)argc;\r\n    CURLcode ret;\r\n    CURL* hnd;\r\n\r\n    fprintf(stdout, \"libcurl version: %s\\n\", curl_version());\r\n\r\n    hnd = curl_easy_init();\r\n    curl_easy_setopt(hnd, CURLOPT_URL, argv[1]);\r\n    curl_easy_setopt(hnd, CURLOPT_VERBOSE, 1L);\r\n\r\n    // Self-signed certificate for testing\r\n    curl_easy_setopt(hnd, CURLOPT_CAINFO, argv[2]);\r\n    curl_easy_setopt(hnd, CURLOPT_SSL_VERIFYHOST, 0L);\r\n    // Use OCSP\r\n    curl_easy_setopt(hnd, CURLOPT_SSL_VERIFYSTATUS, 1L);\r\n    // do not reuse connection to force reuse of the SSL context\r\n    curl_easy_setopt(hnd, CURLOPT_FORBID_REUSE, 1L);\r\n\r\n    ret = curl_easy_perform(hnd);\r\n\r\n    fprintf(stdout, \"Curl call 1 completed with: %d - %s\\n\\n\", ret, curl_easy_strerror(ret));\r\n\r\n    curl_easy_setopt(hnd, CURLOPT_URL, argv[1]);\r\n    ret = curl_easy_perform(hnd);\r\n\r\n    fprintf(stdout, \"Curl call 2 completed with: %d - %s\\n\\n\", ret, curl_easy_strerror(ret));\r\n\r\n    curl_easy_cleanup(hnd);\r\n    hnd = NULL;\r\n\r\n    return (int)ret;\r\n}\r\n```\r\n\r\nThe output of the test code:\r\n(Test server: Apache/2.4.58 (Unix) OpenSSL/3.0.11)\r\n```\r\nlibcurl version: libcurl/8.4.0 OpenSSL/3.1.4 zlib/1.3 brotli/1.1.0 zstd/1.5.5 libidn2/2.3.4 libpsl/0.21.2 (+libidn2/2.3.4) libssh2/1.11.0 nghttp2/1.58.0\r\n*   Trying 172.19.0.2:443...\r\n* Connected to 172.19.0.2 (172.19.0.2) port 443\r\n* ALPN: curl offers h2,http/1.1\r\n*  CAfile: ./etc/tp25poc.ca.crt\r\n*  CApath: none\r\n* SSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384\r\n* ALPN: server accepted h2\r\n* Server certificate:\r\n*  subject: C=DE; OU=TDTP25 Test; CN=localhost\r\n*  start date: Nov 24 08:23:09 2023 GMT\r\n*  expire date: Nov 21 08:23:09 2033 GMT\r\n*  issuer: C=DE; OU=TDTP25 Test; CN=TDTP25 Test Root CA\r\n*  SSL certificate verify ok.\r\n* SSL certificate status: good (0)\r\n* old SSL session ID is stale, removing\r\n* using HTTP/2\r\n* [HTTP/2] [1] OPENED stream for https://172.19.0.2/teapot.php\r\n* [HTTP/2] [1] [:method: GET]\r\n* [HTTP/2] [1] [:scheme: https]\r\n* [HTTP/2] [1] [:authority: 172.19.0.2]\r\n* [HTTP/2] [1] [:path: /teapot.php]\r\n* [HTTP/2] [1] [accept: */*]\r\n> GET /teapot.php HTTP/2\r\nHost: 172.19.0.2\r\nAccept: */*\r\n\r\n< HTTP/2 418 \r\n< x-client: 172.19.0.1\r\n< content-type: text/html; charset=UTF-8\r\n< date: Fri, 24 Nov 2023 08:54:48 GMT\r\n< server: Apache/2.4.58 (Unix) OpenSSL/3.0.11\r\n< \r\n<html>\r\n<h1>418 I'm a teapot</h1><br>\r\n</html>\r\n* Closing connection\r\nCurl call 1 completed with: 0 - No error\r\n\r\n* Hostname 172.19.0.2 was found in DNS cache\r\n*   Trying 172.19.0.2:443...\r\n* Connected to 172.19.0.2 (172.19.0.2) port 443\r\n* ALPN: curl offers h2,http/1.1\r\n* SSL reusing session ID\r\n* SSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384\r\n* ALPN: server accepted h2\r\n* Server certificate:\r\n*  subject: C=DE; OU=TDTP25 Test; CN=localhost\r\n*  start date: Nov 24 08:23:09 2023 GMT\r\n*  expire date: Nov 21 08:23:09 2033 GMT\r\n*  issuer: C=DE; OU=TDTP25 Test; CN=TDTP25 Test Root CA\r\n*  SSL certificate verify ok.\r\n* No OCSP response received\r\n* Closing connection\r\nCurl call 2 completed with: 91 - SSL server certificate status verification FAILED\r\n\r\n```\r\n\r\nHere for the second request it is visible that SSL context is reused and then it tries to get OCSP response from the OpenSSL but OpenSSL does not contain it any more.\r\n\n\n### I expected the following\n\nThe expectation is that when SSL context is reused and the server agrees to restore known TLS session, OCSP status check is not performed.\n\n### curl/libcurl version\n\nlibcurl version: libcurl/8.4.0 OpenSSL/3.1.4 zlib/1.3 brotli/1.1.0 zstd/1.5.5 libidn2/2.3.4 libpsl/0.21.2 (+libidn2/2.3.4) libssh2/1.11.0 nghttp2/1.58.0\n\n### operating system\n\nLinux *** 6.1.62-1-MANJARO #1 SMP PREEMPT_DYNAMIC Thu Nov  9 03:01:44 UTC 2023 x86_64 GNU/Linux","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/12399/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/12399/timeline","performed_via_github_app":null,"state_reason":"completed"}