{"url":"https://api.github.com/repos/curl/curl/issues/10803","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/10803/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/10803/comments","events_url":"https://api.github.com/repos/curl/curl/issues/10803/events","html_url":"https://github.com/curl/curl/issues/10803","id":1632982321,"node_id":"I_kwDOAAiu0c5hVVUx","number":10803,"title":"hyper build memory leaks","user":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":182083182,"node_id":"MDU6TGFiZWwxODIwODMxODI=","url":"https://api.github.com/repos/curl/curl/labels/memory-leak","name":"memory-leak","color":"c7def8","default":false,"description":null},{"id":352090567,"node_id":"MDU6TGFiZWwzNTIwOTA1Njc=","url":"https://api.github.com/repos/curl/curl/labels/KNOWN_BUGS%20material","name":"KNOWN_BUGS material","color":"d93f0b","default":false,"description":null},{"id":2620316181,"node_id":"MDU6TGFiZWwyNjIwMzE2MTgx","url":"https://api.github.com/repos/curl/curl/labels/Hyper","name":"Hyper","color":"006b75","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2023-03-20T22:53:18Z","updated_at":"2023-08-25T07:41:47Z","closed_at":"2023-05-22T15:07:16Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\r\n\r\nBuild curl+hyper with current git master and current hyper git master, run these tests with valgrind:\r\n\r\n~~~\r\ncd tests\r\n./runtests.pl 1069 1072 1073 1539\r\n~~~\r\n\r\nThey all fail due to valgrind reporting memory leaks.\r\n\r\nDue to the leak being identified to line `c-hyper.c:993`:\r\n~~~c\r\n  req = hyper_request_new();\r\n~~~\r\nwhich is executed in pretty much all hyper test cases and yet only leak in these specific ones, I think there is reason to suspect that the leak is either in hyper itself or due to some specific code that is (not) executed due to the specific circumstances in these test cases. They all seem related to HTTP/1.0.\r\n\r\n## Test 1069 output\r\n\r\nThe others seem similar so this probably a decent example:\r\n\r\n~~~\r\n***************************************** \r\ntest 1069...[HTTP 1.0 PUT from stdin with no content length]\r\n valgrind ERROR ==1308628== 701 (264 direct, 437 indirect) bytes in 1 blocks are definitely lost in loss record 8 of 10\r\n==1308628==    at 0x48407B4: malloc (vg_replace_malloc.c:381)\r\n==1308628==    by 0x50D8D49: alloc::alloc::Global::alloc_impl (alloc.rs:95)\r\n==1308628==    by 0x50D8B78: allocate (alloc.rs:237)\r\n==1308628==    by 0x50D8B78: alloc::alloc::exchange_malloc (alloc.rs:326)\r\n==1308628==    by 0x505FE23: new<hyper::ffi::http_types::hyper_request> (boxed.rs:219)\r\n==1308628==    by 0x505FE23: hyper::ffi::http_types::hyper_request_new::{{closure}} (http_types.rs:41)\r\n==1308628==    by 0x508EA8D: core::ops::function::FnOnce::call_once (function.rs:250)\r\n==1308628==    by 0x5073B38: <core::panic::unwind_safe::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once (unwind_safe.rs:271)\r\n==1308628==    by 0x5117E1F: std::panicking::try::do_call (panicking.rs:483)\r\n==1308628==    by 0x511A1FA: __rust_try (in /home/dast/src/hyper/target/debug/libhyper.so)\r\n==1308628==    by 0x5115FCF: std::panicking::try (panicking.rs:447)\r\n==1308628==    by 0x501F060: std::panic::catch_unwind (panic.rs:140)\r\n==1308628==    by 0x5080BAD: hyper_request_new (macros.rs:8)\r\n==1308628==    by 0x19407C: Curl_http (c-hyper.c:993)\r\n==1308628==    by 0x1574CA: multi_do (multi.c:1586)\r\n==1308628==    by 0x1588A6: multi_runsingle (multi.c:2193)\r\n==1308628==    by 0x159AC5: curl_multi_perform (multi.c:2729)\r\n==1308628==    by 0x148A5E: easy_transfer (easy.c:668)\r\n==1308628== \r\n==1308628== 9,456 (24 direct, 9,432 indirect) bytes in 1 blocks are definitely lost in loss record 10 of 10\r\n==1308628==    at 0x48407B4: malloc (vg_replace_malloc.c:381)\r\n==1308628==    by 0x50D8D49: alloc::alloc::Global::alloc_impl (alloc.rs:95)\r\n==1308628==    by 0x50D8B78: allocate (alloc.rs:237)\r\n==1308628==    by 0x50D8B78: alloc::alloc::exchange_malloc (alloc.rs:326)\r\n==1308628==    by 0x50B1DC3: new<hyper::ffi::client::hyper_clientconn> (boxed.rs:219)\r\n==1308628==    by 0x50B1DC3: <T as hyper::ffi::task::IntoDynTaskType>::into_dyn_task_type (task.rs:349)\r\n==1308628==    by 0x50A2FE4: <core::result::Result<T,hyper::error::Error> as hyper::ffi::task::IntoDynTaskType>::into_dyn_task_type (task.rs:359)\r\n==1308628==    by 0x511089D: hyper::ffi::task::hyper_task::boxed::{{closure}} (task.rs:240)\r\n==1308628==    by 0x50D2104: <core::pin::Pin<P> as core::future::future::Future>::poll (future.rs:125)\r\n==1308628==    by 0x511275C: <hyper::ffi::task::TaskFuture as core::future::future::Future>::poll (task.rs:258)\r\n==1308628==    by 0x50D4627: <futures_util::stream::futures_unordered::FuturesUnordered<Fut> as futures_core::stream::Stream>::poll_next (mod.rs:515)\r\n==1308628==    by 0x5112133: hyper::ffi::task::hyper_executor::poll_next (task.rs:129)\r\n==1308628==    by 0x51110DA: hyper::ffi::task::hyper_executor_poll::{{closure}} (task.rs:224)\r\n==1308628==    by 0x508E662: core::ops::function::FnOnce::call_once (function.rs:250)\r\n==1308628==    by 0x5073A3D: <core::panic::unwind_safe::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once (unwind_safe.rs:271)\r\n==1308628==    by 0x5117F1B: std::panicking::try::do_call (panicking.rs:483)\r\n==1308628==    by 0x511A1FA: __rust_try (in /home/dast/src/hyper/target/debug/libhyper.so)\r\n==1308628==    by 0x5114528: std::panicking::try (panicking.rs:447)\r\n==1308628== \r\n\r\n - abort tests\r\nTESTDONE: 1 tests were considered during 2 seconds.\r\nTESTDONE: 0 tests out of 1 reported OK: 0%\r\n\r\n~~~","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/10803/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/10803/timeline","performed_via_github_app":null,"state_reason":"completed"}