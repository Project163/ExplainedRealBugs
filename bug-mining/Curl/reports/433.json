{"url":"https://api.github.com/repos/curl/curl/issues/13229","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/13229/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/13229/comments","events_url":"https://api.github.com/repos/curl/curl/issues/13229/events","html_url":"https://github.com/curl/curl/issues/13229","id":2216331045,"node_id":"I_kwDOAAiu0c6EGocl","number":13229,"title":"chunked POST via callback regression in 8.7.X","user":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118197,"node_id":"MDU6TGFiZWwxODQxMTgxOTc=","url":"https://api.github.com/repos/curl/curl/labels/regression","name":"regression","color":"33aa3f","default":false,"description":null},{"id":184118243,"node_id":"MDU6TGFiZWwxODQxMTgyNDM=","url":"https://api.github.com/repos/curl/curl/labels/HTTP","name":"HTTP","color":"207de5","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"icing","id":15102,"node_id":"MDQ6VXNlcjE1MTAy","avatar_url":"https://avatars.githubusercontent.com/u/15102?v=4","gravatar_id":"","url":"https://api.github.com/users/icing","html_url":"https://github.com/icing","followers_url":"https://api.github.com/users/icing/followers","following_url":"https://api.github.com/users/icing/following{/other_user}","gists_url":"https://api.github.com/users/icing/gists{/gist_id}","starred_url":"https://api.github.com/users/icing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icing/subscriptions","organizations_url":"https://api.github.com/users/icing/orgs","repos_url":"https://api.github.com/users/icing/repos","events_url":"https://api.github.com/users/icing/events{/privacy}","received_events_url":"https://api.github.com/users/icing/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":30,"created_at":"2024-03-30T08:32:19Z","updated_at":"2024-04-02T06:42:22Z","closed_at":"2024-04-02T06:42:00Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\n(imported issued from https://marc.info/?l=git&m=171175679831214&w=2, authored by Jeff King (@peff))\r\n\r\nI noticed some http-related failures in the test suite on my Debian\r\nunstable system, which recently got an upgraded curl package. It looks\r\nlike it's related to cases where we use the remote-curl helper in\r\n\"connect\" mode (i.e., protocol v2) and the http buffer is small\r\n(requiring us to stream the data to curl). Besides just running t5551,\r\nan easy reproduction is:\r\n~~~\r\n  [this works]\r\n  $ git ls-remote https://git.kernel.org/pub/scm/git/git.git | wc -l\r\n  1867\r\n\r\n  [this doesn't]\r\n  $ git -c http.postbuffer=65536 ls-remote https://git.kernel.org/pub/scm/git/git.git\r\n  fatal: expected flush after ref listing\r\n~~~\r\nThe error message comes from ls-remote itself, which was expecting a\r\nFLUSH packet from the remote. Instead it gets the RESPONSE_END from\r\nremote-curl (remember that in connect mode, remote-curl is just ferrying\r\nbytes back and forth between ls-remote and the server).\r\n\r\nIt works with older versions of libcurl, but not 8.7.0 (or 8.7.1).\r\nBisecting in libcurl points to 9369c30cd (lib: Curl_read/Curl_write\r\nclarifications, 2024-02-15).\r\n\r\nRunning with `GIT_TRACE_CURL=1` shows weirdness on the POST we send to\r\nissue the ls-refs command. With older curl, I see this:\r\n\r\n~~~\r\n  => Send header: POST /pub/scm/git/git.git/git-upload-pack HTTP/1.1\r\n  => Send header: Host: git.kernel.org\r\n  => Send header: User-Agent: git/2.44.0.789.g252ee96bc5.dirty\r\n  => Send header: Accept-Encoding: deflate, gzip\r\n  => Send header: Content-Type: application/x-git-upload-pack-request\r\n  => Send header: Accept: application/x-git-upload-pack-result\r\n  => Send header: Git-Protocol: version=2\r\n  => Send header: Transfer-Encoding: chunked\r\n  => Send header:\r\n  => Send data: 14..0014command=ls-refs...\r\n  => Send data: 2a..002aagent=git/2.44.0.789.g252ee96bc5.dirty..\r\n  [and so on until...]\r\n  == Info: Signaling end of chunked upload via terminating chunk.\r\n~~~\r\nBut with the broken version, I get:\r\n~~~\r\n  => Send header: POST /pub/scm/git/git.git/git-upload-pack HTTP/1.1\r\n  => Send header: Host: git.kernel.org\r\n  => Send header: User-Agent: git/2.44.0.789.g252ee96bc5.dirty\r\n  => Send header: Accept-Encoding: deflate, gzip, br, zstd\r\n  => Send header: Content-Type: application/x-git-upload-pack-request\r\n  => Send header: Accept: application/x-git-upload-pack-result\r\n  => Send header: Git-Protocol: version=2\r\n  => Send header: Transfer-Encoding: chunked\r\n  => Send header:\r\n  => Send data, 0000000014 bytes (0x0000000e)\r\n  => Send data: 4..0014..0....\r\n  == Info: upload completely sent off: 14 bytes\r\n~~~\r\nSo we only get the first 4 bytes, and then we quit (the double mention\r\nof 14 is confusing, but I think it is both the size of the pkt-line\r\n(\"command=ls-refs\\n\") but also the length of the 4-byte string when\r\nframed with chunked transfer-encoding). Those 4 bytes are the first\r\nthing returned by rpc_out(), which we use as our `CURLOPT_READFUNCTION`.\r\n\r\nIt's possible that we're doing something wrong with our read/write\r\nfunction callbacks. But I don't see how; we say \"here's 4 bytes\", but\r\nthen we never get called again. It's like curl is giving up on trying to\r\nread the post input early for some reason.\r\n\r\nI'm not sure how to dig further. That commit is pretty big and scary. I\r\ndid check that the tip of master in curl.git is still affected (I'd\r\nhoped maybe the 0-length write fixes in b30d694a027 would be related,\r\nbut that's not it).\r\n\r\nIdeas?\r\n\n\n### I expected the following\n\n_No response_\n\n### curl/libcurl version\n\n8.7.0 and 8.7.1\n\n### operating system\n\nLinux, but probably not relevant","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/13229/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/13229/timeline","performed_via_github_app":null,"state_reason":"completed"}