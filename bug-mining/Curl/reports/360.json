{"url":"https://api.github.com/repos/curl/curl/issues/12465","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/12465/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/12465/comments","events_url":"https://api.github.com/repos/curl/curl/issues/12465/events","html_url":"https://github.com/curl/curl/issues/12465","id":2028109313,"node_id":"I_kwDOAAiu0c544n4B","number":12465,"title":"Misleading \"protocol http not supported\" with MITM","user":{"login":"mausch","id":95194,"node_id":"MDQ6VXNlcjk1MTk0","avatar_url":"https://avatars.githubusercontent.com/u/95194?v=4","gravatar_id":"","url":"https://api.github.com/users/mausch","html_url":"https://github.com/mausch","followers_url":"https://api.github.com/users/mausch/followers","following_url":"https://api.github.com/users/mausch/following{/other_user}","gists_url":"https://api.github.com/users/mausch/gists{/gist_id}","starred_url":"https://api.github.com/users/mausch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mausch/subscriptions","organizations_url":"https://api.github.com/users/mausch/orgs","repos_url":"https://api.github.com/users/mausch/repos","events_url":"https://api.github.com/users/mausch/events{/privacy}","received_events_url":"https://api.github.com/users/mausch/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2023-12-06T09:25:24Z","updated_at":"2023-12-06T22:05:39Z","closed_at":"2023-12-06T22:05:39Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\n1. Go to https://app.kasmweb.com/#/cast/1481835260 , it's a demo for a web-based Ubuntu desktop.\r\n2. Open a terminal\r\n3. Run: `curl -v --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix -o nix-installer` (it's https://github.com/DeterminateSystems/nix-installer )\r\n\r\nOutput shows a MITM but without the `-v` flag all the user sees is `curl: (1) Protocol \"http\" not supported or disabled in libcurl` which is confusing / misleading. \r\n\r\n```\r\n* Uses proxy env variable https_proxy == 'http://127.0.0.1:3128'\r\n*   Trying 127.0.0.1:3128...\r\n* Connected to (nil) (127.0.0.1) port 3128 (#0)\r\n* allocate connect buffer!\r\n* Establish HTTP proxy tunnel to install.determinate.systems:443\r\n> CONNECT install.determinate.systems:443 HTTP/1.1\r\n> Host: install.determinate.systems:443\r\n> User-Agent: curl/7.81.0\r\n> Proxy-Connection: Keep-Alive\r\n> \r\n< HTTP/1.1 200 Connection established\r\n< \r\n* Proxy replied 200 to CONNECT request\r\n* CONNECT phase completed!\r\n* ALPN, offering h2\r\n* ALPN, offering http/1.1\r\n*  CAfile: /etc/ssl/certs/ca-certificates.crt\r\n*  CApath: /etc/ssl/certs\r\n* TLSv1.0 (OUT), TLS header, Certificate Status (22):\r\n} [5 bytes data]\r\n* TLSv1.3 (OUT), TLS handshake, Client hello (1):\r\n} [512 bytes data]\r\n* TLSv1.2 (IN), TLS header, Certificate Status (22):\r\n{ [5 bytes data]\r\n* TLSv1.3 (IN), TLS handshake, Server hello (2):\r\n{ [122 bytes data]\r\n* TLSv1.2 (IN), TLS header, Finished (20):\r\n{ [5 bytes data]\r\n* TLSv1.2 (IN), TLS header, Supplemental data (23):\r\n{ [5 bytes data]\r\n* TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8):\r\n{ [6 bytes data]\r\n* TLSv1.2 (IN), TLS header, Supplemental data (23):\r\n{ [5 bytes data]\r\n* TLSv1.3 (IN), TLS handshake, Certificate (11):\r\n{ [2754 bytes data]\r\n* TLSv1.2 (IN), TLS header, Supplemental data (23):\r\n{ [5 bytes data]\r\n* TLSv1.3 (IN), TLS handshake, CERT verify (15):\r\n{ [264 bytes data]\r\n* TLSv1.2 (IN), TLS header, Supplemental data (23):\r\n{ [5 bytes data]\r\n* TLSv1.3 (IN), TLS handshake, Finished (20):\r\n{ [52 bytes data]\r\n* TLSv1.2 (OUT), TLS header, Finished (20):\r\n} [5 bytes data]\r\n* TLSv1.3 (OUT), TLS change cipher, Change cipher spec (1):\r\n} [1 bytes data]\r\n* TLSv1.2 (OUT), TLS header, Supplemental data (23):\r\n} [5 bytes data]\r\n* TLSv1.3 (OUT), TLS handshake, Finished (20):\r\n} [52 bytes data]\r\n* SSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384\r\n* ALPN, server did not agree to a protocol\r\n* Server certificate:\r\n*  subject: CN=install.determinate.systems\r\n*  start date: Nov 24 23:38:38 2023 GMT\r\n*  expire date: Feb 22 23:38:37 2024 GMT\r\n*  subjectAltName: host \"install.determinate.systems\" matched cert's \"install.determinate.systems\"\r\n*  issuer: C=US; ST=CA; O=Kasm Technologies; CN=kasm.localhost.net\r\n*  SSL certificate verify ok.\r\n TLSv1.2 (OUT), TLS header, Supplemental data (23):\r\n} [5 bytes data]\r\n> GET /nix HTTP/1.1\r\n> Host: install.determinate.systems\r\n> User-Agent: curl/7.81.0\r\n> Accept: */*\r\n> \r\n* TLSv1.2 (IN), TLS header, Supplemental data (23):\r\n{ [5 bytes data]\r\n* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):\r\n{ [217 bytes data]\r\n* TLSv1.2 (IN), TLS header, Supplemental data (23):\r\n{ [5 bytes data]\r\n* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):\r\n{ [217 bytes data]\r\n* old SSL session ID is stale, removing\r\n* TLSv1.2 (IN), TLS header, Supplemental data (23):\r\n{ [5 bytes data]\r\n* Mark bundle as not supporting multiuse\r\n< HTTP/1.1 302 Found\r\n< Server: squid/5.6\r\n< Date: Wed, 06 Dec 2023 09:09:57 GMT\r\n< Content-Length: 0\r\n< Location: http://access_denied/?&message=&url=https://install.determinate.systems/nix&domain=install.determinate.systems&category=Default\r\n< X-Cache: MISS from 267be3abc4a1\r\n< Connection: close\r\n< \r\n* Closing connection 0\r\n* TLSv1.2 (IN), TLS header, Supplemental data (23):\r\n{ [5 bytes data]\r\n* TLSv1.3 (IN), TLS alert, close notify (256):\r\n{ [2 bytes data]\r\n* TLSv1.2 (OUT), TLS header, Supplemental data (23):\r\n} [5 bytes data]\r\n* TLSv1.3 (OUT), TLS alert, close notify (256):\r\n} [2 bytes data]\r\n* Clear auth, redirects to port from 443 to 80\r\n* Issue another request to this URL: 'http://access_denied/?&message=&url=https://install.determinate.systems/nix&domain=install.determinate.systems&category=Default'\r\n* Protocol \"http\" not supported or disabled in libcurl\r\n* Closing connection -1\r\ncurl: (1) Protocol \"http\" not supported or disabled in libcurl\r\n```\r\n\r\n```\n\n### I expected the following\n\nNot sure what curl could/should do here tbh, but the current message seems misleading and given the context this might have security implications?\n\n### curl/libcurl version\n\ncurl 7.81.0 (x86_64-pc-linux-gnu) libcurl/7.81.0 OpenSSL/3.0.2 zlib/1.2.11 brotli/1.0.9 zstd/1.4.8 libidn2/2.3.2 libpsl/0.21.0 (+libidn2/2.3.2) libssh/0.9.6/openssl/zlib nghttp2/1.43.0 librtmp/2.3 OpenLDAP/2.5.16\r\nRelease-Date: 2022-01-05\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps ldap ldaps mqtt pop3 pop3s rtmp rtsp scp sftp smb smbs smtp smtps telnet tftp \r\nFeatures: alt-svc AsynchDNS brotli GSS-API HSTS HTTP2 HTTPS-proxy IDN IPv6 Kerberos Largefile libz NTLM NTLM_WB PSL SPNEGO SSL TLS-SRP UnixSockets zstd\n\n### operating system\n\nLinux 551ed7f17821 6.2.0-1012-aws #12~22.04.1-Ubuntu SMP Thu Sep  7 14:01:24 UTC 2023 x86_64 x86_64 x86_64 GNU/Linux\r\n","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/12465/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/12465/timeline","performed_via_github_app":null,"state_reason":"completed"}