{"url":"https://api.github.com/repos/curl/curl/issues/11737","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/11737/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/11737/comments","events_url":"https://api.github.com/repos/curl/curl/issues/11737/events","html_url":"https://github.com/curl/curl/issues/11737","id":1867642508,"node_id":"I_kwDOAAiu0c5vUfaM","number":11737,"title":"Alt-svc: support IPv6 alt-authority","user":{"login":"oliverpool","id":3864879,"node_id":"MDQ6VXNlcjM4NjQ4Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/3864879?v=4","gravatar_id":"","url":"https://api.github.com/users/oliverpool","html_url":"https://github.com/oliverpool","followers_url":"https://api.github.com/users/oliverpool/followers","following_url":"https://api.github.com/users/oliverpool/following{/other_user}","gists_url":"https://api.github.com/users/oliverpool/gists{/gist_id}","starred_url":"https://api.github.com/users/oliverpool/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/oliverpool/subscriptions","organizations_url":"https://api.github.com/users/oliverpool/orgs","repos_url":"https://api.github.com/users/oliverpool/repos","events_url":"https://api.github.com/users/oliverpool/events{/privacy}","received_events_url":"https://api.github.com/users/oliverpool/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118243,"node_id":"MDU6TGFiZWwxODQxMTgyNDM=","url":"https://api.github.com/repos/curl/curl/labels/HTTP","name":"HTTP","color":"207de5","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":1,"created_at":"2023-08-25T20:24:04Z","updated_at":"2023-08-29T07:45:45Z","closed_at":"2023-08-28T15:09:11Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\r\n\r\nRun `curl -v --alt-svc cache \"https://caddy.pfad.fr\"`\r\n\r\ncaddy.pfad.fr is a test server which replies with an `Alt-svc` header containing an IPv6 as alt-authority:\r\n```\r\nalt-svc: h3=\"[2a01:4f8:c0c:9a6d::42]:443\"; ma=2592000\r\n```\r\n\r\n### I expected the following\r\n\r\nThe cache file to be populated.\r\n\r\nInstead, the cache file is empty and I see in the logs:\r\n```\r\n* Excessive alt-svc host name, ignoring.\r\n< alt-svc: h3=\"[2a01:4f8:c0c:9a6d::42]:443\"; ma=2592000\r\n```\r\n\r\nTriggered by this code:\r\n\r\nhttps://github.com/curl/curl/blob/c2212c05aa99bb31e4b99b0b66fc1747b7d01be6/lib/altsvc.c#L502-L507\r\n\r\nRelevant specifications:\r\n- `alt-authority = quoted-string ; containing [ uri-host ] \":\" port`  [RFC7838](https://httpwg.org/specs/rfc7838.html#alt-svc)\r\n- `uri-host      = <host, see [RFC3986], Section 3.2.2>`  [RFC7230](https://www.rfc-editor.org/rfc/rfc7230.html#section-2.7)\r\n- `host        = IP-literal / IPv4address / reg-name` [RFC3986](https://www.rfc-editor.org/rfc/rfc3986#section-3.2.2)\r\n- `IP-literal = \"[\" ( IPv6address / IPvFuture  ) \"]\"` RFC3986 as well\r\n\r\nHence I think that `h3=\"[2a01:4f8:c0c:9a6d::42]:443\"; ma=2592000` is a valid `alt-svc` header value and should be correctly handled by curl.\r\n\r\n---\r\n\r\nBackground information:\r\n \r\nEach of my service listens on 1 dedicated IPv6 address on the same machine. The traffic to the shared IPv4 gets forwarded to the right service thanks to [snid](https://github.com/AGWA/snid/) (which uses SNI). However this setup can't handle UDP packets, hence I make http3 only available on IPv6.\r\n\r\nPossible workaround: publish AAAA-only DNS record and use this domain as alt-svc (so IPv4 clients will waste a bit of their resources).\r\n\r\n### curl/libcurl version\r\n\r\ncurl 8.2.1 (x86_64-pc-linux-gnu) libcurl/8.2.1 OpenSSL/3.1.2 zlib/1.3 brotli/1.0.9 zstd/1.5.5 libidn2/2.3.4 libpsl/0.21.2 (+libidn2/2.3.4) libssh2/1.11.0 nghttp2/1.55.1\r\nRelease-Date: 2023-07-26\r\nProtocols: dict file ftp ftps gopher gophers http https imap imaps mqtt pop3 pop3s rtsp scp sftp smb smbs smtp smtps telnet tftp\r\nFeatures: alt-svc AsynchDNS brotli GSS-API HSTS HTTP2 HTTPS-proxy IDN IPv6 Kerberos Largefile libz NTLM NTLM_WB PSL SPNEGO SSL threadsafe TLS-SRP UnixSockets zstd\r\n\r\n### operating system\r\n\r\nArch Linux:\r\nLinux 6.4.11-arch2-1 #1 SMP PREEMPT_DYNAMIC Sat, 19 Aug 2023 15:38:34 +0000 x86_64 GNU/Linux","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/11737/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/11737/timeline","performed_via_github_app":null,"state_reason":"completed"}