{"url":"https://api.github.com/repos/curl/curl/issues/9357","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/9357/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/9357/comments","events_url":"https://api.github.com/repos/curl/curl/issues/9357/events","html_url":"https://github.com/curl/curl/issues/9357","id":1349098220,"node_id":"I_kwDOAAiu0c5QaZrs","number":9357,"title":"FTP download fails with \"No such file or directory\" when CURLOPT_FILETIME is enabled","user":{"login":"mhei","id":1313451,"node_id":"MDQ6VXNlcjEzMTM0NTE=","avatar_url":"https://avatars.githubusercontent.com/u/1313451?v=4","gravatar_id":"","url":"https://api.github.com/users/mhei","html_url":"https://github.com/mhei","followers_url":"https://api.github.com/users/mhei/followers","following_url":"https://api.github.com/users/mhei/following{/other_user}","gists_url":"https://api.github.com/users/mhei/gists{/gist_id}","starred_url":"https://api.github.com/users/mhei/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhei/subscriptions","organizations_url":"https://api.github.com/users/mhei/orgs","repos_url":"https://api.github.com/users/mhei/repos","events_url":"https://api.github.com/users/mhei/events{/privacy}","received_events_url":"https://api.github.com/users/mhei/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":184118265,"node_id":"MDU6TGFiZWwxODQxMTgyNjU=","url":"https://api.github.com/repos/curl/curl/labels/FTP","name":"FTP","color":"bfd4f2","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-08-24T08:54:50Z","updated_at":"2022-09-07T08:29:11Z","closed_at":"2022-09-07T08:29:11Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\r\n\r\nI want to download a file from an FTP server and enabled CURLOPT_FILETIME by default in my curl context.\r\nHowever, some FTP servers are configured more strictly so that the MDTM command is rejected with 550 error \"Permission denied\".\r\ncurl translates the 550 to \"File not found\", however, the file is actually present and when I don't set CURLOPT_FILETIME, then the download works fine. See the following trace:\r\n\r\n```\r\n*   Trying 1.1.1.1...\r\n* TCP_NODELAY set\r\n* Connected to ftp.example.com (1.1.1.1) port 21 (#0)\r\n< 220 ProFTPD Server (Ftp Server) [1.1.1.1]\r\n [1.1.1.1]\r\n> AUTH SSL\r\n< 500 AUTH not understood\r\n> AUTH TLS\r\n< 500 AUTH not understood\r\n> USER myuser\r\n< 331 Password required for myuser\r\n> PASS foobarpassword\r\n< 230 User myuser logged in\r\n> PWD\r\n< 550 PWD: Permission denied\r\n> MDTM 1_0_7.image\r\n* ftp_perform ends with SECONDARY: 0\r\n< 550 1_0_7.image: Operation not permitted\r\n* Given file does not exist\r\n* Remembering we are in dir \"\"\r\n* Connection #0 to host ftp.example.com left intact\r\n```\r\n\r\n\r\n### I expected the following\r\n\r\nI would expect that the download still works with CURLOPT_FILETIME set - personally, I consider it more as optional thing - if it works then it's fine - if not then it's still ok. In function ftp_state_mdtm_resp for example an unsupported reply is also handled in such a way, that no error is thrown.\r\nHowever, I know that the FTP server responses are some kind of implementation specific: for some servers 550 is really \"File not found\", some servers (as above) use it for permission things.\r\nIn my eyes, there are three options to handle it:\r\n1. don't fail on every 550 anymore in ftp_state_mdtm_resp, just ignore it -> this would defer the error in case the file really does not exists\r\n2. introduce something like CURLOPT_FILETIME_OPTIONAL which deals with this special situation and allows the library user to fine-control the behavior -> it would only fail hard if the user does not give this flag (keep current behavior) but ignores the 550 in case this flag is set\r\n3. not only look at the numeric error code but use a heuristic on the plain text description, e.g. look for \"found\" or \"permitted\" in the assumption that the FTP server always respon in English and decide upon the found string whether the 550 can be ignored or not\r\n4. any other idea :-)\r\n\r\nI want to discuss here, whether you also consider it as issue and which solution should be worked on.\r\n\r\n### curl/libcurl version\r\n\r\ncurl 7.58.0 (x86_64-pc-linux-gnu) libcurl/7.58.0 OpenSSL/1.1.1 zlib/1.2.11 libidn2/2.0.4 libpsl/0.19.1 (+libidn2/2.0.4) nghttp2/1.30.0 librtmp/2.3\r\nRelease-Date: 2018-01-24\r\nProtocols: dict file ftp ftps gopher http https imap imaps ldap ldaps pop3 pop3s rtmp rtsp smb smbs smtp smtps telnet tftp \r\nFeatures: AsynchDNS IDN IPv6 Largefile GSS-API Kerberos SPNEGO NTLM NTLM_WB SSL libz TLS-SRP HTTP2 UnixSockets HTTPS-proxy PSL\r\n\r\nBut this is still present in latest Github branch.\r\n\r\n### operating system\r\n\r\nI'm still on Ubuntu 18.04 on my dev host, but I also tested with newer libcurl on an embedded Linux system (Yocto based).\r\n","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/9357/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/9357/timeline","performed_via_github_app":null,"state_reason":"completed"}