{"url":"https://api.github.com/repos/curl/curl/issues/16072","repository_url":"https://api.github.com/repos/curl/curl","labels_url":"https://api.github.com/repos/curl/curl/issues/16072/labels{/name}","comments_url":"https://api.github.com/repos/curl/curl/issues/16072/comments","events_url":"https://api.github.com/repos/curl/curl/issues/16072/events","html_url":"https://github.com/curl/curl/issues/16072","id":2803998887,"node_id":"I_kwDOAAiu0c6nIaCn","number":16072,"title":"Undeterministic zsh completion script output (depending on terminal size)","user":{"login":"kpcyrd","id":7763184,"node_id":"MDQ6VXNlcjc3NjMxODQ=","avatar_url":"https://avatars.githubusercontent.com/u/7763184?v=4","gravatar_id":"","url":"https://api.github.com/users/kpcyrd","html_url":"https://github.com/kpcyrd","followers_url":"https://api.github.com/users/kpcyrd/followers","following_url":"https://api.github.com/users/kpcyrd/following{/other_user}","gists_url":"https://api.github.com/users/kpcyrd/gists{/gist_id}","starred_url":"https://api.github.com/users/kpcyrd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kpcyrd/subscriptions","organizations_url":"https://api.github.com/users/kpcyrd/orgs","repos_url":"https://api.github.com/users/kpcyrd/repos","events_url":"https://api.github.com/users/kpcyrd/events{/privacy}","received_events_url":"https://api.github.com/users/kpcyrd/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":352090567,"node_id":"MDU6TGFiZWwzNTIwOTA1Njc=","url":"https://api.github.com/repos/curl/curl/labels/KNOWN_BUGS%20material","name":"KNOWN_BUGS material","color":"d93f0b","default":false,"description":null},{"id":657824945,"node_id":"MDU6TGFiZWw2NTc4MjQ5NDU=","url":"https://api.github.com/repos/curl/curl/labels/help%20wanted","name":"help wanted","color":"fbca04","default":true,"description":null},{"id":3405978577,"node_id":"LA_kwDOAAiu0c7LAxvR","url":"https://api.github.com/repos/curl/curl/labels/script","name":"script","color":"379DD5","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2025-01-22T10:28:39Z","updated_at":"2025-03-24T22:48:50Z","closed_at":"2025-03-24T22:48:50Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I did this\n\nI tried to reproduce the Arch Linux curl package by repeating the build in the documented build environment and noticed the zsh completions do not match:\n\nhttps://web.archive.org/web/20250121190753/https://reproducible.archlinux.org/api/v0/builds/722464/diffoscope\n\n```diff\n@@ -13,19 +13,17 @@\n   {-D,--dump-header}'[Write the received headers to <filename>]':'<filename>':_files \\\n   {-y,--speed-time}'[Trigger '\\''speed-limit'\\'' abort after this time]':'<seconds>' \\\n   --abstract-unix-socket'[Connect via abstract Unix domain socket]':'<path>':_files \\\n   --connect-to'[Connect to host2 instead of host1]':'<HOST1\\:PORT1\\:HOST2\\:PORT2>' \\\n   {-E,--cert}'[Client certificate file and password]':'<certificate[\\:password]>' \\\n   --proxy-capath'[CA directory to verify proxy against]':'<dir>':'_path_files -/' \\\n   --proxy-pinnedpubkey'[FILE/HASHES public key to verify proxy with]':'<hashes>' \\\n-  --preproxy'[\\[protocol\\://\\]host\\[\\:port\\]           Use this proxy first]' \\\n   --resolve'[Resolve host+port to address]':'<[+]host\\:port\\:addr[,addr]...>' \\\n   --aws-sigv4'[AWS V4 signature auth]':'<provider1[\\:prvdr2[\\:reg[\\:srv]]]>' \\\n   {-b,--cookie}'[Send cookies from string/load from file]':'<data|filename>' \\\n-  {-x,--proxy}'[\\[protocol\\://\\]host\\[\\:port\\]              Use this proxy]' \\\n   --socks5-hostname'[SOCKS5 proxy, pass hostname to proxy]':'<host[\\:port]>' \\\n   --ftp-method'[Control CWD usage]':'<method>':'(multicwd nocwd singlecwd)' \\\n   --proto-default'[Use PROTOCOL for any URL missing a scheme]':'<protocol>' \\\n   --proxy-cacert'[CA certificates to verify proxy against]':'<file>':_files \\\n   --socks5-gssapi-service'[SOCKS5 proxy service name for GSS-API]':'<name>' \\\n   --capath'[CA directory to verify peer against]':'<dir>':'_path_files -/' \\\n   --ftp-alternative-to-user'[String to replace USER \\[name\\]]':'<command>' \\\n@@ -56,14 +54,15 @@\n   --proto-redir'[Enable/disable PROTOCOLS on redirect]':'<protocols>' \\\n   --proxy-cert'[Set client certificate for proxy]':'<cert[\\:passwd]>' \\\n   --proxy-ssl-allow-beast'[Allow this security flaw for HTTPS proxy]' \\\n   --trace-config'[Details to log in trace/verbose output]':'<string>' \\\n   --dns-interface'[Interface to use for DNS requests]':'<interface>' \\\n   --dump-ca-embed'[Write the embedded CA bundle to standard output]' \\\n   --keepalive-time'[Interval time for keepalive probes]':'<seconds>' \\\n+  --preproxy'[\\[protocol\\://\\]host\\[\\:port\\]  Use this proxy first]' \\\n   --random-file'[File for reading random data from]':'<file>':_files \\\n   --cacert'[CA certificate to verify peer against]':'<file>':_files \\\n   {-H,--header}'[Pass custom header(s) to server]':'<header/@file>' \\\n   --ignore-content-length'[Ignore the size of the remote resource]' \\\n   --keepalive-cnt'[Maximum number of keepalive probes]':'<integer>' \\\n   --proxy-header'[Pass custom header(s) to proxy]':'<header/@file>' \\\n   --proxy-ssl-auto-client-cert'[Auto client certificate for proxy]' \\\n@@ -88,14 +87,15 @@\n   --ftp-ssl-control'[Require TLS for login, clear for transfer]' \\\n   --hostpubmd5'[Acceptable MD5 hash of host public key]':'<md5>' \\\n   --hsts'[Enable HSTS with this cache file]':'<filename>':_files \\\n   --http2-prior-knowledge'[Use HTTP 2 without HTTP/1.1 Upgrade]' \\\n   --ip-tos'[Set IP Type of Service or Traffic Class]':'<string>' \\\n   --local-port'[Use a local port number within RANGE]':'<range>' \\\n   --pinnedpubkey'[Public key to verify peer against]':'<hashes>' \\\n+  {-x,--proxy}'[\\[protocol\\://\\]host\\[\\:port\\]  Use this proxy]' \\\n   --proxy-ca-native'[Load CA certs from the OS to verify proxy]' \\\n   --proxy-tlspassword'[TLS password for HTTPS proxy]':'<string>' \\\n   {-r,--range}'[Retrieve only the bytes within RANGE]':'<range>' \\\n   --socks4'[SOCKS4 proxy on given host + port]':'<host[\\:port]>' \\\n   --socks5'[SOCKS5 proxy on given host + port]':'<host[\\:port]>' \\\n   {-A,--user-agent}'[Send User-Agent <name> to server]':'<name>' \\\n   --egd-file'[EGD socket path for random data]':'<file>':_files \\\n```\n\n### I expected the following\n\nI expected the zsh completions to be deterministic when building identical source code.\n\nI found the perl script generating the completions (but have trouble reading it). It seems to parse `curl --help all` output and sort the generated lines by length, but the number of spaces differs across builds, causing some lines to rank higher/lower.\n\nhttps://github.com/curl/curl/blob/master/scripts/completion.pl\n\nRunning `curl --help all` with strace I noticed the terminal window size is being queried:\n```strace\nioctl(0, TIOCGWINSZ, {ws_row=29, ws_col=117, ws_xpixel=0, ws_ypixel=0}) = 0\n```\n\nThis is indeed coming from a function related to printing `--help` output:\n\nhttps://github.com/curl/curl/blob/96843f4ef74e02452972fd97fe15d8ff656f46ec/src/tool_help.c#L233-L307\n\nI suspect the zsh completions indirectly record the terminal width and the extra padding needs to be removed with `trim(...)` in the zsh completion script.\n\nThanks!\n\n### curl/libcurl version\n\ncurl 8.11.1\n\n### operating system\n\nArch Linux","closed_by":{"login":"bagder","id":177011,"node_id":"MDQ6VXNlcjE3NzAxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/177011?v=4","gravatar_id":"","url":"https://api.github.com/users/bagder","html_url":"https://github.com/bagder","followers_url":"https://api.github.com/users/bagder/followers","following_url":"https://api.github.com/users/bagder/following{/other_user}","gists_url":"https://api.github.com/users/bagder/gists{/gist_id}","starred_url":"https://api.github.com/users/bagder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bagder/subscriptions","organizations_url":"https://api.github.com/users/bagder/orgs","repos_url":"https://api.github.com/users/bagder/repos","events_url":"https://api.github.com/users/bagder/events{/privacy}","received_events_url":"https://api.github.com/users/bagder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/curl/curl/issues/16072/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/curl/curl/issues/16072/timeline","performed_via_github_app":null,"state_reason":"completed"}