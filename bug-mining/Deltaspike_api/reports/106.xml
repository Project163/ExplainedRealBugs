<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:52:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DELTASPIKE-1198] BeanManagerProvider.isActive() returns true after container shutdown</title>
                <link>https://issues.apache.org/jira/browse/DELTASPIKE-1198</link>
                <project id="12312820" key="DELTASPIKE">DeltaSpike</project>
                    <description>&lt;p&gt;While trying to implement &lt;a href=&quot;https://issues.apache.org/jira/browse/DELTASPIKE-1197&quot; title=&quot;CDIAwareConstraintValidatorFactory should fall back to delegate when CDI is not active&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DELTASPIKE-1197&quot;&gt;DELTASPIKE-1197&lt;/a&gt; I found that &lt;tt&gt;BeanManagerProvider.isActive()&lt;/tt&gt; returns true after container shutdown.&lt;/p&gt;

&lt;p&gt;The javadocs for &lt;tt&gt;isActive()&lt;/tt&gt; say &quot;@return true if the BeanManagerProvider is ready to be used&quot;, but when it is in this state, the BeanManagerProvider can&apos;t actually be used because the CDI container is not active. &lt;/p&gt;

&lt;p&gt;In the case of Weld, when &lt;tt&gt;BeanProvider.getContextualReference()&lt;/tt&gt; was called I got errors like &quot;java.lang.IllegalStateException: Singleton not set for STATIC_INSTANCE =&amp;gt; []&quot;. There was no stack trace, but that message comes from Weld&apos;s RegistrySingletonProvider.java.&lt;/p&gt;

&lt;p&gt;It would seem reasonable to reset bmpSingleton to null during cleanupStoredBeanManagerOnShutdown, but for some reason this breaks a lot of tests.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12999085">DELTASPIKE-1198</key>
            <summary>BeanManagerProvider.isActive() returns true after container shutdown</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="struberg">Mark Struberg</assignee>
                                    <reporter username="sflanigan">Sean Flanigan</reporter>
                        <labels>
                    </labels>
                <created>Tue, 23 Aug 2016 02:10:26 +0000</created>
                <updated>Fri, 7 Sep 2018 11:07:34 +0000</updated>
                            <resolved>Fri, 7 Sep 2018 11:07:33 +0000</resolved>
                                    <version>1.7.0</version>
                    <version>1.7.2</version>
                                    <fixVersion>1.9.0</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15432019" author="sflanigan" created="Tue, 23 Aug 2016 02:42:13 +0000"  >&lt;p&gt;FWIW, I was able to reconstruct the stack trace in the debugger:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.IllegalStateException: Singleton not set for STATIC_INSTANCE =&amp;gt; []
	at org.jboss.weld.bootstrap.api.helpers.RegistrySingletonProvider$RegistrySingleton.get(RegistrySingletonProvider.java:28)
	at org.jboss.weld.Container.instance(Container.java:65)
	at org.jboss.weld.Container.instance(Container.java:69)
	at org.jboss.weld.bean.builtin.BeanManagerProxy.checkContainerState(BeanManagerProxy.java:234)
	at org.jboss.weld.bean.builtin.BeanManagerProxy.checkContainerState(BeanManagerProxy.java:247)
	at org.jboss.weld.bean.builtin.BeanManagerProxy.getBeans(BeanManagerProxy.java:96)
	at org.apache.deltaspike.core.api.provider.BeanProvider.getContextualReference(BeanProvider.java:144)
	at org.apache.deltaspike.core.api.provider.BeanProvider.getContextualReference(BeanProvider.java:121)
	at org.apache.deltaspike.beanvalidation.impl.CDIAwareConstraintValidatorFactory.getInstance(CDIAwareConstraintValidatorFactory.java:61)
	at org.zanata.test.TestingConstraintValidatorFactory.getInstance(TestingConstraintValidatorFactory.java:54)
	...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;(Weld SE 2.3.2.Final, DeltaSpike 1.7.0)&lt;/p&gt;

&lt;p&gt;NB: TestingConstraintValidatorFactory simply checks BeanManagerProvider.isActive() before calling CDIAwareConstraintValidatorFactory.getInstance().&lt;/p&gt;</comment>
                            <comment id="15432025" author="johndament" created="Tue, 23 Aug 2016 02:46:04 +0000"  >&lt;p&gt;Sean, I was wondering what your use case is.  This is a feature of bean val 1.1, so we don&apos;t really maintain it anymore.  How are you using it?  What are you deploying to?&lt;/p&gt;</comment>
                            <comment id="15432053" author="sflanigan" created="Tue, 23 Aug 2016 03:14:02 +0000"  >&lt;p&gt;Hi John, what are you saying a feature of bean val 1.1? Are you talking about CDIAwareConstraintValidatorFactory or BeanManagerProvider? Has CDIAwareConstraintValidatorFactory been replaced by something else?&lt;/p&gt;

&lt;p&gt;My use case: I have a monolithic application, with a mixture of unit tests based on CDI-Unit (which uses Weld SE) and plain non-CDI JUnit tests. At runtime, the code is deployed to EAP 7 or WildFly 10, but I&apos;m not having a problem there, nor in my Arquillian integration tests, because there I just use CDIAwareConstraintValidatorFactory in a Weld/CDI environment. I&apos;m actually in the process of migrating to EAP 7 from 6.&lt;/p&gt;

&lt;p&gt;If META-INF/validation.xml points to CDIAwareConstraintValidatorFactory, my CDI tests work, but some of my non-CDI tests fail, because Hibernate loads CDIAwareConstraintValidatorFactory and it tries to initialise BeanManagerProvider.&lt;/p&gt;

&lt;p&gt;If META-INF/validation.xml is missing, my non-CDI tests are okay (they don&apos;t use any validators which require CDI), but some of my CDI tests fail because the CDI validators don&apos;t have their CDI injections.&lt;/p&gt;

&lt;p&gt;If META-INF/validation.xml points to org.zanata.test.TestingConstraintValidatorFactory, which only uses CDIAwareConstraintValidatorFactory if isActive() is true, that would work in all cases, except for this problem with BeanManagerProvider.isActive().&lt;/p&gt;</comment>
                            <comment id="15434015" author="sflanigan" created="Wed, 24 Aug 2016 01:28:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=johndament&quot; class=&quot;user-hover&quot; rel=&quot;johndament&quot;&gt;johndament&lt;/a&gt; I suppose by &quot;bean val 1.1&quot; you meant &lt;a href=&quot;https://rmannibucau.wordpress.com/2013/07/02/bean-validation-1-1/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt; rather than this &lt;a href=&quot;https://deltaspike.apache.org/documentation/bean-validation.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Bean Validation&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;In the case of Hibernate Validator, I think InjectingConstraintValidatorFactory still insists on a live BeanManager, so I would still need to avoid using it in my non-CDI tests.&lt;/p&gt;

&lt;p&gt;However, unless I write my own CDI extension (and ensure that CDI-Unit picks it up), I&apos;m not sure how to detect whether CDI is currently active from a ConstraintValidatorFactory, if I can&apos;t rely on BeanManagerProvider.isActive(). (BeanManagerProvider almost seems to be that CDI extension already.)&lt;/p&gt;

&lt;p&gt;For now, my only workaround is to call &lt;tt&gt;BeanManagerProvider.isActive()&lt;/tt&gt; then double check with &lt;tt&gt;BeanManagerProvider.getInstance().getBeanManager().getBeans()&lt;/tt&gt; catching &lt;tt&gt;IllegalStateException&lt;/tt&gt;, which is of course not very pretty.&lt;/p&gt;</comment>
                            <comment id="15434852" author="johndament" created="Wed, 24 Aug 2016 12:40:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sflanigan&quot; class=&quot;user-hover&quot; rel=&quot;sflanigan&quot;&gt;sflanigan&lt;/a&gt; I suspect you might be doing too much logic in your validator if this is getting to be an issue.  FWIW, we had a similar issue on the project I&apos;m on currently.  We decided to have two types of tests, low level unit tests using mocks.  Higher level component style tests that will boot up a CDI container for specifically the validators that are doing database calls.&lt;/p&gt;

&lt;p&gt;You can also look at DeltaSpike&apos;s test control module.  I think the real issue you&apos;re running into is that weld has no real &quot;off&quot; state, it launches application scope when it starts.  OWB behaves a little different, in that it can start that independently.&lt;/p&gt;</comment>
                            <comment id="15434950" author="sflanigan" created="Wed, 24 Aug 2016 13:37:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=johndament&quot; class=&quot;user-hover&quot; rel=&quot;johndament&quot;&gt;johndament&lt;/a&gt; The validators themselves aren&apos;t terribly complex - at worst, they might just use a DAO to check for a duplicate email address.  But I do have a mix of very simple validators which don&apos;t even need mocks to test, and other validators like the duplicate email validator which need injection of things like DAOs. Switching them all to CDI tests would get around the problem, but that&apos;s quite a bit of work, especially for any tests which already needed a custom JUnit Runner. &lt;/p&gt;

&lt;p&gt;I don&apos;t know how to tell Hibernate to use a non-CDI ConstraintValidatorFactory for simple unit tests, and use CdiAwareConstraintValidatorFactory or InjectingConstraintValidatorFactory for the others, so the next best thing would be a ConstraintValidatorFactory which chooses between them, depending on the state of CDI. BeanManagerProvider is generally a really handy class for low-level CDI stuff like getting a BeanManager, so it&apos;s a shame &lt;tt&gt;isActive()&lt;/tt&gt; can&apos;t be used for this.&lt;/p&gt;

&lt;p&gt;I&apos;m not using Test-Control, but I am using CDI-Unit, together with Weld SE, which does a lot of the same things. From what I can tell, it is shutting down the Weld deployment between tests, at least enough to blow up when BeanManagerProvider tries to use it. &lt;/p&gt;

&lt;p&gt;The weird thing is that the class BeanManagerProvider is retaining a static reference to a object which were created by the first Weld container (including an instance of BeanManagerProvider itself, which holds a BeanManager), even after that container has stopped. That doesn&apos;t cause a problem most of the time (except a minor memory leak on shutdown perhaps), but it does cause &lt;tt&gt;isActive()&lt;/tt&gt; to violate its own javadoc IMHO. &lt;/p&gt;

&lt;p&gt;Have you got any idea why the BeanManagerProvider needs to retain state after container shutdown?&lt;/p&gt;</comment>
                            <comment id="16000761" author="struberg" created="Mon, 8 May 2017 13:56:32 +0000"  >&lt;p&gt;I&apos;ve reviewed this and I interpret BeanManagerProvider#isActive() a bit different.&lt;br/&gt;
It returns true if the BMP got initialised. But having the BeanManagers itself is something different.&lt;br/&gt;
We might probably not unload the BeanManagers properly, which would be a problem. Investigating.&lt;/p&gt;</comment>
                            <comment id="16000764" author="struberg" created="Mon, 8 May 2017 13:59:15 +0000"  >&lt;p&gt;Seems we do it properly.&lt;br/&gt;
See cleanupStoredBeanManagerOnShutdown.&lt;br/&gt;
There we remove the BeanManager from the Map again.&lt;br/&gt;
Not sure how you manage to access the BeanManager after shutdown. How does your project setup look like?&lt;/p&gt;</comment>
                            <comment id="16001886" author="sflanigan" created="Tue, 9 May 2017 01:12:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=struberg&quot; class=&quot;user-hover&quot; rel=&quot;struberg&quot;&gt;struberg&lt;/a&gt; I&apos;m afraid I&apos;m a bit rusty on this code by now, but in my own project I have a test suite which uses CDI-Unit (based on Weld SE) along with plain (non-CDI) unit tests, trying to use CDIAwareConstraintValidatorFactory in both environments, which is why I needed &lt;a href=&quot;https://issues.apache.org/jira/browse/DELTASPIKE-1197&quot; title=&quot;CDIAwareConstraintValidatorFactory should fall back to delegate when CDI is not active&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DELTASPIKE-1197&quot;&gt;DELTASPIKE-1197&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;See my changes in &lt;a href=&quot;https://github.com/apache/deltaspike/compare/master...seanf:DELTASPIKE-1197&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/deltaspike/compare/master...seanf:DELTASPIKE-1197&lt;/a&gt; (and &lt;a href=&quot;https://issues.apache.org/jira/browse/DELTASPIKE-1197?focusedCommentId=15431960&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15431960&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;DELTASPIKE-1197 comment 15431960&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;I think it was accessing the &lt;tt&gt;BeanManager&lt;/tt&gt; via &lt;tt&gt;bmpSingleton&lt;/tt&gt; (which is static). As I said in the description, it would be good to null it out at shutdown, but when I tried that I found that it broke a number of DeltaSpike&apos;s tests. I can&apos;t reproduce those test failures now, but as I said, I&apos;m a bit rusty on this.&lt;/p&gt;


&lt;p&gt;Anyway, I suppose the real problem is that &lt;tt&gt;isActive&lt;/tt&gt; is that it doesn&apos;t agree with &lt;tt&gt;cleanupStoredBeanManagerOnShutdown&lt;/tt&gt;, since the cleanup method just removes things from a map, but &lt;tt&gt;isActive&lt;/tt&gt; doesn&apos;t look inside that map. &lt;/p&gt;

&lt;p&gt;If for some reason &lt;tt&gt;bmpSingleton&lt;/tt&gt; can&apos;t be set to null, what if &lt;tt&gt;isActive&lt;/tt&gt; were something like this?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isActive()
    {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; bmpSingleton != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; bmpSingleton.bmInfos.containsKey(ClassUtils.getClassLoader(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;));
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16606991" author="jira-bot" created="Fri, 7 Sep 2018 11:07:17 +0000"  >&lt;p&gt;Commit 20ba0e9f7d0c944885092bafb85f3df51b8ed7df in deltaspike&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=struberg&quot; class=&quot;user-hover&quot; rel=&quot;struberg&quot;&gt;struberg&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=deltaspike.git;h=20ba0e9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=deltaspike.git;h=20ba0e9&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DELTASPIKE-1198&quot; title=&quot;BeanManagerProvider.isActive() returns true after container shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DELTASPIKE-1198&quot;&gt;&lt;del&gt;DELTASPIKE-1198&lt;/del&gt;&lt;/a&gt; check if the &lt;em&gt;current&lt;/em&gt; beanManager is still attached.&lt;/p&gt;

&lt;p&gt;This will deal with shutting down the container&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12998811">DELTASPIKE-1197</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 10 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i32mjz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>