<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:52:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DELTASPIKE-782] BeanManager lookup fails when BeanManager created in parent classloader and in SE mode</title>
                <link>https://issues.apache.org/jira/browse/DELTASPIKE-782</link>
                <project id="12312820" key="DELTASPIKE">DeltaSpike</project>
                    <description>&lt;p&gt;using embeadded tomcat and CdiServletContextListener attempting to use BeanProvider from within a Servlet fails:&lt;/p&gt;

&lt;p&gt;ov 16, 2014 8:19:10 AM org.apache.catalina.core.StandardWrapperValve invoke&lt;br/&gt;
SEVERE: Servlet.service() for servlet &lt;span class=&quot;error&quot;&gt;&amp;#91;YourServlet&amp;#93;&lt;/span&gt; in context with path &lt;span class=&quot;error&quot;&gt;&amp;#91;/&amp;#93;&lt;/span&gt; threw exception&lt;br/&gt;
java.lang.IllegalStateException: Unable to find BeanManager. Please ensure that you configured the CDI implementation of your choice properly.&lt;br/&gt;
	at org.apache.deltaspike.core.api.provider.BeanManagerProvider.getBeanManager(BeanManagerProvider.java:201)&lt;br/&gt;
	at org.apache.deltaspike.core.api.provider.BeanProvider.getBeanManager(BeanProvider.java:475)&lt;br/&gt;
	at org.apache.deltaspike.core.api.provider.BeanProvider.getContextualReference(BeanProvider.java:118)&lt;br/&gt;
	at org.apache.deltaspike.core.api.provider.BeanProvider.getContextualReference(BeanProvider.java:101)&lt;/p&gt;

&lt;p&gt;The following code resolves fine in the same location:&lt;br/&gt;
BeanManager beanManager = CdiContainerLoader.getCdiContainer().getBeanManager();&lt;/p&gt;

&lt;p&gt;looks like bmi.loadTimeBm at BeanManagerProvider is not being set properly when using the servlet listener&lt;/p&gt;</description>
                <environment></environment>
        <key id="12755663">DELTASPIKE-782</key>
            <summary>BeanManager lookup fails when BeanManager created in parent classloader and in SE mode</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="struberg">Mark Struberg</assignee>
                                    <reporter username="shay_matasaro">Shay matasaro</reporter>
                        <labels>
                    </labels>
                <created>Sun, 16 Nov 2014 13:50:12 +0000</created>
                <updated>Wed, 3 Dec 2014 18:05:42 +0000</updated>
                            <resolved>Mon, 17 Nov 2014 11:10:50 +0000</resolved>
                                    <version>1.1.0</version>
                                    <fixVersion>1.2.0</fixVersion>
                                    <component>CdiControl</component>
                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14213953" author="johndament" created="Sun, 16 Nov 2014 16:20:02 +0000"  >&lt;p&gt;Hi.  Please provide a test case that reproduces this issue.  What container are you using (Weld or OWB) as well as version.&lt;/p&gt;</comment>
                            <comment id="14213963" author="johndament" created="Sun, 16 Nov 2014 17:01:53 +0000"  >&lt;p&gt;Ran on OWB:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;mvn clean install -Dtest=TomcatTest -Dowb.version=1.2.6 -POWB

SEVERE: Servlet.service() &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; servlet [RequestServlet] in context with path [/] threw exception
java.lang.IllegalStateException: Unable to find BeanManager. Please ensure that you configured the CDI implementation of your choice properly.
	at org.apache.deltaspike.core.api.provider.BeanManagerProvider.getBeanManager(BeanManagerProvider.java:242)
	at org.apache.deltaspike.core.api.provider.BeanProvider.getBeanManager(BeanProvider.java:510)
	at org.apache.deltaspike.core.api.provider.BeanProvider.getContextualReference(BeanProvider.java:119)
	at org.apache.deltaspike.core.api.provider.BeanProvider.getContextualReference(BeanProvider.java:100)
	at org.apache.deltaspike.cdise.servlet.test.content.RequestServlet.getRequestScopedBean(RequestServlet.java:68)
	at org.apache.deltaspike.cdise.servlet.test.content.RequestServlet.doGet(RequestServlet.java:47)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:575)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:668)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:303)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)
	at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:220)
	at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:122)
	at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:501)
	at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:171)
	at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)
	at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:116)
	at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:408)
	at org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1040)
	at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:607)
	at org.apache.tomcat.util.net.JIoEndpoint$SocketProcessor.run(JIoEndpoint.java:314)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14213964" author="johndament" created="Sun, 16 Nov 2014 17:02:33 +0000"  >&lt;p&gt;Ran on OWB2 Profile:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;mvn clean install -Dtest=TomcatTest -Dowb.version=1.5.0-SNAPSHOT -POWB2

SEVERE: Servlet.service() &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; servlet [RequestServlet] in context with path [/] threw exception
java.lang.IllegalStateException: Could not find beans &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; Type=&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.deltaspike.cdise.servlet.test.content.RequestScopedBean and qualifiers:[]
	at org.apache.deltaspike.core.api.provider.BeanProvider.getContextualReference(BeanProvider.java:153)
	at org.apache.deltaspike.core.api.provider.BeanProvider.getContextualReference(BeanProvider.java:121)
	at org.apache.deltaspike.core.api.provider.BeanProvider.getContextualReference(BeanProvider.java:100)
	at org.apache.deltaspike.cdise.servlet.test.content.RequestServlet.getRequestScopedBean(RequestServlet.java:68)
	at org.apache.deltaspike.cdise.servlet.test.content.RequestServlet.doGet(RequestServlet.java:47)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:575)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:668)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:303)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)
	at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:220)
	at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:122)
	at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:501)
	at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:171)
	at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)
	at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:116)
	at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:408)
	at org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1040)
	at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:607)
	at org.apache.tomcat.util.net.JIoEndpoint$SocketProcessor.run(JIoEndpoint.java:314)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14213965" author="johndament" created="Sun, 16 Nov 2014 17:04:15 +0000"  >&lt;p&gt;Ran against Weld 1.1.18:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;mvn clean install -Dtest=TomcatTest -Dweld.version=1.1.18.Final -PWeld

SEVERE: Servlet.service() &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; servlet [RequestServlet] in context with path [/] threw exception
java.lang.IllegalStateException: Unable to find BeanManager. Please ensure that you configured the CDI implementation of your choice properly.
	at org.apache.deltaspike.core.api.provider.BeanManagerProvider.getBeanManager(BeanManagerProvider.java:242)
	at org.apache.deltaspike.core.api.provider.BeanProvider.getBeanManager(BeanProvider.java:510)
	at org.apache.deltaspike.core.api.provider.BeanProvider.getContextualReference(BeanProvider.java:119)
	at org.apache.deltaspike.core.api.provider.BeanProvider.getContextualReference(BeanProvider.java:100)
	at org.apache.deltaspike.cdise.servlet.test.content.RequestServlet.getRequestScopedBean(RequestServlet.java:68)
	at org.apache.deltaspike.cdise.servlet.test.content.RequestServlet.doGet(RequestServlet.java:47)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:575)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:668)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:303)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)
	at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:220)
	at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:122)
	at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:501)
	at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:171)
	at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)
	at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:116)
	at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:408)
	at org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1040)
	at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:607)
	at org.apache.tomcat.util.net.JIoEndpoint$SocketProcessor.run(JIoEndpoint.java:314)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14213966" author="shay_matasaro" created="Sun, 16 Nov 2014 17:05:05 +0000"  >&lt;p&gt;Hi John,&lt;/p&gt;

&lt;p&gt;I&apos;m using Weld.&lt;/p&gt;

&lt;p&gt;Looks like you were able to reproduce also on owb&lt;/p&gt;
</comment>
                            <comment id="14213967" author="johndament" created="Sun, 16 Nov 2014 17:05:22 +0000"  >&lt;p&gt;Ran against Weld 2.2.5:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;mvn clean install -Dtest=TomcatTest -Dweld.version=2.2.5.Final -PWeld

Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 1.718 sec

Results :

Tests run: 1, Failures: 0, Errors: 0, Skipped: 0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14213968" author="johndament" created="Sun, 16 Nov 2014 17:05:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shay_matasaro&quot; class=&quot;user-hover&quot; rel=&quot;shay_matasaro&quot;&gt;shay_matasaro&lt;/a&gt; please provide all details requested.&lt;/p&gt;</comment>
                            <comment id="14213969" author="johndament" created="Sun, 16 Nov 2014 17:07:42 +0000"  >&lt;p&gt;The test change in RequestServlet&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; RequestScopedBean getRequestScopedBean()
    {
        RequestScopedBean instance = BeanProvider.getContextualReference(RequestScopedBean.class);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; instance;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This appears to be more related to recent changes around bean manager lookup (since it can successfully look it up against CDI 1.1 impls, the OWB failure probably needs to be looked into a bit more.&lt;/p&gt;</comment>
                            <comment id="14213971" author="johndament" created="Sun, 16 Nov 2014 17:10:51 +0000"  >&lt;p&gt;Seems like it&apos;s also related to &lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/incubator-deltaspike-users/201304.mbox/%3C1366991646.35051.YahooMailNeo@web172405.mail.ir2.yahoo.com%3E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://mail-archives.apache.org/mod_mbox/incubator-deltaspike-users/201304.mbox/%3C1366991646.35051.YahooMailNeo@web172405.mail.ir2.yahoo.com%3E&lt;/a&gt; since there appears to be many classloaders in play.&lt;/p&gt;</comment>
                            <comment id="14213976" author="johndament" created="Sun, 16 Nov 2014 17:26:31 +0000"  >&lt;p&gt;From looking at this, I doubt that using BeanManagerProvider ever worked from cdi-ctrl enabled components.  The error has nothing to do with servlet, but has everything to do with multiple classloaders in play.&lt;/p&gt;</comment>
                            <comment id="14213993" author="johndament" created="Sun, 16 Nov 2014 18:22:25 +0000"  >&lt;p&gt;Here&apos;s a test that shows this issue in play, without the servlet module enabled.  Seems like the recent addition to look up via CDI.current() fixes it for CDI 1.1 impls, but not for older impls.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/johnament/DELTASPIKE-782&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/johnament/DELTASPIKE-782&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14213995" author="johndament" created="Sun, 16 Nov 2014 18:25:52 +0000"  >&lt;p&gt;The maven commands listed here can be used in the github repo.  I didn&apos;t add a test to deltaspike to avoid circular references (core builds after cdi ctrl).&lt;/p&gt;</comment>
                            <comment id="14214015" author="gpetracek" created="Sun, 16 Nov 2014 19:15:51 +0000"  >&lt;p&gt;we had several changes here for v1.1.1 -&amp;gt; please try it with the latest snapshot.&lt;/p&gt;</comment>
                            <comment id="14214029" author="johndament" created="Sun, 16 Nov 2014 19:43:31 +0000"  >&lt;p&gt;It will pass for weld 2.x but fail for all others.  I think I have a work around for core to fix this.  Will look tonight.&lt;/p&gt;</comment>
                            <comment id="14214033" author="romain.manni-bucau" created="Sun, 16 Nov 2014 19:46:49 +0000"  >&lt;p&gt;We should stop trying to make it working and just rely on weld/OWB internals which would work everytime. We know using the classloader is very fragile in several cases (it is also easy to make it &quot;green&quot; but not doing what is expected with arquillian or junit alone). wdyt?&lt;/p&gt;</comment>
                            <comment id="14214043" author="struberg" created="Sun, 16 Nov 2014 20:04:31 +0000"  >&lt;p&gt;I don&apos;t get the problem. I&apos;ve been using the current BMP as is since many years in various different containers (GlassFish, WAS, TomEE, WildFly) and &lt;b&gt;never&lt;/b&gt; experienced such problems. So what is the special thing with your setup?&lt;br/&gt;
The only reason this can happen is if you use a totally different BeanManager to boot up your app than you later use to execute your application. But in that case the CDI container is the LEAST thing I would be seriously concerned off.&lt;/p&gt;</comment>
                            <comment id="14214045" author="struberg" created="Sun, 16 Nov 2014 20:06:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=romain.manni-bucau&quot; class=&quot;user-hover&quot; rel=&quot;romain.manni-bucau&quot;&gt;romain.manni-bucau&lt;/a&gt; That would work neither and we would need to deal with SE vs EE integration and dozen different versions of the impls.&lt;/p&gt;</comment>
                            <comment id="14214046" author="struberg" created="Sun, 16 Nov 2014 20:08:08 +0000"  >&lt;p&gt;[&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=johndament&quot; class=&quot;user-hover&quot; rel=&quot;johndament&quot;&gt;johndament&lt;/a&gt; please do NOT commit your hack but please post the patch up for review first. This is really very sensitive code. &lt;/p&gt;</comment>
                            <comment id="14214048" author="gpetracek" created="Sun, 16 Nov 2014 20:09:36 +0000"  >&lt;p&gt;i agree with mark - @romain: -1 - you had an idea for &lt;a href=&quot;https://issues.apache.org/jira/browse/DELTASPIKE-404&quot; title=&quot;BeanManagerProvider leaks in case of undeploy/redeploy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DELTASPIKE-404&quot;&gt;&lt;del&gt;DELTASPIKE-404&lt;/del&gt;&lt;/a&gt; which sounded interesting, but moving to a container specific lookup is no option imo (as mentioned by mark)&lt;/p&gt;</comment>
                            <comment id="14214055" author="romain.manni-bucau" created="Sun, 16 Nov 2014 20:30:14 +0000"  >&lt;p&gt;There is no portable way to solve it. All solutions are wrong and each &quot;fix&quot; broke some previously handled cases. That s why specific but localised code is better. Using a cdictlr#getBM would be cleaner IMO for cdi 1.0 containers.&lt;/p&gt;</comment>
                            <comment id="14214059" author="struberg" created="Sun, 16 Nov 2014 20:39:52 +0000"  >&lt;p&gt;The only thing which is wrong is that some containers try to bootstrap applications with a totally different ClassLoader than they use later at runtime. That CRIES for problems! And we are just the first one to blow up, but there are many more issues with that approach (again: not OUR approach, but the container setup).&lt;/p&gt;

&lt;p&gt;You MUST support the case that someone stores classes, static fields etc when booting up and using CDI extensions. If you later at runtime would use another ClassLoader, then all those instances collected in some CDI extensions (not only DeltaSpike!) would crash with ClassLoader errors.&lt;/p&gt;

&lt;p&gt;There are basically 3 valid scenarios: &lt;br/&gt;
1.) The container boots up with the &apos;EAR ClassLoader&apos; and later uses different child classloaders for each WAR at runtime. Still the WarClassLoaders have the EarClassLoader as parent -&amp;gt; works perfectly fine with DS.&lt;/p&gt;

&lt;p&gt;2.) Each WAR get&apos;s booted with it&apos;s own BeanManager (+ 1 for the &apos;common&apos; parts like JMS). This is what you get in WebSphere. -&amp;gt; works perfectly fine with DS.&lt;/p&gt;

&lt;p&gt;3.) There is only 1 ClassLoader and all is treated as &apos;flat&apos; -&amp;gt; works perfectly fine with DS.&lt;/p&gt;

&lt;p&gt;So what is the issue? Where can I retest the scenario to see what the real problem is?&lt;/p&gt;</comment>
                            <comment id="14214064" author="romain.manni-bucau" created="Sun, 16 Nov 2014 20:48:29 +0000"  >&lt;p&gt;Last time I looked app loader bm was random in several embedded cas or worse: you get one when there is no app using apploader. CDI and classloaders have no link by spec so we cant assule anything on it. Works often cause it makes sense but on our side that is by luck. Also Im pretty we can break it with scripting language usages where another loader is used.&lt;/p&gt;</comment>
                            <comment id="14214065" author="johndament" created="Sun, 16 Nov 2014 20:50:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=struberg&quot; class=&quot;user-hover&quot; rel=&quot;struberg&quot;&gt;struberg&lt;/a&gt; here&apos;s a link that includes instructions on what to run.  &lt;a href=&quot;https://issues.apache.org/jira/browse/DELTASPIKE-782?focusedCommentId=14213993&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14213993&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/DELTASPIKE-782?focusedCommentId=14213993&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14213993&lt;/a&gt;&lt;br/&gt;
The following show maven commands to execute: &lt;a href=&quot;https://issues.apache.org/jira/browse/DELTASPIKE-782?focusedCommentId=14213963&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14213963&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/DELTASPIKE-782?focusedCommentId=14213963&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14213963&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The problem is that tomcat (in this particular case) is creating a webapp classloader, so when the servlet tries to load a bean manager it&apos;s not found within that classloader&apos;s context.  It&apos;s in the parent.  It looks like there&apos;s a bug though with the newly created parent classloader resolver.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=romain.manni-bucau&quot; class=&quot;user-hover&quot; rel=&quot;romain.manni-bucau&quot;&gt;romain.manni-bucau&lt;/a&gt; is generally on the right track.  My &lt;em&gt;&quot;hack&quot;&lt;/em&gt; is to refactor BeanManagerProvider to add a case for using CdiContainerLoader.getCdiContainer().getBeanManager() to find the appropriate one, which should fix this case.  My refactoring is to help clean up the hack with CDI.current() that exists.  This would avoid classloaders, but still be portable cross container.&lt;/p&gt;</comment>
                            <comment id="14214070" author="struberg" created="Sun, 16 Nov 2014 20:51:46 +0000"  >&lt;p&gt;We CAN assume that we get the same ClassLoader. The boot is PART of the application runtime. And you can rely on the fact that ClassLoaders wont get killed and you get a new one during application runtime.&lt;/p&gt;

&lt;p&gt;Again: IF you get such weird ClassLoader fuu, then this will not only break DeltaSpike but also LOTS of other libs as well.&lt;/p&gt;</comment>
                            <comment id="14214073" author="gpetracek" created="Sun, 16 Nov 2014 20:54:15 +0000"  >&lt;p&gt;@romain:&lt;br/&gt;
as mentioned by mark: it won&apos;t support more/all cases.&lt;br/&gt;
e.g. the first commit for &lt;a href=&quot;https://issues.apache.org/jira/browse/DELTASPIKE-772&quot; title=&quot;use CDI#current if supported&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DELTASPIKE-772&quot;&gt;&lt;del&gt;DELTASPIKE-772&lt;/del&gt;&lt;/a&gt; was &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=deltaspike.git;a=blobdiff;f=deltaspike/core/api/src/main/java/org/apache/deltaspike/core/api/provider/BeanManagerProvider.java;h=3ee9b1c0898b9f9db8de826aa327a4e175e3eb01;hp=a5d63e0987862a23d32be4686de1b315f85fa8bc;hb=51fa35e2e5831101ce523320b7f719f0db18dd6b;hpb=c27d288e175b98accf8cf25526c95b4f0f9f43f3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=deltaspike.git;a=blobdiff;f=deltaspike/core/api/src/main/java/org/apache/deltaspike/core/api/provider/BeanManagerProvider.java;h=3ee9b1c0898b9f9db8de826aa327a4e175e3eb01;hp=a5d63e0987862a23d32be4686de1b315f85fa8bc;hb=51fa35e2e5831101ce523320b7f719f0db18dd6b;hpb=c27d288e175b98accf8cf25526c95b4f0f9f43f3&lt;/a&gt; - you would expect that it just works, because it bypasses our old logic and delegates directly to CDI.current().getBeanManager(). however, e.g. it failed in wildfly8 once you have an ear. therefore, i had to change it again. we discussed a spi for it several times (which would also allow to delegate to cdi-ctrl). if we can resolve that topic forever with such a spi, i would be ok with it. however, a clear -1 for delegating to cdi-ctrl and drop what we have.&lt;/p&gt;</comment>
                            <comment id="14214074" author="romain.manni-bucau" created="Sun, 16 Nov 2014 20:55:05 +0000"  >&lt;p&gt;Well yes and no. Other libs using classloaders use other lookuo ways AFAIK. DS doesnt have a spi + the fact redeploys leak is just blocking for prod for me...allowing servers or users to override it would be great and a quick win.&lt;/p&gt;</comment>
                            <comment id="14214076" author="johndament" created="Sun, 16 Nov 2014 20:57:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gpetracek&quot; class=&quot;user-hover&quot; rel=&quot;gpetracek&quot;&gt;gpetracek&lt;/a&gt; are you saying you worked around a wildfly 8 bug with CDI.current() in an EAR?&lt;/p&gt;</comment>
                            <comment id="14214077" author="struberg" created="Sun, 16 Nov 2014 20:58:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=johndament&quot; class=&quot;user-hover&quot; rel=&quot;johndament&quot;&gt;johndament&lt;/a&gt; txs for the link. I don&apos;t see the problem. If you have the CDI integration for tomcat properly set up then it perfectly works. I have this running since many years with OWB. And I know others who do the same with Weld. &lt;br/&gt;
And I don&apos;t get the relation to CdiCtrl. This has totally nothing to do with it - the integration in Tomcat, Jetty, etc (plain Serlvet is fine) is done on a totally different level. I told you already in the cdictrl-servlet module that this will NOT work and will create more troubles than it attempts to solve. And here we go... &lt;/p&gt;</comment>
                            <comment id="14214079" author="struberg" created="Sun, 16 Nov 2014 21:00:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=romain.manni-bucau&quot; class=&quot;user-hover&quot; rel=&quot;romain.manni-bucau&quot;&gt;romain.manni-bucau&lt;/a&gt; if there is really a mem leak, then we should just use a WeakHashMap or WeakReference in the right places. That should do the trick.&lt;/p&gt;</comment>
                            <comment id="14214082" author="romain.manni-bucau" created="Sun, 16 Nov 2014 21:05:29 +0000"  >&lt;p&gt;Yes if we dont use a classloader as key it should work. Best way would surely be to associate to the extension all registered classloaders &lt;del&gt;as attribute&lt;/del&gt; and remove them instead of relying on tccl in BeforeShutdown no?&lt;/p&gt;</comment>
                            <comment id="14214085" author="johndament" created="Sun, 16 Nov 2014 21:06:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=struberg&quot; class=&quot;user-hover&quot; rel=&quot;struberg&quot;&gt;struberg&lt;/a&gt; as noted in the test case this, this has nothing to do with cdi ctrl servlet.  It has everything to do with adding child classloaders when using cdi ctrl and trying to resolve beans.&lt;/p&gt;</comment>
                            <comment id="14214088" author="johndament" created="Sun, 16 Nov 2014 21:14:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=struberg&quot; class=&quot;user-hover&quot; rel=&quot;struberg&quot;&gt;struberg&lt;/a&gt; if you want to see it in action where it fails, run the test w/ the debugger on and add break points to various places inside BeanManagerProvider#getBeanManagerInfo(ClassLoader).  You&apos;ll see that there&apos;s no time when running in SE mode when WebAppClassLoader is passed in and registered with a BeanManagerInfo.&lt;/p&gt;

&lt;p&gt;One way to test your theory is to have the OP use Weld-Servlet or OWB-Servlet modules to do the integration.  I just don&apos;t know what either would do when running in SE (embedded) mode.&lt;/p&gt;</comment>
                            <comment id="14214327" author="struberg" created="Mon, 17 Nov 2014 06:17:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=johndament&quot; class=&quot;user-hover&quot; rel=&quot;johndament&quot;&gt;johndament&lt;/a&gt; txs, will debug into. I know this exact use case did work in the past. If we did not find any BMI associated with the current TCCL then we a.) look up in JNDI and associate it. b.) go up the ClassLoader parent hierarchy until we find something.&lt;/p&gt;

&lt;p&gt;The container thus is allowed to even add client classloaders later on. &lt;br/&gt;
What you usually have when integrating OWB or Weld into Tomcat is that you use exactly the same WebAppClassLoader for boot and runtime. This is because the CDI container most time gets booted via ServletContextListener#contextInitialized. And this gets fired when the WebAppClassLoader is perfectly set up already.&lt;/p&gt;</comment>
                            <comment id="14214465" author="struberg" created="Mon, 17 Nov 2014 09:50:52 +0000"  >&lt;p&gt;I&apos;ve committed a fix for it. BMP did miss the parent lookup.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i22flr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>