{"url":"https://api.github.com/repos/quarkusio/quarkus/issues/50075","repository_url":"https://api.github.com/repos/quarkusio/quarkus","labels_url":"https://api.github.com/repos/quarkusio/quarkus/issues/50075/labels{/name}","comments_url":"https://api.github.com/repos/quarkusio/quarkus/issues/50075/comments","events_url":"https://api.github.com/repos/quarkusio/quarkus/issues/50075/events","html_url":"https://github.com/quarkusio/quarkus/issues/50075","id":3420705873,"node_id":"I_kwDOCFbutM7L49RR","number":50075,"title":"Quarkus AWS Lambda API Gateway v2 - Multiple Set-Cookie Headers Not Handled Correctly","user":{"login":"juliusz-cwiakalski","id":9881793,"node_id":"MDQ6VXNlcjk4ODE3OTM=","avatar_url":"https://avatars.githubusercontent.com/u/9881793?v=4","gravatar_id":"","url":"https://api.github.com/users/juliusz-cwiakalski","html_url":"https://github.com/juliusz-cwiakalski","followers_url":"https://api.github.com/users/juliusz-cwiakalski/followers","following_url":"https://api.github.com/users/juliusz-cwiakalski/following{/other_user}","gists_url":"https://api.github.com/users/juliusz-cwiakalski/gists{/gist_id}","starred_url":"https://api.github.com/users/juliusz-cwiakalski/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/juliusz-cwiakalski/subscriptions","organizations_url":"https://api.github.com/users/juliusz-cwiakalski/orgs","repos_url":"https://api.github.com/users/juliusz-cwiakalski/repos","events_url":"https://api.github.com/users/juliusz-cwiakalski/events{/privacy}","received_events_url":"https://api.github.com/users/juliusz-cwiakalski/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":985346620,"node_id":"MDU6TGFiZWw5ODUzNDY2MjA=","url":"https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug","name":"kind/bug","color":"d73a4a","default":false,"description":"Something isn't working"},{"id":1287515315,"node_id":"MDU6TGFiZWwxMjg3NTE1MzE1","url":"https://api.github.com/repos/quarkusio/quarkus/labels/area/kotlin","name":"area/kotlin","color":"0366d6","default":false,"description":""},{"id":1326073020,"node_id":"MDU6TGFiZWwxMzI2MDczMDIw","url":"https://api.github.com/repos/quarkusio/quarkus/labels/area/amazon-lambda","name":"area/amazon-lambda","color":"0366d6","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/quarkusio/quarkus/milestones/444","html_url":"https://github.com/quarkusio/quarkus/milestone/444","labels_url":"https://api.github.com/repos/quarkusio/quarkus/milestones/444/labels","id":13896792,"node_id":"MI_kwDOCFbutM4A1AxY","number":444,"title":"3.27.1","description":"","creator":{"login":"jmartisk","id":937315,"node_id":"MDQ6VXNlcjkzNzMxNQ==","avatar_url":"https://avatars.githubusercontent.com/u/937315?v=4","gravatar_id":"","url":"https://api.github.com/users/jmartisk","html_url":"https://github.com/jmartisk","followers_url":"https://api.github.com/users/jmartisk/followers","following_url":"https://api.github.com/users/jmartisk/following{/other_user}","gists_url":"https://api.github.com/users/jmartisk/gists{/gist_id}","starred_url":"https://api.github.com/users/jmartisk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jmartisk/subscriptions","organizations_url":"https://api.github.com/users/jmartisk/orgs","repos_url":"https://api.github.com/users/jmartisk/repos","events_url":"https://api.github.com/users/jmartisk/events{/privacy}","received_events_url":"https://api.github.com/users/jmartisk/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":1,"closed_issues":108,"state":"open","created_at":"2025-10-15T10:26:00Z","updated_at":"2025-11-05T14:33:46Z","due_on":null,"closed_at":null},"comments":6,"created_at":"2025-09-16T06:46:30Z","updated_at":"2025-10-15T11:28:42Z","closed_at":"2025-09-18T07:11:55Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\n\nWhen using Quarkus as an AWS Lambda handler behind API Gateway v2, multiple `Set-Cookie` headers are incorrectly merged into a single header in the Lambda response. This causes browsers to fail to set multiple cookies as expected, breaking applications that rely on more than one cookie.\n\n\n### Expected behavior\n\nThe response should use the `cookies` array field as per [API Gateway v2 Lambda integration](https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-develop-integrations-lambda.html), with each cookie as a separate entry:\n\n```json\n{\n  \"statusCode\": 200,\n  \"headers\": {\n    \"content-length\": \"40\",\n    \"Content-Type\": \"application/json\"\n  },\n  \"multiValueHeaders\": null,\n  \"cookies\": [\n    \"cookie1=value1;Version=1;Path=/;Max-Age=3600;Secure;HttpOnly;SameSite=Lax\",\n    \"cookie2=value2;Version=1;Path=/;Max-Age=3600;Secure;HttpOnly;SameSite=Lax\"\n  ],\n  \"body\": \"{\\\"status\\\":\\\"ok\\\",\\\"rootPath\\\":\\\"Hello hello\\\"}\",\n  \"isBase64Encoded\": false\n}\n```\n\nWith this format, browsers correctly set multiple cookies.\n\n### Actual behavior\n\nThe response from [PingController](https://github.com/juliusz-cwiakalski/example-bug-quarkus-aws-lambda-gateway-v2-multiple-cookies-broken/blob/main/src/main/java/com/cwiakalski/example/bug/PingController.java) merges all cookies into a single `Set-Cookie` header:\n\n```json\n{\n  \"statusCode\": 200,\n  \"headers\": {\n    \"content-length\": \"40\",\n    \"Set-Cookie\": \"cookie1=value1;Version=1;Path=/;Max-Age=3600;Secure;HttpOnly;SameSite=Lax,cookie2=value2;Version=1;Path=/;Max-Age=3600;Secure;HttpOnly;SameSite=Lax\",\n    \"Content-Type\": \"application/json\"\n  },\n  \"multiValueHeaders\": null,\n  \"cookies\": null,\n  \"body\": \"{\\\"status\\\":\\\"ok\\\",\\\"rootPath\\\":\\\"Hello hello\\\"}\",\n  \"isBase64Encoded\": false\n}\n```\n\nAs a result, when deployed to AWS, browsers do not set multiple cookies correctly if more than one is present.\n\n\n### How to Reproduce?\n\nDetailed description and steps in project https://github.com/juliusz-cwiakalski/example-bug-quarkus-aws-lambda-gateway-v2-multiple-cookies-broken\n\nIn short:\n1. clone the project\n2. `./gradlew build -Dquarkus.package.jar.enabled=true -Dquarkus.package.jar.type=legacy-jar -Dquarkus.native.enabled=false`\n3. `sam local invoke --template ./build/sam.jvm.yaml -e ./example-gateway-event.json`\n\n### Output of `uname -a` or `ver`\n\nLinux juliusz-Latitude-5421 6.8.0-79-generic #79-Ubuntu SMP PREEMPT_DYNAMIC Tue Aug 12 14:42:46 UTC 2025 x86_64 x86_64 x86_64 GNU/Linux\n\n### Output of `java -version`\n\nopenjdk version \"21.0.5\" 2024-10-15 LTS OpenJDK Runtime Environment Corretto-21.0.5.11.1 (build 21.0.5+11-LTS) OpenJDK 64-Bit Server VM Corretto-21.0.5.11.1 (build 21.0.5+11-LTS, mixed mode, sharing)\n\n### Quarkus version or git rev\n\n3.24.4\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\n------------------------------------------------------------ Gradle 8.14 ------------------------------------------------------------  Build time:    2025-04-25 09:29:08 UTC Revision:      34c560e3be961658a6fbcd7170ec2443a228b109  Kotlin:        2.0.21 Groovy:        3.0.24 Ant:           Apache Ant(TM) version 1.10.15 compiled on August 25 2024 Launcher JVM:  21.0.5 (Amazon.com Inc. 21.0.5+11-LTS) Daemon JVM:    /home/juliusz/.sdkman/candidates/java/21.0.5-amzn (no JDK specified, using current Java home) OS:            Linux 6.8.0-79-generic amd64\n\n### Additional information\n\n## Root Cause Analysis\n\nThe bug is caused by the following logic in [LambdaHttpHandler](https://github.com/quarkusio/quarkus/blob/71b94dd392f01194fa6a9b9d4bad28f2527cccc4/extensions/amazon-lambda-http/runtime/src/main/java/io/quarkus/amazon/lambda/http/LambdaHttpHandler.java#L112):\n\n```java\n// Handle cookies separately to preserve commas in the header values\n@Override\npublic void handleMessage(Object msg) {\n    try {\n        // ...existing code...\n        if (msg instanceof HttpResponse res) {\n            responseBuilder.setStatusCode(res.status().code());\n            final Map<String, String> headers = new HashMap<>();\n            responseBuilder.setHeaders(headers);\n            for (String name : res.headers().names()) {\n                final List<String> allForName = res.headers().getAll(name);\n                if (allForName == null || allForName.isEmpty()) {\n                    continue;\n                }\n                // Handle cookies separately to preserve commas in the header values\n                if (\"set-cookie\".equals(name)) {\n                    responseBuilder.setCookies(allForName);\n                    continue;\n                }\n                // ...\n            }\n        }\n    }\n}\n```\n\nHowever, in the Lambda runtime context, the `msg` is of type `io.vertx.core.http.impl.AssembledFullHttpResponse`, and its headers are an instance of `io.vertx.core.http.impl.headers.HeadersMultiMap`, which is case-insensitive and converts all header names to Camel-Kebab-Case. Thus, the check for `\"set-cookie\"` fails because the actual header name is `\"Set-Cookie\"`.\n\n## Solution\n\nChange the header name check to be case-insensitive:\n\n```java\nif (\"set-cookie\".equalsIgnoreCase(name)) {\n    responseBuilder.setCookies(allForName);\n    continue;\n}\n```","closed_by":{"login":"geoand","id":4374975,"node_id":"MDQ6VXNlcjQzNzQ5NzU=","avatar_url":"https://avatars.githubusercontent.com/u/4374975?v=4","gravatar_id":"","url":"https://api.github.com/users/geoand","html_url":"https://github.com/geoand","followers_url":"https://api.github.com/users/geoand/followers","following_url":"https://api.github.com/users/geoand/following{/other_user}","gists_url":"https://api.github.com/users/geoand/gists{/gist_id}","starred_url":"https://api.github.com/users/geoand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/geoand/subscriptions","organizations_url":"https://api.github.com/users/geoand/orgs","repos_url":"https://api.github.com/users/geoand/repos","events_url":"https://api.github.com/users/geoand/events{/privacy}","received_events_url":"https://api.github.com/users/geoand/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/quarkusio/quarkus/issues/50075/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/quarkusio/quarkus/issues/50075/timeline","performed_via_github_app":null,"state_reason":"completed"}