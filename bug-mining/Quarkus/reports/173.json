{"url":"https://api.github.com/repos/quarkusio/quarkus/issues/46197","repository_url":"https://api.github.com/repos/quarkusio/quarkus","labels_url":"https://api.github.com/repos/quarkusio/quarkus/issues/46197/labels{/name}","comments_url":"https://api.github.com/repos/quarkusio/quarkus/issues/46197/comments","events_url":"https://api.github.com/repos/quarkusio/quarkus/issues/46197/events","html_url":"https://github.com/quarkusio/quarkus/issues/46197","id":2845457949,"node_id":"I_kwDOCFbutM6pmj4d","number":46197,"title":"RuntimeException thrown instead of IllegalArgumentException when failing to decode URL","user":{"login":"luisRubiera","id":28353369,"node_id":"MDQ6VXNlcjI4MzUzMzY5","avatar_url":"https://avatars.githubusercontent.com/u/28353369?v=4","gravatar_id":"","url":"https://api.github.com/users/luisRubiera","html_url":"https://github.com/luisRubiera","followers_url":"https://api.github.com/users/luisRubiera/followers","following_url":"https://api.github.com/users/luisRubiera/following{/other_user}","gists_url":"https://api.github.com/users/luisRubiera/gists{/gist_id}","starred_url":"https://api.github.com/users/luisRubiera/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/luisRubiera/subscriptions","organizations_url":"https://api.github.com/users/luisRubiera/orgs","repos_url":"https://api.github.com/users/luisRubiera/repos","events_url":"https://api.github.com/users/luisRubiera/events{/privacy}","received_events_url":"https://api.github.com/users/luisRubiera/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":985346620,"node_id":"MDU6TGFiZWw5ODUzNDY2MjA=","url":"https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug","name":"kind/bug","color":"d73a4a","default":false,"description":"Something isn't working"},{"id":2552031458,"node_id":"MDU6TGFiZWwyNTUyMDMxNDU4","url":"https://api.github.com/repos/quarkusio/quarkus/labels/area/rest","name":"area/rest","color":"0366d6","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/quarkusio/quarkus/milestones/379","html_url":"https://github.com/quarkusio/quarkus/milestone/379","labels_url":"https://api.github.com/repos/quarkusio/quarkus/milestones/379/labels","id":12316625,"node_id":"MI_kwDOCFbutM4Au-_R","number":379,"title":"3.19.0","description":"","creator":{"login":"gsmet","id":1279749,"node_id":"MDQ6VXNlcjEyNzk3NDk=","avatar_url":"https://avatars.githubusercontent.com/u/1279749?v=4","gravatar_id":"","url":"https://api.github.com/users/gsmet","html_url":"https://github.com/gsmet","followers_url":"https://api.github.com/users/gsmet/followers","following_url":"https://api.github.com/users/gsmet/following{/other_user}","gists_url":"https://api.github.com/users/gsmet/gists{/gist_id}","starred_url":"https://api.github.com/users/gsmet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gsmet/subscriptions","organizations_url":"https://api.github.com/users/gsmet/orgs","repos_url":"https://api.github.com/users/gsmet/repos","events_url":"https://api.github.com/users/gsmet/events{/privacy}","received_events_url":"https://api.github.com/users/gsmet/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":31,"state":"closed","created_at":"2025-02-14T16:34:02Z","updated_at":"2025-05-08T09:31:41Z","due_on":null,"closed_at":"2025-02-19T13:08:41Z"},"comments":6,"created_at":"2025-02-11T13:51:04Z","updated_at":"2025-02-27T05:35:46Z","closed_at":"2025-02-13T16:27:32Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\n\nWhen making a request with an invalid parameter in the body—specifically, a non-decodable parameter—the exception thrown is a `RuntimeException`. However, according to the documentation [here](https://github.com/quarkusio/quarkus/blob/ebee0a4b66d1b4dba9c51165e78d22fbf3b90d3e/independent-projects/resteasy-reactive/common/runtime/src/main/java/org/jboss/resteasy/reactive/common/util/URLUtils.java#L78), the expected behavior is to throw an `IllegalArgumentException`.\n\n### Expected behavior\n\nAccording to the code in [URLUtils.decode](https://github.com/quarkusio/quarkus/blob/ebee0a4b66d1b4dba9c51165e78d22fbf3b90d3e/independent-projects/resteasy-reactive/common/runtime/src/main/java/org/jboss/resteasy/reactive/common/util/URLUtils.java#L78), an IllegalArgumentException should be thrown when decoding an invalid parameter.\n\n### Actual behavior\n\nWhen an invalid parameter is provided, the code calls [FailedToDecodeURL](https://github.com/quarkusio/quarkus/blob/ebee0a4b66d1b4dba9c51165e78d22fbf3b90d3e/independent-projects/resteasy-reactive/common/runtime/src/main/java/org/jboss/resteasy/reactive/common/util/URLUtils.java#L226), which throws a RuntimeException, leading to a `500 Internal Server Error` instead of a `400 Bad Request`.\n\n### How to Reproduce?\n\nShort Version:\nRun a Quarkus-based web server and send a request with a malformed, non-decodable parameter in the request body.\n\nLong Version (Reproducing with Keycloak):\n1. Run the following docker-compose file to start Keycloak (>= 23, as Keycloak migrated to Quarkus after this version):\n```\nversion: '3.6'\n\nservices:\n  keycloak_web:\n    image: quay.io/keycloak/keycloak:23.0\n    platform: linux/arm64\n    container_name: keycloak_web\n    environment:\n      KC_DB: postgres\n      KC_DB_URL: jdbc:postgresql://keycloakdb:5432/keycloak\n      KC_DB_USERNAME: keycloak\n      KC_DB_PASSWORD: password\n\n      KC_HOSTNAME: localhost\n      KC_HOSTNAME_PORT: 8080\n      KC_HOSTNAME_STRICT: false\n      KC_HOSTNAME_STRICT_HTTPS: false\n\n      KC_LOG_LEVEL: info\n      KC_METRICS_ENABLED: true\n      KC_HEALTH_ENABLED: true\n      KEYCLOAK_ADMIN: admin\n      KEYCLOAK_ADMIN_PASSWORD: admin\n    command: start-dev\n    depends_on:\n      - keycloakdb\n    ports:\n      - 8080:8080\n\n  keycloakdb:\n    image: postgres:15\n    volumes:\n      - postgres_data:/var/lib/postgresql/data\n    environment:\n      POSTGRES_DB: keycloak\n      POSTGRES_USER: keycloak\n      POSTGRES_PASSWORD: password\n\nvolumes:\n  postgres_data:\n```\n2. Execute the following curl command:\n```\ncurl -X POST \"http://localhost:8080/realms/master/protocol/openid-connect/token\" \\\n     -H \"Content-Type: application/x-www-form-urlencoded\" \\\n     -d \"anyparam=fake%XXuser\"\n```\n3. The response will trigger an error in the logs:\n```\nkeycloak_web  | 2025-02-11 13:26:22,334 ERROR [org.keycloak.services.error.KeycloakErrorHandler] (executor-thread-1) Uncaught server error: java.lang.RuntimeException: Failed to decode URL fake%XXuser to UTF-8\nkeycloak_web  |         at org.jboss.resteasy.reactive.common.util.URLUtils.failedToDecodeURL(URLUtils.java:227)\nkeycloak_web  |         at org.jboss.resteasy.reactive.common.util.URLUtils.decode(URLUtils.java:161)\nkeycloak_web  |         at org.jboss.resteasy.reactive.common.util.URLUtils.decode(URLUtils.java:87)\nkeycloak_web  |         at org.jboss.resteasy.reactive.server.core.multipart.FormEncodedDataDefinition$FormEncodedDataParser.decodeParameterValue(FormEncodedDataDefinition.java:208)\nkeycloak_web  |         at org.jboss.resteasy.reactive.server.core.multipart.FormEncodedDataDefinition$FormEncodedDataParser.inputDone(FormEncodedDataDefinition.java:264)\nkeycloak_web  |         at org.jboss.resteasy.reactive.server.core.multipart.FormEncodedDataDefinition$FormEncodedDataParser.parseBlocking(FormEncodedDataDefinition.java:239)\nkeycloak_web  |         at org.jboss.resteasy.reactive.server.handlers.FormBodyHandler.handle(FormBodyHandler.java:94)\nkeycloak_web  |         at io.quarkus.resteasy.reactive.server.runtime.QuarkusResteasyReactiveRequestContext.invokeHandler(QuarkusResteasyReactiveRequestContext.java:150)\nkeycloak_web  |         at org.jboss.resteasy.reactive.common.core.AbstractResteasyReactiveContext.run(AbstractResteasyReactiveContext.java:145)\nkeycloak_web  |         at io.quarkus.vertx.core.runtime.VertxCoreRecorder$14.runWith(VertxCoreRecorder.java:576)\nkeycloak_web  |         at org.jboss.threads.EnhancedQueueExecutor$Task.run(EnhancedQueueExecutor.java:2513)\nkeycloak_web  |         at org.jboss.threads.EnhancedQueueExecutor$ThreadBody.run(EnhancedQueueExecutor.java:1538)\nkeycloak_web  |         at org.jboss.threads.DelegatingRunnable.run(DelegatingRunnable.java:29)\nkeycloak_web  |         at org.jboss.threads.ThreadLocalResettingRunnable.run(ThreadLocalResettingRunnable.java:29)\nkeycloak_web  |         at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\nkeycloak_web  |         at java.base/java.lang.Thread.run(Thread.java:840)\n```\n\n\n### Output of `uname -a` or `ver`\n\nLinux fe9e37cde0ad 6.10.14-linuxkit #1 SMP Thu Oct 24 19:28:55 UTC 2024 aarch64 aarch64 aarch64 GNU/Linux\n\n### Output of `java -version`\n\nopenjdk version \"17.0.10\" 2024-01-16 LTS OpenJDK Runtime Environment (Red_Hat-17.0.10.0.7-1) (build 17.0.10+7-LTS) OpenJDK 64-Bit Server VM (Red_Hat-17.0.10.0.7-1) (build 17.0.10+7-LTS, mixed mode)\n\n### Quarkus version or git rev\n\ntested with 3.2.7.Final, also 3.8.5 and the code has not changed \n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\nbuilt with docker so not needed\n\n### Additional information\n\n- The issue arises because the failedToDecodeURL method throws a RuntimeException, which results in a 500 Internal Server Error.\n- Instead, it should throw an IllegalArgumentException, which would result in a 400 Bad Request.\n- Simply updating the documentation to match the RuntimeException behavior is not recommended, as it allows attackers to cause unnecessary 500 errors instead of being properly handled as bad input.\n\n## Why This Matters:\n\n- A RuntimeException (500 Internal Server Error) implies an issue with the backend, whereas an IllegalArgumentException (400 Bad Request) correctly indicates a client-side issue.\n- In cases of malformed input (like an attacker sending invalid encoded parameters), the server should not respond with a 500 but rather return a 400, signaling that the request is invalid.\n\n## Suggested Fix\nModify [URLUtils.failedToDecodeURL](https://github.com/quarkusio/quarkus/blob/ebee0a4b66d1b4dba9c51165e78d22fbf3b90d3e/independent-projects/resteasy-reactive/common/runtime/src/main/java/org/jboss/resteasy/reactive/common/util/URLUtils.java#L226) to throw an IllegalArgumentException instead of a RuntimeException.\n\n**Current Code:**\n```\n    private static RuntimeException failedToDecodeURL(String s, Charset enc, Throwable o) {\n        return new RuntimeException(\"Failed to decode URL \" + s + \" to \" + enc, o);\n    }\n```\n\n**Proposed Change:**\n```\n    private static IllegalArgumentException failedToDecodeURL(String s, Charset enc, Throwable o) {\n        return new IllegalArgumentException(\"Invalid encoding URL of \" + s + \" to \" + enc, o);\n    }\n```","closed_by":{"login":"gsmet","id":1279749,"node_id":"MDQ6VXNlcjEyNzk3NDk=","avatar_url":"https://avatars.githubusercontent.com/u/1279749?v=4","gravatar_id":"","url":"https://api.github.com/users/gsmet","html_url":"https://github.com/gsmet","followers_url":"https://api.github.com/users/gsmet/followers","following_url":"https://api.github.com/users/gsmet/following{/other_user}","gists_url":"https://api.github.com/users/gsmet/gists{/gist_id}","starred_url":"https://api.github.com/users/gsmet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gsmet/subscriptions","organizations_url":"https://api.github.com/users/gsmet/orgs","repos_url":"https://api.github.com/users/gsmet/repos","events_url":"https://api.github.com/users/gsmet/events{/privacy}","received_events_url":"https://api.github.com/users/gsmet/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/quarkusio/quarkus/issues/46197/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/quarkusio/quarkus/issues/46197/timeline","performed_via_github_app":null,"state_reason":"completed"}