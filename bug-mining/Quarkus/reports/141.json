{"url":"https://api.github.com/repos/quarkusio/quarkus/issues/44500","repository_url":"https://api.github.com/repos/quarkusio/quarkus","labels_url":"https://api.github.com/repos/quarkusio/quarkus/issues/44500/labels{/name}","comments_url":"https://api.github.com/repos/quarkusio/quarkus/issues/44500/comments","events_url":"https://api.github.com/repos/quarkusio/quarkus/issues/44500/events","html_url":"https://github.com/quarkusio/quarkus/issues/44500","id":2658315716,"node_id":"I_kwDOCFbutM6ecq3E","number":44500,"title":"Kafka serializer cannot be autodetected when injecting an Instance","user":{"login":"rokkolesa","id":6898398,"node_id":"MDQ6VXNlcjY4OTgzOTg=","avatar_url":"https://avatars.githubusercontent.com/u/6898398?v=4","gravatar_id":"","url":"https://api.github.com/users/rokkolesa","html_url":"https://github.com/rokkolesa","followers_url":"https://api.github.com/users/rokkolesa/followers","following_url":"https://api.github.com/users/rokkolesa/following{/other_user}","gists_url":"https://api.github.com/users/rokkolesa/gists{/gist_id}","starred_url":"https://api.github.com/users/rokkolesa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rokkolesa/subscriptions","organizations_url":"https://api.github.com/users/rokkolesa/orgs","repos_url":"https://api.github.com/users/rokkolesa/repos","events_url":"https://api.github.com/users/rokkolesa/events{/privacy}","received_events_url":"https://api.github.com/users/rokkolesa/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":985346622,"node_id":"MDU6TGFiZWw5ODUzNDY2MjI=","url":"https://api.github.com/repos/quarkusio/quarkus/labels/kind/enhancement","name":"kind/enhancement","color":"a2eeef","default":false,"description":"New feature or request"},{"id":1658790125,"node_id":"MDU6TGFiZWwxNjU4NzkwMTI1","url":"https://api.github.com/repos/quarkusio/quarkus/labels/area/kafka","name":"area/kafka","color":"0366d6","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/quarkusio/quarkus/milestones/363","html_url":"https://github.com/quarkusio/quarkus/milestone/363","labels_url":"https://api.github.com/repos/quarkusio/quarkus/milestones/363/labels","id":11920715,"node_id":"MI_kwDOCFbutM4AteVL","number":363,"title":"3.17.0","description":"","creator":{"login":"gsmet","id":1279749,"node_id":"MDQ6VXNlcjEyNzk3NDk=","avatar_url":"https://avatars.githubusercontent.com/u/1279749?v=4","gravatar_id":"","url":"https://api.github.com/users/gsmet","html_url":"https://github.com/gsmet","followers_url":"https://api.github.com/users/gsmet/followers","following_url":"https://api.github.com/users/gsmet/following{/other_user}","gists_url":"https://api.github.com/users/gsmet/gists{/gist_id}","starred_url":"https://api.github.com/users/gsmet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gsmet/subscriptions","organizations_url":"https://api.github.com/users/gsmet/orgs","repos_url":"https://api.github.com/users/gsmet/repos","events_url":"https://api.github.com/users/gsmet/events{/privacy}","received_events_url":"https://api.github.com/users/gsmet/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":31,"state":"closed","created_at":"2024-11-19T18:31:30Z","updated_at":"2024-11-20T12:44:43Z","due_on":null,"closed_at":"2024-11-20T12:44:43Z"},"comments":4,"created_at":"2024-11-14T10:13:04Z","updated_at":"2024-11-19T18:51:23Z","closed_at":"2024-11-15T15:22:00Z","author_association":"NONE","type":{"id":9864042,"node_id":"IT_kwDOAtbo_84AloNq","name":"Enhancement","description":"A request, idea, or new functionality","color":"blue","created_at":"2024-02-02T09:49:34Z","updated_at":"2024-07-26T12:36:36Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\n\nWhen injecting an `Emitter` or `MutinyEmitter` wrapped in `Instance`, the serializer is not autodetected and instead fails the application startup.\n\n### Expected behavior\n\nI expect that it should not matter if the emitter is injected directly or via `Instance` regarding the serializer autodetection.\n\n### Actual behavior\n\nThe application startup fails with the error:\n```\n Failed to start quarkus: io.quarkus.dev.appstate.ApplicationStartException: java.lang.RuntimeException: Failed to start quarkus\n        at io.quarkus.dev.appstate.ApplicationStateNotification.waitForApplicationStart(ApplicationStateNotification.java:63)\n        at io.quarkus.runner.bootstrap.StartupActionImpl.runMainClass(StartupActionImpl.java:142)\n        at io.quarkus.deployment.dev.IsolatedDevModeMain.restartApp(IsolatedDevModeMain.java:202)\n        at io.quarkus.deployment.dev.IsolatedDevModeMain.restartCallback(IsolatedDevModeMain.java:183)\n        at io.quarkus.deployment.dev.RuntimeUpdatesProcessor.doScan(RuntimeUpdatesProcessor.java:555)\n        at io.quarkus.deployment.console.ConsoleStateManager.forceRestart(ConsoleStateManager.java:175)\n        at io.quarkus.deployment.console.ConsoleStateManager.lambda$installBuiltins$0(ConsoleStateManager.java:112)\n        at io.quarkus.deployment.console.ConsoleStateManager$1.accept(ConsoleStateManager.java:77)\n        at io.quarkus.deployment.console.ConsoleStateManager$1.accept(ConsoleStateManager.java:49)\n        at io.quarkus.deployment.console.AeshConsole.lambda$setup$1(AeshConsole.java:278)\n        at org.aesh.terminal.EventDecoder.accept(EventDecoder.java:118)\n        at org.aesh.terminal.EventDecoder.accept(EventDecoder.java:31)\n        at org.aesh.terminal.io.Decoder.write(Decoder.java:133)\n        at org.aesh.readline.tty.terminal.TerminalConnection.openBlocking(TerminalConnection.java:216)\n        at org.aesh.readline.tty.terminal.TerminalConnection.openBlocking(TerminalConnection.java:203)\n        at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1144)\n        at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:642)\n        at java.base/java.lang.Thread.run(Thread.java:1583)\nCaused by: java.lang.RuntimeException: Failed to start quarkus\n        at io.quarkus.runner.ApplicationImpl.doStart(Unknown Source)\n        at io.quarkus.runtime.Application.start(Application.java:101)\n        at io.quarkus.runtime.ApplicationLifecycleManager.run(ApplicationLifecycleManager.java:121)\n        at io.quarkus.runtime.Quarkus.run(Quarkus.java:71)\n        at io.quarkus.runtime.Quarkus.run(Quarkus.java:44)\n        at io.quarkus.runtime.Quarkus.run(Quarkus.java:124)\n        at io.quarkus.runner.GeneratedMain.main(Unknown Source)\n        at java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(DirectMethodHandleAccessor.java:103)\n        at java.base/java.lang.reflect.Method.invoke(Method.java:580)\n        at io.quarkus.runner.bootstrap.StartupActionImpl$1.run(StartupActionImpl.java:116)\n        ... 1 more\nCaused by: jakarta.enterprise.inject.spi.DeploymentException: java.lang.IllegalArgumentException: The attribute `value.serializer` on connector 'smallrye-kafka' (channel: foo_out) must be set\n        at io.quarkus.smallrye.reactivemessaging.runtime.SmallRyeReactiveMessagingLifecycle.onApplicationStart(SmallRyeReactiveMessagingLifecycle.java:58)\n        at io.quarkus.smallrye.reactivemessaging.runtime.SmallRyeReactiveMessagingLifecycle_Observer_onApplicationStart_qTrMuLFyQ1IvGfeSxRVitl6CCBQ.notify(Unknown Source)\n        at io.quarkus.arc.impl.EventImpl$Notifier.notifyObservers(EventImpl.java:351)\n        at io.quarkus.arc.impl.EventImpl$Notifier.notify(EventImpl.java:333)\n        at io.quarkus.arc.impl.EventImpl.fire(EventImpl.java:80)\n        at io.quarkus.arc.runtime.ArcRecorder.fireLifecycleEvent(ArcRecorder.java:163)\n        at io.quarkus.arc.runtime.ArcRecorder.handleLifecycleEvents(ArcRecorder.java:114)\n        at io.quarkus.deployment.steps.LifecycleEventsBuildStep$startupEvent1144526294.deploy_0(Unknown Source)\n        at io.quarkus.deployment.steps.LifecycleEventsBuildStep$startupEvent1144526294.deploy(Unknown Source)\n        ... 11 more\nCaused by: java.lang.IllegalArgumentException: The attribute `value.serializer` on connector 'smallrye-kafka' (channel: foo_out) must be set\n        at io.smallrye.reactive.messaging.kafka.KafkaConnectorOutgoingConfiguration.lambda$getValueSerializer$0(KafkaConnectorOutgoingConfiguration.java:40)\n        at java.base/java.util.Optional.orElseThrow(Optional.java:403)\n        at io.smallrye.reactive.messaging.kafka.KafkaConnectorOutgoingConfiguration.getValueSerializer(KafkaConnectorOutgoingConfiguration.java:40)\n        at io.smallrye.reactive.messaging.kafka.KafkaConnectorOutgoingConfiguration.validate(KafkaConnectorOutgoingConfiguration.java:295)\n        at io.smallrye.reactive.messaging.kafka.KafkaConnectorOutgoingConfiguration.<init>(KafkaConnectorOutgoingConfiguration.java:16)\n        at io.smallrye.reactive.messaging.kafka.KafkaConnector.getSubscriber(KafkaConnector.java:272)\n        at io.smallrye.reactive.messaging.kafka.KafkaConnector_Subclass.getSubscriber$$superforward(Unknown Source)\n        at io.smallrye.reactive.messaging.kafka.KafkaConnector_Subclass$$function$$10.apply(Unknown Source)\n        at io.quarkus.arc.impl.AroundInvokeInvocationContext.proceed(AroundInvokeInvocationContext.java:73)\n        at io.quarkus.arc.impl.AroundInvokeInvocationContext$NextAroundInvokeInvocationContext.proceed(AroundInvokeInvocationContext.java:97)\n        at io.quarkus.smallrye.reactivemessaging.runtime.devmode.DevModeSupportConnectorFactoryInterceptor.intercept(DevModeSupportConnectorFactoryInterceptor.java:97)\n        at io.quarkus.smallrye.reactivemessaging.runtime.devmode.DevModeSupportConnectorFactoryInterceptor_Bean.intercept(Unknown Source)\n        at io.quarkus.arc.impl.InterceptorInvocation.invoke(InterceptorInvocation.java:42)\n        at io.quarkus.arc.impl.AroundInvokeInvocationContext.proceed(AroundInvokeInvocationContext.java:70)\n        at io.quarkus.arc.impl.AroundInvokeInvocationContext.proceed(AroundInvokeInvocationContext.java:62)\n        at io.quarkus.smallrye.reactivemessaging.runtime.DuplicatedContextConnectorFactoryInterceptor.intercept(DuplicatedContextConnectorFactoryInterceptor.java:37)\n        at io.quarkus.smallrye.reactivemessaging.runtime.DuplicatedContextConnectorFactoryInterceptor_Bean.intercept(Unknown Source)\n        at io.quarkus.arc.impl.InterceptorInvocation.invoke(InterceptorInvocation.java:42)\n        at io.quarkus.arc.impl.AroundInvokeInvocationContext.perform(AroundInvokeInvocationContext.java:30)\n        at io.quarkus.arc.impl.InvocationContexts.performAroundInvoke(InvocationContexts.java:27)\n        at io.smallrye.reactive.messaging.kafka.KafkaConnector_Subclass.getSubscriber(Unknown Source)\n        at io.smallrye.reactive.messaging.kafka.KafkaConnector_ClientProxy.getSubscriber(Unknown Source)\n        at io.smallrye.reactive.messaging.providers.impl.ConfiguredChannelFactory.createSubscriber(ConfiguredChannelFactory.java:226)\n        at io.smallrye.reactive.messaging.providers.impl.ConfiguredChannelFactory.register(ConfiguredChannelFactory.java:167)\n        at io.smallrye.reactive.messaging.providers.impl.ConfiguredChannelFactory.initialize(ConfiguredChannelFactory.java:115)\n        at io.smallrye.reactive.messaging.providers.impl.ConfiguredChannelFactory_ClientProxy.initialize(Unknown Source)\n        at java.base/java.util.Iterator.forEachRemaining(Iterator.java:133)\n        at java.base/java.util.Spliterators$IteratorSpliterator.forEachRemaining(Spliterators.java:1939)\n        at java.base/java.util.stream.ReferencePipeline$Head.forEach(ReferencePipeline.java:762)\n        at io.smallrye.reactive.messaging.providers.extension.MediatorManager.start(MediatorManager.java:250)\n        at io.smallrye.reactive.messaging.providers.extension.MediatorManager_ClientProxy.start(Unknown Source)\n        at io.quarkus.smallrye.reactivemessaging.runtime.SmallRyeReactiveMessagingLifecycle.onApplicationStart(SmallRyeReactiveMessagingLifecycle.java:53)\n        ... 19 more\n\n```\n\nIf i instead inject the emitter directly, the error is not thrown and the emitter works correctly.\n\n### How to Reproduce?\n\nUsing the below snippet causes an exception at startup, even if the bean is not used.\n\n```java\nimport jakarta.enterprise.context.ApplicationScoped;\nimport jakarta.enterprise.inject.Instance;\n\nimport org.eclipse.microprofile.reactive.messaging.Channel;\n\nimport io.smallrye.reactive.messaging.MutinyEmitter;\n\n@ApplicationScoped\npublic class Foo\n{\n    @Channel(\"foo_out\")\n    Instance<MutinyEmitter<String>> emitter;\n\n    public void emit()\n    {\n        emitter.get().sendAndAwait(\"bar\");\n    }\n}\n```\n\n### Output of `uname -a` or `ver`\n\n_No response_\n\n### Output of `java -version`\n\nopenjdk version \"21.0.5\" 2024-10-15 OpenJDK Runtime Environment Homebrew (build 21.0.5) OpenJDK 64-Bit Server VM Homebrew (build 21.0.5, mixed mode, sharing)\n\n### Quarkus version or git rev\n\n3.16.3\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\nApache Maven 3.9.9\n\n### Additional information\n\nI can work around this issue by specifying `mp.messaging.outgoing.foo_out.value.serializer=io.quarkus.kafka.client.serialization.ObjectMapperSerializer` in `application.properties`.","closed_by":{"login":"ozangunalp","id":294765,"node_id":"MDQ6VXNlcjI5NDc2NQ==","avatar_url":"https://avatars.githubusercontent.com/u/294765?v=4","gravatar_id":"","url":"https://api.github.com/users/ozangunalp","html_url":"https://github.com/ozangunalp","followers_url":"https://api.github.com/users/ozangunalp/followers","following_url":"https://api.github.com/users/ozangunalp/following{/other_user}","gists_url":"https://api.github.com/users/ozangunalp/gists{/gist_id}","starred_url":"https://api.github.com/users/ozangunalp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ozangunalp/subscriptions","organizations_url":"https://api.github.com/users/ozangunalp/orgs","repos_url":"https://api.github.com/users/ozangunalp/repos","events_url":"https://api.github.com/users/ozangunalp/events{/privacy}","received_events_url":"https://api.github.com/users/ozangunalp/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/quarkusio/quarkus/issues/44500/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/quarkusio/quarkus/issues/44500/timeline","performed_via_github_app":null,"state_reason":"completed"}