{"url":"https://api.github.com/repos/quarkusio/quarkus/issues/43107","repository_url":"https://api.github.com/repos/quarkusio/quarkus","labels_url":"https://api.github.com/repos/quarkusio/quarkus/issues/43107/labels{/name}","comments_url":"https://api.github.com/repos/quarkusio/quarkus/issues/43107/comments","events_url":"https://api.github.com/repos/quarkusio/quarkus/issues/43107/events","html_url":"https://github.com/quarkusio/quarkus/issues/43107","id":2511607953,"node_id":"I_kwDOCFbutM6VtBiR","number":43107,"title":"TLS registry named config and Quarkus Messaging Kafka or Kafka Client can lead to failed application startup","user":{"login":"michalvavrik","id":43821672,"node_id":"MDQ6VXNlcjQzODIxNjcy","avatar_url":"https://avatars.githubusercontent.com/u/43821672?v=4","gravatar_id":"","url":"https://api.github.com/users/michalvavrik","html_url":"https://github.com/michalvavrik","followers_url":"https://api.github.com/users/michalvavrik/followers","following_url":"https://api.github.com/users/michalvavrik/following{/other_user}","gists_url":"https://api.github.com/users/michalvavrik/gists{/gist_id}","starred_url":"https://api.github.com/users/michalvavrik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/michalvavrik/subscriptions","organizations_url":"https://api.github.com/users/michalvavrik/orgs","repos_url":"https://api.github.com/users/michalvavrik/repos","events_url":"https://api.github.com/users/michalvavrik/events{/privacy}","received_events_url":"https://api.github.com/users/michalvavrik/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":985346620,"node_id":"MDU6TGFiZWw5ODUzNDY2MjA=","url":"https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug","name":"kind/bug","color":"d73a4a","default":false,"description":"Something isn't working"},{"id":1449536431,"node_id":"MDU6TGFiZWwxNDQ5NTM2NDMx","url":"https://api.github.com/repos/quarkusio/quarkus/labels/area/kafka-streams","name":"area/kafka-streams","color":"0366d6","default":false,"description":""},{"id":1658790125,"node_id":"MDU6TGFiZWwxNjU4NzkwMTI1","url":"https://api.github.com/repos/quarkusio/quarkus/labels/area/kafka","name":"area/kafka","color":"0366d6","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"cescoffier","id":402301,"node_id":"MDQ6VXNlcjQwMjMwMQ==","avatar_url":"https://avatars.githubusercontent.com/u/402301?v=4","gravatar_id":"","url":"https://api.github.com/users/cescoffier","html_url":"https://github.com/cescoffier","followers_url":"https://api.github.com/users/cescoffier/followers","following_url":"https://api.github.com/users/cescoffier/following{/other_user}","gists_url":"https://api.github.com/users/cescoffier/gists{/gist_id}","starred_url":"https://api.github.com/users/cescoffier/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cescoffier/subscriptions","organizations_url":"https://api.github.com/users/cescoffier/orgs","repos_url":"https://api.github.com/users/cescoffier/repos","events_url":"https://api.github.com/users/cescoffier/events{/privacy}","received_events_url":"https://api.github.com/users/cescoffier/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"cescoffier","id":402301,"node_id":"MDQ6VXNlcjQwMjMwMQ==","avatar_url":"https://avatars.githubusercontent.com/u/402301?v=4","gravatar_id":"","url":"https://api.github.com/users/cescoffier","html_url":"https://github.com/cescoffier","followers_url":"https://api.github.com/users/cescoffier/followers","following_url":"https://api.github.com/users/cescoffier/following{/other_user}","gists_url":"https://api.github.com/users/cescoffier/gists{/gist_id}","starred_url":"https://api.github.com/users/cescoffier/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cescoffier/subscriptions","organizations_url":"https://api.github.com/users/cescoffier/orgs","repos_url":"https://api.github.com/users/cescoffier/repos","events_url":"https://api.github.com/users/cescoffier/events{/privacy}","received_events_url":"https://api.github.com/users/cescoffier/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/quarkusio/quarkus/milestones/350","html_url":"https://github.com/quarkusio/quarkus/milestone/350","labels_url":"https://api.github.com/repos/quarkusio/quarkus/milestones/350/labels","id":11549367,"node_id":"MI_kwDOCFbutM4AsDq3","number":350,"title":"3.14.3","description":"","creator":{"login":"gsmet","id":1279749,"node_id":"MDQ6VXNlcjEyNzk3NDk=","avatar_url":"https://avatars.githubusercontent.com/u/1279749?v=4","gravatar_id":"","url":"https://api.github.com/users/gsmet","html_url":"https://github.com/gsmet","followers_url":"https://api.github.com/users/gsmet/followers","following_url":"https://api.github.com/users/gsmet/following{/other_user}","gists_url":"https://api.github.com/users/gsmet/gists{/gist_id}","starred_url":"https://api.github.com/users/gsmet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gsmet/subscriptions","organizations_url":"https://api.github.com/users/gsmet/orgs","repos_url":"https://api.github.com/users/gsmet/repos","events_url":"https://api.github.com/users/gsmet/events{/privacy}","received_events_url":"https://api.github.com/users/gsmet/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":69,"state":"closed","created_at":"2024-09-06T16:01:17Z","updated_at":"2024-09-11T11:24:07Z","due_on":null,"closed_at":"2024-09-11T11:24:07Z"},"comments":18,"created_at":"2024-09-07T11:37:50Z","updated_at":"2025-03-26T15:49:19Z","closed_at":"2024-09-09T12:43:59Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\r\n\r\nI have app using Quarkus Messaging Kafka, TLS registry and (one of the ways to reproduce it also uses Kafka streams other uses Kafka Client). Most of the time application fails to start.\r\n\r\n### Expected behavior\r\n\r\nApplication starts.\r\n\r\n### Actual behavior\r\n\r\nStartup fails and following exception is logged:\r\n\r\n```\r\n2024-09-07 13:21:05,927 ERROR [io.qua.run.Application] (Quarkus Main Thread) Failed to start application: java.lang.RuntimeException: Failed to start quarkus\r\n\tat io.quarkus.runner.ApplicationImpl.doStart(Unknown Source)\r\n\tat io.quarkus.runtime.Application.start(Application.java:101)\r\n\tat io.quarkus.runtime.ApplicationLifecycleManager.run(ApplicationLifecycleManager.java:119)\r\n\tat io.quarkus.runtime.Quarkus.run(Quarkus.java:71)\r\n\tat io.quarkus.runtime.Quarkus.run(Quarkus.java:44)\r\n\tat io.quarkus.runtime.Quarkus.run(Quarkus.java:124)\r\n\tat io.quarkus.runner.GeneratedMain.main(Unknown Source)\r\n\tat java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(DirectMethodHandleAccessor.java:103)\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:580)\r\n\tat io.quarkus.runner.bootstrap.StartupActionImpl$1.run(StartupActionImpl.java:116)\r\n\tat java.base/java.lang.Thread.run(Thread.java:1583)\r\nCaused by: org.apache.kafka.common.KafkaException: Failed to create new KafkaAdminClient\r\n\tat org.apache.kafka.clients.admin.KafkaAdminClient.createInternal(KafkaAdminClient.java:541)\r\n\tat org.apache.kafka.clients.admin.KafkaAdminClient.createInternal(KafkaAdminClient.java:492)\r\n\tat org.apache.kafka.clients.admin.Admin.create(Admin.java:137)\r\n\tat io.quarkus.kafka.streams.runtime.KafkaStreamsProducer.<init>(KafkaStreamsProducer.java:107)\r\n\tat io.quarkus.kafka.streams.runtime.KafkaStreamsProducer_Bean.doCreate(Unknown Source)\r\n\tat io.quarkus.kafka.streams.runtime.KafkaStreamsProducer_Bean.create(Unknown Source)\r\n\tat io.quarkus.kafka.streams.runtime.KafkaStreamsProducer_Bean.create(Unknown Source)\r\n\tat io.quarkus.arc.impl.AbstractSharedContext.createInstanceHandle(AbstractSharedContext.java:119)\r\n\tat io.quarkus.arc.impl.AbstractSharedContext$1.get(AbstractSharedContext.java:38)\r\n\tat io.quarkus.arc.impl.AbstractSharedContext$1.get(AbstractSharedContext.java:35)\r\n\tat io.quarkus.arc.impl.LazyValue.get(LazyValue.java:32)\r\n\tat io.quarkus.arc.impl.ComputingCache.computeIfAbsent(ComputingCache.java:69)\r\n\tat io.quarkus.arc.impl.ComputingCacheContextInstances.computeIfAbsent(ComputingCacheContextInstances.java:19)\r\n\tat io.quarkus.arc.impl.AbstractSharedContext.get(AbstractSharedContext.java:35)\r\n\tat io.quarkus.kafka.streams.runtime.KafkaStreamsProducer_Observer_onStartup_eonSDFgmJKlmEvopYKyyKONG1pI.notify(Unknown Source)\r\n\tat io.quarkus.arc.impl.EventImpl$Notifier.notifyObservers(EventImpl.java:351)\r\n\tat io.quarkus.arc.impl.EventImpl$Notifier.notify(EventImpl.java:333)\r\n\tat io.quarkus.arc.impl.EventImpl.fire(EventImpl.java:80)\r\n\tat io.quarkus.arc.runtime.ArcRecorder.fireLifecycleEvent(ArcRecorder.java:156)\r\n\tat io.quarkus.arc.runtime.ArcRecorder.handleLifecycleEvents(ArcRecorder.java:107)\r\n\tat io.quarkus.deployment.steps.LifecycleEventsBuildStep$startupEvent1144526294.deploy_0(Unknown Source)\r\n\tat io.quarkus.deployment.steps.LifecycleEventsBuildStep$startupEvent1144526294.deploy(Unknown Source)\r\n\t... 11 more\r\nCaused by: org.apache.kafka.common.KafkaException: Failed to create new NetworkClient\r\n\tat org.apache.kafka.clients.ClientUtils.createNetworkClient(ClientUtils.java:252)\r\n\tat org.apache.kafka.clients.ClientUtils.createNetworkClient(ClientUtils.java:189)\r\n\tat org.apache.kafka.clients.admin.KafkaAdminClient.createInternal(KafkaAdminClient.java:525)\r\n\t... 32 more\r\nCaused by: org.apache.kafka.common.KafkaException: java.lang.NullPointerException: Cannot invoke \"Object.hashCode()\" because \"key\" is null\r\n\tat org.apache.kafka.common.network.SaslChannelBuilder.configure(SaslChannelBuilder.java:184)\r\n\tat org.apache.kafka.common.network.ChannelBuilders.create(ChannelBuilders.java:192)\r\n\tat org.apache.kafka.common.network.ChannelBuilders.clientChannelBuilder(ChannelBuilders.java:81)\r\n\tat org.apache.kafka.clients.ClientUtils.createChannelBuilder(ClientUtils.java:119)\r\n\tat org.apache.kafka.clients.ClientUtils.createNetworkClient(ClientUtils.java:223)\r\n\t... 34 more\r\nCaused by: java.lang.NullPointerException: Cannot invoke \"Object.hashCode()\" because \"key\" is null\r\n\tat java.base/java.util.concurrent.ConcurrentHashMap.get(ConcurrentHashMap.java:936)\r\n\tat io.quarkus.tls.runtime.CertificateRecorder.get(CertificateRecorder.java:134)\r\n\tat io.quarkus.kafka.client.tls.QuarkusKafkaSslEngineFactory.configure(QuarkusKafkaSslEngineFactory.java:101)\r\n\tat org.apache.kafka.common.security.ssl.SslFactory.instantiateSslEngineFactory(SslFactory.java:141)\r\n\tat org.apache.kafka.common.security.ssl.SslFactory.configure(SslFactory.java:98)\r\n\tat org.apache.kafka.common.network.SaslChannelBuilder.configure(SaslChannelBuilder.java:180)\r\n\t... 38 more\r\n```\r\n\r\nAnd in case of KafkaAdminClient the stacktrace is:\r\n\r\n```\r\n16:42:45,524 INFO  [app] 16:42:43,577 Failed to start application: java.lang.RuntimeException: Failed to start quarkus\r\n16:42:45,524 INFO  [app] \tat io.quarkus.runner.ApplicationImpl.doStart(Unknown Source)\r\n16:42:45,524 INFO  [app] \tat io.quarkus.runtime.Application.start(Application.java:101)\r\n16:42:45,524 INFO  [app] \tat io.quarkus.runtime.ApplicationLifecycleManager.run(ApplicationLifecycleManager.java:119)\r\n16:42:45,524 INFO  [app] \tat io.quarkus.runtime.Quarkus.run(Quarkus.java:71)\r\n16:42:45,524 INFO  [app] \tat io.quarkus.runtime.Quarkus.run(Quarkus.java:44)\r\n16:42:45,524 INFO  [app] \tat io.quarkus.runtime.Quarkus.run(Quarkus.java:124)\r\n16:42:45,524 INFO  [app] \tat io.quarkus.runner.GeneratedMain.main(Unknown Source)\r\n16:42:45,524 INFO  [app] \tat java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(DirectMethodHandleAccessor.java:103)\r\n16:42:45,525 INFO  [app] \tat java.base/java.lang.reflect.Method.invoke(Method.java:580)\r\n16:42:45,525 INFO  [app] \tat io.quarkus.bootstrap.runner.QuarkusEntryPoint.doRun(QuarkusEntryPoint.java:62)\r\n16:42:45,525 INFO  [app] \tat io.quarkus.bootstrap.runner.QuarkusEntryPoint.main(QuarkusEntryPoint.java:33)\r\n16:42:45,525 INFO  [app] Caused by: org.apache.kafka.common.KafkaException: Failed to construct kafka consumer\r\n16:42:45,525 INFO  [app] \tat org.apache.kafka.clients.consumer.internals.LegacyKafkaConsumer.<init>(LegacyKafkaConsumer.java:264)\r\n16:42:45,525 INFO  [app] \tat org.apache.kafka.clients.consumer.internals.ConsumerDelegateCreator.create(ConsumerDelegateCreator.java:65)\r\n16:42:45,525 INFO  [app] \tat org.apache.kafka.clients.consumer.KafkaConsumer.<init>(KafkaConsumer.java:600)\r\n16:42:45,525 INFO  [app] \tat org.apache.kafka.clients.consumer.KafkaConsumer.<init>(KafkaConsumer.java:595)\r\n16:42:45,525 INFO  [app] \tat org.apache.kafka.clients.consumer.KafkaConsumer.<init>(KafkaConsumer.java:576)\r\n16:42:45,525 INFO  [app] \tat org.apache.kafka.clients.consumer.KafkaConsumer.<init>(KafkaConsumer.java:556)\r\n16:42:45,525 INFO  [app] \tat io.quarkus.qe.messaging.ssl.providers.SslKafkaProvider.getSslConsumer(SslKafkaProvider.java:53)\r\n16:42:45,525 INFO  [app] \tat io.quarkus.qe.messaging.ssl.providers.SslKafkaProvider_ProducerMethod_getSslConsumer_NFS8yLBckt8VZAzW5baLLACHtyY_Bean.doCreate(Unknown Source)\r\n16:42:45,525 INFO  [app] \tat io.quarkus.qe.messaging.ssl.providers.SslKafkaProvider_ProducerMethod_getSslConsumer_NFS8yLBckt8VZAzW5baLLACHtyY_Bean.create(Unknown Source)\r\n16:42:45,525 INFO  [app] \tat io.quarkus.qe.messaging.ssl.providers.SslKafkaProvider_ProducerMethod_getSslConsumer_NFS8yLBckt8VZAzW5baLLACHtyY_Bean.create(Unknown Source)\r\n16:42:45,525 INFO  [app] \tat io.quarkus.arc.impl.AbstractSharedContext.createInstanceHandle(AbstractSharedContext.java:119)\r\n16:42:45,525 INFO  [app] \tat io.quarkus.arc.impl.AbstractSharedContext$1.get(AbstractSharedContext.java:38)\r\n16:42:45,526 INFO  [app] \tat io.quarkus.arc.impl.AbstractSharedContext$1.get(AbstractSharedContext.java:35)\r\n16:42:45,526 INFO  [app] \tat io.quarkus.arc.impl.LazyValue.get(LazyValue.java:32)\r\n16:42:45,526 INFO  [app] \tat io.quarkus.arc.impl.ComputingCache.computeIfAbsent(ComputingCache.java:69)\r\n16:42:45,526 INFO  [app] \tat io.quarkus.arc.impl.ComputingCacheContextInstances.computeIfAbsent(ComputingCacheContextInstances.java:19)\r\n16:42:45,526 INFO  [app] \tat io.quarkus.arc.impl.AbstractSharedContext.get(AbstractSharedContext.java:35)\r\n16:42:45,526 INFO  [app] \tat io.quarkus.qe.messaging.ssl.providers.SslKafkaProvider_ProducerMethod_getSslConsumer_NFS8yLBckt8VZAzW5baLLACHtyY_Bean.get(Unknown Source)\r\n16:42:45,526 INFO  [app] \tat io.quarkus.qe.messaging.ssl.providers.SslKafkaProvider_ProducerMethod_getSslConsumer_NFS8yLBckt8VZAzW5baLLACHtyY_Bean.get(Unknown Source)\r\n16:42:45,526 INFO  [app] \tat io.quarkus.arc.impl.InstanceImpl.getBeanInstance(InstanceImpl.java:325)\r\n16:42:45,526 INFO  [app] \tat io.quarkus.arc.impl.InstanceImpl.getInternal(InstanceImpl.java:309)\r\n16:42:45,526 INFO  [app] \tat io.quarkus.arc.impl.InstanceImpl.get(InstanceImpl.java:190)\r\n16:42:45,526 INFO  [app] \tat io.quarkus.qe.messaging.ssl.quickstart.SslKafkaEndpoint.initialize(SslKafkaEndpoint.java:46)\r\n16:42:45,526 INFO  [app] \tat io.quarkus.qe.messaging.ssl.quickstart.SslKafkaEndpoint_Observer_initialize_fXpzbA0Aag2X1uiiwypy52BybQ4.notify(Unknown Source)\r\n16:42:45,526 INFO  [app] \tat io.quarkus.arc.impl.EventImpl$Notifier.notifyObservers(EventImpl.java:351)\r\n16:42:45,526 INFO  [app] \tat io.quarkus.arc.impl.EventImpl$Notifier.notify(EventImpl.java:333)\r\n16:42:45,526 INFO  [app] \tat io.quarkus.arc.impl.EventImpl.fire(EventImpl.java:80)\r\n16:42:45,527 INFO  [app] \tat io.quarkus.arc.runtime.ArcRecorder.fireLifecycleEvent(ArcRecorder.java:156)\r\n16:42:45,527 INFO  [app] \tat io.quarkus.arc.runtime.ArcRecorder.handleLifecycleEvents(ArcRecorder.java:107)\r\n16:42:45,527 INFO  [app] \tat io.quarkus.deployment.steps.LifecycleEventsBuildStep$startupEvent1144526294.deploy_0(Unknown Source)\r\n16:42:45,527 INFO  [app] \tat io.quarkus.deployment.steps.LifecycleEventsBuildStep$startupEvent1144526294.deploy(Unknown Source)\r\n16:42:45,527 INFO  [app] \t... 11 more\r\n16:42:45,527 INFO  [app] Caused by: org.apache.kafka.common.KafkaException: Failed to create new NetworkClient\r\n16:42:45,527 INFO  [app] \tat org.apache.kafka.clients.ClientUtils.createNetworkClient(ClientUtils.java:252)\r\n16:42:45,527 INFO  [app] \tat org.apache.kafka.clients.ClientUtils.createNetworkClient(ClientUtils.java:162)\r\n16:42:45,527 INFO  [app] \tat org.apache.kafka.clients.consumer.internals.ConsumerUtils.createConsumerNetworkClient(ConsumerUtils.java:86)\r\n16:42:45,527 INFO  [app] \tat org.apache.kafka.clients.consumer.internals.LegacyKafkaConsumer.<init>(LegacyKafkaConsumer.java:191)\r\n16:42:45,527 INFO  [app] \t... 41 more\r\n16:42:45,527 INFO  [app] Caused by: org.apache.kafka.common.KafkaException: java.lang.NullPointerException: Cannot invoke \"Object.hashCode()\" because \"key\" is null\r\n16:42:45,527 INFO  [app] \tat org.apache.kafka.common.network.SslChannelBuilder.configure(SslChannelBuilder.java:77)\r\n16:42:45,528 INFO  [app] \tat org.apache.kafka.common.network.ChannelBuilders.create(ChannelBuilders.java:192)\r\n16:42:45,528 INFO  [app] \tat org.apache.kafka.common.network.ChannelBuilders.clientChannelBuilder(ChannelBuilders.java:81)\r\n16:42:45,528 INFO  [app] \tat org.apache.kafka.clients.ClientUtils.createChannelBuilder(ClientUtils.java:119)\r\n16:42:45,528 INFO  [app] \tat org.apache.kafka.clients.ClientUtils.createNetworkClient(ClientUtils.java:223)\r\n16:42:45,528 INFO  [app] \t... 44 more\r\n16:42:45,528 INFO  [app] Caused by: java.lang.NullPointerException: Cannot invoke \"Object.hashCode()\" because \"key\" is null\r\n16:42:45,528 INFO  [app] \tat java.base/java.util.concurrent.ConcurrentHashMap.get(ConcurrentHashMap.java:936)\r\n16:42:45,528 INFO  [app] \tat io.quarkus.tls.runtime.CertificateRecorder.get(CertificateRecorder.java:134)\r\n16:42:45,528 INFO  [app] \tat io.quarkus.kafka.client.tls.QuarkusKafkaSslEngineFactory.configure(QuarkusKafkaSslEngineFactory.java:101)\r\n16:42:45,528 INFO  [app] \tat org.apache.kafka.common.security.ssl.SslFactory.instantiateSslEngineFactory(SslFactory.java:141)\r\n16:42:45,528 INFO  [app] \tat org.apache.kafka.common.security.ssl.SslFactory.configure(SslFactory.java:98)\r\n16:42:45,528 INFO  [app] \tat org.apache.kafka.common.network.SslChannelBuilder.configure(SslChannelBuilder.java:73)\r\n16:42:45,529 INFO  [app] \t... 48 more\r\n```\r\n\r\n### How to Reproduce?\r\n\r\nI have 3 reproducers, in the first one, application fails to start always. In the second one (DEV mode) I experience it most of the time, but not always. You need to retry. However the first reproducer is build and started by QE FW and it might be less convenient for debugging. The third one follows Admin client docs.\r\n\r\n**First reproducer** (JVM mode):\r\n```\r\ngit clone git@github.com:michalvavrik/quarkus-test-suite.git -b feature/tls-registry-kafka\r\ncd quarkus-test-suite/messaging/kafka-streams-reactive-messaging\r\nmvn clean verify -Dit.test=SaslSslAlertMonitorIT\r\n```\r\n\r\n**Second reproducer** (DEV mode) (please note that `Topology` is not good, I know but it fails before it's validated anyway):\r\n```\r\nquarkus create app --extensions=messaging-kafka,kafka-streams,resteasy-jsonb,tls-registry\r\n\r\ncd code-with-quarkus/\r\nquarkus tls generate-certificate -n clement -p top-secret\r\n\r\n# important: now update quarkus.tls.sasl-monitor.trust-store.p12.path with console output, e.g. Trust Store File: /tmp/code-with-quarkus/.certs/clement-truststore.p12 so take the truststore path\r\n\r\ncat <<EOF >> ./src/main/resources/application.properties\r\nquarkus.kafka-streams.topics=words\r\nkafka.tls-configuration-name=sasl-monitor\r\nquarkus.tls.sasl-monitor.trust-store.p12.password=top-secret\r\nquarkus.tls.sasl-monitor.trust-store.p12.path=/tmp/strimzi-server-ssl-certs10979500127798639243/strimzi-server-ssl-truststore.p12\r\nkafka.ssl.enable=true\r\nssl.endpoint.identification.algorithm=https\r\nkafka.sasl.mechanism=SCRAM-SHA-512\r\nkafka.security.protocol=SASL_SSL\r\nkafka.sasl.jaas.config=org.apache.kafka.common.security.scram.ScramLoginModule required username=\"client\" password=\"client-secret12345678912345678912\";\r\nEOF\r\n\r\ncat <<EOF > ./src/main/java/org/acme/TopologyProducer.java\r\npackage org.acme;\r\n\r\nimport jakarta.enterprise.context.ApplicationScoped;\r\nimport jakarta.enterprise.inject.Produces;\r\n\r\nimport org.apache.kafka.common.serialization.Serdes;\r\nimport org.apache.kafka.streams.StreamsBuilder;\r\nimport org.apache.kafka.streams.Topology;\r\nimport org.apache.kafka.streams.kstream.Consumed;\r\nimport org.apache.kafka.streams.kstream.GlobalKTable;\r\nimport org.apache.kafka.streams.kstream.Materialized;\r\nimport org.apache.kafka.streams.state.KeyValueBytesStoreSupplier;\r\nimport org.apache.kafka.streams.state.Stores;\r\n\r\nimport io.quarkus.kafka.client.serialization.ObjectMapperSerde;\r\n\r\n@ApplicationScoped\r\npublic class TopologyProducer {\r\n\r\n    static final String WEATHER_STATIONS_STORE = \"weather-stations-store\";\r\n\r\n    private static final String WEATHER_STATIONS_TOPIC = \"weather-stations\";\r\n    private static final String TEMPERATURE_VALUES_TOPIC = \"temperature-values\";\r\n    private static final String TEMPERATURES_AGGREGATED_TOPIC = \"temperatures-aggregated\";\r\n\r\n    @Produces\r\n    public Topology buildTopology() {\r\n        StreamsBuilder builder = new StreamsBuilder();\r\n\r\n        ObjectMapperSerde<String> weatherStationSerde = new ObjectMapperSerde<>(\r\n                String.class);\r\n        ObjectMapperSerde<String> aggregationSerde = new ObjectMapperSerde<>(String.class);\r\n\r\n        KeyValueBytesStoreSupplier storeSupplier = Stores.persistentKeyValueStore(\r\n                WEATHER_STATIONS_STORE);\r\n\r\n        GlobalKTable<String, String> stations = builder.globalTable(\r\n                WEATHER_STATIONS_TOPIC,\r\n                Consumed.with(Serdes.String(), weatherStationSerde));\r\n\r\n        builder.stream(\r\n                        TEMPERATURE_VALUES_TOPIC,\r\n                        Consumed.with(Serdes.String(), Serdes.String())\r\n                )\r\n                .join(                                                        // <3>\r\n                        stations,\r\n                        (stationId, timestampAndValue) -> stationId,\r\n                        (timestampAndValue, station) -> new String(station)\r\n                )\r\n                .groupByKey()                                                 // <4>\r\n                .aggregate(                                                   // <5>\r\n                        String::new,\r\n                        (stationId, value, aggregation) -> aggregation,\r\n                        Materialized.<String, String> as(storeSupplier)\r\n                                .withKeySerde(Serdes.String())\r\n                                .withValueSerde(aggregationSerde)\r\n                )\r\n                .toStream()\r\n                .to(\r\n                        TEMPERATURES_AGGREGATED_TOPIC\r\n                );\r\n\r\n        return builder.build();\r\n    }\r\n}\r\nEOF\r\n\r\nquarkus dev\r\n```\r\n**Third reproducer** - this one uses Kafka Client and Quarkus Messaging Kafka\r\n\r\nWhat is does is that it implements Kafka reference example here https://quarkus.io/guides/kafka#kafka-bare-clients and it creates `KafkaAdminClient` like with properties:\r\n\r\n```\r\n@Inject\r\n    @Identifier(\"default-kafka-broker\")\r\n    Map<String, Object> config;\r\n```\r\n\r\n```\r\ngit clone git@github.com:michalvavrik/quarkus-test-suite.git -b feature/kafka-tls-registry\r\ncd quarkus-test-suite/messaging/kafkaSSL\r\nmvn clean verify -Dit.test=KafkaSslWithTlsRegistryIT\r\n```\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\nFedora 40\r\n\r\n### Output of `java -version`\r\n\r\nOpenJDK 21\r\n\r\n### Quarkus version or git rev\r\n\r\n999-SNAPSHOT & 3.14.x\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\nApache Maven 3.9.9\r\n\r\n### Additional information\r\n\r\n_No response_","closed_by":{"login":"cescoffier","id":402301,"node_id":"MDQ6VXNlcjQwMjMwMQ==","avatar_url":"https://avatars.githubusercontent.com/u/402301?v=4","gravatar_id":"","url":"https://api.github.com/users/cescoffier","html_url":"https://github.com/cescoffier","followers_url":"https://api.github.com/users/cescoffier/followers","following_url":"https://api.github.com/users/cescoffier/following{/other_user}","gists_url":"https://api.github.com/users/cescoffier/gists{/gist_id}","starred_url":"https://api.github.com/users/cescoffier/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cescoffier/subscriptions","organizations_url":"https://api.github.com/users/cescoffier/orgs","repos_url":"https://api.github.com/users/cescoffier/repos","events_url":"https://api.github.com/users/cescoffier/events{/privacy}","received_events_url":"https://api.github.com/users/cescoffier/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/quarkusio/quarkus/issues/43107/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/quarkusio/quarkus/issues/43107/timeline","performed_via_github_app":null,"state_reason":"completed"}