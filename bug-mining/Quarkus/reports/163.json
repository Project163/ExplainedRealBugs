{"url":"https://api.github.com/repos/quarkusio/quarkus/issues/45650","repository_url":"https://api.github.com/repos/quarkusio/quarkus","labels_url":"https://api.github.com/repos/quarkusio/quarkus/issues/45650/labels{/name}","comments_url":"https://api.github.com/repos/quarkusio/quarkus/issues/45650/comments","events_url":"https://api.github.com/repos/quarkusio/quarkus/issues/45650/events","html_url":"https://github.com/quarkusio/quarkus/issues/45650","id":2793054167,"node_id":"I_kwDOCFbutM6mep_X","number":45650,"title":"ClassNotFound during static init build step corrupts delayed logging","user":{"login":"shawkins","id":2475669,"node_id":"MDQ6VXNlcjI0NzU2Njk=","avatar_url":"https://avatars.githubusercontent.com/u/2475669?v=4","gravatar_id":"","url":"https://api.github.com/users/shawkins","html_url":"https://github.com/shawkins","followers_url":"https://api.github.com/users/shawkins/followers","following_url":"https://api.github.com/users/shawkins/following{/other_user}","gists_url":"https://api.github.com/users/shawkins/gists{/gist_id}","starred_url":"https://api.github.com/users/shawkins/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shawkins/subscriptions","organizations_url":"https://api.github.com/users/shawkins/orgs","repos_url":"https://api.github.com/users/shawkins/repos","events_url":"https://api.github.com/users/shawkins/events{/privacy}","received_events_url":"https://api.github.com/users/shawkins/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":985346620,"node_id":"MDU6TGFiZWw5ODUzNDY2MjA=","url":"https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug","name":"kind/bug","color":"d73a4a","default":false,"description":"Something isn't working"},{"id":1283428650,"node_id":"MDU6TGFiZWwxMjgzNDI4NjUw","url":"https://api.github.com/repos/quarkusio/quarkus/labels/area/logging","name":"area/logging","color":"0366d6","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/quarkusio/quarkus/milestones/372","html_url":"https://github.com/quarkusio/quarkus/milestone/372","labels_url":"https://api.github.com/repos/quarkusio/quarkus/milestones/372/labels","id":12181460,"node_id":"MI_kwDOCFbutM4Aud_U","number":372,"title":"3.15.4","description":"","creator":{"login":"gsmet","id":1279749,"node_id":"MDQ6VXNlcjEyNzk3NDk=","avatar_url":"https://avatars.githubusercontent.com/u/1279749?v=4","gravatar_id":"","url":"https://api.github.com/users/gsmet","html_url":"https://github.com/gsmet","followers_url":"https://api.github.com/users/gsmet/followers","following_url":"https://api.github.com/users/gsmet/following{/other_user}","gists_url":"https://api.github.com/users/gsmet/gists{/gist_id}","starred_url":"https://api.github.com/users/gsmet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gsmet/subscriptions","organizations_url":"https://api.github.com/users/gsmet/orgs","repos_url":"https://api.github.com/users/gsmet/repos","events_url":"https://api.github.com/users/gsmet/events{/privacy}","received_events_url":"https://api.github.com/users/gsmet/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":105,"state":"closed","created_at":"2025-01-17T08:42:44Z","updated_at":"2025-07-09T16:36:56Z","due_on":null,"closed_at":"2025-03-11T14:00:10Z"},"comments":9,"created_at":"2025-01-16T15:15:44Z","updated_at":"2025-02-20T12:48:41Z","closed_at":"2025-01-24T07:55:56Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\n\nAn underlying classnotfound exception during a static init build step is causing the delayed logging handling to fail with a NullPointerException and the delayed logging is incomplete.\n\n### Expected behavior\n\nThe delayed logging should work and/or the underlying exception should be propogated to the caller of QuarkusEntryPoint.main().\n\n### Actual behavior\n\nWith an underlying class not found exception during a static init build step (captured via a debug session):\n\n```\njava.util.ServiceConfigurationError: org.keycloak.authentication.AuthenticatorFactory: Provider org.keycloak.examples.authenticator.SecretQuestionAuthenticatorFactory could not be instantiated\n\tat java.base/java.util.ServiceLoader.fail(ServiceLoader.java:586)\n\tat java.base/java.util.ServiceLoader$ProviderImpl.newInstance(ServiceLoader.java:813)\n\tat java.base/java.util.ServiceLoader$ProviderImpl.get(ServiceLoader.java:729)\n\tat java.base/java.util.ServiceLoader$3.next(ServiceLoader.java:1403)\n\tat org.keycloak.provider.DefaultProviderLoader.load(DefaultProviderLoader.java:60)\n\tat org.keycloak.provider.ProviderManager.load(ProviderManager.java:107)\n\tat org.keycloak.quarkus.deployment.KeycloakProcessor.loadFactories(KeycloakProcessor.java:705)\n\tat org.keycloak.quarkus.deployment.KeycloakProcessor.configureKeycloakSessionFactory(KeycloakProcessor.java:468)\n\tat java.base/java.lang.invoke.MethodHandle.invokeWithArguments(MethodHandle.java:733)\n\tat io.quarkus.deployment.ExtensionLoader$3.execute(ExtensionLoader.java:856)\n\tat io.quarkus.builder.BuildContext.run(BuildContext.java:256)\n\tat org.jboss.threads.ContextHandler$1.runWith(ContextHandler.java:18)\n\tat org.jboss.threads.EnhancedQueueExecutor$Task.doRunWith(EnhancedQueueExecutor.java:2516)\n\tat org.jboss.threads.EnhancedQueueExecutor$Task.run(EnhancedQueueExecutor.java:2495)\n\tat org.jboss.threads.EnhancedQueueExecutor$ThreadBody.run(EnhancedQueueExecutor.java:1521)\n\tat java.base/java.lang.Thread.run(Thread.java:1583)\n\tat org.jboss.threads.JBossThread.run(JBossThread.java:483)\nCaused by: java.lang.NoClassDefFoundError: org/keycloak/examples/authenticator/SecretQuestionAuthenticator\n\tat org.keycloak.examples.authenticator.SecretQuestionAuthenticatorFactory.<clinit>(SecretQuestionAuthenticatorFactory.java:39)\n\tat java.base/jdk.internal.misc.Unsafe.ensureClassInitialized0(Native Method)\n\tat java.base/jdk.internal.misc.Unsafe.ensureClassInitialized(Unsafe.java:1160)\n\tat java.base/jdk.internal.reflect.MethodHandleAccessorFactory.ensureClassInitialized(MethodHandleAccessorFactory.java:300)\n\tat java.base/jdk.internal.reflect.MethodHandleAccessorFactory.newConstructorAccessor(MethodHandleAccessorFactory.java:103)\n\tat java.base/jdk.internal.reflect.ReflectionFactory.newConstructorAccessor(ReflectionFactory.java:200)\n\tat java.base/java.lang.reflect.Constructor.acquireConstructorAccessor(Constructor.java:549)\n\tat java.base/java.lang.reflect.Constructor.newInstanceWithCaller(Constructor.java:499)\n\tat java.base/java.lang.reflect.Constructor.newInstance(Constructor.java:486)\n\tat java.base/java.util.ServiceLoader$ProviderImpl.newInstance(ServiceLoader.java:789)\n\t... 15 more\nCaused by: java.lang.ClassNotFoundException: org.keycloak.examples.authenticator.SecretQuestionAuthenticator\n\tat io.quarkus.bootstrap.classloading.QuarkusClassLoader.loadClass(QuarkusClassLoader.java:535)\n\tat io.quarkus.bootstrap.classloading.QuarkusClassLoader.loadClass(QuarkusClassLoader.java:481)\n\tat io.quarkus.bootstrap.classloading.QuarkusClassLoader.loadClass(QuarkusClassLoader.java:533)\n\tat io.quarkus.bootstrap.classloading.QuarkusClassLoader.loadClass(QuarkusClassLoader.java:481)\n\t... 25 more\n```\n\nThere is then an attempt to purge the delayed logging entries:\n\n```\nThe DelayedHandler was closed before any children handlers were configured. Messages will be written to stderr.\n2025-01-16 09:59:07,623 DEBUG [org.jboss.logging] (main) Logging Provider: org.jboss.logging.JBossLogManagerProvider\n\n... more log entries\n```\n\nHowever that triggers a NullPointerException, so that Keycloak shows:\n\n```\njava.lang.NullPointerException\n\tat java.base/java.util.Objects.requireNonNull(Objects.java:233)\n\tat java.base/java.util.ImmutableCollections$List12.<init>(ImmutableCollections.java:563)\n\tat java.base/java.util.List.of(List.java:937)\n\tat io.quarkus.paths.OpenContainerPathTree.getRoots(OpenContainerPathTree.java:96)\n\tat io.quarkus.paths.SharedArchivePathTree$CallerOpenPathTree.getRoots(SharedArchivePathTree.java:142)\n\tat io.quarkus.bootstrap.classloading.PathTreeClassPathElement.toString(PathTreeClassPathElement.java:214)\n\tat java.base/java.util.Formatter$FormatSpecifier.printString(Formatter.java:3158)\n\tat java.base/java.util.Formatter$FormatSpecifier.print(Formatter.java:3036)\n\tat java.base/java.util.Formatter.format(Formatter.java:2791)\n\tat java.base/java.util.Formatter.format(Formatter.java:2728)\n\tat java.base/java.lang.String.format(String.java:4390)\n\tat org.jboss.logmanager.ExtFormatter.formatMessagePrintf(ExtFormatter.java:144)\n\tat org.jboss.logmanager.ExtFormatter.formatMessage(ExtFormatter.java:91)\n\tat org.jboss.logmanager.formatters.Formatters$16.renderRaw(Formatters.java:832)\n\tat org.jboss.logmanager.formatters.Formatters$JustifyingFormatStep.render(Formatters.java:227)\n\tat org.jboss.logmanager.formatters.MultistepFormatter.format(MultistepFormatter.java:90)\n\tat org.jboss.logmanager.ExtFormatter.format(ExtFormatter.java:58)\n\tat io.quarkus.bootstrap.logging.QuarkusDelayedHandler.close(QuarkusDelayedHandler.java:157)\n\tat io.quarkus.bootstrap.runner.QuarkusEntryPoint.main(QuarkusEntryPoint.java:35)\n\tat org.keycloak.quarkus.runtime.cli.Picocli.build(Picocli.java:945)\n\tat org.keycloak.quarkus.runtime.cli.command.Build.run(Build.java:91)\n\tat picocli.CommandLine.executeUserObject(CommandLine.java:2030)\n\t...\n\tat org.keycloak.quarkus.runtime.KeycloakMain.main(KeycloakMain.java:68)\n\tat java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(DirectMethodHandleAccessor.java:103)\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:580)\n\tat io.quarkus.bootstrap.runner.QuarkusEntryPoint.doRun(QuarkusEntryPoint.java:62)\n\tat io.quarkus.bootstrap.runner.QuarkusEntryPoint.main(QuarkusEntryPoint.java:33)\n```\n\n### How to Reproduce?\n\nAdd a jar to the provider directory with a missing class - I used https://github.com/keycloak/keycloak-quickstarts/tree/main/extension/authenticator and remove the Provider classes referenced by the Factories, see also https://github.com/keycloak/keycloak/issues/36482\n\nRun a build\n\nI can also try to isolate this to a non-Keycloak quarkus project if needed.\n\n### Output of `uname -a` or `ver`\n\n_No response_\n\n### Output of `java -version`\n\n_No response_\n\n### Quarkus version or git rev\n\n3.15.2\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\n_No response_\n\n### Additional information\n\nThe Keycloak user reported that this behavior did not occur with Keycloak based upon Quarkus 3.8.5.","closed_by":{"login":"gsmet","id":1279749,"node_id":"MDQ6VXNlcjEyNzk3NDk=","avatar_url":"https://avatars.githubusercontent.com/u/1279749?v=4","gravatar_id":"","url":"https://api.github.com/users/gsmet","html_url":"https://github.com/gsmet","followers_url":"https://api.github.com/users/gsmet/followers","following_url":"https://api.github.com/users/gsmet/following{/other_user}","gists_url":"https://api.github.com/users/gsmet/gists{/gist_id}","starred_url":"https://api.github.com/users/gsmet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gsmet/subscriptions","organizations_url":"https://api.github.com/users/gsmet/orgs","repos_url":"https://api.github.com/users/gsmet/repos","events_url":"https://api.github.com/users/gsmet/events{/privacy}","received_events_url":"https://api.github.com/users/gsmet/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/quarkusio/quarkus/issues/45650/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/quarkusio/quarkus/issues/45650/timeline","performed_via_github_app":null,"state_reason":"completed"}