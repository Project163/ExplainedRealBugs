{"url":"https://api.github.com/repos/quarkusio/quarkus/issues/50073","repository_url":"https://api.github.com/repos/quarkusio/quarkus","labels_url":"https://api.github.com/repos/quarkusio/quarkus/issues/50073/labels{/name}","comments_url":"https://api.github.com/repos/quarkusio/quarkus/issues/50073/comments","events_url":"https://api.github.com/repos/quarkusio/quarkus/issues/50073/events","html_url":"https://github.com/quarkusio/quarkus/issues/50073","id":3420169302,"node_id":"I_kwDOCFbutM7L26RW","number":50073,"title":"Panache allocation and (reflective) annotation scanning in the hot path","user":{"login":"franz1981","id":13125299,"node_id":"MDQ6VXNlcjEzMTI1Mjk5","avatar_url":"https://avatars.githubusercontent.com/u/13125299?v=4","gravatar_id":"","url":"https://api.github.com/users/franz1981","html_url":"https://github.com/franz1981","followers_url":"https://api.github.com/users/franz1981/followers","following_url":"https://api.github.com/users/franz1981/following{/other_user}","gists_url":"https://api.github.com/users/franz1981/gists{/gist_id}","starred_url":"https://api.github.com/users/franz1981/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/franz1981/subscriptions","organizations_url":"https://api.github.com/users/franz1981/orgs","repos_url":"https://api.github.com/users/franz1981/repos","events_url":"https://api.github.com/users/franz1981/events{/privacy}","received_events_url":"https://api.github.com/users/franz1981/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":985346622,"node_id":"MDU6TGFiZWw5ODUzNDY2MjI=","url":"https://api.github.com/repos/quarkusio/quarkus/labels/kind/enhancement","name":"kind/enhancement","color":"a2eeef","default":false,"description":"New feature or request"},{"id":1273026134,"node_id":"MDU6TGFiZWwxMjczMDI2MTM0","url":"https://api.github.com/repos/quarkusio/quarkus/labels/area/panache","name":"area/panache","color":"0366d6","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/quarkusio/quarkus/milestones/447","html_url":"https://github.com/quarkusio/quarkus/milestone/447","labels_url":"https://api.github.com/repos/quarkusio/quarkus/milestones/447/labels","id":13899702,"node_id":"MI_kwDOCFbutM4A1Be2","number":447,"title":"3.30 - main","description":"","creator":{"login":"quarkusbot","id":61254497,"node_id":"MDQ6VXNlcjYxMjU0NDk3","avatar_url":"https://avatars.githubusercontent.com/u/61254497?v=4","gravatar_id":"","url":"https://api.github.com/users/quarkusbot","html_url":"https://github.com/quarkusbot","followers_url":"https://api.github.com/users/quarkusbot/followers","following_url":"https://api.github.com/users/quarkusbot/following{/other_user}","gists_url":"https://api.github.com/users/quarkusbot/gists{/gist_id}","starred_url":"https://api.github.com/users/quarkusbot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/quarkusbot/subscriptions","organizations_url":"https://api.github.com/users/quarkusbot/orgs","repos_url":"https://api.github.com/users/quarkusbot/repos","events_url":"https://api.github.com/users/quarkusbot/events{/privacy}","received_events_url":"https://api.github.com/users/quarkusbot/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":5,"closed_issues":111,"state":"open","created_at":"2025-10-15T18:48:30Z","updated_at":"2025-11-08T18:53:43Z","due_on":null,"closed_at":null},"comments":51,"created_at":"2025-09-16T03:18:35Z","updated_at":"2025-11-07T09:43:22Z","closed_at":"2025-11-07T09:43:19Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description\n\nThis is an extract of the JFR allocation event collected while running https://github.com/brunobat/quarkus-observability-perf/blob/631b05ec3fbfa264d3706c081d04dc76c65d62cb/quarkus-otel-db-perf/src/main/java/com/brunobat/rest/LegumeRepository.java#L18 \n\nwith this change\n\nhttps://github.com/brunobat/quarkus-observability-perf/pull/5/files#diff-87295ab4787f3ecc494c8aa0b00fd701d1a456eee68f531c18351944c9a5fd30R19\n\n<img width=\"1687\" height=\"947\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/6464e6f4-c76a-400b-9c34-2d1f8458225e\" />\n\nIt shows that we're both calling reflective operations (scanning the different constructors for annotations) and allocating `String`s (these two often come together, but in this case we do both), at\nhttps://github.com/quarkusio/quarkus/blob/71b94dd392f01194fa6a9b9d4bad28f2527cccc4/extensions/panache/hibernate-orm-panache-common/runtime/src/main/java/io/quarkus/hibernate/orm/panache/common/runtime/CommonPanacheQueryImpl.java#L128\n\nAnd the same happen in the reactive version of the same code.\nI'm assuming that we cannot end up in the `select` path somehow for good reasons, hence, the easiest \"cure\" to this is to just change such method to collect the different `String`s into a list computing the overall size and perform the joining allocating a properly pre-sized builder - saving it to be enlarged each time (with temporary byte[] copies - which is what JFR complained about).\nBut the reality is that I won't expected the reflective operation to happen each time, too - as these annotation(s) shouldn't change over the lifecycle of the application.\n\nIt looks triggered by not matching the condition:\n\n```java\nif (lowerCasedTrimmedQuery.startsWith(\"select \")) {\n```\nsince the query is:\n```java\npublic Stream<LegumeItem> listLegumes(int pageIndex) {\n        return find(\"FROM Legume h\")\n//                .withHint(\"org.hibernate.cacheable\", \"true\")\n                .project(LegumeItem.class)\n                .page(pageIndex, 16).stream();\n        // ...\n```\n\n\n### Implementation ideas\n\n_No response_","closed_by":{"login":"FroMage","id":179265,"node_id":"MDQ6VXNlcjE3OTI2NQ==","avatar_url":"https://avatars.githubusercontent.com/u/179265?v=4","gravatar_id":"","url":"https://api.github.com/users/FroMage","html_url":"https://github.com/FroMage","followers_url":"https://api.github.com/users/FroMage/followers","following_url":"https://api.github.com/users/FroMage/following{/other_user}","gists_url":"https://api.github.com/users/FroMage/gists{/gist_id}","starred_url":"https://api.github.com/users/FroMage/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/FroMage/subscriptions","organizations_url":"https://api.github.com/users/FroMage/orgs","repos_url":"https://api.github.com/users/FroMage/repos","events_url":"https://api.github.com/users/FroMage/events{/privacy}","received_events_url":"https://api.github.com/users/FroMage/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/quarkusio/quarkus/issues/50073/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/quarkusio/quarkus/issues/50073/timeline","performed_via_github_app":null,"state_reason":"completed"}