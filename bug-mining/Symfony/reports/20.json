{"url":"https://api.github.com/repos/symfony/symfony/issues/59128","repository_url":"https://api.github.com/repos/symfony/symfony","labels_url":"https://api.github.com/repos/symfony/symfony/issues/59128/labels{/name}","comments_url":"https://api.github.com/repos/symfony/symfony/issues/59128/comments","events_url":"https://api.github.com/repos/symfony/symfony/issues/59128/events","html_url":"https://github.com/symfony/symfony/issues/59128","id":2724588279,"node_id":"I_kwDOAAb9Ss6iZer3","number":59128,"title":"[DependencyInjection] env vars are not reset upon kernel.reset","user":{"login":"faizanakram99","id":10880992,"node_id":"MDQ6VXNlcjEwODgwOTky","avatar_url":"https://avatars.githubusercontent.com/u/10880992?v=4","gravatar_id":"","url":"https://api.github.com/users/faizanakram99","html_url":"https://github.com/faizanakram99","followers_url":"https://api.github.com/users/faizanakram99/followers","following_url":"https://api.github.com/users/faizanakram99/following{/other_user}","gists_url":"https://api.github.com/users/faizanakram99/gists{/gist_id}","starred_url":"https://api.github.com/users/faizanakram99/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/faizanakram99/subscriptions","organizations_url":"https://api.github.com/users/faizanakram99/orgs","repos_url":"https://api.github.com/users/faizanakram99/repos","events_url":"https://api.github.com/users/faizanakram99/events{/privacy}","received_events_url":"https://api.github.com/users/faizanakram99/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":99863,"node_id":"MDU6TGFiZWw5OTg2Mw==","url":"https://api.github.com/repos/symfony/symfony/labels/DependencyInjection","name":"DependencyInjection","color":"DDDDDD","default":false,"description":null},{"id":100079,"node_id":"MDU6TGFiZWwxMDAwNzk=","url":"https://api.github.com/repos/symfony/symfony/labels/Bug","name":"Bug","color":"e10c02","default":false,"description":null},{"id":237003792,"node_id":"MDU6TGFiZWwyMzcwMDM3OTI=","url":"https://api.github.com/repos/symfony/symfony/labels/Status:%20Needs%20Review","name":"Status: Needs Review","color":"ededed","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2024-12-07T13:12:26Z","updated_at":"2025-01-17T07:23:51Z","closed_at":"2025-01-17T07:23:51Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Symfony version(s) affected\r\n\r\n7.1.0\r\n\r\n### Description\r\n\r\n#54666 was supposed to reset env vars upon kernel.reset but seems it doesn't work as intended, it probably works for web environments with booted kernels like php-pm or frankenphp worker mode as container is reset for them on each kernel boot but not for messenger workers. Currently there are two issues with it.\r\n\r\n1. EnvVarProcessor is not tagged with kernel.reset\r\n2. Env vars are cached higher up in stack in Container (service_container) and they are never reset.\r\n\r\nSee https://github.com/symfony/symfony/pull/54666#issuecomment-2483122814\r\n            \r\n\r\n### How to reproduce\r\n\r\nReproducer isn't needed, the description is enough to explain the issue. \r\n\r\n### Possible Solution\r\n\r\nFirst issue can be fixed by adding  `->tag('kernel.reset', ['method' => 'reset'])` [here](https://github.com/symfony/symfony/blob/75da5aaa8254fb9b09cdaaea996d922bd0b89874/src/Symfony/Bundle/FrameworkBundle/Resources/config/services.php#L193)\r\n\r\nSecond issue, I'm not sure, ~~maybe we should get rid of services resetter altogether and just reboot kernel~~ (edit: bad idea as pointed out by @stof in following comment). Alternatively, add `service_container` to services_resetter but just reset envCache (and not other services). It would require another public method other than reset in container class and tagging it with `kernel.reset` and use that method as \"resetMethod\". Instead of tagging service_container with kernel.reset, we could simply call that public method from `EnvVarProcessor::reset()`\r\n\r\n\r\n### Additional Context\r\n\r\nResetting env vars is necessary to be able to run symfony messenger workers for a multi tenant application (single web server multiple databases) where each message is identified with a tenant stamp and depending upon the tenant id, its env var needs are loaded like database_url, filesystem path etc. Also it is similar to web model that way, each message is handled without causing side effects (in isolation).","closed_by":{"login":"fabpot","id":47313,"node_id":"MDQ6VXNlcjQ3MzEz","avatar_url":"https://avatars.githubusercontent.com/u/47313?v=4","gravatar_id":"","url":"https://api.github.com/users/fabpot","html_url":"https://github.com/fabpot","followers_url":"https://api.github.com/users/fabpot/followers","following_url":"https://api.github.com/users/fabpot/following{/other_user}","gists_url":"https://api.github.com/users/fabpot/gists{/gist_id}","starred_url":"https://api.github.com/users/fabpot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fabpot/subscriptions","organizations_url":"https://api.github.com/users/fabpot/orgs","repos_url":"https://api.github.com/users/fabpot/repos","events_url":"https://api.github.com/users/fabpot/events{/privacy}","received_events_url":"https://api.github.com/users/fabpot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/symfony/symfony/issues/59128/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/symfony/symfony/issues/59128/timeline","performed_via_github_app":null,"state_reason":"completed"}