{"url":"https://api.github.com/repos/symfony/symfony/issues/58941","repository_url":"https://api.github.com/repos/symfony/symfony","labels_url":"https://api.github.com/repos/symfony/symfony/issues/58941/labels{/name}","comments_url":"https://api.github.com/repos/symfony/symfony/issues/58941/comments","events_url":"https://api.github.com/repos/symfony/symfony/issues/58941/events","html_url":"https://github.com/symfony/symfony/issues/58941","id":2675445641,"node_id":"I_kwDOAAb9Ss6feA-J","number":58941,"title":"[Security] Configured oidc_user_info.claim not used as userIdentifier in OidcUser object","user":{"login":"bodendorfer-simplethings","id":36152444,"node_id":"MDQ6VXNlcjM2MTUyNDQ0","avatar_url":"https://avatars.githubusercontent.com/u/36152444?v=4","gravatar_id":"","url":"https://api.github.com/users/bodendorfer-simplethings","html_url":"https://github.com/bodendorfer-simplethings","followers_url":"https://api.github.com/users/bodendorfer-simplethings/followers","following_url":"https://api.github.com/users/bodendorfer-simplethings/following{/other_user}","gists_url":"https://api.github.com/users/bodendorfer-simplethings/gists{/gist_id}","starred_url":"https://api.github.com/users/bodendorfer-simplethings/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bodendorfer-simplethings/subscriptions","organizations_url":"https://api.github.com/users/bodendorfer-simplethings/orgs","repos_url":"https://api.github.com/users/bodendorfer-simplethings/repos","events_url":"https://api.github.com/users/bodendorfer-simplethings/events{/privacy}","received_events_url":"https://api.github.com/users/bodendorfer-simplethings/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":99600,"node_id":"MDU6TGFiZWw5OTYwMA==","url":"https://api.github.com/repos/symfony/symfony/labels/Security","name":"Security","color":"DDDDDD","default":false,"description":null},{"id":100079,"node_id":"MDU6TGFiZWwxMDAwNzk=","url":"https://api.github.com/repos/symfony/symfony/labels/Bug","name":"Bug","color":"e10c02","default":false,"description":null},{"id":237003792,"node_id":"MDU6TGFiZWwyMzcwMDM3OTI=","url":"https://api.github.com/repos/symfony/symfony/labels/Status:%20Needs%20Review","name":"Status: Needs Review","color":"ededed","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2024-11-20T10:52:39Z","updated_at":"2025-04-07T13:35:15Z","closed_at":"2025-04-07T13:35:15Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Symfony version(s) affected\r\n\r\n`>= 6.3`\r\n\r\n### Description\r\n\r\nThe [documentation ](https://symfony.com/doc/current/security/access_token.html#1-configure-the-oidcuserinfotokenhandler) states:\r\n> Following the [OpenID Connect Specification](https://openid.net/specs/openid-connect-core-1_0.html), the sub claim is used as user identifier by default. To use another claim, specify it on the configuration\r\n\r\nHowever when configuring the claim, it only affects the UserBadge, but not the resulting OidcUser object.\r\nContrary to the statement in the documentation, the value of the `OidcUser::userIdentifier` property is null and the `OidcUser::getUserIdentifer ` method falls back to the `sub` claim.\r\n\r\n### How to reproduce\r\n\r\nWith the following firewall security config:\r\n```\r\n        main:\r\n            pattern:    ^/\r\n            access_token:\r\n                token_handler:\r\n                    oidc_user_info: \r\n                        base_uri: https://www.example.com/realms/demo/protocol/openid-connect/userinfo\r\n                        claim: preferred_username\r\n            stateless:  true\r\n```\r\n\r\npreferred_username is not used as userIdentifier in the user object.\r\n\r\n### Possible Solution\r\n\r\nIn the class `Symfony\\Component\\Security\\Http\\AccessToken\\Oidc\\OidcUserInfoTokenHandler`, instead of \r\n```\r\n            return new UserBadge($claims[$this->claim], new FallbackUserLoader(fn () => $this->createUser($claims)), $claims);\r\n```\r\nthis\r\n```\r\n            return new UserBadge(\r\n                $claims[$this->claim],\r\n                new FallbackUserLoader(\r\n                    function (string $userIdentifier) use ($claims) {\r\n                        $claims['user_identifier'] = $claims[$this->claim];\r\n                        $this->createUser($claims);\r\n                    }\r\n                ),\r\n                $claims\r\n            );\r\n```\r\n\r\n### Additional Context\r\n\r\n_No response_","closed_by":{"login":"chalasr","id":7502063,"node_id":"MDQ6VXNlcjc1MDIwNjM=","avatar_url":"https://avatars.githubusercontent.com/u/7502063?v=4","gravatar_id":"","url":"https://api.github.com/users/chalasr","html_url":"https://github.com/chalasr","followers_url":"https://api.github.com/users/chalasr/followers","following_url":"https://api.github.com/users/chalasr/following{/other_user}","gists_url":"https://api.github.com/users/chalasr/gists{/gist_id}","starred_url":"https://api.github.com/users/chalasr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chalasr/subscriptions","organizations_url":"https://api.github.com/users/chalasr/orgs","repos_url":"https://api.github.com/users/chalasr/repos","events_url":"https://api.github.com/users/chalasr/events{/privacy}","received_events_url":"https://api.github.com/users/chalasr/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/symfony/symfony/issues/58941/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/symfony/symfony/issues/58941/timeline","performed_via_github_app":null,"state_reason":"completed"}