{"url":"https://api.github.com/repos/symfony/symfony/issues/59524","repository_url":"https://api.github.com/repos/symfony/symfony","labels_url":"https://api.github.com/repos/symfony/symfony/issues/59524/labels{/name}","comments_url":"https://api.github.com/repos/symfony/symfony/issues/59524/comments","events_url":"https://api.github.com/repos/symfony/symfony/issues/59524/events","html_url":"https://github.com/symfony/symfony/issues/59524","id":2793053030,"node_id":"I_kwDOAAb9Ss6meptm","number":59524,"title":"[HtmlSanitizer] Access to undefined key in UrlSanitizer","user":{"login":"Stoakes","id":7981968,"node_id":"MDQ6VXNlcjc5ODE5Njg=","avatar_url":"https://avatars.githubusercontent.com/u/7981968?v=4","gravatar_id":"","url":"https://api.github.com/users/Stoakes","html_url":"https://github.com/Stoakes","followers_url":"https://api.github.com/users/Stoakes/followers","following_url":"https://api.github.com/users/Stoakes/following{/other_user}","gists_url":"https://api.github.com/users/Stoakes/gists{/gist_id}","starred_url":"https://api.github.com/users/Stoakes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Stoakes/subscriptions","organizations_url":"https://api.github.com/users/Stoakes/orgs","repos_url":"https://api.github.com/users/Stoakes/repos","events_url":"https://api.github.com/users/Stoakes/events{/privacy}","received_events_url":"https://api.github.com/users/Stoakes/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":100079,"node_id":"MDU6TGFiZWwxMDAwNzk=","url":"https://api.github.com/repos/symfony/symfony/labels/Bug","name":"Bug","color":"e10c02","default":false,"description":null},{"id":237003792,"node_id":"MDU6TGFiZWwyMzcwMDM3OTI=","url":"https://api.github.com/repos/symfony/symfony/labels/Status:%20Needs%20Review","name":"Status: Needs Review","color":"ededed","default":false,"description":null},{"id":3679060522,"node_id":"LA_kwDOAAb9Ss7bSgIq","url":"https://api.github.com/repos/symfony/symfony/labels/HtmlSanitizer","name":"HtmlSanitizer","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2025-01-16T15:15:15Z","updated_at":"2025-01-21T22:44:30Z","closed_at":"2025-01-21T22:44:29Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Symfony version(s) affected\n\n6.1.0 and above\n\n### Description\n\nHello,\n\nI'm getting an error when sanitizing a text with urls. I have multiple allowed hosts in my config, and thus html sanitization for urls fails with access to undefined keys when calling `UrlSanitizer->matchAllowedHostParts`.\n\n<details>\n<summary>Here are details about narrowing down the issue to `UrlSanitizer->matchAllowedHostParts`</summary>\nThis becomes quite obvious that when looking at `matchAllowedHostParts`\n\n```php\n# src/Symfony/Component/HtmlSanitizer/TextSanitizer/UrlSanitizer.php\nprivate static function matchAllowedHostParts(array $uriParts, array $trustedParts): bool\n    {\n        // Check each chunk of the domain is valid\n        foreach ($trustedParts as $key => $trustedPart) {\n            if ($uriParts[$key] !== $trustedPart) {\n                return false;\n            }\n        }\n\n        return true;\n    }\n```\n\nwhen `$trustedParts` is longer than `$uriParts`. It eventually ends with a warning : `Warning: Undefined array key 2`.\n</details>\n\n### How to reproduce\n\nHere is a way to reproduce the issue through HtmlSanitizer unit tests : \n\n1. Open `src/Symfony/Component/HtmlSanitizer/Tests/TextSanitizer/UrlSanitizerTest.php`\n2. Add the following test case :\n   ```php\n        yield [\n            'input' => 'https://trusted.com/link.php',\n            'allowedSchemes' => ['http', 'https'],\n            'allowedHosts' => ['subdomain.trusted.com', 'trusted.com'],\n            'forceHttps' => false,\n            'allowRelative' => false,\n            'expected' => 'https://trusted.com/link.php',\n        ];\n  ```\n3. Test fails with : \n\n```\n4) Symfony\\Component\\HtmlSanitizer\\Tests\\TextSanitizer\\UrlSanitizerTest::testSanitize with data set #27 ('https://trusted.com/link.php', array('http', 'https'), array('subdomain.trusted.com', 'trusted.com'), false, false, 'https://trusted.com/link.php')\nUndefined array key 2\n\n/home/stoakes/dev/symfony/src/Symfony/Component/HtmlSanitizer/TextSanitizer/UrlSanitizer.php:135\n/home/stoakes/dev/symfony/src/Symfony/Component/HtmlSanitizer/TextSanitizer/UrlSanitizer.php:123\n/home/stoakes/dev/symfony/src/Symfony/Component/HtmlSanitizer/TextSanitizer/UrlSanitizer.php:63\n/home/stoakes/dev/symfony/src/Symfony/Component/HtmlSanitizer/Tests/TextSanitizer/UrlSanitizerTest.php:24\n```\n\n### Possible Solution\n\nI would check that key exists before accessing it. Roughly : \n\n```php\nprivate static function matchAllowedHostParts(array $uriParts, array $trustedParts): bool\n    {\n        // Check each chunk of the domain is valid\n        foreach ($trustedParts as $key => $trustedPart) {\n            if (array_key_exists($key, $uriParts) && $uriParts[$key] !== $trustedPart) {\n                return false;\n            }\n        }\n\n        return true;\n    }\n```\n\n\n### Additional Context\n\n_No response_","closed_by":{"login":"chalasr","id":7502063,"node_id":"MDQ6VXNlcjc1MDIwNjM=","avatar_url":"https://avatars.githubusercontent.com/u/7502063?v=4","gravatar_id":"","url":"https://api.github.com/users/chalasr","html_url":"https://github.com/chalasr","followers_url":"https://api.github.com/users/chalasr/followers","following_url":"https://api.github.com/users/chalasr/following{/other_user}","gists_url":"https://api.github.com/users/chalasr/gists{/gist_id}","starred_url":"https://api.github.com/users/chalasr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chalasr/subscriptions","organizations_url":"https://api.github.com/users/chalasr/orgs","repos_url":"https://api.github.com/users/chalasr/repos","events_url":"https://api.github.com/users/chalasr/events{/privacy}","received_events_url":"https://api.github.com/users/chalasr/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/symfony/symfony/issues/59524/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/symfony/symfony/issues/59524/timeline","performed_via_github_app":null,"state_reason":"completed"}