<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:19:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[QPIDJMS-534] BalancedProviderFuture.sync stuck forever during connection recovery</title>
                <link>https://issues.apache.org/jira/browse/QPIDJMS-534</link>
                <project id="12314524" key="QPIDJMS">Qpid JMS</project>
                    <description>&lt;p&gt;Recently, we observed an issue on our production environment where we can see that BalancedProviderFuture.sync method during connection recovery is stuck forever and never returns. We have observed this in 2 hosts in last one week, the only solution is to restart the server.&lt;/p&gt;

&lt;p&gt;I am attaching the thread dump which indicates the issue and how it blocks other threads,&#160;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13023494/13023494_thread-dump.txt&quot; title=&quot;thread-dump.txt attached to QPIDJMS-534&quot;&gt;thread-dump.txt&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&#160;will have details of all the threads.&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;DetailsofInvestigation&quot;&gt;&lt;/a&gt;Details of Investigation&lt;/h3&gt;
&lt;ul&gt;
	&lt;li&gt;This issue is happening on connection recovery during failover from one server to another.&lt;/li&gt;
	&lt;li&gt;By debugging I can see that&#160;BalancedProviderFuture.sync method is waiting for its state to be updated, and its state is updated by AmqpProvider thread. In thread dump I don&apos;t see any AmqpProvider thread which is in stuck state which indicates that AmqpProvider has done its job but still the state for given&#160;BalancedProviderFuture object is not updated.&lt;/li&gt;
	&lt;li&gt;In the successful event, I can see that the state of&#160;BalancedProviderFuture object is updated in below sequence:
	&lt;ul&gt;
		&lt;li&gt;JmsSession.onConnectionRecovery method calls&#160;provider.create after creating&#160;BalancedProviderFuture object.&lt;/li&gt;
		&lt;li&gt;provider.create (aka AmqpProvider.create) is start a thread using serializer, this create method has proper handling and it either calls&#160;pumpToProtonTransport OR&#160;request.onFailure(which will update the state of&#160;BalancedProviderFuture in case of exception).&lt;/li&gt;
		&lt;li&gt;Once the above thread gets finished(basically after pumpToProtonTransport), the serializer will call the AmqpProvider.onData method which will update the state of&#160;BalancedProviderFuture object.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;I have observed that if we get the exception in AmqpProvider.onData method then the state of&#160;BalancedProviderFuture is not getting updated and the BalancedProviderFuture.sync method gets stuck forever, the exception can come in case of&#160;protonTransport tail is closed already(probably because of idle timeout issue OR any other transport related issue).&lt;/li&gt;
	&lt;li&gt;I have also observed that in some cases(of idle timeout OR transport errors) after completion of a thread which was started by&#160;provider.create (aka AmqpProvider.create), the serializer is not calling&#160;AmqpProvider.onData but instead it calls&#160;AmqpProvider.onTransportError OR&#160;AmqpProvider.onTransportClosed and I can not see any handling of updating the state of&#160;BalancedProviderFuture object in&#160;onTransportError OR&#160;onTransportClosed method.&lt;/li&gt;
	&lt;li&gt;I am attaching some&#160;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13023488/13023488_logs.txt&quot; title=&quot;logs.txt attached to QPIDJMS-534&quot;&gt;logs.txt&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&#160;which shows some errors, these error came when the state of BalancedProviderFuture is not updated and sync mehod stuck forever.&lt;/li&gt;
	&lt;li&gt;Please note we are using URL -&#160;failover:(amqp://localhost:5672&lt;br/&gt;
 ,amqp://localhost:5682)?jms.sendTimeout=5000 and qpid version 0.42.0.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I have found two&#160;old tickets &lt;a href=&quot;https://issues.apache.org/jira/browse/QPIDJMS-458&quot; title=&quot;Potential race condition in JmsConnection.destroyResource&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPIDJMS-458&quot;&gt;&lt;del&gt;QPIDJMS-458&lt;/del&gt;&lt;/a&gt; &amp;amp;&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPIDJMS-464&quot; title=&quot;zero prefetch receive can hang if timeout reached whilst message is partially transferred&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPIDJMS-464&quot;&gt;&lt;del&gt;QPIDJMS-464&lt;/del&gt;&lt;/a&gt; which shows the similar issue, but I believe this issue is different and might needs to be fixed separately.&lt;/p&gt;

&lt;p&gt;Can someone please take a look at this as this becomes critical issue in our production environment and we don&apos;t have any option except restart of our services?&lt;/p&gt;</description>
                <environment></environment>
        <key id="13370019">QPIDJMS-534</key>
            <summary>BalancedProviderFuture.sync stuck forever during connection recovery</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="ravinirmal10">Ravi Nirmal</reporter>
                        <labels>
                    </labels>
                <created>Wed, 7 Apr 2021 09:18:56 +0000</created>
                <updated>Mon, 24 May 2021 15:00:10 +0000</updated>
                            <resolved>Tue, 27 Apr 2021 16:23:57 +0000</resolved>
                                    <version>0.42.0</version>
                                    <fixVersion>0.59.0</fixVersion>
                    <fixVersion>1.0.0</fixVersion>
                                    <component>qpid-jms-client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17327132" author="ravinirmal10" created="Thu, 22 Apr 2021 06:41:37 +0000"  >&lt;p&gt;Hi team, can someone please update on this ticket?&lt;/p&gt;

&lt;p&gt;cc - &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=robbie&quot; class=&quot;user-hover&quot; rel=&quot;robbie&quot;&gt;robbie&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17329143" author="gemmellr" created="Thu, 22 Apr 2021 14:15:34 +0000"  >&lt;p&gt;I didnt spot your initial report.&lt;/p&gt;

&lt;p&gt;It looks like its awaiting a session creation completing, you could perhaps look at the jms.requestTimeout option to break it out of waiting.&lt;/p&gt;

&lt;p&gt;One thought might be, what if anything changed in your env around your &apos;recently&apos; timeframe to provoke hitting this behaviour now (I&apos;m assuming you didn&apos;t start out with a ~2 year old client). &lt;/p&gt;

&lt;p&gt;There have been a bunch of releases in the subsequent couple years, I&apos;d also suggest trying them, as thats where any actual changes made around this would be going.&lt;/p&gt;</comment>
                            <comment id="17330007" author="ravinirmal10" created="Fri, 23 Apr 2021 06:13:52 +0000"  >&lt;p&gt;I quickly checked and it looks that&#160;jms.requestTimeout option can help here to release the blocked thread. We will incorporate that in our product along with proper handling of&#160;JmsOperationTimedOutException.&#160; Also, we will try to upgrade the qpid library with latest version.&lt;/p&gt;

&lt;p&gt;Regarding why we started seeing issue now:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Recently we didn&apos;t make changes in configuration for qpid as well as ActiveMQ, however recently we started seeing some network/transport issues between client(qpid) and server(ActiveMQ) and due to that we have seen the threads are blocking.&lt;/li&gt;
	&lt;li&gt;Without&#160;jms.requestTimeout option, if there is some network/transport related error occurs then the qpid is not able to unblock the thread. Basically it seems that while session creation if transport related error occurs then the FailOverProvider thread which is creating session gets blocked forever.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Thanks a lot &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=robbie&quot; class=&quot;user-hover&quot; rel=&quot;robbie&quot;&gt;robbie&lt;/a&gt;&#160;for your response.&#160;&lt;/p&gt;</comment>
                            <comment id="17333360" author="jira-bot" created="Tue, 27 Apr 2021 16:23:21 +0000"  >&lt;p&gt;Commit 8ab821db90506d5900c313260d6666fb8b6c0fe1 in qpid-jms&apos;s branch refs/heads/main from Timothy Bish&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=qpid-jms.git;h=8ab821d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=qpid-jms.git;h=8ab821d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPIDJMS-534&quot; title=&quot;BalancedProviderFuture.sync stuck forever during connection recovery&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPIDJMS-534&quot;&gt;&lt;del&gt;QPIDJMS-534&lt;/del&gt;&lt;/a&gt; Fail pending resource creation calls on connection drop&lt;/p&gt;

&lt;p&gt;Respond quickly to resource creation failures on connection drop instead&lt;br/&gt;
of waiting for a configured request timeout to avoid stuck calls to&lt;br/&gt;
create during reconnection processing.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13320365">QPIDJMS-514</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13023488" name="logs.txt" size="7670" author="ravinirmal10" created="Wed, 7 Apr 2021 09:42:06 +0000"/>
                            <attachment id="13023494" name="thread-dump.txt" size="25883" author="ravinirmal10" created="Wed, 7 Apr 2021 10:03:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 28 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0plwg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>