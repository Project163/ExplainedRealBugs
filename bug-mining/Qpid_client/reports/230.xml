<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:18:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[QPIDJMS-473] failure handling CompletionListener when using fallback anonymous producers</title>
                <link>https://issues.apache.org/jira/browse/QPIDJMS-473</link>
                <project id="12314524" key="QPIDJMS">Qpid JMS</project>
                    <description>&lt;p&gt;When a server does not offer support for the &apos;anonymous relay&apos; capability, the client falls back to opening and closing links to satisfy send requests for anonymous producers (i.e JMSProducer instances, and MessageProducers created without a destination). The fallback mechanism does not currently account for use of a CompletionListener during the send, and so fails to notify it. It should be updated to handle usage of a CompletionListener.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;============&lt;/p&gt;

&lt;p&gt;Original Description:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;When I configure a completion listener and send 50 messages rapidly asynchronous I hit a race condition.&lt;/p&gt;

&lt;p&gt;Debugging the code proves that the envelope has not been placed on asyncSendQueue at the time the very first send completion arrives.&lt;/p&gt;

&lt;p&gt;This results in JmsSession line 1518 within the private AsyncCompletionTask class:&lt;/p&gt;

&lt;p&gt;SendCompletion completion = &lt;font color=&quot;#660e7a&quot;&gt;asyncSendQueue&lt;/font&gt;.peek();&lt;/p&gt;

&lt;p&gt;Returning &lt;b&gt;null&lt;/b&gt; , as the asyncSendQueue does not yet contain the completion as it&apos;s still being populated in the other thread!&lt;/p&gt;

&lt;p&gt;The resulting null pointer exception is logged as a DEBUG message (!!! bad this should be a clear ERROR log with stack trace, it should never happen but if it does don&apos;t hide it this way !!!)&lt;/p&gt;

&lt;p&gt;Enabling debug logging then shows:&lt;/p&gt;

&lt;p&gt;2019-09-19_03:53:00.526-DEBUG-[JmsSession &lt;span class=&quot;error&quot;&gt;&amp;#91;ID:811574d5-f47c-4dd3-82e9-c4aa4ce1d9b9:1:1&amp;#93;&lt;/span&gt; completion dispatcher]-Send completion task encounted unexpected error: null {org.apache.qpid.jms.JmsSession:1567}&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Another comment on the logging style, the exception should be logged not ex.getMessage() !! (you can&apos;t see from the log that it&apos;s an NPE this way).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Line 1567:&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#660e7a&quot;&gt;LOG&lt;/font&gt;.debug(&lt;font color=&quot;#008000&quot;&gt;&quot;Send completion task encounted unexpected error: {}&quot;&lt;/font&gt;, ex.getMessage());&lt;/p&gt;

&lt;p&gt;--&amp;gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#660e7a&quot;&gt;LOG&lt;/font&gt;.debug(&lt;font color=&quot;#008000&quot;&gt;&quot;Send completion task encounted unexpected error&quot;&lt;/font&gt;, ex);&lt;/p&gt;

&lt;p&gt;(never assume getMessage() contains relevant data, log the stack unless 100% sure the exception is known and self descriptive but when are you 100% sure about such?)&lt;/p&gt;

&lt;p&gt;The problem is triggered by the design of the code at line 951:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#000080&quot;&gt;if &lt;/font&gt;(envelope.isCompletionRequired()) {&lt;br/&gt;
 &lt;font color=&quot;#660e7a&quot;&gt;transactionContext&lt;/font&gt;.send(&lt;font color=&quot;#660e7a&quot;&gt;connection&lt;/font&gt;, envelope, &lt;font color=&quot;#000080&quot;&gt;new &lt;/font&gt;ProviderSynchronization() {&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#808000&quot;&gt;@Override&lt;/font&gt; &lt;font color=&quot;#000080&quot;&gt;public void &lt;/font&gt;onPendingSuccess() {&lt;br/&gt;
 &lt;font color=&quot;#808080&quot;&gt;// Provider accepted the send request so new we place the marker in&lt;/font&gt;&lt;font color=&quot;#808080&quot;&gt; // the queue so that it can be completed asynchronously.&lt;/font&gt; &lt;font color=&quot;#660e7a&quot;&gt;asyncSendQueue&lt;/font&gt;.addLast(&lt;font color=&quot;#000080&quot;&gt;new &lt;/font&gt;SendCompletion(&lt;font color=&quot;#660e7a&quot;&gt;envelope&lt;/font&gt;, &lt;font color=&quot;#660e7a&quot;&gt;listener&lt;/font&gt;));&lt;br/&gt;
 }&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#808000&quot;&gt;@Override&lt;/font&gt; &lt;font color=&quot;#000080&quot;&gt;public void &lt;/font&gt;onPendingFailure(ProviderException cause) {&lt;br/&gt;
 &lt;font color=&quot;#808080&quot;&gt;// Provider has rejected the send request so we will throw the&lt;/font&gt;&lt;font color=&quot;#808080&quot;&gt; // exception that is to follow so no completion will be needed.&lt;/font&gt; }&lt;br/&gt;
 });&lt;/p&gt;

&lt;p&gt;First the message is sent (and the sending is actually completed before the onPendingSuccess() is ever called!&lt;/p&gt;

&lt;p&gt;The design of this code should be changed to first record the outstanding send operation (so first do the asyncSendQueue.addLast) BEFORE sending the message.&lt;/p&gt;

&lt;p&gt;The method onPendingFailure can then implement logic to remove the SendCompletion from asyncSendQueue in the case the message could not be sent.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Windows 10/64&lt;/p&gt;

&lt;p&gt;Dell 5530 8 cores (possibly explaining why the send thread completes faster than the thread recording the SendComplete on the queue?)&lt;/p&gt;

&lt;p&gt;java 8&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</environment>
        <key id="13257553">QPIDJMS-473</key>
            <summary>failure handling CompletionListener when using fallback anonymous producers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="robbie">Robbie Gemmell</assignee>
                                    <reporter username="consultantleon">Consultant Leon</reporter>
                        <labels>
                    </labels>
                <created>Thu, 19 Sep 2019 02:08:14 +0000</created>
                <updated>Tue, 1 Oct 2019 14:10:40 +0000</updated>
                            <resolved>Tue, 24 Sep 2019 16:53:28 +0000</resolved>
                                    <version>0.45.0</version>
                                    <fixVersion>0.46.0</fixVersion>
                                    <component>qpid-jms-client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16933021" author="consultantleon" created="Thu, 19 Sep 2019 03:06:49 +0000"  >&lt;p&gt;Attached a patch and can confirm that it resolves my issue sending 50 messages async to an azure service bus queue.&lt;/p&gt;

&lt;p&gt;Disappointed that it takes just as much time as sync sending - need to further investigate why I&apos;m only able to send ~ 2 msgs/second to azure sb.&lt;/p&gt;</comment>
                            <comment id="16933557" author="gemmellr" created="Thu, 19 Sep 2019 16:24:33 +0000"  >&lt;p&gt;Thanks for the report, we will take a look when we get a chance.&lt;/p&gt;

&lt;p&gt;From your note about performance, I suspect that you are using &apos;anonymous&apos; producers (either JMSProducer instances, or a MessageProducer created with null as the destination) and that Service Bus isnt advertising support for the &apos;ANONYMOUS-RELAY&apos; capability, meaning the client has to fall back to creating and closing a fixed-address sending link under the covers each time you do a send, which effectively means it is still doing synchronous sending. I suspect the issue is as much or more related to how that fallback process currently works than the placement of the callback queue updates in the higher level, as in the regular cases it wouldn&apos;t be possible to receive a disposition back before those steps are taken given they process in a single thread.&lt;/p&gt;

&lt;p&gt;Which is all to say, if you are using anonymous producer instances, you might instead try using fixed destination MessageProducer instances instead, which could both work around the issue and improve performance (first by not opening and closing links per send, and separately by allowing actual async sends on top).&lt;/p&gt;</comment>
                            <comment id="16936953" author="jira-bot" created="Tue, 24 Sep 2019 16:13:58 +0000"  >&lt;p&gt;Commit 519bbd010090ad1a2e4a4dec220540a32bafd7d3 in qpid-jms&apos;s branch refs/heads/master from Robert Gemmell&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=qpid-jms.git;h=519bbd0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=qpid-jms.git;h=519bbd0&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPIDJMS-473&quot; title=&quot;failure handling CompletionListener when using fallback anonymous producers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPIDJMS-473&quot;&gt;&lt;del&gt;QPIDJMS-473&lt;/del&gt;&lt;/a&gt;: remove unused + incomplete anonymous fallback cache fragments&lt;/p&gt;</comment>
                            <comment id="16936954" author="jira-bot" created="Tue, 24 Sep 2019 16:14:00 +0000"  >&lt;p&gt;Commit 458e6de93f89cad1e9a75df5607c8a77a234d787 in qpid-jms&apos;s branch refs/heads/master from Robert Gemmell&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=qpid-jms.git;h=458e6de&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=qpid-jms.git;h=458e6de&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPIDJMS-473&quot; title=&quot;failure handling CompletionListener when using fallback anonymous producers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPIDJMS-473&quot;&gt;&lt;del&gt;QPIDJMS-473&lt;/del&gt;&lt;/a&gt;: avoid passing conflicting sync + completion-required flags to the anonymous fallback producer&lt;/p&gt;</comment>
                            <comment id="16936955" author="jira-bot" created="Tue, 24 Sep 2019 16:14:01 +0000"  >&lt;p&gt;Commit 9cad42da6fae11811ec1aea140705b3c59ac88cd in qpid-jms&apos;s branch refs/heads/master from Robert Gemmell&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=qpid-jms.git;h=9cad42d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=qpid-jms.git;h=9cad42d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPIDJMS-473&quot; title=&quot;failure handling CompletionListener when using fallback anonymous producers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPIDJMS-473&quot;&gt;&lt;del&gt;QPIDJMS-473&lt;/del&gt;&lt;/a&gt;: improve handling/logging of exceptions during async completion&lt;/p&gt;</comment>
                            <comment id="16936979" author="gemmellr" created="Tue, 24 Sep 2019 16:53:19 +0000"  >&lt;p&gt;The above changes get the sends working with a CompletionListener when using the fallback anonymous producer mechanism.&lt;/p&gt;

&lt;p&gt;As noted earlier, it is still doing sychronous sends under the cover in that case. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish&quot; class=&quot;user-hover&quot; rel=&quot;tabish&quot;&gt;tabish&lt;/a&gt; has some ideas for improving the fallback mechanisms performance, but thats for a later release and would be its own JIRA. For now, see my earlier comment for routes to avoid the fallback being used for improved performance.&lt;/p&gt;</comment>
                            <comment id="16941854" author="consultantleon" created="Tue, 1 Oct 2019 13:38:52 +0000"  >&lt;p&gt;Thanks for the advise to try fixed destination MessageProducer, when I find some time I&apos;d like to see if that improves throughput as the current results are rather disappointing. I&apos;m not otherwise familiar with the specifics of the qpid jms library except for hunting down this particular that blocked our implementation. (our component is supported on many JMS implementations, maybe other implementations also benefit from fixed destination MessageProducer&apos;s - some benchmark will be needed!)&lt;/p&gt;</comment>
                            <comment id="16941880" author="gemmellr" created="Tue, 1 Oct 2019 14:10:40 +0000"  >&lt;p&gt;Some more outline for you and anyone else reading later&lt;/p&gt;

&lt;p&gt;In AMQP 1.0 sending/receiving links are opened to specific node addresses, e.g to a queue using its name. For &apos;anonymous&apos; producer cases (either a MessageProducer created with null as the destination, or the &apos;light weight&apos; JMSProducer instances) the address of the destination isnt known until the point of send occuring. An extension mechanism was created to allow for a single sending link to be created to an &apos;anonymous relay&apos;, to be used for multiple destinations where each message sent carries its actual destination. For servers that dont advertise support of this functionality, the client has a fallback mechanism so that these &apos;anonymous producer&apos; scenarios could at least still work, albeit more slowly. It would seem ServiceBus does not advertise &apos;anonymous relay&apos; support and so you ended up using the fallback mechanism, and in concert with that you hit a bug in the JMS 2.0 additions made since it was created and that we hadn&apos;t yet come across, due to mainly using servers that do advertise the support.&lt;/p&gt;

&lt;p&gt;0.46.0 resolves the bug, and &lt;a href=&quot;https://issues.apache.org/jira/browse/QPIDJMS-476&quot; title=&quot;Improve send performance of anonymous fallback producer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPIDJMS-476&quot;&gt;&lt;del&gt;QPIDJMS-476&lt;/del&gt;&lt;/a&gt; now has the mentioned improvements around increasing perf of the fallback mechanism.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12980666" name="fix_QPID-JMS-473_race_condition_where_SendCompletion_was_not_placed_on_asyncSendQueue_befo.patch" size="4082" author="consultantleon" created="Thu, 19 Sep 2019 03:05:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 6 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z06siw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>