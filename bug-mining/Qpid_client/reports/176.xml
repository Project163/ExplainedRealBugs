<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:18:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[QPIDJMS-365] failover.reconnectDelay not applied between attempts if peer remote-closes during connection</title>
                <link>https://issues.apache.org/jira/browse/QPIDJMS-365</link>
                <project id="12314524" key="QPIDJMS">Qpid JMS</project>
                    <description>&lt;p&gt;When using Broker-J&apos;s High Availability feature, the client&apos;s failover abilities are used to allow the client to discover which Broker in the HA group has the master role.  The client tries each Broker on the failover list until until one successfully responds to the &lt;tt&gt;Open&lt;/tt&gt; indicating that it is current master.&lt;/p&gt;

&lt;p&gt;When a node is not in the master role, it gracefully closes the AMQP connection by sending a &lt;tt&gt;Close&lt;/tt&gt; performative.  During election periods, it is normal for all nodes in the HA group to respond with the &lt;tt&gt;Close&lt;/tt&gt; until the election concludes.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Close{error=Error{condition=amqp:not-found, description=&apos;Virtual host &apos;localhost&apos; is not active&apos;, info=null}}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;The QpidJMS Client failover options includes a &lt;tt&gt;failover.reconnectDelay&lt;/tt&gt; which &quot;Controls the delay between successive reconnection attempts&quot;.   However it appears that the reconnection delay is only applied between attempts when a connection fails owing to a &apos;transport&apos; level failure (connection refused etc).  If the connection fails at the AMQP level, the delay is not applied.&lt;/p&gt;

&lt;p&gt;This is impactful to the HA use-case for Broker-J.   It means that during periods of reelection, the client, tightly spins in the reconnection loop, excessively consuming system resources.  It is also necessary to ensure that &lt;tt&gt;failover.maxReconnectAttempts&lt;/tt&gt; is set sufficiently large to allow for an election period to conclude successfully.  Whilst the user could use unlimited reconnection attempts, this is unpleasant as it means the system won&apos;t fail in the case where the election does not conclude within a reasonable time period.&lt;/p&gt;

&lt;p&gt;Extract of TRACE level logging from &lt;tt&gt;org.apache.qpid.jms.provider.failover.FailoverProvider&lt;/tt&gt; for the case when a AMQP connection is closed gracefully (&lt;tt&gt;Close&lt;/tt&gt; performative):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2018-03-13 11:04:54,951 [lization thread] - DEBUG FailoverProvider               - Failover: the provider reports failure: Connection closed by external action [condition = amqp:connection:forced]
2018-03-13 11:04:54,951 [lization thread] - DEBUG FailoverProvider               - handling Provider failure: Connection closed by external action [condition = amqp:connection:forced]
2018-03-13 11:04:54,951 [lization thread] - TRACE FailoverProvider               - stack
java.io.IOException: Connection closed by external action [condition = amqp:connection:forced]
	at org.apache.qpid.jms.util.IOExceptionSupport.create(IOExceptionSupport.java:45)
	at org.apache.qpid.jms.provider.amqp.AmqpProvider.fireProviderException(AmqpProvider.java:1086)
	at org.apache.qpid.jms.provider.amqp.AmqpAbstractResource.closeResource(AmqpAbstractResource.java:182)
	at org.apache.qpid.jms.provider.amqp.AmqpAbstractResource.processRemoteClose(AmqpAbstractResource.java:262)
	at org.apache.qpid.jms.provider.amqp.AmqpProvider.processUpdates(AmqpProvider.java:949)
	at org.apache.qpid.jms.provider.amqp.AmqpProvider.access$1900(AmqpProvider.java:104)
	at org.apache.qpid.jms.provider.amqp.AmqpProvider$17.run(AmqpProvider.java:831)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:180)
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at java.lang.Thread.run(Thread.java:748)
Caused by: javax.jms.JMSException: Connection closed by external action [condition = amqp:connection:forced]
	at org.apache.qpid.jms.provider.amqp.AmqpSupport.convertToException(AmqpSupport.java:164)
	at org.apache.qpid.jms.provider.amqp.AmqpSupport.convertToException(AmqpSupport.java:117)
	... 11 more
2018-03-13 11:04:54,954 [ connect thread] - DEBUG FailoverProvider               - Connection attempt:[1] to: amqp://localhost:5672 in-progress
2018-03-13 11:04:55,003 [lization thread] - DEBUG FailoverProvider               - Signalling connection recovery: AmqpProvider: localhost:5672
2018-03-13 11:04:55,007 [lization thread] - DEBUG FailoverProvider               - handling Provider failure: Virtual host &apos;localhost&apos; is not active [condition = amqp:not-found]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Extract of TRACE level logging from &lt;tt&gt;org.apache.qpid.jms.provider.failover.FailoverProvider&lt;/tt&gt; for the case when a AMQP connection is closed at the transport level (Connection Refused):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2018-03-13 11:03:47,069 [lization thread] - TRACE FailoverProvider               - stack
java.io.IOException: Transport connection remotely closed.
	at org.apache.qpid.jms.provider.amqp.AmqpProvider$20.run(AmqpProvider.java:901)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:180)
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at java.lang.Thread.run(Thread.java:748)
2018-03-13 11:03:47,089 [ connect thread] - DEBUG FailoverProvider               - Connection attempt:[1] to: amqp://localhost:5672 in-progress
2018-03-13 11:03:47,095 [ connect thread] - INFO  FailoverProvider               - Connection attempt:[1] to: amqp://localhost:5672 failed
2018-03-13 11:03:47,095 [ connect thread] - TRACE FailoverProvider               - Next reconnect attempt will be in 10000 milliseconds
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13144691">QPIDJMS-365</key>
            <summary>failover.reconnectDelay not applied between attempts if peer remote-closes during connection</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="kwall">Keith Wall</reporter>
                        <labels>
                    </labels>
                <created>Tue, 13 Mar 2018 11:28:59 +0000</created>
                <updated>Mon, 2 Apr 2018 15:51:08 +0000</updated>
                            <resolved>Fri, 16 Mar 2018 17:51:57 +0000</resolved>
                                                    <fixVersion>0.31.0</fixVersion>
                                    <component>qpid-jms-client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16397385" author="gemmellr" created="Tue, 13 Mar 2018 18:00:31 +0000"  >&lt;p&gt;I was able to reproduce this in a test and look into why it occurs, its just the interim failures that play into it rather than the initial one. I noticed a potential ultra-hacky change, but it&apos;ll need some thought on how to address properly.&lt;/p&gt;</comment>
                            <comment id="16399132" author="jira-bot" created="Wed, 14 Mar 2018 19:05:22 +0000"  >&lt;p&gt;Commit daec046413b349f7187ed8490b9a6376c581c848 in qpid-jms&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=qpid-jms.git;h=daec046&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=qpid-jms.git;h=daec046&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPIDJMS-365&quot; title=&quot;failover.reconnectDelay not applied between attempts if peer remote-closes during connection&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPIDJMS-365&quot;&gt;&lt;del&gt;QPIDJMS-365&lt;/del&gt;&lt;/a&gt; Correct failover reconnect delays when remote closes&lt;/p&gt;

&lt;p&gt;Remember reconnect delay state until the connection is fully reconnected&lt;br/&gt;
to avoid restarting delay processing when the remote closes cleanly&lt;br/&gt;
after an initial open attempt due to some condition on the remote.  Adds&lt;br/&gt;
additional error handling and logging as well as some refactoring of the&lt;br/&gt;
overall reconnect handling logic.&lt;/p&gt;</comment>
                            <comment id="16401102" author="jira-bot" created="Thu, 15 Mar 2018 20:49:50 +0000"  >&lt;p&gt;Commit 33978120535a45fa30ae3b01749cda886d56a7b4 in qpid-jms&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=qpid-jms.git;h=3397812&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=qpid-jms.git;h=3397812&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPIDJMS-365&quot; title=&quot;failover.reconnectDelay not applied between attempts if peer remote-closes during connection&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPIDJMS-365&quot;&gt;&lt;del&gt;QPIDJMS-365&lt;/del&gt;&lt;/a&gt; Prevent multiple reconnect tasks from being triggered&lt;/p&gt;

&lt;p&gt;Ensure that the reconnect handler doesn&apos;t queue up a new attempt by&lt;br/&gt;
mistake when handling potential errors.&lt;/p&gt;</comment>
                            <comment id="16401399" author="jira-bot" created="Fri, 16 Mar 2018 02:40:46 +0000"  >&lt;p&gt;Commit bb7b596bbed768b3e3cf03a02a8951b7fdd6d686 in qpid-jms&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=qpid-jms.git;h=bb7b596&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=qpid-jms.git;h=bb7b596&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPIDJMS-365&quot; title=&quot;failover.reconnectDelay not applied between attempts if peer remote-closes during connection&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPIDJMS-365&quot;&gt;&lt;del&gt;QPIDJMS-365&lt;/del&gt;&lt;/a&gt; Ensure failed provider is cleared if close fails&lt;/p&gt;</comment>
                            <comment id="16402173" author="jira-bot" created="Fri, 16 Mar 2018 16:50:17 +0000"  >&lt;p&gt;Commit d12430f9b6b60abbbd8c7f1a24b08928dbfafab7 in qpid-jms&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=qpid-jms.git;h=d12430f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=qpid-jms.git;h=d12430f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPIDJMS-365&quot; title=&quot;failover.reconnectDelay not applied between attempts if peer remote-closes during connection&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPIDJMS-365&quot;&gt;&lt;del&gt;QPIDJMS-365&lt;/del&gt;&lt;/a&gt; Polish the logging a bit and prevent edge case NPE&lt;/p&gt;</comment>
                            <comment id="16405334" author="k-wall" created="Mon, 19 Mar 2018 19:44:50 +0000"  >&lt;p&gt;I reran the tests that caused me to discover this defect. &#160;I confirm that this defect is resolved. &#160;Thanks for the speedy resolution.&lt;/p&gt;</comment>
                            <comment id="16409408" author="jira-bot" created="Thu, 22 Mar 2018 11:41:41 +0000"  >&lt;p&gt;Commit 610ffe2aa5f66a6b1125612e07cbfdfc496963ec in qpid-jms&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gemmellr&quot; class=&quot;user-hover&quot; rel=&quot;gemmellr&quot;&gt;gemmellr&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=qpid-jms.git;h=610ffe2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=qpid-jms.git;h=610ffe2&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPIDJMS-365&quot; title=&quot;failover.reconnectDelay not applied between attempts if peer remote-closes during connection&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPIDJMS-365&quot;&gt;&lt;del&gt;QPIDJMS-365&lt;/del&gt;&lt;/a&gt;: restore previously existing test to earlier condition&lt;/p&gt;</comment>
                            <comment id="16409409" author="jira-bot" created="Thu, 22 Mar 2018 11:41:43 +0000"  >&lt;p&gt;Commit b37200f45cdbfdf541ddd7221696f1ffe28a73cd in qpid-jms&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gemmellr&quot; class=&quot;user-hover&quot; rel=&quot;gemmellr&quot;&gt;gemmellr&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=qpid-jms.git;h=b37200f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=qpid-jms.git;h=b37200f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPIDJMS-365&quot; title=&quot;failover.reconnectDelay not applied between attempts if peer remote-closes during connection&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPIDJMS-365&quot;&gt;&lt;del&gt;QPIDJMS-365&lt;/del&gt;&lt;/a&gt;: add the new test back again&lt;/p&gt;</comment>
                            <comment id="16422650" author="jira-bot" created="Mon, 2 Apr 2018 15:51:08 +0000"  >&lt;p&gt;Commit b22a1e7ad898992a60ffb8ef2c66f58735d8ba1e in qpid-broker-j&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alex.rufous&quot; class=&quot;user-hover&quot; rel=&quot;alex.rufous&quot;&gt;alex.rufous&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=qpid-broker-j.git;h=b22a1e7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=qpid-broker-j.git;h=b22a1e7&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;NO-JIRA: &lt;span class=&quot;error&quot;&gt;&amp;#91;Broker-J&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;System Tests&amp;#93;&lt;/span&gt; Remove workaround for qpid jms client not respecting reconnectDelay (&lt;a href=&quot;https://issues.apache.org/jira/browse/QPIDJMS-365&quot; title=&quot;failover.reconnectDelay not applied between attempts if peer remote-closes during connection&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPIDJMS-365&quot;&gt;&lt;del&gt;QPIDJMS-365&lt;/del&gt;&lt;/a&gt;)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 32 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3r87z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>