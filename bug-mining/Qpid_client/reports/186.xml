<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:18:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[QPIDJMS-366] session commit hangs if server remote-closes and failover.maxReconnectAttempts is exhausted</title>
                <link>https://issues.apache.org/jira/browse/QPIDJMS-366</link>
                <project id="12314524" key="QPIDJMS">Qpid JMS</project>
                    <description>&lt;p&gt;If failover occurs whilst a JMS commit is in-flight, and that failover exhausts its &lt;tt&gt;failover.maxReconnectAttempts&lt;/tt&gt; the JMS commit call is seen to hang forever.  This problem manifests when the connection attempts are failing with a graceful &lt;tt&gt;Close&lt;/tt&gt; from the peer.  If the connection failure is at a &apos;transport&apos; level (e.g. Connection refused) the problem does not appear.&lt;/p&gt;

&lt;p&gt;Reproduction:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Start Broker-J 7.0.2&lt;/li&gt;
	&lt;li&gt;Go to &lt;a href=&quot;http://localhost:8080&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8080&lt;/a&gt;, double click on virtualhost &lt;tt&gt;default&lt;/tt&gt; in the virtualhost table to open the virtualhost tab.&lt;/li&gt;
	&lt;li&gt;Create queue &lt;tt&gt;queue&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Start IDE with qpid-jms project open (master today - 7e7cebe5)&lt;/li&gt;
	&lt;li&gt;Apply HelloWorld patch attached to this JIRA&lt;/li&gt;
	&lt;li&gt;Put a breakpoint in &lt;tt&gt;org.apache.qpid.jms.provider.amqp.AmqpProvider#commit&lt;/tt&gt; line 693 (i.e. the closing brace of the try/catch the statement immediately following the pumpToProton())&lt;/li&gt;
	&lt;li&gt;Run HelloWorld with attached patch applied under the debugger&lt;/li&gt;
	&lt;li&gt;Once the breakpoint is reached, use the console to stop the virtualhost.  Do this by clicking the &lt;tt&gt;Stop&lt;/tt&gt; button on the virtualhost tab.&lt;/li&gt;
	&lt;li&gt;Resume the debugger&lt;/li&gt;
	&lt;li&gt;Expected : once failover attempts are exhausted, the JMS &lt;tt&gt;commit()&lt;/tt&gt; call should end with an exception - Actual: &lt;tt&gt;commit()&lt;/tt&gt; continues to hang indefinitely.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The blocked main thread looks like this:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;main@1&quot; prio=5 tid=0x1 nid=NA waiting
  java.lang.Thread.State: WAITING
	  at sun.misc.Unsafe.park(Unsafe.java:-1)
	  at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
	  at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:836)
	  at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedInterruptibly(AbstractQueuedSynchronizer.java:997)
	  at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(AbstractQueuedSynchronizer.java:1304)
	  at java.util.concurrent.CountDownLatch.await(CountDownLatch.java:231)
	  at org.apache.qpid.jms.provider.ProviderFuture.sync(ProviderFuture.java:103)
	  at org.apache.qpid.jms.JmsConnection.commit(JmsConnection.java:766)
	  at org.apache.qpid.jms.JmsLocalTransactionContext.commit(JmsLocalTransactionContext.java:171)
	  at org.apache.qpid.jms.JmsSession.commit(JmsSession.java:227)
	  at org.apache.qpid.jms.example.HelloWorld.main(HelloWorld.java:61)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13144728">QPIDJMS-366</key>
            <summary>session commit hangs if server remote-closes and failover.maxReconnectAttempts is exhausted</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="kwall">Keith Wall</reporter>
                        <labels>
                    </labels>
                <created>Tue, 13 Mar 2018 13:31:12 +0000</created>
                <updated>Mon, 26 Mar 2018 10:14:23 +0000</updated>
                            <resolved>Wed, 21 Mar 2018 12:40:38 +0000</resolved>
                                                    <fixVersion>0.31.0</fixVersion>
                                    <component>qpid-jms-client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16405339" author="k-wall" created="Mon, 19 Mar 2018 19:48:17 +0000"  >&lt;p&gt;With the work of &lt;a href=&quot;https://issues.apache.org/jira/browse/QPIDJMS-365&quot; title=&quot;failover.reconnectDelay not applied between attempts if peer remote-closes during connection&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPIDJMS-365&quot;&gt;&lt;del&gt;QPIDJMS-365&lt;/del&gt;&lt;/a&gt;, I still see this issue, but the internals look different. &#160; It seems like failover loops forever, regardless of &lt;tt&gt;failover.maxReconnectAttempts&lt;/tt&gt;. &#160;I can provide more details if required.&lt;/p&gt;</comment>
                            <comment id="16405344" author="tabish121" created="Mon, 19 Mar 2018 19:55:01 +0000"  >&lt;p&gt;I&apos;ve tried to reproduce it but had no luck.&#160; A test or some supporting logs would be helpful&lt;/p&gt;</comment>
                            <comment id="16405443" author="jira-bot" created="Mon, 19 Mar 2018 21:02:39 +0000"  >&lt;p&gt;Commit 3e8061b448d934fbc5dab0e2d7119125e06c2265 in qpid-jms&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=qpid-jms.git;h=3e8061b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=qpid-jms.git;h=3e8061b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPIDJMS-366&quot; title=&quot;session commit hangs if server remote-closes and failover.maxReconnectAttempts is exhausted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPIDJMS-366&quot;&gt;&lt;del&gt;QPIDJMS-366&lt;/del&gt;&lt;/a&gt; Add a test of no response to TX commit and remote close&lt;/p&gt;

&lt;p&gt;Test that failover send commit failed on remote close when commit is&lt;br/&gt;
pending.&lt;/p&gt;</comment>
                            <comment id="16405496" author="k-wall" created="Mon, 19 Mar 2018 21:42:35 +0000"  >&lt;p&gt;Please find attached log. &#160;I am reproducing the problem exactly as described above except that I am testing with master now (4b022971b7461ebaefe12161358e03c0af9b590a). &#160; I note that since the changes made by &lt;a href=&quot;https://issues.apache.org/jira/browse/QPIDJMS-365&quot; title=&quot;failover.reconnectDelay not applied between attempts if peer remote-closes during connection&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPIDJMS-365&quot;&gt;&lt;del&gt;QPIDJMS-365&lt;/del&gt;&lt;/a&gt;, failover for this case seems to continue indefinitely (i.e. ignores the&#160;failover.maxReconnectAttempts=2 in my connection url).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16407132" author="jira-bot" created="Tue, 20 Mar 2018 22:15:37 +0000"  >&lt;p&gt;Commit 054e24c5836ffda370e711d2c89b6f35853be939 in qpid-jms&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=qpid-jms.git;h=054e24c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=qpid-jms.git;h=054e24c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPIDJMS-366&quot; title=&quot;session commit hangs if server remote-closes and failover.maxReconnectAttempts is exhausted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPIDJMS-366&quot;&gt;&lt;del&gt;QPIDJMS-366&lt;/del&gt;&lt;/a&gt; Ensure failover honoers maxReconnectAttempts&lt;/p&gt;

&lt;p&gt;Fix case when stuck in repeating remote close cycle the failover&lt;br/&gt;
transport can ignore the max reconnect limit&lt;/p&gt;</comment>
                            <comment id="16407135" author="tabish121" created="Tue, 20 Mar 2018 22:16:17 +0000"  >&lt;p&gt;This should be resolved now if you want to give it another test using the current master.&lt;/p&gt;</comment>
                            <comment id="16407797" author="k-wall" created="Wed, 21 Mar 2018 12:15:09 +0000"  >&lt;p&gt;Commit&#160;&lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=qpid-jms.git;h=054e24c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;054e24c&lt;/a&gt;&#160;did indeed resolve the issue, but I quickly discovered a closely related problem. &#160;If the &lt;b&gt;initial&lt;/b&gt;&#160;connection attempt to the peer ends with a graceful close, then I see the client&apos;s failover spin indefinitely:&#160;&lt;tt&gt;failover.maxReconnectAttempts&lt;/tt&gt;, &lt;tt&gt;failover.startupMaxReconnectAttempts&lt;/tt&gt;  and &lt;tt&gt;failover.reconnectDelay&lt;/tt&gt; are ignored.   To reproduce, I have moved step 8 in my list in this JIRA&apos;s description to after step 3.&lt;/p&gt;

&lt;p&gt;I attach a log.&lt;/p&gt;
</comment>
                            <comment id="16407833" author="tabish121" created="Wed, 21 Mar 2018 12:40:38 +0000"  >&lt;p&gt;The reported issue has been resolved.&#160; Please open a new issue to cover the newly reported problems and provide detailed instructions to reproduce along with any supporting logs or reproducer tests&lt;/p&gt;</comment>
                            <comment id="16409474" author="jira-bot" created="Thu, 22 Mar 2018 12:54:07 +0000"  >&lt;p&gt;Commit 7da7a3d0ec81f5a32a9976315273900db0425146 in qpid-jms&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gemmellr&quot; class=&quot;user-hover&quot; rel=&quot;gemmellr&quot;&gt;gemmellr&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=qpid-jms.git;h=7da7a3d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=qpid-jms.git;h=7da7a3d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPIDJMS-366&quot; title=&quot;session commit hangs if server remote-closes and failover.maxReconnectAttempts is exhausted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPIDJMS-366&quot;&gt;&lt;del&gt;QPIDJMS-366&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/QPIDJMS-369&quot; title=&quot;Failover doesn&amp;#39;t apply max reconnect attempts on initial connect when remote is closing on the Open frame&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPIDJMS-369&quot;&gt;&lt;del&gt;QPIDJMS-369&lt;/del&gt;&lt;/a&gt;: fix final peer shutdown and non-use verification&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12915473" name="054e24_qpid366_initalconnattemptfailsgracefully.log" size="728023" author="kwall" created="Wed, 21 Mar 2018 12:18:39 +0000"/>
                            <attachment id="12915211" name="4b02297_qpid-366.log" size="69186" author="kwall" created="Mon, 19 Mar 2018 21:44:18 +0000"/>
                            <attachment id="12914268" name="HelloWorld.patch" size="3355" author="kwall" created="Tue, 13 Mar 2018 13:32:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 34 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3r8g7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>