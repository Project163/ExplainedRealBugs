<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:18:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[QPIDJMS-239] Client ack session occasionally seen to redeliver recovered messages out of order</title>
                <link>https://issues.apache.org/jira/browse/QPIDJMS-239</link>
                <project id="12314524" key="QPIDJMS">Qpid JMS</project>
                    <description>&lt;p&gt;Test org.apache.qpid.test.unit.ack.RecoverTest#testOrderingWithAsyncConsumer &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; fails occasional when run against the Java Broker.  The test publishes a number of messages then uses an async message listener to consume them. For each message, the message listener recovers the session five times before finally acknowledging the message, then the cycle repeats.  In failure case, I see the Qpid JMS Client delivery an unexpected message to the application after a sequence of expected.&lt;/p&gt;

&lt;p&gt;We have seen the failure on the Apache CI and I can reproduce the problem on my laptop (every 15-20 runs of the test).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://builds.apache.org/view/M-R/view/Qpid/job/Qpid-Java-Java-MMS-1.0/40/artifact/trunk/systests/target/surefire-reports/java-mms.1-0/TEST-org.apache.qpid.test.unit.ack.RecoverTest.testOrderingWithAsyncConsumer.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/view/M-R/view/Qpid/job/Qpid-Java-Java-MMS-1.0/40/artifact/trunk/systests/target/surefire-reports/java-mms.1-0/TEST-org.apache.qpid.test.unit.ack.RecoverTest.testOrderingWithAsyncConsumer.txt&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I have reproduced locally against 0.20.0 too.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13028424">QPIDJMS-239</key>
            <summary>Client ack session occasionally seen to redeliver recovered messages out of order</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="kwall">Keith Wall</reporter>
                        <labels>
                    </labels>
                <created>Thu, 15 Dec 2016 16:05:58 +0000</created>
                <updated>Wed, 2 Oct 2019 19:22:36 +0000</updated>
                            <resolved>Fri, 24 Feb 2017 14:07:35 +0000</resolved>
                                    <version>0.11.0</version>
                    <version>0.20.0</version>
                                                    <component>qpid-jms-client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15751756" author="k-wall" created="Thu, 15 Dec 2016 16:13:04 +0000"  >&lt;p&gt;I&apos;ve attached two examples.  The pattern I see can be summarised with a grep.  The point the unexpected message appears seems to vary.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;grep &apos;delivery dispatcher&apos; TEST-org.apache.qpid.test.unit.ack.RecoverTest.testOrderingWithAsyncConsumer_0.20.0.txt
2016-12-15 15:58:48,531         DEBUG [JmsSession [ID:f702629f-cc27-4366-87a7-55c52282b0cf:1:1] delivery dispatcher] o.a.q.t.u.a.RecoverTest Ignoring message 0 and calling recover
2016-12-15 15:58:48,532         DEBUG [JmsSession [ID:f702629f-cc27-4366-87a7-55c52282b0cf:1:1] delivery dispatcher] o.a.q.t.u.a.RecoverTest Ignoring message 0 and calling recover
2016-12-15 15:58:48,533         DEBUG [JmsSession [ID:f702629f-cc27-4366-87a7-55c52282b0cf:1:1] delivery dispatcher] o.a.q.t.u.a.RecoverTest Ignoring message 0 and calling recover
2016-12-15 15:58:48,533         DEBUG [JmsSession [ID:f702629f-cc27-4366-87a7-55c52282b0cf:1:1] delivery dispatcher] o.a.q.t.u.a.RecoverTest Ignoring message 0 and calling recover
2016-12-15 15:58:48,534         DEBUG [JmsSession [ID:f702629f-cc27-4366-87a7-55c52282b0cf:1:1] delivery dispatcher] o.a.q.t.u.a.RecoverTest Ignoring message 0 and calling recover
2016-12-15 15:58:48,536         DEBUG [JmsSession [ID:f702629f-cc27-4366-87a7-55c52282b0cf:1:1] delivery dispatcher] o.a.q.t.u.a.RecoverTest Acknowledging message 0
2016-12-15 15:58:48,537         DEBUG [JmsSession [ID:f702629f-cc27-4366-87a7-55c52282b0cf:1:1] delivery dispatcher] o.a.q.t.u.a.RecoverTest Ignoring message 1 and calling recover
2016-12-15 15:58:48,540         DEBUG [JmsSession [ID:f702629f-cc27-4366-87a7-55c52282b0cf:1:1] delivery dispatcher] o.a.q.t.u.a.RecoverTest Ignoring message 1 and calling recover
2016-12-15 15:58:48,542         DEBUG [JmsSession [ID:f702629f-cc27-4366-87a7-55c52282b0cf:1:1] delivery dispatcher] o.a.q.t.u.a.RecoverTest Ignoring message 1 and calling recover
# Qpid JMS Client delivers 7th message rather than redelivering the 1st
2016-12-15 15:58:48,546         ERROR [JmsSession [ID:f702629f-cc27-4366-87a7-55c52282b0cf:1:1] delivery dispatcher] o.a.q.t.u.InternalBrokerHolder Uncaught exception from thread JmsSession [ID:f702629f-cc27-4366-87a7-55c52282b0cf:1:1] delivery dispatcher
junit.framework.AssertionFailedError: Received Message Out Of Order expected:&amp;lt;1&amp;gt; but was:&amp;lt;7&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15755631" author="gemmellr" created="Fri, 16 Dec 2016 22:06:38 +0000"  >&lt;p&gt;I had a look at this and couldn&apos;t spot how it would happen or reproduce it with a variant of the test I made to isolate the consumer, either with the original counts or while massively increasing the number of messages and recovers used.&lt;/p&gt;

&lt;p&gt;Could you capture a failing log with the the clients protocol trace logging enabled, in case it can add something to the picture? Last bit on the page from &lt;a href=&quot;http://qpid.apache.org/releases/qpid-jms-0.11.1/docs/index.html#logging&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://qpid.apache.org/releases/qpid-jms-0.11.1/docs/index.html#logging&lt;/a&gt;. No rush as I&apos;m actually going to start my holiday now &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15761279" author="k-wall" created="Mon, 19 Dec 2016 14:22:53 +0000"  >&lt;p&gt;Please find attached (TEST-org.apache.qpid.test.unit.ack.RecoverTest.testOrderingWithAsyncConsumer_0.20.0_proton.txt).  On the surface, it appears that the client (or proton-j) is emitting an unexpected Disposition for a message that the application has not yet seen.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;{Disposition{role=RECEIVER, first=7, last=7, settled=true, state=Accepted{}, batchable=false} 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Let me know if you need anything else.&lt;/p&gt;</comment>
                            <comment id="15767611" author="jira-bot" created="Wed, 21 Dec 2016 17:22:32 +0000"  >&lt;p&gt;Commit 81fc0d9a029f297c385f163262821ae056fa5cdc in qpid-jms&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=qpid-jms.git;h=81fc0d9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=qpid-jms.git;h=81fc0d9&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPIDJMS-239&quot; title=&quot;Client ack session occasionally seen to redeliver recovered messages out of order&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPIDJMS-239&quot;&gt;&lt;del&gt;QPIDJMS-239&lt;/del&gt;&lt;/a&gt; Add a test against ActiveMQ based on the scenario described&lt;/p&gt;

&lt;p&gt;Adds a recover test based on the described scenario in the ActiveMQ test&lt;br/&gt;
suite to try and reproduce.&lt;/p&gt;</comment>
                            <comment id="15801839" author="jira-bot" created="Thu, 5 Jan 2017 16:48:59 +0000"  >&lt;p&gt;Commit 84c95aa1e1f5f9b43e32b490dcc1091b343cde3e in qpid-jms&apos;s branch refs/heads/master from Robert Gemmell&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=qpid-jms.git;h=84c95aa&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=qpid-jms.git;h=84c95aa&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPIDJMS-239&quot; title=&quot;Client ack session occasionally seen to redeliver recovered messages out of order&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPIDJMS-239&quot;&gt;&lt;del&gt;QPIDJMS-239&lt;/del&gt;&lt;/a&gt;: add test using the test peer&lt;/p&gt;</comment>
                            <comment id="15801866" author="gemmellr" created="Thu, 5 Jan 2017 16:57:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kwall&quot; class=&quot;user-hover&quot; rel=&quot;kwall&quot;&gt;kwall&lt;/a&gt; could you check if you see this with the ConsumerIntegrationTest#testRecoverOrderingWithAsyncConsumer test I&apos;ve added? Theres a repetitions toggle on the test itself you can use if you like. If you can, perhaps we can modify that to aid collecting more detail. I still can&apos;t see how it could manage this, and I haven&apos;t been able to reproduce it with either the original test, Tims version agaisnt ActiveMQ, or the brokerless one above.&lt;/p&gt;</comment>
                            <comment id="15811710" author="k-wall" created="Mon, 9 Jan 2017 12:56:39 +0000"  >&lt;p&gt;Sure, I&apos;ll try to do this in the next day to two.&lt;/p&gt;</comment>
                            <comment id="15812176" author="k-wall" created="Mon, 9 Jan 2017 16:33:30 +0000"  >&lt;p&gt;Running &lt;tt&gt;ConsumerIntegrationTest#testRecoverOrderingWithAsyncConsumer&lt;/tt&gt; does not reproduce the problem for me.  I reconfirmed I see the problem when running &lt;tt&gt;org.apache.qpid.test.unit.ack.RecoverTest#testOrderingWithAsyncConsumer&lt;/tt&gt; against trunk Java Broker with trunk qpid-jms-client.  I am on JDK 1.8.0_111 on a Mac.   I have seen the problem once on Apache CI.  I&apos;m happy to run with diagnostic patches in that helps us get to the bottom of this.&lt;/p&gt;
</comment>
                            <comment id="15872429" author="tabish121" created="Fri, 17 Feb 2017 20:03:11 +0000"  >&lt;p&gt;Pretty sure this is the underlying issue.  If you could retest with a snapshot build to confirm that&apos;d be great or wait until 0.21.0 which will have this fix.  &lt;a href=&quot;https://issues.apache.org/jira/browse/QPIDJMS-266&quot; title=&quot;Race on session start and message dispatch can deliver messages in wrong order&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPIDJMS-266&quot;&gt;&lt;del&gt;QPIDJMS-266&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15882744" author="k-wall" created="Fri, 24 Feb 2017 14:07:06 +0000"  >&lt;p&gt;Hi Tim,  Good news.  I haven&apos;t been able to reproduce the issue against the current 0.21.0-SNAPSHOT. I can reason that as org.apache.qpid.jms.JmsSession#recover internally temporarily stops the session, that  &lt;a href=&quot;https://issues.apache.org/jira/browse/QPIDJMS-266&quot; title=&quot;Race on session start and message dispatch can deliver messages in wrong order&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPIDJMS-266&quot;&gt;&lt;del&gt;QPIDJMS-266&lt;/del&gt;&lt;/a&gt; is almost certainly the root cause.   Thanks for chasing this one down.&lt;/p&gt;</comment>
                            <comment id="15882777" author="tabish121" created="Fri, 24 Feb 2017 14:25:06 +0000"  >&lt;p&gt;Great, thanks for closing the loop on this.  &lt;/p&gt;</comment>
                            <comment id="15882829" author="gemmellr" created="Fri, 24 Feb 2017 14:57:30 +0000"  >&lt;blockquote&gt;
&lt;p&gt;I can reason that as org.apache.qpid.jms.JmsSession#recover internally temporarily stops the session&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It didn&apos;t actually do that in 0.11.x or 0.20.0, but I agree &lt;a href=&quot;https://issues.apache.org/jira/browse/QPIDJMS-266&quot; title=&quot;Race on session start and message dispatch can deliver messages in wrong order&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPIDJMS-266&quot;&gt;&lt;del&gt;QPIDJMS-266&lt;/del&gt;&lt;/a&gt; is almost certainly the cause here - a difference between the additional tests we added here and the original is when they started the connection, which would explain why it never reproduced on those.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13044080">QPIDJMS-266</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12843431" name="TEST-org.apache.qpid.test.unit.ack.RecoverTest.testOrderingWithAsyncConsumer.txt" size="148145" author="kwall" created="Thu, 15 Dec 2016 16:07:35 +0000"/>
                            <attachment id="12843432" name="TEST-org.apache.qpid.test.unit.ack.RecoverTest.testOrderingWithAsyncConsumer_0.20.0.txt" size="151026" author="kwall" created="Thu, 15 Dec 2016 16:07:35 +0000"/>
                            <attachment id="12843862" name="TEST-org.apache.qpid.test.unit.ack.RecoverTest.testOrderingWithAsyncConsumer_0.20.0_proton.txt" size="169496" author="kwall" created="Mon, 19 Dec 2016 14:18:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 38 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i37ncn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>