diff --git a/qpid-jms-client/src/main/java/org/apache/qpid/jms/JmsMessageConsumer.java b/qpid-jms-client/src/main/java/org/apache/qpid/jms/JmsMessageConsumer.java
index 7a630e17..9c20b8a8 100644
--- a/qpid-jms-client/src/main/java/org/apache/qpid/jms/JmsMessageConsumer.java
+++ b/qpid-jms-client/src/main/java/org/apache/qpid/jms/JmsMessageConsumer.java
@@ -716,6 +716,7 @@ public class JmsMessageConsumer implements MessageConsumer, JmsMessageAvailableC
                         LOG.trace("{} filtered message with excessive redelivery count: {}", getConsumerId(), envelope);
                         doAckUndeliverable(envelope);
                     } else {
+                        boolean deliveryFailed = false;
                         boolean autoAckOrDupsOk = acknowledgementMode == Session.AUTO_ACKNOWLEDGE ||
                                                   acknowledgementMode == Session.DUPS_OK_ACKNOWLEDGE;
                         if (autoAckOrDupsOk) {
@@ -725,10 +726,18 @@ public class JmsMessageConsumer implements MessageConsumer, JmsMessageAvailableC
                         }
                         session.clearSessionRecovered();
 
-                        messageListener.onMessage(copy);
+                        try {
+                            messageListener.onMessage(copy);
+                        } catch (RuntimeException rte) {
+                            deliveryFailed = true;
+                        }
 
                         if (autoAckOrDupsOk && !session.isSessionRecovered()) {
-                            doAckConsumed(envelope);
+                            if (!deliveryFailed) {
+                                doAckConsumed(envelope);
+                            } else {
+                                doAckReleased(envelope);
+                            }
                         }
                     }
                 } catch (Exception e) {
diff --git a/qpid-jms-client/src/test/java/org/apache/qpid/jms/integration/ConsumerIntegrationTest.java b/qpid-jms-client/src/test/java/org/apache/qpid/jms/integration/ConsumerIntegrationTest.java
index 792cd4d1..39f361e0 100644
--- a/qpid-jms-client/src/test/java/org/apache/qpid/jms/integration/ConsumerIntegrationTest.java
+++ b/qpid-jms-client/src/test/java/org/apache/qpid/jms/integration/ConsumerIntegrationTest.java
@@ -26,6 +26,7 @@ import javax.jms.Connection;
 import javax.jms.IllegalStateException;
 import javax.jms.Message;
 import javax.jms.MessageConsumer;
+import javax.jms.MessageListener;
 import javax.jms.Queue;
 import javax.jms.Session;
 import javax.jms.TextMessage;
@@ -137,6 +138,72 @@ public class ConsumerIntegrationTest extends QpidJmsTestCase {
         }
     }
 
+    /**
+     * Test that an Ack is not dropped when RTE is thrown from onMessage
+     */
+    @Test(timeout = 20000)
+    public void testRuntimeExceptionInOnMessageReleasesInAutoAckMode() throws Exception {
+        try (TestAmqpPeer testPeer = new TestAmqpPeer();) {
+            Connection connection = testFixture.establishConnecton(testPeer);
+            connection.start();
+
+            testPeer.expectBegin();
+
+            Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);
+            Queue queue = session.createQueue("myQueue");
+
+            DescribedType amqpValueNullContent = new AmqpValueDescribedType(null);
+
+            testPeer.expectReceiverAttach();
+            testPeer.expectLinkFlowRespondWithTransfer(null, null, null, null, amqpValueNullContent);
+            testPeer.expectDispositionThatIsReleasedAndSettled();
+
+            MessageConsumer messageConsumer = session.createConsumer(queue);
+            messageConsumer.setMessageListener(new MessageListener() {
+
+                @Override
+                public void onMessage(Message message) {
+                    throw new RuntimeException();
+                }
+            });
+
+            testPeer.waitForAllHandlersToComplete(2000);
+        }
+    }
+
+    /**
+     * Test that an Ack is not dropped when RTE is thrown from onMessage
+     */
+    @Test(timeout = 20000)
+    public void testRuntimeExceptionInOnMessageReleasesInDupsOkAckMode() throws Exception {
+        try (TestAmqpPeer testPeer = new TestAmqpPeer();) {
+            Connection connection = testFixture.establishConnecton(testPeer);
+            connection.start();
+
+            testPeer.expectBegin();
+
+            Session session = connection.createSession(false, Session.DUPS_OK_ACKNOWLEDGE);
+            Queue queue = session.createQueue("myQueue");
+
+            DescribedType amqpValueNullContent = new AmqpValueDescribedType(null);
+
+            testPeer.expectReceiverAttach();
+            testPeer.expectLinkFlowRespondWithTransfer(null, null, null, null, amqpValueNullContent);
+            testPeer.expectDispositionThatIsReleasedAndSettled();
+
+            MessageConsumer messageConsumer = session.createConsumer(queue);
+            messageConsumer.setMessageListener(new MessageListener() {
+
+                @Override
+                public void onMessage(Message message) {
+                    throw new RuntimeException();
+                }
+            });
+
+            testPeer.waitForAllHandlersToComplete(2000);
+        }
+    }
+
     @Test(timeout=20000)
     public void testCloseDurableSubscriberWithUnackedAnUnconsumedPrefetchedMessages() throws Exception {
         try (TestAmqpPeer testPeer = new TestAmqpPeer();) {
diff --git a/qpid-jms-client/src/test/java/org/apache/qpid/jms/test/testpeer/TestAmqpPeer.java b/qpid-jms-client/src/test/java/org/apache/qpid/jms/test/testpeer/TestAmqpPeer.java
index 9743e235..ce48fdd6 100644
--- a/qpid-jms-client/src/test/java/org/apache/qpid/jms/test/testpeer/TestAmqpPeer.java
+++ b/qpid-jms-client/src/test/java/org/apache/qpid/jms/test/testpeer/TestAmqpPeer.java
@@ -55,6 +55,7 @@ import org.apache.qpid.jms.test.testpeer.describedtypes.DispositionFrame;
 import org.apache.qpid.jms.test.testpeer.describedtypes.EndFrame;
 import org.apache.qpid.jms.test.testpeer.describedtypes.FlowFrame;
 import org.apache.qpid.jms.test.testpeer.describedtypes.OpenFrame;
+import org.apache.qpid.jms.test.testpeer.describedtypes.Released;
 import org.apache.qpid.jms.test.testpeer.describedtypes.SaslMechanismsFrame;
 import org.apache.qpid.jms.test.testpeer.describedtypes.SaslOutcomeFrame;
 import org.apache.qpid.jms.test.testpeer.describedtypes.Source;
@@ -1393,6 +1394,11 @@ public class TestAmqpPeer implements AutoCloseable
         expectDisposition(true, new DescriptorMatcher(Accepted.DESCRIPTOR_CODE, Accepted.DESCRIPTOR_SYMBOL));
     }
 
+    public void expectDispositionThatIsReleasedAndSettled()
+    {
+        expectDisposition(true, new DescriptorMatcher(Released.DESCRIPTOR_CODE, Released.DESCRIPTOR_SYMBOL));
+    }
+
     public void expectDisposition(boolean settled, Matcher<?> stateMatcher)
     {
         expectDisposition(settled, stateMatcher, null, null);
