diff --git a/qpid-jms-client/src/test/java/org/apache/qpid/jms/integration/ConsumerIntegrationTest.java b/qpid-jms-client/src/test/java/org/apache/qpid/jms/integration/ConsumerIntegrationTest.java
index e4d18697..f7715a9e 100644
--- a/qpid-jms-client/src/test/java/org/apache/qpid/jms/integration/ConsumerIntegrationTest.java
+++ b/qpid-jms-client/src/test/java/org/apache/qpid/jms/integration/ConsumerIntegrationTest.java
@@ -643,4 +643,57 @@ public class ConsumerIntegrationTest extends QpidJmsTestCase {
             testPeer.waitForAllHandlersToComplete(3000);
         }
     }
+
+    /* Check the clients view of the remaining credit stays in sync with the transports
+     * even in the face of the remote peer advancing the delivery count unexpectedly,
+     * ensuring the client doesn't later think there is credit when there is none.
+     *
+     * QPIDJMS-139 / QPID-6947 / PROTON-1077
+     *
+     * Expect receiver link to attach and send credit, then:
+     * - Have test peer sender pretend it got multiple flows, and only some of the credit had previously arrived.
+     * - Unexpectedly advance delivery count and use up some of credit, set a 0 link credit.
+     * - Top up the link credit with the remainder as if it had just arrived, not advancing delivery count.
+     * - Send messages using up the remaining credit.
+     * - Check when the consumer tops the credit back up to the initial value that the
+     *   value of link-credit on the wire is actually as expected.
+     */
+    @Test(timeout=30000)
+    public void testCreditReplenishmentWhenSenderAdvancesDeliveryCountUnexpectedly() throws Exception {
+        int prefetch = 4;
+        int topUp = 2;
+        int messageCount = prefetch - topUp;
+        try (TestAmqpPeer testPeer = new TestAmqpPeer();) {
+            Connection connection = testFixture.establishConnecton(testPeer, "?jms.prefetchPolicy.all=" + prefetch);
+            connection.start();
+
+            testPeer.expectBegin();
+
+            Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);
+            Queue queue = session.createQueue("myQueue");
+
+            testPeer.expectReceiverAttach();
+            testPeer.expectLinkFlowThenPerformUnexpectedDeliveryCountAdvanceThenCreditTopupThenTransfers(prefetch, topUp, messageCount);
+
+            // Expect consumer to top up the credit window to <prefetch> when accepting the messages
+            testPeer.expectLinkFlow(false, false, equalTo(UnsignedInteger.valueOf(prefetch)));
+            testPeer.expectDisposition(true, new AcceptedMatcher(), 0, 0);
+            testPeer.expectDisposition(true, new AcceptedMatcher(), 1, 1);
+
+            // First timeout used is large to ensure the client sees the
+            // delivery count advancement without trying to drain first.
+            MessageConsumer consumer = session.createConsumer(queue);
+            Message msg = consumer.receive(10000);
+            assertNotNull("Should have received message 1", msg);
+            msg = consumer.receive(1);
+            assertNotNull("Should have received message 2", msg);
+
+            // Then close the consumer
+            testPeer.expectDetach(true, true, true);
+
+            consumer.close();
+
+            testPeer.waitForAllHandlersToComplete(3000);
+        }
+    }
 }
diff --git a/qpid-jms-client/src/test/java/org/apache/qpid/jms/test/testpeer/TestAmqpPeer.java b/qpid-jms-client/src/test/java/org/apache/qpid/jms/test/testpeer/TestAmqpPeer.java
index 9396e3b1..4a20f1f0 100644
--- a/qpid-jms-client/src/test/java/org/apache/qpid/jms/test/testpeer/TestAmqpPeer.java
+++ b/qpid-jms-client/src/test/java/org/apache/qpid/jms/test/testpeer/TestAmqpPeer.java
@@ -20,6 +20,7 @@ package org.apache.qpid.jms.test.testpeer;
 
 import static org.apache.qpid.jms.provider.amqp.AmqpSupport.DYNAMIC_NODE_LIFETIME_POLICY;
 import static org.hamcrest.MatcherAssert.assertThat;
+import static org.hamcrest.Matchers.lessThan;
 import static org.hamcrest.Matchers.arrayContaining;
 import static org.hamcrest.Matchers.equalTo;
 import static org.hamcrest.Matchers.hasEntry;
@@ -66,6 +67,7 @@ import org.apache.qpid.jms.test.testpeer.describedtypes.SaslOutcomeFrame;
 import org.apache.qpid.jms.test.testpeer.describedtypes.Source;
 import org.apache.qpid.jms.test.testpeer.describedtypes.Target;
 import org.apache.qpid.jms.test.testpeer.describedtypes.TransferFrame;
+import org.apache.qpid.jms.test.testpeer.describedtypes.sections.AmqpValueDescribedType;
 import org.apache.qpid.jms.test.testpeer.describedtypes.sections.ApplicationPropertiesDescribedType;
 import org.apache.qpid.jms.test.testpeer.describedtypes.sections.HeaderDescribedType;
 import org.apache.qpid.jms.test.testpeer.describedtypes.sections.MessageAnnotationsDescribedType;
@@ -1329,6 +1331,94 @@ public class TestAmqpPeer implements AutoCloseable
         addHandler(flowMatcher);
     }
 
+    public void expectLinkFlowThenPerformUnexpectedDeliveryCountAdvanceThenCreditTopupThenTransfers(final int prefetch, final int topUp, final int messageCount)
+    {
+        final FlowMatcher flowMatcher = new FlowMatcher()
+                        .withHandle(notNullValue())
+                        .withLinkCredit(equalTo(UnsignedInteger.valueOf(prefetch)))
+                        .withDrain(Matchers.anyOf(equalTo(false), nullValue()));
+
+        final FlowFrame advancingFlowResponse = new FlowFrame();
+        advancingFlowResponse.setOutgoingWindow(UnsignedInteger.MAX_VALUE);
+        advancingFlowResponse.setIncomingWindow(UnsignedInteger.valueOf(Integer.MAX_VALUE));
+
+        // The flow frame channel will be dynamically set based on the incoming frame. Using the -1 is an illegal placeholder.
+        final FrameSender advancingFlowResponseSender = new FrameSender(this, FrameType.AMQP, -1, advancingFlowResponse, null);
+        advancingFlowResponseSender.setValueProvider(new ValueProvider()
+        {
+            @Override
+            public void setValues()
+            {
+                advancingFlowResponseSender.setChannel(flowMatcher.getActualChannel());
+                advancingFlowResponse.setHandle(flowMatcher.getReceivedHandle());
+                advancingFlowResponse.setDeliveryCount(calculateNewDeliveryCount(flowMatcher, prefetch - topUp));
+                advancingFlowResponse.setLinkCredit(UnsignedInteger.ZERO);
+                advancingFlowResponse.setNextOutgoingId(flowMatcher.getReceivedNextIncomingId());
+                advancingFlowResponse.setNextIncomingId(flowMatcher.getReceivedNextOutgoingId());
+            }
+        });
+
+        final FlowFrame topUpFlowResponse = new FlowFrame();
+        topUpFlowResponse.setOutgoingWindow(UnsignedInteger.MAX_VALUE);
+        topUpFlowResponse.setIncomingWindow(UnsignedInteger.valueOf(Integer.MAX_VALUE));
+
+        // The flow frame channel will be dynamically set based on the incoming frame. Using the -1 is an illegal placeholder.
+        final FrameSender topUpFlowResponseSender = new FrameSender(this, FrameType.AMQP, -1, topUpFlowResponse, null);
+        topUpFlowResponseSender.setValueProvider(new ValueProvider()
+        {
+            @Override
+            public void setValues()
+            {
+                topUpFlowResponseSender.setChannel(flowMatcher.getActualChannel());
+                topUpFlowResponse.setHandle(flowMatcher.getReceivedHandle());
+                topUpFlowResponse.setDeliveryCount(calculateNewDeliveryCount(flowMatcher, prefetch - topUp));
+                topUpFlowResponse.setLinkCredit(UnsignedInteger.valueOf(topUp));
+                topUpFlowResponse.setNextOutgoingId(flowMatcher.getReceivedNextIncomingId());
+                topUpFlowResponse.setNextIncomingId(flowMatcher.getReceivedNextOutgoingId());
+            }
+        });
+
+        CompositeAmqpPeerRunnable composite = new CompositeAmqpPeerRunnable();
+        composite.add(advancingFlowResponseSender);
+        advancingFlowResponseSender.setDeferWrite(true);
+        composite.add(topUpFlowResponseSender);
+
+        final Integer remoteNextIncomingId = 0; //TODO: make configurable
+        for(int i = 0; i < messageCount; i++)
+        {
+            final int nextId = remoteNextIncomingId + i;
+
+            String tagString = "theDeliveryTag" + nextId;
+            Binary dtag = new Binary(tagString.getBytes());
+
+            final TransferFrame transferResponse = new TransferFrame()
+            .setDeliveryId(UnsignedInteger.valueOf(nextId))
+            .setDeliveryTag(dtag)
+            .setMessageFormat(UnsignedInteger.ZERO)
+            .setSettled(false);
+
+            Binary payload = prepareTransferPayload(null, null, null, null, new AmqpValueDescribedType("content"));
+
+            // The response frame channel will be dynamically set based on the incoming frame. Using the -1 is an illegal placeholder.
+            final FrameSender transferResponseSender = new FrameSender(this, FrameType.AMQP, -1, transferResponse, payload);
+            transferResponseSender.setValueProvider(new ValueProvider()
+            {
+                @Override
+                public void setValues()
+                {
+                    transferResponse.setHandle(flowMatcher.getReceivedHandle());
+                    transferResponseSender.setChannel(flowMatcher.getActualChannel());
+                }
+            });
+
+            composite.add(transferResponseSender);
+        }
+
+        flowMatcher.onCompletion(composite);
+
+        addHandler(flowMatcher);
+    }
+
     private UnsignedInteger calculateNewDeliveryCount(FlowMatcher flowMatcher) {
         UnsignedInteger dc = (UnsignedInteger) flowMatcher.getReceivedDeliveryCount();
         UnsignedInteger lc = (UnsignedInteger) flowMatcher.getReceivedLinkCredit();
@@ -1336,6 +1426,15 @@ public class TestAmqpPeer implements AutoCloseable
         return dc.add(lc);
     }
 
+    private UnsignedInteger calculateNewDeliveryCount(FlowMatcher flowMatcher, int creditToConsume) {
+        UnsignedInteger dc = (UnsignedInteger) flowMatcher.getReceivedDeliveryCount();
+        UnsignedInteger lc = (UnsignedInteger) flowMatcher.getReceivedLinkCredit();
+
+        assertThat(UnsignedInteger.valueOf(creditToConsume), lessThan(lc));
+
+        return dc.add(UnsignedInteger.valueOf(creditToConsume));
+    }
+
     private UnsignedInteger calculateNewOutgoingId(FlowMatcher flowMatcher, int sentCount) {
         UnsignedInteger nid = (UnsignedInteger) flowMatcher.getReceivedNextIncomingId();
 
