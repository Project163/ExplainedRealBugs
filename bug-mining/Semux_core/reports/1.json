{"url":"https://api.github.com/repos/semuxproject/semux-core/issues/1","repository_url":"https://api.github.com/repos/semuxproject/semux-core","labels_url":"https://api.github.com/repos/semuxproject/semux-core/issues/1/labels{/name}","comments_url":"https://api.github.com/repos/semuxproject/semux-core/issues/1/comments","events_url":"https://api.github.com/repos/semuxproject/semux-core/issues/1/events","html_url":"https://github.com/semuxproject/semux-core/issues/1","id":331192659,"node_id":"MDU6SXNzdWUzMzExOTI2NTk=","number":1,"title":"\"Invalid block header\" errors due to incorrect timestamps of previous validator.","user":{"login":"CellarDoor00","id":40150567,"node_id":"MDQ6VXNlcjQwMTUwNTY3","avatar_url":"https://avatars.githubusercontent.com/u/40150567?v=4","gravatar_id":"","url":"https://api.github.com/users/CellarDoor00","html_url":"https://github.com/CellarDoor00","followers_url":"https://api.github.com/users/CellarDoor00/followers","following_url":"https://api.github.com/users/CellarDoor00/following{/other_user}","gists_url":"https://api.github.com/users/CellarDoor00/gists{/gist_id}","starred_url":"https://api.github.com/users/CellarDoor00/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/CellarDoor00/subscriptions","organizations_url":"https://api.github.com/users/CellarDoor00/orgs","repos_url":"https://api.github.com/users/CellarDoor00/repos","events_url":"https://api.github.com/users/CellarDoor00/events{/privacy}","received_events_url":"https://api.github.com/users/CellarDoor00/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":960721467,"node_id":"MDU6TGFiZWw5NjA3MjE0Njc=","url":"https://api.github.com/repos/semuxproject/semux-core/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/semuxproject/semux-core/milestones/1","html_url":"https://github.com/semuxproject/semux-core/milestone/1","labels_url":"https://api.github.com/repos/semuxproject/semux-core/milestones/1/labels","id":3526894,"node_id":"MDk6TWlsZXN0b25lMzUyNjg5NA==","number":1,"title":"v1.3.0","description":"","creator":{"login":"semuxgo","id":40153479,"node_id":"MDQ6VXNlcjQwMTUzNDc5","avatar_url":"https://avatars.githubusercontent.com/u/40153479?v=4","gravatar_id":"","url":"https://api.github.com/users/semuxgo","html_url":"https://github.com/semuxgo","followers_url":"https://api.github.com/users/semuxgo/followers","following_url":"https://api.github.com/users/semuxgo/following{/other_user}","gists_url":"https://api.github.com/users/semuxgo/gists{/gist_id}","starred_url":"https://api.github.com/users/semuxgo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/semuxgo/subscriptions","organizations_url":"https://api.github.com/users/semuxgo/orgs","repos_url":"https://api.github.com/users/semuxgo/repos","events_url":"https://api.github.com/users/semuxgo/events{/privacy}","received_events_url":"https://api.github.com/users/semuxgo/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":3,"state":"closed","created_at":"2018-07-27T02:26:13Z","updated_at":"2018-11-19T04:38:27Z","due_on":"2018-08-05T07:00:00Z","closed_at":"2018-11-19T04:38:27Z"},"comments":4,"created_at":"2018-06-11T13:37:51Z","updated_at":"2018-11-22T20:13:08Z","closed_at":"2018-06-16T00:07:39Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Semux version: 1.2.0\r\nOS & Version: Ubuntu 16.04 / 18.04, macOS 10.13.4\r\nJava: 8 or 10\r\n\r\nMy validator started getting \"invalid block header\" warnings (errors, really) during a block proposal, resulting in failures to forge blocks. I added some debug messages and found that the cause was the proposed block's timestamp check failure, resulting from an incorrect timestamp of the block forged by the validator before mine.\r\n\r\nIn SemuxBft.validateBlock(), right before if (!Block.validateHeader()), I added:\r\n\r\nlogger.info(\"Time check: prev {}, current {} (delta: {})\", latest.getHeader().getTimestamp(), header.getTimestamp(), header.getTimestamp() - latest.getHeader().getTimestamp());\r\n\r\nNormally, I would see deltas of about 30 sec, but the validator before me consistently had 60 sec deltas. However, the actual time between his block and the block previous to his was still at the regular 30 sec interval. So for my validator, this resulted in the delta for my block's timestamp to be a small negative value, causing the block validation failure.\r\n\r\nThere are currently several validators with block timestamp deltas over 30 (+/-) seconds. semux666 is the validator that reports about 60 seconds, and that causes consistent failures to forge for whoever comes after him. Additionally, there are deltas in the range of 40-50 seconds for some other validators. As long as a delta is less than 60 seconds, a validator that follows is still able to forge blocks successfully.\r\n\r\nHere's an example log, with bolded lines for the culprit and the victim:\r\n\r\n------------------------------------------------------------------------------------------------\r\n2018-06-10T14:08:47-0400 INFO     SemuxBft         Entered new_height: height = 390863, # validators = 100\r\n2018-06-10T14:08:50-0400 INFO     SemuxBft         Entered propose: height = 390863, view = 0, primary = false, # connected validators = 1 + 78\r\n2018-06-10T14:09:02-0400 INFO     SemuxBft         Entered validate: proposal = true, votes = [4, 0] [0, 0] [0, 0]\r\n2018-06-10T14:09:02-0400 INFO     SemuxBft         Time check: prev 1528654101516, current 1528654130198 (delta: 28682)\r\n2018-06-10T14:09:08-0400 INFO     SemuxBft         Entered pre_commit: proposal = true, votes = [98, 0] [3, 0] [0, 0]\r\n2018-06-10T14:09:14-0400 INFO     SemuxBft         Entered commit: proposal = true, votes = [98, 0] [98, 0] [4, 0]\r\n2018-06-10T14:09:14-0400 INFO     SemuxBft         Entered finalize: proposal = true, votes = [98, 0] [98, 0] [67, 0]\r\n2018-06-10T14:09:14-0400 INFO     SemuxBft         Block [number = 390863, view = 0, hash = 6aec8cfa86057310b2a43f8f5fe0925376cf1843759a863734d97c1cec476280, # txs = 0, # votes = 98]\r\n2018-06-10T14:09:17-0400 INFO     SemuxBft         Entered new_height: height = 390864, # validators = 100\r\n2018-06-10T14:09:20-0400 INFO     SemuxBft         Entered propose: height = 390864, view = 0, primary = false, # connected validators = 1 + 79\r\n2018-06-10T14:09:32-0400 INFO     SemuxBft         Entered validate: proposal = true, votes = [3, 0] [0, 0] [0, 0]\r\n**2018-06-10T14:09:32-0400 INFO     SemuxBft         Time check: prev 1528654130198, current 1528654191065 (delta: 60867)**\r\n2018-06-10T14:09:38-0400 INFO     SemuxBft         Entered pre_commit: proposal = true, votes = [98, 0] [2, 0] [0, 0]\r\n2018-06-10T14:09:44-0400 INFO     SemuxBft         Entered commit: proposal = true, votes = [98, 0] [98, 0] [3, 0]\r\n2018-06-10T14:09:44-0400 INFO     SemuxBft         Entered finalize: proposal = true, votes = [98, 0] [98, 0] [67, 0]\r\n2018-06-10T14:09:44-0400 INFO     SemuxBft         Block [number = 390864, view = 0, hash = d4d06b61b845e049f80ece7437135be50341aceb4cac0788fc4c1db9b308da69, # txs = 0, # votes = 98]\r\n2018-06-10T14:09:47-0400 INFO     SemuxBft         Entered new_height: height = 390865, # validators = 100\r\n2018-06-10T14:09:50-0400 INFO     SemuxBft         Entered propose: height = 390865, view = 0, primary = true, # connected validators = 1 + 80\r\n2018-06-10T14:10:02-0400 INFO     SemuxBft         Entered validate: proposal = true, votes = [0, 2] [0, 0] [0, 0]\r\n**2018-06-10T14:10:02-0400 INFO     SemuxBft         Time check: prev 1528654191065, current 1528654190505 (delta: -560)**\r\n2018-06-10T14:10:02-0400 WARN     SemuxBft         Invalid block header\r\n2018-06-10T14:10:08-0400 INFO     SemuxBft         Entered pre_commit: proposal = true, votes = [0, 98] [0, 4] [0, 0]\r\n2018-06-10T14:10:14-0400 INFO     SemuxBft         Entered propose: height = 390865, view = 1, primary = false, # connected validators = 1 + 81\r\n2018-06-10T14:10:26-0400 INFO     SemuxBft         Entered validate: proposal = true, votes = [2, 0] [0, 0] [0, 0]\r\n2018-06-10T14:10:26-0400 INFO     SemuxBft         Time check: prev 1528654191065, current 1528654214503 (delta: 23438)\r\n2018-06-10T14:10:32-0400 INFO     SemuxBft         Entered pre_commit: proposal = true, votes = [98, 0] [4, 0] [0, 0]\r\n2018-06-10T14:10:38-0400 INFO     SemuxBft         Entered commit: proposal = true, votes = [98, 0] [98, 0] [4, 0]\r\n2018-06-10T14:10:38-0400 INFO     SemuxBft         Entered finalize: proposal = true, votes = [98, 0] [98, 0] [67, 0]\r\n2018-06-10T14:10:38-0400 INFO     SemuxBft         Block [number = 390865, view = 1, hash = 78e48571d5ffdf4ecba0231a2c2dc7f9e1f12a5fc794f9417f715b5bf11bfc4c, # txs = 0, # votes = 98]\r\n2018-06-10T14:10:41-0400 INFO     SemuxBft         Entered new_height: height = 390866, # validators = 100\r\n","closed_by":{"login":"orogvany","id":24282143,"node_id":"MDQ6VXNlcjI0MjgyMTQz","avatar_url":"https://avatars.githubusercontent.com/u/24282143?v=4","gravatar_id":"","url":"https://api.github.com/users/orogvany","html_url":"https://github.com/orogvany","followers_url":"https://api.github.com/users/orogvany/followers","following_url":"https://api.github.com/users/orogvany/following{/other_user}","gists_url":"https://api.github.com/users/orogvany/gists{/gist_id}","starred_url":"https://api.github.com/users/orogvany/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/orogvany/subscriptions","organizations_url":"https://api.github.com/users/orogvany/orgs","repos_url":"https://api.github.com/users/orogvany/repos","events_url":"https://api.github.com/users/orogvany/events{/privacy}","received_events_url":"https://api.github.com/users/orogvany/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/semuxproject/semux-core/issues/1/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/semuxproject/semux-core/issues/1/timeline","performed_via_github_app":null,"state_reason":"completed"}