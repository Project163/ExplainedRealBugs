{"url":"https://api.github.com/repos/gabime/spdlog/issues/2408","repository_url":"https://api.github.com/repos/gabime/spdlog","labels_url":"https://api.github.com/repos/gabime/spdlog/issues/2408/labels{/name}","comments_url":"https://api.github.com/repos/gabime/spdlog/issues/2408/comments","events_url":"https://api.github.com/repos/gabime/spdlog/issues/2408/events","html_url":"https://github.com/gabime/spdlog/issues/2408","id":1275529828,"node_id":"I_kwDOAY1ReM5MBwpk","number":2408,"title":"Check IsDebuggerPresent in msvc_sink before doing work","user":{"login":"DominikGrabiec","id":81088,"node_id":"MDQ6VXNlcjgxMDg4","avatar_url":"https://avatars.githubusercontent.com/u/81088?v=4","gravatar_id":"","url":"https://api.github.com/users/DominikGrabiec","html_url":"https://github.com/DominikGrabiec","followers_url":"https://api.github.com/users/DominikGrabiec/followers","following_url":"https://api.github.com/users/DominikGrabiec/following{/other_user}","gists_url":"https://api.github.com/users/DominikGrabiec/gists{/gist_id}","starred_url":"https://api.github.com/users/DominikGrabiec/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DominikGrabiec/subscriptions","organizations_url":"https://api.github.com/users/DominikGrabiec/orgs","repos_url":"https://api.github.com/users/DominikGrabiec/repos","events_url":"https://api.github.com/users/DominikGrabiec/events{/privacy}","received_events_url":"https://api.github.com/users/DominikGrabiec/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2022-06-17T22:08:54Z","updated_at":"2022-11-01T12:08:53Z","closed_at":"2022-10-31T22:53:09Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I'm not sure if everybody will want to do this, so this is just a suggestion and something up for discussion. I've included some code below.\r\n\r\nThe `OutputDebugString` function can be relatively slow at times since it has to lock a global mutex before copying your message to a listener. With many applications trying to use this in parallel you can hit contention and slow down your program. One way to mitigate this is to check if a debugger is attached first using `IsDebuggerPresent` before doing any processing work and calling `OutputDebugString`.\r\n\r\nThe `IsDebuggerPresent` function itself just checks a global flag in your process address space, so it doesn't need to lock or go into the kernel, so it is quite fast and can be checked before each call. \r\n\r\nI've seen people call it once at program startup when setting up logging, so if a debugger is not attached you skip initialising that sink. In this case you do end up missing all logging output when you later attach a debugger to the running process.\r\n\r\nThe one down side I see of checking if a debugger is attached before sinking every log message is that you won't see your debug output in something like Sysinternals DebugView tool. But realistically you should be able to hook up a different logging sink if you want a live feed.\r\n\r\nThe code changes required are adding this forward declare:\r\n```\r\nextern \"C\" __declspec(dllimport) int __stdcall IsDebuggerPresent();\r\n```\r\nThen changing the body of `msvc_sink.h` to something like:\r\n```\r\n        if (IsDebuggerPresent()) // Check if debugger is attached before sinking\r\n        {\r\n            memory_buf_t formatted;\r\n            base_sink<Mutex>::formatter_->format(msg, formatted);\r\n            formatted.push_back('\\0'); // add a null terminator for OutputDebugStringA\r\n            OutputDebugStringA(formatted.data());\r\n        }\r\n```\r\n","closed_by":{"login":"gabime","id":6052198,"node_id":"MDQ6VXNlcjYwNTIxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/6052198?v=4","gravatar_id":"","url":"https://api.github.com/users/gabime","html_url":"https://github.com/gabime","followers_url":"https://api.github.com/users/gabime/followers","following_url":"https://api.github.com/users/gabime/following{/other_user}","gists_url":"https://api.github.com/users/gabime/gists{/gist_id}","starred_url":"https://api.github.com/users/gabime/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gabime/subscriptions","organizations_url":"https://api.github.com/users/gabime/orgs","repos_url":"https://api.github.com/users/gabime/repos","events_url":"https://api.github.com/users/gabime/events{/privacy}","received_events_url":"https://api.github.com/users/gabime/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/gabime/spdlog/issues/2408/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/gabime/spdlog/issues/2408/timeline","performed_via_github_app":null,"state_reason":"completed"}