{"url":"https://api.github.com/repos/alacritty/alacritty/issues/1236","repository_url":"https://api.github.com/repos/alacritty/alacritty","labels_url":"https://api.github.com/repos/alacritty/alacritty/issues/1236/labels{/name}","comments_url":"https://api.github.com/repos/alacritty/alacritty/issues/1236/comments","events_url":"https://api.github.com/repos/alacritty/alacritty/issues/1236/events","html_url":"https://github.com/alacritty/alacritty/issues/1236","id":312192273,"node_id":"MDU6SXNzdWUzMTIxOTIyNzM=","number":1236,"title":"Scrollback memory pre-allocation and optimization","user":{"login":"max-baz","id":1177900,"node_id":"MDQ6VXNlcjExNzc5MDA=","avatar_url":"https://avatars.githubusercontent.com/u/1177900?v=4","gravatar_id":"","url":"https://api.github.com/users/max-baz","html_url":"https://github.com/max-baz","followers_url":"https://api.github.com/users/max-baz/followers","following_url":"https://api.github.com/users/max-baz/following{/other_user}","gists_url":"https://api.github.com/users/max-baz/gists{/gist_id}","starred_url":"https://api.github.com/users/max-baz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/max-baz/subscriptions","organizations_url":"https://api.github.com/users/max-baz/orgs","repos_url":"https://api.github.com/users/max-baz/repos","events_url":"https://api.github.com/users/max-baz/events{/privacy}","received_events_url":"https://api.github.com/users/max-baz/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":861214174,"node_id":"MDU6TGFiZWw4NjEyMTQxNzQ=","url":"https://api.github.com/repos/alacritty/alacritty/labels/S%20-%20scrollback","name":"S - scrollback","color":"5319e7","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":14,"created_at":"2018-04-07T09:40:35Z","updated_at":"2023-03-11T18:33:41Z","closed_at":"2018-09-24T18:40:10Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Arch Linux, X11\r\n\r\nPlease see this message by @mpe: https://github.com/jwilm/alacritty/issues/241#issuecomment-379426780\r\n\r\n> @maximbaz thanks for looking at it.\r\n>\r\n> Measuring memory usage is complicated, because of shared pages etc. But your measurement using RES - SHR is probably better than mine which was just looking at RSS.\r\n>\r\n> I'm also running with scrollback enabled, and it seems I actually had 20,000 lines configured.\r\n>\r\n> So in that case I see RES ~= 130MB and SHR ~= 20MB for 90MB in total.\r\n>\r\n> **It's the scrollback size which accounts for most of the memory usage.**\r\n>\r\n> If I reduce scrollback to 100 lines, I see numbers that more or less match yours in htop.\r\n>\r\n> So the question is why is scrollback using so much memory? If I compare a few values (all at startup):\r\n>\r\n> ```\r\n> Lines   RES  SHR\r\n> 100,000\t535M 19M\r\n>  20,000\t131M 19M\r\n>  10,000\t 82M 19M\r\n>   1,000\t 36M 19M\r\n>     100\t 32M 19M\r\n> ```\r\n>\r\n> Each extra line of (empty) scrollback is using ~5K of memory?\r\n\r\n\r\nI did my own measurements too:\r\n\r\n* alacritty master, tmux with 20,000 lines of history configured:\r\n\r\n    ```\r\n    When               What         RES      SHR\r\n    On startup         tmux         4248     3120\r\n    After `$ tree /`   tmux         33964    3120\r\n    ```\r\n\r\n* alacritty scrollback, with 20,000 lines of history configured:\r\n\r\n    ```\r\n    When               What         RES      SHR\r\n    On startup         alacritty    191M     20856\r\n    After `$ tree /`   alacritty    191M     20856\r\n    ```\r\n\r\nMy summary:\r\n\r\n1. Tmux starts very light, while alacritty pre-allocates huge amount of memory. Can this pre-allocation be avoided? I start many instances of alacritty often, most of them will not have huge scrollback history.\r\n1. Tmux consumes 34MB with 20k lines of history, alacritty eats 191MB for the same size. Can this be optimized?","closed_by":{"login":"chrisduerr","id":8886672,"node_id":"MDQ6VXNlcjg4ODY2NzI=","avatar_url":"https://avatars.githubusercontent.com/u/8886672?v=4","gravatar_id":"","url":"https://api.github.com/users/chrisduerr","html_url":"https://github.com/chrisduerr","followers_url":"https://api.github.com/users/chrisduerr/followers","following_url":"https://api.github.com/users/chrisduerr/following{/other_user}","gists_url":"https://api.github.com/users/chrisduerr/gists{/gist_id}","starred_url":"https://api.github.com/users/chrisduerr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chrisduerr/subscriptions","organizations_url":"https://api.github.com/users/chrisduerr/orgs","repos_url":"https://api.github.com/users/chrisduerr/repos","events_url":"https://api.github.com/users/chrisduerr/events{/privacy}","received_events_url":"https://api.github.com/users/chrisduerr/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/alacritty/alacritty/issues/1236/reactions","total_count":9,"+1":9,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/alacritty/alacritty/issues/1236/timeline","performed_via_github_app":null,"state_reason":"completed"}