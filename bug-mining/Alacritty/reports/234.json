{"url":"https://api.github.com/repos/alacritty/alacritty/issues/3002","repository_url":"https://api.github.com/repos/alacritty/alacritty","labels_url":"https://api.github.com/repos/alacritty/alacritty/issues/3002/labels{/name}","comments_url":"https://api.github.com/repos/alacritty/alacritty/issues/3002/comments","events_url":"https://api.github.com/repos/alacritty/alacritty/issues/3002/events","html_url":"https://github.com/alacritty/alacritty/issues/3002","id":526744992,"node_id":"MDU6SXNzdWU1MjY3NDQ5OTI=","number":3002,"title":"High amount of small allocations during alt-screen-randow-write compared to the older version","user":{"login":"kchibisov","id":27620401,"node_id":"MDQ6VXNlcjI3NjIwNDAx","avatar_url":"https://avatars.githubusercontent.com/u/27620401?v=4","gravatar_id":"","url":"https://api.github.com/users/kchibisov","html_url":"https://github.com/kchibisov","followers_url":"https://api.github.com/users/kchibisov/followers","following_url":"https://api.github.com/users/kchibisov/following{/other_user}","gists_url":"https://api.github.com/users/kchibisov/gists{/gist_id}","starred_url":"https://api.github.com/users/kchibisov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kchibisov/subscriptions","organizations_url":"https://api.github.com/users/kchibisov/orgs","repos_url":"https://api.github.com/users/kchibisov/repos","events_url":"https://api.github.com/users/kchibisov/events{/privacy}","received_events_url":"https://api.github.com/users/kchibisov/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":327960157,"node_id":"MDU6TGFiZWwzMjc5NjAxNTc=","url":"https://api.github.com/repos/alacritty/alacritty/labels/enhancement","name":"enhancement","color":"84b6eb","default":true,"description":null},{"id":451017268,"node_id":"MDU6TGFiZWw0NTEwMTcyNjg=","url":"https://api.github.com/repos/alacritty/alacritty/labels/B%20-%20performance","name":"B - performance","color":"c6071e","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/alacritty/alacritty/milestones/11","html_url":"https://github.com/alacritty/alacritty/milestone/11","labels_url":"https://api.github.com/repos/alacritty/alacritty/milestones/11/labels","id":4421996,"node_id":"MDk6TWlsZXN0b25lNDQyMTk5Ng==","number":11,"title":"Version 0.4.1","description":"","creator":{"login":"chrisduerr","id":8886672,"node_id":"MDQ6VXNlcjg4ODY2NzI=","avatar_url":"https://avatars.githubusercontent.com/u/8886672?v=4","gravatar_id":"","url":"https://api.github.com/users/chrisduerr","html_url":"https://github.com/chrisduerr","followers_url":"https://api.github.com/users/chrisduerr/followers","following_url":"https://api.github.com/users/chrisduerr/following{/other_user}","gists_url":"https://api.github.com/users/chrisduerr/gists{/gist_id}","starred_url":"https://api.github.com/users/chrisduerr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chrisduerr/subscriptions","organizations_url":"https://api.github.com/users/chrisduerr/orgs","repos_url":"https://api.github.com/users/chrisduerr/repos","events_url":"https://api.github.com/users/chrisduerr/events{/privacy}","received_events_url":"https://api.github.com/users/chrisduerr/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":31,"state":"closed","created_at":"2019-06-18T18:56:38Z","updated_at":"2020-01-05T17:59:22Z","due_on":null,"closed_at":"2020-01-05T17:59:22Z"},"comments":4,"created_at":"2019-11-21T17:42:07Z","updated_at":"2019-11-22T16:09:02Z","closed_at":"2019-11-22T16:09:02Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"During profiling alacritty with `valgrind --tool=dhat alacritty` and running 250MB of alt-screen-random-write benchmark it was found that we have 95% of our blocks allocations from url parser.\r\n\r\n```\r\nInvocation {\r\n  Command: ./alacritty -e bash\r\n  PID:     136911\r\n}\r\n\r\nTimes {\r\n  t-gmax: 24,630,855,210 instrs (51.08% of program duration)\r\n  t-end:  48,216,585,204 instrs\r\n}\r\n\r\n▼ AP 1/1 (2 children) {\r\n    Total:     3,146,839,925 bytes (100%, 65,264.68/Minstr) in 2,226,983 blocks (100%, 46.19/Minstr), avg size 1,413.05 bytes, avg lifetime 404,319,186.3 instrs (0.84% of program duration)\r\n    At t-gmax: 28,278,115 bytes (100%) in 18,798 blocks (100%), avg size 1,504.32 bytes\r\n    At t-end:  2,032,205 bytes (100%) in 14,693 blocks (100%), avg size 138.31 bytes\r\n    Reads:     35,236,340,277 bytes (100%, 730,792.94/Minstr), 11.2/byte\r\n    Writes:    15,265,148,801 bytes (100%, 316,595.39/Minstr), 4.85/byte\r\n    Allocated at {\r\n      #0: [root]\r\n    }\r\n  }\r\n  ├── AP 1.1/2 {\r\n  │     Total:     84,636,880 bytes (2.69%, 1,755.35/Minstr) in 2,115,921 blocks (95.01%, 43.88/Minstr), avg size 40 bytes, avg lifetime 3,401.02 instrs (0% of program duration)\r\n  │     Max:       80 bytes in 2 blocks, avg size 40 bytes\r\n  │     At t-gmax: 0 bytes (0%) in 0 blocks (0%), avg size 0 bytes\r\n  │     At t-end:  0 bytes (0%) in 0 blocks (0%), avg size 0 bytes\r\n  │     Reads:     158,506 bytes (0%, 3.29/Minstr), 0/byte\r\n  │     Writes:    74,902,600 bytes (0.49%, 1,553.46/Minstr), 0.88/byte\r\n  │     Allocated at {\r\n  │       #1: 0x194CEA: UnknownInlinedFun (src/libstd/sys/unix/alloc.rs:14)\r\n  │       #2: 0x194CEA: UnknownInlinedFun (src/libstd/alloc.rs:239)\r\n  │       #3: 0x194CEA: UnknownInlinedFun (alloc.rs:84)\r\n  │       #4: 0x194CEA: UnknownInlinedFun (alloc.rs:206)\r\n  │       #5: 0x194CEA: UnknownInlinedFun (url.rs:126)\r\n  │       #6: 0x194CEA: UnknownInlinedFun (display.rs:395)\r\n  │       #7: 0x194CEA: UnknownInlinedFun (mod.rs:789)\r\n  │       #8: 0x194CEA: alacritty::display::Display::draw (display.rs:391)\r\n  │       #9: 0x21685A: _ZN9alacritty5event18Processor$LT$N$GT$3run28_$u7b$$u7b$closure$u7d$$u7d$17h70afd9c0e9042913E.2281 (event.rs:424)\r\n  │       #10: 0x215150: sticky_exit_callback<alacritty_terminal::event::Event,closure-0> (mod.rs:693)\r\n  │       #11: 0x215150: UnknownInlinedFun (event_loop.rs:522)\r\n  │       #12: 0x215150: winit::platform_impl::platform::EventLoop<T>::run_return (mod.rs:629)\r\n  │       #13: 0x265481: UnknownInlinedFun (desktop.rs:43)\r\n  │       #14: 0x265481: alacritty::event::Processor<N>::run (event.rs:350)\r\n  │       #15: 0x24B1DB: run (main.rs:216)\r\n  │       #16: 0x24B1DB: alacritty::main (main.rs:107)\r\n  │       #17: 0x2F68E2: std::rt::lang_start::{{closure}} (rt.rs:61)\r\n  │       #18: 0x241A8D: main (in /home/kchibisov/Developer/rust/forks/alacritty/target/release/alacritty)\r\n  │     }\r\n  │   }\r\n  └── AP 1.2/2 {\r\n        Total:     111,062 blocks (4.99%, 2.3/Minstr)\r\n        Allocated at {\r\n          [1044 insignificant]\r\n        }\r\n      }\r\n```\r\n\r\nAnd this is how it looks like with removing url handling logic from display.rs. The output is a bit cut off, but you can see the total amount of blocks.\r\n\r\n```\r\nInvocation {\r\n  Command: ./alacritty -e bash\r\n  PID:     134333\r\n}\r\n\r\nTimes {\r\n  t-gmax: 29,699,194,913 instrs (63.2% of program duration)\r\n  t-end:  46,992,595,533 instrs\r\n}\r\n\r\n▼ AP 1/1 (18 children) {\r\n    Total:     3,384,433,202 bytes (100%, 72,020.56/Minstr) in 107,858 blocks (100%, 2.3/Minstr), avg size 31,378.6 bytes, avg lifetime 8,132,844,629.78 instrs (17.31% of program duration)\r\n    At t-gmax: 28,239,523 bytes (100%) in 18,791 blocks (100%), avg size 1,502.82 bytes\r\n    At t-end:  2,033,853 bytes (100%) in 14,690 blocks (100%), avg size 138.45 bytes\r\n    Reads:     35,524,421,038 bytes (100%, 755,957.84/Minstr), 10.5/byte\r\n    Writes:    15,359,823,348 bytes (100%, 326,856.25/Minstr), 4.54/byte\r\n    Allocated at {\r\n      #0: [root]\r\n    }\r\n  }\r\n  ├── AP 1.1/18 {\r\n  │     Total:     34,439 blocks (31.93%, 0.73/Minstr)\r\n  │     Allocated at {\r\n  │       [1013 insignificant]\r\n  │     }\r\n  │   }\r\n  ├── AP 1.2/18 {\r\n  │     Total:     3,318,218,456 bytes (98.04%, 70,611.52/Minstr) in 14,815 blocks (13.74%, 0.32/Minstr), avg size 223,976.95 bytes, avg lifetime 982,659.57 instrs (0% of program duration)\r\n  │     Max:       1,835,008 bytes in 1 blocks, avg size 1,835,008 bytes\r\n  │     At t-gmax: 1,835,008 bytes (6.5%) in 1 blocks (0.01%), avg size 1,835,008 bytes\r\n  │     At t-end:  0 bytes (0%) in 0 blocks (0%), avg size 0 bytes\r\n  │     Reads:     1,183,315,269 bytes (3.33%, 25,180.89/Minstr), 0.36/byte\r\n  │     Writes:    1,162,555,352 bytes (7.57%, 24,739.12/Minstr), 0.35/byte\r\n  │     Allocated at {\r\n  │       #1: 0x19152F: UnknownInlinedFun (src/libstd/sys/unix/alloc.rs:14)\r\n  │       #2: 0x19152F: UnknownInlinedFun (src/libstd/alloc.rs:239)\r\n  │       #3: 0x19152F: UnknownInlinedFun (alloc.rs:84)\r\n  │       #4: 0x19152F: UnknownInlinedFun (alloc.rs:172)\r\n  │       #5: 0x19152F: UnknownInlinedFun (raw_vec.rs:98)\r\n  │       #6: 0x19152F: UnknownInlinedFun (raw_vec.rs:167)\r\n  │       #7: 0x19152F: UnknownInlinedFun (vec.rs:358)\r\n  │       #8: 0x19152F: UnknownInlinedFun (vec.rs:1981)\r\n  │       #9: 0x19152F: from_iter<alacritty_terminal::term::RenderableCell,alacritty_terminal::term::RenderableCellsIter<alacritty::config::ui_config::UIConfig>> (vec.rs:1890)\r\n  │       #10: 0x19152F: collect<alacritty_terminal::term::RenderableCellsIter<alacritty::config::ui_config::UIConfig>,alloc::vec::Vec<alacritty_terminal::term::RenderableCell>> (iterator.rs:1494)\r\n  │       #11: 0x19152F: alacritty::display::Display::draw (display.rs:363)\r\n  │       #12: 0x1C2DFA: alacritty::event::Processor<N>::run::{{closure}} (event.rs:424)\r\n  │       #13: 0x1F38C0: sticky_exit_callback<alacritty_terminal::event::Event,closure-0> (mod.rs:693)\r\n  │       #14: 0x1F38C0: UnknownInlinedFun (event_loop.rs:522)\r\n  │       #15: 0x1F38C0: winit::platform_impl::platform::EventLoop<T>::run_return (mod.rs:629)\r\n  │       #16: 0x2608C1: UnknownInlinedFun (desktop.rs:43)\r\n  │       #17: 0x2608C1: alacritty::event::Processor<N>::run (event.rs:350)\r\n  │       #18: 0x226EFB: run (main.rs:216)\r\n  │       #19: 0x226EFB: alacritty::main (main.rs:107)\r\n  │       #20: 0x2F0F92: std::rt::lang_start::{{closure}} (rt.rs:61)\r\n  │       #21: 0x21FCFD: main (in /home/kchibisov/Developer/rust/forks/alacritty/target/release/alacritty)\r\n  │     }\r\n  │   }\r\n  ├─▼ AP 1.3/18 (4 children) {\r\n  │     Total:     153,051 bytes (0%, 3.26/Minstr) in 13,633 blocks (12.64%, 0.29/Minstr), avg size 11.23 bytes, avg lifetime 10,266,682,626.79 instrs (21.85% of program duration)\r\n  │     At t-gmax: 41,541 bytes (0.15%) in 2,992 blocks (15.92%), avg size 13.88 bytes\r\n  │     At t-end:  38,082 bytes (1.87%) in 2,812 blocks (19.14%), avg size 13.54 bytes\r\n  │     Reads:     6,146,447 bytes (0.02%, 130.8/Minstr), 40.16/byte\r\n  │     Writes:    233,287 bytes (0%, 4.96/Minstr), 1.52/byte\r\n  │     Allocated at {\r\n  │       #1: 0x4A83BEE: strdup (in /usr/lib/libc-2.30.so)\r\n  │     }\r\n  │   }\r\n```","closed_by":{"login":"chrisduerr","id":8886672,"node_id":"MDQ6VXNlcjg4ODY2NzI=","avatar_url":"https://avatars.githubusercontent.com/u/8886672?v=4","gravatar_id":"","url":"https://api.github.com/users/chrisduerr","html_url":"https://github.com/chrisduerr","followers_url":"https://api.github.com/users/chrisduerr/followers","following_url":"https://api.github.com/users/chrisduerr/following{/other_user}","gists_url":"https://api.github.com/users/chrisduerr/gists{/gist_id}","starred_url":"https://api.github.com/users/chrisduerr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chrisduerr/subscriptions","organizations_url":"https://api.github.com/users/chrisduerr/orgs","repos_url":"https://api.github.com/users/chrisduerr/repos","events_url":"https://api.github.com/users/chrisduerr/events{/privacy}","received_events_url":"https://api.github.com/users/chrisduerr/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/alacritty/alacritty/issues/3002/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/alacritty/alacritty/issues/3002/timeline","performed_via_github_app":null,"state_reason":"completed"}