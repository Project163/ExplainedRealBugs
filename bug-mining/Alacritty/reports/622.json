{"url":"https://api.github.com/repos/alacritty/alacritty/issues/8509","repository_url":"https://api.github.com/repos/alacritty/alacritty","labels_url":"https://api.github.com/repos/alacritty/alacritty/issues/8509/labels{/name}","comments_url":"https://api.github.com/repos/alacritty/alacritty/issues/8509/comments","events_url":"https://api.github.com/repos/alacritty/alacritty/issues/8509/events","html_url":"https://github.com/alacritty/alacritty/issues/8509","id":2911531436,"node_id":"I_kwDOAxkop86tinGs","number":8509,"title":"Selection cleared on any keypress when the Kitty keyboard protocol flag \"Report all keys as escape codes\" is set","user":{"login":"frazew","id":4470714,"node_id":"MDQ6VXNlcjQ0NzA3MTQ=","avatar_url":"https://avatars.githubusercontent.com/u/4470714?v=4","gravatar_id":"","url":"https://api.github.com/users/frazew","html_url":"https://github.com/frazew","followers_url":"https://api.github.com/users/frazew/followers","following_url":"https://api.github.com/users/frazew/following{/other_user}","gists_url":"https://api.github.com/users/frazew/gists{/gist_id}","starred_url":"https://api.github.com/users/frazew/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/frazew/subscriptions","organizations_url":"https://api.github.com/users/frazew/orgs","repos_url":"https://api.github.com/users/frazew/repos","events_url":"https://api.github.com/users/frazew/events{/privacy}","received_events_url":"https://api.github.com/users/frazew/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2025-03-11T18:40:14Z","updated_at":"2025-03-15T22:14:37Z","closed_at":"2025-03-15T22:14:37Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"# Summary\n\nIf an application requests to use Kitty's keyboard protocol and sets the [`Report all keys as escape codes` flag (8)](https://sw.kovidgoyal.net/kitty/keyboard-protocol/#report-all-keys-as-escape-codes), then any key press will clear the terminal selection, even if the key doesn't technically emit any text (i.e. even if it's a \"usual\" modifier key).\n\nThis was introduced with cb03806e2ab85674c45e87e1bb24dfe2fd1a918c, since it's tied to the implementation of Kitty's keyboard protocol.\n\nThis is a slight annoyance because it makes copying things from an application that uses Kitty's keyboard protocol (and this flag) a painful operation: instead of selecting and then hitting CTRL+SHIFT+C, one has to hold CTRL+SHIFT, then select, and then hit the final C to copy.\n\nThis was noticed while using [`atuin`](https://github.com/atuinsh/atuin): in history mode it became more complicated to select+copy ~~than it was before Alacritty 0.13.0 (or rather before cb03806e2ab85674c45e87e1bb24dfe2fd1a918c)~~ after atuin implemented kitty's keyboard protocol (https://github.com/atuinsh/atuin/commit/e129f7a93eb1bc595201a6ec57ba586b3d9d4419).\n\nI've tried to write down as much information as I could, I first thought about opening a PR directly but I think there should be some discussion with an issue before deciding on doing something (or doing nothing if this should be considered expected behavior!). Thanks!\n\n# Reproduction\n\nOn the current alacritty, or any release after cb03806e2ab85674c45e87e1bb24dfe2fd1a918c, with a simple script:\n\n```python\nimport sys\nimport termios\nimport time\n\n# setup stdin\nstdin_attrs = termios.tcgetattr(sys.stdin)\nstdin_attrs[3] = stdin_attrs[3] & ~(termios.ECHO | termios.ICANON)\ntermios.tcsetattr(sys.stdin, termios.TCSAFLUSH, stdin_attrs)\n\n# enable kitty's terminal protocol.\n# set the \"Report all keys as escape codes\" flag\nsys.stdout.write(\"\\x1b[>8u\")\n\nprint(\"select some text and attempt to copy it with CTRL+SHIFT+C:\")\nprint(\"-> hitting any modifier key immediately drops the selection\")\ntime.sleep(10)\n\n# disable kitty's terminal protocol\nsys.stdout.write(\"\\x1b[<u\")\n```\n\nObviously the behavior before cb03806e2ab85674c45e87e1bb24dfe2fd1a918c is the same as the \"normal\" behavior (= a mod key doesn't clear the selection), but that's expected without the keyboard protocol implemented.\n\n# Suggestions\n\nI think the behavior is confusing and unexpected, but it's also not incorrect behavior I think: in this mode the terminal application is fully responsible for keyboard input handling, which means Alacritty has no way to know whether a given key press should technically be considered a modifier or not. I believe there are therefore three possibilities:\n1. keep the current behavior\n    - Alacritty shouldn't try to do anything smart if all keyboard input is delegated to the program currently running, it has no way of knowing what a key press will do and therefore should clear the selection\n    - Kitty itself is different in that regard because the selection is never cleared on any input, no matter the keyboard input mode = we can't really say \"let's mirror Kitty's behavior in that case\"\n\n\n2. disable the call to [`on_terminal_input_start`](https://github.com/alacritty/alacritty/blob/03c2907b44b4189aac5fdeaea331f5aab5c7072e/alacritty/src/input/keyboard.rs#L95) if `build_key_sequence` is true:    \n    - this should not have any impact on the \"normal\" keyboard handling since the `!bytes.is_empty()` condition already means that pressing a modifier key does not result in clearing the selection\n     -  however, that means pressing ANY key will also no longer clear the selection in this keyboard mode. This could be confusing because it goes against the way Alacritty normally behaves. In this mode when a \"normal\" key (like `a`) is pressed, the selection would no longer be cleared.\n\n3. assume that modifier keys are usually still non-printable keys and use that knowledge to only clear the selection if a printable key is pressed\n    - this keeps the usual Alacritty behavior, if a mod key is pressed the selection is not cleared, if a printable key is pressed, it is\n    - the implementation might be more error-prone and/or have more edge cases (?)\n\nI tried something like this for option 3 (disclaimer: not at all fluent in rust), and the behavior seemed alright:\n```diff\ndiff --git a/alacritty/src/input/keyboard.rs b/alacritty/src/input/keyboard.rs\nindex 417f599b..daf2a77f 100644\n--- a/alacritty/src/input/keyboard.rs\n+++ b/alacritty/src/input/keyboard.rs\n@@ -77,6 +77,7 @@ impl<T: EventListener, A: ActionContext<T>> Processor<T, A> {\n         let mods = if self.alt_send_esc(&key, text) { mods } else { mods & !ModifiersState::ALT };\n\n         let build_key_sequence = Self::should_build_sequence(&key, text, mode, mods);\n+        let is_printable_key = Self::is_printable_key(&key, text);\n\n         let bytes = if build_key_sequence {\n             build_sequence(key, mods, mode)\n@@ -92,7 +93,9 @@ impl<T: EventListener, A: ActionContext<T>> Processor<T, A> {\n\n         // Write only if we have something to write.\n         if !bytes.is_empty() {\n-            self.ctx.on_terminal_input_start();\n+            if is_printable_key {\n+                self.ctx.on_terminal_input_start();\n+            }\n             self.ctx.write_to_pty(bytes);\n         }\n     }\n@@ -149,6 +152,18 @@ impl<T: EventListener, A: ActionContext<T>> Processor<T, A> {\n         }\n     }\n\n+    /// Check whether the key is likely to result in a printed character\n+    fn is_printable_key(\n+        key: &KeyEvent,\n+        text: &str,\n+    ) -> bool {\n+        match key.logical_key {\n+            // Include named keys if they have textual representation.\n+            Key::Named(named) => named.to_text().is_some(),\n+            _ => !text.is_empty(),\n+        }\n+    }\n+\n     /// Attempt to find a binding and execute its action.\n     ///\n     /// The provided mode, mods, and key must match what is allowed by a binding\n  ```","closed_by":{"login":"chrisduerr","id":8886672,"node_id":"MDQ6VXNlcjg4ODY2NzI=","avatar_url":"https://avatars.githubusercontent.com/u/8886672?v=4","gravatar_id":"","url":"https://api.github.com/users/chrisduerr","html_url":"https://github.com/chrisduerr","followers_url":"https://api.github.com/users/chrisduerr/followers","following_url":"https://api.github.com/users/chrisduerr/following{/other_user}","gists_url":"https://api.github.com/users/chrisduerr/gists{/gist_id}","starred_url":"https://api.github.com/users/chrisduerr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chrisduerr/subscriptions","organizations_url":"https://api.github.com/users/chrisduerr/orgs","repos_url":"https://api.github.com/users/chrisduerr/repos","events_url":"https://api.github.com/users/chrisduerr/events{/privacy}","received_events_url":"https://api.github.com/users/chrisduerr/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/alacritty/alacritty/issues/8509/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/alacritty/alacritty/issues/8509/timeline","performed_via_github_app":null,"state_reason":"completed"}