{"url":"https://api.github.com/repos/sirupsen/logrus/issues/729","repository_url":"https://api.github.com/repos/sirupsen/logrus","labels_url":"https://api.github.com/repos/sirupsen/logrus/issues/729/labels{/name}","comments_url":"https://api.github.com/repos/sirupsen/logrus/issues/729/comments","events_url":"https://api.github.com/repos/sirupsen/logrus/issues/729/events","html_url":"https://github.com/sirupsen/logrus/issues/729","id":304810169,"node_id":"MDU6SXNzdWUzMDQ4MTAxNjk=","number":729,"title":"v1.0.5 breaks hooks that update the Entry","user":{"login":"fasaxc","id":469264,"node_id":"MDQ6VXNlcjQ2OTI2NA==","avatar_url":"https://avatars.githubusercontent.com/u/469264?v=4","gravatar_id":"","url":"https://api.github.com/users/fasaxc","html_url":"https://github.com/fasaxc","followers_url":"https://api.github.com/users/fasaxc/followers","following_url":"https://api.github.com/users/fasaxc/following{/other_user}","gists_url":"https://api.github.com/users/fasaxc/gists{/gist_id}","starred_url":"https://api.github.com/users/fasaxc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fasaxc/subscriptions","organizations_url":"https://api.github.com/users/fasaxc/orgs","repos_url":"https://api.github.com/users/fasaxc/repos","events_url":"https://api.github.com/users/fasaxc/events{/privacy}","received_events_url":"https://api.github.com/users/fasaxc/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2018-03-13T15:20:17Z","updated_at":"2019-04-18T04:53:19Z","closed_at":"2018-07-21T07:04:35Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"We've been using a Hook to add line number and file name information to the Entry for a long time.  Unfortunately https://github.com/sirupsen/logrus/pull/707 has broken our Hook.  Since it copies the Entry, our updates to it are lost when the fireHooks method returns.\r\n\r\nOur hook used this pattern to avoid mutating the Entry while it may have been read by another thread:\r\n```go\r\nnewData := make(log.Fields, len(entry.Data)+2)\r\nfor k, v := range entry.Data {\r\n\tnewData[k] = v\r\n}\r\nnewData[\"__file__\"] = path.Base(frame.File)\r\nnewData[\"__line__\"] = frame.Line\r\nentry.Data = newData\r\n```\r\nbut that no longer works.  I think that simply mutating the existing data map would be broken too.\r\n\r\nThis seems to work for a quick fix since it's the copy that gets logged out instead of the original Entry:\r\n```\r\n- entry.fireHooks()\r\n+ entry = entry.fireHooks()\r\n...\r\n- func (entry Entry) fireHooks() {\r\n+ func (entry Entry) fireHooks() Entry {\r\n \tentry.Logger.mu.Lock()\r\n \tdefer entry.Logger.mu.Unlock()\r\n \terr := entry.Logger.Hooks.Fire(entry.Level, &entry)\r\n \tif err != nil { \r\n \t\tfmt.Fprintf(os.Stderr, \"Failed to fire hook: %v\\n\", err)\r\n \t}\r\n+\treturn entry\r\n }\r\n```\r\nI'll put up a PR for that.","closed_by":{"login":"dgsb","id":5495748,"node_id":"MDQ6VXNlcjU0OTU3NDg=","avatar_url":"https://avatars.githubusercontent.com/u/5495748?v=4","gravatar_id":"","url":"https://api.github.com/users/dgsb","html_url":"https://github.com/dgsb","followers_url":"https://api.github.com/users/dgsb/followers","following_url":"https://api.github.com/users/dgsb/following{/other_user}","gists_url":"https://api.github.com/users/dgsb/gists{/gist_id}","starred_url":"https://api.github.com/users/dgsb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dgsb/subscriptions","organizations_url":"https://api.github.com/users/dgsb/orgs","repos_url":"https://api.github.com/users/dgsb/repos","events_url":"https://api.github.com/users/dgsb/events{/privacy}","received_events_url":"https://api.github.com/users/dgsb/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sirupsen/logrus/issues/729/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sirupsen/logrus/issues/729/timeline","performed_via_github_app":null,"state_reason":"completed"}