{"url":"https://api.github.com/repos/sirupsen/logrus/issues/1383","repository_url":"https://api.github.com/repos/sirupsen/logrus","labels_url":"https://api.github.com/repos/sirupsen/logrus/issues/1383/labels{/name}","comments_url":"https://api.github.com/repos/sirupsen/logrus/issues/1383/comments","events_url":"https://api.github.com/repos/sirupsen/logrus/issues/1383/events","html_url":"https://github.com/sirupsen/logrus/issues/1383","id":1713942372,"node_id":"I_kwDOAM_0Yc5mKK9k","number":1383,"title":"v1.9.1 causes panic in writer","user":{"login":"Luap99","id":45212748,"node_id":"MDQ6VXNlcjQ1MjEyNzQ4","avatar_url":"https://avatars.githubusercontent.com/u/45212748?v=4","gravatar_id":"","url":"https://api.github.com/users/Luap99","html_url":"https://github.com/Luap99","followers_url":"https://api.github.com/users/Luap99/followers","following_url":"https://api.github.com/users/Luap99/following{/other_user}","gists_url":"https://api.github.com/users/Luap99/gists{/gist_id}","starred_url":"https://api.github.com/users/Luap99/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Luap99/subscriptions","organizations_url":"https://api.github.com/users/Luap99/orgs","repos_url":"https://api.github.com/users/Luap99/repos","events_url":"https://api.github.com/users/Luap99/events{/privacy}","received_events_url":"https://api.github.com/users/Luap99/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2023-05-17T13:37:54Z","updated_at":"2023-06-03T20:40:06Z","closed_at":"2023-06-03T20:40:06Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Found while updating to the lasted version:\r\n```\r\npanic: bufio.Scan: too many empty tokens without progressing\r\n\r\ngoroutine 27 [running]:\r\nbufio.(*Scanner).Scan(0xc000653f28)\r\n        /usr/lib/golang/src/bufio/scan.go:167 +0x82c\r\ngithub.com/sirupsen/logrus.(*Entry).writerScanner(0x0?, 0xc000014058, 0xc000152140)\r\n        /home/pholzing/go/src/github.com/containers/podman/vendor/github.com/sirupsen/logrus/writer.go:86 +0x11f\r\ncreated by github.com/sirupsen/logrus.(*Entry).WriterLevel\r\n        /home/pholzing/go/src/github.com/containers/podman/vendor/github.com/sirupsen/logrus/writer.go:57 +0x3d1\r\n```\r\n\r\nThis seems to be caused by https://github.com/sirupsen/logrus/pull/1376 which does not look correct. the split function never tells the scanner to stop. Second it even changes the behaviour because it now no longer splits at newlines.\r\n\r\n\r\nIt easy to reproduce, just apply this test to the repo here:\r\n```diff\r\ndiff --git a/writer_test.go b/writer_test.go\r\nindex 5c34927..a6f0b3c 100644\r\n--- a/writer_test.go\r\n+++ b/writer_test.go\r\n@@ -1,10 +1,15 @@\r\n package logrus_test\r\n \r\n import (\r\n+       \"bytes\"\r\n        \"log\"\r\n        \"net/http\"\r\n+       \"strings\"\r\n+       \"testing\"\r\n+       \"time\"\r\n \r\n        \"github.com/sirupsen/logrus\"\r\n+       \"github.com/stretchr/testify/assert\"\r\n )\r\n \r\n func ExampleLogger_Writer_httpServer() {\r\n@@ -32,3 +37,30 @@ func ExampleLogger_Writer_stdlib() {\r\n        // Not logrus imported under the name `log`.\r\n        log.SetOutput(logger.Writer())\r\n }\r\n+\r\n+func TestWriterSplitNewlines(t *testing.T) {\r\n+       buf := bytes.NewBuffer(nil)\r\n+       logger := logrus.New()\r\n+       logger.Formatter = &logrus.TextFormatter{\r\n+               DisableColors:    true,\r\n+               DisableTimestamp: true,\r\n+       }\r\n+       logger.SetOutput(buf)\r\n+       writer := logger.Writer()\r\n+\r\n+       const logNum = 10\r\n+\r\n+       for i := 0; i < logNum; i++ {\r\n+               _, err := writer.Write([]byte(\"bar\\nfoo\\n\"))\r\n+               if err != nil {\r\n+                       assert.NoError(t, err, \"write.Write failed\")\r\n+               }\r\n+       }\r\n+       writer.Close()\r\n+       // Test is flaky because it writes in another goroutine,\r\n+       // we need to make sure to wait a bit so all write are done.\r\n+       time.Sleep(500 * time.Millisecond)\r\n+\r\n+       lines := strings.Split(strings.TrimRight(buf.String(), \"\\n\"), \"\\n\")\r\n+       assert.Len(t, lines, logNum*2, \"logger printed incorrect number of lines\")\r\n+}\r\n```\r\n","closed_by":{"login":"sirupsen","id":97400,"node_id":"MDQ6VXNlcjk3NDAw","avatar_url":"https://avatars.githubusercontent.com/u/97400?v=4","gravatar_id":"","url":"https://api.github.com/users/sirupsen","html_url":"https://github.com/sirupsen","followers_url":"https://api.github.com/users/sirupsen/followers","following_url":"https://api.github.com/users/sirupsen/following{/other_user}","gists_url":"https://api.github.com/users/sirupsen/gists{/gist_id}","starred_url":"https://api.github.com/users/sirupsen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sirupsen/subscriptions","organizations_url":"https://api.github.com/users/sirupsen/orgs","repos_url":"https://api.github.com/users/sirupsen/repos","events_url":"https://api.github.com/users/sirupsen/events{/privacy}","received_events_url":"https://api.github.com/users/sirupsen/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sirupsen/logrus/issues/1383/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/sirupsen/logrus/issues/1383/timeline","performed_via_github_app":null,"state_reason":"completed"}