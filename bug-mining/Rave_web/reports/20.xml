<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:25:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[RAVE-838] Performance problems after model-split merge</title>
                <link>https://issues.apache.org/jira/browse/RAVE-838</link>
                <project id="12311290" key="RAVE">Rave</project>
                    <description>&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;WidgetServer/Repository.get is being called much more frequently with the RegionWidget/Widget split.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="12614085">RAVE-838</key>
            <summary>Performance problems after model-split merge</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="geerzo">Chris Geer</assignee>
                                    <reporter username="geerzo">Chris Geer</reporter>
                        <labels>
                    </labels>
                <created>Tue, 30 Oct 2012 21:20:35 +0000</created>
                <updated>Mon, 7 Jan 2013 21:09:12 +0000</updated>
                                            <version>0.18</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13487346" author="geerzo" created="Tue, 30 Oct 2012 23:03:51 +0000"  >&lt;p&gt;Updated the OpenSocialWidgetRenderer and EncrypedBlobSecurityTokenService to use the WidgetService instead of the WidgetRepository directly.&lt;/p&gt;

&lt;p&gt;Subversion: Committed revision 1403920.&lt;/p&gt;</comment>
                            <comment id="13487350" author="geerzo" created="Tue, 30 Oct 2012 23:06:56 +0000"  >&lt;p&gt;I have implemented a change locally where I&apos;m caching the widgets on load into a hashmap in the WidgetRepository. This really helps since the widgets are &quot;loaded&quot; much more often now after the split but it&apos;s not a very elegant solution. I can commit it for 0.17 and we can improve the solution in the future if people think it&apos;s ok for now.&lt;/p&gt;

&lt;p&gt;Thoughts?&lt;/p&gt;</comment>
                            <comment id="13487690" author="mfranklin" created="Wed, 31 Oct 2012 11:53:58 +0000"  >&lt;p&gt;Jpa has its own caching strategy that IMO should be investigated before  a custom one.  However, I would hesitate to depend on it to get around an issue rather than solving it.  I haven&apos;t looked at the code yet, but why would the widget ever be needed during page render except for during the regionWidget rendering process?&lt;/p&gt;</comment>
                            <comment id="13487736" author="mfranklin" created="Wed, 31 Oct 2012 12:58:49 +0000"  >&lt;p&gt;I looked at the code and see now what Ate was referring to.  We are using the widget object in 3 places during the render cycle:&lt;/p&gt;

&lt;p&gt;   1) In the region_widget.tag JSP tag&lt;br/&gt;
   2) In the RegionWidgetTag.java tag&lt;br/&gt;
   3) In the OpenSocial Renderer&lt;/p&gt;

&lt;p&gt;At this point, my recommendation would be the same as Ate&apos;s:  Remove the controller code to get tags and put them into the context in favor of an &quot;on demand&quot; java tag that adds the specified widget to the context a la PersonTag.java.  I would also update the renderer interface to take a Widget instance as well as a RegionWidget so that the OpenSocial renderer doesn&apos;t have to go back to the repository for the widget information.  This way, the widget object is requested one time and is passed through the remainder of the render cycle.  &lt;/p&gt;</comment>
                            <comment id="13487740" author="adouma" created="Wed, 31 Oct 2012 13:06:00 +0000"  >&lt;p&gt;I agree we better/best let the persistence engine (JPA) handle caching when possible.&lt;/p&gt;

&lt;p&gt;I just traced one page render request,with only a single widget on that page and found it invokes the WigetRepository 4x to load that single Widget:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;PageController: storing a list of widgets in the modelMap&lt;/li&gt;
	&lt;li&gt;DefaultRenderService: called from RegionWidgetTag needing the Widget type to determine the concrete WidgetRenderer&lt;/li&gt;
	&lt;li&gt;OpenSocialWidgetRenderer: called from DefaultRenderService needing the Widget type to validate it its capable of rendering it&lt;/li&gt;
	&lt;li&gt;EncryptedBlobSecurityTokenService: called from OpenSocialWidgetRenderer needing the Widget URL for the regionwidget script block&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Note that this single page request now takes about 14 seconds (which is much better than yesterdays 40 seconds range). The tested widget is the &apos;static&apos; CurrentSchedule widget (e.g. doesn&apos;t add any real overhead itself).&lt;br/&gt;
When I add a second widget to the page (Favorite Websites, adding CurrentSchedule twice causing other problems), the page rendering time goes up 21 sec.&lt;br/&gt;
And with zero widgets on the page the render time goes down to about 7 seconds.&lt;br/&gt;
Based on this (too) trivial testing, it seems a single retrieval of a Widget through the WidgetRepository takes about 7/4 = ~1.75 seconds. Which IMO is way too slow (mildly stated).&lt;/p&gt;

&lt;p&gt;So, regardless caching or not, overall persistence manager object access seems way too slow anyway.&lt;br/&gt;
Caching can and will definitely help, as will be reducing obvious redundant retrieval within our own code.&lt;br/&gt;
But IMO the problem lies deeper than that. In the (new) model structure and mapping, the JPA engine configuration, or maybe both. &lt;/p&gt;</comment>
                            <comment id="13487762" author="mfranklin" created="Wed, 31 Oct 2012 13:25:47 +0000"  >&lt;p&gt;IMO, I think the caching is the last thing we need to do at the moment.  If we modify the code per above, 4 (I missed one earlier) requests will simply become 1 as the widget repository will only be called to make the object available to the context.  &lt;/p&gt;

&lt;p&gt;As for the time it takes to get a widget out of the database, 1.75 seconds to map an object out of the H2 database is extremely slow and definitely warrants a deep look. &lt;/p&gt;

&lt;p&gt;Unless anyone objects, I will refactor the code so that widget repository is called only 1 time per widget.&lt;/p&gt;</comment>
                            <comment id="13487776" author="adouma" created="Wed, 31 Oct 2012 13:46:44 +0000"  >&lt;p&gt;Agreed on all points.&lt;/p&gt;

&lt;p&gt;I&apos;ll also will open a discussion on the mailing list later today (when I have more time) if and how we should do the intended 0.17 release for today.&lt;br/&gt;
A Rave 0.17 release which takes 7 seconds to rendering a page without even a single widget isn&apos;t so great. Maybe we should postpone, or otherwise qualify it as a &apos;-dev&apos; only release. &lt;/p&gt;</comment>
                            <comment id="13487821" author="geerzo" created="Wed, 31 Oct 2012 14:30:04 +0000"  >&lt;p&gt;@Matt - I agree with your assessment of refactoring the code to pass the widget down the stack. I had actually started down that path yesterday but I wanted to talk it through first, and you beat me to it. &lt;/p&gt;

&lt;p&gt;@Ate - I&apos;m still concerned about your performance numbers. The longest I&apos;ve seen it take on the full canonical page is 5 seconds, and that is rare. Also, when I profiled the code, the vast majority of the time is at the WidgetRepository.get level so it would appear the slow down is either JPA or H2. I&apos;m not sure why that would be any slower now than before, other than multiple calls.&lt;/p&gt;</comment>
                            <comment id="13487909" author="adouma" created="Wed, 31 Oct 2012 16:20:47 +0000"  >&lt;p&gt;Hi Chris,&lt;/p&gt;

&lt;p&gt;Concerning the performance numbers: maybe this is only me and in that case should be less critical.&lt;br/&gt;
But so far I haven&apos;t seen anyone else chiming in with concrete figures.&lt;br/&gt;
For sure I don&apos;t get 5 seconds or below responses, 7 seconds being the fastest I can get it, and then without any widgets.&lt;br/&gt;
Note: I&apos;m using a plain Rave trunk stack, no customization at all, standard H2 database, etc. &lt;br/&gt;
If at least one or two others have similar performance results as you, it might be OK to ignore my results (that is: for the 0.17 release), but I&apos;d like to know for sure.&lt;br/&gt;
And then still: why do I see this difference? Before the branch merge I had full page render results in the range of 1 second or faster, so everything else being the same, that merge causes the difference, at least for me.&lt;/p&gt;</comment>
                            <comment id="13487923" author="geerzo" created="Wed, 31 Oct 2012 16:33:43 +0000"  >&lt;p&gt;Ate, I agree, the merge is causing the issues, just curious why it&apos;s so dramatic on your box. One side effect of the split is that we have to retrieve objects (Widgets, Users...) in more places now. My original intent was to do caching along with the model split but since I wasn&apos;t seeing a dramatic performance problem I wasn&apos;t as worried about it and decided to push for the merge sooner. I guess that&apos;s the downside of having a relatively fast dev box. There is no reason why we should be reading the same object from the DB multiple times in short spans, there needs to be caching of some sort. Matt is working on reducing the number of calls required to get a Widget which will help but we still need to think about the caching. I understand JPA has caching, but I really think putting caching at the Service layer might be the best option since it would work regardless of the backend. Maybe use ehCache like Shindig does as a default?&lt;/p&gt;

&lt;p&gt;On a side note, using Rave against MySQL, I&apos;m seeing the same performance now as before the merge. I&apos;m assuming MySQL is doing some level of caching of data somewhere that H2 doesn&apos;t do.&lt;/p&gt;</comment>
                            <comment id="13487945" author="adouma" created="Wed, 31 Oct 2012 16:50:45 +0000"  >&lt;p&gt;Looks like my MacBook Pro 2011, i7 with 8 Gb memory (and running Linux, 3.6.2 kernel) no longer can be considered &apos;fast enough&apos; for development &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;

&lt;p&gt;Seriously: I would expect my dev machine to be fast enough as reference for things like this...&lt;br/&gt;
Anyway, for sure faster machines are available today which should reduce the performance impact I&apos;m seeing.&lt;br/&gt;
And I will try and test later this evening against MySQL as well to see if that makes a lot of difference. If it does and performance comes back to acceptable ranges, H2 might turn out to be the only culprit and I can live with that.&lt;/p&gt;

&lt;p&gt;I&apos;m in the process of composing an email to the mailing list with the options how to proceed from here. I&apos;ll send that off before I have to leave for home and dinner, and will chime back in later this evening.&lt;/p&gt;</comment>
                            <comment id="13487971" author="geerzo" created="Wed, 31 Oct 2012 17:12:56 +0000"  >&lt;p&gt;The only difference (potentially) between our machines is I have a SSD in mine. We really need other input.&lt;/p&gt;</comment>
                            <comment id="13488208" author="adouma" created="Wed, 31 Oct 2012 20:39:15 +0000"  >&lt;p&gt;I have more input: when using MySQL instead of H2, &apos;normal&apos; performance is back!&lt;br/&gt;
Now, the full default canonical page renders within a second again.&lt;br/&gt;
Looks like it is the new model and mapping (or how OpenJPA executes that) which somehow causes seriously problems with H2.&lt;/p&gt;

&lt;p&gt;Of course, we use H2 primarily as default/development database, and if it is a H2 only quirk, I&apos;d even consider dropping/replacing H2.&lt;br/&gt;
But besides H2 quirks, there are certainly some implementation improvements we should address nonetheless, like what was discussed earlier and above.&lt;/p&gt;

&lt;p&gt;To me however this issue no longer is a blocker for the release itself, although we still need to indicate the out-of-the-box performance problems when using the H2 database.&lt;/p&gt;
</comment>
                            <comment id="13488210" author="mfranklin" created="Wed, 31 Oct 2012 20:42:28 +0000"  >&lt;p&gt;Did you by chance delete the h2 database from temp before running?  Maybe there are indexes being created by JPA.&lt;/p&gt;</comment>
                            <comment id="13488226" author="adouma" created="Wed, 31 Oct 2012 20:59:00 +0000"  >&lt;p&gt;I tried against H2 both with a new database and a previously seeded database, didn&apos;t make any difference.&lt;/p&gt;</comment>
                            <comment id="13488451" author="geerzo" created="Thu, 1 Nov 2012 04:35:49 +0000"  >&lt;p&gt;I updated the SecurityTokenService interface (EncryptedBlobSecurityTokenService) to take the widget instance along with the region widget. This eliminates another call to retrieve the widget.&lt;/p&gt;

&lt;p&gt;I also included configuration in the persistence.xml file that will enable JPA caching (commented out for now). This really helps performance when enabled. If we can show it doesn&apos;t have any side effects it would be good to turn on for performance. It takes a few page loads before the full potential is seen. I went from 1.5s to 500ms.&lt;/p&gt;</comment>
                            <comment id="13488570" author="adouma" created="Thu, 1 Nov 2012 09:30:26 +0000"  >&lt;p&gt;The jpa caching definitely helps: in my tests a two-widget page rendering goes down from 18 (yes: I&apos;m seeing some slower rendering this morning, not sure why) to about 7 seconds. Still not great but much better.&lt;br/&gt;
So I think that looking into jpa caching certainly is useful but it cannot serve as stop gag. &lt;/p&gt;</comment>
                            <comment id="13489313" author="geerzo" created="Fri, 2 Nov 2012 08:55:20 +0000"  >&lt;p&gt;Using JProfiler, I was able to profile the JPA calls directly for the first time which is helping shed some light on what&apos;s going on. Currently, on 0.17, when loading the default canonical home page, WdigetRepository.get is called 5 times, UserRepository.get is called 5 times, PersonRepository.get is called 3 times and four other JPA queries are run. Compare that with 0.16 where you just have the four JPA queries, no direct calls to any repository.get method.&lt;/p&gt;

&lt;p&gt;After digging into it a little more I came to the conclusion that it&apos;s not the number of calls that is the sole problem, it&apos;s the sheer amount of data loaded on each call. For example, on each widget call there has to be queries to load Widgets, WidgetComments, WidgetRatings, WidgetTags and Categories (missed that split). The frustrating thing is that none of those extra sets of data is actually used in any of the calls to load the page (that I saw), so we are loading lots of data (5 times) that is never used on that page. Now, for a lot of them, there isn&apos;t data by default but there is still an attempt to load data. There is the same problem when you look at person and user. As it turns out, JPA has a solution to handle scenarios like this, Lazy fetch, which will only load the sub-data on demand which would be great. When I changed the Widget object to lazy fetch all the sub data the time spent in those calls dropped by ~70%. The major problem this introduced however was that the lazy data was never loaded. I couldn&apos;t find a way to fix that but maybe someone else with more JPA experience could have a look or explain why that&apos;s a really bad idea. &lt;/p&gt;

&lt;p&gt;EDIT: Looking at the H2 performance, it looks like each request to H2 spawns a new thread (or multiple threads). On the load of the canonical home page H2 spanwed (and killed) 16 separate threads on 0.16 and well over 100 separate threads on 0.17. I can&apos;t confirm if those are from a pool or what but that is a lot of short lived threads.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>253210</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 3 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0dcgn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>75948</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>