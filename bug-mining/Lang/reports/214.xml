<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:15:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LANG-762] Handle or document ReflectionToStringBuilder and ToStringBuilder for collections that are not thread safe</title>
                <link>https://issues.apache.org/jira/browse/LANG-762</link>
                <project id="12310481" key="LANG">Commons Lang</project>
                    <description>&lt;p&gt;Moving discussion here from &lt;a href=&quot;https://issues.apache.org/jira/browse/POOL-191&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/POOL-191&lt;/a&gt; ConcurrentModificationException in GenericObjectPool LinkedList.&lt;/p&gt;

&lt;p&gt;It is possible to get a &lt;tt&gt;ConcurrentModificationException&lt;/tt&gt; in a &lt;tt&gt;LinkedList&lt;/tt&gt; from a Commons Pool &lt;tt&gt;GenericObjectPool&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;This happens when I call &lt;tt&gt;ReflectionToStringBuilder.toString(this)&lt;/tt&gt; from a subclass of &lt;tt&gt;GenericObjectPool&lt;/tt&gt;. My guess is that it would happen with just &lt;tt&gt;ReflectionToStringBuilder.toString(gop)&lt;/tt&gt;. IOW, subclassing does not have anything to do with it I would venture.&lt;/p&gt;

&lt;p&gt;For example, in this stack trace &lt;tt&gt;JmsSessionPool&lt;/tt&gt; is a subclass of &lt;tt&gt;GenericObjectPool&lt;/tt&gt;.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.util.ConcurrentModificationException
at java.util.LinkedList$ListItr.checkForComodification(LinkedList.java:761)
at java.util.LinkedList$ListItr.next(LinkedList.java:696)
at java.util.AbstractCollection.toString(AbstractCollection.java:421)
at java.lang.String.valueOf(String.java:2826)
at java.lang.StringBuffer.append(StringBuffer.java:219)
at org.apache.commons.lang3.builder.ToStringStyle.appendDetail(ToStringStyle.java:598)
at org.apache.commons.lang3.builder.ToStringStyle.appendInternal(ToStringStyle.java:473)
at org.apache.commons.lang3.builder.ToStringStyle.append(ToStringStyle.java:436)
at org.apache.commons.lang3.builder.ToStringBuilder.append(ToStringBuilder.java:848)
at org.apache.commons.lang3.builder.ReflectionToStringBuilder.appendFieldsIn(ReflectionToStringBuilder.java:528)
at org.apache.commons.lang3.builder.ReflectionToStringBuilder.toString(ReflectionToStringBuilder.java:692)
at org.apache.commons.lang3.builder.ReflectionToStringBuilder.toString(ReflectionToStringBuilder.java:288)
at org.apache.commons.lang3.builder.ReflectionToStringBuilder.toString(ReflectionToStringBuilder.java:119)
at com.seagullsw.appinterface.comm.jms.JmsSessionPool.toString(JmsSessionPool.java:120)
at java.lang.String.valueOf(String.java:2826)
at java.lang.StringBuffer.append(StringBuffer.java:219)
at org.apache.commons.lang3.builder.ToStringStyle.appendDetail(ToStringStyle.java:586)
at org.apache.commons.lang3.builder.ToStringStyle.appendInternal(ToStringStyle.java:550)
at org.apache.commons.lang3.builder.ToStringStyle.append(ToStringStyle.java:436)
at org.apache.commons.lang3.builder.ToStringBuilder.append(ToStringBuilder.java:848)
at org.apache.commons.lang3.builder.ReflectionToStringBuilder.appendFieldsIn(ReflectionToStringBuilder.java:528)
at org.apache.commons.lang3.builder.ReflectionToStringBuilder.toString(ReflectionToStringBuilder.java:689)
at org.apache.commons.lang3.builder.ReflectionToStringBuilder.toString(ReflectionToStringBuilder.java:288)
at org.apache.commons.lang3.builder.ReflectionToStringBuilder.toString(ReflectionToStringBuilder.java:119)
at com.seagullsw.appinterface.server.comm.BasicCommunicationManager.toString(BasicCommunicationManager.java:828)
at com.seagullsw.appinterface.server.comm.BasicCommunicationManager.toString(BasicCommunicationManager.java:817)
at java.lang.String.valueOf(String.java:2826)
at java.lang.StringBuilder.append(StringBuilder.java:115)
at com.seagullsw.appinterface.server.AisHelper.waitForCommuncationManagers(AisHelper.java:217)
at com.seagullsw.appinterface.server.AisHelper.start(AisHelper.java:136)
at com.seagullsw.appinterface.server.AisHelper.startFromResource(AisHelper.java:161)
at com.seagullsw.appinterface.server.AbstractServerJunit4.startServer(AbstractServerJunit4.java:179)
at com.seagullsw.appinterface.server.comm.jms.AbstractJmsRoundtripMaxConcurrencyTestCase.setUpOnce(AbstractJmsRoundtripMaxConcurrencyTestCase.java:141)
at com.seagullsw.appinterface.server.comm.jms.ibmmq.JmsRoundtripMaxConcurrency032TestCase.setUpOnce(JmsRoundtripMaxConcurrency032TestCase.java:40)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We should either: &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Document ReflectionToStringBuilder and ToStringBuilder such that call sites use synchronized if the object passed in contains collections that are not thread-safe. F&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;or example:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; toString() {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ReflectionToStringBuilder.toString(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Or have our code in ReflectionToStringBuilder and ToStringBuilder lock collections while they are being toString&apos;d.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment>&lt;p&gt;Apache Maven 3.0.3 (r1075438; 2011-02-28 12:31:09-0500)&lt;br/&gt;
Maven home: C:\Java\apache-maven-3.0.3\bin\..&lt;br/&gt;
Java version: 1.6.0_24, vendor: Sun Microsystems Inc.&lt;br/&gt;
Java home: C:\Program Files\Java\jdk1.6.0_24\jre&lt;br/&gt;
Default locale: en_US, platform encoding: Cp1252&lt;br/&gt;
OS name: &quot;windows 7&quot;, version: &quot;6.1&quot;, arch: &quot;amd64&quot;, family: &quot;windows&quot;&lt;/p&gt;</environment>
        <key id="12527474">LANG-762</key>
            <summary>Handle or document ReflectionToStringBuilder and ToStringBuilder for collections that are not thread safe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="2">Won&apos;t Fix</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="ggregory">Gary D. Gregory</reporter>
                        <labels>
                    </labels>
                <created>Mon, 17 Oct 2011 18:20:48 +0000</created>
                <updated>Mon, 21 Oct 2013 19:51:56 +0000</updated>
                            <resolved>Mon, 21 Oct 2013 19:51:56 +0000</resolved>
                                                    <fixVersion>3.2</fixVersion>
                                    <component>lang.builder.*</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13133221" author="acumiskey" created="Sat, 22 Oct 2011 01:59:57 +0000"  >&lt;p&gt;I tried pretty hard to try and reproduce ConcurrentModificationException in a fairly elaborate multithreaded unit test (but alas failed...).&lt;/p&gt;

&lt;p&gt;I looked at the two approaches you proposed for fixing this issue.  I believe it is not correct to expect the ReflectionToStringBuilder caller to synchronize his toString() implementation.  &lt;/p&gt;

&lt;p&gt;I believe the best place for the guard is just prior to the object being appended by the StringBuffer.  I have provided a small patch that takes care of synchronizing any Collection or Map in ToStringStyle. &lt;/p&gt;

&lt;p&gt;Cheers, Adrian.&lt;/p&gt;</comment>
                            <comment id="13133236" author="garydgregory" created="Sat, 22 Oct 2011 03:11:08 +0000"  >&lt;p&gt;I&apos;ll have to provide my test case that shows the failure. I&apos;m on vacation now so it might be a couple of days.&lt;/p&gt;</comment>
                            <comment id="13133249" author="acumiskey" created="Sat, 22 Oct 2011 05:26:49 +0000"  >&lt;p&gt;Hi Gary,&lt;/p&gt;

&lt;p&gt;No problem.  That would be great if you are able to provide a test case which is able to reliably reproduce the failure on trunk.  It might be the following weekend before I get chance to revisit if the patch doesn&apos;t resolve the issue.  Enjoy your vacation! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Cheers, Adrian.&lt;/p&gt;</comment>
                            <comment id="13133286" author="psteitz" created="Sat, 22 Oct 2011 07:11:58 +0000"  >&lt;p&gt;Attaching a test that illustrates the problem, which I don&apos;t think is solvable by the &lt;span class=&quot;error&quot;&gt;&amp;#91;lang&amp;#93;&lt;/span&gt; code (so probably this class should not be committed, as it will never pass).&lt;/p&gt;

&lt;p&gt;The problem is that when you circumvent a class&apos; internal synchronization to protect fields, all bets are off in terms of data integrity or CoMod exceptions. This should be clearly documented - i.e., users should be warned that this class should not be used in concurrent applications, or at least fields protected by synchronization should be excluded.&lt;/p&gt;

&lt;p&gt;What is going on in the test case is that there are two different kinds of threads spawned concurrently - one kind uses the reflection back door opened by the builder to &quot;inspect&quot; an instance and the other kind mutates the instance using its synchronized methods.  Note that synchronizing the builder using the private field&apos;s monitor will not solve the problem (i.e., the first patch does not work) because what really needs to happen is that the access by the builder needs to be synchronized using the instance&apos;s monitor.  You could try to fix that by synchronizing on the instance, which would solve this example; but there is no guarantee that a class may not use its own internal locks, so there is no generic solution to this problem.&lt;/p&gt;

&lt;p&gt;My recommendation is to just document the danger associated with using reflection to access private fields in the class javadoc.&lt;/p&gt;</comment>
                            <comment id="13147091" author="garydgregory" created="Wed, 9 Nov 2011 15:17:55 +0000"  >&lt;p&gt;I&apos;ve added some unit tests, mostly @Ignore tests. I added Phil&apos;s test &lt;tt&gt;ReflectionToStringBuilderConcurrencyTest.java&lt;/tt&gt; from 22/Oct/11 07:11 as &lt;tt&gt;ReflectionToStringBuilderMutateInspectConcurrencyTest&lt;/tt&gt; because I already have a &lt;tt&gt;ReflectionToStringBuilderConcurrencyTest&lt;/tt&gt; in there.&lt;/p&gt;

&lt;p&gt;This should make it easier for people to experiment with suggestions and patches.&lt;/p&gt;

&lt;p&gt;For example, the patch &lt;tt&gt;patch-LANG762.txt&lt;/tt&gt; from 22/Oct/11 01:59 does not work for on my machine.&lt;/p&gt;

&lt;p&gt;The test ReflectionToStringBuilderMutateInspectConcurrencyTest passes on my machine but I still @Ignored the test based on Phil&apos;s comments.&lt;/p&gt;
</comment>
                            <comment id="13147468" author="psteitz" created="Thu, 10 Nov 2011 03:29:10 +0000"  >&lt;p&gt;Looking at this again, I am pretty well convinced that &lt;span class=&quot;error&quot;&gt;&amp;#91;lang&amp;#93;&lt;/span&gt; is never going to be able to &quot;fix&quot; this issue.  Consider the case where a class uses its own private Lock instances to protect data members.  Unless you want to get into the byte code analysis business, you are not going to be able to pick this up or access the relevant locks.  Moreoever, even if you could discern and acquire the right locks, you might risk introducing deadlocks or liveness problems for the code, because the class may have lock acquisition / release order invariants that you don&apos;t know about.&lt;/p&gt;

&lt;p&gt;The risks associated with using the ReflectionToStringBuilder to access fields protected by synchronization should be documented. I would suggest just adding something like the following to the class javadoc, after the sentence that reads &quot;This will fail under a security manager, unless the appropriate permissions are set up correctly&quot; add &quot;Using reflection to access private fields also circumvents any synchronization protection guarding access to private fields.  Fields that cannot safely be read at any time by toString should be excluded from the generated method, or synchronization consistent with the underlying class&apos; lock management should be added around invocation of the method. Special care should be taken to avoid including non-threadsafe collection classes, as these classes may throw ConcurrentModificationException if modified while the toString method is executing.&quot;&lt;/p&gt;

&lt;p&gt;Above is probably too long, but something like it should be added.&lt;/p&gt;</comment>
                            <comment id="13147513" author="garydgregory" created="Thu, 10 Nov 2011 06:15:09 +0000"  >&lt;p&gt;Better Javadocs: Committed revision 1200177.&lt;/p&gt;</comment>
                            <comment id="13801002" author="bayard" created="Mon, 21 Oct 2013 19:51:56 +0000"  >&lt;p&gt;Issue documented in 3.2, but no code change made. Reading through the conversation, consensus appears to me to be to make no code change to Lang.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12500310" name="ReflectionToStringBuilderConcurrencyTest.java" size="3222" author="psteitz" created="Sat, 22 Oct 2011 07:11:58 +0000"/>
                            <attachment id="12500277" name="patch-LANG762.txt" size="886" author="acumiskey" created="Sat, 22 Oct 2011 01:59:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>88662</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 4 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0b5lb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>63018</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>