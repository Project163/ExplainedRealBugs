{"url":"https://api.github.com/repos/rails/rails/issues/53682","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/53682/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/53682/comments","events_url":"https://api.github.com/repos/rails/rails/issues/53682/events","html_url":"https://github.com/rails/rails/issues/53682","id":2676463913,"node_id":"I_kwDNIULOn4eZKQ","number":53682,"title":"The description of to_prepare and middleware stack is inaccurate","user":{"login":"ransombriggs","id":62452,"node_id":"MDQ6VXNlcjYyNDUy","avatar_url":"https://avatars.githubusercontent.com/u/62452?v=4","gravatar_id":"","url":"https://api.github.com/users/ransombriggs","html_url":"https://github.com/ransombriggs","followers_url":"https://api.github.com/users/ransombriggs/followers","following_url":"https://api.github.com/users/ransombriggs/following{/other_user}","gists_url":"https://api.github.com/users/ransombriggs/gists{/gist_id}","starred_url":"https://api.github.com/users/ransombriggs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ransombriggs/subscriptions","organizations_url":"https://api.github.com/users/ransombriggs/orgs","repos_url":"https://api.github.com/users/ransombriggs/repos","events_url":"https://api.github.com/users/ransombriggs/events{/privacy}","received_events_url":"https://api.github.com/users/ransombriggs/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":150377,"node_id":"MDU6TGFiZWwxNTAzNzc=","url":"https://api.github.com/repos/rails/rails/labels/docs","name":"docs","color":"02d7e1","default":false,"description":null},{"id":384913768,"node_id":"MDU6TGFiZWwzODQ5MTM3Njg=","url":"https://api.github.com/repos/rails/rails/labels/good%20first%20issue","name":"good first issue","color":"0e8a16","default":true,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2024-11-20T16:37:36Z","updated_at":"2024-11-27T20:01:05Z","closed_at":"2024-11-27T08:30:04Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Steps to reproduce\r\n\r\nThe documentation is inaccurate in [Initialization Events](https://guides.rubyonrails.org/configuring.html), specifically this block.\r\n\r\n> to_prepare: Run after the initializers are run for all Railties (including the application itself), but before eager loading and the middleware stack is built. More importantly, will run upon every code reload in development, but only once (during boot-up) in production and test.\r\n\r\nWhen I tried to add a middleware in a `to_prepare` block I get a frozen error.  This is because the [to_prepare is run after the build_middleware_stack](https://github.com/rails/rails/blob/v8.0.0/railties/lib/rails/application/finisher.rb#L56-L74) initializer.  The documentation says that the `to_prepare` runs before the middleware stack, but that does not appear to be the case.\r\n\r\n```\r\nRails.application.config.to_prepare do\r\n  Rails.configuration.middleware.insert_before ActionDispatch::Cookies, MyMiddleware\r\nend\r\n```\r\n\r\n```\r\nactionpack-7.0.8.4/lib/action_dispatch/middleware/stack.rb:102:in `insert': can't modify frozen Array: [...] (FrozenError)\r\n```\r\n\r\n### Expected behavior\r\n\r\nI expected to be able to insert a middleware in a `to_prepare` block\r\n\r\n### Actual behavior\r\n\r\nI receive a `FrozenError` because it has already been built.\r\n\r\n### System configuration\r\n**Rails version**:\r\n\r\n7.0.8.4\r\n\r\n**Ruby version**:\r\n\r\n3.2.4\r\n","closed_by":{"login":"skipkayhil","id":6014046,"node_id":"MDQ6VXNlcjYwMTQwNDY=","avatar_url":"https://avatars.githubusercontent.com/u/6014046?v=4","gravatar_id":"","url":"https://api.github.com/users/skipkayhil","html_url":"https://github.com/skipkayhil","followers_url":"https://api.github.com/users/skipkayhil/followers","following_url":"https://api.github.com/users/skipkayhil/following{/other_user}","gists_url":"https://api.github.com/users/skipkayhil/gists{/gist_id}","starred_url":"https://api.github.com/users/skipkayhil/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/skipkayhil/subscriptions","organizations_url":"https://api.github.com/users/skipkayhil/orgs","repos_url":"https://api.github.com/users/skipkayhil/repos","events_url":"https://api.github.com/users/skipkayhil/events{/privacy}","received_events_url":"https://api.github.com/users/skipkayhil/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/53682/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/53682/timeline","performed_via_github_app":null,"state_reason":"completed"}