{"url":"https://api.github.com/repos/rails/rails/issues/48884","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/48884/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/48884/comments","events_url":"https://api.github.com/repos/rails/rails/issues/48884/events","html_url":"https://github.com/rails/rails/issues/48884","id":1836447313,"node_id":"I_kwDNIULObXX2UQ","number":48884,"title":"7.0.6 changed the i18n behavior of validation messages for `base` in autosave associations","user":{"login":"wata727","id":9624059,"node_id":"MDQ6VXNlcjk2MjQwNTk=","avatar_url":"https://avatars.githubusercontent.com/u/9624059?v=4","gravatar_id":"","url":"https://api.github.com/users/wata727","html_url":"https://github.com/wata727","followers_url":"https://api.github.com/users/wata727/followers","following_url":"https://api.github.com/users/wata727/following{/other_user}","gists_url":"https://api.github.com/users/wata727/gists{/gist_id}","starred_url":"https://api.github.com/users/wata727/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wata727/subscriptions","organizations_url":"https://api.github.com/users/wata727/orgs","repos_url":"https://api.github.com/users/wata727/repos","events_url":"https://api.github.com/users/wata727/events{/privacy}","received_events_url":"https://api.github.com/users/wata727/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2023-08-04T10:02:33Z","updated_at":"2023-08-07T07:10:06Z","closed_at":"2023-08-04T19:57:58Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"From v7.0.6, the behavior regarding i18n of autosave associations validation errors added to `base` has been changed. This change was introduced in https://github.com/rails/rails/pull/48413 (I know this has been reverted in https://github.com/rails/rails/pull/48871, but the behavior hasn't changed).\r\n\r\nThis broke our use case of adding to the `base`, which is configured as `\"\"`. This may have been intentional, but I've decided to open this issue in order to share our use case.\r\n\r\n### Background\r\n\r\n- Add validation errors to `base` that are not related to a column (e.g. depending on multiple columns).\r\n- An entity is stored in multiple models (imagine the [Delegated Types example](https://api.rubyonrails.org/v7.0.6/classes/ActiveRecord/DelegatedType.html)).\r\n- Add validation errors to the delegated association.\r\n\r\n### Steps to reproduce\r\n\r\nBelow is a simplified example of our use case. This works fine in v7.0.5.\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activerecord\", '7.0.5'\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\n\r\nI18n.backend.store_translations(\r\n  :en,\r\n  activerecord: {\r\n    attributes: {\r\n      comment: {\r\n        entity: \"Comment\"\r\n      },\r\n      entity: {\r\n        base: \"\",\r\n      }\r\n    }\r\n  }\r\n)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :comments, force: true do |t|\r\n  end\r\n\r\n  create_table :entities, force: true do |t|\r\n    t.integer :comment_id\r\n  end\r\nend\r\n\r\nclass Comment < ActiveRecord::Base\r\n  has_one :entity, autosave: true\r\n\r\n  validates :entity, presence: true\r\nend\r\n\r\nclass Entity < ActiveRecord::Base\r\n  validate ->() { errors.add(:base, \"This operation is not allowed\") }\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_without_entity\r\n    comment = Comment.new\r\n\r\n    assert_predicate(comment, :invalid?)\r\n    assert_equal([\"Comment can't be blank\"], comment.errors.full_messages.map(&:strip))\r\n  end\r\n\r\n  def test_with_entity\r\n    comment = Comment.new\r\n    comment.build_entity\r\n\r\n    assert_predicate(comment, :invalid?)\r\n    assert_equal([\"This operation is not allowed\"], comment.errors.full_messages.map(&:strip))\r\n  end\r\nend\r\n\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\nAll tests pass in v7.0.6.\r\n\r\n```\r\n# Running:\r\n\r\n..\r\n\r\nFinished in 0.007893s, 253.3891 runs/s, 506.7782 assertions/s.\r\n\r\n2 runs, 4 assertions, 0 failures, 0 errors, 0 skips\r\n```\r\n\r\nOr that there is a way to change the locale data to support this case.\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\nFirst, if I simply update to v7.0.6, the tests fail:\r\n\r\n```diff\r\n@@ -8,7 +8,7 @@ gemfile(true) do\r\n   git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n \r\n   # Activate the gem you are reporting the issue against.\r\n-  gem \"activerecord\", \"7.0.5\"\r\n+  gem \"activerecord\", \"7.0.6\"\r\n   gem \"sqlite3\"\r\n end\r\n```\r\n\r\n```\r\n# Running:\r\n\r\n.F\r\n\r\nFinished in 0.122810s, 16.2853 runs/s, 32.5706 assertions/s.\r\n\r\n  1) Failure:\r\nBugTest#test_with_entity [test.rb:68]:\r\n--- expected\r\n+++ actual\r\n@@ -1 +1 @@\r\n-[\"This operation is not allowed\"]\r\n+[\"Comment This operation is not allowed\"]\r\n\r\n\r\n2 runs, 4 assertions, 1 failures, 0 errors, 0 skips\r\n```\r\n\r\nThe other test fails when changed the locale data as below:\r\n\r\n```diff\r\n@@ -24,10 +24,9 @@ I18n.backend.store_translations(\r\n   activerecord: {\r\n     attributes: {\r\n       comment: {\r\n-        entity: \"Comment\"\r\n+        entity: \"\"\r\n       },\r\n       entity: {\r\n-        base: \"\",\r\n       }\r\n     }\r\n   }\r\n```\r\n\r\n```\r\n# Running:\r\n\r\n.F\r\n\r\nFinished in 0.007706s, 259.5380 runs/s, 519.0761 assertions/s.\r\n\r\n  1) Failure:\r\nBugTest#test_without_entity [test.rb:59]:\r\nExpected: [\"Comment can't be blank\"]\r\n  Actual: [\"can't be blank\"]\r\n\r\n2 runs, 4 assertions, 1 failures, 0 errors, 0 skips\r\n```\r\n\r\nOnly `base` is treated specially in https://github.com/rails/rails/pull/48413, so it works if changed to `_base`.\r\n\r\n```diff\r\n@@ -27,7 +27,7 @@ I18n.backend.store_translations(\r\n         entity: \"Comment\"\r\n       },\r\n       entity: {\r\n-        base: \"\"\r\n+        _base: \"\"\r\n       }\r\n     }\r\n   }\r\n@@ -49,7 +49,7 @@ class Comment < ActiveRecord::Base\r\n end\r\n \r\n class Entity < ActiveRecord::Base\r\n-  validate ->() { errors.add(:base, \"This operation is not allowed\") }\r\n+  validate ->() { errors.add(:_base, \"This operation is not allowed\") }\r\n end\r\n \r\n class BugTest < Minitest::Test\r\n```\r\n\r\n```\r\n# Running:\r\n\r\n..\r\n\r\nFinished in 0.006907s, 289.5613 runs/s, 579.1226 assertions/s.\r\n\r\n2 runs, 4 assertions, 0 failures, 0 errors, 0 skips\r\n```\r\n\r\nBut is this the right approach? Isn't it an issue that only `base` behaves differently in autosave than otherwise?\r\n\r\n### System configuration\r\n**Rails version**: 7.0.6\r\n\r\n**Ruby version**: 3.1.4\r\n","closed_by":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/48884/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/rails/rails/issues/48884/timeline","performed_via_github_app":null,"state_reason":"completed"}