{"url":"https://api.github.com/repos/rails/rails/issues/55771","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/55771/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/55771/comments","events_url":"https://api.github.com/repos/rails/rails/issues/55771/events","html_url":"https://github.com/rails/rails/issues/55771","id":3455343143,"node_id":"I_kwDNIULOzfRaJw","number":55771,"title":"Rails 8.0.2+ saves invalid records when required distantly associated records are marked for deletion (is correct on 8.0.1)","user":{"login":"ianterrell","id":54963,"node_id":"MDQ6VXNlcjU0OTYz","avatar_url":"https://avatars.githubusercontent.com/u/54963?v=4","gravatar_id":"","url":"https://api.github.com/users/ianterrell","html_url":"https://github.com/ianterrell","followers_url":"https://api.github.com/users/ianterrell/followers","following_url":"https://api.github.com/users/ianterrell/following{/other_user}","gists_url":"https://api.github.com/users/ianterrell/gists{/gist_id}","starred_url":"https://api.github.com/users/ianterrell/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ianterrell/subscriptions","organizations_url":"https://api.github.com/users/ianterrell/orgs","repos_url":"https://api.github.com/users/ianterrell/repos","events_url":"https://api.github.com/users/ianterrell/events{/privacy}","received_events_url":"https://api.github.com/users/ianterrell/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2025-09-25T23:42:37Z","updated_at":"2025-09-26T17:29:09Z","closed_at":"2025-09-26T17:29:09Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Steps to reproduce\n\nHave a model relationship with a `foo --* bar --* baz` like structure where nested attributes are accepted for the deeper models. Delete a distant model `baz` via nested attributes when `bar`'s validations require it not be deleted.\n\nIn this case, the instance of `bar` will be invalid, and therefore `foo` will be invalid, but the deletion will occur anyway in Rails 8.0.2 and up. This leads to an invalid model structure when it was valid before.\n\nThe deletion does not occur in Rails 8.0.1 and validity is preserved.\n\nA reproduction script follows, where the models are named `Parent`, `Child`, and `Grandchild` for simplicity, but I do not believe the tree-like structure is necessary.\n\n```ruby\n# frozen_string_literal: true\n\nrequire \"bundler/inline\"\n\ngemfile(true) do\n  source \"https://rubygems.org\"\n\n  # The tests pass in 8.0.1\n  # gem \"rails\", \"8.0.1\"\n\n  # The tests fail in 8.0.2\n  gem \"rails\", \"8.0.2\"\n\n  # and in 8.0.3\n  # gem \"rails\", \"8.0.3\"\n\n  gem \"sqlite3\"\nend\n\nrequire \"active_record/railtie\"\nrequire \"minitest/autorun\"\n\n# This connection will do for database-independent bug reports.\nENV[\"DATABASE_URL\"] = \"sqlite3::memory:\"\n\nclass TestApp < Rails::Application\n  config.load_defaults Rails::VERSION::STRING.to_f\n  config.eager_load = false\n  config.logger = Logger.new($stdout)\n  config.secret_key_base = \"secret_key_base\"\n\n  config.active_record.encryption.primary_key = \"primary_key\"\n  config.active_record.encryption.deterministic_key = \"deterministic_key\"\n  config.active_record.encryption.key_derivation_salt = \"key_derivation_salt\"\nend\nRails.application.initialize!\n\nActiveRecord::Schema.define do\n  create_table :parents, force: true do |t|\n  end\n\n  create_table :children, force: true do |t|\n    t.integer :parent_id\n  end\n\n  create_table :grandchildren, force: true do |t|\n    t.integer :child_id\n  end\nend\n\nclass Parent < ActiveRecord::Base\n  has_many :children\n  accepts_nested_attributes_for :children, allow_destroy: true\nend\n\nclass Child < ActiveRecord::Base\n  belongs_to :parent\n  has_many :grandchildren\n  accepts_nested_attributes_for :grandchildren, allow_destroy: true\n\n  validate :has_at_least_two_grandchildren\n\n  # This is a workaround for 8.0.2:\n  # def changed?\n  #   grandchildren.any? { |gc| gc.marked_for_destruction? } || super\n  # end\n\n  private\n\n  def has_at_least_two_grandchildren\n    current_grandchildren = grandchildren.select { |gc| !gc.marked_for_destruction? }\n    errors.add(:grandchildren, \"must have at least two grandchildren\") if current_grandchildren.size < 2\n  end\nend\n\nclass Grandchild < ActiveRecord::Base\n  belongs_to :child\nend\n\nclass BugTest < ActiveSupport::TestCase\n  setup do\n    @parent = Parent.create!\n    @child = @parent.children.new\n    @grandchild1 = @child.grandchildren.new\n    @grandchild2 = @child.grandchildren.new\n    @child.save!\n\n    @deletion_params = {\n      \"children_attributes\" => {\n        \"0\" => {\n          \"id\" => @child.id,\n          \"grandchildren_attributes\" => {\n            \"0\" => {\n              \"id\" => @grandchild1.id,\n              \"_destroy\" => '1',\n            },\n          }\n        }\n      }\n    }\n  end\n\n  test \"starts out in a valid state\" do\n    assert_predicate @parent, :valid?\n    assert_predicate @child, :valid?\n    assert_predicate @grandchild1, :valid?\n    assert_predicate @grandchild2, :valid?\n  end\n\n  test \"cannot update a parent with invalid child via deleting a grandchild\" do\n    refute @parent.update(@deletion_params), \"Parent should not update successfully\"\n  end\n\n  test \"failed update should not delete grandchild\" do\n    @parent.update(@deletion_params)\n    assert_nothing_raised do\n      @grandchild1.reload\n    end\n  end\n\n  test \"child should be invalid after failed update\" do\n    @parent.update(@deletion_params)\n    refute_predicate @child, :valid?\n    assert_includes @child.errors[:grandchildren], \"must have at least two grandchildren\"\n  end\n\n  test \"parent should be invalid when child is invalid after failed update\" do\n    @parent.update(@deletion_params)\n    refute_predicate @parent, :valid?\n    assert_includes @parent.errors[:\"children.grandchildren\"], \"must have at least two grandchildren\"\n  end\nend\n```\n\nNote that you can change the version to 8.0.1 and see that the tests pass. There is also a workaround commented out that can be uncommented to have the tests pass in 8.0.2 and above. \n\nIt also fails in 8.0.3, but 8.0.2 is used a reference since that is the first failing version.\n\n### Expected behavior\n\nAll tests should pass as they do in Rails 8.0.1.\n\nIn this case, the `Parent` instance should not be saved, because its existing `Child` instance is now invalid. The child is properly validated and expresses that it is invalid through adding an error.\n\n### Actual behavior\n\nThe `Parent` is saved, its `Child` instance is saved, and the `Grandchild` instance is deleted. Now the `Child` is invalid and the `Parent` is invalid, despite all records starting as valid.\n\n### Notes\n\nThis behavior was changed in\n\n- https://github.com/rails/rails/pull/53951 (cc @byroot)\n- https://github.com/rails/rails/pull/54273 (cc @Edouard-chin)\n\nNotably it is caused by this in `activerecord/lib/active_record/autosave_association.rb`:\n\n```ruby\nif record.changed? || record.new_record? || context\n  associated_errors = record.errors.objects\nelse\n  # If there are existing invalid records in the DB, we should still be able to reference them.\n  # Unless a record (no matter where in the association chain) is invalid and is being changed.\n  associated_errors = record.errors.objects.select { |error| error.is_a?(Associations::NestedError) }\nend\n```\n\nThe issue is there are _not_ existing invalid records in the database. Unfortunately, the change is occurring via an association with nested attributes and this is not reported via dirty tracking.\n\nAs a workaround, we can modify our own code like so:\n\n```ruby\ndef changed?\n  grandchildren.any? { |gc| gc.marked_for_destruction? } || super\nend\n```\n\nBut this is surprising behavior for a patch release since it worked through 8.0.1.\n\n### System configuration\n\n**Rails version**: 8.0.2+\n\n**Ruby version**: 3.4.1\n","closed_by":{"login":"byroot","id":44640,"node_id":"MDQ6VXNlcjQ0NjQw","avatar_url":"https://avatars.githubusercontent.com/u/44640?v=4","gravatar_id":"","url":"https://api.github.com/users/byroot","html_url":"https://github.com/byroot","followers_url":"https://api.github.com/users/byroot/followers","following_url":"https://api.github.com/users/byroot/following{/other_user}","gists_url":"https://api.github.com/users/byroot/gists{/gist_id}","starred_url":"https://api.github.com/users/byroot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/byroot/subscriptions","organizations_url":"https://api.github.com/users/byroot/orgs","repos_url":"https://api.github.com/users/byroot/repos","events_url":"https://api.github.com/users/byroot/events{/privacy}","received_events_url":"https://api.github.com/users/byroot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/55771/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/55771/timeline","performed_via_github_app":null,"state_reason":"completed"}