{"url":"https://api.github.com/repos/rails/rails/issues/50003","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/50003/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/50003/comments","events_url":"https://api.github.com/repos/rails/rails/issues/50003/events","html_url":"https://github.com/rails/rails/issues/50003","id":1987870492,"node_id":"I_kwDNIULOdnx_HA","number":50003,"title":"`filter_attributes` getting set to nil & `GeneratedAssociationMethods` generated multiple times when using `self.inherited` ","user":{"login":"Adrian-Hirt","id":13788379,"node_id":"MDQ6VXNlcjEzNzg4Mzc5","avatar_url":"https://avatars.githubusercontent.com/u/13788379?v=4","gravatar_id":"","url":"https://api.github.com/users/Adrian-Hirt","html_url":"https://github.com/Adrian-Hirt","followers_url":"https://api.github.com/users/Adrian-Hirt/followers","following_url":"https://api.github.com/users/Adrian-Hirt/following{/other_user}","gists_url":"https://api.github.com/users/Adrian-Hirt/gists{/gist_id}","starred_url":"https://api.github.com/users/Adrian-Hirt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Adrian-Hirt/subscriptions","organizations_url":"https://api.github.com/users/Adrian-Hirt/orgs","repos_url":"https://api.github.com/users/Adrian-Hirt/repos","events_url":"https://api.github.com/users/Adrian-Hirt/events{/privacy}","received_events_url":"https://api.github.com/users/Adrian-Hirt/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":126910270,"node_id":"MDU6TGFiZWwxMjY5MTAyNzA=","url":"https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps","name":"With reproduction steps","color":"009800","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/rails/rails/milestones/86","html_url":"https://github.com/rails/rails/milestone/86","labels_url":"https://api.github.com/repos/rails/rails/milestones/86/labels","id":10172820,"node_id":"MI_kwDNIULOAJs5lA","number":86,"title":"7.1.3","description":"","creator":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":7,"state":"closed","created_at":"2023-11-10T18:58:10Z","updated_at":"2024-01-16T23:09:21Z","due_on":null,"closed_at":"2024-01-16T23:05:16Z"},"comments":2,"created_at":"2023-11-10T15:45:42Z","updated_at":"2023-11-10T23:04:06Z","closed_at":"2023-11-10T23:04:05Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"While updating an app to rails `7.1.1`, I discovered a bug that occurs when using `self.inherited(subclass)` in models. As far as I can tell, this change in behaviour was introduced #47023, where @byroot worked on improving the shape friendliness of Rails.\r\nPlease note that the bug happens in a bit of an edgecase, and I'd also be okay with the issue being closed without code changes if you consider the producing code to be too much of an edgecase / bad practice in general.\r\n\r\n### Steps to reproduce\r\n\r\nConsider the following ruby script that can be run to showcase the bug. It defines two \"parent\" classes, `Vehicle` and `Device` that both define a `belongs_to` relation as well as a `filter_attribute` in their child classes via the `self.inherited` method.\r\n\r\nThe `device` class defines these *before* calling `super`, the `Vehicle` class definies these *after* calling `super`:\r\n\r\n(Again, please note that the code might be nonsensical, it's just to showcase the behaviour).\r\n\r\n```ruby\r\nrequire 'bundler/inline'\r\n\r\ngemfile(true) do\r\n  source 'https://rubygems.org'\r\n\r\n  gem 'activerecord', ENV.fetch('AR_VERSION', '7.0.8')\r\n  gem 'sqlite3'\r\nend\r\n\r\nrequire 'active_record'\r\n\r\nActiveRecord::Base.establish_connection(adapter: 'sqlite3', database: ':memory:')\r\n\r\n# Create the tables needed for the examples\r\nActiveRecord::Schema.define do\r\n  create_table :devices, force: true do |t|\r\n    t.string \"type\", null: false\r\n    t.belongs_to :person\r\n  end\r\n\r\n  create_table :vehicles, force: true do |t|\r\n    t.string \"type\", null: false\r\n    t.belongs_to :person\r\n  end\r\n\r\n  create_table :people, force: true\r\nend\r\n\r\n# If the ENV var `TOGGLER` is set to true, monkey-patch the `inherited` method\r\n# to only set the `@filter_attributes` and `@generated_association_methods`\r\n# variabes to nil if they are not already set to something.\r\nif ENV.fetch('TOGGLER', false) == 'true'\r\n  module ActiveRecord\r\n    module Core\r\n      module ClassMethods\r\n        def generated_association_methods # :nodoc:\r\n          @generated_association_methods ||= begin\r\n            puts \"Creating `GeneratedAssociationMethods` module for class #{self.name}\" # <= CHANGE FOR DEBUGGING HERE\r\n\r\n            mod = const_set(:GeneratedAssociationMethods, Module.new)\r\n            private_constant :GeneratedAssociationMethods\r\n            include mod\r\n\r\n            mod\r\n          end\r\n        end\r\n\r\n        private\r\n          def inherited(subclass)\r\n            super\r\n\r\n            # initialize cache at class definition for thread safety\r\n            subclass.initialize_find_by_cache\r\n            unless subclass.base_class?\r\n              klass = self\r\n              until klass.base_class?\r\n                klass.initialize_find_by_cache\r\n                klass = klass.superclass\r\n              end\r\n            end\r\n\r\n            subclass.class_eval do\r\n              @arel_table = nil\r\n              @predicate_builder = nil\r\n              @inspection_filter = nil\r\n              @filter_attributes ||= nil              # <= MONKEY PATCH HERE\r\n              @generated_association_methods ||= nil  # <= MONKEY PATCH HERE\r\n            end\r\n          end\r\n      end\r\n    end\r\n  end\r\nelse\r\n  module ActiveRecord\r\n    module Core\r\n      module ClassMethods\r\n        def generated_association_methods # :nodoc:\r\n          @generated_association_methods ||= begin\r\n            puts \"Creating `GeneratedAssociationMethods` module for class #{self.name}\" # <= CHANGE FOR DEBUGGING HERE\r\n\r\n            mod = const_set(:GeneratedAssociationMethods, Module.new)\r\n            private_constant :GeneratedAssociationMethods\r\n            include mod\r\n\r\n            mod\r\n          end\r\n        end\r\n      end\r\n    end\r\n  end\r\nend\r\n\r\n# Define an `ApplicationRecord` class\r\nclass ApplicationRecord < ActiveRecord::Base\r\n  self.abstract_class = true\r\nend\r\n\r\n# Create a `Person` class which we'll use for the `belongs_to` calls\r\n# futher below.\r\nclass Person < ApplicationRecord\r\n  has_many :devices\r\n  has_many :computers\r\n  has_many :smartphones\r\n\r\n  has_many :vehicles\r\n  has_many :cars\r\n  has_many :bikes\r\nend\r\n\r\n# Define a parent class for `Computer` and `Smartphone`. Please note that here\r\n# we add the `belongs_to` and `filter_attributes` to the child classes BEFORE\r\n# calling `super`.\r\nclass Device < ApplicationRecord\r\n  def self.inherited(subclass)\r\n    subclass.belongs_to :person, inverse_of: subclass.name.tableize.to_sym\r\n\r\n    subclass.filter_attributes = [:secret_attribute, :\"#{subclass.name.downcase}_key\"]\r\n\r\n    super\r\n  end\r\nend\r\nclass Computer < Device; end\r\nclass Smartphone < Device; end\r\n\r\n# Define a parent class for `Car` and `Bike`. Please note that here\r\n# we add the `belongs_to` and `filter_attributes` to the child classes AFTER\r\n# calling `super`.\r\nclass Vehicle < ApplicationRecord\r\n  def self.inherited(subclass)\r\n    super\r\n\r\n    subclass.belongs_to :person, inverse_of: subclass.name.tableize.to_sym\r\n\r\n    subclass.filter_attributes = [:secret_attribute, :\"#{subclass.name.downcase}_key\"]\r\n  end\r\nend\r\nclass Car < Vehicle; end\r\nclass Bike < Vehicle; end\r\n\r\n\r\nputs '-' * 30\r\nputs 'filter_attributes output'\r\nputs '-' * 30\r\n\r\nputs \"Computer.filter_attributes: #{Computer.filter_attributes}\"\r\nputs \"Smartphone.filter_attributes: #{Smartphone.filter_attributes}\"\r\nputs \"Car.filter_attributes: #{Car.filter_attributes}\"\r\nputs \"Bike.filter_attributes: #{Bike.filter_attributes}\"\r\n\r\nputs '-' * 30\r\nputs 'associations method output'\r\nputs '-' * 30\r\n\r\nputs \"Computer.new.respond_to?(:person=): #{Computer.new.respond_to?(:person=)}\"\r\nputs \"Smartphone.new.respond_to?(:person=): #{Smartphone.new.respond_to?(:person=)}\"\r\nputs \"Car.new.respond_to?(:person=): #{Car.new.respond_to?(:person=)}\"\r\nputs \"Bike.new.respond_to?(:person=): #{Bike.new.respond_to?(:person=)}\"\r\n\r\nputs \"Person.new.devices: #{Person.new.devices}\"\r\nputs \"Person.new.smartphones: #{Person.new.smartphones}\"\r\nputs \"Person.new.computers: #{Person.new.computers}\"\r\nputs \"Person.new.vehicles: #{Person.new.vehicles}\"\r\nputs \"Person.new.cars: #{Person.new.cars}\"\r\nputs \"Person.new.bikes: #{Person.new.bikes}\"\r\n\r\n```\r\n\r\n### Observed behavior\r\n\r\nIf I run the test script with ActiveRecord version `7.0.8` via `ruby script.rb`, the output is the following:\r\n\r\n```\r\n<snip>\r\nUsing activerecord 7.0.8\r\n<snip>\r\nCreating `GeneratedAssociationMethods` module for class ApplicationRecord\r\nCreating `GeneratedAssociationMethods` module for class Person\r\nCreating `GeneratedAssociationMethods` module for class Device\r\nCreating `GeneratedAssociationMethods` module for class Computer\r\nCreating `GeneratedAssociationMethods` module for class Smartphone\r\nCreating `GeneratedAssociationMethods` module for class Vehicle\r\nCreating `GeneratedAssociationMethods` module for class Car\r\nCreating `GeneratedAssociationMethods` module for class Bike\r\n------------------------------\r\nfilter_attributes output\r\n------------------------------\r\nComputer.filter_attributes: [:secret_attribute, :computer_key]\r\nSmartphone.filter_attributes: [:secret_attribute, :smartphone_key]\r\nCar.filter_attributes: [:secret_attribute, :car_key]\r\nBike.filter_attributes: [:secret_attribute, :bike_key]\r\n------------------------------\r\nassociations method output\r\n------------------------------\r\nComputer.new.respond_to?(:person=): true\r\nSmartphone.new.respond_to?(:person=): true\r\nCar.new.respond_to?(:person=): true\r\nBike.new.respond_to?(:person=): true\r\nPerson.new.devices: #<Device::ActiveRecord_Associations_CollectionProxy:0x00007f315d7072a0>\r\nPerson.new.smartphones: #<Smartphone::ActiveRecord_Associations_CollectionProxy:0x00007f315d705298>\r\nPerson.new.computers: #<Computer::ActiveRecord_Associations_CollectionProxy:0x00007f315d702f70>\r\nPerson.new.vehicles: #<Vehicle::ActiveRecord_Associations_CollectionProxy:0x00007f315d701328>\r\nPerson.new.cars: #<Car::ActiveRecord_Associations_CollectionProxy:0x00007f315d71f9b8>\r\nPerson.new.bikes: #<Bike::ActiveRecord_Associations_CollectionProxy:0x00007f315d71dc58>\r\n```\r\n\r\nThe `GeneratedAssociationMethods` module is created once per Class (as it is stored in the instance variable after the first call), the `filter_attributes` seem to work fine and the associations methods work as expected.\r\n\r\nWhen running the same script with ActiveRecord `7.1.0` via `AR_VERSION=7.1.0 ruby script.rb`, the output is:\r\n\r\n```\r\n<snip>\r\nUsing activerecord 7.1.0\r\n<snip>\r\nCreating `GeneratedAssociationMethods` module for classs ApplicationRecord\r\nCreating `GeneratedAssociationMethods` module for class Person\r\nCreating `GeneratedAssociationMethods` module for class Device\r\nCreating `GeneratedAssociationMethods` module for class Computer\r\nCreating `GeneratedAssociationMethods` module for class Computer\r\nscript.rb:81: warning: already initialized constant Computer::GeneratedAssociationMethods\r\nscript.rb:81: warning: previous definition of GeneratedAssociationMethods was here\r\nCreating `GeneratedAssociationMethods` module for class Smartphone\r\nCreating `GeneratedAssociationMethods` module for class Smartphone\r\nscript.rb:81: warning: already initialized constant Smartphone::GeneratedAssociationMethods\r\nscript.rb:81: warning: previous definition of GeneratedAssociationMethods was here\r\nCreating `GeneratedAssociationMethods` module for class Vehicle\r\nCreating `GeneratedAssociationMethods` module for class Car\r\nCreating `GeneratedAssociationMethods` module for class Bike\r\n------------------------------\r\nfilter_attributes output\r\n------------------------------\r\nComputer.filter_attributes: []\r\nSmartphone.filter_attributes: []\r\nCar.filter_attributes: [:secret_attribute, :car_key]\r\nBike.filter_attributes: [:secret_attribute, :bike_key]\r\n------------------------------\r\nassociations method output\r\n------------------------------\r\nComputer.new.respond_to?(:person=): true\r\nSmartphone.new.respond_to?(:person=): true\r\nCar.new.respond_to?(:person=): true\r\nBike.new.respond_to?(:person=): true\r\nPerson.new.devices: #<Device::ActiveRecord_Associations_CollectionProxy:0x00007f7f27ea1d40>\r\nPerson.new.smartphones: #<Smartphone::ActiveRecord_Associations_CollectionProxy:0x00007f7f27ed4358>\r\nPerson.new.computers: #<Computer::ActiveRecord_Associations_CollectionProxy:0x00007f7f27f0e8f0>\r\nPerson.new.vehicles: #<Vehicle::ActiveRecord_Associations_CollectionProxy:0x00007f7f27f0d180>\r\nPerson.new.cars: #<Car::ActiveRecord_Associations_CollectionProxy:0x00007f7f27f0bc40>\r\nPerson.new.bikes: #<Bike::ActiveRecord_Associations_CollectionProxy:0x00007f7f27f0a390>\r\n```\r\n\r\nAs you can see, the `GeneratedAssociationMethods` module is created twice for the `Computer` and `Smartphone` model, which generates the warnings. Also, the `filter_attributes` of the `Computer` and `Smartphone` model classes are both empty. Association methods still work as expected.\r\n\r\nFinally, when running with `TOGGLER=true AR_VERSION=7.1.0 ruby script.rb` which adds the monkey-patch to the `inherited` call, the output is the same as for `7.0.8`:\r\n\r\n```\r\n<snip>\r\nUsing activerecord 7.1.0\r\n<snip>\r\nCreating `GeneratedAssociationMethods` module for class ApplicationRecord\r\nCreating `GeneratedAssociationMethods` module for class Person\r\nCreating `GeneratedAssociationMethods` module for class Device\r\nCreating `GeneratedAssociationMethods` module for class Computer\r\nCreating `GeneratedAssociationMethods` module for class Smartphone\r\nCreating `GeneratedAssociationMethods` module for class Vehicle\r\nCreating `GeneratedAssociationMethods` module for class Car\r\nCreating `GeneratedAssociationMethods` module for class Bike\r\n------------------------------\r\nfilter_attributes output\r\n------------------------------\r\nComputer.filter_attributes: [:secret_attribute, :computer_key]\r\nSmartphone.filter_attributes: [:secret_attribute, :smartphone_key]\r\nCar.filter_attributes: [:secret_attribute, :car_key]\r\nBike.filter_attributes: [:secret_attribute, :bike_key]\r\n------------------------------\r\nassociations method output\r\n------------------------------\r\nComputer.new.respond_to?(:person=): true\r\nSmartphone.new.respond_to?(:person=): true\r\nCar.new.respond_to?(:person=): true\r\nBike.new.respond_to?(:person=): true\r\nPerson.new.devices: #<Device::ActiveRecord_Associations_CollectionProxy:0x00007f901d233480>\r\nPerson.new.smartphones: #<Smartphone::ActiveRecord_Associations_CollectionProxy:0x00007f901d2659a8>\r\nPerson.new.computers: #<Computer::ActiveRecord_Associations_CollectionProxy:0x00007f901d2602c8>\r\nPerson.new.vehicles: #<Vehicle::ActiveRecord_Associations_CollectionProxy:0x00007f901d29eb90>\r\nPerson.new.cars: #<Car::ActiveRecord_Associations_CollectionProxy:0x00007f901d29d6a0>\r\nPerson.new.bikes: #<Bike::ActiveRecord_Associations_CollectionProxy:0x00007f901d29be90>\r\n```\r\n\r\nHere, the warning does not appear and the `filter_attributes` still contain all the attributes.\r\n\r\n### System configuration\r\n**Rails version**: `7.0.8` / `7.1.0`\r\n\r\n**Ruby version**: 3.2.1\r\n\r\n### Additional comments\r\n\r\nAs said before, I'm perfectly fine with this issue not being worked on any further, I just wanted to bring this to attention. One easy solution would be to only set the instance variables to `nil` if they were not previously defined (i.e. changing the \r\n\r\n```ruby\r\n@filter_attributes = nil\r\n@generated_association_methods = nil\r\n```\r\n\r\ncode in `activerecord/lib/active_record/core.rb` to\r\n\r\n```ruby\r\n@filter_attributes ||= nil\r\n@generated_association_methods ||= nil\r\n```\r\n\r\nIf I understand correctly, this should not have a big impact on the performance, as these instance variables already were defined in the `belongs_to` and `filter_attributes` calls, which changed the shape of these objects. (Please correct me if I'm wrong). Maybe it could be worth checking if any of the other variables are also affected by such issues, these two are the only ones that I found. Please let me know if I should open a PR with an idea for a fix for this.","closed_by":{"login":"byroot","id":44640,"node_id":"MDQ6VXNlcjQ0NjQw","avatar_url":"https://avatars.githubusercontent.com/u/44640?v=4","gravatar_id":"","url":"https://api.github.com/users/byroot","html_url":"https://github.com/byroot","followers_url":"https://api.github.com/users/byroot/followers","following_url":"https://api.github.com/users/byroot/following{/other_user}","gists_url":"https://api.github.com/users/byroot/gists{/gist_id}","starred_url":"https://api.github.com/users/byroot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/byroot/subscriptions","organizations_url":"https://api.github.com/users/byroot/orgs","repos_url":"https://api.github.com/users/byroot/repos","events_url":"https://api.github.com/users/byroot/events{/privacy}","received_events_url":"https://api.github.com/users/byroot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/50003/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/50003/timeline","performed_via_github_app":null,"state_reason":"completed"}