{"url":"https://api.github.com/repos/rails/rails/issues/51164","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/51164/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/51164/comments","events_url":"https://api.github.com/repos/rails/rails/issues/51164/events","html_url":"https://github.com/rails/rails/issues/51164","id":2149141856,"node_id":"I_kwDNIULOgBlNYA","number":51164,"title":"`Model.query_constraints` with a single non-primary-key column raises a confusing error","user":{"login":"joshuay03","id":54629302,"node_id":"MDQ6VXNlcjU0NjI5MzAy","avatar_url":"https://avatars.githubusercontent.com/u/54629302?v=4","gravatar_id":"","url":"https://api.github.com/users/joshuay03","html_url":"https://github.com/joshuay03","followers_url":"https://api.github.com/users/joshuay03/followers","following_url":"https://api.github.com/users/joshuay03/following{/other_user}","gists_url":"https://api.github.com/users/joshuay03/gists{/gist_id}","starred_url":"https://api.github.com/users/joshuay03/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/joshuay03/subscriptions","organizations_url":"https://api.github.com/users/joshuay03/orgs","repos_url":"https://api.github.com/users/joshuay03/repos","events_url":"https://api.github.com/users/joshuay03/events{/privacy}","received_events_url":"https://api.github.com/users/joshuay03/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2024-02-22T13:59:58Z","updated_at":"2024-02-28T13:12:54Z","closed_at":"2024-02-28T13:12:54Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\nUsing `Model.query_constraints` with a single column that's not the primary key raises an error meant for passing more than 2 columns. This issue has existed since these raises were originally added in #49088.\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", path: \"../rails\"\r\n\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :organisations, force: true do |t|\r\n  end\r\n\r\n  create_table :employees, force: true do |t|\r\n    t.integer :organisation_id\r\n  end\r\nend\r\n\r\nclass Organisation < ActiveRecord::Base\r\n  has_many :employees\r\nend\r\n\r\nclass Employee < ActiveRecord::Base\r\n  query_constraints :organisation_id\r\n\r\n  belongs_to :organisation\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_query_constraints_with_single_non_primary_key_column\r\n    org = Organisation.create!\r\n    org.employees << Employee.create!\r\n\r\n    assert_equal 1, org.employees.count  # âŒ raises as it should, but with a confusing message\r\n  end\r\nend\r\n\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\nIt turns out there is [already an appropriate error for this case](https://github.com/rails/rails/blob/9f1dec2ea5155205a880f6e6e232cf9ea6da2d8c/activerecord/lib/active_record/reflection.rb#L799-L806). We never reach it because of the incorrect condition for the error before. I would expect this to get raised:\r\n\r\n```ruby\r\nError:\r\nBugTest#test_association_stuff:\r\nArgumentError: The query constraints on the `Employee` model does not include the primary key so Active Record is unable to derive the foreign key constraints for the association. You need to explicitly define the query constraints for this association.\r\n    test_2.rb:45:in `test_query_constraints_with_single_non_primary_key_column'\r\n```\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\nRaises this error:\r\n\r\n```ruby\r\nError:\r\nBugTest#test_association_stuff:\r\nArgumentError: The query constraints list on the `Employee` model has more than 2 attributes. Active Record is unable to derive the query constraints for the association. You need to explicitly define the query constraints for this association.\r\n    test_2.rb:45:in `test_query_constraints_with_single_non_primary_key_column'\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.1.3, main\r\n\r\n**Ruby version**: 3.3.0\r\n","closed_by":{"login":"eileencodes","id":1080678,"node_id":"MDQ6VXNlcjEwODA2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/1080678?v=4","gravatar_id":"","url":"https://api.github.com/users/eileencodes","html_url":"https://github.com/eileencodes","followers_url":"https://api.github.com/users/eileencodes/followers","following_url":"https://api.github.com/users/eileencodes/following{/other_user}","gists_url":"https://api.github.com/users/eileencodes/gists{/gist_id}","starred_url":"https://api.github.com/users/eileencodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eileencodes/subscriptions","organizations_url":"https://api.github.com/users/eileencodes/orgs","repos_url":"https://api.github.com/users/eileencodes/repos","events_url":"https://api.github.com/users/eileencodes/events{/privacy}","received_events_url":"https://api.github.com/users/eileencodes/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/51164/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/51164/timeline","performed_via_github_app":null,"state_reason":"completed"}