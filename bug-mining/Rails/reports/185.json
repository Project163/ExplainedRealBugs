{"url":"https://api.github.com/repos/rails/rails/issues/54560","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/54560/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/54560/comments","events_url":"https://api.github.com/repos/rails/rails/issues/54560/events","html_url":"https://github.com/rails/rails/issues/54560","id":2859244965,"node_id":"I_kwDNIULOqmydpQ","number":54560,"title":"Updates in joins crash in some cases that use a `through` association","user":{"login":"ghiculescu","id":509837,"node_id":"MDQ6VXNlcjUwOTgzNw==","avatar_url":"https://avatars.githubusercontent.com/u/509837?v=4","gravatar_id":"","url":"https://api.github.com/users/ghiculescu","html_url":"https://github.com/ghiculescu","followers_url":"https://api.github.com/users/ghiculescu/followers","following_url":"https://api.github.com/users/ghiculescu/following{/other_user}","gists_url":"https://api.github.com/users/ghiculescu/gists{/gist_id}","starred_url":"https://api.github.com/users/ghiculescu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ghiculescu/subscriptions","organizations_url":"https://api.github.com/users/ghiculescu/orgs","repos_url":"https://api.github.com/users/ghiculescu/repos","events_url":"https://api.github.com/users/ghiculescu/events{/privacy}","received_events_url":"https://api.github.com/users/ghiculescu/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2025-02-18T03:28:18Z","updated_at":"2025-02-20T08:31:15Z","closed_at":"2025-02-20T08:31:15Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"\n### Steps to reproduce\n\n<!-- (Guidelines for creating a bug report are [available\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\n\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\n```ruby\nrequire \"bundler/inline\"\n\ngemfile(true) do\n  source \"https://rubygems.org\"\n\n  # gem \"rails\" # passes\n\n  # edge fails. this includes https://github.com/rails/rails/pull/54530 and https://github.com/rails/rails/pull/53950\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\n\n  # commit before https://github.com/rails/rails/pull/53950, passes\n  # gem \"rails\", github: \"rails/rails\", ref: \"4e5a13a55b5960c9a35afdcecd1120bc926d377c\"\n\n  gem \"sqlite3\"\nend\n\nrequire \"active_record/railtie\"\nrequire \"minitest/autorun\"\nENV[\"DATABASE_URL\"] = \"sqlite3::memory:\"\n\nclass TestApp < Rails::Application\n  config.load_defaults Rails::VERSION::STRING.to_f\n  config.eager_load = false\n  config.logger = Logger.new($stdout)\n  config.secret_key_base = \"secret_key_base\"\nend\nRails.application.initialize!\n\nActiveRecord::Schema.define do\n  create_table :posts, force: true do |t|\n  end\n\n  create_table :comments, force: true do |t|\n    t.integer :post_id\n  end\n\n  create_table :likes, force: true do |t|\n    t.integer :comment_id\n    t.integer :reply_id\n    t.boolean :seen, default: false\n  end\n\n  create_table :replies, force: true do |t|\n  end\nend\n\nclass Post < ActiveRecord::Base\n  has_many :comments\n  has_many :likes, through: :comments\nend\n\nclass Comment < ActiveRecord::Base\n  belongs_to :post\n  has_many :likes\nend\n\nclass Like < ActiveRecord::Base\n  belongs_to :comment\n  belongs_to :reply, optional: true\n  scope :for_post, lambda { |post| joins(:comment).where(comment: { post_id: post.id }) }\nend\n\nclass Reply < ActiveRecord::Base\nend\n\nclass BugTest < ActiveSupport::TestCase\n  def test_association_stuff\n    post = Post.create!\n    comment = post.comments.create!\n    like = comment.likes.create!\n\n    post.likes.update_all(seen: true) # fine\n    post.likes.left_joins(:reply).update_all(seen: true) # ðŸ’¥ - workaround is to not use the through: association\n    post.likes.for_post(post).update_all(seen: true) # ðŸ’¥ - fixed by removing the double-join\n  end\nend\n\n```\n\n### Expected behavior\n\nTests should complete without crashing.\n\n### Actual behavior\n\nTwo of the updates fail. Here are the errors:\n\n```\nBugTest#test_association_stuff:\nActiveRecord::StatementInvalid: SQLite3::SQLException: no such column: likes.reply_id:\nUPDATE \"likes\" SET \"seen\" = ? FROM \"comments\" LEFT OUTER JOIN \"replies\" ON \"replies\".\"id\" = \"likes\".\"reply_id\"  WHERE \"likes\".\"comment_id\" = \"comments\".\"id\" AND \"comments\".\"post_id\" = ?\n```\n\n```\nBugTest#test_association_stuff:\nActiveRecord::StatementInvalid: SQLite3::SQLException: no such column: likes.comment_id:\nUPDATE \"likes\" SET \"seen\" = ? FROM \"comments\" INNER JOIN \"comments\" \"comment\" ON \"comment\".\"id\" = \"likes\".\"comment_id\"  WHERE \"likes\".\"comment_id\" = \"comments\".\"id\" AND \"comments\".\"post_id\" = ? AND \"comment\".\"post_id\" = ?\n```\n\n\nOur app, which runs on postgres, had a similar issue come up when trying to update to edge Rails.\n\nThis issue was introduced by https://github.com/rails/rails/pull/53950 and was not fixed by https://github.com/rails/rails/pull/54530\n\n### System configuration\n\n**Rails version**:  edge\n\n**Ruby version**:  3\n","closed_by":{"login":"byroot","id":44640,"node_id":"MDQ6VXNlcjQ0NjQw","avatar_url":"https://avatars.githubusercontent.com/u/44640?v=4","gravatar_id":"","url":"https://api.github.com/users/byroot","html_url":"https://github.com/byroot","followers_url":"https://api.github.com/users/byroot/followers","following_url":"https://api.github.com/users/byroot/following{/other_user}","gists_url":"https://api.github.com/users/byroot/gists{/gist_id}","starred_url":"https://api.github.com/users/byroot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/byroot/subscriptions","organizations_url":"https://api.github.com/users/byroot/orgs","repos_url":"https://api.github.com/users/byroot/repos","events_url":"https://api.github.com/users/byroot/events{/privacy}","received_events_url":"https://api.github.com/users/byroot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/54560/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/54560/timeline","performed_via_github_app":null,"state_reason":"completed"}