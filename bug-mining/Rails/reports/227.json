{"url":"https://api.github.com/repos/rails/rails/issues/55678","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/55678/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/55678/comments","events_url":"https://api.github.com/repos/rails/rails/issues/55678/events","html_url":"https://github.com/rails/rails/issues/55678","id":3417988320,"node_id":"I_kwDNIULOy7pc4A","number":55678,"title":"Performance regression introduced at c313d9161360f4539afeb36cc8353ad29ba6bef3","user":{"login":"cmaion","id":187317,"node_id":"MDQ6VXNlcjE4NzMxNw==","avatar_url":"https://avatars.githubusercontent.com/u/187317?v=4","gravatar_id":"","url":"https://api.github.com/users/cmaion","html_url":"https://github.com/cmaion","followers_url":"https://api.github.com/users/cmaion/followers","following_url":"https://api.github.com/users/cmaion/following{/other_user}","gists_url":"https://api.github.com/users/cmaion/gists{/gist_id}","starred_url":"https://api.github.com/users/cmaion/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cmaion/subscriptions","organizations_url":"https://api.github.com/users/cmaion/orgs","repos_url":"https://api.github.com/users/cmaion/repos","events_url":"https://api.github.com/users/cmaion/events{/privacy}","received_events_url":"https://api.github.com/users/cmaion/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2025-09-15T13:30:59Z","updated_at":"2025-09-15T18:50:52Z","closed_at":"2025-09-15T18:50:52Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hi\n\nI'm surfacing a [comment](https://github.com/rails/rails/commit/c313d9161360f4539afeb36cc8353ad29ba6bef3#commitcomment-164243155) I left on commit c313d9161360f4539afeb36cc8353ad29ba6bef3.\n\nSince that commit, a large number of *unneeded* empty arrays are allocated when working with ActiveRecord associations.\nIn my case, this results in hundreds of new allocations that have a measurable impact on query/s metrics.\nI have traced those allocations to `activesupport-8.0.2.1/lib/active_support/core_ext/array/extract.rb:13`.\nThose calls where not present before that commit.\n\nCheck this simple `post.comments.count` query:\n\n### Steps to reproduce\n\n```ruby\nrequire 'bundler/inline'\n\ngemfile(true) do\n  source 'https://rubygems.org'\n\n  gem 'rails'\n  # If you want to test against edge Rails replace the previous line with this:\n  # gem \"rails\", github: \"rails/rails\", branch: \"main\"\n\n  gem 'sqlite3'\nend\n\nrequire 'active_record/railtie'\nrequire 'minitest/autorun'\n\n# This connection will do for database-independent bug reports.\nENV['DATABASE_URL'] = 'sqlite3::memory:'\n\nclass TestApp < Rails::Application\n  config.load_defaults Rails::VERSION::STRING.to_f\n  config.eager_load = false\n  config.logger = Logger.new($stdout)\n  config.secret_key_base = 'secret_key_base'\n\n  config.active_record.encryption.primary_key = 'primary_key'\n  config.active_record.encryption.deterministic_key = 'deterministic_key'\n  config.active_record.encryption.key_derivation_salt = 'key_derivation_salt'\nend\nRails.application.initialize!\n\nActiveRecord::Schema.define do\n  create_table :posts, force: true do |t|\n  end\n\n  create_table :comments, force: true do |t|\n    t.integer :post_id\n  end\nend\n\nclass Post < ActiveRecord::Base\n  has_many :comments\nend\n\nclass Comment < ActiveRecord::Base\n  belongs_to :post\nend\n\nclass BugTest < ActiveSupport::TestCase\n  def trace_array_allocations\n    require 'objspace'\n\n    ObjectSpace.trace_object_allocations_clear\n    current_generation = GC.count\n    ObjectSpace.trace_object_allocations_start\n\n    yield\n\n    ObjectSpace.trace_object_allocations_stop\n\n    arrays = []\n    ObjectSpace.dump_all(output: :string, since: current_generation).each_line do |line|\n      json = JSON.parse(line)\n      arrays << json if json['file'] && json['type'] == 'ARRAY'\n    end\n\n    Rails.logger.debug \"Total allocated arrays: #{arrays.count}\"\n    arrays.group_by do |obj|\n      \"#{obj['file']}:#{obj['line']}\"\n    end.sort_by do |_file, objs|\n      -objs.count\n    end.take(5).each do |file, objs|\n      Rails.logger.debug \"↳ #{file.sub(Rails.root.join.to_s + '/', '')}: #{objs.count} allocated\"\n    end\n  end\n\n  def test_arrays_allocations\n    post = Post.create!\n    post.comments.create!\n\n    assert_nil(trace_array_allocations do\n      post.comments.count\n    end.find do |file, _objs|\n      file =~ %r{active_support/core_ext/array/extract.rb}\n    end)\n  end\nend\n```\n\nThe total number allocated arrays is reported in the debug log + source location of the 5 most prevalent origins.\n\n\n### Expected behavior\n\nBefore that commit, no allocation originates from `activesupport-8.0.2.1/lib/active_support/core_ext/array/extract.rb:13`.\nTotal allocated arrays is 101.\n\n```\nD, [2025-09-15T15:20:13.802467 #334504] DEBUG -- : Total allocated arrays: 101\nD, [2025-09-15T15:20:13.803034 #334504] DEBUG -- : ↳ vendor/bundle/gems/activerecord-8.0.2.1/lib/active_record/relation/where_clause.rb:29: 4 allocated\nD, [2025-09-15T15:20:13.803064 #334504] DEBUG -- : ↳ vendor/bundle/gems/activesupport-8.0.2.1/lib/active_support/log_subscriber.rb:181: 4 allocated\nD, [2025-09-15T15:20:13.803154 #334504] DEBUG -- : ↳ vendor/bundle/gems/activerecord-8.0.2.1/lib/active_record/relation/where_clause.rb:111: 4 allocated\nD, [2025-09-15T15:20:13.803171 #334504] DEBUG -- : ↳ vendor/bundle/gems/activerecord-8.0.2.1/lib/active_record/relation.rb:1304: 2 allocated\nD, [2025-09-15T15:20:13.803182 #334504] DEBUG -- : ↳ vendor/bundle/gems/activerecord-8.0.2.1/lib/active_record/relation/calculations.rb:646: 2 allocated\n```\n\n\n### Actual behavior\n\nWe now have **8** empty arrays allocated from `activesupport-8.0.2.1/lib/active_support/core_ext/array/extract.rb:13`, none of them are needed, and this is the largest source of array allocations.\nTotal allocated arrays is now 110.\nThrow more simple/complex queries in and that number quickly balloons to an unhealthy volume.\n\n\n```\nD, [2025-09-15T15:20:04.446302 #334411] DEBUG -- : Total allocated arrays: 110\nD, [2025-09-15T15:20:04.446830 #334411] DEBUG -- : ↳ vendor/bundle/gems/activesupport-8.0.2.1/lib/active_support/core_ext/array/extract.rb:13: 8 allocated\nD, [2025-09-15T15:20:04.446852 #334411] DEBUG -- : ↳ vendor/bundle/gems/activerecord-8.0.2.1/lib/active_record/relation/where_clause.rb:29: 4 allocated\nD, [2025-09-15T15:20:04.446922 #334411] DEBUG -- : ↳ vendor/bundle/gems/activesupport-8.0.2.1/lib/active_support/log_subscriber.rb:181: 4 allocated\nD, [2025-09-15T15:20:04.446939 #334411] DEBUG -- : ↳ vendor/bundle/gems/activerecord-8.0.2.1/lib/active_record/relation/where_clause.rb:178: 4 allocated\nD, [2025-09-15T15:20:04.446948 #334411] DEBUG -- : ↳ vendor/bundle/gems/activerecord-8.0.2.1/lib/active_record/relation/where_clause.rb:111: 4 allocated\n```\n\nA simple fix is just to avoid calling `columns.extract!` in `ActiveRecord::Relation::WhereClause.except_predicates` when `columns` is empty, as follows:\n\n```ruby\nmodule ActiveRecord\n  class Relation\n    class WhereClause # :nodoc:\n      def except_predicates(columns)\n        return predicates if columns.empty? # Prevent allocating unneeded empty arrays in columns.extract!\n\n        attrs = columns.extract! { |node| node.is_a?(Arel::Attribute) }\n        non_attrs = columns.extract! { |node| node.is_a?(Arel::Predications) }\n\n        predicates.reject do |node|\n          if !non_attrs.empty? && node.equality? && node.left.is_a?(Arel::Predications)\n            non_attrs.include?(node.left)\n          end || Arel.fetch_attribute(node) do |attr|\n            attrs.include?(attr) || columns.include?(attr.name.to_s)\n          end\n        end\n      end\n    end\n  end\nend\n\n```\n\n### System configuration\n\n**Rails version**: \n7.2, 8.0\n\n**Ruby version**: \n3.3, 3.4","closed_by":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/55678/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/55678/timeline","performed_via_github_app":null,"state_reason":"completed"}