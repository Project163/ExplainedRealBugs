[{"url":"https://api.github.com/repos/rails/rails/issues/comments/2289731672","html_url":"https://github.com/rails/rails/issues/52607#issuecomment-2289731672","issue_url":"https://api.github.com/repos/rails/rails/issues/52607","id":2289731672,"node_id":"IC_kwDNIULOiHqIWA","user":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-14T19:41:54Z","updated_at":"2024-08-14T19:41:54Z","body":"Probably caused by 6d00605f955a992fb52d4a1006f7c50b99a2e858","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/2289731672/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rails/rails/issues/comments/2289751773","html_url":"https://github.com/rails/rails/issues/52607#issuecomment-2289751773","issue_url":"https://api.github.com/repos/rails/rails/issues/52607","id":2289751773,"node_id":"IC_kwDNIULOiHrW3Q","user":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-14T19:52:46Z","updated_at":"2024-08-14T19:53:33Z","body":"I tried to reproduce with the script and I can but it is because the script doesn't create the table so doesn't have the column.\r\n\r\nThis script pass without any problem:\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nENV['RAILS_ENV'] ||= 'test'\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  gem \"rails\", path: \"../rails\"\r\n\r\n  gem \"pg\", \"~> 1.5.7\"\r\n\r\n  gem \"minitest\", \"5.24.1\" # https://github.com/minitest/minitest/issues/1007\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"action_controller/railtie\"\r\nrequire \"logger\"\r\n\r\nActiveRecord::Base.configurations = {\r\n  \"test\" => {\r\n    \"adapter\"=>\"postgresql\",\r\n    \"database\"=>\"test\",\r\n    \"host\"=>\"localhost\",\r\n    \"username\"=>\"rails\",\r\n    \"password\"=>\"rails\"\r\n  }\r\n}\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(\r\n  adapter:  \"postgresql\",\r\n  host:     \"localhost\",\r\n  username: \"rails\",\r\n  password: \"rails\",\r\n  database: \"test\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_enum \"my_enum\", [\"one\", \"two\", \"three\"]\r\n\r\n  create_table :posts, force: true do |t|\r\n    t.enum :post_type, enum_type: :my_enum\r\n  end\r\nend\r\n\r\n\r\nclass Application < Rails::Application\r\n  # Setting eager load to `true` matters in my test setup\r\n  # but this does not make a difference in the reproduction\r\n  config.eager_load = false\r\nend\r\n\r\nRails.application.initialize!\r\n\r\nclass Post < ActiveRecord::Base\r\n  enum :post_type, { one: 'one', two: 'two', three: 'three' }\r\nend\r\n\r\n\r\nclass ActiveSupport::TestCase\r\n  parallelize(\r\n    workers: 0, # The amount of workers doesn't matter, as long as `parallelize` is used\r\n    threshold: 1 # The threshold does matter, if you set this to 2 the tests will work\r\n  )\r\nend\r\n\r\nrequire \"rails/test_help\"\r\n\r\nclass BugTest < ActiveSupport::TestCase\r\n  def test_one\r\n    Post.new\r\n\r\n    assert true\r\n  end\r\n\r\n  def test_two\r\n    Post.new\r\n\r\n    assert true\r\n  end\r\nend\r\n```\r\n\r\nCan you modify the script so it fails?","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/2289751773/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":13886551423,"node_id":"LE_lADNIULOkwVwgM8AAAADO7P1fw","url":"https://api.github.com/repos/rails/rails/issues/events/13886551423","actor":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2024-08-14T19:52:52Z","label":{"name":"more-information-needed","color":"bfdadc"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/comments/2289843237","html_url":"https://github.com/rails/rails/issues/52607#issuecomment-2289843237","issue_url":"https://api.github.com/repos/rails/rails/issues/52607","id":2289843237,"node_id":"IC_kwDNIULOiHw8JQ","user":{"login":"robbevp","id":48474670,"node_id":"MDQ6VXNlcjQ4NDc0Njcw","avatar_url":"https://avatars.githubusercontent.com/u/48474670?v=4","gravatar_id":"","url":"https://api.github.com/users/robbevp","html_url":"https://github.com/robbevp","followers_url":"https://api.github.com/users/robbevp/followers","following_url":"https://api.github.com/users/robbevp/following{/other_user}","gists_url":"https://api.github.com/users/robbevp/gists{/gist_id}","starred_url":"https://api.github.com/users/robbevp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/robbevp/subscriptions","organizations_url":"https://api.github.com/users/robbevp/orgs","repos_url":"https://api.github.com/users/robbevp/repos","events_url":"https://api.github.com/users/robbevp/events{/privacy}","received_events_url":"https://api.github.com/users/robbevp/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-14T20:43:32Z","updated_at":"2024-08-14T20:43:32Z","body":"Hi @rafaelfranca\r\nI modified your version to make it fail again. Seems I made some wrong assumptions while debugging. The number of workers should be >= 2 and `config.eager_load = true`\r\n\r\nThe script below does fail for me with the error\r\n```\r\n./db/schema.rb doesn't exist yet. Run \\`bin/rails db:migrate\\` to create it, then try again.\r\n```\r\n Is there a way too keep the schema inline and have parallelization?\r\n\r\nAfter creating a separate schema file, I get the error described above on 7.2.0, but not on 7.1.3.4. I added a print of `Post.columns` to verify that the column itself exists\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nENV['RAILS_ENV'] ||= 'test'\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  gem \"rails\", \"7.2.0\"\r\n\r\n  gem \"pg\", \"~> 1.5.7\"\r\n\r\n  gem \"minitest\", \"5.24.1\" # https://github.com/minitest/minitest/issues/1007\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"action_controller/railtie\"\r\nrequire \"logger\"\r\n\r\nActiveRecord::Base.configurations = {\r\n  \"test\" => {\r\n    \"adapter\"=>\"postgresql\",\r\n    \"database\"=>\"test\",\r\n    \"host\"=>\"localhost\",\r\n    \"username\"=>\"rails\",\r\n    \"password\"=>\"rails\"\r\n  }\r\n}\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(\r\n  adapter:  \"postgresql\",\r\n  host:     \"localhost\",\r\n  username: \"rails\",\r\n  password: \"rails\",\r\n  database: \"test\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_enum \"my_enum\", [\"one\", \"two\", \"three\"]\r\n\r\n  create_table :posts, force: true do |t|\r\n    t.enum :post_type, enum_type: :my_enum\r\n  end\r\nend\r\n\r\n\r\nclass Application < Rails::Application\r\n  config.eager_load = true\r\nend\r\n\r\nRails.application.initialize!\r\n\r\nclass Post < ActiveRecord::Base\r\n  enum :post_type, { one: 'one', two: 'two', three: 'three' }\r\nend\r\n\r\n\r\nclass ActiveSupport::TestCase\r\n  parallelize(\r\n    workers: 2,\r\n    threshold: 1\r\n  )\r\nend\r\n\r\nrequire \"rails/test_help\"\r\n\r\nclass BugTest < ActiveSupport::TestCase\r\n  def test_one\r\n    pp Post.columns\r\n    Post.new\r\n\r\n    assert true\r\n  end\r\n\r\n  def test_two\r\n    Post.new\r\n\r\n    assert true\r\n  end\r\nend\r\n```","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/2289843237/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"robbevp","id":48474670,"node_id":"MDQ6VXNlcjQ4NDc0Njcw","avatar_url":"https://avatars.githubusercontent.com/u/48474670?v=4","gravatar_id":"","url":"https://api.github.com/users/robbevp","html_url":"https://github.com/robbevp","followers_url":"https://api.github.com/users/robbevp/followers","following_url":"https://api.github.com/users/robbevp/following{/other_user}","gists_url":"https://api.github.com/users/robbevp/gists{/gist_id}","starred_url":"https://api.github.com/users/robbevp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/robbevp/subscriptions","organizations_url":"https://api.github.com/users/robbevp/orgs","repos_url":"https://api.github.com/users/robbevp/repos","events_url":"https://api.github.com/users/robbevp/events{/privacy}","received_events_url":"https://api.github.com/users/robbevp/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":13887036313,"node_id":"MEE_lADNIULOkwVwgM8AAAADO7tbmQ","url":"https://api.github.com/repos/rails/rails/issues/events/13887036313","actor":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-08-14T20:43:33Z","performed_via_github_app":null},{"id":13887036327,"node_id":"SE_lADNIULOkwVwgM8AAAADO7tbpw","url":"https://api.github.com/repos/rails/rails/issues/events/13887036327","actor":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-08-14T20:43:33Z","performed_via_github_app":null},{"id":13887036868,"node_id":"UNLE_lADNIULOkwVwgM8AAAADO7tdxA","url":"https://api.github.com/repos/rails/rails/issues/events/13887036868","actor":{"login":"rails-bot[bot]","id":28418009,"node_id":"MDM6Qm90Mjg0MTgwMDk=","avatar_url":"https://avatars.githubusercontent.com/in/2272?v=4","gravatar_id":"","url":"https://api.github.com/users/rails-bot%5Bbot%5D","html_url":"https://github.com/apps/rails-bot","followers_url":"https://api.github.com/users/rails-bot%5Bbot%5D/followers","following_url":"https://api.github.com/users/rails-bot%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/rails-bot%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/rails-bot%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rails-bot%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/rails-bot%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/rails-bot%5Bbot%5D/repos","events_url":"https://api.github.com/users/rails-bot%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/rails-bot%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"event":"unlabeled","commit_id":null,"commit_url":null,"created_at":"2024-08-14T20:43:37Z","label":{"name":"more-information-needed","color":"bfdadc"},"performed_via_github_app":null},{"id":13888533514,"node_id":"LE_lADNIULOkwVwgM8AAAADO9I0Cg","url":"https://api.github.com/repos/rails/rails/issues/events/13888533514","actor":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2024-08-15T00:01:33Z","label":{"name":"activerecord","color":"0b02e1"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/comments/2290103052","html_url":"https://github.com/rails/rails/issues/52607#issuecomment-2290103052","issue_url":"https://api.github.com/repos/rails/rails/issues/52607","id":2290103052,"node_id":"IC_kwDNIULOiIAzDA","user":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-15T00:01:55Z","updated_at":"2024-08-15T00:01:55Z","body":"Thank. Now that you can reproduce, can you bisect to see which change in rails caused it?","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/2290103052/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rails/rails/issues/comments/2290960349","html_url":"https://github.com/rails/rails/issues/52607#issuecomment-2290960349","issue_url":"https://api.github.com/repos/rails/rails/issues/52607","id":2290960349,"node_id":"IC_kwDNIULOiI1H3Q","user":{"login":"robbevp","id":48474670,"node_id":"MDQ6VXNlcjQ4NDc0Njcw","avatar_url":"https://avatars.githubusercontent.com/u/48474670?v=4","gravatar_id":"","url":"https://api.github.com/users/robbevp","html_url":"https://github.com/robbevp","followers_url":"https://api.github.com/users/robbevp/followers","following_url":"https://api.github.com/users/robbevp/following{/other_user}","gists_url":"https://api.github.com/users/robbevp/gists{/gist_id}","starred_url":"https://api.github.com/users/robbevp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/robbevp/subscriptions","organizations_url":"https://api.github.com/users/robbevp/orgs","repos_url":"https://api.github.com/users/robbevp/repos","events_url":"https://api.github.com/users/robbevp/events{/privacy}","received_events_url":"https://api.github.com/users/robbevp/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-15T09:25:37Z","updated_at":"2024-08-15T09:25:37Z","body":"Bisecting leads to https://github.com/rails/rails/commit/6d00605f955a992fb52d4a1006f7c50b99a2e858 as the first bad commit.\r\n\r\nWhen running the script above the subtype at [activerecord/lib/active_record/enum.rb#L258-L259](https://github.com/rails/rails/blob/7-2-stable/activerecord/lib/active_record/enum.rb#L258-L259) is  `#<ActiveModel::Type::Value:0x000000010dec7fd0 @limit=nil, @precision=nil, @scale=nil>`\r\nIf eager load is false, or if the tests aren't parallelized, the subtype is `#<ActiveRecord::ConnectionAdapters::PostgreSQL::OID::Enum:0x000000012b056000 @limit=nil, @precision=nil, @scale=nil>`\r\n\r\nWhile trying to work backwards to see where this difference comes from, I found that [ActiveRecord::ConnectionAdapter::PostgreSQL::Question#lookup_cast_type_from_column](https://github.com/rails/rails/blob/7-2-stable/activerecord/lib/active_record/connection_adapters/postgresql/quoting.rb#L189-L192) has the same input type, but returns the different subtypes\r\n```\r\n#<ActiveRecord::ConnectionAdapters::PostgreSQL::Column:0x0000000115ab9300\r\n @collation=nil,\r\n @comment=nil,\r\n @default=nil,\r\n @default_function=nil,\r\n @generated=\"\",\r\n @identity=nil,\r\n @name=\"post_type\",\r\n @null=true,\r\n @serial=nil,\r\n @sql_type_metadata=\r\n  #<ActiveRecord::ConnectionAdapters::SqlTypeMetadata:0x000000014550b810\r\n   @limit=nil,\r\n   @precision=nil,\r\n   @scale=nil,\r\n   @sql_type=\"my_enum\",\r\n   @type=:enum>>\r\n```\r\n","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/2290960349/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"robbevp","id":48474670,"node_id":"MDQ6VXNlcjQ4NDc0Njcw","avatar_url":"https://avatars.githubusercontent.com/u/48474670?v=4","gravatar_id":"","url":"https://api.github.com/users/robbevp","html_url":"https://github.com/robbevp","followers_url":"https://api.github.com/users/robbevp/followers","following_url":"https://api.github.com/users/robbevp/following{/other_user}","gists_url":"https://api.github.com/users/robbevp/gists{/gist_id}","starred_url":"https://api.github.com/users/robbevp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/robbevp/subscriptions","organizations_url":"https://api.github.com/users/robbevp/orgs","repos_url":"https://api.github.com/users/robbevp/repos","events_url":"https://api.github.com/users/robbevp/events{/privacy}","received_events_url":"https://api.github.com/users/robbevp/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rails/rails/issues/comments/2291522319","html_url":"https://github.com/rails/rails/issues/52607#issuecomment-2291522319","issue_url":"https://api.github.com/repos/rails/rails/issues/52607","id":2291522319,"node_id":"IC_kwDNIULOiJXbDw","user":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-15T15:27:27Z","updated_at":"2024-08-15T15:27:27Z","body":"@jonathanhefner ","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/2291522319/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":13897605701,"node_id":"MEE_lADNIULOkwVwgM8AAAADPFyiRQ","url":"https://api.github.com/repos/rails/rails/issues/events/13897605701","actor":{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-08-15T15:27:29Z","performed_via_github_app":null},{"id":13897605707,"node_id":"SE_lADNIULOkwVwgM8AAAADPFyiSw","url":"https://api.github.com/repos/rails/rails/issues/events/13897605707","actor":{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-08-15T15:27:29Z","performed_via_github_app":null},{"id":13897767906,"node_id":"MIE_lADNIULOkwVwgM8AAAADPF8b4g","url":"https://api.github.com/repos/rails/rails/issues/events/13897767906","actor":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"milestoned","commit_id":null,"commit_url":null,"created_at":"2024-08-15T15:33:09Z","milestone":{"title":"7.2.1"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/comments/2296910117","html_url":"https://github.com/rails/rails/issues/52607#issuecomment-2296910117","issue_url":"https://api.github.com/repos/rails/rails/issues/52607","id":2296910117,"node_id":"IC_kwDNIULOiOgRJQ","user":{"login":"duduribeiro","id":771411,"node_id":"MDQ6VXNlcjc3MTQxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/771411?v=4","gravatar_id":"","url":"https://api.github.com/users/duduribeiro","html_url":"https://github.com/duduribeiro","followers_url":"https://api.github.com/users/duduribeiro/followers","following_url":"https://api.github.com/users/duduribeiro/following{/other_user}","gists_url":"https://api.github.com/users/duduribeiro/gists{/gist_id}","starred_url":"https://api.github.com/users/duduribeiro/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/duduribeiro/subscriptions","organizations_url":"https://api.github.com/users/duduribeiro/orgs","repos_url":"https://api.github.com/users/duduribeiro/repos","events_url":"https://api.github.com/users/duduribeiro/events{/privacy}","received_events_url":"https://api.github.com/users/duduribeiro/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-19T15:55:29Z","updated_at":"2024-08-19T15:55:29Z","body":"I'm also seeing this after upgrading to Rails 7.2 \n\nAs workaround we disabled parallel tests until this is fixed. Like pointed by @robbevp, the weird thing is that this works locally and only fail on CI with parallel tests enabled. ","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/2296910117/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"duduribeiro","id":771411,"node_id":"MDQ6VXNlcjc3MTQxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/771411?v=4","gravatar_id":"","url":"https://api.github.com/users/duduribeiro","html_url":"https://github.com/duduribeiro","followers_url":"https://api.github.com/users/duduribeiro/followers","following_url":"https://api.github.com/users/duduribeiro/following{/other_user}","gists_url":"https://api.github.com/users/duduribeiro/gists{/gist_id}","starred_url":"https://api.github.com/users/duduribeiro/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/duduribeiro/subscriptions","organizations_url":"https://api.github.com/users/duduribeiro/orgs","repos_url":"https://api.github.com/users/duduribeiro/repos","events_url":"https://api.github.com/users/duduribeiro/events{/privacy}","received_events_url":"https://api.github.com/users/duduribeiro/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":13932619492,"node_id":"MEE_lADNIULOkwVwgM8AAAADPnLm5A","url":"https://api.github.com/repos/rails/rails/issues/events/13932619492","actor":{"login":"robbevp","id":48474670,"node_id":"MDQ6VXNlcjQ4NDc0Njcw","avatar_url":"https://avatars.githubusercontent.com/u/48474670?v=4","gravatar_id":"","url":"https://api.github.com/users/robbevp","html_url":"https://github.com/robbevp","followers_url":"https://api.github.com/users/robbevp/followers","following_url":"https://api.github.com/users/robbevp/following{/other_user}","gists_url":"https://api.github.com/users/robbevp/gists{/gist_id}","starred_url":"https://api.github.com/users/robbevp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/robbevp/subscriptions","organizations_url":"https://api.github.com/users/robbevp/orgs","repos_url":"https://api.github.com/users/robbevp/repos","events_url":"https://api.github.com/users/robbevp/events{/privacy}","received_events_url":"https://api.github.com/users/robbevp/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-08-19T15:55:30Z","performed_via_github_app":null},{"id":13932619505,"node_id":"SE_lADNIULOkwVwgM8AAAADPnLm8Q","url":"https://api.github.com/repos/rails/rails/issues/events/13932619505","actor":{"login":"robbevp","id":48474670,"node_id":"MDQ6VXNlcjQ4NDc0Njcw","avatar_url":"https://avatars.githubusercontent.com/u/48474670?v=4","gravatar_id":"","url":"https://api.github.com/users/robbevp","html_url":"https://github.com/robbevp","followers_url":"https://api.github.com/users/robbevp/followers","following_url":"https://api.github.com/users/robbevp/following{/other_user}","gists_url":"https://api.github.com/users/robbevp/gists{/gist_id}","starred_url":"https://api.github.com/users/robbevp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/robbevp/subscriptions","organizations_url":"https://api.github.com/users/robbevp/orgs","repos_url":"https://api.github.com/users/robbevp/repos","events_url":"https://api.github.com/users/robbevp/events{/privacy}","received_events_url":"https://api.github.com/users/robbevp/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-08-19T15:55:30Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/comments/2297868324","html_url":"https://github.com/rails/rails/issues/52607#issuecomment-2297868324","issue_url":"https://api.github.com/repos/rails/rails/issues/52607","id":2297868324,"node_id":"IC_kwDNIULOiPawJA","user":{"login":"duduribeiro","id":771411,"node_id":"MDQ6VXNlcjc3MTQxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/771411?v=4","gravatar_id":"","url":"https://api.github.com/users/duduribeiro","html_url":"https://github.com/duduribeiro","followers_url":"https://api.github.com/users/duduribeiro/followers","following_url":"https://api.github.com/users/duduribeiro/following{/other_user}","gists_url":"https://api.github.com/users/duduribeiro/gists{/gist_id}","starred_url":"https://api.github.com/users/duduribeiro/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/duduribeiro/subscriptions","organizations_url":"https://api.github.com/users/duduribeiro/orgs","repos_url":"https://api.github.com/users/duduribeiro/repos","events_url":"https://api.github.com/users/duduribeiro/events{/privacy}","received_events_url":"https://api.github.com/users/duduribeiro/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-20T02:57:11Z","updated_at":"2024-08-20T20:56:47Z","body":"@jonathanhefner I'm trying to debug this but I still didn't have success and will try to check if I can help somehow with this tomorrow. \n\nThe only odd thing that I noticed is that:\nwhen calling `connection.lookup_cast_type_from_column(column)` each version (one with eager_load = true and another with eager_load = false) uses a different OID to look for the column.\n\nI added some logs on `activerecord/lib/active_record/type/hash_lookup_type_map.rb # register_type` and on `activerecord/lib/active_record/model_schema.rb # type_for_column`:\n\n```\n# eager_load: false\nregistered enum type: 24578 #<ActiveRecord::ConnectionAdapters::PostgreSQL::OID::Enum:0x0000ffff639f4c38> \nregistered enum type: 24578 #<ActiveRecord::ConnectionAdapters::PostgreSQL::OID::Enum:0x0000ffff63acc930> \nregistered enum type: 24632 #<ActiveRecord::ConnectionAdapters::PostgreSQL::OID::Enum:0x0000ffff95a41b28> \nregistered enum type: 24631 #<ActiveRecord::ConnectionAdapters::PostgreSQL::OID::Enum:0x0000ffff95a42b18> \nregistered enum type: 24631 #<ActiveRecord::ConnectionAdapters::PostgreSQL::OID::Enum:0x0000ffff959fb808> \nregistered enum type: 24632 #<ActiveRecord::ConnectionAdapters::PostgreSQL::OID::Enum:0x0000ffff959fb358> \ntype_for_column post_type oid: 24632 - #<ActiveRecord::ConnectionAdapters::PostgreSQL::OID::Enum:0x0000ffff959fb358> \ntype_for_column post_type oid: 24631 - #<ActiveRecord::ConnectionAdapters::PostgreSQL::OID::Enum:0x0000ffff959fb808> \n\n########\n\n# eager_load: true\nregistered enum type: 24578 #<ActiveRecord::ConnectionAdapters::PostgreSQL::OID::Enum:0x0000ffff716f0c68> \nregistered enum type: 24578 #<ActiveRecord::ConnectionAdapters::PostgreSQL::OID::Enum:0x0000ffff70c5cb80> \nregistered enum type: 24632 #<ActiveRecord::ConnectionAdapters::PostgreSQL::OID::Enum:0x0000ffff70eb4bd0> \nregistered enum type: 24631 #<ActiveRecord::ConnectionAdapters::PostgreSQL::OID::Enum:0x0000ffff70eb5418> \nregistered enum type: 24632 #<ActiveRecord::ConnectionAdapters::PostgreSQL::OID::Enum:0x0000ffff70f50df0> \nregistered enum type: 24631 #<ActiveRecord::ConnectionAdapters::PostgreSQL::OID::Enum:0x0000ffff70f51688> \ntype_for_column post_type oid: 24578 - #<ActiveModel::Type::Value:0x0000ffff70faa198> \ntype_for_column post_type oid: 24578 - #<ActiveModel::Type::Value:0x0000ffff70fc6208> \n```\n\non my machine the version with eager_load tries to find a type for the OID 24578 while the version without eager_load tries to find the type for the OID `24632` and `24631`.  And even on version with eager_load have registered the OID 24578 with `ActiveRecord::ConnectionAdapters::PostgreSQL::OID::Enum` type, it returns `ActiveModel::Type::Value` when calling `lookup_cast_type_from_column`. Tomorrow I will try to find if there is any issue with `type_map.lookup` method to see why it is not returning `ActiveRecord::ConnectionAdapters::PostgreSQL::OID::Enum` when doing the lookup. \n\nI see that with eager_load in one test call the mapping includes the 24578 OID but in another call it does not include it. Maybe in one thread the mapping includes but in another no\n```\n(ruby) @mapping.keys.include?(24578)\ntrue\n\n---\n\n(ruby@test_bug.rb#79354) @mapping.keys.include?(24578)\nfalse\n```\n\n\nI also noticed that with `eager load false` `activerecord/lib/active_record/model_schema.rb # load_schema` is being called twice with the script provided by @robbevp, probably one call per thread. With `eager_load true` it is only being called once, which makes sense as it is being eager loaded but maybe this is why the other thread does not have the updated mapping with all OIDs? I will try to debug more","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/2297868324/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"duduribeiro","id":771411,"node_id":"MDQ6VXNlcjc3MTQxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/771411?v=4","gravatar_id":"","url":"https://api.github.com/users/duduribeiro","html_url":"https://github.com/duduribeiro","followers_url":"https://api.github.com/users/duduribeiro/followers","following_url":"https://api.github.com/users/duduribeiro/following{/other_user}","gists_url":"https://api.github.com/users/duduribeiro/gists{/gist_id}","starred_url":"https://api.github.com/users/duduribeiro/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/duduribeiro/subscriptions","organizations_url":"https://api.github.com/users/duduribeiro/orgs","repos_url":"https://api.github.com/users/duduribeiro/repos","events_url":"https://api.github.com/users/duduribeiro/events{/privacy}","received_events_url":"https://api.github.com/users/duduribeiro/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":13938504014,"node_id":"MEE_lADNIULOkwVwgM8AAAADPsyxTg","url":"https://api.github.com/repos/rails/rails/issues/events/13938504014","actor":{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-08-20T02:57:12Z","performed_via_github_app":null},{"id":13938504024,"node_id":"SE_lADNIULOkwVwgM8AAAADPsyxWA","url":"https://api.github.com/repos/rails/rails/issues/events/13938504024","actor":{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-08-20T02:57:12Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/comments/2299032155","html_url":"https://github.com/rails/rails/issues/52607#issuecomment-2299032155","issue_url":"https://api.github.com/repos/rails/rails/issues/52607","id":2299032155,"node_id":"IC_kwDNIULOiQhyWw","user":{"login":"gstokkink","id":14915325,"node_id":"MDQ6VXNlcjE0OTE1MzI1","avatar_url":"https://avatars.githubusercontent.com/u/14915325?v=4","gravatar_id":"","url":"https://api.github.com/users/gstokkink","html_url":"https://github.com/gstokkink","followers_url":"https://api.github.com/users/gstokkink/followers","following_url":"https://api.github.com/users/gstokkink/following{/other_user}","gists_url":"https://api.github.com/users/gstokkink/gists{/gist_id}","starred_url":"https://api.github.com/users/gstokkink/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gstokkink/subscriptions","organizations_url":"https://api.github.com/users/gstokkink/orgs","repos_url":"https://api.github.com/users/gstokkink/repos","events_url":"https://api.github.com/users/gstokkink/events{/privacy}","received_events_url":"https://api.github.com/users/gstokkink/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-20T14:41:15Z","updated_at":"2024-08-20T14:41:15Z","body":"Running into the same issue here, can confirm it only occurs when running tests in parallel with multiple workers _and_ eager loading enabled.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/2299032155/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"gstokkink","id":14915325,"node_id":"MDQ6VXNlcjE0OTE1MzI1","avatar_url":"https://avatars.githubusercontent.com/u/14915325?v=4","gravatar_id":"","url":"https://api.github.com/users/gstokkink","html_url":"https://github.com/gstokkink","followers_url":"https://api.github.com/users/gstokkink/followers","following_url":"https://api.github.com/users/gstokkink/following{/other_user}","gists_url":"https://api.github.com/users/gstokkink/gists{/gist_id}","starred_url":"https://api.github.com/users/gstokkink/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gstokkink/subscriptions","organizations_url":"https://api.github.com/users/gstokkink/orgs","repos_url":"https://api.github.com/users/gstokkink/repos","events_url":"https://api.github.com/users/gstokkink/events{/privacy}","received_events_url":"https://api.github.com/users/gstokkink/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":13946731740,"node_id":"MEE_lADNIULOkwVwgM8AAAADP0o83A","url":"https://api.github.com/repos/rails/rails/issues/events/13946731740","actor":{"login":"robbevp","id":48474670,"node_id":"MDQ6VXNlcjQ4NDc0Njcw","avatar_url":"https://avatars.githubusercontent.com/u/48474670?v=4","gravatar_id":"","url":"https://api.github.com/users/robbevp","html_url":"https://github.com/robbevp","followers_url":"https://api.github.com/users/robbevp/followers","following_url":"https://api.github.com/users/robbevp/following{/other_user}","gists_url":"https://api.github.com/users/robbevp/gists{/gist_id}","starred_url":"https://api.github.com/users/robbevp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/robbevp/subscriptions","organizations_url":"https://api.github.com/users/robbevp/orgs","repos_url":"https://api.github.com/users/robbevp/repos","events_url":"https://api.github.com/users/robbevp/events{/privacy}","received_events_url":"https://api.github.com/users/robbevp/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-08-20T15:07:52Z","performed_via_github_app":null},{"id":13946731751,"node_id":"SE_lADNIULOkwVwgM8AAAADP0o85w","url":"https://api.github.com/repos/rails/rails/issues/events/13946731751","actor":{"login":"robbevp","id":48474670,"node_id":"MDQ6VXNlcjQ4NDc0Njcw","avatar_url":"https://avatars.githubusercontent.com/u/48474670?v=4","gravatar_id":"","url":"https://api.github.com/users/robbevp","html_url":"https://github.com/robbevp","followers_url":"https://api.github.com/users/robbevp/followers","following_url":"https://api.github.com/users/robbevp/following{/other_user}","gists_url":"https://api.github.com/users/robbevp/gists{/gist_id}","starred_url":"https://api.github.com/users/robbevp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/robbevp/subscriptions","organizations_url":"https://api.github.com/users/robbevp/orgs","repos_url":"https://api.github.com/users/robbevp/repos","events_url":"https://api.github.com/users/robbevp/events{/privacy}","received_events_url":"https://api.github.com/users/robbevp/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-08-20T15:07:52Z","performed_via_github_app":null},{"actor":{"login":"jerometremblay","id":4490798,"node_id":"MDQ6VXNlcjQ0OTA3OTg=","avatar_url":"https://avatars.githubusercontent.com/u/4490798?v=4","gravatar_id":"","url":"https://api.github.com/users/jerometremblay","html_url":"https://github.com/jerometremblay","followers_url":"https://api.github.com/users/jerometremblay/followers","following_url":"https://api.github.com/users/jerometremblay/following{/other_user}","gists_url":"https://api.github.com/users/jerometremblay/gists{/gist_id}","starred_url":"https://api.github.com/users/jerometremblay/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jerometremblay/subscriptions","organizations_url":"https://api.github.com/users/jerometremblay/orgs","repos_url":"https://api.github.com/users/jerometremblay/repos","events_url":"https://api.github.com/users/jerometremblay/events{/privacy}","received_events_url":"https://api.github.com/users/jerometremblay/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-20T15:27:21Z","updated_at":"2024-08-20T15:27:21Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/rails/rails/issues/52657","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/52657/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/52657/comments","events_url":"https://api.github.com/repos/rails/rails/issues/52657/events","html_url":"https://github.com/rails/rails/issues/52657","id":2475938918,"node_id":"I_kwDNIULOk5PUZg","number":52657,"title":"Problem with cached_find_by and cached_find_by_statement","user":{"login":"jerometremblay","id":4490798,"node_id":"MDQ6VXNlcjQ0OTA3OTg=","avatar_url":"https://avatars.githubusercontent.com/u/4490798?v=4","gravatar_id":"","url":"https://api.github.com/users/jerometremblay","html_url":"https://github.com/jerometremblay","followers_url":"https://api.github.com/users/jerometremblay/followers","following_url":"https://api.github.com/users/jerometremblay/following{/other_user}","gists_url":"https://api.github.com/users/jerometremblay/gists{/gist_id}","starred_url":"https://api.github.com/users/jerometremblay/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jerometremblay/subscriptions","organizations_url":"https://api.github.com/users/jerometremblay/orgs","repos_url":"https://api.github.com/users/jerometremblay/repos","events_url":"https://api.github.com/users/jerometremblay/events{/privacy}","received_events_url":"https://api.github.com/users/jerometremblay/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2024-08-20T15:27:21Z","updated_at":"2024-08-20T15:52:35Z","closed_at":"2024-08-20T15:42:55Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":8514,"node_id":"MDEwOlJlcG9zaXRvcnk4NTE0","name":"rails","full_name":"rails/rails","private":false,"owner":{"login":"rails","id":4223,"node_id":"MDEyOk9yZ2FuaXphdGlvbjQyMjM=","avatar_url":"https://avatars.githubusercontent.com/u/4223?v=4","gravatar_id":"","url":"https://api.github.com/users/rails","html_url":"https://github.com/rails","followers_url":"https://api.github.com/users/rails/followers","following_url":"https://api.github.com/users/rails/following{/other_user}","gists_url":"https://api.github.com/users/rails/gists{/gist_id}","starred_url":"https://api.github.com/users/rails/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rails/subscriptions","organizations_url":"https://api.github.com/users/rails/orgs","repos_url":"https://api.github.com/users/rails/repos","events_url":"https://api.github.com/users/rails/events{/privacy}","received_events_url":"https://api.github.com/users/rails/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/rails/rails","description":"Ruby on Rails","fork":false,"url":"https://api.github.com/repos/rails/rails","forks_url":"https://api.github.com/repos/rails/rails/forks","keys_url":"https://api.github.com/repos/rails/rails/keys{/key_id}","collaborators_url":"https://api.github.com/repos/rails/rails/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/rails/rails/teams","hooks_url":"https://api.github.com/repos/rails/rails/hooks","issue_events_url":"https://api.github.com/repos/rails/rails/issues/events{/number}","events_url":"https://api.github.com/repos/rails/rails/events","assignees_url":"https://api.github.com/repos/rails/rails/assignees{/user}","branches_url":"https://api.github.com/repos/rails/rails/branches{/branch}","tags_url":"https://api.github.com/repos/rails/rails/tags","blobs_url":"https://api.github.com/repos/rails/rails/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/rails/rails/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/rails/rails/git/refs{/sha}","trees_url":"https://api.github.com/repos/rails/rails/git/trees{/sha}","statuses_url":"https://api.github.com/repos/rails/rails/statuses/{sha}","languages_url":"https://api.github.com/repos/rails/rails/languages","stargazers_url":"https://api.github.com/repos/rails/rails/stargazers","contributors_url":"https://api.github.com/repos/rails/rails/contributors","subscribers_url":"https://api.github.com/repos/rails/rails/subscribers","subscription_url":"https://api.github.com/repos/rails/rails/subscription","commits_url":"https://api.github.com/repos/rails/rails/commits{/sha}","git_commits_url":"https://api.github.com/repos/rails/rails/git/commits{/sha}","comments_url":"https://api.github.com/repos/rails/rails/comments{/number}","issue_comment_url":"https://api.github.com/repos/rails/rails/issues/comments{/number}","contents_url":"https://api.github.com/repos/rails/rails/contents/{+path}","compare_url":"https://api.github.com/repos/rails/rails/compare/{base}...{head}","merges_url":"https://api.github.com/repos/rails/rails/merges","archive_url":"https://api.github.com/repos/rails/rails/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/rails/rails/downloads","issues_url":"https://api.github.com/repos/rails/rails/issues{/number}","pulls_url":"https://api.github.com/repos/rails/rails/pulls{/number}","milestones_url":"https://api.github.com/repos/rails/rails/milestones{/number}","notifications_url":"https://api.github.com/repos/rails/rails/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/rails/rails/labels{/name}","releases_url":"https://api.github.com/repos/rails/rails/releases{/id}","deployments_url":"https://api.github.com/repos/rails/rails/deployments","created_at":"2008-04-11T02:19:47Z","updated_at":"2025-11-10T02:03:47Z","pushed_at":"2025-11-10T00:33:52Z","git_url":"git://github.com/rails/rails.git","ssh_url":"git@github.com:rails/rails.git","clone_url":"https://github.com/rails/rails.git","svn_url":"https://github.com/rails/rails","homepage":"https://rubyonrails.org","size":271619,"stargazers_count":57840,"watchers_count":57840,"language":"Ruby","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":true,"forks_count":22025,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":1341,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["activejob","activerecord","framework","html","mvc","rails","ruby"],"visibility":"public","forks":22025,"open_issues":1341,"watchers":57840,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"### Steps to reproduce\r\n\r\nI just updated my application to Rails 7.2.\r\n\r\nI had the https://github.com/rails/rails/issues/52607 issue.\r\n\r\nBut now I have at least two problems:\r\n- `MyModel.survey`, where survey is defined in MyModel as `belong_to :survey`\r\n- `MyModel.find('bc622fd5-11f2-4e01-b90f-dc1c5d16afd6')`\r\n\r\nBoth of those methods fails with 'ArgumentError: wrong number of arguments (given 2, expected 1)'\r\n\r\nI tracked the the error to `cached_find_by_statement` and `cached_find_by`, both of which were modified back in [7.2.0.beta1](https://github.com/rails/rails/commit/fa048105d145536538b923fa57465bdeee559e88#diff-4411c7993e3f8ccfd8e09f44a81f10dfac3ea7dbd44cabd60b369040a00be324)\r\n\r\nI see from the code that `cached_find_by_statement` should accept two parameters, but somehow when I am in `cached_find_by`, the version that is actually called only accepts 1.\r\n\r\nI don't understand what is happening. \r\n\r\n\r\n### Expected behavior\r\n\r\n- MyModel.survey returns a Survey instance.\r\n- MyModel.find('bc622fd5-11f2-4e01-b90f-dc1c5d16afd6') returns a MyModel instance.\r\n\r\nBoth of those values actually exists in the database, and were correctly loaded prior the Rails 7.2 upgrade.\r\n\r\n### Actual behavior\r\n\r\nAn exception is raised\r\n\r\n`ArgumentError: wrong number of arguments (given 2, expected 1)`\r\n\r\n### System configuration\r\n**Rails version**: 7.2\r\n\r\n**Ruby version**: 3.2.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/52657/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/52657/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"},{"url":"https://api.github.com/repos/rails/rails/issues/comments/2299179360","html_url":"https://github.com/rails/rails/issues/52607#issuecomment-2299179360","issue_url":"https://api.github.com/repos/rails/rails/issues/52607","id":2299179360,"node_id":"IC_kwDNIULOiQqxYA","user":{"login":"gstokkink","id":14915325,"node_id":"MDQ6VXNlcjE0OTE1MzI1","avatar_url":"https://avatars.githubusercontent.com/u/14915325?v=4","gravatar_id":"","url":"https://api.github.com/users/gstokkink","html_url":"https://github.com/gstokkink","followers_url":"https://api.github.com/users/gstokkink/followers","following_url":"https://api.github.com/users/gstokkink/following{/other_user}","gists_url":"https://api.github.com/users/gstokkink/gists{/gist_id}","starred_url":"https://api.github.com/users/gstokkink/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gstokkink/subscriptions","organizations_url":"https://api.github.com/users/gstokkink/orgs","repos_url":"https://api.github.com/users/gstokkink/repos","events_url":"https://api.github.com/users/gstokkink/events{/privacy}","received_events_url":"https://api.github.com/users/gstokkink/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-20T15:47:29Z","updated_at":"2024-08-20T15:47:29Z","body":"For what it's worth, this issue does _not_ occur if I comment out this bit of code:\r\n\r\nhttps://github.com/rails/rails/blob/v7.2.0/railties/lib/rails/testing/maintain_test_schema.rb#L11-L15\r\n\r\nMight explain why the issue only occurs when eager loading is enabled.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/2299179360/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"gstokkink","id":14915325,"node_id":"MDQ6VXNlcjE0OTE1MzI1","avatar_url":"https://avatars.githubusercontent.com/u/14915325?v=4","gravatar_id":"","url":"https://api.github.com/users/gstokkink","html_url":"https://github.com/gstokkink","followers_url":"https://api.github.com/users/gstokkink/followers","following_url":"https://api.github.com/users/gstokkink/following{/other_user}","gists_url":"https://api.github.com/users/gstokkink/gists{/gist_id}","starred_url":"https://api.github.com/users/gstokkink/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gstokkink/subscriptions","organizations_url":"https://api.github.com/users/gstokkink/orgs","repos_url":"https://api.github.com/users/gstokkink/repos","events_url":"https://api.github.com/users/gstokkink/events{/privacy}","received_events_url":"https://api.github.com/users/gstokkink/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rails/rails/issues/comments/2299686248","html_url":"https://github.com/rails/rails/issues/52607#issuecomment-2299686248","issue_url":"https://api.github.com/repos/rails/rails/issues/52607","id":2299686248,"node_id":"IC_kwDNIULOiRJtaA","user":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-20T20:14:32Z","updated_at":"2024-08-20T20:14:32Z","body":"That makes the issue disappear but isn't the place where we should fix. We should understand why the `connection.lookup_cast_type_from_column(column)` is returning different values.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/2299686248/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rails/rails/issues/comments/2299749629","html_url":"https://github.com/rails/rails/issues/52607#issuecomment-2299749629","issue_url":"https://api.github.com/repos/rails/rails/issues/52607","id":2299749629,"node_id":"IC_kwDNIULOiRNk_Q","user":{"login":"gstokkink","id":14915325,"node_id":"MDQ6VXNlcjE0OTE1MzI1","avatar_url":"https://avatars.githubusercontent.com/u/14915325?v=4","gravatar_id":"","url":"https://api.github.com/users/gstokkink","html_url":"https://github.com/gstokkink","followers_url":"https://api.github.com/users/gstokkink/followers","following_url":"https://api.github.com/users/gstokkink/following{/other_user}","gists_url":"https://api.github.com/users/gstokkink/gists{/gist_id}","starred_url":"https://api.github.com/users/gstokkink/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gstokkink/subscriptions","organizations_url":"https://api.github.com/users/gstokkink/orgs","repos_url":"https://api.github.com/users/gstokkink/repos","events_url":"https://api.github.com/users/gstokkink/events{/privacy}","received_events_url":"https://api.github.com/users/gstokkink/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-20T20:55:54Z","updated_at":"2024-08-21T04:13:04Z","body":"Oh no, I agree, just saying that that's probably why eager loading is a prerequisite for this issue to appear. The forced schema loading seems to trigger it. It might help narrowing down the minimal reproduction scenario.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/2299749629/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"gstokkink","id":14915325,"node_id":"MDQ6VXNlcjE0OTE1MzI1","avatar_url":"https://avatars.githubusercontent.com/u/14915325?v=4","gravatar_id":"","url":"https://api.github.com/users/gstokkink","html_url":"https://github.com/gstokkink","followers_url":"https://api.github.com/users/gstokkink/followers","following_url":"https://api.github.com/users/gstokkink/following{/other_user}","gists_url":"https://api.github.com/users/gstokkink/gists{/gist_id}","starred_url":"https://api.github.com/users/gstokkink/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gstokkink/subscriptions","organizations_url":"https://api.github.com/users/gstokkink/orgs","repos_url":"https://api.github.com/users/gstokkink/repos","events_url":"https://api.github.com/users/gstokkink/events{/privacy}","received_events_url":"https://api.github.com/users/gstokkink/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":13951009783,"node_id":"MEE_lADNIULOkwVwgM8AAAADP4uD9w","url":"https://api.github.com/repos/rails/rails/issues/events/13951009783","actor":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-08-20T21:16:49Z","performed_via_github_app":null},{"id":13951009792,"node_id":"SE_lADNIULOkwVwgM8AAAADP4uEAA","url":"https://api.github.com/repos/rails/rails/issues/events/13951009792","actor":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-08-20T21:16:49Z","performed_via_github_app":null},{"actor":{"login":"ankane","id":220358,"node_id":"MDQ6VXNlcjIyMDM1OA==","avatar_url":"https://avatars.githubusercontent.com/u/220358?v=4","gravatar_id":"","url":"https://api.github.com/users/ankane","html_url":"https://github.com/ankane","followers_url":"https://api.github.com/users/ankane/followers","following_url":"https://api.github.com/users/ankane/following{/other_user}","gists_url":"https://api.github.com/users/ankane/gists{/gist_id}","starred_url":"https://api.github.com/users/ankane/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ankane/subscriptions","organizations_url":"https://api.github.com/users/ankane/orgs","repos_url":"https://api.github.com/users/ankane/repos","events_url":"https://api.github.com/users/ankane/events{/privacy}","received_events_url":"https://api.github.com/users/ankane/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-21T18:17:46Z","updated_at":"2024-08-21T18:17:46Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/ankane/neighbor/issues/23","repository_url":"https://api.github.com/repos/ankane/neighbor","labels_url":"https://api.github.com/repos/ankane/neighbor/issues/23/labels{/name}","comments_url":"https://api.github.com/repos/ankane/neighbor/issues/23/comments","events_url":"https://api.github.com/repos/ankane/neighbor/issues/23/events","html_url":"https://github.com/ankane/neighbor/issues/23","id":2476365898,"node_id":"I_kwDOFDkX0M6TmlhK","number":23,"title":"TypeError: can't quote Array (occasionally)","user":{"login":"gjtorikian","id":64050,"node_id":"MDQ6VXNlcjY0MDUw","avatar_url":"https://avatars.githubusercontent.com/u/64050?v=4","gravatar_id":"","url":"https://api.github.com/users/gjtorikian","html_url":"https://github.com/gjtorikian","followers_url":"https://api.github.com/users/gjtorikian/followers","following_url":"https://api.github.com/users/gjtorikian/following{/other_user}","gists_url":"https://api.github.com/users/gjtorikian/gists{/gist_id}","starred_url":"https://api.github.com/users/gjtorikian/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gjtorikian/subscriptions","organizations_url":"https://api.github.com/users/gjtorikian/orgs","repos_url":"https://api.github.com/users/gjtorikian/repos","events_url":"https://api.github.com/users/gjtorikian/events{/privacy}","received_events_url":"https://api.github.com/users/gjtorikian/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2024-08-20T19:16:34Z","updated_at":"2024-08-25T20:20:45Z","closed_at":"2024-08-25T20:20:44Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":339285968,"node_id":"MDEwOlJlcG9zaXRvcnkzMzkyODU5Njg=","name":"neighbor","full_name":"ankane/neighbor","private":false,"owner":{"login":"ankane","id":220358,"node_id":"MDQ6VXNlcjIyMDM1OA==","avatar_url":"https://avatars.githubusercontent.com/u/220358?v=4","gravatar_id":"","url":"https://api.github.com/users/ankane","html_url":"https://github.com/ankane","followers_url":"https://api.github.com/users/ankane/followers","following_url":"https://api.github.com/users/ankane/following{/other_user}","gists_url":"https://api.github.com/users/ankane/gists{/gist_id}","starred_url":"https://api.github.com/users/ankane/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ankane/subscriptions","organizations_url":"https://api.github.com/users/ankane/orgs","repos_url":"https://api.github.com/users/ankane/repos","events_url":"https://api.github.com/users/ankane/events{/privacy}","received_events_url":"https://api.github.com/users/ankane/received_events","type":"User","user_view_type":"public","site_admin":false},"html_url":"https://github.com/ankane/neighbor","description":"Nearest neighbor search for Rails","fork":false,"url":"https://api.github.com/repos/ankane/neighbor","forks_url":"https://api.github.com/repos/ankane/neighbor/forks","keys_url":"https://api.github.com/repos/ankane/neighbor/keys{/key_id}","collaborators_url":"https://api.github.com/repos/ankane/neighbor/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/ankane/neighbor/teams","hooks_url":"https://api.github.com/repos/ankane/neighbor/hooks","issue_events_url":"https://api.github.com/repos/ankane/neighbor/issues/events{/number}","events_url":"https://api.github.com/repos/ankane/neighbor/events","assignees_url":"https://api.github.com/repos/ankane/neighbor/assignees{/user}","branches_url":"https://api.github.com/repos/ankane/neighbor/branches{/branch}","tags_url":"https://api.github.com/repos/ankane/neighbor/tags","blobs_url":"https://api.github.com/repos/ankane/neighbor/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/ankane/neighbor/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/ankane/neighbor/git/refs{/sha}","trees_url":"https://api.github.com/repos/ankane/neighbor/git/trees{/sha}","statuses_url":"https://api.github.com/repos/ankane/neighbor/statuses/{sha}","languages_url":"https://api.github.com/repos/ankane/neighbor/languages","stargazers_url":"https://api.github.com/repos/ankane/neighbor/stargazers","contributors_url":"https://api.github.com/repos/ankane/neighbor/contributors","subscribers_url":"https://api.github.com/repos/ankane/neighbor/subscribers","subscription_url":"https://api.github.com/repos/ankane/neighbor/subscription","commits_url":"https://api.github.com/repos/ankane/neighbor/commits{/sha}","git_commits_url":"https://api.github.com/repos/ankane/neighbor/git/commits{/sha}","comments_url":"https://api.github.com/repos/ankane/neighbor/comments{/number}","issue_comment_url":"https://api.github.com/repos/ankane/neighbor/issues/comments{/number}","contents_url":"https://api.github.com/repos/ankane/neighbor/contents/{+path}","compare_url":"https://api.github.com/repos/ankane/neighbor/compare/{base}...{head}","merges_url":"https://api.github.com/repos/ankane/neighbor/merges","archive_url":"https://api.github.com/repos/ankane/neighbor/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/ankane/neighbor/downloads","issues_url":"https://api.github.com/repos/ankane/neighbor/issues{/number}","pulls_url":"https://api.github.com/repos/ankane/neighbor/pulls{/number}","milestones_url":"https://api.github.com/repos/ankane/neighbor/milestones{/number}","notifications_url":"https://api.github.com/repos/ankane/neighbor/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/ankane/neighbor/labels{/name}","releases_url":"https://api.github.com/repos/ankane/neighbor/releases{/id}","deployments_url":"https://api.github.com/repos/ankane/neighbor/deployments","created_at":"2021-02-16T04:36:33Z","updated_at":"2025-11-09T21:57:53Z","pushed_at":"2025-10-24T02:36:07Z","git_url":"git://github.com/ankane/neighbor.git","ssh_url":"git@github.com:ankane/neighbor.git","clone_url":"https://github.com/ankane/neighbor.git","svn_url":"https://github.com/ankane/neighbor","homepage":"","size":334,"stargazers_count":764,"watchers_count":764,"language":"Ruby","has_issues":true,"has_projects":false,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":false,"forks_count":17,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":3,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["nearest-neighbor-search"],"visibility":"public","forks":17,"open_issues":3,"watchers":764,"default_branch":"master","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"I'm not quite sure what's causing it, but sometimes, `neighbor` throws the following error:\r\n\r\n```\r\n[123, 132] in ~/.rbenv/versions/3.3.4/lib/ruby/gems/3.3.0/gems/neighbor-0.4.0/lib/neighbor/model.rb\r\n   123|           column_attribute = klass.type_for_attribute(attribute_name)\r\n   124|           vector = column_attribute.cast(vector)\r\n   125|           Neighbor::Utils.validate(vector, dimensions: dimensions, column_info: column_info)\r\n   126|           vector = Neighbor::Utils.normalize(vector, column_info: column_info) if normalize\r\n   127| \r\n=> 128|           query = connection.quote(column_attribute.serialize(vector))\r\n   129|           order = \"#{quoted_attribute} #{operator} #{query}\"\r\n   130|           if operator == \"#\"\r\n   131|             order = \"bit_count(#{order})\"\r\n   132|           end\r\n=>#0    block {|attribute_name=:embedding_1536, vector=[0.011979911, -0.03421443, 8.979617e-05,..., options={:dimensions=>nil, :normalize=>nil}|} in has_neighbors (2 levels) at ~/.rbenv/versions/3.3.4/lib/ruby/gems/3.3.0/gems/neighbor-0.4.0/lib/neighbor/model.rb:128\r\n  #1    [C] BasicObject#instance_exec at ~/.rbenv/versions/3.3.4/lib/ruby/gems/3.3.0/gems/activerecord-7.2.0/lib/active_record/relation.rb:548\r\n  # and 46 frames (use `bt' command for all frames)\r\n(ruby@bin/rails#63657) connection.quote(column_attribute.serialize(vector))\r\neval error: can't quote Array\r\n  /Users/gjtorikian/.rbenv/versions/3.3.4/lib/ruby/gems/3.3.0/gems/activerecord-7.2.0/lib/active_record/connection_adapters/abstract/quoting.rb:87:in `quote'\r\n  /Users/gjtorikian/.rbenv/versions/3.3.4/lib/ruby/gems/3.3.0/gems/activerecord-7.2.0/lib/active_record/connection_adapters/postgresql/quoting.rb:122:in `quote'\r\n  (rdbg)//Users/gjtorikian/.rbenv/versions/3.3.4/lib/ruby/gems/3.3.0/gems/neighbor-0.4.0/lib/neighbor/model.rb:1:in `block (2 levels) in has_neighbors'\r\n```\r\n\r\nThis is despite the fact that none of the arguments in the `nearest_neighbors` scope change. ","reactions":{"url":"https://api.github.com/repos/ankane/neighbor/issues/23/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/ankane/neighbor/issues/23/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"}]