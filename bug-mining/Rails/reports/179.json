{"url":"https://api.github.com/repos/rails/rails/issues/54267","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/54267/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/54267/comments","events_url":"https://api.github.com/repos/rails/rails/issues/54267/events","html_url":"https://github.com/rails/rails/issues/54267","id":2792884288,"node_id":"I_kwDNIULOpngIQA","number":54267,"title":"[Regression] Invalid doubly-nested attributes are saved","user":{"login":"adrianna-chang-shopify","id":22918438,"node_id":"MDQ6VXNlcjIyOTE4NDM4","avatar_url":"https://avatars.githubusercontent.com/u/22918438?v=4","gravatar_id":"","url":"https://api.github.com/users/adrianna-chang-shopify","html_url":"https://github.com/adrianna-chang-shopify","followers_url":"https://api.github.com/users/adrianna-chang-shopify/followers","following_url":"https://api.github.com/users/adrianna-chang-shopify/following{/other_user}","gists_url":"https://api.github.com/users/adrianna-chang-shopify/gists{/gist_id}","starred_url":"https://api.github.com/users/adrianna-chang-shopify/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adrianna-chang-shopify/subscriptions","organizations_url":"https://api.github.com/users/adrianna-chang-shopify/orgs","repos_url":"https://api.github.com/users/adrianna-chang-shopify/repos","events_url":"https://api.github.com/users/adrianna-chang-shopify/events{/privacy}","received_events_url":"https://api.github.com/users/adrianna-chang-shopify/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2025-01-16T14:08:41Z","updated_at":"2025-01-20T09:27:03Z","closed_at":"2025-01-20T09:27:02Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I believe https://github.com/rails/rails/pull/53951 introduced a regression into saving nested attributes if there is more than one level of nesting. Repro:\n\n```ruby\nrequire \"bundler/inline\"\n\ngemfile(true) do\n  source \"https://rubygems.org\"\n\n  # gem \"rails\", github: \"rails/rails\", branch: \"main\"\n  gem \"rails\", github: \"rails/rails\", ref: \"9424179306\" # commit prior to change\n\n  gem \"sqlite3\"\n\n  gem \"debug\"\nend\n\nrequire \"active_record/railtie\"\nrequire \"minitest/autorun\"\n\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\n\nActiveRecord::Schema.define do\n  create_table :countries do |t|\n    t.string :name\n  end\n\n  create_table :tax_overrides do |t|\n    t.string :name\n    t.references :country\n  end\n\n  create_table :tax_override_regions do |t|\n    t.string :name\n    t.references :tax_override\n    t.decimal :rate, precision: 10, scale: 2\n  end\nend\n\nclass Country < ActiveRecord::Base\n  has_many :tax_overrides\n\n  accepts_nested_attributes_for :tax_overrides\nend\n\nclass TaxOverride < ActiveRecord::Base\n  belongs_to :country\n  has_many :tax_override_regions\n\n  accepts_nested_attributes_for :tax_override_regions\nend\n\nclass TaxOverrideRegion < ActiveRecord::Base\n  belongs_to :tax_override\n\n  validates :rate, numericality: { greater_than_or_equal_to: 0 }, allow_nil: false\nend\n\nclass BugTest < ActiveSupport::TestCase\n  def test_validation_issue\n    country = Country.build(name: \"Canada\")\n    tax_override = country.tax_overrides.build(name: \"Tax Override for Ontario\")\n    tax_override_region = tax_override.tax_override_regions.build(name: \"Toronto\", rate: 10.0)\n\n    country.save!\n\n    input_attributes = {\n      tax_overrides_attributes:\n      {\"0\" =>\n        {\n          id: tax_override.id,\n          tax_override_regions_attributes: {\"0\" => { rate: -0.4, id: tax_override_region.id }},\n        }\n      }\n    }\n\n    refute country.update(input_attributes), \"Country should not have been updated\"\n    assert country.errors.full_messages.include?(\n      \"Tax overrides tax override regions rate must be greater than or equal to 0\"\n    )\n  end\nend\n```\n\nBefore change, the test passes.\n\nOn main:\n```\n  1) Failure:\nBugTest#test_validation_issue [scripts/no-validation-bug.rb:73]:\nCountry should not have been updated\n\n1 runs, 1 assertions, 1 failures, 0 errors, 0 skips\n```\n\ncc @byroot \n","closed_by":{"login":"byroot","id":44640,"node_id":"MDQ6VXNlcjQ0NjQw","avatar_url":"https://avatars.githubusercontent.com/u/44640?v=4","gravatar_id":"","url":"https://api.github.com/users/byroot","html_url":"https://github.com/byroot","followers_url":"https://api.github.com/users/byroot/followers","following_url":"https://api.github.com/users/byroot/following{/other_user}","gists_url":"https://api.github.com/users/byroot/gists{/gist_id}","starred_url":"https://api.github.com/users/byroot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/byroot/subscriptions","organizations_url":"https://api.github.com/users/byroot/orgs","repos_url":"https://api.github.com/users/byroot/repos","events_url":"https://api.github.com/users/byroot/events{/privacy}","received_events_url":"https://api.github.com/users/byroot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/54267/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/54267/timeline","performed_via_github_app":null,"state_reason":"completed"}