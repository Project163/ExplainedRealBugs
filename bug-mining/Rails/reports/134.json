{"url":"https://api.github.com/repos/rails/rails/issues/52607","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/52607/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/52607/comments","events_url":"https://api.github.com/repos/rails/rails/issues/52607/events","html_url":"https://github.com/rails/rails/issues/52607","id":2466607232,"node_id":"I_kwDNIULOkwVwgA","number":52607,"title":"False positive for enum without DB column in rails 7.2 in parallelized tests","user":{"login":"robbevp","id":48474670,"node_id":"MDQ6VXNlcjQ4NDc0Njcw","avatar_url":"https://avatars.githubusercontent.com/u/48474670?v=4","gravatar_id":"","url":"https://api.github.com/users/robbevp","html_url":"https://github.com/robbevp","followers_url":"https://api.github.com/users/robbevp/followers","following_url":"https://api.github.com/users/robbevp/following{/other_user}","gists_url":"https://api.github.com/users/robbevp/gists{/gist_id}","starred_url":"https://api.github.com/users/robbevp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/robbevp/subscriptions","organizations_url":"https://api.github.com/users/robbevp/orgs","repos_url":"https://api.github.com/users/robbevp/repos","events_url":"https://api.github.com/users/robbevp/events{/privacy}","received_events_url":"https://api.github.com/users/robbevp/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/rails/rails/milestones/89","html_url":"https://github.com/rails/rails/milestone/89","labels_url":"https://api.github.com/repos/rails/rails/milestones/89/labels","id":11433036,"node_id":"MI_kwDNIULOAK50TA","number":89,"title":"7.2.1","description":"","creator":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":4,"state":"closed","created_at":"2024-08-12T17:36:48Z","updated_at":"2024-08-22T21:33:44Z","due_on":null,"closed_at":"2024-08-22T21:33:44Z"},"comments":20,"created_at":"2024-08-14T19:03:26Z","updated_at":"2024-08-22T15:24:00Z","closed_at":"2024-08-22T15:17:26Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"While updating an app to 7.2, my CI started throwing a lot of errors around enums:\r\n```\r\nRuntimeError: Undeclared attribute type for enum 'post_type' in Post. Enums must be backed by a database column or declared with an explicit type via `attribute`.\r\n```\r\nThese are false positives as (1) the DB column exists (2) the tests worked locally/work when not executed in parallel.\r\n\r\nI _think_ the actual issue might not be related to enums, but just be some underlying problem in how attributes are initialized. However, I'm not knowledgeable enough about these rails internals to be really sure of what is going on \r\n\r\n### Steps to reproduce\r\n* Add an enum backed by a Postgres enum to a model\r\n* Add a test that calls the model in some way that loads the attribute info\r\n* Run tests in parallel\r\n* Run tests using `config.eager_load = true` ~~(This is needed in my actual app but not in the reproduction below)~~\r\n\r\nI had to add a bunch of stuff to the basic script to reproduce the error and had to create a separate schema file. There might be a better way to reproduce this\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nENV['RAILS_ENV'] ||= 'test'\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  gem \"rails\", \"~> 7.2.0\"\r\n  # If you want to test against edge Rails replace the previous line with this:\r\n  # gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n\r\n  gem \"pg\", \"~> 1.5.7\"\r\n\r\n  gem \"minitest\", \"5.24.1\" # https://github.com/minitest/minitest/issues/1007\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"action_controller/railtie\"\r\nrequire \"logger\"\r\n\r\nActiveRecord::Base.configurations = { \r\n  \"test\" => {\r\n    \"adapter\"=>\"postgresql\",\r\n    \"database\"=>\"test\",\r\n    \"host\"=>\"localhost\",\r\n    \"username\"=>\"rails\",\r\n    \"password\"=>\"rails\"\r\n  }\r\n}\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(\r\n  adapter:  \"postgresql\",\r\n  host:     \"localhost\",\r\n  username: \"rails\",\r\n  password: \"rails\",\r\n  database: \"test\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\n\r\nclass Application < Rails::Application\r\n  # Setting eager load to `true` matters in my test setup\r\n  # but this does not make a difference in the reproduction\r\n  config.eager_load = false\r\nend\r\n\r\nRails.application.initialize!\r\n\r\nclass Post < ActiveRecord::Base\r\n  enum :post_type, { one: 'one', two: 'two', three: 'three' }\r\nend\r\n\r\n\r\nclass ActiveSupport::TestCase\r\n  parallelize(\r\n    workers: 0, # The amount of workers doesn't matter, as long as `parallelize` is used\r\n    threshold: 1 # The threshold does matter, if you set this to 2 the tests will work\r\n  )\r\nend\r\n\r\nrequire \"rails/test_help\"\r\n\r\nclass BugTest < ActiveSupport::TestCase\r\n  def test_one\r\n    Post.new\r\n\r\n    assert true\r\n  end\r\n\r\n  def test_two\r\n    Post.new\r\n\r\n    assert true\r\n  end\r\nend\r\n```\r\n\r\nIn a separate `db/schema.rb` file\r\n```ruby\r\nActiveRecord::Schema.define do\r\n  create_enum \"my_enum\", [\"one\", \"two\", \"three\"]\r\n\r\n  create_table :posts, force: true do |t|\r\n    t.enum :post_type, enum_type: :my_enum\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nThe DB column should be detected, since this worked in rails 7.1.X (and many versions before that)\r\n\r\n### Actual behavior\r\nAn error is throw saying that the enum does not have a matching DB column\r\n```\r\nRuntimeError: Undeclared attribute type for enum 'post_type' in Post. Enums must be backed by a database column or declared with an explicit type via `attribute`.\r\n    vendor/ruby/gems/activerecord-7.2.0/lib/active_record/enum.rb:259:in `block in _enum'\r\n    vendor/ruby/gems/activemodel-7.2.0/lib/active_model/attribute_registration.rb:71:in `block in apply_to'\r\n    vendor/ruby/gems/activemodel-7.2.0/lib/active_model/attribute_registration.rb:69:in `each'\r\n    vendor/ruby/gems/activemodel-7.2.0/lib/active_model/attribute_registration.rb:69:in `apply_to'\r\n    vendor/ruby/gems/activemodel-7.2.0/lib/active_model/attribute_registration.rb:87:in `block in apply_pending_attribute_modifications'\r\n    vendor/ruby/gems/activemodel-7.2.0/lib/active_model/attribute_registration.rb:86:in `each'\r\n    vendor/ruby/gems/activemodel-7.2.0/lib/active_model/attribute_registration.rb:86:in `apply_pending_attribute_modifications'\r\n    vendor/ruby/gems/activerecord-7.2.0/lib/active_record/attributes.rb:249:in `_default_attributes'\r\n    vendor/ruby/gems/activemodel-7.2.0/lib/active_model/attribute_registration.rb:38:in `attribute_types'\r\n    vendor/ruby/gems/activerecord-7.2.0/lib/active_record/attribute_methods.rb:260:in `_has_attribute?'\r\n    vendor/ruby/gems/activerecord-7.2.0/lib/active_record/inheritance.rb:61:in `new'\r\n    script.rb:67:in `test_one'\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.2\r\n\r\n**Ruby version**: 3.2.4\r\n","closed_by":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/52607/reactions","total_count":8,"+1":8,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/52607/timeline","performed_via_github_app":null,"state_reason":"completed"}