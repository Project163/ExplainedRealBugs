{"url":"https://api.github.com/repos/rails/rails/issues/55708","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/55708/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/55708/comments","events_url":"https://api.github.com/repos/rails/rails/issues/55708/events","html_url":"https://github.com/rails/rails/issues/55708","id":3434402921,"node_id":"I_kwDNIULOzLTUaQ","number":55708,"title":"ActiveSupport::FileUpdateChecker triggers unnecessary reloads in tests using time travel","user":{"login":"grodowski","id":4991698,"node_id":"MDQ6VXNlcjQ5OTE2OTg=","avatar_url":"https://avatars.githubusercontent.com/u/4991698?v=4","gravatar_id":"","url":"https://api.github.com/users/grodowski","html_url":"https://github.com/grodowski","followers_url":"https://api.github.com/users/grodowski/followers","following_url":"https://api.github.com/users/grodowski/following{/other_user}","gists_url":"https://api.github.com/users/grodowski/gists{/gist_id}","starred_url":"https://api.github.com/users/grodowski/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/grodowski/subscriptions","organizations_url":"https://api.github.com/users/grodowski/orgs","repos_url":"https://api.github.com/users/grodowski/repos","events_url":"https://api.github.com/users/grodowski/events{/privacy}","received_events_url":"https://api.github.com/users/grodowski/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2025-09-19T13:34:00Z","updated_at":"2025-09-19T20:11:53Z","closed_at":"2025-09-19T20:11:53Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"My team discovered this issue troubleshooting a flaky test that depended on class state that was (re)created at load time. We found that when `Time.now` is stubbed with time travel test helpers, the checker treats all files as updated and reloads even when files haven't been changed. Our temporary fix was to enable `cache_classes` in the Rails config for tests (which does make sense in general), but this led me to a possible change to the `FileUpdateChecker` to avoid those unnecessary file reloads caused by time travel in tests.\n\n### Steps to reproduce\n\nRun `ruby file_update_checker_time_travel.rb --seed 23705` with the following structure and observe the constant is reloaded:\n\n```\n  1) Failure:\nBugTest#test_without_time_travel [file_update_checker_time_travel.rb:58]:\n--- expected\n+++ actual\n@@ -1,3 +1,3 @@\n # encoding: ASCII-8BIT\n #    valid: true\n-\"243\"\n+\"437\"\n```\n\nThis is the smallest setup I could get to show that a test, when executed following one that uses time travel helpers, will experience unnecessary reloads.\n\n```\n.\n├── app\n│   └── models\n│       └── user.rb\n├── config\n│   └── routes.rb\n└── file_update_checker_time_travel.rb\n```\n\n```ruby\n# app/models/user.rb\nclass User\n  puts \"Loading User...\"\n  cattr_accessor :random_value do\n    rand(1000)\n  end\nend\n```\n\n```ruby\n# config/routes.rb\nRails.application.routes.draw do\n  get \"/\", to: \"test#index\"\nend\n```\n\n```ruby\n# file_update_checker_time_travel.rb\n# frozen_string_literal: true\n\nrequire \"bundler/inline\"\n\ngemfile(true) do\n  source \"https://rubygems.org\"\n\n  gem \"rails\"\nend\n\nrequire \"action_controller/railtie\"\nrequire \"minitest/autorun\"\nrequire \"rack/test\"\n\nclass TestApp < Rails::Application\n  config.load_defaults Rails::VERSION::STRING.to_f\n  config.root = __dir__\n  config.eager_load = false\n  config.hosts << \"example.org\"\n  config.secret_key_base = \"secret_key_base\"\n  config.logger = Logger.new($stdout)\n\n  config.enable_reloading = true\nend\n\nRails.application.initialize!\n\n# moved routes to config/routes.rb - otherwise the RoutesReloader runs before tests start and\n# @loaded is already true => the bug isn't reproduced\n# Rails.application.routes.draw do\n#   get \"/\", to: \"test#index\"\n# end\n\nclass TestController < ActionController::Base\n  include Rails.application.routes.url_helpers\n\n  def index\n    render plain: User.random_value\n  end\nend\n\nclass BugTest < ActionDispatch::IntegrationTest\n  include Rack::Test::Methods\n\n  $initial_random_value = nil\n  def test_with_time_travel # ensure with a --seed value that this runs first\n    travel_to Time.utc(2023) do\n      get \"/\"\n      assert last_response.ok?\n      $initial_random_value = last_response.body\n      puts last_response.body\n    end\n  end\n\n  def test_without_time_travel # ensure this runs last\n    get \"/\"\n    assert last_response.ok?\n    assert_equal last_response.body, $initial_random_value\n  end\n\n  private\n\n  def app\n    Rails.application\n  end\nend\n\n# extra debugging for FileUpdateChecker\nmodule ActiveSupport\n  class FileUpdateChecker\n    alias_method :original_initialize, :initialize\n    alias_method :original_updated?, :updated?\n    alias_method :original_execute, :execute\n    def initialize(files, dirs = {}, &block)\n      original_initialize(files, dirs = {}, &block)\n      if caller.any? { |line| line.include?(\"routes_reloader\") }\n        puts \"[initializing FileUpdateChecker] #{self.object_id} for #{files.inspect}, #{dirs.inspect}, @last_update_at: #{@last_update_at.inspect}\"\n      end\n    end\n\n    def updated?\n      original_updated?.tap do\n        if caller.any? { |line| line.include?(\"routes_reloader\") }\n          puts \"[updated? #{self.object_id}] @last_update_at: #{@last_update_at.inspect}\"\n        end\n      end\n    end\n\n    def execute\n      original_execute.tap do\n        if caller.any? { |line| line.include?(\"routes_reloader\") }\n          puts \"[execute #{self.object_id}] set @last_update_at to #{@last_update_at.inspect}\"\n        end\n      end\n    end\n  end\nend\n\n```\n\n### Expected behavior\n\nUnchanged files are not reloaded.\n\n### Actual behavior\n\n`FileUpdateChecker` sets `@last_update_at` to `Time.at(0)` and treats all files as changed.\n\n### Proposed fixes (pull request pending)\n\n- replace `Time.now` with system time in `FileUpdateChecker`: [Use process time instead of Time.now in FileUpdateChecker](https://github.com/rails/rails/commit/b623a64045168dd6f441cb167f9911bf51714a62)\n- kind of a bonus, but using the `EventedFileUpdateChecker` for reloading routes also fixed our issue: [Respect the file_watcher config in the routes reloader](https://github.com/rails/rails/commit/8a3d601a423865f88dd08acf8679f8136185a8da)\n\n### Additional notes\n\nNew Rails apps disable reloading in the `test` environment by default, so they won't be affected by this.\n\n```\n# While tests run files are not watched, reloading is not necessary.\nconfig.enable_reloading = false\n```\n\n### System configuration\n\n**Rails version**: 8.0.2.1\n\n**Ruby version**: 3.4.5\n","closed_by":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/55708/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/55708/timeline","performed_via_github_app":null,"state_reason":"completed"}