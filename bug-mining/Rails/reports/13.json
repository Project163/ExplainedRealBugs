{"url":"https://api.github.com/repos/rails/rails/issues/46724","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/46724/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/46724/comments","events_url":"https://api.github.com/repos/rails/rails/issues/46724/events","html_url":"https://github.com/rails/rails/issues/46724","id":1496692328,"node_id":"I_kwDNIULOWTW2aA","number":46724,"title":"Duplicate tests/unused action in test controller raises error when used.","user":{"login":"leonelgalan","id":727774,"node_id":"MDQ6VXNlcjcyNzc3NA==","avatar_url":"https://avatars.githubusercontent.com/u/727774?v=4","gravatar_id":"","url":"https://api.github.com/users/leonelgalan","html_url":"https://github.com/leonelgalan","followers_url":"https://api.github.com/users/leonelgalan/followers","following_url":"https://api.github.com/users/leonelgalan/following{/other_user}","gists_url":"https://api.github.com/users/leonelgalan/gists{/gist_id}","starred_url":"https://api.github.com/users/leonelgalan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/leonelgalan/subscriptions","organizations_url":"https://api.github.com/users/leonelgalan/orgs","repos_url":"https://api.github.com/users/leonelgalan/repos","events_url":"https://api.github.com/users/leonelgalan/events{/privacy}","received_events_url":"https://api.github.com/users/leonelgalan/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":107189,"node_id":"MDU6TGFiZWwxMDcxODk=","url":"https://api.github.com/repos/rails/rails/labels/actionpack","name":"actionpack","color":"FFF700","default":false,"description":null},{"id":384913768,"node_id":"MDU6TGFiZWwzODQ5MTM3Njg=","url":"https://api.github.com/repos/rails/rails/labels/good%20first%20issue","name":"good first issue","color":"0e8a16","default":true,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-12-14T14:01:56Z","updated_at":"2023-01-16T23:40:28Z","closed_at":"2023-01-16T23:40:28Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Steps to reproduce\r\nDuplicate tests in https://github.com/rails/rails/blob/v7.0.4/actionpack/test/controller/new_base/render_template_test.rb#L103:L111:\r\n\r\n```ruby\r\ntest \"rendering a template with local variables\" do\r\n  get :with_locals\r\n  assert_response \"The secret is area51\"\r\nend\r\n\r\ntest \"rendering a template with local variables without key\" do\r\n  get :with_locals\r\n  assert_response \"The secret is area51\"\r\nend\r\n```\r\n\r\nBoth use the `with_locals` controller action. A `with_locals_without_key` action exists but it is unused; the two relevant actions are defined in [here](https://github.com/rails/rails/blob/v7.0.4/actionpack/test/controller/new_base/render_template_test.rb#L45:L51)\r\n\r\n```ruby\r\ndef with_locals\r\n  render template: \"locals\", locals: { secret: \"area51\" }\r\nend\r\n\r\ndef with_locals_without_key\r\n  render \"locals\", locals: { secret: \"area51\" }\r\nend\r\n```\r\n\r\n#### [Executable Test Case](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) based on the _Template for Action Pack (controllers, routing) issues_:\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"rails\", \"~> 7.0.0\"\r\nend\r\n\r\nrequire \"rack/test\"\r\nrequire \"action_controller/railtie\"\r\n\r\nclass TestApp < Rails::Application\r\n  config.root = __dir__\r\n  config.hosts << \"example.org\"\r\n  config.session_store :cookie_store, key: \"cookie_store_key\"\r\n  secrets.secret_key_base = \"secret_key_base\"\r\n\r\n  config.logger = Logger.new($stdout)\r\n  Rails.logger  = config.logger\r\n\r\n  routes.draw do\r\n    get \"/original\" => \"test#with_locals_without_key\"\r\n    get \"/modified\" => \"test#with_locals_without_key_modified\"\r\n  end\r\nend\r\n\r\nrequire \"action_view/testing/resolvers\"\r\n\r\nclass TestController < ActionController::Base\r\n  include Rails.application.routes.url_helpers\r\n\r\n  # From actionpack/test/controller/new_base/render_template_test.rb:7\r\n  self.view_paths = [ActionView::FixtureResolver.new(\r\n      \"locals.html.erb\"            => \"The secret is <%= secret %>\",\r\n    )]\r\n\r\n  # From actionpack/test/controller/new_base/render_template_test.rb:49-51\r\n  def with_locals_without_key\r\n    render \"locals\", locals: { secret: \"area51\" }\r\n  end\r\n\r\n  # Possible Fix\r\n  def with_locals_without_key_modified\r\n    render \"/locals\", locals: { secret: \"area51\" }\r\n  end\r\nend\r\n\r\nrequire \"minitest/autorun\"\r\n\r\nclass BugTest < Minitest::Test\r\n  include Rack::Test::Methods\r\n\r\n  def test_returns_server_error\r\n    get \"/original\"\r\n    assert last_response.server_error?\r\n  end\r\n\r\n  def test_returns_success\r\n    get \"/modified\"\r\n    assert last_response.ok?\r\n  end\r\n\r\n  private\r\n    def app\r\n      Rails.application\r\n    end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\nChanging \"rendering a template with local variables without key\" to use `with_locals_without_key` should work.\r\n\r\n```diff\r\ndiff --git a/actionpack/test/controller/new_base/render_template_test.rb b/actionpack/test/controller/new_base/render_template_test.rb\r\nindex 3d71184b5f..70833ae11c 100644\r\n--- a/actionpack/test/controller/new_base/render_template_test.rb\r\n+++ b/actionpack/test/controller/new_base/render_template_test.rb\r\n@@ -106,7 +106,7 @@ class TestWithoutLayout < Rack::TestCase\r\n     end\r\n \r\n     test \"rendering a template with local variables without key\" do\r\n-      get :with_locals\r\n+      get :with_locals_without_key\r\n       assert_response \"The secret is area51\"\r\n     end\r\n````\r\n\r\n### Actual behavior\r\n\r\nRaises an error:\r\n\r\n```\r\nMissing template ./locals with {:locale=>[:en], :formats=>[:html], :variants=>[], :handlers=>[:raw, :erb, :html, :builder, :ruby]}.\r\n\r\nSearched in:\r\n  * \"test/basic.html.erb, shared.html.erb, locals.html.erb, xml_template.xml.builder, with_raw.html.erb, with_implicit_raw.html.erb, with_implicit_raw.text.erb, test/with_json.html.erb, test/with_json.json.erb, test/final.json.erb, test/with_error.html.erb\"\r\n```\r\n\r\n### Possible Solution\r\nShown on the executable test: prepending a slash seems to work, but that (without locals) appears to be covered in\r\n\r\n* \"rendering a template not in a subdirectory\"\r\n* \"rendering a template not in a subdirectory with a leading slash without key\"\r\n\r\nAnd both work, not sure why is different here. \r\n\r\n**UPDATE**: I'm no longer convinced this is a solution, it should work without the leading slash as well. I'll look into it, see https://github.com/rails/rails/issues/46724#issuecomment-1355182948.\r\n\r\n\r\n```diff\r\ndiff --git a/actionpack/test/controller/new_base/render_template_test.rb b/actionpack/test/controller/new_base/render_template_test.rb\r\nindex 3d71184b5f..f211a45860 100644\r\n--- a/actionpack/test/controller/new_base/render_template_test.rb\r\n+++ b/actionpack/test/controller/new_base/render_template_test.rb\r\n@@ -47,7 +47,7 @@ def with_locals\r\n     end\r\n \r\n     def with_locals_without_key\r\n-      render \"locals\", locals: { secret: \"area51\" }\r\n+      render \"/locals\", locals: { secret: \"area51\" }\r\n     end\r\n \r\n     def builder_template\r\n@@ -106,7 +106,7 @@ class TestWithoutLayout < Rack::TestCase\r\n     end\r\n \r\n     test \"rendering a template with local variables without key\" do\r\n-      get :with_locals\r\n+      get :with_locals_without_key\r\n       assert_response \"The secret is area51\"\r\n     end\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.0.4\r\n\r\n**Ruby version**: 3.1.2\r\n","closed_by":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/46724/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/46724/timeline","performed_via_github_app":null,"state_reason":"completed"}