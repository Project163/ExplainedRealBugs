{"url":"https://api.github.com/repos/rails/rails/issues/49906","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/49906/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/49906/comments","events_url":"https://api.github.com/repos/rails/rails/issues/49906/events","html_url":"https://github.com/rails/rails/issues/49906","id":1976809171,"node_id":"I_kwDNIULOddO20w","number":49906,"title":"Race condition with parallel system tests: Text file busy - chromedriver","user":{"login":"mattbrictson","id":189693,"node_id":"MDQ6VXNlcjE4OTY5Mw==","avatar_url":"https://avatars.githubusercontent.com/u/189693?v=4","gravatar_id":"","url":"https://api.github.com/users/mattbrictson","html_url":"https://github.com/mattbrictson","followers_url":"https://api.github.com/users/mattbrictson/followers","following_url":"https://api.github.com/users/mattbrictson/following{/other_user}","gists_url":"https://api.github.com/users/mattbrictson/gists{/gist_id}","starred_url":"https://api.github.com/users/mattbrictson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattbrictson/subscriptions","organizations_url":"https://api.github.com/users/mattbrictson/orgs","repos_url":"https://api.github.com/users/mattbrictson/repos","events_url":"https://api.github.com/users/mattbrictson/events{/privacy}","received_events_url":"https://api.github.com/users/mattbrictson/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":107189,"node_id":"MDU6TGFiZWwxMDcxODk=","url":"https://api.github.com/repos/rails/rails/labels/actionpack","name":"actionpack","color":"FFF700","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2023-11-03T19:28:39Z","updated_at":"2023-11-07T17:41:14Z","closed_at":"2023-11-07T17:41:14Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"When running system tests in parallel using `parallelize(workers: :number_of_processors)`, there is a race condition due to the chromedriver executable to being downloaded simultaneously by multiple worker processes. The following error occurs:\r\n\r\n```\r\nText file busy - /home/circleci/.cache/selenium/chromedriver/linux64/116.0.5845.96/chromedriver\r\n```\r\n\r\nThis race condition was previously reported in #36288 and subsequently addressed in #36592. At the time, the fix was to \"preload\" the Selenium driver path by calling `driver_path.try(:call)`. That fix was specific to how the `webdrivers` gem worked. The `webdrivers` gem assigned a Proc to `driver_path`, which could then be lazily invoked.\r\n\r\nThat fix is no longer effective, because starting in Rails 7.1, Rails apps no longer ship with the `webdrivers` gem (see #48847). Instead, the `selenum-webdriver` gem itself now contains a \"Selenium Manager\" private internal implementation that installs drivers on demand. This new implementation is susceptible to a race condition when used with Rails parallel testing.\r\n\r\nIn short, the \"preload\" fix in #36592 works when the `webdrivers` gem is used, but a different solution is needed when `webdrivers` is not being used.\r\n\r\n### Steps to reproduce\r\n\r\n1. Use a Rails 7.1.1 app\r\n2. Ensure that `selenium-webdriver` is in the Gemfile\r\n3. Ensure that `webdrivers` is **not** in the Gemfile\r\n4. Configure `ApplicationSystemTestCase` with `driven_by :selenium, using: :chrome`\r\n5. Run a large suite of system tests in parallel. I am using `parallelize(workers: 16)` on a CircleCI Docker/Medium instance.\r\n\r\n(Apologies, I don't have a standalone script or repo that can be used to reproduce.)\r\n\r\n### Expected behavior\r\n\r\nTests should run without errors.\r\n\r\n### Actual behavior\r\n\r\nSporadic failures with the following error:\r\n\r\n```\r\nText file busy - /home/circleci/.cache/selenium/chromedriver/linux64/116.0.5845.96/chromedriver\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.1.1\r\n\r\n**Ruby version**: 3.2.2\r\n","closed_by":{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/49906/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/49906/timeline","performed_via_github_app":null,"state_reason":"completed"}