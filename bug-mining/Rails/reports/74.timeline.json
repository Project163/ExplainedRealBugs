[{"id":10824009313,"node_id":"LE_lADNIULOdXnljs8AAAAChSlGYQ","url":"https://api.github.com/repos/rails/rails/issues/events/10824009313","actor":{"login":"akhilgkrishnan","id":22231095,"node_id":"MDQ6VXNlcjIyMjMxMDk1","avatar_url":"https://avatars.githubusercontent.com/u/22231095?v=4","gravatar_id":"","url":"https://api.github.com/users/akhilgkrishnan","html_url":"https://github.com/akhilgkrishnan","followers_url":"https://api.github.com/users/akhilgkrishnan/followers","following_url":"https://api.github.com/users/akhilgkrishnan/following{/other_user}","gists_url":"https://api.github.com/users/akhilgkrishnan/gists{/gist_id}","starred_url":"https://api.github.com/users/akhilgkrishnan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/akhilgkrishnan/subscriptions","organizations_url":"https://api.github.com/users/akhilgkrishnan/orgs","repos_url":"https://api.github.com/users/akhilgkrishnan/repos","events_url":"https://api.github.com/users/akhilgkrishnan/events{/privacy}","received_events_url":"https://api.github.com/users/akhilgkrishnan/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2023-10-31T17:29:47Z","label":{"name":"activerecord","color":"0b02e1"},"performed_via_github_app":null},{"id":10824099370,"node_id":"LE_lADNIULOdXnljs8AAAAChSqmKg","url":"https://api.github.com/repos/rails/rails/issues/events/10824099370","actor":{"login":"akhilgkrishnan","id":22231095,"node_id":"MDQ6VXNlcjIyMjMxMDk1","avatar_url":"https://avatars.githubusercontent.com/u/22231095?v=4","gravatar_id":"","url":"https://api.github.com/users/akhilgkrishnan","html_url":"https://github.com/akhilgkrishnan","followers_url":"https://api.github.com/users/akhilgkrishnan/followers","following_url":"https://api.github.com/users/akhilgkrishnan/following{/other_user}","gists_url":"https://api.github.com/users/akhilgkrishnan/gists{/gist_id}","starred_url":"https://api.github.com/users/akhilgkrishnan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/akhilgkrishnan/subscriptions","organizations_url":"https://api.github.com/users/akhilgkrishnan/orgs","repos_url":"https://api.github.com/users/akhilgkrishnan/repos","events_url":"https://api.github.com/users/akhilgkrishnan/events{/privacy}","received_events_url":"https://api.github.com/users/akhilgkrishnan/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2023-10-31T17:37:35Z","label":{"name":"With reproduction steps","color":"009800"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/comments/1787716481","html_url":"https://github.com/rails/rails/issues/49871#issuecomment-1787716481","issue_url":"https://api.github.com/repos/rails/rails/issues/49871","id":1787716481,"node_id":"IC_kwDNIULOao5jgQ","user":{"login":"fatkodima","id":5657035,"node_id":"MDQ6VXNlcjU2NTcwMzU=","avatar_url":"https://avatars.githubusercontent.com/u/5657035?v=4","gravatar_id":"","url":"https://api.github.com/users/fatkodima","html_url":"https://github.com/fatkodima","followers_url":"https://api.github.com/users/fatkodima/followers","following_url":"https://api.github.com/users/fatkodima/following{/other_user}","gists_url":"https://api.github.com/users/fatkodima/gists{/gist_id}","starred_url":"https://api.github.com/users/fatkodima/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fatkodima/subscriptions","organizations_url":"https://api.github.com/users/fatkodima/orgs","repos_url":"https://api.github.com/users/fatkodima/repos","events_url":"https://api.github.com/users/fatkodima/events{/privacy}","received_events_url":"https://api.github.com/users/fatkodima/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-10-31T17:59:20Z","updated_at":"2023-10-31T17:59:20Z","body":"This is because of how `normalizes` is implemented. For a user record, we have a `@attributes` instance variable, where keys are attribute names, and values are types. For `normalizes`, we have a `NormalizedValueType`, which holds a proc as its instance variable https://github.com/rails/rails/blob/2745366a09ea3fcb4f3d4ebe458aa247ddc228f6/activerecord/lib/active_record/normalization.rb#L118\r\n\r\nThis type is used not only when storing records (so we can reimplement this type by some callback, for example), but also when we use the attribute in `.where`, so it is normalized too. Not sure how this problem can be solved.\r\n\r\ncc @jonathanhefner ","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/1787716481/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"fatkodima","id":5657035,"node_id":"MDQ6VXNlcjU2NTcwMzU=","avatar_url":"https://avatars.githubusercontent.com/u/5657035?v=4","gravatar_id":"","url":"https://api.github.com/users/fatkodima","html_url":"https://github.com/fatkodima","followers_url":"https://api.github.com/users/fatkodima/followers","following_url":"https://api.github.com/users/fatkodima/following{/other_user}","gists_url":"https://api.github.com/users/fatkodima/gists{/gist_id}","starred_url":"https://api.github.com/users/fatkodima/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fatkodima/subscriptions","organizations_url":"https://api.github.com/users/fatkodima/orgs","repos_url":"https://api.github.com/users/fatkodima/repos","events_url":"https://api.github.com/users/fatkodima/events{/privacy}","received_events_url":"https://api.github.com/users/fatkodima/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":10824374681,"node_id":"MEE_lADNIULOdXnljs8AAAAChS7ZmQ","url":"https://api.github.com/repos/rails/rails/issues/events/10824374681","actor":{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2023-10-31T17:59:20Z","performed_via_github_app":null},{"id":10824374701,"node_id":"SE_lADNIULOdXnljs8AAAAChS7ZrQ","url":"https://api.github.com/repos/rails/rails/issues/events/10824374701","actor":{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2023-10-31T17:59:20Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/comments/1787761678","html_url":"https://github.com/rails/rails/issues/49871#issuecomment-1787761678","issue_url":"https://api.github.com/repos/rails/rails/issues/49871","id":1787761678,"node_id":"IC_kwDNIULOao8UDg","user":{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-10-31T18:29:30Z","updated_at":"2023-10-31T18:29:30Z","body":"Adding `ActiveRecord.marshalling_format_version = 7.1` to the reproduction script fixes the error.\r\n\r\nI'm inclined to say that is an acceptable limitation.  It is already advisable to migrate to `marshalling_format_version = 7.1`, so I'm not really in favor of complicating the implementation of `NormalizedValueType` just to support the old `Marshal` format.\r\n","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/1787761678/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rails/rails/issues/comments/1787826790","html_url":"https://github.com/rails/rails/issues/49871#issuecomment-1787826790","issue_url":"https://api.github.com/repos/rails/rails/issues/49871","id":1787826790,"node_id":"IC_kwDNIULOapASZg","user":{"login":"mjankowski","id":225,"node_id":"MDQ6VXNlcjIyNQ==","avatar_url":"https://avatars.githubusercontent.com/u/225?v=4","gravatar_id":"","url":"https://api.github.com/users/mjankowski","html_url":"https://github.com/mjankowski","followers_url":"https://api.github.com/users/mjankowski/followers","following_url":"https://api.github.com/users/mjankowski/following{/other_user}","gists_url":"https://api.github.com/users/mjankowski/gists{/gist_id}","starred_url":"https://api.github.com/users/mjankowski/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mjankowski/subscriptions","organizations_url":"https://api.github.com/users/mjankowski/orgs","repos_url":"https://api.github.com/users/mjankowski/repos","events_url":"https://api.github.com/users/mjankowski/events{/privacy}","received_events_url":"https://api.github.com/users/mjankowski/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-10-31T18:58:07Z","updated_at":"2023-10-31T19:04:30Z","body":"> Adding `ActiveRecord.marshalling_format_version = 7.1` to the reproduction script fixes the error.\r\n\r\nConfirmed this locally, thanks for quick response both of you!\r\n\r\n> I'm inclined to say that is an acceptable limitation. It is already advisable to migrate to `marshalling_format_version = 7.1`, so I'm not really in favor of complicating the implementation of `NormalizedValueType` just to support the old `Marshal` format.\r\n\r\nI agree with this -- I didn't realize these two issues were linked; and I was doing the \"start using normalizes in some places\" portion of a rails upgrade before completing all the config update elements, including the marshalling format change.\r\n\r\nDo you think any of:\r\n\r\n- Add docs around this requirement to API docs?\r\n- Add a note in upgrading docs?\r\n- Add code which detects attempting to use normalizes without updating the marshall format version (and warns)?\r\n\r\n...would be useful to future people encountering this? Or is this issue conversation probably enough?\r\n\r\n","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/1787826790/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mjankowski","id":225,"node_id":"MDQ6VXNlcjIyNQ==","avatar_url":"https://avatars.githubusercontent.com/u/225?v=4","gravatar_id":"","url":"https://api.github.com/users/mjankowski","html_url":"https://github.com/mjankowski","followers_url":"https://api.github.com/users/mjankowski/followers","following_url":"https://api.github.com/users/mjankowski/following{/other_user}","gists_url":"https://api.github.com/users/mjankowski/gists{/gist_id}","starred_url":"https://api.github.com/users/mjankowski/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mjankowski/subscriptions","organizations_url":"https://api.github.com/users/mjankowski/orgs","repos_url":"https://api.github.com/users/mjankowski/repos","events_url":"https://api.github.com/users/mjankowski/events{/privacy}","received_events_url":"https://api.github.com/users/mjankowski/received_events","type":"User","user_view_type":"public","site_admin":false}},{"actor":{"login":"mjankowski","id":225,"node_id":"MDQ6VXNlcjIyNQ==","avatar_url":"https://avatars.githubusercontent.com/u/225?v=4","gravatar_id":"","url":"https://api.github.com/users/mjankowski","html_url":"https://github.com/mjankowski","followers_url":"https://api.github.com/users/mjankowski/followers","following_url":"https://api.github.com/users/mjankowski/following{/other_user}","gists_url":"https://api.github.com/users/mjankowski/gists{/gist_id}","starred_url":"https://api.github.com/users/mjankowski/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mjankowski/subscriptions","organizations_url":"https://api.github.com/users/mjankowski/orgs","repos_url":"https://api.github.com/users/mjankowski/repos","events_url":"https://api.github.com/users/mjankowski/events{/privacy}","received_events_url":"https://api.github.com/users/mjankowski/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-10-31T19:03:23Z","updated_at":"2023-10-31T19:03:23Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/mastodon/mastodon/issues/27602","repository_url":"https://api.github.com/repos/mastodon/mastodon","labels_url":"https://api.github.com/repos/mastodon/mastodon/issues/27602/labels{/name}","comments_url":"https://api.github.com/repos/mastodon/mastodon/issues/27602/comments","events_url":"https://api.github.com/repos/mastodon/mastodon/issues/27602/events","html_url":"https://github.com/mastodon/mastodon/pull/27602","id":1966626443,"node_id":"PR_kwDOAx2_w85eB9vP","number":27602,"title":"Use `normalizes` on `CustomFilter#context` value","user":{"login":"mjankowski","id":225,"node_id":"MDQ6VXNlcjIyNQ==","avatar_url":"https://avatars.githubusercontent.com/u/225?v=4","gravatar_id":"","url":"https://api.github.com/users/mjankowski","html_url":"https://github.com/mjankowski","followers_url":"https://api.github.com/users/mjankowski/followers","following_url":"https://api.github.com/users/mjankowski/following{/other_user}","gists_url":"https://api.github.com/users/mjankowski/gists{/gist_id}","starred_url":"https://api.github.com/users/mjankowski/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mjankowski/subscriptions","organizations_url":"https://api.github.com/users/mjankowski/orgs","repos_url":"https://api.github.com/users/mjankowski/repos","events_url":"https://api.github.com/users/mjankowski/events{/privacy}","received_events_url":"https://api.github.com/users/mjankowski/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":721908177,"node_id":"MDU6TGFiZWw3MjE5MDgxNzc=","url":"https://api.github.com/repos/mastodon/mastodon/labels/refactoring","name":"refactoring","color":"e544bd","default":false,"description":"Improving code quality"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2023-10-28T14:56:04Z","updated_at":"2024-03-13T12:38:43Z","closed_at":"2024-03-13T08:51:27Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":52281283,"node_id":"MDEwOlJlcG9zaXRvcnk1MjI4MTI4Mw==","name":"mastodon","full_name":"mastodon/mastodon","private":false,"owner":{"login":"mastodon","id":24979032,"node_id":"MDEyOk9yZ2FuaXphdGlvbjI0OTc5MDMy","avatar_url":"https://avatars.githubusercontent.com/u/24979032?v=4","gravatar_id":"","url":"https://api.github.com/users/mastodon","html_url":"https://github.com/mastodon","followers_url":"https://api.github.com/users/mastodon/followers","following_url":"https://api.github.com/users/mastodon/following{/other_user}","gists_url":"https://api.github.com/users/mastodon/gists{/gist_id}","starred_url":"https://api.github.com/users/mastodon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mastodon/subscriptions","organizations_url":"https://api.github.com/users/mastodon/orgs","repos_url":"https://api.github.com/users/mastodon/repos","events_url":"https://api.github.com/users/mastodon/events{/privacy}","received_events_url":"https://api.github.com/users/mastodon/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/mastodon/mastodon","description":"Your self-hosted, globally interconnected microblogging community","fork":false,"url":"https://api.github.com/repos/mastodon/mastodon","forks_url":"https://api.github.com/repos/mastodon/mastodon/forks","keys_url":"https://api.github.com/repos/mastodon/mastodon/keys{/key_id}","collaborators_url":"https://api.github.com/repos/mastodon/mastodon/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/mastodon/mastodon/teams","hooks_url":"https://api.github.com/repos/mastodon/mastodon/hooks","issue_events_url":"https://api.github.com/repos/mastodon/mastodon/issues/events{/number}","events_url":"https://api.github.com/repos/mastodon/mastodon/events","assignees_url":"https://api.github.com/repos/mastodon/mastodon/assignees{/user}","branches_url":"https://api.github.com/repos/mastodon/mastodon/branches{/branch}","tags_url":"https://api.github.com/repos/mastodon/mastodon/tags","blobs_url":"https://api.github.com/repos/mastodon/mastodon/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/mastodon/mastodon/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/mastodon/mastodon/git/refs{/sha}","trees_url":"https://api.github.com/repos/mastodon/mastodon/git/trees{/sha}","statuses_url":"https://api.github.com/repos/mastodon/mastodon/statuses/{sha}","languages_url":"https://api.github.com/repos/mastodon/mastodon/languages","stargazers_url":"https://api.github.com/repos/mastodon/mastodon/stargazers","contributors_url":"https://api.github.com/repos/mastodon/mastodon/contributors","subscribers_url":"https://api.github.com/repos/mastodon/mastodon/subscribers","subscription_url":"https://api.github.com/repos/mastodon/mastodon/subscription","commits_url":"https://api.github.com/repos/mastodon/mastodon/commits{/sha}","git_commits_url":"https://api.github.com/repos/mastodon/mastodon/git/commits{/sha}","comments_url":"https://api.github.com/repos/mastodon/mastodon/comments{/number}","issue_comment_url":"https://api.github.com/repos/mastodon/mastodon/issues/comments{/number}","contents_url":"https://api.github.com/repos/mastodon/mastodon/contents/{+path}","compare_url":"https://api.github.com/repos/mastodon/mastodon/compare/{base}...{head}","merges_url":"https://api.github.com/repos/mastodon/mastodon/merges","archive_url":"https://api.github.com/repos/mastodon/mastodon/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/mastodon/mastodon/downloads","issues_url":"https://api.github.com/repos/mastodon/mastodon/issues{/number}","pulls_url":"https://api.github.com/repos/mastodon/mastodon/pulls{/number}","milestones_url":"https://api.github.com/repos/mastodon/mastodon/milestones{/number}","notifications_url":"https://api.github.com/repos/mastodon/mastodon/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/mastodon/mastodon/labels{/name}","releases_url":"https://api.github.com/repos/mastodon/mastodon/releases{/id}","deployments_url":"https://api.github.com/repos/mastodon/mastodon/deployments","created_at":"2016-02-22T15:01:25Z","updated_at":"2025-11-10T01:55:57Z","pushed_at":"2025-11-10T04:28:10Z","git_url":"git://github.com/mastodon/mastodon.git","ssh_url":"git@github.com:mastodon/mastodon.git","clone_url":"https://github.com/mastodon/mastodon.git","svn_url":"https://github.com/mastodon/mastodon","homepage":"https://joinmastodon.org","size":328136,"stargazers_count":49215,"watchers_count":49215,"language":"Ruby","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":true,"forks_count":7341,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":4279,"license":{"key":"agpl-3.0","name":"GNU Affero General Public License v3.0","spdx_id":"AGPL-3.0","url":"https://api.github.com/licenses/agpl-3.0","node_id":"MDc6TGljZW5zZTE="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["activity-stream","activitypub","docker","fediverse","mastodon","microblog","social-network","social-web","webfinger"],"visibility":"public","forks":7341,"open_issues":4279,"watchers":49215,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/mastodon/mastodon/pulls/27602","html_url":"https://github.com/mastodon/mastodon/pull/27602","diff_url":"https://github.com/mastodon/mastodon/pull/27602.diff","patch_url":"https://github.com/mastodon/mastodon/pull/27602.patch","merged_at":"2024-03-13T08:51:27Z"},"body":"This was originally in https://github.com/mastodon/mastodon/pull/27521 but after the final Rails 7.1 rebase there were some errors that I couldn't figure out quickly so I removed it from that one.\r\n\r\nAdded some spec coverage here to be more confident and I think this change (adding normalization, refactor on existing validation) preserves the prior validations and data cleanup behaviour. Will watch CI to see if the prior issue is resolved.","reactions":{"url":"https://api.github.com/repos/mastodon/mastodon/issues/27602/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mastodon/mastodon/issues/27602/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"id":10826090777,"node_id":"REFE_lADNIULOdXnljs8AAAAChUkJGQ","url":"https://api.github.com/repos/rails/rails/issues/events/10826090777","actor":{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"c2323f42bb2e3ee1da65918b544e8992b500667f","commit_url":"https://api.github.com/repos/jonathanhefner/rails/commits/c2323f42bb2e3ee1da65918b544e8992b500667f","created_at":"2023-10-31T21:18:10Z","performed_via_github_app":null},{"id":10826118037,"node_id":"REFE_lADNIULOdXnljs8AAAAChUlzlQ","url":"https://api.github.com/repos/rails/rails/issues/events/10826118037","actor":{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"7faba032d01a8df147a0c90f09fdcd65e1d8bbb4","commit_url":"https://api.github.com/repos/jonathanhefner/rails/commits/7faba032d01a8df147a0c90f09fdcd65e1d8bbb4","created_at":"2023-10-31T21:22:01Z","performed_via_github_app":null},{"actor":{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-10-31T21:23:55Z","updated_at":"2023-10-31T21:23:55Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/rails/rails/issues/49876","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/49876/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/49876/comments","events_url":"https://api.github.com/repos/rails/rails/issues/49876/events","html_url":"https://github.com/rails/rails/pull/49876","id":1971323934,"node_id":"PR_kwDNIULOXkdgeQ","number":49876,"title":"Add caveat about `normalizes` / `Marshal` interaction [ci-skip]","user":{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2023-10-31T21:23:55Z","updated_at":"2023-11-01T01:48:31Z","closed_at":"2023-11-01T01:47:02Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":8514,"node_id":"MDEwOlJlcG9zaXRvcnk4NTE0","name":"rails","full_name":"rails/rails","private":false,"owner":{"login":"rails","id":4223,"node_id":"MDEyOk9yZ2FuaXphdGlvbjQyMjM=","avatar_url":"https://avatars.githubusercontent.com/u/4223?v=4","gravatar_id":"","url":"https://api.github.com/users/rails","html_url":"https://github.com/rails","followers_url":"https://api.github.com/users/rails/followers","following_url":"https://api.github.com/users/rails/following{/other_user}","gists_url":"https://api.github.com/users/rails/gists{/gist_id}","starred_url":"https://api.github.com/users/rails/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rails/subscriptions","organizations_url":"https://api.github.com/users/rails/orgs","repos_url":"https://api.github.com/users/rails/repos","events_url":"https://api.github.com/users/rails/events{/privacy}","received_events_url":"https://api.github.com/users/rails/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/rails/rails","description":"Ruby on Rails","fork":false,"url":"https://api.github.com/repos/rails/rails","forks_url":"https://api.github.com/repos/rails/rails/forks","keys_url":"https://api.github.com/repos/rails/rails/keys{/key_id}","collaborators_url":"https://api.github.com/repos/rails/rails/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/rails/rails/teams","hooks_url":"https://api.github.com/repos/rails/rails/hooks","issue_events_url":"https://api.github.com/repos/rails/rails/issues/events{/number}","events_url":"https://api.github.com/repos/rails/rails/events","assignees_url":"https://api.github.com/repos/rails/rails/assignees{/user}","branches_url":"https://api.github.com/repos/rails/rails/branches{/branch}","tags_url":"https://api.github.com/repos/rails/rails/tags","blobs_url":"https://api.github.com/repos/rails/rails/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/rails/rails/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/rails/rails/git/refs{/sha}","trees_url":"https://api.github.com/repos/rails/rails/git/trees{/sha}","statuses_url":"https://api.github.com/repos/rails/rails/statuses/{sha}","languages_url":"https://api.github.com/repos/rails/rails/languages","stargazers_url":"https://api.github.com/repos/rails/rails/stargazers","contributors_url":"https://api.github.com/repos/rails/rails/contributors","subscribers_url":"https://api.github.com/repos/rails/rails/subscribers","subscription_url":"https://api.github.com/repos/rails/rails/subscription","commits_url":"https://api.github.com/repos/rails/rails/commits{/sha}","git_commits_url":"https://api.github.com/repos/rails/rails/git/commits{/sha}","comments_url":"https://api.github.com/repos/rails/rails/comments{/number}","issue_comment_url":"https://api.github.com/repos/rails/rails/issues/comments{/number}","contents_url":"https://api.github.com/repos/rails/rails/contents/{+path}","compare_url":"https://api.github.com/repos/rails/rails/compare/{base}...{head}","merges_url":"https://api.github.com/repos/rails/rails/merges","archive_url":"https://api.github.com/repos/rails/rails/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/rails/rails/downloads","issues_url":"https://api.github.com/repos/rails/rails/issues{/number}","pulls_url":"https://api.github.com/repos/rails/rails/pulls{/number}","milestones_url":"https://api.github.com/repos/rails/rails/milestones{/number}","notifications_url":"https://api.github.com/repos/rails/rails/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/rails/rails/labels{/name}","releases_url":"https://api.github.com/repos/rails/rails/releases{/id}","deployments_url":"https://api.github.com/repos/rails/rails/deployments","created_at":"2008-04-11T02:19:47Z","updated_at":"2025-11-10T02:03:47Z","pushed_at":"2025-11-10T00:33:52Z","git_url":"git://github.com/rails/rails.git","ssh_url":"git@github.com:rails/rails.git","clone_url":"https://github.com/rails/rails.git","svn_url":"https://github.com/rails/rails","homepage":"https://rubyonrails.org","size":271619,"stargazers_count":57840,"watchers_count":57840,"language":"Ruby","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":true,"forks_count":22025,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":1341,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["activejob","activerecord","framework","html","mvc","rails","ruby"],"visibility":"public","forks":22025,"open_issues":1341,"watchers":57840,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/rails/rails/pulls/49876","html_url":"https://github.com/rails/rails/pull/49876","diff_url":"https://github.com/rails/rails/pull/49876.diff","patch_url":"https://github.com/rails/rails/pull/49876.patch","merged_at":"2023-11-01T01:47:02Z"},"body":"When `ActiveRecord.marshalling_format_version` is set to `6.1`, `Marshal` will try to serialize attribute types along with the model, causing a `TypeError` if the model uses `ActiveRecord::Base.normalizes` with a normalization `Proc`.\r\n\r\nThis commit adds a caveat to the `normalizes` API documentation to warn users that they should set `marshalling_format_version` to `7.1` if they are using `normalizes` and marshalling the targeted model.\r\n\r\nFixes #49871.\r\n\r\n---\r\n\r\n@mjankowski Do you feel like this would have prevented the issue you encountered?\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/49876/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/49876/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"url":"https://api.github.com/repos/rails/rails/issues/comments/1788058151","html_url":"https://github.com/rails/rails/issues/49871#issuecomment-1788058151","issue_url":"https://api.github.com/repos/rails/rails/issues/49871","id":1788058151,"node_id":"IC_kwDNIULOapOaJw","user":{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-10-31T21:24:28Z","updated_at":"2023-10-31T21:24:28Z","body":"> Do you think any of:\r\n>\r\n>     * Add docs around this requirement to API docs?\r\n>\r\n>     * Add a note in upgrading docs?\r\n>\r\n>     * Add code which detects attempting to use normalizes without updating the marshall format version (and warns)?\r\n>\r\n>\r\n> ...would be useful to future people encountering this? Or is this issue conversation probably enough?\r\n\r\nI'm not sure that code emitting warning would be feasible because an app may not actually be marshalling models (e.g. not using caching, or using the `:message_pack` serializer instead).  We could try to catch the `TypeError`, determine if it's due to `normalizes`, and then raise a better error; but that seems complicated for very little gain.\r\n\r\nThere doesn't seem to be a good spot in the upgrading docs for such a note, so I will add one to the `normalizes` API docs: #49876.  It's not ideal, but we want to eventually remove the old Marshal format (and that caveat with it).\r\n","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/1788058151/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":10827462179,"node_id":"CE_lADNIULOdXnljs8AAAAChV32Iw","url":"https://api.github.com/repos/rails/rails/issues/events/10827462179","actor":{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2023-11-01T01:47:04Z","state_reason":null,"performed_via_github_app":null},{"id":16620116685,"node_id":"REFE_lADNIULOdXnljs8AAAAD3qLazQ","url":"https://api.github.com/repos/rails/rails/issues/events/16620116685","actor":{"login":"yoones","id":1333898,"node_id":"MDQ6VXNlcjEzMzM4OTg=","avatar_url":"https://avatars.githubusercontent.com/u/1333898?v=4","gravatar_id":"","url":"https://api.github.com/users/yoones","html_url":"https://github.com/yoones","followers_url":"https://api.github.com/users/yoones/followers","following_url":"https://api.github.com/users/yoones/following{/other_user}","gists_url":"https://api.github.com/users/yoones/gists{/gist_id}","starred_url":"https://api.github.com/users/yoones/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yoones/subscriptions","organizations_url":"https://api.github.com/users/yoones/orgs","repos_url":"https://api.github.com/users/yoones/repos","events_url":"https://api.github.com/users/yoones/events{/privacy}","received_events_url":"https://api.github.com/users/yoones/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"9e787320cb01a1e7a3bd0edf23e49f0f5247be61","commit_url":"https://api.github.com/repos/yoones/rails/commits/9e787320cb01a1e7a3bd0edf23e49f0f5247be61","created_at":"2025-03-06T16:29:19Z","performed_via_github_app":null}]