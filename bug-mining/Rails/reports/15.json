{"url":"https://api.github.com/repos/rails/rails/issues/46779","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/46779/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/46779/comments","events_url":"https://api.github.com/repos/rails/rails/issues/46779/events","html_url":"https://github.com/rails/rails/issues/46779","id":1503901257,"node_id":"I_kwDNIULOWaO2SQ","number":46779,"title":"Deprecation error when calling `sum` on objects that can be summed","user":{"login":"ghiculescu","id":509837,"node_id":"MDQ6VXNlcjUwOTgzNw==","avatar_url":"https://avatars.githubusercontent.com/u/509837?v=4","gravatar_id":"","url":"https://api.github.com/users/ghiculescu","html_url":"https://github.com/ghiculescu","followers_url":"https://api.github.com/users/ghiculescu/followers","following_url":"https://api.github.com/users/ghiculescu/following{/other_user}","gists_url":"https://api.github.com/users/ghiculescu/gists{/gist_id}","starred_url":"https://api.github.com/users/ghiculescu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ghiculescu/subscriptions","organizations_url":"https://api.github.com/users/ghiculescu/orgs","repos_url":"https://api.github.com/users/ghiculescu/repos","events_url":"https://api.github.com/users/ghiculescu/events{/privacy}","received_events_url":"https://api.github.com/users/ghiculescu/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2022-12-20T02:43:18Z","updated_at":"2023-01-17T20:51:26Z","closed_at":"2023-01-17T20:51:26Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Steps to reproduce\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\nend\r\n\r\nrequire \"active_support\"\r\nrequire \"active_support/all\"\r\nrequire \"minitest/autorun\"\r\n\r\nclass Money\r\n  attr_reader :value\r\n\r\n  def initialize(value)\r\n    @value = value\r\n  end\r\n\r\n  def +(other)\r\n    Money.new(value + other.value)\r\n  end\r\n\r\n def coerce(other)\r\n   [Money.new(other), self]\r\n end\r\n\r\n  def ==(other)\r\n    other.value == value\r\n  end\r\nend\r\n\r\nclass BugTest < ActiveSupport::TestCase\r\n  def test_stuff\r\n    assert_equal Money.new(3), [Money.new(1), Money.new(2)].sum\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\nDeprecation warning:\r\n\r\n```\r\nDEPRECATION WARNING: Rails 7.0 has deprecated Enumerable.sum in favor of Ruby's native implementation available since 2.4. Sum of non-numeric elements requires an initial argument. (called from test_stuff)\r\n```\r\n\r\n### Actual behavior\r\n\r\nNo warning.\r\n\r\nI don't expect a warning, because the relevant code works outside a Rails context fine. Because the Money class (which is based on [this gem](https://github.com/Shopify/money)) has a `coerce` method it is already able to handle being added to other numerics, and so the native implementation works correctly even without an initial argument.\r\n\r\nHere is proof the code works with no Rails, and no warnings:\r\n\r\n<details>\r\n<summary>Rails-free executable test case</summary>\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"minitest\"\r\nend\r\n\r\nrequire \"minitest/autorun\"\r\n\r\nclass Money\r\n  attr_reader :value\r\n\r\n  def initialize(value)\r\n    @value = value\r\n  end\r\n\r\n  def +(other)\r\n    Money.new(value + other.value)\r\n  end\r\n\r\n def coerce(other)\r\n   [Money.new(other), self]\r\n end\r\n\r\n  def ==(other)\r\n    other.value == value\r\n  end\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_stuff\r\n    assert_equal Money.new(3), [Money.new(1), Money.new(2)].sum # deprecation warning here\r\n  end\r\nend\r\n```\r\n\r\n</details>\r\n\r\nThe discussion in https://github.com/rails/rails/pull/41669 also discussed Money objects.\r\n\r\nI am not sure exactly which code paths will get removed in 7.1 as a result of https://github.com/rails/rails/pull/42080 - it's possible this will get fixed as part of the deprecated code being removed.\r\n\r\nSo I guess the question is, is it worth trying to fix the logic for the deprecation warning between now and 7.1?\r\n\r\n\r\n### System configuration\r\n**Rails version**: `main`\r\n\r\n**Ruby version**: 3.1.3\r\n","closed_by":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/46779/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/46779/timeline","performed_via_github_app":null,"state_reason":"completed"}