{"url":"https://api.github.com/repos/rails/rails/issues/52227","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/52227/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/52227/comments","events_url":"https://api.github.com/repos/rails/rails/issues/52227/events","html_url":"https://github.com/rails/rails/issues/52227","id":2378084863,"node_id":"I_kwDNIULOjb6x_w","number":52227,"title":"ActionView: Rendering a template with strict locals should not rewrite ArgumentErrors","user":{"login":"nhasselmeyer","id":62055282,"node_id":"MDQ6VXNlcjYyMDU1Mjgy","avatar_url":"https://avatars.githubusercontent.com/u/62055282?v=4","gravatar_id":"","url":"https://api.github.com/users/nhasselmeyer","html_url":"https://github.com/nhasselmeyer","followers_url":"https://api.github.com/users/nhasselmeyer/followers","following_url":"https://api.github.com/users/nhasselmeyer/following{/other_user}","gists_url":"https://api.github.com/users/nhasselmeyer/gists{/gist_id}","starred_url":"https://api.github.com/users/nhasselmeyer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nhasselmeyer/subscriptions","organizations_url":"https://api.github.com/users/nhasselmeyer/orgs","repos_url":"https://api.github.com/users/nhasselmeyer/repos","events_url":"https://api.github.com/users/nhasselmeyer/events{/privacy}","received_events_url":"https://api.github.com/users/nhasselmeyer/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":3666649,"node_id":"MDU6TGFiZWwzNjY2NjQ5","url":"https://api.github.com/repos/rails/rails/labels/actionview","name":"actionview","color":"d7e102","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2024-06-27T12:55:44Z","updated_at":"2025-01-06T20:25:14Z","closed_at":"2025-01-06T20:25:14Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Steps to reproduce\r\nRaise an ArgumentError in a template that is rendered with strict locals.\r\n\r\nReproduction script:\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n  gem \"rails\"\r\nend\r\n\r\nrequire \"minitest/autorun\"\r\nrequire \"action_view\"\r\n\r\nclass StrictLocalsArgumentErrorTest < ActionView::TestCase\r\n  helper do\r\n    def helper_with_arg(arg)\r\n    end\r\n  end\r\n\r\n  # red\r\n  def test_actionview_does_not_touch_argument_errors_with_strict_locals\r\n    err = assert_raises do\r\n      render inline: <<~ERB\r\n        <% # locals: () %>\r\n        <%= helper_with_arg %>\r\n      ERB\r\n    end\r\n\r\n    assert_match /in `helper_with_arg'/, err.backtrace.first\r\n    # or something similar, I'm not sure what the best assertion would be\r\n  end\r\n\r\n  # green\r\n  def test_actionview_does_not_touch_argument_errors_without_strict_locals\r\n    err = assert_raises do\r\n      render inline: <<~ERB\r\n        <%= helper_with_arg %>\r\n      ERB\r\n    end\r\n\r\n    assert_match /in `helper_with_arg'/, err.backtrace.first\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nRendering the template should raise an `ArgumentError` that points to the code that raised the exception (the `helper_with_arg` method and the template that incorrectly called it), e.g.\r\n```\r\ntest.rb:17:in `helper_with_arg'\r\ninline template:2:in `_inline_template__2760670737058980199_3460'\r\n...\r\n```\r\n\r\n\r\n### Actual behavior\r\nRendering the template with strict locals raises an `ArgumentError` with the the following backtrace:\r\n```\r\n/path/to/actionview-7.1.3.4/lib/action_view/base.rb:254:in `rescue in _run'\r\n/path/to/actionview-7.1.3.4/lib/action_view/base.rb:251:in `_run'\r\n/path/to/actionview-7.1.3.4/lib/action_view/template.rb:261:in `block in render'\r\n...\r\n```\r\n\r\nIf the helper method was instead defined as `def helper_with_kwarg(kwarg:)`, the error message says `missing local: :kwarg` instead.\r\n\r\n### System configuration\r\n**Rails version**: 7.1.3.4\r\n\r\n**Ruby version**: 3.1.2\r\n\r\n\r\n---\r\nActionView should not touch this exception, because the current behaviour makes templates with strict locals a lot harder to debug.\r\n\r\nI think the best behaviour here would be:\r\n- check the exception's backtrace (something like ``argument_error.backtrace.first.match? /in `#{method}'$/``) and reraise the exception if it doesn't match\r\n- or, if that becomes to complicated, don't modify the exception at all? I'd rather see correct backtraces and messages for errors raised within a template than getting slightly prettier exceptions for when I forget to pass a local.","closed_by":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/52227/reactions","total_count":5,"+1":5,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/52227/timeline","performed_via_github_app":null,"state_reason":"completed"}