{"url":"https://api.github.com/repos/rails/rails/issues/52098","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/52098/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/52098/comments","events_url":"https://api.github.com/repos/rails/rails/issues/52098/events","html_url":"https://github.com/rails/rails/issues/52098","id":2347672856,"node_id":"I_kwDNIULOi-6lGA","number":52098,"title":"new_framework_defaults initializer for Rails 7.1 not setting ActiveRecord.run_after_transaction_callbacks_in_order_defined","user":{"login":"jdlubrano","id":4729920,"node_id":"MDQ6VXNlcjQ3Mjk5MjA=","avatar_url":"https://avatars.githubusercontent.com/u/4729920?v=4","gravatar_id":"","url":"https://api.github.com/users/jdlubrano","html_url":"https://github.com/jdlubrano","followers_url":"https://api.github.com/users/jdlubrano/followers","following_url":"https://api.github.com/users/jdlubrano/following{/other_user}","gists_url":"https://api.github.com/users/jdlubrano/gists{/gist_id}","starred_url":"https://api.github.com/users/jdlubrano/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jdlubrano/subscriptions","organizations_url":"https://api.github.com/users/jdlubrano/orgs","repos_url":"https://api.github.com/users/jdlubrano/repos","events_url":"https://api.github.com/users/jdlubrano/events{/privacy}","received_events_url":"https://api.github.com/users/jdlubrano/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2024-06-12T02:38:12Z","updated_at":"2025-01-23T15:53:48Z","closed_at":"2024-06-12T19:44:36Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Steps to reproduce\r\n\r\nI was upgrading a Rails application from Rails 7 to 7.1 and ran into unexpected behavior involving the `ActiveRecord.run_after_transaction_callbacks_in_order_defined` config option.  In `config/initializers/new_framework_defaults_7_1.rb`, I had uncommented the setting such that:\r\n\r\n```ruby\r\nRails.application.config.active_record.run_after_transaction_callbacks_in_order_defined = true\r\n```\r\n\r\nI was not, however, seeing `after_commit` callbacks run in the order in which they were defined.  I saw them continuing to run in the reverse order in which they were defined.\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  gem \"debug\"\r\n  gem \"rails\", \">= 7.1\"\r\n  gem \"sqlite3\", \"~> 1.4\"\r\nend\r\n\r\nrequire \"rails/all\"\r\nrequire \"minitest/autorun\"\r\n\r\ndebugger\r\nputs \"Rails version: #{Rails::VERSION}\"\r\n\r\ndatabase = \":memory:\"\r\nENV['DATABASE_URL'] = \"sqlite3:#{database}\"\r\nActiveRecord::Base.establish_connection(adapter: 'sqlite3', database: database)\r\n\r\nclass App < Rails::Application\r\n  config.eager_load = false\r\n  config.load_defaults 7.0\r\nend\r\n\r\n# config/initializers/new_framework_defaults_7_1.rb\r\nRails.application.initializer \"demo.new_framework_defaults\" do\r\n  Rails.application.config.active_record.run_after_transaction_callbacks_in_order_defined = true\r\nend\r\n\r\nApp.initialize!\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_callbacks_in_order_defined\r\n    assert ActiveRecord.run_after_transaction_callbacks_in_order_defined\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\n`ActiveRecord.run_after_transaction_callbacks_in_order_defined` should be set to `true` and callbacks should run in the order in which they are defined.\r\n\r\n### Actual behavior\r\n\r\n`ActiveRecord.run_after_transaction_callbacks_in_order_defined` is not set to `true` and after transactional callbacks continue to run in the reverse order of how they are defined.\r\n\r\n### System configuration\r\n**Rails version**: 7.1.3.4\r\n\r\n**Ruby version**: 3.3.0\r\n\r\n### Investigation Notes\r\n\r\nI did a little digging into the Rails source.  I noticed that in [`activerecord/lib/active_record/railtie.rb`](https://github.com/rails/rails/blob/2ebb508cd8ee16c0bb280f91b93c01d939fcbf12/activerecord/lib/active_record/railtie.rb#L230-L276), the local variable `configs` is being shadowed and set to a new `Hash` [here](https://github.com/rails/rails/blob/2ebb508cd8ee16c0bb280f91b93c01d939fcbf12/activerecord/lib/active_record/railtie.rb#L245-L260).  That new Hash is then referenced and reused again in the [`after_initialize` hook here](https://github.com/rails/rails/blob/2ebb508cd8ee16c0bb280f91b93c01d939fcbf12/activerecord/lib/active_record/railtie.rb#L233-L241).  I found that a little surprising and wondered if that local variable being \"reset\" to a Hash was intentional ðŸ¤·â€â™‚ï¸ .  I was surprised that the two hooks within the \"active_record.set_configs\" would depend on one another _and_ that the first block (as written) would depend on the second block running first to set `configs` to a specific value.\r\n","closed_by":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/52098/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/52098/timeline","performed_via_github_app":null,"state_reason":"completed"}