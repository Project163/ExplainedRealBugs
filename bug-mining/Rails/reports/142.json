{"url":"https://api.github.com/repos/rails/rails/issues/52742","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/52742/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/52742/comments","events_url":"https://api.github.com/repos/rails/rails/issues/52742/events","html_url":"https://github.com/rails/rails/issues/52742","id":2493817120,"node_id":"I_kwDNIULOlKShIA","number":52742,"title":"Inconsistent type handling for `real` columns in PostgreSQL schema dumps and loads","user":{"login":"krororo","id":3143443,"node_id":"MDQ6VXNlcjMxNDM0NDM=","avatar_url":"https://avatars.githubusercontent.com/u/3143443?v=4","gravatar_id":"","url":"https://api.github.com/users/krororo","html_url":"https://github.com/krororo","followers_url":"https://api.github.com/users/krororo/followers","following_url":"https://api.github.com/users/krororo/following{/other_user}","gists_url":"https://api.github.com/users/krororo/gists{/gist_id}","starred_url":"https://api.github.com/users/krororo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/krororo/subscriptions","organizations_url":"https://api.github.com/users/krororo/orgs","repos_url":"https://api.github.com/users/krororo/repos","events_url":"https://api.github.com/users/krororo/events{/privacy}","received_events_url":"https://api.github.com/users/krororo/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":70310659,"node_id":"MDU6TGFiZWw3MDMxMDY1OQ==","url":"https://api.github.com/repos/rails/rails/labels/PostgreSQL","name":"PostgreSQL","color":"fbca04","default":false,"description":null},{"id":126910270,"node_id":"MDU6TGFiZWwxMjY5MTAyNzA=","url":"https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps","name":"With reproduction steps","color":"009800","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2024-08-29T08:43:01Z","updated_at":"2024-09-30T07:28:45Z","closed_at":"2024-09-30T07:28:45Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\nWhen dumping a PostgreSQL schema that includes a `real` column (defined as `float(24)`), the column is represented as `float` in the generated schema dump. However, when loading this schema, the `real` column is converted to `double precision`.\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  gem \"rails\", \"7.1.4\"\r\n  gem \"pg\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\ndbconfig = {\r\n  adapter: \"postgresql\",\r\n  username: \"postgres\",\r\n  password: \"postgres\",\r\n  host: \"localhost\",\r\n  database: \"migration_test\"\r\n}\r\nActiveRecord::Base.establish_connection(dbconfig.merge(database: \"postgres\"))\r\nActiveRecord::Base.connection.drop_database(\"migration_test\")\r\nActiveRecord::Base.connection.create_database(\"migration_test\")\r\nActiveRecord::Base.establish_connection(dbconfig)\r\n\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nclass CreatePaymentWithFloatColumn < ActiveRecord::Migration::Current\r\n  def change\r\n    create_table :payments do |t|\r\n      t.float :amount, limit: 24\r\n    end\r\n  end\r\nend\r\n\r\nclass Payment < ActiveRecord::Base\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_migration_up\r\n    CreatePaymentWithFloatColumn.migrate(:up)\r\n    Payment.reset_column_information\r\n\r\n    assert_equal \"real\", Payment.columns_hash[\"amount\"].sql_type\r\n\r\n    io = StringIO.new\r\n    ActiveRecord::SchemaDumper.dump(ActiveRecord::Base.connection, io)\r\n    assert_includes('t.float \"amount\", limit: 24', io.string)\r\n  end\r\nend\r\n```\r\n\r\nresult:\r\n```\r\nRun options: --seed 55169\r\n\r\n# Running:\r\n\r\n==  CreatePaymentWithFloatColumn: migrating ===================================\r\n-- create_table(:payments)\r\nD, [2024-08-29T17:34:22.146929 #38268] DEBUG -- :    (2.8ms)  CREATE TABLE \"payments\" (\"id\" bigserial primary key, \"amount\" float(24))\r\n   -> 0.0187s\r\n==  CreatePaymentWithFloatColumn: migrated (0.0187s) ==========================\r\n\r\nF\r\n\r\nFinished in 0.036045s, 27.7431 runs/s, 83.2293 assertions/s.\r\n\r\n  1) Failure:\r\nBugTest#test_migration_up [migration_test.rb:50]:\r\nExpected \"t.float \\\"amount\\\", limit: 24\" to include \"# This file is auto-generated from the current state of the database. Instead\\n# of editing this file, please use the migrations feature of Active Record to\\n# incrementally modify your database, and then regenerate this schema definition.\\n#\\n# This file is the source Rails uses to define your schema when running `bin/rails\\n# db:schema:load`. When creating a new database, `bin/rails db:schema:load` tends to\\n# be faster and is potentially less error prone than running all of your\\n# migrations from scratch. Old migrations may fail to apply correctly if those\\n# migrations use external dependencies or application code.\\n#\\n# It's strongly recommended that you check this file into your version control system.\\n\\nActiveRecord::Schema[7.2].define(version: 0) do\\n  # These are extensions that must be enabled in order to support this database\\n  enable_extension \\\"plpgsql\\\"\\n\\n  create_table \\\"payments\\\", force: :cascade do |t|\\n    t.float \\\"amount\\\"\\n  end\\nend\\n\".\r\n\r\n1 runs, 3 assertions, 1 failures, 0 errors, 0 skips\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\nA `real` column defined in a PostgreSQL schema should be preserved as a `real` column when dumped and loaded. \r\n\r\nsee: https://www.postgresql.org/docs/14/datatype-numeric.html#DATATYPE-FLOAT\r\n> PostgreSQL also supports the SQL-standard notations float and float(p) for specifying inexact numeric types. Here, p specifies the minimum acceptable precision in binary digits. PostgreSQL accepts float(1) to float(24) as selecting the real type, while float(25) to float(53) select double precision. Values of p outside the allowed range draw an error. float with no precision specified is taken to mean double precision.\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\nThe current behavior results in a conversion from `real` to `double precision` during the dump and load process.\r\n\r\n### System configuration\r\n**Rails version**: 7.1.4\r\n\r\n**Ruby version**: 3.3.4\r\n\r\n**PostgreSQL version**: 14.7\r\n","closed_by":{"login":"kamipo","id":12642,"node_id":"MDQ6VXNlcjEyNjQy","avatar_url":"https://avatars.githubusercontent.com/u/12642?v=4","gravatar_id":"","url":"https://api.github.com/users/kamipo","html_url":"https://github.com/kamipo","followers_url":"https://api.github.com/users/kamipo/followers","following_url":"https://api.github.com/users/kamipo/following{/other_user}","gists_url":"https://api.github.com/users/kamipo/gists{/gist_id}","starred_url":"https://api.github.com/users/kamipo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kamipo/subscriptions","organizations_url":"https://api.github.com/users/kamipo/orgs","repos_url":"https://api.github.com/users/kamipo/repos","events_url":"https://api.github.com/users/kamipo/events{/privacy}","received_events_url":"https://api.github.com/users/kamipo/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/52742/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/52742/timeline","performed_via_github_app":null,"state_reason":"completed"}