{"url":"https://api.github.com/repos/rails/rails/issues/47400","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/47400/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/47400/comments","events_url":"https://api.github.com/repos/rails/rails/issues/47400/events","html_url":"https://github.com/rails/rails/issues/47400","id":1585963263,"node_id":"I_kwDNIULOXofg_w","number":47400,"title":"SQLite3Adapter: `autoincrement` declaration lost on execution of `#alter_table`","user":{"login":"andsip","id":1520552,"node_id":"MDQ6VXNlcjE1MjA1NTI=","avatar_url":"https://avatars.githubusercontent.com/u/1520552?v=4","gravatar_id":"","url":"https://api.github.com/users/andsip","html_url":"https://github.com/andsip","followers_url":"https://api.github.com/users/andsip/followers","following_url":"https://api.github.com/users/andsip/following{/other_user}","gists_url":"https://api.github.com/users/andsip/gists{/gist_id}","starred_url":"https://api.github.com/users/andsip/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andsip/subscriptions","organizations_url":"https://api.github.com/users/andsip/orgs","repos_url":"https://api.github.com/users/andsip/repos","events_url":"https://api.github.com/users/andsip/events{/privacy}","received_events_url":"https://api.github.com/users/andsip/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"adrianna-chang-shopify","id":22918438,"node_id":"MDQ6VXNlcjIyOTE4NDM4","avatar_url":"https://avatars.githubusercontent.com/u/22918438?v=4","gravatar_id":"","url":"https://api.github.com/users/adrianna-chang-shopify","html_url":"https://github.com/adrianna-chang-shopify","followers_url":"https://api.github.com/users/adrianna-chang-shopify/followers","following_url":"https://api.github.com/users/adrianna-chang-shopify/following{/other_user}","gists_url":"https://api.github.com/users/adrianna-chang-shopify/gists{/gist_id}","starred_url":"https://api.github.com/users/adrianna-chang-shopify/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adrianna-chang-shopify/subscriptions","organizations_url":"https://api.github.com/users/adrianna-chang-shopify/orgs","repos_url":"https://api.github.com/users/adrianna-chang-shopify/repos","events_url":"https://api.github.com/users/adrianna-chang-shopify/events{/privacy}","received_events_url":"https://api.github.com/users/adrianna-chang-shopify/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"adrianna-chang-shopify","id":22918438,"node_id":"MDQ6VXNlcjIyOTE4NDM4","avatar_url":"https://avatars.githubusercontent.com/u/22918438?v=4","gravatar_id":"","url":"https://api.github.com/users/adrianna-chang-shopify","html_url":"https://github.com/adrianna-chang-shopify","followers_url":"https://api.github.com/users/adrianna-chang-shopify/followers","following_url":"https://api.github.com/users/adrianna-chang-shopify/following{/other_user}","gists_url":"https://api.github.com/users/adrianna-chang-shopify/gists{/gist_id}","starred_url":"https://api.github.com/users/adrianna-chang-shopify/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adrianna-chang-shopify/subscriptions","organizations_url":"https://api.github.com/users/adrianna-chang-shopify/orgs","repos_url":"https://api.github.com/users/adrianna-chang-shopify/repos","events_url":"https://api.github.com/users/adrianna-chang-shopify/events{/privacy}","received_events_url":"https://api.github.com/users/adrianna-chang-shopify/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":3,"created_at":"2023-02-15T14:31:39Z","updated_at":"2023-02-27T16:11:09Z","closed_at":"2023-02-27T16:11:09Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Steps to reproduce\r\n\r\n- create a table with a `autoincrement` primary key (Rails default behavior for `id` columns)\r\n- run a migration that uses one of the `#change_column` methods (which use `#alter_table` internally)\r\n- `autoincrement` declaration on table is lost (happens during re-creation of table in `#alter_table` method)\r\n\r\nThis has been reported in #37722 already, and @peterkovacs points towards a solution there.\r\n\r\n---\r\n\r\nThe script below allows to reproduce the problem.\r\n\r\n3 out of the 4 `assert is_autoincrement_id?(\"payments\")` assertions fail right now.\r\nThe one not failing is always the first one that is executed, which depends on the execution order of the tests.\r\nThe reason that the first assertion does not fail is that no `#change_column` call has been executed at that point.\r\n\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :payments, force: true do |t|\r\n    t.decimal :amount, precision: 10, scale: 0, default: 0, null: false\r\n  end\r\nend\r\n\r\nclass Payment < ActiveRecord::Base\r\nend\r\n\r\nclass ChangeAmountToAddScale < ActiveRecord::Migration[7.1]\r\n  def change\r\n    reversible do |dir|\r\n      dir.up do\r\n        change_column :payments, :amount, :decimal, precision: 10, scale: 2, default: 0, null: false\r\n      end\r\n\r\n      dir.down do\r\n        change_column :payments, :amount, :decimal, precision: 10, scale: 0, default: 0, null: false\r\n      end\r\n    end\r\n  end\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_migration_up\r\n    assert is_autoincrement_id?(\"payments\")\r\n\r\n    ChangeAmountToAddScale.migrate(:up)\r\n    Payment.reset_column_information\r\n\r\n    assert is_autoincrement_id?(\"payments\")\r\n  end\r\n\r\n  def test_migration_down\r\n    assert is_autoincrement_id?(\"payments\")\r\n\r\n    ChangeAmountToAddScale.migrate(:down)\r\n    Payment.reset_column_information\r\n\r\n    assert is_autoincrement_id?(\"payments\")\r\n  end\r\n\r\n  private\r\n\r\n  def is_autoincrement_id?(tbl_name)\r\n    sql = \"SELECT count(*) FROM sqlite_master WHERE tbl_name='#{tbl_name}' AND \" \\\r\n          \"sql LIKE '%\\\"id\\\" integer PRIMARY KEY AUTOINCREMENT%'\"\r\n\r\n    ActiveRecord::Base.connection.select_value(sql) > 0\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\n`AUTOINCREMENT` declaration on primary key should **not be lost** when re-creating a table (via `#alter_table` method).\r\n\r\n### Actual behavior\r\n\r\n`AUTOINCREMENT` declaration on primary key **is lost** when re-creating a table (via `#alter_table` method).\r\n\r\n### System configuration\r\n**Rails version**:\r\n`7.1.0.alpha`\r\n\r\n**Ruby version**:\r\n`3.2.1`\r\n","closed_by":{"login":"eileencodes","id":1080678,"node_id":"MDQ6VXNlcjEwODA2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/1080678?v=4","gravatar_id":"","url":"https://api.github.com/users/eileencodes","html_url":"https://github.com/eileencodes","followers_url":"https://api.github.com/users/eileencodes/followers","following_url":"https://api.github.com/users/eileencodes/following{/other_user}","gists_url":"https://api.github.com/users/eileencodes/gists{/gist_id}","starred_url":"https://api.github.com/users/eileencodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eileencodes/subscriptions","organizations_url":"https://api.github.com/users/eileencodes/orgs","repos_url":"https://api.github.com/users/eileencodes/repos","events_url":"https://api.github.com/users/eileencodes/events{/privacy}","received_events_url":"https://api.github.com/users/eileencodes/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/47400/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/47400/timeline","performed_via_github_app":null,"state_reason":"completed"}