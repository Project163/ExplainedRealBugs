{"url":"https://api.github.com/repos/rails/rails/issues/46621","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/46621/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/46621/comments","events_url":"https://api.github.com/repos/rails/rails/issues/46621/events","html_url":"https://github.com/rails/rails/issues/46621","id":1470691270,"node_id":"I_kwDNIULOV6j3xg","number":46621,"title":"Should assert_enqueued_email_with accept args/params matchers?","user":{"login":"maxim","id":7758,"node_id":"MDQ6VXNlcjc3NTg=","avatar_url":"https://avatars.githubusercontent.com/u/7758?v=4","gravatar_id":"","url":"https://api.github.com/users/maxim","html_url":"https://github.com/maxim","followers_url":"https://api.github.com/users/maxim/followers","following_url":"https://api.github.com/users/maxim/following{/other_user}","gists_url":"https://api.github.com/users/maxim/gists{/gist_id}","starred_url":"https://api.github.com/users/maxim/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maxim/subscriptions","organizations_url":"https://api.github.com/users/maxim/orgs","repos_url":"https://api.github.com/users/maxim/repos","events_url":"https://api.github.com/users/maxim/events{/privacy}","received_events_url":"https://api.github.com/users/maxim/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":107188,"node_id":"MDU6TGFiZWwxMDcxODg=","url":"https://api.github.com/repos/rails/rails/labels/actionmailer","name":"actionmailer","color":"8B00FC","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-12-01T05:10:01Z","updated_at":"2023-05-11T18:06:39Z","closed_at":"2023-05-11T18:06:39Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"This is currently impossible (as of main branch on 2022-11-30):\r\n\r\n```ruby\r\nassert_enqueued_email_with UserMailer, :email_verification, params: -> p { p[:token] =~ /\\w+/ }\r\n```\r\n\r\nbecause `assert_enqueued_email_with` never passes a proc into `assert_enqueued_with`'s `args`.\r\n\r\nNote that `assert_enqueued_with` does support proc args.\r\n\r\nI took a stab at adding this feature, but found that [`assert_enqueued_email_with`](https://github.com/rails/rails/blob/main/actionmailer/lib/action_mailer/test_helper.rb#L151-L164) is getting increasingly funky.\r\n\r\nIt currently tries to guess whether args are actually params (I assume for backwards compatibility).\r\n\r\nIf I start adding a few more `if/elsif` statements to check for proc values, it turns quite messy.\r\n\r\nMy questions are:\r\n\r\n1. Do we want these args/params to support procs? (I would ❤️ it)\r\n2. Should we stop [guessing](https://github.com/rails/rails/blob/main/actionmailer/lib/action_mailer/test_helper.rb#L156-L157) if args are params, and simply pass args to args, and params to params? It would simplify this feature. If neither args nor params is a proc, we simply pass them down. If either of them is a proc, we make a wrapper proc, in which we make a boolean out of args/params procs, and pass the wrapper down. (In latter situation we don't really need to be comparing mailer / method / \"deliver_now\", but we could.)\r\n\r\nFor example\r\n\r\n```ruby\r\n# In case of non-proc args/params:\r\nargs: [mailer.to_s, method.to_s, \"deliver_now\", params: params, args: Array(args)]\r\n\r\n# In case of proc args/params, something like this:\r\nargs: ->(job_args) { params.(job_args[3][:params]) && args.(job_args[3][:args]) }\r\n```","closed_by":{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/46621/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/46621/timeline","performed_via_github_app":null,"state_reason":"completed"}