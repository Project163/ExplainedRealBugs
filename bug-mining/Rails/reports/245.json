{"url":"https://api.github.com/repos/rails/rails/issues/56087","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/56087/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/56087/comments","events_url":"https://api.github.com/repos/rails/rails/issues/56087/events","html_url":"https://github.com/rails/rails/issues/56087","id":3583963183,"node_id":"I_kwDNIULO1Z7wLw","number":56087,"title":"Eager-loading has many associations on models with a composite primary key results in duplicate records","user":{"login":"Martin-Alexander","id":19353631,"node_id":"MDQ6VXNlcjE5MzUzNjMx","avatar_url":"https://avatars.githubusercontent.com/u/19353631?v=4","gravatar_id":"","url":"https://api.github.com/users/Martin-Alexander","html_url":"https://github.com/Martin-Alexander","followers_url":"https://api.github.com/users/Martin-Alexander/followers","following_url":"https://api.github.com/users/Martin-Alexander/following{/other_user}","gists_url":"https://api.github.com/users/Martin-Alexander/gists{/gist_id}","starred_url":"https://api.github.com/users/Martin-Alexander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Martin-Alexander/subscriptions","organizations_url":"https://api.github.com/users/Martin-Alexander/orgs","repos_url":"https://api.github.com/users/Martin-Alexander/repos","events_url":"https://api.github.com/users/Martin-Alexander/events{/privacy}","received_events_url":"https://api.github.com/users/Martin-Alexander/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2025-11-03T22:22:53Z","updated_at":"2025-11-05T08:30:07Z","closed_at":"2025-11-05T08:30:07Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"It seems like the logic for instantiating records from an eager-loaded query does not properly take composite primary keys into account.\n\n### Steps to reproduce\n\n1. Create model A with a composite primary key and a \"has many\" association to model B\n2. Create one record for model A and two associated records for model B\n2. Query model A and eager load the \"has many\" association to model B\n3. Observe that two identical instances of model A are returned, each with only one of the associated B records loaded\n\n```ruby\nrequire \"bundler/inline\"\n\ngemfile(true) do\n  source \"https://rubygems.org\"\n\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\n\n  gem \"rails\", \"8.1.1\"\n  gem \"pg\"\nend\n\nrequire \"active_record\"\nrequire \"minitest/autorun\"\nrequire \"logger\"\n\ndb_config = {\n  adapter: \"postgresql\",\n  database: \"eager_load_composite_key_test\"\n}\n\nbegin\n  ActiveRecord::Base.establish_connection(db_config.except(:database))\n  ActiveRecord::Base.connection.drop_database(db_config[:database]) rescue nil\n  ActiveRecord::Base.connection.create_database(db_config[:database])\nend\nActiveRecord::Base.establish_connection(db_config)\nActiveRecord::Base.logger = Logger.new(STDOUT)\n\nActiveRecord::Schema.define do\n  create_table :buyers, primary_key: [:user_id, :tenant_id] do |t|\n    t.bigint :user_id\n    t.bigint :tenant_id\n  end\n  create_table :orders do |t|\n    t.references :buyer_user\n    t.references :buyer_tenant\n  end\nend\n\nclass Buyer < ActiveRecord::Base\n  self.primary_key = [:user_id, :tenant_id]\n\n  has_many :orders, foreign_key: [:buyer_user_id, :buyer_tenant_id]\nend\nclass Order < ActiveRecord::Base; end\n\nclass CompositePrimaryKeyTest < Minitest::Test\n  def test_eager_load_has_many\n    Buyer.create!(user_id: 1, tenant_id: 1)\n    Order.create!(id: 1, buyer_user_id: 1, buyer_tenant_id: 1)\n    Order.create!(id: 2, buyer_user_id: 1, buyer_tenant_id: 1)\n\n    buyers = Buyer.eager_load(:orders).to_a\n\n    assert_equal 1, buyers.length\n  end\nend\n```\n\n### Expected behavior\n\nIt should return one buyer record with both of its orders loaded.\n\n```\n└── Buyer: user_id=1, tenant_id=1\n    ├── Order: id=1, buyer_user_id=1, buyer_tenant_id=1\n    └── Order: id=2, buyer_user_id=1, buyer_tenant_id=1\n```\n\n### Actual behavior\n\nIt returns two identical buyer records, each with one order loaded.\n\n```\n├── Buyer: user_id=1, tenant_id=1\n│   └── Order: id=1, buyer_user_id=1, buyer_tenant_id=1\n└── Buyer: user_id=1, tenant_id=1\n    └── Order: id=2, buyer_user_id=1, buyer_tenant_id=1\n```\n\n### System configuration\n\n**Rails version**: 8.1.1\n\n**Ruby version**: ruby 3.2.0 (2022-12-25 revision a528908271) [arm64-darwin24]\n","closed_by":{"login":"byroot","id":44640,"node_id":"MDQ6VXNlcjQ0NjQw","avatar_url":"https://avatars.githubusercontent.com/u/44640?v=4","gravatar_id":"","url":"https://api.github.com/users/byroot","html_url":"https://github.com/byroot","followers_url":"https://api.github.com/users/byroot/followers","following_url":"https://api.github.com/users/byroot/following{/other_user}","gists_url":"https://api.github.com/users/byroot/gists{/gist_id}","starred_url":"https://api.github.com/users/byroot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/byroot/subscriptions","organizations_url":"https://api.github.com/users/byroot/orgs","repos_url":"https://api.github.com/users/byroot/repos","events_url":"https://api.github.com/users/byroot/events{/privacy}","received_events_url":"https://api.github.com/users/byroot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/56087/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/56087/timeline","performed_via_github_app":null,"state_reason":"completed"}