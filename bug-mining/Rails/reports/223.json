{"url":"https://api.github.com/repos/rails/rails/issues/49745","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/49745/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/49745/comments","events_url":"https://api.github.com/repos/rails/rails/issues/49745/events","html_url":"https://github.com/rails/rails/issues/49745","id":1956771268,"node_id":"I_kwDNIULOdKH1xA","number":49745,"title":"`Rails.logger.tagged` will execute block as many times as the number of tagged loggers in the broadcast","user":{"login":"davidstosik","id":816901,"node_id":"MDQ6VXNlcjgxNjkwMQ==","avatar_url":"https://avatars.githubusercontent.com/u/816901?v=4","gravatar_id":"","url":"https://api.github.com/users/davidstosik","html_url":"https://github.com/davidstosik","followers_url":"https://api.github.com/users/davidstosik/followers","following_url":"https://api.github.com/users/davidstosik/following{/other_user}","gists_url":"https://api.github.com/users/davidstosik/gists{/gist_id}","starred_url":"https://api.github.com/users/davidstosik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidstosik/subscriptions","organizations_url":"https://api.github.com/users/davidstosik/orgs","repos_url":"https://api.github.com/users/davidstosik/repos","events_url":"https://api.github.com/users/davidstosik/events{/privacy}","received_events_url":"https://api.github.com/users/davidstosik/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"Edouard-chin","id":8122246,"node_id":"MDQ6VXNlcjgxMjIyNDY=","avatar_url":"https://avatars.githubusercontent.com/u/8122246?v=4","gravatar_id":"","url":"https://api.github.com/users/Edouard-chin","html_url":"https://github.com/Edouard-chin","followers_url":"https://api.github.com/users/Edouard-chin/followers","following_url":"https://api.github.com/users/Edouard-chin/following{/other_user}","gists_url":"https://api.github.com/users/Edouard-chin/gists{/gist_id}","starred_url":"https://api.github.com/users/Edouard-chin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Edouard-chin/subscriptions","organizations_url":"https://api.github.com/users/Edouard-chin/orgs","repos_url":"https://api.github.com/users/Edouard-chin/repos","events_url":"https://api.github.com/users/Edouard-chin/events{/privacy}","received_events_url":"https://api.github.com/users/Edouard-chin/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"Edouard-chin","id":8122246,"node_id":"MDQ6VXNlcjgxMjIyNDY=","avatar_url":"https://avatars.githubusercontent.com/u/8122246?v=4","gravatar_id":"","url":"https://api.github.com/users/Edouard-chin","html_url":"https://github.com/Edouard-chin","followers_url":"https://api.github.com/users/Edouard-chin/followers","following_url":"https://api.github.com/users/Edouard-chin/following{/other_user}","gists_url":"https://api.github.com/users/Edouard-chin/gists{/gist_id}","starred_url":"https://api.github.com/users/Edouard-chin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Edouard-chin/subscriptions","organizations_url":"https://api.github.com/users/Edouard-chin/orgs","repos_url":"https://api.github.com/users/Edouard-chin/repos","events_url":"https://api.github.com/users/Edouard-chin/events{/privacy}","received_events_url":"https://api.github.com/users/Edouard-chin/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/rails/rails/milestones/94","html_url":"https://github.com/rails/rails/milestone/94","labels_url":"https://api.github.com/repos/rails/rails/milestones/94/labels","id":11878524,"node_id":"MI_kwDNIULOALVAfA","number":94,"title":"7.1.6","description":"","creator":{"login":"skipkayhil","id":6014046,"node_id":"MDQ6VXNlcjYwMTQwNDY=","avatar_url":"https://avatars.githubusercontent.com/u/6014046?v=4","gravatar_id":"","url":"https://api.github.com/users/skipkayhil","html_url":"https://github.com/skipkayhil","followers_url":"https://api.github.com/users/skipkayhil/followers","following_url":"https://api.github.com/users/skipkayhil/following{/other_user}","gists_url":"https://api.github.com/users/skipkayhil/gists{/gist_id}","starred_url":"https://api.github.com/users/skipkayhil/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/skipkayhil/subscriptions","organizations_url":"https://api.github.com/users/skipkayhil/orgs","repos_url":"https://api.github.com/users/skipkayhil/repos","events_url":"https://api.github.com/users/skipkayhil/events{/privacy}","received_events_url":"https://api.github.com/users/skipkayhil/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":5,"closed_issues":1,"state":"open","created_at":"2024-11-11T20:53:20Z","updated_at":"2025-08-13T20:43:33Z","due_on":null,"closed_at":null},"comments":7,"created_at":"2023-10-23T09:45:55Z","updated_at":"2025-08-13T20:43:33Z","closed_at":"2025-08-13T20:43:33Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Steps to reproduce\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"debug\"\r\nend\r\n\r\nrequire \"active_support\"\r\nrequire \"active_support/core_ext/object/blank\"\r\nrequire \"minitest/autorun\"\r\n\r\nmodule ActiveSupport\r\n  class BugTest < Minitest::Test\r\n    def test_tagged_broadcast\r\n      logger1_io = StringIO.new\r\n      logger2_io = StringIO.new\r\n\r\n      logger = BroadcastLogger.new(TaggedLogging.new(Logger.new(logger1_io)))\r\n      logger.broadcast_to(TaggedLogging.new(Logger.new(logger2_io)))\r\n\r\n      run_counter = 0\r\n\r\n      logger.tagged(\"TEST\") do\r\n        logger.info(\"Doing something\")\r\n        run_counter += 1\r\n      end\r\n\r\n      # require \"debug\";binding.b\r\n      assert_equal 1, run_counter                                  # Actual: 2\r\n      assert_equal \"[TEST] Doing something\\n\", logger1_io.string   # Actual: \"[TEST] Doing something\\nDoing something\\n\"\r\n      assert_equal \"[TEST] Doing something\\n\", logger2_io.string   # Actual: \"Doing something\\n[TEST] Doing something\\n\"\r\n    end\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\nWhen I do `Rails.logger.tagged(\"MY TAG\") { do_something }`, I expect `do_something` to be called once, regardless of how many loggers Rails is broadcasting to.\r\n\r\nI also expect my log to be tagged and displayed in each logger. (I should see \"[TEST] Doing something\" once in the first log sink, and once in the second log sink.)\r\n\r\nI don't know how common this is, but I've seen many applications (starting with Shopify), passing rather long blocks to `#tagged`, expecting all logs produced by the code in that block to be tagged. This becomes a problem if we for example do database operations in that block.\r\n\r\n### Actual behavior\r\n\r\nThe block passed to `tagged` is run as many times as there are loggers broadcasted to.\r\nThe log messages get multiplied too (obviously), and only one for each logger is tagged.\r\n\r\n### System configuration\r\n\r\n**Rails version**: `HEAD`\r\n**Ruby version**: 3.2.1\r\n\r\n---\r\n\r\nStill working on a graceful but quick solution to handle this. Suggestions welcome!","closed_by":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/49745/reactions","total_count":6,"+1":6,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/49745/timeline","performed_via_github_app":null,"state_reason":"completed"}