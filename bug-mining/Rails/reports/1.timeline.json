[{"url":"https://api.github.com/repos/rails/rails/issues/comments/1248341656","html_url":"https://github.com/rails/rails/issues/46044#issuecomment-1248341656","issue_url":"https://api.github.com/repos/rails/rails/issues/46044","id":1248341656,"node_id":"IC_kwDNIULOSmgumA","user":{"login":"rnubel","id":850438,"node_id":"MDQ6VXNlcjg1MDQzOA==","avatar_url":"https://avatars.githubusercontent.com/u/850438?v=4","gravatar_id":"","url":"https://api.github.com/users/rnubel","html_url":"https://github.com/rnubel","followers_url":"https://api.github.com/users/rnubel/followers","following_url":"https://api.github.com/users/rnubel/following{/other_user}","gists_url":"https://api.github.com/users/rnubel/gists{/gist_id}","starred_url":"https://api.github.com/users/rnubel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnubel/subscriptions","organizations_url":"https://api.github.com/users/rnubel/orgs","repos_url":"https://api.github.com/users/rnubel/repos","events_url":"https://api.github.com/users/rnubel/events{/privacy}","received_events_url":"https://api.github.com/users/rnubel/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-09-15T16:30:41Z","updated_at":"2022-09-15T16:30:41Z","body":"https://github.com/rnubel/rails/commit/9b48b35a1adbb8c36abee8472afe7ebd49d84475 is a patch which does fix the above test, but I'm not sure about side effects it may have or if there's a better solution. Essentially, it just updates the hash keys for the query cache to include the original numerical hash so that the equivalence check cannot return true if the hash has changed.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/1248341656/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"rnubel","id":850438,"node_id":"MDQ6VXNlcjg1MDQzOA==","avatar_url":"https://avatars.githubusercontent.com/u/850438?v=4","gravatar_id":"","url":"https://api.github.com/users/rnubel","html_url":"https://github.com/rnubel","followers_url":"https://api.github.com/users/rnubel/followers","following_url":"https://api.github.com/users/rnubel/following{/other_user}","gists_url":"https://api.github.com/users/rnubel/gists{/gist_id}","starred_url":"https://api.github.com/users/rnubel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnubel/subscriptions","organizations_url":"https://api.github.com/users/rnubel/orgs","repos_url":"https://api.github.com/users/rnubel/repos","events_url":"https://api.github.com/users/rnubel/events{/privacy}","received_events_url":"https://api.github.com/users/rnubel/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":7398463809,"node_id":"LE_lADNIULOUfGv1M8AAAABuPuZQQ","url":"https://api.github.com/repos/rails/rails/issues/events/7398463809","actor":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2022-09-15T21:28:53Z","label":{"name":"activerecord","color":"0b02e1"},"performed_via_github_app":null},{"id":7398463811,"node_id":"LE_lADNIULOUfGv1M8AAAABuPuZQw","url":"https://api.github.com/repos/rails/rails/issues/events/7398463811","actor":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2022-09-15T21:28:53Z","label":{"name":"With reproduction steps","color":"009800"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/comments/1248657315","html_url":"https://github.com/rails/rails/issues/46044#issuecomment-1248657315","issue_url":"https://api.github.com/repos/rails/rails/issues/46044","id":1248657315,"node_id":"IC_kwDNIULOSmz_ow","user":{"login":"tenderlove","id":3124,"node_id":"MDQ6VXNlcjMxMjQ=","avatar_url":"https://avatars.githubusercontent.com/u/3124?v=4","gravatar_id":"","url":"https://api.github.com/users/tenderlove","html_url":"https://github.com/tenderlove","followers_url":"https://api.github.com/users/tenderlove/followers","following_url":"https://api.github.com/users/tenderlove/following{/other_user}","gists_url":"https://api.github.com/users/tenderlove/gists{/gist_id}","starred_url":"https://api.github.com/users/tenderlove/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tenderlove/subscriptions","organizations_url":"https://api.github.com/users/tenderlove/orgs","repos_url":"https://api.github.com/users/tenderlove/repos","events_url":"https://api.github.com/users/tenderlove/events{/privacy}","received_events_url":"https://api.github.com/users/tenderlove/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-09-15T21:35:58Z","updated_at":"2022-09-15T21:35:58Z","body":"Nice find!!!  I'm not sure if this is the best fix.  It's perfectly legit for two objects to return the same value for `.hash`.  That's why we have the `eql?` method too.  That makes me doubt that storing the return value of `.hash` will 100% fix this issue.  Also it seems like the proposed patch would punish every query.\r\n\r\nIt seems like this is only a problem when a column can store a complex data type, like JSON or something.  Maybe we can make a more surgical fix, like dup and freeze the bind value, but only on JSON columns?  I'm trying something but not 100% sure it'll work.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/1248657315/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"tenderlove","id":3124,"node_id":"MDQ6VXNlcjMxMjQ=","avatar_url":"https://avatars.githubusercontent.com/u/3124?v=4","gravatar_id":"","url":"https://api.github.com/users/tenderlove","html_url":"https://github.com/tenderlove","followers_url":"https://api.github.com/users/tenderlove/followers","following_url":"https://api.github.com/users/tenderlove/following{/other_user}","gists_url":"https://api.github.com/users/tenderlove/gists{/gist_id}","starred_url":"https://api.github.com/users/tenderlove/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tenderlove/subscriptions","organizations_url":"https://api.github.com/users/tenderlove/orgs","repos_url":"https://api.github.com/users/tenderlove/repos","events_url":"https://api.github.com/users/tenderlove/events{/privacy}","received_events_url":"https://api.github.com/users/tenderlove/received_events","type":"User","user_view_type":"public","site_admin":false}},{"actor":{"login":"tenderlove","id":3124,"node_id":"MDQ6VXNlcjMxMjQ=","avatar_url":"https://avatars.githubusercontent.com/u/3124?v=4","gravatar_id":"","url":"https://api.github.com/users/tenderlove","html_url":"https://github.com/tenderlove","followers_url":"https://api.github.com/users/tenderlove/followers","following_url":"https://api.github.com/users/tenderlove/following{/other_user}","gists_url":"https://api.github.com/users/tenderlove/gists{/gist_id}","starred_url":"https://api.github.com/users/tenderlove/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tenderlove/subscriptions","organizations_url":"https://api.github.com/users/tenderlove/orgs","repos_url":"https://api.github.com/users/tenderlove/repos","events_url":"https://api.github.com/users/tenderlove/events{/privacy}","received_events_url":"https://api.github.com/users/tenderlove/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-09-15T21:43:56Z","updated_at":"2022-09-15T21:43:56Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/rails/rails/issues/46048","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/46048/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/46048/comments","events_url":"https://api.github.com/repos/rails/rails/issues/46048/events","html_url":"https://github.com/rails/rails/pull/46048","id":1375121023,"node_id":"PR_kwDNIULOPw6L0g","number":46048,"title":"Dup and freeze complex types when making query attributes","user":{"login":"tenderlove","id":3124,"node_id":"MDQ6VXNlcjMxMjQ=","avatar_url":"https://avatars.githubusercontent.com/u/3124?v=4","gravatar_id":"","url":"https://api.github.com/users/tenderlove","html_url":"https://github.com/tenderlove","followers_url":"https://api.github.com/users/tenderlove/followers","following_url":"https://api.github.com/users/tenderlove/following{/other_user}","gists_url":"https://api.github.com/users/tenderlove/gists{/gist_id}","starred_url":"https://api.github.com/users/tenderlove/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tenderlove/subscriptions","organizations_url":"https://api.github.com/users/tenderlove/orgs","repos_url":"https://api.github.com/users/tenderlove/repos","events_url":"https://api.github.com/users/tenderlove/events{/privacy}","received_events_url":"https://api.github.com/users/tenderlove/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":107190,"node_id":"MDU6TGFiZWwxMDcxOTA=","url":"https://api.github.com/repos/rails/rails/labels/activemodel","name":"activemodel","color":"00E5FF","default":false,"description":null},{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":107195,"node_id":"MDU6TGFiZWwxMDcxOTU=","url":"https://api.github.com/repos/rails/rails/labels/railties","name":"railties","color":"8BE06E","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2022-09-15T21:43:56Z","updated_at":"2023-07-12T13:55:11Z","closed_at":"2022-09-19T08:37:06Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":8514,"node_id":"MDEwOlJlcG9zaXRvcnk4NTE0","name":"rails","full_name":"rails/rails","private":false,"owner":{"login":"rails","id":4223,"node_id":"MDEyOk9yZ2FuaXphdGlvbjQyMjM=","avatar_url":"https://avatars.githubusercontent.com/u/4223?v=4","gravatar_id":"","url":"https://api.github.com/users/rails","html_url":"https://github.com/rails","followers_url":"https://api.github.com/users/rails/followers","following_url":"https://api.github.com/users/rails/following{/other_user}","gists_url":"https://api.github.com/users/rails/gists{/gist_id}","starred_url":"https://api.github.com/users/rails/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rails/subscriptions","organizations_url":"https://api.github.com/users/rails/orgs","repos_url":"https://api.github.com/users/rails/repos","events_url":"https://api.github.com/users/rails/events{/privacy}","received_events_url":"https://api.github.com/users/rails/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/rails/rails","description":"Ruby on Rails","fork":false,"url":"https://api.github.com/repos/rails/rails","forks_url":"https://api.github.com/repos/rails/rails/forks","keys_url":"https://api.github.com/repos/rails/rails/keys{/key_id}","collaborators_url":"https://api.github.com/repos/rails/rails/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/rails/rails/teams","hooks_url":"https://api.github.com/repos/rails/rails/hooks","issue_events_url":"https://api.github.com/repos/rails/rails/issues/events{/number}","events_url":"https://api.github.com/repos/rails/rails/events","assignees_url":"https://api.github.com/repos/rails/rails/assignees{/user}","branches_url":"https://api.github.com/repos/rails/rails/branches{/branch}","tags_url":"https://api.github.com/repos/rails/rails/tags","blobs_url":"https://api.github.com/repos/rails/rails/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/rails/rails/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/rails/rails/git/refs{/sha}","trees_url":"https://api.github.com/repos/rails/rails/git/trees{/sha}","statuses_url":"https://api.github.com/repos/rails/rails/statuses/{sha}","languages_url":"https://api.github.com/repos/rails/rails/languages","stargazers_url":"https://api.github.com/repos/rails/rails/stargazers","contributors_url":"https://api.github.com/repos/rails/rails/contributors","subscribers_url":"https://api.github.com/repos/rails/rails/subscribers","subscription_url":"https://api.github.com/repos/rails/rails/subscription","commits_url":"https://api.github.com/repos/rails/rails/commits{/sha}","git_commits_url":"https://api.github.com/repos/rails/rails/git/commits{/sha}","comments_url":"https://api.github.com/repos/rails/rails/comments{/number}","issue_comment_url":"https://api.github.com/repos/rails/rails/issues/comments{/number}","contents_url":"https://api.github.com/repos/rails/rails/contents/{+path}","compare_url":"https://api.github.com/repos/rails/rails/compare/{base}...{head}","merges_url":"https://api.github.com/repos/rails/rails/merges","archive_url":"https://api.github.com/repos/rails/rails/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/rails/rails/downloads","issues_url":"https://api.github.com/repos/rails/rails/issues{/number}","pulls_url":"https://api.github.com/repos/rails/rails/pulls{/number}","milestones_url":"https://api.github.com/repos/rails/rails/milestones{/number}","notifications_url":"https://api.github.com/repos/rails/rails/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/rails/rails/labels{/name}","releases_url":"https://api.github.com/repos/rails/rails/releases{/id}","deployments_url":"https://api.github.com/repos/rails/rails/deployments","created_at":"2008-04-11T02:19:47Z","updated_at":"2025-11-10T02:03:47Z","pushed_at":"2025-11-10T00:33:52Z","git_url":"git://github.com/rails/rails.git","ssh_url":"git@github.com:rails/rails.git","clone_url":"https://github.com/rails/rails.git","svn_url":"https://github.com/rails/rails","homepage":"https://rubyonrails.org","size":271619,"stargazers_count":57840,"watchers_count":57840,"language":"Ruby","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":true,"forks_count":22025,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":1341,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["activejob","activerecord","framework","html","mvc","rails","ruby"],"visibility":"public","forks":22025,"open_issues":1341,"watchers":57840,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/rails/rails/pulls/46048","html_url":"https://github.com/rails/rails/pull/46048","diff_url":"https://github.com/rails/rails/pull/46048.diff","patch_url":"https://github.com/rails/rails/pull/46048.patch","merged_at":"2022-09-19T08:37:06Z"},"body":"This avoids problems when complex data structures are mutated _after_ being handed to ActiveRecord for processing.  For example false hits in the query cache.\r\n\r\nPossible fix for #46044 ","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/46048/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/46048/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"url":"https://api.github.com/repos/rails/rails/issues/comments/1248666158","html_url":"https://github.com/rails/rails/issues/46044#issuecomment-1248666158","issue_url":"https://api.github.com/repos/rails/rails/issues/46044","id":1248666158,"node_id":"IC_kwDNIULOSm0iLg","user":{"login":"tenderlove","id":3124,"node_id":"MDQ6VXNlcjMxMjQ=","avatar_url":"https://avatars.githubusercontent.com/u/3124?v=4","gravatar_id":"","url":"https://api.github.com/users/tenderlove","html_url":"https://github.com/tenderlove","followers_url":"https://api.github.com/users/tenderlove/followers","following_url":"https://api.github.com/users/tenderlove/following{/other_user}","gists_url":"https://api.github.com/users/tenderlove/gists{/gist_id}","starred_url":"https://api.github.com/users/tenderlove/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tenderlove/subscriptions","organizations_url":"https://api.github.com/users/tenderlove/orgs","repos_url":"https://api.github.com/users/tenderlove/repos","events_url":"https://api.github.com/users/tenderlove/events{/privacy}","received_events_url":"https://api.github.com/users/tenderlove/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-09-15T21:47:00Z","updated_at":"2022-09-15T21:47:00Z","body":"I pushed #46048.  It fixed your test case, but I haven't tried all of the suite.  If CI is green (and you're OK with that patch) we should add your test case. :)","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/1248666158/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":1,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"tenderlove","id":3124,"node_id":"MDQ6VXNlcjMxMjQ=","avatar_url":"https://avatars.githubusercontent.com/u/3124?v=4","gravatar_id":"","url":"https://api.github.com/users/tenderlove","html_url":"https://github.com/tenderlove","followers_url":"https://api.github.com/users/tenderlove/followers","following_url":"https://api.github.com/users/tenderlove/following{/other_user}","gists_url":"https://api.github.com/users/tenderlove/gists{/gist_id}","starred_url":"https://api.github.com/users/tenderlove/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tenderlove/subscriptions","organizations_url":"https://api.github.com/users/tenderlove/orgs","repos_url":"https://api.github.com/users/tenderlove/repos","events_url":"https://api.github.com/users/tenderlove/events{/privacy}","received_events_url":"https://api.github.com/users/tenderlove/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rails/rails/issues/comments/1248941933","html_url":"https://github.com/rails/rails/issues/46044#issuecomment-1248941933","issue_url":"https://api.github.com/repos/rails/rails/issues/46044","id":1248941933,"node_id":"IC_kwDNIULOSnFXbQ","user":{"login":"rnubel","id":850438,"node_id":"MDQ6VXNlcjg1MDQzOA==","avatar_url":"https://avatars.githubusercontent.com/u/850438?v=4","gravatar_id":"","url":"https://api.github.com/users/rnubel","html_url":"https://github.com/rnubel","followers_url":"https://api.github.com/users/rnubel/followers","following_url":"https://api.github.com/users/rnubel/following{/other_user}","gists_url":"https://api.github.com/users/rnubel/gists{/gist_id}","starred_url":"https://api.github.com/users/rnubel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnubel/subscriptions","organizations_url":"https://api.github.com/users/rnubel/orgs","repos_url":"https://api.github.com/users/rnubel/repos","events_url":"https://api.github.com/users/rnubel/events{/privacy}","received_events_url":"https://api.github.com/users/rnubel/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-09-16T05:44:29Z","updated_at":"2022-09-16T05:44:29Z","body":"@tenderlove I think your deep-dup-and-freeze idea is an elegant fix to this problem. I wouldn't be surprised if one day Ruby stopped allowing mutable objects to be used as hash keys, like Python does, because it's only a recipe for trouble. Your patch looks great! My only feedback is that `wrap_value` isn't really describing what's happening -- maybe `hashable_value` (not really right either as all values are hashable, but descriptive of the purpose) or `immutable_value`?\r\n\r\nAlso, since your fix is more robust, I was able to minify the test case down to just one iteration by using a custom HashWithFixedHash class that locks its `hash` as `1`. If you'd prefer to keep the thousands-of-iterations version for better fidelity, I can switch it back, but that one took over 5 minutes to run on my dev container and just felt a bit wasteful.\r\n\r\nOn main, the test fails; with your patch, it passes:\r\n\r\n<img width=\"1079\" alt=\"image\" src=\"https://user-images.githubusercontent.com/850438/190560400-4418d2d0-aa48-41b8-a8fe-fe2cec640889.png\">\r\n\r\nHere's a commit with just the test case that you can cherry-pick, if you'd like: https://github.com/rnubel/rails/commit/a93bd508d26b9b3852ef98aba36225420173b5b1. I'm new to developing on the Rails codebase so it might need some work.\r\n\r\n\r\n<br />\r\n\r\nP.S. While digging through `hash.c` and working on reproducing this bug, I thought of your [Yak Shaving Is Best Shaving](https://speakerdeck.com/tenderlove/yak-shaving-is-best-shaving) talk that I was fortunate enough to watch you give at Madison Ruby way back in 2013. That talk inspired me in my career to not be afraid to peel back layers and keep digging until everything is made clear... which is probably why I found the root cause here instead of just disabling the query cache in our app and moving on. Full circle! üòÑ ","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/1248941933/reactions","total_count":2,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":2,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"rnubel","id":850438,"node_id":"MDQ6VXNlcjg1MDQzOA==","avatar_url":"https://avatars.githubusercontent.com/u/850438?v=4","gravatar_id":"","url":"https://api.github.com/users/rnubel","html_url":"https://github.com/rnubel","followers_url":"https://api.github.com/users/rnubel/followers","following_url":"https://api.github.com/users/rnubel/following{/other_user}","gists_url":"https://api.github.com/users/rnubel/gists{/gist_id}","starred_url":"https://api.github.com/users/rnubel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnubel/subscriptions","organizations_url":"https://api.github.com/users/rnubel/orgs","repos_url":"https://api.github.com/users/rnubel/repos","events_url":"https://api.github.com/users/rnubel/events{/privacy}","received_events_url":"https://api.github.com/users/rnubel/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":7400209771,"node_id":"MEE_lADNIULOUfGv1M8AAAABuRY9aw","url":"https://api.github.com/repos/rails/rails/issues/events/7400209771","actor":{"login":"tenderlove","id":3124,"node_id":"MDQ6VXNlcjMxMjQ=","avatar_url":"https://avatars.githubusercontent.com/u/3124?v=4","gravatar_id":"","url":"https://api.github.com/users/tenderlove","html_url":"https://github.com/tenderlove","followers_url":"https://api.github.com/users/tenderlove/followers","following_url":"https://api.github.com/users/tenderlove/following{/other_user}","gists_url":"https://api.github.com/users/tenderlove/gists{/gist_id}","starred_url":"https://api.github.com/users/tenderlove/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tenderlove/subscriptions","organizations_url":"https://api.github.com/users/tenderlove/orgs","repos_url":"https://api.github.com/users/tenderlove/repos","events_url":"https://api.github.com/users/tenderlove/events{/privacy}","received_events_url":"https://api.github.com/users/tenderlove/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2022-09-16T05:44:29Z","performed_via_github_app":null},{"id":7400209776,"node_id":"SE_lADNIULOUfGv1M8AAAABuRY9cA","url":"https://api.github.com/repos/rails/rails/issues/events/7400209776","actor":{"login":"tenderlove","id":3124,"node_id":"MDQ6VXNlcjMxMjQ=","avatar_url":"https://avatars.githubusercontent.com/u/3124?v=4","gravatar_id":"","url":"https://api.github.com/users/tenderlove","html_url":"https://github.com/tenderlove","followers_url":"https://api.github.com/users/tenderlove/followers","following_url":"https://api.github.com/users/tenderlove/following{/other_user}","gists_url":"https://api.github.com/users/tenderlove/gists{/gist_id}","starred_url":"https://api.github.com/users/tenderlove/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tenderlove/subscriptions","organizations_url":"https://api.github.com/users/tenderlove/orgs","repos_url":"https://api.github.com/users/tenderlove/repos","events_url":"https://api.github.com/users/tenderlove/events{/privacy}","received_events_url":"https://api.github.com/users/tenderlove/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2022-09-16T05:44:29Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/comments/1249746186","html_url":"https://github.com/rails/rails/issues/46044#issuecomment-1249746186","issue_url":"https://api.github.com/repos/rails/rails/issues/46044","id":1249746186,"node_id":"IC_kwDNIULOSn2dCg","user":{"login":"tenderlove","id":3124,"node_id":"MDQ6VXNlcjMxMjQ=","avatar_url":"https://avatars.githubusercontent.com/u/3124?v=4","gravatar_id":"","url":"https://api.github.com/users/tenderlove","html_url":"https://github.com/tenderlove","followers_url":"https://api.github.com/users/tenderlove/followers","following_url":"https://api.github.com/users/tenderlove/following{/other_user}","gists_url":"https://api.github.com/users/tenderlove/gists{/gist_id}","starred_url":"https://api.github.com/users/tenderlove/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tenderlove/subscriptions","organizations_url":"https://api.github.com/users/tenderlove/orgs","repos_url":"https://api.github.com/users/tenderlove/repos","events_url":"https://api.github.com/users/tenderlove/events{/privacy}","received_events_url":"https://api.github.com/users/tenderlove/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-09-16T19:49:55Z","updated_at":"2022-09-16T19:49:55Z","body":"> I wouldn't be surprised if one day Ruby stopped allowing mutable objects to be used as hash keys, like Python does, because it's only a recipe for trouble.\r\n\r\nYa, I think that would be great.  Might be worth making a feature request to Ruby. This isn't the first time we've hit this particular footgun (see #43681)\r\n\r\n> My only feedback is that wrap_value isn't really describing what's happening -- maybe hashable_value (not really right either as all values are hashable, but descriptive of the purpose) or immutable_value?\r\n\r\nI agree.  I like `immutable_value` so I'll change it to that.\r\n\r\n> Also, since your fix is more robust, I was able to minify the test case down to just one iteration by using a custom HashWithFixedHash class that locks its `hash` as `1`. If you'd prefer to keep the thousands-of-iterations version for better fidelity, I can switch it back, but that one took over 5 minutes to run on my dev container and just felt a bit wasteful.\r\n\r\nNo, I think your test case is good.  I'll cherry pick it over.  Thank you!\r\n\r\n> P.S. While digging through `hash.c` and working on reproducing this bug, I thought of your [Yak Shaving Is Best Shaving](https://speakerdeck.com/tenderlove/yak-shaving-is-best-shaving) talk that I was fortunate enough to watch you give at Madison Ruby way back in 2013. That talk inspired me in my career to not be afraid to peel back layers and keep digging until everything is made clear... which is probably why I found the root cause here instead of just disabling the query cache in our app and moving on. Full circle! üòÑ\r\n\r\nNice!  Thank you so much, I really appreciate it.  I'm glad I was able to make an impact!! üôáüèª‚Äç‚ôÄÔ∏è","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/1249746186/reactions","total_count":5,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":4,"eyes":1},"performed_via_github_app":null,"event":"commented","actor":{"login":"tenderlove","id":3124,"node_id":"MDQ6VXNlcjMxMjQ=","avatar_url":"https://avatars.githubusercontent.com/u/3124?v=4","gravatar_id":"","url":"https://api.github.com/users/tenderlove","html_url":"https://github.com/tenderlove","followers_url":"https://api.github.com/users/tenderlove/followers","following_url":"https://api.github.com/users/tenderlove/following{/other_user}","gists_url":"https://api.github.com/users/tenderlove/gists{/gist_id}","starred_url":"https://api.github.com/users/tenderlove/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tenderlove/subscriptions","organizations_url":"https://api.github.com/users/tenderlove/orgs","repos_url":"https://api.github.com/users/tenderlove/repos","events_url":"https://api.github.com/users/tenderlove/events{/privacy}","received_events_url":"https://api.github.com/users/tenderlove/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":7405745504,"node_id":"REFE_lADNIULOUfGv1M8AAAABuWq1YA","url":"https://api.github.com/repos/rails/rails/issues/events/7405745504","actor":{"login":"tenderlove","id":3124,"node_id":"MDQ6VXNlcjMxMjQ=","avatar_url":"https://avatars.githubusercontent.com/u/3124?v=4","gravatar_id":"","url":"https://api.github.com/users/tenderlove","html_url":"https://github.com/tenderlove","followers_url":"https://api.github.com/users/tenderlove/followers","following_url":"https://api.github.com/users/tenderlove/following{/other_user}","gists_url":"https://api.github.com/users/tenderlove/gists{/gist_id}","starred_url":"https://api.github.com/users/tenderlove/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tenderlove/subscriptions","organizations_url":"https://api.github.com/users/tenderlove/orgs","repos_url":"https://api.github.com/users/tenderlove/repos","events_url":"https://api.github.com/users/tenderlove/events{/privacy}","received_events_url":"https://api.github.com/users/tenderlove/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"8ca7a0554fa34a738131c3615bcecf21b4facfd5","commit_url":"https://api.github.com/repos/rails/rails/commits/8ca7a0554fa34a738131c3615bcecf21b4facfd5","created_at":"2022-09-16T19:53:24Z","performed_via_github_app":null},{"id":7411043191,"node_id":"REFE_lADNIULOUfGv1M8AAAABubuLdw","url":"https://api.github.com/repos/rails/rails/issues/events/7411043191","actor":{"login":"byroot","id":44640,"node_id":"MDQ6VXNlcjQ0NjQw","avatar_url":"https://avatars.githubusercontent.com/u/44640?v=4","gravatar_id":"","url":"https://api.github.com/users/byroot","html_url":"https://github.com/byroot","followers_url":"https://api.github.com/users/byroot/followers","following_url":"https://api.github.com/users/byroot/following{/other_user}","gists_url":"https://api.github.com/users/byroot/gists{/gist_id}","starred_url":"https://api.github.com/users/byroot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/byroot/subscriptions","organizations_url":"https://api.github.com/users/byroot/orgs","repos_url":"https://api.github.com/users/byroot/repos","events_url":"https://api.github.com/users/byroot/events{/privacy}","received_events_url":"https://api.github.com/users/byroot/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"f8329c59d167ea4ae62e4c2bcb3d8d6eb7c3f70c","commit_url":"https://api.github.com/repos/rails/rails/commits/f8329c59d167ea4ae62e4c2bcb3d8d6eb7c3f70c","created_at":"2022-09-19T07:14:33Z","performed_via_github_app":null},{"id":7411049612,"node_id":"REFE_lADNIULOUfGv1M8AAAABubukjA","url":"https://api.github.com/repos/rails/rails/issues/events/7411049612","actor":{"login":"byroot","id":44640,"node_id":"MDQ6VXNlcjQ0NjQw","avatar_url":"https://avatars.githubusercontent.com/u/44640?v=4","gravatar_id":"","url":"https://api.github.com/users/byroot","html_url":"https://github.com/byroot","followers_url":"https://api.github.com/users/byroot/followers","following_url":"https://api.github.com/users/byroot/following{/other_user}","gists_url":"https://api.github.com/users/byroot/gists{/gist_id}","starred_url":"https://api.github.com/users/byroot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/byroot/subscriptions","organizations_url":"https://api.github.com/users/byroot/orgs","repos_url":"https://api.github.com/users/byroot/repos","events_url":"https://api.github.com/users/byroot/events{/privacy}","received_events_url":"https://api.github.com/users/byroot/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"73d064964faa94cd986d43e5af66bd4f8ed2551a","commit_url":"https://api.github.com/repos/rails/rails/commits/73d064964faa94cd986d43e5af66bd4f8ed2551a","created_at":"2022-09-19T07:15:35Z","performed_via_github_app":null},{"id":7411208629,"node_id":"REFE_lADNIULOUfGv1M8AAAABub4RtQ","url":"https://api.github.com/repos/rails/rails/issues/events/7411208629","actor":{"login":"casperisfine","id":19192189,"node_id":"MDQ6VXNlcjE5MTkyMTg5","avatar_url":"https://avatars.githubusercontent.com/u/19192189?v=4","gravatar_id":"","url":"https://api.github.com/users/casperisfine","html_url":"https://github.com/casperisfine","followers_url":"https://api.github.com/users/casperisfine/followers","following_url":"https://api.github.com/users/casperisfine/following{/other_user}","gists_url":"https://api.github.com/users/casperisfine/gists{/gist_id}","starred_url":"https://api.github.com/users/casperisfine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/casperisfine/subscriptions","organizations_url":"https://api.github.com/users/casperisfine/orgs","repos_url":"https://api.github.com/users/casperisfine/repos","events_url":"https://api.github.com/users/casperisfine/events{/privacy}","received_events_url":"https://api.github.com/users/casperisfine/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"df74fc6039d5551bdbefebe24fd21f34a577c343","commit_url":"https://api.github.com/repos/byroot/rails/commits/df74fc6039d5551bdbefebe24fd21f34a577c343","created_at":"2022-09-19T07:39:29Z","performed_via_github_app":null},{"id":7411225495,"node_id":"REFE_lADNIULOUfGv1M8AAAABub5Tlw","url":"https://api.github.com/repos/rails/rails/issues/events/7411225495","actor":{"login":"casperisfine","id":19192189,"node_id":"MDQ6VXNlcjE5MTkyMTg5","avatar_url":"https://avatars.githubusercontent.com/u/19192189?v=4","gravatar_id":"","url":"https://api.github.com/users/casperisfine","html_url":"https://github.com/casperisfine","followers_url":"https://api.github.com/users/casperisfine/followers","following_url":"https://api.github.com/users/casperisfine/following{/other_user}","gists_url":"https://api.github.com/users/casperisfine/gists{/gist_id}","starred_url":"https://api.github.com/users/casperisfine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/casperisfine/subscriptions","organizations_url":"https://api.github.com/users/casperisfine/orgs","repos_url":"https://api.github.com/users/casperisfine/repos","events_url":"https://api.github.com/users/casperisfine/events{/privacy}","received_events_url":"https://api.github.com/users/casperisfine/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"5abb45d53ae32f9d80fac5a21fe4cda9b83412a1","commit_url":"https://api.github.com/repos/byroot/rails/commits/5abb45d53ae32f9d80fac5a21fe4cda9b83412a1","created_at":"2022-09-19T07:41:55Z","performed_via_github_app":null},{"id":7411603513,"node_id":"CE_lADNIULOUfGv1M8AAAABucQYOQ","url":"https://api.github.com/repos/rails/rails/issues/events/7411603513","actor":{"login":"byroot","id":44640,"node_id":"MDQ6VXNlcjQ0NjQw","avatar_url":"https://avatars.githubusercontent.com/u/44640?v=4","gravatar_id":"","url":"https://api.github.com/users/byroot","html_url":"https://github.com/byroot","followers_url":"https://api.github.com/users/byroot/followers","following_url":"https://api.github.com/users/byroot/following{/other_user}","gists_url":"https://api.github.com/users/byroot/gists{/gist_id}","starred_url":"https://api.github.com/users/byroot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/byroot/subscriptions","organizations_url":"https://api.github.com/users/byroot/orgs","repos_url":"https://api.github.com/users/byroot/repos","events_url":"https://api.github.com/users/byroot/events{/privacy}","received_events_url":"https://api.github.com/users/byroot/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":"5abb45d53ae32f9d80fac5a21fe4cda9b83412a1","commit_url":"https://api.github.com/repos/rails/rails/commits/5abb45d53ae32f9d80fac5a21fe4cda9b83412a1","created_at":"2022-09-19T08:37:40Z","state_reason":null,"performed_via_github_app":null},{"id":9775017708,"node_id":"REFE_lADNIULOUfGv1M8AAAACRqLu7A","url":"https://api.github.com/repos/rails/rails/issues/events/9775017708","actor":{"login":"casperisfine","id":19192189,"node_id":"MDQ6VXNlcjE5MTkyMTg5","avatar_url":"https://avatars.githubusercontent.com/u/19192189?v=4","gravatar_id":"","url":"https://api.github.com/users/casperisfine","html_url":"https://github.com/casperisfine","followers_url":"https://api.github.com/users/casperisfine/followers","following_url":"https://api.github.com/users/casperisfine/following{/other_user}","gists_url":"https://api.github.com/users/casperisfine/gists{/gist_id}","starred_url":"https://api.github.com/users/casperisfine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/casperisfine/subscriptions","organizations_url":"https://api.github.com/users/casperisfine/orgs","repos_url":"https://api.github.com/users/casperisfine/repos","events_url":"https://api.github.com/users/casperisfine/events{/privacy}","received_events_url":"https://api.github.com/users/casperisfine/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"c14a007959ef4edc5568c90b6d90621c833ac739","commit_url":"https://api.github.com/repos/Shopify/rails/commits/c14a007959ef4edc5568c90b6d90621c833ac739","created_at":"2023-07-10T13:38:01Z","performed_via_github_app":null},{"actor":{"login":"casperisfine","id":19192189,"node_id":"MDQ6VXNlcjE5MTkyMTg5","avatar_url":"https://avatars.githubusercontent.com/u/19192189?v=4","gravatar_id":"","url":"https://api.github.com/users/casperisfine","html_url":"https://github.com/casperisfine","followers_url":"https://api.github.com/users/casperisfine/followers","following_url":"https://api.github.com/users/casperisfine/following{/other_user}","gists_url":"https://api.github.com/users/casperisfine/gists{/gist_id}","starred_url":"https://api.github.com/users/casperisfine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/casperisfine/subscriptions","organizations_url":"https://api.github.com/users/casperisfine/orgs","repos_url":"https://api.github.com/users/casperisfine/repos","events_url":"https://api.github.com/users/casperisfine/events{/privacy}","received_events_url":"https://api.github.com/users/casperisfine/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-07-10T13:41:25Z","updated_at":"2023-07-10T13:41:25Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/rails/rails/issues/48705","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/48705/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/48705/comments","events_url":"https://api.github.com/repos/rails/rails/issues/48705/events","html_url":"https://github.com/rails/rails/pull/48705","id":1796813346,"node_id":"PR_kwDNIULOVRbSwg","number":48705,"title":"Stop deep duping query values of serialized attributes","user":{"login":"casperisfine","id":19192189,"node_id":"MDQ6VXNlcjE5MTkyMTg5","avatar_url":"https://avatars.githubusercontent.com/u/19192189?v=4","gravatar_id":"","url":"https://api.github.com/users/casperisfine","html_url":"https://github.com/casperisfine","followers_url":"https://api.github.com/users/casperisfine/followers","following_url":"https://api.github.com/users/casperisfine/following{/other_user}","gists_url":"https://api.github.com/users/casperisfine/gists{/gist_id}","starred_url":"https://api.github.com/users/casperisfine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/casperisfine/subscriptions","organizations_url":"https://api.github.com/users/casperisfine/orgs","repos_url":"https://api.github.com/users/casperisfine/repos","events_url":"https://api.github.com/users/casperisfine/events{/privacy}","received_events_url":"https://api.github.com/users/casperisfine/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":107190,"node_id":"MDU6TGFiZWwxMDcxOTA=","url":"https://api.github.com/repos/rails/rails/labels/activemodel","name":"activemodel","color":"00E5FF","default":false,"description":null},{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2023-07-10T13:41:25Z","updated_at":"2023-07-13T09:58:35Z","closed_at":"2023-07-13T09:58:35Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":8514,"node_id":"MDEwOlJlcG9zaXRvcnk4NTE0","name":"rails","full_name":"rails/rails","private":false,"owner":{"login":"rails","id":4223,"node_id":"MDEyOk9yZ2FuaXphdGlvbjQyMjM=","avatar_url":"https://avatars.githubusercontent.com/u/4223?v=4","gravatar_id":"","url":"https://api.github.com/users/rails","html_url":"https://github.com/rails","followers_url":"https://api.github.com/users/rails/followers","following_url":"https://api.github.com/users/rails/following{/other_user}","gists_url":"https://api.github.com/users/rails/gists{/gist_id}","starred_url":"https://api.github.com/users/rails/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rails/subscriptions","organizations_url":"https://api.github.com/users/rails/orgs","repos_url":"https://api.github.com/users/rails/repos","events_url":"https://api.github.com/users/rails/events{/privacy}","received_events_url":"https://api.github.com/users/rails/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/rails/rails","description":"Ruby on Rails","fork":false,"url":"https://api.github.com/repos/rails/rails","forks_url":"https://api.github.com/repos/rails/rails/forks","keys_url":"https://api.github.com/repos/rails/rails/keys{/key_id}","collaborators_url":"https://api.github.com/repos/rails/rails/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/rails/rails/teams","hooks_url":"https://api.github.com/repos/rails/rails/hooks","issue_events_url":"https://api.github.com/repos/rails/rails/issues/events{/number}","events_url":"https://api.github.com/repos/rails/rails/events","assignees_url":"https://api.github.com/repos/rails/rails/assignees{/user}","branches_url":"https://api.github.com/repos/rails/rails/branches{/branch}","tags_url":"https://api.github.com/repos/rails/rails/tags","blobs_url":"https://api.github.com/repos/rails/rails/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/rails/rails/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/rails/rails/git/refs{/sha}","trees_url":"https://api.github.com/repos/rails/rails/git/trees{/sha}","statuses_url":"https://api.github.com/repos/rails/rails/statuses/{sha}","languages_url":"https://api.github.com/repos/rails/rails/languages","stargazers_url":"https://api.github.com/repos/rails/rails/stargazers","contributors_url":"https://api.github.com/repos/rails/rails/contributors","subscribers_url":"https://api.github.com/repos/rails/rails/subscribers","subscription_url":"https://api.github.com/repos/rails/rails/subscription","commits_url":"https://api.github.com/repos/rails/rails/commits{/sha}","git_commits_url":"https://api.github.com/repos/rails/rails/git/commits{/sha}","comments_url":"https://api.github.com/repos/rails/rails/comments{/number}","issue_comment_url":"https://api.github.com/repos/rails/rails/issues/comments{/number}","contents_url":"https://api.github.com/repos/rails/rails/contents/{+path}","compare_url":"https://api.github.com/repos/rails/rails/compare/{base}...{head}","merges_url":"https://api.github.com/repos/rails/rails/merges","archive_url":"https://api.github.com/repos/rails/rails/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/rails/rails/downloads","issues_url":"https://api.github.com/repos/rails/rails/issues{/number}","pulls_url":"https://api.github.com/repos/rails/rails/pulls{/number}","milestones_url":"https://api.github.com/repos/rails/rails/milestones{/number}","notifications_url":"https://api.github.com/repos/rails/rails/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/rails/rails/labels{/name}","releases_url":"https://api.github.com/repos/rails/rails/releases{/id}","deployments_url":"https://api.github.com/repos/rails/rails/deployments","created_at":"2008-04-11T02:19:47Z","updated_at":"2025-11-10T02:03:47Z","pushed_at":"2025-11-10T00:33:52Z","git_url":"git://github.com/rails/rails.git","ssh_url":"git@github.com:rails/rails.git","clone_url":"https://github.com/rails/rails.git","svn_url":"https://github.com/rails/rails","homepage":"https://rubyonrails.org","size":271619,"stargazers_count":57840,"watchers_count":57840,"language":"Ruby","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":true,"forks_count":22025,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":1341,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["activejob","activerecord","framework","html","mvc","rails","ruby"],"visibility":"public","forks":22025,"open_issues":1341,"watchers":57840,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/rails/rails/pulls/48705","html_url":"https://github.com/rails/rails/pull/48705","diff_url":"https://github.com/rails/rails/pull/48705.diff","patch_url":"https://github.com/rails/rails/pull/48705.patch","merged_at":null},"body":"Fix: https://github.com/rails/rails/issues/48652\r\nRef: https://github.com/rails/rails/pull/46048\r\nRef: https://github.com/rails/rails/issues/46044\r\nRef: https://github.com/rails/rails/pull/34303\r\nRef: https://github.com/rails/rails/pull/39160\r\n\r\nThis deep_dup was introduced to prevent the value stored in the query cache to be later mutated.\r\n\r\nThe problem is that `ActiveRecord::Base#dup` will return a copy of the record but with the primary key set to nil. One could argue that `#dup` shouldn't behave this way, but I think this ship has sailed (or has it?).\r\n\r\nMy initial fix was to instead call `type.cast` so that we'd dup serialized types in a more correct way. However there is a test that explictly ensure this doesn't happen: https://github.com/rails/rails/pull/39160\r\n\r\nThe reason isn't 100% clear to me, but if I get it correctly, it's to avoid a potentially costly operation upfront.\r\n\r\nSo instead we can call `deserialize(serialize(value))` for serialized attributes only.\r\n\r\nThis isn't very performant, but honestly it's kind of a miracle this even work. Querying by a serialized attribute is a very weird idea.\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/48705/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/48705/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"id":9776133553,"node_id":"REFE_lADNIULOUfGv1M8AAAACRrP1sQ","url":"https://api.github.com/repos/rails/rails/issues/events/9776133553","actor":{"login":"casperisfine","id":19192189,"node_id":"MDQ6VXNlcjE5MTkyMTg5","avatar_url":"https://avatars.githubusercontent.com/u/19192189?v=4","gravatar_id":"","url":"https://api.github.com/users/casperisfine","html_url":"https://github.com/casperisfine","followers_url":"https://api.github.com/users/casperisfine/followers","following_url":"https://api.github.com/users/casperisfine/following{/other_user}","gists_url":"https://api.github.com/users/casperisfine/gists{/gist_id}","starred_url":"https://api.github.com/users/casperisfine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/casperisfine/subscriptions","organizations_url":"https://api.github.com/users/casperisfine/orgs","repos_url":"https://api.github.com/users/casperisfine/repos","events_url":"https://api.github.com/users/casperisfine/events{/privacy}","received_events_url":"https://api.github.com/users/casperisfine/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"0e8f44835f9e94434e9519a2d55e7b5888a9027a","commit_url":"https://api.github.com/repos/Shopify/rails/commits/0e8f44835f9e94434e9519a2d55e7b5888a9027a","created_at":"2023-07-10T15:04:28Z","performed_via_github_app":null},{"id":9787193253,"node_id":"REFE_lADNIULOUfGv1M8AAAACR1y3pQ","url":"https://api.github.com/repos/rails/rails/issues/events/9787193253","actor":{"login":"casperisfine","id":19192189,"node_id":"MDQ6VXNlcjE5MTkyMTg5","avatar_url":"https://avatars.githubusercontent.com/u/19192189?v=4","gravatar_id":"","url":"https://api.github.com/users/casperisfine","html_url":"https://github.com/casperisfine","followers_url":"https://api.github.com/users/casperisfine/followers","following_url":"https://api.github.com/users/casperisfine/following{/other_user}","gists_url":"https://api.github.com/users/casperisfine/gists{/gist_id}","starred_url":"https://api.github.com/users/casperisfine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/casperisfine/subscriptions","organizations_url":"https://api.github.com/users/casperisfine/orgs","repos_url":"https://api.github.com/users/casperisfine/repos","events_url":"https://api.github.com/users/casperisfine/events{/privacy}","received_events_url":"https://api.github.com/users/casperisfine/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"82dce8d4513ccfbb386f7f883170b6d6793b83de","commit_url":"https://api.github.com/repos/Shopify/rails/commits/82dce8d4513ccfbb386f7f883170b6d6793b83de","created_at":"2023-07-11T12:59:36Z","performed_via_github_app":null},{"id":9808079447,"node_id":"REFE_lADNIULOUfGv1M8AAAACSJtqVw","url":"https://api.github.com/repos/rails/rails/issues/events/9808079447","actor":{"login":"casperisfine","id":19192189,"node_id":"MDQ6VXNlcjE5MTkyMTg5","avatar_url":"https://avatars.githubusercontent.com/u/19192189?v=4","gravatar_id":"","url":"https://api.github.com/users/casperisfine","html_url":"https://github.com/casperisfine","followers_url":"https://api.github.com/users/casperisfine/followers","following_url":"https://api.github.com/users/casperisfine/following{/other_user}","gists_url":"https://api.github.com/users/casperisfine/gists{/gist_id}","starred_url":"https://api.github.com/users/casperisfine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/casperisfine/subscriptions","organizations_url":"https://api.github.com/users/casperisfine/orgs","repos_url":"https://api.github.com/users/casperisfine/repos","events_url":"https://api.github.com/users/casperisfine/events{/privacy}","received_events_url":"https://api.github.com/users/casperisfine/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"198fde9221e1ec444f321efd9cf5669e912a861a","commit_url":"https://api.github.com/repos/Shopify/rails/commits/198fde9221e1ec444f321efd9cf5669e912a861a","created_at":"2023-07-13T08:33:07Z","performed_via_github_app":null},{"actor":{"login":"casperisfine","id":19192189,"node_id":"MDQ6VXNlcjE5MTkyMTg5","avatar_url":"https://avatars.githubusercontent.com/u/19192189?v=4","gravatar_id":"","url":"https://api.github.com/users/casperisfine","html_url":"https://github.com/casperisfine","followers_url":"https://api.github.com/users/casperisfine/followers","following_url":"https://api.github.com/users/casperisfine/following{/other_user}","gists_url":"https://api.github.com/users/casperisfine/gists{/gist_id}","starred_url":"https://api.github.com/users/casperisfine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/casperisfine/subscriptions","organizations_url":"https://api.github.com/users/casperisfine/orgs","repos_url":"https://api.github.com/users/casperisfine/repos","events_url":"https://api.github.com/users/casperisfine/events{/privacy}","received_events_url":"https://api.github.com/users/casperisfine/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-07-13T09:03:41Z","updated_at":"2023-07-13T09:03:41Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/rails/rails/issues/48730","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/48730/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/48730/comments","events_url":"https://api.github.com/repos/rails/rails/issues/48730/events","html_url":"https://github.com/rails/rails/pull/48730","id":1802547265,"node_id":"PR_kwDNIULOVWUp7g","number":48730,"title":"Eagerly cast serialized query attributes","user":{"login":"casperisfine","id":19192189,"node_id":"MDQ6VXNlcjE5MTkyMTg5","avatar_url":"https://avatars.githubusercontent.com/u/19192189?v=4","gravatar_id":"","url":"https://api.github.com/users/casperisfine","html_url":"https://github.com/casperisfine","followers_url":"https://api.github.com/users/casperisfine/followers","following_url":"https://api.github.com/users/casperisfine/following{/other_user}","gists_url":"https://api.github.com/users/casperisfine/gists{/gist_id}","starred_url":"https://api.github.com/users/casperisfine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/casperisfine/subscriptions","organizations_url":"https://api.github.com/users/casperisfine/orgs","repos_url":"https://api.github.com/users/casperisfine/repos","events_url":"https://api.github.com/users/casperisfine/events{/privacy}","received_events_url":"https://api.github.com/users/casperisfine/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":107190,"node_id":"MDU6TGFiZWwxMDcxOTA=","url":"https://api.github.com/repos/rails/rails/labels/activemodel","name":"activemodel","color":"00E5FF","default":false,"description":null},{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2023-07-13T09:03:40Z","updated_at":"2023-07-13T10:03:26Z","closed_at":"2023-07-13T09:58:34Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":8514,"node_id":"MDEwOlJlcG9zaXRvcnk4NTE0","name":"rails","full_name":"rails/rails","private":false,"owner":{"login":"rails","id":4223,"node_id":"MDEyOk9yZ2FuaXphdGlvbjQyMjM=","avatar_url":"https://avatars.githubusercontent.com/u/4223?v=4","gravatar_id":"","url":"https://api.github.com/users/rails","html_url":"https://github.com/rails","followers_url":"https://api.github.com/users/rails/followers","following_url":"https://api.github.com/users/rails/following{/other_user}","gists_url":"https://api.github.com/users/rails/gists{/gist_id}","starred_url":"https://api.github.com/users/rails/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rails/subscriptions","organizations_url":"https://api.github.com/users/rails/orgs","repos_url":"https://api.github.com/users/rails/repos","events_url":"https://api.github.com/users/rails/events{/privacy}","received_events_url":"https://api.github.com/users/rails/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/rails/rails","description":"Ruby on Rails","fork":false,"url":"https://api.github.com/repos/rails/rails","forks_url":"https://api.github.com/repos/rails/rails/forks","keys_url":"https://api.github.com/repos/rails/rails/keys{/key_id}","collaborators_url":"https://api.github.com/repos/rails/rails/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/rails/rails/teams","hooks_url":"https://api.github.com/repos/rails/rails/hooks","issue_events_url":"https://api.github.com/repos/rails/rails/issues/events{/number}","events_url":"https://api.github.com/repos/rails/rails/events","assignees_url":"https://api.github.com/repos/rails/rails/assignees{/user}","branches_url":"https://api.github.com/repos/rails/rails/branches{/branch}","tags_url":"https://api.github.com/repos/rails/rails/tags","blobs_url":"https://api.github.com/repos/rails/rails/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/rails/rails/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/rails/rails/git/refs{/sha}","trees_url":"https://api.github.com/repos/rails/rails/git/trees{/sha}","statuses_url":"https://api.github.com/repos/rails/rails/statuses/{sha}","languages_url":"https://api.github.com/repos/rails/rails/languages","stargazers_url":"https://api.github.com/repos/rails/rails/stargazers","contributors_url":"https://api.github.com/repos/rails/rails/contributors","subscribers_url":"https://api.github.com/repos/rails/rails/subscribers","subscription_url":"https://api.github.com/repos/rails/rails/subscription","commits_url":"https://api.github.com/repos/rails/rails/commits{/sha}","git_commits_url":"https://api.github.com/repos/rails/rails/git/commits{/sha}","comments_url":"https://api.github.com/repos/rails/rails/comments{/number}","issue_comment_url":"https://api.github.com/repos/rails/rails/issues/comments{/number}","contents_url":"https://api.github.com/repos/rails/rails/contents/{+path}","compare_url":"https://api.github.com/repos/rails/rails/compare/{base}...{head}","merges_url":"https://api.github.com/repos/rails/rails/merges","archive_url":"https://api.github.com/repos/rails/rails/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/rails/rails/downloads","issues_url":"https://api.github.com/repos/rails/rails/issues{/number}","pulls_url":"https://api.github.com/repos/rails/rails/pulls{/number}","milestones_url":"https://api.github.com/repos/rails/rails/milestones{/number}","notifications_url":"https://api.github.com/repos/rails/rails/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/rails/rails/labels{/name}","releases_url":"https://api.github.com/repos/rails/rails/releases{/id}","deployments_url":"https://api.github.com/repos/rails/rails/deployments","created_at":"2008-04-11T02:19:47Z","updated_at":"2025-11-10T02:03:47Z","pushed_at":"2025-11-10T00:33:52Z","git_url":"git://github.com/rails/rails.git","ssh_url":"git@github.com:rails/rails.git","clone_url":"https://github.com/rails/rails.git","svn_url":"https://github.com/rails/rails","homepage":"https://rubyonrails.org","size":271619,"stargazers_count":57840,"watchers_count":57840,"language":"Ruby","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":true,"forks_count":22025,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":1341,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["activejob","activerecord","framework","html","mvc","rails","ruby"],"visibility":"public","forks":22025,"open_issues":1341,"watchers":57840,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/rails/rails/pulls/48730","html_url":"https://github.com/rails/rails/pull/48730","diff_url":"https://github.com/rails/rails/pull/48730.diff","patch_url":"https://github.com/rails/rails/pull/48730.patch","merged_at":"2023-07-13T09:58:34Z"},"body":"Fix: https://github.com/rails/rails/issues/48652\r\nRef: https://github.com/rails/rails/pull/46048\r\nRef: https://github.com/rails/rails/issues/46044\r\nRef: https://github.com/rails/rails/pull/34303\r\nRef: https://github.com/rails/rails/pull/39160\r\nClose: https://github.com/rails/rails/pull/48705\r\n\r\nThis deep_dup was introduced to prevent the value stored in the query cache to be later mutated.\r\n\r\nThe problem is that `ActiveRecord::Base#dup` will return a copy of the record but with the primary key set to nil. One could argue that `#dup` shouldn't behave this way, but I think this ship has sailed (or has it?).\r\n\r\nMy initial fix was to instead always call `type.cast` eagerly so that we'd dup serialized types in a more correct way. However there is a test that explictly ensure this doesn't happen: https://github.com/rails/rails/pull/39160\r\n\r\nThe reason isn't 100% clear to me, but if I get it correctly, it's to avoid a potentially costly operation upfront.\r\n\r\nSo instead we only eagerly cast serialized attributes only, so protect against future mutations.\r\n\r\nMutable types are still deep duped.\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/48730/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/48730/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"id":9808422670,"node_id":"REFE_lADNIULOUfGv1M8AAAACSKCnDg","url":"https://api.github.com/repos/rails/rails/issues/events/9808422670","actor":{"login":"casperisfine","id":19192189,"node_id":"MDQ6VXNlcjE5MTkyMTg5","avatar_url":"https://avatars.githubusercontent.com/u/19192189?v=4","gravatar_id":"","url":"https://api.github.com/users/casperisfine","html_url":"https://github.com/casperisfine","followers_url":"https://api.github.com/users/casperisfine/followers","following_url":"https://api.github.com/users/casperisfine/following{/other_user}","gists_url":"https://api.github.com/users/casperisfine/gists{/gist_id}","starred_url":"https://api.github.com/users/casperisfine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/casperisfine/subscriptions","organizations_url":"https://api.github.com/users/casperisfine/orgs","repos_url":"https://api.github.com/users/casperisfine/repos","events_url":"https://api.github.com/users/casperisfine/events{/privacy}","received_events_url":"https://api.github.com/users/casperisfine/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"0c148a62eb3cd9c33bfcb3926a5f3baab0f68624","commit_url":"https://api.github.com/repos/Shopify/rails/commits/0c148a62eb3cd9c33bfcb3926a5f3baab0f68624","created_at":"2023-07-13T09:03:59Z","performed_via_github_app":null},{"id":9808909701,"node_id":"REFE_lADNIULOUfGv1M8AAAACSKgVhQ","url":"https://api.github.com/repos/rails/rails/issues/events/9808909701","actor":{"login":"casperisfine","id":19192189,"node_id":"MDQ6VXNlcjE5MTkyMTg5","avatar_url":"https://avatars.githubusercontent.com/u/19192189?v=4","gravatar_id":"","url":"https://api.github.com/users/casperisfine","html_url":"https://github.com/casperisfine","followers_url":"https://api.github.com/users/casperisfine/followers","following_url":"https://api.github.com/users/casperisfine/following{/other_user}","gists_url":"https://api.github.com/users/casperisfine/gists{/gist_id}","starred_url":"https://api.github.com/users/casperisfine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/casperisfine/subscriptions","organizations_url":"https://api.github.com/users/casperisfine/orgs","repos_url":"https://api.github.com/users/casperisfine/repos","events_url":"https://api.github.com/users/casperisfine/events{/privacy}","received_events_url":"https://api.github.com/users/casperisfine/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"29205d7928a2c530aceffde25cb1173c3133857a","commit_url":"https://api.github.com/repos/Shopify/rails/commits/29205d7928a2c530aceffde25cb1173c3133857a","created_at":"2023-07-13T09:45:11Z","performed_via_github_app":null}]