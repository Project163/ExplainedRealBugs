[{"url":"https://api.github.com/repos/rails/rails/issues/comments/1408908293","html_url":"https://github.com/rails/rails/issues/47185#issuecomment-1408908293","issue_url":"https://api.github.com/repos/rails/rails/issues/47185","id":1408908293,"node_id":"IC_kwDNIULOU_o8BQ","user":{"login":"alexandreruban","id":33979976,"node_id":"MDQ6VXNlcjMzOTc5OTc2","avatar_url":"https://avatars.githubusercontent.com/u/33979976?v=4","gravatar_id":"","url":"https://api.github.com/users/alexandreruban","html_url":"https://github.com/alexandreruban","followers_url":"https://api.github.com/users/alexandreruban/followers","following_url":"https://api.github.com/users/alexandreruban/following{/other_user}","gists_url":"https://api.github.com/users/alexandreruban/gists{/gist_id}","starred_url":"https://api.github.com/users/alexandreruban/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alexandreruban/subscriptions","organizations_url":"https://api.github.com/users/alexandreruban/orgs","repos_url":"https://api.github.com/users/alexandreruban/repos","events_url":"https://api.github.com/users/alexandreruban/events{/privacy}","received_events_url":"https://api.github.com/users/alexandreruban/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-01-30T16:12:30Z","updated_at":"2023-01-30T16:12:30Z","body":"I'd love to work on this issue. I found the bug, I'll open a PR later today.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/1408908293/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"alexandreruban","id":33979976,"node_id":"MDQ6VXNlcjMzOTc5OTc2","avatar_url":"https://avatars.githubusercontent.com/u/33979976?v=4","gravatar_id":"","url":"https://api.github.com/users/alexandreruban","html_url":"https://github.com/alexandreruban","followers_url":"https://api.github.com/users/alexandreruban/followers","following_url":"https://api.github.com/users/alexandreruban/following{/other_user}","gists_url":"https://api.github.com/users/alexandreruban/gists{/gist_id}","starred_url":"https://api.github.com/users/alexandreruban/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alexandreruban/subscriptions","organizations_url":"https://api.github.com/users/alexandreruban/orgs","repos_url":"https://api.github.com/users/alexandreruban/repos","events_url":"https://api.github.com/users/alexandreruban/events{/privacy}","received_events_url":"https://api.github.com/users/alexandreruban/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rails/rails/issues/comments/1409060990","html_url":"https://github.com/rails/rails/issues/47185#issuecomment-1409060990","issue_url":"https://api.github.com/repos/rails/rails/issues/47185","id":1409060990,"node_id":"IC_kwDNIULOU_yQfg","user":{"login":"alexandreruban","id":33979976,"node_id":"MDQ6VXNlcjMzOTc5OTc2","avatar_url":"https://avatars.githubusercontent.com/u/33979976?v=4","gravatar_id":"","url":"https://api.github.com/users/alexandreruban","html_url":"https://github.com/alexandreruban","followers_url":"https://api.github.com/users/alexandreruban/followers","following_url":"https://api.github.com/users/alexandreruban/following{/other_user}","gists_url":"https://api.github.com/users/alexandreruban/gists{/gist_id}","starred_url":"https://api.github.com/users/alexandreruban/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alexandreruban/subscriptions","organizations_url":"https://api.github.com/users/alexandreruban/orgs","repos_url":"https://api.github.com/users/alexandreruban/repos","events_url":"https://api.github.com/users/alexandreruban/events{/privacy}","received_events_url":"https://api.github.com/users/alexandreruban/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-01-30T17:51:04Z","updated_at":"2023-01-30T17:51:04Z","body":"@ankane I think what you are looking for is the `ActiveSupport::JsonWithMarshalFallback` serializer.\r\n\r\nThe following example works:\r\n\r\n```rb\r\nclass BugTest < Minitest::Test\r\n  def test_stuff\r\n    key = SecureRandom.hex(64)\r\n    message = ActiveSupport::MessageVerifier.new(key, serializer: Marshal).generate([\"hello\", \"world\"])\r\n\r\n    verifier = ActiveSupport::MessageVerifier.new(key, serializer: ActiveSupport::JsonWithMarshalFallback)\r\n    verifier.rotate(serializer: Marshal)\r\n    assert_equal [\"hello\", \"world\"], verifier.verify(message)\r\n  end\r\nend\r\n```\r\n\r\nLet me know if it helps.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/1409060990/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"alexandreruban","id":33979976,"node_id":"MDQ6VXNlcjMzOTc5OTc2","avatar_url":"https://avatars.githubusercontent.com/u/33979976?v=4","gravatar_id":"","url":"https://api.github.com/users/alexandreruban","html_url":"https://github.com/alexandreruban","followers_url":"https://api.github.com/users/alexandreruban/followers","following_url":"https://api.github.com/users/alexandreruban/following{/other_user}","gists_url":"https://api.github.com/users/alexandreruban/gists{/gist_id}","starred_url":"https://api.github.com/users/alexandreruban/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alexandreruban/subscriptions","organizations_url":"https://api.github.com/users/alexandreruban/orgs","repos_url":"https://api.github.com/users/alexandreruban/repos","events_url":"https://api.github.com/users/alexandreruban/events{/privacy}","received_events_url":"https://api.github.com/users/alexandreruban/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":8390898841,"node_id":"MEE_lADNIULOXRZeLc8AAAAB9CL0mQ","url":"https://api.github.com/repos/rails/rails/issues/events/8390898841","actor":{"login":"ankane","id":220358,"node_id":"MDQ6VXNlcjIyMDM1OA==","avatar_url":"https://avatars.githubusercontent.com/u/220358?v=4","gravatar_id":"","url":"https://api.github.com/users/ankane","html_url":"https://github.com/ankane","followers_url":"https://api.github.com/users/ankane/followers","following_url":"https://api.github.com/users/ankane/following{/other_user}","gists_url":"https://api.github.com/users/ankane/gists{/gist_id}","starred_url":"https://api.github.com/users/ankane/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ankane/subscriptions","organizations_url":"https://api.github.com/users/ankane/orgs","repos_url":"https://api.github.com/users/ankane/repos","events_url":"https://api.github.com/users/ankane/events{/privacy}","received_events_url":"https://api.github.com/users/ankane/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2023-01-30T17:51:04Z","performed_via_github_app":null},{"id":8390898856,"node_id":"SE_lADNIULOXRZeLc8AAAAB9CL0qA","url":"https://api.github.com/repos/rails/rails/issues/events/8390898856","actor":{"login":"ankane","id":220358,"node_id":"MDQ6VXNlcjIyMDM1OA==","avatar_url":"https://avatars.githubusercontent.com/u/220358?v=4","gravatar_id":"","url":"https://api.github.com/users/ankane","html_url":"https://github.com/ankane","followers_url":"https://api.github.com/users/ankane/followers","following_url":"https://api.github.com/users/ankane/following{/other_user}","gists_url":"https://api.github.com/users/ankane/gists{/gist_id}","starred_url":"https://api.github.com/users/ankane/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ankane/subscriptions","organizations_url":"https://api.github.com/users/ankane/orgs","repos_url":"https://api.github.com/users/ankane/repos","events_url":"https://api.github.com/users/ankane/events{/privacy}","received_events_url":"https://api.github.com/users/ankane/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2023-01-30T17:51:04Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/comments/1409244743","html_url":"https://github.com/rails/rails/issues/47185#issuecomment-1409244743","issue_url":"https://api.github.com/repos/rails/rails/issues/47185","id":1409244743,"node_id":"IC_kwDNIULOU_9eRw","user":{"login":"ankane","id":220358,"node_id":"MDQ6VXNlcjIyMDM1OA==","avatar_url":"https://avatars.githubusercontent.com/u/220358?v=4","gravatar_id":"","url":"https://api.github.com/users/ankane","html_url":"https://github.com/ankane","followers_url":"https://api.github.com/users/ankane/followers","following_url":"https://api.github.com/users/ankane/following{/other_user}","gists_url":"https://api.github.com/users/ankane/gists{/gist_id}","starred_url":"https://api.github.com/users/ankane/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ankane/subscriptions","organizations_url":"https://api.github.com/users/ankane/orgs","repos_url":"https://api.github.com/users/ankane/repos","events_url":"https://api.github.com/users/ankane/events{/privacy}","received_events_url":"https://api.github.com/users/ankane/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-01-30T19:54:49Z","updated_at":"2023-01-30T19:54:49Z","body":"Hey @alexandreruban, thanks for the response. That'll work on `main` for those specific serializers, but not the general case. For instance, trying to rotate from YAML to JSON will raise the same error as above, and trying to rotate something to YAML will raise `Psych::SyntaxError: (<unknown>): control characters are not allowed at line 1 column 1`.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/1409244743/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ankane","id":220358,"node_id":"MDQ6VXNlcjIyMDM1OA==","avatar_url":"https://avatars.githubusercontent.com/u/220358?v=4","gravatar_id":"","url":"https://api.github.com/users/ankane","html_url":"https://github.com/ankane","followers_url":"https://api.github.com/users/ankane/followers","following_url":"https://api.github.com/users/ankane/following{/other_user}","gists_url":"https://api.github.com/users/ankane/gists{/gist_id}","starred_url":"https://api.github.com/users/ankane/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ankane/subscriptions","organizations_url":"https://api.github.com/users/ankane/orgs","repos_url":"https://api.github.com/users/ankane/repos","events_url":"https://api.github.com/users/ankane/events{/privacy}","received_events_url":"https://api.github.com/users/ankane/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":8391952418,"node_id":"MEE_lADNIULOXRZeLc8AAAAB9DMIIg","url":"https://api.github.com/repos/rails/rails/issues/events/8391952418","actor":{"login":"alexandreruban","id":33979976,"node_id":"MDQ6VXNlcjMzOTc5OTc2","avatar_url":"https://avatars.githubusercontent.com/u/33979976?v=4","gravatar_id":"","url":"https://api.github.com/users/alexandreruban","html_url":"https://github.com/alexandreruban","followers_url":"https://api.github.com/users/alexandreruban/followers","following_url":"https://api.github.com/users/alexandreruban/following{/other_user}","gists_url":"https://api.github.com/users/alexandreruban/gists{/gist_id}","starred_url":"https://api.github.com/users/alexandreruban/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alexandreruban/subscriptions","organizations_url":"https://api.github.com/users/alexandreruban/orgs","repos_url":"https://api.github.com/users/alexandreruban/repos","events_url":"https://api.github.com/users/alexandreruban/events{/privacy}","received_events_url":"https://api.github.com/users/alexandreruban/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2023-01-30T19:54:49Z","performed_via_github_app":null},{"id":8391952450,"node_id":"SE_lADNIULOXRZeLc8AAAAB9DMIQg","url":"https://api.github.com/repos/rails/rails/issues/events/8391952450","actor":{"login":"alexandreruban","id":33979976,"node_id":"MDQ6VXNlcjMzOTc5OTc2","avatar_url":"https://avatars.githubusercontent.com/u/33979976?v=4","gravatar_id":"","url":"https://api.github.com/users/alexandreruban","html_url":"https://github.com/alexandreruban","followers_url":"https://api.github.com/users/alexandreruban/followers","following_url":"https://api.github.com/users/alexandreruban/following{/other_user}","gists_url":"https://api.github.com/users/alexandreruban/gists{/gist_id}","starred_url":"https://api.github.com/users/alexandreruban/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alexandreruban/subscriptions","organizations_url":"https://api.github.com/users/alexandreruban/orgs","repos_url":"https://api.github.com/users/alexandreruban/repos","events_url":"https://api.github.com/users/alexandreruban/events{/privacy}","received_events_url":"https://api.github.com/users/alexandreruban/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2023-01-30T19:54:49Z","performed_via_github_app":null},{"id":8474044811,"node_id":"REFE_lADNIULOXRZeLc8AAAAB-Repiw","url":"https://api.github.com/repos/rails/rails/issues/events/8474044811","actor":{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"66f9b70d37e221655fc2777fe457cfa2c4de5a01","commit_url":"https://api.github.com/repos/jonathanhefner/rails/commits/66f9b70d37e221655fc2777fe457cfa2c4de5a01","created_at":"2023-02-08T23:42:01Z","performed_via_github_app":null},{"actor":{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-02-08T23:48:43Z","updated_at":"2023-02-08T23:48:43Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/rails/rails/issues/47326","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/47326/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/47326/comments","events_url":"https://api.github.com/repos/rails/rails/issues/47326/events","html_url":"https://github.com/rails/rails/pull/47326","id":1576969442,"node_id":"PR_kwDNIULOSZH34g","number":47326,"title":"Use `throw` for message error handling control flow","user":{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2023-02-08T23:48:43Z","updated_at":"2023-02-12T21:50:51Z","closed_at":"2023-02-12T21:50:51Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":8514,"node_id":"MDEwOlJlcG9zaXRvcnk4NTE0","name":"rails","full_name":"rails/rails","private":false,"owner":{"login":"rails","id":4223,"node_id":"MDEyOk9yZ2FuaXphdGlvbjQyMjM=","avatar_url":"https://avatars.githubusercontent.com/u/4223?v=4","gravatar_id":"","url":"https://api.github.com/users/rails","html_url":"https://github.com/rails","followers_url":"https://api.github.com/users/rails/followers","following_url":"https://api.github.com/users/rails/following{/other_user}","gists_url":"https://api.github.com/users/rails/gists{/gist_id}","starred_url":"https://api.github.com/users/rails/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rails/subscriptions","organizations_url":"https://api.github.com/users/rails/orgs","repos_url":"https://api.github.com/users/rails/repos","events_url":"https://api.github.com/users/rails/events{/privacy}","received_events_url":"https://api.github.com/users/rails/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/rails/rails","description":"Ruby on Rails","fork":false,"url":"https://api.github.com/repos/rails/rails","forks_url":"https://api.github.com/repos/rails/rails/forks","keys_url":"https://api.github.com/repos/rails/rails/keys{/key_id}","collaborators_url":"https://api.github.com/repos/rails/rails/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/rails/rails/teams","hooks_url":"https://api.github.com/repos/rails/rails/hooks","issue_events_url":"https://api.github.com/repos/rails/rails/issues/events{/number}","events_url":"https://api.github.com/repos/rails/rails/events","assignees_url":"https://api.github.com/repos/rails/rails/assignees{/user}","branches_url":"https://api.github.com/repos/rails/rails/branches{/branch}","tags_url":"https://api.github.com/repos/rails/rails/tags","blobs_url":"https://api.github.com/repos/rails/rails/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/rails/rails/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/rails/rails/git/refs{/sha}","trees_url":"https://api.github.com/repos/rails/rails/git/trees{/sha}","statuses_url":"https://api.github.com/repos/rails/rails/statuses/{sha}","languages_url":"https://api.github.com/repos/rails/rails/languages","stargazers_url":"https://api.github.com/repos/rails/rails/stargazers","contributors_url":"https://api.github.com/repos/rails/rails/contributors","subscribers_url":"https://api.github.com/repos/rails/rails/subscribers","subscription_url":"https://api.github.com/repos/rails/rails/subscription","commits_url":"https://api.github.com/repos/rails/rails/commits{/sha}","git_commits_url":"https://api.github.com/repos/rails/rails/git/commits{/sha}","comments_url":"https://api.github.com/repos/rails/rails/comments{/number}","issue_comment_url":"https://api.github.com/repos/rails/rails/issues/comments{/number}","contents_url":"https://api.github.com/repos/rails/rails/contents/{+path}","compare_url":"https://api.github.com/repos/rails/rails/compare/{base}...{head}","merges_url":"https://api.github.com/repos/rails/rails/merges","archive_url":"https://api.github.com/repos/rails/rails/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/rails/rails/downloads","issues_url":"https://api.github.com/repos/rails/rails/issues{/number}","pulls_url":"https://api.github.com/repos/rails/rails/pulls{/number}","milestones_url":"https://api.github.com/repos/rails/rails/milestones{/number}","notifications_url":"https://api.github.com/repos/rails/rails/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/rails/rails/labels{/name}","releases_url":"https://api.github.com/repos/rails/rails/releases{/id}","deployments_url":"https://api.github.com/repos/rails/rails/deployments","created_at":"2008-04-11T02:19:47Z","updated_at":"2025-11-10T02:03:47Z","pushed_at":"2025-11-10T00:33:52Z","git_url":"git://github.com/rails/rails.git","ssh_url":"git@github.com:rails/rails.git","clone_url":"https://github.com/rails/rails.git","svn_url":"https://github.com/rails/rails","homepage":"https://rubyonrails.org","size":271619,"stargazers_count":57840,"watchers_count":57840,"language":"Ruby","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":true,"forks_count":22025,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":1341,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["activejob","activerecord","framework","html","mvc","rails","ruby"],"visibility":"public","forks":22025,"open_issues":1341,"watchers":57840,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/rails/rails/pulls/47326","html_url":"https://github.com/rails/rails/pull/47326","diff_url":"https://github.com/rails/rails/pull/47326.diff","patch_url":"https://github.com/rails/rails/pull/47326.patch","merged_at":"2023-02-12T21:50:51Z"},"body":"There are multiple points of failure when processing a message with `MessageEncryptor` or `MessageVerifier`, and there several ways we might want to handle those failures.  For example, swallowing a failure with `MessageVerifier#verified`, or raising a specific exception with `MessageVerifier#verify`, or conditionally ignoring a failure when rotations are configured.\r\n\r\nPrior to this commit, the _internal_ logic of handling failures was implemented using a mix of `nil` return values and raised exceptions. This commit reimplements the internal logic using `throw` and a few precisely targeted `rescue`s.  This accomplishes several things:\r\n\r\n* Allow rotation of serializers for `MessageVerifier`.  Previously, errors from a `MessageVerifier`'s initial serializer were never rescued.  Thus, the serializer could not be rotated:\r\n\r\n    ```ruby\r\n    old_verifier = ActiveSupport::MessageVerifier.new(\"secret\", serializer: Marshal)\r\n    new_verifier = ActiveSupport::MessageVerifier.new(\"secret\", serializer: JSON)\r\n    new_verifier.rotate(serializer: Marshal)\r\n\r\n    message = old_verifier.generate(\"message\")\r\n\r\n    new_verifier.verify(message)\r\n    # BEFORE:\r\n    # => raises JSON::ParserError\r\n    # AFTER:\r\n    # => \"message\"\r\n    ```\r\n\r\n* Allow rotation of serializers for `MessageEncryptor` when using a non-standard initial serializer.  Similar to `MessageVerifier`, the serializer could not be rotated when the initial serializer raised an error other than `TypeError` and `JSON::ParserError`, such as `Psych::SyntaxError` or a custom error.\r\n\r\n* Raise `MessageEncryptor::InvalidMessage` from `decrypt_and_verify` regardless of cipher.  Previously, when a `MessageEncryptor` was using a non-AEAD cipher such as AES-256-CBC, a corrupt or tampered message would raise `MessageVerifier::InvalidSignature` due to reliance on `MessageVerifier` for verification.  Now, the verification mechanism is transparent to the user:\r\n\r\n    ```ruby\r\n    encryptor = ActiveSupport::MessageEncryptor.new(\"x\" * 32, cipher: \"aes-256-gcm\")\r\n    message = encryptor.encrypt_and_sign(\"message\")\r\n    encryptor.decrypt_and_verify(message.next)\r\n    # => raises ActiveSupport::MessageEncryptor::InvalidMessage\r\n\r\n    encryptor = ActiveSupport::MessageEncryptor.new(\"x\" * 32, cipher: \"aes-256-cbc\")\r\n    message = encryptor.encrypt_and_sign(\"message\")\r\n    encryptor.decrypt_and_verify(message.next)\r\n    # BEFORE:\r\n    # => raises ActiveSupport::MessageVerifier::InvalidSignature\r\n    # AFTER:\r\n    # => raises ActiveSupport::MessageEncryptor::InvalidMessage\r\n    ```\r\n\r\n* Support `nil` original value when using `MessageVerifier#verify`. Previously, `MessageVerifier#verify` did not work with `nil` original values, though both `MessageVerifier#verified` and `MessageEncryptor#decrypt_and_verify` do:\r\n\r\n    ```ruby\r\n    encryptor = ActiveSupport::MessageEncryptor.new(\"x\" * 32)\r\n    message = encryptor.encrypt_and_sign(nil)\r\n\r\n    encryptor.decrypt_and_verify(message)\r\n    # => nil\r\n\r\n    verifier = ActiveSupport::MessageVerifier.new(\"secret\")\r\n    message = verifier.generate(nil)\r\n\r\n    verifier.verified(message)\r\n    # => nil\r\n\r\n    verifier.verify(message)\r\n    # BEFORE:\r\n    # => raises ActiveSupport::MessageVerifier::InvalidSignature\r\n    # AFTER:\r\n    # => nil\r\n    ```\r\n\r\n* Improve performance of verifying a message when it has expired and one or more rotations have been configured:\r\n\r\n    ```ruby\r\n    # frozen_string_literal: true\r\n    require \"benchmark/ips\"\r\n    require \"active_support/all\"\r\n\r\n    verifier = ActiveSupport::MessageVerifier.new(\"new secret\")\r\n    verifier.rotate(\"old secret\")\r\n\r\n    message = verifier.generate({ \"data\" => \"x\" * 100 }, expires_at: 1.day.ago)\r\n\r\n    Benchmark.ips do |x|\r\n      x.report(\"expired message\") do\r\n        verifier.verified(message)\r\n      end\r\n    end\r\n    ```\r\n\r\n  __Before__\r\n\r\n    ```\r\n    Warming up --------------------------------------\r\n         expired message     1.442k i/100ms\r\n    Calculating -------------------------------------\r\n         expired message     14.403k (± 1.7%) i/s -     72.100k in   5.007382s\r\n    ```\r\n\r\n  __After__\r\n\r\n    ```\r\n    Warming up --------------------------------------\r\n         expired message     1.995k i/100ms\r\n    Calculating -------------------------------------\r\n         expired message     19.992k (± 2.0%) i/s -    101.745k in   5.091421s\r\n    ```\r\n\r\nFixes #47185.\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/47326/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/47326/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"id":8474077298,"node_id":"REFE_lADNIULOXRZeLc8AAAAB-Rgocg","url":"https://api.github.com/repos/rails/rails/issues/events/8474077298","actor":{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"a5b0e4d7b510ef50134d6d8df59863a55d355077","commit_url":"https://api.github.com/repos/jonathanhefner/rails/commits/a5b0e4d7b510ef50134d6d8df59863a55d355077","created_at":"2023-02-08T23:49:04Z","performed_via_github_app":null},{"id":8481667644,"node_id":"REFE_lADNIULOXRZeLc8AAAAB-Yv6PA","url":"https://api.github.com/repos/rails/rails/issues/events/8481667644","actor":{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"34390e4d83c0fd716d164df3b267d389ab199408","commit_url":"https://api.github.com/repos/jonathanhefner/rails/commits/34390e4d83c0fd716d164df3b267d389ab199408","created_at":"2023-02-09T16:51:22Z","performed_via_github_app":null},{"id":8485667657,"node_id":"LE_lADNIULOXRZeLc8AAAAB-ckDSQ","url":"https://api.github.com/repos/rails/rails/issues/events/8485667657","actor":{"login":"zzak","id":277819,"node_id":"MDQ6VXNlcjI3NzgxOQ==","avatar_url":"https://avatars.githubusercontent.com/u/277819?v=4","gravatar_id":"","url":"https://api.github.com/users/zzak","html_url":"https://github.com/zzak","followers_url":"https://api.github.com/users/zzak/followers","following_url":"https://api.github.com/users/zzak/following{/other_user}","gists_url":"https://api.github.com/users/zzak/gists{/gist_id}","starred_url":"https://api.github.com/users/zzak/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zzak/subscriptions","organizations_url":"https://api.github.com/users/zzak/orgs","repos_url":"https://api.github.com/users/zzak/repos","events_url":"https://api.github.com/users/zzak/events{/privacy}","received_events_url":"https://api.github.com/users/zzak/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2023-02-10T03:15:12Z","label":{"name":"attached PR","color":"006b75"},"performed_via_github_app":null},{"id":8485668184,"node_id":"LE_lADNIULOXRZeLc8AAAAB-ckFWA","url":"https://api.github.com/repos/rails/rails/issues/events/8485668184","actor":{"login":"zzak","id":277819,"node_id":"MDQ6VXNlcjI3NzgxOQ==","avatar_url":"https://avatars.githubusercontent.com/u/277819?v=4","gravatar_id":"","url":"https://api.github.com/users/zzak","html_url":"https://github.com/zzak","followers_url":"https://api.github.com/users/zzak/followers","following_url":"https://api.github.com/users/zzak/following{/other_user}","gists_url":"https://api.github.com/users/zzak/gists{/gist_id}","starred_url":"https://api.github.com/users/zzak/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zzak/subscriptions","organizations_url":"https://api.github.com/users/zzak/orgs","repos_url":"https://api.github.com/users/zzak/repos","events_url":"https://api.github.com/users/zzak/events{/privacy}","received_events_url":"https://api.github.com/users/zzak/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2023-02-10T03:15:22Z","label":{"name":"activesupport","color":"FC9300"},"performed_via_github_app":null},{"id":8499035663,"node_id":"REFE_lADNIULOXRZeLc8AAAAB-pT-Dw","url":"https://api.github.com/repos/rails/rails/issues/events/8499035663","actor":{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"d3917f5fdd73630b40b6acec8cd1de8b01cad14a","commit_url":"https://api.github.com/repos/jonathanhefner/rails/commits/d3917f5fdd73630b40b6acec8cd1de8b01cad14a","created_at":"2023-02-12T21:25:04Z","performed_via_github_app":null},{"id":8499069918,"node_id":"CE_lADNIULOXRZeLc8AAAAB-pWD3g","url":"https://api.github.com/repos/rails/rails/issues/events/8499069918","actor":{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2023-02-12T21:50:52Z","state_reason":null,"performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/comments/1428390672","html_url":"https://github.com/rails/rails/issues/47185#issuecomment-1428390672","issue_url":"https://api.github.com/repos/rails/rails/issues/47185","id":1428390672,"node_id":"IC_kwDNIULOVSODEA","user":{"login":"ankane","id":220358,"node_id":"MDQ6VXNlcjIyMDM1OA==","avatar_url":"https://avatars.githubusercontent.com/u/220358?v=4","gravatar_id":"","url":"https://api.github.com/users/ankane","html_url":"https://github.com/ankane","followers_url":"https://api.github.com/users/ankane/followers","following_url":"https://api.github.com/users/ankane/following{/other_user}","gists_url":"https://api.github.com/users/ankane/gists{/gist_id}","starred_url":"https://api.github.com/users/ankane/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ankane/subscriptions","organizations_url":"https://api.github.com/users/ankane/orgs","repos_url":"https://api.github.com/users/ankane/repos","events_url":"https://api.github.com/users/ankane/events{/privacy}","received_events_url":"https://api.github.com/users/ankane/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-02-13T17:46:27Z","updated_at":"2023-02-13T17:46:27Z","body":"Thanks @jonathanhefner for both the fix and additional improvements!","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/1428390672/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":1,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ankane","id":220358,"node_id":"MDQ6VXNlcjIyMDM1OA==","avatar_url":"https://avatars.githubusercontent.com/u/220358?v=4","gravatar_id":"","url":"https://api.github.com/users/ankane","html_url":"https://github.com/ankane","followers_url":"https://api.github.com/users/ankane/followers","following_url":"https://api.github.com/users/ankane/following{/other_user}","gists_url":"https://api.github.com/users/ankane/gists{/gist_id}","starred_url":"https://api.github.com/users/ankane/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ankane/subscriptions","organizations_url":"https://api.github.com/users/ankane/orgs","repos_url":"https://api.github.com/users/ankane/repos","events_url":"https://api.github.com/users/ankane/events{/privacy}","received_events_url":"https://api.github.com/users/ankane/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":8507221635,"node_id":"MEE_lADNIULOXRZeLc8AAAAB-xHmgw","url":"https://api.github.com/repos/rails/rails/issues/events/8507221635","actor":{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2023-02-13T17:46:28Z","performed_via_github_app":null},{"id":8507221658,"node_id":"SE_lADNIULOXRZeLc8AAAAB-xHmmg","url":"https://api.github.com/repos/rails/rails/issues/events/8507221658","actor":{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2023-02-13T17:46:28Z","performed_via_github_app":null}]