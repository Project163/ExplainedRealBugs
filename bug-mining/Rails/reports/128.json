{"url":"https://api.github.com/repos/rails/rails/issues/52522","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/52522/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/52522/comments","events_url":"https://api.github.com/repos/rails/rails/issues/52522/events","html_url":"https://github.com/rails/rails/issues/52522","id":2451594299,"node_id":"I_kwDNIULOkiBcOw","number":52522,"title":"Usage of available_processor_count in default puma config leads to excessive number of puma workers in hosting platforms with shared vCPU management and containerized environment","user":{"login":"denys-chaikovskyi","id":12110348,"node_id":"MDQ6VXNlcjEyMTEwMzQ4","avatar_url":"https://avatars.githubusercontent.com/u/12110348?v=4","gravatar_id":"","url":"https://api.github.com/users/denys-chaikovskyi","html_url":"https://github.com/denys-chaikovskyi","followers_url":"https://api.github.com/users/denys-chaikovskyi/followers","following_url":"https://api.github.com/users/denys-chaikovskyi/following{/other_user}","gists_url":"https://api.github.com/users/denys-chaikovskyi/gists{/gist_id}","starred_url":"https://api.github.com/users/denys-chaikovskyi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/denys-chaikovskyi/subscriptions","organizations_url":"https://api.github.com/users/denys-chaikovskyi/orgs","repos_url":"https://api.github.com/users/denys-chaikovskyi/repos","events_url":"https://api.github.com/users/denys-chaikovskyi/events{/privacy}","received_events_url":"https://api.github.com/users/denys-chaikovskyi/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":11,"created_at":"2024-08-06T19:56:58Z","updated_at":"2024-08-07T18:48:04Z","closed_at":"2024-08-07T18:48:04Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description\r\n\r\nThe default Puma configuration in Rails 7.1.3.4 leverages the `Concurrent.physical_processor_count` to automatically detect a number of Puma workers that can be spawned by default based on available CPUs.\r\n\r\nI see that it was later removed ([commit](https://github.com/rails/rails/commit/06d614ada9e4609ff83659e842f48af3232a03a5)) and recently `Concurrent.available_processor_count` was added instead ([commit](https://github.com/rails/rails/commit/f719787c582839fd2fcd886d70b43da3ddad2ceb)), which is a group-aware method to detect how many processors we can actually use on various shared hosting platforms.\r\n\r\nI tried using both `Concurrent.physical_processor_count` and `Concurrent.available_processor_count` on an instance of Digital Ocean App Platform with 1 shared vCPU and 2GB RAM. Unfortunately, both methods failed to identify a real count of available CPUs spawning too many workers, which leads to excessive RAM usage (70-95% with minimal user activity) and degraded performance.\r\n\r\n### Steps to reproduce\r\n1. Deploy a Rails application on the Digital Ocean App Platform with 1 shared vCPU and 2GB RAM connected to the managed database. (The \"App Platform\" is a Paas from DO that is similar to Heroku) \r\n![CleanShot 2024-08-06 at 19 48 15@2x](https://github.com/user-attachments/assets/09720fab-3592-496b-9b23-87077e325db4)\r\n\r\n2. Use the default `puma.rb` configuration provided by Rails 7.2.0.rc1 (which uses  `Concurrent.available_processor_count` method)\r\n\r\n3. Open Digital Ocean App Platform instance's console and check the number of spawned workers with a command like `ps aux --sort=-%mem | head -n 10` \r\n\r\n4. Launch the Rails console within the same console session and check what value `Concurrent.available_processor_count` returns.\r\n\r\n\r\n### Expected behavior\r\nFor Digital Ocean App Platform instance with 1 shared vCPU, puma.rb should not spawn multiple puma workers. `workers_count` should be 1.\r\n\r\nIn my experience of running a similar fresh new MVP (minimal user usage) with similar setup, RAM usage should be in the range of 15-25%.\r\n\r\n### Actual behavior\r\nThe number of Puma workers is set incorrectly for shared virtual CPU, spawning too many workers, which leads to excessive RAM usage (70-95% with minimal user activity) and degraded performance.\r\n\r\nIn my case I got 8 puma workers:\r\n```bash\r\nrails@appname:/rails$ ps aux --sort=-%mem | head -n 10\r\nUSER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND\r\nrails       69  0.0 15.3 905500 321880 ?       Sl   Aug05   0:53 puma: cluster worker 6: 1 [rails]\r\nrails       35  0.0 15.1 896668 317424 ?       Sl   Aug05   0:47 puma: cluster worker 0: 1 [rails]\r\nrails       51  0.0 15.1 901404 317372 ?       Sl   Aug05   0:41 puma: cluster worker 4: 1 [rails]\r\nrails       38  0.0 15.1 902428 317012 ?       Sl   Aug05   0:56 puma: cluster worker 1: 1 [rails]\r\nrails       76  0.0 14.8 895752 312028 ?       Sl   Aug05   0:20 puma: cluster worker 7: 1 [rails]\r\nrails       45  0.0 14.8 894024 311368 ?       Sl   Aug05   0:21 puma: cluster worker 3: 1 [rails]\r\nrails       61  0.0 14.7 896604 310340 ?       Sl   Aug05   0:53 puma: cluster worker 5: 1 [rails]\r\nrails       40  0.0 13.9 876552 292144 ?       Sl   Aug05   0:19 puma: cluster worker 2: 1 [rails]\r\nrails        1  0.0 10.4 808944 218888 ?       Ssl  Aug05   0:34 puma 6.4.2 (tcp://0.0.0.0:3000) [rails]\r\n```\r\nBy running Rails console within an instance I can see that both `available_processor_count` and `physical_processor_count` returns number of available CPUs as `8`\r\n\r\n```\r\nirb(main):001> Concurrent.available_processor_count\r\n=> 8.0\r\n\r\nirb(main):002> Concurrent.physical_processor_count\r\n=> 8\r\n```\r\n\r\nFrom my reading of DO docs, the instance described above doesn't provide a real 8 cores. It most likely shares them among many customers. \r\n\r\n### System configuration\r\n**Ruby version**: 3.3.4\r\n**Rails Version**: 7.2.0.rc1 (experiencing same issue in 7.1.3.4)\r\n**Puma Version**: 6.4.2\r\n**concurrent-ruby version**: 1.3.3\r\n**Hosting Platform**: DigitalOcean App Platform (Docker based)\r\n**Environment**: Production\r\n\r\n### Additional information\r\n\r\nI'm not sure which mechanism DO App Platform utilizes to manage shared virtual CPUs. \r\n\r\nMy assumption is that either accurate cgroud quota information is not available for reading within their Docker container or they use another mechanism for managing shared CPUs across customers. \r\n\r\nFor cgroup quota, my instance shows the following:\r\n```\r\n$ cat /sys/fs/cgroup/cpu/cpu.cfs_quota_us\r\n-1\r\n```\r\n-1, from my reading, means no limit on CPU usage. Considering this is a value within the Docker container, it doesnâ€™t necessarily mean there are no limits. My assumption is that a similar issue can occur in other Paas platforms with containerized/virtualized environments.\r\n\r\nI think it's a great idea to automatically set the number of Puma workers based on available CPU cores. However, this can be problematic in containerized environments and some PaaS instances with shared CPUs.\r\n\r\nIf my understanding of the this issue is correct, my concern is that the current default puma.rb configuration might overwhelm new users deploying their first Rails apps on low-resource instances without prior experience and expectations about how much resources a simple Rails app is supposed to consume. This could discourage them from working with a wonderful Rails ecosystem.\r\n\r\nAlthough, we can partially mitigate the issue by also considering available RAM by using something like gem 'sys-memory' when deciding how many puma workers to start. Reading the number of available CPU cores with `Concurrent.available_processor_count` still won't be very accurate on certain platforms with virtualized environments where cgroup quota is not available for reading within the container or when an alternative CPU management mechanism is used. \r\n\r\ncc: @byroot, @dhh \r\n\r\n## P.S.\r\n\r\nIf I missed or misunderstood something, I would appreciate any clarification.\r\n\r\nThanks!\r\n","closed_by":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/52522/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/52522/timeline","performed_via_github_app":null,"state_reason":"completed"}