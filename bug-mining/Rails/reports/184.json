{"url":"https://api.github.com/repos/rails/rails/issues/54471","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/54471/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/54471/comments","events_url":"https://api.github.com/repos/rails/rails/issues/54471/events","html_url":"https://github.com/rails/rails/issues/54471","id":2840036788,"node_id":"I_kwDNIULOqUeFtA","number":54471,"title":"PostgreSQL-only schema definition (`t.exclusion_constraint`, `t.unique_constraint`) fails when using keyword arguments.","user":{"login":"wata727","id":9624059,"node_id":"MDQ6VXNlcjk2MjQwNTk=","avatar_url":"https://avatars.githubusercontent.com/u/9624059?v=4","gravatar_id":"","url":"https://api.github.com/users/wata727","html_url":"https://github.com/wata727","followers_url":"https://api.github.com/users/wata727/followers","following_url":"https://api.github.com/users/wata727/following{/other_user}","gists_url":"https://api.github.com/users/wata727/gists{/gist_id}","starred_url":"https://api.github.com/users/wata727/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wata727/subscriptions","organizations_url":"https://api.github.com/users/wata727/orgs","repos_url":"https://api.github.com/users/wata727/repos","events_url":"https://api.github.com/users/wata727/events{/privacy}","received_events_url":"https://api.github.com/users/wata727/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2025-02-08T14:33:45Z","updated_at":"2025-02-08T16:10:48Z","closed_at":"2025-02-08T16:10:48Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"If you use keyword arguments in PostgreSQL-only schema definitions such as `t.exclusion_constraint` or `t.unique_constraint`, migrations will always fail with `ArgumentError`.\n\n### Steps to reproduce\n<!-- (Guidelines for creating a bug report are [available\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\n\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\n```ruby\n# frozen_string_literal: true\n\nrequire \"bundler/inline\"\n\ngemfile(true) do\n  source \"https://rubygems.org\"\n\n  gem \"rails\", \"8.0.1\"\n  # gem \"rails\", path: \"./rails\"\n\n  gem \"pg\", \"1.5.9\"\nend\n\nrequire \"active_record\"\nrequire \"minitest/autorun\"\nrequire \"logger\"\n\nActiveRecord::Base.establish_connection(\n  adapter: \"postgresql\",\n  host: \"127.0.0.1\",\n  username: \"postgres\",\n  password: \"postgres\"\n)\nActiveRecord::Base.logger = Logger.new(STDOUT)\n\nActiveRecord::Schema.define do\n  create_table :invoices, force: true do |t|\n    t.date :start_date\n    t.date :end_date\n  end\n\n  create_table :sections, force: true do |t|\n    t.integer :position\n  end\nend\n\nclass AddExclusionConstraint < ActiveRecord::Migration::Current\n  def change\n    change_table :invoices do |t|\n      t.exclusion_constraint \"daterange(start_date, end_date) WITH &&\", using: \"gist\", name: \"date_overlap\"\n    end\n  end\nend\n\nclass AddUniqueConstraint < ActiveRecord::Migration::Current\n  def change\n    change_table :sections do |t|\n      t.unique_constraint :position, name: \"position_uniqueness\"\n    end\n  end\nend\n\nclass BugTest < Minitest::Test\n  def test_add_exclusion_constraint\n    AddExclusionConstraint.migrate(:up)\n  end\n\n  def test_add_unique_constraint\n    AddUniqueConstraint.migrate(:up)\n  end\nend\n```\n\n### Expected behavior\n```\n# Running:\n\n==  AddUniqueConstraint: migrating ============================================\n-- change_table(:sections)\nD, [2025-02-08T13:45:51.301564 #7951] DEBUG -- :    (1.3ms)  ALTER TABLE \"sections\" ADD CONSTRAINT \"position_uniqueness\" UNIQUE (\"position\")\n   -> 0.0018s\n==  AddUniqueConstraint: migrated (0.0018s) ===================================\n\n.==  AddExclusionConstraint: migrating =========================================\n-- change_table(:invoices)\nD, [2025-02-08T13:45:51.303630 #7951] DEBUG -- :    (1.3ms)  ALTER TABLE \"invoices\" ADD CONSTRAINT \"date_overlap\" EXCLUDE USING gist (daterange(start_date, end_date) WITH &&)\n   -> 0.0015s\n==  AddExclusionConstraint: migrated (0.0017s) ================================\n\n.\n\nFinished in 0.005328s, 375.3779 runs/s, 0.0000 assertions/s.\n\n2 runs, 0 assertions, 0 failures, 0 errors, 0 skips\n```\n\n### Actual behavior\n```\n# Running:\n\n==  AddExclusionConstraint: migrating =========================================\n-- change_table(:invoices)\nE==  AddUniqueConstraint: migrating ============================================\n-- change_table(:sections)\nE\n\nFinished in 0.002145s, 932.5879 runs/s, 0.0000 assertions/s.\n\n  1) Error:\nBugTest#test_add_exclusion_constraint:\nArgumentError: wrong number of arguments (given 3, expected 2)\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/connection_adapters/postgresql/schema_statements.rb:745:in `add_exclusion_constraint'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/connection_adapters/postgresql/schema_definitions.rb:312:in `exclusion_constraint'\n    test.rb:40:in `block in change'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/migration.rb:590:in `block in change_table'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/connection_adapters/abstract/schema_statements.rb:516:in `change_table'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/migration/default_strategy.rb:10:in `method_missing'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/migration.rb:1056:in `block in method_missing'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/migration.rb:1022:in `block in say_with_time'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activesupport-8.0.1/lib/active_support/benchmark.rb:17:in `realtime'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/migration.rb:1022:in `say_with_time'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/migration.rb:1045:in `method_missing'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/migration.rb:590:in `change_table'\n    test.rb:39:in `change'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/migration.rb:991:in `exec_migration'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/migration.rb:975:in `block (2 levels) in migrate'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activesupport-8.0.1/lib/active_support/benchmark.rb:17:in `realtime'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/migration.rb:974:in `block in migrate'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/connection_adapters/abstract/connection_pool.rb:412:in `with_connection'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/migration.rb:973:in `migrate'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/migration.rb:728:in `migrate'\n    test.rb:55:in `test_add_exclusion_constraint'\n\n  2) Error:\nBugTest#test_add_unique_constraint:\nArgumentError: wrong number of arguments (given 3, expected 1..2)\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/connection_adapters/postgresql/schema_statements.rb:796:in `add_unique_constraint'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/connection_adapters/postgresql/schema_definitions.rb:330:in `unique_constraint'\n    test.rb:48:in `block in change'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/migration.rb:590:in `block in change_table'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/connection_adapters/abstract/schema_statements.rb:516:in `change_table'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/migration/default_strategy.rb:10:in `method_missing'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/migration.rb:1056:in `block in method_missing'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/migration.rb:1022:in `block in say_with_time'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activesupport-8.0.1/lib/active_support/benchmark.rb:17:in `realtime'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/migration.rb:1022:in `say_with_time'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/migration.rb:1045:in `method_missing'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/migration.rb:590:in `change_table'\n    test.rb:47:in `change'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/migration.rb:991:in `exec_migration'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/migration.rb:975:in `block (2 levels) in migrate'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activesupport-8.0.1/lib/active_support/benchmark.rb:17:in `realtime'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/migration.rb:974:in `block in migrate'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/connection_adapters/abstract/connection_pool.rb:412:in `with_connection'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/migration.rb:973:in `migrate'\n    /usr/local/rvm/gems/ruby-3.3.4/gems/activerecord-8.0.1/lib/active_record/migration.rb:728:in `migrate'\n    test.rb:59:in `test_add_unique_constraint'\n\n2 runs, 0 assertions, 0 failures, 2 errors, 0 skips\n```\n\n### System configuration\n**Rails version**: 8.0.1\n\n**Ruby version**: 3.3.4\n","closed_by":{"login":"fatkodima","id":5657035,"node_id":"MDQ6VXNlcjU2NTcwMzU=","avatar_url":"https://avatars.githubusercontent.com/u/5657035?v=4","gravatar_id":"","url":"https://api.github.com/users/fatkodima","html_url":"https://github.com/fatkodima","followers_url":"https://api.github.com/users/fatkodima/followers","following_url":"https://api.github.com/users/fatkodima/following{/other_user}","gists_url":"https://api.github.com/users/fatkodima/gists{/gist_id}","starred_url":"https://api.github.com/users/fatkodima/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fatkodima/subscriptions","organizations_url":"https://api.github.com/users/fatkodima/orgs","repos_url":"https://api.github.com/users/fatkodima/repos","events_url":"https://api.github.com/users/fatkodima/events{/privacy}","received_events_url":"https://api.github.com/users/fatkodima/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/54471/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/54471/timeline","performed_via_github_app":null,"state_reason":"completed"}