{"url":"https://api.github.com/repos/rails/rails/issues/50713","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/50713/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/50713/comments","events_url":"https://api.github.com/repos/rails/rails/issues/50713/events","html_url":"https://github.com/rails/rails/issues/50713","id":2077355553,"node_id":"I_kwDNIULOe9HuIQ","number":50713,"title":"ActiveJob::TestHelper should not trigger the immediate loading of ActiveJob::Base","user":{"login":"maximerety","id":58582,"node_id":"MDQ6VXNlcjU4NTgy","avatar_url":"https://avatars.githubusercontent.com/u/58582?v=4","gravatar_id":"","url":"https://api.github.com/users/maximerety","html_url":"https://github.com/maximerety","followers_url":"https://api.github.com/users/maximerety/followers","following_url":"https://api.github.com/users/maximerety/following{/other_user}","gists_url":"https://api.github.com/users/maximerety/gists{/gist_id}","starred_url":"https://api.github.com/users/maximerety/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maximerety/subscriptions","organizations_url":"https://api.github.com/users/maximerety/orgs","repos_url":"https://api.github.com/users/maximerety/repos","events_url":"https://api.github.com/users/maximerety/events{/privacy}","received_events_url":"https://api.github.com/users/maximerety/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2024-01-11T18:33:03Z","updated_at":"2024-01-11T19:41:22Z","closed_at":"2024-01-11T19:41:22Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description\r\n\r\n`ActiveJob::TestHelper` triggers the immediate loading of `ActiveJob::Base` because of the following line in its implementation:\r\n\r\nhttps://github.com/rails/rails/blob/4230d0d2be9e4c85f6a32debe72cf98d8d464416/activejob/lib/active_job/test_helper.rb#L37\r\n\r\nThis is unexpected as other parts of `ActiveJob` take great care of deferring the loading of `ActiveJob::Base` thanks to the following construct:\r\n\r\n```ruby\r\nActiveSupport.on_load(:active_job) do\r\n  # Do something with ActiveJob::Base\r\nend\r\n```\r\n\r\nUnfortunately, this can lead to situations in which `ActiveJob` configurations are not applied, because defined after the loading of `ActiveJob::Base`.\r\n\r\nExample of such a situation:\r\n\r\n1. Have a gem  in the `Gemfile` that (most likely inadvertently) triggers the loading of `ActiveJob::TestHelper`;\r\n2. Have `ActiveJob` configurations a in `config/initializers/active_job.rb` file (loaded after the gems from the application).\r\n\r\n### Steps to reproduce\r\n\r\nIn a terminal, set up this demo application:\r\n\r\n```shell\r\nrails new active-job-issue-50713 && cd active-job-issue-50713\r\n\r\ncat <<RUBY >> Gemfile\r\n\r\ngem 'api-auth', '1.5.0'\r\n\r\ngroup :test do\r\n  gem 'minitest-spec-rails', '7.2.0'\r\nend\r\nRUBY\r\n\r\nbundle install\r\n\r\ncat <<RUBY > config/initializers/active_job.rb\r\nRails.application.config.active_job.default_queue_name = \"custom_default_queue\"\r\nRUBY\r\n\r\nmkdir -p test/jobs\r\n\r\ncat <<RUBY > test/jobs/application_job_test.rb\r\nrequire 'test_helper'\r\n\r\nclass ApplicationJobTest < ActiveSupport::TestCase\r\n  test \"default queue configured\" do\r\n    assert_equal \"custom_default_queue\", ApplicationJob.default_queue_name\r\n  end\r\nend\r\nRUBY\r\n```\r\n\r\nThen, run this test:\r\n\r\n```shell\r\nbin/rails test test/jobs/application_job_test.rb\r\n```\r\n\r\n#### Expected behavior\r\n\r\nThe test should pass, i.e. `ActiveJob::TestHelper` should not trigger the immediate loading of `ActiveJob::Base`, and let the the process load it (lazily or eagerly) when actually needed.\r\n\r\n#### Actual behavior\r\n\r\nThe test does not pass, since `ActiveJob::TestHelper` triggers the immediate loading of `ActiveJob::Base`.\r\n\r\n#### System configuration\r\n\r\n**Rails version**: 7.1.2 / main\r\n\r\n**Ruby version**: 3.2.2\r\n\r\n#### Detailed explanations about the test failure\r\n\r\nA legacy version of the `api-auth` gem is referenced in the `Gemfile`, which triggers the loading of `ActionController::Base` here: https://github.com/mgomes/api_auth/blob/v1.5.0/lib/api_auth/railtie.rb#L33-L35 (note that latest versions of the gem fixed that undesired behavior).\r\n\r\nIn turn, loading `ActionController::Base` triggers the loading of `ActionDispatch::IntegrationTest` in  `minitest-spec-rails`, another gem used in tests, see:\r\n* https://github.com/metaskills/minitest-spec-rails/blob/v7.2.0/lib/minitest-spec-rails/railtie.rb#L15\r\n* https://github.com/metaskills/minitest-spec-rails/blob/v7.2.0/lib/minitest-spec-rails/init/action_dispatch.rb#L14\r\n\r\nIn turn, loading `ActionDispatch::IntegrationTest` triggers the loading of `ActionMailer::TestHelper` here: https://github.com/rails/rails/blob/v7.1.2/actionmailer/lib/action_mailer/railtie.rb#L66.\r\n\r\nIn turn, loading `ActionMailer::TestHelper` triggers the loading of `ActiveJob::TestHelper` here: https://github.com/rails/rails/blob/v7.1.2/actionmailer/lib/action_mailer/test_helper.rb#L10.\r\n\r\nFinally, `ActiveJob::TestHelper` triggers the eager loading of `ActiveJob::Base` here: https://github.com/rails/rails/blob/v7.1.2/activejob/lib/active_job/test_helper.rb#L37\r\n\r\nThis code could/should be wrapped in a loading hook instead:\r\n\r\n```diff\r\n- ActiveJob::Base.include(TestQueueAdapter)\r\n+ ActiveSupport.on_load(:active_job) do\r\n+   ActiveJob::Base.include(TestQueueAdapter)\r\n+ end\r\n```\r\n\r\nNow, since `ActiveJob::Base` is eager loaded during the loading of the gems, it is before our initializers get a chance to run and modify the configs, which triggers the issue.\r\n","closed_by":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/50713/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/50713/timeline","performed_via_github_app":null,"state_reason":"completed"}