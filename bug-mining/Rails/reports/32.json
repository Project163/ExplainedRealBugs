{"url":"https://api.github.com/repos/rails/rails/issues/48080","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/48080/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/48080/comments","events_url":"https://api.github.com/repos/rails/rails/issues/48080/events","html_url":"https://github.com/rails/rails/issues/48080","id":1687108694,"node_id":"I_kwDNIULOZI88Vg","number":48080,"title":"Broken order(...).includes(...).ids in PostgreSQL","user":{"login":"alpaca-tc","id":1688137,"node_id":"MDQ6VXNlcjE2ODgxMzc=","avatar_url":"https://avatars.githubusercontent.com/u/1688137?v=4","gravatar_id":"","url":"https://api.github.com/users/alpaca-tc","html_url":"https://github.com/alpaca-tc","followers_url":"https://api.github.com/users/alpaca-tc/followers","following_url":"https://api.github.com/users/alpaca-tc/following{/other_user}","gists_url":"https://api.github.com/users/alpaca-tc/gists{/gist_id}","starred_url":"https://api.github.com/users/alpaca-tc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alpaca-tc/subscriptions","organizations_url":"https://api.github.com/users/alpaca-tc/orgs","repos_url":"https://api.github.com/users/alpaca-tc/repos","events_url":"https://api.github.com/users/alpaca-tc/events{/privacy}","received_events_url":"https://api.github.com/users/alpaca-tc/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":126910270,"node_id":"MDU6TGFiZWwxMjY5MTAyNzA=","url":"https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps","name":"With reproduction steps","color":"009800","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2023-04-27T15:40:02Z","updated_at":"2023-05-03T13:33:11Z","closed_at":"2023-05-03T13:33:11Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Steps to reproduce\r\n\r\nThis bug was introduced by a change to exclude duplicate rows from the id. https://github.com/rails/rails/pull/46503\r\nA `DISTINCT` clause has been added to avoid duplication, but this is an error because the implementation does not consider the case where an `ORDER(column_other_than_pk)` clause exists.\r\n\r\nI tried to fix it, but couldn't figure out how to fix it.\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"pg\"\r\nend\r\n\r\nrequire 'active_record'\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nbegin\r\n  config = { adapter: \"postgresql\", encoding: 'unicode', url: \"postgresql://postgres@localhost:5432\", password: 'postgres', database: 'rails-test' }\r\n  ActiveRecord::Base.establish_connection(config.except(:database))\r\n  ActiveRecord::Base.connection.drop_database(config[:database]) rescue nil\r\n  ActiveRecord::Base.connection.create_database(config[:database])\r\nend\r\n\r\nActiveRecord::Base.establish_connection(config)\r\n\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n    t.timestamps\r\n  end\r\n\r\n  create_table :comments, force: true do |t|\r\n    t.integer :post_id\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  has_many :comments\r\nend\r\n\r\nclass Comment < ActiveRecord::Base\r\n  belongs_to :post\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_includes_ids\r\n    Post.order(:created_at).includes(:comments).ids\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\nno exception\r\n\r\n### Actual behavior\r\n\r\n```\r\nActiveRecord::StatementInvalid: PG::InvalidColumnReference: ERROR: for SELECT DISTINCT, ORDER BY expressions must appear in select list\r\n```\r\n\r\n### System configuration\r\n**Rails version**: main\r\n\r\n**Ruby version**:\r\n","closed_by":{"login":"eileencodes","id":1080678,"node_id":"MDQ6VXNlcjEwODA2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/1080678?v=4","gravatar_id":"","url":"https://api.github.com/users/eileencodes","html_url":"https://github.com/eileencodes","followers_url":"https://api.github.com/users/eileencodes/followers","following_url":"https://api.github.com/users/eileencodes/following{/other_user}","gists_url":"https://api.github.com/users/eileencodes/gists{/gist_id}","starred_url":"https://api.github.com/users/eileencodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eileencodes/subscriptions","organizations_url":"https://api.github.com/users/eileencodes/orgs","repos_url":"https://api.github.com/users/eileencodes/repos","events_url":"https://api.github.com/users/eileencodes/events{/privacy}","received_events_url":"https://api.github.com/users/eileencodes/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/48080/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/48080/timeline","performed_via_github_app":null,"state_reason":"completed"}