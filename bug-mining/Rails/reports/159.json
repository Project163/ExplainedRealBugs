{"url":"https://api.github.com/repos/rails/rails/issues/53394","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/53394/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/53394/comments","events_url":"https://api.github.com/repos/rails/rails/issues/53394/events","html_url":"https://github.com/rails/rails/issues/53394","id":2601289400,"node_id":"I_kwDNIULOmwyGuA","number":53394,"title":"Regression in request parameter parsing","user":{"login":"ghiculescu","id":509837,"node_id":"MDQ6VXNlcjUwOTgzNw==","avatar_url":"https://avatars.githubusercontent.com/u/509837?v=4","gravatar_id":"","url":"https://api.github.com/users/ghiculescu","html_url":"https://github.com/ghiculescu","followers_url":"https://api.github.com/users/ghiculescu/followers","following_url":"https://api.github.com/users/ghiculescu/following{/other_user}","gists_url":"https://api.github.com/users/ghiculescu/gists{/gist_id}","starred_url":"https://api.github.com/users/ghiculescu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ghiculescu/subscriptions","organizations_url":"https://api.github.com/users/ghiculescu/orgs","repos_url":"https://api.github.com/users/ghiculescu/repos","events_url":"https://api.github.com/users/ghiculescu/events{/privacy}","received_events_url":"https://api.github.com/users/ghiculescu/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":107189,"node_id":"MDU6TGFiZWwxMDcxODk=","url":"https://api.github.com/repos/rails/rails/labels/actionpack","name":"actionpack","color":"FFF700","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/rails/rails/milestones/87","html_url":"https://github.com/rails/rails/milestone/87","labels_url":"https://api.github.com/repos/rails/rails/milestones/87/labels","id":10350173,"node_id":"MI_kwDNIULOAJ3uXQ","number":87,"title":"8.0.0","description":null,"creator":{"login":"dhh","id":2741,"node_id":"MDQ6VXNlcjI3NDE=","avatar_url":"https://avatars.githubusercontent.com/u/2741?v=4","gravatar_id":"","url":"https://api.github.com/users/dhh","html_url":"https://github.com/dhh","followers_url":"https://api.github.com/users/dhh/followers","following_url":"https://api.github.com/users/dhh/following{/other_user}","gists_url":"https://api.github.com/users/dhh/gists{/gist_id}","starred_url":"https://api.github.com/users/dhh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dhh/subscriptions","organizations_url":"https://api.github.com/users/dhh/orgs","repos_url":"https://api.github.com/users/dhh/repos","events_url":"https://api.github.com/users/dhh/events{/privacy}","received_events_url":"https://api.github.com/users/dhh/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":40,"state":"closed","created_at":"2023-12-26T22:00:17Z","updated_at":"2024-11-11T20:53:00Z","due_on":null,"closed_at":"2024-11-11T20:53:00Z"},"comments":5,"created_at":"2024-10-21T04:32:53Z","updated_at":"2024-10-29T20:11:55Z","closed_at":"2024-10-29T20:11:55Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Steps to reproduce\r\n\r\nhttps://github.com/rails/rails/pull/53193 causes a change of behaviour if using Rack 2. This might be considered a bug fix, but it's a non-trivial change so I thought it was worth getting some eyes over.\r\n\r\nThe issue occurs when requesting a URL that looks like this: `\"/foo?date=2024-10-21&amp;user_id=123\"`. With Rack 2, before https://github.com/rails/rails/pull/53193, this was parsed as:\r\n\r\n```\r\n{\"date\"=>\"2024-10-21\", \"amp\"=>nil, \"user_id\"=>\"123\", \"controller\"=>\"test\", \"action\"=>\"index\"}\r\n```\r\n\r\nAfter https://github.com/rails/rails/pull/53193 it is parsed as:\r\n\r\n```\r\n{\"date\"=>\"2024-10-21\", \"amp;user_id\"=>\"123\", \"controller\"=>\"test\", \"action\"=>\"index\"}\r\n```\r\n\r\nIf you use Rack 3, it parses as the latter form regardless of Rails commit.\r\n\r\nSo https://github.com/rails/rails/pull/53193 causes a change in behaviour for Rack 2 users. Arguably it's a bug fix in Rails, and the user should fix their buggy code (they should go to `\"/foo?date=2024-10-21&user_id=123\"` instead). But it's a pretty subtle bug that's hard to audit for and that's been around for a very long time.\r\n\r\nWhat makes it particularly subtle is that the \"buggy\" code results in expected params, ie. if you do `params[:user_id]` in your controller it'll return what you expect. On upgrading to the \"fixed\" version of Rails, will `params[:user_id]` return `nil` instead of a value.\r\n\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  # The last commit before https://github.com/rails/rails/pull/53193, tests fail.\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\", ref: \"e83cfa5466255d48cf03308dfe5d183eb8444d51\"\r\n\r\n  # The commit for https://github.com/rails/rails/pull/53193, tests pass\r\n  # gem \"rails\", github: \"rails/rails\", branch: \"main\", ref: \"d64611bc5a71a749d10c4da295e80fe182b5d7ea\"\r\n\r\n  # The issue is specific to Rack 2.\r\n  gem \"rack\", \"~> 2\"\r\n\r\n  # If you use Rack 3 the tests pass with either Rails commit.\r\n  # gem \"rack\", \"~> 3\"\r\nend\r\n\r\nrequire \"action_controller/railtie\"\r\n\r\nclass TestApp < Rails::Application\r\n  config.root = __dir__\r\n  config.hosts << \"example.org\"\r\n  config.secret_key_base = \"secret_key_base\"\r\n\r\n  config.logger = Logger.new($stdout)\r\n  Rails.logger  = config.logger\r\n\r\n  routes.draw do\r\n    get \"/foo\" => \"test#index\"\r\n  end\r\nend\r\n\r\nclass TestController < ActionController::Base\r\n  include Rails.application.routes.url_helpers\r\n\r\n  def index\r\n    render plain: params.to_s\r\n  end\r\nend\r\n\r\nrequire \"minitest/autorun\"\r\nrequire \"rack/test\"\r\n\r\nclass BugTest < ActiveSupport::TestCase\r\n  include Rack::Test::Methods\r\n\r\n  def test_returns_success\r\n    get \"/foo?date=2024-10-21&amp;user_id=123\"\r\n    expected = %Q({\"date\"=>\"2024-10-21\", \"amp;user_id\"=>\"123\", \"controller\"=>\"test\", \"action\"=>\"index\"})\r\n    assert_equal expected, last_response.body\r\n\r\n    # before PR 53193, this would pass:\r\n    # expected = %Q({\"date\"=>\"2024-10-21\", \"amp\"=>nil, \"user_id\"=>\"123\", \"controller\"=>\"test\", \"action\"=>\"index\"})\r\n    # assert_equal expected, last_response.body\r\n  end\r\n\r\n  private\r\n    def app\r\n      Rails.application\r\n    end\r\nend\r\n\r\n```\r\n\r\n### Expected behavior\r\n\r\nHonestly I'm not sure the right approach here. It would suit me if the old behaviour was supported forever, but objectively that seems silly given that it's clearly a bug.\r\n\r\n### Actual behavior\r\n\r\nSee above\r\n\r\n### System configuration\r\n**Rails version**: main\r\n\r\n**Ruby version**: 3.3\r\n","closed_by":{"login":"matthewd","id":1034,"node_id":"MDQ6VXNlcjEwMzQ=","avatar_url":"https://avatars.githubusercontent.com/u/1034?v=4","gravatar_id":"","url":"https://api.github.com/users/matthewd","html_url":"https://github.com/matthewd","followers_url":"https://api.github.com/users/matthewd/followers","following_url":"https://api.github.com/users/matthewd/following{/other_user}","gists_url":"https://api.github.com/users/matthewd/gists{/gist_id}","starred_url":"https://api.github.com/users/matthewd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/matthewd/subscriptions","organizations_url":"https://api.github.com/users/matthewd/orgs","repos_url":"https://api.github.com/users/matthewd/repos","events_url":"https://api.github.com/users/matthewd/events{/privacy}","received_events_url":"https://api.github.com/users/matthewd/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/53394/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/53394/timeline","performed_via_github_app":null,"state_reason":"completed"}