{"url":"https://api.github.com/repos/rails/rails/issues/48118","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/48118/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/48118/comments","events_url":"https://api.github.com/repos/rails/rails/issues/48118/events","html_url":"https://github.com/rails/rails/issues/48118","id":1694071302,"node_id":"I_kwDNIULOZPl6Bg","number":48118,"title":"ActiveSupport::MessageEncryptor migration path to 7.1 defaults","user":{"login":"etiennebarrie","id":3535,"node_id":"MDQ6VXNlcjM1MzU=","avatar_url":"https://avatars.githubusercontent.com/u/3535?v=4","gravatar_id":"","url":"https://api.github.com/users/etiennebarrie","html_url":"https://github.com/etiennebarrie","followers_url":"https://api.github.com/users/etiennebarrie/followers","following_url":"https://api.github.com/users/etiennebarrie/following{/other_user}","gists_url":"https://api.github.com/users/etiennebarrie/gists{/gist_id}","starred_url":"https://api.github.com/users/etiennebarrie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/etiennebarrie/subscriptions","organizations_url":"https://api.github.com/users/etiennebarrie/orgs","repos_url":"https://api.github.com/users/etiennebarrie/repos","events_url":"https://api.github.com/users/etiennebarrie/events{/privacy}","received_events_url":"https://api.github.com/users/etiennebarrie/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/rails/rails/milestones/82","html_url":"https://github.com/rails/rails/milestone/82","labels_url":"https://api.github.com/repos/rails/rails/milestones/82/labels","id":7758309,"node_id":"MI_kwDNIULOAHZh5Q","number":82,"title":"7.1.0","description":"","creator":{"login":"eileencodes","id":1080678,"node_id":"MDQ6VXNlcjEwODA2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/1080678?v=4","gravatar_id":"","url":"https://api.github.com/users/eileencodes","html_url":"https://github.com/eileencodes","followers_url":"https://api.github.com/users/eileencodes/followers","following_url":"https://api.github.com/users/eileencodes/following{/other_user}","gists_url":"https://api.github.com/users/eileencodes/gists{/gist_id}","starred_url":"https://api.github.com/users/eileencodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eileencodes/subscriptions","organizations_url":"https://api.github.com/users/eileencodes/orgs","repos_url":"https://api.github.com/users/eileencodes/repos","events_url":"https://api.github.com/users/eileencodes/events{/privacy}","received_events_url":"https://api.github.com/users/eileencodes/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":63,"state":"closed","created_at":"2022-03-11T16:33:03Z","updated_at":"2023-10-05T08:10:50Z","due_on":null,"closed_at":"2023-10-05T08:10:50Z"},"comments":1,"created_at":"2023-05-03T13:22:44Z","updated_at":"2023-05-08T18:41:08Z","closed_at":"2023-05-08T18:41:07Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Steps to reproduce\r\n* With a 7.0 app, generate a encrypted message with ActiveSupport::MessageEncryptor.\r\n* Upgrade the app 7.1 keeping 7.0 defaults: you can decode the message, generate a new message.\r\n* Use the 7.1 defaults: you can't decode the message.\r\n\r\nI created a [small example app](https://github.com/etiennebarrie/rails-app/tree/message-encryptor-7.1-compat) which you can clone with `git clone https://github.com/etiennebarrie/rails-app.git --single-branch --branch message-encryptor-7.1-compat`. With this app, the steps are:\r\n\r\n```sh-session\r\n$ bundle\r\n$ bin/rails server\r\n# navigate to http://127.0.0.1:3000/\r\n# optionally click \"Verify\" to ensure the message roundtrip works on 7.0\r\n# keep the window open to verify a 7.0 message with 7.1\r\n$ BUNDLE_GEMFILE=Gemfile.main bundle\r\n$ BUNDLE_GEMFILE=Gemfile.main bin/rails s\r\n# now click \"Verify\" to verify the 7.0 generated message with 7.1 with 7.0 defaults\r\n# it works!\r\n# keep the window open\r\n$ RAILS_71_DEFAULTS=1 BUNDLE_GEMFILE=Gemfile.main bin/rails s\r\n# click \"Verify\"\r\n# verification failed\r\n```\r\n\r\nI know there are more steps mentioned in https://edgeguides.rubyonrails.org/upgrading_ruby_on_rails.html, but out-of-the-box this should work. Instead multiple steps are necessary.\r\n\r\n### Expected behavior\r\nThe application is upgraded and the message should be verified.\r\n\r\n### Actual behavior\r\nMessage verification fails.\r\n\r\n---\r\n\r\nFor each line in these tables, you should check what is generated and the fact that it is verifiable by the line above and the line below.\r\nThe approach right now can be resumed to this:\r\n\r\n| Application configuration | Generation | Can verify Marshal | Can verify JSON |\r\n|--------|--------|--------|--------|\r\n| 7.0 | Marshal | ‚úì | êÑÇ |\r\n| 7.1 with 7.0 defaults  | Marshal | ‚úì | êÑÇ |\r\n| 7.1 with 7.1 defaults | JSON | êÑÇ | ‚úì | \r\n\r\nWe can see the incompatibility by looking at what each steps generates and what each next step can verify. The step 2 to 3 is incompatible.\r\n\r\nThe approach recommended in the upgrading guide:\r\n\r\n| Application configuration | Generation | Can verify Marshal | Can verify JSON |\r\n|--------|--------|--------|--------|\r\n| 7.0 | Marshal | ‚úì | êÑÇ |\r\n| 7.1 with 7.0 defaults, default_message_encryptor_serializer = :marshal | Marshal | ‚úì | êÑÇ |\r\n| 7.1 with 7.0 defaults, default_message_encryptor_serializer = :hybrid | Marshal | ‚úì | ‚úì |\r\n| 7.1 with 7.1 defaults, default_message_encryptor_serializer = :hybrid, use_marshal_serialization = false | JSON | ‚úì | ‚úì | \r\n| 7.1 with 7.1 defaults | JSON | êÑÇ | ‚úì | \r\n\r\nThis shows it's compatible, but adds multiple steps to the upgrade. The second step is not necessary, but still described in the upgrading guide.\r\n\r\nWhat I think we should do, in line with the way we usually use defaults:\r\n\r\n| Application configuration | Generation | Can verify Marshal | Can verify JSON |\r\n|--------|--------|--------|--------|\r\n| 7.0 | Marshal | ‚úì | êÑÇ |\r\n| 7.1 with 7.0 defaults | Marshal | ‚úì | ‚úì |\r\n| 7.1 with 7.1 defaults | JSON | ‚úì | ‚úì | \r\n| 7.1 with 7.1 defaults, default_message_encryptor_serializer = :json | JSON | êÑÇ | ‚úì | \r\n\r\nThat last line, with `default_message_encryptor_serializer = :json` can become the default in 7.2, and can be enabled earlier to make sure no Marshal is accepted before then.\r\n","closed_by":{"login":"guilleiguaran","id":160941,"node_id":"MDQ6VXNlcjE2MDk0MQ==","avatar_url":"https://avatars.githubusercontent.com/u/160941?v=4","gravatar_id":"","url":"https://api.github.com/users/guilleiguaran","html_url":"https://github.com/guilleiguaran","followers_url":"https://api.github.com/users/guilleiguaran/followers","following_url":"https://api.github.com/users/guilleiguaran/following{/other_user}","gists_url":"https://api.github.com/users/guilleiguaran/gists{/gist_id}","starred_url":"https://api.github.com/users/guilleiguaran/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/guilleiguaran/subscriptions","organizations_url":"https://api.github.com/users/guilleiguaran/orgs","repos_url":"https://api.github.com/users/guilleiguaran/repos","events_url":"https://api.github.com/users/guilleiguaran/events{/privacy}","received_events_url":"https://api.github.com/users/guilleiguaran/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/48118/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":1,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/48118/timeline","performed_via_github_app":null,"state_reason":"completed"}