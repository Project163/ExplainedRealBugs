{"url":"https://api.github.com/repos/rails/rails/issues/52776","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/52776/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/52776/comments","events_url":"https://api.github.com/repos/rails/rails/issues/52776/events","html_url":"https://github.com/rails/rails/issues/52776","id":2501475072,"node_id":"I_kwDNIULOlRl7AA","number":52776,"title":"Schema dumps incorrectly for secondary databases","user":{"login":"dhh","id":2741,"node_id":"MDQ6VXNlcjI3NDE=","avatar_url":"https://avatars.githubusercontent.com/u/2741?v=4","gravatar_id":"","url":"https://api.github.com/users/dhh","html_url":"https://github.com/dhh","followers_url":"https://api.github.com/users/dhh/followers","following_url":"https://api.github.com/users/dhh/following{/other_user}","gists_url":"https://api.github.com/users/dhh/gists{/gist_id}","starred_url":"https://api.github.com/users/dhh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dhh/subscriptions","organizations_url":"https://api.github.com/users/dhh/orgs","repos_url":"https://api.github.com/users/dhh/repos","events_url":"https://api.github.com/users/dhh/events{/privacy}","received_events_url":"https://api.github.com/users/dhh/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2024-09-02T19:02:35Z","updated_at":"2024-09-02T20:19:35Z","closed_at":"2024-09-02T20:19:35Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Consider this database.yml:\r\n\r\n```yaml\r\ndevelopment:\r\n  primary:\r\n    <<: *default\r\n    database: storage/development.sqlite3\r\n  cache:\r\n    <<: *default\r\n    database: storage/cache.sqlite3\r\n    migrations_paths: db/cache_migrate\r\n```\r\n\r\nThere are two databases. Now assume that we haven't yet run the migrations. So there are no db/*schema.rb files yet.\r\n\r\nWhen we run `rails db:prepare`, migrations for both databases will be run correctly, but when the schema.rb for the secondary cache database is due to be dumped, it'll be dumped as the development database.\r\n\r\nThis is happening because https://github.com/rails/rails/blob/main/activerecord/lib/active_record/tasks/database_tasks.rb#L214 calls which then calls https://github.com/rails/rails/blob/main/activerecord/lib/active_record/tasks/database_tasks.rb#L214 to trigger the SchemaDumper. But the `migration_connection_pool` references `migration_class`, which is always ActiveRecord::Base, so you get the schema that belongs to that. Which is the primary.\r\n\r\nWe need the call to the dumper to use a connection pool that belongs to the cache db for this to work correctly.","closed_by":{"login":"dhh","id":2741,"node_id":"MDQ6VXNlcjI3NDE=","avatar_url":"https://avatars.githubusercontent.com/u/2741?v=4","gravatar_id":"","url":"https://api.github.com/users/dhh","html_url":"https://github.com/dhh","followers_url":"https://api.github.com/users/dhh/followers","following_url":"https://api.github.com/users/dhh/following{/other_user}","gists_url":"https://api.github.com/users/dhh/gists{/gist_id}","starred_url":"https://api.github.com/users/dhh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dhh/subscriptions","organizations_url":"https://api.github.com/users/dhh/orgs","repos_url":"https://api.github.com/users/dhh/repos","events_url":"https://api.github.com/users/dhh/events{/privacy}","received_events_url":"https://api.github.com/users/dhh/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/52776/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/52776/timeline","performed_via_github_app":null,"state_reason":"completed"}