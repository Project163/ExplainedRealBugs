{"url":"https://api.github.com/repos/rails/rails/issues/55513","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/55513/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/55513/comments","events_url":"https://api.github.com/repos/rails/rails/issues/55513/events","html_url":"https://github.com/rails/rails/issues/55513","id":3334650388,"node_id":"I_kwDNIULOxsK6FA","number":55513,"title":"Parallel tests hang if a worker dies abruptly","user":{"login":"tavianator","id":1692591,"node_id":"MDQ6VXNlcjE2OTI1OTE=","avatar_url":"https://avatars.githubusercontent.com/u/1692591?v=4","gravatar_id":"","url":"https://api.github.com/users/tavianator","html_url":"https://github.com/tavianator","followers_url":"https://api.github.com/users/tavianator/followers","following_url":"https://api.github.com/users/tavianator/following{/other_user}","gists_url":"https://api.github.com/users/tavianator/gists{/gist_id}","starred_url":"https://api.github.com/users/tavianator/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tavianator/subscriptions","organizations_url":"https://api.github.com/users/tavianator/orgs","repos_url":"https://api.github.com/users/tavianator/repos","events_url":"https://api.github.com/users/tavianator/events{/privacy}","received_events_url":"https://api.github.com/users/tavianator/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null},{"id":126910270,"node_id":"MDU6TGFiZWwxMjY5MTAyNzA=","url":"https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps","name":"With reproduction steps","color":"009800","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2025-08-19T14:40:15Z","updated_at":"2025-09-29T12:55:15Z","closed_at":"2025-09-29T12:55:15Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Steps to reproduce\n\nIn one terminal tab, with parallel tests enabled:\n\n```console\n$ rails test\n```\n\nIn another tab, find one of the worker processes and kill it:\n\n```console\n$ ps aux | grep Rails\ntavianator       60418  91.5  1.0 414614432 497440 s007  S+   10:29AM   0:01.42 Rails test worker 1 -\ntavianator       60419  75.1  0.9 414614464 462272 s007  R+   10:29AM   0:01.34 Rails test worker 2 -\ntavianator         845   0.0  0.0 414575232  13712   ??  S    Thu11AM   0:01.44 Rails test worker 0 -\n...\n$ kill -9 60418\n```\n\n### Expected behavior\n\nThe tests should fail.\n\n### Actual behavior\n\nThe tests will hang forever:\n\n```console\n$ rails test\nRunning 3763 tests in parallel using 12 processes\nStarted with run options --seed 1248\n\n  3762/3763: [============================================ ] 99% Time: 00:00:24,  ETA: 00:00:00\n```\n\n### System configuration\n\n**Rails version**: \n\n```console\n$ rails --version\nRails 8.0.2\n```\n\n**Ruby version**: \n\n```console\n$ ruby --version\nruby 3.4.4 (2025-05-14 revision a38531fd3f) +PRISM [arm64-darwin23]\n```\n\n### More details\n\nI noticed this due to tests timing out in CI.  It turned out that the workers were being OOM killed, but there was no indication in the logs.  All we saw was the tests hanging after nearly completing.\n\nThe hang happens in https://github.com/rails/rails/blob/430cff888c248eb45258c74953226edd3b4bae50/activesupport/lib/active_support/testing/parallelization/server.rb#L67-L70\n\n`active_workers?` is waiting for a worker to call `stop_worker`: https://github.com/rails/rails/blob/430cff888c248eb45258c74953226edd3b4bae50/activesupport/lib/active_support/testing/parallelization/server.rb#L47-L53\n\nBut the worker will never call `stop_worker` if it's killed in the middle of running tests: https://github.com/rails/rails/blob/430cff888c248eb45258c74953226edd3b4bae50/activesupport/lib/active_support/testing/parallelization/worker.rb#L21-L32\n\nI suspect the fix will involve refactoring `Parallelization#shutdown` to call `waitpid` earlier and check for a successful exit: https://github.com/rails/rails/blob/430cff888c248eb45258c74953226edd3b4bae50/activesupport/lib/active_support/testing/parallelization.rb#L62-L65","closed_by":{"login":"byroot","id":44640,"node_id":"MDQ6VXNlcjQ0NjQw","avatar_url":"https://avatars.githubusercontent.com/u/44640?v=4","gravatar_id":"","url":"https://api.github.com/users/byroot","html_url":"https://github.com/byroot","followers_url":"https://api.github.com/users/byroot/followers","following_url":"https://api.github.com/users/byroot/following{/other_user}","gists_url":"https://api.github.com/users/byroot/gists{/gist_id}","starred_url":"https://api.github.com/users/byroot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/byroot/subscriptions","organizations_url":"https://api.github.com/users/byroot/orgs","repos_url":"https://api.github.com/users/byroot/repos","events_url":"https://api.github.com/users/byroot/events{/privacy}","received_events_url":"https://api.github.com/users/byroot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/55513/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/55513/timeline","performed_via_github_app":null,"state_reason":"completed"}