{"url":"https://api.github.com/repos/rails/rails/issues/51745","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/51745/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/51745/comments","events_url":"https://api.github.com/repos/rails/rails/issues/51745/events","html_url":"https://github.com/rails/rails/issues/51745","id":2280431140,"node_id":"I_kwDNIULOh-yeJA","number":51745,"title":"Range of dates with infinite end are stored incorrectly in Postgres database","user":{"login":"pean","id":681780,"node_id":"MDQ6VXNlcjY4MTc4MA==","avatar_url":"https://avatars.githubusercontent.com/u/681780?v=4","gravatar_id":"","url":"https://api.github.com/users/pean","html_url":"https://github.com/pean","followers_url":"https://api.github.com/users/pean/followers","following_url":"https://api.github.com/users/pean/following{/other_user}","gists_url":"https://api.github.com/users/pean/gists{/gist_id}","starred_url":"https://api.github.com/users/pean/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pean/subscriptions","organizations_url":"https://api.github.com/users/pean/orgs","repos_url":"https://api.github.com/users/pean/repos","events_url":"https://api.github.com/users/pean/events{/privacy}","received_events_url":"https://api.github.com/users/pean/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null},{"id":70310659,"node_id":"MDU6TGFiZWw3MDMxMDY1OQ==","url":"https://api.github.com/repos/rails/rails/labels/PostgreSQL","name":"PostgreSQL","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2024-05-06T09:24:56Z","updated_at":"2025-07-17T13:08:43Z","closed_at":"2025-07-17T13:08:43Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"In Rails 7.1.3 date ranges with unbounded end is stored incorrectly when the end is included and it is i stored with excluded end.\r\n\r\n### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n1. Create a table with a Postgres date range column\r\n2. Create and entry in the table with a range with included unbounded end `(Date.today..)` and save it\r\n3. Reload that entry and the range comes back with excluded end `(Date.today...)`\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", '~> 7.1.3'\r\n  gem \"pg\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# You may need to change your pg settings accordingly\r\ndb_config = {\r\n  adapter: 'postgresql',\r\n  database: 'infinityrange_test',\r\n  host: 'localhost', # Change this to your PostgreSQL host\r\n  port: 5432,\r\n  username: 'postgres', # Change this to your PostgreSQL username\r\n  password: 'postgres'  # Change this to your PostgreSQL password\r\n}\r\n\r\nbegin\r\n  ActiveRecord::Base.establish_connection(db_config.except(:database))\r\n  ActiveRecord::Base.connection.drop_database(db_config[:database]) rescue nil\r\n  ActiveRecord::Base.connection.create_database(db_config[:database])\r\nend\r\nActiveRecord::Base.establish_connection(db_config)\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :infinity_ranges do |t|\r\n    t.tsrange :date_range\r\n  end\r\nend\r\n\r\nclass InfinityRange < ActiveRecord::Base; end\r\n\r\nclass InfinityRangeTest < Minitest::Test\r\n  def setup\r\n    @time = Time.utc(2024)\r\n  end\r\n\r\n  def test_date_range_infinity\r\n    # Create a range with infinity end including end 2024-01-01 00:00:00 UTC..\r\n    # There are multiple ways to create a range with infinity end but all of \r\n    # these give the same result\r\n    # range = (@time..Float::INFINITY)\r\n    # range = (@time..DateTime::Infinity.new)\r\n    # range = (@time..Date::Infinity.new)\r\n    range = (@time..)\r\n\r\n    record = InfinityRange.new(date_range: range)\r\n\r\n    # Range is including end\r\n    refute_predicate record.date_range, :exclude_end?\r\n\r\n    # Save an reload the record to read back the value from db\r\n    record.save!\r\n    record.reload\r\n\r\n    # Range is no longer including range and returns 2024-01-01 00:00:00 UTC...\r\n    # but it should be 2024-01-01 00:00:00 UTC..\r\n    assert_equal (@time..), record.date_range\r\n    refute_predicate record.date_range, :exclude_end?\r\n\r\n    # To read back excluding end it needs to be stored like this\r\n    assert_equal(\r\n      \"[\\\"#{@time.to_fs(:db)}\\\",infinity]\",\r\n      record.read_attribute_before_type_cast(:date_range),\r\n    )\r\n  end\r\n\r\n  # This test is to shows that the range can be inserted directly into the\r\n  # database and then read back as expected\r\n  def test_direct_insert\r\n    # Insert the equivalent of (@time..) directly into the database\r\n    sql = \"INSERT INTO infinity_ranges (date_range) VALUES ('[#{@time},infinity]')\"\r\n    ActiveRecord::Base.connection.execute(sql)\r\n\r\n    record = InfinityRange.last\r\n\r\n    assert_equal (@time..), record.date_range\r\n    refute_predicate record.date_range, :exclude_end?\r\n\r\n    assert_equal(\r\n      \"[\\\"#{@time.to_fs(:db)}\\\",infinity]\",\r\n      record.read_attribute_before_type_cast(:date_range),\r\n    )\r\n  end\r\n\r\n  def test_direct_insert_nil\r\n    # Insert the equivalent of (@time..) directly into the database\r\n    sql = \"INSERT INTO infinity_ranges (date_range) VALUES ('[#{@time},]')\"\r\n    ActiveRecord::Base.connection.execute(sql)\r\n\r\n    record = InfinityRange.last\r\n\r\n    assert_equal (@time..), record.date_range\r\n    refute_predicate record.date_range, :exclude_end?\r\n\r\n    assert_equal(\r\n      \"[\\\"#{@time.to_fs(:db)}\\\",infinity]\",\r\n      record.read_attribute_before_type_cast(:date_range),\r\n    )\r\n  end\r\nend\r\n```\r\n☝️ These assertions fails btw, except in`test_direct_insert` that all pass.\r\n\r\n### Expected behavior\r\nTo save the range including unbounded end as it was specified.\r\n\r\n### Actual behavior\r\nRange is saved in database excluding end and when it's read back into rails it is not the same value.\r\n\r\n### System configuration\r\n**Rails version**: `7.1.3`\r\n\r\n**Ruby version**: `ruby 3.2.3 (2024-01-18 revision 52bb2ac0a6) [arm64-darwin23]`\r\n","closed_by":{"login":"byroot","id":44640,"node_id":"MDQ6VXNlcjQ0NjQw","avatar_url":"https://avatars.githubusercontent.com/u/44640?v=4","gravatar_id":"","url":"https://api.github.com/users/byroot","html_url":"https://github.com/byroot","followers_url":"https://api.github.com/users/byroot/followers","following_url":"https://api.github.com/users/byroot/following{/other_user}","gists_url":"https://api.github.com/users/byroot/gists{/gist_id}","starred_url":"https://api.github.com/users/byroot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/byroot/subscriptions","organizations_url":"https://api.github.com/users/byroot/orgs","repos_url":"https://api.github.com/users/byroot/repos","events_url":"https://api.github.com/users/byroot/events{/privacy}","received_events_url":"https://api.github.com/users/byroot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/51745/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/51745/timeline","performed_via_github_app":null,"state_reason":"completed"}