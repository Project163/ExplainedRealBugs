{"url":"https://api.github.com/repos/rails/rails/issues/48685","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/48685/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/48685/comments","events_url":"https://api.github.com/repos/rails/rails/issues/48685/events","html_url":"https://github.com/rails/rails/issues/48685","id":1793527161,"node_id":"I_kwDNIULOaucNeQ","number":48685,"title":"Make ActiveRecord Encryptor agnostic of the type of serialized data to be decrypted","user":{"login":"maximerety","id":58582,"node_id":"MDQ6VXNlcjU4NTgy","avatar_url":"https://avatars.githubusercontent.com/u/58582?v=4","gravatar_id":"","url":"https://api.github.com/users/maximerety","html_url":"https://github.com/maximerety","followers_url":"https://api.github.com/users/maximerety/followers","following_url":"https://api.github.com/users/maximerety/following{/other_user}","gists_url":"https://api.github.com/users/maximerety/gists{/gist_id}","starred_url":"https://api.github.com/users/maximerety/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maximerety/subscriptions","organizations_url":"https://api.github.com/users/maximerety/orgs","repos_url":"https://api.github.com/users/maximerety/repos","events_url":"https://api.github.com/users/maximerety/events{/privacy}","received_events_url":"https://api.github.com/users/maximerety/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null},{"id":5511275119,"node_id":"LA_kwDNIULPAAAAAUh_Ym8","url":"https://api.github.com/repos/rails/rails/labels/encryption","name":"encryption","color":"8D3EA8","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2023-07-07T13:11:02Z","updated_at":"2024-01-05T18:05:58Z","closed_at":"2024-01-05T18:05:57Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Steps to reproduce\r\n\r\nI am using [ActiveRecord Encryption](https://guides.rubyonrails.org/active_record_encryption.html) with latest Rails `7.0.*`, and a custom serializer instead of the default one.\r\n\r\nThis custom serializer outputs binary values that are stored in a `bytea` column in PostgreSQL, instead of a JSON value in a `text` column, as the default MessageSerializer would do.\r\n\r\nIt works pretty well except that the `ActiveRecord::Encryption::Encryptor#deserialize_message` prevents `ActiveModel::Type::Binary::Data` objects to be passed to the custom serializer for decryption. (Note: we get this type of data for user inputs subsequently decrypted, e.g. during attribute validation).\r\n\r\nI would expect the `Encryptor` to be agnostic about the type of values to decrypt, and let the underlying serializer assert the actual types that it supports.\r\n\r\nNote that the default `MessageSerializer` is already able to reject any input which is not a `String`:\r\n\r\n1. A  `TypeError` is raised by `JSON.parse` (not caught here)\r\nhttps://github.com/rails/rails/blob/a5fc471b3f4bbd02e6be38dae023526a49e7d049/activerecord/lib/active_record/encryption/message_serializer.rb#L24-L29\r\n2. The `TypeError` is caught and replaced by an `Encoding` error:\r\nhttps://github.com/rails/rails/blob/a5fc471b3f4bbd02e6be38dae023526a49e7d049/activerecord/lib/active_record/encryption/encryptor.rb#L102-L107\r\n3. And finally caught again and replaced by  a `Decryption` error:\r\nhttps://github.com/rails/rails/blob/a5fc471b3f4bbd02e6be38dae023526a49e7d049/activerecord/lib/active_record/encryption/encryptor.rb#L52-L59\r\n\r\nSo there is no need for this duplicate preventive check at `Encryptor` level in step 2.:\r\n\r\nhttps://github.com/rails/rails/blob/a5fc471b3f4bbd02e6be38dae023526a49e7d049/activerecord/lib/active_record/encryption/encryptor.rb#L103\r\n\r\nWhen I remove that duplicate check, the behavior is unchanged when using the default `MessageSerializer`, but I am able to use a custom serializer too.\r\n\r\n### Expected behavior\r\n\r\nI would expect the `Encryptor` to be agnostic about the type of values to decrypt, and let the underlying serializer assert the actual types that it supports.\r\n\r\n### Actual behavior\r\n\r\nThe `Encryptor` assumes that the input to be deserialized/decrypted is always a `String` when it could be something else. This unnecessarily prevents the use of custom serializers.\r\n\r\n### System configuration\r\n\r\n**Rails version**: 7.0.6 / 7.1\r\n\r\n**Ruby version**: 3.2.2\r\n","closed_by":{"login":"eileencodes","id":1080678,"node_id":"MDQ6VXNlcjEwODA2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/1080678?v=4","gravatar_id":"","url":"https://api.github.com/users/eileencodes","html_url":"https://github.com/eileencodes","followers_url":"https://api.github.com/users/eileencodes/followers","following_url":"https://api.github.com/users/eileencodes/following{/other_user}","gists_url":"https://api.github.com/users/eileencodes/gists{/gist_id}","starred_url":"https://api.github.com/users/eileencodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eileencodes/subscriptions","organizations_url":"https://api.github.com/users/eileencodes/orgs","repos_url":"https://api.github.com/users/eileencodes/repos","events_url":"https://api.github.com/users/eileencodes/events{/privacy}","received_events_url":"https://api.github.com/users/eileencodes/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/48685/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/48685/timeline","performed_via_github_app":null,"state_reason":"completed"}