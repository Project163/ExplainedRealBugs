[{"url":"https://api.github.com/repos/rails/rails/issues/comments/2676419049","html_url":"https://github.com/rails/rails/issues/54595#issuecomment-2676419049","issue_url":"https://api.github.com/repos/rails/rails/issues/54595","id":2676419049,"node_id":"IC_kwDNIULOn4bp6Q","user":{"login":"quixoten","id":63675,"node_id":"MDQ6VXNlcjYzNjc1","avatar_url":"https://avatars.githubusercontent.com/u/63675?v=4","gravatar_id":"","url":"https://api.github.com/users/quixoten","html_url":"https://github.com/quixoten","followers_url":"https://api.github.com/users/quixoten/followers","following_url":"https://api.github.com/users/quixoten/following{/other_user}","gists_url":"https://api.github.com/users/quixoten/gists{/gist_id}","starred_url":"https://api.github.com/users/quixoten/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/quixoten/subscriptions","organizations_url":"https://api.github.com/users/quixoten/orgs","repos_url":"https://api.github.com/users/quixoten/repos","events_url":"https://api.github.com/users/quixoten/events{/privacy}","received_events_url":"https://api.github.com/users/quixoten/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-02-22T21:52:16Z","updated_at":"2025-02-22T21:52:16Z","body":"Here's the the complete test code if it helps. If this is something that's easier to test in another way I don't mind pivoting. \n\n<details>\n<summary>test/controllers/concerns/error_pages_test.rb</summary>\n\n```ruby\nrequire \"test_helper\"\n\nclass ErrorPagesTestController < ActionController::Base\n  include ErrorPages\n\n  def action_not_found\n    raise AbstractController::ActionNotFound, \"action_not_found\"\n  end\n\n  def invalid_authenticity_token\n    raise ActionController::InvalidAuthenticityToken, \"invalid_authenticity_token\"\n  end\n\n  def name_error\n    raise NameError, \"name_error\"\n  end\n\n  def no_method_error\n    raise NoMethodError, \"no_method_error\"\n  end\n\n  def record_not_found\n    raise ActiveRecord::RecordNotFound, \"record_not_found\"\n  end\n\n  def routing_error\n    raise ActionController::RoutingError, \"routing_error\"\n  end\n\n  def standard_error\n    raise StandardError, \"standard_error\"\n  end\nend\n\nclass RescuedErrorPagesTestController < ErrorPagesTestController\n  rescue_from_common_errors\nend\n\nclass ErrorPagesTest < ActionDispatch::IntegrationTest\n  with_routing do |routes|\n    routes.draw do\n      %w[action_not_found invalid_authenticity_token name_error no_method_error record_not_found routing_error standard_error].each do |action|\n        get \"/default/#{action}\", to: \"error_pages_test##{action}\"\n        get \"/rescued/#{action}\", to: \"rescued_error_pages_test##{action}\"\n      end\n    end\n  end\n\n  test \"preserves behavior by default\" do\n    %w[action_not_found record_not_found routing_error].each do |action|\n      get \"/default/#{action}\"\n      assert_response 404\n      assert_template nil\n    end\n\n    %w[invalid_authenticity_token].each do |action|\n      get \"/default/#{action}\"\n      assert_response 422\n      assert_template nil\n    end\n\n    %w[name_error no_method_error standard_error].each do |action|\n      assert_raises do\n        get \"/default/#{action}\"\n      end\n    end\n  end\n\n  test \"renders a shared error page when rescue_from_common_errors is used\" do\n    %w[action_not_found invalid_authenticity_token name_error no_method_error record_not_found routing_error].each do |action|\n      get \"/rescued/#{action}\"\n      assert_response 404\n      assert_template \"error_pages/render_404\"\n    end\n\n    %w[standard_error].each do |action|\n      get \"/rescued/#{action}\"\n      assert_response 500\n      assert_template \"error_pages/standard_error\"\n    end\n  end\nend\n```\n\n</details>","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/2676419049/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"quixoten","id":63675,"node_id":"MDQ6VXNlcjYzNjc1","avatar_url":"https://avatars.githubusercontent.com/u/63675?v=4","gravatar_id":"","url":"https://api.github.com/users/quixoten","html_url":"https://github.com/quixoten","followers_url":"https://api.github.com/users/quixoten/followers","following_url":"https://api.github.com/users/quixoten/following{/other_user}","gists_url":"https://api.github.com/users/quixoten/gists{/gist_id}","starred_url":"https://api.github.com/users/quixoten/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/quixoten/subscriptions","organizations_url":"https://api.github.com/users/quixoten/orgs","repos_url":"https://api.github.com/users/quixoten/repos","events_url":"https://api.github.com/users/quixoten/events{/privacy}","received_events_url":"https://api.github.com/users/quixoten/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rails/rails/issues/comments/2676690820","html_url":"https://github.com/rails/rails/issues/54595#issuecomment-2676690820","issue_url":"https://api.github.com/repos/rails/rails/issues/54595","id":2676690820,"node_id":"IC_kwDNIULOn4sPhA","user":{"login":"byroot","id":44640,"node_id":"MDQ6VXNlcjQ0NjQw","avatar_url":"https://avatars.githubusercontent.com/u/44640?v=4","gravatar_id":"","url":"https://api.github.com/users/byroot","html_url":"https://github.com/byroot","followers_url":"https://api.github.com/users/byroot/followers","following_url":"https://api.github.com/users/byroot/following{/other_user}","gists_url":"https://api.github.com/users/byroot/gists{/gist_id}","starred_url":"https://api.github.com/users/byroot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/byroot/subscriptions","organizations_url":"https://api.github.com/users/byroot/orgs","repos_url":"https://api.github.com/users/byroot/repos","events_url":"https://api.github.com/users/byroot/events{/privacy}","received_events_url":"https://api.github.com/users/byroot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-02-23T07:56:51Z","updated_at":"2025-02-23T07:56:51Z","body":"> Here's the the complete test code if it helps.\n\nCould you try turning it into an self contained executable test case?  https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/2676690820/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"byroot","id":44640,"node_id":"MDQ6VXNlcjQ0NjQw","avatar_url":"https://avatars.githubusercontent.com/u/44640?v=4","gravatar_id":"","url":"https://api.github.com/users/byroot","html_url":"https://github.com/byroot","followers_url":"https://api.github.com/users/byroot/followers","following_url":"https://api.github.com/users/byroot/following{/other_user}","gists_url":"https://api.github.com/users/byroot/gists{/gist_id}","starred_url":"https://api.github.com/users/byroot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/byroot/subscriptions","organizations_url":"https://api.github.com/users/byroot/orgs","repos_url":"https://api.github.com/users/byroot/repos","events_url":"https://api.github.com/users/byroot/events{/privacy}","received_events_url":"https://api.github.com/users/byroot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rails/rails/issues/comments/2682650007","html_url":"https://github.com/rails/rails/issues/54595#issuecomment-2682650007","issue_url":"https://api.github.com/repos/rails/rails/issues/54595","id":2682650007,"node_id":"IC_kwDNIULOn-X9lw","user":{"login":"Edouard-chin","id":8122246,"node_id":"MDQ6VXNlcjgxMjIyNDY=","avatar_url":"https://avatars.githubusercontent.com/u/8122246?v=4","gravatar_id":"","url":"https://api.github.com/users/Edouard-chin","html_url":"https://github.com/Edouard-chin","followers_url":"https://api.github.com/users/Edouard-chin/followers","following_url":"https://api.github.com/users/Edouard-chin/following{/other_user}","gists_url":"https://api.github.com/users/Edouard-chin/gists{/gist_id}","starred_url":"https://api.github.com/users/Edouard-chin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Edouard-chin/subscriptions","organizations_url":"https://api.github.com/users/Edouard-chin/orgs","repos_url":"https://api.github.com/users/Edouard-chin/repos","events_url":"https://api.github.com/users/Edouard-chin/events{/privacy}","received_events_url":"https://api.github.com/users/Edouard-chin/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-02-25T16:53:21Z","updated_at":"2025-02-25T16:53:49Z","body":"Are you using the `warden` gem directly or through another gem like `devise`?\n\nI know that the `devise` gem had one issue after Rails introduced the LazyRouteSet feature which could break some tests depending on the order they'd run.\nCan you reproduce the issue consistently when running the tests with the same seed?","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/2682650007/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Edouard-chin","id":8122246,"node_id":"MDQ6VXNlcjgxMjIyNDY=","avatar_url":"https://avatars.githubusercontent.com/u/8122246?v=4","gravatar_id":"","url":"https://api.github.com/users/Edouard-chin","html_url":"https://github.com/Edouard-chin","followers_url":"https://api.github.com/users/Edouard-chin/followers","following_url":"https://api.github.com/users/Edouard-chin/following{/other_user}","gists_url":"https://api.github.com/users/Edouard-chin/gists{/gist_id}","starred_url":"https://api.github.com/users/Edouard-chin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Edouard-chin/subscriptions","organizations_url":"https://api.github.com/users/Edouard-chin/orgs","repos_url":"https://api.github.com/users/Edouard-chin/repos","events_url":"https://api.github.com/users/Edouard-chin/events{/privacy}","received_events_url":"https://api.github.com/users/Edouard-chin/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":16464538534,"node_id":"LE_lADNIULOqy9hs88AAAAD1Vzrpg","url":"https://api.github.com/repos/rails/rails/issues/events/16464538534","actor":{"login":"Edouard-chin","id":8122246,"node_id":"MDQ6VXNlcjgxMjIyNDY=","avatar_url":"https://avatars.githubusercontent.com/u/8122246?v=4","gravatar_id":"","url":"https://api.github.com/users/Edouard-chin","html_url":"https://github.com/Edouard-chin","followers_url":"https://api.github.com/users/Edouard-chin/followers","following_url":"https://api.github.com/users/Edouard-chin/following{/other_user}","gists_url":"https://api.github.com/users/Edouard-chin/gists{/gist_id}","starred_url":"https://api.github.com/users/Edouard-chin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Edouard-chin/subscriptions","organizations_url":"https://api.github.com/users/Edouard-chin/orgs","repos_url":"https://api.github.com/users/Edouard-chin/repos","events_url":"https://api.github.com/users/Edouard-chin/events{/privacy}","received_events_url":"https://api.github.com/users/Edouard-chin/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2025-02-25T16:54:14Z","label":{"name":"more-information-needed","color":"bfdadc"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/comments/2682966032","html_url":"https://github.com/rails/rails/issues/54595#issuecomment-2682966032","issue_url":"https://api.github.com/repos/rails/rails/issues/54595","id":2682966032,"node_id":"IC_kwDNIULOn-rQEA","user":{"login":"quixoten","id":63675,"node_id":"MDQ6VXNlcjYzNjc1","avatar_url":"https://avatars.githubusercontent.com/u/63675?v=4","gravatar_id":"","url":"https://api.github.com/users/quixoten","html_url":"https://github.com/quixoten","followers_url":"https://api.github.com/users/quixoten/followers","following_url":"https://api.github.com/users/quixoten/following{/other_user}","gists_url":"https://api.github.com/users/quixoten/gists{/gist_id}","starred_url":"https://api.github.com/users/quixoten/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/quixoten/subscriptions","organizations_url":"https://api.github.com/users/quixoten/orgs","repos_url":"https://api.github.com/users/quixoten/repos","events_url":"https://api.github.com/users/quixoten/events{/privacy}","received_events_url":"https://api.github.com/users/quixoten/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-02-25T18:44:59Z","updated_at":"2025-02-25T18:44:59Z","body":"> Are you using the `warden` gem directly or through another gem like `devise`?\n> \n> I know that the `devise` gem had one issue after Rails introduced the LazyRouteSet feature which could break some tests depending on the order they'd run. Can you reproduce the issue consistently when running the tests with the same seed?\n\nI am using devise. Oddly, running with the same seed does not fail consistently.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/2682966032/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"quixoten","id":63675,"node_id":"MDQ6VXNlcjYzNjc1","avatar_url":"https://avatars.githubusercontent.com/u/63675?v=4","gravatar_id":"","url":"https://api.github.com/users/quixoten","html_url":"https://github.com/quixoten","followers_url":"https://api.github.com/users/quixoten/followers","following_url":"https://api.github.com/users/quixoten/following{/other_user}","gists_url":"https://api.github.com/users/quixoten/gists{/gist_id}","starred_url":"https://api.github.com/users/quixoten/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/quixoten/subscriptions","organizations_url":"https://api.github.com/users/quixoten/orgs","repos_url":"https://api.github.com/users/quixoten/repos","events_url":"https://api.github.com/users/quixoten/events{/privacy}","received_events_url":"https://api.github.com/users/quixoten/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":16466399498,"node_id":"UNLE_lADNIULOqy9hs88AAAAD1XlRCg","url":"https://api.github.com/repos/rails/rails/issues/events/16466399498","actor":{"login":"rails-bot[bot]","id":28418009,"node_id":"MDM6Qm90Mjg0MTgwMDk=","avatar_url":"https://avatars.githubusercontent.com/in/2272?v=4","gravatar_id":"","url":"https://api.github.com/users/rails-bot%5Bbot%5D","html_url":"https://github.com/apps/rails-bot","followers_url":"https://api.github.com/users/rails-bot%5Bbot%5D/followers","following_url":"https://api.github.com/users/rails-bot%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/rails-bot%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/rails-bot%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rails-bot%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/rails-bot%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/rails-bot%5Bbot%5D/repos","events_url":"https://api.github.com/users/rails-bot%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/rails-bot%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"event":"unlabeled","commit_id":null,"commit_url":null,"created_at":"2025-02-25T18:45:04Z","label":{"name":"more-information-needed","color":"bfdadc"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/comments/2683035384","html_url":"https://github.com/rails/rails/issues/54595#issuecomment-2683035384","issue_url":"https://api.github.com/repos/rails/rails/issues/54595","id":2683035384,"node_id":"IC_kwDNIULOn-ve-A","user":{"login":"quixoten","id":63675,"node_id":"MDQ6VXNlcjYzNjc1","avatar_url":"https://avatars.githubusercontent.com/u/63675?v=4","gravatar_id":"","url":"https://api.github.com/users/quixoten","html_url":"https://github.com/quixoten","followers_url":"https://api.github.com/users/quixoten/followers","following_url":"https://api.github.com/users/quixoten/following{/other_user}","gists_url":"https://api.github.com/users/quixoten/gists{/gist_id}","starred_url":"https://api.github.com/users/quixoten/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/quixoten/subscriptions","organizations_url":"https://api.github.com/users/quixoten/orgs","repos_url":"https://api.github.com/users/quixoten/repos","events_url":"https://api.github.com/users/quixoten/events{/privacy}","received_events_url":"https://api.github.com/users/quixoten/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-02-25T19:18:48Z","updated_at":"2025-02-25T19:18:48Z","body":"Actually, with `PARALLEL_WORKERS=1 bin/rails test` I can find seeds that always fail in the same way. It fails more often than not with `PARALLEL_WORKERS=1`, but I can also find seeds that always succeed.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/2683035384/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"quixoten","id":63675,"node_id":"MDQ6VXNlcjYzNjc1","avatar_url":"https://avatars.githubusercontent.com/u/63675?v=4","gravatar_id":"","url":"https://api.github.com/users/quixoten","html_url":"https://github.com/quixoten","followers_url":"https://api.github.com/users/quixoten/followers","following_url":"https://api.github.com/users/quixoten/following{/other_user}","gists_url":"https://api.github.com/users/quixoten/gists{/gist_id}","starred_url":"https://api.github.com/users/quixoten/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/quixoten/subscriptions","organizations_url":"https://api.github.com/users/quixoten/orgs","repos_url":"https://api.github.com/users/quixoten/repos","events_url":"https://api.github.com/users/quixoten/events{/privacy}","received_events_url":"https://api.github.com/users/quixoten/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rails/rails/issues/comments/2683083288","html_url":"https://github.com/rails/rails/issues/54595#issuecomment-2683083288","issue_url":"https://api.github.com/repos/rails/rails/issues/54595","id":2683083288,"node_id":"IC_kwDNIULOn-yaGA","user":{"login":"Edouard-chin","id":8122246,"node_id":"MDQ6VXNlcjgxMjIyNDY=","avatar_url":"https://avatars.githubusercontent.com/u/8122246?v=4","gravatar_id":"","url":"https://api.github.com/users/Edouard-chin","html_url":"https://github.com/Edouard-chin","followers_url":"https://api.github.com/users/Edouard-chin/followers","following_url":"https://api.github.com/users/Edouard-chin/following{/other_user}","gists_url":"https://api.github.com/users/Edouard-chin/gists{/gist_id}","starred_url":"https://api.github.com/users/Edouard-chin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Edouard-chin/subscriptions","organizations_url":"https://api.github.com/users/Edouard-chin/orgs","repos_url":"https://api.github.com/users/Edouard-chin/repos","events_url":"https://api.github.com/users/Edouard-chin/events{/privacy}","received_events_url":"https://api.github.com/users/Edouard-chin/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-02-25T19:33:53Z","updated_at":"2025-02-25T19:34:11Z","body":"Ah so that very sounds like the issue I mentioned. It was fixed in https://github.com/heartcombo/devise/pull/5728. Try to point your Gemfile on devise's main branch from github as the fix hasn't been made to a release yet and see if this fixes your problem.\n","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/2683083288/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Edouard-chin","id":8122246,"node_id":"MDQ6VXNlcjgxMjIyNDY=","avatar_url":"https://avatars.githubusercontent.com/u/8122246?v=4","gravatar_id":"","url":"https://api.github.com/users/Edouard-chin","html_url":"https://github.com/Edouard-chin","followers_url":"https://api.github.com/users/Edouard-chin/followers","following_url":"https://api.github.com/users/Edouard-chin/following{/other_user}","gists_url":"https://api.github.com/users/Edouard-chin/gists{/gist_id}","starred_url":"https://api.github.com/users/Edouard-chin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Edouard-chin/subscriptions","organizations_url":"https://api.github.com/users/Edouard-chin/orgs","repos_url":"https://api.github.com/users/Edouard-chin/repos","events_url":"https://api.github.com/users/Edouard-chin/events{/privacy}","received_events_url":"https://api.github.com/users/Edouard-chin/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rails/rails/issues/comments/2685901948","html_url":"https://github.com/rails/rails/issues/54595#issuecomment-2685901948","issue_url":"https://api.github.com/repos/rails/rails/issues/54595","id":2685901948,"node_id":"IC_kwDNIULOoBecfA","user":{"login":"quixoten","id":63675,"node_id":"MDQ6VXNlcjYzNjc1","avatar_url":"https://avatars.githubusercontent.com/u/63675?v=4","gravatar_id":"","url":"https://api.github.com/users/quixoten","html_url":"https://github.com/quixoten","followers_url":"https://api.github.com/users/quixoten/followers","following_url":"https://api.github.com/users/quixoten/following{/other_user}","gists_url":"https://api.github.com/users/quixoten/gists{/gist_id}","starred_url":"https://api.github.com/users/quixoten/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/quixoten/subscriptions","organizations_url":"https://api.github.com/users/quixoten/orgs","repos_url":"https://api.github.com/users/quixoten/repos","events_url":"https://api.github.com/users/quixoten/events{/privacy}","received_events_url":"https://api.github.com/users/quixoten/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-02-26T18:45:09Z","updated_at":"2025-02-26T18:45:09Z","body":"@Edouard-chin, thanks for the guidance! I found that my tests still failed consistently (`PARALLEL_WORKERS=1 bin/rails test --seed 29227`) using the `main` branch of devise, but it got me on the right track. After adding `Rails.application.try(:reload_routes_unless_loaded)` to my test:\n\n```ruby\nclass ErrorPagesTest < ActionDispatch::IntegrationTest\n  Rails.application.try(:reload_routes_unless_loaded)\n\n  with_routing do |routes|\n  ...\n  end\n\n  ...\nend\n```\n\nmy test suite passes consistently again. I found that I had to call `reload_routes_unless_loaded` before `with_routing` to get it to work. Putting it inside the `with_routing` block had no effect. I also verified that the following \"patch\" worked:\n\n```ruby\nmodule ActionDispatch::Assertions::RoutingAssertions::WithIntegrationRouting::ClassMethods\n  def with_routing(&block)\n    Rails.application.try(:reload_routes_unless_loaded)\n    # .. existing code left unchanged\n  end\nend\n```\n\nWould it make sense to open a PR with this change? Would all the `with_routing` methods (I count 4) require this addition?","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/2685901948/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"quixoten","id":63675,"node_id":"MDQ6VXNlcjYzNjc1","avatar_url":"https://avatars.githubusercontent.com/u/63675?v=4","gravatar_id":"","url":"https://api.github.com/users/quixoten","html_url":"https://github.com/quixoten","followers_url":"https://api.github.com/users/quixoten/followers","following_url":"https://api.github.com/users/quixoten/following{/other_user}","gists_url":"https://api.github.com/users/quixoten/gists{/gist_id}","starred_url":"https://api.github.com/users/quixoten/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/quixoten/subscriptions","organizations_url":"https://api.github.com/users/quixoten/orgs","repos_url":"https://api.github.com/users/quixoten/repos","events_url":"https://api.github.com/users/quixoten/events{/privacy}","received_events_url":"https://api.github.com/users/quixoten/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":16484912228,"node_id":"MEE_lADNIULOqy9hs88AAAAD1pPMZA","url":"https://api.github.com/repos/rails/rails/issues/events/16484912228","actor":{"login":"Edouard-chin","id":8122246,"node_id":"MDQ6VXNlcjgxMjIyNDY=","avatar_url":"https://avatars.githubusercontent.com/u/8122246?v=4","gravatar_id":"","url":"https://api.github.com/users/Edouard-chin","html_url":"https://github.com/Edouard-chin","followers_url":"https://api.github.com/users/Edouard-chin/followers","following_url":"https://api.github.com/users/Edouard-chin/following{/other_user}","gists_url":"https://api.github.com/users/Edouard-chin/gists{/gist_id}","starred_url":"https://api.github.com/users/Edouard-chin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Edouard-chin/subscriptions","organizations_url":"https://api.github.com/users/Edouard-chin/orgs","repos_url":"https://api.github.com/users/Edouard-chin/repos","events_url":"https://api.github.com/users/Edouard-chin/events{/privacy}","received_events_url":"https://api.github.com/users/Edouard-chin/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2025-02-26T18:45:11Z","performed_via_github_app":null},{"id":16484912305,"node_id":"SE_lADNIULOqy9hs88AAAAD1pPMsQ","url":"https://api.github.com/repos/rails/rails/issues/events/16484912305","actor":{"login":"Edouard-chin","id":8122246,"node_id":"MDQ6VXNlcjgxMjIyNDY=","avatar_url":"https://avatars.githubusercontent.com/u/8122246?v=4","gravatar_id":"","url":"https://api.github.com/users/Edouard-chin","html_url":"https://github.com/Edouard-chin","followers_url":"https://api.github.com/users/Edouard-chin/followers","following_url":"https://api.github.com/users/Edouard-chin/following{/other_user}","gists_url":"https://api.github.com/users/Edouard-chin/gists{/gist_id}","starred_url":"https://api.github.com/users/Edouard-chin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Edouard-chin/subscriptions","organizations_url":"https://api.github.com/users/Edouard-chin/orgs","repos_url":"https://api.github.com/users/Edouard-chin/repos","events_url":"https://api.github.com/users/Edouard-chin/events{/privacy}","received_events_url":"https://api.github.com/users/Edouard-chin/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2025-02-26T18:45:11Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/comments/2688312191","html_url":"https://github.com/rails/rails/issues/54595#issuecomment-2688312191","issue_url":"https://api.github.com/repos/rails/rails/issues/54595","id":2688312191,"node_id":"IC_kwDNIULOoDxjfw","user":{"login":"Edouard-chin","id":8122246,"node_id":"MDQ6VXNlcjgxMjIyNDY=","avatar_url":"https://avatars.githubusercontent.com/u/8122246?v=4","gravatar_id":"","url":"https://api.github.com/users/Edouard-chin","html_url":"https://github.com/Edouard-chin","followers_url":"https://api.github.com/users/Edouard-chin/followers","following_url":"https://api.github.com/users/Edouard-chin/following{/other_user}","gists_url":"https://api.github.com/users/Edouard-chin/gists{/gist_id}","starred_url":"https://api.github.com/users/Edouard-chin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Edouard-chin/subscriptions","organizations_url":"https://api.github.com/users/Edouard-chin/orgs","repos_url":"https://api.github.com/users/Edouard-chin/repos","events_url":"https://api.github.com/users/Edouard-chin/events{/privacy}","received_events_url":"https://api.github.com/users/Edouard-chin/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-02-27T15:31:15Z","updated_at":"2025-02-27T15:31:15Z","body":"Thanks for digging on this. Glad that you found a temporary solution.\n\n> Would it make sense to open a PR with this change? \n\nDon't take my words for granted as I haven't looked, but I don't think so.\nThe `with_routing` is supposed to create a temporary route set (which doesn't use the lazy load feature), so reloading the previous route set that aren't going to be used should have no influence. Though I understand it fixes your issue somehow, I suspect the issue would need to be fixed on devise rather than Rails.\n\nNow that we have scoped down the issue, maybe you can try creating a reproduction script without devise and see if the issue is really in Rails' `with_routing` method.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/2688312191/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Edouard-chin","id":8122246,"node_id":"MDQ6VXNlcjgxMjIyNDY=","avatar_url":"https://avatars.githubusercontent.com/u/8122246?v=4","gravatar_id":"","url":"https://api.github.com/users/Edouard-chin","html_url":"https://github.com/Edouard-chin","followers_url":"https://api.github.com/users/Edouard-chin/followers","following_url":"https://api.github.com/users/Edouard-chin/following{/other_user}","gists_url":"https://api.github.com/users/Edouard-chin/gists{/gist_id}","starred_url":"https://api.github.com/users/Edouard-chin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Edouard-chin/subscriptions","organizations_url":"https://api.github.com/users/Edouard-chin/orgs","repos_url":"https://api.github.com/users/Edouard-chin/repos","events_url":"https://api.github.com/users/Edouard-chin/events{/privacy}","received_events_url":"https://api.github.com/users/Edouard-chin/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rails/rails/issues/comments/2692511748","html_url":"https://github.com/rails/rails/issues/54595#issuecomment-2692511748","issue_url":"https://api.github.com/repos/rails/rails/issues/54595","id":2692511748,"node_id":"IC_kwDNIULOoHx4BA","user":{"login":"quixoten","id":63675,"node_id":"MDQ6VXNlcjYzNjc1","avatar_url":"https://avatars.githubusercontent.com/u/63675?v=4","gravatar_id":"","url":"https://api.github.com/users/quixoten","html_url":"https://github.com/quixoten","followers_url":"https://api.github.com/users/quixoten/followers","following_url":"https://api.github.com/users/quixoten/following{/other_user}","gists_url":"https://api.github.com/users/quixoten/gists{/gist_id}","starred_url":"https://api.github.com/users/quixoten/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/quixoten/subscriptions","organizations_url":"https://api.github.com/users/quixoten/orgs","repos_url":"https://api.github.com/users/quixoten/repos","events_url":"https://api.github.com/users/quixoten/events{/privacy}","received_events_url":"https://api.github.com/users/quixoten/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-03-02T01:58:46Z","updated_at":"2025-03-02T01:58:46Z","body":"Here's an executable reproduction:\n\n```ruby\n# frozen_string_literal: true\n\nrequire \"bundler/inline\"\n\ngemfile(true) do\n  source \"https://rubygems.org\"\n  gem \"rails\"\n  gem \"devise\", github: \"heartcombo/devise\", ref: \"fec67f98f26fcd9a79072e4581b1bd40d0c7fa1d\"\n  gem \"sqlite3\"\nend\n\nrequire \"action_controller/railtie\"\nrequire \"active_record/railtie\"\nrequire \"devise/orm/active_record\"\nrequire \"minitest/autorun\"\nrequire \"rack/test\"\n\nENV[\"DATABASE_URL\"] = \"sqlite3::memory:\"\n\nclass TestApp < Rails::Application\n  config.load_defaults Rails::VERSION::STRING.to_f\n  config.root = __dir__\n  config.eager_load = false\n  config.hosts.clear\n  config.secret_key_base = \"secret_key_base\"\n\n  config.logger = Logger.new($stdout)\n  config.active_record.encryption.primary_key = \"primary_key\"\n  config.active_record.encryption.deterministic_key = \"deterministic_key\"\n  config.active_record.encryption.key_derivation_salt = \"key_derivation_salt\"\nend\nRails.application.initialize!\n\nActiveRecord::Schema.define do\n  create_table \"users\", force: :cascade do |t|\n    t.string \"email\", default: \"\", null: false\n    t.string \"encrypted_password\", default: \"\", null: false\n    t.string \"reset_password_token\"\n    t.datetime \"reset_password_sent_at\"\n    t.datetime \"remember_created_at\"\n    t.datetime \"created_at\", null: false\n    t.datetime \"updated_at\", null: false\n    t.index [\"email\"], name: \"index_users_on_email\", unique: true\n    t.index [\"reset_password_token\"], name: \"index_users_on_reset_password_token\", unique: true\n  end\nend\n\nclass User < ActiveRecord::Base\n  devise :database_authenticatable, :registerable, :recoverable, :rememberable, :validatable\nend\n\nUSERS = {\n  one: User.create!(email: \"one@example.com\", password: \"secret\")\n}\n\nRails.application.routes.draw do\n  devise_for :users\n\n  # NOTE: if you uncomment this route and remove the with_routing block below,\n  # the error (No Failure App provided) goes away\n\n  # get \"/no-failure-app\", to: \"no_failure_app#index\"\nend\n\nclass ApplicationController < ActionController::Base\n  before_action :authenticate_user!\nend\n\nclass NoFailureAppController < ApplicationController\n  def index\n    render json: { msg: \"no failure app\" }\n  end\nend\n\nclass NoFailureAppControllerTest < ActionDispatch::IntegrationTest\n  include Devise::Test::IntegrationHelpers\n\n  # NOTE: If you remove this with_routing block and uncomment the route above,\n  # the error (No Failure App provided) goes away\n\n  with_routing do |routes|\n    routes.draw do\n      get \"/no-failure-app\", to: \"no_failure_app#index\"\n    end\n  end\n\n  def test_no_failure_app\n    get \"/no-failure-app\"\n    assert_response :found\n  end\nend\n```","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/2692511748/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"quixoten","id":63675,"node_id":"MDQ6VXNlcjYzNjc1","avatar_url":"https://avatars.githubusercontent.com/u/63675?v=4","gravatar_id":"","url":"https://api.github.com/users/quixoten","html_url":"https://github.com/quixoten","followers_url":"https://api.github.com/users/quixoten/followers","following_url":"https://api.github.com/users/quixoten/following{/other_user}","gists_url":"https://api.github.com/users/quixoten/gists{/gist_id}","starred_url":"https://api.github.com/users/quixoten/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/quixoten/subscriptions","organizations_url":"https://api.github.com/users/quixoten/orgs","repos_url":"https://api.github.com/users/quixoten/repos","events_url":"https://api.github.com/users/quixoten/events{/privacy}","received_events_url":"https://api.github.com/users/quixoten/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rails/rails/issues/comments/2692574643","html_url":"https://github.com/rails/rails/issues/54595#issuecomment-2692574643","issue_url":"https://api.github.com/repos/rails/rails/issues/54595","id":2692574643,"node_id":"IC_kwDNIULOoH1tsw","user":{"login":"yedhink","id":31244999,"node_id":"MDQ6VXNlcjMxMjQ0OTk5","avatar_url":"https://avatars.githubusercontent.com/u/31244999?v=4","gravatar_id":"","url":"https://api.github.com/users/yedhink","html_url":"https://github.com/yedhink","followers_url":"https://api.github.com/users/yedhink/followers","following_url":"https://api.github.com/users/yedhink/following{/other_user}","gists_url":"https://api.github.com/users/yedhink/gists{/gist_id}","starred_url":"https://api.github.com/users/yedhink/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yedhink/subscriptions","organizations_url":"https://api.github.com/users/yedhink/orgs","repos_url":"https://api.github.com/users/yedhink/repos","events_url":"https://api.github.com/users/yedhink/events{/privacy}","received_events_url":"https://api.github.com/users/yedhink/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-03-02T05:58:21Z","updated_at":"2025-03-02T05:58:21Z","body":"I tested the executable test code. For some reason the `warden_config.failure_app` is getting reset to `nil` in the `with_routing` block, which in turn leads to a `500 internal server error`: https://github.com/heartcombo/devise/blob/main/lib/devise.rb#L489\n\nI even tried setting the Devise mapping, which in turn adds a [default_failure_app](https://github.com/heartcombo/devise/blob/fec67f98f26fcd9a79072e4581b1bd40d0c7fa1d/lib/devise/mapping.rb#L123-L129), but that was also in vain because the `warden_config` is getting reset:\n```diff\nwith_routing do |routes|\n    routes.draw do\n+      devise_for :users\n      get \"/no-failure-app\", to: \"no_failure_app#index\"\n    end\n  end\n```\n\nBefore the `with_routing` block:\n```\n(byebug) Devise.warden_config\n{default_scope: nil, scope_defaults: {}, default_strategies: {}, intercept_401: false, failure_app: #<Devise::Delegator:0x0000000129accf18>}\n```\n\nAfter the `with_routing` block:\n```\n(byebug) Devise.warden_config\n{default_scope: :default, scope_defaults: {}, default_strategies: {}, intercept_401: true}\n```\n\n\nOn another note, I think we are supposed to pass assertions associated with custom routes within the `with_routing` block - refer: https://api.rubyonrails.org/v8.0/classes/ActionDispatch/Assertions/RoutingAssertions.html#method-i-with_routing:\n```rb\n  def test_no_failure_app\n    with_routing do |routes|\n      routes.draw do\n        devise_for :users\n        get '/no-failure-app', to: 'no_failure_app#index'\n      end\n\n      get '/no-failure-app'\n      assert_response :found\n    end\n  end\n```\n\nI still havent' figured out what's resetting the `warden_config` when `with_routing` block gets executed.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/2692574643/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"yedhink","id":31244999,"node_id":"MDQ6VXNlcjMxMjQ0OTk5","avatar_url":"https://avatars.githubusercontent.com/u/31244999?v=4","gravatar_id":"","url":"https://api.github.com/users/yedhink","html_url":"https://github.com/yedhink","followers_url":"https://api.github.com/users/yedhink/followers","following_url":"https://api.github.com/users/yedhink/following{/other_user}","gists_url":"https://api.github.com/users/yedhink/gists{/gist_id}","starred_url":"https://api.github.com/users/yedhink/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yedhink/subscriptions","organizations_url":"https://api.github.com/users/yedhink/orgs","repos_url":"https://api.github.com/users/yedhink/repos","events_url":"https://api.github.com/users/yedhink/events{/privacy}","received_events_url":"https://api.github.com/users/yedhink/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rails/rails/issues/comments/2694415511","html_url":"https://github.com/rails/rails/issues/54595#issuecomment-2694415511","issue_url":"https://api.github.com/repos/rails/rails/issues/54595","id":2694415511,"node_id":"IC_kwDNIULOoJmElw","user":{"login":"Edouard-chin","id":8122246,"node_id":"MDQ6VXNlcjgxMjIyNDY=","avatar_url":"https://avatars.githubusercontent.com/u/8122246?v=4","gravatar_id":"","url":"https://api.github.com/users/Edouard-chin","html_url":"https://github.com/Edouard-chin","followers_url":"https://api.github.com/users/Edouard-chin/followers","following_url":"https://api.github.com/users/Edouard-chin/following{/other_user}","gists_url":"https://api.github.com/users/Edouard-chin/gists{/gist_id}","starred_url":"https://api.github.com/users/Edouard-chin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Edouard-chin/subscriptions","organizations_url":"https://api.github.com/users/Edouard-chin/orgs","repos_url":"https://api.github.com/users/Edouard-chin/repos","events_url":"https://api.github.com/users/Edouard-chin/events{/privacy}","received_events_url":"https://api.github.com/users/Edouard-chin/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-03-03T13:35:28Z","updated_at":"2025-03-03T13:35:28Z","body":"Thanks for the reproduction script! It's indeed a problem in devise that started since Rails 7.2\n\nI submitted a PR to fix this upstream: https://github.com/heartcombo/devise/pull/5769 Hopefully it will get accepted.\n\nI'll close this issue since there is not much to do in Rails.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/2694415511/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Edouard-chin","id":8122246,"node_id":"MDQ6VXNlcjgxMjIyNDY=","avatar_url":"https://avatars.githubusercontent.com/u/8122246?v=4","gravatar_id":"","url":"https://api.github.com/users/Edouard-chin","html_url":"https://github.com/Edouard-chin","followers_url":"https://api.github.com/users/Edouard-chin/followers","following_url":"https://api.github.com/users/Edouard-chin/following{/other_user}","gists_url":"https://api.github.com/users/Edouard-chin/gists{/gist_id}","starred_url":"https://api.github.com/users/Edouard-chin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Edouard-chin/subscriptions","organizations_url":"https://api.github.com/users/Edouard-chin/orgs","repos_url":"https://api.github.com/users/Edouard-chin/repos","events_url":"https://api.github.com/users/Edouard-chin/events{/privacy}","received_events_url":"https://api.github.com/users/Edouard-chin/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":16534604022,"node_id":"CE_lADNIULOqy9hs88AAAAD2YoI9g","url":"https://api.github.com/repos/rails/rails/issues/events/16534604022","actor":{"login":"Edouard-chin","id":8122246,"node_id":"MDQ6VXNlcjgxMjIyNDY=","avatar_url":"https://avatars.githubusercontent.com/u/8122246?v=4","gravatar_id":"","url":"https://api.github.com/users/Edouard-chin","html_url":"https://github.com/Edouard-chin","followers_url":"https://api.github.com/users/Edouard-chin/followers","following_url":"https://api.github.com/users/Edouard-chin/following{/other_user}","gists_url":"https://api.github.com/users/Edouard-chin/gists{/gist_id}","starred_url":"https://api.github.com/users/Edouard-chin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Edouard-chin/subscriptions","organizations_url":"https://api.github.com/users/Edouard-chin/orgs","repos_url":"https://api.github.com/users/Edouard-chin/repos","events_url":"https://api.github.com/users/Edouard-chin/events{/privacy}","received_events_url":"https://api.github.com/users/Edouard-chin/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2025-03-03T13:35:28Z","state_reason":null,"performed_via_github_app":null},{"id":16620471809,"node_id":"REFE_lADNIULOqy9hs88AAAAD3qhGAQ","url":"https://api.github.com/repos/rails/rails/issues/events/16620471809","actor":{"login":"Edouard-chin","id":8122246,"node_id":"MDQ6VXNlcjgxMjIyNDY=","avatar_url":"https://avatars.githubusercontent.com/u/8122246?v=4","gravatar_id":"","url":"https://api.github.com/users/Edouard-chin","html_url":"https://github.com/Edouard-chin","followers_url":"https://api.github.com/users/Edouard-chin/followers","following_url":"https://api.github.com/users/Edouard-chin/following{/other_user}","gists_url":"https://api.github.com/users/Edouard-chin/gists{/gist_id}","starred_url":"https://api.github.com/users/Edouard-chin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Edouard-chin/subscriptions","organizations_url":"https://api.github.com/users/Edouard-chin/orgs","repos_url":"https://api.github.com/users/Edouard-chin/repos","events_url":"https://api.github.com/users/Edouard-chin/events{/privacy}","received_events_url":"https://api.github.com/users/Edouard-chin/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"7c99813448db5718331f9f710dca05752ffadb4b","commit_url":"https://api.github.com/repos/Edouard-chin/rails/commits/7c99813448db5718331f9f710dca05752ffadb4b","created_at":"2025-03-06T16:55:11Z","performed_via_github_app":null},{"actor":{"login":"Edouard-chin","id":8122246,"node_id":"MDQ6VXNlcjgxMjIyNDY=","avatar_url":"https://avatars.githubusercontent.com/u/8122246?v=4","gravatar_id":"","url":"https://api.github.com/users/Edouard-chin","html_url":"https://github.com/Edouard-chin","followers_url":"https://api.github.com/users/Edouard-chin/followers","following_url":"https://api.github.com/users/Edouard-chin/following{/other_user}","gists_url":"https://api.github.com/users/Edouard-chin/gists{/gist_id}","starred_url":"https://api.github.com/users/Edouard-chin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Edouard-chin/subscriptions","organizations_url":"https://api.github.com/users/Edouard-chin/orgs","repos_url":"https://api.github.com/users/Edouard-chin/repos","events_url":"https://api.github.com/users/Edouard-chin/events{/privacy}","received_events_url":"https://api.github.com/users/Edouard-chin/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-03-06T16:57:46Z","updated_at":"2025-03-06T16:57:46Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/rails/rails/issues/54705","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/54705/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/54705/comments","events_url":"https://api.github.com/repos/rails/rails/issues/54705/events","html_url":"https://github.com/rails/rails/pull/54705","id":2900945486,"node_id":"PR_kwDNIULOjasbrg","number":54705,"title":"Don't rebuild the middleware stack when using `with_routing`","user":{"login":"Edouard-chin","id":8122246,"node_id":"MDQ6VXNlcjgxMjIyNDY=","avatar_url":"https://avatars.githubusercontent.com/u/8122246?v=4","gravatar_id":"","url":"https://api.github.com/users/Edouard-chin","html_url":"https://github.com/Edouard-chin","followers_url":"https://api.github.com/users/Edouard-chin/followers","following_url":"https://api.github.com/users/Edouard-chin/following{/other_user}","gists_url":"https://api.github.com/users/Edouard-chin/gists{/gist_id}","starred_url":"https://api.github.com/users/Edouard-chin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Edouard-chin/subscriptions","organizations_url":"https://api.github.com/users/Edouard-chin/orgs","repos_url":"https://api.github.com/users/Edouard-chin/repos","events_url":"https://api.github.com/users/Edouard-chin/events{/privacy}","received_events_url":"https://api.github.com/users/Edouard-chin/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":107189,"node_id":"MDU6TGFiZWwxMDcxODk=","url":"https://api.github.com/repos/rails/rails/labels/actionpack","name":"actionpack","color":"FFF700","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2025-03-06T16:57:45Z","updated_at":"2025-03-07T13:56:18Z","closed_at":"2025-03-07T13:38:58Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":8514,"node_id":"MDEwOlJlcG9zaXRvcnk4NTE0","name":"rails","full_name":"rails/rails","private":false,"owner":{"login":"rails","id":4223,"node_id":"MDEyOk9yZ2FuaXphdGlvbjQyMjM=","avatar_url":"https://avatars.githubusercontent.com/u/4223?v=4","gravatar_id":"","url":"https://api.github.com/users/rails","html_url":"https://github.com/rails","followers_url":"https://api.github.com/users/rails/followers","following_url":"https://api.github.com/users/rails/following{/other_user}","gists_url":"https://api.github.com/users/rails/gists{/gist_id}","starred_url":"https://api.github.com/users/rails/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rails/subscriptions","organizations_url":"https://api.github.com/users/rails/orgs","repos_url":"https://api.github.com/users/rails/repos","events_url":"https://api.github.com/users/rails/events{/privacy}","received_events_url":"https://api.github.com/users/rails/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/rails/rails","description":"Ruby on Rails","fork":false,"url":"https://api.github.com/repos/rails/rails","forks_url":"https://api.github.com/repos/rails/rails/forks","keys_url":"https://api.github.com/repos/rails/rails/keys{/key_id}","collaborators_url":"https://api.github.com/repos/rails/rails/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/rails/rails/teams","hooks_url":"https://api.github.com/repos/rails/rails/hooks","issue_events_url":"https://api.github.com/repos/rails/rails/issues/events{/number}","events_url":"https://api.github.com/repos/rails/rails/events","assignees_url":"https://api.github.com/repos/rails/rails/assignees{/user}","branches_url":"https://api.github.com/repos/rails/rails/branches{/branch}","tags_url":"https://api.github.com/repos/rails/rails/tags","blobs_url":"https://api.github.com/repos/rails/rails/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/rails/rails/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/rails/rails/git/refs{/sha}","trees_url":"https://api.github.com/repos/rails/rails/git/trees{/sha}","statuses_url":"https://api.github.com/repos/rails/rails/statuses/{sha}","languages_url":"https://api.github.com/repos/rails/rails/languages","stargazers_url":"https://api.github.com/repos/rails/rails/stargazers","contributors_url":"https://api.github.com/repos/rails/rails/contributors","subscribers_url":"https://api.github.com/repos/rails/rails/subscribers","subscription_url":"https://api.github.com/repos/rails/rails/subscription","commits_url":"https://api.github.com/repos/rails/rails/commits{/sha}","git_commits_url":"https://api.github.com/repos/rails/rails/git/commits{/sha}","comments_url":"https://api.github.com/repos/rails/rails/comments{/number}","issue_comment_url":"https://api.github.com/repos/rails/rails/issues/comments{/number}","contents_url":"https://api.github.com/repos/rails/rails/contents/{+path}","compare_url":"https://api.github.com/repos/rails/rails/compare/{base}...{head}","merges_url":"https://api.github.com/repos/rails/rails/merges","archive_url":"https://api.github.com/repos/rails/rails/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/rails/rails/downloads","issues_url":"https://api.github.com/repos/rails/rails/issues{/number}","pulls_url":"https://api.github.com/repos/rails/rails/pulls{/number}","milestones_url":"https://api.github.com/repos/rails/rails/milestones{/number}","notifications_url":"https://api.github.com/repos/rails/rails/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/rails/rails/labels{/name}","releases_url":"https://api.github.com/repos/rails/rails/releases{/id}","deployments_url":"https://api.github.com/repos/rails/rails/deployments","created_at":"2008-04-11T02:19:47Z","updated_at":"2025-11-10T02:03:47Z","pushed_at":"2025-11-10T00:33:52Z","git_url":"git://github.com/rails/rails.git","ssh_url":"git@github.com:rails/rails.git","clone_url":"https://github.com/rails/rails.git","svn_url":"https://github.com/rails/rails","homepage":"https://rubyonrails.org","size":271619,"stargazers_count":57840,"watchers_count":57840,"language":"Ruby","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":true,"forks_count":22025,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":1341,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["activejob","activerecord","framework","html","mvc","rails","ruby"],"visibility":"public","forks":22025,"open_issues":1341,"watchers":57840,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/rails/rails/pulls/54705","html_url":"https://github.com/rails/rails/pull/54705","diff_url":"https://github.com/rails/rails/pull/54705.diff","patch_url":"https://github.com/rails/rails/pull/54705.patch","merged_at":"2025-03-07T13:38:58Z"},"body":"### Motivation / Background\r\n\r\nFix #54595\r\n\r\n### Detail\r\n\r\n#### Problem\r\n\r\nWhen using the `with_routing` helper method in an integration test, we rebuild the middleware stack so that the entrypoint of our new stack is the new RouteSet object.\r\n\r\nBy rebuilding the middleware stack from scratch, we may end un-configuring a middleware from an application. We also break the contract of the Rails initialization process.\r\n\r\nFor instance, if you have a middleware that needs to be configured, after the Rails routes are loaded, this is what it would look like:\r\n\r\n```ruby\r\n# config/application.rb\r\n\r\nwarden_config = nil\r\n\r\nconfig.middleware.use Warden::Manager do |config|\r\n  # The Warden middleware yields its config when the middleware is\r\n  # instantiated. We can't configure warden yet as the routes\r\n  # are not yet loaded.\r\n\r\n  warden_config = config\r\nend\r\n\r\ninitializer :configure_warden do\r\n  ActiveSupport.on_load(:after_routes_loaded) do\r\n    # The routes are now loaded, we can configure warden\r\n  end\r\nend\r\n```\r\n\r\nThis snippet follows the order of the documented Rails initialization process where first the middleware stack is built and then the routes gets loaded.\r\n\r\n--------------------\r\n\r\nBy rebuilding the middleware stack, we unconfigure what was done in the initializer.\r\n\r\n### Solution\r\n\r\nSince rebuilding the middleware stack has some caveats, my idea is to modify the middleware stack original entry point and redefine `call` so that it calls our new RouteSet middleware.\r\nWe have a reference to the original RouteSet middleware thanks to the `application.routes` method.\r\n\r\n\r\n### Checklist\r\n\r\nBefore submitting the PR make sure the following are checked:\r\n\r\n* [x] This Pull Request is related to one change. Unrelated changes should be opened in separate PRs.\r\n* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`\r\n* [x] Tests are added or updated if you fix a bug or add a feature.\r\n* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/54705/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/54705/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"url":"https://api.github.com/repos/rails/rails/issues/comments/2704421978","html_url":"https://github.com/rails/rails/issues/54595#issuecomment-2704421978","issue_url":"https://api.github.com/repos/rails/rails/issues/54595","id":2704421978,"node_id":"IC_kwDNIULOoTI0Wg","user":{"login":"Edouard-chin","id":8122246,"node_id":"MDQ6VXNlcjgxMjIyNDY=","avatar_url":"https://avatars.githubusercontent.com/u/8122246?v=4","gravatar_id":"","url":"https://api.github.com/users/Edouard-chin","html_url":"https://github.com/Edouard-chin","followers_url":"https://api.github.com/users/Edouard-chin/followers","following_url":"https://api.github.com/users/Edouard-chin/following{/other_user}","gists_url":"https://api.github.com/users/Edouard-chin/gists{/gist_id}","starred_url":"https://api.github.com/users/Edouard-chin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Edouard-chin/subscriptions","organizations_url":"https://api.github.com/users/Edouard-chin/orgs","repos_url":"https://api.github.com/users/Edouard-chin/repos","events_url":"https://api.github.com/users/Edouard-chin/events{/privacy}","received_events_url":"https://api.github.com/users/Edouard-chin/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-03-06T17:00:33Z","updated_at":"2025-03-06T17:00:33Z","body":"I'm going to reopen because after digging, I think I found a legitimate issue with the `with_routing` implementation. I originally closed as I saw that devise was using some sort of monkeypatch on the RouteSet object and I figured this would need to be fixed there.\n\nBut even without monkeypatching and configuring a middleware the \"Rails' way\", I couldn't figure out how to workaround the issue so I believe this would need to be fixed in Rails.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/2704421978/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Edouard-chin","id":8122246,"node_id":"MDQ6VXNlcjgxMjIyNDY=","avatar_url":"https://avatars.githubusercontent.com/u/8122246?v=4","gravatar_id":"","url":"https://api.github.com/users/Edouard-chin","html_url":"https://github.com/Edouard-chin","followers_url":"https://api.github.com/users/Edouard-chin/followers","following_url":"https://api.github.com/users/Edouard-chin/following{/other_user}","gists_url":"https://api.github.com/users/Edouard-chin/gists{/gist_id}","starred_url":"https://api.github.com/users/Edouard-chin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Edouard-chin/subscriptions","organizations_url":"https://api.github.com/users/Edouard-chin/orgs","repos_url":"https://api.github.com/users/Edouard-chin/repos","events_url":"https://api.github.com/users/Edouard-chin/events{/privacy}","received_events_url":"https://api.github.com/users/Edouard-chin/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":16620545576,"node_id":"REE_lADNIULOqy9hs88AAAAD3qlmKA","url":"https://api.github.com/repos/rails/rails/issues/events/16620545576","actor":{"login":"Edouard-chin","id":8122246,"node_id":"MDQ6VXNlcjgxMjIyNDY=","avatar_url":"https://avatars.githubusercontent.com/u/8122246?v=4","gravatar_id":"","url":"https://api.github.com/users/Edouard-chin","html_url":"https://github.com/Edouard-chin","followers_url":"https://api.github.com/users/Edouard-chin/followers","following_url":"https://api.github.com/users/Edouard-chin/following{/other_user}","gists_url":"https://api.github.com/users/Edouard-chin/gists{/gist_id}","starred_url":"https://api.github.com/users/Edouard-chin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Edouard-chin/subscriptions","organizations_url":"https://api.github.com/users/Edouard-chin/orgs","repos_url":"https://api.github.com/users/Edouard-chin/repos","events_url":"https://api.github.com/users/Edouard-chin/events{/privacy}","received_events_url":"https://api.github.com/users/Edouard-chin/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"reopened","commit_id":null,"commit_url":null,"created_at":"2025-03-06T17:00:33Z","state_reason":"reopened","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/comments/2704503675","html_url":"https://github.com/rails/rails/issues/54595#issuecomment-2704503675","issue_url":"https://api.github.com/repos/rails/rails/issues/54595","id":2704503675,"node_id":"IC_kwDNIULOoTNzew","user":{"login":"byroot","id":44640,"node_id":"MDQ6VXNlcjQ0NjQw","avatar_url":"https://avatars.githubusercontent.com/u/44640?v=4","gravatar_id":"","url":"https://api.github.com/users/byroot","html_url":"https://github.com/byroot","followers_url":"https://api.github.com/users/byroot/followers","following_url":"https://api.github.com/users/byroot/following{/other_user}","gists_url":"https://api.github.com/users/byroot/gists{/gist_id}","starred_url":"https://api.github.com/users/byroot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/byroot/subscriptions","organizations_url":"https://api.github.com/users/byroot/orgs","repos_url":"https://api.github.com/users/byroot/repos","events_url":"https://api.github.com/users/byroot/events{/privacy}","received_events_url":"https://api.github.com/users/byroot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-03-06T17:30:17Z","updated_at":"2025-03-06T17:30:17Z","body":"> But even without monkeypatching and configuring a middleware the \"Rails' way\",\n\nYou have a pure Rails repro?","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/2704503675/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"byroot","id":44640,"node_id":"MDQ6VXNlcjQ0NjQw","avatar_url":"https://avatars.githubusercontent.com/u/44640?v=4","gravatar_id":"","url":"https://api.github.com/users/byroot","html_url":"https://github.com/byroot","followers_url":"https://api.github.com/users/byroot/followers","following_url":"https://api.github.com/users/byroot/following{/other_user}","gists_url":"https://api.github.com/users/byroot/gists{/gist_id}","starred_url":"https://api.github.com/users/byroot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/byroot/subscriptions","organizations_url":"https://api.github.com/users/byroot/orgs","repos_url":"https://api.github.com/users/byroot/repos","events_url":"https://api.github.com/users/byroot/events{/privacy}","received_events_url":"https://api.github.com/users/byroot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rails/rails/issues/comments/2704555216","html_url":"https://github.com/rails/rails/issues/54595#issuecomment-2704555216","issue_url":"https://api.github.com/repos/rails/rails/issues/54595","id":2704555216,"node_id":"IC_kwDNIULOoTQ80A","user":{"login":"Edouard-chin","id":8122246,"node_id":"MDQ6VXNlcjgxMjIyNDY=","avatar_url":"https://avatars.githubusercontent.com/u/8122246?v=4","gravatar_id":"","url":"https://api.github.com/users/Edouard-chin","html_url":"https://github.com/Edouard-chin","followers_url":"https://api.github.com/users/Edouard-chin/followers","following_url":"https://api.github.com/users/Edouard-chin/following{/other_user}","gists_url":"https://api.github.com/users/Edouard-chin/gists{/gist_id}","starred_url":"https://api.github.com/users/Edouard-chin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Edouard-chin/subscriptions","organizations_url":"https://api.github.com/users/Edouard-chin/orgs","repos_url":"https://api.github.com/users/Edouard-chin/repos","events_url":"https://api.github.com/users/Edouard-chin/events{/privacy}","received_events_url":"https://api.github.com/users/Edouard-chin/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-03-06T17:52:29Z","updated_at":"2025-03-06T17:53:14Z","body":"I have opened #54705, with a concrete example. If you'd like a pure Rails repo, I can work on creating a new app and showcase the issue\n\n> You have a pure Rails repro?\n\n I read \"repo\". Either way, let me know if the example in the PR is convincing enough :)","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/2704555216/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Edouard-chin","id":8122246,"node_id":"MDQ6VXNlcjgxMjIyNDY=","avatar_url":"https://avatars.githubusercontent.com/u/8122246?v=4","gravatar_id":"","url":"https://api.github.com/users/Edouard-chin","html_url":"https://github.com/Edouard-chin","followers_url":"https://api.github.com/users/Edouard-chin/followers","following_url":"https://api.github.com/users/Edouard-chin/following{/other_user}","gists_url":"https://api.github.com/users/Edouard-chin/gists{/gist_id}","starred_url":"https://api.github.com/users/Edouard-chin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Edouard-chin/subscriptions","organizations_url":"https://api.github.com/users/Edouard-chin/orgs","repos_url":"https://api.github.com/users/Edouard-chin/repos","events_url":"https://api.github.com/users/Edouard-chin/events{/privacy}","received_events_url":"https://api.github.com/users/Edouard-chin/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":16632748969,"node_id":"CE_lADNIULOqy9hs88AAAAD32ObqQ","url":"https://api.github.com/repos/rails/rails/issues/events/16632748969","actor":{"login":"byroot","id":44640,"node_id":"MDQ6VXNlcjQ0NjQw","avatar_url":"https://avatars.githubusercontent.com/u/44640?v=4","gravatar_id":"","url":"https://api.github.com/users/byroot","html_url":"https://github.com/byroot","followers_url":"https://api.github.com/users/byroot/followers","following_url":"https://api.github.com/users/byroot/following{/other_user}","gists_url":"https://api.github.com/users/byroot/gists{/gist_id}","starred_url":"https://api.github.com/users/byroot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/byroot/subscriptions","organizations_url":"https://api.github.com/users/byroot/orgs","repos_url":"https://api.github.com/users/byroot/repos","events_url":"https://api.github.com/users/byroot/events{/privacy}","received_events_url":"https://api.github.com/users/byroot/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":"7c99813448db5718331f9f710dca05752ffadb4b","commit_url":"https://api.github.com/repos/rails/rails/commits/7c99813448db5718331f9f710dca05752ffadb4b","created_at":"2025-03-07T13:38:59Z","state_reason":null,"performed_via_github_app":null},{"id":16632749046,"node_id":"CE_lADNIULOqy9hs88AAAAD32Ob9g","url":"https://api.github.com/repos/rails/rails/issues/events/16632749046","actor":{"login":"byroot","id":44640,"node_id":"MDQ6VXNlcjQ0NjQw","avatar_url":"https://avatars.githubusercontent.com/u/44640?v=4","gravatar_id":"","url":"https://api.github.com/users/byroot","html_url":"https://github.com/byroot","followers_url":"https://api.github.com/users/byroot/followers","following_url":"https://api.github.com/users/byroot/following{/other_user}","gists_url":"https://api.github.com/users/byroot/gists{/gist_id}","starred_url":"https://api.github.com/users/byroot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/byroot/subscriptions","organizations_url":"https://api.github.com/users/byroot/orgs","repos_url":"https://api.github.com/users/byroot/repos","events_url":"https://api.github.com/users/byroot/events{/privacy}","received_events_url":"https://api.github.com/users/byroot/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2025-03-07T13:39:00Z","state_reason":null,"performed_via_github_app":null}]