{"url":"https://api.github.com/repos/rails/rails/issues/48052","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/48052/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/48052/comments","events_url":"https://api.github.com/repos/rails/rails/issues/48052/events","html_url":"https://github.com/rails/rails/issues/48052","id":1681419022,"node_id":"I_kwDNIULOZDhrDg","number":48052,"title":"MIME type validation too strict","user":{"login":"mak-dunkelziffer","id":78786774,"node_id":"MDQ6VXNlcjc4Nzg2Nzc0","avatar_url":"https://avatars.githubusercontent.com/u/78786774?v=4","gravatar_id":"","url":"https://api.github.com/users/mak-dunkelziffer","html_url":"https://github.com/mak-dunkelziffer","followers_url":"https://api.github.com/users/mak-dunkelziffer/followers","following_url":"https://api.github.com/users/mak-dunkelziffer/following{/other_user}","gists_url":"https://api.github.com/users/mak-dunkelziffer/gists{/gist_id}","starred_url":"https://api.github.com/users/mak-dunkelziffer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mak-dunkelziffer/subscriptions","organizations_url":"https://api.github.com/users/mak-dunkelziffer/orgs","repos_url":"https://api.github.com/users/mak-dunkelziffer/repos","events_url":"https://api.github.com/users/mak-dunkelziffer/events{/privacy}","received_events_url":"https://api.github.com/users/mak-dunkelziffer/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":107189,"node_id":"MDU6TGFiZWwxMDcxODk=","url":"https://api.github.com/repos/rails/rails/labels/actionpack","name":"actionpack","color":"FFF700","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2023-04-24T14:33:36Z","updated_at":"2023-06-05T16:56:19Z","closed_at":"2023-06-05T16:56:19Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Steps to reproduce\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\nend\r\n\r\nrequire \"active_support\"\r\nrequire \"active_support/core_ext/object/blank\"\r\nrequire \"minitest/autorun\"\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_simple_mime_type_parameter_works\r\n    Mime::Type.register(\"application/vnd.api+json; profile=\\\"cursor-pagination\\\"\", :jsonapi)\r\n  end\r\n  \r\n  def test_mime_type_parameter_with_url_fails\r\n    Mime::Type.register(\"application/vnd.api+json; profile=\\\"https://jsonapi.org/profiles/ethanresnick/cursor-pagination/\\\"\", :jsonapi)\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\nRails should understand MIME types of the following form:\r\n```\r\napplication/vnd.api+json; profile=\"https://jsonapi.org/profiles/ethanresnick/cursor-pagination/\" ext=\"https://jsonapi.org/ext/atomic\"\r\n```\r\n\r\nUse case: creating a spec-conform implementation of the `JSON:API` spec with applied extensions and/or profiles:\r\n- https://jsonapi.org/format/#media-type-parameter-rules\r\n- https://jsonapi.org/extensions/\r\n\r\n### Actual behavior\r\n\r\nI was not able to register a MIME type with URLs as parameter values. The following error gets raised:\r\n- `Mime::Type::InvalidMimeType: \"application/vnd.api+json; profile=\\\"https://jsonapi.org/profiles/ethanresnick/cursor-pagination/\\\"\" is not a valid MIME type`\r\n\r\nSource: the following regex seems to be too strict and imposes the same limitations on parameter values that should only apply to parameter names:\r\n- https://github.com/rails/rails/blob/3cca0d5205329e28a9879739bb2d3ae3cff1b14f/actionpack/lib/action_dispatch/http/mime_type.rb#L230\r\n\r\nMaybe this is also a user error. Maybe the parameter value needs to be escaped or encoded in some manner. However, as even `\\` and `%` are not allowed, I don't even know which escaping/encoding to use.\r\n\r\n### System configuration\r\n**Rails version**: 7.0.4.3\r\n\r\n**Ruby version**: 3.2.0\r\n","closed_by":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/48052/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/48052/timeline","performed_via_github_app":null,"state_reason":"completed"}