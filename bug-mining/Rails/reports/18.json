{"url":"https://api.github.com/repos/rails/rails/issues/47343","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/47343/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/47343/comments","events_url":"https://api.github.com/repos/rails/rails/issues/47343/events","html_url":"https://github.com/rails/rails/issues/47343","id":1578592374,"node_id":"I_kwDNIULOXhdodg","number":47343,"title":"Inconsistent HTML safe string behaviour between string slice functions","user":{"login":"ggmichaelgo","id":2475611,"node_id":"MDQ6VXNlcjI0NzU2MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2475611?v=4","gravatar_id":"","url":"https://api.github.com/users/ggmichaelgo","html_url":"https://github.com/ggmichaelgo","followers_url":"https://api.github.com/users/ggmichaelgo/followers","following_url":"https://api.github.com/users/ggmichaelgo/following{/other_user}","gists_url":"https://api.github.com/users/ggmichaelgo/gists{/gist_id}","starred_url":"https://api.github.com/users/ggmichaelgo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ggmichaelgo/subscriptions","organizations_url":"https://api.github.com/users/ggmichaelgo/orgs","repos_url":"https://api.github.com/users/ggmichaelgo/repos","events_url":"https://api.github.com/users/ggmichaelgo/events{/privacy}","received_events_url":"https://api.github.com/users/ggmichaelgo/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2023-02-09T20:47:03Z","updated_at":"2023-02-09T21:24:10Z","closed_at":"2023-02-09T21:24:10Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Steps to reproduce\r\n\r\nI have found inconsistent behaviour between `SafeBuffer`'s `slice`, `chr`, and `[]` functions, and how these functions maintain the string's `html_safe?`.\r\n\r\n```ruby\r\nbuffer = ActiveSupport::SafeBuffer.new\r\nbuffer.concat(\"<html>\")\r\n\r\nbuffer[0..0].html_safe? # true\r\nbuffer.slice(0, 1).html_safe? # false\r\n\r\nbuffer[0].html_safe? # true\r\nbuffer.chr.html_safe? # false\r\n```\r\n\r\n### Expected behaviour\r\nAll of the `ActiveSupport::SafeBuffer` string's slice functions should maintain the `html_safe?`.\r\n\r\n```ruby\r\n#! /usr/bin/env ruby\r\n# borrowed example from https://github.com/rails/rails/pull/33808#issuecomment-1044647597\r\n\r\nrequire \"action_view\"\r\nrequire \"active_support\"\r\n\r\nclass Sanitizer\r\n  include ActionView::Helpers::SanitizeHelper\r\nend\r\n\r\noriginal = %{<div><script>alert(\"xss\")</script></div>}\r\n# => \"<div><script>alert(\\\"xss\\\")</script></div>\"\r\n\r\nsafe = Sanitizer.new.sanitize(original)\r\n\r\nsafe[0..0].html_safe? # true\r\nsafe.slice(0, 1).html_safe? # false but it should be true\r\n\r\nsafe[0].html_safe? # true\r\nsafe.chr.html_safe? # false but it should be true\r\n\r\nsafe.slice!(0..1).html_safe? # false but it should be true\r\nsafe.html_safe? # false but it should be true\r\n```\r\n\r\nSince the original string has been sanitized, it is impossible to create an unsafe string. Therefore, when we slice an HTML Safe String, the sliced strings should also stay as an HTML Safe string. (reference: https://github.com/rails/rails/pull/33808#issuecomment-1044647597)\r\n\r\n### Actual behaviour\r\n`html_safe?` is maintained only if the `ActiveSupport::SafeBuffer` string is sliced with `[]`\r\n\r\n","closed_by":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/47343/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/47343/timeline","performed_via_github_app":null,"state_reason":"completed"}