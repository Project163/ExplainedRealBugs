[{"id":8399483496,"node_id":"LE_lADNIULOXT26_M8AAAAB9KXyaA","url":"https://api.github.com/repos/rails/rails/issues/events/8399483496","actor":{"login":"yahonda","id":73684,"node_id":"MDQ6VXNlcjczNjg0","avatar_url":"https://avatars.githubusercontent.com/u/73684?v=4","gravatar_id":"","url":"https://api.github.com/users/yahonda","html_url":"https://github.com/yahonda","followers_url":"https://api.github.com/users/yahonda/followers","following_url":"https://api.github.com/users/yahonda/following{/other_user}","gists_url":"https://api.github.com/users/yahonda/gists{/gist_id}","starred_url":"https://api.github.com/users/yahonda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yahonda/subscriptions","organizations_url":"https://api.github.com/users/yahonda/orgs","repos_url":"https://api.github.com/users/yahonda/repos","events_url":"https://api.github.com/users/yahonda/events{/privacy}","received_events_url":"https://api.github.com/users/yahonda/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2023-01-31T13:38:27Z","label":{"name":"activerecord","color":"0b02e1"},"performed_via_github_app":null},{"id":8399483509,"node_id":"LE_lADNIULOXT26_M8AAAAB9KXydQ","url":"https://api.github.com/repos/rails/rails/issues/events/8399483509","actor":{"login":"yahonda","id":73684,"node_id":"MDQ6VXNlcjczNjg0","avatar_url":"https://avatars.githubusercontent.com/u/73684?v=4","gravatar_id":"","url":"https://api.github.com/users/yahonda","html_url":"https://github.com/yahonda","followers_url":"https://api.github.com/users/yahonda/followers","following_url":"https://api.github.com/users/yahonda/following{/other_user}","gists_url":"https://api.github.com/users/yahonda/gists{/gist_id}","starred_url":"https://api.github.com/users/yahonda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yahonda/subscriptions","organizations_url":"https://api.github.com/users/yahonda/orgs","repos_url":"https://api.github.com/users/yahonda/repos","events_url":"https://api.github.com/users/yahonda/events{/privacy}","received_events_url":"https://api.github.com/users/yahonda/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2023-01-31T13:38:27Z","label":{"name":"ci issues","color":"aaafff"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/comments/1410696415","html_url":"https://github.com/rails/rails/issues/47203#issuecomment-1410696415","issue_url":"https://api.github.com/repos/rails/rails/issues/47203","id":1410696415,"node_id":"IC_kwDNIULOVBWE3w","user":{"login":"ghiculescu","id":509837,"node_id":"MDQ6VXNlcjUwOTgzNw==","avatar_url":"https://avatars.githubusercontent.com/u/509837?v=4","gravatar_id":"","url":"https://api.github.com/users/ghiculescu","html_url":"https://github.com/ghiculescu","followers_url":"https://api.github.com/users/ghiculescu/followers","following_url":"https://api.github.com/users/ghiculescu/following{/other_user}","gists_url":"https://api.github.com/users/ghiculescu/gists{/gist_id}","starred_url":"https://api.github.com/users/ghiculescu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ghiculescu/subscriptions","organizations_url":"https://api.github.com/users/ghiculescu/orgs","repos_url":"https://api.github.com/users/ghiculescu/repos","events_url":"https://api.github.com/users/ghiculescu/events{/privacy}","received_events_url":"https://api.github.com/users/ghiculescu/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-01-31T16:30:09Z","updated_at":"2023-01-31T16:30:09Z","body":"Did https://github.com/rails/rails/commit/fcf3388e7458c038e1073cfe07e9596f900c776a break this? (cc @matthewd)","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/1410696415/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ghiculescu","id":509837,"node_id":"MDQ6VXNlcjUwOTgzNw==","avatar_url":"https://avatars.githubusercontent.com/u/509837?v=4","gravatar_id":"","url":"https://api.github.com/users/ghiculescu","html_url":"https://github.com/ghiculescu","followers_url":"https://api.github.com/users/ghiculescu/followers","following_url":"https://api.github.com/users/ghiculescu/following{/other_user}","gists_url":"https://api.github.com/users/ghiculescu/gists{/gist_id}","starred_url":"https://api.github.com/users/ghiculescu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ghiculescu/subscriptions","organizations_url":"https://api.github.com/users/ghiculescu/orgs","repos_url":"https://api.github.com/users/ghiculescu/repos","events_url":"https://api.github.com/users/ghiculescu/events{/privacy}","received_events_url":"https://api.github.com/users/ghiculescu/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":8401585520,"node_id":"MEE_lADNIULOXT26_M8AAAAB9MYFcA","url":"https://api.github.com/repos/rails/rails/issues/events/8401585520","actor":{"login":"matthewd","id":1034,"node_id":"MDQ6VXNlcjEwMzQ=","avatar_url":"https://avatars.githubusercontent.com/u/1034?v=4","gravatar_id":"","url":"https://api.github.com/users/matthewd","html_url":"https://github.com/matthewd","followers_url":"https://api.github.com/users/matthewd/followers","following_url":"https://api.github.com/users/matthewd/following{/other_user}","gists_url":"https://api.github.com/users/matthewd/gists{/gist_id}","starred_url":"https://api.github.com/users/matthewd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/matthewd/subscriptions","organizations_url":"https://api.github.com/users/matthewd/orgs","repos_url":"https://api.github.com/users/matthewd/repos","events_url":"https://api.github.com/users/matthewd/events{/privacy}","received_events_url":"https://api.github.com/users/matthewd/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2023-01-31T16:30:10Z","performed_via_github_app":null},{"id":8401585541,"node_id":"SE_lADNIULOXT26_M8AAAAB9MYFhQ","url":"https://api.github.com/repos/rails/rails/issues/events/8401585541","actor":{"login":"matthewd","id":1034,"node_id":"MDQ6VXNlcjEwMzQ=","avatar_url":"https://avatars.githubusercontent.com/u/1034?v=4","gravatar_id":"","url":"https://api.github.com/users/matthewd","html_url":"https://github.com/matthewd","followers_url":"https://api.github.com/users/matthewd/followers","following_url":"https://api.github.com/users/matthewd/following{/other_user}","gists_url":"https://api.github.com/users/matthewd/gists{/gist_id}","starred_url":"https://api.github.com/users/matthewd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/matthewd/subscriptions","organizations_url":"https://api.github.com/users/matthewd/orgs","repos_url":"https://api.github.com/users/matthewd/repos","events_url":"https://api.github.com/users/matthewd/events{/privacy}","received_events_url":"https://api.github.com/users/matthewd/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2023-01-31T16:30:10Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/comments/1421238101","html_url":"https://github.com/rails/rails/issues/47203#issuecomment-1421238101","issue_url":"https://api.github.com/repos/rails/rails/issues/47203","id":1421238101,"node_id":"IC_kwDNIULOVLZfVQ","user":{"login":"fredma","id":13537657,"node_id":"MDQ6VXNlcjEzNTM3NjU3","avatar_url":"https://avatars.githubusercontent.com/u/13537657?v=4","gravatar_id":"","url":"https://api.github.com/users/fredma","html_url":"https://github.com/fredma","followers_url":"https://api.github.com/users/fredma/followers","following_url":"https://api.github.com/users/fredma/following{/other_user}","gists_url":"https://api.github.com/users/fredma/gists{/gist_id}","starred_url":"https://api.github.com/users/fredma/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fredma/subscriptions","organizations_url":"https://api.github.com/users/fredma/orgs","repos_url":"https://api.github.com/users/fredma/repos","events_url":"https://api.github.com/users/fredma/events{/privacy}","received_events_url":"https://api.github.com/users/fredma/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-02-07T18:13:43Z","updated_at":"2023-02-07T18:13:43Z","body":"The test command fails with the same error even when reverting the last 2 commits ([fcf3388](https://github.com/rails/rails/commit/fcf3388e7458c038e1073cfe07e9596f900c776a), [76a1971](https://github.com/rails/rails/commit/76a197169d3b8efe8130451b29c8c4463114d580)), so it looks unrelated.\r\n\r\n","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/1421238101/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"fredma","id":13537657,"node_id":"MDQ6VXNlcjEzNTM3NjU3","avatar_url":"https://avatars.githubusercontent.com/u/13537657?v=4","gravatar_id":"","url":"https://api.github.com/users/fredma","html_url":"https://github.com/fredma","followers_url":"https://api.github.com/users/fredma/followers","following_url":"https://api.github.com/users/fredma/following{/other_user}","gists_url":"https://api.github.com/users/fredma/gists{/gist_id}","starred_url":"https://api.github.com/users/fredma/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fredma/subscriptions","organizations_url":"https://api.github.com/users/fredma/orgs","repos_url":"https://api.github.com/users/fredma/repos","events_url":"https://api.github.com/users/fredma/events{/privacy}","received_events_url":"https://api.github.com/users/fredma/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rails/rails/issues/comments/1421680524","html_url":"https://github.com/rails/rails/issues/47203#issuecomment-1421680524","issue_url":"https://api.github.com/repos/rails/rails/issues/47203","id":1421680524,"node_id":"IC_kwDNIULOVL0fjA","user":{"login":"jessicajoly88","id":13633237,"node_id":"MDQ6VXNlcjEzNjMzMjM3","avatar_url":"https://avatars.githubusercontent.com/u/13633237?v=4","gravatar_id":"","url":"https://api.github.com/users/jessicajoly88","html_url":"https://github.com/jessicajoly88","followers_url":"https://api.github.com/users/jessicajoly88/followers","following_url":"https://api.github.com/users/jessicajoly88/following{/other_user}","gists_url":"https://api.github.com/users/jessicajoly88/gists{/gist_id}","starred_url":"https://api.github.com/users/jessicajoly88/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jessicajoly88/subscriptions","organizations_url":"https://api.github.com/users/jessicajoly88/orgs","repos_url":"https://api.github.com/users/jessicajoly88/repos","events_url":"https://api.github.com/users/jessicajoly88/events{/privacy}","received_events_url":"https://api.github.com/users/jessicajoly88/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-02-08T00:11:43Z","updated_at":"2023-02-08T00:11:43Z","body":"@fredma and I looked into this earlier today and were able to reproduce and figure out the root cause of the problem. The test that's failing (`ActiveRecord::ConnectionAdapters::PostgreSQLAdapterTest#test_only_check_for_insensitive_comparison_capability_once`) is dependent on the order that the two other tests are run.  We rebased our branch on main to get the latest commits towards the end of the day and we weren't able to get the tests running in the order which caused the failure to happen despite using the same seeds (--seed 60206). We were able to confirm that the root problem wasn't fixed, it's just the order of the tests that are making the failing test pass (so the problem is still there). \r\n\r\nIs there a way to manually configure the order in which the tests run to get to the failure state?","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/1421680524/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"jessicajoly88","id":13633237,"node_id":"MDQ6VXNlcjEzNjMzMjM3","avatar_url":"https://avatars.githubusercontent.com/u/13633237?v=4","gravatar_id":"","url":"https://api.github.com/users/jessicajoly88","html_url":"https://github.com/jessicajoly88","followers_url":"https://api.github.com/users/jessicajoly88/followers","following_url":"https://api.github.com/users/jessicajoly88/following{/other_user}","gists_url":"https://api.github.com/users/jessicajoly88/gists{/gist_id}","starred_url":"https://api.github.com/users/jessicajoly88/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jessicajoly88/subscriptions","organizations_url":"https://api.github.com/users/jessicajoly88/orgs","repos_url":"https://api.github.com/users/jessicajoly88/repos","events_url":"https://api.github.com/users/jessicajoly88/events{/privacy}","received_events_url":"https://api.github.com/users/jessicajoly88/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":8463252525,"node_id":"MEE_lADNIULOXT26_M8AAAAB-HL8LQ","url":"https://api.github.com/repos/rails/rails/issues/events/8463252525","actor":{"login":"fredma","id":13537657,"node_id":"MDQ6VXNlcjEzNTM3NjU3","avatar_url":"https://avatars.githubusercontent.com/u/13537657?v=4","gravatar_id":"","url":"https://api.github.com/users/fredma","html_url":"https://github.com/fredma","followers_url":"https://api.github.com/users/fredma/followers","following_url":"https://api.github.com/users/fredma/following{/other_user}","gists_url":"https://api.github.com/users/fredma/gists{/gist_id}","starred_url":"https://api.github.com/users/fredma/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fredma/subscriptions","organizations_url":"https://api.github.com/users/fredma/orgs","repos_url":"https://api.github.com/users/fredma/repos","events_url":"https://api.github.com/users/fredma/events{/privacy}","received_events_url":"https://api.github.com/users/fredma/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2023-02-08T00:11:43Z","performed_via_github_app":null},{"id":8463252535,"node_id":"SE_lADNIULOXT26_M8AAAAB-HL8Nw","url":"https://api.github.com/repos/rails/rails/issues/events/8463252535","actor":{"login":"fredma","id":13537657,"node_id":"MDQ6VXNlcjEzNTM3NjU3","avatar_url":"https://avatars.githubusercontent.com/u/13537657?v=4","gravatar_id":"","url":"https://api.github.com/users/fredma","html_url":"https://github.com/fredma","followers_url":"https://api.github.com/users/fredma/followers","following_url":"https://api.github.com/users/fredma/following{/other_user}","gists_url":"https://api.github.com/users/fredma/gists{/gist_id}","starred_url":"https://api.github.com/users/fredma/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fredma/subscriptions","organizations_url":"https://api.github.com/users/fredma/orgs","repos_url":"https://api.github.com/users/fredma/repos","events_url":"https://api.github.com/users/fredma/events{/privacy}","received_events_url":"https://api.github.com/users/fredma/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2023-02-08T00:11:43Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/comments/1421784218","html_url":"https://github.com/rails/rails/issues/47203#issuecomment-1421784218","issue_url":"https://api.github.com/repos/rails/rails/issues/47203","id":1421784218,"node_id":"IC_kwDNIULOVL60mg","user":{"login":"yahonda","id":73684,"node_id":"MDQ6VXNlcjczNjg0","avatar_url":"https://avatars.githubusercontent.com/u/73684?v=4","gravatar_id":"","url":"https://api.github.com/users/yahonda","html_url":"https://github.com/yahonda","followers_url":"https://api.github.com/users/yahonda/followers","following_url":"https://api.github.com/users/yahonda/following{/other_user}","gists_url":"https://api.github.com/users/yahonda/gists{/gist_id}","starred_url":"https://api.github.com/users/yahonda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yahonda/subscriptions","organizations_url":"https://api.github.com/users/yahonda/orgs","repos_url":"https://api.github.com/users/yahonda/repos","events_url":"https://api.github.com/users/yahonda/events{/privacy}","received_events_url":"https://api.github.com/users/yahonda/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-02-08T01:28:08Z","updated_at":"2023-02-08T01:28:08Z","body":"Using `-seed 21290` should reproduce this failure with the latest main branch.\r\n\r\n```ruby\r\n$ ARCONN=postgresql bin/test test/cases/validations/uniqueness_validation_test.rb test/cases/adapters/postgresql/postgresql_adapter_test.rb -n \"/^(?:UniquenessValidationTest#(?:test_validate_case_insensitive_uniqueness)|ActiveRecord::ConnectionAdapters::PostgreSQLAdapterTest#(?:test_unparsed_defaults_are_at_least_set_when_saving|test_only_check_for_insensitive_comparison_capability_once))$/\" --seed 21290 -v\r\nUsing postgresql\r\nRun options: -n \"/^(?:UniquenessValidationTest#(?:test_validate_case_insensitive_uniqueness)|ActiveRecord::ConnectionAdapters::PostgreSQLAdapterTest#(?:test_unparsed_defaults_are_at_least_set_when_saving|test_only_check_for_insensitive_comparison_capability_once))$/\" --seed 21290 -v\r\n\r\n# Running:\r\n\r\nUniquenessValidationTest#test_validate_case_insensitive_uniqueness = 0.08 s = .\r\nActiveRecord::ConnectionAdapters::PostgreSQLAdapterTest#test_unparsed_defaults_are_at_least_set_when_saving = 0.01 s = .\r\nActiveRecord::ConnectionAdapters::PostgreSQLAdapterTest#test_only_check_for_insensitive_comparison_capability_once = 0.00 s = F\r\n\r\n\r\nFailure:\r\nActiveRecord::ConnectionAdapters::PostgreSQLAdapterTest#test_only_check_for_insensitive_comparison_capability_once [/home/yahonda/src/github.com/rails/rails/activerecord/test/cases/adapters/postgresql/postgresql_adapter_test.rb:495]:\r\n1 or more queries expected, but none were executed..\r\nExpected 0 to be >= 1.\r\n\r\n\r\nbin/test test/cases/adapters/postgresql/postgresql_adapter_test.rb:487\r\n\r\n\r\nFinished in 0.111934s, 26.8014 runs/s, 214.4112 assertions/s.\r\n3 runs, 24 assertions, 1 failures, 0 errors, 0 skips\r\n$\r\n```","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/comments/1421784218/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"yahonda","id":73684,"node_id":"MDQ6VXNlcjczNjg0","avatar_url":"https://avatars.githubusercontent.com/u/73684?v=4","gravatar_id":"","url":"https://api.github.com/users/yahonda","html_url":"https://github.com/yahonda","followers_url":"https://api.github.com/users/yahonda/followers","following_url":"https://api.github.com/users/yahonda/following{/other_user}","gists_url":"https://api.github.com/users/yahonda/gists{/gist_id}","starred_url":"https://api.github.com/users/yahonda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yahonda/subscriptions","organizations_url":"https://api.github.com/users/yahonda/orgs","repos_url":"https://api.github.com/users/yahonda/repos","events_url":"https://api.github.com/users/yahonda/events{/privacy}","received_events_url":"https://api.github.com/users/yahonda/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":8472812158,"node_id":"REFE_lADNIULOXT26_M8AAAAB-QTafg","url":"https://api.github.com/repos/rails/rails/issues/events/8472812158","actor":{"login":"jessicajoly88","id":13633237,"node_id":"MDQ6VXNlcjEzNjMzMjM3","avatar_url":"https://avatars.githubusercontent.com/u/13633237?v=4","gravatar_id":"","url":"https://api.github.com/users/jessicajoly88","html_url":"https://github.com/jessicajoly88","followers_url":"https://api.github.com/users/jessicajoly88/followers","following_url":"https://api.github.com/users/jessicajoly88/following{/other_user}","gists_url":"https://api.github.com/users/jessicajoly88/gists{/gist_id}","starred_url":"https://api.github.com/users/jessicajoly88/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jessicajoly88/subscriptions","organizations_url":"https://api.github.com/users/jessicajoly88/orgs","repos_url":"https://api.github.com/users/jessicajoly88/repos","events_url":"https://api.github.com/users/jessicajoly88/events{/privacy}","received_events_url":"https://api.github.com/users/jessicajoly88/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"0a99299a26c28f6d2cc532519600953eb9b746e1","commit_url":"https://api.github.com/repos/jessicajoly88/rails/commits/0a99299a26c28f6d2cc532519600953eb9b746e1","created_at":"2023-02-08T20:38:12Z","performed_via_github_app":null},{"actor":{"login":"jessicajoly88","id":13633237,"node_id":"MDQ6VXNlcjEzNjMzMjM3","avatar_url":"https://avatars.githubusercontent.com/u/13633237?v=4","gravatar_id":"","url":"https://api.github.com/users/jessicajoly88","html_url":"https://github.com/jessicajoly88","followers_url":"https://api.github.com/users/jessicajoly88/followers","following_url":"https://api.github.com/users/jessicajoly88/following{/other_user}","gists_url":"https://api.github.com/users/jessicajoly88/gists{/gist_id}","starred_url":"https://api.github.com/users/jessicajoly88/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jessicajoly88/subscriptions","organizations_url":"https://api.github.com/users/jessicajoly88/orgs","repos_url":"https://api.github.com/users/jessicajoly88/repos","events_url":"https://api.github.com/users/jessicajoly88/events{/privacy}","received_events_url":"https://api.github.com/users/jessicajoly88/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-02-08T21:57:09Z","updated_at":"2023-02-08T21:57:09Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/rails/rails/issues/47320","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/47320/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/47320/comments","events_url":"https://api.github.com/repos/rails/rails/issues/47320/events","html_url":"https://github.com/rails/rails/pull/47320","id":1576766533,"node_id":"PR_kwDNIULOSY88ow","number":47320,"title":"Fix state leakage between tests","user":{"login":"jessicajoly88","id":13633237,"node_id":"MDQ6VXNlcjEzNjMzMjM3","avatar_url":"https://avatars.githubusercontent.com/u/13633237?v=4","gravatar_id":"","url":"https://api.github.com/users/jessicajoly88","html_url":"https://github.com/jessicajoly88","followers_url":"https://api.github.com/users/jessicajoly88/followers","following_url":"https://api.github.com/users/jessicajoly88/following{/other_user}","gists_url":"https://api.github.com/users/jessicajoly88/gists{/gist_id}","starred_url":"https://api.github.com/users/jessicajoly88/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jessicajoly88/subscriptions","organizations_url":"https://api.github.com/users/jessicajoly88/orgs","repos_url":"https://api.github.com/users/jessicajoly88/repos","events_url":"https://api.github.com/users/jessicajoly88/events{/privacy}","received_events_url":"https://api.github.com/users/jessicajoly88/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2023-02-08T20:35:59Z","updated_at":"2023-02-10T15:49:41Z","closed_at":"2023-02-10T15:49:41Z","author_association":"NONE","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":8514,"node_id":"MDEwOlJlcG9zaXRvcnk4NTE0","name":"rails","full_name":"rails/rails","private":false,"owner":{"login":"rails","id":4223,"node_id":"MDEyOk9yZ2FuaXphdGlvbjQyMjM=","avatar_url":"https://avatars.githubusercontent.com/u/4223?v=4","gravatar_id":"","url":"https://api.github.com/users/rails","html_url":"https://github.com/rails","followers_url":"https://api.github.com/users/rails/followers","following_url":"https://api.github.com/users/rails/following{/other_user}","gists_url":"https://api.github.com/users/rails/gists{/gist_id}","starred_url":"https://api.github.com/users/rails/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rails/subscriptions","organizations_url":"https://api.github.com/users/rails/orgs","repos_url":"https://api.github.com/users/rails/repos","events_url":"https://api.github.com/users/rails/events{/privacy}","received_events_url":"https://api.github.com/users/rails/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/rails/rails","description":"Ruby on Rails","fork":false,"url":"https://api.github.com/repos/rails/rails","forks_url":"https://api.github.com/repos/rails/rails/forks","keys_url":"https://api.github.com/repos/rails/rails/keys{/key_id}","collaborators_url":"https://api.github.com/repos/rails/rails/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/rails/rails/teams","hooks_url":"https://api.github.com/repos/rails/rails/hooks","issue_events_url":"https://api.github.com/repos/rails/rails/issues/events{/number}","events_url":"https://api.github.com/repos/rails/rails/events","assignees_url":"https://api.github.com/repos/rails/rails/assignees{/user}","branches_url":"https://api.github.com/repos/rails/rails/branches{/branch}","tags_url":"https://api.github.com/repos/rails/rails/tags","blobs_url":"https://api.github.com/repos/rails/rails/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/rails/rails/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/rails/rails/git/refs{/sha}","trees_url":"https://api.github.com/repos/rails/rails/git/trees{/sha}","statuses_url":"https://api.github.com/repos/rails/rails/statuses/{sha}","languages_url":"https://api.github.com/repos/rails/rails/languages","stargazers_url":"https://api.github.com/repos/rails/rails/stargazers","contributors_url":"https://api.github.com/repos/rails/rails/contributors","subscribers_url":"https://api.github.com/repos/rails/rails/subscribers","subscription_url":"https://api.github.com/repos/rails/rails/subscription","commits_url":"https://api.github.com/repos/rails/rails/commits{/sha}","git_commits_url":"https://api.github.com/repos/rails/rails/git/commits{/sha}","comments_url":"https://api.github.com/repos/rails/rails/comments{/number}","issue_comment_url":"https://api.github.com/repos/rails/rails/issues/comments{/number}","contents_url":"https://api.github.com/repos/rails/rails/contents/{+path}","compare_url":"https://api.github.com/repos/rails/rails/compare/{base}...{head}","merges_url":"https://api.github.com/repos/rails/rails/merges","archive_url":"https://api.github.com/repos/rails/rails/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/rails/rails/downloads","issues_url":"https://api.github.com/repos/rails/rails/issues{/number}","pulls_url":"https://api.github.com/repos/rails/rails/pulls{/number}","milestones_url":"https://api.github.com/repos/rails/rails/milestones{/number}","notifications_url":"https://api.github.com/repos/rails/rails/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/rails/rails/labels{/name}","releases_url":"https://api.github.com/repos/rails/rails/releases{/id}","deployments_url":"https://api.github.com/repos/rails/rails/deployments","created_at":"2008-04-11T02:19:47Z","updated_at":"2025-11-10T02:03:47Z","pushed_at":"2025-11-10T00:33:52Z","git_url":"git://github.com/rails/rails.git","ssh_url":"git@github.com:rails/rails.git","clone_url":"https://github.com/rails/rails.git","svn_url":"https://github.com/rails/rails","homepage":"https://rubyonrails.org","size":271619,"stargazers_count":57840,"watchers_count":57840,"language":"Ruby","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":true,"forks_count":22025,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":1341,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["activejob","activerecord","framework","html","mvc","rails","ruby"],"visibility":"public","forks":22025,"open_issues":1341,"watchers":57840,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/rails/rails/pulls/47320","html_url":"https://github.com/rails/rails/pull/47320","diff_url":"https://github.com/rails/rails/pull/47320.diff","patch_url":"https://github.com/rails/rails/pull/47320.patch","merged_at":"2023-02-10T15:49:41Z"},"body":"### Motivation / Background\r\nFixes https://github.com/rails/rails/issues/47203\r\n\r\n### Detail\r\n\r\nThe issue was about a test failing when executed in a particular order as part a series of tests described as below:\r\n```\r\nARCONN=postgresql bin/test test/cases/validations/uniqueness_validation_test.rb test/cases/adapters/postgresql/postgresql_adapter_test.rb -n \"/^(?:UniquenessValidationTest#(?:test_validate_case_insensitive_uniqueness)|ActiveRecord::ConnectionAdapters::PostgreSQLAdapterTest#(?:test_unparsed_defaults_are_at_least_set_when_saving|test_only_check_for_insensitive_comparison_capability_once))$/\" --seed 21290 -v\r\n```\r\n\r\nThis test command runs the following tests in that order:\r\n\r\n1. UniquenessValidationTest#test_validate_case_insensitive_uniqueness\r\n2. ActiveRecord::ConnectionAdapters::PostgreSQLAdapterTest#test_unparsed_defaults_are_at_least_set_when_saving\r\n3. ActiveRecord::ConnectionAdapters::PostgreSQLAdapterTest#test_only_check_for_insensitive_comparison_capability_once\r\n\r\nThe 1st and 2nd tests passes but the last one fails.\r\n\r\nThe below assertion is where the test fails because it's expecting queries to be run when `case_insensitive_comparison` is called but no queries are executed. \r\n```\r\nassert_queries :any, ignore_none: true do\r\n  @connection.case_insensitive_comparison(attribute, \"foo\")\r\nend\r\n```\r\n\r\nThis is happening for two reasons: \r\n**1) Schema cache not being cleared between tests**\r\n\r\n The purpose of the `case_insensitive_comparison` method is to perform a case insensitive comparison for the given attribute against a value. But the method needs to know if a comparison is possible based on the column type of the attribute being compared. To find out if it is capable of doing it, it run queries against Postgres which will return a boolean result. `true` if case insensitive comparison is possible for the column type of the attribute, otherwise `false`.\r\n\r\nHowever, querying the database every time the method `case_insensitive_comparison` is called is not optimal for performance. So, a prior [PR](https://github.com/rails/rails/commit/b39050e8d574b814d3580688276e933a3d08aca8) tackled this issue by introducing a local cache layer aka `@case_insensitive_cache`, so that queries to the database are only done once.\r\n\r\nSo when debugging the 3rd test, we noticed that the `case_insensitive_comparison` method was looking up the column type `integer` in the cache `@case_insensitive_cache` when it should have been looking up  `example_type` based on the table created in the test. ![first_screenshot](https://user-images.githubusercontent.com/13633237/217651038-3e29ef54-39a8-45bd-bb4a-2f96baacd36a.jpg)\r\n\r\nWe noticed that both the failing test and the second test ActiveRecord::ConnectionAdapters::PostgreSQLAdapterTest#test_unparsed_defaults_are_at_least_set_when_saving both create a table called \"ex\" but with different column_types for the `number` attribute. When we skip the second test, the failing test now passes because it now looks up `example_type` in the `@case_insensitive_cache`.  We printed out the logs when debugging to see exactly what was happening behind the scenes and we saw that both tests were properly creating and dropping the tables during their lifecycle. We confirmed this by checking the postgres database. \r\n\r\nThis led us to discover that Rails has a schema cache for performance reasons. We realized that the column_type used by the failing test was coming from the schema cache and NOT from what was defined in the table creation within the test. \r\nThe third test (failing one) is  loading the  column_type for `number` from the schema cache populated by the table creation in the second test because both tests have the same table name e.g. \"ex\" and column name e.g. \"number\". \r\n\r\nTo fix that, we clear the schema cache using `clear_data_source_cache!` on the table \"ex\". \r\n\r\n**2) `@case_insensitive_cache` not being cleared between tests**\r\n\r\nThe `case_insensitive_comparison` method uses a local cache between successive calls and the failing test was testing the functionality of that cache, and asserting that the queries against postgres were only performed once assuming that the cache was empty. But we found that the cache was not empty when the 3rd test executes because the 1st test also calls the `case_insensitive_comparison` method which populated the cache for column type `integer`. \r\nThe 3rd test already passes by just clearing the schema cache. So why do we clear the `@case_insensitive_cache` again?\r\nIf another test is added that also calls the `case_insensitive_comparison` method with an attribute of the same column type e.g. `integer` or even `example_type`, then the 3rd test will fail because the cache knows about those column types. So, clearing `@case_insensitive_cache` ensures that the 3rd test will never fail the `assert_queries :any`.\r\n\r\nYou can see the cache being populated by the first test in the top section of this screenshot:\r\n![latest](https://user-images.githubusercontent.com/13633237/217660251-59ced012-2747-4961-8c0d-6b4624e9027d.jpg)\r\n\r\n### Additional information\r\n\r\n- Is force clearing the schema cache the right approach? We would have expected the schema cache to be destroyed as part of the table drop ðŸ¤” \r\n\r\n### Checklist\r\n\r\nBefore submitting the PR make sure the following are checked:\r\n\r\n* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.\r\n* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`\r\n* [x] Tests are added or updated if you fix a bug or add a feature.\r\n* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/47320/reactions","total_count":2,"+1":0,"-1":0,"laugh":0,"hooray":1,"confused":0,"heart":1,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/47320/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"id":8473457222,"node_id":"REFE_lADNIULOXT26_M8AAAAB-Q6yRg","url":"https://api.github.com/repos/rails/rails/issues/events/8473457222","actor":{"login":"jessicajoly88","id":13633237,"node_id":"MDQ6VXNlcjEzNjMzMjM3","avatar_url":"https://avatars.githubusercontent.com/u/13633237?v=4","gravatar_id":"","url":"https://api.github.com/users/jessicajoly88","html_url":"https://github.com/jessicajoly88","followers_url":"https://api.github.com/users/jessicajoly88/followers","following_url":"https://api.github.com/users/jessicajoly88/following{/other_user}","gists_url":"https://api.github.com/users/jessicajoly88/gists{/gist_id}","starred_url":"https://api.github.com/users/jessicajoly88/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jessicajoly88/subscriptions","organizations_url":"https://api.github.com/users/jessicajoly88/orgs","repos_url":"https://api.github.com/users/jessicajoly88/repos","events_url":"https://api.github.com/users/jessicajoly88/events{/privacy}","received_events_url":"https://api.github.com/users/jessicajoly88/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"6ec5c68bd1441f0e27aef3f8a2eb663406b7f039","commit_url":"https://api.github.com/repos/jessicajoly88/rails/commits/6ec5c68bd1441f0e27aef3f8a2eb663406b7f039","created_at":"2023-02-08T22:06:04Z","performed_via_github_app":null},{"id":8482128552,"node_id":"REFE_lADNIULOXT26_M8AAAAB-ZMCqA","url":"https://api.github.com/repos/rails/rails/issues/events/8482128552","actor":{"login":"jessicajoly88","id":13633237,"node_id":"MDQ6VXNlcjEzNjMzMjM3","avatar_url":"https://avatars.githubusercontent.com/u/13633237?v=4","gravatar_id":"","url":"https://api.github.com/users/jessicajoly88","html_url":"https://github.com/jessicajoly88","followers_url":"https://api.github.com/users/jessicajoly88/followers","following_url":"https://api.github.com/users/jessicajoly88/following{/other_user}","gists_url":"https://api.github.com/users/jessicajoly88/gists{/gist_id}","starred_url":"https://api.github.com/users/jessicajoly88/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jessicajoly88/subscriptions","organizations_url":"https://api.github.com/users/jessicajoly88/orgs","repos_url":"https://api.github.com/users/jessicajoly88/repos","events_url":"https://api.github.com/users/jessicajoly88/events{/privacy}","received_events_url":"https://api.github.com/users/jessicajoly88/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"6a61586e8a56e6fe3d00ecdff8bb7f0cbc7b8a49","commit_url":"https://api.github.com/repos/jessicajoly88/rails/commits/6a61586e8a56e6fe3d00ecdff8bb7f0cbc7b8a49","created_at":"2023-02-09T17:41:30Z","performed_via_github_app":null},{"id":8482464256,"node_id":"REFE_lADNIULOXT26_M8AAAAB-ZgiAA","url":"https://api.github.com/repos/rails/rails/issues/events/8482464256","actor":{"login":"jessicajoly88","id":13633237,"node_id":"MDQ6VXNlcjEzNjMzMjM3","avatar_url":"https://avatars.githubusercontent.com/u/13633237?v=4","gravatar_id":"","url":"https://api.github.com/users/jessicajoly88","html_url":"https://github.com/jessicajoly88","followers_url":"https://api.github.com/users/jessicajoly88/followers","following_url":"https://api.github.com/users/jessicajoly88/following{/other_user}","gists_url":"https://api.github.com/users/jessicajoly88/gists{/gist_id}","starred_url":"https://api.github.com/users/jessicajoly88/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jessicajoly88/subscriptions","organizations_url":"https://api.github.com/users/jessicajoly88/orgs","repos_url":"https://api.github.com/users/jessicajoly88/repos","events_url":"https://api.github.com/users/jessicajoly88/events{/privacy}","received_events_url":"https://api.github.com/users/jessicajoly88/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"f3e732cb01e520367a9ee55e81449936372bb3fb","commit_url":"https://api.github.com/repos/jessicajoly88/rails/commits/f3e732cb01e520367a9ee55e81449936372bb3fb","created_at":"2023-02-09T18:21:11Z","performed_via_github_app":null},{"id":8490804197,"node_id":"REFE_lADNIULOXT26_M8AAAAB-hdj5Q","url":"https://api.github.com/repos/rails/rails/issues/events/8490804197","actor":{"login":"jessicajoly88","id":13633237,"node_id":"MDQ6VXNlcjEzNjMzMjM3","avatar_url":"https://avatars.githubusercontent.com/u/13633237?v=4","gravatar_id":"","url":"https://api.github.com/users/jessicajoly88","html_url":"https://github.com/jessicajoly88","followers_url":"https://api.github.com/users/jessicajoly88/followers","following_url":"https://api.github.com/users/jessicajoly88/following{/other_user}","gists_url":"https://api.github.com/users/jessicajoly88/gists{/gist_id}","starred_url":"https://api.github.com/users/jessicajoly88/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jessicajoly88/subscriptions","organizations_url":"https://api.github.com/users/jessicajoly88/orgs","repos_url":"https://api.github.com/users/jessicajoly88/repos","events_url":"https://api.github.com/users/jessicajoly88/events{/privacy}","received_events_url":"https://api.github.com/users/jessicajoly88/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"9436c739c99c6cf0aaa58690c1b2320626af86e2","commit_url":"https://api.github.com/repos/jessicajoly88/rails/commits/9436c739c99c6cf0aaa58690c1b2320626af86e2","created_at":"2023-02-10T15:00:55Z","performed_via_github_app":null},{"id":8491053410,"node_id":"REFE_lADNIULOXT26_M8AAAAB-hsxYg","url":"https://api.github.com/repos/rails/rails/issues/events/8491053410","actor":{"login":"jessicajoly88","id":13633237,"node_id":"MDQ6VXNlcjEzNjMzMjM3","avatar_url":"https://avatars.githubusercontent.com/u/13633237?v=4","gravatar_id":"","url":"https://api.github.com/users/jessicajoly88","html_url":"https://github.com/jessicajoly88","followers_url":"https://api.github.com/users/jessicajoly88/followers","following_url":"https://api.github.com/users/jessicajoly88/following{/other_user}","gists_url":"https://api.github.com/users/jessicajoly88/gists{/gist_id}","starred_url":"https://api.github.com/users/jessicajoly88/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jessicajoly88/subscriptions","organizations_url":"https://api.github.com/users/jessicajoly88/orgs","repos_url":"https://api.github.com/users/jessicajoly88/repos","events_url":"https://api.github.com/users/jessicajoly88/events{/privacy}","received_events_url":"https://api.github.com/users/jessicajoly88/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"68aceb5946e6822a39d8062d8af742a955cf9014","commit_url":"https://api.github.com/repos/jessicajoly88/rails/commits/68aceb5946e6822a39d8062d8af742a955cf9014","created_at":"2023-02-10T15:26:50Z","performed_via_github_app":null},{"id":8491281517,"node_id":"CE_lADNIULOXT26_M8AAAAB-h6sbQ","url":"https://api.github.com/repos/rails/rails/issues/events/8491281517","actor":{"login":"eileencodes","id":1080678,"node_id":"MDQ6VXNlcjEwODA2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/1080678?v=4","gravatar_id":"","url":"https://api.github.com/users/eileencodes","html_url":"https://github.com/eileencodes","followers_url":"https://api.github.com/users/eileencodes/followers","following_url":"https://api.github.com/users/eileencodes/following{/other_user}","gists_url":"https://api.github.com/users/eileencodes/gists{/gist_id}","starred_url":"https://api.github.com/users/eileencodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eileencodes/subscriptions","organizations_url":"https://api.github.com/users/eileencodes/orgs","repos_url":"https://api.github.com/users/eileencodes/repos","events_url":"https://api.github.com/users/eileencodes/events{/privacy}","received_events_url":"https://api.github.com/users/eileencodes/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2023-02-10T15:49:43Z","state_reason":null,"performed_via_github_app":null}]