{"url":"https://api.github.com/repos/rails/rails/issues/55460","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/55460/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/55460/comments","events_url":"https://api.github.com/repos/rails/rails/issues/55460/events","html_url":"https://github.com/rails/rails/issues/55460","id":3299011844,"node_id":"I_kwDNIULOxKLtBA","number":55460,"title":"`Rails.logger` is not `#freeze`-friendly","user":{"login":"joshuay03","id":54629302,"node_id":"MDQ6VXNlcjU0NjI5MzAy","avatar_url":"https://avatars.githubusercontent.com/u/54629302?v=4","gravatar_id":"","url":"https://api.github.com/users/joshuay03","html_url":"https://github.com/joshuay03","followers_url":"https://api.github.com/users/joshuay03/followers","following_url":"https://api.github.com/users/joshuay03/following{/other_user}","gists_url":"https://api.github.com/users/joshuay03/gists{/gist_id}","starred_url":"https://api.github.com/users/joshuay03/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/joshuay03/subscriptions","organizations_url":"https://api.github.com/users/joshuay03/orgs","repos_url":"https://api.github.com/users/joshuay03/repos","events_url":"https://api.github.com/users/joshuay03/events{/privacy}","received_events_url":"https://api.github.com/users/joshuay03/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2025-08-07T05:15:42Z","updated_at":"2025-08-07T21:43:23Z","closed_at":"2025-08-07T21:43:23Z","author_association":"CONTRIBUTOR","type":{"id":91648,"node_id":"IT_kwDNEH_OAAFmAA","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T09:10:59Z","updated_at":"2024-07-26T10:04:55Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Steps to reproduce\n\n<!-- (Guidelines for creating a bug report are [available\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\n\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\n\nNot exactly a bug, but more of a question about whether `Rails.logger` should be `#freeze`-friendly.\n\nWe're implementing a custom railtie that freezes `Rails.logger` to prevent unintentional modifications by gem initializers or application code. This addresses a recurring issue where we've accidentally changed the Rails logger level when configuring logging for gems that share the same logger instance.\n\nFor example, when a gem shares `Rails.logger` and we configure its logging level in an initializer like:\n```ruby\n# config/initializers/some_gem.rb\n\nSomeGem.logger.level = Logger::DEBUG  # Oops! This changes Rails.logger.level too\n```\n\nThis has happened a few times in our codebase, causing production log level changes that resulted in either lost log messages (when accidentally set to a higher level) or excessive logging (when set to a lower level).\n\nThe railtie works by freezing the logger after Rails completes its logger setup but before any `config/initializers` run. However, we discovered that Rails' `ActiveSupport::LoggerThreadSafeLevel` module attempts to modify the logger's singleton class when accessing `.level`, which fails when the logger is frozen (see link in code comment).\n\nOur current workaround is to call `Rails.logger.level` before freezing to trigger the lazy initialization of the thread-local key, but this feels like an implementation detail we shouldn't have to know about. It would be ideal if Rails loggers were designed to be freeze-friendly, allowing safe freezing without requiring knowledge of internal lazy initialization patterns.\n\n```ruby\n# frozen_string_literal: true\n\n# This railtie freezes the singleton Rails logger instance to prevent unintentional modifications\n# during initialisation or runtime. This ensures that in production, we don't lose log messages due\n# to a config initializer for a gem changing the logger level when sharing the same logger instance.\n#\nclass FreezeLoggerRailtie < Rails::Railtie\n  # rspec-mocks relies on proxies for method stubbing and expectations,\n  # and frozen objects cannot be proxied.\n  unless Rails.env.test?\n    initializer :freeze_logger, after: :initialize_logger, before: :load_config_initializers do\n      # We need to read the logger level before freezing the logger because the thread-local key to store\n      # the level is lazily assigned to an instance variable.\n      #\n      # See: https://github.com/rails/rails/blob/3235827585d87661942c91bc81f64f56d710f0b2/activesupport/lib/active_support/logger_thread_safe_level.rb#L43-L45\n      Rails.logger.level\n      Rails.logger.freeze\n\n      if Rails.logger.is_a?(ActiveSupport::BroadcastLogger)\n        Rails.logger.broadcasts.each do |logger|\n          logger.level\n          logger.freeze\n        end\n      end\n    end\n  end\nend\n\n```\n\n### Expected behavior\n\n<!-- Tell us what should happen -->\n\nCalling `Rails.logger.level` or `Rails.logger.info` or any common method on `Rails.logger` shouldn't raise an error when `Rails.logger.freeze` has been called beforehand.\n\n### Actual behavior\n\n<!-- Tell us what happens instead -->\n\nCalling `Rails.logger.level` or `Rails.logger.info` on `Rails.logger` when `Rails.logger.freeze` has been called beforehand raises an error during boot:\n\n```\n/Users/joshuayoung/Projects/buildkite/buildkite/.bundle/ruby/3.4.0/gems/activesupport-8.0.2/lib/active_support/logger_thread_safe_level.rb:44:in 'ActiveSupport::LoggerThreadSafeLevel#local_level_key': can't modify frozen #<Class:#<ActiveSupport::Logger:0x000000014bf3d170>>: #<ActiveSupport::Logger:0x000000014bf3d170 @level=1, @progname=nil, @default_formatter=#<Logger::Formatter:0x000000014bc515d8 @datetime_format=nil>, @formatter=#<ProductionLoggerFormatter:0x000000014bd3ed88 @datetime_format=nil>, @logdev=#<Logger::LogDevice:0x0000000160516380 @shift_period_suffix=\"%Y%m%d\", @shift_size=1048576, @shift_age=0, @filename=\"/Users/joshuayoung/Projects/buildkite/buildkite/log/production.log\", @dev=#<File:/Users/joshuayoung/Projects/buildkite/buildkite/log/production.log>, @binmode=false, @reraise_write_errors=[], @skip_header=false, @mon_data=#<Monitor:0x000000014bc51498>, @mon_data_owner_object_id=5768>, @level_override={}> (FrozenError)\n\tfrom /Users/joshuayoung/Projects/buildkite/buildkite/.bundle/ruby/3.4.0/gems/activesupport-8.0.2/lib/active_support/logger_thread_safe_level.rb:11:in 'ActiveSupport::LoggerThreadSafeLevel#local_level'\n\tfrom /Users/joshuayoung/Projects/buildkite/buildkite/.bundle/ruby/3.4.0/gems/activesupport-8.0.2/lib/active_support/logger_thread_safe_level.rb:31:in 'ActiveSupport::LoggerThreadSafeLevel#level'\n\tfrom /Users/joshuayoung/Projects/buildkite/buildkite/.bundle/ruby/3.4.0/gems/activesupport-8.0.2/lib/active_support/broadcast_logger.rb:109:in 'Array#map'\n\tfrom /Users/joshuayoung/Projects/buildkite/buildkite/.bundle/ruby/3.4.0/gems/activesupport-8.0.2/lib/active_support/broadcast_logger.rb:109:in 'ActiveSupport::BroadcastLogger#level'\n\tfrom /Users/joshuayoung/Projects/buildkite/buildkite/.bundle/ruby/3.4.0/gems/activerecord-8.0.2/lib/active_record/railtie.rb:68:in 'block in <class:Railtie>'\n\tfrom /Users/joshuayoung/Projects/buildkite/buildkite/.bundle/ruby/3.4.0/gems/railties-8.0.2/lib/rails/railtie.rb:272:in 'block in Rails::Railtie#run_console_blocks'\n\tfrom /Users/joshuayoung/Projects/buildkite/buildkite/.bundle/ruby/3.4.0/gems/railties-8.0.2/lib/rails/railtie.rb:297:in 'Array#each'\n\tfrom /Users/joshuayoung/Projects/buildkite/buildkite/.bundle/ruby/3.4.0/gems/railties-8.0.2/lib/rails/railtie.rb:297:in 'Rails::Railtie#each_registered_block'\n\tfrom /Users/joshuayoung/Projects/buildkite/buildkite/.bundle/ruby/3.4.0/gems/railties-8.0.2/lib/rails/railtie.rb:272:in 'Rails::Railtie#run_console_blocks'\n\tfrom /Users/joshuayoung/Projects/buildkite/buildkite/.bundle/ruby/3.4.0/gems/railties-8.0.2/lib/rails/application.rb:582:in 'block in Rails::Application#run_console_blocks'\n\tfrom /Users/joshuayoung/Projects/buildkite/buildkite/.bundle/ruby/3.4.0/gems/railties-8.0.2/lib/rails/engine/railties.rb:15:in 'Array#each'\n\tfrom /Users/joshuayoung/Projects/buildkite/buildkite/.bundle/ruby/3.4.0/gems/railties-8.0.2/lib/rails/engine/railties.rb:15:in 'Rails::Engine::Railties#each'\n\tfrom /Users/joshuayoung/Projects/buildkite/buildkite/.bundle/ruby/3.4.0/gems/railties-8.0.2/lib/rails/application.rb:582:in 'Rails::Application#run_console_blocks'\n\tfrom /Users/joshuayoung/Projects/buildkite/buildkite/.bundle/ruby/3.4.0/gems/railties-8.0.2/lib/rails/engine.rb:455:in 'Rails::Engine#load_console'\n```\n\n### System configuration\n\n**Rails version**: 8.0.1\n\n**Ruby version**: 3.4.5\n","closed_by":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/55460/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/55460/timeline","performed_via_github_app":null,"state_reason":"completed"}