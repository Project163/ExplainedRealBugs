{"url":"https://api.github.com/repos/rails/rails/issues/46507","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/46507/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/46507/comments","events_url":"https://api.github.com/repos/rails/rails/issues/46507/events","html_url":"https://github.com/rails/rails/issues/46507","id":1450320534,"node_id":"I_kwDNIULOVnIilg","number":46507,"title":"Disallow passing non-rewindable io to ActiveStorage::Blob.create_and_upload!","user":{"login":"Earlopain","id":14981592,"node_id":"MDQ6VXNlcjE0OTgxNTky","avatar_url":"https://avatars.githubusercontent.com/u/14981592?v=4","gravatar_id":"","url":"https://api.github.com/users/Earlopain","html_url":"https://github.com/Earlopain","followers_url":"https://api.github.com/users/Earlopain/followers","following_url":"https://api.github.com/users/Earlopain/following{/other_user}","gists_url":"https://api.github.com/users/Earlopain/gists{/gist_id}","starred_url":"https://api.github.com/users/Earlopain/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Earlopain/subscriptions","organizations_url":"https://api.github.com/users/Earlopain/orgs","repos_url":"https://api.github.com/users/Earlopain/repos","events_url":"https://api.github.com/users/Earlopain/events{/privacy}","received_events_url":"https://api.github.com/users/Earlopain/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":384913768,"node_id":"MDU6TGFiZWwzODQ5MTM3Njg=","url":"https://api.github.com/repos/rails/rails/labels/good%20first%20issue","name":"good first issue","color":"0e8a16","default":true,"description":""},{"id":664533972,"node_id":"MDU6TGFiZWw2NjQ1MzM5NzI=","url":"https://api.github.com/repos/rails/rails/labels/activestorage","name":"activestorage","color":"bfd4f2","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2022-11-15T20:11:08Z","updated_at":"2022-11-23T18:51:35Z","closed_at":"2022-11-23T18:51:35Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n\r\nPassing a Pathname to ActiveStorage::Blob.create_and_upload results in an infinite loop. The read method gets called on the io parameter when calculating the checksum, but since there is no pointer to advance it just keeps on reading from the beginning forever, fully utilizing a cpu core in the process.\r\n\r\nIt's kind of mentioned in the docs [here](https://github.com/rails/rails/blob/2d2fdc941e7497ca77f99ce5ad404b6e58f043ef/activestorage/app/models/active_storage/blob.rb#L6-L7) that the io must be rewindable. The fix is to simply not use Pathname, but it should either work or throw, infinite loops aren't great. One solution could be to check if the io responds to rewind in compute_checksum_in_chunks, which Pathname doesn't do.\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"rails\", \"~> 7.0.0\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record/railtie\"\r\nrequire \"active_storage/engine\"\r\nrequire \"tmpdir\"\r\n\r\nclass TestApp < Rails::Application\r\n  config.root = __dir__\r\n  config.hosts << \"example.org\"\r\n  config.eager_load = false\r\n  config.session_store :cookie_store, key: \"cookie_store_key\"\r\n  secrets.secret_key_base = \"secret_key_base\"\r\n\r\n  config.logger = Logger.new($stdout)\r\n  Rails.logger  = config.logger\r\n\r\n  config.active_storage.service = :local\r\n  config.active_storage.service_configurations = {\r\n    local: {\r\n      root: Dir.tmpdir,\r\n      service: \"Disk\"\r\n    }\r\n  }\r\nend\r\n\r\nENV[\"DATABASE_URL\"] = \"sqlite3::memory:\"\r\n\r\nRails.application.initialize!\r\n\r\nrequire ActiveStorage::Engine.root.join(\"db/migrate/20170806125915_create_active_storage_tables.rb\").to_s\r\n\r\nActiveRecord::Schema.define do\r\n  CreateActiveStorageTables.new.change\r\nend\r\n\r\nrequire \"minitest/autorun\"\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_active_storage_pathname\r\n    t = Tempfile.new\r\n    t << \"dummy\"\r\n    t.rewind\r\n\r\n    io = Pathname.new(t.path)\r\n    ActiveStorage::Blob.create_and_upload!(io: io, filename: \"dummy\")\r\n    puts \"never reached, create_and_upload! calculates the checksum in an infinite loop\"\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nIt throws an error telling me that the io must be rewindable.\r\n\r\n### Actual behavior\r\nThe function doesn't terminate and spins the cpu.\r\n\r\n### System configuration\r\n**Rails version**:\r\n7.0.4\r\n**Ruby version**:\r\n3.1.2","closed_by":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/46507/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/46507/timeline","performed_via_github_app":null,"state_reason":"completed"}