{"url":"https://api.github.com/repos/rails/rails/issues/50604","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/50604/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/50604/comments","events_url":"https://api.github.com/repos/rails/rails/issues/50604/events","html_url":"https://github.com/rails/rails/issues/50604","id":2067789909,"node_id":"I_kwDNIULOez_4VQ","number":50604,"title":"Active Record Encryption configs not ready in eager loading mode","user":{"login":"maximerety","id":58582,"node_id":"MDQ6VXNlcjU4NTgy","avatar_url":"https://avatars.githubusercontent.com/u/58582?v=4","gravatar_id":"","url":"https://api.github.com/users/maximerety","html_url":"https://github.com/maximerety","followers_url":"https://api.github.com/users/maximerety/followers","following_url":"https://api.github.com/users/maximerety/following{/other_user}","gists_url":"https://api.github.com/users/maximerety/gists{/gist_id}","starred_url":"https://api.github.com/users/maximerety/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maximerety/subscriptions","organizations_url":"https://api.github.com/users/maximerety/orgs","repos_url":"https://api.github.com/users/maximerety/repos","events_url":"https://api.github.com/users/maximerety/events{/privacy}","received_events_url":"https://api.github.com/users/maximerety/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2024-01-05T17:50:05Z","updated_at":"2024-02-12T21:13:24Z","closed_at":"2024-02-12T21:13:24Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description\r\n\r\nThe introduction of `after_initialize` in Active Record Encryption configuration setup in https://github.com/rails/rails/pull/48530 (also see [that discussion in the same PR](https://github.com/rails/rails/pull/48530/files#r1237624233)) is not fully compatible with the eager loading mode: https://github.com/rails/rails/blob/6b446bee63c401364d193920f3426af0bfe75650/activerecord/lib/active_record/railtie.rb#L385\r\n\r\nIn eager loading mode, the models from the application are loaded before the `after_initialize` hook has a chance to run, as visible here (hint: you need to scroll in the code snippet): https://github.com/rails/rails/blob/b0b1eb5a1847c1de5616a55c1d7c78f11eb08cd8/railties/lib/rails/application/finisher.rb#L77-L95\r\n\r\nAs a result, some configurations may not be ready at the time Active Record Encryption's helper `encrypts` needs them during model loading.\r\n\r\nFor example, the following methods are called in order: `encrypts` ->  `encrypt_attribute` -> `scheme_for` -> `global_previous_schemes_for`:\r\n\r\nhttps://github.com/rails/rails/blob/e0a55b038f7f2f50d1467876558be183be6cedaa/activerecord/lib/active_record/encryption/encryptable_record.rb#L78-L82\r\n\r\nIf `ActiveRecord::Encryption.config.previous_schemes` is not defined yet, then the encrypted attribute is not properly configured.\r\n\r\n### Example 1\r\n\r\n#### Steps to reproduce\r\n\r\nIn this example, a previous encryption scheme is provided globally, as described in https://guides.rubyonrails.org/active_record_encryption.html#global-previous-encryption-schemes:\r\n\r\n```ruby\r\n# config/application.rb\r\nconfig.active_record.encryption.previous = [ { key_provider: MyOldKeyProvider.new } ]\r\nconfig.eager_load = true\r\n\r\n# app/models/article.rb\r\nclass Article < ApplicationRecord\r\n  encrypts :title\r\nend\r\n```\r\n\r\n#### Expected behavior\r\n\r\nThe previous encryption scheme should always be taken into account when line `encrypts :title` is reached.\r\n\r\n#### Actual behavior\r\n\r\nWhen lazy loading the application, everything is fine and the `Article` model is lazily loaded after the previous encryption scheme is defined by the `after_initialize` hook and the `:title` attribute can benefit from that previous encryption scheme.\r\n\r\nWhen eager loading the application however, the `Article` model is eager loaded before the previous scheme is defined and that config gets ignored.\r\n\r\n### Example 2\r\n\r\n#### Steps to reproduce\r\n\r\nIn this example, a custom key provider is configured when declaring the attribute, as described in https://guides.rubyonrails.org/active_record_encryption.html#model-specific-key-providers:\r\n\r\n```ruby\r\n# config/application.rb\r\nconfig.eager_load = true\r\n\r\n# app/models/article.rb\r\nclass Article < ApplicationRecord\r\n  encrypts :title, key_provider: CustomKeyProvider.new(ActiveRecord::Encryption.config.primary_key)\r\nend\r\n```\r\n\r\n#### Expected behavior\r\n\r\nThe custom key provider should be able to use the `primary_key` configured  when line `encrypts :title` is reached.\r\n\r\n#### Actual behavior\r\n\r\nWhen lazy loading the application, everything is fine and the `Article` model is lazily loaded after the `primary_key` is defined by the `after_initialize` hook and the `:title` attribute can be set up normally.\r\n\r\nWhen eager loading the application however, the `Article` model is eager loaded before the `primary_key` is defined by the `after_initialize` hook, and the model fails to load with the following exception:\r\n\r\n```\r\nactiverecord-7.1.2/lib/active_record/encryption/config.rb:43:in `block (2 levels) in <class:Config>':\r\n  Missing Active Record encryption credential: active_record_encryption.primary_key (ActiveRecord::Encryption::Errors::Configuration)\r\n```\r\n\r\n### System configuration\r\n\r\n**Rails version**: `7.1.2` / `7.1.3` / `main`\r\n\r\n**Ruby version**: `3.2.2` / `3.3.0`\r\n\r\n### Possible fixes\r\n\r\n1. Get rid of `after_initialize` if not really necessary (see [previous discussions](https://github.com/rails/rails/pull/48530/files#r1237624233))\r\n2. Otherwise, keep `after_initialize` and attempt to patch the eager loading mode (using `config.before_eager_load`?)","closed_by":{"login":"eileencodes","id":1080678,"node_id":"MDQ6VXNlcjEwODA2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/1080678?v=4","gravatar_id":"","url":"https://api.github.com/users/eileencodes","html_url":"https://github.com/eileencodes","followers_url":"https://api.github.com/users/eileencodes/followers","following_url":"https://api.github.com/users/eileencodes/following{/other_user}","gists_url":"https://api.github.com/users/eileencodes/gists{/gist_id}","starred_url":"https://api.github.com/users/eileencodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eileencodes/subscriptions","organizations_url":"https://api.github.com/users/eileencodes/orgs","repos_url":"https://api.github.com/users/eileencodes/repos","events_url":"https://api.github.com/users/eileencodes/events{/privacy}","received_events_url":"https://api.github.com/users/eileencodes/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rails/rails/issues/50604/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/50604/timeline","performed_via_github_app":null,"state_reason":"completed"}