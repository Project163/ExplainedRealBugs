{"url":"https://api.github.com/repos/google/google-java-format/issues/846","repository_url":"https://api.github.com/repos/google/google-java-format","labels_url":"https://api.github.com/repos/google/google-java-format/issues/846/labels{/name}","comments_url":"https://api.github.com/repos/google/google-java-format/issues/846/comments","events_url":"https://api.github.com/repos/google/google-java-format/issues/846/events","html_url":"https://github.com/google/google-java-format/issues/846","id":1410288162,"node_id":"I_kwDOAhznzM5UD0oi","number":846,"title":"Formatter leaks threads and memory","user":{"login":"stiemannkj1","id":3483874,"node_id":"MDQ6VXNlcjM0ODM4NzQ=","avatar_url":"https://avatars.githubusercontent.com/u/3483874?v=4","gravatar_id":"","url":"https://api.github.com/users/stiemannkj1","html_url":"https://github.com/stiemannkj1","followers_url":"https://api.github.com/users/stiemannkj1/followers","following_url":"https://api.github.com/users/stiemannkj1/following{/other_user}","gists_url":"https://api.github.com/users/stiemannkj1/gists{/gist_id}","starred_url":"https://api.github.com/users/stiemannkj1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/stiemannkj1/subscriptions","organizations_url":"https://api.github.com/users/stiemannkj1/orgs","repos_url":"https://api.github.com/users/stiemannkj1/repos","events_url":"https://api.github.com/users/stiemannkj1/events{/privacy}","received_events_url":"https://api.github.com/users/stiemannkj1/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-10-15T20:54:36Z","updated_at":"2023-02-04T00:59:27Z","closed_at":"2023-02-04T00:59:27Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"The formatter fails to clean up the threads it creates which leaks the threads themselves (if the formatter is run multiple times) and the memory for the threads.\r\n\r\nThis also can prevent the JVM to from shutting down because the threads are non-daemon threads.\n\nThe reason this leak doesn't usually affect users is probably because users run the formatter via the CLI which calls ` System#exit` to kill the JVM process.\r\n\r\n## Steps to Reproduce:\r\n\r\n1. Add this test to `MainTest.java`:\r\n\r\n    ```\r\n    private static Path createTestSourceFile(TemporaryFolder testFolder, String className)\r\n        throws IOException {\r\n      Path path = testFolder.newFile(className + \".java\").toPath();\r\n      Files.write(path, (\"class \" + className + \" {}\\n\").getBytes(UTF_8));\r\n      try {\r\n        Files.setPosixFilePermissions(path, EnumSet.of(PosixFilePermission.OWNER_READ));\r\n      } catch (UnsupportedOperationException e) {\r\n        throw new IOException(e);\r\n      }\r\n      return path;\r\n    }\r\n  \r\n    @Test\r\n    public void doesNotLeakThreads() throws Exception {\r\n      Path testA = createTestSourceFile(testFolder, \"TestA\");\r\n      Path testB = createTestSourceFile(testFolder, \"TestB\");\r\n  \r\n      // Get the number of threads before formatting.\r\n      int numberOfThreadsBeforeFormatting = Thread.currentThread().getThreadGroup().activeCount();\r\n  \r\n      // Run the formatter several times.\r\n      for (int i = 0; i < 10000; i++) {\r\n        final var errorCode =\r\n            new GoogleJavaFormatToolProvider()\r\n                .run(\r\n                    new PrintWriter(\r\n                        new BufferedWriter(new OutputStreamWriter(System.out, UTF_8)), true),\r\n                    new PrintWriter(\r\n                        new BufferedWriter(new OutputStreamWriter(System.err, UTF_8)), true),\r\n                    \"--replace\",\r\n                    testA.toString(),\r\n                    testB.toString());\r\n        assertWithMessage(\"Error Code\").that(errorCode).isEqualTo(0);\r\n      }\r\n  \r\n      // Verify that the number of threads is nearly the same before and after. NB: we allow for a few\r\n      // additional threads since we don't completely control the number of running threads in this\r\n      // test.\r\n      assertThat(Thread.currentThread().getThreadGroup().activeCount())\r\n          .isLessThan(numberOfThreadsBeforeFormatting + 5);\r\n    }\r\n    ```\r\n\r\n2. Run the test:\r\n\r\n        mvn test -Dtest=\"MainTest#doesNotLeakThreads\"\r\n\r\nIf the test fails you'll get an OOM error:\r\n\r\n```\r\n[WARNING] Corrupted STDOUT by directly writing to native stream in forked JVM 1. See FAQ web page and the dump file /Volumes/Projects/google/google-java-format/core/target/surefire-reports/2022-10-15T16-48-29_971-jvmRun1.dumpstream\r\n[ERROR] Tests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 1.654 s <<< FAILURE! - in com.google.googlejavaformat.java.MainTest\r\n[ERROR] doesNotLeakThreads(com.google.googlejavaformat.java.MainTest)  Time elapsed: 1.629 s  <<< ERROR!\r\njava.lang.OutOfMemoryError: unable to create native thread: possibly out of memory or process/resource limits reached\r\n        at com.google.googlejavaformat.java.MainTest.doesNotLeakThreads(MainTest.java:645)\r\n\r\njava.lang.OutOfMemoryError: unable to create native thread: possibly out of memory or process/resource limits reached\r\n        at java.base/java.lang.Thread.start0(Native Method)\r\n        at java.base/java.lang.Thread.start(Thread.java:798)\r\n        at java.base/java.util.concurrent.ThreadPoolExecutor.addWorker(ThreadPoolExecutor.java:937)\r\n        at java.base/java.util.concurrent.ThreadPoolExecutor.ensurePrestart(ThreadPoolExecutor.java:1583)\r\n        at java.base/java.util.concurrent.ScheduledThreadPoolExecutor.delayedExecute(ScheduledThreadPoolExecutor.java:346)\r\n        at java.base/java.util.concurrent.ScheduledThreadPoolExecutor.schedule(ScheduledThreadPoolExecutor.java:562)\r\n        at org.apache.maven.surefire.booter.ForkedBooter.launchLastDitchDaemonShutdownThread(ForkedBooter.java:369)\r\n        at org.apache.maven.surefire.booter.ForkedBooter.acknowledgedExit(ForkedBooter.java:333)\r\n        at org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:145)\r\n        at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:418)\r\nException in thread \"main\" java.lang.OutOfMemoryError: unable to create native thread: possibly out of memory or process/resource limits reached\r\n        at java.base/java.lang.Thread.start0(Native Method)\r\n        at java.base/java.lang.Thread.start(Thread.java:798)\r\n        at java.base/java.util.concurrent.ThreadPoolExecutor.addWorker(ThreadPoolExecutor.java:937)\r\n        at java.base/java.util.concurrent.ThreadPoolExecutor.ensurePrestart(ThreadPoolExecutor.java:1583)\r\n        at java.base/java.util.concurrent.ScheduledThreadPoolExecutor.delayedExecute(ScheduledThreadPoolExecutor.java:346)\r\n        at java.base/java.util.concurrent.ScheduledThreadPoolExecutor.schedule(ScheduledThreadPoolExecutor.java:562)\r\n        at org.apache.maven.surefire.booter.ForkedBooter.launchLastDitchDaemonShutdownThread(ForkedBooter.java:369)\r\n        at org.apache.maven.surefire.booter.ForkedBooter.exit(ForkedBooter.java:316)\r\n        at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:425)\r\n```\r\n\r\nIf the test passes the bug is fixed.\r\n","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/google/google-java-format/issues/846/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/google/google-java-format/issues/846/timeline","performed_via_github_app":null,"state_reason":"completed"}