diff --git a/wicket-request/src/main/java/org/apache/wicket/request/Request.java b/wicket-request/src/main/java/org/apache/wicket/request/Request.java
index 623229d058..8d00d44f57 100644
--- a/wicket-request/src/main/java/org/apache/wicket/request/Request.java
+++ b/wicket-request/src/main/java/org/apache/wicket/request/Request.java
@@ -38,7 +38,22 @@ public abstract class Request
 	public abstract Url getUrl();
 
 	/**
-	 * In case this request has been created using {@link #requestWithUrl(Url)}, this method should
+	 * Returns the base URL relative to which this request should be processed.
+	 * 
+	 * If the current requested url is:
+	 * 
+	 * <pre>
+	 * /con/text/fil/ter/wicket/page?1&foo=bar
+	 * </pre>
+	 * 
+	 * the relative url is: </pre> wicket/page </pre>
+	 * 
+	 * @return ajax base url
+	 */
+	public abstract Url getBaseUrl();
+
+	/**
+	 * In case this request has been created using {@link #cloneWithUrl(Url)}, this method should
 	 * return the original URL.
 	 * 
 	 * @return original URL
@@ -86,7 +101,7 @@ public abstract class Request
 	 *            Url instance
 	 * @return request with specified URL.
 	 */
-	public Request requestWithUrl(final Url url)
+	public Request cloneWithUrl(final Url url)
 	{
 		return new Request()
 		{
@@ -119,6 +134,12 @@ public abstract class Request
 			{
 				return Request.this.getCharset();
 			}
+
+			@Override
+			public Url getBaseUrl()
+			{
+				return getUrl();
+			}
 		};
 	}
 
diff --git a/wicket-request/src/main/java/org/apache/wicket/request/Url.java b/wicket-request/src/main/java/org/apache/wicket/request/Url.java
index c7a4e42c08..800029253a 100755
--- a/wicket-request/src/main/java/org/apache/wicket/request/Url.java
+++ b/wicket-request/src/main/java/org/apache/wicket/request/Url.java
@@ -257,6 +257,18 @@ public final class Url implements Serializable
 		setCharset(charset);
 	}
 
+	public void resolveRelativeTo(Url base)
+	{
+		Url url = new Url(base);
+
+		while (!getSegments().isEmpty() && "..".equals(getSegments().get(0)))
+		{
+			removeLeadingSegments(0);
+			url.getSegments().remove(url.getSegments().size() - 1);
+		}
+		getSegments().addAll(url.getSegments());
+	}
+
 	/**
 	 * Returns segments of the URL. Segments form the part before query string.
 	 * 
@@ -701,4 +713,54 @@ public final class Url implements Serializable
 			return result.toString();
 		}
 	}
+
+	/**
+	 * Makes this url the result of resolving the {@code relative} url against this url.
+	 * <p>
+	 * Segments will be properly resolved, handling any {@code ..} references, while the query
+	 * parameters will be completely replaced with {@code relative}'s query parameters.
+	 * </p>
+	 * <p>
+	 * For example:
+	 * 
+	 * <pre>
+	 * wicket/page/render?foo=bar
+	 * </pre>
+	 * 
+	 * resolved with
+	 * 
+	 * <pre>
+	 * ../component/render?a=b
+	 * </pre>
+	 * 
+	 * will become
+	 * 
+	 * <pre>
+	 * wicket/component/render?a=b
+	 * </pre>
+	 * 
+	 * </p>
+	 * 
+	 * @param relative
+	 *            relative url
+	 */
+	public void resolveRelative(Url relative)
+	{
+		// strip the first non-folder segment
+		getSegments().remove(getSegments().size() - 1);
+
+		// process any ../ segments in the relative url
+		while (!relative.getSegments().isEmpty() && "".equals(relative.getSegments().get(0)))
+		{
+			relative.getSegments().remove(0);
+			getSegments().remove(getSegments().size() - 1);
+		}
+
+		// append the remaining relative segments
+		getSegments().addAll(relative.getSegments());
+
+		// replace query params with the ones from relative
+		parameters.clear();
+		parameters.addAll(relative.getQueryParameters());
+	}
 }
diff --git a/wicket-request/src/main/java/org/apache/wicket/request/http/WebRequest.java b/wicket-request/src/main/java/org/apache/wicket/request/http/WebRequest.java
index f6c644213a..6e2403e1af 100644
--- a/wicket-request/src/main/java/org/apache/wicket/request/http/WebRequest.java
+++ b/wicket-request/src/main/java/org/apache/wicket/request/http/WebRequest.java
@@ -33,9 +33,19 @@ import org.apache.wicket.util.string.Strings;
  * Base class for request that provides additional web-related information.
  * 
  * @author Matej Knopp
+ * @author Igor Vaynberg
  */
 public abstract class WebRequest extends Request
 {
+	/** marker for Ajax requests */
+	protected static final String PARAM_AJAX = "wicket-ajax";
+	/** marker for Ajax requests */
+	protected static final String HEADER_AJAX = "Wicket-Ajax";
+	/** marker for Ajax-relative url */
+	protected static final String PARAM_AJAX_BASE_URL = "wicket-ajax-baseurl";
+	/** marker for Ajax-relative url */
+	protected static final String HEADER_AJAX_BASE_URL = "Wicket-Ajax-BaseURL";
+
 	/**
 	 * @return request cookies
 	 */
@@ -101,15 +111,11 @@ public abstract class WebRequest extends Request
 		}
 	}
 
-	/**
-	 * Marker parameter for AjaxRequest.
-	 */
-	private static final String PARAM_AJAX = "wicket:ajax";
-	private static final String HEADER_AJAX = "Wicket-Ajax";
 
 	/**
-	 * Returns whether this request is an Ajax request. This implementation only checks for value of
-	 * wicket:ajax url parameter. Subclasses can use other approach.
+	 * Returns whether this request is an Ajax request. This implementation checks for values of
+	 * {@value #PARAM_AJAX} url parameter or the {@value #HEADER_AJAX} header. Subclasses can use
+	 * other approaches.
 	 * 
 	 * @return <code>true</code> if this request is an ajax request, <code>false</code> otherwise.
 	 */
@@ -127,7 +133,7 @@ public abstract class WebRequest extends Request
 	 * @return request with specified URL.
 	 */
 	@Override
-	public WebRequest requestWithUrl(final Url url)
+	public WebRequest cloneWithUrl(final Url url)
 	{
 		return new WebRequest()
 		{
@@ -178,6 +184,12 @@ public abstract class WebRequest extends Request
 			{
 				return WebRequest.this.getCharset();
 			}
+
+			@Override
+			public Url getBaseUrl()
+			{
+				return WebRequest.this.getBaseUrl();
+			}
 		};
 	}
 
diff --git a/wicket-request/src/main/java/org/apache/wicket/request/mapper/AbstractMapper.java b/wicket-request/src/main/java/org/apache/wicket/request/mapper/AbstractMapper.java
index 10d132018a..4be40561b8 100644
--- a/wicket-request/src/main/java/org/apache/wicket/request/mapper/AbstractMapper.java
+++ b/wicket-request/src/main/java/org/apache/wicket/request/mapper/AbstractMapper.java
@@ -118,7 +118,7 @@ public abstract class AbstractMapper
 			removeMetaParameter(urlCopy);
 		}
 
-		PageParameters decoded = encoder.decodePageParameters(request.requestWithUrl(urlCopy));
+		PageParameters decoded = encoder.decodePageParameters(request.cloneWithUrl(urlCopy));
 		return decoded;
 	}
 
diff --git a/wicket-request/src/main/java/org/apache/wicket/request/mapper/CompoundRequestMapper.java b/wicket-request/src/main/java/org/apache/wicket/request/mapper/CompoundRequestMapper.java
index 1368e2d9ad..571222f0f0 100644
--- a/wicket-request/src/main/java/org/apache/wicket/request/mapper/CompoundRequestMapper.java
+++ b/wicket-request/src/main/java/org/apache/wicket/request/mapper/CompoundRequestMapper.java
@@ -118,7 +118,8 @@ public class CompoundRequestMapper implements ICompoundRequestMapper
 
 		for (IRequestMapper encoder : mappers)
 		{
-			list.add(new EncoderWithSegmentsCount(encoder, encoder.getCompatibilityScore(request)));
+			int score = encoder.getCompatibilityScore(request);
+			list.add(new EncoderWithSegmentsCount(encoder, score));
 		}
 
 		Collections.sort(list);
diff --git a/wicket-request/src/main/java/org/apache/wicket/request/mapper/ParentPathReferenceRewriter.java b/wicket-request/src/main/java/org/apache/wicket/request/mapper/ParentPathReferenceRewriter.java
index bfd02c2cd9..62aba991ff 100755
--- a/wicket-request/src/main/java/org/apache/wicket/request/mapper/ParentPathReferenceRewriter.java
+++ b/wicket-request/src/main/java/org/apache/wicket/request/mapper/ParentPathReferenceRewriter.java
@@ -79,7 +79,7 @@ public class ParentPathReferenceRewriter implements IRequestMapper
 			}
 		}
 
-		return chain.mapRequest(request.requestWithUrl(url));
+		return chain.mapRequest(request.cloneWithUrl(url));
 	}
 
 	/**
diff --git a/wicket-request/src/main/java/org/apache/wicket/request/mapper/mount/MountMapper.java b/wicket-request/src/main/java/org/apache/wicket/request/mapper/mount/MountMapper.java
index 6377f9d9f0..2bf61d9e86 100644
--- a/wicket-request/src/main/java/org/apache/wicket/request/mapper/mount/MountMapper.java
+++ b/wicket-request/src/main/java/org/apache/wicket/request/mapper/mount/MountMapper.java
@@ -103,7 +103,7 @@ public class MountMapper extends AbstractMapper
 	{
 		Url dismountedUrl = new Url(request.getUrl());
 		dismountedUrl.removeLeadingSegments(mountSegments.length);
-		return request.requestWithUrl(dismountedUrl);
+		return request.cloneWithUrl(dismountedUrl);
 	}
 
 	/**
