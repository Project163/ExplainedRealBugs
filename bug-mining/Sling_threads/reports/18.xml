<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:38:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SLING-7432] Thread pool clean up code can lead to infinite loops in ThreadLocal.get</title>
                <link>https://issues.apache.org/jira/browse/SLING-7432</link>
                <project id="12310710" key="SLING">Sling</project>
                    <description>&lt;p&gt;The thread local clean up code added in &lt;a href=&quot;https://issues.apache.org/jira/browse/SLING-6261&quot; title=&quot;ThreadExpiringThreadPool is relying on uncaught exceptions to kill threads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SLING-6261&quot;&gt;&lt;del&gt;SLING-6261&lt;/del&gt;&lt;/a&gt; leads to Threads stuck in &lt;tt&gt;ThreadLocal.get&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I am working on a simplified test case, but the stack trace is similar to&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;pool-1-thread-1&quot; prio=10 tid=0x00007f47f4374800 nid=0xb19 runnable [0x00007f47e734e000]
   java.lang.Thread.State: RUNNABLE
	at java.lang.ThreadLocal$ThreadLocalMap.set(ThreadLocal.java:429)
	at java.lang.ThreadLocal$ThreadLocalMap.access$100(ThreadLocal.java:261)
	at java.lang.ThreadLocal.set(ThreadLocal.java:183)
	at org.apache.sling.commons.threads.impl.ThreadPoolExecutorCleaningThreadLocalsTest$RunnableImplementation.run(ThreadPoolExecutorCleaningThreadLocalsTest.java:100)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
	at java.util.concurrent.FutureTask.run(FutureTask.java:262)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13133059">SLING-7432</key>
            <summary>Thread pool clean up code can lead to infinite loops in ThreadLocal.get</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rombert">Robert Munteanu</assignee>
                                    <reporter username="rombert">Robert Munteanu</reporter>
                        <labels>
                    </labels>
                <created>Tue, 23 Jan 2018 13:54:00 +0000</created>
                <updated>Thu, 1 Feb 2018 09:55:25 +0000</updated>
                            <resolved>Thu, 25 Jan 2018 13:36:34 +0000</resolved>
                                    <version>Commons Threads 3.2.10</version>
                                    <fixVersion>Commons Threads 3.2.16</fixVersion>
                                    <component>Commons</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16335793" author="rombert" created="Tue, 23 Jan 2018 13:58:27 +0000"  >&lt;p&gt;Added ignored test in &lt;a href=&quot;https://github.com/apache/sling-org-apache-sling-commons-threads/commit/21a553d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;sling-org-apache-sling-commons-threads commit 21a553d&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16335840" author="rombert" created="Tue, 23 Jan 2018 14:34:42 +0000"  >&lt;p&gt;Applied a potential fix in &lt;a href=&quot;https://github.com/apache/sling-org-apache-sling-commons-threads/commit/afa59d6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;sling-org-apache-sling-commons-threads commit afa59d6&lt;/a&gt;. This at least makes the failing test for me.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kwin&quot; class=&quot;user-hover&quot; rel=&quot;kwin&quot;&gt;kwin&lt;/a&gt; - I am going to run some more extensive tests, but it would be good if you could also review the change. I&apos;ve checked and the &lt;tt&gt;ThreadLocalMap&lt;/tt&gt; has the same three fields in Java 7, 8 and 9, so we should be covered at least from that point of view.&lt;/p&gt;</comment>
                            <comment id="16335860" author="kwin" created="Tue, 23 Jan 2018 14:46:59 +0000"  >&lt;p&gt;Looks good to me. I am wondering whether &lt;a href=&quot;https://issues.apache.org/jira/browse/SLING-7320&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SLING-7320&lt;/a&gt; is related but up to now I couldn&apos;t reproduce the NPE.&lt;/p&gt;</comment>
                            <comment id="16335864" author="rombert" created="Tue, 23 Jan 2018 14:48:26 +0000"  >&lt;p&gt;Well, I apparently fixed one problem, but I am still able to reproduce the hang outside the unit test :| So I need to dig a bit more&lt;/p&gt;</comment>
                            <comment id="16336371" author="rombert" created="Tue, 23 Jan 2018 21:05:56 +0000"  >&lt;p&gt;While going deeper and deeper in the code we currently have, I wonder whether it&apos;s all necessary. We have a thread pool where we manage all threads, they never &quot;escape&quot; from our control. So we don&apos;t need to provide anyone with guarantees regarding restoring thread local values after threads have finished execution.&lt;/p&gt;

&lt;p&gt;I think we can simply set the ThreadLocalMap fields to null and be done with it ( and testing this assumption now ).&lt;/p&gt;</comment>
                            <comment id="16336388" author="kwin" created="Tue, 23 Jan 2018 21:20:08 +0000"  >&lt;p&gt;New threads by default carry some thread locals (which are set by Oracle). Removing those once a thread from the pool is gonna be reused might have negative side-effects.&lt;/p&gt;</comment>
                            <comment id="16336397" author="rombert" created="Tue, 23 Jan 2018 21:27:11 +0000"  >&lt;p&gt;Interesting, I did not know about that. I looked briefly at the code and all that I found was the passing of &apos;inheritable&apos; thread locals&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (inheritThreadLocals &amp;amp;&amp;amp; parent.inheritableThreadLocals != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.inheritableThreadLocals =
                ThreadLocal.createInheritedMap(parent.inheritableThreadLocals);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Do you have any other references for the default thread locals? I&apos;d like to make sure I don&apos;t mess anything up related to that.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Edit&lt;/em&gt;: formatting&lt;/p&gt;</comment>
                            <comment id="16337329" author="kwin" created="Wed, 24 Jan 2018 10:28:06 +0000"  >&lt;p&gt;I unfortunately don&apos;t have any reference but right after creating the thread (i.e. in the &lt;tt&gt;beforeExecute&lt;/tt&gt; method) it already has 7 thread locals attached (i.e. size is 7). Some of them are integers. Don&apos;t know for what they are used internally.&lt;/p&gt;</comment>
                            <comment id="16337818" author="kwin" created="Wed, 24 Jan 2018 16:07:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rombert&quot; class=&quot;user-hover&quot; rel=&quot;rombert&quot;&gt;rombert&lt;/a&gt; Please check out the branch from &lt;a href=&quot;https://github.com/apache/sling-org-apache-sling-commons-threads/compare/bugfix/SLING-7432?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/sling-org-apache-sling-commons-threads/compare/bugfix/SLING-7432?expand=1&lt;/a&gt;. There I added some logging (therefore please do not merge as is) and also I cleaned up the logic a bit where the old thread local state is being stored. This is now no longer internally relying on thread locals. Please check if that fixes the issue on your side already. If not the logging should give further hints on why you run into an infinite loop (hopefully).&lt;/p&gt;</comment>
                            <comment id="16338125" author="rombert" created="Wed, 24 Jan 2018 19:44:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kwin&quot; class=&quot;user-hover&quot; rel=&quot;kwin&quot;&gt;kwin&lt;/a&gt; - I am working on removing all thread locals as well, I assume this might trip to the save/restore logic. I&apos;m running the tests as we speak and I&apos;ll compare with your changes as well.&lt;/p&gt;</comment>
                            <comment id="16339221" author="rombert" created="Thu, 25 Jan 2018 13:36:34 +0000"  >&lt;p&gt;I think we finally got this right, so pushing my changes&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/sling-org-apache-sling-commons-threads/commit/69c0e9f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;sling-org-apache-sling-commons-threads commit 69c0e9f&lt;/a&gt; - stop using any sort of &lt;tt&gt;ThreadLocal&lt;/tt&gt; field&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/sling-org-apache-sling-commons-threads/commit/e046d2f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;sling-org-apache-sling-commons-threads commit e046d2f&lt;/a&gt; - throw any errors or runtime exceptions from the &lt;tt&gt;beforeExecute&lt;/tt&gt; method to make sure the fallback thread pool implementation is used&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kwin&quot; class=&quot;user-hover&quot; rel=&quot;kwin&quot;&gt;kwin&lt;/a&gt; for your help.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13123940">SLING-7300</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="13019472">SLING-6261</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 42 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3p8zz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>