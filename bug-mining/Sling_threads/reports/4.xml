<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:38:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SLING-2535] QuartzScheduler:ApacheSling thread group remaining after stopping the scheduler bundle</title>
                <link>https://issues.apache.org/jira/browse/SLING-2535</link>
                <project id="12310710" key="SLING">Sling</project>
                    <description>&lt;p&gt;When the Scheduler bundle is stopped, the threads (probably the thread pool) is cleaned away but the thread group &quot;QuartzScheduler:ApacheSling&quot; remains. For ultimate cleanup, I would think the thread group should also be destroyed.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12599124">SLING-2535</key>
            <summary>QuartzScheduler:ApacheSling thread group remaining after stopping the scheduler bundle</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ianeboston">Ian Boston</assignee>
                                    <reporter username="fmeschbe">Felix Meschberger</reporter>
                        <labels>
                    </labels>
                <created>Tue, 17 Jul 2012 15:02:17 +0000</created>
                <updated>Mon, 7 Oct 2013 14:55:59 +0000</updated>
                            <resolved>Thu, 6 Jun 2013 12:31:32 +0000</resolved>
                                    <version>Commons Scheduler 2.3.4</version>
                                    <fixVersion>Commons Scheduler 2.4.0</fixVersion>
                                    <component>Commons</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13426675" author="cziegeler" created="Wed, 1 Aug 2012 14:51:15 +0000"  >&lt;p&gt;Actually calling shutdown on the quartz scheduler should remove the thread group. Maybe we need do to something additional&lt;/p&gt;</comment>
                            <comment id="13487598" author="ianeboston" created="Wed, 31 Oct 2012 07:16:02 +0000"  >&lt;p&gt;Testing in the trunk at 1403475 shows that the thread pool does shutdown if Sling has just been started and no jobs have been run.&lt;/p&gt;

&lt;p&gt;31.10.2012 17:48:56.013 &lt;b&gt;INFO&lt;/b&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;401258966@qtp-1399560387-11&amp;#93;&lt;/span&gt; org.apache.sling.commons.threads.impl.DefaultThreadPool Shutting down thread pool &lt;span class=&quot;error&quot;&gt;&amp;#91;ThreadPool-0a751a8b-e907-4993-806f-64923e3d85cd (Apache Sling Eventing Thread Pool)&amp;#93;&lt;/span&gt; ...&lt;br/&gt;
31.10.2012 17:48:56.013 &lt;b&gt;INFO&lt;/b&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;401258966@qtp-1399560387-11&amp;#93;&lt;/span&gt; org.apache.sling.commons.threads.impl.DefaultThreadPool Thread pool &lt;span class=&quot;error&quot;&gt;&amp;#91;ThreadPool-0a751a8b-e907-4993-806f-64923e3d85cd (Apache Sling Eventing Thread Pool)&amp;#93;&lt;/span&gt; is shut down.&lt;/p&gt;

&lt;p&gt;JMX records the Thread group disappears when the bundle unloads.&lt;br/&gt;
(My JDK is 1.6 Java HotSpot(TM) 64-Bit Server VM version 20.12-b01-434)&lt;/p&gt;

&lt;p&gt;Default configuration on thread groups is to shutdown non gracefully so its not an issue with threads in the thread group being slow to terminate.&lt;/p&gt;

&lt;p&gt;Looking at the code:&lt;/p&gt;

&lt;p&gt;In org.apache.sling.commons.scheduler.impl.QuartzScheduler.QuartzThreadPool.shutdown(boolean) does nothing. &lt;/p&gt;

&lt;p&gt;QuartzThreadPool.shutdown is called by org.quartz.core.QuartzScheduler.shutdown(boolean) line 677.&lt;/p&gt;

&lt;p&gt;        resources.getThreadPool().shutdown(waitForJobsToComplete);&lt;/p&gt;


&lt;p&gt;The comment on org.apache.sling.commons.scheduler.impl.QuartzScheduler.QuartzThreadPool.shutdown(boolean) indicates that the pool is managed by the thread pool manager.&lt;/p&gt;

&lt;p&gt;in the org.apache.sling.commons.scheduler.impl.QuartzScheduler.dispose(Scheduler) line 222, tpm.release(this.threadPool); is called. &lt;br/&gt;
This calls org.apache.sling.commons.threads.impl.DefaultThreadPoolManager.Entry.decUsage() which when a reference counter reaches zero the thread pool is shutdown by calling org.apache.sling.commons.threads.impl.DefaultThreadPool.shutdown() which calls down to the JDK.&lt;/p&gt;

&lt;p&gt;That last method should emit some messages:&lt;br/&gt;
        this.logger.info(&quot;Shutting down thread pool &lt;span class=&quot;error&quot;&gt;&amp;#91;{}&amp;#93;&lt;/span&gt; ...&quot;, name);&lt;br/&gt;
followed by&lt;br/&gt;
        this.logger.info(&quot;Thread pool &lt;span class=&quot;error&quot;&gt;&amp;#91;{}&amp;#93;&lt;/span&gt; is shut down.&quot;, this.name);&lt;/p&gt;

&lt;p&gt;the incUsage and decUsage methods reference count with ints protected by synchronized(this.pool) where this.pool is the pool they were added to.... except for one location.&lt;/p&gt;

&lt;p&gt;org.apache.sling.commons.threads.impl.DefaultThreadPoolManager.create(ThreadPoolConfig) does this:&lt;/p&gt;

&lt;p&gt;  final Entry entry = new Entry(null, config, name);&lt;br/&gt;
  synchronized ( this.pools ) &lt;/p&gt;
{
          this.pools.put(name, entry);
   }
&lt;p&gt;   return entry.incUsage();&lt;/p&gt;

&lt;p&gt;which could result in an invalid reference count causing decUsage to never call the ThreadExecutor shutdown.&lt;/p&gt;


&lt;p&gt;To recap:&lt;br/&gt;
If there is no &lt;br/&gt;
Shutting down thread pool &lt;span class=&quot;error&quot;&gt;&amp;#91;ThreadPool-0a751a8b-e907-4993-806f-64923e3d85cd (Apache Sling Eventing Thread Pool)&amp;#93;&lt;/span&gt; &lt;/p&gt;

&lt;p&gt;in the logs there is a race condition in decUsage, incUsage&lt;/p&gt;

&lt;p&gt;if there is, but there is no &lt;br/&gt;
Thread pool &lt;span class=&quot;error&quot;&gt;&amp;#91;ThreadPool-0a751a8b-e907-4993-806f-64923e3d85cd (Apache Sling Eventing Thread Pool)&amp;#93;&lt;/span&gt; is shut down.&lt;/p&gt;

&lt;p&gt;Then its an issue with running jobs in the Quartz scheduler.&lt;br/&gt;
Since the default configuration of the ThreadPools (unless there is a configuration) seems to be to a non graceful shutdown which points to a race condition.&lt;/p&gt;

&lt;p&gt;In addition FindBugs reports &lt;br/&gt;
VO_VOLATILE_INCREMENT&lt;br/&gt;
This code increments a volatile field. Increments of volatile fields aren&apos;t atomic. If more than one thread is incrementing the field at the same time, increments could be lost.&lt;/p&gt;

&lt;p&gt;(It doesn&apos;t detect the potential synchronization issue or that the volatile field is protected)&lt;/p&gt;


&lt;p&gt;To fix, for certain I would need to be able to reproduce. Is there are reliable way ?&lt;/p&gt;

&lt;p&gt;(Sorry for the long comment)&lt;/p&gt;





</comment>
                            <comment id="13487609" author="cziegeler" created="Wed, 31 Oct 2012 08:08:32 +0000"  >&lt;p&gt;I think you&apos;re right, create() and also get(String) do not sync access to the Entry class (incUsage in this case) - so it should be moved into the sync block in both cases.&lt;/p&gt;</comment>
                            <comment id="13487675" author="ianeboston" created="Wed, 31 Oct 2012 10:51:25 +0000"  >&lt;p&gt;I have put sync blocks inside incUsage and decUsage to see if that addresses the problem in r1404087.&lt;br/&gt;
After looking at it for some time I felt this was safer since it doesn&apos;t require the caller to know they have to be synchronized.&lt;/p&gt;</comment>
                            <comment id="13487677" author="cziegeler" created="Wed, 31 Oct 2012 10:59:00 +0000"  >&lt;p&gt;Hmm, not 100% sure, need to check the code again but right now all other syncing is done from the outside. I think there is a decUsage()/ isInUse() combination which could maybe cause trouble&lt;/p&gt;</comment>
                            <comment id="13488220" author="ianeboston" created="Wed, 31 Oct 2012 20:51:28 +0000"  >&lt;p&gt;Hmm, I see what you mean. &lt;br/&gt;
The shutdown in decUsage has the potential to cause a deadlock.&lt;/p&gt;

&lt;p&gt;       public void decUsage() {&lt;br/&gt;
            synchronized (usagelock) {&lt;br/&gt;
                this.count--;&lt;br/&gt;
                if ( this.count == 0 ) &lt;/p&gt;
{
                    this.shutdown();
                }
&lt;p&gt;            }&lt;br/&gt;
        }&lt;/p&gt;

&lt;p&gt;could be &lt;br/&gt;
         public void decUsage() {&lt;br/&gt;
            boolean shutdown = false;&lt;br/&gt;
            synchronized (usagelock) {&lt;br/&gt;
                this.count--;&lt;br/&gt;
                if ( this.count == 0 ) &lt;/p&gt;
{
                    shutdown = true;
                }
&lt;p&gt;            }&lt;br/&gt;
            if ( shutdown ) &lt;/p&gt;
{
                  this.shutdown();
            }
&lt;p&gt;        }&lt;/p&gt;</comment>
                            <comment id="13488375" author="ianeboston" created="Thu, 1 Nov 2012 00:24:01 +0000"  >&lt;p&gt;Reverted the commit and put the sync one layer further out as suggested.&lt;br/&gt;
Avoiding a deadlock or weird behaviour was going to be hard.&lt;/p&gt;</comment>
                            <comment id="13493750" author="ianeboston" created="Fri, 9 Nov 2012 05:40:35 +0000"  >&lt;p&gt;I think this is fixed, but I am leaving the issue open to see if it reappears in the wild.&lt;/p&gt;</comment>
                            <comment id="13676957" author="cziegeler" created="Thu, 6 Jun 2013 12:31:18 +0000"  >&lt;p&gt;Assigning to Ian who worked on this&lt;/p&gt;</comment>
                            <comment id="13676958" author="cziegeler" created="Thu, 6 Jun 2013 12:31:32 +0000"  >&lt;p&gt;I think we can close this now&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12600525">SLING-2547</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>242910</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 24 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i030y7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>15587</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>