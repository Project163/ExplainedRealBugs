<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:38:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SLING-7447] Race condition in ThreadLocalCleaner initialization code</title>
                <link>https://issues.apache.org/jira/browse/SLING-7447</link>
                <project id="12310710" key="SLING">Sling</project>
                    <description>&lt;p&gt;There is a race condition in the &lt;tt&gt;ThreadLocalCleaner&lt;/tt&gt; initialization code that can lead to the fields not being fully initialized when read.&lt;/p&gt;

&lt;p&gt;The stack trace is similar to&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Exception in thread &quot;sling-oak-observation-2&quot; java.lang.NullPointerException
        at org.apache.sling.commons.threads.impl.ThreadLocalCleaner.copy(ThreadLocalCleaner.java:110)
        at org.apache.sling.commons.threads.impl.ThreadLocalCleaner.saveOldThreadLocals(ThreadLocalCleaner.java:230)
        at org.apache.sling.commons.threads.impl.ThreadLocalCleaner.&amp;lt;init&amp;gt;(ThreadLocalCleaner.java:155)
        at org.apache.sling.commons.threads.impl.ThreadPoolExecutorCleaningThreadLocals.beforeExecute(ThreadPoolExecutorCleaningThreadLocals.java:58)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1139)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
        at java.lang.Thread.run(Thread.java:748)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Assume that two threads, &lt;em&gt;T1&lt;/em&gt; and &lt;em&gt;T2&lt;/em&gt; enter the constructor at more or less the same time. The following events can then occur, leading to the above invalid access&lt;/p&gt;


&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;T1&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;T2&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;check threadLocalsField (is null)&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;invoke initReflectionFields, load threadLocalsField&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; check threadLocalsField (is not null) &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; invoke saveOldTreadLocals &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; invoke copy &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;At this point, the &lt;tt&gt;tableField&lt;/tt&gt; field is null since &lt;tt&gt;initReflectionFields&lt;/tt&gt; has not yet completed, which leads to the above NPE.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;edit&lt;/em&gt;: formatting&lt;/p&gt;</description>
                <environment></environment>
        <key id="13133854">SLING-7447</key>
            <summary>Race condition in ThreadLocalCleaner initialization code</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rombert">Robert Munteanu</assignee>
                                    <reporter username="rombert">Robert Munteanu</reporter>
                        <labels>
                    </labels>
                <created>Thu, 25 Jan 2018 21:51:22 +0000</created>
                <updated>Mon, 29 Jan 2018 09:04:30 +0000</updated>
                            <resolved>Thu, 25 Jan 2018 22:25:49 +0000</resolved>
                                                    <fixVersion>Commons Threads 3.2.16</fixVersion>
                                    <component>Commons</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16340203" author="rombert" created="Thu, 25 Jan 2018 22:25:49 +0000"  >&lt;p&gt;Fixed in &lt;a href=&quot;https://github.com/apache/sling-org-apache-sling-commons-threads/commit/c472954b67524042618b59bb0e45f180bcea146f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/sling-org-apache-sling-commons-threads/commit/c472954b67524042618b59bb0e45f180bcea146f&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16342113" author="kwin" created="Sat, 27 Jan 2018 12:22:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rombert&quot; class=&quot;user-hover&quot; rel=&quot;rombert&quot;&gt;rombert&lt;/a&gt; Thanks for finding and fixing this issue. &lt;br/&gt;
I am not sure about throwing exception from static initializers. We are not yet sure how well this is working for other JREs than OpenJDK/Oracle therefore it is unclear how often one might experience such an exception. Unfortunately you only get the real exception logged the first time you try to access this class but only a very generic NoClassDefFoundException afterwards (&lt;a href=&quot;https://bugs.openjdk.java.net/browse/JDK-8051847&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://bugs.openjdk.java.net/browse/JDK-8051847&lt;/a&gt;).&lt;br/&gt;
The other alternative is to catch it in the static initializer and store it in a field. In the constructor you can then check if that exception field is set and throw it then. That way you prevent those hard to debug {{NoClassDefFoundException}}s. WDYT?&lt;/p&gt;</comment>
                            <comment id="16343105" author="rombert" created="Mon, 29 Jan 2018 09:04:30 +0000"  >&lt;p&gt;Sure, we can do that as a follow-up fix.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13126255">SLING-7320</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 41 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3pdw7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>