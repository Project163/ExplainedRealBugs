<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:16:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[POOL-184] Premature starvation in GenericObjectPool when borrowObject() and evict() are executed concurrently</title>
                <link>https://issues.apache.org/jira/browse/POOL-184</link>
                <project id="12310488" key="POOL">Commons Pool</project>
                    <description>&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I am encountering a deadlock in GenericObjectPool. It appears in version 1.5.5 &lt;br/&gt;
and also in revision 1079385 (March 8th 2011).&lt;/p&gt;

&lt;p&gt;The deadlock manifests when calling borrowObject() and evict() in parallel. I &lt;br/&gt;
have inlined a test that exposes this problem. For this test, the expected &lt;br/&gt;
output is:&lt;/p&gt;

&lt;p&gt;Expected output:&lt;br/&gt;
0&lt;br/&gt;
1&lt;br/&gt;
2&lt;br/&gt;
3&lt;br/&gt;
4&lt;br/&gt;
.....&lt;br/&gt;
498&lt;br/&gt;
499&lt;br/&gt;
DONE&lt;/p&gt;


&lt;p&gt;But when the bug manifests (almost always for this test), the output is:&lt;/p&gt;

&lt;p&gt;Bug output:&lt;br/&gt;
0&lt;br/&gt;
1&lt;br/&gt;
2&lt;br/&gt;
3&lt;br/&gt;
4&lt;/p&gt;

&lt;p&gt;When the bug manifests, the test does not finish, it just gets stuck after&lt;br/&gt;
printing several values (in this run: 0 1 2 3 4, but in other runs may be&lt;br/&gt;
0 1 2 .. 18 or 0 1 2 or some other value).&lt;/p&gt;

&lt;p&gt;When the loop limit is small (e.g., 11 instead of 5000), the test does finish.&lt;/p&gt;

&lt;p&gt;Also, when running sequentially:&lt;/p&gt;

&lt;p&gt;    Pool.borrowObject();&lt;br/&gt;
    Pool.evict();&lt;/p&gt;

&lt;p&gt;or vice-versa&lt;/p&gt;

&lt;p&gt;    Pool.evict();&lt;br/&gt;
    Pool.borrowObject();&lt;/p&gt;

&lt;p&gt;the test still finishes. &lt;/p&gt;

&lt;p&gt;Is this a bug? Is there a patch for it?&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;

&lt;p&gt;Adrian&lt;/p&gt;


&lt;p&gt;================================================================================&lt;br/&gt;
This test is for version 1.5.5. For revision 1079385 one should replace &lt;br/&gt;
setMaxActive() with setMaxTotal()&lt;br/&gt;
================================================================================&lt;br/&gt;
package org.apache.commons.pool.impl;&lt;/p&gt;

&lt;p&gt;import org.apache.commons.pool.PoolableObjectFactory;&lt;/p&gt;

&lt;p&gt;public class Test01 &lt;br/&gt;
{&lt;br/&gt;
    public static void main(String[] args) throws Exception &lt;/p&gt;
    {
        Test01 test = new Test01();
        test.test();
    }

&lt;p&gt;    SimpleFactory Factory = null;&lt;br/&gt;
    GenericObjectPool Pool = null;&lt;br/&gt;
    Object Obj = null;&lt;br/&gt;
    public void test() throws Exception &lt;br/&gt;
    {&lt;br/&gt;
        Factory = new SimpleFactory();&lt;br/&gt;
        Pool = new GenericObjectPool(Factory);&lt;br/&gt;
        Pool.setMaxActive(1);&lt;br/&gt;
        Pool.addObject();&lt;/p&gt;

&lt;p&gt;        for(int i=0; i&amp;lt;5000; i++)&lt;br/&gt;
        {&lt;br/&gt;
            Thread one = new MyThread(1);&lt;br/&gt;
            Thread two = new MyThread(2);&lt;br/&gt;
            one.start();&lt;br/&gt;
            two.start();&lt;br/&gt;
            one.join();&lt;br/&gt;
            two.join();&lt;/p&gt;

&lt;p&gt;            Pool.returnObject(Obj);&lt;br/&gt;
            if(i%10==0)&lt;/p&gt;
            {
                System.out.println(i/10);
            }
&lt;p&gt;        }&lt;br/&gt;
        System.out.println(&quot;DONE&quot;);&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;    private class MyThread extends Thread &lt;br/&gt;
    {&lt;br/&gt;
        int _tid;&lt;br/&gt;
        public MyThread(int tid) &lt;/p&gt;
        {
            _tid = tid;
        }

&lt;p&gt;        public void run() &lt;br/&gt;
        {&lt;br/&gt;
            try &lt;br/&gt;
            {&lt;br/&gt;
                if(_tid == 1) &lt;/p&gt;
                {
                    Obj = Pool.borrowObject();
                }
&lt;p&gt;                if (_tid == 2) &lt;br/&gt;
                {&lt;br/&gt;
                    try&lt;br/&gt;
                    &lt;/p&gt;
{
                        Pool.evict();
                    }
&lt;p&gt; catch (Exception e) {}&lt;br/&gt;
                }&lt;br/&gt;
            } &lt;br/&gt;
            catch(Exception e) &lt;/p&gt;
            {
                throw new RuntimeException(e);
            }
&lt;p&gt;        }&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;    private class SimpleFactory implements PoolableObjectFactory&lt;br/&gt;
    {&lt;br/&gt;
        public SimpleFactory() {}&lt;br/&gt;
        public Object makeObject() &lt;/p&gt;
{ return new String(&quot;testing&quot;); }
&lt;p&gt;        public void destroyObject(Object obj) {}&lt;br/&gt;
        public boolean validateObject(Object obj) &lt;/p&gt;
{return true;}&lt;br/&gt;
        public void activateObject(Object obj) throws Exception {}&lt;br/&gt;
        public void passivateObject(Object obj) throws Exception {}&lt;br/&gt;
        public boolean isThrowExceptionOnActivate() {return true;}
&lt;p&gt;    }&lt;br/&gt;
}&lt;br/&gt;
================================================================================&lt;/p&gt;</description>
                <environment>&lt;p&gt;java 1.6.0_24&lt;br/&gt;
Ubuntu 10.10&lt;/p&gt;</environment>
        <key id="12500897">POOL-184</key>
            <summary>Premature starvation in GenericObjectPool when borrowObject() and evict() are executed concurrently</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="markt">Mark Thomas</assignee>
                                    <reporter username="adriannistor">Adrian Nistor</reporter>
                        <labels>
                    </labels>
                <created>Wed, 9 Mar 2011 14:51:25 +0000</created>
                <updated>Fri, 8 Apr 2011 13:53:46 +0000</updated>
                            <resolved>Wed, 23 Mar 2011 18:56:56 +0000</resolved>
                                    <version>1.5.5</version>
                                    <fixVersion>1.5.6</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13005085" author="psteitz" created="Thu, 10 Mar 2011 14:49:19 +0000"  >&lt;p&gt;Thanks for reporting this and thanks especially for providing a test case.  I am attaching a thread dump during a stalled execution.&lt;/p&gt;

&lt;p&gt;I think what is going on here is not deadlock, but inappropriate starvation.  With maxActive set to 1 (or whenever maxActive is about to be attained by a borrowObject with one idle instance in the pool), if one thread does a borrow while the evictor is visiting the idle instance, the borrowing thread will stall until another thread does a borrow or return.  When there is only one active thread, this will never happen, so the test program stalls.&lt;/p&gt;

&lt;p&gt;If my analysis is correct, this is a bug, which is caused by the fact that evict() temporarily removes idle instances being examined, but does not call allocate() when it returns them.  The stall here happens when the borrowing thread makes its request when evict is examining the idle instance.  It never gets notified when the instance is returned to the pool. &lt;/p&gt;

&lt;p&gt;A simple fix is to insert an allocate() at the end of evict().  We need to verify though that this will not cause any other problems.&lt;/p&gt;</comment>
                            <comment id="13005088" author="psteitz" created="Thu, 10 Mar 2011 14:51:19 +0000"  >&lt;p&gt;Thread dump during stalled execution of TestO1.java&lt;/p&gt;</comment>
                            <comment id="13010290" author="markt" created="Wed, 23 Mar 2011 18:56:56 +0000"  >&lt;p&gt;As long as the call to allocate() is outside a sync block, you can add as many as you like with the only impact being performance. Inside sync blocks you need to be very careful.&lt;/p&gt;

&lt;p&gt;This is fixed in 1.5.x and trunk.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12473133" name="Test01.java" size="2400" author="adriannistor" created="Wed, 9 Mar 2011 14:58:06 +0000"/>
                            <attachment id="12473270" name="stall.txt" size="4421" author="psteitz" created="Thu, 10 Mar 2011 14:51:19 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>166742</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 35 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0zfmv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>204835</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>