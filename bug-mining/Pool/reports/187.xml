<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:17:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[POOL-418] The maximum wait time for GenericObjectPool.borrowObject(*) may exceed expectations due to a spurious thread wakeup</title>
                <link>https://issues.apache.org/jira/browse/POOL-418</link>
                <project id="12310488" key="POOL">Commons Pool</project>
                    <description>&lt;p&gt;I found an issue when using jedis to operate Redis database, Here is the issue link -&amp;gt; &lt;a href=&quot;https://github.com/redis/jedis/issues/4014&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/redis/jedis/issues/4014&lt;/a&gt;. we feel that it&apos;s a problem with the Commons pool.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In situations where the connection is tight, the waiting time can be up to twice the maxWaitMillis consumption.&lt;/p&gt;

&lt;p&gt;code: org.apache.commons.pool2.impl.GenericObjectPool#borrowObject(long) -&amp;gt; org.apache.commons.pool2.impl.GenericObjectPool#create&lt;/p&gt;

&lt;p&gt;The thread that failed to create the connection will wake up the thread that is waiting to be created. Threads that do not compete for resources will wait again, and the waiting time will still be the maxWaitMillis.&lt;/p&gt;

&lt;p&gt;If the first waiting time is ( maxWaitMillis - 1ms), plus the second full waiting time, then the full waiting time will be twice the expected time.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The waiting time we hope for this time is the total waiting time minus the time already waited.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;such as: Duration remainingWait = localMaxWaitDuration.minus(Duration.between(localStartInstant, Instant.now()));&lt;/p&gt;

&lt;p&gt;if (remainingWait.isNegative()) &lt;/p&gt;
{

create = Boolean.FALSE;

}
&lt;p&gt; else &lt;/p&gt;
{

wait(makeObjectCountLock, remainingWait);

}

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We are not sure if this issue has been addressed and look forward to your reply.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13599626">POOL-418</key>
            <summary>The maximum wait time for GenericObjectPool.borrowObject(*) may exceed expectations due to a spurious thread wakeup</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ggregory">Gary D. Gregory</assignee>
                                    <reporter username="sunshuai">SunShuai</reporter>
                        <labels>
                    </labels>
                <created>Fri, 22 Nov 2024 02:55:29 +0000</created>
                <updated>Sun, 27 Apr 2025 23:10:04 +0000</updated>
                            <resolved>Sat, 8 Feb 2025 16:00:10 +0000</resolved>
                                                    <fixVersion>2.12.1</fixVersion>
                    <fixVersion>2.12.2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17900546" author="garydgregory" created="Sat, 23 Nov 2024 02:46:51 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sunshuai&quot; class=&quot;user-hover&quot; rel=&quot;sunshuai&quot;&gt;sunshuai&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;What version of POOL are you using?&lt;/p&gt;

&lt;p&gt;The ticket shows 2.9.0, which is old, the current version is 2.12.0. If there is a change to be made, it would be in 2.12.1.&lt;/p&gt;</comment>
                            <comment id="17900659" author="JIRAUSER307788" created="Sun, 24 Nov 2024 02:47:58 +0000"  >&lt;p&gt;hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I am currently using version 2.9.0, but the source code in my attachment is version 2.12.0.&lt;/p&gt;

&lt;p&gt;The latest version also has this issue&lt;/p&gt;</comment>
                            <comment id="17900720" author="garydgregory" created="Sun, 24 Nov 2024 17:52:08 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sunshuai&quot; class=&quot;user-hover&quot; rel=&quot;sunshuai&quot;&gt;sunshuai&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I see the issue. I&apos;m working on a fix.&lt;/p&gt;</comment>
                            <comment id="17900744" author="garydgregory" created="Sun, 24 Nov 2024 23:20:08 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sunshuai&quot; class=&quot;user-hover&quot; rel=&quot;sunshuai&quot;&gt;sunshuai&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This is fixed in git master.&lt;/p&gt;

&lt;p&gt;Please build from git master or pick up a snapshot build from &lt;a href=&quot;https://repository.apache.org/content/repositories/snapshots/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/repositories/snapshots/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17901728" author="JIRAUSER307788" created="Thu, 28 Nov 2024 13:50:32 +0000"  >&lt;p&gt;hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;If blockWhenExhausted is enabled, the waiting time in the blocking queue will be maxWaitMillis.&lt;/p&gt;

&lt;p&gt;Should the actual waiting time be calculated here?&#160;&lt;/p&gt;

&lt;p&gt;We found that the maximum wait time after repair may be &#160;maxWaitMillis * 2 or &#160;maxWaitMillis + connectionTimeout&lt;/p&gt;</comment>
                            <comment id="17901756" author="garydgregory" created="Thu, 28 Nov 2024 16:06:23 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sunshuai&quot; class=&quot;user-hover&quot; rel=&quot;sunshuai&quot;&gt;sunshuai&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I don&apos;t think so. See &lt;a href=&quot;https://github.com/apache/commons-pool/blob/4edc3dc20f867014bdac7436f2ff530e11dfdc19/src/main/java/org/apache/commons/pool2/impl/GenericObjectPool.java#L307&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-pool/blob/4edc3dc20f867014bdac7436f2ff530e11dfdc19/src/main/java/org/apache/commons/pool2/impl/GenericObjectPool.java#L307&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
p = negativeDuration ? idleObjects.takeFirst() : idleObjects.pollFirst(remainingWaitDuration);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Or am I missing something?&lt;/p&gt;</comment>
                            <comment id="17901828" author="JIRAUSER307788" created="Fri, 29 Nov 2024 02:23:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt; Thanks for your reply&lt;/p&gt;

&lt;p&gt;The documentation for the &lt;tt&gt;borrowObject&lt;/tt&gt; method states:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&quot;The length of time that this method will block when &lt;tt&gt;getBlockWhenExhausted()&lt;/tt&gt; is true is determined by the value passed into the &lt;tt&gt;borrowMaxWaitMillis&lt;/tt&gt; parameter.&quot;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;However, based on current behavior, if the &lt;tt&gt;create&lt;/tt&gt; method has already waited for &lt;b&gt;&lt;tt&gt;maxWaitMillis&lt;/tt&gt;&lt;/b&gt; without successfully creating a connection, it will then enter the blocking queue and wait for another &lt;b&gt;full &lt;tt&gt;maxWaitMillis&lt;/tt&gt;&lt;/b&gt;. This means the maximum wait time for this interface could reach &lt;b&gt;twice the value of &lt;tt&gt;maxWaitMillis&lt;/tt&gt;&lt;/b&gt;.&lt;/p&gt;

&lt;p&gt;My question is: When the &lt;tt&gt;blockWhenExhausted&lt;/tt&gt; parameter is enabled, should the remaining wait time be recalculated to ensure consistency with the documentation?&lt;/p&gt;</comment>
                            <comment id="17901935" author="garydgregory" created="Fri, 29 Nov 2024 13:36:04 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sunshuai&quot; class=&quot;user-hover&quot; rel=&quot;sunshuai&quot;&gt;sunshuai&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Where do you see this behavior in &lt;a href=&quot;https://github.com/apache/commons-pool/blob/1c0095548ff8810f8ef6a9dabebfd57cf1a1b9b2/src/main/java/org/apache/commons/pool2/impl/GenericObjectPool.java#L281&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;GenericObjectPool&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17902153" author="JIRAUSER307788" created="Mon, 2 Dec 2024 02:13:14 +0000"  >&lt;p&gt;hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;When there are no available objects in the connection pool, the current thread enters the &lt;tt&gt;create&lt;/tt&gt; method to &lt;a href=&quot;https://github.com/apache/commons-pool/blob/1c0095548ff8810f8ef6a9dabebfd57cf1a1b9b2/src/main/java/org/apache/commons/pool2/impl/GenericObjectPool.java#L300&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;create a connection &lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If the maximum number of connections has already been reached and other threads are creating connections, &lt;a href=&quot;https://github.com/apache/commons-pool/blob/1c0095548ff8810f8ef6a9dabebfd57cf1a1b9b2/src/main/java/org/apache/commons/pool2/impl/GenericObjectPool.java#L537&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the current thread will wait for a duration specified by {{maxWaitMillis }}&lt;/a&gt;. If the wait ends and the maximum connection limit is still reached, the &lt;tt&gt;create&lt;/tt&gt; method &lt;a href=&quot;https://github.com/apache/commons-pool/blob/1c0095548ff8810f8ef6a9dabebfd57cf1a1b9b2/src/main/java/org/apache/commons/pool2/impl/GenericObjectPool.java#L553&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;will return null &lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;If &lt;tt&gt;blockWhenExhausted&lt;/tt&gt; is enabled, &lt;a href=&quot;https://github.com/apache/commons-pool/blob/1c0095548ff8810f8ef6a9dabebfd57cf1a1b9b2/src/main/java/org/apache/commons/pool2/impl/GenericObjectPool.java#L307&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the current thread will block and wait in the queue&lt;/a&gt;, with the wait time also determined by &lt;tt&gt;maxWaitMillis&lt;/tt&gt;.&#160;&lt;/p&gt;

&lt;p&gt;Looking at the entire process, the total wait time will be &lt;tt&gt;createWait + pollFirstWait = 2 * maxWaitMillis&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Do you think it&#8217;s necessary to calculate the remaining wait time during the second wait?&lt;/p&gt;</comment>
                            <comment id="17903162" author="JIRAUSER307788" created="Thu, 5 Dec 2024 02:14:40 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Just checking in to see if you had a chance to review my previous comment. Let me know if you need any additional details from me.&lt;/p&gt;</comment>
                            <comment id="17924260" author="garydgregory" created="Wed, 5 Feb 2025 20:50:35 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sunshuai&quot; class=&quot;user-hover&quot; rel=&quot;sunshuai&quot;&gt;sunshuai&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Please accept my apologies for the delay in replying to your question.&lt;/p&gt;

&lt;p&gt;We should try to follow the duration limit as closely as possible. Do you think we should recompute the duration, as in:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
diff --git a/src/main/java/org/apache/commons/pool2/impl/GenericObjectPool.java b/src/main/java/org/apache/commons/pool2/impl/GenericObjectPool.java
index 023b552..f81271f 100644
--- a/src/main/java/org/apache/commons/pool2/impl/GenericObjectPool.java
+++ b/src/main/java/org/apache/commons/pool2/impl/GenericObjectPool.java
@@ -246,8 +246,8 @@
      * &amp;lt;p&amp;gt;
      * If there are no idle instances available in the pool, behavior depends on
      * the {@link #getMaxTotal() maxTotal}, (&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; applicable)
-     * {@link #getBlockWhenExhausted()} and the value passed in to the
-     * {@code borrowMaxWaitMillis} parameter. If the number of instances
+     * {@link #getBlockWhenExhausted()} and the value passed in the
+     * {@code maxWaitDuration} parameter. If the number of instances
      * checked out from the pool is less than {@code maxTotal,} a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;
      * instance is created, activated and (&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; applicable) validated and returned
      * to the caller. If validation fails, a {@code NoSuchElementException}
@@ -261,7 +261,7 @@
      * {@code NoSuchElementException} (&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;
      * {@link #getBlockWhenExhausted()} is &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;). The length of time that &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;
      * method will block when {@link #getBlockWhenExhausted()} is &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; is
-     * determined by the value passed in to the {@code borrowMaxWaitMillis}
+     * determined by the value passed in to the {@code maxWaitDuration}
      * parameter.
      * &amp;lt;/p&amp;gt;
      * &amp;lt;p&amp;gt;
@@ -271,17 +271,17 @@
      * available instances in request arrival order.
      * &amp;lt;/p&amp;gt;
      *
-     * @param borrowMaxWaitDuration The time to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; an object to become available, not &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;.
+     * @param maxWaitDuration The time to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; an object to become available, not &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;.
      * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; object instance from the pool
      * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; NoSuchElementException &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; an instance cannot be returned
      * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; an object instance cannot be returned due to an error
      * @since 2.10.0
      */
-    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; T borrowObject(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Duration borrowMaxWaitDuration) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
+    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; T borrowObject(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Duration maxWaitDuration) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
         assertOpen();
         &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Instant startInstant = Instant.now();
-        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; negativeDuration = borrowMaxWaitDuration.isNegative();
-        Duration remainingWaitDuration = borrowMaxWaitDuration;
+        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; negativeDuration = maxWaitDuration.isNegative();
+        Duration remainingWaitDuration = maxWaitDuration;
         &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; AbandonedConfig ac = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.abandonedConfig;
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ac != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; ac.getRemoveAbandonedOnBorrow() &amp;amp;&amp;amp; getNumIdle() &amp;lt; 2 &amp;amp;&amp;amp; getNumActive() &amp;gt; getMaxTotal() - 3) {
             removeAbandoned(ac);
@@ -292,7 +292,7 @@
         &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; blockWhenExhausted = getBlockWhenExhausted();
         &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; create;
         &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (p == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
-            remainingWaitDuration = remainingWaitDuration.minus(durationSince(startInstant));
+            remainingWaitDuration = maxWaitDuration.minus(durationSince(startInstant));
             create = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
             p = idleObjects.pollFirst();
             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (p == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
@@ -303,11 +303,12 @@
             }
             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (blockWhenExhausted) {
                 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (PooledObject.isNull(p)) {
+                    remainingWaitDuration = maxWaitDuration.minus(durationSince(startInstant));
                     p = negativeDuration ? idleObjects.takeFirst() : idleObjects.pollFirst(remainingWaitDuration);
                 }
                 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (PooledObject.isNull(p)) {
                     &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NoSuchElementException(appendStats(
-                            &lt;span class=&quot;code-quote&quot;&gt;&quot;Timeout waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; idle object, borrowMaxWaitDuration=&quot;&lt;/span&gt; + remainingWaitDuration));
+                            &lt;span class=&quot;code-quote&quot;&gt;&quot;Timeout waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; idle object, maxWaitDuration=&quot;&lt;/span&gt; + remainingWaitDuration));
                 }
             } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (PooledObject.isNull(p)) {
                 &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NoSuchElementException(appendStats(&lt;span class=&quot;code-quote&quot;&gt;&quot;Pool exhausted&quot;&lt;/span&gt;));
@@ -379,7 +380,7 @@
      * If there are no idle instances available in the pool, behavior depends on
      * the {@link #getMaxTotal() maxTotal}, (&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; applicable)
      * {@link #getBlockWhenExhausted()} and the value passed in to the
-     * {@code borrowMaxWaitMillis} parameter. If the number of instances
+     * {@code maxWaitMillis} parameter. If the number of instances
      * checked out from the pool is less than {@code maxTotal,} a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;
      * instance is created, activated and (&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; applicable) validated and returned
      * to the caller. If validation fails, a {@code NoSuchElementException}
@@ -393,7 +394,7 @@
      * {@code NoSuchElementException} (&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;
      * {@link #getBlockWhenExhausted()} is &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;). The length of time that &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;
      * method will block when {@link #getBlockWhenExhausted()} is &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; is
-     * determined by the value passed in to the {@code borrowMaxWaitMillis}
+     * determined by the value passed in to the {@code maxWaitMillis}
      * parameter.
      * &amp;lt;/p&amp;gt;
      * &amp;lt;p&amp;gt;
@@ -403,15 +404,15 @@
      * available instances in request arrival order.
      * &amp;lt;/p&amp;gt;
      *
-     * @param borrowMaxWaitMillis The time to wait in milliseconds &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; an object
+     * @param maxWaitMillis The time to wait in milliseconds &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; an object
      *                            to become available
      * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; object instance from the pool
      * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; NoSuchElementException &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; an instance cannot be returned
      * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; an object instance cannot be returned due to an
      *                   error
      */
-    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; T borrowObject(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; borrowMaxWaitMillis) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
-        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; borrowObject(Duration.ofMillis(borrowMaxWaitMillis));
+    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; T borrowObject(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; maxWaitMillis) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
+        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; borrowObject(Duration.ofMillis(maxWaitMillis));
     }
 
     /**
@@ -512,7 +513,7 @@
         &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt; create = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
         &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (create == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
             &lt;span class=&quot;code-comment&quot;&gt;// remainingWaitDuration handles spurious wakeup from wait().
&lt;/span&gt;-            remainingWaitDuration = remainingWaitDuration.minus(durationSince(startInstant));
+            remainingWaitDuration = maxWaitDuration.minus(durationSince(startInstant));
             &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (makeObjectCountLock) {
                 &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; newCreateCount = createCount.incrementAndGet();
                 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (newCreateCount &amp;gt; localMaxTotal) {

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I think the &lt;tt&gt;remainingWaitDuration&lt;/tt&gt; computation was wrong!&lt;/p&gt;

&lt;p&gt;WDYT?&lt;/p&gt;
</comment>
                            <comment id="17924818" author="JIRAUSER307788" created="Fri, 7 Feb 2025 09:02:36 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;I think it should be changed like this. Today I was testing version 2.12.1, and I found this issue quite obvious. The following image can prove this point. I set the maxWaitMillis to 120ms, but the total time was 240ms, with both create and pollFirst taking 120ms each.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13074555/13074555_Snipaste_2025-02-07_17-05-08.png&quot; height=&quot;150&quot; width=&quot;589&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Here&apos;s a suggestion: Before executing pollFirst, check the value of remainingWaitDuration. If it&apos;s negative, there&apos;s no need to execute pollFirst, which can save one lock operation inside pollFirst.&lt;/p&gt;

&lt;p&gt;Something like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
p = negativeDuration || remainingWaitDuration.isNegative() ? idleObjects.takeFirst() : idleObjects.pollFirst(maxWaitDuration);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17925296" author="garydgregory" created="Sat, 8 Feb 2025 15:57:21 +0000"  >&lt;p&gt;Reopening to revisit since duration computation can be improved.&lt;/p&gt;</comment>
                            <comment id="17925305" author="garydgregory" created="Sat, 8 Feb 2025 17:18:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sunshuai&quot; class=&quot;user-hover&quot; rel=&quot;sunshuai&quot;&gt;sunshuai&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;I pushed to git master with improvement, you can also use a 2.12.2-SNAPSHOT build from &lt;a href=&quot;https://repository.apache.org/content/repositories/snapshots/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/repositories/snapshots/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Please try your suggestion in the code and you&apos;ll see some failing tests: The suggestion causes the timeout to be ignored and the pool waits until an entry is available, which is the opposite of the desired behavior. You should generally try ideas in code and PR.&lt;/p&gt;

&lt;p&gt;TY!&lt;/p&gt;</comment>
                            <comment id="17925481" author="JIRAUSER307788" created="Mon, 10 Feb 2025 05:56:09 +0000"  >&lt;p&gt;hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt; &#160;Thank you for the reminder.&lt;/p&gt;

&lt;p&gt;I submitted a PR:&#160; &lt;a href=&quot;https://github.com/apache/commons-pool/pull/388&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-pool/pull/388&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10020">
                    <name>Cloners</name>
                                                                <inwardlinks description="is cloned by">
                                        <issuelink>
            <issuekey id="13616513">POOL-420</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13073005" name="74C00A2F-EE3A-4660-BE58-66CA37F9808A.png" size="962766" author="sunshuai" created="Fri, 22 Nov 2024 02:55:15 +0000"/>
                            <attachment id="13073004" name="EE4BD798-26B6-4AE1-B114-5AC7342B31A6.png" size="1016569" author="sunshuai" created="Fri, 22 Nov 2024 02:55:23 +0000"/>
                            <attachment id="13074555" name="Snipaste_2025-02-07_17-05-08.png" size="1125389" author="sunshuai" created="Fri, 7 Feb 2025 09:05:31 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311020" key="com.atlassian.jira.plugin.system.customfieldtypes:url">
                        <customfieldname>External issue URL</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[https://github.com/redis/jedis/issues/4014]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            38 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1spc0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>