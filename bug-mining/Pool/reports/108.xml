<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:16:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[POOL-276] Validation code invoked on unexpected timing.</title>
                <link>https://issues.apache.org/jira/browse/POOL-276</link>
                <project id="12310488" key="POOL">Commons Pool</project>
                    <description>&lt;p&gt;I found BasePooledObjectFactory.validateObject() of commons-pool sometimes called on unexpected timing.&lt;/p&gt;

&lt;p&gt;I&apos;ve configured the pool so as to the validateObject() would be invoked only on instance creation, but sometimes it was invoked for &quot;non-fresh&quot; instance on borrowing.&lt;/p&gt;

&lt;p&gt;Reproduction code below.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.io.*;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.*;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.commons.pool2.*;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.commons.pool2.impl.*;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;reproduction
{
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MyPooledObj
    {
        &lt;span class=&quot;code-keyword&quot;&gt;volatile&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0;
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; uuid = UUID.randomUUID().toString();
    }

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MyFactory &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; BasePooledObjectFactory&amp;lt;MyPooledObj&amp;gt;
    {
        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; MyPooledObj create() {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MyPooledObj();
        }

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; PooledObject&amp;lt;MyPooledObj&amp;gt; wrap(MyPooledObj o) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DefaultPooledObject&amp;lt;MyPooledObj&amp;gt;(o);
        }

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; validateObject(PooledObject&amp;lt;MyPooledObj&amp;gt; o) {
            MyPooledObj myobj = o.getObject();
            &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (myobj) {
                myobj.i++;
            }
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Validated.&quot;&lt;/span&gt;);
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
        }
    }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args)
        &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception
    {
        GenericObjectPoolConfig poolCfg = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GenericObjectPoolConfig() ;
        poolCfg.setMaxTotal(1);
        poolCfg.setMaxIdle(1);
        poolCfg.setBlockWhenExhausted(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
        poolCfg.setMaxWaitMillis(10000);

        poolCfg.setTestOnCreate(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;); &lt;span class=&quot;code-comment&quot;&gt;// should be validated only on creation
&lt;/span&gt;        poolCfg.setTestOnBorrow(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
        poolCfg.setTestOnReturn(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
        poolCfg.setTestWhileIdle(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);

        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; GenericObjectPool&amp;lt;MyPooledObj&amp;gt; pool =
            &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GenericObjectPool&amp;lt;MyPooledObj&amp;gt;(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MyFactory(), poolCfg);

        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; MyPooledObj o = pool.borrowObject();
        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.printf(&lt;span class=&quot;code-quote&quot;&gt;&quot;%d: %s\n&quot;&lt;/span&gt;, o.i, o.uuid);

        Timer t = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Timer();
        t.schedule
            (&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TimerTask() {
                    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
                        pool.returnObject(o);
                    }
                }, 3000);

        &lt;span class=&quot;code-comment&quot;&gt;// validation will occur again &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; non-fresh instance,
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// confirmed on commons-pool2-2.2 with jdk1.7.0_55
&lt;/span&gt;        MyPooledObj o2 = pool.borrowObject();
        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.printf(&lt;span class=&quot;code-quote&quot;&gt;&quot;%d: %s\n&quot;&lt;/span&gt;, o2.i, o2.uuid);
        pool.returnObject(o2);
        pool.close();

        t.cancel();
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;jdk1.7.0_55 on CentOS6&lt;/p&gt;</environment>
        <key id="12739004">POOL-276</key>
            <summary>Validation code invoked on unexpected timing.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="nori">Noriyuki Torii</reporter>
                        <labels>
                    </labels>
                <created>Thu, 4 Sep 2014 03:13:29 +0000</created>
                <updated>Wed, 31 Dec 2014 16:21:19 +0000</updated>
                            <resolved>Thu, 4 Sep 2014 09:04:31 +0000</resolved>
                                    <version>2.2</version>
                                    <fixVersion>2.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="14120952" author="b.eckenfels" created="Thu, 4 Sep 2014 04:46:27 +0000"  >&lt;p&gt;The sequence is:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;1409804599167 main                    Created 0 379cbef5-3e40-4f39-af5f-ac3e76506e81
1409804599229 main                    Wrapped 0 379cbef5-3e40-4f39-af5f-ac3e76506e81
1409804599229 main                  Validated 1 379cbef5-3e40-4f39-af5f-ac3e76506e81
1409804599229 main                   Borrowed 1 379cbef5-3e40-4f39-af5f-ac3e76506e81
1409804602256 Timer-0               Returning 1 379cbef5-3e40-4f39-af5f-ac3e76506e81
1409804602256 main                  Validated 2 379cbef5-3e40-4f39-af5f-ac3e76506e81
1409804602256 main             Borrowed Again 2 379cbef5-3e40-4f39-af5f-ac3e76506e81
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Discussion on &lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/commons-user/201409.mbox/%3CCADQ45ZFFpUuW0qBtUi0OwbuZ9ePfGtCp2eKcEYxskRn6QAM8%2Bg%40mail.gmail.com%3E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;commons-user&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14121098" author="markt" created="Thu, 4 Sep 2014 08:22:15 +0000"  >&lt;p&gt;Nice find. I see the bug and the fix looks simple. I&apos;ll turn the code above into a unit test and then commit that and the fix. I also want to look to see if GKOP is affected by the same bug.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 11 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1znuv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>