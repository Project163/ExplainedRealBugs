<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:17:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[POOL-326] Threading issue, NullPointerException and IllegalStateException in GenericKeyedObjectPool</title>
                <link>https://issues.apache.org/jira/browse/POOL-326</link>
                <project id="12310488" key="POOL">Commons Pool</project>
                    <description>&lt;p&gt;I&apos;ll included a test to help reproduce this issue.  Take a look at the embedded comments as it&apos;s extremely difficult to reproduce.  I&apos;ve seen the provided test show the failure on more than one PC so I believe it will show the problem.&lt;/p&gt;

&lt;p&gt;Example stack trace for error on return:&lt;br/&gt;
java.util.concurrent.ExecutionException: java.lang.NullPointerException&lt;br/&gt;
	at java.util.concurrent.FutureTask.report(FutureTask.java:122)&lt;br/&gt;
	at java.util.concurrent.FutureTask.get(FutureTask.java:192)&lt;br/&gt;
	at threading_pool.ObjectPoolIssue.run(ObjectPoolIssue.java:63)&lt;br/&gt;
	at threading_pool.ObjectPoolIssue.main(ObjectPoolIssue.java:23)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:498)&lt;br/&gt;
	at com.intellij.rt.execution.application.AppMain.main(AppMain.java:147)&lt;br/&gt;
Caused by: java.lang.NullPointerException&lt;br/&gt;
	at org.apache.commons.pool2.impl.GenericKeyedObjectPool.returnObject(GenericKeyedObjectPool.java:474)&lt;br/&gt;
	at threading_pool.ObjectPoolIssue$Task.call(ObjectPoolIssue.java:112)&lt;br/&gt;
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:745)&lt;/p&gt;

&lt;p&gt;Example stack trace for error on borrow:&lt;br/&gt;
java.util.concurrent.ExecutionException: java.lang.NullPointerException&lt;br/&gt;
	at java.util.concurrent.FutureTask.report(FutureTask.java:122)&lt;br/&gt;
	at java.util.concurrent.FutureTask.get(FutureTask.java:192)&lt;br/&gt;
	at threading_pool.ObjectPoolIssue.run(ObjectPoolIssue.java:63)&lt;br/&gt;
	at threading_pool.ObjectPoolIssue.main(ObjectPoolIssue.java:23)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:498)&lt;br/&gt;
	at com.intellij.rt.execution.application.AppMain.main(AppMain.java:147)&lt;br/&gt;
Caused by: java.lang.NullPointerException&lt;br/&gt;
	at org.apache.commons.pool2.impl.GenericKeyedObjectPool.deregister(GenericKeyedObjectPool.java:1146)&lt;br/&gt;
	at org.apache.commons.pool2.impl.GenericKeyedObjectPool.borrowObject(GenericKeyedObjectPool.java:438)&lt;br/&gt;
	at org.apache.commons.pool2.impl.GenericKeyedObjectPool.borrowObject(GenericKeyedObjectPool.java:279)&lt;br/&gt;
	at threading_pool.ObjectPoolIssue$Task.call(ObjectPoolIssue.java:108)&lt;br/&gt;
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:745)&lt;/p&gt;</description>
                <environment></environment>
        <key id="13071573">POOL-326</key>
            <summary>Threading issue, NullPointerException and IllegalStateException in GenericKeyedObjectPool</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="csallison">Chris Allison</reporter>
                        <labels>
                    </labels>
                <created>Fri, 12 May 2017 15:48:30 +0000</created>
                <updated>Sat, 5 Oct 2019 01:01:15 +0000</updated>
                            <resolved>Sat, 5 Oct 2019 01:01:15 +0000</resolved>
                                    <version>2.4.2</version>
                                    <fixVersion>2.6.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16009709" author="sebb@apache.org" created="Sun, 14 May 2017 12:23:30 +0000"  >&lt;p&gt;The stack trace line entry:&lt;/p&gt;

&lt;p&gt;threading_pool.ObjectPoolIssue$Task.call(ObjectPoolIssue.java:105)&lt;/p&gt;

&lt;p&gt;does not appear to relate to the attached source file.&lt;/p&gt;</comment>
                            <comment id="16025164" author="csallison" created="Thu, 25 May 2017 18:26:06 +0000"  >&lt;p&gt;My apologies, I uploaded a version with an external lock that I was testing to work around this issue.  I&apos;ve uploaded the correct version that produces the NPE.  I also updated the example stack traces with values from this source so that the line numbers are correct.  I added stack traces for both the borrow and return operations, although I typically see the problem on the borrow operation.&lt;/p&gt;</comment>
                            <comment id="16027106" author="garydgregory" created="Sat, 27 May 2017 01:27:10 +0000"  >&lt;p&gt;Here is what I get when I tried twice:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.util.concurrent.ExecutionException: java.lang.IllegalStateException: Returned object not currently part of this pool
Time: 38.876
	at java.util.concurrent.FutureTask.report(FutureTask.java:122)
	at java.util.concurrent.FutureTask.get(FutureTask.java:188)
	at org.apache.commons.pool2.ObjectPoolIssue.run(ObjectPoolIssue.java:62)
	at org.apache.commons.pool2.ObjectPoolIssue.main(ObjectPoolIssue.java:22)
Caused by: java.lang.IllegalStateException: Returned object not currently part of this pool
	at org.apache.commons.pool2.impl.GenericKeyedObjectPool.returnObject(GenericKeyedObjectPool.java:471)
	at org.apache.commons.pool2.ObjectPoolIssue$Task.call(ObjectPoolIssue.java:111)
	at java.util.concurrent.FutureTask.run(FutureTask.java:262)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Time: 75.327
java.util.concurrent.ExecutionException: java.lang.NullPointerException
	at java.util.concurrent.FutureTask.report(FutureTask.java:122)
	at java.util.concurrent.FutureTask.get(FutureTask.java:188)
	at org.apache.commons.pool2.ObjectPoolIssue.run(ObjectPoolIssue.java:62)
	at org.apache.commons.pool2.ObjectPoolIssue.main(ObjectPoolIssue.java:22)
Caused by: java.lang.NullPointerException
	at org.apache.commons.pool2.impl.GenericKeyedObjectPool.deregister(GenericKeyedObjectPool.java:1175)
	at org.apache.commons.pool2.impl.GenericKeyedObjectPool.borrowObject(GenericKeyedObjectPool.java:432)
	at org.apache.commons.pool2.impl.GenericKeyedObjectPool.borrowObject(GenericKeyedObjectPool.java:283)
	at org.apache.commons.pool2.ObjectPoolIssue$Task.call(ObjectPoolIssue.java:107)
	at java.util.concurrent.FutureTask.run(FutureTask.java:262)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16027856" author="psteitz" created="Sun, 28 May 2017 16:27:46 +0000"  >&lt;p&gt;Nice job on the test case and bug report, Chris!&lt;/p&gt;

&lt;p&gt;Looks like you are using git head, right, Gary?  I have also verified that the problem exists with both the 2.4.2 release jar and git head as of fc68e1ba783b49df82e27fc88f4cb8819aa0b0c0.&lt;/p&gt;

&lt;p&gt;I am not sure, but I suspect at least the borrowObject NPE might be caused by the following scenario (line numbers from git head)&lt;/p&gt;

&lt;p&gt;1. Thread 1 enters deregister and the conditions are met so it progresses to line 1178 where it waits for a write lock.&lt;br/&gt;
2. Thread 2 enters deregister and decrements numInterested, now to -1.&lt;br/&gt;
3. Thread 3 (a borrower) enters and exits register, but numInterested just gets incremented back to 0.&lt;br/&gt;
4. Thread 1 completes (second test succeeding), killing the deque.&lt;br/&gt;
5. Thread 3 enters deregister and gets NPE&lt;/p&gt;

&lt;p&gt;I added some instrumentation to the test code and it looks like the npe on borrow-deregister is occurring when the pool is out of capacity and numActive and numIdle for the key under which the borrow request is made are both 0.  Strictly speaking, you can&apos;t really tell from instrumentation because between the exception and the catch other threads could be changing those stats.  I get the same thing repeatedly, though.&lt;/p&gt;

&lt;p&gt;When I modify deregister to work like register does - immediately acquire a read lock and then escalate if needed to a write lock - the test code does not raise NPEs or ISEs.  Attached is a patch with that change.  It should be carefully reviewed and performance-tested before being applied.  I doubt the performance hit would be measurable, but it is adding some lock contention.&lt;/p&gt;</comment>
                            <comment id="16491738" author="garydgregory" created="Sat, 26 May 2018 17:09:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=psteitz&quot; class=&quot;user-hover&quot; rel=&quot;psteitz&quot;&gt;psteitz&lt;/a&gt;,&#160;I should have noted what I used... I am &lt;em&gt;guessing&lt;/em&gt; git master...&lt;/p&gt;</comment>
                            <comment id="16666377" author="struberg" created="Sun, 28 Oct 2018 11:59:27 +0000"  >&lt;p&gt;push&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=psteitz&quot; class=&quot;user-hover&quot; rel=&quot;psteitz&quot;&gt;psteitz&lt;/a&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=garydgregory&quot; class=&quot;user-hover&quot; rel=&quot;garydgregory&quot;&gt;garydgregory&lt;/a&gt; how to progress with this ticket?&lt;/p&gt;</comment>
                            <comment id="16666418" author="garydgregory" created="Sun, 28 Oct 2018 14:37:58 +0000"  >&lt;p&gt;No progress from me. Perhaps &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=psteitz&quot; class=&quot;user-hover&quot; rel=&quot;psteitz&quot;&gt;psteitz&lt;/a&gt; knows more?&lt;/p&gt;</comment>
                            <comment id="16763788" author="garydgregory" created="Fri, 8 Feb 2019 17:51:02 +0000"  >&lt;p&gt;Committed patch. I did not see any adverse effect from large grain testing using &apos;mvn test&apos;. The &apos;test&apos; goal with the patch took 5:31 for me and 5:34 without the patch. The difference seems like random noise. Granted there is no test to measure the performance difference specifically for this change.&lt;/p&gt;</comment>
                            <comment id="16915347" author="psteitz" created="Sun, 25 Aug 2019 20:50:45 +0000"  >&lt;p&gt;I don&apos;t think we fully fixed this problem.&lt;/p&gt;

&lt;p&gt;I am now getting sporadic NPEs in returnObject when running soak tests with the following config:&lt;/p&gt;

&lt;p&gt;maxTotal = 50,&#160;maxIdlePerKey=10,&#160;minIdlePerKey=5,&#160;maxTotalPerKey=10,&#160;maxWait=-1&lt;/p&gt;

&lt;p&gt;Evictor runs every 2 seconds, 3 tests, 1 second idle timeout.&#160; Validation is off except while idle.&#160;&#160;The factory is set to add&#160; latency in make and destroy and there are 100 threads running concurrently.&#160; This setup (and the way reuseCapacity works) generates a lot of object churn.&#160; For example, one run that hit the NPE had these final stats:&#160;borrowedCount=21261, returnedCount=21222, createdCount=13822, destroyedCount=13806, destroyedByEvictorCount=9.&#160;&#160;&lt;/p&gt;

&lt;p&gt;The NPE happens when returnObject(key) dereferences the ObjectDeque returned by&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
poolMap.get(key)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I can make the NPE go away by adding the condition&#160;allObjects.isEmpty() to the test before removing a key in deregister, but what is bugging me is I can&apos;t figure out how it is happening.&#160; All of my attempts thus far at a simple unit test making this happen or an explanation for how it can happen have failed.&#160; The lock used in register / deregister should make it impossible for a key to be eliminated while there is an instance checked out.&#160; Somehow createCount is getting zeroed while there is an instance checked out.&lt;/p&gt;

&lt;p&gt;&#160;&lt;br/&gt;
 &#160;&lt;/p&gt;</comment>
                            <comment id="16915806" author="garydgregory" created="Mon, 26 Aug 2019 14:05:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=psteitz&quot; class=&quot;user-hover&quot; rel=&quot;psteitz&quot;&gt;psteitz&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Curious: do you have a stack trace to post here?&lt;/p&gt;</comment>
                            <comment id="16915885" author="psteitz" created="Mon, 26 Aug 2019 15:19:03 +0000"  >&lt;p&gt;Here is stack trace of the NPE&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[java] java.lang.NullPointerException
[java] at org.apache.commons.pool2.impl.GenericKeyedObjectPool.returnObject(GenericKeyedObjectPool.java:450)
[java] at org.apache.commons.performance.pool.PoolClientThread.execute(Unknown Source)
[java] at org.apache.commons.performance.ClientThread.run(Unknown Source)
[java] at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
[java] at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
[java] at java.lang.Thread.run(Thread.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This is running against the 2.7.0 release jar.&#160; The GKOP line is in returnObject, when dereferencing the ObjectDeque returned by the poolMap lookup.&#160; The commons performance code is a forked version of what is in the sandbox repo.&#160; PoolClientThreads just generate random (Integer) keys, borrow objects under those keys and then return them.&#160; The factory adds make, destroy and validate latency.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16915993" author="garydgregory" created="Mon, 26 Aug 2019 17:38:09 +0000"  >&lt;p&gt;Pardon my lack of deep analysis, but should we not guard against NPEs in this API such that returning garbage does not cause NPEs? For example, this &lt;tt&gt;TestGenericKeyedObjectPool&lt;/tt&gt; test will currently throw an NPE:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
 &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testNpe() {
 &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GenericKeyedObjectPool(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SimpleFactory()).returnObject(&lt;span class=&quot;code-quote&quot;&gt;&quot;Foo&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Bar&quot;&lt;/span&gt;);
 }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
Should it:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Throw an NPE as it does now? Not helpful IMO.&lt;/li&gt;
	&lt;li&gt;Throw an IllegalArgumentException &quot;Key not found&quot;? Better than an NPE IMO.&lt;/li&gt;
	&lt;li&gt;Ignore the missing key and do nothing?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Gary&lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                            <comment id="16916015" author="psteitz" created="Mon, 26 Aug 2019 17:57:58 +0000"  >&lt;p&gt;It should throw ISE, as stated in the javadoc for returnObject.&lt;/p&gt;

&lt;p&gt;The bigger problem here is the pool counters are getting corrupted somehow.&lt;/p&gt;</comment>
                            <comment id="16916026" author="garydgregory" created="Mon, 26 Aug 2019 18:12:05 +0000"  >&lt;p&gt;Roger that. Then we can make the following part of the solution:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;diff --git a/src/main/java/org/apache/commons/pool2/impl/GenericKeyedObjectPool.java b/src/main/java/org/apache/commons/pool2/impl/GenericKeyedObjectPool.java
index 6910c37..c152e0a 100644
--- a/src/main/java/org/apache/commons/pool2/impl/GenericKeyedObjectPool.java
+++ b/src/main/java/org/apache/commons/pool2/impl/GenericKeyedObjectPool.java
@@ -447,6 +447,11 @@
 
         final ObjectDeque&amp;lt;T&amp;gt; objectDeque = poolMap.get(key);
 
+        if (objectDeque == null) {
+            throw new IllegalStateException(
+                    &quot;Returned object not currently part of this pool&quot;);
+        }
+
         final PooledObject&amp;lt;T&amp;gt; p = objectDeque.getAllObjects().get(new IdentityWrapper&amp;lt;&amp;gt;(obj));
 
         if (p == null) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We can also consider whether the key should be part of the exception messages.&lt;/p&gt;</comment>
                            <comment id="16916184" author="garydgregory" created="Mon, 26 Aug 2019 22:36:04 +0000"  >&lt;p&gt;I did the ISE bit in &lt;a href=&quot;https://issues.apache.org/jira/browse/POOL-374&quot; title=&quot;org.apache.commons.pool2.impl.GenericKeyedObjectPool.returnObject(K, T) should throw IllegalStateException instead of NullPointerException when a key is not found in the pool map&quot; class=&quot;issue-link&quot; data-issue-key=&quot;POOL-374&quot;&gt;&lt;del&gt;POOL-374&lt;/del&gt;&lt;/a&gt; since it is related to this issue but not critical to it. TBD is whether the exception messages should include the key or if that would ever present some security risk.&lt;/p&gt;</comment>
                            <comment id="16916200" author="garydgregory" created="Mon, 26 Aug 2019 23:01:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=psteitz&quot; class=&quot;user-hover&quot; rel=&quot;psteitz&quot;&gt;psteitz&lt;/a&gt;&lt;br/&gt;
May you please copy the performance code you are using in &lt;tt&gt;org.apache.commons.pool2.performance&lt;/tt&gt;? It seems like a good idea to keep this code in the main repo.&lt;/p&gt;</comment>
                            <comment id="16916609" author="struberg" created="Tue, 27 Aug 2019 10:41:43 +0000"  >&lt;p&gt;Just glimpsed over the code. It looks good so far, but I&apos;m not sure whether our goal is the right one.&lt;/p&gt;

&lt;p&gt;Please correct me if I got this wrong, but all the unit test does is to put heavy load on the pool, right?&lt;br/&gt;
If this is right, then it is a perfectly valid usage scenario, isn&apos;t? So why should it fail at all? I mean it doesn&apos;t make any difference whether we blow up with a NPE or an ISE. We should rather not blow up at all.&lt;/p&gt;

&lt;p&gt;Btw, got the following when running the test on my box: &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.util.concurrent.ExecutionException: java.lang.NullPointerException
	at java.util.concurrent.FutureTask.report(FutureTask.java:122)
	at java.util.concurrent.FutureTask.get(FutureTask.java:192)
	at org.apache.commons.pool2.ObjectPoolIssue326.run(ObjectPoolIssue326.java:90)
	at org.apache.commons.pool2.ObjectPoolIssue326.main(ObjectPoolIssue326.java:44)
Caused by: java.lang.NullPointerException
	at org.apache.commons.pool2.impl.GenericKeyedObjectPool.deregister(GenericKeyedObjectPool.java:1166)
	at org.apache.commons.pool2.impl.GenericKeyedObjectPool.borrowObject(GenericKeyedObjectPool.java:419)
	at org.apache.commons.pool2.impl.GenericKeyedObjectPool.borrowObject(GenericKeyedObjectPool.java:270)
	at org.apache.commons.pool2.ObjectPoolIssue326$Task.call(ObjectPoolIssue326.java:135)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.Thread.run(Thread.java:745)
Time: 690.49
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;My gut feeling is that we should start to &apos;think big&apos; and see whether we have a conceptual problem where we should potentially rewrite much more of the internal handling.&lt;/p&gt;</comment>
                            <comment id="16916639" author="garydgregory" created="Tue, 27 Aug 2019 11:27:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=struberg&quot; class=&quot;user-hover&quot; rel=&quot;struberg&quot;&gt;struberg&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I agree WRT NSE vs. ISE, it is a separate detail, which is why I created a separate issue.&lt;/p&gt;</comment>
                            <comment id="16918148" author="psteitz" created="Wed, 28 Aug 2019 22:20:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt;&#160;- it will take me a little while to get the changes to o.a.c.performance in a state where I can commit them.&#160; I will do that. I have not tried, but I suspect even just setting up the ancient code in trunk there with the config above would cause the NPE.&#160; It does not happen on every run and the frustrating thing is that when I use the multi-thread loading framework in TestGenericKeyedObjectPool, I can&apos;t get it to happen.&#160; Hope through research...&lt;/p&gt;

&lt;p&gt;I added some instrumentation into GKOP though to see what is going on when the exception hits and it is what I suspected - the returning object is in idleObjects.&#160; So yet another way to make the exception go away and probably a good fix in any case is to change the test in deregister to check idleObjects.size instead of relying on createCount.&#160; What bugs me is I can&apos;t figure out how createCount is getting zeroed when there is an instance out in circulation.&lt;/p&gt;</comment>
                            <comment id="16918159" author="psteitz" created="Wed, 28 Aug 2019 22:44:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=struberg&quot; class=&quot;user-hover&quot; rel=&quot;struberg&quot;&gt;struberg&lt;/a&gt;&#160;what source was that run against?&#160; I assm it is the first dereference of objectDeque so what is going on is the poolMap lookup is returning null (like the problem in returnObject). I agree with you that there is something basic wrong here that we need to figure out.&lt;/p&gt;</comment>
                            <comment id="16943270" author="psteitz" created="Thu, 3 Oct 2019 00:51:54 +0000"  >&lt;p&gt;I think I found the root cause of this issue.&#160; In destroy, we use the following to test if an object is idle in the pool (so can be destroyed if the &quot;always&quot; parameter is false)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isIdle = objectDeque.getIdleObjects().remove(toDestroy);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But we don&apos;t check its state, which leaves open the possibility that it can be in process of being considered for eviction.&#160; This can result in its getting destroyed twice - once by say clearOldest and then a second time by the evictor.&#160; That results in the createCount going prematurely to 0, which is what causes the keyed pool to be removed before it has no objects under management.&#160;&#160;&lt;/p&gt;</comment>
                            <comment id="16944945" author="psteitz" created="Sat, 5 Oct 2019 01:01:15 +0000"  >&lt;p&gt;Fixed in&#160;7d0b45940238918033094684343551f90524e600&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13253138">POOL-374</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12869908" name="ObjectPoolIssue.java" size="5621" author="csallison" created="Thu, 25 May 2017 18:20:04 +0000"/>
                            <attachment id="12870254" name="pool-326.patch" size="2224" author="psteitz" created="Sun, 28 May 2017 16:28:27 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 6 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ewlj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>