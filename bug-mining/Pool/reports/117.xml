<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:16:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[POOL-287] GKOP can lose objects over time due to swallowed NPE in the evictor</title>
                <link>https://issues.apache.org/jira/browse/POOL-287</link>
                <project id="12310488" key="POOL">Commons Pool</project>
                    <description>&lt;p&gt;We ran into this bug via a Redis library that uses a GenericKeyedObjectPool for connection pooling. We found that over the course of several days, the connections available to our application were dwindling.&lt;/p&gt;

&lt;p&gt;Some relevant configuration:&lt;/p&gt;

&lt;p&gt;testWhileIdle: false&lt;br/&gt;
numTestsPerEvictionRun: -1&lt;br/&gt;
minEvictableIdleTimeMillis: 60000&lt;br/&gt;
timeBetweenEvictionRunsMillis: 30000&lt;br/&gt;
maxTotalPerKey 400&lt;br/&gt;
maxIdlePerKey 400&lt;/p&gt;

&lt;p&gt;(In a more minimal repro case I developed later, the problem happens much faster if minEvictableIdleTimeMillis and timeBetweenEvictionRunsMillis are reduced greatly, even down to 1.)&lt;/p&gt;

&lt;p&gt;We discovered that this is what happens (looking at 2.3 code, but the problem occurred with 2.2 and 2.3):&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;In evict(), there is a variable idleObjects which starts as null&lt;/li&gt;
	&lt;li&gt;The branch where idleObjects is set is not necessarily taken&lt;/li&gt;
	&lt;li&gt;The null idleObjects is passed to underTest.endEvictionTest(idleObjects)&lt;/li&gt;
	&lt;li&gt;If the object underTest had previously been borrowed and was thus set to the  EVICTION_RETURN_TO_HEAD state, then endEvictionTest throws a NPE&lt;/li&gt;
	&lt;li&gt;By default this is silently swallowed and the evictor continues on&lt;/li&gt;
	&lt;li&gt;Now the object that had been underTest is set to state IDLE, but is not in the pool&apos;s idleObjects list, so it is lost&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If it would help, I can clean up my repro program and attach that, but it is written in Clojure, not Java. I can also try to write a Java repro but I might not have time to do that for a little while.&lt;/p&gt;

&lt;p&gt;This bug can be avoided by disabling the evictor. That doesn&apos;t help us, though, because we rely on background eviction to avoid running into server-side connection timeouts.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12774789">POOL-287</key>
            <summary>GKOP can lose objects over time due to swallowed NPE in the evictor</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="cespare">Caleb Spare</reporter>
                        <labels>
                    </labels>
                <created>Fri, 13 Feb 2015 04:04:50 +0000</created>
                <updated>Mon, 1 Jun 2015 17:16:12 +0000</updated>
                            <resolved>Sat, 21 Feb 2015 22:09:46 +0000</resolved>
                                    <version>2.0</version>
                    <version>2.1</version>
                    <version>2.2</version>
                    <version>2.3</version>
                                    <fixVersion>2.4.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14320052" author="psteitz" created="Fri, 13 Feb 2015 13:14:52 +0000"  >&lt;p&gt;Thanks for the report and code analysis, which looks correct to me.  We should be able to develop a test case for this.  Patches welcome, of course, but no need to attach the Clojure program.&lt;/p&gt;</comment>
                            <comment id="14330301" author="psteitz" created="Sat, 21 Feb 2015 15:44:38 +0000"  >&lt;p&gt;Test case illustrating the problem.&lt;/p&gt;</comment>
                            <comment id="14330339" author="psteitz" created="Sat, 21 Feb 2015 16:36:03 +0000"  >&lt;p&gt;I am inclined to fix this by turning the evictionIterator into a class that holds a reference to its underlying collection.  Otherwise, we need to always set idleObjects which is a little tricky and may have slight performance impact.  It also seems a little brittle to me to have to recover the pool reference across evictor runs.   Any objections or better ideas?  I suppose another logical alternative would be to have DefaultPooleObject itself hold a reference to its owning pool.&lt;/p&gt;
</comment>
                            <comment id="14330407" author="tn" created="Sat, 21 Feb 2015 19:48:32 +0000"  >&lt;p&gt;Difficult to catch, but great that you did come up with a test case.&lt;br/&gt;
I think the idea with an iterator that holds a reference to its idleObject deque is fine, see the attached patch for a possible implementation.&lt;/p&gt;</comment>
                            <comment id="14330454" author="psteitz" created="Sat, 21 Feb 2015 22:09:24 +0000"  >&lt;p&gt;Thanks, Thomas!&lt;/p&gt;

&lt;p&gt;Fix patch (with trival javadoc add to make checkstyle happy) committed in r1661444.&lt;/p&gt;</comment>
                            <comment id="14330455" author="psteitz" created="Sat, 21 Feb 2015 22:09:46 +0000"  >&lt;p&gt;Fixed in r1661444.&lt;/p&gt;</comment>
                            <comment id="14567599" author="psteitz" created="Mon, 1 Jun 2015 17:16:12 +0000"  >&lt;p&gt;Fix released in 2.4.1&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12700052" name="POOL-287-fix.patch" size="6881" author="tn" created="Sat, 21 Feb 2015 19:48:32 +0000"/>
                            <attachment id="12700041" name="POOL-287-test.patch" size="3168" author="psteitz" created="Sat, 21 Feb 2015 15:44:38 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 24 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i25kxb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>