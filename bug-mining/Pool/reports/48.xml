<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:16:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[POOL-161] ContextClassLoader problems for the Evictor thread</title>
                <link>https://issues.apache.org/jira/browse/POOL-161</link>
                <project id="12310488" key="POOL">Commons Pool</project>
                    <description>&lt;p&gt;Since a single Timer is used for several GenericObjectPool instances, this may create classloader issues and a memory leak of one classloader :&lt;/p&gt;

&lt;p&gt;Let&apos;s imagine the following scenario :&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;commons-pool.jar is in the classpath of a webapp container (e.g. tomcat).&lt;/li&gt;
	&lt;li&gt;2 webapps A and B are deployed, each creating an instance of GenericObjectPool for its own usage.&lt;/li&gt;
	&lt;li&gt;each webapp makes use of the idle object evictor and sets a positive number for minIdle&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;first, webapp A instantiates its GenericObjectPool. Since this is the first TimerTask to be created, the Timer instance is created, thus creating a Thread whose ContextClassLoader is the current one, that is webapp A&apos;s ContextClassLoader.&lt;br/&gt;
The TimerTask properly creates instances of idle objects in the pool, making use of the ObjectFactory provided by A.&lt;/li&gt;
	&lt;li&gt;then B instantiates its GenericObjectPool. A new TimerTask is created, and it tries to invoke the ObjectFactory provided by B. But when it needs a class that only exists in B webapp, it cannot find it because the ContextClassLoader of the Timer Thread is A&apos;s classloader.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Other side effect : if webapp A is undeployed, but B is still running, then A&apos;s webappClassLoader cannot be GCed because the Timer Thread keeps a strong reference to A&apos;s classloader (as its context classloader).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12459088">POOL-161</key>
            <summary>ContextClassLoader problems for the Evictor thread</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="slaurent">Sylvain Laurent</reporter>
                        <labels>
                    </labels>
                <created>Sun, 14 Mar 2010 22:26:56 +0000</created>
                <updated>Wed, 18 Dec 2013 12:55:06 +0000</updated>
                            <resolved>Tue, 14 Feb 2012 19:27:00 +0000</resolved>
                                    <version>1.5.4</version>
                                    <fixVersion>1.5.8</fixVersion>
                    <fixVersion>1.6.1</fixVersion>
                    <fixVersion>2.0</fixVersion>
                                        <due></due>
                            <votes>4</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="12845145" author="slaurent" created="Sun, 14 Mar 2010 22:30:29 +0000"  >&lt;p&gt;added TestGenericObjectPoolClassLoader.patch.txt to showcase the problem.&lt;/p&gt;</comment>
                            <comment id="12845148" author="slaurent" created="Sun, 14 Mar 2010 22:35:37 +0000"  >&lt;p&gt;attached patch_Evictor_CCL.txt : proposed patch to save the CCL that is used when the factory is set in the pool (either in constructor or in setFactory() ), and then use it in the run() method of the TimerTask to set the CCL to the correct one.&lt;/p&gt;</comment>
                            <comment id="12874126" author="markt" created="Tue, 1 Jun 2010 18:01:27 +0000"  >&lt;p&gt;I wonder if we want to support this use case. The simple solution would be to package commons-pool in each web application. Disk is cheap, memory is cheap. Is the memory and disk space saved worth the additional complexity?&lt;/p&gt;

&lt;p&gt;I am currently looking to fix a related issue in Tomcat&apos;s use of commons-dbcp and commons-pool. I believe I&apos;ll be able to fix that entirely within Tomcat but if not, it will likely impact this fix. I&apos;ll report back here with any progress on the Tomcat issue.&lt;/p&gt;</comment>
                            <comment id="12874167" author="markt" created="Tue, 1 Jun 2010 19:13:58 +0000"  >&lt;p&gt;It wasn&apos;t possible to fix the related issue in Tomcat so I have fixed it in pool.&lt;/p&gt;

&lt;p&gt;The issue was that the context class loader for the TimerThread would be set to whatever class laoder happened to be in use when the Thread was created. That could trigger a memory leak in multiple class loader environments. The fix should not impact the proposed patch since the fix sets the default class loader that this patch stores whilst an alternative class loader is used and then restores.&lt;/p&gt;</comment>
                            <comment id="12874171" author="sebb@apache.org" created="Tue, 1 Jun 2010 19:20:20 +0000"  >&lt;p&gt;Disk space and memory may be cheap, but finding the memory leak in a complicated web application and/or reconfiguring the application to avoid it is probably not cheap.&lt;/p&gt;

&lt;p&gt;So unless the fix turns out to be considerably more complex than the patch suggests, I think it would be worth implementing.&lt;/p&gt;</comment>
                            <comment id="12874193" author="markt" created="Tue, 1 Jun 2010 19:39:04 +0000"  >&lt;p&gt;My main concern is what other as yet undiscovered memory leaks may be lurking in the code. Having each web app (in this use case) use it&apos;s own copy of pool will avoid any such issues entirely. Fixing this issue sets us off down the potentially hugely complicated path of supporting the use of a single instance of commons pool across multiple class loaders. That is the complexity that concerns me.&lt;/p&gt;</comment>
                            <comment id="12874210" author="sebb@apache.org" created="Tue, 1 Jun 2010 20:09:50 +0000"  >&lt;p&gt;I see. &lt;/p&gt;

&lt;p&gt;However it seems to me that it&apos;s still worth doing - it may be the only class-loader leak, and even if not, it will help some users.&lt;/p&gt;

&lt;p&gt;We don&apos;t have to guarantee that POOL is free of class-loader issues, but at least we could fix ones that don&apos;t involve a huge effort.&lt;/p&gt;

&lt;p&gt;We also need to clearly document that the code may have class-loader issues, and the work-round.&lt;/p&gt;</comment>
                            <comment id="12874236" author="slaurent" created="Tue, 1 Jun 2010 21:02:01 +0000"  >&lt;p&gt;I think commons-pool should be considered as the kind of infrastructure library that should be multi-classloader aware. For instance, it is often used through commons-dbcp for datasources declared in tomcat&apos;s server.xml.&lt;br/&gt;
In such a scenario, one can have a single datasource shared by multiple webapps...&lt;/p&gt;

&lt;p&gt;Mark, if you don&apos;t intend to apply the patch I proposed for the next release of commons-pool, then this issue should be split in 2, one for the fix you did, one to fix the CCL before calling the ObjectFactory.&lt;/p&gt;</comment>
                            <comment id="12875907" author="psteitz" created="Sat, 5 Jun 2010 14:14:57 +0000"  >&lt;p&gt;We seem to be talking about three different issues here:&lt;/p&gt;

&lt;p&gt;1. The issue that Mark&apos;s commit fixed - potential for memory leak when the class loader for the eviction thread is not the same loader that loaded the library.  IIUC, Mark&apos;s patch fully fixes this issue and any other potential for classloader leaks associated with the evictor.  Correct?&lt;/p&gt;

&lt;p&gt;2. Feature request to support the use case in the issue description.  Looks to me like Mark&apos;s patch actually does fully fix the issue as narrowly defined above.  I must be missing something here.&lt;/p&gt;

&lt;p&gt;3. Feature request for pool to work in arbitrary multi-classloader environments&lt;/p&gt;

&lt;p&gt;I agree with Mark that it is not obvious that we should aim to support 2., and I think we have some work do to in defining exactly what 3. means.  I am strongly +1 on doing everything we can to avoid leaks. &lt;/p&gt;</comment>
                            <comment id="12875921" author="slaurent" created="Sat, 5 Jun 2010 17:50:43 +0000"  >&lt;p&gt;1. Correct&lt;/p&gt;

&lt;p&gt;2. No. Mark&apos;s patch fixes the CCL when the TimerThread is started. The patch I provided allows to have the ObjectFactory called with a different CCL just for the duration of the call. So there are no leak problems involved here for case #2, just a use case in a multi-classloader environment&lt;/p&gt;

&lt;p&gt;3. The issue I raised did not ask to review the whole commons-pool usage in multi-classloader environment, I just proposed to fix a use case I encountered. Actually I first discovered the leak and then found out about the issue about multi-classloader usage...&lt;/p&gt;

&lt;p&gt;So, If my patch were applied, I would consider the issue as totally fixed.&lt;/p&gt;</comment>
                            <comment id="12876046" author="psteitz" created="Sun, 6 Jun 2010 14:33:47 +0000"  >&lt;p&gt;Thanks, Sylvain.  My mistake on 2.&lt;/p&gt;

&lt;p&gt;I am on the fence as to whether to apply Sylvain&apos;s patch for 1.5.x or wait until 2.0 to fully fix the issue.  Does anyone see any risk in applying the patch in 1.5.5?  If we don&apos;t apply it, we should at least update the docs to make it clear that the evictor is nailed to the loader used to load the library.&lt;/p&gt;</comment>
                            <comment id="13055006" author="ringerc" created="Sun, 26 Jun 2011 02:42:19 +0000"  >&lt;p&gt;This has been biting me rather severely. It&apos;s not &quot;only&quot; a classloader leak because, by leaking the classloader it can become impossible to unload huge parts of the web application because so many Java libraries like to keep static caches.&lt;/p&gt;

&lt;p&gt;Mark Thomas: It&apos;s not correct to state that having each app use its own copy of commons-pool will fix the issue. In fact, I encountered the issue precisely &lt;b&gt;because&lt;/b&gt; my app deploys its own copy of commons-pool. I landed up with a timer thread used by commons-pool in a ThreadGroup owned by the app server. The timer thread holds a reference to my classloader via contextClassLoader, so my app&apos;s classloader cannot be unloaded.&lt;/p&gt;

&lt;p&gt;An effective workaround appears to be to move apache commons pool into the application server&apos;s set of provided classes. For Glassfish, that&apos;s glassfish/domains/domain1/lib .&lt;/p&gt;</comment>
                            <comment id="13207329" author="markt" created="Mon, 13 Feb 2012 23:21:09 +0000"  >&lt;p&gt;Craig: Per context use of commons pool does avoid this bug and does not trigger a memory leak. The problem you are describing is not a pool bug but the application&apos;s (or possibly the container&apos;s depending on exact usage) failure to correctly shutdown the pool when the context stops. For the record Tomcat handles this correctly. The workaround you describe for glassfish will trigger the bug that Sylvain describes in point 2.&lt;/p&gt;

&lt;p&gt;Sylvain: Thanks for the patch. It has been applied - with some minor tweaks to 1.6.x and will be included in 1.6.1 onwards. I will back-port it to 1.5.x forward port it to 2.x shortly.&lt;/p&gt;</comment>
                            <comment id="13207339" author="garydgregory" created="Mon, 13 Feb 2012 23:32:07 +0000"  >&lt;p&gt;We&apos;ll need a 1.5 branch for this in 1.5.8.&lt;/p&gt;</comment>
                            <comment id="13207344" author="markt" created="Mon, 13 Feb 2012 23:34:58 +0000"  >&lt;p&gt;Huh? Could you explain that comment please. We already have a 1.5.x branch.&lt;/p&gt;</comment>
                            <comment id="13207423" author="garydgregory" created="Tue, 14 Feb 2012 01:07:20 +0000"  >&lt;p&gt;Sorry I confused 1_5_RELEASE (used for 1.5.x) and POOL_1_X (the latest release from there is 1.6)&lt;/p&gt;</comment>
                            <comment id="13207930" author="markt" created="Tue, 14 Feb 2012 19:27:00 +0000"  >&lt;p&gt;Fix ported to 1.5.x and 2.x&lt;/p&gt;</comment>
                            <comment id="13851666" author="matusferko" created="Wed, 18 Dec 2013 12:55:06 +0000"  >&lt;p&gt;HI,&lt;br/&gt;
is this fixed in any 1.5.x Release/tag version? &lt;br/&gt;
I can&apos;t find 1.5.8 in maven repository&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12438773" name="TestGenericObjectPoolClassLoader.patch.txt" size="3845" author="slaurent" created="Sun, 14 Mar 2010 22:30:29 +0000"/>
                            <attachment id="12438774" name="patch_Evictor_CCL.txt" size="3157" author="slaurent" created="Sun, 14 Mar 2010 22:35:37 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>19471</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 48 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0zcgf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>204320</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>