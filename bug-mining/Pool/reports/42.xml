<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:16:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[POOL-149] A serious concurrent bug can cause resource leak when Pool exhausted and borrowed objects are invalid</title>
                <link>https://issues.apache.org/jira/browse/POOL-149</link>
                <project id="12310488" key="POOL">Commons Pool</project>
                    <description>&lt;p&gt;This bug will happen when the pool is in exhausted state and the borrowed object are invalid.&lt;/p&gt;

&lt;p&gt;Let&apos;s go through a simple scenario:&lt;br/&gt;
1)A GenericObjectPool with _maxActive==1, whenExhaustedAction==WHEN_EXHAUSTED_BLOCK&lt;br/&gt;
2)Two threads using that pool, called thread1 and thread2&lt;/p&gt;

&lt;p&gt;Here is error path:&lt;br/&gt;
1)thread1 calls pool.borrowObject() to get the object out of the pool&lt;br/&gt;
//now the pool is exhausted&lt;br/&gt;
2)thread2 calls pool.borrowObject(), adds a new latch to the _allocationQueue, but before it enters the synchronized block for WHEN_EXHAUSTED_BLOCK(GenericObjectPool line 1099 revision 806215), context-switch happens&lt;br/&gt;
3)thread1 checks the object from pool, and decides to invalidate it. So it calls pool.invalidateObject(), which calls allocate(), then calls latch.notify(), but currently no thread is waiting on this latch.(thread2 has not enter the wait synchronized block yet).&lt;br/&gt;
4)Then thread2 will wait there for ever.(it just missed the notify)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12433583">POOL-149</key>
            <summary>A serious concurrent bug can cause resource leak when Pool exhausted and borrowed objects are invalid</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="shuyang.zhou">shuyang.zhou</reporter>
                        <labels>
                    </labels>
                <created>Thu, 20 Aug 2009 16:32:49 +0000</created>
                <updated>Thu, 24 Sep 2009 00:49:09 +0000</updated>
                            <resolved>Wed, 9 Sep 2009 13:12:11 +0000</resolved>
                                    <version>1.5</version>
                    <version>1.5.1</version>
                    <version>1.5.2</version>
                                    <fixVersion>1.5.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12746721" author="psteitz" created="Mon, 24 Aug 2009 03:43:35 +0000"  >&lt;p&gt;This looks like a &quot;latch leak&quot; similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/POOL-147&quot; title=&quot;Thread stuck in GenericObjectPool borrowObject()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;POOL-147&quot;&gt;&lt;del&gt;POOL-147&lt;/del&gt;&lt;/a&gt;.  It would be great to have a test case to demonstrate the reported issue.  In any case, the execution sequence should not result in a deadlock; rather a resource leak and one thread blocking indefinitely.  &lt;/p&gt;</comment>
                            <comment id="12746734" author="shuyang.zhou" created="Mon, 24 Aug 2009 05:17:50 +0000"  >&lt;p&gt;HI Phil Steitz,&lt;/p&gt;

&lt;p&gt;My problem is different with &lt;a href=&quot;https://issues.apache.org/jira/browse/POOL-147&quot; title=&quot;Thread stuck in GenericObjectPool borrowObject()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;POOL-147&quot;&gt;&lt;del&gt;POOL-147&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/POOL-147&quot; title=&quot;Thread stuck in GenericObjectPool borrowObject()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;POOL-147&quot;&gt;&lt;del&gt;POOL-147&lt;/del&gt;&lt;/a&gt; is a &quot;double check&quot; problem, i think.&lt;br/&gt;
But my problem is the &quot;notify&quot; comes earlier than its &quot;wait&quot;, which will cause the &quot;wait&quot; wait for ever.&lt;/p&gt;

&lt;p&gt;I will create a demo test case for this.&lt;/p&gt;</comment>
                            <comment id="12746737" author="shuyang.zhou" created="Mon, 24 Aug 2009 05:42:34 +0000"  >&lt;p&gt;Ok, there is no way to force the bad case to happen in a unit test.&lt;br/&gt;
I created a test case, and with it you can just hope the bug happens.&lt;/p&gt;

&lt;p&gt;And i tested it several times, it always happens. But maybe you need to run it several time to get your luck.&lt;/p&gt;

&lt;p&gt;Here is the instruction:&lt;br/&gt;
1)Run the test case, and look at your output console&lt;br/&gt;
2)Wait until it stops output timestamp(If you test case quit successfully, you need to restart from 1))&lt;br/&gt;
3)Use VisualVM to take a thread dump and heap dump&lt;/p&gt;

&lt;p&gt;From the thread dump you should able to find one pooled thread wait on GenericObjectPool for ever like this:&lt;br/&gt;
&quot;pool-267-thread-10&quot; prio=10 tid=0x00007f58c4300800 nid=0x2892 in Object.wait() &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007f58c91a2000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: WAITING (on object monitor)&lt;br/&gt;
	at java.lang.Object.wait(Native Method)&lt;br/&gt;
	at java.lang.Object.wait(Object.java:485)&lt;br/&gt;
	at org.apache.commons.pool.impl.GenericObjectPool.borrowObject(GenericObjectPool.java:1103)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;locked &amp;lt;0x00007f58fb042db0&amp;gt; (a org.apache.commons.pool.impl.GenericObjectPool$Latch)&lt;br/&gt;
	at BugTest$TestJob.run(BugTest.java:72)&lt;br/&gt;
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)&lt;br/&gt;
	at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)&lt;br/&gt;
	at java.util.concurrent.FutureTask.run(FutureTask.java:138)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:619)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   Locked ownable synchronizers:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&amp;lt;0x00007f58fa67ff10&amp;gt; (a java.util.concurrent.locks.ReentrantLock$NonfairSync)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;From the heap dump you should able to see the GenericObjectPool is empty.&lt;/p&gt;

&lt;p&gt;There is another way to see this bug easily, but you need a multithread enabled debuger, for example, Netbeans(See &lt;a href=&quot;http://www.netbeans.org/kb/docs/java/debug-multithreaded.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.netbeans.org/kb/docs/java/debug-multithreaded.html&lt;/a&gt;)&lt;br/&gt;
In the test case set TEST_THREAD_NUM=2, MAX_ACTIVE=1, run the debuger with the instruction in ticket description, you can see how this bug happens easily.&lt;/p&gt;</comment>
                            <comment id="12746738" author="shuyang.zhou" created="Mon, 24 Aug 2009 05:50:45 +0000"  >&lt;p&gt;And this bug should be called resource leak, not deadlock. My bad.&lt;/p&gt;

&lt;p&gt;Finally all threads try to borrow objects from the empty pool will block indefinitely.&lt;/p&gt;</comment>
                            <comment id="12747417" author="psteitz" created="Tue, 25 Aug 2009 14:02:19 +0000"  >&lt;p&gt;Thanks, Shuyang!&lt;/p&gt;

&lt;p&gt;The test case demonstrates the problem nicely.  A simple fix for the specific case identified here is to recheck latch.mayCreate() inside the synch(latch) block, i.e. change GenericObjectPool line 1101 revision 792217 to &lt;/p&gt;

&lt;p&gt;if (latch.getPair() == null &amp;amp;&amp;amp; !latch.mayCreate())&lt;/p&gt;

&lt;p&gt;That &quot;fix&quot; does not fully address the problem though, as it deals only with the control path called out in the bug report.  We should look at all other latch state tests and scope of synchronization on latches.&lt;/p&gt;</comment>
                            <comment id="12747450" author="shuyang.zhou" created="Tue, 25 Aug 2009 14:52:21 +0000"  >&lt;p&gt;Just curious, do you guys have a plan to upgrade Commons Pool&apos;s jdk requirement to 1.5+ ?&lt;/p&gt;

&lt;p&gt;By the concurrent package, you can avoid the fragile synchronized, wait and notify, and also use the spin lock instead of the old monitor lock to get a performance gain.&lt;/p&gt;</comment>
                            <comment id="12747451" author="psteitz" created="Tue, 25 Aug 2009 14:57:06 +0000"  >&lt;p&gt;Yes, in pool 2.0.  &lt;/p&gt;</comment>
                            <comment id="12747453" author="shuyang.zhou" created="Tue, 25 Aug 2009 15:07:52 +0000"  >&lt;p&gt;Great! Hope it comes out soon&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12749846" author="fdiotalevi" created="Tue, 1 Sep 2009 10:44:07 +0000"  >&lt;p&gt;Hi, I believe this problem is hitting me in pre-production, where all the threads are dealocked at &lt;/p&gt;

&lt;p&gt;   java.lang.Thread.State: WAITING (on object monitor)&lt;br/&gt;
	at java.lang.Object.wait(Native Method)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting on &amp;lt;0x000000010a2a1258&amp;gt; (a org.apache.commons.pool.impl.GenericObjectPool)&lt;br/&gt;
	at java.lang.Object.wait(Object.java:485)&lt;br/&gt;
	at org.apache.commons.pool.impl.GenericObjectPool.borrowObject(GenericObjectPool.java:942)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x000000010a2a1258&amp;gt; (a org.apache.commons.pool.impl.GenericObjectPool)&lt;br/&gt;
	at org.apache.commons.dbcp.PoolingDataSource.getConnection(PoolingDataSource.java:96)&lt;br/&gt;
	at org.apache.commons.dbcp.BasicDataSource.getConnection(BasicDataSource.java:880)&lt;br/&gt;
	at sun.reflect.GeneratedMethodAccessor87.invoke(Unknown Source)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
	at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:307)&lt;br/&gt;
	at org.springframework.osgi.service.importer.support.internal.aop.ServiceInvoker.doInvoke(ServiceInvoker.java:58)&lt;br/&gt;
	at org.springframework.osgi.service.importer.support.internal.aop.ServiceInvoker.invoke(S&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;Can I have an update on this issue? Is there a patch I can apply to workaround this problem?&lt;/p&gt;</comment>
                            <comment id="12749856" author="shuyang.zhou" created="Tue, 1 Sep 2009 11:04:28 +0000"  >&lt;p&gt;Hi Filippo,&lt;/p&gt;

&lt;p&gt;No sure is your problem the same as the one i found. Because your thread dump looks different. Do you know which version of commons pool you have? GenericObjectPool.java:942 is javadoc in 1.5.2&lt;/p&gt;

&lt;p&gt;If you sure about they are the same, you can try Phil&apos;s solution. Even though there maybe more bugs like this, but this fix should help your problem.&lt;/p&gt;</comment>
                            <comment id="12750058" author="psteitz" created="Tue, 1 Sep 2009 19:24:31 +0000"  >&lt;p&gt;Fillippo:  From the line numbers in the stack trace above, it looks like a) the pool version is 1.4 and b) you have configured the pool to block indefinitely (maxWait &amp;lt; 0) when the pool is exhausted and c) the pool is exhausted.  The issue reported in this ticket applies only to pool 1.5+.&lt;/p&gt;

&lt;p&gt;Assuming I have interpreted the line numbers in the trace right, most likely what is going on is your application is not closing connections and you are exhausting the pool.&lt;/p&gt;</comment>
                            <comment id="12753074" author="markt" created="Wed, 9 Sep 2009 13:12:11 +0000"  >&lt;p&gt;This is related  to &lt;a href=&quot;https://issues.apache.org/jira/browse/POOL-147&quot; title=&quot;Thread stuck in GenericObjectPool borrowObject()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;POOL-147&quot;&gt;&lt;del&gt;POOL-147&lt;/del&gt;&lt;/a&gt; although it highlights a wider problem.&lt;/p&gt;

&lt;p&gt;In short, when testing to see if allocate() had assigned an object, checking latch.getPair()==null was insufficient. It is also necessary to check latch.mayCreate()==false&lt;/p&gt;

&lt;p&gt;This has been patched in trunk and will be fixed in 1.5.3&lt;/p&gt;

&lt;p&gt;The attached test case now runs without locking up.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12417441" name="BugTest.java" size="2928" author="shuyang.zhou" created="Mon, 24 Aug 2009 05:42:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>166723</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 11 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0zec7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>204625</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>