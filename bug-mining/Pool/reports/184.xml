<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:17:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[POOL-407] Threads get stuck when idleObjects list is empty.</title>
                <link>https://issues.apache.org/jira/browse/POOL-407</link>
                <project id="12310488" key="POOL">Commons Pool</project>
                    <description>&lt;p&gt;While borrowing object from pool, threads are getting stuck. I initialised the pool size as 1. And had 3 threads created. First thread enters borrowObject method, since there are no idle objects to poll from, it will create one object and move forward.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
p = (PooledObject)&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.idleObjects.pollFirst();
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (p == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
  p = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.create();
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (p != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
     create = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
  }
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The other two threads will also follow same path and check for idle objects(there are none), will try to create one object but the pool size is set to 1. Thus, the two threads will move forward and enter&#160;&lt;b&gt;idleObjects.takeFirst()&lt;/b&gt; function. Value of blockWhenExhausted is true and borrowMaxWaitMillis is -1 as we don&apos;t want timeout.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (blockWhenExhausted) {
   &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (p == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (borrowMaxWaitMillis &amp;lt; 0L) {
           p = (PooledObject)&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.idleObjects.takeFirst();
      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
           p = (PooledObject)&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.idleObjects.pollFirst(borrowMaxWaitMillis, TimeUnit.MILLISECONDS);
      }
   }

   &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (p == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NoSuchElementException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Timeout waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; idle object&quot;&lt;/span&gt;);
   }
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Now, the main thread does&#160;&lt;b&gt;this.factory.activateObject(p);&lt;/b&gt;&#160;and object gets activated. Now, when the validation is checked&#160;&lt;b&gt;validate = this.factory.validateObject(p);&lt;/b&gt;&#160;it comes out to be false as provider might have been disconnected.&lt;/p&gt;

&lt;p&gt;So, the object is destroyed by calling&#160;&lt;b&gt;this.destroy(p);&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void destroy(PooledObject&amp;lt;T&amp;gt; toDestroy) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
     toDestroy.invalidate();
     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.idleObjects.remove(toDestroy);
     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.allObjects.remove(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BaseGenericObjectPool.IdentityWrapper(toDestroy.getObject()));

     &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.factory.destroyObject(toDestroy);
     } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.destroyedCount.incrementAndGet();
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.createCount.decrementAndGet();
     }
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The object which was created is now destroyed and removed from idleObject and allObjects list. Now, the other two threads are still waiting to take object from idle objects list but there are no object present. Hence, the two threads are in wait state for infinite period and the application waits forever until we kill the process.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; E takeFirst() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InterruptedException {
   &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.lock.lock();

   &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; var2;
   &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; x;
      &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt;((x = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.unlinkFirst()) == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
         &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.notEmpty.await();
      }

      var2 = x;
    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.lock.unlock();
    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; var2;
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13473220">POOL-407</key>
            <summary>Threads get stuck when idleObjects list is empty.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="sarthak_eddy">Sarthak Shukla</reporter>
                        <labels>
                    </labels>
                <created>Mon, 25 Jul 2022 07:21:42 +0000</created>
                <updated>Mon, 18 Sep 2023 22:47:52 +0000</updated>
                                            <version>2.8.1</version>
                                    <fixVersion>3.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17570841" author="garydgregory" created="Mon, 25 Jul 2022 10:58:22 +0000"  >&lt;p&gt;What is &quot;Unknown macro&quot;?&lt;/p&gt;</comment>
                            <comment id="17570843" author="garydgregory" created="Mon, 25 Jul 2022 11:00:53 +0000"  >&lt;p&gt;Can you provide a PR with a failing unit test?&lt;/p&gt;

&lt;p&gt;What happens if you use the current version 2.11.1?&lt;/p&gt;</comment>
                            <comment id="17577928" author="garydgregory" created="Wed, 10 Aug 2022 11:01:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sarthak_eddy&quot; class=&quot;user-hover&quot; rel=&quot;sarthak_eddy&quot;&gt;sarthak_eddy&lt;/a&gt;&#160;Ping?&lt;/p&gt;

&lt;p&gt;Phil, any thoughts?&lt;/p&gt;</comment>
                            <comment id="17610719" author="JIRAUSER296290" created="Wed, 28 Sep 2022 20:19:09 +0000"  >&lt;p&gt;I think we hit the same or at least a very similar bug. In our case the create method of the Object Factory returned &lt;tt&gt;null&lt;/tt&gt; because the connection that was supposed to be established failed at a very early stage.&lt;/p&gt;

&lt;p&gt;I&apos;ve prepared a test case at &lt;a href=&quot;https://github.com/dmfs/POOL-407/blob/main/src/test/java/org/example/FooPoolTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/dmfs/POOL-407/blob/main/src/test/java/org/example/FooPoolTest.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This is reproducible with both, 2.8.1 and 2.11.1.&lt;/p&gt;

&lt;p&gt;There is a 3rd party application suffering from this called openHAB. It returns &lt;tt&gt;null&lt;/tt&gt; when the name resolution of the connection fails, see &lt;a href=&quot;https://github.com/openhab/openhab-core/blob/main/bundles/org.openhab.core.io.transport.modbus/src/main/java/org/openhab/core/io/transport/modbus/internal/pooling/ModbusSlaveConnectionFactoryImpl.java#L163&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ModbusSlaveConnectionFactoryImpl#create(ModbusSlaveEndpoint endpoint)&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17612791" author="garydgregory" created="Tue, 4 Oct 2022 20:30:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dmfs&quot; class=&quot;user-hover&quot; rel=&quot;dmfs&quot;&gt;dmfs&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Please provide your test as a GitHub PR as it currently does not look like it would even compile since there is no Foo or FooPool types in your example folder. We need a failing test to debug &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17612860" author="JIRAUSER296290" created="Wed, 5 Oct 2022 06:35:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt; the missing classes are in the src/main folder of the project &lt;a href=&quot;https://github.com/dmfs/POOL-407&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/dmfs/POOL-407&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I probably can file a PR by the end of the week.&lt;/p&gt;</comment>
                            <comment id="17612963" author="garydgregory" created="Wed, 5 Oct 2022 11:44:36 +0000"  >&lt;p&gt;Ah, gotcha. Thanks for the pointer.&lt;/p&gt;</comment>
                            <comment id="17614290" author="garydgregory" created="Fri, 7 Oct 2022 22:01:41 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dmfs&quot; class=&quot;user-hover&quot; rel=&quot;dmfs&quot;&gt;dmfs&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;For your use case, I added the test package &lt;tt&gt;org.apache.commons.pool2.pool407&lt;/tt&gt; which contains a configurable set of test classes based on your git repo.&lt;/p&gt;

&lt;p&gt;The simplest way to fix your issue is to not create a bogus pooled object by updating your factory from:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; &#160; @Override
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; PooledObject&amp;lt;KeyedPool407Fixture&amp;gt; wrap(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; KeyedPool407Fixture value) {
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DefaultPooledObject&amp;lt;&amp;gt;(value,);
&#160; &#160; }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;to:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; &#160; @Override
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; PooledObject&amp;lt;KeyedPool407Fixture&amp;gt; wrap(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; KeyedPool407Fixture value) {
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// Require a non-&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; value.
&lt;/span&gt;&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DefaultPooledObject&amp;lt;&amp;gt;(Objects.requireNonNull(value, &lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;));
&#160; &#160; }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;One would think that changing the validation method only should work, but the following is not enough:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; validateObject(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; key, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; PooledObject&amp;lt;KeyedPool407Fixture&amp;gt; p) {
        &lt;span class=&quot;code-comment&quot;&gt;// TODO Should &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; be enough even &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; wrap() does &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; and returns a DefaultPooledObject wrapping a &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;?
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; p.getObject() != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17614535" author="JIRAUSER296290" created="Sat, 8 Oct 2022 18:54:02 +0000"  >&lt;p&gt;So the solution (or correct usage?) is to throw an exception in case the pooled can not be created? That&apos;s what we ended up doing too, just not in &lt;tt&gt;wrap&lt;/tt&gt; but in &lt;tt&gt;create&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I think the assumption of the openHAB developers (and probably of &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sarthak_eddy&quot; class=&quot;user-hover&quot; rel=&quot;sarthak_eddy&quot;&gt;sarthak_eddy&lt;/a&gt; too) was that you can indeed return/wrap a &lt;tt&gt;null&lt;/tt&gt; object and just return &lt;tt&gt;false&lt;/tt&gt; in &lt;tt&gt;validateObject&lt;/tt&gt;. I&apos;m fine with throwing an Exception and we&apos;ll file a PR in the openHAB project to do so as well.&lt;/p&gt;</comment>
                            <comment id="17614541" author="garydgregory" created="Sat, 8 Oct 2022 21:08:28 +0000"  >&lt;p&gt;Some of the Javadocs say that throwing an exception is how you signal a &quot;make an object&quot; problem. IMO, the framework should no-op on null values from a factory but that&apos;s not what happens as you discovered. A null is pretty useless, so an exception seems appropriate.&lt;/p&gt;</comment>
                            <comment id="17653705" author="psteitz" created="Mon, 2 Jan 2023 22:18:00 +0000"  >&lt;p&gt;Thanks for reporting this with the detailed analysis.&#160; It is a liveness bug.&#160; One option to consider for a patch would be to modify the code in borrowObject to do what returnObject does on validation failures, which is to call ensureIdle(1, false).&#160; Need to think carefully about the consequences of adding this, but that is what we did to address the dual of this problem on return.&lt;/p&gt;</comment>
                            <comment id="17742216" author="psteitz" created="Tue, 11 Jul 2023 23:57:39 +0000"  >&lt;p&gt;Looking more carefully at this, the sequence in the description can happen and it is a liveness limitation of the pool.&#160; There are other scenarios that can lead to this.&#160; Neither GKOP nor GOP currently have a way to recover from factory &quot;outages.&quot;&#160; My suggestion to use ensureIdle above is not a good idea because it could lead to looping in borrowObject.&#160;&#160;&lt;/p&gt;

&lt;p&gt;The tests added above are not really testing anything.&#160; You can see in the console NPE stack traces that don&apos;t cause the Junit tests to fail because the runner is not picking them up.&#160; A more complex setup would be needed to catch them.&#160; That setup would cause the ones where the factory returns null to fail.&#160; By design, pool create methods throw NPE when factories return null.&#160; This is documented in the javadoc for create, but missing from that of the pool methods.&#160;&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 17 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z17560:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>