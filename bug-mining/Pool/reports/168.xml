<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:17:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[POOL-356] deadlock if borrowObject gets called to fast and maxIdle is 0</title>
                <link>https://issues.apache.org/jira/browse/POOL-356</link>
                <project id="12310488" key="POOL">Commons Pool</project>
                    <description>&lt;p&gt;I figured this while creating a unit test for OpenJPA. But also did see this in real production with commons-dbcp2. See &lt;a href=&quot;https://issues.apache.org/jira/browse/DBCP-513&quot; title=&quot;Hundreads of threads in Wait state with below stack trace&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DBCP-513&quot;&gt;&lt;del&gt;DBCP-513&lt;/del&gt;&lt;/a&gt; for more info.&lt;/p&gt;

&lt;p&gt;See this comment for a precise explanation what happens &lt;a href=&quot;https://issues.apache.org/jira/browse/DBCP-513?focusedCommentId=16660545&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-16660545&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/DBCP-513?focusedCommentId=16660545&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-16660545&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The problem is basically that the logic to immediately destroy a pool object does not notify the DeLinkedQueue:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isClosed() || maxIdleSave &amp;gt; -1 &amp;amp;&amp;amp; maxIdleSave &amp;lt;= idleObjects.size()) {
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                destroy(p);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But the borrowObject code is locking on that condition...&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (borrowMaxWaitMillis &amp;lt; 0) {
                        p = idleObjects.takeFirst();
                    } 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13193829">POOL-356</key>
            <summary>deadlock if borrowObject gets called to fast and maxIdle is 0</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="struberg">Mark Struberg</assignee>
                                    <reporter username="struberg">Mark Struberg</reporter>
                        <labels>
                    </labels>
                <created>Wed, 24 Oct 2018 10:50:54 +0000</created>
                <updated>Wed, 25 Sep 2019 20:14:49 +0000</updated>
                            <resolved>Wed, 25 Sep 2019 17:42:43 +0000</resolved>
                                    <version>2.6.0</version>
                                    <fixVersion>2.6.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4200">1h 10m</timespent>
                                <comments>
                            <comment id="16662112" author="githubbot" created="Wed, 24 Oct 2018 11:00:00 +0000"  >&lt;p&gt;GitHub user struberg opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/commons-pool/pull/11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-pool/pull/11&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/POOL-356&quot; title=&quot;deadlock if borrowObject gets called to fast and maxIdle is 0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;POOL-356&quot;&gt;&lt;del&gt;POOL-356&lt;/del&gt;&lt;/a&gt; add unit test for the deadlock&lt;/p&gt;

&lt;p&gt;    Please review!&lt;/p&gt;

&lt;p&gt;    Will ship a first fix candidate soon.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/struberg/commons-pool&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/struberg/commons-pool&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/POOL-356&quot; title=&quot;deadlock if borrowObject gets called to fast and maxIdle is 0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;POOL-356&quot;&gt;&lt;del&gt;POOL-356&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/commons-pool/pull/11.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-pool/pull/11.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #11&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 60a041d393c75035e9a63c33723c382ac6f35c30&lt;br/&gt;
Author: Mark Struberg &amp;lt;struberg@...&amp;gt;&lt;br/&gt;
Date:   2018-10-24T10:58:38Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/POOL-356&quot; title=&quot;deadlock if borrowObject gets called to fast and maxIdle is 0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;POOL-356&quot;&gt;&lt;del&gt;POOL-356&lt;/del&gt;&lt;/a&gt; add unit test for the deadlock&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16662119" author="struberg" created="Wed, 24 Oct 2018 11:04:12 +0000"  >&lt;p&gt;This is what it looks like in the thread dump.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;Thread-198@1388&quot; daemon prio=5 tid=0xd4 nid=NA waiting
  java.lang.Thread.State: WAITING
	  at sun.misc.Unsafe.park(Unsafe.java:-1)
	  at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
	  at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2039)
	  at org.apache.commons.pool2.impl.LinkedBlockingDeque.takeFirst(LinkedBlockingDeque.java:590)
	  at org.apache.commons.pool2.impl.GenericObjectPool.borrowObject(GenericObjectPool.java:425)
	  at org.apache.commons.pool2.impl.GenericObjectPool.borrowObject(GenericObjectPool.java:346)
	  at org.apache.commons.pool2.impl.TestGenericObjectPool$TestThread.run(TestGenericObjectPool.java:1680)
	  at java.lang.Thread.run(Thread.java:748)

&quot;Thread-197@1387&quot; daemon prio=5 tid=0xd3 nid=NA waiting
  java.lang.Thread.State: WAITING
	  at sun.misc.Unsafe.park(Unsafe.java:-1)
	  at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
	  at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2039)
	  at org.apache.commons.pool2.impl.LinkedBlockingDeque.takeFirst(LinkedBlockingDeque.java:590)
	  at org.apache.commons.pool2.impl.GenericObjectPool.borrowObject(GenericObjectPool.java:425)
	  at org.apache.commons.pool2.impl.GenericObjectPool.borrowObject(GenericObjectPool.java:346)
	  at org.apache.commons.pool2.impl.TestGenericObjectPool$TestThread.run(TestGenericObjectPool.java:1680)
	  at java.lang.Thread.run(Thread.java:748)

&quot;Thread-196@1386&quot; daemon prio=5 tid=0xd2 nid=NA waiting
  java.lang.Thread.State: WAITING
	  at sun.misc.Unsafe.park(Unsafe.java:-1)
	  at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
	  at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2039)
	  at org.apache.commons.pool2.impl.LinkedBlockingDeque.takeFirst(LinkedBlockingDeque.java:590)
	  at org.apache.commons.pool2.impl.GenericObjectPool.borrowObject(GenericObjectPool.java:425)
	  at org.apache.commons.pool2.impl.GenericObjectPool.borrowObject(GenericObjectPool.java:346)
	  at org.apache.commons.pool2.impl.TestGenericObjectPool$TestThread.run(TestGenericObjectPool.java:1680)
	  at java.lang.Thread.run(Thread.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16662753" author="githubbot" created="Wed, 24 Oct 2018 19:45:45 +0000"  >&lt;p&gt;Github user coveralls commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/commons-pool/pull/11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-pool/pull/11&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;    [!&lt;span class=&quot;error&quot;&gt;&amp;#91;Coverage Status&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://coveralls.io/builds/19703092/badge)](https://coveralls.io/builds/19703092&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://coveralls.io/builds/19703092/badge)](https://coveralls.io/builds/19703092&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;    Coverage increased (+0.3%) to 85.174% when pulling *&lt;b&gt;016a1f67263fe1cde1d910dc7002d972811951c5 on struberg:&lt;a href=&quot;https://issues.apache.org/jira/browse/POOL-356&quot; title=&quot;deadlock if borrowObject gets called to fast and maxIdle is 0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;POOL-356&quot;&gt;&lt;del&gt;POOL-356&lt;/del&gt;&lt;/a&gt;&lt;/b&gt;* into *&lt;b&gt;d4e0e88227ad91d8c8ef36ba01d656f71c770f83 on apache:master&lt;/b&gt;*.&lt;/p&gt;
</comment>
                            <comment id="16662754" author="githubbot" created="Wed, 24 Oct 2018 19:45:46 +0000"  >&lt;p&gt;Github user coveralls commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/commons-pool/pull/11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-pool/pull/11&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;    [!&lt;span class=&quot;error&quot;&gt;&amp;#91;Coverage Status&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://coveralls.io/builds/19703092/badge)](https://coveralls.io/builds/19703092&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://coveralls.io/builds/19703092/badge)](https://coveralls.io/builds/19703092&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;    Coverage increased (+0.3%) to 85.174% when pulling *&lt;b&gt;016a1f67263fe1cde1d910dc7002d972811951c5 on struberg:&lt;a href=&quot;https://issues.apache.org/jira/browse/POOL-356&quot; title=&quot;deadlock if borrowObject gets called to fast and maxIdle is 0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;POOL-356&quot;&gt;&lt;del&gt;POOL-356&lt;/del&gt;&lt;/a&gt;&lt;/b&gt;* into *&lt;b&gt;d4e0e88227ad91d8c8ef36ba01d656f71c770f83 on apache:master&lt;/b&gt;*.&lt;/p&gt;
</comment>
                            <comment id="16666192" author="githubbot" created="Sat, 27 Oct 2018 19:03:54 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/commons-pool/pull/11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-pool/pull/11&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16934737" author="psteitz" created="Fri, 20 Sep 2019 20:25:58 +0000"  >&lt;p&gt;I am not sure this issue is really valid, but assuming there is a real use case to have maxIdle set to 0, the committed fix is not correct.&#160; create() can return null and that will result in NPE in the put to idleObjects.&#160; If I am missing something and it really does make sense to have minidle 0 (so you are basically just using the pool as an object factory), the correct fix is to call&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ensureIdle(1, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;); &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;after the call to destroy in returnObject (like it does for validation failures).&#160; That will be a no-op if create returns null.&lt;/p&gt;</comment>
                            <comment id="16935230" author="sazzad" created="Sun, 22 Sep 2019 07:00:11 +0000"  >&lt;p&gt;IMHO, it doesn&apos;t make any sense to &lt;tt&gt;create()&lt;/tt&gt; within &lt;tt&gt;destroy(p)&lt;/tt&gt;.&#160; For example, &lt;tt&gt;clear()&lt;/tt&gt; uses &lt;tt&gt;destroy(p)&lt;/tt&gt; and it&apos;s absurd to create same number of idle objects again. Even worse, doesn&apos;t this lead to an infinite loop?&lt;/p&gt;</comment>
                            <comment id="16937440" author="struberg" created="Wed, 25 Sep 2019 06:30:21 +0000"  >&lt;p&gt;Afair this is for ensuring some of our configuration. In pool you can configure that a pooled item has a maximum lifespan of n. So if you release the pooled item we check whether this time is over. And in that case we destroy it and create a fresh instance instead?&lt;/p&gt;</comment>
                            <comment id="16937941" author="psteitz" created="Wed, 25 Sep 2019 17:42:43 +0000"  >&lt;p&gt;The regression was fixed in&#160;0cdff0ade7e6a6ae2a48356e55d7549353535043&lt;/p&gt;

&lt;p&gt;The liveness issue originally called out here was also fixed.&#160;&#160;&lt;/p&gt;</comment>
                            <comment id="16938031" author="garydgregory" created="Wed, 25 Sep 2019 20:14:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=psteitz&quot; class=&quot;user-hover&quot; rel=&quot;psteitz&quot;&gt;psteitz&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Please update &lt;tt&gt;changes.xml&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13173190">DBCP-513</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="13258080">POOL-376</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                            <outwardlinks description="supercedes">
                                        <issuelink>
            <issuekey id="13080797">POOL-327</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 7 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3zkwf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>