<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:17:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[POOL-396] Exceptions in validation can cause an object&apos;s lifecycle to be stuck in EVICTION state</title>
                <link>https://issues.apache.org/jira/browse/POOL-396</link>
                <project id="12310488" key="POOL">Commons Pool</project>
                    <description>&lt;p&gt;Currently, if validation of an object throws an exception when testing an idle object during eviction, an exception will be thrown from the evict() method. This causes the object to be left in the EVICTION state, but still be present in the idleObjects queue.&lt;/p&gt;

&lt;p&gt;Future runs of the eviction thread will run into an infinite loop, because they pick up the afflicted object from the queue, fail to set its state to EVICTION, don&apos;t count it as a test, and repeat ad infinitum. This infinite loop means that no further evictions will take place; it also causes increases in garbage collection owing to allocation of the EvictionIterator on each loop iteration.&lt;/p&gt;

&lt;p&gt;This test added to TestGenericObjectPool (plus a small change allowing exceptions to be thrown from the validateObject method of SimpleFactory) reproduces the issue.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
@Timeout(value = 60000, unit = TimeUnit.MILLISECONDS)
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testExceptionInValidationDuringEviction() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    genericObjectPool.setMaxIdle(1);
    genericObjectPool.setMaxTotal(2);
    genericObjectPool.setNumTestsPerEvictionRun(1);
    genericObjectPool.setMinEvictableIdleTime(Duration.ofMillis(0));
    genericObjectPool.setTestWhileIdle(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);

    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; active = genericObjectPool.borrowObject();
    genericObjectPool.returnObject(active);

    simpleFactory.setThrowExceptionOnValidate(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);

    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        genericObjectPool.evict();
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
        &lt;span class=&quot;code-comment&quot;&gt;// OK that a given run fails. But the object should still be evicted.
&lt;/span&gt;    }
    genericObjectPool.evict(); &lt;span class=&quot;code-comment&quot;&gt;// currently fails: causes an infinite loop!
&lt;/span&gt;    assertEquals(0, genericObjectPool.getNumActive());
    assertEquals(0, genericObjectPool.getNumIdle());
}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It seems that protection against exceptions thrown by validation code exist elsewhere (e.g. in borrowObject()); similarly, protections against exceptions thrown by user eviction policy code exist in evict(). So it looks like the testWhileIdle() portion of evict() needs to similarly be protected.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;br/&gt;
Jeremy&lt;/p&gt;</description>
                <environment></environment>
        <key id="13383718">POOL-396</key>
            <summary>Exceptions in validation can cause an object&apos;s lifecycle to be stuck in EVICTION state</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="jeremyk-91">Jeremy Kong</reporter>
                        <labels>
                    </labels>
                <created>Mon, 14 Jun 2021 12:51:54 +0000</created>
                <updated>Tue, 22 Jun 2021 23:30:00 +0000</updated>
                            <resolved>Tue, 22 Jun 2021 23:30:00 +0000</resolved>
                                    <version>2.4.2</version>
                    <version>2.9.0</version>
                                    <fixVersion>2.11.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="2400">40m</timespent>
                                <comments>
                            <comment id="17362952" author="jeremyk-91" created="Mon, 14 Jun 2021 13:18:10 +0000"  >&lt;p&gt;I have proposed a fix in &lt;a href=&quot;https://github.com/apache/commons-pool/pull/85&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-pool/pull/85&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17363643" author="garydgregory" created="Tue, 15 Jun 2021 13:37:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=psteitz&quot; class=&quot;user-hover&quot; rel=&quot;psteitz&quot;&gt;psteitz&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Any thoughs on the PR?&lt;/p&gt;</comment>
                            <comment id="17364015" author="psteitz" created="Wed, 16 Jun 2021 02:22:02 +0000"  >&lt;p&gt;Nice work on the report and patch.&#160; &#160;Thanks especially for the unit test showing the bug.&#160; I have a couple of comments on the patch:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;We should remember to apply an analogous patch to GenericKeyedObjectPool, which is subject to the same issue.&lt;/li&gt;
	&lt;li&gt;I think it would be better to fix the eviction state of the object under test and rethrow the exception (like what borrowObject does when the instance failing validation has just been created) rather than swallowing the exception and destroying the instance under test.&#160;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;When I say &quot;fix the eviction state&quot; I mean basically just call endEvictionTest.&#160; My reasoning for this is that validation exceptions often indicate infrastructure issues that may be transient and that clients may want to know about.&#160; &#160;&lt;/p&gt;</comment>
                            <comment id="17364356" author="psteitz" created="Wed, 16 Jun 2021 15:54:44 +0000"  >&lt;p&gt;After sleeping on this, I think it is probably better to go ahead and destroy the instance before rethrowing the exception.&#160; We should also not decrement the numtests counter in this case.&lt;/p&gt;

&lt;p&gt;We should probably add prominent docs somewhere (site and javadoc) pointing out that factory methods should handle their own exceptions.&#160; We try to do reasonable things when they throw, but this case is a good example where we need the factory to tell us what to do.&lt;/p&gt;</comment>
                            <comment id="17364427" author="jeremyk-91" created="Wed, 16 Jun 2021 17:52:24 +0000"  >&lt;p&gt;I see, that makes sense. Yep, I&apos;ve updated the PR to do that, and added the analogous patch for GenericKeyedObjectPool (plus tests).&lt;/p&gt;

&lt;p&gt;Would NoSuchElementException be the right exception to throw in this case? I&apos;ve copied it from the existing validation failure handling code, though while that makes sense for e.g. borrowObject() I don&apos;t know if it does for evict().&lt;/p&gt;</comment>
                            <comment id="17366259" author="garydgregory" created="Sun, 20 Jun 2021 19:37:09 +0000"  >&lt;p&gt;Unless &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=psteitz&quot; class=&quot;user-hover&quot; rel=&quot;psteitz&quot;&gt;psteitz&lt;/a&gt;&#160;chimes back in with more suggestions or an answer to your question, I intent to merge the PR.&lt;/p&gt;</comment>
                            <comment id="17366264" author="psteitz" created="Sun, 20 Jun 2021 19:59:01 +0000"  >&lt;p&gt;Sorry for the slow response.&#160; Really nice work on this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jeremyk-91&quot; class=&quot;user-hover&quot; rel=&quot;jeremyk-91&quot;&gt;jeremyk-91&lt;/a&gt;.&#160; One small change (responding to your question above) is that I would just rethrow the original exception rather than wrapping in a NSEE.&#160; That makes sense on borrow, but here it&apos;s probably better to just propagate whatever was thrown by the factory.&#160; &#160;&lt;/p&gt;</comment>
                            <comment id="17366675" author="jeremyk-91" created="Mon, 21 Jun 2021 15:33:47 +0000"  >&lt;p&gt;No worries! That&apos;s good to hear. Yep, rethrowing seems reasonable - I&apos;ve added that.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 20 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0rxmg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>