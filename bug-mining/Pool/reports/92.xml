<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:16:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[POOL-231] GOP, GKOP invalidateObject is not threadsafe</title>
                <link>https://issues.apache.org/jira/browse/POOL-231</link>
                <project id="12310488" key="POOL">Commons Pool</project>
                    <description>&lt;p&gt;There does not appear to be sufficient sync protection for the destroyCount and createCount counters when destroy is activated by invalidateObject in GOP, GKOP, v2 trunk.  The test below fails when added to GOP tests. The destroyCount is over-incremented due (I think) to the fact that multiple threads can enter destroy before the object being invalidated is removed from allObjects.  This problem was originally reported by Thomas Neidhart in a comment on &lt;a href=&quot;https://issues.apache.org/jira/browse/POOL-213&quot; title=&quot;_numActive can go negative&quot; class=&quot;issue-link&quot; data-issue-key=&quot;POOL-213&quot;&gt;&lt;del&gt;POOL-213&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;@Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testConcurrentInvalidate() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-comment&quot;&gt;// Get allObjects and idleObjects loaded with some instances
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; nObjects = 1000;
        pool.setMaxTotal(nObjects);
        pool.setMaxIdle(nObjects);
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] obj = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[nObjects];
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; nObjects; i++) {
            obj[i] = pool.borrowObject();
        }
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; nObjects; i++) {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (i % 2 == 0) {
                pool.returnObject(obj[i]);
            }
        }
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; nThreads = 100;
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; nIterations = 100;
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; InvalidateThread[] threads = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; InvalidateThread[nThreads];
        &lt;span class=&quot;code-comment&quot;&gt;// Randomly generated list of distinct invalidation targets
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ArrayList&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;&amp;gt; targets = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;&amp;gt;();
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Random random = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Random();
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; j = 0; j &amp;lt; nIterations; j++) {
            &lt;span class=&quot;code-comment&quot;&gt;// Get a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; invalidation target
&lt;/span&gt;            &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; targ = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;(random.nextInt(nObjects));
            &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (targets.contains(targ)) {
                targ = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;(random.nextInt(nObjects));
            }
            targets.add(targ);
            &lt;span class=&quot;code-comment&quot;&gt;// Launch nThreads threads all trying to invalidate the target
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; nThreads; i++) {
                threads[i] = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; InvalidateThread(pool, obj[targ]);
            }
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; nThreads; i++) {
                &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;(threads[i]).start();
            }
            &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; done = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
            &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!done) {
                done = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
                &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; nThreads; i++) {
                    done = done &amp;amp;&amp;amp; threads[i].complete();
                }
                &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(100);
            }
        }
        Assert.assertEquals(nIterations, pool.getDestroyedCount());
    }
    
    &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;InvalidateThread &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; obj;
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; ObjectPool&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; pool;
        &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; done = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; InvalidateThread(ObjectPool&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; pool, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; obj) {
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.obj = obj;
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.pool = pool;
        }
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                pool.invalidateObject(obj);
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IllegalStateException ex) {
                &lt;span class=&quot;code-comment&quot;&gt;// Ignore
&lt;/span&gt;            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception ex) {
                Assert.fail(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unexpected exception &quot;&lt;/span&gt; + ex.toString());
            } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
                done = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
            }
        }
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; complete() {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; done;
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12618507">POOL-231</key>
            <summary>GOP, GKOP invalidateObject is not threadsafe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="psteitz">Phil Steitz</reporter>
                        <labels>
                    </labels>
                <created>Sun, 2 Dec 2012 20:46:32 +0000</created>
                <updated>Wed, 31 Dec 2014 16:22:49 +0000</updated>
                            <resolved>Sat, 29 Dec 2012 18:24:30 +0000</resolved>
                                    <version>Nightly Builds</version>
                                    <fixVersion>2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13508841" author="psteitz" created="Mon, 3 Dec 2012 16:38:05 +0000"  >&lt;p&gt;Sorry the original test that I included in the description (now edited) was incorrect.  Combining borrow / return loops caused duplicates in the obj array.  I am pretty sure now this is a bug and the description of how it happens is correct.  The test will pass if I patch invalidateObject in GOP to guard destroy(p) using p&apos;s monitor and include a second allObjects check:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (p) {
     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (allObjects.get(obj) != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) { 
         destroy(p);
     }
 }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That is probably not the best way to address the problem (probably better to somehow guard using PooledObject state); but I think it does show that there is a problem and where it is.&lt;/p&gt;</comment>
                            <comment id="13508945" author="tn" created="Mon, 3 Dec 2012 19:01:26 +0000"  >&lt;p&gt;I think the proposed change is correct:&lt;/p&gt;

&lt;p&gt;it will require two lookups in the allObjects map for the nominal case, but otoh will only need synchronization on the pooled object itself rather than the map.&lt;/p&gt;</comment>
                            <comment id="13509739" author="psteitz" created="Tue, 4 Dec 2012 13:54:00 +0000"  >&lt;p&gt;This is better:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (p) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (p.getState() != PooledObjectState.INVALID) { 
        destroy(p);
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13509876" author="markt" created="Tue, 4 Dec 2012 17:16:42 +0000"  >&lt;p&gt;+1 works for me&lt;/p&gt;</comment>
                            <comment id="13509891" author="psteitz" created="Tue, 4 Dec 2012 17:42:52 +0000"  >&lt;p&gt;OK, I will try to get a similar fix for GKOP, which I am sure has the same problem.  I am not in love with the factory method in any kind of sync scope, but I can&apos;t think of any way that contention for p&apos;s monitor could cause a problem, so I guess this is OK.&lt;/p&gt;</comment>
                            <comment id="13540954" author="psteitz" created="Sat, 29 Dec 2012 18:24:30 +0000"  >&lt;p&gt;Fixed in r1426799.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>293325</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 47 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0swqf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>166780</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>