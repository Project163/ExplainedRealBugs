<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:16:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[POOL-279] Thread concurrency issue in DefaultPooledObject.getIdleTimeMillis()</title>
                <link>https://issues.apache.org/jira/browse/POOL-279</link>
                <project id="12310488" key="POOL">Commons Pool</project>
                    <description>&lt;p&gt;Under unlucky thread concurrency the getIdleTimeMillis() method of DefaultPooledObject can return a negative value.&lt;br/&gt;
I have attached a Junit test that fails most of the times and a simple fix, that doesn&apos;t use synchronization: with this fix the Junit test always succeed.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12745971">POOL-279</key>
            <summary>Thread concurrency issue in DefaultPooledObject.getIdleTimeMillis()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="jacopoc">Jacopo Cappellato</reporter>
                        <labels>
                    </labels>
                <created>Sun, 5 Oct 2014 06:00:20 +0000</created>
                <updated>Wed, 31 Dec 2014 16:49:15 +0000</updated>
                            <resolved>Sun, 21 Dec 2014 20:33:09 +0000</resolved>
                                    <version>2.2</version>
                                    <fixVersion>2.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14159490" author="sebb@apache.org" created="Sun, 5 Oct 2014 09:43:09 +0000"  >&lt;p&gt;The code patch needs to be documented.&lt;br/&gt;
Without an explanation, the fetch appears to be redundant, so a later maintainer may decide to inline it.&lt;/p&gt;</comment>
                            <comment id="14159504" author="jacopoc" created="Sun, 5 Oct 2014 11:11:20 +0000"  >&lt;p&gt;New patch with a comment that explain the reason a copy of the field is taken; thanks to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sebb%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;sebb@apache.org&quot;&gt;sebb@apache.org&lt;/a&gt; for the review.&lt;/p&gt;</comment>
                            <comment id="14159512" author="sebb@apache.org" created="Sun, 5 Oct 2014 12:27:04 +0000"  >&lt;p&gt;Thanks, but it does not really explain why the time can be negative.&lt;/p&gt;

&lt;p&gt;AFAICT the problem is that the calculation:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;return System.currentTimeMillis() - lastReturnTime;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;will first fetch the current time, and then fetch lastReturnTime.&lt;br/&gt;
However this may have been updated in the meantime to a later time, hence the negative value.&lt;/p&gt;

&lt;p&gt;&lt;del&gt;Also, as has been pointed out on the dev list, there is a multi-threading issue - the field is not safely published, so it needs to be made volatile&lt;/del&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;The field is already volatile&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="14159523" author="jacopoc" created="Sun, 5 Oct 2014 13:41:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sebb%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;sebb@apache.org&quot;&gt;sebb@apache.org&lt;/a&gt; the field lastReturnTime is already volatile.&lt;br/&gt;
I am uploading a new patch with an expanded comment as you have recommended.&lt;/p&gt;</comment>
                            <comment id="14159525" author="jacopoc" created="Sun, 5 Oct 2014 13:48:00 +0000"  >&lt;p&gt;New patch with expanded comment.&lt;/p&gt;</comment>
                            <comment id="14161427" author="jacopoc" created="Tue, 7 Oct 2014 03:54:22 +0000"  >&lt;p&gt;Improved patch after the reviews received in the dev list: since the code in this method may still compute a negative value (if the JVM reorders the code in the method), if the value is negative then return 0.&lt;/p&gt;</comment>
                            <comment id="14161459" author="jacopoc" created="Tue, 7 Oct 2014 04:41:55 +0000"  >&lt;p&gt;Junit test&lt;/p&gt;</comment>
                            <comment id="14164510" author="sebb@apache.org" created="Thu, 9 Oct 2014 01:06:08 +0000"  >&lt;p&gt;Thanks for the test cse - very useful.&lt;/p&gt;

&lt;p&gt;I can confirm that the unit test exposes the bug (MacOSX/Java 6) and that taking a copy of lastReturnTime before the subtraction fixes the issue. Also, if the volatile attribute is dropped from the field, the bug returns.&lt;/p&gt;

&lt;p&gt;I did not test the case where System.currentTimeMillis() is non-monotonic.&lt;/p&gt;</comment>
                            <comment id="14165066" author="sebb@apache.org" created="Thu, 9 Oct 2014 12:17:34 +0000"  >&lt;p&gt;@&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jacopoc&quot; class=&quot;user-hover&quot; rel=&quot;jacopoc&quot;&gt;jacopoc&lt;/a&gt; Just noticed some odd code in the unit tests. The Runnable allocateAndDeallocateTask starts by performing the same test as getIdleTimeTask - why is that needed? Also, getIdleTimeTask exits the loop as soon as the first error is found, however that is not the case for allocateAndDeallocateTask. Why is that?&lt;/p&gt;

&lt;p&gt;It also occurs to me that it might be simpler to use the following code:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; elapsed = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis() - lastReturnTime;
&lt;span class=&quot;code-comment&quot;&gt;// elapsed may be negative &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;:
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// - another thread updates lastReturnTime during the calculation window
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// - &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis() is not monotonic (e.g. system time is set back)
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; elapsed &amp;gt;= 0 ? elapsed : 0;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14165109" author="jacopoc" created="Thu, 9 Oct 2014 13:04:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sebb%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;sebb@apache.org&quot;&gt;sebb@apache.org&lt;/a&gt; I can definitely refine the code in the tests: it is a result of a few attempts to recreate consistently the issue and I know it is not perfect. In particular, the return statements are not necessary but I have added them to terminate earlier the test if the error condition is met. However I didn&apos;t want to check the negativeIdleTimeReturned condition too often because this would increase the serialization of threads. But, especially if you are willing to commit the test in the trunk, I would be happy to clean it a bit.&lt;/p&gt;

&lt;p&gt;As regards the fix: I agree that your simplified code is better.&lt;/p&gt;</comment>
                            <comment id="14255267" author="psteitz" created="Sun, 21 Dec 2014 20:33:09 +0000"  >&lt;p&gt;Sebb&apos;s proposed code patch and slightly revised version of Jacopo&apos;s test committed in r1647206.  I tested fairly extensively using GOP borrow/return sequences in place of the direct allocate/deallocate and was not able to get a failure.  I am pretty sure it is not possible for this to happen with actual pool use, as per comments on the mailing list the state management will not allow the interleaving of calls necessary to get a negative value back from getIdleTimeMillis.&lt;/p&gt;

&lt;p&gt;I tried to simplify the test, but was not able to get consistent failures pre-patch when I pulled out the getIdleTimeMillis calls in the allocate/deallocate task.  I think what may be going on here is synchronization delays waiting on the system clock are necessary to get the &quot;bad&quot; sequence to happen.  I tried defining a third task that just hit the clock, but was not able to get the consistent failures that Jacopo&apos;s original generates.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12673290" name="POOL-279-unit-test.patch" size="4182" author="jacopoc" created="Tue, 7 Oct 2014 04:41:55 +0000"/>
                            <attachment id="12673287" name="POOL-279.patch" size="964" author="jacopoc" created="Tue, 7 Oct 2014 03:54:22 +0000"/>
                            <attachment id="12672993" name="POOL-279.patch" size="894" author="jacopoc" created="Sun, 5 Oct 2014 13:48:00 +0000"/>
                            <attachment id="12672991" name="POOL-279.patch" size="625" author="jacopoc" created="Sun, 5 Oct 2014 11:11:20 +0000"/>
                            <attachment id="12672980" name="POOL-279.patch" size="4757" author="jacopoc" created="Sun, 5 Oct 2014 06:02:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 47 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i20t67:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>