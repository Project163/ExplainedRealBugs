<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:16:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[POOL-338] GenericObjectPool constructor may throw an exception under OSGi</title>
                <link>https://issues.apache.org/jira/browse/POOL-338</link>
                <project id="12310488" key="POOL">Commons Pool</project>
                    <description>&lt;p&gt;Version 2.4.3 GenericObjectPool constructor throws this exception:&lt;/p&gt;



&lt;p&gt;&lt;tt&gt;java.lang.IllegalArgumentException: &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.commons.pool2.impl.DefaultEvictionPolicy&amp;#93;&lt;/span&gt; does not implement EvictionPolicy&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160;&#160; &#160;at org.apache.commons.pool2.impl.BaseGenericObjectPool.setEvictionPolicyClassName(BaseGenericObjectPool.java:618)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160;&#160; &#160;at org.apache.commons.pool2.impl.GenericObjectPool.setConfig(GenericObjectPool.java:318)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160;&#160; &#160;at org.apache.commons.pool2.impl.GenericObjectPool.&amp;lt;init&amp;gt;(GenericObjectPool.java:115)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160;&#160; &#160;at org.apache.commons.pool2.impl.GenericObjectPool.&amp;lt;init&amp;gt;(GenericObjectPool.java:88)&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Version 2.5.0 throws the same exception. Version 2.4.2 or older&apos;s setEvictionPolicyClassName method fail silently for the same reason. This line in&#160;BaseGenericObjectPool evaluates to false for all versions:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (policy instanceof EvictionPolicy&amp;lt;?&amp;gt;) {&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Java 8, Liferay DXP (an OSGi environment).&lt;/p&gt;</environment>
        <key id="13150113">POOL-338</key>
            <summary>GenericObjectPool constructor may throw an exception under OSGi</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ggregory">Gary D. Gregory</assignee>
                                    <reporter username="mcgitty">Michael C</reporter>
                        <labels>
                    </labels>
                <created>Wed, 4 Apr 2018 18:51:57 +0000</created>
                <updated>Mon, 28 May 2018 13:47:09 +0000</updated>
                            <resolved>Sun, 27 May 2018 16:18:59 +0000</resolved>
                                    <version>2.4.2</version>
                    <version>2.4.3</version>
                    <version>2.5.0</version>
                                    <fixVersion>2.6.0</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16426123" author="garydgregory" created="Wed, 4 Apr 2018 20:19:06 +0000"  >&lt;p&gt;I wonder if this is a class loader issue. Can you describe your environment?&lt;/p&gt;</comment>
                            <comment id="16427292" author="mcgitty" created="Thu, 5 Apr 2018 17:22:55 +0000"  >&lt;p&gt;It is possible. This exception is observed from Liferay DXP, an OSGi environment.&lt;/p&gt;</comment>
                            <comment id="16427303" author="garydgregory" created="Thu, 5 Apr 2018 17:38:11 +0000"  >&lt;p&gt;You can see from the source code that &lt;tt&gt;org.apache.commons.pool2.impl.DefaultEvictionPolicy&lt;/tt&gt;&#160;does implement &lt;tt&gt;org.apache.commons.pool2.impl.EvictionPolicy&lt;/tt&gt;, so this should be a class loader issue...&lt;/p&gt;</comment>
                            <comment id="16427368" author="garydgregory" created="Thu, 5 Apr 2018 18:04:22 +0000"  >&lt;p&gt;I&apos;ve improved the exception messages in &lt;tt&gt;org.apache.commons.pool2.impl.BaseGenericObjectPool.setEvictionPolicyClassName(String)&lt;/tt&gt; to include the FQN of the &lt;tt&gt;EvictionPolicy&lt;/tt&gt; interface: &lt;tt&gt;apache.commons.pool2.impl.EvictionPolicy&lt;/tt&gt;. This won&apos;t fix anything for you but it will make it clear what the excepted interface the given class has to implement.&lt;/p&gt;

&lt;p&gt;The next improvement would be to include in the message some class loader information... suggestions welcome.&lt;/p&gt;</comment>
                            <comment id="16427494" author="mcgitty" created="Thu, 5 Apr 2018 19:42:55 +0000"  >&lt;p&gt;Eclipse debugger shows while at that if statement:&lt;/p&gt;


&lt;p&gt;&lt;tt&gt;clazz: class org.apache.commons.pool2.impl.DefaultEvictionPolicy&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;policy: org.apache.commons.pool2.impl.DefaultEvictionPolicy@4591dc8f&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;evictionPolicyClassName: &quot;org.apache.commons.pool2.impl.DefaultEvictionPolicy&quot;&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Looks good to me symbolically. May be I should write a unit test ...&lt;/p&gt;</comment>
                            <comment id="16427516" author="garydgregory" created="Thu, 5 Apr 2018 20:01:59 +0000"  >&lt;p&gt;You can also use the 2.5.1-SNAPSHOT version or our sources directly to get the latest code.&lt;/p&gt;</comment>
                            <comment id="16429162" author="garydgregory" created="Sat, 7 Apr 2018 00:20:42 +0000"  >&lt;p&gt;When you are at &lt;a href=&quot;https://issues.apache.org/jira/browse/POOL-338?focusedCommentId=16427494&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16427494&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/POOL-338?focusedCommentId=16427494&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16427494&lt;/a&gt;&#160;it would be interesting to see the class loader for each object&apos;s class.&lt;/p&gt;</comment>
                            <comment id="16429206" author="garydgregory" created="Sat, 7 Apr 2018 02:37:32 +0000"  >&lt;p&gt;Can you please try again with 2.5.1-SNAPSHOT? I added information about class loaders to exception message when the instance created does not implement the expected interface &lt;tt&gt;EvictionPolicy&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16430519" author="mcgitty" created="Mon, 9 Apr 2018 13:23:20 +0000"  >&lt;p&gt;Nice touch. Here is the new log that shows two class loaders:&lt;/p&gt;

&lt;p&gt;java.lang.IllegalArgumentException: Class org.apache.commons.pool2.impl.DefaultEvictionPolicy from class loader &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread context class loader: org.eclipse.osgi.internal.framework.ContextFinder@383d49e2&amp;#93;&lt;/span&gt; does not implement org.apache.commons.pool2.impl.EvictionPolicy from class loader [org.eclipse.osgi.internal.loader.EquinoxClassLoader@d099faf&lt;span class=&quot;error&quot;&gt;&amp;#91;com.rivetlogic.liferay.store.box:1.0.0(id=42)&amp;#93;&lt;/span&gt;]&lt;/p&gt;

&lt;p&gt;Since the error came from line 618 &lt;em&gt;&lt;tt&gt;if (policy instanceof EvictionPolicy&amp;lt;?&amp;gt;)&lt;/tt&gt;&lt;/em&gt;, it makes sense to me to use the same class loader of EvictionPolicy to load &lt;em&gt;&lt;tt&gt;policy&lt;/tt&gt;&lt;/em&gt; in line 608:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&#160;&#160;&#160; final ClassLoader classLoader = EvictionPolicy.class.getClassLoader();&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;It works in my OSGi environment.&lt;/p&gt;</comment>
                            <comment id="16430654" author="mcgitty" created="Mon, 9 Apr 2018 15:05:37 +0000"  >&lt;p&gt;I also question using &lt;tt&gt;Class.forName&lt;/tt&gt; to create &lt;tt&gt;EvictionPolicy&lt;/tt&gt;. All these class loader trouble actually makes the API harder to use compare to just a &lt;tt&gt;setEvictionPolicy(EvictionPolicy&amp;lt;?&amp;gt;)&lt;/tt&gt; method. For example, you cannot have a class that extends &lt;tt&gt;GenericObjectPoolConfig&lt;/tt&gt; also implements &lt;tt&gt;EvictionPolicy&lt;/tt&gt;, because the former must be instantiated first with all the customization needed.&lt;/p&gt;</comment>
                            <comment id="16431213" author="garydgregory" created="Mon, 9 Apr 2018 20:52:04 +0000"  >&lt;p&gt;Can you try the following on top of out git master:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;diff --git a/pom.xml b/pom.xml
index f913e97..cc8f799 100644
--- a/pom.xml
+++ b/pom.xml
@@ -26,7 +26,7 @@
   &amp;lt;/parent&amp;gt;
   &amp;lt;modelVersion&amp;gt;4.0.0&amp;lt;/modelVersion&amp;gt;
   &amp;lt;artifactId&amp;gt;commons-pool2&amp;lt;/artifactId&amp;gt;
-  &amp;lt;version&amp;gt;2.5.1-SNAPSHOT&amp;lt;/version&amp;gt;
+  &amp;lt;version&amp;gt;2.6.0-SNAPSHOT&amp;lt;/version&amp;gt;
   &amp;lt;name&amp;gt;Apache Commons Pool&amp;lt;/name&amp;gt;
 
   &amp;lt;inceptionYear&amp;gt;2001&amp;lt;/inceptionYear&amp;gt;
diff --git a/src/main/java/org/apache/commons/pool2/impl/BaseGenericObjectPool.java b/src/main/java/org/apache/commons/pool2/impl/BaseGenericObjectPool.java
index d9a4df7..af332ce 100644
--- a/src/main/java/org/apache/commons/pool2/impl/BaseGenericObjectPool.java
+++ b/src/main/java/org/apache/commons/pool2/impl/BaseGenericObjectPool.java
@@ -589,30 +589,46 @@
     }
 
     /**
-     * Sets the name of the {@link EvictionPolicy} implementation that is
-     * used by this pool. The Pool will attempt to load the class using the
-     * thread context class loader. If that fails, the Pool will attempt to load
-     * the class using the class loader that loaded this class.
+     * Sets the eviction policy for this pool.
+     * 
+     * @param evictionPolicy
+     *            the eviction policy for this pool.
+     * @since 2.6.0
+     */
+    public void setEvictionPolicy(EvictionPolicy&amp;lt;T&amp;gt; evictionPolicy) {
+        this.evictionPolicy = evictionPolicy;
+    }
+
+
+    /**
+     * Sets the name of the {@link EvictionPolicy} implementation that is used by this pool. The Pool will attempt to
+     * load the class using the given class loader. If that fails, use the class loader for the {@link EvictionPolicy}
+     * interface.
      *
-     * @param evictionPolicyClassName   the fully qualified class name of the
-     *                                  new eviction policy
+     * @param evictionPolicyClassName
+     *            the fully qualified class name of the new eviction policy
+     * @param classLoader
+     *            the class loader to load the given {@code evictionPolicyClassName}.
      *
      * @see #getEvictionPolicyClassName()
+     * @since 2.6.0 If loading the class using the given class loader fails, use the class loader for the
+     *        {@link EvictionPolicy} interface.
      */
-    public final void setEvictionPolicyClassName(final String evictionPolicyClassName) {
-        final String EVICTION_POLICY_TYPE_NAME = EvictionPolicy.class.getName();
+    public final void setEvictionPolicyClassName(final String evictionPolicyClassName, final ClassLoader classLoader) {
+        @SuppressWarnings(&quot;rawtypes&quot;)
+        final Class&amp;lt;EvictionPolicy&amp;gt; INTERFACE_TYPE = EvictionPolicy.class;
+        final String EVICTION_POLICY_TYPE_NAME = INTERFACE_TYPE.getName();
         final String exMessage = &quot;Unable to create &quot; + EVICTION_POLICY_TYPE_NAME + &quot; instance of type &quot;
                 + evictionPolicyClassName;
         try {
             Class&amp;lt;?&amp;gt; clazz;
-            final ClassLoader classLoader = Thread.currentThread().getContextClassLoader();
             String epcnClassLoaderDesc;
             try {
-                epcnClassLoaderDesc = &quot;Thread context class loader: &quot; + classLoader;
+                epcnClassLoaderDesc = &quot;Class loader: &quot; + classLoader;
                 clazz = Class.forName(evictionPolicyClassName, true, classLoader);
             } catch (final ClassNotFoundException e) {
-                epcnClassLoaderDesc = &quot;Default class loader&quot;;
-                clazz = Class.forName(evictionPolicyClassName);
+                epcnClassLoaderDesc = EVICTION_POLICY_TYPE_NAME + &quot; class loader&quot;;
+                clazz = Class.forName(evictionPolicyClassName, true, INTERFACE_TYPE.getClassLoader());
             }
             final Object policy = clazz.getConstructor().newInstance();
             if (policy instanceof EvictionPolicy&amp;lt;?&amp;gt;) {
@@ -622,7 +638,7 @@
             } else {
                 throw new IllegalArgumentException(&quot;Class &quot; + evictionPolicyClassName + &quot; from class loader [&quot;
                         + epcnClassLoaderDesc + &quot;] does not implement &quot; + EVICTION_POLICY_TYPE_NAME
-                        + &quot; from class loader [&quot; + EvictionPolicy.class.getClassLoader() + &quot;]&quot;);
+                        + &quot; from class loader [&quot; + INTERFACE_TYPE.getClassLoader() + &quot;]&quot;);
             }
         } catch (final ClassNotFoundException | InstantiationException | IllegalAccessException
                 | InvocationTargetException | NoSuchMethodException e) {
@@ -631,6 +647,22 @@
     }
 
     /**
+     * Sets the name of the {@link EvictionPolicy} implementation that is used by this pool. The Pool will attempt to
+     * load the class using the thread context class loader. If that fails, the use the class loader for the
+     * {@link EvictionPolicy} interface.
+     *
+     * @param evictionPolicyClassName
+     *            the fully qualified class name of the new eviction policy
+     *
+     * @see #getEvictionPolicyClassName()
+     * @since 2.6.0 If loading the class using the thread context class loader fails, use the class loader for the
+     *        {@link EvictionPolicy} interface.
+     */
+    public final void setEvictionPolicyClassName(final String evictionPolicyClassName) {
+        setEvictionPolicyClassName(evictionPolicyClassName, Thread.currentThread().getContextClassLoader());
+    }
+    
+    /**
      * Gets the timeout that will be used when waiting for the Evictor to
      * shutdown if this pool is closed and it is the only pool still using the
      * the value for the Evictor.
@@ -1317,4 +1349,5 @@
         builder.append(swallowedExceptionListener);
     }
 
+
 }
diff --git a/src/test/java/org/apache/commons/pool2/impl/TestGenericObjectPool.java b/src/test/java/org/apache/commons/pool2/impl/TestGenericObjectPool.java
index 0abc55b..915e083 100644
--- a/src/test/java/org/apache/commons/pool2/impl/TestGenericObjectPool.java
+++ b/src/test/java/org/apache/commons/pool2/impl/TestGenericObjectPool.java
@@ -1073,6 +1073,9 @@
             // expected
         }
 
+        genericObjectPool.setEvictionPolicy(new TestEvictionPolicy&amp;lt;String&amp;gt;());
+        assertEquals(TestEvictionPolicy.class.getName(), genericObjectPool.getEvictionPolicyClassName());
+
         genericObjectPool.setEvictionPolicyClassName(TestEvictionPolicy.class.getName());
         assertEquals(TestEvictionPolicy.class.getName(), genericObjectPool.getEvictionPolicyClassName());
 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16431549" author="mcgitty" created="Tue, 10 Apr 2018 00:24:39 +0000"  >&lt;p&gt;Your diff won&apos;t help my use case of calling default constructor &lt;tt&gt;GenericObjectPool()&lt;/tt&gt;. See the original stack trace. It is not the class loader that throws the exception. It is the &lt;tt&gt;if (policy instanceof EvictionPolicy&amp;lt;?&amp;gt;)&lt;/tt&gt; line evaluates to false for whatever odd reason.&lt;/p&gt;

&lt;p&gt;Nice addition to the 2.6 API, but consider adding:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&#160;&#160;&#160; BaseObjectPoolConfig.setEvictionPolicy(EvictionPolicy&amp;lt;T&amp;gt; evictionPolicy)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160;&#160;&#160; BaseObjectPoolConfig.getEvictionPolicy()&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;plus the logic that favors a not null &lt;tt&gt;evictionPolicy&lt;/tt&gt; over &lt;tt&gt;evictionPolicyClassName&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16434096" author="garydgregory" created="Wed, 11 Apr 2018 15:52:22 +0000"  >&lt;p&gt;Ah, yes, the ctor... please try the attached patch &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12924774/12924774_commons-pool-gg.patch&quot; title=&quot;commons-pool-gg.patch attached to POOL-338&quot;&gt;commons-pool-gg.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;In the 2.x version, we have to keep backward compatibility in mind. This patch will use the class name only if the class name is different from the default class name.&lt;/p&gt;

&lt;p&gt;Gary&lt;/p&gt;</comment>
                            <comment id="16435697" author="mcgitty" created="Thu, 12 Apr 2018 14:38:35 +0000"  >&lt;p&gt;The issue steams from the &lt;tt&gt;instancesof&lt;/tt&gt; check. Why not work on the &lt;tt&gt;else&lt;/tt&gt; block with the following, which gives the method a 3rd chance to succeed (diff with commit&#160;&lt;tt&gt;d0f2514&lt;/tt&gt; on April 5). Avoiding an incorrectly thrown exception should not be considered as breaking backward compatibility:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;diff BaseGenericObjectPool.java-d0f2514 BaseGenericObjectPool.java
623c623,628
&amp;lt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; throw new IllegalArgumentException(&quot;Class &quot; + evictionPolicyClassName + &quot; from class loader [&quot;
---
&amp;gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; final ClassLoader epClassLoader = EvictionPolicy.class.getClassLoader();
&amp;gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; clazz = Class.forName(evictionPolicyClassName, true, epClassLoader);
&amp;gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; try {
&amp;gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; this.evictionPolicy = (EvictionPolicy&amp;lt;T&amp;gt;)clazz.newInstance();
&amp;gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; } catch (Exception e) {
&amp;gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; throw new IllegalArgumentException(&quot;Class &quot; + evictionPolicyClassName + &quot; from class loader [&quot;
625c630,631
&amp;lt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; + &quot; from class loader [&quot; + EvictionPolicy.class.getClassLoader() + &quot;]&quot;);
---
&amp;gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; + &quot; from class loader [&quot; + epClassLoader + &quot;]&quot;);
&amp;gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I will comment on the 2.6 API separately.&lt;/p&gt;</comment>
                            <comment id="16435701" author="garydgregory" created="Thu, 12 Apr 2018 14:42:08 +0000"  >&lt;p&gt;I see what you mean here,&#160;but.. I would like you to try my patch (&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12918586/commons-pool-gg.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12918586/commons-pool-gg.patch&lt;/a&gt;) as it introduces your idea that I do want to have, namely adding:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&#160;&#160;&#160; BaseObjectPoolConfig.setEvictionPolicy(EvictionPolicy&amp;lt;T&amp;gt; evictionPolicy)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160;&#160;&#160; BaseObjectPoolConfig.getEvictionPolicy()&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;Gary&lt;/p&gt;</comment>
                            <comment id="16436374" author="mcgitty" created="Thu, 12 Apr 2018 22:10:08 +0000"  >&lt;p&gt;The patch doesn&apos;t work for me, because you missed the logic that favors &lt;tt&gt;evictionPolicy&lt;/tt&gt; in &lt;tt&gt;GenericObjectPool.setConfig()&lt;/tt&gt;. Even for &lt;tt&gt;GenericKeyedObjectPool.setConfig()&lt;/tt&gt;, I believe favoring &lt;tt&gt;evictionPolicy&lt;/tt&gt; should simply be:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;@@ -238,7 +238,7 @@
      *
      * @see GenericKeyedObjectPoolConfig
      */
-    public void setConfig(final GenericKeyedObjectPoolConfig conf) {
+    public void setConfig(final GenericKeyedObjectPoolConfig&amp;lt;T&amp;gt; conf) {
         setLifo(conf.getLifo());
         setMaxIdlePerKey(conf.getMaxIdlePerKey());
         setMaxTotalPerKey(conf.getMaxTotalPerKey());
@@ -256,7 +256,14 @@
                 conf.getSoftMinEvictableIdleTimeMillis());
         setTimeBetweenEvictionRunsMillis(
                 conf.getTimeBetweenEvictionRunsMillis());
-        setEvictionPolicyClassName(conf.getEvictionPolicyClassName());
+        final EvictionPolicy&amp;lt;T&amp;gt; policy = conf.getEvictionPolicy();
+        if (policy == null) {
+            // Use the class name
+            setEvictionPolicyClassName(conf.getEvictionPolicyClassName());
+        } else {
+            // Otherwise, use the class
+            setEvictionPolicy(policy);
+        }
         setEvictorShutdownTimeoutMillis(conf.getEvictorShutdownTimeoutMillis());
     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;That does not break compatibility, because &lt;tt&gt;BaseObjectPoolConfig.evictionPolicy&lt;/tt&gt; is new in 2.6.&lt;/p&gt;

&lt;p&gt;Speaking of the 2.6 API, if anything, this bug tells us to avoid class loaders. Here are my assessments:&lt;/p&gt;

&lt;p&gt;1) This static member may be &lt;em&gt;created&lt;/em&gt; by an unknown thread:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;+ static final Class&amp;lt;EvictionPolicy&amp;gt; EVICTION_POLICY_TYPE = EvictionPolicy.class;&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;What is &lt;tt&gt;EVICTION_POLICY_TYPE.getClassLoader()&lt;/tt&gt;? Is it from that unknown thread or the default class loader?&lt;/p&gt;

&lt;p&gt;2) What is the value of &lt;tt&gt;BaseGenericObjectPool.setEvictionPolicyClass()&lt;/tt&gt; when you already have the &lt;tt&gt;setEvictionPolicy()&lt;/tt&gt; pair? It&apos;s one more potential problem down the road.&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="16487500" author="garydgregory" created="Wed, 23 May 2018 15:44:16 +0000"  >&lt;p&gt;I&apos;m finally coming back around to this. I am updating the patch attached to this ticket to account for the patch in your previous comment as well as some other minor clean ups.&lt;/p&gt;

&lt;p&gt;May you please test again and report here?&lt;/p&gt;

&lt;p&gt;WRT to your question (1): The reference is &lt;a href=&quot;https://docs.oracle.com/javase/specs/jls/se8/html/jls-12.html#jls-12.4.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/javase/specs/jls/se8/html/jls-12.html#jls-12.4.2&lt;/a&gt; (no time to dig in)&lt;/p&gt;

&lt;p&gt;WRT to your question (2): We could just remove &lt;tt&gt;BaseGenericObjectPool.setEvictionPolicyClass()&lt;/tt&gt; as a YAGNI.&lt;/p&gt;</comment>
                            <comment id="16490206" author="mcgitty" created="Fri, 25 May 2018 04:19:00 +0000"  >&lt;p&gt;The patch you posted yesterday (5/23) still does not help me. I posted &lt;b&gt;two&lt;/b&gt; separate comments on 5/12. Please revisit both again. Both offer backward compatible solutions in two different places.&lt;/p&gt;

&lt;p&gt;See the stack trace in the original bug description. I am using &lt;em&gt;DefaultEvictionPolicy&lt;/em&gt; instantiated in my code, so this if statement in your diff won&apos;t my &lt;em&gt;DefaultEvictionPolicy&lt;/em&gt;:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+        // Maintain compatibility:
+        if (!BaseObjectPoolConfig.DEFAULT_EVICTION_POLICY_CLASS_NAME.equals(conf.getEvictionPolicyClassName())) {
+            // Use the class name if it is not the default
+            setEvictionPolicyClassName(conf.getEvictionPolicyClassName());
+        } else {
+            // Otherwise, use the class
+            setEvictionPolicy(conf.getEvictionPolicy());
+        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Again, both changes in my 5/12 comments are backward compatible, and suggestion 1) and 2) in the second comment should be reconsidered.&lt;/p&gt;</comment>
                            <comment id="16490639" author="garydgregory" created="Fri, 25 May 2018 12:24:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mcgitty&quot; class=&quot;user-hover&quot; rel=&quot;mcgitty&quot;&gt;mcgitty&lt;/a&gt;: Please provide a patch or PR &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; on top of git master.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/commons-pool/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-pool/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16491136" author="mcgitty" created="Fri, 25 May 2018 18:30:14 +0000"  >&lt;p&gt;Attached &lt;em&gt;commons-pool-mc.patch&lt;/em&gt; has these key changes compared to &lt;em&gt;commons-pool-gg.patch&lt;/em&gt;:&lt;/p&gt;

&lt;p&gt;1) &lt;tt&gt;BaseGenericObjectPool.setEvictionPolicyClassName(,)&lt;/tt&gt; now uses &lt;tt&gt;epClass.isInstance(policy)&lt;/tt&gt; instead of &lt;em&gt;instanceof&lt;/em&gt; to safe-guard casting, which proved to be more robust in multiple class loaders environments like OSGi.&lt;/p&gt;

&lt;p&gt;2) &lt;tt&gt;epClass&lt;/tt&gt; is created at method call time instead of a static variable, which also contributes to the success of &lt;tt&gt;epClass.isInstance(policy)&lt;/tt&gt; in 1).&lt;/p&gt;

&lt;p&gt;3) &lt;tt&gt;BaseObjectPoolConfig.evictionPolicy&lt;/tt&gt; default to &lt;em&gt;null&lt;/em&gt; to provide backward compatibility to pre-2.6 versions.&lt;/p&gt;

&lt;p&gt;4) &lt;tt&gt;setConfig()&lt;/tt&gt; of both &lt;tt&gt;GenericKeyedObjectPool&lt;/tt&gt; and &lt;tt&gt;GenericObjectPool&lt;/tt&gt; uses the &lt;em&gt;evictionPolicy&lt;/em&gt; being null to preserve backward compatibility to pre-2.6 while giving precedence to 2.6 applications that explicitly set &lt;em&gt;evictionPolicy&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;5) Included other minor optimizations.&lt;/p&gt;</comment>
                            <comment id="16491690" author="garydgregory" created="Sat, 26 May 2018 15:02:38 +0000"  >&lt;p&gt;In git master and now under 2.6.0-SNAPSHOT since we are adding public APIs to set the eviction policy directly.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mcgitty&quot; class=&quot;user-hover&quot; rel=&quot;mcgitty&quot;&gt;mcgitty&lt;/a&gt;: Please review and close this ticket.&lt;/p&gt;</comment>
                            <comment id="16491749" author="mcgitty" created="Sat, 26 May 2018 17:29:59 +0000"  >&lt;p&gt;I don&apos;t see 2.6.0-SNAPSHOT yet for some reason. &lt;/p&gt;

&lt;p&gt;For 2.5.x, I just attached commons-pool-2.5.1.patch. It uses a different try block for &lt;tt&gt;BaseGenericObjectPool.setEvictionPolicyClassName(String)&lt;/tt&gt; with the help of a private method. Compared to the 2.6 patch, this is actually cleaner. I may submit this for 2.6 later.&lt;/p&gt;</comment>
                            <comment id="16491786" author="mcgitty" created="Sat, 26 May 2018 18:55:10 +0000"  >&lt;p&gt;Turns out &lt;em&gt;commons-pool-mm.patch&lt;/em&gt; applied to master does not resolve the original problem of GenericObjectPoll constructor. The alternative &lt;tt&gt;epClassLoader&lt;/tt&gt; in &lt;tt&gt;BaseGenericObjectPool.setEvictionPolicyClassName(,)&lt;/tt&gt; is never used, because execution never reaches the inner-most catch.&lt;/p&gt;

&lt;p&gt;Therefore, we need the same thing from &lt;em&gt;commons-pool-2.5.1.patch&lt;/em&gt; for 2.6, which is attached as &lt;em&gt;commons-pool-2.6.0.patch&lt;/em&gt;. I don&apos;t see a way to submit PR, probably because I am not a committer.&lt;/p&gt;</comment>
                            <comment id="16492081" author="garydgregory" created="Sun, 27 May 2018 16:18:59 +0000"  >&lt;p&gt;Setting to &lt;tt&gt;Resolved&lt;/tt&gt;: Committed to git master patch &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12925260/12925260_commons-pool-2.6.0.patch&quot; title=&quot;commons-pool-2.6.0.patch attached to POOL-338&quot;&gt;commons-pool-2.6.0.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Note that we are going from version 2.5.0 to 2.6.0 since we&apos;ve added new public APIs. There will not be a 2.5.1 (as of now.)&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mcgitty&quot; class=&quot;user-hover&quot; rel=&quot;mcgitty&quot;&gt;mcgitty&lt;/a&gt;: Please verify and close if appropriate.&lt;/p&gt;

&lt;p&gt;Thank you,&lt;/p&gt;

&lt;p&gt;Gary&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12925256" name="commons-pool-2.5.1.patch" size="5149" author="mcgitty" created="Sat, 26 May 2018 17:24:18 +0000"/>
                            <attachment id="12925260" name="commons-pool-2.6.0.patch" size="3706" author="mcgitty" created="Sat, 26 May 2018 18:55:23 +0000"/>
                            <attachment id="12924774" name="commons-pool-gg.patch" size="20324" author="ggregory" created="Wed, 23 May 2018 16:02:39 +0000"/>
                            <attachment id="12925189" name="commons-pool-mc.patch" size="20764" author="mcgitty" created="Fri, 25 May 2018 18:47:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 24 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3s5k7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>