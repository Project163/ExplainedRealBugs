{"url":"https://api.github.com/repos/paramiko/paramiko/issues/1963","repository_url":"https://api.github.com/repos/paramiko/paramiko","labels_url":"https://api.github.com/repos/paramiko/paramiko/issues/1963/labels{/name}","comments_url":"https://api.github.com/repos/paramiko/paramiko/issues/1963/comments","events_url":"https://api.github.com/repos/paramiko/paramiko/issues/1963/events","html_url":"https://github.com/paramiko/paramiko/issues/1963","id":1092350522,"node_id":"I_kwDOAAHTOc5BG_I6","number":1963,"title":"Regression in 2.9.x - authentication with signed ssh key fails","user":{"login":"forsberg","id":109604,"node_id":"MDQ6VXNlcjEwOTYwNA==","avatar_url":"https://avatars.githubusercontent.com/u/109604?v=4","gravatar_id":"","url":"https://api.github.com/users/forsberg","html_url":"https://github.com/forsberg","followers_url":"https://api.github.com/users/forsberg/followers","following_url":"https://api.github.com/users/forsberg/following{/other_user}","gists_url":"https://api.github.com/users/forsberg/gists{/gist_id}","starred_url":"https://api.github.com/users/forsberg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/forsberg/subscriptions","organizations_url":"https://api.github.com/users/forsberg/orgs","repos_url":"https://api.github.com/users/forsberg/repos","events_url":"https://api.github.com/users/forsberg/events{/privacy}","received_events_url":"https://api.github.com/users/forsberg/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2022-01-03T09:25:36Z","updated_at":"2022-03-18T20:56:02Z","closed_at":"2022-03-18T20:56:02Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I'm using signed ssh keys to authenticate to a host. This has worked flawlessly up until Paramiko 2.8.1, but with 2.9.0 and 2.9.1 it fails.\r\n\r\nExample program:\r\n\r\n```python\r\nimport os\r\nimport sys\r\nimport paramiko\r\nimport logging\r\n\r\nscript_dir = os.path.dirname(os.path.abspath(__file__))\r\n\r\ndef try_connect(hostname):\r\n    logging.basicConfig(level=logging.DEBUG, stream=sys.stderr)\r\n\r\n    client = paramiko.SSHClient()\r\n    client.set_missing_host_key_policy(paramiko.AutoAddPolicy())\r\n\r\n    proxy_command = os.path.join(script_dir, \"../../../ssh/proxy-command\")\r\n\r\n    sock = paramiko.ProxyCommand(f\"{proxy_command} {hostname}\")\r\n\r\n    client.connect(hostname, 22, username=\"root\", sock=sock, key_filename=\"/home/forsberg/.ssh/robot-test-cert.pub\")\r\n\r\nif __name__ == \"__main__\":\r\n    try_connect(sys.argv[1])\r\n```\r\n\r\n1. The proxy command is just a netcat forwarding the TCP packets, and is probably not important anyway in this context.\r\n2. `robot-test-cert.pub` is signed via ssh-keygen, and has the following metadata:\r\n\r\n```\r\nssh-keygen -Lf ~/.ssh/robot-test-cert.pub \r\n/home/forsberg/.ssh/robot-test-cert.pub:\r\n        Type: ssh-rsa-cert-v01@openssh.com user certificate\r\n        Public key: RSA-CERT SHA256:JtAqrYvjJBLxkXDeSkXEuGyTR9uykjzaqlGIExjFi/g\r\n        Signing CA: RSA SHA256:E5U81luuNJQIojmQVtDNfnKa4s89Q1gMTOIDqhk1jJE (using ssh-rsa)\r\n        Key ID: \"erik.forsberg\"\r\n        Serial: 1\r\n        Valid: from 2022-01-02T09:36:22 to 2022-01-10T09:36:22\r\n        Principals: \r\n                root\r\n                ssh_gate\r\n        Critical Options: (none)\r\n        Extensions: \r\n                permit-X11-forwarding\r\n                permit-agent-forwarding\r\n                permit-port-forwarding\r\n                permit-pty\r\n                permit-user-rc\r\n```\r\n\r\nRunning this program with paramiko 2.8.1 gives the following output:\r\n\r\n```\r\npython ssh_via_paramiko hostname.example.com\r\nDEBUG:paramiko.transport:starting thread (client mode): 0xb8e398b0\r\nDEBUG:paramiko.transport:Local version/idstring: SSH-2.0-paramiko_2.8.1\r\nDEBUG:paramiko.transport:Remote version/idstring: SSH-2.0-OpenSSH_8.2\r\nINFO:paramiko.transport:Connected (version 2.0, client OpenSSH_8.2)\r\nDEBUG:paramiko.transport:kex algos:['curve25519-sha256', 'curve25519-sha256@libssh.org', 'ecdh-sha2-nistp256', 'ecdh-sha2-nistp384', 'ecdh-sha2-nistp521', 'diffie-hellman-group-exchange-sha256', 'diffie-hellman-group16-sha512', 'diffie-hellman-group18-sha512', 'diffie-hellman-group14-sha256'] server key:['rsa-sha2-512', 'rsa-sha2-256', 'ssh-rsa'] client encrypt:['chacha20-poly1305@openssh.com', 'aes128-ctr', 'aes192-ctr', 'aes256-ctr', 'aes128-gcm@openssh.com', 'aes256-gcm@openssh.com'] server encrypt:['chacha20-poly1305@openssh.com', 'aes128-ctr', 'aes192-ctr', 'aes256-ctr', 'aes128-gcm@openssh.com', 'aes256-gcm@openssh.com'] client mac:['umac-64-etm@openssh.com', 'umac-128-etm@openssh.com', 'hmac-sha2-256-etm@openssh.com', 'hmac-sha2-512-etm@openssh.com', 'hmac-sha1-etm@openssh.com', 'umac-64@openssh.com', 'umac-128@openssh.com', 'hmac-sha2-256', 'hmac-sha2-512', 'hmac-sha1'] server mac:['umac-64-etm@openssh.com', 'umac-128-etm@openssh.com', 'hmac-sha2-256-etm@openssh.com', 'hmac-sha2-512-etm@openssh.com', 'hmac-sha1-etm@openssh.com', 'umac-64@openssh.com', 'umac-128@openssh.com', 'hmac-sha2-256', 'hmac-sha2-512', 'hmac-sha1'] client compress:['none'] server compress:['none'] client lang:[''] server lang:[''] kex follows?False\r\nDEBUG:paramiko.transport:Kex agreed: curve25519-sha256@libssh.org\r\nDEBUG:paramiko.transport:HostKey agreed: ssh-rsa\r\nDEBUG:paramiko.transport:Cipher agreed: aes128-ctr\r\nDEBUG:paramiko.transport:MAC agreed: hmac-sha2-256\r\nDEBUG:paramiko.transport:Compression agreed: none\r\nDEBUG:paramiko.transport:kex engine KexCurve25519 specified hash_algo <built-in function openssl_sha256>\r\nDEBUG:paramiko.transport:Switch to new keys ...\r\nDEBUG:paramiko.transport:Adding ssh-rsa host key for hostname.example.com: b'4a16f769992de3607928b51c5d1decee'\r\nDEBUG:paramiko.transport:Trying discovered key b'87a2c32a46a2be4f644fb8cc69f47707' in /home/forsberg/.ssh/robot-test\r\nDEBUG:paramiko.transport:Adding public certificate /home/forsberg/.ssh/robot-test-cert.pub\r\nDEBUG:paramiko.transport:userauth is OK\r\nINFO:paramiko.transport:Authentication (publickey) successful!\r\n```\r\n\r\nHowever, with paramiko 2.9.1 I instead get the following:\r\n\r\n```\r\npython ssh_via_paramiko hostname.example.com\r\nDEBUG:paramiko.transport:starting thread (client mode): 0x1fbd4c10\r\nDEBUG:paramiko.transport:Local version/idstring: SSH-2.0-paramiko_2.9.1\r\nDEBUG:paramiko.transport:Remote version/idstring: SSH-2.0-OpenSSH_8.2\r\nINFO:paramiko.transport:Connected (version 2.0, client OpenSSH_8.2)\r\nDEBUG:paramiko.transport:=== Key exchange possibilities ===\r\nDEBUG:paramiko.transport:kex algos: curve25519-sha256, curve25519-sha256@libssh.org, ecdh-sha2-nistp256, ecdh-sha2-nistp384, ecdh-sha2-nistp521, diffie-hellman-group-exchange-sha256, diffie-hellman-group16-sha512, diffie-hellman-group18-sha512, diffie-hellman-group14-sha256\r\nDEBUG:paramiko.transport:server key: rsa-sha2-512, rsa-sha2-256, ssh-rsa\r\nDEBUG:paramiko.transport:client encrypt: chacha20-poly1305@openssh.com, aes128-ctr, aes192-ctr, aes256-ctr, aes128-gcm@openssh.com, aes256-gcm@openssh.com\r\nDEBUG:paramiko.transport:server encrypt: chacha20-poly1305@openssh.com, aes128-ctr, aes192-ctr, aes256-ctr, aes128-gcm@openssh.com, aes256-gcm@openssh.com\r\nDEBUG:paramiko.transport:client mac: umac-64-etm@openssh.com, umac-128-etm@openssh.com, hmac-sha2-256-etm@openssh.com, hmac-sha2-512-etm@openssh.com, hmac-sha1-etm@openssh.com, umac-64@openssh.com, umac-128@openssh.com, hmac-sha2-256, hmac-sha2-512, hmac-sha1\r\nDEBUG:paramiko.transport:server mac: umac-64-etm@openssh.com, umac-128-etm@openssh.com, hmac-sha2-256-etm@openssh.com, hmac-sha2-512-etm@openssh.com, hmac-sha1-etm@openssh.com, umac-64@openssh.com, umac-128@openssh.com, hmac-sha2-256, hmac-sha2-512, hmac-sha1\r\nDEBUG:paramiko.transport:client compress: none\r\nDEBUG:paramiko.transport:server compress: none\r\nDEBUG:paramiko.transport:client lang: <none>\r\nDEBUG:paramiko.transport:server lang: <none>\r\nDEBUG:paramiko.transport:kex follows: False\r\nDEBUG:paramiko.transport:=== Key exchange agreements ===\r\nDEBUG:paramiko.transport:Kex: curve25519-sha256@libssh.org\r\nDEBUG:paramiko.transport:HostKey: rsa-sha2-512\r\nDEBUG:paramiko.transport:Cipher: aes128-ctr\r\nDEBUG:paramiko.transport:MAC: hmac-sha2-256\r\nDEBUG:paramiko.transport:Compression: none\r\nDEBUG:paramiko.transport:=== End of kex handshake ===\r\nDEBUG:paramiko.transport:kex engine KexCurve25519 specified hash_algo <built-in function openssl_sha256>\r\nDEBUG:paramiko.transport:Switch to new keys ...\r\nDEBUG:paramiko.transport:Got EXT_INFO: {'server-sig-algs': b'ssh-ed25519,sk-ssh-ed25519@openssh.com,ssh-rsa,rsa-sha2-256,rsa-sha2-512,ssh-dss,ecdsa-sha2-nistp256,ecdsa-sha2-nistp384,ecdsa-sha2-nistp521,sk-ecdsa-sha2-nistp256@openssh.com'}\r\nDEBUG:paramiko.transport:Adding ssh-rsa host key for hostname.example.com: b'4a16f769992de3607928b51c5d1decee'\r\nDEBUG:paramiko.transport:Trying discovered key b'87a2c32a46a2be4f644fb8cc69f47707' in /home/forsberg/.ssh/robot-test\r\nDEBUG:paramiko.transport:Adding public certificate /home/forsberg/.ssh/robot-test-cert.pub\r\nDEBUG:paramiko.transport:userauth is OK\r\nDEBUG:paramiko.transport:Finalizing pubkey algorithm for key of type 'ssh-rsa-cert-v01@openssh.com'\r\nDEBUG:paramiko.transport:Our pubkey algorithm list: ['rsa-sha2-512', 'rsa-sha2-256', 'ssh-rsa']\r\nDEBUG:paramiko.transport:Server-side algorithm list: ['ssh-ed25519', 'sk-ssh-ed25519@openssh.com', 'ssh-rsa', 'rsa-sha2-256', 'rsa-sha2-512', 'ssh-dss', 'ecdsa-sha2-nistp256', 'ecdsa-sha2-nistp384', 'ecdsa-sha2-nistp521', 'sk-ecdsa-sha2-nistp256@openssh.com']\r\nDEBUG:paramiko.transport:Agreed upon 'rsa-sha2-512' pubkey algorithm\r\nINFO:paramiko.transport:Authentication (publickey) failed.\r\nDEBUG:paramiko.transport:Trying discovered key b'd491164ce81ead130e0bc2843ca59ad4' in /home/forsberg/.ssh/robot-test\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python3.8/runpy.py\", line 194, in _run_module_as_main\r\n    return _run_code(code, main_globals, None,\r\n  File \"/usr/lib/python3.8/runpy.py\", line 87, in _run_code\r\n    exec(code, run_globals)\r\n  File \"/home/forsberg/ferro/ferroamp-os-continuous-deploy/ehub-target-tests/src/ehub_target_tests/ssh_via_paramiko.py\", line 21, in <module>\r\n    try_connect(\"hostname.example.com\")\r\n  File \"/home/forsberg/ferro/ferroamp-os-continuous-deploy/ehub-target-tests/src/ehub_target_tests/ssh_via_paramiko.py\", line 18, in try_connect\r\n    client.connect(hostname, 22, username=\"root\", sock=sock, key_filename=\"/home/forsberg/.ssh/robot-test-cert.pub\")\r\n  File \"/home/forsberg/.virtualenvs/feos-cont-deploy/lib/python3.8/site-packages/paramiko/client.py\", line 435, in connect\r\n    self._auth(\r\n  File \"/home/forsberg/.virtualenvs/feos-cont-deploy/lib/python3.8/site-packages/paramiko/client.py\", line 678, in _auth\r\n    key = self._key_from_filepath(\r\n  File \"/home/forsberg/.virtualenvs/feos-cont-deploy/lib/python3.8/site-packages/paramiko/client.py\", line 598, in _key_from_filepath\r\n    key.load_certificate(cert_path)\r\n  File \"/home/forsberg/.virtualenvs/feos-cont-deploy/lib/python3.8/site-packages/paramiko/pkey.py\", line 652, in load_certificate\r\n    raise ValueError(err.format(blob.key_type, self.get_name()))\r\nValueError: PublicBlob type ssh-rsa-cert-v01@openssh.com incompatible with key type ssh-dss\r\n```","closed_by":{"login":"bitprophet","id":6088,"node_id":"MDQ6VXNlcjYwODg=","avatar_url":"https://avatars.githubusercontent.com/u/6088?v=4","gravatar_id":"","url":"https://api.github.com/users/bitprophet","html_url":"https://github.com/bitprophet","followers_url":"https://api.github.com/users/bitprophet/followers","following_url":"https://api.github.com/users/bitprophet/following{/other_user}","gists_url":"https://api.github.com/users/bitprophet/gists{/gist_id}","starred_url":"https://api.github.com/users/bitprophet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bitprophet/subscriptions","organizations_url":"https://api.github.com/users/bitprophet/orgs","repos_url":"https://api.github.com/users/bitprophet/repos","events_url":"https://api.github.com/users/bitprophet/events{/privacy}","received_events_url":"https://api.github.com/users/bitprophet/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/paramiko/paramiko/issues/1963/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":1,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/paramiko/paramiko/issues/1963/timeline","performed_via_github_app":null,"state_reason":"completed"}