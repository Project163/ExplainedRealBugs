{"url":"https://api.github.com/repos/paramiko/paramiko/issues/621","repository_url":"https://api.github.com/repos/paramiko/paramiko","labels_url":"https://api.github.com/repos/paramiko/paramiko/issues/621/labels{/name}","comments_url":"https://api.github.com/repos/paramiko/paramiko/issues/621/comments","events_url":"https://api.github.com/repos/paramiko/paramiko/issues/621/events","html_url":"https://github.com/paramiko/paramiko/issues/621","id":116766792,"node_id":"MDU6SXNzdWUxMTY3NjY3OTI=","number":621,"title":"No documented way to check that channel has closed","user":{"login":"nolar","id":544296,"node_id":"MDQ6VXNlcjU0NDI5Ng==","avatar_url":"https://avatars.githubusercontent.com/u/544296?v=4","gravatar_id":"","url":"https://api.github.com/users/nolar","html_url":"https://github.com/nolar","followers_url":"https://api.github.com/users/nolar/followers","following_url":"https://api.github.com/users/nolar/following{/other_user}","gists_url":"https://api.github.com/users/nolar/gists{/gist_id}","starred_url":"https://api.github.com/users/nolar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nolar/subscriptions","organizations_url":"https://api.github.com/users/nolar/orgs","repos_url":"https://api.github.com/users/nolar/repos","events_url":"https://api.github.com/users/nolar/events{/privacy}","received_events_url":"https://api.github.com/users/nolar/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":60522311,"node_id":"MDU6TGFiZWw2MDUyMjMxMQ==","url":"https://api.github.com/repos/paramiko/paramiko/labels/Needs%20investigation","name":"Needs investigation","color":"fad8c7","default":false,"description":null},{"id":120561399,"node_id":"MDU6TGFiZWwxMjA1NjEzOTk=","url":"https://api.github.com/repos/paramiko/paramiko/labels/Bug","name":"Bug","color":"a04040","default":false,"description":null},{"id":120561604,"node_id":"MDU6TGFiZWwxMjA1NjE2MDQ=","url":"https://api.github.com/repos/paramiko/paramiko/labels/Support","name":"Support","color":"4070a0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/paramiko/paramiko/milestones/9","html_url":"https://github.com/paramiko/paramiko/milestone/9","labels_url":"https://api.github.com/repos/paramiko/paramiko/milestones/9/labels","id":1400546,"node_id":"MDk6TWlsZXN0b25lMTQwMDU0Ng==","number":9,"title":"1.16.1","description":"","creator":{"login":"bitprophet","id":6088,"node_id":"MDQ6VXNlcjYwODg=","avatar_url":"https://avatars.githubusercontent.com/u/6088?v=4","gravatar_id":"","url":"https://api.github.com/users/bitprophet","html_url":"https://github.com/bitprophet","followers_url":"https://api.github.com/users/bitprophet/followers","following_url":"https://api.github.com/users/bitprophet/following{/other_user}","gists_url":"https://api.github.com/users/bitprophet/gists{/gist_id}","starred_url":"https://api.github.com/users/bitprophet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bitprophet/subscriptions","organizations_url":"https://api.github.com/users/bitprophet/orgs","repos_url":"https://api.github.com/users/bitprophet/repos","events_url":"https://api.github.com/users/bitprophet/events{/privacy}","received_events_url":"https://api.github.com/users/bitprophet/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":12,"state":"closed","created_at":"2015-11-09T01:13:24Z","updated_at":"2016-05-12T16:49:31Z","due_on":null,"closed_at":"2016-04-25T05:18:00Z"},"comments":2,"created_at":"2015-11-13T13:17:15Z","updated_at":"2016-04-24T20:13:27Z","closed_at":"2016-04-24T20:13:27Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Briefly:**\n\nSSH sends exit status before the stdout data, and there is no _documented_ way to properly check that the channel has actually finished.\n\n**Detailed:**\n\nSSH can have exit status sent before stdout data. The typical approach in real-time streaming is to check if channel is recv_ready, recv_stderr_ready or exit_status_ready. There are no other documented ways to check the channel has actually finished. \n\n```\n        # Read if it still executes silently, or there are data left to read.\n        while channel.recv_ready() or channel.recv_stderr_ready() or not channel.exit_status_ready():\n            select.select([channel], [], [channel], 60)\n\n            if channel.recv_ready():\n                out = channel.recv(9999999)\n            if channel.recv_stderr_ready():\n                out = channel.recv_stderr(9999999)\n\n        exit_code = channel.recv_exit_status()\n```\n\nWith this script iterated infinitely, it fails on an attempt number 40-120 (randomly):\n\n```\n        iteration = 0\n        while True:\n            iteration += 1\n            stdout = run(\"{ sleep 1 ; echo 'itr=%s' ; } &\" % iteration).stdout\n            assert stdout != ''\n```\n\nThe hexdump looks like this (note the timing in seconds!):\n\n```\n2015-11-13 13:38:07,936 [Thread-3  ] [DEBUG]  [paramiko.transp]  IN: A2 7F 59 EF 57 2D 5C 3D A8 54 72 F5 96 CC E6 91    ..Y.W-\\=.Tr.....\n2015-11-13 13:38:07,936 [Thread-3  ] [DEBUG]  [paramiko.transp]  Got payload (28 bytes, 18 padding)\n2015-11-13 13:38:07,937 [Thread-3  ] [DEBUG]  [paramiko.transp]  Read packet <channel-window-adjust>, length 9\n\n2015-11-13 13:38:07,937 [Thread-3  ] [DEBUG]  [paramiko.transp]  IN: 00 00 00 0C 06 63 00 00 00 22 87 B2 83 6E 05 7F    .....c...\"...n..\n2015-11-13 13:38:07,937 [Thread-3  ] [DEBUG]  [paramiko.transp]  Got payload (12 bytes, 6 padding)\n2015-11-13 13:38:07,937 [Thread-3  ] [DEBUG]  [paramiko.transp]  Read packet <channel-success>, length 5\n2015-11-13 13:38:07,937 [Thread-3  ] [DEBUG]  [paramiko.transp]  [chan 34] Sesch channel 34 request ok\n\n2015-11-13 13:38:07,939 [Thread-3  ] [DEBUG]  [paramiko.transp]  IN: 00 00 00 2C 12 62 00 00 00 22 00 00 00 0B 65 78    ...,.b...\"....ex\n2015-11-13 13:38:07,939 [Thread-3  ] [DEBUG]  [paramiko.transp]  IN: 69 74 2D 73 74 61 74 75 73 00 00 00 00 00 57 C1    it-status.....W.\n2015-11-13 13:38:07,939 [Thread-3  ] [DEBUG]  [paramiko.transp]  IN: DC AB EB E4 E0 53 7F B6 34 6F 74 64 F8 4E F5 58    .....S..4otd.N.X\n2015-11-13 13:38:07,940 [Thread-3  ] [DEBUG]  [paramiko.transp]  Got payload (44 bytes, 18 padding)\n2015-11-13 13:38:07,940 [Thread-3  ] [DEBUG]  [paramiko.transp]  Read packet <channel-request>, length 25\n\n2015-11-13 13:38:08,940 [Thread-3  ] [DEBUG]  [paramiko.transp]  IN: 00 00 00 1C 0B 5E 00 00 00 22 00 00 00 07 69 74    .....^...\"....it\n2015-11-13 13:38:08,940 [Thread-3  ] [DEBUG]  [paramiko.transp]  IN: 72 3D 33 34 0A FF CA AC 4D DF 85 B6 B8 97 7B C9    r=34....M.....{.\n2015-11-13 13:38:08,940 [Thread-3  ] [DEBUG]  [paramiko.transp]  Got payload (28 bytes, 11 padding)\n2015-11-13 13:38:08,941 [Thread-3  ] [DEBUG]  [paramiko.transp]  Read packet <channel-data>, length 16\n\n2015-11-13 13:38:08,941 [Thread-3  ] [DEBUG]  [paramiko.transp]  IN: 00 00 00 0C 06 60 00 00 00 22 AC C1 45 F0 AA BC    .....`...\"..E...\n2015-11-13 13:38:08,941 [Thread-3  ] [DEBUG]  [paramiko.transp]  Got payload (12 bytes, 6 padding)\n2015-11-13 13:38:08,942 [Thread-3  ] [DEBUG]  [paramiko.transp]  Read packet <channel-eof>, length 5\n2015-11-13 13:38:08,942 [Thread-3  ] [DEBUG]  [paramiko.transp]  [chan 34] EOF received (34)\n\n2015-11-13 13:38:08,942 [Thread-3  ] [DEBUG]  [paramiko.transp]  IN: 00 00 00 0C 06 61 00 00 00 22 6C 38 5F 18 5C 5E    .....a...\"l8_.\\^\n2015-11-13 13:38:08,942 [Thread-3  ] [DEBUG]  [paramiko.transp]  Got payload (12 bytes, 6 padding)\n2015-11-13 13:38:08,943 [Thread-3  ] [DEBUG]  [paramiko.transp]  Read packet <channel-close>, length 5\n2015-11-13 13:38:08,943 [MainThread] [DEBUG]  [paramiko.transp]  [chan 34] EOF sent (34)\n```\n\nIf you are unlucky enough to start your 1st iteration of the while cycle when the exit status is already there (can be simulated with time.sleep), you do not even enter the cycle's body, and go straight to recv_exit_status().\n\n**Solution?**\n\nBut there is _undocumented_ field channel.closed, which can be used to fix this issue. This line works fine:\n\n```\n        while channel.recv_ready() or channel.recv_stderr_ready() or not channel.closed:\n            ...\n```\n\nPlease make it documented, or add some other way to check that the channel has _actually_ finished.\n\n**PS:**\n\n```\n$ python --version\nPython 2.7.10\n\n$ pip freeze\necdsa==0.13\nnetaddr==0.7.18\nparamiko==1.15.3\npycrypto==2.6.1\nrequests==2.8.0\n```\n","closed_by":{"login":"bitprophet","id":6088,"node_id":"MDQ6VXNlcjYwODg=","avatar_url":"https://avatars.githubusercontent.com/u/6088?v=4","gravatar_id":"","url":"https://api.github.com/users/bitprophet","html_url":"https://github.com/bitprophet","followers_url":"https://api.github.com/users/bitprophet/followers","following_url":"https://api.github.com/users/bitprophet/following{/other_user}","gists_url":"https://api.github.com/users/bitprophet/gists{/gist_id}","starred_url":"https://api.github.com/users/bitprophet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bitprophet/subscriptions","organizations_url":"https://api.github.com/users/bitprophet/orgs","repos_url":"https://api.github.com/users/bitprophet/repos","events_url":"https://api.github.com/users/bitprophet/events{/privacy}","received_events_url":"https://api.github.com/users/bitprophet/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/paramiko/paramiko/issues/621/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":1,"eyes":0},"timeline_url":"https://api.github.com/repos/paramiko/paramiko/issues/621/timeline","performed_via_github_app":null,"state_reason":"completed"}