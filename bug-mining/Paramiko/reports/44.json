{"url":"https://api.github.com/repos/paramiko/paramiko/issues/673","repository_url":"https://api.github.com/repos/paramiko/paramiko","labels_url":"https://api.github.com/repos/paramiko/paramiko/issues/673/labels{/name}","comments_url":"https://api.github.com/repos/paramiko/paramiko/issues/673/comments","events_url":"https://api.github.com/repos/paramiko/paramiko/issues/673/events","html_url":"https://github.com/paramiko/paramiko/issues/673","id":131057451,"node_id":"MDU6SXNzdWUxMzEwNTc0NTE=","number":673,"title":"\"SSHException: Error reading SSH protocol banner\" when using ProxyCommand","user":{"login":"depado","id":694365,"node_id":"MDQ6VXNlcjY5NDM2NQ==","avatar_url":"https://avatars.githubusercontent.com/u/694365?v=4","gravatar_id":"","url":"https://api.github.com/users/depado","html_url":"https://github.com/depado","followers_url":"https://api.github.com/users/depado/followers","following_url":"https://api.github.com/users/depado/following{/other_user}","gists_url":"https://api.github.com/users/depado/gists{/gist_id}","starred_url":"https://api.github.com/users/depado/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/depado/subscriptions","organizations_url":"https://api.github.com/users/depado/orgs","repos_url":"https://api.github.com/users/depado/repos","events_url":"https://api.github.com/users/depado/events{/privacy}","received_events_url":"https://api.github.com/users/depado/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":60522311,"node_id":"MDU6TGFiZWw2MDUyMjMxMQ==","url":"https://api.github.com/repos/paramiko/paramiko/labels/Needs%20investigation","name":"Needs investigation","color":"fad8c7","default":false,"description":null},{"id":120561399,"node_id":"MDU6TGFiZWwxMjA1NjEzOTk=","url":"https://api.github.com/repos/paramiko/paramiko/labels/Bug","name":"Bug","color":"a04040","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":33,"created_at":"2016-02-03T15:25:59Z","updated_at":"2020-07-30T12:55:54Z","closed_at":"2016-07-26T04:04:00Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hello,\n\nIt's been a few days and I'm still struggling with this, I think it's quite a known issue but wasn't able to find a workaround. \n\n```\nParamiko 1.16.0\nPython 3.5.1\nOperating System : Archlinux\n```\n\nBelow is a simplified version of my actual code that throws the same error :\n\n``` python\nimport os\nimport paramiko\n\n# Loading ssh configuration to get the IP and user of the desired host (here 'bastion')\ncfg = paramiko.SSHConfig()\nwith open(os.path.expanduser(\"~/.ssh/config\")) as f:\n    cfg.parse(f)\nhost_cfg = cfg.lookup('bastion')\nsock = paramiko.ProxyCommand(\"ssh -W %h:%p {}@{}\".format(host_cfg.get('user', 'root'), host_cfg.get('hostname')))\n\n# Client Setup\nclient = paramiko.SSHClient()\nclient.load_system_host_keys()\nclient.set_missing_host_key_policy(paramiko.AutoAddPolicy())\n\n# Connect and execute command\nclient.connect(\"my.ip.ad.dr\", username='root', sock=sock)\n(stdin, stdout, stderr) = client.exec_command(\"echo 'Hello World !'\")\nfor line in stdout.readlines():\n    print(line)\nclient.close()\n```\n\nNote that the whole parsing the ssh config thing is simplified because I know this entry is in the ssh config. (And yes I'm sure the error doesn't come from that because the generated ProxyCommand is correct)\n\nOf course it raises the error when executing the `client.connect` line. The ProxyCommand is correct, tested multiple times and works just fine in my `~/.ssh/config`. When using it with the command line, it creates an entry in the logs of my bastion. When using it within paramiko it doesn't generate an entry in the logs. \n\nI also tested using the `netcat` approach like this :\n\n``` python\nsock = paramiko.ProxyCommand(\"ssh {}@{} nc %h %p\".format(host_cfg.get('user', 'root'), host_cfg.get('hostname')))\n```\n\nThis time it generates an entry in the logs of my bastion (even though it still raises this error) but closes the connection immediatly.\n\nAnyone having the same issue and could help me with that ?\n","closed_by":{"login":"bitprophet","id":6088,"node_id":"MDQ6VXNlcjYwODg=","avatar_url":"https://avatars.githubusercontent.com/u/6088?v=4","gravatar_id":"","url":"https://api.github.com/users/bitprophet","html_url":"https://github.com/bitprophet","followers_url":"https://api.github.com/users/bitprophet/followers","following_url":"https://api.github.com/users/bitprophet/following{/other_user}","gists_url":"https://api.github.com/users/bitprophet/gists{/gist_id}","starred_url":"https://api.github.com/users/bitprophet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bitprophet/subscriptions","organizations_url":"https://api.github.com/users/bitprophet/orgs","repos_url":"https://api.github.com/users/bitprophet/repos","events_url":"https://api.github.com/users/bitprophet/events{/privacy}","received_events_url":"https://api.github.com/users/bitprophet/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/paramiko/paramiko/issues/673/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/paramiko/paramiko/issues/673/timeline","performed_via_github_app":null,"state_reason":"completed"}