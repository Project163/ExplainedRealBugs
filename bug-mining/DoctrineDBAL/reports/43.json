{"url":"https://api.github.com/repos/doctrine/dbal/issues/4619","repository_url":"https://api.github.com/repos/doctrine/dbal","labels_url":"https://api.github.com/repos/doctrine/dbal/issues/4619/labels{/name}","comments_url":"https://api.github.com/repos/doctrine/dbal/issues/4619/comments","events_url":"https://api.github.com/repos/doctrine/dbal/issues/4619/events","html_url":"https://github.com/doctrine/dbal/issues/4619","id":868250168,"node_id":"MDU6SXNzdWU4NjgyNTAxNjg=","number":4619,"title":"ensureForwardCompatibilityStatement broke existing code","user":{"login":"bizurkur","id":16649887,"node_id":"MDQ6VXNlcjE2NjQ5ODg3","avatar_url":"https://avatars.githubusercontent.com/u/16649887?v=4","gravatar_id":"","url":"https://api.github.com/users/bizurkur","html_url":"https://github.com/bizurkur","followers_url":"https://api.github.com/users/bizurkur/followers","following_url":"https://api.github.com/users/bizurkur/following{/other_user}","gists_url":"https://api.github.com/users/bizurkur/gists{/gist_id}","starred_url":"https://api.github.com/users/bizurkur/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bizurkur/subscriptions","organizations_url":"https://api.github.com/users/bizurkur/orgs","repos_url":"https://api.github.com/users/bizurkur/repos","events_url":"https://api.github.com/users/bizurkur/events{/privacy}","received_events_url":"https://api.github.com/users/bizurkur/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":308809145,"node_id":"MDU6TGFiZWwzMDg4MDkxNDU=","url":"https://api.github.com/repos/doctrine/dbal/labels/Connections","name":"Connections","color":"bfe5bf","default":false,"description":null},{"id":308818813,"node_id":"MDU6TGFiZWwzMDg4MTg4MTM=","url":"https://api.github.com/repos/doctrine/dbal/labels/Configuration","name":"Configuration","color":"bfe5bf","default":false,"description":null},{"id":308827849,"node_id":"MDU6TGFiZWwzMDg4Mjc4NDk=","url":"https://api.github.com/repos/doctrine/dbal/labels/BC%20Break","name":"BC Break","color":"e11d21","default":false,"description":null},{"id":309163317,"node_id":"MDU6TGFiZWwzMDkxNjMzMTc=","url":"https://api.github.com/repos/doctrine/dbal/labels/PDO","name":"PDO","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/doctrine/dbal/milestones/94","html_url":"https://github.com/doctrine/dbal/milestone/94","labels_url":"https://api.github.com/repos/doctrine/dbal/milestones/94/labels","id":6879034,"node_id":"MDk6TWlsZXN0b25lNjg3OTAzNA==","number":94,"title":"2.13.3","description":"","creator":{"login":"alcaeus","id":383198,"node_id":"MDQ6VXNlcjM4MzE5OA==","avatar_url":"https://avatars.githubusercontent.com/u/383198?v=4","gravatar_id":"","url":"https://api.github.com/users/alcaeus","html_url":"https://github.com/alcaeus","followers_url":"https://api.github.com/users/alcaeus/followers","following_url":"https://api.github.com/users/alcaeus/following{/other_user}","gists_url":"https://api.github.com/users/alcaeus/gists{/gist_id}","starred_url":"https://api.github.com/users/alcaeus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alcaeus/subscriptions","organizations_url":"https://api.github.com/users/alcaeus/orgs","repos_url":"https://api.github.com/users/alcaeus/repos","events_url":"https://api.github.com/users/alcaeus/events{/privacy}","received_events_url":"https://api.github.com/users/alcaeus/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":18,"state":"closed","created_at":"2021-06-22T17:17:37Z","updated_at":"2021-09-12T19:29:59Z","due_on":null,"closed_at":"2021-09-12T19:29:59Z"},"comments":7,"created_at":"2021-04-26T22:28:18Z","updated_at":"2022-07-26T00:26:31Z","closed_at":"2021-06-27T19:22:39Z","author_association":"NONE","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Bug Report\r\n\r\nThis is likely a low priority. \r\n\r\n|    Q        |   A\r\n|------------ | ------\r\n| BC Break    | yes?\r\n| Version     | 2.13.1, but it looks like 2.12.x branch has the issue too. 2.12.1 worked fine\r\n\r\n#### Summary\r\n\r\nCommit 4297f5027011027529fdccfa3b1fbbb3090a7d25 broke `Connection` when passing in `$params['pdo']`\r\n\r\nhttps://github.com/doctrine/dbal/pull/4590 says it should have fixed the issue, but I'm using 2.13.1 and it still seems to be broken.\r\n\r\n#### Current behaviour\r\n\r\nIf you build a `Connection` object using an already established `$params['pdo']` connection, commit 4297f5027011027529fdccfa3b1fbbb3090a7d25 caused breaking changes that no longer allow that behavior. Now you get the following error:\r\n\r\n```\r\nAn exception occurred while executing 'SHOW FULL TABLES WHERE Table_type = 'BASE TABLE'':  Argument 1 passed to Doctrine\\DBAL\\Connection::ensureForwardCompatibilityStatement() must be an instance of Doctrine\\DBAL\\Driver\\ResultStatement, instance of PDOStatement given, called in /var/www/vendor/doctrine/dbal/lib/Doctrine/DBAL/Connection.php on line 1314\r\n```\r\n\r\n#### How to reproduce\r\n\r\n```php\r\n\r\nuse Doctrine\\DBAL\\Connection;\r\nuse Doctrine\\DBAL\\Driver\\PDO\\MySQL\\Driver;\r\n\r\n$params = [\r\n    'pdo' => new \\PDO('mysql:<whatever>'),\r\n];\r\n$driver = new Driver();\r\n\r\n$connection = new Connection($params, $driver);\r\n// This is a query that Doctrine Migrations tool does:\r\n$connection->executeQuery(\"SHOW FULL TABLES WHERE Table_type = 'BASE TABLE'\");\r\n```\r\n\r\n- Within the `executeQuery()` method, it calls `$connection = $this->getWrappedConnection();` which is returning the raw PDO connection. \r\n- Later in the method it calls `$stmt = $connection->prepare($sql);` which is a raw PDOStatement object.\r\n- At the end of the method the referenced commit changed the code to `return $this->ensureForwardCompatibilityStatement($stmt);` and it expects `$stmt` to be an instance of `ResultStatement`, but of course it's the raw PDOStatement instead.\r\n\r\n#### Expected behaviour\r\n\r\nNo error to be thrown\r\n\r\n","closed_by":{"login":"morozov","id":59683,"node_id":"MDQ6VXNlcjU5Njgz","avatar_url":"https://avatars.githubusercontent.com/u/59683?v=4","gravatar_id":"","url":"https://api.github.com/users/morozov","html_url":"https://github.com/morozov","followers_url":"https://api.github.com/users/morozov/followers","following_url":"https://api.github.com/users/morozov/following{/other_user}","gists_url":"https://api.github.com/users/morozov/gists{/gist_id}","starred_url":"https://api.github.com/users/morozov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/morozov/subscriptions","organizations_url":"https://api.github.com/users/morozov/orgs","repos_url":"https://api.github.com/users/morozov/repos","events_url":"https://api.github.com/users/morozov/events{/privacy}","received_events_url":"https://api.github.com/users/morozov/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/doctrine/dbal/issues/4619/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/doctrine/dbal/issues/4619/timeline","performed_via_github_app":null,"state_reason":"completed"}