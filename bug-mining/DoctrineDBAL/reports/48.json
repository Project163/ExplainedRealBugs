{"url":"https://api.github.com/repos/doctrine/dbal/issues/6198","repository_url":"https://api.github.com/repos/doctrine/dbal","labels_url":"https://api.github.com/repos/doctrine/dbal/issues/6198/labels{/name}","comments_url":"https://api.github.com/repos/doctrine/dbal/issues/6198/comments","events_url":"https://api.github.com/repos/doctrine/dbal/issues/6198/events","html_url":"https://github.com/doctrine/dbal/issues/6198","id":1950879431,"node_id":"I_kwDOAApWWM50SA7H","number":6198,"title":"PostgresSQLSchemaManager incorrectly detect GENERATED column definition as being the column default value","user":{"login":"allan-simon","id":213167,"node_id":"MDQ6VXNlcjIxMzE2Nw==","avatar_url":"https://avatars.githubusercontent.com/u/213167?v=4","gravatar_id":"","url":"https://api.github.com/users/allan-simon","html_url":"https://github.com/allan-simon","followers_url":"https://api.github.com/users/allan-simon/followers","following_url":"https://api.github.com/users/allan-simon/following{/other_user}","gists_url":"https://api.github.com/users/allan-simon/gists{/gist_id}","starred_url":"https://api.github.com/users/allan-simon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/allan-simon/subscriptions","organizations_url":"https://api.github.com/users/allan-simon/orgs","repos_url":"https://api.github.com/users/allan-simon/repos","events_url":"https://api.github.com/users/allan-simon/events{/privacy}","received_events_url":"https://api.github.com/users/allan-simon/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2023-10-18T23:32:36Z","updated_at":"2023-10-18T23:32:36Z","closed_at":null,"author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Bug Report\r\n\r\n<!-- Fill in the relevant information below to help triage your issue. -->\r\n\r\n|    Q        |   A\r\n|------------ | ------\r\n| Version     | all\r\n\r\n#### Summary\r\n\r\n<!-- Provide a summary describing the problem you are experiencing. -->\r\n\r\nAs reported https://github.com/doctrine/dbal/issues/5661 \r\n\r\nWhen creating  [generated column ](https://www.postgresql.org/docs/current/ddl-generated-columns.html) using `columnDefinition`  , the schema tool will try to generate a  `ALTER TABLE mytable  ALTER mycolumn DROP DEFAULT\r\n\r\nthe reason is that currently `PostgreSQLSchemaManager`  considers `SELECT pg_get_expr(adbin, adrelid) FROM pg_attrdef`  as containing ONLY the  attribute *DEFault* value , while it contains the attribute *DEFinition* , which is 99% of the time the default value .... except for generated column\r\n\r\nfor a column defined as `foobar INT GENERATED ALWAYS AS  ( otherColumn / 100 ) STORED`   ,  `SELECT pg_get_expr(adbin, adrelid) FROM pg_attrdef` will return the  part inside `()`   i.e `otherColumn / 100`  , i.e the definition of the generated value.\r\n\r\n\r\n\r\n#### Current behaviour\r\n\r\nCurrently `ColumnDiff`  will always see a change because the schema definition says there's no default which is correct as 'default' as no meaning for a  ,  while `PostgreSQLSchemaManager` will report the column as having \r\n\r\n#### How to reproduce\r\n```sql\r\nCREATE SEQUENCE fulltext_id_seq INCREMENT BY 1 MINVALUE 1 START 1;\r\nCREATE TABLE fulltext (\r\nid INT NOT NULL, column1 TEXT DEFAULT NULL, \r\ncolumn2 TEXT DEFAULT NULL,\r\nconcatenated  TEXT GENERATED ALWAYS AS  ( column1 || column 2 )  STORED,\r\nPRIMARY KEY(id)\r\n);\r\n```\r\n\r\n    * Add the below entity in your (Symfony) codebase. Outside Symfony, change the command to orm:schema-tool:update. The point is to get the SchemaTool to try to detect changes.\r\n    * Run bin/console do:sch:up --force to create the table and sequence\r\n    * Run bin/console do:sch:up --dump-sql to see the broken update queries.\r\n\r\n```\r\n<?php\r\n\r\nnamespace App\\Entity;\r\n\r\nuse Doctrine\\ORM\\Mapping as ORM;\r\n\r\n#[ORM\\Entity]\r\nclass Fulltext\r\n{\r\n    #[ORM\\Id]\r\n    #[ORM\\GeneratedValue]\r\n    #[ORM\\Column(type: 'integer')]\r\n    private $id;\r\n    \r\n    #[ORM\\Column(type: 'text', nullable: true)]\r\n    private $column1;\r\n\r\n    #[ORM\\Column(type: 'text', nullable: true)]\r\n    private $column2;\r\n\r\n    #[ORM\\Column(\r\n        type: 'text',\r\n        nullable: true,\r\n        insertable: false,\r\n        updatable: false,\r\n        columnDefinition: \"TEXT GENERATED ALWAYS AS (  column1 || column2 )   STORED\",\r\n        generated: 'ALWAYS',\r\n    )]\r\n    private $concatenated;\r\n}\r\n```\r\n\r\nit will try to generate the diff \r\n\r\n```\r\n`ALTER TABLE fulltext  ALTER concatenated DROP DEFAULT\r\n```\r\n\r\n#### Expected behaviour\r\n\r\nit should not see a difference \r\n\r\n\r\n I will open a PR as I have a fix which I think is not hackish\r\n\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/doctrine/dbal/issues/6198/reactions","total_count":3,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/doctrine/dbal/issues/6198/timeline","performed_via_github_app":null,"state_reason":null}