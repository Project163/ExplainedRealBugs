{"url":"https://api.github.com/repos/doctrine/dbal/issues/1599","repository_url":"https://api.github.com/repos/doctrine/dbal","labels_url":"https://api.github.com/repos/doctrine/dbal/issues/1599/labels{/name}","comments_url":"https://api.github.com/repos/doctrine/dbal/issues/1599/comments","events_url":"https://api.github.com/repos/doctrine/dbal/issues/1599/events","html_url":"https://github.com/doctrine/dbal/issues/1599","id":120674288,"node_id":"MDU6SXNzdWUxMjA2NzQyODg=","number":1599,"title":"DBAL-406: PostgreSqlSchemaManager::tablesExist() misses schema-qualified table names if they exist in the first schema on the search path","user":{"login":"doctrinebot","id":2414358,"node_id":"MDQ6VXNlcjI0MTQzNTg=","avatar_url":"https://avatars.githubusercontent.com/u/2414358?v=4","gravatar_id":"","url":"https://api.github.com/users/doctrinebot","html_url":"https://github.com/doctrinebot","followers_url":"https://api.github.com/users/doctrinebot/followers","following_url":"https://api.github.com/users/doctrinebot/following{/other_user}","gists_url":"https://api.github.com/users/doctrinebot/gists{/gist_id}","starred_url":"https://api.github.com/users/doctrinebot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/doctrinebot/subscriptions","organizations_url":"https://api.github.com/users/doctrinebot/orgs","repos_url":"https://api.github.com/users/doctrinebot/repos","events_url":"https://api.github.com/users/doctrinebot/events{/privacy}","received_events_url":"https://api.github.com/users/doctrinebot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":225630643,"node_id":"MDU6TGFiZWwyMjU2MzA2NDM=","url":"https://api.github.com/repos/doctrine/dbal/labels/Bug","name":"Bug","color":"e11d21","default":false,"description":null}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2013-01-07T08:33:41Z","updated_at":"2022-10-04T00:33:57Z","closed_at":"2022-09-03T18:29:09Z","author_association":"NONE","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Jira issue originally created by user rhunwicks:\n\nPlease see https://github.com/doctrine/migrations/issues/99 for additional background.\n\nTo reproduce:\n\n``` sql\nCREATE SCHEMA test_schema;\nCREATE TABLE test*schema.test_table (test*column TEXT);\n```\n\nThen in Doctrine:\n\n``` php\n$connection->executeUpdate('SET search*path=test*schema;');\n$result = $connection->getSchemaManager()->tablesExist(array('test*schema.test*table'));\n```\n\n`$result` is false when it should be true.\n\nThe error occurs because `PostgreSqlSchemaManager` returns the bare table name from `getPortableTablesList()` if the schema is the first one in the search path.\n\nThe full explanation is...\n\n`AbstractSchemaManager::tablesExist()` calls `$this->getPortableTablesList()` before checking if the tables exist.\n\n`PostgreSqlSchemaManager` overrides this in `_getPortableTableDefinition()`  by comparing the schema for the table with the search path for the connection. If the table schema is the first one in the search path, then it returns the bare table name, if it isn't then it returns the schema-qualified table name (i.e. schema.table).\n\n`tablesExist()` does an array_intersect to check that all the tables in the search array exist in the database.\n\nIf one of the tables in the search array was schema-qualified but also in the first schema on the search path, then you end up checking:\n\n`array*intersect(array('test_schema.test_table'), array('test*table'))`\n\nwhich fails.\n\nOne way to fix it would be to override `tablesExist()` in `PostgreSqlSchemaManager` so that it passes the search array through `getPortableTableDefinition()` before doing the array_intersect:\n\n``` php\n    /****\n     * Return true if all the given tables exist.\n     *\n     * @param array $tableNames\n     * @return bool\n     */\n    public function tablesExist($tableNames)\n    {\n        foreach ($tableNames as $key => $tableName) {\n            if (strpos($tableName, '.') !== false) {\n                $tableName = explode('.', $tableName, 2);\n                $tableNames[$key] = $this->*getPortableTableDefinition(array('schema_name'=>$tableName[0], 'table*name'=>$tableName[1]));\n            }\n        }\n        return parent::tablesExist($tableNames);\n    }\n```\n\nI'm happy to provide a PR on GitHub if you want.\n","closed_by":{"login":"morozov","id":59683,"node_id":"MDQ6VXNlcjU5Njgz","avatar_url":"https://avatars.githubusercontent.com/u/59683?v=4","gravatar_id":"","url":"https://api.github.com/users/morozov","html_url":"https://github.com/morozov","followers_url":"https://api.github.com/users/morozov/followers","following_url":"https://api.github.com/users/morozov/following{/other_user}","gists_url":"https://api.github.com/users/morozov/gists{/gist_id}","starred_url":"https://api.github.com/users/morozov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/morozov/subscriptions","organizations_url":"https://api.github.com/users/morozov/orgs","repos_url":"https://api.github.com/users/morozov/repos","events_url":"https://api.github.com/users/morozov/events{/privacy}","received_events_url":"https://api.github.com/users/morozov/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/doctrine/dbal/issues/1599/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/doctrine/dbal/issues/1599/timeline","performed_via_github_app":null,"state_reason":"completed"}