{"url":"https://api.github.com/repos/FasterXML/woodstox/issues/23","repository_url":"https://api.github.com/repos/FasterXML/woodstox","labels_url":"https://api.github.com/repos/FasterXML/woodstox/issues/23/labels{/name}","comments_url":"https://api.github.com/repos/FasterXML/woodstox/issues/23/comments","events_url":"https://api.github.com/repos/FasterXML/woodstox/issues/23/events","html_url":"https://github.com/FasterXML/woodstox/issues/23","id":173397700,"node_id":"MDU6SXNzdWUxNzMzOTc3MDA=","number":23,"title":"Text content is not validated correctly when copying events to `XmlStreamWriter`","user":{"login":"hxc9","id":4180490,"node_id":"MDQ6VXNlcjQxODA0OTA=","avatar_url":"https://avatars.githubusercontent.com/u/4180490?v=4","gravatar_id":"","url":"https://api.github.com/users/hxc9","html_url":"https://github.com/hxc9","followers_url":"https://api.github.com/users/hxc9/followers","following_url":"https://api.github.com/users/hxc9/following{/other_user}","gists_url":"https://api.github.com/users/hxc9/gists{/gist_id}","starred_url":"https://api.github.com/users/hxc9/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hxc9/subscriptions","organizations_url":"https://api.github.com/users/hxc9/orgs","repos_url":"https://api.github.com/users/hxc9/repos","events_url":"https://api.github.com/users/hxc9/events{/privacy}","received_events_url":"https://api.github.com/users/hxc9/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/FasterXML/woodstox/milestones/4","html_url":"https://github.com/FasterXML/woodstox/milestone/4","labels_url":"https://api.github.com/repos/FasterXML/woodstox/milestones/4/labels","id":3224172,"node_id":"MDk6TWlsZXN0b25lMzIyNDE3Mg==","number":4,"title":"5.1.0","description":null,"creator":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":3,"state":"open","created_at":"2018-03-28T05:31:13Z","updated_at":"2018-03-28T21:57:52Z","due_on":null,"closed_at":null},"comments":3,"created_at":"2016-08-26T08:25:35Z","updated_at":"2018-03-28T21:58:58Z","closed_at":"2018-03-28T21:57:52Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hello,\n\nI found a bug in the way validation is performed for text content when writing to an XmlStreamWriter, which leads to validation errors.\n\nI've tested it with the 5.0.3 release.\nHere is the code to reproduce:\n\n```\nimport com.ctc.wstx.stax.WstxInputFactory;\nimport com.ctc.wstx.stax.WstxOutputFactory;\nimport org.codehaus.stax2.XMLStreamReader2;\nimport org.codehaus.stax2.XMLStreamWriter2;\nimport org.codehaus.stax2.validation.XMLValidationSchema;\nimport org.codehaus.stax2.validation.XMLValidationSchemaFactory;\n\nimport javax.xml.stream.XMLStreamException;\nimport java.io.InputStream;\nimport java.io.StringWriter;\n\npublic class Converter {\n\n    public static void main(String... args) throws XMLStreamException {\n\n        InputStream reader = Converter.class.getClassLoader().getResourceAsStream(\"test.xml\");\n        StringWriter writer = new StringWriter();\n\n        XMLValidationSchema schema = XMLValidationSchemaFactory.newInstance(XMLValidationSchema.SCHEMA_ID_W3C_SCHEMA)\n                .createSchema(Converter.class.getClassLoader().getResourceAsStream(\"schema.xsd\"));\n\n\n        XMLStreamReader2 xmlReader = (XMLStreamReader2) new WstxInputFactory().createXMLStreamReader(reader);\n        xmlReader.validateAgainst(schema);\n\n        XMLStreamWriter2 xmlWriter = (XMLStreamWriter2) new WstxOutputFactory().createXMLStreamWriter(writer);\n        xmlWriter.validateAgainst(schema);\n\n        xmlWriter.copyEventFromReader(xmlReader, false);\n\n        while (xmlReader.hasNext()) {\n            xmlReader.next();\n\n            xmlWriter.copyEventFromReader(xmlReader, true);\n        }\n\n        System.out.println(writer.toString());\n    }\n}\n```\n\nHere is the XML:\n\n```\n<?xml version='1.0' encoding='UTF-8'?>\n<Document>1</Document>\n\n```\n\nand the schema\n\n```\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xs:schema elementFormDefault=\"unqualified\"\n           xmlns:xs=\"http://www.w3.org/2001/XMLSchema\">\n    <xs:element name=\"Document\" type=\"xs:int\"/>\n</xs:schema>\n```\n\nRunning the example code with those two files results in the following exception being thrown:\n\n```\nException in thread \"main\" com.ctc.wstx.exc.WstxValidationException: Unknown reason\n at [row,col {unknown-source}]: [1,61]\n    at com.ctc.wstx.exc.WstxValidationException.create(WstxValidationException.java:50)\n    at com.ctc.wstx.sw.BaseStreamWriter.reportProblem(BaseStreamWriter.java:1243)\n    at com.ctc.wstx.msv.GenericMsvValidator.reportError(GenericMsvValidator.java:549)\n    at com.ctc.wstx.msv.GenericMsvValidator.reportError(GenericMsvValidator.java:541)\n    at com.ctc.wstx.msv.GenericMsvValidator.reportError(GenericMsvValidator.java:535)\n    at com.ctc.wstx.msv.GenericMsvValidator.validateElementEnd(GenericMsvValidator.java:390)\n    at com.ctc.wstx.sw.BaseNsStreamWriter.doWriteEndTag(BaseNsStreamWriter.java:742)\n    at com.ctc.wstx.sw.BaseNsStreamWriter.writeEndElement(BaseNsStreamWriter.java:291)\n    at com.ctc.wstx.sw.BaseStreamWriter.copyEventFromReader(BaseStreamWriter.java:795)\n    at Converter.main(Converter.java:34)\n    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n    at java.lang.reflect.Method.invoke(Method.java:606)\n    at com.intellij.rt.execution.application.AppMain.main(AppMain.java:147)\n```\n\nWhen reading that XML, no error occur, this only happens when writing.\nAdditionnaly, if I change the type of the Document element to xs:string in the XSD, validation is successful.\n\nI've dug a bit into this, my understanding is that the stream writer doesn't pass text content to the validator, GenericMsvValidator#validateText is never called, and as a result GenericMsvValidator#mTextAccumulator stays empty until validateElementEnd is called.\n","closed_by":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/FasterXML/woodstox/issues/23/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/FasterXML/woodstox/issues/23/timeline","performed_via_github_app":null,"state_reason":"completed"}