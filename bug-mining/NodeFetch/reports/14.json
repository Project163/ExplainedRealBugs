{"url":"https://api.github.com/repos/node-fetch/node-fetch/issues/378","repository_url":"https://api.github.com/repos/node-fetch/node-fetch","labels_url":"https://api.github.com/repos/node-fetch/node-fetch/issues/378/labels{/name}","comments_url":"https://api.github.com/repos/node-fetch/node-fetch/issues/378/comments","events_url":"https://api.github.com/repos/node-fetch/node-fetch/issues/378/events","html_url":"https://github.com/node-fetch/node-fetch/issues/378","id":280525800,"node_id":"MDU6SXNzdWUyODA1MjU4MDA=","number":378,"title":"Errors on the body pipe are only handled if the requests body is accessed which crashes the node process","user":{"login":"MoritzKn","id":10676525,"node_id":"MDQ6VXNlcjEwNjc2NTI1","avatar_url":"https://avatars.githubusercontent.com/u/10676525?v=4","gravatar_id":"","url":"https://api.github.com/users/MoritzKn","html_url":"https://github.com/MoritzKn","followers_url":"https://api.github.com/users/MoritzKn/followers","following_url":"https://api.github.com/users/MoritzKn/following{/other_user}","gists_url":"https://api.github.com/users/MoritzKn/gists{/gist_id}","starred_url":"https://api.github.com/users/MoritzKn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MoritzKn/subscriptions","organizations_url":"https://api.github.com/users/MoritzKn/orgs","repos_url":"https://api.github.com/users/MoritzKn/repos","events_url":"https://api.github.com/users/MoritzKn/events{/privacy}","received_events_url":"https://api.github.com/users/MoritzKn/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":575319007,"node_id":"MDU6TGFiZWw1NzUzMTkwMDc=","url":"https://api.github.com/repos/node-fetch/node-fetch/labels/Node-specific","name":"Node-specific","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-12-08T15:31:50Z","updated_at":"2018-11-27T14:52:45Z","closed_at":"2018-01-27T19:20:06Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"When requesting a site with `node-fetch` and the response sets the `content-encoding` header to `gzip`, the body gets piped through Gunzip:\r\n```js\r\n// for gzip\r\nif (name == 'gzip' || name == 'x-gzip') {\r\n\tbody = body.pipe(zlib.createGunzip());\r\n\toutput = new Response(body, response_options);\r\n\tresolve(output);\r\n\treturn;\r\n}\r\n```\r\nhttps://github.com/bitinn/node-fetch/blob/1.7.3/index.js#L208\r\n\r\nIn cases where the encoding is errorsome Gunzip will emit an error event on the pipe:\r\n```js\r\nfunction zlibOnError(message, errno) {\r\n  // there is no way to cleanly recover.\r\n  // continuing only obscures problems.\r\n  _close(this);\r\n  this._hadError = true;\r\n\r\n  var error = new Error(message);\r\n  error.errno = errno;\r\n  error.code = codes[errno];\r\n  this.emit('error', error);\r\n}\r\n```\r\nhttps://github.com/nodejs/node/blob/v8.9.1/lib/zlib.js#L156\r\n\r\nIf I already called `response.text()` (`fetch(url).then(response => response.text())`) or similar (e.g. `.json()`), `Body.prototype._decode` gets called and sets an error handler on the body steam:\r\n\r\n```js\r\nBody.prototype._decode = function() {\r\n\t[...]\r\n\treturn new Body.Promise(function(resolve, reject) {\r\n\t\t[...]\r\n\t\tself.body.on('error', function(err) {\r\n\t\t\treject(new FetchError('invalid response body at: ' + self.url + ' reason: ' + err.message, 'system', err));\r\n\t\t});\r\n\t\t[...]\r\n\t});\r\n};\r\n```\r\nhttps://github.com/bitinn/node-fetch/blob/1.7.3/lib/body.js#L122\r\n\r\nHowever if I don't call `.text()` (for example because I only care for the status code), there will be no error handler and node will throw an exception:\r\n\r\n```js\r\nEventEmitter.prototype.emit = function emit(type) {\r\n  [...]\r\n  var doError = (type === 'error');\r\n\r\n  events = this._events;\r\n  if (events)\r\n    doError = (doError && events.error == null);\r\n  [...]\r\n  // If there is no 'error' event listener then throw.\r\n  if (doError) {\r\n    if (arguments.length > 1)\r\n      [...]\r\n    } else if (er instanceof Error) {\r\n      throw er; // Unhandled 'error' event\r\n    }\r\n  }\r\n  [...]\r\n};\r\n```\r\nhttps://github.com/nodejs/node/blob/v8.9.1/lib/events.js#L169\r\n\r\nBecause of this an exception is thrown so deep in the core of node, it is not possible to catch. In response node crashes because of an uncaught exception.\r\n\r\nA workaround for this is to always call `response.text()` even if you don't use it.\r\n\r\nThis is a very nasty error because you get little to no infos on what it the cause. All you get is:\r\n```\r\nevents.js:183\r\n      throw er; // Unhandled 'error' event\r\n      ^\r\nError: unexpected end of file\r\n    at Gunzip.zlibOnError (zlib.js:153:15)\r\n```\r\n\r\nI'm using:\r\nNode: `v8.9.1`\r\nNode Fetch: `1.7.3`\r\nOS: maxOs 10.12.6","closed_by":{"login":"TimothyGu","id":1538624,"node_id":"MDQ6VXNlcjE1Mzg2MjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1538624?v=4","gravatar_id":"","url":"https://api.github.com/users/TimothyGu","html_url":"https://github.com/TimothyGu","followers_url":"https://api.github.com/users/TimothyGu/followers","following_url":"https://api.github.com/users/TimothyGu/following{/other_user}","gists_url":"https://api.github.com/users/TimothyGu/gists{/gist_id}","starred_url":"https://api.github.com/users/TimothyGu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimothyGu/subscriptions","organizations_url":"https://api.github.com/users/TimothyGu/orgs","repos_url":"https://api.github.com/users/TimothyGu/repos","events_url":"https://api.github.com/users/TimothyGu/events{/privacy}","received_events_url":"https://api.github.com/users/TimothyGu/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/node-fetch/node-fetch/issues/378/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/node-fetch/node-fetch/issues/378/timeline","performed_via_github_app":null,"state_reason":"completed"}