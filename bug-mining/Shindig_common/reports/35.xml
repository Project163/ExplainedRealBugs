<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:34:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SHINDIG-1132] ClassLoader memory leak caused by XmlUtil ThreadLocal</title>
                <link>https://issues.apache.org/jira/browse/SHINDIG-1132</link>
                <project id="12310741" key="SHINDIG">Shindig</project>
                    <description>&lt;p&gt;The class org.apache.shindig.common.xml.XmlUtil caches a javax.xml.parsers.DocumentBuilder in the ThreadLocal reusableBuilder variable. These instances are created with the static ErrorHandler instance which creates the strong reference to the XmlUtil class that prevents the ClassLoader from being reclaimed.&lt;/p&gt;

&lt;p&gt;Currently the only way to turn off this behaviour is for DocumentBuilder.reset() to throw an exception.&lt;/p&gt;

&lt;p&gt;We need a way to turn off this caching. Maybe the caching aspect could be injected via Guice?&lt;/p&gt;</description>
                <environment>When trying to unload the ClassLoader that loaded Shindig, for instance in an OSGi environment</environment>
        <key id="12431651">SHINDIG-1132</key>
            <summary>ClassLoader memory leak caused by XmlUtil ThreadLocal</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="jedws">Jed Wesley-Smith</reporter>
                        <labels>
                    </labels>
                <created>Wed, 29 Jul 2009 01:03:58 +0000</created>
                <updated>Tue, 7 Aug 2012 21:47:34 +0000</updated>
                            <resolved>Mon, 16 Nov 2009 19:53:45 +0000</resolved>
                                    <version>1.0</version>
                                    <fixVersion>1.1-BETA5</fixVersion>
                                    <component>Java</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12736814" author="plindner" created="Wed, 29 Jul 2009 20:36:33 +0000"  >&lt;p&gt;would creating a new errorhandler instance per builder fix this?&lt;/p&gt;

&lt;p&gt;@@ -279,7 +266,21 @@ public class XmlUtil {&lt;br/&gt;
     } else &lt;/p&gt;
{
       builder = builderFactory.newDocumentBuilder();
     }
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;builder.setErrorHandler(errorHandler);&lt;br/&gt;
+&lt;br/&gt;
+    // Create a new ErrorHandler to avoid ClassLoader issues.&lt;br/&gt;
+    builder.setErrorHandler(new ErrorHandler() 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+      public void error(SAXParseException exception) throws SAXException {
+        throw exception;
+      }&lt;br/&gt;
+      public void fatalError(SAXParseException exception) throws SAXException {+        throw exception;+      }+      public void warning(SAXParseException exception) {
+        // warnings can be ignored.
+        LOG.log(Level.INFO, &quot;XmlUtil warning&quot;, exception);
+      }+    }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;);&lt;br/&gt;
+&lt;br/&gt;
     return builder;&lt;br/&gt;
   }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Otherwise we might want to investigate a guice threadlocal scope as outlined here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://code.google.com/p/google-guice/issues/detail?id=114&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://code.google.com/p/google-guice/issues/detail?id=114&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12736934" author="jedws" created="Thu, 30 Jul 2009 00:30:19 +0000"  >&lt;p&gt;Unfortunately, the problem is that the instance inside the threadlocal contains  a strong reference to the XmlUtil class. Making it a new instance each time or using the Guide threadlocal do not change this at all and will not fix the problem.&lt;/p&gt;

&lt;p&gt;The simplest fix would be to set the error handler to null after using it (example doing this in the parse method):&lt;/p&gt;

&lt;p&gt;Index: XmlUtil.java&lt;br/&gt;
===================================================================&lt;br/&gt;
&amp;#8212; XmlUtil.java	(revision 33230)&lt;br/&gt;
+++ XmlUtil.java	(working copy)&lt;br/&gt;
@@ -282,23 +282,29 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Attempts to parse the input xml into a single element.&lt;/li&gt;
	&lt;li&gt;@param xml&lt;/li&gt;
	&lt;li&gt;@return The document object&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* @throws XmlException if a parse error occured.&lt;br/&gt;
+   * @throws XmlException if a parse error occurred.&lt;br/&gt;
    */&lt;br/&gt;
   public static Element parse(String xml) throws XmlException {&lt;br/&gt;
     try 
{
-      DocumentBuilder builder = getBuilder();
-      InputSource is = new InputSource(new StringReader(xml.trim()));
-      Element element = builder.parse(is).getDocumentElement();
-      return element;
-    }
&lt;p&gt; catch (SAXParseException e) &lt;/p&gt;
{
-      throw new XmlException(
-          e.getMessage() + &quot; At: (&quot; + e.getLineNumber() + &apos;,&apos; + e.getColumnNumber() + &apos;)&apos;, e);
-    }
&lt;p&gt; catch (SAXException e) {&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;throw new XmlException(e);&lt;br/&gt;
+      final DocumentBuilder builder = getBuilder();&lt;br/&gt;
+      try 
{
+        InputSource is = new InputSource(new StringReader(xml.trim()));
+        Element element = builder.parse(is).getDocumentElement();
+        return element;
+      }
&lt;p&gt; catch (SAXParseException e) &lt;/p&gt;
{
+        throw new XmlException(
+            e.getMessage() + &quot; At: (&quot; + e.getLineNumber() + &apos;,&apos; + e.getColumnNumber() + &apos;)&apos;, e);
+      }
&lt;p&gt; catch (SAXException e) &lt;/p&gt;
{
+        throw new XmlException(e);
+      } catch (IOException e) {+        throw new XmlException(e);+      }
&lt;p&gt; finally &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+        if (builder != null) {
+          builder.setErrorHandler(null);
+        }+      }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;     } catch (ParserConfigurationException e) &lt;/p&gt;
{
       throw new XmlException(e);
-    }
&lt;p&gt; catch (IOException e) &lt;/p&gt;
{
-      throw new XmlException(e);
     }
&lt;p&gt;   }&lt;br/&gt;
 }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12778485" author="plindner" created="Mon, 16 Nov 2009 19:53:45 +0000"  >&lt;p&gt;patch applied&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12601662">RAVE-750</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>174416</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 1 week, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i10bhr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>209996</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>