{"url":"https://api.github.com/repos/hashicorp/vagrant/issues/10869","repository_url":"https://api.github.com/repos/hashicorp/vagrant","labels_url":"https://api.github.com/repos/hashicorp/vagrant/issues/10869/labels{/name}","comments_url":"https://api.github.com/repos/hashicorp/vagrant/issues/10869/comments","events_url":"https://api.github.com/repos/hashicorp/vagrant/issues/10869/events","html_url":"https://github.com/hashicorp/vagrant/issues/10869","id":446597687,"node_id":"MDU6SXNzdWU0NDY1OTc2ODc=","number":10869,"title":"Vagrant rsync plugin fails when 'rsync__exclude' array is empty","user":{"login":"cjsin","id":19607446,"node_id":"MDQ6VXNlcjE5NjA3NDQ2","avatar_url":"https://avatars.githubusercontent.com/u/19607446?v=4","gravatar_id":"","url":"https://api.github.com/users/cjsin","html_url":"https://github.com/cjsin","followers_url":"https://api.github.com/users/cjsin/followers","following_url":"https://api.github.com/users/cjsin/following{/other_user}","gists_url":"https://api.github.com/users/cjsin/gists{/gist_id}","starred_url":"https://api.github.com/users/cjsin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cjsin/subscriptions","organizations_url":"https://api.github.com/users/cjsin/orgs","repos_url":"https://api.github.com/users/cjsin/repos","events_url":"https://api.github.com/users/cjsin/events{/privacy}","received_events_url":"https://api.github.com/users/cjsin/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":25816,"node_id":"MDU6TGFiZWwyNTgxNg==","url":"https://api.github.com/repos/hashicorp/vagrant/labels/bug","name":"bug","color":"e11d21","default":true,"description":null},{"id":218284916,"node_id":"MDU6TGFiZWwyMTgyODQ5MTY=","url":"https://api.github.com/repos/hashicorp/vagrant/labels/synced-folders/rsync","name":"synced-folders/rsync","color":"fef2c0","default":false,"description":null},{"id":867284247,"node_id":"MDU6TGFiZWw4NjcyODQyNDc=","url":"https://api.github.com/repos/hashicorp/vagrant/labels/task-small","name":"task-small","color":"d8dd3b","default":false,"description":""}],"state":"closed","locked":true,"assignee":{"login":"briancain","id":810277,"node_id":"MDQ6VXNlcjgxMDI3Nw==","avatar_url":"https://avatars.githubusercontent.com/u/810277?v=4","gravatar_id":"","url":"https://api.github.com/users/briancain","html_url":"https://github.com/briancain","followers_url":"https://api.github.com/users/briancain/followers","following_url":"https://api.github.com/users/briancain/following{/other_user}","gists_url":"https://api.github.com/users/briancain/gists{/gist_id}","starred_url":"https://api.github.com/users/briancain/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/briancain/subscriptions","organizations_url":"https://api.github.com/users/briancain/orgs","repos_url":"https://api.github.com/users/briancain/repos","events_url":"https://api.github.com/users/briancain/events{/privacy}","received_events_url":"https://api.github.com/users/briancain/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"briancain","id":810277,"node_id":"MDQ6VXNlcjgxMDI3Nw==","avatar_url":"https://avatars.githubusercontent.com/u/810277?v=4","gravatar_id":"","url":"https://api.github.com/users/briancain","html_url":"https://github.com/briancain","followers_url":"https://api.github.com/users/briancain/followers","following_url":"https://api.github.com/users/briancain/following{/other_user}","gists_url":"https://api.github.com/users/briancain/gists{/gist_id}","starred_url":"https://api.github.com/users/briancain/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/briancain/subscriptions","organizations_url":"https://api.github.com/users/briancain/orgs","repos_url":"https://api.github.com/users/briancain/repos","events_url":"https://api.github.com/users/briancain/events{/privacy}","received_events_url":"https://api.github.com/users/briancain/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/hashicorp/vagrant/milestones/43","html_url":"https://github.com/hashicorp/vagrant/milestone/43","labels_url":"https://api.github.com/repos/hashicorp/vagrant/milestones/43/labels","id":4093855,"node_id":"MDk6TWlsZXN0b25lNDA5Mzg1NQ==","number":43,"title":"2.2.5","description":"","creator":{"login":"chrisroberts","id":266674,"node_id":"MDQ6VXNlcjI2NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/266674?v=4","gravatar_id":"","url":"https://api.github.com/users/chrisroberts","html_url":"https://github.com/chrisroberts","followers_url":"https://api.github.com/users/chrisroberts/followers","following_url":"https://api.github.com/users/chrisroberts/following{/other_user}","gists_url":"https://api.github.com/users/chrisroberts/gists{/gist_id}","starred_url":"https://api.github.com/users/chrisroberts/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chrisroberts/subscriptions","organizations_url":"https://api.github.com/users/chrisroberts/orgs","repos_url":"https://api.github.com/users/chrisroberts/repos","events_url":"https://api.github.com/users/chrisroberts/events{/privacy}","received_events_url":"https://api.github.com/users/chrisroberts/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":31,"state":"closed","created_at":"2019-02-27T18:22:57Z","updated_at":"2019-12-01T10:29:03Z","due_on":null,"closed_at":"2019-07-10T21:53:34Z"},"comments":1,"created_at":"2019-05-21T12:43:39Z","updated_at":"2020-01-28T02:37:48Z","closed_at":"2019-06-17T15:18:20Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Vagrant version\r\n2.0.2\r\n\r\n### Host operating system\r\nLinux\r\n\r\n### Guest operating system\r\nLinux\r\n\r\n### Vagrantfile\r\n```ruby\r\nVagrant.configure(\"2\") do |config|\r\n    config.vm.box = \"centos/7\"\r\n    config.vm.box_check_update = false\r\n\r\n    config.vm.define \"example\" do |example|\r\n        config.vm.synced_folder \"./test\", \"/test/\", type: \"rsync\", rsync__exclude: [] \r\n    end\r\nend\r\n```\r\n\r\nPlease note, if you are using Homestead or a different Vagrantfile format, we\r\nmay be unable to assist with your issue. Try to reproduce the issue using a\r\nvanilla Vagrantfile first.\r\n\r\n### Debug output\r\nNo need for the debug output as I have found the issue already.\r\n\r\n### Expected behavior\r\nThe empty array should not trigger an rsync or provision to fail.\r\nIdeally the rsync vagrant plugin should support an empty excludes array because in some cases this array needs to be calculated programmatically and can be empty.\r\n\r\n### Actual behavior\r\nThe rsync plugin generates a 'find' command with invalid syntax, which causes the rsync to fail, which therefore prevents provisioning from being triggered.\r\n\r\n### Steps to reproduce\r\n1. Use a vm.synced_folder directive of type 'rsync' and a parameter 'rsync_exclude: []' \r\n2. Use 'vagrant up'\r\n3. Wait for the rsync to finish.\r\n\r\nThe following error is produced:\r\n\r\n```\r\nfind /test  -o '!' -type l -a '(' ! -user vagrant -or ! -group vagrant ')' -exec chown vagrant:vagrant '{}' +\r\nStdout from the command:\r\nStderr from the command:\r\nfind: invalid expression; you have used a binary operator '-o' with nothing before it.\r\n```\r\n\r\nAs can be seen from the error output, the '-o' flag is extraneous in the case where the exclusions list was empty.\r\n\r\nThe problematic code exists in the current master version on github.\r\nThe source code file is vagrant/plugins/synced_folders/rsync/default_unix_cap.rb\r\nThe line numbers are 32-37.\r\n\r\nThe code is as follows, and leads to a '-o' being included in the corner case of the array being empty (instead of '-o' being used to separate items.\r\n\r\nThe code in question:\r\n```ruby\r\n        if(opts[:exclude])\r\n          exclude_base = Pathname.new(opts[:guestpath])\r\n          exclusions = Array(opts[:exclude]).map do |ex_path|\r\n            ex_path = ex_path.slice(1, ex_path.size) if ex_path.start_with?(File::SEPARATOR)\r\n            \"-path #{Shellwords.escape(exclude_base.join(ex_path))} -prune\"\r\n          end.join(\" -o \") + \" -o \"\r\n ```\r\n\r\nPotential fix:\r\n\r\nI tried the following fix and it resolved the issue for me.\r\n\r\nline 32:\r\n\r\nexisting code:\r\n\r\n```ruby\r\n        if(opts[:exclude])\r\n```\r\n\r\nnew line:\r\n\r\n```ruby\r\n        if(opts[:exclude] && Array(opts[:exclude]).length > 0)\r\n```\r\n","closed_by":{"login":"briancain","id":810277,"node_id":"MDQ6VXNlcjgxMDI3Nw==","avatar_url":"https://avatars.githubusercontent.com/u/810277?v=4","gravatar_id":"","url":"https://api.github.com/users/briancain","html_url":"https://github.com/briancain","followers_url":"https://api.github.com/users/briancain/followers","following_url":"https://api.github.com/users/briancain/following{/other_user}","gists_url":"https://api.github.com/users/briancain/gists{/gist_id}","starred_url":"https://api.github.com/users/briancain/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/briancain/subscriptions","organizations_url":"https://api.github.com/users/briancain/orgs","repos_url":"https://api.github.com/users/briancain/repos","events_url":"https://api.github.com/users/briancain/events{/privacy}","received_events_url":"https://api.github.com/users/briancain/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/hashicorp/vagrant/issues/10869/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/hashicorp/vagrant/issues/10869/timeline","performed_via_github_app":null,"state_reason":"completed"}