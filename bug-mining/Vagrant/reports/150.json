{"url":"https://api.github.com/repos/hashicorp/vagrant/issues/10585","repository_url":"https://api.github.com/repos/hashicorp/vagrant","labels_url":"https://api.github.com/repos/hashicorp/vagrant/issues/10585/labels{/name}","comments_url":"https://api.github.com/repos/hashicorp/vagrant/issues/10585/comments","events_url":"https://api.github.com/repos/hashicorp/vagrant/issues/10585/events","html_url":"https://github.com/hashicorp/vagrant/issues/10585","id":398251253,"node_id":"MDU6SXNzdWUzOTgyNTEyNTM=","number":10585,"title":"debian/stretch64 9.6.0 box configured with private_network and dhcp gets wrong IP-address with systemd-networkd","user":{"login":"nestthvt","id":46589385,"node_id":"MDQ6VXNlcjQ2NTg5Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/46589385?v=4","gravatar_id":"","url":"https://api.github.com/users/nestthvt","html_url":"https://github.com/nestthvt","followers_url":"https://api.github.com/users/nestthvt/followers","following_url":"https://api.github.com/users/nestthvt/following{/other_user}","gists_url":"https://api.github.com/users/nestthvt/gists{/gist_id}","starred_url":"https://api.github.com/users/nestthvt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nestthvt/subscriptions","organizations_url":"https://api.github.com/users/nestthvt/orgs","repos_url":"https://api.github.com/users/nestthvt/repos","events_url":"https://api.github.com/users/nestthvt/events{/privacy}","received_events_url":"https://api.github.com/users/nestthvt/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":157557761,"node_id":"MDU6TGFiZWwxNTc1NTc3NjE=","url":"https://api.github.com/repos/hashicorp/vagrant/labels/guest/debian","name":"guest/debian","color":"5319e7","default":false,"description":null},{"id":283683436,"node_id":"MDU6TGFiZWwyODM2ODM0MzY=","url":"https://api.github.com/repos/hashicorp/vagrant/labels/has-pr","name":"has-pr","color":"fef2c0","default":false,"description":null},{"id":425128607,"node_id":"MDU6TGFiZWw0MjUxMjg2MDc=","url":"https://api.github.com/repos/hashicorp/vagrant/labels/networking","name":"networking","color":"0e8a16","default":false,"description":null}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/hashicorp/vagrant/milestones/42","html_url":"https://github.com/hashicorp/vagrant/milestone/42","labels_url":"https://api.github.com/repos/hashicorp/vagrant/milestones/42/labels","id":3960072,"node_id":"MDk6TWlsZXN0b25lMzk2MDA3Mg==","number":42,"title":"2.2.4","description":"","creator":{"login":"chrisroberts","id":266674,"node_id":"MDQ6VXNlcjI2NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/266674?v=4","gravatar_id":"","url":"https://api.github.com/users/chrisroberts","html_url":"https://github.com/chrisroberts","followers_url":"https://api.github.com/users/chrisroberts/followers","following_url":"https://api.github.com/users/chrisroberts/following{/other_user}","gists_url":"https://api.github.com/users/chrisroberts/gists{/gist_id}","starred_url":"https://api.github.com/users/chrisroberts/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chrisroberts/subscriptions","organizations_url":"https://api.github.com/users/chrisroberts/orgs","repos_url":"https://api.github.com/users/chrisroberts/repos","events_url":"https://api.github.com/users/chrisroberts/events{/privacy}","received_events_url":"https://api.github.com/users/chrisroberts/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":18,"state":"closed","created_at":"2019-01-10T17:37:29Z","updated_at":"2019-02-27T18:23:20Z","due_on":null,"closed_at":"2019-02-27T18:23:20Z"},"comments":1,"created_at":"2019-01-11T11:32:34Z","updated_at":"2020-03-28T02:00:52Z","closed_at":"2019-01-12T00:22:13Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"\r\n### Vagrant version\r\n\r\nVagrant 2.1.5\r\n\r\n\r\n### Host operating system\r\n\r\nWindows 7\r\n\r\n\r\n### Guest operating system\r\n\r\ndebian/stretch64  (virtualbox, 9.6.0)\r\n\r\n\r\n### Vagrantfile\r\n\r\n\r\n```\r\nVagrant.configure(\"2\") do |config|\r\n  config.vm.box = \"debian/stretch64\"\r\n  config.vm.network \"private_network\", type: \"dhcp\"\r\n\r\n  config.vm.provision \"shell\", inline: <<-SHELL\r\n    sudo systemctl enable systemd-networkd.service\r\n  SHELL \r\nend\r\n```\r\n\r\n\r\n### Debug output\r\n\r\n\r\nImportant lines from the 'vagrant up'-debug ouput after reboot:\r\n\r\n```\r\n INFO ssh: Execute: sudo systemctl status systemd-networkd.service (sudo=false)\r\nDEBUG ssh: stderr: 41e57d38-b4f7-4e46-9c38-13873d338b86-vagrant-ssh\r\nDEBUG ssh: Exit status: 0\r\nDEBUG ssh: Uploading: D:/WS/Temp/vagrant-debian-configure-networks20190111-1224-1wc9fyk to /tmp/vagrant-network-entry-1547201289\r\nDEBUG ssh: Re-using SSH connection.\r\nDEBUG ssh: Re-using SSH connection.\r\n INFO ssh: Execute: mkdir -p /etc/systemd/network\r\nmv -f '/tmp/vagrant-network-entry-1547201289' '/etc/systemd/network/50-vagrant-eth1.network'\r\n\r\n```\r\n\r\nVagrant stores following network-configuration into the vm:\r\n\r\n```\r\nD:\\WS\\Vagrant\\BugRepro>vagrant ssh -c \"cat /etc/systemd/network/50-vagrant-eth1.network\"\r\n[Match]\r\nName=eth1\r\n[Network]\r\nDHCP=no\r\nAddress=172.28.128.1/24\r\nConnection to 127.0.0.1 closed.\r\n```\r\n\r\nWhich results in an invalid IP-address:\r\n\r\n```\r\nD:\\WS\\Vagrant\\BugRepro>vagrant ssh -c \"ip addr show\"\r\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1\r\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\r\n    inet 127.0.0.1/8 scope host lo\r\n       valid_lft forever preferred_lft forever\r\n    inet6 ::1/128 scope host\r\n       valid_lft forever preferred_lft forever\r\n2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\r\n    link/ether 08:00:27:8d:c0:4d brd ff:ff:ff:ff:ff:ff\r\n    inet 10.0.2.15/24 brd 10.0.2.255 scope global eth0\r\n       valid_lft forever preferred_lft forever\r\n    inet6 fe80::a00:27ff:fe8d:c04d/64 scope link\r\n       valid_lft forever preferred_lft forever\r\n3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\r\n    link/ether 08:00:27:37:59:f8 brd ff:ff:ff:ff:ff:ff\r\n    inet 172.28.128.1/24 brd 172.28.128.255 scope global eth1\r\n       valid_lft forever preferred_lft forever\r\n    inet6 fe80::a00:27ff:fe37:59f8/64 scope link\r\n       valid_lft forever preferred_lft forever\r\nConnection to 127.0.0.1 closed.\r\n```\r\n\r\n\r\n### Expected behavior\r\n\r\n- DHCP should be set to yes\r\n- a dynamic IP adress should be assigned in the range given by the used \"VirtualBox-Host-Only Ethernet Adapter\"\r\n\r\n\r\n### Actual behavior\r\n\r\n- DHCP should be set to no. \r\n- a static invalid IP-address is configured (address is the one of the used \"VirtualBox-Host-Only Ethernet Adapter\")\r\n\r\n\r\n### Steps to reproduce\r\n\r\n1. create a new directory and store the given Vagrantfile to it\r\n2. running machine and enable the systemd-netword-service (will be done automatically)\r\n3. restart the machine and check the assigned IP-address\r\n4. inspect the created network-config-file under `/etc/systemd/network/`\r\n\r\n\r\n### References\r\n\r\nProblem is similar to #9570\r\n\r\nThe IP-Address will be set in case dhcp is enabled by C:\\HashiCorp\\Vagrant\\embedded\\gems\\2.1.5\\gems\\vagrant-2.1.5\\plugins\\providers\\virtualbox\\action\\network.rb:259:\r\n \r\n```\r\n\r\n          # Default IP is in the 20-bit private network block for DHCP based networks\r\n          options[:ip] = \"172.28.128.1\" if options[:type] == :dhcp && !options[:ip]\r\n\r\n```\r\n\r\n\r\nIf the IP-adress is set, dhcp will be disabled by 'C:\\HashiCorp\\Vagrant\\embedded\\gems\\2.1.5\\gems\\vagrant-2.1.5\\plugins\\guests\\debian\\cap\\configure_networks.rb:92':\r\n\r\n```\r\n            if network[:ip]\r\n              mask = network[:netmask]\r\n              if mask && IPAddr.new(network[:ip]).ipv4?\r\n                begin\r\n                  mask = IPAddr.new(mask).to_i.to_s(2).count(\"1\")\r\n                rescue IPAddr::Error\r\n                  # ignore and use given value\r\n                end\r\n              end\r\n              address = [network[:ip], mask].compact.join(\"/\")\r\n              net_conf << \"DHCP=no\"\r\n              net_conf << \"Address=#{address}\"\r\n              net_conf << \"Gateway=#{network[:gateway]}\" if network[:gateway]\r\n            else\r\n              net_conf << \"DHCP=yes\"\r\n            end\r\n```\r\n\r\n","closed_by":{"login":"briancain","id":810277,"node_id":"MDQ6VXNlcjgxMDI3Nw==","avatar_url":"https://avatars.githubusercontent.com/u/810277?v=4","gravatar_id":"","url":"https://api.github.com/users/briancain","html_url":"https://github.com/briancain","followers_url":"https://api.github.com/users/briancain/followers","following_url":"https://api.github.com/users/briancain/following{/other_user}","gists_url":"https://api.github.com/users/briancain/gists{/gist_id}","starred_url":"https://api.github.com/users/briancain/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/briancain/subscriptions","organizations_url":"https://api.github.com/users/briancain/orgs","repos_url":"https://api.github.com/users/briancain/repos","events_url":"https://api.github.com/users/briancain/events{/privacy}","received_events_url":"https://api.github.com/users/briancain/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/hashicorp/vagrant/issues/10585/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/hashicorp/vagrant/issues/10585/timeline","performed_via_github_app":null,"state_reason":"completed"}