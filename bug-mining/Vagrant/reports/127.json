{"url":"https://api.github.com/repos/hashicorp/vagrant/issues/10289","repository_url":"https://api.github.com/repos/hashicorp/vagrant","labels_url":"https://api.github.com/repos/hashicorp/vagrant/issues/10289/labels{/name}","comments_url":"https://api.github.com/repos/hashicorp/vagrant/issues/10289/comments","events_url":"https://api.github.com/repos/hashicorp/vagrant/issues/10289/events","html_url":"https://github.com/hashicorp/vagrant/issues/10289","id":369055386,"node_id":"MDU6SXNzdWUzNjkwNTUzODY=","number":10289,"title":"Vagrant rsync plugin unreliable: it copies files to different hosts sometimes `rand(1000)` collision","user":{"login":"edwintorok","id":721894,"node_id":"MDQ6VXNlcjcyMTg5NA==","avatar_url":"https://avatars.githubusercontent.com/u/721894?v=4","gravatar_id":"","url":"https://api.github.com/users/edwintorok","html_url":"https://github.com/edwintorok","followers_url":"https://api.github.com/users/edwintorok/followers","following_url":"https://api.github.com/users/edwintorok/following{/other_user}","gists_url":"https://api.github.com/users/edwintorok/gists{/gist_id}","starred_url":"https://api.github.com/users/edwintorok/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/edwintorok/subscriptions","organizations_url":"https://api.github.com/users/edwintorok/orgs","repos_url":"https://api.github.com/users/edwintorok/repos","events_url":"https://api.github.com/users/edwintorok/events{/privacy}","received_events_url":"https://api.github.com/users/edwintorok/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":25816,"node_id":"MDU6TGFiZWwyNTgxNg==","url":"https://api.github.com/repos/hashicorp/vagrant/labels/bug","name":"bug","color":"e11d21","default":true,"description":null},{"id":218284916,"node_id":"MDU6TGFiZWwyMTgyODQ5MTY=","url":"https://api.github.com/repos/hashicorp/vagrant/labels/synced-folders/rsync","name":"synced-folders/rsync","color":"fef2c0","default":false,"description":null},{"id":283683436,"node_id":"MDU6TGFiZWwyODM2ODM0MzY=","url":"https://api.github.com/repos/hashicorp/vagrant/labels/has-pr","name":"has-pr","color":"fef2c0","default":false,"description":null}],"state":"closed","locked":true,"assignee":{"login":"briancain","id":810277,"node_id":"MDQ6VXNlcjgxMDI3Nw==","avatar_url":"https://avatars.githubusercontent.com/u/810277?v=4","gravatar_id":"","url":"https://api.github.com/users/briancain","html_url":"https://github.com/briancain","followers_url":"https://api.github.com/users/briancain/followers","following_url":"https://api.github.com/users/briancain/following{/other_user}","gists_url":"https://api.github.com/users/briancain/gists{/gist_id}","starred_url":"https://api.github.com/users/briancain/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/briancain/subscriptions","organizations_url":"https://api.github.com/users/briancain/orgs","repos_url":"https://api.github.com/users/briancain/repos","events_url":"https://api.github.com/users/briancain/events{/privacy}","received_events_url":"https://api.github.com/users/briancain/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"briancain","id":810277,"node_id":"MDQ6VXNlcjgxMDI3Nw==","avatar_url":"https://avatars.githubusercontent.com/u/810277?v=4","gravatar_id":"","url":"https://api.github.com/users/briancain","html_url":"https://github.com/briancain","followers_url":"https://api.github.com/users/briancain/followers","following_url":"https://api.github.com/users/briancain/following{/other_user}","gists_url":"https://api.github.com/users/briancain/gists{/gist_id}","starred_url":"https://api.github.com/users/briancain/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/briancain/subscriptions","organizations_url":"https://api.github.com/users/briancain/orgs","repos_url":"https://api.github.com/users/briancain/repos","events_url":"https://api.github.com/users/briancain/events{/privacy}","received_events_url":"https://api.github.com/users/briancain/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/hashicorp/vagrant/milestones/37","html_url":"https://github.com/hashicorp/vagrant/milestone/37","labels_url":"https://api.github.com/repos/hashicorp/vagrant/milestones/37/labels","id":3646695,"node_id":"MDk6TWlsZXN0b25lMzY0NjY5NQ==","number":37,"title":"2.1.6","description":"","creator":{"login":"chrisroberts","id":266674,"node_id":"MDQ6VXNlcjI2NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/266674?v=4","gravatar_id":"","url":"https://api.github.com/users/chrisroberts","html_url":"https://github.com/chrisroberts","followers_url":"https://api.github.com/users/chrisroberts/followers","following_url":"https://api.github.com/users/chrisroberts/following{/other_user}","gists_url":"https://api.github.com/users/chrisroberts/gists{/gist_id}","starred_url":"https://api.github.com/users/chrisroberts/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chrisroberts/subscriptions","organizations_url":"https://api.github.com/users/chrisroberts/orgs","repos_url":"https://api.github.com/users/chrisroberts/repos","events_url":"https://api.github.com/users/chrisroberts/events{/privacy}","received_events_url":"https://api.github.com/users/chrisroberts/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":35,"state":"closed","created_at":"2018-09-11T22:50:40Z","updated_at":"2018-10-16T23:43:48Z","due_on":null,"closed_at":"2018-10-16T23:43:48Z"},"comments":1,"created_at":"2018-10-11T10:28:57Z","updated_at":"2020-03-29T02:12:26Z","closed_at":"2018-10-11T17:31:50Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Generating a unique filename by using `rand(1000)` is wrong:\r\nhttps://github.com/hashicorp/vagrant/blob/master/plugins/synced_folders/rsync/helper.rb#L84\r\n\r\nThis has caused numerous random failures in one of our testing infrastructures which uses vagrant to spin up virtual machines. We are rsyncing 3 directories, and sometimes we would see on VM receiving 4 rsync commands and another one just 2.\r\nLooking at the debug logs it can be seen that they both use the same ControlPath socket path (although different IP!)\r\n\r\nPlease  use the equivalent of `mktemp` for generating the temporary filenames, or some other way to ensure uniqueness.\r\n\r\n### Vagrant version\r\nVagrant 2.1.5+dfsg-1\r\nBug confirmed to be present in master:  https://github.com/hashicorp/vagrant/blob/master/plugins/synced_folders/rsync/helper.rb#L84\r\n\r\n### Host operating system\r\nDebian buster/sid\r\n\r\n### Guest operating system\r\nXenServer 7.x\r\n\r\n### Vagrantfile\r\nhttps://github.com/xapi-project/testarossa/blob/master/Vagrantfile\r\n\r\n### Debug output\r\nhttps://gist.githubusercontent.com/edwintorok/f1a256f9c9507a4e61d15b4dae409275/raw/26d9b80247c6d808944b9aeaab76a83c33116839/gistfile1.txt\r\n\r\n\r\n### Expected behavior\r\nRsync run on all 16 VMs and updated /sbin accordingly\r\n\r\n### Actual behavior\r\nRsync got called 4 times on cluster4 and 2 times on cluster14, looking at the logs it is clear that the problem is that both 169.254.0.5 and 169.254.0.15 use the same ControlPath /tmp/ssh.327\r\n```\r\n INFO subprocess: Starting process: [\"/usr/bin/rsync\", \"--whole-file\", \"--verbose\", \"--itemize-changes\", \"--ignore-times\", \"--archive\", \"-z\", \"--copy-links\", \"--no-owner\", \"--no-group\"\r\n, \"--rsync-path\", \"sudo rsync\", \"-e\", \"ssh -p 22 -o LogLevel=FATAL -o ProxyCommand='ssh 'internal-machine' -l 'root' -W %h:%p'  -o ControlMaster=auto -o ControlPath=/tmp/ssh.327 -o Con\r\ntrolPersist=10m  -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i '/root/testarossa/.vagrant/machines/cluster4/xenserver/private_key'\", \"--exclude\",\r\n \".vagrant/\", \"/root/testarossa/xs/sbin/\", \"vagrant@169.254.0.5:/sbin\"]\r\n```\r\n\r\n```\r\n INFO subprocess: Starting process: [\"/usr/bin/rsync\", \"--whole-file\", \"--verbose\", \"--itemize-changes\", \"--ignore-times\", \"--archive\", \"-z\", \"--copy-links\", \"--no-owner\", \"--no-group\"\r\n, \"--rsync-path\", \"sudo rsync\", \"-e\", \"ssh -p 22 -o LogLevel=FATAL -o ProxyCommand='ssh 'internal-machine' -l 'root' -W %h:%p'  -o ControlMaster=auto -o ControlPath=/tmp/ssh.327 -o Con\r\ntrolPersist=10m  -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i '/root/testarossa/.vagrant/machines/cluster14/xenserver/private_key'\", \"--exclude\"\r\n, \".vagrant/\", \"/root/testarossa/xs/sbin/\", \"vagrant@169.254.0.15:/sbin\"]\r\n```\r\n### Steps to reproduce\r\n1. vagrant up many VMs in sequence in a Vagrantfile that uses rsync\r\n2. check the  ControlPath values in the debug logs, they should be distinct when the IP address is distinct\r\n3. Usually needs running vagrant destroy/vagrant up in a loop until the problem is hit.\r\n","closed_by":{"login":"briancain","id":810277,"node_id":"MDQ6VXNlcjgxMDI3Nw==","avatar_url":"https://avatars.githubusercontent.com/u/810277?v=4","gravatar_id":"","url":"https://api.github.com/users/briancain","html_url":"https://github.com/briancain","followers_url":"https://api.github.com/users/briancain/followers","following_url":"https://api.github.com/users/briancain/following{/other_user}","gists_url":"https://api.github.com/users/briancain/gists{/gist_id}","starred_url":"https://api.github.com/users/briancain/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/briancain/subscriptions","organizations_url":"https://api.github.com/users/briancain/orgs","repos_url":"https://api.github.com/users/briancain/repos","events_url":"https://api.github.com/users/briancain/events{/privacy}","received_events_url":"https://api.github.com/users/briancain/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/hashicorp/vagrant/issues/10289/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/hashicorp/vagrant/issues/10289/timeline","performed_via_github_app":null,"state_reason":"completed"}