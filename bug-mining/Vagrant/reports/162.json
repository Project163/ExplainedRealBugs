{"url":"https://api.github.com/repos/hashicorp/vagrant/issues/10823","repository_url":"https://api.github.com/repos/hashicorp/vagrant","labels_url":"https://api.github.com/repos/hashicorp/vagrant/issues/10823/labels{/name}","comments_url":"https://api.github.com/repos/hashicorp/vagrant/issues/10823/comments","events_url":"https://api.github.com/repos/hashicorp/vagrant/issues/10823/events","html_url":"https://github.com/hashicorp/vagrant/issues/10823","id":440142863,"node_id":"MDU6SXNzdWU0NDAxNDI4NjM=","number":10823,"title":"Abort option for triggers incorrectly exits in a multi-threaded context","user":{"login":"pantunex","id":27766684,"node_id":"MDQ6VXNlcjI3NzY2Njg0","avatar_url":"https://avatars.githubusercontent.com/u/27766684?v=4","gravatar_id":"","url":"https://api.github.com/users/pantunex","html_url":"https://github.com/pantunex","followers_url":"https://api.github.com/users/pantunex/followers","following_url":"https://api.github.com/users/pantunex/following{/other_user}","gists_url":"https://api.github.com/users/pantunex/gists{/gist_id}","starred_url":"https://api.github.com/users/pantunex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pantunex/subscriptions","organizations_url":"https://api.github.com/users/pantunex/orgs","repos_url":"https://api.github.com/users/pantunex/repos","events_url":"https://api.github.com/users/pantunex/events{/privacy}","received_events_url":"https://api.github.com/users/pantunex/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":25816,"node_id":"MDU6TGFiZWwyNTgxNg==","url":"https://api.github.com/repos/hashicorp/vagrant/labels/bug","name":"bug","color":"e11d21","default":true,"description":null},{"id":922836310,"node_id":"MDU6TGFiZWw5MjI4MzYzMTA=","url":"https://api.github.com/repos/hashicorp/vagrant/labels/triggers","name":"triggers","color":"2bdbc0","default":false,"description":""}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/hashicorp/vagrant/milestones/43","html_url":"https://github.com/hashicorp/vagrant/milestone/43","labels_url":"https://api.github.com/repos/hashicorp/vagrant/milestones/43/labels","id":4093855,"node_id":"MDk6TWlsZXN0b25lNDA5Mzg1NQ==","number":43,"title":"2.2.5","description":"","creator":{"login":"chrisroberts","id":266674,"node_id":"MDQ6VXNlcjI2NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/266674?v=4","gravatar_id":"","url":"https://api.github.com/users/chrisroberts","html_url":"https://github.com/chrisroberts","followers_url":"https://api.github.com/users/chrisroberts/followers","following_url":"https://api.github.com/users/chrisroberts/following{/other_user}","gists_url":"https://api.github.com/users/chrisroberts/gists{/gist_id}","starred_url":"https://api.github.com/users/chrisroberts/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chrisroberts/subscriptions","organizations_url":"https://api.github.com/users/chrisroberts/orgs","repos_url":"https://api.github.com/users/chrisroberts/repos","events_url":"https://api.github.com/users/chrisroberts/events{/privacy}","received_events_url":"https://api.github.com/users/chrisroberts/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":31,"state":"closed","created_at":"2019-02-27T18:22:57Z","updated_at":"2019-12-01T10:29:03Z","due_on":null,"closed_at":"2019-07-10T21:53:34Z"},"comments":2,"created_at":"2019-05-03T17:22:41Z","updated_at":"2020-04-01T01:55:27Z","closed_at":"2019-05-08T16:15:57Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I use `trigger.abort` to stop Vagrant from doing any further work with my machine once it's been started. The machine in question is a virtual image of a network router, so not a real server and there is nothing Vagrant can help with. (If there is a better way to achieve my goal I will also be happy to learn about it).\r\nMy solution works well when I spin up one single machine. But I get an error when I try to start two machines at once (or simply `vagrant up`).\r\n\r\n### Vagrant version\r\n```\r\n$ vagrant --version\r\nVagrant 2.2.4\r\n```\r\n\r\n### Host operating system\r\nUbuntu 18.04\r\nProbably more important than the host OS is the provider which is libvirt. I am not sure whether the root cause of the bug is Vagrant itself or the provider. I didn't try with another provider. \r\n```\r\n$ virsh version \r\nCompiled against library: libvirt 4.6.0\r\nUsing library: libvirt 4.6.0\r\nUsing API: QEMU 4.6.0\r\nRunning hypervisor: QEMU 2.12.0\r\n```\r\n\r\n### Guest operating system\r\nCentOS based\r\n\r\n### Vagrantfile\r\nMy Vagrantfile includes the following Action based trigger:\r\n```ruby\r\n   config.trigger.after :\"VagrantPlugins::ProviderLibvirt::Action::StartDomain\", type: :action do |trigger|\r\n     trigger.only_on = /pfe$/\r\n     trigger.abort = true\r\n   end\r\n```\r\n\r\nWhen I run `vagrant up vmx01pfe` all is good:\r\n```\r\n$ VAGRANT_EXPERIMENTAL=\"typed_triggers\" vagrant up vmx01pfe\r\n==> vagrant: You have requested to enabled the experimental flag with the following features:\r\n==> vagrant:\r\n==> vagrant: Features:  typed_triggers\r\n==> vagrant:\r\n==> vagrant: Please use with caution, as some of the features may not be fully\r\n==> vagrant: functional yet.\r\nBringing machine 'vmx01pfe' up with 'libvirt' provider...\r\n\r\n[ Output suppressed for brevity ]\r\n\r\n==> vmx01pfe: Creating shared folders metadata...\r\n==> vmx01pfe: Starting domain.\r\n==> vargant: Running action triggers after VagrantPlugins::ProviderLibvirt::Action::StartDomain ...\r\n==> vargant: Running trigger...\r\n==> vargant: Vagrant has been configured to abort. Terminating now...\r\n```\r\n\r\nReturn code is 1. \r\nAll good here.\r\n\r\n\r\nNow I run `vagrant up vmx01pfe vmx02pfe` still with the same Vagrantfile:\r\n```\r\n$ VAGRANT_EXPERIMENTAL=\"typed_triggers\" vagrant up vmx01pfe vmx02pfe                                                                                                                                                                                                         \r\n==> vagrant: You have requested to enabled the experimental flag with the following features:\r\n==> vagrant:\r\n==> vagrant: Features:  typed_triggers\r\n==> vagrant:\r\n==> vagrant: Please use with caution, as some of the features may not be fully\r\n==> vagrant: functional yet.\r\nBringing machine 'vmx01pfe' up with 'libvirt' provider...\r\nBringing machine 'vmx02pfe' up with 'libvirt' provider...\r\n==> vmx01pfe: Creating image (snapshot of base box volume).\r\n==> vmx02pfe: Creating image (snapshot of base box volume).\r\n==> vmx01pfe: Creating domain with the following settings...\r\n==> vmx02pfe: Creating domain with the following settings...\r\n\r\n[ Output suppressed for brevity ]\r\n\r\n==> vmx01pfe: Starting domain.\r\n==> vmx02pfe: Starting domain.\r\n==> vargant: Running action triggers after VagrantPlugins::ProviderLibvirt::Action::StartDomain ...\r\n==> vargant: Running action triggers after VagrantPlugins::ProviderLibvirt::Action::StartDomain ...\r\n==> vargant: Running trigger...\r\n==> vargant: Vagrant has been configured to abort. Terminating now...\r\n==> vmx01pfe: An error occurred. The error will be shown after all tasks complete.\r\n==> vargant: Running trigger...\r\n==> vargant: Vagrant has been configured to abort. Terminating now...\r\n==> vmx02pfe: An error occurred. The error will be shown after all tasks complete.\r\nAn error occurred while executing multiple actions in parallel.\r\nAny errors that occurred are shown below.\r\n\r\nAn unexpected error occurred when executing the action on the\r\n'vmx01pfe' machine. Please report this as a bug:\r\n\r\nexit\r\n\r\n\r\n/opt/vagrant/embedded/gems/2.2.4/gems/vagrant-2.2.4/lib/vagrant/plugin/v2/trigger.rb:304:in `exit'\r\n/opt/vagrant/embedded/gems/2.2.4/gems/vagrant-2.2.4/lib/vagrant/plugin/v2/trigger.rb:304:in `trigger_abort'\r\n/opt/vagrant/embedded/gems/2.2.4/gems/vagrant-2.2.4/lib/vagrant/plugin/v2/trigger.rb:161:in `block in fire'\r\n/opt/vagrant/embedded/gems/2.2.4/gems/vagrant-2.2.4/lib/vagrant/plugin/v2/trigger.rb:142:in `each'\r\n/opt/vagrant/embedded/gems/2.2.4/gems/vagrant-2.2.4/lib/vagrant/plugin/v2/trigger.rb:142:in `fire'\r\n/opt/vagrant/embedded/gems/2.2.4/gems/vagrant-2.2.4/lib/vagrant/plugin/v2/trigger.rb:74:in `fire_triggers'\r\n/opt/vagrant/embedded/gems/2.2.4/gems/vagrant-2.2.4/lib/vagrant/action/builtin/after_trigger.rb:23:in `call'\r\n/opt/vagrant/embedded/gems/2.2.4/gems/vagrant-2.2.4/lib/vagrant/action/warden.rb:50:in `call'\r\n/home/pedro/.vagrant.d/gems/2.4.4/gems/vagrant-libvirt-0.0.45/lib/vagrant-libvirt/action/start_domain.rb:302:in `call'\r\n/opt/vagrant/embedded/gems/2.2.4/gems/vagrant-2.2.4/lib/vagrant/action/warden.rb:50:in `call'\r\n/opt/vagrant/embedded/gems/2.2.4/gems/vagrant-2.2.4/lib/vagrant/action/builtin/before_trigger.rb:23:in `call'\r\n/opt/vagrant/embedded/gems/2.2.4/gems/vagrant-2.2.4/lib/vagrant/action/warden.rb:50:in `call'\r\n/opt/vagrant/embedded/gems/2.2.4/gems/vagrant-2.2.4/lib/vagrant/action/builtin/after_trigger.rb:26:in `call'\r\n/opt/vagrant/embedded/gems/2.2.4/gems/vagrant-2.2.4/lib/vagrant/action/warden.rb:50:in `call'\r\n/home/pedro/.vagrant.d/gems/2.4.4/gems/vagrant-libvirt-0.0.45/lib/vagrant-libvirt/action/set_boot_order.rb:78:in `call'\r\n[ Full error stack not shown here for brevity]\r\n\r\n[ Similar stack with the second machine (vmx02pfe) ]\r\n```\r\n\r\n### Debug output\r\nhttps://gist.github.com/p0xd1/3d3696f1537a47b04545ddc5591eebed\r\n\r\n### Expected behavior\r\nVagrant exits with a return code 1. The machines are in `running` state.\r\n\r\n### Actual behavior\r\nAwful error messages.\r\n\r\n### Steps to reproduce\r\n1. Define a Action based trigger with an abort instruction.\r\n2. Start up two machines.\r\n\r\n\r\n\r\n","closed_by":{"login":"briancain","id":810277,"node_id":"MDQ6VXNlcjgxMDI3Nw==","avatar_url":"https://avatars.githubusercontent.com/u/810277?v=4","gravatar_id":"","url":"https://api.github.com/users/briancain","html_url":"https://github.com/briancain","followers_url":"https://api.github.com/users/briancain/followers","following_url":"https://api.github.com/users/briancain/following{/other_user}","gists_url":"https://api.github.com/users/briancain/gists{/gist_id}","starred_url":"https://api.github.com/users/briancain/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/briancain/subscriptions","organizations_url":"https://api.github.com/users/briancain/orgs","repos_url":"https://api.github.com/users/briancain/repos","events_url":"https://api.github.com/users/briancain/events{/privacy}","received_events_url":"https://api.github.com/users/briancain/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/hashicorp/vagrant/issues/10823/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/hashicorp/vagrant/issues/10823/timeline","performed_via_github_app":null,"state_reason":"completed"}