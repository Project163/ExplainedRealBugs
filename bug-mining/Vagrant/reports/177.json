{"url":"https://api.github.com/repos/hashicorp/vagrant/issues/10961","repository_url":"https://api.github.com/repos/hashicorp/vagrant","labels_url":"https://api.github.com/repos/hashicorp/vagrant/issues/10961/labels{/name}","comments_url":"https://api.github.com/repos/hashicorp/vagrant/issues/10961/comments","events_url":"https://api.github.com/repos/hashicorp/vagrant/issues/10961/events","html_url":"https://github.com/hashicorp/vagrant/issues/10961","id":466362658,"node_id":"MDU6SXNzdWU0NjYzNjI2NTg=","number":10961,"title":"Catalina filesystem changes appear to introduce NFS sync issues","user":{"login":"bjfresh","id":12784,"node_id":"MDQ6VXNlcjEyNzg0","avatar_url":"https://avatars.githubusercontent.com/u/12784?v=4","gravatar_id":"","url":"https://api.github.com/users/bjfresh","html_url":"https://github.com/bjfresh","followers_url":"https://api.github.com/users/bjfresh/followers","following_url":"https://api.github.com/users/bjfresh/following{/other_user}","gists_url":"https://api.github.com/users/bjfresh/gists{/gist_id}","starred_url":"https://api.github.com/users/bjfresh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bjfresh/subscriptions","organizations_url":"https://api.github.com/users/bjfresh/orgs","repos_url":"https://api.github.com/users/bjfresh/repos","events_url":"https://api.github.com/users/bjfresh/events{/privacy}","received_events_url":"https://api.github.com/users/bjfresh/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":192400390,"node_id":"MDU6TGFiZWwxOTI0MDAzOTA=","url":"https://api.github.com/repos/hashicorp/vagrant/labels/host/darwin","name":"host/darwin","color":"d4c5f9","default":false,"description":null},{"id":218284866,"node_id":"MDU6TGFiZWwyMTgyODQ4NjY=","url":"https://api.github.com/repos/hashicorp/vagrant/labels/synced-folders/nfs","name":"synced-folders/nfs","color":"fef2c0","default":false,"description":null}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/hashicorp/vagrant/milestones/44","html_url":"https://github.com/hashicorp/vagrant/milestone/44","labels_url":"https://api.github.com/repos/hashicorp/vagrant/milestones/44/labels","id":4482321,"node_id":"MDk6TWlsZXN0b25lNDQ4MjMyMQ==","number":44,"title":"2.2.7","description":"","creator":{"login":"briancain","id":810277,"node_id":"MDQ6VXNlcjgxMDI3Nw==","avatar_url":"https://avatars.githubusercontent.com/u/810277?v=4","gravatar_id":"","url":"https://api.github.com/users/briancain","html_url":"https://github.com/briancain","followers_url":"https://api.github.com/users/briancain/followers","following_url":"https://api.github.com/users/briancain/following{/other_user}","gists_url":"https://api.github.com/users/briancain/gists{/gist_id}","starred_url":"https://api.github.com/users/briancain/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/briancain/subscriptions","organizations_url":"https://api.github.com/users/briancain/orgs","repos_url":"https://api.github.com/users/briancain/repos","events_url":"https://api.github.com/users/briancain/events{/privacy}","received_events_url":"https://api.github.com/users/briancain/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":44,"state":"closed","created_at":"2019-07-10T21:40:07Z","updated_at":"2020-01-30T19:14:57Z","due_on":null,"closed_at":"2020-01-30T19:14:57Z"},"comments":85,"created_at":"2019-07-10T15:03:42Z","updated_at":"2020-01-28T01:51:27Z","closed_at":"2019-10-10T16:20:41Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Vagrant version\r\n2.2.5\r\n\r\n### Host operating system\r\nMac OS X Catalina Public Beta 2\r\n\r\n### Guest operating system\r\nUbuntu 16.04.1 LTS\r\n\r\n### Vagrantfile\r\n```ruby\r\n# -*- mode: ruby -*-\r\n# vi: set ft=ruby :\r\n\r\nANSIBLE_PATH = __dir__ # absolute path to Ansible directory on host machine\r\nANSIBLE_PATH_ON_VM = '/home/vagrant/trellis'.freeze # absolute path to Ansible directory on virtual machine\r\n\r\nrequire File.join(ANSIBLE_PATH, 'lib', 'trellis', 'vagrant')\r\nrequire File.join(ANSIBLE_PATH, 'lib', 'trellis', 'config')\r\nrequire 'yaml'\r\n\r\nvconfig = YAML.load_file(\"#{ANSIBLE_PATH}/vagrant.default.yml\")\r\n\r\nif File.exist?(\"#{ANSIBLE_PATH}/vagrant.local.yml\")\r\n  local_config = YAML.load_file(\"#{ANSIBLE_PATH}/vagrant.local.yml\")\r\n  vconfig.merge!(local_config) if local_config\r\nend\r\n\r\nensure_plugins(vconfig.fetch('vagrant_plugins')) if vconfig.fetch('vagrant_install_plugins')\r\n\r\ntrellis_config = Trellis::Config.new(root_path: ANSIBLE_PATH)\r\n\r\nVagrant.require_version '>= 2.0.1'\r\n\r\nVagrant.configure('2') do |config|\r\n  config.vm.box = vconfig.fetch('vagrant_box')\r\n  config.vm.box_version = vconfig.fetch('vagrant_box_version')\r\n  config.ssh.forward_agent = true\r\n  config.vm.post_up_message = post_up_message\r\n\r\n  # Fix for: \"stdin: is not a tty\"\r\n  # https://github.com/mitchellh/vagrant/issues/1673#issuecomment-28288042\r\n  config.ssh.shell = %(bash -c 'BASH_ENV=/etc/profile exec bash')\r\n\r\n  # Required for NFS to work\r\n  if vconfig.fetch('vagrant_ip') == 'dhcp'\r\n    config.vm.network :private_network, type: 'dhcp', hostsupdater: 'skip'\r\n\r\n    cached_addresses = {}\r\n    config.hostmanager.ip_resolver = proc do |vm, _resolving_vm|\r\n      if cached_addresses[vm.name].nil?\r\n        if vm.communicate.ready?\r\n          vm.communicate.execute(\"hostname -I | cut -d ' ' -f 2\") do |_type, contents|\r\n            cached_addresses[vm.name] = contents.split(\"\\n\").first[/(\\d+\\.\\d+\\.\\d+\\.\\d+)/, 1]\r\n          end\r\n        end\r\n      end\r\n      cached_addresses[vm.name]\r\n    end\r\n  else\r\n    config.vm.network :private_network, ip: vconfig.fetch('vagrant_ip'), hostsupdater: 'skip'\r\n  end\r\n\r\n  main_hostname, *hostnames = trellis_config.site_hosts_canonical\r\n  config.vm.hostname = main_hostname\r\n\r\n  if Vagrant.has_plugin?('vagrant-hostmanager') && !trellis_config.multisite_subdomains?\r\n    redirects = trellis_config.site_hosts_redirects\r\n\r\n    config.hostmanager.enabled = true\r\n    config.hostmanager.manage_host = true\r\n    config.hostmanager.aliases = hostnames + redirects\r\n  elsif Vagrant.has_plugin?('landrush') && trellis_config.multisite_subdomains?\r\n    config.landrush.enabled = true\r\n    config.landrush.tld = config.vm.hostname\r\n    hostnames.each { |host| config.landrush.host host, vconfig.fetch('vagrant_ip') }\r\n  else\r\n    fail_with_message \"vagrant-hostmanager missing, please install the plugin with this command:\\nvagrant plugin install vagrant-hostmanager\\n\\nOr install landrush for multisite subdomains:\\nvagrant plugin install landrush\"\r\n  end\r\n\r\n  bin_path = File.join(ANSIBLE_PATH_ON_VM, 'bin')\r\n\r\n  vagrant_mount_type = vconfig.fetch('vagrant_mount_type')\r\n\r\n  if vagrant_mount_type != 'nfs' || Vagrant::Util::Platform.wsl? || (Vagrant::Util::Platform.windows? && !Vagrant.has_plugin?('vagrant-winnfsd'))\r\n    vagrant_mount_type = nil if vagrant_mount_type == 'nfs'\r\n    trellis_config.wordpress_sites.each_pair do |name, site|\r\n      config.vm.synced_folder local_site_path(site), remote_site_path(name, site), owner: 'vagrant', group: 'www-data', mount_options: ['dmode=776', 'fmode=775'], type: vagrant_mount_type\r\n    end\r\n\r\n    config.vm.synced_folder ANSIBLE_PATH, ANSIBLE_PATH_ON_VM, mount_options: ['dmode=755', 'fmode=644'], type: vagrant_mount_type\r\n    config.vm.synced_folder File.join(ANSIBLE_PATH, 'bin'), bin_path, mount_options: ['dmode=755', 'fmode=755'], type: vagrant_mount_type\r\n  elsif !Vagrant.has_plugin?('vagrant-bindfs')\r\n    fail_with_message \"vagrant-bindfs missing, please install the plugin with this command:\\nvagrant plugin install vagrant-bindfs\"\r\n  else\r\n    trellis_config.wordpress_sites.each_pair do |name, site|\r\n      config.vm.synced_folder local_site_path(site), nfs_path(name), type: 'nfs', nfs_version: 4, nfs_udp: false\r\n      config.bindfs.bind_folder nfs_path(name), remote_site_path(name, site), u: 'vagrant', g: 'www-data', o: 'nonempty'\r\n    end\r\n\r\n    config.vm.synced_folder ANSIBLE_PATH, '/ansible-nfs', type: 'nfs', nfs_version: 4, nfs_udp: false\r\n    config.bindfs.bind_folder '/ansible-nfs', ANSIBLE_PATH_ON_VM, o: 'nonempty', p: '0644,a+D'\r\n    config.bindfs.bind_folder bin_path, bin_path, perms: '0755'\r\n  end\r\n\r\n  vconfig.fetch('vagrant_synced_folders', []).each do |folder|\r\n    options = {\r\n      type: folder.fetch('type', 'nfs'),\r\n      create: folder.fetch('create', false),\r\n      mount_options: folder.fetch('mount_options', [])\r\n    }\r\n\r\n    destination_folder = folder.fetch('bindfs', true) ? nfs_path(folder['destination']) : folder['destination']\r\n\r\n    config.vm.synced_folder folder['local_path'], destination_folder, options\r\n\r\n    if folder.fetch('bindfs', true)\r\n      config.bindfs.bind_folder destination_folder, folder['destination'], folder.fetch('bindfs_options', {})\r\n    end\r\n  end\r\n\r\n  provisioner = local_provisioning? ? :ansible_local : :ansible\r\n  provisioning_path = local_provisioning? ? ANSIBLE_PATH_ON_VM : ANSIBLE_PATH\r\n\r\n  config.vm.provision provisioner do |ansible|\r\n    if local_provisioning?\r\n      ansible.install_mode = 'pip'\r\n      ansible.provisioning_path = provisioning_path\r\n      ansible.version = vconfig.fetch('vagrant_ansible_version')\r\n    end\r\n\r\n    ansible.compatibility_mode = '2.0'\r\n    ansible.playbook = File.join(provisioning_path, 'dev.yml')\r\n    ansible.galaxy_role_file = File.join(provisioning_path, 'requirements.yml') unless vconfig.fetch('vagrant_skip_galaxy') || ENV['SKIP_GALAXY']\r\n    ansible.galaxy_roles_path = File.join(provisioning_path, 'vendor/roles')\r\n\r\n    ansible.groups = {\r\n      'web' => ['default'],\r\n      'development' => ['default']\r\n    }\r\n\r\n    ansible.tags = ENV['ANSIBLE_TAGS']\r\n    ansible.extra_vars = { 'vagrant_version' => Vagrant::VERSION }\r\n\r\n    if (vars = ENV['ANSIBLE_VARS'])\r\n      extra_vars = Hash[vars.split(',').map { |pair| pair.split('=') }]\r\n      ansible.extra_vars.merge!(extra_vars)\r\n    end\r\n  end\r\n\r\n  # Virtualbox settings\r\n  config.vm.provider 'virtualbox' do |vb|\r\n    vb.name = config.vm.hostname\r\n    vb.customize ['modifyvm', :id, '--cpus', vconfig.fetch('vagrant_cpus')]\r\n    vb.customize ['modifyvm', :id, '--memory', vconfig.fetch('vagrant_memory')]\r\n    vb.customize ['modifyvm', :id, '--ioapic', vconfig.fetch('vagrant_ioapic', 'on')]\r\n\r\n    # Fix for slow external network connections\r\n    vb.customize ['modifyvm', :id, '--natdnshostresolver1', vconfig.fetch('vagrant_natdnshostresolver', 'on')]\r\n    vb.customize ['modifyvm', :id, '--natdnsproxy1', vconfig.fetch('vagrant_natdnsproxy', 'on')]\r\n  end\r\n\r\n  # VMware Workstation/Fusion settings\r\n  %w(vmware_fusion vmware_workstation).each do |provider|\r\n    config.vm.provider provider do |vmw, _override|\r\n      vmw.name = config.vm.hostname\r\n      vmw.vmx['numvcpus'] = vconfig.fetch('vagrant_cpus')\r\n      vmw.vmx['memsize'] = vconfig.fetch('vagrant_memory')\r\n    end\r\n  end\r\n\r\n  # Parallels settings\r\n  config.vm.provider 'parallels' do |prl, _override|\r\n    prl.name = config.vm.hostname\r\n    prl.cpus = vconfig.fetch('vagrant_cpus')\r\n    prl.memory = vconfig.fetch('vagrant_memory')\r\n    prl.update_guest_tools = true\r\n  end\r\nend\r\n```\r\n\r\n### Debug output\r\nhttps://gist.github.com/bjfresh/673d66b9ab814e6ca66404ca6755a885\r\n\r\n### Expected behavior\r\nNFS syncs the folder\r\n\r\n### Actual behavior\r\nCatalina introduces separate volumes for system and user data (Root changed from \"/\" to \"System/Volumes/Data/\" ), which appears to be the cause of this unexpected mismatch:\r\n\r\n```\r\nNFS is reporting that your exports file is invalid. Vagrant does\r\nthis check before making any changes to the file. Please correct\r\nthe issues below and execute \"vagrant reload\":\r\n\r\nexports:2: exported dir/fs mismatch: /Users/bj/Sites/sitename.com/site /System/Volumes/Data\r\nexports:3: exported dir/fs mismatch: /Users/bj/Sites/sitename.com/trellis /System/Volumes/Data\r\n\r\n```\r\n\r\n### Steps to reproduce\r\n1. Install MacOS Catalina Public Beta 2\r\n2. Run 'vagrant up' on an existing Vagrant + Trellis installation using NFS\r\n\r\nFWIW I've updated Virtualbox, Vagrant, and relevant plugins","closed_by":{"login":"chrisroberts","id":266674,"node_id":"MDQ6VXNlcjI2NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/266674?v=4","gravatar_id":"","url":"https://api.github.com/users/chrisroberts","html_url":"https://github.com/chrisroberts","followers_url":"https://api.github.com/users/chrisroberts/followers","following_url":"https://api.github.com/users/chrisroberts/following{/other_user}","gists_url":"https://api.github.com/users/chrisroberts/gists{/gist_id}","starred_url":"https://api.github.com/users/chrisroberts/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chrisroberts/subscriptions","organizations_url":"https://api.github.com/users/chrisroberts/orgs","repos_url":"https://api.github.com/users/chrisroberts/repos","events_url":"https://api.github.com/users/chrisroberts/events{/privacy}","received_events_url":"https://api.github.com/users/chrisroberts/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/hashicorp/vagrant/issues/10961/reactions","total_count":24,"+1":24,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/hashicorp/vagrant/issues/10961/timeline","performed_via_github_app":null,"state_reason":"completed"}