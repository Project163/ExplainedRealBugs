{"url":"https://api.github.com/repos/hashicorp/vagrant/issues/8315","repository_url":"https://api.github.com/repos/hashicorp/vagrant","labels_url":"https://api.github.com/repos/hashicorp/vagrant/issues/8315/labels{/name}","comments_url":"https://api.github.com/repos/hashicorp/vagrant/issues/8315/comments","events_url":"https://api.github.com/repos/hashicorp/vagrant/issues/8315/events","html_url":"https://github.com/hashicorp/vagrant/issues/8315","id":210956159,"node_id":"MDU6SXNzdWUyMTA5NTYxNTk=","number":8315,"title":"Unable to set environment variables for Puppet provisioning on Windows","user":{"login":"mtkennerly","id":4934192,"node_id":"MDQ6VXNlcjQ5MzQxOTI=","avatar_url":"https://avatars.githubusercontent.com/u/4934192?v=4","gravatar_id":"","url":"https://api.github.com/users/mtkennerly","html_url":"https://github.com/mtkennerly","followers_url":"https://api.github.com/users/mtkennerly/followers","following_url":"https://api.github.com/users/mtkennerly/following{/other_user}","gists_url":"https://api.github.com/users/mtkennerly/gists{/gist_id}","starred_url":"https://api.github.com/users/mtkennerly/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mtkennerly/subscriptions","organizations_url":"https://api.github.com/users/mtkennerly/orgs","repos_url":"https://api.github.com/users/mtkennerly/repos","events_url":"https://api.github.com/users/mtkennerly/events{/privacy}","received_events_url":"https://api.github.com/users/mtkennerly/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":25816,"node_id":"MDU6TGFiZWwyNTgxNg==","url":"https://api.github.com/repos/hashicorp/vagrant/labels/bug","name":"bug","color":"e11d21","default":true,"description":null},{"id":78409296,"node_id":"MDU6TGFiZWw3ODQwOTI5Ng==","url":"https://api.github.com/repos/hashicorp/vagrant/labels/provisioner/puppet","name":"provisioner/puppet","color":"bfdadc","default":false,"description":null},{"id":218287562,"node_id":"MDU6TGFiZWwyMTgyODc1NjI=","url":"https://api.github.com/repos/hashicorp/vagrant/labels/guest/windows","name":"guest/windows","color":"5319e7","default":false,"description":null},{"id":283683436,"node_id":"MDU6TGFiZWwyODM2ODM0MzY=","url":"https://api.github.com/repos/hashicorp/vagrant/labels/has-pr","name":"has-pr","color":"fef2c0","default":false,"description":null}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/hashicorp/vagrant/milestones/37","html_url":"https://github.com/hashicorp/vagrant/milestone/37","labels_url":"https://api.github.com/repos/hashicorp/vagrant/milestones/37/labels","id":3646695,"node_id":"MDk6TWlsZXN0b25lMzY0NjY5NQ==","number":37,"title":"2.1.6","description":"","creator":{"login":"chrisroberts","id":266674,"node_id":"MDQ6VXNlcjI2NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/266674?v=4","gravatar_id":"","url":"https://api.github.com/users/chrisroberts","html_url":"https://github.com/chrisroberts","followers_url":"https://api.github.com/users/chrisroberts/followers","following_url":"https://api.github.com/users/chrisroberts/following{/other_user}","gists_url":"https://api.github.com/users/chrisroberts/gists{/gist_id}","starred_url":"https://api.github.com/users/chrisroberts/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chrisroberts/subscriptions","organizations_url":"https://api.github.com/users/chrisroberts/orgs","repos_url":"https://api.github.com/users/chrisroberts/repos","events_url":"https://api.github.com/users/chrisroberts/events{/privacy}","received_events_url":"https://api.github.com/users/chrisroberts/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":35,"state":"closed","created_at":"2018-09-11T22:50:40Z","updated_at":"2018-10-16T23:43:48Z","due_on":null,"closed_at":"2018-10-16T23:43:48Z"},"comments":1,"created_at":"2017-03-01T01:46:51Z","updated_at":"2020-03-29T02:27:15Z","closed_at":"2018-09-19T16:04:07Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Vagrant version\r\n1.9.2 (also saw in 1.9.1)\r\n\r\n### Host operating system\r\nWindows 10\r\n\r\n### Guest operating system\r\nWindows Server 2012 R2\r\n\r\n### Vagrantfile\r\n```ruby\r\nVagrant.configure(\"2\") do |config|\r\n  config.vm.box = \"opentable/win-2012r2-standard-amd64-nocm\"\r\n\r\n  config.vm.provider \"virtualbox\" do |vb|\r\n    vb.gui = true\r\n  end\r\n\r\n  config.vm.provision :shell do |shell|\r\n    shell.inline = 'Start-Process -FilePath \"msiexec.exe\" -ArgumentList \"/i C:\\vagrant\\provision\\bin\\puppet-agent-1.9.2-x64.msi /qn\" -Wait'\r\n  end\r\n\r\n  config.vm.provision :puppet do |puppet|\r\n    puppet.environment_path = \"provision/env\"\r\n    puppet.environment = \"main\"\r\n    puppet.manifests_path = \"provision/env/main\"\r\n    puppet.manifest_file = \"demo.pp\"\r\n    puppet.environment_variables = {\r\n      :demo => \"hi\"\r\n    }\r\n  end\r\nend\r\n```\r\n\r\n### Debug output\r\n[Gist](https://gist.github.com/mtkennerly/5823e26fa0d953436c71bd9fea60be1d)\r\n\r\n### Expected behavior\r\nEnvironment variable \"demo\" should be set in VM, and the variable's value should be written to <C:/demo.txt>.\r\n\r\n### Actual behavior\r\nVagrant shows an error from PowerShell about an unexpected token:\r\n\r\n```\r\n==> default: Running Puppet with environment main...\r\n==> default: At C:\\windows\\temp\\winrm-elevated-shell-c7856836-37e4-4685-8eba-75848c4d4129.ps\r\n==> default: 1:1 char:16\r\n==> default: + $env:demo=\"hi\" puppet apply --color=false --detailed-exitcodes\r\n==> default: --environmentpath ...\r\n==> default: +                ~~~~~~\r\n==> default: Unexpected token 'puppet' in expression or statement.\r\n==> default:     + CategoryInfo          : ParserError: (:) [], ParentContainsErrorRecordEx\r\n==> default:    ception\r\n==> default:     + FullyQualifiedErrorId : UnexpectedToken\r\n```\r\n\r\nFrom the logging, it looks like it's trying to set the environment variable in the same line that it calls Puppet, whereas PowerShell would expect the  part on its own line.\r\n\r\nFor the record, if I take out the puppet.environment_variables part of the Vagrantfile, there are no errors; demo.txt gets created, albeit without the variable value being set.\r\n\r\n### Steps to reproduce\r\nCreate the following directory structure on your host:\r\n\r\n```\r\nprovision/\r\n  bin/\r\n    demo.cmd\r\n    puppet-agent-1.9.2-x64.msi\r\n  env/\r\n    main/\r\n      demo.pp\r\nVagrantfile\r\n```\r\n\r\nDownload puppet-agent-1.9.2-x64.msi from [PuppetLabs](https://downloads.puppetlabs.com/windows/). This is the newest version, released yesterday (although I also saw the issue with 1.9.1-x86 on a different VM at work).\r\n\r\nContent of demo.cmd:\r\n```bat\r\necho \"%demo%\" > C:\\demo.txt\r\n```\r\n\r\nContent of demo.pp:\r\n```puppet\r\nexec { \"C:/vagrant/provision/bin/demo.cmd\":\r\n  creates => \"C:/demo.txt\",\r\n}\r\n```\r\n\r\nThen just run \"vagrant up\".\r\n\r\n### References\r\nN/A\r\n","closed_by":{"login":"briancain","id":810277,"node_id":"MDQ6VXNlcjgxMDI3Nw==","avatar_url":"https://avatars.githubusercontent.com/u/810277?v=4","gravatar_id":"","url":"https://api.github.com/users/briancain","html_url":"https://github.com/briancain","followers_url":"https://api.github.com/users/briancain/followers","following_url":"https://api.github.com/users/briancain/following{/other_user}","gists_url":"https://api.github.com/users/briancain/gists{/gist_id}","starred_url":"https://api.github.com/users/briancain/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/briancain/subscriptions","organizations_url":"https://api.github.com/users/briancain/orgs","repos_url":"https://api.github.com/users/briancain/repos","events_url":"https://api.github.com/users/briancain/events{/privacy}","received_events_url":"https://api.github.com/users/briancain/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/hashicorp/vagrant/issues/8315/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/hashicorp/vagrant/issues/8315/timeline","performed_via_github_app":null,"state_reason":"completed"}