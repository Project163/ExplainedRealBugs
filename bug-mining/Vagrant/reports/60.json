{"url":"https://api.github.com/repos/hashicorp/vagrant/issues/7135","repository_url":"https://api.github.com/repos/hashicorp/vagrant","labels_url":"https://api.github.com/repos/hashicorp/vagrant/issues/7135/labels{/name}","comments_url":"https://api.github.com/repos/hashicorp/vagrant/issues/7135/comments","events_url":"https://api.github.com/repos/hashicorp/vagrant/issues/7135/events","html_url":"https://github.com/hashicorp/vagrant/issues/7135","id":140463790,"node_id":"MDU6SXNzdWUxNDA0NjM3OTA=","number":7135,"title":"config.vm.provider not setting provider in multi-machine Vagrantfile","user":{"login":"antoncohen","id":784476,"node_id":"MDQ6VXNlcjc4NDQ3Ng==","avatar_url":"https://avatars.githubusercontent.com/u/784476?v=4","gravatar_id":"","url":"https://api.github.com/users/antoncohen","html_url":"https://github.com/antoncohen","followers_url":"https://api.github.com/users/antoncohen/followers","following_url":"https://api.github.com/users/antoncohen/following{/other_user}","gists_url":"https://api.github.com/users/antoncohen/gists{/gist_id}","starred_url":"https://api.github.com/users/antoncohen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/antoncohen/subscriptions","organizations_url":"https://api.github.com/users/antoncohen/orgs","repos_url":"https://api.github.com/users/antoncohen/repos","events_url":"https://api.github.com/users/antoncohen/events{/privacy}","received_events_url":"https://api.github.com/users/antoncohen/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2016-03-13T08:19:24Z","updated_at":"2020-04-03T02:35:15Z","closed_at":"2016-03-17T19:50:58Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Vagrant version\n\nVagrant 1.8.1\n### Host operating system\n\nOS X 10.11.3\n### Guest operating system\n\nLinux\n### Vagrantfile\n\n``` ruby\n# -*- mode: ruby -*-\n# vi: set ft=ruby :\n\nrequire 'pp'\n\nerror = Vagrant::Errors::VagrantError\n\nVagrant.configure(2) do |config|\n  config.vm.box_check_update = false\n\n  machines = [\n    {\n      'name' => 'trusty',\n      'box' => 'bento/ubuntu-14.04',\n      'memory' => 1024,\n      'default' => true\n    },\n    {\n      'name' => 'centos7',\n      'box' => 'bento/centos-7.2',\n      'default' => false\n    },\n    {\n      'name' => 'xenial',\n      'box_name' => 'xenial-server-cloudimg-amd64',\n      'box_url' => 'https://cloud-images.ubuntu.com/xenial/current/xenial-server-cloudimg-amd64-vagrant.box',\n      'providers' => ['virtualbox']\n    }\n  ]\n\n  machines.each do |machine|\n    name = machine['name']\n    box = machine['box']\n    box_url = machine['box_url']\n    box_name = machine['box_name']\n    providers = machine['providers'] || %w(vmware_fusion vmware_workstation virtualbox)\n    memory = machine['memory'] || '512'\n    default = machine['default'] || false\n\n    fail error.new, 'machines must contain a name' if name.nil?\n\n    config.vm.define name, primary: default, autostart: default do |cfg|\n      # Find boxes at https://atlas.hashicorp.com/search\n      if box\n        cfg.vm.box = box\n      elsif box_url && box_name\n        cfg.vm.box = box_name\n        cfg.vm.box_url = box_url\n      else\n        fail error.new, 'machines must contain box or box_name and box_url'\n      end\n\n      if providers.include? 'vmware_fusion'\n        cfg.vm.provider :vmware_fusion do |v|\n          v.vmx['memsize'] = memory\n        end\n      end\n\n      if providers.include? 'vmware_workstation'\n        cfg.vm.provider :vmware_workstation do |v|\n          v.vmx['memsize'] = memory\n        end\n      end\n\n      if providers.include? 'virtualbox'\n        cfg.vm.provider :virtualbox do |v|\n          v.memory = memory\n        end\n      end\n      pp cfg.vm.__providers\n    end\n  end\nend\n```\n### Expected behavior\n\nIn a multi-machine Vagrantfile I expect `config.vm.provider` to set the provider.\n### Actual behavior\n\nMachine attempts to use unsupported provider.\n### Steps to reproduce\n1. Use the above Vagrantfile\n2. `vagrant status`\n3. `vagrant up`\n4. `vagrant up xenial`\n\n```\n$ env | grep -i vagrant\n\n$ vagrant status \n[:vmware_fusion, :vmware_workstation, :virtualbox]\n[:vmware_fusion, :vmware_workstation, :virtualbox]\n[:virtualbox]\nCurrent machine states:\n\ntrusty                    not created (vmware_fusion)\ncentos7                   not created (vmware_fusion)\nxenial                    not created (vmware_fusion)\n\nThis environment represents multiple VMs. The VMs are all listed\nabove with their current state. For more information about a specific\nVM, run `vagrant status NAME`.\n\n$ vagrant up\n[:vmware_fusion, :vmware_workstation, :virtualbox]\nBringing machine 'trusty' up with 'vmware_fusion' provider...\n==> trusty: Cloning VMware VM: 'bento/ubuntu-14.04'. This can take some time...\n==> trusty: Verifying vmnet devices are healthy...\n==> trusty: Preparing network adapters...\n==> trusty: Starting the VMware VM...\n==> trusty: Waiting for machine to boot. This may take a few minutes...\n    trusty: SSH address: 192.168.109.161:22\n    trusty: SSH username: vagrant\n    trusty: SSH auth method: private key\n    trusty: \n    trusty: Vagrant insecure key detected. Vagrant will automatically replace\n    trusty: this with a newly generated keypair for better security.\n    trusty: \n    trusty: Inserting generated public key within guest...\n    trusty: Removing insecure key from the guest if it's present...\n    trusty: Key inserted! Disconnecting and reconnecting using new SSH key...\n==> trusty: Machine booted and ready!\n==> trusty: Forwarding ports...\n    trusty: -- 22 => 2222\n==> trusty: Configuring network adapters within the VM...\n==> trusty: Waiting for HGFS kernel module to load...\n==> trusty: Enabling and configuring shared folders...\n    trusty: -- <removed>: /vagrant\n\n$ vagrant status\n[:vmware_fusion, :vmware_workstation, :virtualbox]\n[:vmware_fusion, :vmware_workstation, :virtualbox]\n[:virtualbox]\nCurrent machine states:\n\ntrusty                    running (vmware_fusion)\ncentos7                   not created (vmware_fusion)\nxenial                    not created (vmware_fusion)\n\nThis environment represents multiple VMs. The VMs are all listed\nabove with their current state. For more information about a specific\nVM, run `vagrant status NAME`.\n\n$ vagrant up xenial\n[:virtualbox]\nBringing machine 'xenial' up with 'vmware_fusion' provider...\n==> xenial: Box 'xenial-server-cloudimg-amd64' could not be found. Attempting to find and install...\n    xenial: Box Provider: vmware_desktop, vmware_fusion, vmware_workstation\n    xenial: Box Version: >= 0\n==> xenial: Box file was not detected as metadata. Adding it directly...\n==> xenial: Adding box 'xenial-server-cloudimg-amd64' (v0) for provider: vmware_desktop, vmware_fusion, vmware_workstation\n    xenial: Downloading: https://cloud-images.ubuntu.com/xenial/current/xenial-server-cloudimg-amd64-vagrant.box\n==> xenial: Box download is resuming from prior download progress\nThe box you attempted to add doesn't match the provider you specified.\n\nProvider expected: vmware_desktop, vmware_fusion, vmware_workstation\nProvider of box: virtualbox\n$\n```\n\n`pp cfg.vm.__providers` prints the list of providers the box should support, yet it attempts to load with an unsupported provider. Environmental variable VAGRANT_DEFAULT_PROVIDER is not set.\n","closed_by":{"login":"sethvargo","id":408570,"node_id":"MDQ6VXNlcjQwODU3MA==","avatar_url":"https://avatars.githubusercontent.com/u/408570?v=4","gravatar_id":"","url":"https://api.github.com/users/sethvargo","html_url":"https://github.com/sethvargo","followers_url":"https://api.github.com/users/sethvargo/followers","following_url":"https://api.github.com/users/sethvargo/following{/other_user}","gists_url":"https://api.github.com/users/sethvargo/gists{/gist_id}","starred_url":"https://api.github.com/users/sethvargo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sethvargo/subscriptions","organizations_url":"https://api.github.com/users/sethvargo/orgs","repos_url":"https://api.github.com/users/sethvargo/repos","events_url":"https://api.github.com/users/sethvargo/events{/privacy}","received_events_url":"https://api.github.com/users/sethvargo/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/hashicorp/vagrant/issues/7135/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/hashicorp/vagrant/issues/7135/timeline","performed_via_github_app":null,"state_reason":"completed"}