{"url":"https://api.github.com/repos/hashicorp/vagrant/issues/10966","repository_url":"https://api.github.com/repos/hashicorp/vagrant","labels_url":"https://api.github.com/repos/hashicorp/vagrant/issues/10966/labels{/name}","comments_url":"https://api.github.com/repos/hashicorp/vagrant/issues/10966/comments","events_url":"https://api.github.com/repos/hashicorp/vagrant/issues/10966/events","html_url":"https://github.com/hashicorp/vagrant/issues/10966","id":467647182,"node_id":"MDU6SXNzdWU0Njc2NDcxODI=","number":10966,"title":"rsync-auto ignores subfolder directory changes","user":{"login":"polynomialdonut","id":19887727,"node_id":"MDQ6VXNlcjE5ODg3NzI3","avatar_url":"https://avatars.githubusercontent.com/u/19887727?v=4","gravatar_id":"","url":"https://api.github.com/users/polynomialdonut","html_url":"https://github.com/polynomialdonut","followers_url":"https://api.github.com/users/polynomialdonut/followers","following_url":"https://api.github.com/users/polynomialdonut/following{/other_user}","gists_url":"https://api.github.com/users/polynomialdonut/gists{/gist_id}","starred_url":"https://api.github.com/users/polynomialdonut/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polynomialdonut/subscriptions","organizations_url":"https://api.github.com/users/polynomialdonut/orgs","repos_url":"https://api.github.com/users/polynomialdonut/repos","events_url":"https://api.github.com/users/polynomialdonut/events{/privacy}","received_events_url":"https://api.github.com/users/polynomialdonut/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":25816,"node_id":"MDU6TGFiZWwyNTgxNg==","url":"https://api.github.com/repos/hashicorp/vagrant/labels/bug","name":"bug","color":"e11d21","default":true,"description":null},{"id":283683436,"node_id":"MDU6TGFiZWwyODM2ODM0MzY=","url":"https://api.github.com/repos/hashicorp/vagrant/labels/has-pr","name":"has-pr","color":"fef2c0","default":false,"description":null},{"id":739785018,"node_id":"MDU6TGFiZWw3Mzk3ODUwMTg=","url":"https://api.github.com/repos/hashicorp/vagrant/labels/regression","name":"regression","color":"e5004c","default":false,"description":null},{"id":1017385901,"node_id":"MDU6TGFiZWwxMDE3Mzg1OTAx","url":"https://api.github.com/repos/hashicorp/vagrant/labels/rsync-auto","name":"rsync-auto","color":"40b9c9","default":false,"description":""}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/hashicorp/vagrant/milestones/44","html_url":"https://github.com/hashicorp/vagrant/milestone/44","labels_url":"https://api.github.com/repos/hashicorp/vagrant/milestones/44/labels","id":4482321,"node_id":"MDk6TWlsZXN0b25lNDQ4MjMyMQ==","number":44,"title":"2.2.7","description":"","creator":{"login":"briancain","id":810277,"node_id":"MDQ6VXNlcjgxMDI3Nw==","avatar_url":"https://avatars.githubusercontent.com/u/810277?v=4","gravatar_id":"","url":"https://api.github.com/users/briancain","html_url":"https://github.com/briancain","followers_url":"https://api.github.com/users/briancain/followers","following_url":"https://api.github.com/users/briancain/following{/other_user}","gists_url":"https://api.github.com/users/briancain/gists{/gist_id}","starred_url":"https://api.github.com/users/briancain/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/briancain/subscriptions","organizations_url":"https://api.github.com/users/briancain/orgs","repos_url":"https://api.github.com/users/briancain/repos","events_url":"https://api.github.com/users/briancain/events{/privacy}","received_events_url":"https://api.github.com/users/briancain/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":44,"state":"closed","created_at":"2019-07-10T21:40:07Z","updated_at":"2020-01-30T19:14:57Z","due_on":null,"closed_at":"2020-01-30T19:14:57Z"},"comments":6,"created_at":"2019-07-13T00:41:47Z","updated_at":"2020-01-28T02:17:51Z","closed_at":"2019-10-02T19:47:06Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Vagrant version\r\n2.2.5\r\n\r\n### Host operating system\r\nUbuntu 18.04.2 LTS\r\n\r\n### Guest operating system\r\nUbuntu 16.04.6 LTS\r\n\r\n### Vagrantfile\r\n```ruby\r\n# -*- mode: ruby -*-\r\n# vi: set ft=ruby :\r\n\r\n## ADAPT: CHANGED repo inside the VM's host machine - Uncomment and adapt the following line!\r\nDIR_HOST_CHANGED_REPO = \"/home/CHANGED/git-repo\"\r\n\r\n# All Vagrant configuration is done below. The constant \"VAGRANTFILE_API_VERSION\"\r\n# in Vagrant.configure configures the configuration version (we support older styles\r\n# for backwards compatibility). Please don't change it unless you know what you're doing.\r\nVAGRANTFILE_API_VERSION = \"2\"\r\nVagrant.configure(VAGRANTFILE_API_VERSION) do |config|\r\n  BOX_USER_HOME_DIR=\"/home/vagrant\"\r\n  # Fixes (TODO: Put into separate provisioner script/store state inside Vagrant for new base box (?))\r\n  ## In order to work, this has to stay here on top (before other provisioner commands are run)\r\n  config.vm.provision \"Fix No-tty error message\",\r\n  type: \"shell\" do |s|\r\n    s.privileged = false\r\n    s.inline = \"echo -e '\\tFix for no-tty'; sudo sed -i '/tty/!s/mesg n/tty -s \\\\&\\\\& mesg n/' /root/.profile\"\r\n  end\r\n  ## Fix 'unable to re-open stdin: No file or directory' from dpkg-reconfigure (doesn't work properly, it seems)\r\n  config.vm.provision \"Fix 'unable to re-open stdin\",\r\n  type: \"shell\" do |s|\r\n    s.inline = \"echo -e \\\"\\tFix 'unable to re-open stdin: No file or directory' from dpkg-reconfigure\\\";  sed -i 's@\\(DPkg::Pre-Install-Pkgs {\\\"/usr/sbin/dpkg-preconfigure --apt || true\\\"\\;};\\)@// \\1@g' /etc/apt/apt.conf.d/70debconf\"\r\n  end\r\n  config.vm.provision \"shell\" do |s|\r\n    s.inline = \"dpkg-reconfigure debconf -f noninteractive -p critical\"\r\n  end\r\n\r\n  ## (omitted/sensitive information) ##\r\n\r\n   ## Where we want to put the NFS-mounted repo inside the guest\r\n  DIR_GUEST_CHANGED_REPO = \"/usr/local/src/CHANGED-git-repo\"\r\n  ## Sync above folders from Host to guest\r\n  DIR_HOST_CHANGED_REPO_BUILD=\"#{DIR_HOST_CHANGED_REPO}/build\"\r\n  #config.vm.synced_folder DIR_HOST_CHANGED_REPO, DIR_GUEST_CHANGED_REPO, type: \"rsync\",\r\n  config.vm.synced_folder DIR_HOST_CHANGED_REPO, DIR_GUEST_CHANGED_REPO, type: \"rsync\",\r\n\t  rsync__args: [\"--verbose\", \"--archive\", \"--delete\", \"-z\", \"--ignore-errors\"],\r\n          rsync__exclude: [\"build/*\", \"build/\", \"*.so*\", \"*.o*\", \"localInstDir/\"]\r\n  config.gatling.rsync_on_startup = false\r\n  # TODO: DELETE\r\n  # config.vm.synced_folder DIR_HOST_CHANGED_REPO, DIR_GUEST_CHANGED_REPO_NFS,\r\n  # id: \"CHANGED\", type: \"nfs\", mount_options: ['rw', 'vers=3', 'tcp'], linux__nfs_options: ['rw','no_subtree_check','all_squash','async']\r\n\r\n  config.vm.provision \"Set the Timezone to Berlin\",\r\n  type: \"shell\" do |s|\r\n    s.inline = \"if [ -f /etc/localtime ]; then rm /etc/localtime; fi && ln -s /usr/share/zoneinfo/Europe/Berlin /etc/localtime\"\r\n  end\r\n  config.vm.provision \"Install 'ntp' so guest and host have the same time\",\r\n  type: \"shell\" do |s|\r\n    s.inline = \"export DEBIAN_FRONTEND=noninteractive; apt-get -qq update && apt-get -qq -y install ntp\"\r\n  end\r\n  config.vm.provision \"Set ulimit\",\r\n  type: \"shell\" do |s|\r\n    s.inline = \"mv /etc/security/limits.conf /etc/security/limits.conf.orig &&\r\n      echo -e '# For details: 'man limits.conf'\\n*\t-\tcore\tunlimited\\nroot\t-\tcore\tunlimited\\n# End of file\\n' > /etc/security/limits.conf\"\r\n  end\r\n\r\n  LINK_GUEST_CHANGED_REPO = \"#{BOX_USER_HOME_DIR}/CHANGED-git-repo\"\r\n  config.vm.provision \"Link location of CHANGED repo into home for convenience\",\r\n  type: \"shell\" do |s|\r\n    s.inline = \"if [ ! -L #{LINK_GUEST_CHANGED_REPO} ]; then\\\r\n    ln -s #{DIR_GUEST_CHANGED_REPO} #{LINK_GUEST_CHANGED_REPO}; fi\"\r\n  end\r\n\r\n  ## (omitted) ##\r\n\r\n  # Might work with one of the official Ubuntu boxes from Canonical, as well... (I dare not try for now)\r\n  # bash /usr/bin/vagrant rsync-auto CHANGED-ubuntu-16.04\r\n  RSYNC_AUTO_START_UBUNTU_16_04 = \"vagrant rsync-auto CHANGED-ubuntu-16.04&\"\r\n  RSYNC_AUTO_START_UBUNTU_16_04_4GREP = \"[v]agrant rsync-auto\"\r\n  KILL_RSYNC_AUTO_UBUNTU_16_04 = \"bash -c \\\"for pid in \\$(ps x|grep --color=never '.*#{RSYNC_AUTO_START_UBUNTU_16_04_4GREP}'|awk '{print \\$1}'); do kill \\$pid; done\\\"\"\r\n\r\n  config.vm.define \"CHANGED-ubuntu-16.04\" do |pu1604|\r\n    pu1604.vm.box = \"bento/ubuntu-16.04\"\r\n    pu1604.trigger.after [:up, :reload, :resume]  do |t|\r\n      t.info = \"rsync auto after up/reload/resume\"\r\n      t.run = {inline: \"bash -c '#{RSYNC_AUTO_START_UBUNTU_16_04}'\"}\r\n      # If you don't want it running in the background switch these\r\n      # t.run = {inline: \"vagrant rsync-auto bork\"}\r\n    end\r\n    pu1604.trigger.before :reload do |t|\r\n      t.info = \"disable rsync auto before reloading\"\r\n      t.run = {inline: \"#{KILL_RSYNC_AUTO_UBUNTU_16_04}\"}\r\n      # If you don't want it running in the background switch these\r\n      # t.run = {inline: \"vagrant rsync-auto bork\"}\r\n    end\r\n    pu1604.trigger.after [:halt, :destroy, :suspend] do |t|\r\n      t.info = \"disable rsync auto after halting/destroying/suspending\"\r\n      t.run = {inline: \"#{KILL_RSYNC_AUTO_UBUNTU_16_04}\"}\r\n      # If you don't want it running in the background switch these\r\n      # t.run = {inline: \"vagrant rsync-auto bork\"}\r\n    end\r\n  end\r\n\r\n  ## (ommitted) ##\r\n\r\n  config.vm.provider \"virtualbox\" do |vb|\r\n     ## ADAPT: For a speed boost, uncomment the following lines and plug in sensible data... (you don't have to)\r\n     vb.memory = 12288\r\n     vb.cpus = 8\r\n     # Enable getting host time\r\n     vb.customize [ \"setextradata\", :id, \"VBoxInternal/Devices/VMMDev/0/Config/GetHostTimeDisabled\", 0 ]\r\n     vb.customize [ \"guestproperty\", \"set\", :id, \"/VirtualBox/GuestAdd/VBoxService/--timesync-set-threshold\", 10000 ]\r\n  end\r\n\r\nend\r\n```\r\n\r\n### Expected behavior\r\nThe file `#{DIR_HOST_CHANGED_REPO}/modules/pfcp/messages.c` should have been updated inside the guest at `#{DIR_GUEST_CHANGED_REPO}` after writing to it on the host side.\r\n\r\n### Actual behavior\r\nIt was not updated. No error output was printed, so `rsync` didn't fail, either.\r\n\r\n### Steps to reproduce\r\n1. `vagrant up` \r\n2. Change `#{DIR_HOST_CHANGED_REPO}/modules/pfcp/messages.c` on the host side inside the source folder of the host-to-guest sync specified in the Vagrantfile.\r\n\r\n### Possible source of error\r\nI am suspecting that there is some conversion from the list items given by `rsync__exclude` to regular expressions for `rsync-auto` going on, and that `*.so*` or `*.o*` got converted the wrong way; afaik `rsync` is understands that `.` is a literal dot, but maybe the conversion tool assumes a `.` means we have a single character, so ghat `*.o` actually acts as if we had passed `*o`, which would then exlude `#{DIR_HOST_CHANGED_REPO}`, since the variable ends on an 'o'.\r\n\r\nAfter changing the exclude line to\r\n```ruby\r\nrsync__exclude: [\"build/**\", \"build/\", \"localInstDir/\", \"localInstDir/**\"]\r\n```\r\nsyncs were quasi-instantaneous.\r\n\r\nAlso, on the initial sync, everything was copied into the guest, so there seems to be some difference between how the initial sync works (and it did) and how rsync-auto syncs work.","closed_by":{"login":"briancain","id":810277,"node_id":"MDQ6VXNlcjgxMDI3Nw==","avatar_url":"https://avatars.githubusercontent.com/u/810277?v=4","gravatar_id":"","url":"https://api.github.com/users/briancain","html_url":"https://github.com/briancain","followers_url":"https://api.github.com/users/briancain/followers","following_url":"https://api.github.com/users/briancain/following{/other_user}","gists_url":"https://api.github.com/users/briancain/gists{/gist_id}","starred_url":"https://api.github.com/users/briancain/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/briancain/subscriptions","organizations_url":"https://api.github.com/users/briancain/orgs","repos_url":"https://api.github.com/users/briancain/repos","events_url":"https://api.github.com/users/briancain/events{/privacy}","received_events_url":"https://api.github.com/users/briancain/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/hashicorp/vagrant/issues/10966/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/hashicorp/vagrant/issues/10966/timeline","performed_via_github_app":null,"state_reason":"completed"}