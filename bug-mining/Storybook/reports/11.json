{"url":"https://api.github.com/repos/storybookjs/storybook/issues/29030","repository_url":"https://api.github.com/repos/storybookjs/storybook","labels_url":"https://api.github.com/repos/storybookjs/storybook/issues/29030/labels{/name}","comments_url":"https://api.github.com/repos/storybookjs/storybook/issues/29030/comments","events_url":"https://api.github.com/repos/storybookjs/storybook/issues/29030/events","html_url":"https://github.com/storybookjs/storybook/issues/29030","id":2501606757,"node_id":"I_kwDOAzqfmc6VG31l","number":29030,"title":"[Bug]: Storybook Vite Builder injected runtime uses .at() method, breaking compatibility with older browsers.","user":{"login":"Chudesnov","id":240422,"node_id":"MDQ6VXNlcjI0MDQyMg==","avatar_url":"https://avatars.githubusercontent.com/u/240422?v=4","gravatar_id":"","url":"https://api.github.com/users/Chudesnov","html_url":"https://github.com/Chudesnov","followers_url":"https://api.github.com/users/Chudesnov/followers","following_url":"https://api.github.com/users/Chudesnov/following{/other_user}","gists_url":"https://api.github.com/users/Chudesnov/gists{/gist_id}","starred_url":"https://api.github.com/users/Chudesnov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Chudesnov/subscriptions","organizations_url":"https://api.github.com/users/Chudesnov/orgs","repos_url":"https://api.github.com/users/Chudesnov/repos","events_url":"https://api.github.com/users/Chudesnov/events{/privacy}","received_events_url":"https://api.github.com/users/Chudesnov/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":343576454,"node_id":"MDU6TGFiZWwzNDM1NzY0NTQ=","url":"https://api.github.com/repos/storybookjs/storybook/labels/bug","name":"bug","color":"EB484F","default":true,"description":null},{"id":2901306776,"node_id":"MDU6TGFiZWwyOTAxMzA2Nzc2","url":"https://api.github.com/repos/storybookjs/storybook/labels/needs%20triage","name":"needs triage","color":"D4C5F9","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2024-09-02T21:37:30Z","updated_at":"2024-09-24T11:21:12Z","closed_at":"2024-09-24T11:21:12Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\n\nWhile most Storybook functionality does not require the latest browser versions, the Vite builder injects code into the runtime that completely breaks the app in browsers released before 2021/2022. The issue stems from this code:\r\nhttps://github.com/storybookjs/storybook/blob/00c1524e0e393da445b3a5e2d82197d453907dcc/code/builders/builder-vite/src/codegen-modern-iframe-script.ts#L30\r\n\r\nSpecifically, this runtime uses the [Array#at](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/at) method, which is not available in iOS versions prior to 15.4 (still accounting for about 1% of global web usage). Patching Array.prototype.at into the global object through `managerHead` does not resolve the issue. This is because the modules that require this syntax are loaded via `<script type=\"module\">`. In iOS Safari 15.3 at least, these modules do not seem to wait for global scripts to finish executing.\r\n\r\nSwitching to a simple [index] access method instead of .at(index) does not seem to impact any functionality.\n\n### Reproduction link\n\nhttps://vanilla-vite-chudesnov.replit.app/\n\n### Reproduction steps\n\n(Note: The example uses the development server for demonstration purposes; the result is the same when running `storybook build` instead of `dev`.)\r\n\r\n1. Using a browser that does not support `.at()`, open the provided link.\r\n1. The browser should fail with the error: \"hmrPreviewAnnotationModules.at is not a function.\"\n\n### System\n\n```bash\nThis issue is specific to the on-device browser version and is not related to the developer environment.\n```\n\n\n### Additional context\n\nThis issue complicates testing components documented with Storybook for compatibility with devices that are limited to older browser versions without upgrading the entire system (a niche use case, admittedly).\r\n\r\nTo the best of my knowledge, this is the only issue preventing Storybook built with Vite from running in most older browsers such as iOS Safari <15.4.","closed_by":{"login":"kasperpeulen","id":1035299,"node_id":"MDQ6VXNlcjEwMzUyOTk=","avatar_url":"https://avatars.githubusercontent.com/u/1035299?v=4","gravatar_id":"","url":"https://api.github.com/users/kasperpeulen","html_url":"https://github.com/kasperpeulen","followers_url":"https://api.github.com/users/kasperpeulen/followers","following_url":"https://api.github.com/users/kasperpeulen/following{/other_user}","gists_url":"https://api.github.com/users/kasperpeulen/gists{/gist_id}","starred_url":"https://api.github.com/users/kasperpeulen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kasperpeulen/subscriptions","organizations_url":"https://api.github.com/users/kasperpeulen/orgs","repos_url":"https://api.github.com/users/kasperpeulen/repos","events_url":"https://api.github.com/users/kasperpeulen/events{/privacy}","received_events_url":"https://api.github.com/users/kasperpeulen/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/storybookjs/storybook/issues/29030/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/storybookjs/storybook/issues/29030/timeline","performed_via_github_app":null,"state_reason":"completed"}