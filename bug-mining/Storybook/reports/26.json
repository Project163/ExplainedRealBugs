{"url":"https://api.github.com/repos/storybookjs/storybook/issues/31150","repository_url":"https://api.github.com/repos/storybookjs/storybook","labels_url":"https://api.github.com/repos/storybookjs/storybook/issues/31150/labels{/name}","comments_url":"https://api.github.com/repos/storybookjs/storybook/issues/31150/comments","events_url":"https://api.github.com/repos/storybookjs/storybook/issues/31150/events","html_url":"https://github.com/storybookjs/storybook/issues/31150","id":3000870748,"node_id":"I_kwDOAzqfmc6y3adc","number":31150,"title":"[Bug]: Storybook 8/9 - Playwright Portable Stories error with `Unexpected Value` if function is passed as a prop, despite it being supported by underlying CT core","user":{"login":"adamscybot","id":1210785,"node_id":"MDQ6VXNlcjEyMTA3ODU=","avatar_url":"https://avatars.githubusercontent.com/u/1210785?v=4","gravatar_id":"","url":"https://api.github.com/users/adamscybot","html_url":"https://github.com/adamscybot","followers_url":"https://api.github.com/users/adamscybot/followers","following_url":"https://api.github.com/users/adamscybot/following{/other_user}","gists_url":"https://api.github.com/users/adamscybot/gists{/gist_id}","starred_url":"https://api.github.com/users/adamscybot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adamscybot/subscriptions","organizations_url":"https://api.github.com/users/adamscybot/orgs","repos_url":"https://api.github.com/users/adamscybot/repos","events_url":"https://api.github.com/users/adamscybot/events{/privacy}","received_events_url":"https://api.github.com/users/adamscybot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":343576454,"node_id":"MDU6TGFiZWwzNDM1NzY0NTQ=","url":"https://api.github.com/repos/storybookjs/storybook/labels/bug","name":"bug","color":"EB484F","default":true,"description":null},{"id":6164011392,"node_id":"LA_kwDOAzqfmc8AAAABb2dZgA","url":"https://api.github.com/repos/storybookjs/storybook/labels/portable%20stories","name":"portable stories","color":"FBCA04","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2025-04-16T22:19:48Z","updated_at":"2025-07-01T08:23:57Z","closed_at":"2025-07-01T08:23:57Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\n\nThis bug occurs on Storybook 8 as well as 9. It's possibly been there since the experimental Playwright CT portable stories feature was added.\n\nWhen using Playwright component testing with the experimental portable stories integration, any test which passes a function as a prop to the story from the test, blows up with:\n\n```\n    Error: Unexpected value\n\n      15 | test('render button with function was passed to props', async ({ mount }) => {\n      16 |\n    > 17 |   const component = await mount(<stories.Primary label=\"label from test\" onClick={() => console.log('buttonClicked')} />);\n         |                           ^\n      18 |   await expect(component).toContainText('label from test');\n      19 | });\n```\n\nEven though the test is in node JS, and the story itself is in the browser -- functions should be allowed to be passed. [See the example](https://playwright.dev/docs/test-components#example) on the main page of the playwright CT docs. Playwright's own core mount handles this situation, with the caveats mentioned [here](https://playwright.dev/docs/test-components#how-do-i-access-the-components-methods-or-its-instance).\n\nThis works fine with the base playwright `mount()`, so the problem is within the modified version of mount that is bound to the augmented `test` function that originates from `createTest` in the `@storybook/react/experimental-playwright` package.\n\nSee additional details for more info on proposed fix.\n\n\n\n\n\n### Reproduction link\n\nhttps://github.com/adamscybot/storybook-playwright-ct-function-repro\n\n### Reproduction steps\n\nThe reproduction link is a repository with a basic broken test setup in [`Buttons.stories.spec.js` ](https://github.com/adamscybot/storybook-playwright-ct-function-repro/blob/main/src/stories/Button.stories.spec.js), as well as a \"working\" case without the function prop present.\n\nPlaywright CT has been configured according to the docs.\n\n1. Clone the above link\n2. `npm install`\n3. `npm run test-ct`\n4. Observe that the test that passes a function fails with `Unexpected value`\n\n### System\n\n```bash\nSystem:\n    OS: macOS 15.4\n    CPU: (12) arm64 Apple M2 Pro\n    Shell: 5.9 - /bin/zsh\n  Binaries:\n    Node: 20.18.3 - ~/.nvm/versions/node/v20.18.3/bin/node\n    npm: 10.8.2 - ~/.nvm/versions/node/v20.18.3/bin/npm <----- active\n    pnpm: 10.6.1 - ~/.nvm/versions/node/v20.18.3/bin/pnpm\n  Browsers:\n    Chrome: 135.0.7049.86\n    Edge: 135.0.3179.73\n    Safari: 18.4\n  npmPackages:\n    @storybook/addon-docs: ^9.0.0-alpha.19 => 9.0.0-alpha.19 \n    @storybook/addon-onboarding: ^9.0.0-alpha.19 => 9.0.0-alpha.19 \n    @storybook/react: ^9.0.0-alpha.19 => 9.0.0-alpha.19 \n    @storybook/react-vite: ^9.0.0-alpha.19 => 9.0.0-alpha.19 \n    storybook: ^9.0.0-alpha.19 => 9.0.0-alpha.19\n```\n\n### Additional context\n\nI was able to identify that the problem is originating from the `page.evaluate` calls in `createPlaywrightTest` that bookend the call to Playwrights own `mount()` function\n\nThe sections being https://github.com/storybookjs/storybook/blob/fd5928f7bad21d5f84c0f2f47727b1f62488b845/code/core/src/preview-api/modules/store/csf/portable-stories.ts#L345-L350 and https://github.com/storybookjs/storybook/blob/fd5928f7bad21d5f84c0f2f47727b1f62488b845/code/core/src/preview-api/modules/store/csf/portable-stories.ts#L356-L362.\n\nThe problem is `storyRef` contains the props, and if a function is in there, it can not be serialised (which is needed by `page.evaluate`).\n\nHowever, it appears the props being sent here are not necessary at all. The core `mount()` call handles the props, including function ones just fine. The contents of the evaluate callbacks work without the props, as it can get the desired story and call load/play on it without them. They are not relevant to that inference I beleive.\n\nThis works:\n\n```javascript\nconst { props, ...storyRefType } = storyRef\nawait page.evaluate(async (wrappedStoryRef: WrappedStoryRef) => {\n  const unwrappedStoryRef = await globalThis.__pwUnwrapObject?.(wrappedStoryRef);\n  const story =\n    '__pw_type' in unwrappedStoryRef ? unwrappedStoryRef.type : unwrappedStoryRef;\n  return story?.load?.();\n}, storyRefType);\n\n// mount the story\nconst mountResult = await mount(storyRef, ...restArgs);\n\n// play the story in the browser\nawait page.evaluate(async (wrappedStoryRef: WrappedStoryRef) => {\n  const unwrappedStoryRef = await globalThis.__pwUnwrapObject?.(wrappedStoryRef);\n  const story =\n    '__pw_type' in unwrappedStoryRef ? unwrappedStoryRef.type : unwrappedStoryRef;\n  const canvasElement = document.querySelector('#root');\n  return story?.play?.({ canvasElement });\n}, storyRefType);\n```\n\nHere I simply prevent the props being passed to the evaluate calls by destructuring them away. We still call the core `mount()` with the whole `storyRef` object including props, so Playwright can do the magic it does to make it work.\n\nThis fixes the issue, functions can be passed from tests successfully, and my test case works as expected.","closed_by":{"login":"yannbf","id":1671563,"node_id":"MDQ6VXNlcjE2NzE1NjM=","avatar_url":"https://avatars.githubusercontent.com/u/1671563?v=4","gravatar_id":"","url":"https://api.github.com/users/yannbf","html_url":"https://github.com/yannbf","followers_url":"https://api.github.com/users/yannbf/followers","following_url":"https://api.github.com/users/yannbf/following{/other_user}","gists_url":"https://api.github.com/users/yannbf/gists{/gist_id}","starred_url":"https://api.github.com/users/yannbf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yannbf/subscriptions","organizations_url":"https://api.github.com/users/yannbf/orgs","repos_url":"https://api.github.com/users/yannbf/repos","events_url":"https://api.github.com/users/yannbf/events{/privacy}","received_events_url":"https://api.github.com/users/yannbf/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/storybookjs/storybook/issues/31150/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/storybookjs/storybook/issues/31150/timeline","performed_via_github_app":null,"state_reason":"completed"}