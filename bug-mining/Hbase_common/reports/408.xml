<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:11:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HBASE-19457] Debugging flaky TestTruncateTableProcedure#testRecoveryAndDoubleExecutionPreserveSplits</title>
                <link>https://issues.apache.org/jira/browse/HBASE-19457</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Trying to explain the bug in a more general way where understanding of ProcedureV2 is not required.&lt;/p&gt;

&lt;p&gt;Truncating table operation:&lt;br/&gt;
....&lt;br/&gt;
delete region states from meta&lt;br/&gt;
delete table state from meta&lt;br/&gt;
....&lt;br/&gt;
add new regions to meta with state null.&lt;br/&gt;
....crash&lt;br/&gt;
....recovery: TableStateManager treats table with null state as ENABLED. AM treats regions with null state as offline. Combined result - AM starts assigning the new regions from incomplete truncate operation.&lt;/p&gt;

&lt;p&gt;Fix: Mark table as disabled instead of deleting it&apos;s state.&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;&lt;b&gt;patch1&lt;/b&gt;&lt;br/&gt;
Just added some logging to help with debugging:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;60s was too less time, increased timeout&lt;/li&gt;
	&lt;li&gt;Added some useful log statements&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13123621">HBASE-19457</key>
            <summary>Debugging flaky TestTruncateTableProcedure#testRecoveryAndDoubleExecutionPreserveSplits</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="appy">Apekshit Sharma</assignee>
                                    <reporter username="appy">Apekshit Sharma</reporter>
                        <labels>
                    </labels>
                <created>Fri, 8 Dec 2017 04:25:07 +0000</created>
                <updated>Wed, 1 Aug 2018 06:22:56 +0000</updated>
                            <resolved>Tue, 26 Dec 2017 19:57:36 +0000</resolved>
                                                    <fixVersion>2.0.0-beta-1</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16283036" author="appy" created="Fri, 8 Dec 2017 04:25:57 +0000"  >&lt;p&gt;This is so weird, test fails consistently upstream (individual test functions time out after 180sec), but passes locally (~80sec for whole test class , 6 tests)!&lt;/p&gt;</comment>
                            <comment id="16283058" author="appy" created="Fri, 8 Dec 2017 04:56:04 +0000"  >&lt;p&gt;Findings from today:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Checked ~10 runs, these two are failing in all.&lt;br/&gt;
org.apache.hadoop.hbase.master.procedure.TestTruncateTableProcedure.testRecoveryAndDoubleExecutionPreserveSplits&lt;br/&gt;
org.apache.hadoop.hbase.master.procedure.TestTruncateTableProcedure.testSimpleTruncatePreserveSplits&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Tried debugging testSimpleTruncatePreserveSplits (since it&apos;s simpler test), dug around, added a bunch of logging messages (will commit shortly), in the end, it&apos;s not even the culprit. It finished perfectly, but then times out cleaning up tables in @After TestTableDDLProcedureBase#teadDown.&lt;/li&gt;
	&lt;li&gt;More importantly, table testRecoveryAndDoubleExecutionPreserveSplits is the issue.
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2017-12-06 22:42:44,216 DEBUG [ProcExecWrkr-1] procedure.TruncateTableProcedure(134): truncate &apos;testSimpleTruncatePreserveSplits&apos; completed
2017-12-06 22:42:44,260 INFO  [ProcExecWrkr-1] procedure2.ProcedureExecutor(1246): Finished pid=99, state=SUCCESS; TruncateTableProcedure (table=testSimpleTruncatePreserveSplits preserveSplits=true) in 2.0060sec
2017-12-06 22:42:44,508 INFO  [Time-limited test] hbase.Waiter(189): Waiting up to [60,000] milli-secs(wait.for.ratio=[1])
2017-12-06 22:42:44,515 INFO  [Time-limited test] hbase.Waiter(189): Waiting up to [60,000] milli-secs(wait.for.ratio=[1])
2017-12-06 22:42:44,520 DEBUG [Time-limited test] util.CommonFSUtils(736): Current file system:
2017-12-06 22:42:44,521 DEBUG [Time-limited test] util.CommonFSUtils(754): |-.tabledesc/
2017-12-06 22:42:44,522 DEBUG [Time-limited test] util.CommonFSUtils(757): |----.tableinfo.0000000001
2017-12-06 22:42:44,522 DEBUG [Time-limited test] util.CommonFSUtils(754): |-.tmp/
2017-12-06 22:42:44,523 DEBUG [Time-limited test] util.CommonFSUtils(754): |-1c6cd8294a789f4998b71741869e1aa7/
2017-12-06 22:42:44,524 DEBUG [Time-limited test] util.CommonFSUtils(757): |----.regioninfo
2017-12-06 22:42:44,524 DEBUG [Time-limited test] util.CommonFSUtils(754): |----f1/
2017-12-06 22:42:44,524 DEBUG [Time-limited test] util.CommonFSUtils(754): |----f2/
2017-12-06 22:42:44,525 DEBUG [Time-limited test] util.CommonFSUtils(754): |----recovered.edits/
2017-12-06 22:42:44,526 DEBUG [Time-limited test] util.CommonFSUtils(757): |-------2.seqid
2017-12-06 22:42:44,526 DEBUG [Time-limited test] util.CommonFSUtils(754): |-5bd5770f4cb5fda71c84441d6be2c0e7/
2017-12-06 22:42:44,527 DEBUG [Time-limited test] util.CommonFSUtils(757): |----.regioninfo
2017-12-06 22:42:44,527 DEBUG [Time-limited test] util.CommonFSUtils(754): |----f1/
2017-12-06 22:42:44,527 DEBUG [Time-limited test] util.CommonFSUtils(754): |----f2/
2017-12-06 22:42:44,528 DEBUG [Time-limited test] util.CommonFSUtils(754): |----recovered.edits/
2017-12-06 22:42:44,529 DEBUG [Time-limited test] util.CommonFSUtils(757): |-------2.seqid
2017-12-06 22:42:44,529 DEBUG [Time-limited test] util.CommonFSUtils(754): |-c24958fa636e29e21028e350d32623fb/
2017-12-06 22:42:44,530 DEBUG [Time-limited test] util.CommonFSUtils(757): |----.regioninfo
2017-12-06 22:42:44,530 DEBUG [Time-limited test] util.CommonFSUtils(754): |----f1/
2017-12-06 22:42:44,530 DEBUG [Time-limited test] util.CommonFSUtils(754): |----f2/
2017-12-06 22:42:44,531 DEBUG [Time-limited test] util.CommonFSUtils(754): |----recovered.edits/
2017-12-06 22:42:44,532 DEBUG [Time-limited test] util.CommonFSUtils(757): |-------2.seqid
2017-12-06 22:42:44,532 DEBUG [Time-limited test] util.CommonFSUtils(754): |-e9f2e3d66bf51aa5d73745df63badf9a/
2017-12-06 22:42:44,533 DEBUG [Time-limited test] util.CommonFSUtils(757): |----.regioninfo
2017-12-06 22:42:44,533 DEBUG [Time-limited test] util.CommonFSUtils(754): |----f1/
2017-12-06 22:42:44,533 DEBUG [Time-limited test] util.CommonFSUtils(754): |----f2/
2017-12-06 22:42:44,534 DEBUG [Time-limited test] util.CommonFSUtils(754): |----recovered.edits/
2017-12-06 22:42:44,535 DEBUG [Time-limited test] util.CommonFSUtils(757): |-------2.seqid
2017-12-06 22:42:44,556 DEBUG [RpcServer.default.FPBQ.Fifo.handler=4,queue=0,port=43202] ipc.CallRunner(141): callId: 233 service: ClientService methodName: Scan size: 138 connection: 67.195.81.155:48320 deadline: 1512600224556

.....some scanner errors for NotServingRegionException, but then retry passes....

2017-12-06 22:42:44,998 DEBUG [Time-limited test] client.ClientScanner(241): Advancing internal scanner to startKey at &apos;a&apos;, inclusive
2017-12-06 22:42:45,000 DEBUG [Time-limited test] client.ClientScanner(241): Advancing internal scanner to startKey at &apos;b&apos;, inclusive
2017-12-06 22:42:45,002 DEBUG [Time-limited test] client.ClientScanner(241): Advancing internal scanner to startKey at &apos;c&apos;, inclusive
2017-12-06 22:42:45,005 WARN  [Time-limited test] procedure2.ProcedureTestingUtility(146): Set Kill before store update to: false
2017-12-06 22:42:45,012 INFO  [Time-limited test] procedure.TestTableDDLProcedureBase(67): Tear down, remove table=testRecoveryAndDoubleExecutionPreserveSplits
2017-12-06 22:42:45,013 INFO  [Time-limited test] client.HBaseAdmin$15(895): Started disable of testRecoveryAndDoubleExecutionPreserveSplits
2017-12-06 22:42:45,014 INFO  [RpcServer.default.FPBQ.Fifo.handler=3,queue=0,port=39318] master.HMaster$8(2284): Client=jenkins//67.195.81.155 disable testRecoveryAndDoubleExecutionPreserveSplits
2017-12-06 22:42:45,103 DEBUG [RpcServer.default.FPBQ.Fifo.handler=3,queue=0,port=39318] procedure2.ProcedureExecutor(868): Stored pid=104, state=RUNNABLE:DISABLE_TABLE_PREPARE; DisableTableProcedure table=testRecoveryAndDoubleExecutionPreserveSplits
2017-12-06 22:42:45,105 DEBUG [RpcServer.default.FPBQ.Fifo.handler=3,queue=0,port=39318] master.MasterRpcServices(1124): Checking to see if procedure is done pid=104
2017-12-06 22:42:45,207 DEBUG [RpcServer.default.FPBQ.Fifo.handler=3,queue=0,port=39318] master.MasterRpcServices(1124): Checking to see if procedure is done pid=104
2017-12-06 22:42:45,409 DEBUG [RpcServer.default.FPBQ.Fifo.handler=3,queue=0,port=39318] master.MasterRpcServices(1124): Checking to see if procedure is done pid=104
2017-12-06 22:42:45,711 DEBUG [RpcServer.default.FPBQ.Fifo.handler=3,queue=0,port=39318] master.MasterRpcServices(1124): Checking to see if procedure is done pid=104
2017-12-06 22:42:46,202 INFO  [ReadOnlyZKClient] zookeeper.ReadOnlyZKClient(306): 0x5adb9ac4 no activities for 60000 ms, close active connection. Will reconnect next time when there are new requests.
2017-12-06 22:42:46,213 DEBUG [RpcServer.default.FPBQ.Fifo.handler=3,queue=0,port=39318] master.MasterRpcServices(1124): Checking to see if procedure is done pid=104
2017-12-06 22:42:47,215 DEBUG [RpcServer.default.FPBQ.Fifo.handler=3,queue=0,port=39318] master.MasterRpcServices(1124): Checking to see if procedure is done pid=104
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Onto debugging testRecoveryAndDoubleExecutionPreserveSplits now.&lt;/p&gt;</comment>
                            <comment id="16284502" author="appy" created="Sat, 9 Dec 2017 01:27:27 +0000"  >&lt;p&gt;After more debugging, testRecoveryAndDoubleExecutionPreserveSplits is just a lot of failing and recovery and needs more time (it reaches just halfway when clock hits the minute). Removing 60s timeout.&lt;br/&gt;
Also adding some more logging to help in future debugging.&lt;/p&gt;</comment>
                            <comment id="16284510" author="appy" created="Sat, 9 Dec 2017 01:53:32 +0000"  >&lt;p&gt;Although the test timed out after 60 sec, it had at least reached TRUNCATE_TABLE_ADD_TO_META state.&lt;br/&gt;
One bug i see here is, if master crashes after performing TRUNCATE_TABLE_ADD_TO_META, when the new AM comes up, it reads back the meta and assumes that these newly added regions are offline and need to be reassigned (see logs below). But that&apos;s wrong since recovered TruncateTableProcedure will try to do the same.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Edit&lt;/b&gt;: Striking out below text. AM shouldn&apos;t be assigning regions from incomplete actions. Analysis of case when it does so (below stuff) is irrelevant. Fix here should be truncate procedure better managing state of table/regions in meta AND/OR assignment manager handling default cases in a better way.&lt;br/&gt;
-&lt;del&gt;Since there&apos;s table lock, they won&apos;t execute in parallel, but i think it&apos;ll be:&lt;/del&gt;-&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;-&lt;del&gt;Fine if truncate proc executes first. Assign procs will complete immediately saying regions are assigned.&lt;/del&gt;-&lt;/li&gt;
	&lt;li&gt;-&lt;del&gt;Bad if assign procs executes first. Since, when truncate proc will execute later, it&apos;ll meddle with hbase:meta assuming table is disabled and try to assign and fail.&lt;/del&gt;-&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;-&lt;del&gt;An even worst scenario would be: If 1) master crashes, 2)region containing meta crashes in between puts and only some puts succeed&lt;/del&gt;-&lt;br/&gt;
-&lt;del&gt;Then new AM will bring partial regions (since even meta doesn&apos;t know about all regions) of the table online.&lt;/del&gt;-&lt;/p&gt;

&lt;p&gt;Waiting for more runs after increasing timeout to get better logs.&lt;/p&gt;
</comment>
                            <comment id="16284584" author="hudson" created="Sat, 9 Dec 2017 04:31:00 +0000"  >&lt;p&gt;FAILURE: Integrated in Jenkins build HBase-Trunk_matrix #4192 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-Trunk_matrix/4192/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/HBase-Trunk_matrix/4192/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-19457&quot; title=&quot;Debugging flaky TestTruncateTableProcedure#testRecoveryAndDoubleExecutionPreserveSplits&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-19457&quot;&gt;&lt;del&gt;HBASE-19457&lt;/del&gt;&lt;/a&gt; Debugging flaky TestTruncateTableProcedure (appy: rev 7092b814bd5c5e243987853771dc2ec339ae0b0c)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/AssignmentManager.java&lt;/li&gt;
	&lt;li&gt;(edit) hbase-server/src/test/java/org/apache/hadoop/hbase/master/procedure/TestTruncateTableProcedure.java&lt;/li&gt;
	&lt;li&gt;(edit) hbase-server/src/test/java/org/apache/hadoop/hbase/master/procedure/MasterProcedureTestingUtility.java&lt;/li&gt;
	&lt;li&gt;(edit) hbase-common/src/main/java/org/apache/hadoop/hbase/util/CommonFSUtils.java&lt;/li&gt;
	&lt;li&gt;(edit) hbase-procedure/src/main/java/org/apache/hadoop/hbase/procedure2/StateMachineProcedure.java&lt;/li&gt;
	&lt;li&gt;(edit) hbase-server/src/main/java/org/apache/hadoop/hbase/master/procedure/TruncateTableProcedure.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16290632" author="appy" created="Thu, 14 Dec 2017 09:52:10 +0000"  >&lt;p&gt;After more debugging, i think i finally have fix (sorry for being slow, just beginning to understand AM).&lt;/p&gt;

&lt;p&gt;So the issue is,&lt;br/&gt;
We delete table&apos;s state from meta (in step &lt;a href=&quot;https://github.com/apache/hbase/blob/7466e64abb2c68c8a0f40f6051e4b5bf550e69bd/hbase-server/src/main/java/org/apache/hadoop/hbase/master/procedure/TruncateTableProcedure.java#L102&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;TRUNCATE_TABLE_REMOVE_FROM_META &lt;/a&gt;)&lt;br/&gt;
On recovery, TableStateManager#fixTableStates assumes that missing state means enabled table is enabled. (&lt;a href=&quot;https://github.com/apache/hbase/blob/7466e64abb2c68c8a0f40f6051e4b5bf550e69bd/hbase-server/src/main/java/org/apache/hadoop/hbase/master/TableStateManager.java#L218&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;Later we add regions to meta and crash after that. On recovery, AM sees these regions, looks for table state and finds it enabled, and starts assigning them and screws up.&lt;/p&gt;

&lt;p&gt;Simple fix here would be: Don&apos;t delete table state from meta, just let it remain DISABLED.&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;But CreateTableProcedure also adds regions to meta and crashes. Why don&apos;t we see same issue there?&lt;br/&gt;
It adds region row to meta, but does not add any row for the table. &lt;br/&gt;
On recovery, when AM looks for table state corresponding to those regions, TSM#getTableState() throws TableNotFoundException, which get&apos;s caught &lt;a href=&quot;https://github.com/apache/hbase/blob/master/hbase-server/src/main/java/org/apache/hadoop/hbase/master/TableStateManager.java#L135&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;..etc etc&lt;br/&gt;
End result being, it ignores those regions.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Some bigger questions to ponder:&lt;br/&gt;
1) Should we really assume missing state column as enabled? Probably assuming disabled is more conservative and better choice? Won&apos;t screws up the cluster. (Only other place delete the state column is hbck)&lt;br/&gt;
2) Shouldn&apos;t new regions always be added with state closed? (dev thread: &lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/hbase-dev/201712.mbox/browser&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://mail-archives.apache.org/mod_mbox/hbase-dev/201712.mbox/browser&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="16290681" author="appy" created="Thu, 14 Dec 2017 10:26:10 +0000"  >&lt;p&gt;Ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stack&quot; class=&quot;user-hover&quot; rel=&quot;stack&quot;&gt;stack&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Apache9&quot; class=&quot;user-hover&quot; rel=&quot;Apache9&quot;&gt;Apache9&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16290698" author="apache9" created="Thu, 14 Dec 2017 10:41:36 +0000"  >&lt;p&gt;I&apos;m not very familiar with the current AM yet, but I know it is complicated when reading the procedure2 related code...&lt;/p&gt;

&lt;p&gt;So let&apos;s wait for the boss &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stack&quot; class=&quot;user-hover&quot; rel=&quot;stack&quot;&gt;stack&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16290793" author="hadoopqa" created="Thu, 14 Dec 2017 12:53:34 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/error.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;b&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;&lt;/b&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Vote &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Subsystem &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Runtime &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Comment &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;blue&quot;&gt;0&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;blue&quot;&gt; reexec &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;blue&quot;&gt;  0m  8s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;blue&quot;&gt; Docker mode activated. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; Prechecks &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;blue&quot;&gt;0&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;blue&quot;&gt; findbugs &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;blue&quot;&gt;  0m  0s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;blue&quot;&gt; Findbugs executables are not available. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; hbaseanti &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  0m  0s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Patch does not have any anti-patterns. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; @author &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  0m  0s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; The patch does not contain any @author tags. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt;-1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt; test4tests &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt;  0m  0s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt; The patch doesn&apos;t appear to include any new or modified tests. Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; master Compile Tests &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; mvninstall &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  5m 37s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; master passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; compile &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  0m 53s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; master passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; checkstyle &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m  8s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; master passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; shadedjars &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  6m  9s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; branch has no errors when building our shaded downstream artifacts. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; javadoc &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  0m 36s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; master passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; Patch Compile Tests &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; mvninstall &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  5m 26s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; compile &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  0m 48s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; javac &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  0m 48s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; checkstyle &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m 10s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; whitespace &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  0m  0s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; The patch has no whitespace issues. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; shadedjars &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  4m 53s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; patch has no errors when building our shaded downstream artifacts. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; hadoopcheck &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; 22m 21s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Patch does not cause any errors with Hadoop 2.6.5 2.7.4 or 3.0.0-beta1. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; javadoc &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  0m 35s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; Other Tests &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; unit &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; 98m 27s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; hbase-server in the patch passed. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; asflicense &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  0m 17s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; The patch does not generate ASF License warnings. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt;&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt; &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt;142m 42s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt; &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Subsystem &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Report/Notes &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Docker &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Client=17.05.0-ce Server=17.05.0-ce Image:yetus/hbase:eee3b01 &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; JIRA Issue &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-19457&quot; title=&quot;Debugging flaky TestTruncateTableProcedure#testRecoveryAndDoubleExecutionPreserveSplits&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-19457&quot;&gt;&lt;del&gt;HBASE-19457&lt;/del&gt;&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; JIRA Patch URL &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12902038/HBASE-19457.master.001.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12902038/HBASE-19457.master.001.patch&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Optional Tests &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  asflicense  javac  javadoc  unit  findbugs  shadedjars  hadoopcheck  hbaseanti  checkstyle  compile  &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; uname &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Linux 7bde35b740b5 3.13.0-133-generic #182-Ubuntu SMP Tue Sep 19 15:49:21 UTC 2017 x86_64 GNU/Linux &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Build tool &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; maven &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Personality &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; /home/jenkins/jenkins-slave/workspace/PreCommit-HBASE-Build@2/component/dev-support/hbase-personality.sh &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; git revision &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; master / 7466e64abb &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; maven &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; version: Apache Maven 3.5.2 (138edd61fd100ec658bfa2d307c43b76940a5d7d; 2017-10-18T07:58:13Z) &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Default Java &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 1.8.0_151 &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  Test Results &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/10442/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/10442/testReport/&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; modules &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; C: hbase-server U: hbase-server &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Console output &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/10442/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/10442/console&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Powered by &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Apache Yetus 0.6.0   &lt;a href=&quot;http://yetus.apache.org&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://yetus.apache.org&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;



&lt;p&gt;This message was automatically generated.&lt;/p&gt;
</comment>
                            <comment id="16291183" author="appy" created="Thu, 14 Dec 2017 17:04:40 +0000"  >&lt;p&gt;Sure thing Duo. Thanks nevertheless!&lt;/p&gt;</comment>
                            <comment id="16291441" author="appy" created="Thu, 14 Dec 2017 19:37:15 +0000"  >&lt;p&gt;Let me put it in a more general way where understanding of ProcedureV2 is not required.&lt;/p&gt;

&lt;p&gt;Truncating table:&lt;br/&gt;
....&lt;br/&gt;
delete region states from meta&lt;br/&gt;
delete table state from meta&lt;br/&gt;
....&lt;br/&gt;
add new regions to meta with state null.&lt;br/&gt;
....crash&lt;br/&gt;
....recovery: TableStateManager treats table with null state as ENABLED. AM treats regions with null state as offline. Combined result - AM starts assigning the new regions from incomplete truncate operation.&lt;/p&gt;

&lt;p&gt;Fix: Mark table as disabled instead of deleting it&apos;s state.&lt;/p&gt;</comment>
                            <comment id="16292097" author="stack" created="Fri, 15 Dec 2017 06:28:39 +0000"  >&lt;p&gt;Good one Appy. There are pieces that still need paving over. Looks like you found one (I&apos;m currently working on another).&lt;/p&gt;

&lt;p&gt;When we truncate, we delete the table and its regions from hbase:meta or do we just edit state? (Looks like we delete the regions... good).&lt;/p&gt;

&lt;p&gt;Dang. Why is this Truncate Table not calling DeleteTable then CreateTable as subprocedures? Why is it dup&apos;ing procedure body?&lt;/p&gt;

&lt;p&gt;If a crash puts us into a whack state such that on resumption we do the wrong thing, then the Procedure is not written properly. &lt;/p&gt;

&lt;p&gt;What is wrong about when it goes to assign? Is it that we have not finished editing/adding all regions to hbase:meta?&lt;/p&gt;

&lt;p&gt;I&apos;ve been working on Master startup. It reads meta and if it finds regions in OPEN state, it will reassign them trying to retain their old locations. It will also assign regions that are OFFLINE which thinking about it now is NOT what we want.&lt;/p&gt;

&lt;p&gt;Who is doing the assign of regions with empty state?&lt;/p&gt;

&lt;p&gt;(Can talk tomorrow boss)&lt;/p&gt;</comment>
                            <comment id="16292170" author="appy" created="Fri, 15 Dec 2017 08:07:00 +0000"  >&lt;blockquote&gt;&lt;p&gt;Dang. Why is this Truncate Table not calling DeleteTable then CreateTable as subprocedures? Why is it dup&apos;ing procedure body?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Had same thought during debugging. Maybe the answer lies in Pv2 being able to handle trees of proc-subprocs. Given design around rootProcid, i think that was the goal, but not sure of it&apos;s status.&lt;br/&gt;
At this point, instead of digging into Pv2 design to figure that out seemed waste of time  since&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if it&apos;s complete, we still probably shouldn&apos;t change things close to release&lt;/li&gt;
	&lt;li&gt;if not complete, we can&apos;t invest time to finish it before&lt;/li&gt;
	&lt;li&gt;Internal stuff, can be done in 2.1&lt;/li&gt;
	&lt;li&gt;More important things are there than this &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;blockquote&gt;&lt;p&gt;If a crash puts us into a whack state such that on resumption we do the wrong thing, then the Procedure is not written properly.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;It&apos;s was not managing state correctly. I want to try this one line patch because it should fix it.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;What is wrong about when it goes to assign? Is it that we have not finished editing/adding all regions to hbase:meta?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;All regions are added to meta. But AM starts it&apos;s own assign procs first (in recovery phase itself before joining cluster, ie. other procs can run), and they too get stuck somehow.&lt;/p&gt;

&lt;p&gt;AM only assigns offline regions if table is marked enabled.&lt;br/&gt;
It&apos;s two assumptions together which leads to wrong behavior here.&lt;br/&gt;
AM assumes regions with empty state are offline. TableStateManager (TSM) assumes table with empty state is enabled.&lt;br/&gt;
When AM recovers, it starts assigning.&lt;br/&gt;
We can easily solve the issue here by marking table as disabled.&lt;/p&gt;

&lt;p&gt;In the end it&apos;s these three things:&lt;br/&gt;
We should probably change TSM to assume tables with empty state as disabled.&lt;br/&gt;
Always add new regions as CLOSED.&lt;br/&gt;
And to tie last loose end, decide if region empty null means offline or closed. &lt;/p&gt;
</comment>
                            <comment id="16292901" author="stack" created="Fri, 15 Dec 2017 17:45:46 +0000"  >&lt;p&gt;Loads of our Procedures are written as Procedures spawning subprocedures so we know it &apos;works&apos;.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;But AM starts it&apos;s own assign procs first (in recovery phase itself before joining cluster, ie. other procs can run), and they too get stuck somehow.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;One note is that it is ok if two assigns scheduled. The second will notice the successful first one and then finish.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;But AM starts it&apos;s own assign procs first (in recovery phase itself before joining cluster, ie. other procs can run), and they too get stuck somehow.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We could look at a log together?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;AM only assigns offline regions if table is marked enabled.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You are right...&lt;/p&gt;

&lt;p&gt;      } else if (regionNode.getState() == State.OFFLINE) {&lt;br/&gt;
        if (isTableEnabled(regionNode.getTable())) {&lt;br/&gt;
          offlineRegionsToAssign.add(regionNode.getRegionInfo());&lt;br/&gt;
...&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;We can easily solve the issue here by marking table as disabled.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;As a step in truncate before we create the new? Wonder why this needs it and CreateTable doesnt (I think you ask this above).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;We should probably change TSM to assume tables with empty state as disabled.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hmm. Will complicate rolling upgrade.&lt;/p&gt;

&lt;p&gt;I like your questions on the end. They are questions about how the state machine should work. There should be no fuzzyness around states. Plainly there is going by your work here. Lets fix. New issue?&lt;/p&gt;

</comment>
                            <comment id="16293380" author="appy" created="Fri, 15 Dec 2017 22:42:38 +0000"  >&lt;p&gt;We discussed few things, here&apos;s the summary:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;we have procs spawing subprocs, but not sure if there&apos;s an example where this tree&apos;s depth &amp;gt; 2. If yes, we can change truncate proc to just delete proc + create proc.&lt;/li&gt;
&lt;/ul&gt;


&lt;blockquote&gt;&lt;p&gt;As a step in truncate before we create the new? Wonder why this needs it and CreateTable doesnt (I think you ask this above).&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Both have ADD_TO_META step where they add regions to meta. But when we fail after that:&lt;br/&gt;
in case of truncate proc, there&apos;s a table row in meta with state null --&amp;gt; gets assumed as enabled --&amp;gt; AM starts interfering&lt;br/&gt;
in case of create proc, there&apos;s no table row at all --&amp;gt; AM ignores those new regions&lt;/p&gt;

&lt;p&gt;New stuff:&lt;br/&gt;
Stack recently committed &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-18946&quot; title=&quot;Stochastic load balancer assigns replica regions to the same RS&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-18946&quot;&gt;&lt;del&gt;HBASE-18946&lt;/del&gt;&lt;/a&gt; which fixes issues around balancer and assigning. After it went in, we see more greens for TestTruncateTableProcedure in flaky dashboard.&lt;br/&gt;
A word on that:&lt;br/&gt;
When AM interfered on recovery (see &quot;...recovery: TableStateManager treats table with null state as ENABLED. AM treats regions with null state as offline. Combined result - AM starts assigning the new &quot; in description), it started Assign procs. But they got stuck for some reason (which i didn&apos;t care to debug as part of this test fix since it&apos;s unrelated). His patch makes that case better.&lt;br/&gt;
But the real fix here should be to correctly handle state in TTP so that AM doesn&apos;t interfere.&lt;/p&gt;

&lt;p&gt;We&apos;ll keep an eye on dashboard, see the new failures, and then decide verdict on this jira&apos;s patch.&lt;/p&gt;

&lt;p&gt;In meantime opened this new jira to discuss other questions &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-19529&quot; title=&quot;Handle null states in AM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-19529&quot;&gt;&lt;del&gt;HBASE-19529&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-19530&quot; title=&quot;New regions should always be added with state CLOSED&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-19530&quot;&gt;&lt;del&gt;HBASE-19530&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16293435" author="stack" created="Sat, 16 Dec 2017 00:08:58 +0000"  >&lt;p&gt;I can&apos;t find a case of three tiers of proc. Would need to try it.  I don&apos;t see why not.&lt;/p&gt;

&lt;p&gt;Yeah, its turning up some greens now when it used to be solid red: &lt;a href=&quot;https://builds.apache.org/view/H-L/view/HBase/job/HBase-Find-Flaky-Tests/lastSuccessfulBuild/artifact/dashboard.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/view/H-L/view/HBase/job/HBase-Find-Flaky-Tests/lastSuccessfulBuild/artifact/dashboard.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The new failure types &amp;#8211; 2 out 5 &amp;#8211; seem different. As you say, lets keep an eye on it.&lt;/p&gt;

&lt;p&gt;Thanks for new JIRAs. Yeah, lets sort out state in meta.&lt;/p&gt;</comment>
                            <comment id="16295907" author="appy" created="Tue, 19 Dec 2017 00:06:04 +0000"  >&lt;p&gt;Still failing, less frequently on apache infra, but much more frequently on GCE infra. Will take a look.&lt;/p&gt;</comment>
                            <comment id="16303992" author="appy" created="Tue, 26 Dec 2017 19:56:00 +0000"  >&lt;p&gt;Fixed now. But quoting the comment from other jira (&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-19530?focusedCommentId=16293663&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16293663&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-19530?focusedCommentId=16293663&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16293663&lt;/a&gt;).&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Btw, i predict that this patch might make &quot;fix&quot; TestTruncateTableProcedure.&lt;br/&gt;
I quote fix because, those failures are result of two assumption collectively resulting in a failure (region state = null --&amp;gt; assume OFFLINE, table state = null --&amp;gt; assume ENABLED).&lt;br/&gt;
This will break the first one and test might start passing.&lt;br/&gt;
But we still need to address the second one, and that will be done in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-19529&quot; title=&quot;Handle null states in AM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-19529&quot;&gt;&lt;del&gt;HBASE-19529&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Closing this one.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12902038" name="HBASE-19457.master.001.patch" size="1584" author="appy" created="Thu, 14 Dec 2017 10:25:32 +0000"/>
                            <attachment id="12901654" name="patch1" size="11932" author="appy" created="Tue, 12 Dec 2017 11:04:54 +0000"/>
                            <attachment id="12901339" name="test-output.txt" size="2226305" author="appy" created="Sat, 9 Dec 2017 01:35:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 46 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3nodz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>