diff --git a/hbase-common/src/main/java/org/apache/hadoop/hbase/util/CoprocessorClassLoader.java b/hbase-common/src/main/java/org/apache/hadoop/hbase/util/CoprocessorClassLoader.java
index 3a65fc5d0f..745896a6ed 100644
--- a/hbase-common/src/main/java/org/apache/hadoop/hbase/util/CoprocessorClassLoader.java
+++ b/hbase-common/src/main/java/org/apache/hadoop/hbase/util/CoprocessorClassLoader.java
@@ -152,7 +152,7 @@ public class CoprocessorClassLoader extends ClassLoaderBase {
     synchronized (parentDirLockSet) {
       if (!parentDirLockSet.contains(parentDirStr)) {
         Path parentDir = new Path(parentDirStr);
-        FileSystem fs = parentDir.getFileSystem(conf);
+        FileSystem fs = FileSystem.getLocal(conf);
         fs.delete(parentDir, true); // it's ok if the dir doesn't exist now
         parentDirLockSet.add(parentDirStr);
         if (!fs.mkdirs(parentDir) && !fs.getFileStatus(parentDir).isDir()) {
diff --git a/hbase-common/src/test/java/org/apache/hadoop/hbase/HBaseCommonTestingUtility.java b/hbase-common/src/test/java/org/apache/hadoop/hbase/HBaseCommonTestingUtility.java
index d95b2bd307..d5e5f9c8b7 100644
--- a/hbase-common/src/test/java/org/apache/hadoop/hbase/HBaseCommonTestingUtility.java
+++ b/hbase-common/src/test/java/org/apache/hadoop/hbase/HBaseCommonTestingUtility.java
@@ -27,6 +27,7 @@ import org.apache.commons.logging.Log;
 import org.apache.commons.logging.LogFactory;
 import org.apache.hadoop.classification.InterfaceAudience;
 import org.apache.hadoop.classification.InterfaceStability;
+import org.apache.hadoop.conf.Configuration;
 import org.apache.hadoop.fs.Path;
 
 /**
@@ -39,6 +40,24 @@ import org.apache.hadoop.fs.Path;
 public class HBaseCommonTestingUtility {
   protected static final Log LOG = LogFactory.getLog(HBaseCommonTestingUtility.class);
 
+  protected Configuration conf;
+
+  public HBaseCommonTestingUtility() {
+    this(HBaseConfiguration.create());
+  }
+
+  public HBaseCommonTestingUtility(Configuration conf) {
+    this.conf = conf;
+  }
+
+  /**
+   * Returns this classes's instance of {@link Configuration}.
+   * @return Instance of Configuration.
+   */
+  public Configuration getConfiguration() {
+    return this.conf;
+  }
+
   /**
    * System property key to get base test directory value
    */
@@ -95,9 +114,19 @@ public class HBaseCommonTestingUtility {
     // Set this property so if mapreduce jobs run, they will use this as their home dir.
     System.setProperty("test.build.dir", this.dataTestDir.toString());
     if (deleteOnExit()) this.dataTestDir.deleteOnExit();
+
+    createSubDir("hbase.local.dir", testPath, "hbase-local-dir");
+
     return testPath;
   }
 
+  protected void createSubDir(String propertyName, Path parent, String subDirName){
+    Path newPath= new Path(parent, subDirName);
+    File newDir = new File(newPath.toString()).getAbsoluteFile();
+    if (deleteOnExit()) newDir.deleteOnExit();
+    conf.set(propertyName, newDir.getAbsolutePath());
+  }
+
   /**
    * @return True if we should delete testing dirs on exit.
    */
diff --git a/hbase-common/src/test/java/org/apache/hadoop/hbase/util/TestCoprocessorClassLoader.java b/hbase-common/src/test/java/org/apache/hadoop/hbase/util/TestCoprocessorClassLoader.java
index 91dd87ffdb..942c7e37e0 100644
--- a/hbase-common/src/test/java/org/apache/hadoop/hbase/util/TestCoprocessorClassLoader.java
+++ b/hbase-common/src/test/java/org/apache/hadoop/hbase/util/TestCoprocessorClassLoader.java
@@ -30,7 +30,6 @@ import java.io.FileOutputStream;
 import org.apache.hadoop.conf.Configuration;
 import org.apache.hadoop.fs.Path;
 import org.apache.hadoop.hbase.HBaseCommonTestingUtility;
-import org.apache.hadoop.hbase.HBaseConfiguration;
 import org.apache.hadoop.hbase.SmallTests;
 import org.apache.hadoop.io.IOUtils;
 import org.junit.Test;
@@ -41,9 +40,12 @@ import org.junit.experimental.categories.Category;
  */
 @Category(SmallTests.class)
 public class TestCoprocessorClassLoader {
-  private static final Configuration conf = HBaseConfiguration.create();
 
   private static final HBaseCommonTestingUtility TEST_UTIL = new HBaseCommonTestingUtility();
+  private static final Configuration conf = TEST_UTIL.getConfiguration();
+  static {
+    TEST_UTIL.getDataTestDir(); // prepare data test dir and hbase local dir
+  }
 
   @Test
   public void testCleanupOldJars() throws Exception {
diff --git a/hbase-common/src/test/java/org/apache/hadoop/hbase/util/TestDynamicClassLoader.java b/hbase-common/src/test/java/org/apache/hadoop/hbase/util/TestDynamicClassLoader.java
index dfe439b2ad..11a545bf57 100644
--- a/hbase-common/src/test/java/org/apache/hadoop/hbase/util/TestDynamicClassLoader.java
+++ b/hbase-common/src/test/java/org/apache/hadoop/hbase/util/TestDynamicClassLoader.java
@@ -27,7 +27,6 @@ import org.apache.commons.logging.Log;
 import org.apache.commons.logging.LogFactory;
 import org.apache.hadoop.conf.Configuration;
 import org.apache.hadoop.hbase.HBaseCommonTestingUtility;
-import org.apache.hadoop.hbase.HBaseConfiguration;
 import org.apache.hadoop.hbase.SmallTests;
 import org.junit.Test;
 import org.junit.experimental.categories.Category;
@@ -39,9 +38,8 @@ import org.junit.experimental.categories.Category;
 public class TestDynamicClassLoader {
   private static final Log LOG = LogFactory.getLog(TestDynamicClassLoader.class);
 
-  private static final Configuration conf = HBaseConfiguration.create();
-
   private static final HBaseCommonTestingUtility TEST_UTIL = new HBaseCommonTestingUtility();
+  private static final Configuration conf = TEST_UTIL.getConfiguration();
 
   static {
     conf.set("hbase.dynamic.jars.dir", TEST_UTIL.getDataTestDir().toString());
