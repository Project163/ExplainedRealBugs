{"url":"https://api.github.com/repos/obsproject/obs-studio/issues/4885","repository_url":"https://api.github.com/repos/obsproject/obs-studio","labels_url":"https://api.github.com/repos/obsproject/obs-studio/issues/4885/labels{/name}","comments_url":"https://api.github.com/repos/obsproject/obs-studio/issues/4885/comments","events_url":"https://api.github.com/repos/obsproject/obs-studio/issues/4885/events","html_url":"https://github.com/obsproject/obs-studio/issues/4885","id":919626283,"node_id":"MDU6SXNzdWU5MTk2MjYyODM=","number":4885,"title":"obs-ffmpeg: AAC encoder fails with Invalid argument (NaN error)","user":{"login":"SuslikV","id":19683044,"node_id":"MDQ6VXNlcjE5NjgzMDQ0","avatar_url":"https://avatars.githubusercontent.com/u/19683044?v=4","gravatar_id":"","url":"https://api.github.com/users/SuslikV","html_url":"https://github.com/SuslikV","followers_url":"https://api.github.com/users/SuslikV/followers","following_url":"https://api.github.com/users/SuslikV/following{/other_user}","gists_url":"https://api.github.com/users/SuslikV/gists{/gist_id}","starred_url":"https://api.github.com/users/SuslikV/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SuslikV/subscriptions","organizations_url":"https://api.github.com/users/SuslikV/orgs","repos_url":"https://api.github.com/users/SuslikV/repos","events_url":"https://api.github.com/users/SuslikV/events{/privacy}","received_events_url":"https://api.github.com/users/SuslikV/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2021-06-12T17:55:59Z","updated_at":"2022-05-21T00:24:49Z","closed_at":"2022-05-21T00:24:49Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Operating System Info\r\n\r\nOther\r\n\r\n### Other OS\r\n\r\nany OS\r\n\r\n### OBS Studio Version\r\n\r\n27.0.0\r\n\r\n### OBS Studio Version (Other)\r\n\r\n_No response_\r\n\r\n### OBS Studio Log URL\r\n\r\nabout:blank\r\n\r\n### OBS Studio Crash Log URL\r\n\r\n_No response_\r\n\r\n### Expected Behavior\r\n\r\nCommon AAC Encoder shouldn't fail on broken audio samples.\r\n\r\n### Current Behavior\r\n\r\nWhen decoded audio has NaN as value the OBS Studio fails to encode it into AAC and stops recording/streaming immediately.\r\n\r\n### Steps to Reproduce\r\n\r\n1. Run OBS Studio\r\n2. Enable Replay Buffer (simple mode)\r\n3. Start Replay Buffer (encoding should start)\r\n4. Add Media source and point it to the attached \"issue FFmpeg NaN aac encode error - Short - 50ms.wav\" file.\r\n5. Click OK button to close the source properties.\r\n6. If encoder didn't yet fail for you - try to show/hide the Media source (p.4) few times.\r\n7. The OBS Studio stops the Replay Buffer and rises error message: \"Recording error - An unsupported error occurred while recording\". The log file has next entry: \r\n```\r\n20:02:03.547: error:   Input contains (near) NaN/+-Inf\r\n20:02:03.547: [FFmpeg aac encoder: 'simple_aac'] avcodec_encode_audio2 failed: Invalid argument\r\n20:02:03.547: Error encoding with encoder 'simple_aac'\r\n```\r\n**TEST FILE:**\r\n[issue FFmpeg NaN aac encode error - Short - 50ms.zip](https://github.com/obsproject/obs-studio/files/6642593/issue.FFmpeg.NaN.aac.encode.error.-.Short.-.50ms.zip)\r\n359 bytes to download, CRC of the .zip archive MD5:1C0440AB08860A39A02822AFA4C369C7\r\n\r\n### Anything else we should know?\r\n\r\n- The FFmpeg AAC encoder fails on input of the  floating point number that represents NaN (usually it keeps NaN in all math calculations, thus it is possible). This happens inside internal FFmpeg's _aac_encode_frame_ function.\r\n- Audio in OBS can be modified by third-party plugins that can be written improperly (or without awareness of this limitation of the FFmpeg and OBS): https://obsproject.com/forum/threads/obs-studio-27-release-candidate.141857/page-2#post-522499\r\n- The **test file*** that surely fails to encode by the OBS consist of the stereo data, 48kHz, about 50ms long, 32 bit float-point format. Both channels keeps silent until offset 1038(h), **where placed two NaN**s - 7F900000(h) (LSB first, one number for each channel). Media files less then 22ms may not trigger the encoding error. Any NaN in the audio will trigger the error and stops any running output that uses FFmpeg's AAC encoder.\r\n*see attached above \"issue FFmpeg NaN aac encode error - Short - 50ms.wav\" file for Media source.","closed_by":{"login":"notr1ch","id":876345,"node_id":"MDQ6VXNlcjg3NjM0NQ==","avatar_url":"https://avatars.githubusercontent.com/u/876345?v=4","gravatar_id":"","url":"https://api.github.com/users/notr1ch","html_url":"https://github.com/notr1ch","followers_url":"https://api.github.com/users/notr1ch/followers","following_url":"https://api.github.com/users/notr1ch/following{/other_user}","gists_url":"https://api.github.com/users/notr1ch/gists{/gist_id}","starred_url":"https://api.github.com/users/notr1ch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/notr1ch/subscriptions","organizations_url":"https://api.github.com/users/notr1ch/orgs","repos_url":"https://api.github.com/users/notr1ch/repos","events_url":"https://api.github.com/users/notr1ch/events{/privacy}","received_events_url":"https://api.github.com/users/notr1ch/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/obsproject/obs-studio/issues/4885/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/obsproject/obs-studio/issues/4885/timeline","performed_via_github_app":null,"state_reason":"completed"}