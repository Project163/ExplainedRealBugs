diff --git a/src/EFCore.Design/Properties/DesignStrings.Designer.cs b/src/EFCore.Design/Properties/DesignStrings.Designer.cs
index f213b989dd..e245a42bcc 100644
--- a/src/EFCore.Design/Properties/DesignStrings.Designer.cs
+++ b/src/EFCore.Design/Properties/DesignStrings.Designer.cs
@@ -129,14 +129,6 @@ public static string CompiledModelCustomCacheKeyFactory(object? factoryType)
                 GetString("CompiledModelCustomCacheKeyFactory", nameof(factoryType)),
                 factoryType);
 
-        /// <summary>
-        ///     The entity type '{entityType}' has a defining query configured. Compiled model can't be generated, because defining queries are not supported.
-        /// </summary>
-        public static string CompiledModelDefiningQuery(object? entityType)
-            => string.Format(
-                GetString("CompiledModelDefiningQuery", nameof(entityType)),
-                entityType);
-
         /// <summary>
         ///     Successfully generated a compiled model, it will be discovered automatically, but you can also call '{optionsCall}'. Run this command again when the model is modified.
         /// </summary>
diff --git a/src/EFCore.Design/Properties/DesignStrings.resx b/src/EFCore.Design/Properties/DesignStrings.resx
index 1303c7e481..d050626661 100644
--- a/src/EFCore.Design/Properties/DesignStrings.resx
+++ b/src/EFCore.Design/Properties/DesignStrings.resx
@@ -162,9 +162,6 @@
   <data name="CompiledModelCustomCacheKeyFactory" xml:space="preserve">
     <value>The context is configured to use a custom model cache key factory '{factoryType}', this usually indicates that the produced model can change between context instances. To preserve this behavior manually modify the generated compiled model source code.</value>
   </data>
-  <data name="CompiledModelDefiningQuery" xml:space="preserve">
-    <value>The entity type '{entityType}' has a defining query configured. Compiled model can't be generated, because defining queries are not supported.</value>
-  </data>
   <data name="CompiledModelGenerated" xml:space="preserve">
     <value>Successfully generated a compiled model, it will be discovered automatically, but you can also call '{optionsCall}'. Run this command again when the model is modified.</value>
   </data>
diff --git a/src/EFCore.Design/Scaffolding/Internal/CSharpRuntimeModelCodeGenerator.cs b/src/EFCore.Design/Scaffolding/Internal/CSharpRuntimeModelCodeGenerator.cs
index ad23c6aaca..e18a43f317 100644
--- a/src/EFCore.Design/Scaffolding/Internal/CSharpRuntimeModelCodeGenerator.cs
+++ b/src/EFCore.Design/Scaffolding/Internal/CSharpRuntimeModelCodeGenerator.cs
@@ -898,14 +898,6 @@ private void Create(IEntityType entityType, CSharpRuntimeAnnotationCodeGenerator
             throw new InvalidOperationException(DesignStrings.CompiledModelQueryFilter(entityType.ShortName()));
         }
 
-#pragma warning disable CS0618 // Type or member is obsolete
-        if (entityType.GetDefiningQuery() != null)
-        {
-            // TODO: Move to InMemoryCSharpRuntimeAnnotationCodeGenerator, see #21624
-            throw new InvalidOperationException(DesignStrings.CompiledModelDefiningQuery(entityType.ShortName()));
-        }
-#pragma warning restore CS0618 // Type or member is obsolete
-
         AddNamespace(entityType.ClrType, parameters.Namespaces);
 
         var mainBuilder = parameters.MainBuilder;
diff --git a/src/EFCore.InMemory/Design/Internal/InMemoryCSharpRuntimeAnnotationCodeGenerator.cs b/src/EFCore.InMemory/Design/Internal/InMemoryCSharpRuntimeAnnotationCodeGenerator.cs
index a9c7e56e25..0ea2c29c5f 100644
--- a/src/EFCore.InMemory/Design/Internal/InMemoryCSharpRuntimeAnnotationCodeGenerator.cs
+++ b/src/EFCore.InMemory/Design/Internal/InMemoryCSharpRuntimeAnnotationCodeGenerator.cs
@@ -2,6 +2,7 @@
 // The .NET Foundation licenses this file to you under the MIT license.
 
 using Microsoft.EntityFrameworkCore.Design.Internal;
+using Microsoft.EntityFrameworkCore.InMemory.Internal;
 
 namespace Microsoft.EntityFrameworkCore.InMemory.Design.Internal;
 
@@ -25,4 +26,20 @@ public class InMemoryCSharpRuntimeAnnotationCodeGenerator : CSharpRuntimeAnnotat
         : base(dependencies)
     {
     }
+
+    /// <summary>
+    ///     This is an internal API that supports the Entity Framework Core infrastructure and not subject to
+    ///     the same compatibility standards as public APIs. It may be changed or removed without notice in
+    ///     any release. You should only use it directly in your code with extreme caution and knowing that
+    ///     doing so can result in application failures when updating to a new Entity Framework Core release.
+    /// </summary>
+    public override void Generate(IEntityType entityType, CSharpRuntimeAnnotationCodeGeneratorParameters parameters)
+    {
+        if (entityType.GetInMemoryQuery() != null)
+        {
+            throw new InvalidOperationException(InMemoryStrings.CompiledModelDefiningQuery(entityType.DisplayName()));
+        }
+
+        base.Generate(entityType, parameters);
+    }
 }
diff --git a/src/EFCore.InMemory/EFCore.InMemory.csproj b/src/EFCore.InMemory/EFCore.InMemory.csproj
index bf88275bc8..17c05bf18d 100644
--- a/src/EFCore.InMemory/EFCore.InMemory.csproj
+++ b/src/EFCore.InMemory/EFCore.InMemory.csproj
@@ -5,7 +5,7 @@
     <TargetFramework>$(DefaultNetCoreTargetFramework)</TargetFramework>
     <MinClientVersion>3.6</MinClientVersion>
     <AssemblyName>Microsoft.EntityFrameworkCore.InMemory</AssemblyName>
-    <RootNamespace>Microsoft.EntityFrameworkCore.InMemory</RootNamespace>
+    <RootNamespace>Microsoft.EntityFrameworkCore</RootNamespace>
     <GenerateDocumentationFile>true</GenerateDocumentationFile>
     <PackageTags>$(PackageTags);In-Memory</PackageTags>
     <ImplicitUsings>true</ImplicitUsings>
diff --git a/src/EFCore.InMemory/Extensions/InMemoryEntityTypeBuilderExtensions.cs b/src/EFCore.InMemory/Extensions/InMemoryEntityTypeBuilderExtensions.cs
index e0bc4d2856..9d7c8d9a93 100644
--- a/src/EFCore.InMemory/Extensions/InMemoryEntityTypeBuilderExtensions.cs
+++ b/src/EFCore.InMemory/Extensions/InMemoryEntityTypeBuilderExtensions.cs
@@ -101,9 +101,5 @@ public static class InMemoryEntityTypeBuilderExtensions
         this IConventionEntityTypeBuilder entityTypeBuilder,
         LambdaExpression? query,
         bool fromDataAnnotation = false)
-#pragma warning disable EF1001 // Internal EF Core API usage.
-#pragma warning disable CS0612 // Type or member is obsolete
-        => entityTypeBuilder.CanSetAnnotation(CoreAnnotationNames.DefiningQuery, query, fromDataAnnotation);
-#pragma warning restore CS0612 // Type or member is obsolete
-#pragma warning restore EF1001 // Internal EF Core API usage.
+        => entityTypeBuilder.CanSetAnnotation(InMemoryAnnotationNames.DefiningQuery, query, fromDataAnnotation);
 }
diff --git a/src/EFCore.InMemory/Extensions/InMemoryEntityTypeExtensions.cs b/src/EFCore.InMemory/Extensions/InMemoryEntityTypeExtensions.cs
index 5045a664b8..0c42dc1ffa 100644
--- a/src/EFCore.InMemory/Extensions/InMemoryEntityTypeExtensions.cs
+++ b/src/EFCore.InMemory/Extensions/InMemoryEntityTypeExtensions.cs
@@ -21,11 +21,7 @@ public static class InMemoryEntityTypeExtensions
     /// <param name="entityType">The entity type to get the in-memory query for.</param>
     /// <returns>The LINQ query used as the default source.</returns>
     public static LambdaExpression? GetInMemoryQuery(this IReadOnlyEntityType entityType)
-#pragma warning disable EF1001 // Internal EF Core API usage.
-#pragma warning disable CS0612 // Type or member is obsolete
-        => (LambdaExpression?)entityType[CoreAnnotationNames.DefiningQuery];
-#pragma warning restore CS0612 // Type or member is obsolete
-#pragma warning restore EF1001 // Internal EF Core API usage.
+        => (LambdaExpression?)entityType[InMemoryAnnotationNames.DefiningQuery];
 
     /// <summary>
     ///     Sets the LINQ query used as the default source for queries of this type.
@@ -36,11 +32,7 @@ public static class InMemoryEntityTypeExtensions
         this IMutableEntityType entityType,
         LambdaExpression? inMemoryQuery)
         => entityType
-#pragma warning disable EF1001 // Internal EF Core API usage.
-#pragma warning disable CS0612 // Type or member is obsolete
-            .SetOrRemoveAnnotation(CoreAnnotationNames.DefiningQuery, inMemoryQuery);
-#pragma warning restore CS0612 // Type or member is obsolete
-#pragma warning restore EF1001 // Internal EF Core API usage.
+            .SetOrRemoveAnnotation(InMemoryAnnotationNames.DefiningQuery, inMemoryQuery);
 
     /// <summary>
     ///     Sets the LINQ query used as the default source for queries of this type.
@@ -54,11 +46,7 @@ public static class InMemoryEntityTypeExtensions
         LambdaExpression? inMemoryQuery,
         bool fromDataAnnotation = false)
         => (LambdaExpression?)entityType
-#pragma warning disable EF1001 // Internal EF Core API usage.
-#pragma warning disable CS0612 // Type or member is obsolete
-            .SetOrRemoveAnnotation(CoreAnnotationNames.DefiningQuery, inMemoryQuery, fromDataAnnotation)
-#pragma warning restore CS0612 // Type or member is obsolete
-#pragma warning restore EF1001 // Internal EF Core API usage.
+            .SetOrRemoveAnnotation(InMemoryAnnotationNames.DefiningQuery, inMemoryQuery, fromDataAnnotation)
             ?.Value;
 
     /// <summary>
@@ -66,10 +54,6 @@ public static class InMemoryEntityTypeExtensions
     /// </summary>
     /// <param name="entityType">The entity type.</param>
     /// <returns>The configuration source for <see cref="GetInMemoryQuery" />.</returns>
-    public static ConfigurationSource? GetDefiningQueryConfigurationSource(this IConventionEntityType entityType)
-#pragma warning disable EF1001 // Internal EF Core API usage.
-#pragma warning disable CS0612 // Type or member is obsolete
-        => entityType.FindAnnotation(CoreAnnotationNames.DefiningQuery)?.GetConfigurationSource();
-#pragma warning restore CS0612 // Type or member is obsolete
-#pragma warning restore EF1001 // Internal EF Core API usage.
+    public static ConfigurationSource? GetInMemoryQueryConfigurationSource(this IConventionEntityType entityType)
+        => entityType.FindAnnotation(InMemoryAnnotationNames.DefiningQuery)?.GetConfigurationSource();
 }
diff --git a/src/EFCore.InMemory/Extensions/InMemoryServiceCollectionExtensions.cs b/src/EFCore.InMemory/Extensions/InMemoryServiceCollectionExtensions.cs
index 6b8d1c64e4..d3d50a93eb 100644
--- a/src/EFCore.InMemory/Extensions/InMemoryServiceCollectionExtensions.cs
+++ b/src/EFCore.InMemory/Extensions/InMemoryServiceCollectionExtensions.cs
@@ -4,7 +4,6 @@
 using System.ComponentModel;
 using Microsoft.EntityFrameworkCore.InMemory.Diagnostics.Internal;
 using Microsoft.EntityFrameworkCore.InMemory.Infrastructure.Internal;
-using Microsoft.EntityFrameworkCore.InMemory.Metadata.Conventions;
 using Microsoft.EntityFrameworkCore.InMemory.Query.Internal;
 using Microsoft.EntityFrameworkCore.InMemory.Storage.Internal;
 using Microsoft.EntityFrameworkCore.InMemory.ValueGeneration.Internal;
diff --git a/src/EFCore.InMemory/Metadata/Conventions/InMemoryConventionSetBuilder.cs b/src/EFCore.InMemory/Metadata/Conventions/InMemoryConventionSetBuilder.cs
index 0f13f38176..7bfad928af 100644
--- a/src/EFCore.InMemory/Metadata/Conventions/InMemoryConventionSetBuilder.cs
+++ b/src/EFCore.InMemory/Metadata/Conventions/InMemoryConventionSetBuilder.cs
@@ -1,7 +1,7 @@
 // Licensed to the .NET Foundation under one or more agreements.
 // The .NET Foundation licenses this file to you under the MIT license.
 
-namespace Microsoft.EntityFrameworkCore.InMemory.Metadata.Conventions;
+namespace Microsoft.EntityFrameworkCore.Metadata.Conventions;
 
 /// <summary>
 ///     A builder for building conventions for th in-memory provider.
diff --git a/src/EFCore.InMemory/Metadata/Internal/CosmosAnnotationNames.cs b/src/EFCore.InMemory/Metadata/Internal/CosmosAnnotationNames.cs
new file mode 100644
index 0000000000..ce1a599dfd
--- /dev/null
+++ b/src/EFCore.InMemory/Metadata/Internal/CosmosAnnotationNames.cs
@@ -0,0 +1,29 @@
+// Licensed to the .NET Foundation under one or more agreements.
+// The .NET Foundation licenses this file to you under the MIT license.
+
+namespace Microsoft.EntityFrameworkCore.Metadata.Internal;
+
+/// <summary>
+///     This is an internal API that supports the Entity Framework Core infrastructure and not subject to
+///     the same compatibility standards as public APIs. It may be changed or removed without notice in
+///     any release. You should only use it directly in your code with extreme caution and knowing that
+///     doing so can result in application failures when updating to a new Entity Framework Core release.
+/// </summary>
+public static class InMemoryAnnotationNames
+{
+    /// <summary>
+    ///     This is an internal API that supports the Entity Framework Core infrastructure and not subject to
+    ///     the same compatibility standards as public APIs. It may be changed or removed without notice in
+    ///     any release. You should only use it directly in your code with extreme caution and knowing that
+    ///     doing so can result in application failures when updating to a new Entity Framework Core release.
+    /// </summary>
+    public const string Prefix = "InMemory:";
+
+    /// <summary>
+    ///     This is an internal API that supports the Entity Framework Core infrastructure and not subject to
+    ///     the same compatibility standards as public APIs. It may be changed or removed without notice in
+    ///     any release. You should only use it directly in your code with extreme caution and knowing that
+    ///     doing so can result in application failures when updating to a new Entity Framework Core release.
+    /// </summary>
+    public const string DefiningQuery = Prefix + "DefiningQuery";
+}
diff --git a/src/EFCore.InMemory/Properties/InMemoryStrings.Designer.cs b/src/EFCore.InMemory/Properties/InMemoryStrings.Designer.cs
index 83f0de0246..4076751e73 100644
--- a/src/EFCore.InMemory/Properties/InMemoryStrings.Designer.cs
+++ b/src/EFCore.InMemory/Properties/InMemoryStrings.Designer.cs
@@ -21,7 +21,15 @@ namespace Microsoft.EntityFrameworkCore.InMemory.Internal
     public static class InMemoryStrings
     {
         private static readonly ResourceManager _resourceManager
-            = new ResourceManager("Microsoft.EntityFrameworkCore.InMemory.Properties.InMemoryStrings", typeof(InMemoryStrings).Assembly);
+            = new ResourceManager("Microsoft.EntityFrameworkCore.Properties.InMemoryStrings", typeof(InMemoryStrings).Assembly);
+
+        /// <summary>
+        ///     The entity type '{entityType}' has a defining query configured. Compiled model can't be generated, because defining queries are not supported.
+        /// </summary>
+        public static string CompiledModelDefiningQuery(object? entityType)
+            => string.Format(
+                GetString("CompiledModelDefiningQuery", nameof(entityType)),
+                entityType);
 
         /// <summary>
         ///     Cannot apply 'DefaultIfEmpty' after a client-evaluated projection. Consider applying 'DefaultIfEmpty' before last 'Select' or use 'AsEnumerable' before 'DefaultIfEmpty' to apply it on client-side.
@@ -131,7 +139,7 @@ namespace Microsoft.EntityFrameworkCore.InMemory.Internal
     public static class InMemoryResources
     {
         private static readonly ResourceManager _resourceManager
-            = new ResourceManager("Microsoft.EntityFrameworkCore.InMemory.Properties.InMemoryStrings", typeof(InMemoryResources).Assembly);
+            = new ResourceManager("Microsoft.EntityFrameworkCore.Properties.InMemoryStrings", typeof(InMemoryResources).Assembly);
 
         /// <summary>
         ///     Saved {count} entities to in-memory store.
diff --git a/src/EFCore.InMemory/Properties/InMemoryStrings.Designer.tt b/src/EFCore.InMemory/Properties/InMemoryStrings.Designer.tt
index 8f9f997c86..349c4ed04e 100644
--- a/src/EFCore.InMemory/Properties/InMemoryStrings.Designer.tt
+++ b/src/EFCore.InMemory/Properties/InMemoryStrings.Designer.tt
@@ -1,7 +1,7 @@
 <#
     Session = new System.Collections.Generic.Dictionary<string, object>();
     Session["ResourceFile"] = "InMemoryStrings.resx";
-    Session["ResourceNamespace"] = "Microsoft.EntityFrameworkCore.InMemory.Properties";
+    Session["ResourceNamespace"] = "Microsoft.EntityFrameworkCore.Properties";
     Session["LoggingDefinitionsClass"] = "Diagnostics.Internal.InMemoryLoggingDefinitions";
 #>
 <#@ include file="..\..\..\tools\Resources.tt" #>
\ No newline at end of file
diff --git a/src/EFCore.InMemory/Properties/InMemoryStrings.resx b/src/EFCore.InMemory/Properties/InMemoryStrings.resx
index 93e3f5cfd5..ed8494a350 100644
--- a/src/EFCore.InMemory/Properties/InMemoryStrings.resx
+++ b/src/EFCore.InMemory/Properties/InMemoryStrings.resx
@@ -117,6 +117,9 @@
   <resheader name="writer">
     <value>System.Resources.ResXResourceWriter, System.Windows.Forms, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089</value>
   </resheader>
+  <data name="CompiledModelDefiningQuery" xml:space="preserve">
+    <value>The entity type '{entityType}' has a defining query configured. Compiled model can't be generated, because defining queries are not supported.</value>
+  </data>
   <data name="DefaultIfEmptyAppliedAfterProjection" xml:space="preserve">
     <value>Cannot apply 'DefaultIfEmpty' after a client-evaluated projection. Consider applying 'DefaultIfEmpty' before last 'Select' or use 'AsEnumerable' before 'DefaultIfEmpty' to apply it on client-side.</value>
   </data>
diff --git a/src/EFCore.Relational/Extensions/RelationalEntityTypeExtensions.cs b/src/EFCore.Relational/Extensions/RelationalEntityTypeExtensions.cs
index 517205fb73..2e0a92fb07 100644
--- a/src/EFCore.Relational/Extensions/RelationalEntityTypeExtensions.cs
+++ b/src/EFCore.Relational/Extensions/RelationalEntityTypeExtensions.cs
@@ -39,9 +39,6 @@ public static class RelationalEntityTypeExtensions
 
         return ((entityType as IConventionEntityType)?.GetViewNameConfigurationSource() == null)
             && (entityType as IConventionEntityType)?.GetFunctionNameConfigurationSource() == null
-#pragma warning disable CS0618 // Type or member is obsolete
-            && (entityType as IConventionEntityType)?.GetDefiningQueryConfigurationSource() == null
-#pragma warning restore CS0618 // Type or member is obsolete
             && (entityType as IConventionEntityType)?.GetSqlQueryConfigurationSource() == null
                 ? GetDefaultTableName(entityType)
                 : null;
@@ -267,9 +264,6 @@ public static void SetSchema(this IMutableEntityType entityType, string? value)
         }
 
         return ((entityType as IConventionEntityType)?.GetFunctionNameConfigurationSource() == null)
-#pragma warning disable CS0618 // Type or member is obsolete
-            && ((entityType as IConventionEntityType)?.GetDefiningQueryConfigurationSource() == null)
-#pragma warning restore CS0618 // Type or member is obsolete
             && ((entityType as IConventionEntityType)?.GetSqlQueryConfigurationSource() == null)
                 ? GetDefaultViewName(entityType)
                 : null;
diff --git a/src/EFCore.Relational/Metadata/Conventions/RelationalQueryFilterRewritingConvention.cs b/src/EFCore.Relational/Metadata/Conventions/RelationalQueryFilterRewritingConvention.cs
index 8453e44137..1cb87baf3c 100644
--- a/src/EFCore.Relational/Metadata/Conventions/RelationalQueryFilterRewritingConvention.cs
+++ b/src/EFCore.Relational/Metadata/Conventions/RelationalQueryFilterRewritingConvention.cs
@@ -39,14 +39,6 @@ public class RelationalQueryFilterRewritingConvention : QueryFilterRewritingConv
             {
                 entityType.SetQueryFilter((LambdaExpression)DbSetAccessRewriter.Rewrite(modelBuilder.Metadata, queryFilter));
             }
-
-#pragma warning disable CS0618 // Type or member is obsolete
-            var definingQuery = ((IEntityType)entityType).GetDefiningQuery();
-            if (definingQuery != null)
-            {
-                entityType.SetDefiningQuery((LambdaExpression)DbSetAccessRewriter.Rewrite(modelBuilder.Metadata, definingQuery));
-            }
-#pragma warning restore CS0618 // Type or member is obsolete
         }
     }
 
diff --git a/src/EFCore/Extensions/ConventionEntityTypeExtensions.cs b/src/EFCore/Extensions/ConventionEntityTypeExtensions.cs
deleted file mode 100644
index e6b66ad06b..0000000000
--- a/src/EFCore/Extensions/ConventionEntityTypeExtensions.cs
+++ /dev/null
@@ -1,38 +0,0 @@
-// Licensed to the .NET Foundation under one or more agreements.
-// The .NET Foundation licenses this file to you under the MIT license.
-
-using Microsoft.EntityFrameworkCore.Metadata.Internal;
-
-// ReSharper disable once CheckNamespace
-namespace Microsoft.EntityFrameworkCore;
-
-/// <summary>
-///     Extension methods for <see cref="IConventionEntityType" />.
-/// </summary>
-[Obsolete("Use IConventionEntityType")] // Delete with defining query
-public static class ConventionEntityTypeExtensions
-{
-    /// <summary>
-    ///     Sets the LINQ query used as the default source for queries of this type.
-    /// </summary>
-    /// <param name="entityType">The entity type.</param>
-    /// <param name="definingQuery">The LINQ query used as the default source.</param>
-    /// <param name="fromDataAnnotation">Indicates whether the configuration was specified using a data annotation.</param>
-    [Obsolete("Use InMemoryEntityTypeExtensions.SetInMemoryQuery")]
-    public static void SetDefiningQuery(
-        this IConventionEntityType entityType,
-        LambdaExpression? definingQuery,
-        bool fromDataAnnotation = false)
-        => ((EntityType)entityType).SetDefiningQuery(
-            definingQuery,
-            fromDataAnnotation ? ConfigurationSource.DataAnnotation : ConfigurationSource.Convention);
-
-    /// <summary>
-    ///     Returns the configuration source for <see cref="EntityTypeExtensions.GetDefiningQuery" />.
-    /// </summary>
-    /// <param name="entityType">The entity type.</param>
-    /// <returns>The configuration source for <see cref="EntityTypeExtensions.GetDefiningQuery" />.</returns>
-    [Obsolete("Use InMemoryEntityTypeExtensions.GetInMemoryQueryConfigurationSource")]
-    public static ConfigurationSource? GetDefiningQueryConfigurationSource(this IConventionEntityType entityType)
-        => entityType.FindAnnotation(CoreAnnotationNames.DefiningQuery)?.GetConfigurationSource();
-}
diff --git a/src/EFCore/Extensions/EntityTypeExtensions.cs b/src/EFCore/Extensions/EntityTypeExtensions.cs
deleted file mode 100644
index b99fbb127c..0000000000
--- a/src/EFCore/Extensions/EntityTypeExtensions.cs
+++ /dev/null
@@ -1,23 +0,0 @@
-// Licensed to the .NET Foundation under one or more agreements.
-// The .NET Foundation licenses this file to you under the MIT license.
-
-using Microsoft.EntityFrameworkCore.Metadata.Internal;
-
-// ReSharper disable once CheckNamespace
-namespace Microsoft.EntityFrameworkCore;
-
-/// <summary>
-///     Entity type extension methods for <see cref="IReadOnlyEntityType" />.
-/// </summary>
-[Obsolete("Use IReadOnlyEntityType")] // Delete with defining query
-public static class EntityTypeExtensions
-{
-    /// <summary>
-    ///     Gets the LINQ query used as the default source for queries of this type.
-    /// </summary>
-    /// <param name="entityType">The entity type to get the defining query for.</param>
-    /// <returns>The LINQ query used as the default source.</returns>
-    [Obsolete("Use InMemoryEntityTypeExtensions.GetInMemoryQuery")]
-    public static LambdaExpression? GetDefiningQuery(this IEntityType entityType)
-        => (LambdaExpression?)entityType[CoreAnnotationNames.DefiningQuery];
-}
diff --git a/src/EFCore/Extensions/MutableEntityTypeExtensions.cs b/src/EFCore/Extensions/MutableEntityTypeExtensions.cs
deleted file mode 100644
index 395b1aa72e..0000000000
--- a/src/EFCore/Extensions/MutableEntityTypeExtensions.cs
+++ /dev/null
@@ -1,25 +0,0 @@
-// Licensed to the .NET Foundation under one or more agreements.
-// The .NET Foundation licenses this file to you under the MIT license.
-
-using Microsoft.EntityFrameworkCore.Metadata.Internal;
-
-// ReSharper disable once CheckNamespace
-namespace Microsoft.EntityFrameworkCore;
-
-/// <summary>
-///     Extension methods for <see cref="IMutableEntityType" />.
-/// </summary>
-[Obsolete("Use IMutableEntityType")] // Delete with defining query
-public static class MutableEntityTypeExtensions
-{
-    /// <summary>
-    ///     Sets the LINQ query used as the default source for queries of this type.
-    /// </summary>
-    /// <param name="entityType">The entity type.</param>
-    /// <param name="definingQuery">The LINQ query used as the default source.</param>
-    [Obsolete("Use InMemoryEntityTypeExtensions.SetInMemoryQuery")]
-    public static void SetDefiningQuery(
-        this IMutableEntityType entityType,
-        LambdaExpression? definingQuery)
-        => ((EntityType)entityType).SetDefiningQuery(definingQuery, ConfigurationSource.Explicit);
-}
diff --git a/src/EFCore/Metadata/Builders/EntityTypeBuilder`.cs b/src/EFCore/Metadata/Builders/EntityTypeBuilder`.cs
index 3cee16b13e..b84fb98a56 100644
--- a/src/EFCore/Metadata/Builders/EntityTypeBuilder`.cs
+++ b/src/EFCore/Metadata/Builders/EntityTypeBuilder`.cs
@@ -425,21 +425,6 @@ public new virtual EntityTypeBuilder<TEntity> HasQueryFilter(LambdaExpression? f
     public virtual EntityTypeBuilder<TEntity> HasQueryFilter(Expression<Func<TEntity, bool>>? filter)
         => (EntityTypeBuilder<TEntity>)base.HasQueryFilter(filter);
 
-    /// <summary>
-    ///     Configures a query used to provide data for a keyless entity type.
-    /// </summary>
-    /// <param name="query">The query that will provide the underlying data for the keyless entity type.</param>
-    /// <returns>The same builder instance so that multiple calls can be chained.</returns>
-    [Obsolete("Use InMemoryEntityTypeBuilderExtensions.ToInMemoryQuery")]
-    public virtual EntityTypeBuilder<TEntity> ToQuery(Expression<Func<IQueryable<TEntity>>> query)
-    {
-        Check.NotNull(query, nameof(query));
-
-        Builder.HasDefiningQuery(query, ConfigurationSource.Explicit);
-
-        return this;
-    }
-
     /// <summary>
     ///     Configures an unnamed index on the specified properties.
     ///     If there is an existing index on the given list of properties,
diff --git a/src/EFCore/Metadata/Builders/IConventionEntityTypeBuilder.cs b/src/EFCore/Metadata/Builders/IConventionEntityTypeBuilder.cs
index 3ae88c32f9..e701491948 100644
--- a/src/EFCore/Metadata/Builders/IConventionEntityTypeBuilder.cs
+++ b/src/EFCore/Metadata/Builders/IConventionEntityTypeBuilder.cs
@@ -878,26 +878,6 @@ bool CanHaveSkipNavigation(MemberInfo navigation, bool fromDataAnnotation = fals
     /// <returns><see langword="true" /> if the given query filter can be set.</returns>
     bool CanSetQueryFilter(LambdaExpression? filter, bool fromDataAnnotation = false);
 
-    /// <summary>
-    ///     Configures a query used to provide data for a keyless entity type.
-    /// </summary>
-    /// <param name="query">The query that will provide the underlying data for the keyless entity type.</param>
-    /// <param name="fromDataAnnotation">Indicates whether the configuration was specified using a data annotation.</param>
-    /// <returns>
-    ///     The same builder instance if the query was set, <see langword="null" /> otherwise.
-    /// </returns>
-    [Obsolete("Use InMemoryEntityTypeBuilderExtensions.ToInMemoryQuery")]
-    IConventionEntityTypeBuilder? HasDefiningQuery(LambdaExpression? query, bool fromDataAnnotation = false);
-
-    /// <summary>
-    ///     Returns a value indicating whether the given defining query can be set from the current configuration source.
-    /// </summary>
-    /// <param name="query">The query that will provide the underlying data for the keyless entity type.</param>
-    /// <param name="fromDataAnnotation">Indicates whether the configuration was specified using a data annotation.</param>
-    /// <returns><see langword="true" /> if the given defining query can be set.</returns>
-    [Obsolete("Use InMemoryEntityTypeBuilderExtensions.CanSetInMemoryQuery")]
-    bool CanSetDefiningQuery(LambdaExpression? query, bool fromDataAnnotation = false);
-
     /// <summary>
     ///     Configures the <see cref="ChangeTrackingStrategy" /> to be used for this entity type.
     ///     This strategy indicates how the context detects changes to properties for an instance of the entity type.
diff --git a/src/EFCore/Metadata/Conventions/RuntimeModelConvention.cs b/src/EFCore/Metadata/Conventions/RuntimeModelConvention.cs
index ff39b266bf..e3684e0b68 100644
--- a/src/EFCore/Metadata/Conventions/RuntimeModelConvention.cs
+++ b/src/EFCore/Metadata/Conventions/RuntimeModelConvention.cs
@@ -293,9 +293,6 @@ private static ParameterBinding Create(ParameterBinding parameterBinding, Runtim
             {
                 if (CoreAnnotationNames.AllNames.Contains(key)
                     && key != CoreAnnotationNames.QueryFilter
-#pragma warning disable CS0612 // Type or member is obsolete
-                    && key != CoreAnnotationNames.DefiningQuery
-#pragma warning restore CS0612 // Type or member is obsolete
                     && key != CoreAnnotationNames.DiscriminatorMappingComplete)
                 {
                     annotations.Remove(key);
@@ -307,14 +304,6 @@ private static ParameterBinding Create(ParameterBinding parameterBinding, Runtim
                 annotations[CoreAnnotationNames.QueryFilter] =
                     new QueryRootRewritingExpressionVisitor(runtimeEntityType.Model).Rewrite((Expression)queryFilter!);
             }
-
-#pragma warning disable CS0612 // Type or member is obsolete
-            if (annotations.TryGetValue(CoreAnnotationNames.DefiningQuery, out var definingQuery))
-            {
-                annotations[CoreAnnotationNames.DefiningQuery] =
-#pragma warning restore CS0612 // Type or member is obsolete
-                    new QueryRootRewritingExpressionVisitor(runtimeEntityType.Model).Rewrite((Expression)definingQuery!);
-            }
         }
     }
 
diff --git a/src/EFCore/Metadata/IConventionModel.cs b/src/EFCore/Metadata/IConventionModel.cs
index c31023226d..6a149ee47c 100644
--- a/src/EFCore/Metadata/IConventionModel.cs
+++ b/src/EFCore/Metadata/IConventionModel.cs
@@ -133,6 +133,7 @@ public interface IConventionModel : IReadOnlyModel, IConventionAnnotatable
     /// <param name="definingEntityType">The defining entity type.</param>
     /// <param name="fromDataAnnotation">Indicates whether the configuration was specified using a data annotation.</param>
     /// <returns>The new entity type.</returns>
+    [Obsolete]
     IConventionEntityType? AddEntityType(
         string name,
         string definingNavigationName,
@@ -147,6 +148,7 @@ public interface IConventionModel : IReadOnlyModel, IConventionAnnotatable
     /// <param name="definingEntityType">The defining entity type.</param>
     /// <param name="fromDataAnnotation">Indicates whether the configuration was specified using a data annotation.</param>
     /// <returns>The new entity type.</returns>
+    [Obsolete]
     IConventionEntityType? AddEntityType(
         [DynamicallyAccessedMembers(IEntityType.DynamicallyAccessedMemberTypes)] Type type,
         string definingNavigationName,
diff --git a/src/EFCore/Metadata/Internal/CoreAnnotationNames.cs b/src/EFCore/Metadata/Internal/CoreAnnotationNames.cs
index cb6e7a32c6..1246a35180 100644
--- a/src/EFCore/Metadata/Internal/CoreAnnotationNames.cs
+++ b/src/EFCore/Metadata/Internal/CoreAnnotationNames.cs
@@ -195,15 +195,6 @@ public static class CoreAnnotationNames
     /// </summary>
     public const string QueryFilter = "QueryFilter";
 
-    /// <summary>
-    ///     This is an internal API that supports the Entity Framework Core infrastructure and not subject to
-    ///     the same compatibility standards as public APIs. It may be changed or removed without notice in
-    ///     any release. You should only use it directly in your code with extreme caution and knowing that
-    ///     doing so can result in application failures when updating to a new Entity Framework Core release.
-    /// </summary>
-    [Obsolete] // Remove with defining query
-    public const string DefiningQuery = "DefiningQuery";
-
     /// <summary>
     ///     This is an internal API that supports the Entity Framework Core infrastructure and not subject to
     ///     the same compatibility standards as public APIs. It may be changed or removed without notice in
@@ -411,9 +402,6 @@ public static class CoreAnnotationNames
         AfterSaveBehavior,
         BeforeSaveBehavior,
         QueryFilter,
-#pragma warning disable CS0612 // Type or member is obsolete
-        DefiningQuery,
-#pragma warning restore CS0612 // Type or member is obsolete
         EagerLoaded,
         LazyLoadingEnabled,
         ProviderClrType,
diff --git a/src/EFCore/Metadata/Internal/EntityType.cs b/src/EFCore/Metadata/Internal/EntityType.cs
index a0133ed02b..79cf4767af 100644
--- a/src/EFCore/Metadata/Internal/EntityType.cs
+++ b/src/EFCore/Metadata/Internal/EntityType.cs
@@ -2918,16 +2918,6 @@ public virtual PropertyAccessMode GetNavigationAccessMode()
     public virtual ConfigurationSource? GetQueryFilterConfigurationSource()
         => FindAnnotation(CoreAnnotationNames.QueryFilter)?.GetConfigurationSource();
 
-    /// <summary>
-    ///     This is an internal API that supports the Entity Framework Core infrastructure and not subject to
-    ///     the same compatibility standards as public APIs. It may be changed or removed without notice in
-    ///     any release. You should only use it directly in your code with extreme caution and knowing that
-    ///     doing so can result in application failures when updating to a new Entity Framework Core release.
-    /// </summary>
-    [Obsolete]
-    public virtual LambdaExpression? SetDefiningQuery(LambdaExpression? definingQuery, ConfigurationSource configurationSource)
-        => (LambdaExpression?)SetOrRemoveAnnotation(CoreAnnotationNames.DefiningQuery, definingQuery, configurationSource)?.Value;
-
     /// <summary>
     ///     This is an internal API that supports the Entity Framework Core infrastructure and not subject to
     ///     the same compatibility standards as public APIs. It may be changed or removed without notice in
diff --git a/src/EFCore/Metadata/Internal/InternalEntityTypeBuilder.cs b/src/EFCore/Metadata/Internal/InternalEntityTypeBuilder.cs
index 7f04bcd9f9..39f503cab8 100644
--- a/src/EFCore/Metadata/Internal/InternalEntityTypeBuilder.cs
+++ b/src/EFCore/Metadata/Internal/InternalEntityTypeBuilder.cs
@@ -1322,38 +1322,6 @@ public virtual bool CanSetQueryFilter(LambdaExpression? filter, ConfigurationSou
         => configurationSource.Overrides(Metadata.GetQueryFilterConfigurationSource())
             || Metadata.GetQueryFilter() == filter;
 
-    /// <summary>
-    ///     This is an internal API that supports the Entity Framework Core infrastructure and not subject to
-    ///     the same compatibility standards as public APIs. It may be changed or removed without notice in
-    ///     any release. You should only use it directly in your code with extreme caution and knowing that
-    ///     doing so can result in application failures when updating to a new Entity Framework Core release.
-    /// </summary>
-    [Obsolete]
-    public virtual InternalEntityTypeBuilder? HasDefiningQuery(
-        LambdaExpression? query,
-        ConfigurationSource configurationSource)
-    {
-        if (CanSetDefiningQuery(query, configurationSource))
-        {
-            Metadata.SetDefiningQuery(query, configurationSource);
-
-            return this;
-        }
-
-        return null;
-    }
-
-    /// <summary>
-    ///     This is an internal API that supports the Entity Framework Core infrastructure and not subject to
-    ///     the same compatibility standards as public APIs. It may be changed or removed without notice in
-    ///     any release. You should only use it directly in your code with extreme caution and knowing that
-    ///     doing so can result in application failures when updating to a new Entity Framework Core release.
-    /// </summary>
-    [Obsolete]
-    public virtual bool CanSetDefiningQuery(LambdaExpression? query, ConfigurationSource configurationSource)
-        => configurationSource.Overrides(Metadata.GetDefiningQueryConfigurationSource())
-            || Metadata.GetDefiningQuery() == query;
-
     /// <summary>
     ///     This is an internal API that supports the Entity Framework Core infrastructure and not subject to
     ///     the same compatibility standards as public APIs. It may be changed or removed without notice in
@@ -5318,28 +5286,6 @@ bool IConventionEntityTypeBuilder.CanHaveTrigger(string modelName, bool fromData
     bool IConventionEntityTypeBuilder.CanSetQueryFilter(LambdaExpression? filter, bool fromDataAnnotation)
         => CanSetQueryFilter(filter, fromDataAnnotation ? ConfigurationSource.DataAnnotation : ConfigurationSource.Convention);
 
-    /// <summary>
-    ///     This is an internal API that supports the Entity Framework Core infrastructure and not subject to
-    ///     the same compatibility standards as public APIs. It may be changed or removed without notice in
-    ///     any release. You should only use it directly in your code with extreme caution and knowing that
-    ///     doing so can result in application failures when updating to a new Entity Framework Core release.
-    /// </summary>
-    [DebuggerStepThrough]
-    [Obsolete]
-    IConventionEntityTypeBuilder? IConventionEntityTypeBuilder.HasDefiningQuery(LambdaExpression? query, bool fromDataAnnotation)
-        => HasDefiningQuery(query, fromDataAnnotation ? ConfigurationSource.DataAnnotation : ConfigurationSource.Convention);
-
-    /// <summary>
-    ///     This is an internal API that supports the Entity Framework Core infrastructure and not subject to
-    ///     the same compatibility standards as public APIs. It may be changed or removed without notice in
-    ///     any release. You should only use it directly in your code with extreme caution and knowing that
-    ///     doing so can result in application failures when updating to a new Entity Framework Core release.
-    /// </summary>
-    [DebuggerStepThrough]
-    [Obsolete]
-    bool IConventionEntityTypeBuilder.CanSetDefiningQuery(LambdaExpression? query, bool fromDataAnnotation)
-        => CanSetDefiningQuery(query, fromDataAnnotation ? ConfigurationSource.DataAnnotation : ConfigurationSource.Convention);
-
     /// <summary>
     ///     This is an internal API that supports the Entity Framework Core infrastructure and not subject to
     ///     the same compatibility standards as public APIs. It may be changed or removed without notice in
diff --git a/src/EFCore/Query/Internal/NavigationExpandingExpressionVisitor.cs b/src/EFCore/Query/Internal/NavigationExpandingExpressionVisitor.cs
index 0c4d3874bf..5752032680 100644
--- a/src/EFCore/Query/Internal/NavigationExpandingExpressionVisitor.cs
+++ b/src/EFCore/Query/Internal/NavigationExpandingExpressionVisitor.cs
@@ -200,9 +200,8 @@ protected override Expression VisitExtension(Expression extensionExpression)
         {
             case EntityQueryRootExpression entityQueryRootExpression:
                 var entityType = entityQueryRootExpression.EntityType;
-#pragma warning disable CS0618 // Type or member is obsolete
-                var definingQuery = entityType.GetDefiningQuery();
-#pragma warning restore CS0618 // Type or member is obsolete
+                // TODO: Move to InMemory #21624
+                var definingQuery = (LambdaExpression?)entityType["InMemory:DefiningQuery"];
                 NavigationExpansionExpression navigationExpansionExpression;
                 if (definingQuery != null
                     // Apply defining query only when it is not custom query root
@@ -1120,15 +1119,14 @@ private NavigationExpansionExpression ProcessDistinct(NavigationExpansionExpress
     {
         if (source.PendingSelector is NavigationTreeExpression { Value: EntityReference entityReference })
         {
-#pragma warning disable CS0618 // Type or member is obsolete
-            if (entityReference.EntityType.GetDefiningQuery() != null)
+            // TODO: Move to InMemory #21624
+            if (entityReference.EntityType["InMemory:DefiningQuery"] != null)
             {
                 throw new InvalidOperationException(
 #pragma warning disable CS0612 // Type or member is obsolete
                     CoreStrings.IncludeOnEntityWithDefiningQueryNotSupported(expression, entityReference.EntityType.DisplayName()));
 #pragma warning restore CS0612 // Type or member is obsolete
             }
-#pragma warning restore CS0618 // Type or member is obsolete
 
             if (expression is ConstantExpression { Value: string navigationChain })
             {
diff --git a/test/EFCore.Design.Tests/Migrations/Design/CSharpMigrationsGeneratorTest.cs b/test/EFCore.Design.Tests/Migrations/Design/CSharpMigrationsGeneratorTest.cs
index 033af3a37f..501d53b230 100644
--- a/test/EFCore.Design.Tests/Migrations/Design/CSharpMigrationsGeneratorTest.cs
+++ b/test/EFCore.Design.Tests/Migrations/Design/CSharpMigrationsGeneratorTest.cs
@@ -150,12 +150,6 @@ public void Test_new_annotations_handled_for_entity_types()
                     + "    })")
             },
             {
-#pragma warning disable CS0612 // Type or member is obsolete
-                CoreAnnotationNames.DefiningQuery,
-#pragma warning restore CS0612 // Type or member is obsolete
-                (Expression.Lambda(Expression.Constant(null)), _toNullTable)
-            },
-            {
                 RelationalAnnotationNames.ViewName, ("MyView", _toNullTable
                     + ";"
                     + _nl
@@ -202,9 +196,6 @@ public void Test_new_annotations_handled_for_properties()
             CoreAnnotationNames.EagerLoaded,
             CoreAnnotationNames.LazyLoadingEnabled,
             CoreAnnotationNames.QueryFilter,
-#pragma warning disable CS0612 // Type or member is obsolete
-            CoreAnnotationNames.DefiningQuery,
-#pragma warning restore CS0612 // Type or member is obsolete
             CoreAnnotationNames.DiscriminatorProperty,
             CoreAnnotationNames.DiscriminatorValue,
             CoreAnnotationNames.InverseNavigations,
diff --git a/test/EFCore.InMemory.FunctionalTests/Query/AdHocQueryFiltersQueryInMemoryTest.cs b/test/EFCore.InMemory.FunctionalTests/Query/AdHocQueryFiltersQueryInMemoryTest.cs
index 92f3fd6e22..538d96349b 100644
--- a/test/EFCore.InMemory.FunctionalTests/Query/AdHocQueryFiltersQueryInMemoryTest.cs
+++ b/test/EFCore.InMemory.FunctionalTests/Query/AdHocQueryFiltersQueryInMemoryTest.cs
@@ -5,6 +5,130 @@ namespace Microsoft.EntityFrameworkCore.Query;
 
 public class AdHocQueryFiltersQueryInMemoryTest(NonSharedFixture fixture) : AdHocQueryFiltersQueryTestBase(fixture)
 {
+    #region 19708
+
+    [ConditionalFact]
+    public virtual async Task GroupJoin_SelectMany_gets_flattened()
+    {
+        var contextFactory = await InitializeAsync<Context19708>(seed: c => c.SeedAsync());
+        using (var context = contextFactory.CreateContext())
+        {
+            var query = context.CustomerFilters.ToList();
+        }
+
+        using (var context = contextFactory.CreateContext())
+        {
+            var query = context.Set<Context19708.CustomerView19708>().ToList();
+
+            Assert.Collection(
+                query,
+                t => AssertCustomerView(t, 1, "First", 1, "FirstChild"),
+                t => AssertCustomerView(t, 2, "Second", 2, "SecondChild1"),
+                t => AssertCustomerView(t, 2, "Second", 3, "SecondChild2"),
+                t => AssertCustomerView(t, 3, "Third", null, ""));
+
+            static void AssertCustomerView(
+                Context19708.CustomerView19708 actual,
+                int id,
+                string name,
+                int? customerMembershipId,
+                string customerMembershipName)
+            {
+                Assert.Equal(id, actual.Id);
+                Assert.Equal(name, actual.Name);
+                Assert.Equal(customerMembershipId, actual.CustomerMembershipId);
+                Assert.Equal(customerMembershipName, actual.CustomerMembershipName);
+            }
+        }
+    }
+
+    protected class Context19708(DbContextOptions options) : DbContext(options)
+    {
+        public DbSet<Customer19708> Customers { get; set; }
+        public DbSet<CustomerMembership19708> CustomerMemberships { get; set; }
+        public DbSet<CustomerFilter19708> CustomerFilters { get; set; }
+
+        protected override void OnModelCreating(ModelBuilder modelBuilder)
+        {
+            modelBuilder.Entity<CustomerFilter19708>()
+                .HasQueryFilter(
+                    e => (from a in (from c in Customers
+                                     join cm in CustomerMemberships on c.Id equals cm.CustomerId into g
+                                     from cm in g.DefaultIfEmpty()
+                                     select new { c.Id, CustomerMembershipId = (int?)cm.Id })
+                          where a.CustomerMembershipId != null && a.Id == e.CustomerId
+                          select a).Count()
+                        > 0)
+                .HasKey(e => e.CustomerId);
+
+            modelBuilder.Entity<CustomerView19708>().HasNoKey().ToInMemoryQuery(Build_Customers_Sql_View_InMemory());
+        }
+
+        public Task SeedAsync()
+        {
+            var customer1 = new Customer19708 { Name = "First" };
+            var customer2 = new Customer19708 { Name = "Second" };
+            var customer3 = new Customer19708 { Name = "Third" };
+
+            var customerMembership1 = new CustomerMembership19708 { Name = "FirstChild", Customer = customer1 };
+            var customerMembership2 = new CustomerMembership19708 { Name = "SecondChild1", Customer = customer2 };
+            var customerMembership3 = new CustomerMembership19708 { Name = "SecondChild2", Customer = customer2 };
+
+            AddRange(customer1, customer2, customer3);
+            AddRange(customerMembership1, customerMembership2, customerMembership3);
+
+            return SaveChangesAsync();
+        }
+
+        private Expression<Func<IQueryable<CustomerView19708>>> Build_Customers_Sql_View_InMemory()
+        {
+            Expression<Func<IQueryable<CustomerView19708>>> query = () =>
+                from customer in Customers
+                join customerMembership in CustomerMemberships on customer.Id equals customerMembership.CustomerId into
+                    nullableCustomerMemberships
+                from customerMembership in nullableCustomerMemberships.DefaultIfEmpty()
+                select new CustomerView19708
+                {
+                    Id = customer.Id,
+                    Name = customer.Name,
+                    CustomerMembershipId = customerMembership != null ? customerMembership.Id : default(int?),
+                    CustomerMembershipName = customerMembership != null ? customerMembership.Name : ""
+                };
+            return query;
+        }
+
+        public class Customer19708
+        {
+            public int Id { get; set; }
+            public string Name { get; set; }
+        }
+
+        public class CustomerMembership19708
+        {
+            public int Id { get; set; }
+            public string Name { get; set; }
+
+            public int CustomerId { get; set; }
+            public Customer19708 Customer { get; set; }
+        }
+
+        public class CustomerFilter19708
+        {
+            public int CustomerId { get; set; }
+            public int CustomerMembershipId { get; set; }
+        }
+
+        public class CustomerView19708
+        {
+            public int Id { get; set; }
+            public string Name { get; set; }
+            public int? CustomerMembershipId { get; set; }
+            public string CustomerMembershipName { get; set; }
+        }
+    }
+
+    #endregion
+
     protected override ITestStoreFactory TestStoreFactory
         => InMemoryTestStoreFactory.Instance;
 }
diff --git a/test/EFCore.InMemory.FunctionalTests/Scaffolding/CompiledModelInMemoryTest.cs b/test/EFCore.InMemory.FunctionalTests/Scaffolding/CompiledModelInMemoryTest.cs
index dbf56c0246..4c0e39444e 100644
--- a/test/EFCore.InMemory.FunctionalTests/Scaffolding/CompiledModelInMemoryTest.cs
+++ b/test/EFCore.InMemory.FunctionalTests/Scaffolding/CompiledModelInMemoryTest.cs
@@ -8,6 +8,7 @@
 using System.Runtime.CompilerServices;
 using System.Text.Json;
 using Microsoft.EntityFrameworkCore.Design.Internal;
+using Microsoft.EntityFrameworkCore.InMemory.Internal;
 using Microsoft.EntityFrameworkCore.InMemory.Storage.Internal;
 using Microsoft.EntityFrameworkCore.Internal;
 using Microsoft.EntityFrameworkCore.Metadata.Internal;
@@ -307,7 +308,7 @@ public virtual Task Throws_for_query_filter()
         [ConditionalFact]
         public virtual Task Throws_for_defining_query()
             => Test<DefiningQueryContext>(
-                expectedExceptionMessage: DesignStrings.CompiledModelDefiningQuery("object"));
+                expectedExceptionMessage: InMemoryStrings.CompiledModelDefiningQuery("object"));
 
         public class DefiningQueryContext(DbContextOptions<DefiningQueryContext> options) : DbContext(options)
         {
diff --git a/test/EFCore.Relational.Tests/Migrations/Internal/MigrationsModelDifferTest.cs b/test/EFCore.Relational.Tests/Migrations/Internal/MigrationsModelDifferTest.cs
index 7936924eaa..1747d5dbca 100644
--- a/test/EFCore.Relational.Tests/Migrations/Internal/MigrationsModelDifferTest.cs
+++ b/test/EFCore.Relational.Tests/Migrations/Internal/MigrationsModelDifferTest.cs
@@ -43,19 +43,6 @@ public void Model_differ_does_not_detect_views_with_weak_types()
                 }),
             upOperations => Assert.Equal(0, upOperations.Count));
 
-    [ConditionalFact]
-    public void Model_differ_does_not_detect_defining_queries()
-    {
-        DbContext context = null;
-        Execute(
-            _ => { },
-#pragma warning disable CS0618 // Type or member is obsolete
-            modelBuilder => modelBuilder.Entity<TestKeylessType>().HasNoKey().ToQuery(
-                () => context.Set<TestKeylessType>().FromSqlRaw("SELECT * FROM Vista")),
-#pragma warning restore CS0618 // Type or member is obsolete
-            result => Assert.Empty(result));
-    }
-
     [ConditionalFact]
     public void Model_differ_does_not_detect_queries()
         => Execute(
diff --git a/test/EFCore.Specification.Tests/Query/AdHocQueryFiltersQueryTestBase.cs b/test/EFCore.Specification.Tests/Query/AdHocQueryFiltersQueryTestBase.cs
index 2b544ce67c..24b1bcc0b3 100644
--- a/test/EFCore.Specification.Tests/Query/AdHocQueryFiltersQueryTestBase.cs
+++ b/test/EFCore.Specification.Tests/Query/AdHocQueryFiltersQueryTestBase.cs
@@ -417,132 +417,6 @@ public class User18759
 
     #endregion
 
-    #region 19708
-
-    [ConditionalFact]
-    public virtual async Task GroupJoin_SelectMany_gets_flattened()
-    {
-        var contextFactory = await InitializeAsync<Context19708>(seed: c => c.SeedAsync());
-        using (var context = contextFactory.CreateContext())
-        {
-            var query = context.CustomerFilters.ToList();
-        }
-
-        using (var context = contextFactory.CreateContext())
-        {
-            var query = context.Set<Context19708.CustomerView19708>().ToList();
-
-            Assert.Collection(
-                query,
-                t => AssertCustomerView(t, 1, "First", 1, "FirstChild"),
-                t => AssertCustomerView(t, 2, "Second", 2, "SecondChild1"),
-                t => AssertCustomerView(t, 2, "Second", 3, "SecondChild2"),
-                t => AssertCustomerView(t, 3, "Third", null, ""));
-
-            static void AssertCustomerView(
-                Context19708.CustomerView19708 actual,
-                int id,
-                string name,
-                int? customerMembershipId,
-                string customerMembershipName)
-            {
-                Assert.Equal(id, actual.Id);
-                Assert.Equal(name, actual.Name);
-                Assert.Equal(customerMembershipId, actual.CustomerMembershipId);
-                Assert.Equal(customerMembershipName, actual.CustomerMembershipName);
-            }
-        }
-    }
-
-    protected class Context19708(DbContextOptions options) : DbContext(options)
-    {
-        public DbSet<Customer19708> Customers { get; set; }
-        public DbSet<CustomerMembership19708> CustomerMemberships { get; set; }
-        public DbSet<CustomerFilter19708> CustomerFilters { get; set; }
-
-        protected override void OnModelCreating(ModelBuilder modelBuilder)
-        {
-            modelBuilder.Entity<CustomerFilter19708>()
-                .HasQueryFilter(
-                    e => (from a in (from c in Customers
-                                     join cm in CustomerMemberships on c.Id equals cm.CustomerId into g
-                                     from cm in g.DefaultIfEmpty()
-                                     select new { c.Id, CustomerMembershipId = (int?)cm.Id })
-                          where a.CustomerMembershipId != null && a.Id == e.CustomerId
-                          select a).Count()
-                        > 0)
-                .HasKey(e => e.CustomerId);
-
-#pragma warning disable CS0618 // Type or member is obsolete
-            modelBuilder.Entity<CustomerView19708>().HasNoKey().ToQuery(Build_Customers_Sql_View_InMemory());
-#pragma warning restore CS0618 // Type or member is obsolete
-        }
-
-        public Task SeedAsync()
-        {
-            var customer1 = new Customer19708 { Name = "First" };
-            var customer2 = new Customer19708 { Name = "Second" };
-            var customer3 = new Customer19708 { Name = "Third" };
-
-            var customerMembership1 = new CustomerMembership19708 { Name = "FirstChild", Customer = customer1 };
-            var customerMembership2 = new CustomerMembership19708 { Name = "SecondChild1", Customer = customer2 };
-            var customerMembership3 = new CustomerMembership19708 { Name = "SecondChild2", Customer = customer2 };
-
-            AddRange(customer1, customer2, customer3);
-            AddRange(customerMembership1, customerMembership2, customerMembership3);
-
-            return SaveChangesAsync();
-        }
-
-        private Expression<Func<IQueryable<CustomerView19708>>> Build_Customers_Sql_View_InMemory()
-        {
-            Expression<Func<IQueryable<CustomerView19708>>> query = () =>
-                from customer in Customers
-                join customerMembership in CustomerMemberships on customer.Id equals customerMembership.CustomerId into
-                    nullableCustomerMemberships
-                from customerMembership in nullableCustomerMemberships.DefaultIfEmpty()
-                select new CustomerView19708
-                {
-                    Id = customer.Id,
-                    Name = customer.Name,
-                    CustomerMembershipId = customerMembership != null ? customerMembership.Id : default(int?),
-                    CustomerMembershipName = customerMembership != null ? customerMembership.Name : ""
-                };
-            return query;
-        }
-
-        public class Customer19708
-        {
-            public int Id { get; set; }
-            public string Name { get; set; }
-        }
-
-        public class CustomerMembership19708
-        {
-            public int Id { get; set; }
-            public string Name { get; set; }
-
-            public int CustomerId { get; set; }
-            public Customer19708 Customer { get; set; }
-        }
-
-        public class CustomerFilter19708
-        {
-            public int CustomerId { get; set; }
-            public int CustomerMembershipId { get; set; }
-        }
-
-        public class CustomerView19708
-        {
-            public int Id { get; set; }
-            public string Name { get; set; }
-            public int? CustomerMembershipId { get; set; }
-            public string CustomerMembershipName { get; set; }
-        }
-    }
-
-    #endregion
-
     #region 26428
 
 #nullable enable
diff --git a/test/EFCore.SqlServer.FunctionalTests/Query/AdHocQueryFiltersQuerySqlServerTest.cs b/test/EFCore.SqlServer.FunctionalTests/Query/AdHocQueryFiltersQuerySqlServerTest.cs
index 48eec0c80e..286113b1b0 100644
--- a/test/EFCore.SqlServer.FunctionalTests/Query/AdHocQueryFiltersQuerySqlServerTest.cs
+++ b/test/EFCore.SqlServer.FunctionalTests/Query/AdHocQueryFiltersQuerySqlServerTest.cs
@@ -264,31 +264,6 @@ public override async Task Query_filter_with_null_constant()
 """);
     }
 
-    public override async Task GroupJoin_SelectMany_gets_flattened()
-    {
-        await base.GroupJoin_SelectMany_gets_flattened();
-
-        AssertSql(
-            """
-SELECT [c].[CustomerId], [c].[CustomerMembershipId]
-FROM [CustomerFilters] AS [c]
-WHERE (
-    SELECT COUNT(*)
-    FROM [Customers] AS [c0]
-    LEFT JOIN [CustomerMemberships] AS [c1] ON [c0].[Id] = [c1].[CustomerId]
-    WHERE [c1].[Id] IS NOT NULL AND [c0].[Id] = [c].[CustomerId]) > 0
-""",
-            //
-            """
-SELECT [c].[Id], [c].[Name], [c0].[Id] AS [CustomerMembershipId], CASE
-    WHEN [c0].[Id] IS NOT NULL THEN [c0].[Name]
-    ELSE N''
-END AS [CustomerMembershipName]
-FROM [Customers] AS [c]
-LEFT JOIN [CustomerMemberships] AS [c0] ON [c].[Id] = [c0].[CustomerId]
-""");
-    }
-
     public override async Task Group_by_multiple_aggregate_joining_different_tables(bool async)
     {
         await base.Group_by_multiple_aggregate_joining_different_tables(async);
diff --git a/test/EFCore.SqlServer.FunctionalTests/Query/RawSqlServerTest.cs b/test/EFCore.SqlServer.FunctionalTests/Query/RawSqlServerTest.cs
deleted file mode 100644
index d984363098..0000000000
--- a/test/EFCore.SqlServer.FunctionalTests/Query/RawSqlServerTest.cs
+++ /dev/null
@@ -1,79 +0,0 @@
-// Licensed to the .NET Foundation under one or more agreements.
-// The .NET Foundation licenses this file to you under the MIT license.
-
-// ReSharper disable InconsistentNaming
-
-namespace Microsoft.EntityFrameworkCore.Query;
-
-#nullable disable
-
-public class RawSqlServerTest(NonSharedFixture fixture) : NonSharedModelTestBase(fixture), IClassFixture<NonSharedFixture>
-{
-    // Issue #13346, #24623
-    [ConditionalFact]
-    public virtual async Task ToQuery_can_use_FromSqlRaw()
-    {
-        var contextFactory = await InitializeAsync<Context13346>(seed: c => c.SeedAsync());
-        using var context = contextFactory.CreateContext();
-        var query = context.Set<Context13346.OrderSummary>().ToList();
-
-        Assert.Equal(4, query.Count);
-
-        AssertSql(
-            """
-SELECT o.Amount From Orders AS o -- RAW
-""");
-    }
-
-    public class Context13346(DbContextOptions options) : DbContext(options)
-    {
-        public virtual DbSet<Order> Orders { get; set; }
-
-        protected override void OnModelCreating(ModelBuilder modelBuilder)
-        {
-#pragma warning disable CS0618 // Type or member is obsolete
-            modelBuilder.Entity<OrderSummary>()
-                .HasNoKey()
-                .ToQuery(() => Set<OrderSummary>().FromSqlRaw("SELECT o.Amount From Orders AS o -- RAW"));
-#pragma warning restore CS0618 // Type or member is obsolete
-        }
-
-        public Task SeedAsync()
-        {
-            AddRange(
-                new Order { Amount = 1 },
-                new Order { Amount = 2 },
-                new Order { Amount = 3 },
-                new Order { Amount = 4 }
-            );
-
-            return SaveChangesAsync();
-        }
-
-        public class Order
-        {
-            public int Id { get; set; }
-            public int Amount { get; set; }
-        }
-
-        public class OrderSummary
-        {
-            public int Amount { get; set; }
-        }
-    }
-
-    protected override string StoreName
-        => "RawSqlServerTest";
-
-    protected TestSqlLoggerFactory TestSqlLoggerFactory
-        => (TestSqlLoggerFactory)ListLoggerFactory;
-
-    protected override ITestStoreFactory TestStoreFactory
-        => SqlServerTestStoreFactory.Instance;
-
-    protected void AssertSql(params string[] expected)
-        => TestSqlLoggerFactory.AssertBaseline(expected);
-
-    protected void ClearLog()
-        => TestSqlLoggerFactory.Clear();
-}
diff --git a/test/EFCore.Tests/Metadata/Conventions/ConventionSetBuilderTests.cs b/test/EFCore.Tests/Metadata/Conventions/ConventionSetBuilderTests.cs
index 5eb545a849..c959423f25 100644
--- a/test/EFCore.Tests/Metadata/Conventions/ConventionSetBuilderTests.cs
+++ b/test/EFCore.Tests/Metadata/Conventions/ConventionSetBuilderTests.cs
@@ -2,7 +2,6 @@
 // The .NET Foundation licenses this file to you under the MIT license.
 
 using System.ComponentModel.DataAnnotations.Schema;
-using Microsoft.EntityFrameworkCore.InMemory.Metadata.Conventions;
 
 // ReSharper disable InconsistentNaming
 namespace Microsoft.EntityFrameworkCore.Metadata.Conventions;
