diff --git a/src/EFCore.Relational/Properties/RelationalStrings.Designer.cs b/src/EFCore.Relational/Properties/RelationalStrings.Designer.cs
index b7ef50f00f..758e4278d1 100644
--- a/src/EFCore.Relational/Properties/RelationalStrings.Designer.cs
+++ b/src/EFCore.Relational/Properties/RelationalStrings.Designer.cs
@@ -1287,6 +1287,14 @@ public static string NoActiveTransaction
         public static string NoDbCommand
             => GetString("NoDbCommand");
 
+        /// <summary>
+        ///     Expression of type '{type}' isn't supported as the Values of an InExpression; only constants and parameters are supported.
+        /// </summary>
+        public static string NonConstantOrParameterAsInExpressionValues(object? type)
+            => string.Format(
+                GetString("NonConstantOrParameterAsInExpressionValues", nameof(type)),
+                type);
+
         /// <summary>
         ///     'FindMapping' was called on a 'RelationalTypeMappingSource' with a non-relational 'TypeMappingInfo'.
         /// </summary>
diff --git a/src/EFCore.Relational/Properties/RelationalStrings.resx b/src/EFCore.Relational/Properties/RelationalStrings.resx
index d10d59b928..bff3e0ea56 100644
--- a/src/EFCore.Relational/Properties/RelationalStrings.resx
+++ b/src/EFCore.Relational/Properties/RelationalStrings.resx
@@ -902,6 +902,9 @@
   <data name="NoDbCommand" xml:space="preserve">
     <value>Cannot create a DbCommand for a non-relational query.</value>
   </data>
+  <data name="NonConstantOrParameterAsInExpressionValues" xml:space="preserve">
+    <value>Expression of type '{type}' isn't supported as the Values of an InExpression; only constants and parameters are supported.</value>
+  </data>
   <data name="NoneRelationalTypeMappingOnARelationalTypeMappingSource" xml:space="preserve">
     <value>'FindMapping' was called on a 'RelationalTypeMappingSource' with a non-relational 'TypeMappingInfo'.</value>
   </data>
diff --git a/src/EFCore.Relational/Query/SqlExpressions/SelectExpression.Helper.cs b/src/EFCore.Relational/Query/SqlExpressions/SelectExpression.Helper.cs
index b168182172..93f15cc32b 100644
--- a/src/EFCore.Relational/Query/SqlExpressions/SelectExpression.Helper.cs
+++ b/src/EFCore.Relational/Query/SqlExpressions/SelectExpression.Helper.cs
@@ -210,7 +210,7 @@ when _groupByDiscovery
 
                 case SqlExpression sqlExpression
                     when !_groupByDiscovery
-                    && sqlExpression is not SqlConstantExpression or SqlParameterExpression
+                    && sqlExpression is not SqlConstantExpression and not SqlParameterExpression
                     && _correlatedTerms.Contains(sqlExpression):
                     var outerColumn = _subquery.GenerateOuterColumn(_tableReferenceExpression, sqlExpression);
                     _mappings[sqlExpression] = outerColumn;
diff --git a/src/EFCore.Relational/Query/SqlNullabilityProcessor.cs b/src/EFCore.Relational/Query/SqlNullabilityProcessor.cs
index 5b42172288..1b413d0faa 100644
--- a/src/EFCore.Relational/Query/SqlNullabilityProcessor.cs
+++ b/src/EFCore.Relational/Query/SqlNullabilityProcessor.cs
@@ -720,26 +720,28 @@ protected virtual SqlExpression VisitIn(InExpression inExpression, bool allowOpt
         {
             var inValues = new List<object?>();
             var hasNullValue = false;
-            RelationalTypeMapping? typeMapping = null;
+            RelationalTypeMapping? typeMapping;
 
-            IEnumerable? values = null;
-            if (valuesExpression is SqlConstantExpression sqlConstant)
+            IEnumerable values;
+            switch (valuesExpression)
             {
-                typeMapping = sqlConstant.TypeMapping;
-                values = (IEnumerable)sqlConstant.Value!;
-            }
-            else if (valuesExpression is SqlParameterExpression sqlParameter)
-            {
-                DoNotCache();
-                typeMapping = sqlParameter.TypeMapping;
-                values = (IEnumerable?)ParameterValues[sqlParameter.Name];
-                if (values == null)
-                {
-                    throw new NullReferenceException();
-                }
+                case SqlConstantExpression sqlConstant:
+                    typeMapping = sqlConstant.TypeMapping;
+                    values = (IEnumerable)sqlConstant.Value!;
+                    break;
+
+                case SqlParameterExpression sqlParameter:
+                    DoNotCache();
+                    typeMapping = sqlParameter.TypeMapping;
+                    values = (IEnumerable?)ParameterValues[sqlParameter.Name] ?? throw new NullReferenceException();
+                    break;
+
+                default:
+                    throw new InvalidOperationException(
+                        RelationalStrings.NonConstantOrParameterAsInExpressionValues(valuesExpression.GetType().Name));
             }
 
-            foreach (var value in values!)
+            foreach (var value in values)
             {
                 if (value == null && extractNullValues)
                 {
diff --git a/test/EFCore.Specification.Tests/Query/ComplexNavigationsCollectionsQueryTestBase.cs b/test/EFCore.Specification.Tests/Query/ComplexNavigationsCollectionsQueryTestBase.cs
index 629c767f92..a5e3683aa7 100644
--- a/test/EFCore.Specification.Tests/Query/ComplexNavigationsCollectionsQueryTestBase.cs
+++ b/test/EFCore.Specification.Tests/Query/ComplexNavigationsCollectionsQueryTestBase.cs
@@ -2197,6 +2197,26 @@ public virtual Task Skip_Take_on_grouping_element_inside_collection_projection(b
                     });
             });
 
+    [ConditionalTheory]
+    [MemberData(nameof(IsAsyncData))]
+    public virtual Task Collection_projection_over_GroupBy_over_parameter(bool async)
+    {
+        var validIds = new List<string> { "L1 01", "L1 02" };
+
+        return AssertQuery(
+            async,
+            ss => ss.Set<Level1>()
+                .Where(l1 => validIds.Contains(l1.Name))
+                .GroupBy(l => l.Date)
+                .Select(g => new { g.Key, Ids = g.Select(e => e.Id) }),
+            elementSorter: e => e.Key,
+            elementAsserter: (e, a) =>
+            {
+                AssertEqual(e.Key, a.Key);
+                AssertCollection(e.Ids, a.Ids);
+            });
+    }
+
     [ConditionalTheory]
     [MemberData(nameof(IsAsyncData))]
     public virtual Task SelectMany_over_conditional_null_source(bool async)
diff --git a/test/EFCore.Specification.Tests/Query/NorthwindIncludeQueryTestBase.cs b/test/EFCore.Specification.Tests/Query/NorthwindIncludeQueryTestBase.cs
index 2fc8ee0b8f..a388e0ab56 100644
--- a/test/EFCore.Specification.Tests/Query/NorthwindIncludeQueryTestBase.cs
+++ b/test/EFCore.Specification.Tests/Query/NorthwindIncludeQueryTestBase.cs
@@ -1453,7 +1453,7 @@ public virtual Task Include_with_cycle_does_not_throw_when_AsTracking_NoTracking
 
     [ConditionalTheory]
     [MemberData(nameof(IsAsyncData))]
-    public virtual Task Outer_idenfier_correctly_determined_when_doing_include_on_right_side_of_left_join(bool async)
+    public virtual Task Outer_identifier_correctly_determined_when_doing_include_on_right_side_of_left_join(bool async)
         => AssertQuery(
             async,
             ss => from cust in ss.Set<Customer>()
diff --git a/test/EFCore.SqlServer.FunctionalTests/Query/ComplexNavigationsCollectionsQuerySqlServerTest.cs b/test/EFCore.SqlServer.FunctionalTests/Query/ComplexNavigationsCollectionsQuerySqlServerTest.cs
index 1ca2aa4195..db21098eb4 100644
--- a/test/EFCore.SqlServer.FunctionalTests/Query/ComplexNavigationsCollectionsQuerySqlServerTest.cs
+++ b/test/EFCore.SqlServer.FunctionalTests/Query/ComplexNavigationsCollectionsQuerySqlServerTest.cs
@@ -2319,6 +2319,28 @@ public override async Task Skip_Take_on_grouping_element_inside_collection_proje
 """);
     }
 
+    public override async Task Collection_projection_over_GroupBy_over_parameter(bool async)
+    {
+        await base.Collection_projection_over_GroupBy_over_parameter(async);
+
+        AssertSql(
+"""
+SELECT [t].[Date], [t0].[Id]
+FROM (
+    SELECT [l].[Date]
+    FROM [LevelOne] AS [l]
+    WHERE [l].[Name] IN (N'L1 01', N'L1 02')
+    GROUP BY [l].[Date]
+) AS [t]
+LEFT JOIN (
+    SELECT [l0].[Id], [l0].[Date]
+    FROM [LevelOne] AS [l0]
+    WHERE [l0].[Name] IN (N'L1 01', N'L1 02')
+) AS [t0] ON [t].[Date] = [t0].[Date]
+ORDER BY [t].[Date]
+""");
+    }
+
     public override async Task Include_partially_added_before_Where_and_then_build_upon(bool async)
     {
         await base.Include_partially_added_before_Where_and_then_build_upon(async);
diff --git a/test/EFCore.SqlServer.FunctionalTests/Query/ComplexNavigationsCollectionsSharedTypeQuerySqlServerTest.cs b/test/EFCore.SqlServer.FunctionalTests/Query/ComplexNavigationsCollectionsSharedTypeQuerySqlServerTest.cs
index b8a98df535..f71d71a4b2 100644
--- a/test/EFCore.SqlServer.FunctionalTests/Query/ComplexNavigationsCollectionsSharedTypeQuerySqlServerTest.cs
+++ b/test/EFCore.SqlServer.FunctionalTests/Query/ComplexNavigationsCollectionsSharedTypeQuerySqlServerTest.cs
@@ -3003,6 +3003,28 @@ public override async Task Skip_Take_on_grouping_element_inside_collection_proje
 """);
     }
 
+    public override async Task Collection_projection_over_GroupBy_over_parameter(bool async)
+    {
+        await base.Collection_projection_over_GroupBy_over_parameter(async);
+
+        AssertSql(
+"""
+SELECT [t].[Date], [t0].[Id]
+FROM (
+    SELECT [l].[Date]
+    FROM [Level1] AS [l]
+    WHERE [l].[Name] IN (N'L1 01', N'L1 02')
+    GROUP BY [l].[Date]
+) AS [t]
+LEFT JOIN (
+    SELECT [l0].[Id], [l0].[Date]
+    FROM [Level1] AS [l0]
+    WHERE [l0].[Name] IN (N'L1 01', N'L1 02')
+) AS [t0] ON [t].[Date] = [t0].[Date]
+ORDER BY [t].[Date]
+""");
+    }
+
     public override async Task Filtered_include_is_considered_loaded(bool async)
     {
         await base.Filtered_include_is_considered_loaded(async);
diff --git a/test/EFCore.SqlServer.FunctionalTests/Query/ComplexNavigationsCollectionsSplitQuerySqlServerTest.cs b/test/EFCore.SqlServer.FunctionalTests/Query/ComplexNavigationsCollectionsSplitQuerySqlServerTest.cs
index c6a3d7f220..fe870979d6 100644
--- a/test/EFCore.SqlServer.FunctionalTests/Query/ComplexNavigationsCollectionsSplitQuerySqlServerTest.cs
+++ b/test/EFCore.SqlServer.FunctionalTests/Query/ComplexNavigationsCollectionsSplitQuerySqlServerTest.cs
@@ -3728,6 +3728,36 @@ public override async Task Skip_Take_on_grouping_element_inside_collection_proje
 """);
     }
 
+    public override async Task Collection_projection_over_GroupBy_over_parameter(bool async)
+    {
+        await base.Collection_projection_over_GroupBy_over_parameter(async);
+
+        AssertSql(
+"""
+SELECT [l].[Date]
+FROM [LevelOne] AS [l]
+WHERE [l].[Name] IN (N'L1 01', N'L1 02')
+GROUP BY [l].[Date]
+ORDER BY [l].[Date]
+""",
+            //
+"""
+SELECT [t0].[Id], [t].[Date]
+FROM (
+    SELECT [l].[Date]
+    FROM [LevelOne] AS [l]
+    WHERE [l].[Name] IN (N'L1 01', N'L1 02')
+    GROUP BY [l].[Date]
+) AS [t]
+INNER JOIN (
+    SELECT [l0].[Id], [l0].[Date]
+    FROM [LevelOne] AS [l0]
+    WHERE [l0].[Name] IN (N'L1 01', N'L1 02')
+) AS [t0] ON [t].[Date] = [t0].[Date]
+ORDER BY [t].[Date]
+""");
+    }
+
     public override async Task Include_partially_added_before_Where_and_then_build_upon(bool async)
     {
         await base.Include_partially_added_before_Where_and_then_build_upon(async);
diff --git a/test/EFCore.SqlServer.FunctionalTests/Query/NorthwindEFPropertyIncludeQuerySqlServerTest.cs b/test/EFCore.SqlServer.FunctionalTests/Query/NorthwindEFPropertyIncludeQuerySqlServerTest.cs
index 74a621e49e..6d25e26b2a 100644
--- a/test/EFCore.SqlServer.FunctionalTests/Query/NorthwindEFPropertyIncludeQuerySqlServerTest.cs
+++ b/test/EFCore.SqlServer.FunctionalTests/Query/NorthwindEFPropertyIncludeQuerySqlServerTest.cs
@@ -1262,9 +1262,9 @@ public override async Task Include_multiple_references_then_include_collection_m
 """);
     }
 
-    public override async Task Outer_idenfier_correctly_determined_when_doing_include_on_right_side_of_left_join(bool async)
+    public override async Task Outer_identifier_correctly_determined_when_doing_include_on_right_side_of_left_join(bool async)
     {
-        await base.Outer_idenfier_correctly_determined_when_doing_include_on_right_side_of_left_join(async);
+        await base.Outer_identifier_correctly_determined_when_doing_include_on_right_side_of_left_join(async);
 
         AssertSql(
 """
diff --git a/test/EFCore.SqlServer.FunctionalTests/Query/NorthwindIncludeNoTrackingQuerySqlServerTest.cs b/test/EFCore.SqlServer.FunctionalTests/Query/NorthwindIncludeNoTrackingQuerySqlServerTest.cs
index ec5fcce54a..ee5cb18d5a 100644
--- a/test/EFCore.SqlServer.FunctionalTests/Query/NorthwindIncludeNoTrackingQuerySqlServerTest.cs
+++ b/test/EFCore.SqlServer.FunctionalTests/Query/NorthwindIncludeNoTrackingQuerySqlServerTest.cs
@@ -261,9 +261,9 @@ public override async Task Include_collection_then_include_collection_predicate(
 """);
     }
 
-    public override async Task Outer_idenfier_correctly_determined_when_doing_include_on_right_side_of_left_join(bool async)
+    public override async Task Outer_identifier_correctly_determined_when_doing_include_on_right_side_of_left_join(bool async)
     {
-        await base.Outer_idenfier_correctly_determined_when_doing_include_on_right_side_of_left_join(async);
+        await base.Outer_identifier_correctly_determined_when_doing_include_on_right_side_of_left_join(async);
 
         AssertSql(
 """
diff --git a/test/EFCore.SqlServer.FunctionalTests/Query/NorthwindIncludeQuerySqlServerTest.cs b/test/EFCore.SqlServer.FunctionalTests/Query/NorthwindIncludeQuerySqlServerTest.cs
index e94e0b5774..8d4b38bd59 100644
--- a/test/EFCore.SqlServer.FunctionalTests/Query/NorthwindIncludeQuerySqlServerTest.cs
+++ b/test/EFCore.SqlServer.FunctionalTests/Query/NorthwindIncludeQuerySqlServerTest.cs
@@ -1712,9 +1712,9 @@ public override async Task Filtered_include_with_multiple_ordering(bool async)
 """);
     }
 
-    public override async Task Outer_idenfier_correctly_determined_when_doing_include_on_right_side_of_left_join(bool async)
+    public override async Task Outer_identifier_correctly_determined_when_doing_include_on_right_side_of_left_join(bool async)
     {
-        await base.Outer_idenfier_correctly_determined_when_doing_include_on_right_side_of_left_join(async);
+        await base.Outer_identifier_correctly_determined_when_doing_include_on_right_side_of_left_join(async);
 
         AssertSql(
 """
diff --git a/test/EFCore.SqlServer.FunctionalTests/Query/NorthwindSplitIncludeNoTrackingQuerySqlServerTest.cs b/test/EFCore.SqlServer.FunctionalTests/Query/NorthwindSplitIncludeNoTrackingQuerySqlServerTest.cs
index 244a115679..53c1b6470a 100644
--- a/test/EFCore.SqlServer.FunctionalTests/Query/NorthwindSplitIncludeNoTrackingQuerySqlServerTest.cs
+++ b/test/EFCore.SqlServer.FunctionalTests/Query/NorthwindSplitIncludeNoTrackingQuerySqlServerTest.cs
@@ -1309,9 +1309,9 @@ public override async Task Include_duplicate_reference3(bool async)
 """);
     }
 
-    public override async Task Outer_idenfier_correctly_determined_when_doing_include_on_right_side_of_left_join(bool async)
+    public override async Task Outer_identifier_correctly_determined_when_doing_include_on_right_side_of_left_join(bool async)
     {
-        await base.Outer_idenfier_correctly_determined_when_doing_include_on_right_side_of_left_join(async);
+        await base.Outer_identifier_correctly_determined_when_doing_include_on_right_side_of_left_join(async);
 
         AssertSql(
 """
diff --git a/test/EFCore.SqlServer.FunctionalTests/Query/NorthwindSplitIncludeQuerySqlServerTest.cs b/test/EFCore.SqlServer.FunctionalTests/Query/NorthwindSplitIncludeQuerySqlServerTest.cs
index 821b3def04..17d163af35 100644
--- a/test/EFCore.SqlServer.FunctionalTests/Query/NorthwindSplitIncludeQuerySqlServerTest.cs
+++ b/test/EFCore.SqlServer.FunctionalTests/Query/NorthwindSplitIncludeQuerySqlServerTest.cs
@@ -2388,9 +2388,9 @@ public override async Task Filtered_include_with_multiple_ordering(bool async)
 """);
     }
 
-    public override async Task Outer_idenfier_correctly_determined_when_doing_include_on_right_side_of_left_join(bool async)
+    public override async Task Outer_identifier_correctly_determined_when_doing_include_on_right_side_of_left_join(bool async)
     {
-        await base.Outer_idenfier_correctly_determined_when_doing_include_on_right_side_of_left_join(async);
+        await base.Outer_identifier_correctly_determined_when_doing_include_on_right_side_of_left_join(async);
 
         AssertSql(
 """
diff --git a/test/EFCore.SqlServer.FunctionalTests/Query/NorthwindStringIncludeQuerySqlServerTest.cs b/test/EFCore.SqlServer.FunctionalTests/Query/NorthwindStringIncludeQuerySqlServerTest.cs
index 8c115ba567..0c7a790a8b 100644
--- a/test/EFCore.SqlServer.FunctionalTests/Query/NorthwindStringIncludeQuerySqlServerTest.cs
+++ b/test/EFCore.SqlServer.FunctionalTests/Query/NorthwindStringIncludeQuerySqlServerTest.cs
@@ -1262,9 +1262,9 @@ public override async Task Include_multiple_references_then_include_collection_m
 """);
     }
 
-    public override async Task Outer_idenfier_correctly_determined_when_doing_include_on_right_side_of_left_join(bool async)
+    public override async Task Outer_identifier_correctly_determined_when_doing_include_on_right_side_of_left_join(bool async)
     {
-        await base.Outer_idenfier_correctly_determined_when_doing_include_on_right_side_of_left_join(async);
+        await base.Outer_identifier_correctly_determined_when_doing_include_on_right_side_of_left_join(async);
 
         AssertSql(
 """
diff --git a/test/EFCore.SqlServer.FunctionalTests/Query/TemporalComplexNavigationsCollectionsQuerySqlServerTest.cs b/test/EFCore.SqlServer.FunctionalTests/Query/TemporalComplexNavigationsCollectionsQuerySqlServerTest.cs
index 0850234d7f..0aae82b36e 100644
--- a/test/EFCore.SqlServer.FunctionalTests/Query/TemporalComplexNavigationsCollectionsQuerySqlServerTest.cs
+++ b/test/EFCore.SqlServer.FunctionalTests/Query/TemporalComplexNavigationsCollectionsQuerySqlServerTest.cs
@@ -2295,6 +2295,28 @@ public override async Task Skip_Take_on_grouping_element_inside_collection_proje
 """);
     }
 
+    public override async Task Collection_projection_over_GroupBy_over_parameter(bool async)
+    {
+        await base.Collection_projection_over_GroupBy_over_parameter(async);
+
+        AssertSql(
+"""
+SELECT [t].[Date], [t0].[Id]
+FROM (
+    SELECT [l].[Date]
+    FROM [LevelOne] FOR SYSTEM_TIME AS OF '2010-01-01T00:00:00.0000000' AS [l]
+    WHERE [l].[Name] IN (N'L1 01', N'L1 02')
+    GROUP BY [l].[Date]
+) AS [t]
+LEFT JOIN (
+    SELECT [l0].[Id], [l0].[Date]
+    FROM [LevelOne] FOR SYSTEM_TIME AS OF '2010-01-01T00:00:00.0000000' AS [l0]
+    WHERE [l0].[Name] IN (N'L1 01', N'L1 02')
+) AS [t0] ON [t].[Date] = [t0].[Date]
+ORDER BY [t].[Date]
+""");
+    }
+
     public override async Task Multiple_SelectMany_navigation_property_followed_by_select_collection_navigation(bool async)
     {
         await base.Multiple_SelectMany_navigation_property_followed_by_select_collection_navigation(async);
diff --git a/test/EFCore.SqlServer.FunctionalTests/Query/TemporalComplexNavigationsCollectionsSharedTypeQuerySqlServerTest.cs b/test/EFCore.SqlServer.FunctionalTests/Query/TemporalComplexNavigationsCollectionsSharedTypeQuerySqlServerTest.cs
index e1a9361895..7cad5cafa2 100644
--- a/test/EFCore.SqlServer.FunctionalTests/Query/TemporalComplexNavigationsCollectionsSharedTypeQuerySqlServerTest.cs
+++ b/test/EFCore.SqlServer.FunctionalTests/Query/TemporalComplexNavigationsCollectionsSharedTypeQuerySqlServerTest.cs
@@ -3023,6 +3023,28 @@ public override async Task Skip_Take_on_grouping_element_inside_collection_proje
 """);
     }
 
+    public override async Task Collection_projection_over_GroupBy_over_parameter(bool async)
+    {
+        await base.Collection_projection_over_GroupBy_over_parameter(async);
+
+        AssertSql(
+"""
+SELECT [t].[Date], [t0].[Id]
+FROM (
+    SELECT [l].[Date]
+    FROM [Level1] FOR SYSTEM_TIME AS OF '2010-01-01T00:00:00.0000000' AS [l]
+    WHERE [l].[Name] IN (N'L1 01', N'L1 02')
+    GROUP BY [l].[Date]
+) AS [t]
+LEFT JOIN (
+    SELECT [l0].[Id], [l0].[Date]
+    FROM [Level1] FOR SYSTEM_TIME AS OF '2010-01-01T00:00:00.0000000' AS [l0]
+    WHERE [l0].[Name] IN (N'L1 01', N'L1 02')
+) AS [t0] ON [t].[Date] = [t0].[Date]
+ORDER BY [t].[Date]
+""");
+    }
+
     public override async Task Skip_Take_on_grouping_element_into_non_entity(bool async)
     {
         await base.Skip_Take_on_grouping_element_into_non_entity(async);
