diff --git a/src/EFCore.Design/Design/Internal/DbContextOperations.cs b/src/EFCore.Design/Design/Internal/DbContextOperations.cs
index d076d3ac68..da44b15b28 100644
--- a/src/EFCore.Design/Design/Internal/DbContextOperations.cs
+++ b/src/EFCore.Design/Design/Internal/DbContextOperations.cs
@@ -447,7 +447,7 @@ public virtual DbContext CreateContext(string? contextType)
     public virtual IEnumerable<DbContext> CreateAllContexts()
     {
         EF.IsDesignTime = true;
-        var types = FindContextTypes();
+        var types = FindContextTypes(useServiceProvider: false);
         foreach (var contextPair in types)
         {
             yield return CreateContext(null, contextPair);
@@ -499,7 +499,7 @@ public virtual IEnumerable<Type> GetContextTypes()
     public virtual Type GetContextType(string? name)
         => FindContextType(name).Key;
 
-    private IDictionary<Type, Func<DbContext>> FindContextTypes(string? name = null)
+    private IDictionary<Type, Func<DbContext>> FindContextTypes(string? name = null, bool useServiceProvider = true)
     {
         _reporter.WriteVerbose(DesignStrings.FindingContexts);
 
@@ -576,7 +576,7 @@ where i.IsGenericType
             }
 
             if (contexts.Values.All(f => f != null)
-                && (string.IsNullOrEmpty(name) || contexts.Count == 1))
+                && (!useServiceProvider || contexts.Count == 1))
             {
                 return contexts!;
             }
diff --git a/test/EFCore.AspNet.Specification.Tests/AspNetIdentityCustomTypesDefaultTestBase.cs b/test/EFCore.AspNet.Specification.Tests/AspNetIdentityCustomTypesDefaultTestBase.cs
index b88e33d492..3c62689b1b 100644
--- a/test/EFCore.AspNet.Specification.Tests/AspNetIdentityCustomTypesDefaultTestBase.cs
+++ b/test/EFCore.AspNet.Specification.Tests/AspNetIdentityCustomTypesDefaultTestBase.cs
@@ -348,12 +348,11 @@ protected override void OnModelCreating(ModelBuilder modelBuilder)
                     .WithMany(e => e.Users)
                     .UsingEntity<CustomUserRoleString>(
                         j => j.HasOne(e => e.Role).WithMany(e => e.UserRoles).HasForeignKey(e => e.RoleId),
-                        j => j.HasOne(e => e.User).WithMany(e => e.UserRoles).HasForeignKey(e => e.RoleId));
+                        j => j.HasOne(e => e.User).WithMany(e => e.UserRoles).HasForeignKey(e => e.UserId));
 
                 b.HasMany(e => e.Claims).WithOne(e => e.User).HasForeignKey(uc => uc.UserId).IsRequired();
                 b.HasMany(e => e.Logins).WithOne(e => e.User).HasForeignKey(ul => ul.UserId).IsRequired();
                 b.HasMany(e => e.Tokens).WithOne(e => e.User).HasForeignKey(ut => ut.UserId).IsRequired();
-                b.HasMany(e => e.UserRoles).WithOne(e => e.User).HasForeignKey(ur => ur.UserId).IsRequired();
                 b.ToTable("MyUsers");
                 b.Property(u => u.UserName).HasMaxLength(128);
                 b.Property(u => u.NormalizedUserName).HasMaxLength(128);
diff --git a/test/EFCore.Design.Tests/Design/Internal/DbContextOperationsTest.cs b/test/EFCore.Design.Tests/Design/Internal/DbContextOperationsTest.cs
index 0ab95ab7bf..990345659b 100644
--- a/test/EFCore.Design.Tests/Design/Internal/DbContextOperationsTest.cs
+++ b/test/EFCore.Design.Tests/Design/Internal/DbContextOperationsTest.cs
@@ -10,7 +10,11 @@ public class DbContextOperationsTest
 {
     [ConditionalFact]
     public void CreateContext_gets_service()
-        => CreateOperations(typeof(TestProgram)).CreateContext(typeof(TestContext).FullName.ToLower());
+        => CreateOperations(typeof(TestProgram), includeContext: false).CreateContext(typeof(TestContext).FullName.ToLower());
+
+    [ConditionalFact]
+    public void CreateContext_gets_service_without_name()
+        => CreateOperations(typeof(TestProgram), includeContext: false).CreateContext(null);
 
     [ConditionalFact]
     public void CreateContext_gets_service_without_AddDbContext()
@@ -18,7 +22,11 @@ public void CreateContext_gets_service_without_AddDbContext()
 
     [ConditionalFact]
     public void CreateContext_gets_service_when_context_factory_used()
-        => CreateOperations(typeof(TestProgramWithContextFactory)).CreateContext(typeof(TestContextFromFactory).FullName);
+        => CreateOperations(typeof(TestProgramWithContextFactory), includeContext: false).CreateContext(typeof(TestContextFromFactory).FullName);
+
+    [ConditionalFact]
+    public void CreateContext_gets_service_when_context_factory_used_without_name()
+        => CreateOperations(typeof(TestProgramWithContextFactory), includeContext: false).CreateContext(null);
 
     [ConditionalFact]
     public void CreateContext_throws_if_context_type_not_found()
@@ -230,10 +238,9 @@ public void Optimize_throws_when_no_contexts()
 
         Assert.Equal(
             DesignStrings.NoContextsToOptimize,
-            Assert.Throws<OperationException>(
-                () =>
-                    operations.Optimize(
-                        null, null, contextTypeName: "*", null, scaffoldModel: true, precompileQueries: false, nativeAot: false)).Message);
+            Assert.Throws<OperationException>(() =>
+                operations.Optimize(
+                    null, null, contextTypeName: "*", null, scaffoldModel: true, precompileQueries: false, nativeAot: false)).Message);
 
         Assert.DoesNotContain(reporter.Messages, m => m.Level == LogLevel.Critical);
         Assert.DoesNotContain(reporter.Messages, m => m.Level == LogLevel.Error);
@@ -364,9 +371,14 @@ private static TestWebHost BuildWebHost(string[] args)
             => CreateWebHost(b => b.UseSqlServer(@"Cake=None"));
     }
 
-    private static TestDbContextOperations CreateOperations(Type testProgramType)
+    private static TestDbContextOperations CreateOperations(Type testProgramType, bool includeContext = true)
     {
-        var assembly = MockAssembly.Create(testProgramType, typeof(TestContext));
+        List<Type> types = [testProgramType];
+        if (includeContext)
+        {
+            types.Add(typeof(TestContext));
+        }
+        var assembly = MockAssembly.Create([.. types]);
         var reporter = new TestOperationReporter();
         var operations = new TestDbContextOperations(
             reporter,
