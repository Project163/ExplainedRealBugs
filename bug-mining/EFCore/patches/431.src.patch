diff --git a/src/EFCore.Relational/Query/SqlExpressions/SelectExpression.cs b/src/EFCore.Relational/Query/SqlExpressions/SelectExpression.cs
index 4ddcc34837..7ac113066b 100644
--- a/src/EFCore.Relational/Query/SqlExpressions/SelectExpression.cs
+++ b/src/EFCore.Relational/Query/SqlExpressions/SelectExpression.cs
@@ -30,6 +30,8 @@ public sealed partial class SelectExpression : TableExpressionBase
         AppContext.TryGetSwitch("Microsoft.EntityFrameworkCore.Issue31107", out var enabled31107) && enabled31107;
     private static readonly bool UseOldBehavior32234 =
         AppContext.TryGetSwitch("Microsoft.EntityFrameworkCore.Issue32234", out var enabled32234) && enabled32234;
+    private static readonly bool UseOldBehavior32911 =
+        AppContext.TryGetSwitch("Microsoft.EntityFrameworkCore.Issue32911", out var enabled32911) && enabled32911;
 
     private static readonly IdentifierComparer IdentifierComparerInstance = new();
 
@@ -2706,116 +2708,243 @@ private void ApplySetOperation(SetOperationType setOperationType, SelectExpressi
                         projection1.StructuralType.DisplayName(), projection2.StructuralType.DisplayName()));
             }
 
-            var propertyExpressions = new Dictionary<IProperty, ColumnExpression>();
-
-            ProcessStructuralType(projection1, projection2);
-
-            void ProcessStructuralType(
-                StructuralTypeProjectionExpression nestedProjection1,
-                StructuralTypeProjectionExpression nestedProjection2)
+            if (UseOldBehavior32911)
             {
-                var type = nestedProjection1.StructuralType;
+                var propertyExpressions = new Dictionary<IProperty, ColumnExpression>();
+
+                ProcessStructuralType(projection1, projection2);
 
-                foreach (var property in GetAllPropertiesInHierarchy(type))
+                void ProcessStructuralType(
+                    StructuralTypeProjectionExpression nestedProjection1,
+                    StructuralTypeProjectionExpression nestedProjection2)
                 {
-                    var column1 = nestedProjection1.BindProperty(property);
-                    var column2 = nestedProjection2.BindProperty(property);
-                    var alias = GenerateUniqueColumnAlias(column1.Name);
-                    var innerProjection = new ProjectionExpression(column1, alias);
-                    select1._projection.Add(innerProjection);
-                    select2._projection.Add(new ProjectionExpression(column2, alias));
-                    var outerColumn = new ConcreteColumnExpression(innerProjection, tableReferenceExpression);
-                    if (column1.IsNullable
-                        || column2.IsNullable)
+                    var type = nestedProjection1.StructuralType;
+
+                    foreach (var property in GetAllPropertiesInHierarchy(type))
                     {
-                        outerColumn = outerColumn.MakeNullable();
-                    }
+                        var column1 = nestedProjection1.BindProperty(property);
+                        var column2 = nestedProjection2.BindProperty(property);
+                        var alias = GenerateUniqueColumnAlias(column1.Name);
+                        var innerProjection = new ProjectionExpression(column1, alias);
+                        select1._projection.Add(innerProjection);
+                        select2._projection.Add(new ProjectionExpression(column2, alias));
+                        var outerColumn = new ConcreteColumnExpression(innerProjection, tableReferenceExpression);
+                        if (column1.IsNullable
+                            || column2.IsNullable)
+                        {
+                            outerColumn = outerColumn.MakeNullable();
+                        }
 
-                    propertyExpressions[property] = outerColumn;
+                        propertyExpressions[property] = outerColumn;
 
-                    // Lift up any identifier columns to the set operation result (the outer).
-                    // This is typically the entity primary key columns, but can also be all of a complex type's properties if Distinct
-                    // was previously called.
-                    if (outerIdentifiers.Length > 0)
-                    {
-                        var index = select1._identifier.FindIndex(e => e.Column.Equals(column1));
-                        if (index != -1)
+                        // Lift up any identifier columns to the set operation result (the outer).
+                        // This is typically the entity primary key columns, but can also be all of a complex type's properties if Distinct
+                        // was previously called.
+                        if (outerIdentifiers.Length > 0)
                         {
-                            if (select2._identifier[index].Column.Equals(column2))
+                            var index = select1._identifier.FindIndex(e => e.Column.Equals(column1));
+                            if (index != -1)
                             {
-                                outerIdentifiers[index] = outerColumn;
+                                if (select2._identifier[index].Column.Equals(column2))
+                                {
+                                    outerIdentifiers[index] = outerColumn;
+                                }
+                                else
+                                {
+                                    // If select1 matched but select2 did not then we erase all identifiers
+                                    // TODO: We could make this little more robust by allow the indexes to be different. See issue#24475
+                                    // i.e. Identifier ordering being different.
+                                    outerIdentifiers = Array.Empty<ColumnExpression>();
+                                }
                             }
-                            else
+                            // If the top-level projection - not the current nested one - is a complex type and not an entity type, then add
+                            // all its columns to the "otherExpressions" list (i.e. columns not part of a an entity primary key). This is
+                            // the same as with a non-structural type projection.
+                            else if (projection1.StructuralType is IComplexType)
                             {
-                                // If select1 matched but select2 did not then we erase all identifiers
-                                // TODO: We could make this little more robust by allow the indexes to be different. See issue#24475
-                                // i.e. Identifier ordering being different.
-                                outerIdentifiers = Array.Empty<ColumnExpression>();
+                                var outerTypeMapping = column1.TypeMapping ?? column1.TypeMapping;
+                                if (outerTypeMapping == null)
+                                {
+                                    throw new InvalidOperationException(
+                                        RelationalStrings.SetOperationsRequireAtLeastOneSideWithValidTypeMapping(setOperationType));
+                                }
+
+                                otherExpressions.Add((outerColumn, outerTypeMapping.KeyComparer));
                             }
                         }
-                        // If the top-level projection - not the current nested one - is a complex type and not an entity type, then add
-                        // all its columns to the "otherExpressions" list (i.e. columns not part of a an entity primary key). This is
-                        // the same as with a non-structural type projection.
-                        else if (projection1.StructuralType is IComplexType)
-                        {
-                            var outerTypeMapping = column1.TypeMapping ?? column1.TypeMapping;
-                            if (outerTypeMapping == null)
-                            {
-                                throw new InvalidOperationException(
-                                    RelationalStrings.SetOperationsRequireAtLeastOneSideWithValidTypeMapping(setOperationType));
-                            }
+                    }
 
-                            otherExpressions.Add((outerColumn, outerTypeMapping.KeyComparer));
-                        }
+                    foreach (var complexProperty in GetAllComplexPropertiesInHierarchy(nestedProjection1.StructuralType))
+                    {
+                        ProcessStructuralType(
+                            (StructuralTypeProjectionExpression)nestedProjection1.BindComplexProperty(complexProperty).ValueBufferExpression,
+                            (StructuralTypeProjectionExpression)nestedProjection2.BindComplexProperty(complexProperty).ValueBufferExpression);
                     }
                 }
 
-                foreach (var complexProperty in GetAllComplexPropertiesInHierarchy(nestedProjection1.StructuralType))
+                Check.DebugAssert(
+                    projection1.TableMap.Count == projection2.TableMap.Count,
+                    "Set operation over entity projections with different table map counts");
+                Check.DebugAssert(
+                    projection1.TableMap.Keys.All(t => projection2.TableMap.ContainsKey(t)),
+                    "Set operation over entity projections with table map discrepancy");
+
+                var tableMap = projection1.TableMap.ToDictionary(kvp => kvp.Key, kvp => tableReferenceExpression);
+
+                var discriminatorExpression = projection1.DiscriminatorExpression;
+                if (projection1.DiscriminatorExpression != null
+                    && projection2.DiscriminatorExpression != null)
                 {
-                    ProcessStructuralType(
-                        (StructuralTypeProjectionExpression)nestedProjection1.BindComplexProperty(complexProperty).ValueBufferExpression,
-                        (StructuralTypeProjectionExpression)nestedProjection2.BindComplexProperty(complexProperty).ValueBufferExpression);
+                    var alias = GenerateUniqueColumnAlias(DiscriminatorColumnAlias);
+                    var innerProjection = new ProjectionExpression(projection1.DiscriminatorExpression, alias);
+                    select1._projection.Add(innerProjection);
+                    select2._projection.Add(new ProjectionExpression(projection2.DiscriminatorExpression, alias));
+                    discriminatorExpression = new ConcreteColumnExpression(innerProjection, tableReferenceExpression);
                 }
-            }
-
-            Check.DebugAssert(
-                projection1.TableMap.Count == projection2.TableMap.Count,
-                "Set operation over entity projections with different table map counts");
-            Check.DebugAssert(
-                projection1.TableMap.Keys.All(t => projection2.TableMap.ContainsKey(t)),
-                "Set operation over entity projections with table map discrepancy");
 
-            var tableMap = projection1.TableMap.ToDictionary(kvp => kvp.Key, kvp => tableReferenceExpression);
+                var outerProjection = new StructuralTypeProjectionExpression(
+                    projection1.StructuralType, propertyExpressions, tableMap, nullable: false, discriminatorExpression);
 
-            var discriminatorExpression = projection1.DiscriminatorExpression;
-            if (projection1.DiscriminatorExpression != null
-                && projection2.DiscriminatorExpression != null)
-            {
-                var alias = GenerateUniqueColumnAlias(DiscriminatorColumnAlias);
-                var innerProjection = new ProjectionExpression(projection1.DiscriminatorExpression, alias);
-                select1._projection.Add(innerProjection);
-                select2._projection.Add(new ProjectionExpression(projection2.DiscriminatorExpression, alias));
-                discriminatorExpression = new ConcreteColumnExpression(innerProjection, tableReferenceExpression);
-            }
+                if (outerIdentifiers.Length > 0 && outerProjection is { StructuralType: IEntityType entityType })
+                {
+                    var primaryKey = entityType.FindPrimaryKey();
 
-            var outerProjection = new StructuralTypeProjectionExpression(
-                projection1.StructuralType, propertyExpressions, tableMap, nullable: false, discriminatorExpression);
+                    // We know that there are existing identifiers (see condition above); we know we must have a key since a keyless
+                    // entity type would have wiped the identifiers when generating the join.
+                    Check.DebugAssert(primaryKey != null, "primary key is null.");
+                    foreach (var property in primaryKey.Properties)
+                    {
+                        entityProjectionIdentifiers.Add(outerProjection.BindProperty(property));
+                        entityProjectionValueComparers.Add(property.GetKeyValueComparer());
+                    }
+                }
 
-            if (outerIdentifiers.Length > 0 && outerProjection is { StructuralType: IEntityType entityType })
+                _projectionMapping[projectionMember] = outerProjection;
+            }
+            else
             {
-                var primaryKey = entityType.FindPrimaryKey();
+                var resultProjection = ProcessStructuralType(projection1, projection2);
+                _projectionMapping[projectionMember] = resultProjection;
 
-                // We know that there are existing identifiers (see condition above); we know we must have a key since a keyless
-                // entity type would have wiped the identifiers when generating the join.
-                Check.DebugAssert(primaryKey != null, "primary key is null.");
-                foreach (var property in primaryKey.Properties)
+                StructuralTypeProjectionExpression ProcessStructuralType(
+                    StructuralTypeProjectionExpression structuralProjection1,
+                    StructuralTypeProjectionExpression structuralProjection2)
                 {
-                    entityProjectionIdentifiers.Add(outerProjection.BindProperty(property));
-                    entityProjectionValueComparers.Add(property.GetKeyValueComparer());
+                    var propertyExpressions = new Dictionary<IProperty, ColumnExpression>();
+                    var complexPropertyCache = new Dictionary<IComplexProperty, StructuralTypeShaperExpression>();
+                    var type = structuralProjection1.StructuralType;
+
+                    foreach (var property in GetAllPropertiesInHierarchy(type))
+                    {
+                        var column1 = structuralProjection1.BindProperty(property);
+                        var column2 = structuralProjection2.BindProperty(property);
+                        var alias = GenerateUniqueColumnAlias(column1.Name);
+                        var innerProjection = new ProjectionExpression(column1, alias);
+                        select1._projection.Add(innerProjection);
+                        select2._projection.Add(new ProjectionExpression(column2, alias));
+                        var outerColumn = new ConcreteColumnExpression(innerProjection, tableReferenceExpression);
+                        if (column1.IsNullable
+                            || column2.IsNullable)
+                        {
+                            outerColumn = outerColumn.MakeNullable();
+                        }
+
+                        propertyExpressions[property] = outerColumn;
+
+                        // Lift up any identifier columns to the set operation result (the outer).
+                        // This is typically the entity primary key columns, but can also be all of a complex type's properties if Distinct
+                        // was previously called.
+                        if (outerIdentifiers.Length > 0)
+                        {
+                            var index = select1._identifier.FindIndex(e => e.Column.Equals(column1));
+                            if (index != -1)
+                            {
+                                if (select2._identifier[index].Column.Equals(column2))
+                                {
+                                    outerIdentifiers[index] = outerColumn;
+                                }
+                                else
+                                {
+                                    // If select1 matched but select2 did not then we erase all identifiers
+                                    // TODO: We could make this little more robust by allow the indexes to be different. See issue#24475
+                                    // i.e. Identifier ordering being different.
+                                    outerIdentifiers = Array.Empty<ColumnExpression>();
+                                }
+                            }
+                            // If the top-level projection - not the current nested one - is a complex type and not an entity type, then add
+                            // all its columns to the "otherExpressions" list (i.e. columns not part of a an entity primary key). This is
+                            // the same as with a non-structural type projection.
+                            else if (projection1.StructuralType is IComplexType)
+                            {
+                                var outerTypeMapping = column1.TypeMapping ?? column1.TypeMapping;
+                                if (outerTypeMapping == null)
+                                {
+                                    throw new InvalidOperationException(
+                                        RelationalStrings.SetOperationsRequireAtLeastOneSideWithValidTypeMapping(setOperationType));
+                                }
+
+                                otherExpressions.Add((outerColumn, outerTypeMapping.KeyComparer));
+                            }
+                        }
+                    }
+
+                    foreach (var complexProperty in GetAllComplexPropertiesInHierarchy(type))
+                    {
+                        var complexPropertyShaper1 = structuralProjection1.BindComplexProperty(complexProperty);
+                        var complexPropertyShaper2 = structuralProjection2.BindComplexProperty(complexProperty);
+
+                        var resultComplexProjection = ProcessStructuralType(
+                            (StructuralTypeProjectionExpression)complexPropertyShaper1.ValueBufferExpression,
+                            (StructuralTypeProjectionExpression)complexPropertyShaper2.ValueBufferExpression);
+
+                        var resultComplexShaper = new RelationalStructuralTypeShaperExpression(
+                            complexProperty.ComplexType,
+                            resultComplexProjection,
+                            resultComplexProjection.IsNullable);
+
+                        complexPropertyCache[complexProperty] = resultComplexShaper;
+                    }
+
+                    Check.DebugAssert(
+                        structuralProjection1.TableMap.Count == structuralProjection2.TableMap.Count,
+                        "Set operation over entity projections with different table map counts");
+                    Check.DebugAssert(
+                        structuralProjection1.TableMap.Keys.All(t => structuralProjection2.TableMap.ContainsKey(t)),
+                        "Set operation over entity projections with table map discrepancy");
+
+                    var tableMap = structuralProjection1.TableMap.ToDictionary(kvp => kvp.Key, _ => tableReferenceExpression);
+
+                    var discriminatorExpression = structuralProjection1.DiscriminatorExpression;
+                    if (structuralProjection1.DiscriminatorExpression != null
+                        && structuralProjection2.DiscriminatorExpression != null)
+                    {
+                        var alias = GenerateUniqueColumnAlias(DiscriminatorColumnAlias);
+                        var innerProjection = new ProjectionExpression(structuralProjection1.DiscriminatorExpression, alias);
+                        select1._projection.Add(innerProjection);
+                        select2._projection.Add(new ProjectionExpression(structuralProjection2.DiscriminatorExpression, alias));
+                        discriminatorExpression = new ConcreteColumnExpression(innerProjection, tableReferenceExpression);
+                    }
+
+                    var outerProjection = new StructuralTypeProjectionExpression(
+                        type, propertyExpressions, complexPropertyCache, tableMap, nullable: false, discriminatorExpression);
+
+                    if (outerIdentifiers.Length > 0 && outerProjection is { StructuralType: IEntityType entityType })
+                    {
+                        var primaryKey = entityType.FindPrimaryKey();
+
+                        // We know that there are existing identifiers (see condition above); we know we must have a key since a keyless
+                        // entity type would have wiped the identifiers when generating the join.
+                        Check.DebugAssert(primaryKey != null, "primary key is null.");
+                        foreach (var property in primaryKey.Properties)
+                        {
+                            entityProjectionIdentifiers.Add(outerProjection.BindProperty(property));
+                            entityProjectionValueComparers.Add(property.GetKeyValueComparer());
+                        }
+                    }
+
+                    return outerProjection;
                 }
             }
-
-            _projectionMapping[projectionMember] = outerProjection;
         }
 
         string GenerateUniqueColumnAlias(string baseAlias)
@@ -4184,32 +4313,67 @@ private SqlRemappingVisitor PushdownIntoSubqueryInternal(bool liftOrderings = tr
             TableReferenceExpression subqueryTableReference)
         {
             var propertyExpressions = new Dictionary<IProperty, ColumnExpression>();
+            var complexPropertyCache = new Dictionary<IComplexProperty, StructuralTypeShaperExpression>();
+
+            if (UseOldBehavior32911)
+            {
+                HandleTypeProjection(projection);
 
-            HandleTypeProjection(projection);
+                void HandleTypeProjection(StructuralTypeProjectionExpression typeProjection)
+                {
+                    foreach (var property in GetAllPropertiesInHierarchy(typeProjection.StructuralType))
+                    {
+                        // json entity projection (i.e. JSON entity that was transformed into query root) may have synthesized keys
+                        // but they don't correspond to any columns - we need to skip those
+                        if (typeProjection is { StructuralType: IEntityType entityType }
+                            && entityType.IsMappedToJson()
+                            && property.IsOrdinalKeyProperty())
+                        {
+                            continue;
+                        }
+
+                        var innerColumn = typeProjection.BindProperty(property);
+                        var outerColumn = subquery.GenerateOuterColumn(subqueryTableReferenceExpression, innerColumn);
+                        projectionMap[innerColumn] = outerColumn;
+                        propertyExpressions[property] = outerColumn;
+                    }
 
-            void HandleTypeProjection(StructuralTypeProjectionExpression typeProjection)
+                    foreach (var complexProperty in GetAllComplexPropertiesInHierarchy(typeProjection.StructuralType))
+                    {
+                        HandleTypeProjection(
+                            (StructuralTypeProjectionExpression)typeProjection.BindComplexProperty(complexProperty).ValueBufferExpression);
+                    }
+                }
+            }
+            else
             {
-                foreach (var property in GetAllPropertiesInHierarchy(typeProjection.StructuralType))
+                foreach (var property in GetAllPropertiesInHierarchy(projection.StructuralType))
                 {
                     // json entity projection (i.e. JSON entity that was transformed into query root) may have synthesized keys
                     // but they don't correspond to any columns - we need to skip those
-                    if (typeProjection is { StructuralType: IEntityType entityType }
+                    if (projection is { StructuralType: IEntityType entityType }
                         && entityType.IsMappedToJson()
                         && property.IsOrdinalKeyProperty())
                     {
                         continue;
                     }
 
-                    var innerColumn = typeProjection.BindProperty(property);
-                    var outerColumn = subquery.GenerateOuterColumn(subqueryTableReferenceExpression, innerColumn);
+                    var innerColumn = projection.BindProperty(property);
+                    var outerColumn = subquery.GenerateOuterColumn(subqueryTableReference, innerColumn);
+
                     projectionMap[innerColumn] = outerColumn;
                     propertyExpressions[property] = outerColumn;
                 }
 
-                foreach (var complexProperty in GetAllComplexPropertiesInHierarchy(typeProjection.StructuralType))
+                foreach (var complexProperty in GetAllComplexPropertiesInHierarchy(projection.StructuralType))
                 {
-                    HandleTypeProjection(
-                        (StructuralTypeProjectionExpression)typeProjection.BindComplexProperty(complexProperty).ValueBufferExpression);
+                    var complexPropertyShaper = projection.BindComplexProperty(complexProperty);
+
+                    var complexTypeProjectionExpression = LiftEntityProjectionFromSubquery(
+                        (StructuralTypeProjectionExpression)complexPropertyShaper.ValueBufferExpression,
+                        subqueryTableReference);
+
+                    complexPropertyCache[complexProperty] = complexPropertyShaper.Update(complexTypeProjectionExpression);
                 }
             }
 
@@ -4223,8 +4387,11 @@ void HandleTypeProjection(StructuralTypeProjectionExpression typeProjection)
 
             var tableMap = projection.TableMap.ToDictionary(kvp => kvp.Key, _ => subqueryTableReference);
 
-            var newEntityProjection = new StructuralTypeProjectionExpression(
-                projection.StructuralType, propertyExpressions, tableMap, nullable: false, discriminatorExpression);
+            var newEntityProjection = UseOldBehavior32911
+                ? new StructuralTypeProjectionExpression(
+                    projection.StructuralType, propertyExpressions, tableMap, nullable: false, discriminatorExpression)
+                : new StructuralTypeProjectionExpression(
+                    projection.StructuralType, propertyExpressions, complexPropertyCache, tableMap, nullable: false, discriminatorExpression);
 
             if (projection.StructuralType is IEntityType entityType2)
             {
diff --git a/src/EFCore.Relational/Query/StructuralTypeProjectionExpression.cs b/src/EFCore.Relational/Query/StructuralTypeProjectionExpression.cs
index 828a7c95b2..5b9c7dd152 100644
--- a/src/EFCore.Relational/Query/StructuralTypeProjectionExpression.cs
+++ b/src/EFCore.Relational/Query/StructuralTypeProjectionExpression.cs
@@ -17,6 +17,9 @@ namespace Microsoft.EntityFrameworkCore.Query;
 /// </summary>
 public class StructuralTypeProjectionExpression : Expression
 {
+    private static readonly bool UseOldBehavior32911 =
+        AppContext.TryGetSwitch("Microsoft.EntityFrameworkCore.Issue32911", out var enabled32911) && enabled32911;
+
     private readonly IReadOnlyDictionary<IProperty, ColumnExpression> _propertyExpressionMap;
     private readonly Dictionary<INavigation, StructuralTypeShaperExpression> _ownedNavigationMap;
     private Dictionary<IComplexProperty, StructuralTypeShaperExpression>? _complexPropertyCache;
@@ -38,6 +41,32 @@ public class StructuralTypeProjectionExpression : Expression
             type,
             propertyExpressionMap,
             new Dictionary<INavigation, StructuralTypeShaperExpression>(),
+            null,
+            tableMap,
+            nullable,
+            discriminatorExpression)
+    {
+    }
+
+    /// <summary>
+    ///     This is an internal API that supports the Entity Framework Core infrastructure and not subject to
+    ///     the same compatibility standards as public APIs. It may be changed or removed without notice in
+    ///     any release. You should only use it directly in your code with extreme caution and knowing that
+    ///     doing so can result in application failures when updating to a new Entity Framework Core release.
+    /// </summary>
+    [EntityFrameworkInternal]
+    public StructuralTypeProjectionExpression(
+        ITypeBase type,
+        IReadOnlyDictionary<IProperty, ColumnExpression> propertyExpressionMap,
+        Dictionary<IComplexProperty, StructuralTypeShaperExpression> complexPropertyCache,
+        IReadOnlyDictionary<ITableBase, TableReferenceExpression> tableMap,
+        bool nullable = false,
+        SqlExpression? discriminatorExpression = null)
+        : this(
+            type,
+            propertyExpressionMap,
+            new Dictionary<INavigation, StructuralTypeShaperExpression>(),
+            complexPropertyCache,
             tableMap,
             nullable,
             discriminatorExpression)
@@ -48,6 +77,7 @@ public class StructuralTypeProjectionExpression : Expression
         ITypeBase type,
         IReadOnlyDictionary<IProperty, ColumnExpression> propertyExpressionMap,
         Dictionary<INavigation, StructuralTypeShaperExpression> ownedNavigationMap,
+        Dictionary<IComplexProperty, StructuralTypeShaperExpression>? complexPropertyCache,
         IReadOnlyDictionary<ITableBase, TableReferenceExpression> tableMap,
         bool nullable,
         SqlExpression? discriminatorExpression = null)
@@ -55,6 +85,7 @@ public class StructuralTypeProjectionExpression : Expression
         StructuralType = type;
         _propertyExpressionMap = propertyExpressionMap;
         _ownedNavigationMap = ownedNavigationMap;
+        _complexPropertyCache = complexPropertyCache;
         TableMap = tableMap;
         IsNullable = nullable;
         DiscriminatorExpression = discriminatorExpression;
@@ -115,6 +146,21 @@ protected override Expression VisitChildren(ExpressionVisitor visitor)
             propertyExpressionMap[property] = newExpression;
         }
 
+        var complexPropertyCache = default(Dictionary<IComplexProperty, StructuralTypeShaperExpression>);
+        if (!UseOldBehavior32911)
+        {
+            if (_complexPropertyCache != null)
+            {
+                complexPropertyCache = new();
+                foreach (var (complexProperty, complexShaper) in _complexPropertyCache)
+                {
+                    var newComplexShaper = (StructuralTypeShaperExpression)visitor.Visit(complexShaper);
+                    changed |= complexShaper != newComplexShaper;
+                    complexPropertyCache[complexProperty] = newComplexShaper;
+                }
+            }
+        }
+
         // We only need to visit the table map since TableReferenceUpdatingExpressionVisitor may need to modify it; it mutates
         // TableReferenceExpression (a new TableReferenceExpression is never returned), so we never need a new table map.
         foreach (var (_, tableExpression) in TableMap)
@@ -136,7 +182,7 @@ protected override Expression VisitChildren(ExpressionVisitor visitor)
 
         return changed
             ? new StructuralTypeProjectionExpression(
-                StructuralType, propertyExpressionMap, ownedNavigationMap, TableMap, IsNullable, discriminatorExpression)
+                StructuralType, propertyExpressionMap, ownedNavigationMap, complexPropertyCache, TableMap, IsNullable, discriminatorExpression)
             : this;
     }
 
@@ -159,6 +205,19 @@ public virtual StructuralTypeProjectionExpression MakeNullable()
             discriminatorExpression = ce.MakeNullable();
         }
 
+        var complexPropertyCache = default(Dictionary<IComplexProperty, StructuralTypeShaperExpression>);
+        if (!UseOldBehavior32911)
+        {
+            if (_complexPropertyCache != null)
+            {
+                complexPropertyCache = new();
+                foreach (var (complexProperty, complexShaper) in _complexPropertyCache)
+                {
+                    complexPropertyCache[complexProperty] = complexShaper.MakeNullable();
+                }
+            }
+        }
+
         var ownedNavigationMap = new Dictionary<INavigation, StructuralTypeShaperExpression>();
         foreach (var (navigation, shaper) in _ownedNavigationMap)
         {
@@ -178,6 +237,7 @@ public virtual StructuralTypeProjectionExpression MakeNullable()
             StructuralType,
             propertyExpressionMap,
             ownedNavigationMap,
+            complexPropertyCache,
             TableMap,
             nullable: true,
             discriminatorExpression);
@@ -212,6 +272,23 @@ public virtual StructuralTypeProjectionExpression UpdateEntityType(IEntityType d
             }
         }
 
+        var complexPropertyCache = default(Dictionary<IComplexProperty, StructuralTypeShaperExpression>);
+        if (!UseOldBehavior32911)
+        {
+            if (_complexPropertyCache != null)
+            {
+                complexPropertyCache = new();
+                foreach (var (complexProperty, complexShaper) in _complexPropertyCache)
+                {
+                    if (derivedType.IsAssignableFrom(complexProperty.DeclaringType)
+                        || complexProperty.DeclaringType.IsAssignableFrom(derivedType))
+                    {
+                        complexPropertyCache[complexProperty] = complexShaper;
+                    }
+                }
+            }
+        }
+
         var ownedNavigationMap = new Dictionary<INavigation, StructuralTypeShaperExpression>();
         foreach (var (navigation, entityShaperExpression) in _ownedNavigationMap)
         {
@@ -263,7 +340,7 @@ public virtual StructuralTypeProjectionExpression UpdateEntityType(IEntityType d
         }
 
         return new StructuralTypeProjectionExpression(
-            derivedType, propertyExpressionMap, ownedNavigationMap, newTableMap ?? TableMap, IsNullable, discriminatorExpression);
+            derivedType, propertyExpressionMap, ownedNavigationMap, complexPropertyCache, newTableMap ?? TableMap, IsNullable, discriminatorExpression);
     }
 
     /// <summary>
diff --git a/test/EFCore.InMemory.FunctionalTests/Query/AdHocAdvancedMappingsQueryInMemoryTest.cs b/test/EFCore.InMemory.FunctionalTests/Query/AdHocAdvancedMappingsQueryInMemoryTest.cs
new file mode 100644
index 0000000000..bcd988e756
--- /dev/null
+++ b/test/EFCore.InMemory.FunctionalTests/Query/AdHocAdvancedMappingsQueryInMemoryTest.cs
@@ -0,0 +1,10 @@
+﻿// Licensed to the .NET Foundation under one or more agreements.
+// The .NET Foundation licenses this file to you under the MIT license.
+
+namespace Microsoft.EntityFrameworkCore.Query;
+
+public class AdHocAdvancedMappingsQueryInMemoryTest : AdHocAdvancedMappingsQueryTestBase
+{
+    protected override ITestStoreFactory TestStoreFactory
+        => InMemoryTestStoreFactory.Instance;
+}
diff --git a/test/EFCore.Relational.Specification.Tests/Query/AdHocAdvancedMappingsQueryRelationalTestBase.cs b/test/EFCore.Relational.Specification.Tests/Query/AdHocAdvancedMappingsQueryRelationalTestBase.cs
new file mode 100644
index 0000000000..d001b5488f
--- /dev/null
+++ b/test/EFCore.Relational.Specification.Tests/Query/AdHocAdvancedMappingsQueryRelationalTestBase.cs
@@ -0,0 +1,230 @@
+﻿// Licensed to the .NET Foundation under one or more agreements.
+// The .NET Foundation licenses this file to you under the MIT license.
+
+namespace Microsoft.EntityFrameworkCore.Query;
+
+public abstract class AdHocAdvancedMappingsQueryRelationalTestBase : AdHocAdvancedMappingsQueryTestBase
+{
+    protected TestSqlLoggerFactory TestSqlLoggerFactory
+        => (TestSqlLoggerFactory)ListLoggerFactory;
+
+    protected void ClearLog()
+        => TestSqlLoggerFactory.Clear();
+
+    protected void AssertSql(params string[] expected)
+        => TestSqlLoggerFactory.AssertBaseline(expected);
+
+    #region 32911
+
+    [ConditionalFact]
+    public virtual async Task Two_similar_complex_properties_projected_with_split_query1()
+    {
+        var contextFactory = await InitializeAsync<Context32911>(seed: c => c.Seed());
+
+        using var context = contextFactory.CreateContext();
+        var query = context.Offers
+            .Include(e => e.Variations)
+            .ThenInclude(v => v.Nested)
+            .AsSplitQuery()
+            .ToList();
+
+        var resultElement = query.Single();
+        foreach (var variation in resultElement.Variations)
+        {
+            Assert.NotEqual(variation.Payment.Brutto, variation.Nested.Payment.Brutto);
+            Assert.NotEqual(variation.Payment.Netto, variation.Nested.Payment.Netto);
+        }
+    }
+
+    [ConditionalFact]
+    public virtual async Task Two_similar_complex_properties_projected_with_split_query2()
+    {
+        var contextFactory = await InitializeAsync<Context32911>(seed: c => c.Seed());
+
+        using var context = contextFactory.CreateContext();
+        var query = context.Offers
+            .Include(e => e.Variations)
+            .ThenInclude(v => v.Nested)
+            .AsSplitQuery()
+            .Single(x => x.Id == 1);
+
+        foreach (var variation in query.Variations)
+        {
+            Assert.NotEqual(variation.Payment.Brutto, variation.Nested.Payment.Brutto);
+            Assert.NotEqual(variation.Payment.Netto, variation.Nested.Payment.Netto);
+        }
+    }
+
+    [ConditionalFact]
+    public virtual async Task Projecting_one_of_two_similar_complex_types_picks_the_correct_one()
+    {
+        var contextFactory = await InitializeAsync<Context32911_2>(seed: c => c.Seed());
+
+        using var context = contextFactory.CreateContext();
+
+        var query = context.Cs
+            .Where(x => x.B.AId.Value == 1)
+            .OrderBy(x => x.Id)
+            .Take(10)
+            .Select(x => new
+            {
+                x.B.A.Id,
+                x.B.Info.Created,
+            }).ToList();
+
+        Assert.Equal(new DateTime(2000, 1, 1), query[0].Created);
+    }
+
+    protected class Context32911(DbContextOptions options) : DbContext(options)
+    {
+        public DbSet<Offer> Offers { get; set; }
+
+        protected override void OnModelCreating(ModelBuilder modelBuilder)
+        {
+            modelBuilder.Entity<Offer>().Property(x => x.Id).ValueGeneratedNever();
+            modelBuilder.Entity<Variation>().Property(x => x.Id).ValueGeneratedNever();
+            modelBuilder.Entity<Variation>().ComplexProperty(x => x.Payment, cpb =>
+            {
+                cpb.IsRequired();
+                cpb.Property(p => p.Netto).HasColumnName("payment_netto");
+                cpb.Property(p => p.Brutto).HasColumnName("payment_brutto");
+            });
+            modelBuilder.Entity<NestedEntity>().Property(x => x.Id).ValueGeneratedNever();
+            modelBuilder.Entity<NestedEntity>().ComplexProperty(x => x.Payment, cpb =>
+            {
+                cpb.IsRequired();
+                cpb.Property(p => p.Netto).HasColumnName("payment_netto");
+                cpb.Property(p => p.Brutto).HasColumnName("payment_brutto");
+            });
+        }
+
+        public void Seed()
+        {
+            var v1 = new Variation
+            {
+                Id = 1,
+                Payment = new Payment(1, 10),
+                Nested = new NestedEntity
+                {
+                    Id = 1,
+                    Payment = new Payment(10, 100)
+                }
+            };
+
+            var v2 = new Variation
+            {
+                Id = 2,
+                Payment = new Payment(2, 20),
+                Nested = new NestedEntity
+                {
+                    Id = 2,
+                    Payment = new Payment(20, 200)
+                }
+            };
+
+            var v3 = new Variation
+            {
+                Id = 3,
+                Payment = new Payment(3, 30),
+                Nested = new NestedEntity
+                {
+                    Id = 3,
+                    Payment = new Payment(30, 300)
+                }
+            };
+
+            Offers.Add(new Offer { Id = 1, Variations = new List<Variation> { v1, v2, v3 } });
+
+            SaveChanges();
+        }
+
+        public abstract class EntityBase
+        {
+            public int Id { get; set; }
+        }
+
+        public class Offer : EntityBase
+        {
+            public ICollection<Variation> Variations { get; set; }
+        }
+
+        public class Variation : EntityBase
+        {
+            public Payment Payment { get; set; } = new Payment(0, 0);
+
+            public NestedEntity Nested { get; set; }
+        }
+
+        public class NestedEntity : EntityBase
+        {
+            public Payment Payment { get; set; } = new Payment(0, 0);
+        }
+
+        public record Payment(decimal Netto, decimal Brutto);
+    }
+
+    protected class Context32911_2(DbContextOptions options) : DbContext(options)
+    {
+        public DbSet<A> As { get; set; }
+        public DbSet<B> Bs { get; set; }
+        public DbSet<C> Cs { get; set; }
+
+        protected override void OnModelCreating(ModelBuilder modelBuilder)
+        {
+            modelBuilder.Entity<A>().Property(x => x.Id).ValueGeneratedNever();
+            modelBuilder.Entity<B>().Property(x => x.Id).ValueGeneratedNever();
+            modelBuilder.Entity<C>().Property(x => x.Id).ValueGeneratedNever();
+
+            modelBuilder.Entity<B>(x => x.ComplexProperty(b => b.Info).IsRequired());
+            modelBuilder.Entity<C>(x => x.ComplexProperty(c => c.Info).IsRequired());
+        }
+
+        public void Seed()
+        {
+            var c = new C
+            {
+                Id = 100,
+                Info = new Metadata { Created = new DateTime(2020, 10, 10) },
+                B = new B
+                {
+                    Id = 10,
+                    Info = new Metadata { Created = new DateTime(2000, 1, 1) },
+                    A = new A { Id = 1 }
+                }
+            };
+
+            Cs.Add(c);
+            SaveChanges();
+        }
+
+        public class Metadata
+        {
+            public DateTime Created { get; set; }
+        }
+
+        public class A
+        {
+            public int Id { get; set; }
+        }
+
+        public class B
+        {
+            public int Id { get; set; }
+            public Metadata Info { get; set; }
+            public int? AId { get; set; }
+
+            public A A { get; set; }
+        }
+
+        public class C
+        {
+            public int Id { get; set; }
+            public Metadata Info { get; set; }
+            public int BId { get; set; }
+
+            public B B { get; set; }
+        }
+    }
+
+    #endregion
+}
diff --git a/test/EFCore.Specification.Tests/Query/AdHocAdvancedMappingsQueryTestBase.cs b/test/EFCore.Specification.Tests/Query/AdHocAdvancedMappingsQueryTestBase.cs
new file mode 100644
index 0000000000..7782e297b4
--- /dev/null
+++ b/test/EFCore.Specification.Tests/Query/AdHocAdvancedMappingsQueryTestBase.cs
@@ -0,0 +1,10 @@
+﻿// Licensed to the .NET Foundation under one or more agreements.
+// The .NET Foundation licenses this file to you under the MIT license.
+
+namespace Microsoft.EntityFrameworkCore.Query;
+
+public abstract class AdHocAdvancedMappingsQueryTestBase : NonSharedModelTestBase
+{
+    protected override string StoreName
+        => "AdHocAdvancedMappingsQueryTests";
+}
diff --git a/test/EFCore.Specification.Tests/Query/ComplexTypeQueryTestBase.cs b/test/EFCore.Specification.Tests/Query/ComplexTypeQueryTestBase.cs
index ceb4a5d65a..1f45144803 100644
--- a/test/EFCore.Specification.Tests/Query/ComplexTypeQueryTestBase.cs
+++ b/test/EFCore.Specification.Tests/Query/ComplexTypeQueryTestBase.cs
@@ -506,6 +506,292 @@ public virtual Task Union_two_different_struct_complex_type(bool async)
             async,
             ss => ss.Set<ValuedCustomer>().Select(c => c.ShippingAddress).Union(ss.Set<ValuedCustomer>().Select(c => c.BillingAddress)));
 
+    [ConditionalTheory]
+    [MemberData(nameof(IsAsyncData))]
+    public virtual Task Project_same_nested_complex_type_twice_with_pushdown(bool async)
+        => AssertQuery(
+            async,
+            ss => (from c1 in ss.Set<Customer>()
+                   from c2 in ss.Set<Customer>()
+                   select new { BA1 = c1.BillingAddress, BA2 = c2.BillingAddress })
+                .Distinct()
+                .Select(x => new { x.BA1, x.BA2 }),
+            elementSorter: e => (e.BA1.ZipCode, e.BA2.ZipCode),
+            elementAsserter: (e, a) =>
+            {
+                AssertEqual(e.BA1, a.BA1);
+                AssertEqual(e.BA2, a.BA2);
+            });
+
+    [ConditionalTheory]
+    [MemberData(nameof(IsAsyncData))]
+    public virtual Task Project_same_entity_with_nested_complex_type_twice_with_pushdown(bool async)
+        => AssertQuery(
+            async,
+            ss => (from c1 in ss.Set<Customer>()
+                   from c2 in ss.Set<Customer>()
+                   select new { c1, c2 })
+                .Distinct()
+                .Select(x => new { x.c1, x.c2 }),
+            elementSorter: e => (e.c1.Id, e.c2.Id),
+            elementAsserter: (e, a) =>
+            {
+                AssertEqual(e.c1, a.c1);
+                AssertEqual(e.c2, a.c2);
+            });
+
+    [ConditionalTheory]
+    [MemberData(nameof(IsAsyncData))]
+    public virtual Task Project_same_nested_complex_type_twice_with_double_pushdown(bool async)
+        => AssertQuery(
+            async,
+            ss => (from c1 in ss.Set<Customer>()
+                   from c2 in ss.Set<Customer>()
+                   orderby c1.Id, c2.Id
+                   select new { BA1 = c1.BillingAddress, BA2 = c2.BillingAddress })
+                .Take(50)
+                .Distinct()
+                .Select(x => new { x.BA1, x.BA2 }),
+            elementSorter: e => (e.BA1.ZipCode, e.BA2.ZipCode),
+            elementAsserter: (e, a) =>
+            {
+                AssertEqual(e.BA1, a.BA1);
+                AssertEqual(e.BA2, a.BA2);
+            });
+
+    [ConditionalTheory]
+    [MemberData(nameof(IsAsyncData))]
+    public virtual Task Project_same_entity_with_nested_complex_type_twice_with_double_pushdown(bool async)
+        => AssertQuery(
+            async,
+            ss => (from c1 in ss.Set<Customer>()
+                   from c2 in ss.Set<Customer>()
+                   orderby c1.Id, c2.Id
+                   select new { c1, c2 })
+                .Take(50)
+                .Distinct()
+                .Select(x => new { x.c1, x.c2 }),
+            elementSorter: e => (e.c1.Id, e.c2.Id),
+            elementAsserter: (e, a) =>
+            {
+                AssertEqual(e.c1, a.c1);
+                AssertEqual(e.c2, a.c2);
+            });
+
+    [ConditionalTheory]
+    [MemberData(nameof(IsAsyncData))]
+    public virtual Task Project_same_struct_nested_complex_type_twice_with_pushdown(bool async)
+        => AssertQuery(
+            async,
+            ss => (from c1 in ss.Set<ValuedCustomer>()
+                   from c2 in ss.Set<ValuedCustomer>()
+                   select new { BA1 = c1.BillingAddress, BA2 = c2.BillingAddress })
+                .Distinct()
+                .Select(x => new { x.BA1, x.BA2 }),
+            elementSorter: e => (e.BA1.ZipCode, e.BA2.ZipCode),
+            elementAsserter: (e, a) =>
+            {
+                AssertEqual(e.BA1, a.BA1);
+                AssertEqual(e.BA2, a.BA2);
+            });
+
+    [ConditionalTheory]
+    [MemberData(nameof(IsAsyncData))]
+    public virtual Task Project_same_entity_with_struct_nested_complex_type_twice_with_pushdown(bool async)
+        => AssertQuery(
+            async,
+            ss => (from c1 in ss.Set<ValuedCustomer>()
+                   from c2 in ss.Set<ValuedCustomer>()
+                   select new { c1, c2 })
+                .Distinct()
+                .Select(x => new { x.c1, x.c2 }),
+            elementSorter: e => (e.c1.Id, e.c2.Id),
+            elementAsserter: (e, a) =>
+            {
+                AssertEqual(e.c1, a.c1);
+                AssertEqual(e.c2, a.c2);
+            });
+
+    [ConditionalTheory]
+    [MemberData(nameof(IsAsyncData))]
+    public virtual Task Project_same_struct_nested_complex_type_twice_with_double_pushdown(bool async)
+        => AssertQuery(
+            async,
+            ss => (from c1 in ss.Set<ValuedCustomer>()
+                   from c2 in ss.Set<ValuedCustomer>()
+                   orderby c1.Id, c2.Id
+                   select new { BA1 = c1.BillingAddress, BA2 = c2.BillingAddress })
+                .Take(50)
+                .Distinct()
+                .Select(x => new { x.BA1, x.BA2 }),
+            elementSorter: e => (e.BA1.ZipCode, e.BA2.ZipCode),
+            elementAsserter: (e, a) =>
+            {
+                AssertEqual(e.BA1, a.BA1);
+                AssertEqual(e.BA2, a.BA2);
+            });
+
+    [ConditionalTheory]
+    [MemberData(nameof(IsAsyncData))]
+    public virtual Task Project_same_entity_with_struct_nested_complex_type_twice_with_double_pushdown(bool async)
+        => AssertQuery(
+            async,
+            ss => (from c1 in ss.Set<ValuedCustomer>()
+                   from c2 in ss.Set<ValuedCustomer>()
+                   orderby c1.Id, c2.Id
+                   select new { c1, c2 })
+                .Take(50)
+                .Distinct()
+                .Select(x => new { x.c1, x.c2 }),
+            elementSorter: e => (e.c1.Id, e.c2.Id),
+            elementAsserter: (e, a) =>
+            {
+                AssertEqual(e.c1, a.c1);
+                AssertEqual(e.c2, a.c2);
+            });
+
+    [ConditionalTheory]
+    [MemberData(nameof(IsAsyncData))]
+    public virtual Task Union_of_same_entity_with_nested_complex_type_projected_twice_with_pushdown(bool async)
+        => AssertQuery(
+            async,
+            ss => (from c1 in ss.Set<Customer>()
+                   from c2 in ss.Set<Customer>()
+                   orderby c1.Id, c2.Id
+                   select new { c1, c2 })
+                .Union(from c1 in ss.Set<Customer>()
+                       from c2 in ss.Set<Customer>()
+                       orderby c1.Id, c2.Id
+                       select new { c1, c2 })
+                .OrderBy(x => x.c1.Id).ThenBy(x => x.c2.Id)
+                .Take(50)
+                .Select(x => new { x.c1, x.c2 }),
+            assertOrder: true,
+            elementAsserter: (e, a) =>
+            {
+                AssertEqual(e.c1, a.c1);
+                AssertEqual(e.c2, a.c2);
+            });
+
+    [ConditionalTheory]
+    [MemberData(nameof(IsAsyncData))]
+    public virtual Task Union_of_same_entity_with_nested_complex_type_projected_twice_with_double_pushdown(bool async)
+        => AssertQuery(
+            async,
+            ss => (from c1 in ss.Set<Customer>()
+                   from c2 in ss.Set<Customer>()
+                   orderby c1.Id, c2.Id
+                   select new { c1, c2 })
+                .Union(from c1 in ss.Set<Customer>()
+                       from c2 in ss.Set<Customer>()
+                       orderby c1.Id, c2.Id
+                       select new { c1, c2 })
+                .OrderBy(x => x.c1.Id).ThenBy(x => x.c2.Id)
+                .Take(50)
+                .Select(x => new { x.c1, x.c2 })
+                .Distinct()
+                .OrderBy(x => x.c1.Id).ThenBy(x => x.c2.Id)
+                .Take(50)
+                .Select(x => new { x.c1, x.c2 }),
+            assertOrder: true,
+            elementAsserter: (e, a) =>
+            {
+                AssertEqual(e.c1, a.c1);
+                AssertEqual(e.c2, a.c2);
+            });
+
+    [ConditionalTheory]
+    [MemberData(nameof(IsAsyncData))]
+    public virtual Task Union_of_same_nested_complex_type_projected_twice_with_pushdown(bool async)
+        => AssertQuery(
+            async,
+            ss => (from c1 in ss.Set<Customer>()
+                   from c2 in ss.Set<Customer>()
+                   orderby c1.Id, c2.Id
+                   select new { BA1 = c1.BillingAddress, BA2 = c2.BillingAddress })
+                .Union(from c1 in ss.Set<Customer>()
+                       from c2 in ss.Set<Customer>()
+                       orderby c1.Id, c2.Id
+                       select new { BA1 = c1.BillingAddress, BA2 = c2.BillingAddress })
+                .OrderBy(x => x.BA1.ZipCode).ThenBy(x => x.BA2.ZipCode)
+                .Take(50)
+                .Select(x => new { x.BA1, x.BA2 }),
+            assertOrder: true,
+            elementAsserter: (e, a) =>
+            {
+                AssertEqual(e.BA1, a.BA1);
+                AssertEqual(e.BA2, a.BA2);
+            });
+
+    [ConditionalTheory]
+    [MemberData(nameof(IsAsyncData))]
+    public virtual Task Union_of_same_nested_complex_type_projected_twice_with_double_pushdown(bool async)
+        => AssertQuery(
+            async,
+            ss => (from c1 in ss.Set<Customer>()
+                   from c2 in ss.Set<Customer>()
+                   orderby c1.Id, c2.Id
+                   select new { BA1 = c1.BillingAddress, BA2 = c2.BillingAddress })
+                .Union(from c1 in ss.Set<Customer>()
+                       from c2 in ss.Set<Customer>()
+                       orderby c1.Id, c2.Id
+                       select new { BA1 = c1.BillingAddress, BA2 = c2.BillingAddress })
+                .OrderBy(x => x.BA1.ZipCode).ThenBy(x => x.BA2.ZipCode)
+                .Take(50)
+                .Select(x => new { x.BA1, x.BA2 })
+                .Distinct()
+                .OrderBy(x => x.BA1.ZipCode).ThenBy(x => x.BA2.ZipCode)
+                .Take(50)
+                .Select(x => new { x.BA1, x.BA2 }),
+            assertOrder: true,
+            elementAsserter: (e, a) =>
+            {
+                AssertEqual(e.BA1, a.BA1);
+                AssertEqual(e.BA2, a.BA2);
+            });
+
+    [ConditionalTheory]
+    [MemberData(nameof(IsAsyncData))]
+    public virtual Task Same_entity_with_complex_type_projected_twice_with_pushdown_as_part_of_another_projection(bool async)
+        => AssertQuery(
+            async,
+            ss => ss.Set<Customer>().Select(x => new
+            {
+                x.Id,
+                Complex = (from c1 in ss.Set<Customer>()
+                           from c2 in ss.Set<Customer>()
+                           orderby c1.Id, c2.Id descending
+                           select new { One = c1, Two = c2 }).FirstOrDefault()
+            }),
+            elementSorter: e => e.Id,
+            elementAsserter: (e, a) =>
+            {
+                AssertEqual(e.Id, a.Id);
+                AssertEqual(e.Complex?.One, a.Complex?.One);
+                AssertEqual(e.Complex?.Two, a.Complex?.Two);
+            });
+
+    [ConditionalTheory(Skip = "issue #31376")]
+    [MemberData(nameof(IsAsyncData))]
+    public virtual Task Same_complex_type_projected_twice_with_pushdown_as_part_of_another_projection(bool async)
+        => AssertQuery(
+            async,
+            ss => ss.Set<Customer>().Select(x => new
+            {
+                x.Id,
+                Complex = (from c1 in ss.Set<Customer>()
+                           from c2 in ss.Set<Customer>()
+                           orderby c1.Id, c2.Id descending
+                           select new { One = c1.BillingAddress, Two = c2.BillingAddress }).FirstOrDefault()
+            }),
+            elementSorter: e => e.Id,
+            elementAsserter: (e, a) =>
+            {
+                AssertEqual(e.Id, a.Id);
+                AssertEqual(e.Complex?.One, a.Complex?.One);
+                AssertEqual(e.Complex?.Two, a.Complex?.Two);
+            });
+
     protected DbContext CreateContext()
         => Fixture.CreateContext();
 }
diff --git a/test/EFCore.SqlServer.FunctionalTests/Query/AdHocAdvancedMappingsQuerySqlServerTest.cs b/test/EFCore.SqlServer.FunctionalTests/Query/AdHocAdvancedMappingsQuerySqlServerTest.cs
new file mode 100644
index 0000000000..122d76763b
--- /dev/null
+++ b/test/EFCore.SqlServer.FunctionalTests/Query/AdHocAdvancedMappingsQuerySqlServerTest.cs
@@ -0,0 +1,82 @@
+﻿// Licensed to the .NET Foundation under one or more agreements.
+// The .NET Foundation licenses this file to you under the MIT license.
+
+namespace Microsoft.EntityFrameworkCore.Query;
+
+public class AdHocAdvancedMappingsQuerySqlServerTest : AdHocAdvancedMappingsQueryRelationalTestBase
+{
+    protected override ITestStoreFactory TestStoreFactory
+        => SqlServerTestStoreFactory.Instance;
+
+    public override async Task Two_similar_complex_properties_projected_with_split_query1()
+    {
+        await base.Two_similar_complex_properties_projected_with_split_query1();
+
+        AssertSql(
+"""
+SELECT [o].[Id]
+FROM [Offers] AS [o]
+ORDER BY [o].[Id]
+""",
+                //
+                """
+SELECT [t].[Id], [t].[NestedId], [t].[OfferId], [t].[payment_brutto], [t].[payment_netto], [t].[Id0], [t].[payment_brutto0], [t].[payment_netto0], [o].[Id]
+FROM [Offers] AS [o]
+INNER JOIN (
+    SELECT [v].[Id], [v].[NestedId], [v].[OfferId], [v].[payment_brutto], [v].[payment_netto], [n].[Id] AS [Id0], [n].[payment_brutto] AS [payment_brutto0], [n].[payment_netto] AS [payment_netto0]
+    FROM [Variation] AS [v]
+    LEFT JOIN [NestedEntity] AS [n] ON [v].[NestedId] = [n].[Id]
+) AS [t] ON [o].[Id] = [t].[OfferId]
+ORDER BY [o].[Id]
+""");
+    }
+
+    public override async Task Two_similar_complex_properties_projected_with_split_query2()
+    {
+        await base.Two_similar_complex_properties_projected_with_split_query2();
+
+        AssertSql(
+"""
+SELECT TOP(2) [o].[Id]
+FROM [Offers] AS [o]
+WHERE [o].[Id] = 1
+ORDER BY [o].[Id]
+""",
+                //
+                """
+SELECT [t0].[Id], [t0].[NestedId], [t0].[OfferId], [t0].[payment_brutto], [t0].[payment_netto], [t0].[Id0], [t0].[payment_brutto0], [t0].[payment_netto0], [t].[Id]
+FROM (
+    SELECT TOP(1) [o].[Id]
+    FROM [Offers] AS [o]
+    WHERE [o].[Id] = 1
+) AS [t]
+INNER JOIN (
+    SELECT [v].[Id], [v].[NestedId], [v].[OfferId], [v].[payment_brutto], [v].[payment_netto], [n].[Id] AS [Id0], [n].[payment_brutto] AS [payment_brutto0], [n].[payment_netto] AS [payment_netto0]
+    FROM [Variation] AS [v]
+    LEFT JOIN [NestedEntity] AS [n] ON [v].[NestedId] = [n].[Id]
+) AS [t0] ON [t].[Id] = [t0].[OfferId]
+ORDER BY [t].[Id]
+""");
+    }
+
+    public override async Task Projecting_one_of_two_similar_complex_types_picks_the_correct_one()
+    {
+        await base.Projecting_one_of_two_similar_complex_types_picks_the_correct_one();
+
+        AssertSql(
+"""
+@__p_0='10'
+
+SELECT [a].[Id], [t].[Info_Created0] AS [Created]
+FROM (
+    SELECT TOP(@__p_0) [c].[Id], [b].[AId], [b].[Info_Created] AS [Info_Created0]
+    FROM [Cs] AS [c]
+    INNER JOIN [Bs] AS [b] ON [c].[BId] = [b].[Id]
+    WHERE [b].[AId] = 1
+    ORDER BY [c].[Id]
+) AS [t]
+LEFT JOIN [As] AS [a] ON [t].[AId] = [a].[Id]
+ORDER BY [t].[Id]
+""");
+    }
+}
diff --git a/test/EFCore.SqlServer.FunctionalTests/Query/ComplexTypeQuerySqlServerTest.cs b/test/EFCore.SqlServer.FunctionalTests/Query/ComplexTypeQuerySqlServerTest.cs
index 9c72bf3aeb..cbaf021a01 100644
--- a/test/EFCore.SqlServer.FunctionalTests/Query/ComplexTypeQuerySqlServerTest.cs
+++ b/test/EFCore.SqlServer.FunctionalTests/Query/ComplexTypeQuerySqlServerTest.cs
@@ -858,6 +858,276 @@ public virtual Task Select_complex_type_Distinct_with_FromSql(bool async)
                 """).Select(c => c.ShippingAddress).Distinct(),
             ss => ss.Set<Customer>().Select(c => c.ShippingAddress).Distinct());
 
+    public override async Task Project_same_entity_with_nested_complex_type_twice_with_pushdown(bool async)
+    {
+        await base.Project_same_entity_with_nested_complex_type_twice_with_pushdown(async);
+
+        AssertSql(
+"""
+SELECT [t].[Id], [t].[Name], [t].[BillingAddress_AddressLine1], [t].[BillingAddress_AddressLine2], [t].[BillingAddress_ZipCode], [t].[BillingAddress_Country_Code], [t].[BillingAddress_Country_FullName], [t].[ShippingAddress_AddressLine1], [t].[ShippingAddress_AddressLine2], [t].[ShippingAddress_ZipCode], [t].[ShippingAddress_Country_Code], [t].[ShippingAddress_Country_FullName], [t].[Id0], [t].[Name0], [t].[BillingAddress_AddressLine10], [t].[BillingAddress_AddressLine20], [t].[BillingAddress_ZipCode0], [t].[BillingAddress_Country_Code0], [t].[BillingAddress_Country_FullName0], [t].[ShippingAddress_AddressLine10], [t].[ShippingAddress_AddressLine20], [t].[ShippingAddress_ZipCode0], [t].[ShippingAddress_Country_Code0], [t].[ShippingAddress_Country_FullName0]
+FROM (
+    SELECT DISTINCT [c].[Id], [c].[Name], [c].[BillingAddress_AddressLine1], [c].[BillingAddress_AddressLine2], [c].[BillingAddress_ZipCode], [c].[BillingAddress_Country_Code], [c].[BillingAddress_Country_FullName], [c].[ShippingAddress_AddressLine1], [c].[ShippingAddress_AddressLine2], [c].[ShippingAddress_ZipCode], [c].[ShippingAddress_Country_Code], [c].[ShippingAddress_Country_FullName], [c0].[Id] AS [Id0], [c0].[Name] AS [Name0], [c0].[BillingAddress_AddressLine1] AS [BillingAddress_AddressLine10], [c0].[BillingAddress_AddressLine2] AS [BillingAddress_AddressLine20], [c0].[BillingAddress_ZipCode] AS [BillingAddress_ZipCode0], [c0].[BillingAddress_Country_Code] AS [BillingAddress_Country_Code0], [c0].[BillingAddress_Country_FullName] AS [BillingAddress_Country_FullName0], [c0].[ShippingAddress_AddressLine1] AS [ShippingAddress_AddressLine10], [c0].[ShippingAddress_AddressLine2] AS [ShippingAddress_AddressLine20], [c0].[ShippingAddress_ZipCode] AS [ShippingAddress_ZipCode0], [c0].[ShippingAddress_Country_Code] AS [ShippingAddress_Country_Code0], [c0].[ShippingAddress_Country_FullName] AS [ShippingAddress_Country_FullName0]
+    FROM [Customer] AS [c]
+    CROSS JOIN [Customer] AS [c0]
+) AS [t]
+""");
+    }
+
+    public override async Task Project_same_nested_complex_type_twice_with_pushdown(bool async)
+    {
+        await base.Project_same_nested_complex_type_twice_with_pushdown(async);
+
+        AssertSql(
+"""
+SELECT [t].[BillingAddress_AddressLine1], [t].[BillingAddress_AddressLine2], [t].[BillingAddress_ZipCode], [t].[BillingAddress_Country_Code], [t].[BillingAddress_Country_FullName], [t].[BillingAddress_AddressLine10], [t].[BillingAddress_AddressLine20], [t].[BillingAddress_ZipCode0], [t].[BillingAddress_Country_Code0], [t].[BillingAddress_Country_FullName0]
+FROM (
+    SELECT DISTINCT [c].[BillingAddress_AddressLine1], [c].[BillingAddress_AddressLine2], [c].[BillingAddress_ZipCode], [c].[BillingAddress_Country_Code], [c].[BillingAddress_Country_FullName], [c0].[BillingAddress_AddressLine1] AS [BillingAddress_AddressLine10], [c0].[BillingAddress_AddressLine2] AS [BillingAddress_AddressLine20], [c0].[BillingAddress_ZipCode] AS [BillingAddress_ZipCode0], [c0].[BillingAddress_Country_Code] AS [BillingAddress_Country_Code0], [c0].[BillingAddress_Country_FullName] AS [BillingAddress_Country_FullName0]
+    FROM [Customer] AS [c]
+    CROSS JOIN [Customer] AS [c0]
+) AS [t]
+""");
+    }
+
+    public override async Task Project_same_entity_with_nested_complex_type_twice_with_double_pushdown(bool async)
+    {
+        await base.Project_same_entity_with_nested_complex_type_twice_with_double_pushdown(async);
+
+        AssertSql(
+"""
+@__p_0='50'
+
+SELECT [t0].[Id], [t0].[Name], [t0].[BillingAddress_AddressLine1], [t0].[BillingAddress_AddressLine2], [t0].[BillingAddress_ZipCode], [t0].[BillingAddress_Country_Code], [t0].[BillingAddress_Country_FullName], [t0].[ShippingAddress_AddressLine1], [t0].[ShippingAddress_AddressLine2], [t0].[ShippingAddress_ZipCode], [t0].[ShippingAddress_Country_Code], [t0].[ShippingAddress_Country_FullName], [t0].[Id0], [t0].[Name0], [t0].[BillingAddress_AddressLine10], [t0].[BillingAddress_AddressLine20], [t0].[BillingAddress_ZipCode0], [t0].[BillingAddress_Country_Code0], [t0].[BillingAddress_Country_FullName0], [t0].[ShippingAddress_AddressLine10], [t0].[ShippingAddress_AddressLine20], [t0].[ShippingAddress_ZipCode0], [t0].[ShippingAddress_Country_Code0], [t0].[ShippingAddress_Country_FullName0]
+FROM (
+    SELECT DISTINCT [t].[Id], [t].[Name], [t].[BillingAddress_AddressLine1], [t].[BillingAddress_AddressLine2], [t].[BillingAddress_ZipCode], [t].[BillingAddress_Country_Code], [t].[BillingAddress_Country_FullName], [t].[ShippingAddress_AddressLine1], [t].[ShippingAddress_AddressLine2], [t].[ShippingAddress_ZipCode], [t].[ShippingAddress_Country_Code], [t].[ShippingAddress_Country_FullName], [t].[Id0], [t].[Name0], [t].[BillingAddress_AddressLine10], [t].[BillingAddress_AddressLine20], [t].[BillingAddress_ZipCode0], [t].[BillingAddress_Country_Code0], [t].[BillingAddress_Country_FullName0], [t].[ShippingAddress_AddressLine10], [t].[ShippingAddress_AddressLine20], [t].[ShippingAddress_ZipCode0], [t].[ShippingAddress_Country_Code0], [t].[ShippingAddress_Country_FullName0]
+    FROM (
+        SELECT TOP(@__p_0) [c].[Id], [c].[Name], [c].[BillingAddress_AddressLine1], [c].[BillingAddress_AddressLine2], [c].[BillingAddress_ZipCode], [c].[BillingAddress_Country_Code], [c].[BillingAddress_Country_FullName], [c].[ShippingAddress_AddressLine1], [c].[ShippingAddress_AddressLine2], [c].[ShippingAddress_ZipCode], [c].[ShippingAddress_Country_Code], [c].[ShippingAddress_Country_FullName], [c0].[Id] AS [Id0], [c0].[Name] AS [Name0], [c0].[BillingAddress_AddressLine1] AS [BillingAddress_AddressLine10], [c0].[BillingAddress_AddressLine2] AS [BillingAddress_AddressLine20], [c0].[BillingAddress_ZipCode] AS [BillingAddress_ZipCode0], [c0].[BillingAddress_Country_Code] AS [BillingAddress_Country_Code0], [c0].[BillingAddress_Country_FullName] AS [BillingAddress_Country_FullName0], [c0].[ShippingAddress_AddressLine1] AS [ShippingAddress_AddressLine10], [c0].[ShippingAddress_AddressLine2] AS [ShippingAddress_AddressLine20], [c0].[ShippingAddress_ZipCode] AS [ShippingAddress_ZipCode0], [c0].[ShippingAddress_Country_Code] AS [ShippingAddress_Country_Code0], [c0].[ShippingAddress_Country_FullName] AS [ShippingAddress_Country_FullName0]
+        FROM [Customer] AS [c]
+        CROSS JOIN [Customer] AS [c0]
+        ORDER BY [c].[Id], [c0].[Id]
+    ) AS [t]
+) AS [t0]
+""");
+    }
+
+    public override async Task Project_same_nested_complex_type_twice_with_double_pushdown(bool async)
+    {
+        await base.Project_same_nested_complex_type_twice_with_double_pushdown(async);
+
+        AssertSql(
+"""
+@__p_0='50'
+
+SELECT [t0].[BillingAddress_AddressLine1], [t0].[BillingAddress_AddressLine2], [t0].[BillingAddress_ZipCode], [t0].[BillingAddress_Country_Code], [t0].[BillingAddress_Country_FullName], [t0].[BillingAddress_AddressLine10], [t0].[BillingAddress_AddressLine20], [t0].[BillingAddress_ZipCode0], [t0].[BillingAddress_Country_Code0], [t0].[BillingAddress_Country_FullName0]
+FROM (
+    SELECT DISTINCT [t].[BillingAddress_AddressLine1], [t].[BillingAddress_AddressLine2], [t].[BillingAddress_ZipCode], [t].[BillingAddress_Country_Code], [t].[BillingAddress_Country_FullName], [t].[BillingAddress_AddressLine10], [t].[BillingAddress_AddressLine20], [t].[BillingAddress_ZipCode0], [t].[BillingAddress_Country_Code0], [t].[BillingAddress_Country_FullName0]
+    FROM (
+        SELECT TOP(@__p_0) [c].[BillingAddress_AddressLine1], [c].[BillingAddress_AddressLine2], [c].[BillingAddress_ZipCode], [c].[BillingAddress_Country_Code], [c].[BillingAddress_Country_FullName], [c0].[BillingAddress_AddressLine1] AS [BillingAddress_AddressLine10], [c0].[BillingAddress_AddressLine2] AS [BillingAddress_AddressLine20], [c0].[BillingAddress_ZipCode] AS [BillingAddress_ZipCode0], [c0].[BillingAddress_Country_Code] AS [BillingAddress_Country_Code0], [c0].[BillingAddress_Country_FullName] AS [BillingAddress_Country_FullName0]
+        FROM [Customer] AS [c]
+        CROSS JOIN [Customer] AS [c0]
+        ORDER BY [c].[Id], [c0].[Id]
+    ) AS [t]
+) AS [t0]
+""");
+    }
+
+    public override async Task Project_same_entity_with_struct_nested_complex_type_twice_with_pushdown(bool async)
+    {
+        await base.Project_same_entity_with_struct_nested_complex_type_twice_with_pushdown(async);
+
+        AssertSql(
+"""
+SELECT [t].[Id], [t].[Name], [t].[BillingAddress_AddressLine1], [t].[BillingAddress_AddressLine2], [t].[BillingAddress_ZipCode], [t].[BillingAddress_Country_Code], [t].[BillingAddress_Country_FullName], [t].[ShippingAddress_AddressLine1], [t].[ShippingAddress_AddressLine2], [t].[ShippingAddress_ZipCode], [t].[ShippingAddress_Country_Code], [t].[ShippingAddress_Country_FullName], [t].[Id0], [t].[Name0], [t].[BillingAddress_AddressLine10], [t].[BillingAddress_AddressLine20], [t].[BillingAddress_ZipCode0], [t].[BillingAddress_Country_Code0], [t].[BillingAddress_Country_FullName0], [t].[ShippingAddress_AddressLine10], [t].[ShippingAddress_AddressLine20], [t].[ShippingAddress_ZipCode0], [t].[ShippingAddress_Country_Code0], [t].[ShippingAddress_Country_FullName0]
+FROM (
+    SELECT DISTINCT [v].[Id], [v].[Name], [v].[BillingAddress_AddressLine1], [v].[BillingAddress_AddressLine2], [v].[BillingAddress_ZipCode], [v].[BillingAddress_Country_Code], [v].[BillingAddress_Country_FullName], [v].[ShippingAddress_AddressLine1], [v].[ShippingAddress_AddressLine2], [v].[ShippingAddress_ZipCode], [v].[ShippingAddress_Country_Code], [v].[ShippingAddress_Country_FullName], [v0].[Id] AS [Id0], [v0].[Name] AS [Name0], [v0].[BillingAddress_AddressLine1] AS [BillingAddress_AddressLine10], [v0].[BillingAddress_AddressLine2] AS [BillingAddress_AddressLine20], [v0].[BillingAddress_ZipCode] AS [BillingAddress_ZipCode0], [v0].[BillingAddress_Country_Code] AS [BillingAddress_Country_Code0], [v0].[BillingAddress_Country_FullName] AS [BillingAddress_Country_FullName0], [v0].[ShippingAddress_AddressLine1] AS [ShippingAddress_AddressLine10], [v0].[ShippingAddress_AddressLine2] AS [ShippingAddress_AddressLine20], [v0].[ShippingAddress_ZipCode] AS [ShippingAddress_ZipCode0], [v0].[ShippingAddress_Country_Code] AS [ShippingAddress_Country_Code0], [v0].[ShippingAddress_Country_FullName] AS [ShippingAddress_Country_FullName0]
+    FROM [ValuedCustomer] AS [v]
+    CROSS JOIN [ValuedCustomer] AS [v0]
+) AS [t]
+""");
+    }
+
+    public override async Task Project_same_struct_nested_complex_type_twice_with_pushdown(bool async)
+    {
+        await base.Project_same_struct_nested_complex_type_twice_with_pushdown(async);
+
+        AssertSql(
+"""
+SELECT [t].[BillingAddress_AddressLine1], [t].[BillingAddress_AddressLine2], [t].[BillingAddress_ZipCode], [t].[BillingAddress_Country_Code], [t].[BillingAddress_Country_FullName], [t].[BillingAddress_AddressLine10], [t].[BillingAddress_AddressLine20], [t].[BillingAddress_ZipCode0], [t].[BillingAddress_Country_Code0], [t].[BillingAddress_Country_FullName0]
+FROM (
+    SELECT DISTINCT [v].[BillingAddress_AddressLine1], [v].[BillingAddress_AddressLine2], [v].[BillingAddress_ZipCode], [v].[BillingAddress_Country_Code], [v].[BillingAddress_Country_FullName], [v0].[BillingAddress_AddressLine1] AS [BillingAddress_AddressLine10], [v0].[BillingAddress_AddressLine2] AS [BillingAddress_AddressLine20], [v0].[BillingAddress_ZipCode] AS [BillingAddress_ZipCode0], [v0].[BillingAddress_Country_Code] AS [BillingAddress_Country_Code0], [v0].[BillingAddress_Country_FullName] AS [BillingAddress_Country_FullName0]
+    FROM [ValuedCustomer] AS [v]
+    CROSS JOIN [ValuedCustomer] AS [v0]
+) AS [t]
+""");
+    }
+
+    public override async Task Project_same_entity_with_struct_nested_complex_type_twice_with_double_pushdown(bool async)
+    {
+        await base.Project_same_entity_with_struct_nested_complex_type_twice_with_double_pushdown(async);
+
+        AssertSql(
+"""
+@__p_0='50'
+
+SELECT [t0].[Id], [t0].[Name], [t0].[BillingAddress_AddressLine1], [t0].[BillingAddress_AddressLine2], [t0].[BillingAddress_ZipCode], [t0].[BillingAddress_Country_Code], [t0].[BillingAddress_Country_FullName], [t0].[ShippingAddress_AddressLine1], [t0].[ShippingAddress_AddressLine2], [t0].[ShippingAddress_ZipCode], [t0].[ShippingAddress_Country_Code], [t0].[ShippingAddress_Country_FullName], [t0].[Id0], [t0].[Name0], [t0].[BillingAddress_AddressLine10], [t0].[BillingAddress_AddressLine20], [t0].[BillingAddress_ZipCode0], [t0].[BillingAddress_Country_Code0], [t0].[BillingAddress_Country_FullName0], [t0].[ShippingAddress_AddressLine10], [t0].[ShippingAddress_AddressLine20], [t0].[ShippingAddress_ZipCode0], [t0].[ShippingAddress_Country_Code0], [t0].[ShippingAddress_Country_FullName0]
+FROM (
+    SELECT DISTINCT [t].[Id], [t].[Name], [t].[BillingAddress_AddressLine1], [t].[BillingAddress_AddressLine2], [t].[BillingAddress_ZipCode], [t].[BillingAddress_Country_Code], [t].[BillingAddress_Country_FullName], [t].[ShippingAddress_AddressLine1], [t].[ShippingAddress_AddressLine2], [t].[ShippingAddress_ZipCode], [t].[ShippingAddress_Country_Code], [t].[ShippingAddress_Country_FullName], [t].[Id0], [t].[Name0], [t].[BillingAddress_AddressLine10], [t].[BillingAddress_AddressLine20], [t].[BillingAddress_ZipCode0], [t].[BillingAddress_Country_Code0], [t].[BillingAddress_Country_FullName0], [t].[ShippingAddress_AddressLine10], [t].[ShippingAddress_AddressLine20], [t].[ShippingAddress_ZipCode0], [t].[ShippingAddress_Country_Code0], [t].[ShippingAddress_Country_FullName0]
+    FROM (
+        SELECT TOP(@__p_0) [v].[Id], [v].[Name], [v].[BillingAddress_AddressLine1], [v].[BillingAddress_AddressLine2], [v].[BillingAddress_ZipCode], [v].[BillingAddress_Country_Code], [v].[BillingAddress_Country_FullName], [v].[ShippingAddress_AddressLine1], [v].[ShippingAddress_AddressLine2], [v].[ShippingAddress_ZipCode], [v].[ShippingAddress_Country_Code], [v].[ShippingAddress_Country_FullName], [v0].[Id] AS [Id0], [v0].[Name] AS [Name0], [v0].[BillingAddress_AddressLine1] AS [BillingAddress_AddressLine10], [v0].[BillingAddress_AddressLine2] AS [BillingAddress_AddressLine20], [v0].[BillingAddress_ZipCode] AS [BillingAddress_ZipCode0], [v0].[BillingAddress_Country_Code] AS [BillingAddress_Country_Code0], [v0].[BillingAddress_Country_FullName] AS [BillingAddress_Country_FullName0], [v0].[ShippingAddress_AddressLine1] AS [ShippingAddress_AddressLine10], [v0].[ShippingAddress_AddressLine2] AS [ShippingAddress_AddressLine20], [v0].[ShippingAddress_ZipCode] AS [ShippingAddress_ZipCode0], [v0].[ShippingAddress_Country_Code] AS [ShippingAddress_Country_Code0], [v0].[ShippingAddress_Country_FullName] AS [ShippingAddress_Country_FullName0]
+        FROM [ValuedCustomer] AS [v]
+        CROSS JOIN [ValuedCustomer] AS [v0]
+        ORDER BY [v].[Id], [v0].[Id]
+    ) AS [t]
+) AS [t0]
+""");
+    }
+
+    public override async Task Project_same_struct_nested_complex_type_twice_with_double_pushdown(bool async)
+    {
+        await base.Project_same_struct_nested_complex_type_twice_with_double_pushdown(async);
+
+        AssertSql(
+"""
+@__p_0='50'
+
+SELECT [t0].[BillingAddress_AddressLine1], [t0].[BillingAddress_AddressLine2], [t0].[BillingAddress_ZipCode], [t0].[BillingAddress_Country_Code], [t0].[BillingAddress_Country_FullName], [t0].[BillingAddress_AddressLine10], [t0].[BillingAddress_AddressLine20], [t0].[BillingAddress_ZipCode0], [t0].[BillingAddress_Country_Code0], [t0].[BillingAddress_Country_FullName0]
+FROM (
+    SELECT DISTINCT [t].[BillingAddress_AddressLine1], [t].[BillingAddress_AddressLine2], [t].[BillingAddress_ZipCode], [t].[BillingAddress_Country_Code], [t].[BillingAddress_Country_FullName], [t].[BillingAddress_AddressLine10], [t].[BillingAddress_AddressLine20], [t].[BillingAddress_ZipCode0], [t].[BillingAddress_Country_Code0], [t].[BillingAddress_Country_FullName0]
+    FROM (
+        SELECT TOP(@__p_0) [v].[BillingAddress_AddressLine1], [v].[BillingAddress_AddressLine2], [v].[BillingAddress_ZipCode], [v].[BillingAddress_Country_Code], [v].[BillingAddress_Country_FullName], [v0].[BillingAddress_AddressLine1] AS [BillingAddress_AddressLine10], [v0].[BillingAddress_AddressLine2] AS [BillingAddress_AddressLine20], [v0].[BillingAddress_ZipCode] AS [BillingAddress_ZipCode0], [v0].[BillingAddress_Country_Code] AS [BillingAddress_Country_Code0], [v0].[BillingAddress_Country_FullName] AS [BillingAddress_Country_FullName0]
+        FROM [ValuedCustomer] AS [v]
+        CROSS JOIN [ValuedCustomer] AS [v0]
+        ORDER BY [v].[Id], [v0].[Id]
+    ) AS [t]
+) AS [t0]
+""");
+    }
+
+    public override async Task Union_of_same_entity_with_nested_complex_type_projected_twice_with_pushdown(bool async)
+    {
+        await base.Union_of_same_entity_with_nested_complex_type_projected_twice_with_pushdown(async);
+
+        AssertSql(
+"""
+@__p_0='50'
+
+SELECT TOP(@__p_0) [t].[Id], [t].[Name], [t].[BillingAddress_AddressLine1], [t].[BillingAddress_AddressLine2], [t].[BillingAddress_ZipCode], [t].[BillingAddress_Country_Code], [t].[BillingAddress_Country_FullName], [t].[ShippingAddress_AddressLine1], [t].[ShippingAddress_AddressLine2], [t].[ShippingAddress_ZipCode], [t].[ShippingAddress_Country_Code], [t].[ShippingAddress_Country_FullName], [t].[Id0], [t].[Name0], [t].[BillingAddress_AddressLine10], [t].[BillingAddress_AddressLine20], [t].[BillingAddress_ZipCode0], [t].[BillingAddress_Country_Code0], [t].[BillingAddress_Country_FullName0], [t].[ShippingAddress_AddressLine10], [t].[ShippingAddress_AddressLine20], [t].[ShippingAddress_ZipCode0], [t].[ShippingAddress_Country_Code0], [t].[ShippingAddress_Country_FullName0]
+FROM (
+    SELECT [c].[Id], [c].[Name], [c].[BillingAddress_AddressLine1], [c].[BillingAddress_AddressLine2], [c].[BillingAddress_ZipCode], [c].[BillingAddress_Country_Code], [c].[BillingAddress_Country_FullName], [c].[ShippingAddress_AddressLine1], [c].[ShippingAddress_AddressLine2], [c].[ShippingAddress_ZipCode], [c].[ShippingAddress_Country_Code], [c].[ShippingAddress_Country_FullName], [c0].[Id] AS [Id0], [c0].[Name] AS [Name0], [c0].[BillingAddress_AddressLine1] AS [BillingAddress_AddressLine10], [c0].[BillingAddress_AddressLine2] AS [BillingAddress_AddressLine20], [c0].[BillingAddress_ZipCode] AS [BillingAddress_ZipCode0], [c0].[BillingAddress_Country_Code] AS [BillingAddress_Country_Code0], [c0].[BillingAddress_Country_FullName] AS [BillingAddress_Country_FullName0], [c0].[ShippingAddress_AddressLine1] AS [ShippingAddress_AddressLine10], [c0].[ShippingAddress_AddressLine2] AS [ShippingAddress_AddressLine20], [c0].[ShippingAddress_ZipCode] AS [ShippingAddress_ZipCode0], [c0].[ShippingAddress_Country_Code] AS [ShippingAddress_Country_Code0], [c0].[ShippingAddress_Country_FullName] AS [ShippingAddress_Country_FullName0]
+    FROM [Customer] AS [c]
+    CROSS JOIN [Customer] AS [c0]
+    UNION
+    SELECT [c1].[Id], [c1].[Name], [c1].[BillingAddress_AddressLine1], [c1].[BillingAddress_AddressLine2], [c1].[BillingAddress_ZipCode], [c1].[BillingAddress_Country_Code], [c1].[BillingAddress_Country_FullName], [c1].[ShippingAddress_AddressLine1], [c1].[ShippingAddress_AddressLine2], [c1].[ShippingAddress_ZipCode], [c1].[ShippingAddress_Country_Code], [c1].[ShippingAddress_Country_FullName], [c2].[Id] AS [Id0], [c2].[Name] AS [Name0], [c2].[BillingAddress_AddressLine1] AS [BillingAddress_AddressLine10], [c2].[BillingAddress_AddressLine2] AS [BillingAddress_AddressLine20], [c2].[BillingAddress_ZipCode] AS [BillingAddress_ZipCode0], [c2].[BillingAddress_Country_Code] AS [BillingAddress_Country_Code0], [c2].[BillingAddress_Country_FullName] AS [BillingAddress_Country_FullName0], [c2].[ShippingAddress_AddressLine1] AS [ShippingAddress_AddressLine10], [c2].[ShippingAddress_AddressLine2] AS [ShippingAddress_AddressLine20], [c2].[ShippingAddress_ZipCode] AS [ShippingAddress_ZipCode0], [c2].[ShippingAddress_Country_Code] AS [ShippingAddress_Country_Code0], [c2].[ShippingAddress_Country_FullName] AS [ShippingAddress_Country_FullName0]
+    FROM [Customer] AS [c1]
+    CROSS JOIN [Customer] AS [c2]
+) AS [t]
+ORDER BY [t].[Id], [t].[Id0]
+""");
+    }
+
+    public override async Task Union_of_same_entity_with_nested_complex_type_projected_twice_with_double_pushdown(bool async)
+    {
+        await base.Union_of_same_entity_with_nested_complex_type_projected_twice_with_double_pushdown(async);
+
+        AssertSql(
+"""
+@__p_0='50'
+
+SELECT TOP(@__p_0) [t1].[Id], [t1].[Name], [t1].[BillingAddress_AddressLine1], [t1].[BillingAddress_AddressLine2], [t1].[BillingAddress_ZipCode], [t1].[BillingAddress_Country_Code], [t1].[BillingAddress_Country_FullName], [t1].[ShippingAddress_AddressLine1], [t1].[ShippingAddress_AddressLine2], [t1].[ShippingAddress_ZipCode], [t1].[ShippingAddress_Country_Code], [t1].[ShippingAddress_Country_FullName], [t1].[Id0], [t1].[Name0], [t1].[BillingAddress_AddressLine10], [t1].[BillingAddress_AddressLine20], [t1].[BillingAddress_ZipCode0], [t1].[BillingAddress_Country_Code0], [t1].[BillingAddress_Country_FullName0], [t1].[ShippingAddress_AddressLine10], [t1].[ShippingAddress_AddressLine20], [t1].[ShippingAddress_ZipCode0], [t1].[ShippingAddress_Country_Code0], [t1].[ShippingAddress_Country_FullName0]
+FROM (
+    SELECT DISTINCT [t0].[Id], [t0].[Name], [t0].[BillingAddress_AddressLine1], [t0].[BillingAddress_AddressLine2], [t0].[BillingAddress_ZipCode], [t0].[BillingAddress_Country_Code], [t0].[BillingAddress_Country_FullName], [t0].[ShippingAddress_AddressLine1], [t0].[ShippingAddress_AddressLine2], [t0].[ShippingAddress_ZipCode], [t0].[ShippingAddress_Country_Code], [t0].[ShippingAddress_Country_FullName], [t0].[Id0], [t0].[Name0], [t0].[BillingAddress_AddressLine10], [t0].[BillingAddress_AddressLine20], [t0].[BillingAddress_ZipCode0], [t0].[BillingAddress_Country_Code0], [t0].[BillingAddress_Country_FullName0], [t0].[ShippingAddress_AddressLine10], [t0].[ShippingAddress_AddressLine20], [t0].[ShippingAddress_ZipCode0], [t0].[ShippingAddress_Country_Code0], [t0].[ShippingAddress_Country_FullName0]
+    FROM (
+        SELECT TOP(@__p_0) [t].[Id], [t].[Name], [t].[BillingAddress_AddressLine1], [t].[BillingAddress_AddressLine2], [t].[BillingAddress_ZipCode], [t].[BillingAddress_Country_Code], [t].[BillingAddress_Country_FullName], [t].[ShippingAddress_AddressLine1], [t].[ShippingAddress_AddressLine2], [t].[ShippingAddress_ZipCode], [t].[ShippingAddress_Country_Code], [t].[ShippingAddress_Country_FullName], [t].[Id0], [t].[Name0], [t].[BillingAddress_AddressLine10], [t].[BillingAddress_AddressLine20], [t].[BillingAddress_ZipCode0], [t].[BillingAddress_Country_Code0], [t].[BillingAddress_Country_FullName0], [t].[ShippingAddress_AddressLine10], [t].[ShippingAddress_AddressLine20], [t].[ShippingAddress_ZipCode0], [t].[ShippingAddress_Country_Code0], [t].[ShippingAddress_Country_FullName0]
+        FROM (
+            SELECT [c].[Id], [c].[Name], [c].[BillingAddress_AddressLine1], [c].[BillingAddress_AddressLine2], [c].[BillingAddress_ZipCode], [c].[BillingAddress_Country_Code], [c].[BillingAddress_Country_FullName], [c].[ShippingAddress_AddressLine1], [c].[ShippingAddress_AddressLine2], [c].[ShippingAddress_ZipCode], [c].[ShippingAddress_Country_Code], [c].[ShippingAddress_Country_FullName], [c0].[Id] AS [Id0], [c0].[Name] AS [Name0], [c0].[BillingAddress_AddressLine1] AS [BillingAddress_AddressLine10], [c0].[BillingAddress_AddressLine2] AS [BillingAddress_AddressLine20], [c0].[BillingAddress_ZipCode] AS [BillingAddress_ZipCode0], [c0].[BillingAddress_Country_Code] AS [BillingAddress_Country_Code0], [c0].[BillingAddress_Country_FullName] AS [BillingAddress_Country_FullName0], [c0].[ShippingAddress_AddressLine1] AS [ShippingAddress_AddressLine10], [c0].[ShippingAddress_AddressLine2] AS [ShippingAddress_AddressLine20], [c0].[ShippingAddress_ZipCode] AS [ShippingAddress_ZipCode0], [c0].[ShippingAddress_Country_Code] AS [ShippingAddress_Country_Code0], [c0].[ShippingAddress_Country_FullName] AS [ShippingAddress_Country_FullName0]
+            FROM [Customer] AS [c]
+            CROSS JOIN [Customer] AS [c0]
+            UNION
+            SELECT [c1].[Id], [c1].[Name], [c1].[BillingAddress_AddressLine1], [c1].[BillingAddress_AddressLine2], [c1].[BillingAddress_ZipCode], [c1].[BillingAddress_Country_Code], [c1].[BillingAddress_Country_FullName], [c1].[ShippingAddress_AddressLine1], [c1].[ShippingAddress_AddressLine2], [c1].[ShippingAddress_ZipCode], [c1].[ShippingAddress_Country_Code], [c1].[ShippingAddress_Country_FullName], [c2].[Id] AS [Id0], [c2].[Name] AS [Name0], [c2].[BillingAddress_AddressLine1] AS [BillingAddress_AddressLine10], [c2].[BillingAddress_AddressLine2] AS [BillingAddress_AddressLine20], [c2].[BillingAddress_ZipCode] AS [BillingAddress_ZipCode0], [c2].[BillingAddress_Country_Code] AS [BillingAddress_Country_Code0], [c2].[BillingAddress_Country_FullName] AS [BillingAddress_Country_FullName0], [c2].[ShippingAddress_AddressLine1] AS [ShippingAddress_AddressLine10], [c2].[ShippingAddress_AddressLine2] AS [ShippingAddress_AddressLine20], [c2].[ShippingAddress_ZipCode] AS [ShippingAddress_ZipCode0], [c2].[ShippingAddress_Country_Code] AS [ShippingAddress_Country_Code0], [c2].[ShippingAddress_Country_FullName] AS [ShippingAddress_Country_FullName0]
+            FROM [Customer] AS [c1]
+            CROSS JOIN [Customer] AS [c2]
+        ) AS [t]
+        ORDER BY [t].[Id], [t].[Id0]
+    ) AS [t0]
+) AS [t1]
+ORDER BY [t1].[Id], [t1].[Id0]
+""");
+    }
+
+    public override async Task Union_of_same_nested_complex_type_projected_twice_with_pushdown(bool async)
+    {
+        await base.Union_of_same_nested_complex_type_projected_twice_with_pushdown(async);
+
+        AssertSql(
+"""
+@__p_0='50'
+
+SELECT TOP(@__p_0) [t].[BillingAddress_AddressLine1], [t].[BillingAddress_AddressLine2], [t].[BillingAddress_ZipCode], [t].[BillingAddress_Country_Code], [t].[BillingAddress_Country_FullName], [t].[BillingAddress_AddressLine10], [t].[BillingAddress_AddressLine20], [t].[BillingAddress_ZipCode0], [t].[BillingAddress_Country_Code0], [t].[BillingAddress_Country_FullName0]
+FROM (
+    SELECT [c].[BillingAddress_AddressLine1], [c].[BillingAddress_AddressLine2], [c].[BillingAddress_ZipCode], [c].[BillingAddress_Country_Code], [c].[BillingAddress_Country_FullName], [c0].[BillingAddress_AddressLine1] AS [BillingAddress_AddressLine10], [c0].[BillingAddress_AddressLine2] AS [BillingAddress_AddressLine20], [c0].[BillingAddress_ZipCode] AS [BillingAddress_ZipCode0], [c0].[BillingAddress_Country_Code] AS [BillingAddress_Country_Code0], [c0].[BillingAddress_Country_FullName] AS [BillingAddress_Country_FullName0]
+    FROM [Customer] AS [c]
+    CROSS JOIN [Customer] AS [c0]
+    UNION
+    SELECT [c1].[BillingAddress_AddressLine1], [c1].[BillingAddress_AddressLine2], [c1].[BillingAddress_ZipCode], [c1].[BillingAddress_Country_Code], [c1].[BillingAddress_Country_FullName], [c2].[BillingAddress_AddressLine1] AS [BillingAddress_AddressLine10], [c2].[BillingAddress_AddressLine2] AS [BillingAddress_AddressLine20], [c2].[BillingAddress_ZipCode] AS [BillingAddress_ZipCode0], [c2].[BillingAddress_Country_Code] AS [BillingAddress_Country_Code0], [c2].[BillingAddress_Country_FullName] AS [BillingAddress_Country_FullName0]
+    FROM [Customer] AS [c1]
+    CROSS JOIN [Customer] AS [c2]
+) AS [t]
+ORDER BY [t].[BillingAddress_ZipCode], [t].[BillingAddress_ZipCode0]
+""");
+    }
+
+    public override async Task Union_of_same_nested_complex_type_projected_twice_with_double_pushdown(bool async)
+    {
+        await base.Union_of_same_nested_complex_type_projected_twice_with_double_pushdown(async);
+
+        AssertSql(
+"""
+@__p_0='50'
+
+SELECT TOP(@__p_0) [t1].[BillingAddress_AddressLine1], [t1].[BillingAddress_AddressLine2], [t1].[BillingAddress_ZipCode], [t1].[BillingAddress_Country_Code], [t1].[BillingAddress_Country_FullName], [t1].[BillingAddress_AddressLine10], [t1].[BillingAddress_AddressLine20], [t1].[BillingAddress_ZipCode0], [t1].[BillingAddress_Country_Code0], [t1].[BillingAddress_Country_FullName0]
+FROM (
+    SELECT DISTINCT [t0].[BillingAddress_AddressLine1], [t0].[BillingAddress_AddressLine2], [t0].[BillingAddress_ZipCode], [t0].[BillingAddress_Country_Code], [t0].[BillingAddress_Country_FullName], [t0].[BillingAddress_AddressLine10], [t0].[BillingAddress_AddressLine20], [t0].[BillingAddress_ZipCode0], [t0].[BillingAddress_Country_Code0], [t0].[BillingAddress_Country_FullName0]
+    FROM (
+        SELECT TOP(@__p_0) [t].[BillingAddress_AddressLine1], [t].[BillingAddress_AddressLine2], [t].[BillingAddress_ZipCode], [t].[BillingAddress_Country_Code], [t].[BillingAddress_Country_FullName], [t].[BillingAddress_AddressLine10], [t].[BillingAddress_AddressLine20], [t].[BillingAddress_ZipCode0], [t].[BillingAddress_Country_Code0], [t].[BillingAddress_Country_FullName0]
+        FROM (
+            SELECT [c].[BillingAddress_AddressLine1], [c].[BillingAddress_AddressLine2], [c].[BillingAddress_ZipCode], [c].[BillingAddress_Country_Code], [c].[BillingAddress_Country_FullName], [c0].[BillingAddress_AddressLine1] AS [BillingAddress_AddressLine10], [c0].[BillingAddress_AddressLine2] AS [BillingAddress_AddressLine20], [c0].[BillingAddress_ZipCode] AS [BillingAddress_ZipCode0], [c0].[BillingAddress_Country_Code] AS [BillingAddress_Country_Code0], [c0].[BillingAddress_Country_FullName] AS [BillingAddress_Country_FullName0]
+            FROM [Customer] AS [c]
+            CROSS JOIN [Customer] AS [c0]
+            UNION
+            SELECT [c1].[BillingAddress_AddressLine1], [c1].[BillingAddress_AddressLine2], [c1].[BillingAddress_ZipCode], [c1].[BillingAddress_Country_Code], [c1].[BillingAddress_Country_FullName], [c2].[BillingAddress_AddressLine1] AS [BillingAddress_AddressLine10], [c2].[BillingAddress_AddressLine2] AS [BillingAddress_AddressLine20], [c2].[BillingAddress_ZipCode] AS [BillingAddress_ZipCode0], [c2].[BillingAddress_Country_Code] AS [BillingAddress_Country_Code0], [c2].[BillingAddress_Country_FullName] AS [BillingAddress_Country_FullName0]
+            FROM [Customer] AS [c1]
+            CROSS JOIN [Customer] AS [c2]
+        ) AS [t]
+        ORDER BY [t].[BillingAddress_ZipCode], [t].[BillingAddress_ZipCode0]
+    ) AS [t0]
+) AS [t1]
+ORDER BY [t1].[BillingAddress_ZipCode], [t1].[BillingAddress_ZipCode0]
+""");
+    }
+
+    public override async Task Same_entity_with_complex_type_projected_twice_with_pushdown_as_part_of_another_projection(bool async)
+    {
+        await base.Same_entity_with_complex_type_projected_twice_with_pushdown_as_part_of_another_projection(async);
+
+        AssertSql(
+"""
+SELECT [c].[Id], [t].[Id], [t].[Name], [t].[BillingAddress_AddressLine1], [t].[BillingAddress_AddressLine2], [t].[BillingAddress_ZipCode], [t].[BillingAddress_Country_Code], [t].[BillingAddress_Country_FullName], [t].[ShippingAddress_AddressLine1], [t].[ShippingAddress_AddressLine2], [t].[ShippingAddress_ZipCode], [t].[ShippingAddress_Country_Code], [t].[ShippingAddress_Country_FullName], [t].[Id0], [t].[Name0], [t].[BillingAddress_AddressLine10], [t].[BillingAddress_AddressLine20], [t].[BillingAddress_ZipCode0], [t].[BillingAddress_Country_Code0], [t].[BillingAddress_Country_FullName0], [t].[ShippingAddress_AddressLine10], [t].[ShippingAddress_AddressLine20], [t].[ShippingAddress_ZipCode0], [t].[ShippingAddress_Country_Code0], [t].[ShippingAddress_Country_FullName0], [t].[c]
+FROM [Customer] AS [c]
+OUTER APPLY (
+    SELECT TOP(1) [c0].[Id], [c0].[Name], [c0].[BillingAddress_AddressLine1], [c0].[BillingAddress_AddressLine2], [c0].[BillingAddress_ZipCode], [c0].[BillingAddress_Country_Code], [c0].[BillingAddress_Country_FullName], [c0].[ShippingAddress_AddressLine1], [c0].[ShippingAddress_AddressLine2], [c0].[ShippingAddress_ZipCode], [c0].[ShippingAddress_Country_Code], [c0].[ShippingAddress_Country_FullName], [c1].[Id] AS [Id0], [c1].[Name] AS [Name0], [c1].[BillingAddress_AddressLine1] AS [BillingAddress_AddressLine10], [c1].[BillingAddress_AddressLine2] AS [BillingAddress_AddressLine20], [c1].[BillingAddress_ZipCode] AS [BillingAddress_ZipCode0], [c1].[BillingAddress_Country_Code] AS [BillingAddress_Country_Code0], [c1].[BillingAddress_Country_FullName] AS [BillingAddress_Country_FullName0], [c1].[ShippingAddress_AddressLine1] AS [ShippingAddress_AddressLine10], [c1].[ShippingAddress_AddressLine2] AS [ShippingAddress_AddressLine20], [c1].[ShippingAddress_ZipCode] AS [ShippingAddress_ZipCode0], [c1].[ShippingAddress_Country_Code] AS [ShippingAddress_Country_Code0], [c1].[ShippingAddress_Country_FullName] AS [ShippingAddress_Country_FullName0], 1 AS [c]
+    FROM [Customer] AS [c0]
+    CROSS JOIN [Customer] AS [c1]
+    ORDER BY [c0].[Id], [c1].[Id] DESC
+) AS [t]
+""");
+    }
+
+    public override async Task Same_complex_type_projected_twice_with_pushdown_as_part_of_another_projection(bool async)
+    {
+        await base.Same_complex_type_projected_twice_with_pushdown_as_part_of_another_projection(async);
+
+        AssertSql("");
+    }
+
     [ConditionalFact]
     public virtual void Check_all_tests_overridden()
         => TestHelpers.AssertAllMethodsOverridden(GetType());
diff --git a/test/EFCore.Sqlite.FunctionalTests/Query/AdHocAdvancedMappingsQuerySqliteTest.cs b/test/EFCore.Sqlite.FunctionalTests/Query/AdHocAdvancedMappingsQuerySqliteTest.cs
new file mode 100644
index 0000000000..1807f23b4a
--- /dev/null
+++ b/test/EFCore.Sqlite.FunctionalTests/Query/AdHocAdvancedMappingsQuerySqliteTest.cs
@@ -0,0 +1,10 @@
+﻿// Licensed to the .NET Foundation under one or more agreements.
+// The .NET Foundation licenses this file to you under the MIT license.
+
+namespace Microsoft.EntityFrameworkCore.Query;
+
+public class AdHocAdvancedMappingsQuerySqliteTest : AdHocAdvancedMappingsQueryRelationalTestBase
+{
+    protected override ITestStoreFactory TestStoreFactory
+        => SqliteTestStoreFactory.Instance;
+}
diff --git a/test/EFCore.Sqlite.FunctionalTests/Query/ComplexTypeQuerySqliteTest.cs b/test/EFCore.Sqlite.FunctionalTests/Query/ComplexTypeQuerySqliteTest.cs
index 51c426cd28..ace097abb2 100644
--- a/test/EFCore.Sqlite.FunctionalTests/Query/ComplexTypeQuerySqliteTest.cs
+++ b/test/EFCore.Sqlite.FunctionalTests/Query/ComplexTypeQuerySqliteTest.cs
@@ -1,6 +1,8 @@
 // Licensed to the .NET Foundation under one or more agreements.
 // The .NET Foundation licenses this file to you under the MIT license.
 
+using Microsoft.EntityFrameworkCore.Sqlite.Internal;
+
 namespace Microsoft.EntityFrameworkCore.Query;
 
 public class ComplexTypeQuerySqliteTest : ComplexTypeQueryRelationalTestBase<
@@ -740,6 +742,274 @@ public override async Task Union_two_different_struct_complex_type(bool async)
         AssertSql();
     }
 
+    public override async Task Project_same_entity_with_nested_complex_type_twice_with_pushdown(bool async)
+    {
+        await base.Project_same_entity_with_nested_complex_type_twice_with_pushdown(async);
+
+        AssertSql(
+"""
+SELECT "t"."Id", "t"."Name", "t"."BillingAddress_AddressLine1", "t"."BillingAddress_AddressLine2", "t"."BillingAddress_ZipCode", "t"."BillingAddress_Country_Code", "t"."BillingAddress_Country_FullName", "t"."ShippingAddress_AddressLine1", "t"."ShippingAddress_AddressLine2", "t"."ShippingAddress_ZipCode", "t"."ShippingAddress_Country_Code", "t"."ShippingAddress_Country_FullName", "t"."Id0", "t"."Name0", "t"."BillingAddress_AddressLine10", "t"."BillingAddress_AddressLine20", "t"."BillingAddress_ZipCode0", "t"."BillingAddress_Country_Code0", "t"."BillingAddress_Country_FullName0", "t"."ShippingAddress_AddressLine10", "t"."ShippingAddress_AddressLine20", "t"."ShippingAddress_ZipCode0", "t"."ShippingAddress_Country_Code0", "t"."ShippingAddress_Country_FullName0"
+FROM (
+    SELECT DISTINCT "c"."Id", "c"."Name", "c"."BillingAddress_AddressLine1", "c"."BillingAddress_AddressLine2", "c"."BillingAddress_ZipCode", "c"."BillingAddress_Country_Code", "c"."BillingAddress_Country_FullName", "c"."ShippingAddress_AddressLine1", "c"."ShippingAddress_AddressLine2", "c"."ShippingAddress_ZipCode", "c"."ShippingAddress_Country_Code", "c"."ShippingAddress_Country_FullName", "c0"."Id" AS "Id0", "c0"."Name" AS "Name0", "c0"."BillingAddress_AddressLine1" AS "BillingAddress_AddressLine10", "c0"."BillingAddress_AddressLine2" AS "BillingAddress_AddressLine20", "c0"."BillingAddress_ZipCode" AS "BillingAddress_ZipCode0", "c0"."BillingAddress_Country_Code" AS "BillingAddress_Country_Code0", "c0"."BillingAddress_Country_FullName" AS "BillingAddress_Country_FullName0", "c0"."ShippingAddress_AddressLine1" AS "ShippingAddress_AddressLine10", "c0"."ShippingAddress_AddressLine2" AS "ShippingAddress_AddressLine20", "c0"."ShippingAddress_ZipCode" AS "ShippingAddress_ZipCode0", "c0"."ShippingAddress_Country_Code" AS "ShippingAddress_Country_Code0", "c0"."ShippingAddress_Country_FullName" AS "ShippingAddress_Country_FullName0"
+    FROM "Customer" AS "c"
+    CROSS JOIN "Customer" AS "c0"
+) AS "t"
+""");
+    }
+
+    public override async Task Project_same_nested_complex_type_twice_with_pushdown(bool async)
+    {
+        await base.Project_same_nested_complex_type_twice_with_pushdown(async);
+
+        AssertSql(
+"""
+SELECT "t"."BillingAddress_AddressLine1", "t"."BillingAddress_AddressLine2", "t"."BillingAddress_ZipCode", "t"."BillingAddress_Country_Code", "t"."BillingAddress_Country_FullName", "t"."BillingAddress_AddressLine10", "t"."BillingAddress_AddressLine20", "t"."BillingAddress_ZipCode0", "t"."BillingAddress_Country_Code0", "t"."BillingAddress_Country_FullName0"
+FROM (
+    SELECT DISTINCT "c"."BillingAddress_AddressLine1", "c"."BillingAddress_AddressLine2", "c"."BillingAddress_ZipCode", "c"."BillingAddress_Country_Code", "c"."BillingAddress_Country_FullName", "c0"."BillingAddress_AddressLine1" AS "BillingAddress_AddressLine10", "c0"."BillingAddress_AddressLine2" AS "BillingAddress_AddressLine20", "c0"."BillingAddress_ZipCode" AS "BillingAddress_ZipCode0", "c0"."BillingAddress_Country_Code" AS "BillingAddress_Country_Code0", "c0"."BillingAddress_Country_FullName" AS "BillingAddress_Country_FullName0"
+    FROM "Customer" AS "c"
+    CROSS JOIN "Customer" AS "c0"
+) AS "t"
+""");
+    }
+
+    public override async Task Project_same_entity_with_nested_complex_type_twice_with_double_pushdown(bool async)
+    {
+        await base.Project_same_entity_with_nested_complex_type_twice_with_double_pushdown(async);
+
+        AssertSql(
+"""
+@__p_0='50'
+
+SELECT "t0"."Id", "t0"."Name", "t0"."BillingAddress_AddressLine1", "t0"."BillingAddress_AddressLine2", "t0"."BillingAddress_ZipCode", "t0"."BillingAddress_Country_Code", "t0"."BillingAddress_Country_FullName", "t0"."ShippingAddress_AddressLine1", "t0"."ShippingAddress_AddressLine2", "t0"."ShippingAddress_ZipCode", "t0"."ShippingAddress_Country_Code", "t0"."ShippingAddress_Country_FullName", "t0"."Id0", "t0"."Name0", "t0"."BillingAddress_AddressLine10", "t0"."BillingAddress_AddressLine20", "t0"."BillingAddress_ZipCode0", "t0"."BillingAddress_Country_Code0", "t0"."BillingAddress_Country_FullName0", "t0"."ShippingAddress_AddressLine10", "t0"."ShippingAddress_AddressLine20", "t0"."ShippingAddress_ZipCode0", "t0"."ShippingAddress_Country_Code0", "t0"."ShippingAddress_Country_FullName0"
+FROM (
+    SELECT DISTINCT "t"."Id", "t"."Name", "t"."BillingAddress_AddressLine1", "t"."BillingAddress_AddressLine2", "t"."BillingAddress_ZipCode", "t"."BillingAddress_Country_Code", "t"."BillingAddress_Country_FullName", "t"."ShippingAddress_AddressLine1", "t"."ShippingAddress_AddressLine2", "t"."ShippingAddress_ZipCode", "t"."ShippingAddress_Country_Code", "t"."ShippingAddress_Country_FullName", "t"."Id0", "t"."Name0", "t"."BillingAddress_AddressLine10", "t"."BillingAddress_AddressLine20", "t"."BillingAddress_ZipCode0", "t"."BillingAddress_Country_Code0", "t"."BillingAddress_Country_FullName0", "t"."ShippingAddress_AddressLine10", "t"."ShippingAddress_AddressLine20", "t"."ShippingAddress_ZipCode0", "t"."ShippingAddress_Country_Code0", "t"."ShippingAddress_Country_FullName0"
+    FROM (
+        SELECT "c"."Id", "c"."Name", "c"."BillingAddress_AddressLine1", "c"."BillingAddress_AddressLine2", "c"."BillingAddress_ZipCode", "c"."BillingAddress_Country_Code", "c"."BillingAddress_Country_FullName", "c"."ShippingAddress_AddressLine1", "c"."ShippingAddress_AddressLine2", "c"."ShippingAddress_ZipCode", "c"."ShippingAddress_Country_Code", "c"."ShippingAddress_Country_FullName", "c0"."Id" AS "Id0", "c0"."Name" AS "Name0", "c0"."BillingAddress_AddressLine1" AS "BillingAddress_AddressLine10", "c0"."BillingAddress_AddressLine2" AS "BillingAddress_AddressLine20", "c0"."BillingAddress_ZipCode" AS "BillingAddress_ZipCode0", "c0"."BillingAddress_Country_Code" AS "BillingAddress_Country_Code0", "c0"."BillingAddress_Country_FullName" AS "BillingAddress_Country_FullName0", "c0"."ShippingAddress_AddressLine1" AS "ShippingAddress_AddressLine10", "c0"."ShippingAddress_AddressLine2" AS "ShippingAddress_AddressLine20", "c0"."ShippingAddress_ZipCode" AS "ShippingAddress_ZipCode0", "c0"."ShippingAddress_Country_Code" AS "ShippingAddress_Country_Code0", "c0"."ShippingAddress_Country_FullName" AS "ShippingAddress_Country_FullName0"
+        FROM "Customer" AS "c"
+        CROSS JOIN "Customer" AS "c0"
+        ORDER BY "c"."Id", "c0"."Id"
+        LIMIT @__p_0
+    ) AS "t"
+) AS "t0"
+""");
+    }
+
+    public override async Task Project_same_nested_complex_type_twice_with_double_pushdown(bool async)
+    {
+        await base.Project_same_nested_complex_type_twice_with_double_pushdown(async);
+
+        AssertSql(
+"""
+@__p_0='50'
+
+SELECT "t0"."BillingAddress_AddressLine1", "t0"."BillingAddress_AddressLine2", "t0"."BillingAddress_ZipCode", "t0"."BillingAddress_Country_Code", "t0"."BillingAddress_Country_FullName", "t0"."BillingAddress_AddressLine10", "t0"."BillingAddress_AddressLine20", "t0"."BillingAddress_ZipCode0", "t0"."BillingAddress_Country_Code0", "t0"."BillingAddress_Country_FullName0"
+FROM (
+    SELECT DISTINCT "t"."BillingAddress_AddressLine1", "t"."BillingAddress_AddressLine2", "t"."BillingAddress_ZipCode", "t"."BillingAddress_Country_Code", "t"."BillingAddress_Country_FullName", "t"."BillingAddress_AddressLine10", "t"."BillingAddress_AddressLine20", "t"."BillingAddress_ZipCode0", "t"."BillingAddress_Country_Code0", "t"."BillingAddress_Country_FullName0"
+    FROM (
+        SELECT "c"."BillingAddress_AddressLine1", "c"."BillingAddress_AddressLine2", "c"."BillingAddress_ZipCode", "c"."BillingAddress_Country_Code", "c"."BillingAddress_Country_FullName", "c0"."BillingAddress_AddressLine1" AS "BillingAddress_AddressLine10", "c0"."BillingAddress_AddressLine2" AS "BillingAddress_AddressLine20", "c0"."BillingAddress_ZipCode" AS "BillingAddress_ZipCode0", "c0"."BillingAddress_Country_Code" AS "BillingAddress_Country_Code0", "c0"."BillingAddress_Country_FullName" AS "BillingAddress_Country_FullName0"
+        FROM "Customer" AS "c"
+        CROSS JOIN "Customer" AS "c0"
+        ORDER BY "c"."Id", "c0"."Id"
+        LIMIT @__p_0
+    ) AS "t"
+) AS "t0"
+""");
+    }
+
+    public override async Task Project_same_entity_with_struct_nested_complex_type_twice_with_pushdown(bool async)
+    {
+        await base.Project_same_entity_with_struct_nested_complex_type_twice_with_pushdown(async);
+
+        AssertSql(
+"""
+SELECT "t"."Id", "t"."Name", "t"."BillingAddress_AddressLine1", "t"."BillingAddress_AddressLine2", "t"."BillingAddress_ZipCode", "t"."BillingAddress_Country_Code", "t"."BillingAddress_Country_FullName", "t"."ShippingAddress_AddressLine1", "t"."ShippingAddress_AddressLine2", "t"."ShippingAddress_ZipCode", "t"."ShippingAddress_Country_Code", "t"."ShippingAddress_Country_FullName", "t"."Id0", "t"."Name0", "t"."BillingAddress_AddressLine10", "t"."BillingAddress_AddressLine20", "t"."BillingAddress_ZipCode0", "t"."BillingAddress_Country_Code0", "t"."BillingAddress_Country_FullName0", "t"."ShippingAddress_AddressLine10", "t"."ShippingAddress_AddressLine20", "t"."ShippingAddress_ZipCode0", "t"."ShippingAddress_Country_Code0", "t"."ShippingAddress_Country_FullName0"
+FROM (
+    SELECT DISTINCT "v"."Id", "v"."Name", "v"."BillingAddress_AddressLine1", "v"."BillingAddress_AddressLine2", "v"."BillingAddress_ZipCode", "v"."BillingAddress_Country_Code", "v"."BillingAddress_Country_FullName", "v"."ShippingAddress_AddressLine1", "v"."ShippingAddress_AddressLine2", "v"."ShippingAddress_ZipCode", "v"."ShippingAddress_Country_Code", "v"."ShippingAddress_Country_FullName", "v0"."Id" AS "Id0", "v0"."Name" AS "Name0", "v0"."BillingAddress_AddressLine1" AS "BillingAddress_AddressLine10", "v0"."BillingAddress_AddressLine2" AS "BillingAddress_AddressLine20", "v0"."BillingAddress_ZipCode" AS "BillingAddress_ZipCode0", "v0"."BillingAddress_Country_Code" AS "BillingAddress_Country_Code0", "v0"."BillingAddress_Country_FullName" AS "BillingAddress_Country_FullName0", "v0"."ShippingAddress_AddressLine1" AS "ShippingAddress_AddressLine10", "v0"."ShippingAddress_AddressLine2" AS "ShippingAddress_AddressLine20", "v0"."ShippingAddress_ZipCode" AS "ShippingAddress_ZipCode0", "v0"."ShippingAddress_Country_Code" AS "ShippingAddress_Country_Code0", "v0"."ShippingAddress_Country_FullName" AS "ShippingAddress_Country_FullName0"
+    FROM "ValuedCustomer" AS "v"
+    CROSS JOIN "ValuedCustomer" AS "v0"
+) AS "t"
+""");
+    }
+
+    public override async Task Project_same_struct_nested_complex_type_twice_with_pushdown(bool async)
+    {
+        await base.Project_same_struct_nested_complex_type_twice_with_pushdown(async);
+
+        AssertSql(
+"""
+SELECT "t"."BillingAddress_AddressLine1", "t"."BillingAddress_AddressLine2", "t"."BillingAddress_ZipCode", "t"."BillingAddress_Country_Code", "t"."BillingAddress_Country_FullName", "t"."BillingAddress_AddressLine10", "t"."BillingAddress_AddressLine20", "t"."BillingAddress_ZipCode0", "t"."BillingAddress_Country_Code0", "t"."BillingAddress_Country_FullName0"
+FROM (
+    SELECT DISTINCT "v"."BillingAddress_AddressLine1", "v"."BillingAddress_AddressLine2", "v"."BillingAddress_ZipCode", "v"."BillingAddress_Country_Code", "v"."BillingAddress_Country_FullName", "v0"."BillingAddress_AddressLine1" AS "BillingAddress_AddressLine10", "v0"."BillingAddress_AddressLine2" AS "BillingAddress_AddressLine20", "v0"."BillingAddress_ZipCode" AS "BillingAddress_ZipCode0", "v0"."BillingAddress_Country_Code" AS "BillingAddress_Country_Code0", "v0"."BillingAddress_Country_FullName" AS "BillingAddress_Country_FullName0"
+    FROM "ValuedCustomer" AS "v"
+    CROSS JOIN "ValuedCustomer" AS "v0"
+) AS "t"
+""");
+    }
+
+    public override async Task Project_same_entity_with_struct_nested_complex_type_twice_with_double_pushdown(bool async)
+    {
+        await base.Project_same_entity_with_struct_nested_complex_type_twice_with_double_pushdown(async);
+
+        AssertSql(
+"""
+@__p_0='50'
+
+SELECT "t0"."Id", "t0"."Name", "t0"."BillingAddress_AddressLine1", "t0"."BillingAddress_AddressLine2", "t0"."BillingAddress_ZipCode", "t0"."BillingAddress_Country_Code", "t0"."BillingAddress_Country_FullName", "t0"."ShippingAddress_AddressLine1", "t0"."ShippingAddress_AddressLine2", "t0"."ShippingAddress_ZipCode", "t0"."ShippingAddress_Country_Code", "t0"."ShippingAddress_Country_FullName", "t0"."Id0", "t0"."Name0", "t0"."BillingAddress_AddressLine10", "t0"."BillingAddress_AddressLine20", "t0"."BillingAddress_ZipCode0", "t0"."BillingAddress_Country_Code0", "t0"."BillingAddress_Country_FullName0", "t0"."ShippingAddress_AddressLine10", "t0"."ShippingAddress_AddressLine20", "t0"."ShippingAddress_ZipCode0", "t0"."ShippingAddress_Country_Code0", "t0"."ShippingAddress_Country_FullName0"
+FROM (
+    SELECT DISTINCT "t"."Id", "t"."Name", "t"."BillingAddress_AddressLine1", "t"."BillingAddress_AddressLine2", "t"."BillingAddress_ZipCode", "t"."BillingAddress_Country_Code", "t"."BillingAddress_Country_FullName", "t"."ShippingAddress_AddressLine1", "t"."ShippingAddress_AddressLine2", "t"."ShippingAddress_ZipCode", "t"."ShippingAddress_Country_Code", "t"."ShippingAddress_Country_FullName", "t"."Id0", "t"."Name0", "t"."BillingAddress_AddressLine10", "t"."BillingAddress_AddressLine20", "t"."BillingAddress_ZipCode0", "t"."BillingAddress_Country_Code0", "t"."BillingAddress_Country_FullName0", "t"."ShippingAddress_AddressLine10", "t"."ShippingAddress_AddressLine20", "t"."ShippingAddress_ZipCode0", "t"."ShippingAddress_Country_Code0", "t"."ShippingAddress_Country_FullName0"
+    FROM (
+        SELECT "v"."Id", "v"."Name", "v"."BillingAddress_AddressLine1", "v"."BillingAddress_AddressLine2", "v"."BillingAddress_ZipCode", "v"."BillingAddress_Country_Code", "v"."BillingAddress_Country_FullName", "v"."ShippingAddress_AddressLine1", "v"."ShippingAddress_AddressLine2", "v"."ShippingAddress_ZipCode", "v"."ShippingAddress_Country_Code", "v"."ShippingAddress_Country_FullName", "v0"."Id" AS "Id0", "v0"."Name" AS "Name0", "v0"."BillingAddress_AddressLine1" AS "BillingAddress_AddressLine10", "v0"."BillingAddress_AddressLine2" AS "BillingAddress_AddressLine20", "v0"."BillingAddress_ZipCode" AS "BillingAddress_ZipCode0", "v0"."BillingAddress_Country_Code" AS "BillingAddress_Country_Code0", "v0"."BillingAddress_Country_FullName" AS "BillingAddress_Country_FullName0", "v0"."ShippingAddress_AddressLine1" AS "ShippingAddress_AddressLine10", "v0"."ShippingAddress_AddressLine2" AS "ShippingAddress_AddressLine20", "v0"."ShippingAddress_ZipCode" AS "ShippingAddress_ZipCode0", "v0"."ShippingAddress_Country_Code" AS "ShippingAddress_Country_Code0", "v0"."ShippingAddress_Country_FullName" AS "ShippingAddress_Country_FullName0"
+        FROM "ValuedCustomer" AS "v"
+        CROSS JOIN "ValuedCustomer" AS "v0"
+        ORDER BY "v"."Id", "v0"."Id"
+        LIMIT @__p_0
+    ) AS "t"
+) AS "t0"
+""");
+    }
+
+    public override async Task Project_same_struct_nested_complex_type_twice_with_double_pushdown(bool async)
+    {
+        await base.Project_same_struct_nested_complex_type_twice_with_double_pushdown(async);
+
+        AssertSql(
+"""
+@__p_0='50'
+
+SELECT "t0"."BillingAddress_AddressLine1", "t0"."BillingAddress_AddressLine2", "t0"."BillingAddress_ZipCode", "t0"."BillingAddress_Country_Code", "t0"."BillingAddress_Country_FullName", "t0"."BillingAddress_AddressLine10", "t0"."BillingAddress_AddressLine20", "t0"."BillingAddress_ZipCode0", "t0"."BillingAddress_Country_Code0", "t0"."BillingAddress_Country_FullName0"
+FROM (
+    SELECT DISTINCT "t"."BillingAddress_AddressLine1", "t"."BillingAddress_AddressLine2", "t"."BillingAddress_ZipCode", "t"."BillingAddress_Country_Code", "t"."BillingAddress_Country_FullName", "t"."BillingAddress_AddressLine10", "t"."BillingAddress_AddressLine20", "t"."BillingAddress_ZipCode0", "t"."BillingAddress_Country_Code0", "t"."BillingAddress_Country_FullName0"
+    FROM (
+        SELECT "v"."BillingAddress_AddressLine1", "v"."BillingAddress_AddressLine2", "v"."BillingAddress_ZipCode", "v"."BillingAddress_Country_Code", "v"."BillingAddress_Country_FullName", "v0"."BillingAddress_AddressLine1" AS "BillingAddress_AddressLine10", "v0"."BillingAddress_AddressLine2" AS "BillingAddress_AddressLine20", "v0"."BillingAddress_ZipCode" AS "BillingAddress_ZipCode0", "v0"."BillingAddress_Country_Code" AS "BillingAddress_Country_Code0", "v0"."BillingAddress_Country_FullName" AS "BillingAddress_Country_FullName0"
+        FROM "ValuedCustomer" AS "v"
+        CROSS JOIN "ValuedCustomer" AS "v0"
+        ORDER BY "v"."Id", "v0"."Id"
+        LIMIT @__p_0
+    ) AS "t"
+) AS "t0"
+""");
+    }
+
+    public override async Task Union_of_same_entity_with_nested_complex_type_projected_twice_with_pushdown(bool async)
+    {
+        await base.Union_of_same_entity_with_nested_complex_type_projected_twice_with_pushdown(async);
+
+        AssertSql(
+"""
+@__p_0='50'
+
+SELECT "t"."Id", "t"."Name", "t"."BillingAddress_AddressLine1", "t"."BillingAddress_AddressLine2", "t"."BillingAddress_ZipCode", "t"."BillingAddress_Country_Code", "t"."BillingAddress_Country_FullName", "t"."ShippingAddress_AddressLine1", "t"."ShippingAddress_AddressLine2", "t"."ShippingAddress_ZipCode", "t"."ShippingAddress_Country_Code", "t"."ShippingAddress_Country_FullName", "t"."Id0", "t"."Name0", "t"."BillingAddress_AddressLine10", "t"."BillingAddress_AddressLine20", "t"."BillingAddress_ZipCode0", "t"."BillingAddress_Country_Code0", "t"."BillingAddress_Country_FullName0", "t"."ShippingAddress_AddressLine10", "t"."ShippingAddress_AddressLine20", "t"."ShippingAddress_ZipCode0", "t"."ShippingAddress_Country_Code0", "t"."ShippingAddress_Country_FullName0"
+FROM (
+    SELECT "c"."Id", "c"."Name", "c"."BillingAddress_AddressLine1", "c"."BillingAddress_AddressLine2", "c"."BillingAddress_ZipCode", "c"."BillingAddress_Country_Code", "c"."BillingAddress_Country_FullName", "c"."ShippingAddress_AddressLine1", "c"."ShippingAddress_AddressLine2", "c"."ShippingAddress_ZipCode", "c"."ShippingAddress_Country_Code", "c"."ShippingAddress_Country_FullName", "c0"."Id" AS "Id0", "c0"."Name" AS "Name0", "c0"."BillingAddress_AddressLine1" AS "BillingAddress_AddressLine10", "c0"."BillingAddress_AddressLine2" AS "BillingAddress_AddressLine20", "c0"."BillingAddress_ZipCode" AS "BillingAddress_ZipCode0", "c0"."BillingAddress_Country_Code" AS "BillingAddress_Country_Code0", "c0"."BillingAddress_Country_FullName" AS "BillingAddress_Country_FullName0", "c0"."ShippingAddress_AddressLine1" AS "ShippingAddress_AddressLine10", "c0"."ShippingAddress_AddressLine2" AS "ShippingAddress_AddressLine20", "c0"."ShippingAddress_ZipCode" AS "ShippingAddress_ZipCode0", "c0"."ShippingAddress_Country_Code" AS "ShippingAddress_Country_Code0", "c0"."ShippingAddress_Country_FullName" AS "ShippingAddress_Country_FullName0"
+    FROM "Customer" AS "c"
+    CROSS JOIN "Customer" AS "c0"
+    UNION
+    SELECT "c1"."Id", "c1"."Name", "c1"."BillingAddress_AddressLine1", "c1"."BillingAddress_AddressLine2", "c1"."BillingAddress_ZipCode", "c1"."BillingAddress_Country_Code", "c1"."BillingAddress_Country_FullName", "c1"."ShippingAddress_AddressLine1", "c1"."ShippingAddress_AddressLine2", "c1"."ShippingAddress_ZipCode", "c1"."ShippingAddress_Country_Code", "c1"."ShippingAddress_Country_FullName", "c2"."Id" AS "Id0", "c2"."Name" AS "Name0", "c2"."BillingAddress_AddressLine1" AS "BillingAddress_AddressLine10", "c2"."BillingAddress_AddressLine2" AS "BillingAddress_AddressLine20", "c2"."BillingAddress_ZipCode" AS "BillingAddress_ZipCode0", "c2"."BillingAddress_Country_Code" AS "BillingAddress_Country_Code0", "c2"."BillingAddress_Country_FullName" AS "BillingAddress_Country_FullName0", "c2"."ShippingAddress_AddressLine1" AS "ShippingAddress_AddressLine10", "c2"."ShippingAddress_AddressLine2" AS "ShippingAddress_AddressLine20", "c2"."ShippingAddress_ZipCode" AS "ShippingAddress_ZipCode0", "c2"."ShippingAddress_Country_Code" AS "ShippingAddress_Country_Code0", "c2"."ShippingAddress_Country_FullName" AS "ShippingAddress_Country_FullName0"
+    FROM "Customer" AS "c1"
+    CROSS JOIN "Customer" AS "c2"
+) AS "t"
+ORDER BY "t"."Id", "t"."Id0"
+LIMIT @__p_0
+""");
+    }
+
+    public override async Task Union_of_same_entity_with_nested_complex_type_projected_twice_with_double_pushdown(bool async)
+    {
+        await base.Union_of_same_entity_with_nested_complex_type_projected_twice_with_double_pushdown(async);
+
+        AssertSql(
+"""
+@__p_0='50'
+
+SELECT "t1"."Id", "t1"."Name", "t1"."BillingAddress_AddressLine1", "t1"."BillingAddress_AddressLine2", "t1"."BillingAddress_ZipCode", "t1"."BillingAddress_Country_Code", "t1"."BillingAddress_Country_FullName", "t1"."ShippingAddress_AddressLine1", "t1"."ShippingAddress_AddressLine2", "t1"."ShippingAddress_ZipCode", "t1"."ShippingAddress_Country_Code", "t1"."ShippingAddress_Country_FullName", "t1"."Id0", "t1"."Name0", "t1"."BillingAddress_AddressLine10", "t1"."BillingAddress_AddressLine20", "t1"."BillingAddress_ZipCode0", "t1"."BillingAddress_Country_Code0", "t1"."BillingAddress_Country_FullName0", "t1"."ShippingAddress_AddressLine10", "t1"."ShippingAddress_AddressLine20", "t1"."ShippingAddress_ZipCode0", "t1"."ShippingAddress_Country_Code0", "t1"."ShippingAddress_Country_FullName0"
+FROM (
+    SELECT DISTINCT "t0"."Id", "t0"."Name", "t0"."BillingAddress_AddressLine1", "t0"."BillingAddress_AddressLine2", "t0"."BillingAddress_ZipCode", "t0"."BillingAddress_Country_Code", "t0"."BillingAddress_Country_FullName", "t0"."ShippingAddress_AddressLine1", "t0"."ShippingAddress_AddressLine2", "t0"."ShippingAddress_ZipCode", "t0"."ShippingAddress_Country_Code", "t0"."ShippingAddress_Country_FullName", "t0"."Id0", "t0"."Name0", "t0"."BillingAddress_AddressLine10", "t0"."BillingAddress_AddressLine20", "t0"."BillingAddress_ZipCode0", "t0"."BillingAddress_Country_Code0", "t0"."BillingAddress_Country_FullName0", "t0"."ShippingAddress_AddressLine10", "t0"."ShippingAddress_AddressLine20", "t0"."ShippingAddress_ZipCode0", "t0"."ShippingAddress_Country_Code0", "t0"."ShippingAddress_Country_FullName0"
+    FROM (
+        SELECT "t"."Id", "t"."Name", "t"."BillingAddress_AddressLine1", "t"."BillingAddress_AddressLine2", "t"."BillingAddress_ZipCode", "t"."BillingAddress_Country_Code", "t"."BillingAddress_Country_FullName", "t"."ShippingAddress_AddressLine1", "t"."ShippingAddress_AddressLine2", "t"."ShippingAddress_ZipCode", "t"."ShippingAddress_Country_Code", "t"."ShippingAddress_Country_FullName", "t"."Id0", "t"."Name0", "t"."BillingAddress_AddressLine10", "t"."BillingAddress_AddressLine20", "t"."BillingAddress_ZipCode0", "t"."BillingAddress_Country_Code0", "t"."BillingAddress_Country_FullName0", "t"."ShippingAddress_AddressLine10", "t"."ShippingAddress_AddressLine20", "t"."ShippingAddress_ZipCode0", "t"."ShippingAddress_Country_Code0", "t"."ShippingAddress_Country_FullName0"
+        FROM (
+            SELECT "c"."Id", "c"."Name", "c"."BillingAddress_AddressLine1", "c"."BillingAddress_AddressLine2", "c"."BillingAddress_ZipCode", "c"."BillingAddress_Country_Code", "c"."BillingAddress_Country_FullName", "c"."ShippingAddress_AddressLine1", "c"."ShippingAddress_AddressLine2", "c"."ShippingAddress_ZipCode", "c"."ShippingAddress_Country_Code", "c"."ShippingAddress_Country_FullName", "c0"."Id" AS "Id0", "c0"."Name" AS "Name0", "c0"."BillingAddress_AddressLine1" AS "BillingAddress_AddressLine10", "c0"."BillingAddress_AddressLine2" AS "BillingAddress_AddressLine20", "c0"."BillingAddress_ZipCode" AS "BillingAddress_ZipCode0", "c0"."BillingAddress_Country_Code" AS "BillingAddress_Country_Code0", "c0"."BillingAddress_Country_FullName" AS "BillingAddress_Country_FullName0", "c0"."ShippingAddress_AddressLine1" AS "ShippingAddress_AddressLine10", "c0"."ShippingAddress_AddressLine2" AS "ShippingAddress_AddressLine20", "c0"."ShippingAddress_ZipCode" AS "ShippingAddress_ZipCode0", "c0"."ShippingAddress_Country_Code" AS "ShippingAddress_Country_Code0", "c0"."ShippingAddress_Country_FullName" AS "ShippingAddress_Country_FullName0"
+            FROM "Customer" AS "c"
+            CROSS JOIN "Customer" AS "c0"
+            UNION
+            SELECT "c1"."Id", "c1"."Name", "c1"."BillingAddress_AddressLine1", "c1"."BillingAddress_AddressLine2", "c1"."BillingAddress_ZipCode", "c1"."BillingAddress_Country_Code", "c1"."BillingAddress_Country_FullName", "c1"."ShippingAddress_AddressLine1", "c1"."ShippingAddress_AddressLine2", "c1"."ShippingAddress_ZipCode", "c1"."ShippingAddress_Country_Code", "c1"."ShippingAddress_Country_FullName", "c2"."Id" AS "Id0", "c2"."Name" AS "Name0", "c2"."BillingAddress_AddressLine1" AS "BillingAddress_AddressLine10", "c2"."BillingAddress_AddressLine2" AS "BillingAddress_AddressLine20", "c2"."BillingAddress_ZipCode" AS "BillingAddress_ZipCode0", "c2"."BillingAddress_Country_Code" AS "BillingAddress_Country_Code0", "c2"."BillingAddress_Country_FullName" AS "BillingAddress_Country_FullName0", "c2"."ShippingAddress_AddressLine1" AS "ShippingAddress_AddressLine10", "c2"."ShippingAddress_AddressLine2" AS "ShippingAddress_AddressLine20", "c2"."ShippingAddress_ZipCode" AS "ShippingAddress_ZipCode0", "c2"."ShippingAddress_Country_Code" AS "ShippingAddress_Country_Code0", "c2"."ShippingAddress_Country_FullName" AS "ShippingAddress_Country_FullName0"
+            FROM "Customer" AS "c1"
+            CROSS JOIN "Customer" AS "c2"
+        ) AS "t"
+        ORDER BY "t"."Id", "t"."Id0"
+        LIMIT @__p_0
+    ) AS "t0"
+) AS "t1"
+ORDER BY "t1"."Id", "t1"."Id0"
+LIMIT @__p_0
+""");
+    }
+
+    public override async Task Union_of_same_nested_complex_type_projected_twice_with_pushdown(bool async)
+    {
+        await base.Union_of_same_nested_complex_type_projected_twice_with_pushdown(async);
+
+        AssertSql(
+"""
+@__p_0='50'
+
+SELECT "t"."BillingAddress_AddressLine1", "t"."BillingAddress_AddressLine2", "t"."BillingAddress_ZipCode", "t"."BillingAddress_Country_Code", "t"."BillingAddress_Country_FullName", "t"."BillingAddress_AddressLine10", "t"."BillingAddress_AddressLine20", "t"."BillingAddress_ZipCode0", "t"."BillingAddress_Country_Code0", "t"."BillingAddress_Country_FullName0"
+FROM (
+    SELECT "c"."BillingAddress_AddressLine1", "c"."BillingAddress_AddressLine2", "c"."BillingAddress_ZipCode", "c"."BillingAddress_Country_Code", "c"."BillingAddress_Country_FullName", "c0"."BillingAddress_AddressLine1" AS "BillingAddress_AddressLine10", "c0"."BillingAddress_AddressLine2" AS "BillingAddress_AddressLine20", "c0"."BillingAddress_ZipCode" AS "BillingAddress_ZipCode0", "c0"."BillingAddress_Country_Code" AS "BillingAddress_Country_Code0", "c0"."BillingAddress_Country_FullName" AS "BillingAddress_Country_FullName0"
+    FROM "Customer" AS "c"
+    CROSS JOIN "Customer" AS "c0"
+    UNION
+    SELECT "c1"."BillingAddress_AddressLine1", "c1"."BillingAddress_AddressLine2", "c1"."BillingAddress_ZipCode", "c1"."BillingAddress_Country_Code", "c1"."BillingAddress_Country_FullName", "c2"."BillingAddress_AddressLine1" AS "BillingAddress_AddressLine10", "c2"."BillingAddress_AddressLine2" AS "BillingAddress_AddressLine20", "c2"."BillingAddress_ZipCode" AS "BillingAddress_ZipCode0", "c2"."BillingAddress_Country_Code" AS "BillingAddress_Country_Code0", "c2"."BillingAddress_Country_FullName" AS "BillingAddress_Country_FullName0"
+    FROM "Customer" AS "c1"
+    CROSS JOIN "Customer" AS "c2"
+) AS "t"
+ORDER BY "t"."BillingAddress_ZipCode", "t"."BillingAddress_ZipCode0"
+LIMIT @__p_0
+""");
+    }
+
+    public override async Task Union_of_same_nested_complex_type_projected_twice_with_double_pushdown(bool async)
+    {
+        await base.Union_of_same_nested_complex_type_projected_twice_with_double_pushdown(async);
+
+        AssertSql(
+"""
+@__p_0='50'
+
+SELECT "t1"."BillingAddress_AddressLine1", "t1"."BillingAddress_AddressLine2", "t1"."BillingAddress_ZipCode", "t1"."BillingAddress_Country_Code", "t1"."BillingAddress_Country_FullName", "t1"."BillingAddress_AddressLine10", "t1"."BillingAddress_AddressLine20", "t1"."BillingAddress_ZipCode0", "t1"."BillingAddress_Country_Code0", "t1"."BillingAddress_Country_FullName0"
+FROM (
+    SELECT DISTINCT "t0"."BillingAddress_AddressLine1", "t0"."BillingAddress_AddressLine2", "t0"."BillingAddress_ZipCode", "t0"."BillingAddress_Country_Code", "t0"."BillingAddress_Country_FullName", "t0"."BillingAddress_AddressLine10", "t0"."BillingAddress_AddressLine20", "t0"."BillingAddress_ZipCode0", "t0"."BillingAddress_Country_Code0", "t0"."BillingAddress_Country_FullName0"
+    FROM (
+        SELECT "t"."BillingAddress_AddressLine1", "t"."BillingAddress_AddressLine2", "t"."BillingAddress_ZipCode", "t"."BillingAddress_Country_Code", "t"."BillingAddress_Country_FullName", "t"."BillingAddress_AddressLine10", "t"."BillingAddress_AddressLine20", "t"."BillingAddress_ZipCode0", "t"."BillingAddress_Country_Code0", "t"."BillingAddress_Country_FullName0"
+        FROM (
+            SELECT "c"."BillingAddress_AddressLine1", "c"."BillingAddress_AddressLine2", "c"."BillingAddress_ZipCode", "c"."BillingAddress_Country_Code", "c"."BillingAddress_Country_FullName", "c0"."BillingAddress_AddressLine1" AS "BillingAddress_AddressLine10", "c0"."BillingAddress_AddressLine2" AS "BillingAddress_AddressLine20", "c0"."BillingAddress_ZipCode" AS "BillingAddress_ZipCode0", "c0"."BillingAddress_Country_Code" AS "BillingAddress_Country_Code0", "c0"."BillingAddress_Country_FullName" AS "BillingAddress_Country_FullName0"
+            FROM "Customer" AS "c"
+            CROSS JOIN "Customer" AS "c0"
+            UNION
+            SELECT "c1"."BillingAddress_AddressLine1", "c1"."BillingAddress_AddressLine2", "c1"."BillingAddress_ZipCode", "c1"."BillingAddress_Country_Code", "c1"."BillingAddress_Country_FullName", "c2"."BillingAddress_AddressLine1" AS "BillingAddress_AddressLine10", "c2"."BillingAddress_AddressLine2" AS "BillingAddress_AddressLine20", "c2"."BillingAddress_ZipCode" AS "BillingAddress_ZipCode0", "c2"."BillingAddress_Country_Code" AS "BillingAddress_Country_Code0", "c2"."BillingAddress_Country_FullName" AS "BillingAddress_Country_FullName0"
+            FROM "Customer" AS "c1"
+            CROSS JOIN "Customer" AS "c2"
+        ) AS "t"
+        ORDER BY "t"."BillingAddress_ZipCode", "t"."BillingAddress_ZipCode0"
+        LIMIT @__p_0
+    ) AS "t0"
+) AS "t1"
+ORDER BY "t1"."BillingAddress_ZipCode", "t1"."BillingAddress_ZipCode0"
+LIMIT @__p_0
+""");
+    }
+
+    public override async Task Same_entity_with_complex_type_projected_twice_with_pushdown_as_part_of_another_projection(bool async)
+        => Assert.Equal(
+            SqliteStrings.ApplyNotSupported,
+            (await Assert.ThrowsAsync<InvalidOperationException>(
+                () => base.Same_entity_with_complex_type_projected_twice_with_pushdown_as_part_of_another_projection(async))).Message);
+
+    public override async Task Same_complex_type_projected_twice_with_pushdown_as_part_of_another_projection(bool async)
+        => Assert.Equal(
+            SqliteStrings.ApplyNotSupported,
+            (await Assert.ThrowsAsync<InvalidOperationException>(
+                () => base.Same_complex_type_projected_twice_with_pushdown_as_part_of_another_projection(async))).Message);
+
     [ConditionalFact]
     public virtual void Check_all_tests_overridden()
         => TestHelpers.AssertAllMethodsOverridden(GetType());
