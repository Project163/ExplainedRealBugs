diff --git a/src/EFCore.Relational/Metadata/Internal/RelationalModel.cs b/src/EFCore.Relational/Metadata/Internal/RelationalModel.cs
index 6fadc51627..67dc922156 100644
--- a/src/EFCore.Relational/Metadata/Internal/RelationalModel.cs
+++ b/src/EFCore.Relational/Metadata/Internal/RelationalModel.cs
@@ -383,7 +383,7 @@ public virtual RelationalModel MakeReadOnly()
 
         Check.DebugAssert(entityType.FindRuntimeAnnotationValue(RelationalAnnotationNames.TableMappings) == null, "not null");
         var tableMappings = new List<TableMapping>();
-        entityType.SetRuntimeAnnotation(RelationalAnnotationNames.TableMappings, tableMappings);
+        entityType.AddRuntimeAnnotation(RelationalAnnotationNames.TableMappings, tableMappings);
 
         var mappingStrategy = entityType.GetMappingStrategy();
         var isTpc = mappingStrategy == RelationalAnnotationNames.TpcMappingStrategy;
@@ -500,8 +500,13 @@ public virtual RelationalModel MakeReadOnly()
             foreach (var complexProperty in mappedType.GetDeclaredComplexProperties())
             {
                 var complexType = complexProperty.ComplexType;
-                var complexTableMappings = new List<TableMapping>();
-                complexType.SetRuntimeAnnotation(RelationalAnnotationNames.TableMappings, complexTableMappings);
+
+                var complexTableMappings = (List<TableMapping>?)complexType.FindRuntimeAnnotationValue(RelationalAnnotationNames.TableMappings);
+                if (complexTableMappings == null)
+                {
+                    complexTableMappings = [];
+                    complexType.AddRuntimeAnnotation(RelationalAnnotationNames.TableMappings, complexTableMappings);
+                }
 
                 CreateTableMapping(
                     relationalTypeMappingSource,
@@ -570,7 +575,7 @@ public virtual RelationalModel MakeReadOnly()
 
         Check.DebugAssert(entityType.FindRuntimeAnnotationValue(RelationalAnnotationNames.ViewMappings) == null, "not null");
         var viewMappings = new List<ViewMapping>();
-        entityType.SetRuntimeAnnotation(RelationalAnnotationNames.ViewMappings, viewMappings);
+        entityType.AddRuntimeAnnotation(RelationalAnnotationNames.ViewMappings, viewMappings);
 
         var mappingStrategy = entityType.GetMappingStrategy();
         var isTpc = mappingStrategy == RelationalAnnotationNames.TpcMappingStrategy;
@@ -1061,19 +1066,19 @@ private static StoreFunction GetOrCreateStoreFunction(IRuntimeDbFunction dbFunct
         if (insertStoredProcedureMappings?.Count > 0)
         {
             insertStoredProcedureMappings.Reverse();
-            entityType.SetRuntimeAnnotation(RelationalAnnotationNames.InsertStoredProcedureMappings, insertStoredProcedureMappings);
+            entityType.AddRuntimeAnnotation(RelationalAnnotationNames.InsertStoredProcedureMappings, insertStoredProcedureMappings);
         }
 
         if (deleteStoredProcedureMappings?.Count > 0)
         {
             deleteStoredProcedureMappings.Reverse();
-            entityType.SetRuntimeAnnotation(RelationalAnnotationNames.DeleteStoredProcedureMappings, deleteStoredProcedureMappings);
+            entityType.AddRuntimeAnnotation(RelationalAnnotationNames.DeleteStoredProcedureMappings, deleteStoredProcedureMappings);
         }
 
         if (updateStoredProcedureMappings?.Count > 0)
         {
             updateStoredProcedureMappings.Reverse();
-            entityType.SetRuntimeAnnotation(RelationalAnnotationNames.UpdateStoredProcedureMappings, updateStoredProcedureMappings);
+            entityType.AddRuntimeAnnotation(RelationalAnnotationNames.UpdateStoredProcedureMappings, updateStoredProcedureMappings);
         }
     }
 
diff --git a/src/EFCore/Metadata/IReadOnlyEntityType.cs b/src/EFCore/Metadata/IReadOnlyEntityType.cs
index 99646c2d79..b5ee5ba708 100644
--- a/src/EFCore/Metadata/IReadOnlyEntityType.cs
+++ b/src/EFCore/Metadata/IReadOnlyEntityType.cs
@@ -262,7 +262,7 @@ bool IsAssignableFrom(IReadOnlyEntityType derivedType)
     /// <param name="property">The property that the key is defined on.</param>
     /// <returns>The key, or null if none is defined.</returns>
     IReadOnlyKey? FindKey(IReadOnlyProperty property)
-        => FindKey(new[] { property });
+        => FindKey([property]);
 
     /// <summary>
     ///     Gets the primary and alternate keys for this entity type.
diff --git a/src/EFCore/Metadata/RuntimeAnnotatableBase.cs b/src/EFCore/Metadata/RuntimeAnnotatableBase.cs
index 260f4cfc02..cc7d6429d5 100644
--- a/src/EFCore/Metadata/RuntimeAnnotatableBase.cs
+++ b/src/EFCore/Metadata/RuntimeAnnotatableBase.cs
@@ -3,7 +3,6 @@
 
 using System.Collections.Concurrent;
 using Microsoft.EntityFrameworkCore.Internal;
-using Microsoft.EntityFrameworkCore.Metadata.Internal;
 
 namespace Microsoft.EntityFrameworkCore.Infrastructure;
 
@@ -22,7 +21,7 @@ namespace Microsoft.EntityFrameworkCore.Infrastructure;
 /// </remarks>
 public class RuntimeAnnotatableBase : IAnnotatable
 {
-    private readonly Dictionary<string, Annotation> _annotations = new(StringComparer.Ordinal);
+    private Dictionary<string, Annotation>? _annotations;
     private ConcurrentDictionary<string, Annotation>? _runtimeAnnotations;
 
     /// <summary>
@@ -104,6 +103,7 @@ public virtual void SetAnnotation(string name, object? value)
         string name,
         Annotation annotation)
     {
+        _annotations ??= new(StringComparer.Ordinal);
         _annotations[name] = annotation;
 
         return annotation;
@@ -120,7 +120,7 @@ public virtual void SetAnnotation(string name, object? value)
     {
         Check.NotEmpty(name, nameof(name));
 
-        return _annotations.TryGetValue(name, out var annotation)
+        return _annotations != null && _annotations.TryGetValue(name, out var annotation)
                 ? annotation
                 : null;
     }
@@ -143,6 +143,26 @@ public virtual Annotation GetAnnotation(string annotationName)
         return annotation;
     }
 
+    /// <summary>
+    ///     Removes the given annotation from this object.
+    /// </summary>
+    /// <param name="name">The annotation to remove.</param>
+    /// <returns>The annotation that was removed.</returns>
+    public virtual Annotation? RemoveAnnotation(string name)
+    {
+        Check.NotNull(name, nameof(name));
+
+        var annotation = FindAnnotation(name);
+        if (annotation == null)
+        {
+            return null;
+        }
+
+        _annotations!.Remove(name);
+
+        return annotation;
+    }
+
     /// <summary>
     ///     Gets the value annotation with the given name, returning <see langword="null" /> if it does not exist.
     /// </summary>
@@ -151,7 +171,24 @@ public virtual Annotation GetAnnotation(string annotationName)
     ///     The value of the existing annotation if an annotation with the specified name already exists.
     ///     Otherwise, <see langword="null" />.
     /// </returns>
-    public virtual object? this[string name] => FindAnnotation(name)?.Value;
+    public virtual object? this[string name]
+    {
+        get => FindAnnotation(name)?.Value;
+
+        set
+        {
+            Check.NotEmpty(name, nameof(name));
+
+            if (value == null)
+            {
+                RemoveAnnotation(name);
+            }
+            else
+            {
+                SetAnnotation(name, value);
+            }
+        }
+    }
 
     /// <summary>
     ///     Creates a new annotation.
@@ -330,7 +367,7 @@ protected virtual Annotation CreateRuntimeAnnotation(string name, object? value)
     /// <inheritdoc />
     [DebuggerStepThrough]
     IEnumerable<IAnnotation> IReadOnlyAnnotatable.GetAnnotations()
-        => _annotations.Values.OrderBy(a => a.Name, StringComparer.Ordinal);
+        => _annotations?.Values.OrderBy(a => a.Name, StringComparer.Ordinal) ?? Enumerable.Empty<Annotation>();
 
     /// <inheritdoc />
     [DebuggerStepThrough]
diff --git a/src/EFCore/Metadata/RuntimeEntityType.cs b/src/EFCore/Metadata/RuntimeEntityType.cs
index 3dc3f2ba6b..415375d4de 100644
--- a/src/EFCore/Metadata/RuntimeEntityType.cs
+++ b/src/EFCore/Metadata/RuntimeEntityType.cs
@@ -94,12 +94,12 @@ public class RuntimeEntityType : RuntimeTypeBase, IRuntimeEntityType
             _serviceProperties = new(servicePropertyCount, StringComparer.Ordinal);
         }
         _unnamedIndexes = new(unnamedIndexCount, PropertyListComparer.Instance);
-        if(namedIndexCount > 0)
+        if (namedIndexCount > 0)
         {
             _namedIndexes = new(namedIndexCount, StringComparer.Ordinal);
         }
         _keys = new(keyCount, PropertyListComparer.Instance);
-        if(triggerPropertyCount > 0)
+        if (triggerPropertyCount > 0)
         {
             _triggers = new(triggerPropertyCount, StringComparer.Ordinal);
         }
@@ -168,10 +168,23 @@ public virtual RuntimeKey AddKey(IReadOnlyList<RuntimeProperty> properties)
             ? key
             : BaseType?.FindKey(properties);
 
-    private IEnumerable<RuntimeKey> GetDeclaredKeys()
+    /// <summary>
+    ///     Gets all keys declared on this entity type.
+    /// </summary>
+    /// <remarks>
+    ///     This method does not return keys declared on base types.
+    ///     It is useful when iterating over all entity types to avoid processing the same key more than once.
+    ///     Use <see cref="GetKeys" /> to also return keys declared on base types.
+    /// </remarks>
+    /// <returns>Declared keys.</returns>
+    public virtual IEnumerable<RuntimeKey> GetDeclaredKeys()
         => _keys.Values;
 
-    private IEnumerable<RuntimeKey> GetKeys()
+    /// <summary>
+    ///     Gets the primary and alternate keys for this entity type.
+    /// </summary>
+    /// <returns>The primary and alternate keys.</returns>
+    public virtual IEnumerable<RuntimeKey> GetKeys()
         => BaseType?.GetKeys().Concat(_keys.Values) ?? _keys.Values;
 
     /// <summary>
@@ -268,12 +281,27 @@ private IEnumerable<RuntimeForeignKey> FindForeignKeys(IReadOnlyList<IReadOnlyPr
         => FindDeclaredForeignKey(properties, principalKey, principalEntityType)
             ?? BaseType?.FindForeignKey(properties, principalKey, principalEntityType);
 
+    /// <summary>
+    ///     Gets all foreign keys declared on this entity type..
+    /// </summary>
+    /// <remarks>
+    ///     This method does not return foreign keys declared on base types.
+    ///     It is useful when iterating over all entity types to avoid processing the same foreign key more than once.
+    ///     Use <see cref="GetForeignKeys" /> to also return foreign keys declared on base types.
+    /// </remarks>
+    /// <returns>Declared foreign keys.</returns>
+    public virtual List<RuntimeForeignKey> GetDeclaredForeignKeys() => _foreignKeys;
+
     private IEnumerable<RuntimeForeignKey> GetDerivedForeignKeys()
         => !HasDirectlyDerivedTypes
             ? Enumerable.Empty<RuntimeForeignKey>()
             : GetDerivedTypes().Cast<RuntimeEntityType>().SelectMany(et => et._foreignKeys);
 
-    private IEnumerable<RuntimeForeignKey> GetForeignKeys()
+    /// <summary>
+    ///     Gets the foreign keys defined on this entity type.
+    /// </summary>
+    /// <returns>The foreign keys defined on this entity type.</returns>
+    public virtual IEnumerable<RuntimeForeignKey> GetForeignKeys()
         => BaseType != null
             ? _foreignKeys.Count == 0
                 ? BaseType.GetForeignKeys()
@@ -560,7 +588,16 @@ public virtual IEnumerable<RuntimeSkipNavigation> FindSkipNavigationsInHierarchy
             ? index
             : BaseType?.FindIndex(name);
 
-    private IEnumerable<RuntimeIndex> GetDeclaredIndexes()
+    /// <summary>
+    ///     Gets all indexes declared on this entity type.
+    /// </summary>
+    /// <remarks>
+    ///     This method does not return indexes declared on base types.
+    ///     It is useful when iterating over all entity types to avoid processing the same index more than once.
+    ///     Use <see cref="GetForeignKeys" /> to also return indexes declared on base types.
+    /// </remarks>
+    /// <returns>Declared indexes.</returns>
+    public virtual IEnumerable<RuntimeIndex> GetDeclaredIndexes()
         => _namedIndexes == null
             ? _unnamedIndexes.Values
             : _unnamedIndexes.Values.Concat(_namedIndexes.Values);
@@ -570,7 +607,11 @@ private IEnumerable<RuntimeIndex> GetDerivedIndexes()
             ? Enumerable.Empty<RuntimeIndex>()
             : GetDerivedTypes().Cast<RuntimeEntityType>().SelectMany(et => et.GetDeclaredIndexes());
 
-    private IEnumerable<RuntimeIndex> GetIndexes()
+    /// <summary>
+    ///     Gets the indexes defined on this entity type.
+    /// </summary>
+    /// <returns>The indexes defined on this entity type.</returns>
+    public virtual IEnumerable<RuntimeIndex> GetIndexes()
         => BaseType != null
             ? _namedIndexes == null
                 ? BaseType.GetIndexes()
@@ -1057,12 +1098,12 @@ IEnumerable<IForeignKey> IEntityType.GetForeignKeys()
     /// <inheritdoc />
     [DebuggerStepThrough]
     IEnumerable<IReadOnlyForeignKey> IReadOnlyEntityType.GetDeclaredForeignKeys()
-        => _foreignKeys;
+        => GetDeclaredForeignKeys();
 
     /// <inheritdoc />
     [DebuggerStepThrough]
     IEnumerable<IForeignKey> IEntityType.GetDeclaredForeignKeys()
-        => _foreignKeys;
+        => GetDeclaredForeignKeys();
 
     /// <inheritdoc />
     [DebuggerStepThrough]
diff --git a/src/EFCore/Metadata/RuntimeModel.cs b/src/EFCore/Metadata/RuntimeModel.cs
index ae84df6a36..d722ac7c30 100644
--- a/src/EFCore/Metadata/RuntimeModel.cs
+++ b/src/EFCore/Metadata/RuntimeModel.cs
@@ -247,6 +247,16 @@ private IEnumerable<RuntimeEntityType> FindEntityTypes(Type type)
             : result;
     }
 
+    /// <summary>
+    ///     Gets all entity types defined in the model.
+    /// </summary>
+    /// <remarks>
+    ///     See <see href="https://aka.ms/efcore-docs-modeling">Modeling entity types and relationships</see> for more information and examples.
+    /// </remarks>
+    /// <returns>All entity types defined in the model.</returns>
+    private IEnumerable<RuntimeEntityType> GetEntityTypes()
+        => _entityTypes.Values.OrderBy(e => e.Name, StringComparer.Ordinal);
+
     /// <summary>
     ///     Adds configuration for a scalar type.
     /// </summary>
@@ -392,12 +402,12 @@ bool IModel.IsIndexerMethod(MethodInfo methodInfo)
     /// <inheritdoc />
     [DebuggerStepThrough]
     IEnumerable<IReadOnlyEntityType> IReadOnlyModel.GetEntityTypes()
-        => _entityTypes.Values.OrderBy(e => e.Name, StringComparer.Ordinal);
+        => GetEntityTypes();
 
     /// <inheritdoc />
     [DebuggerStepThrough]
     IEnumerable<IEntityType> IModel.GetEntityTypes()
-        => _entityTypes.Values.OrderBy(e => e.Name, StringComparer.Ordinal);
+        => GetEntityTypes();
 
     /// <inheritdoc />
     [DebuggerStepThrough]
diff --git a/src/EFCore/Metadata/RuntimeTypeBase.cs b/src/EFCore/Metadata/RuntimeTypeBase.cs
index 84c96cbb0a..aea301e943 100644
--- a/src/EFCore/Metadata/RuntimeTypeBase.cs
+++ b/src/EFCore/Metadata/RuntimeTypeBase.cs
@@ -258,7 +258,7 @@ protected virtual IEnumerable<T> GetDerivedTypes<T>()
         => _properties.TryGetValue(name, out var property)
             ? property
             : null;
-    
+
     /// <summary>
     ///     Gets all scalar properties declared on this type.
     /// </summary>
diff --git a/test/EFCore.Relational.Specification.Tests/Scaffolding/CompiledModelRelationalTestBase.cs b/test/EFCore.Relational.Specification.Tests/Scaffolding/CompiledModelRelationalTestBase.cs
index 6a84c1bc5b..f8d50cdce5 100644
--- a/test/EFCore.Relational.Specification.Tests/Scaffolding/CompiledModelRelationalTestBase.cs
+++ b/test/EFCore.Relational.Specification.Tests/Scaffolding/CompiledModelRelationalTestBase.cs
@@ -1176,6 +1176,104 @@ protected override void OnModelCreating(ModelBuilder modelBuilder)
         }
     }
 
+    [ConditionalFact]
+    public virtual void Dynamic_schema()
+        => Test(
+            modelBuilder => modelBuilder.Entity<Data>(
+                eb =>
+                {
+                    eb.Property<int>("Id");
+                    eb.HasKey("Id");
+                }),
+            model =>
+            {
+                Assert.Equal("custom", model.GetDefaultSchema());
+
+                var dataEntity = model.GetEntityTypes().Single();
+                Assert.Equal("custom", dataEntity.GetSchema());
+            },
+            additionalSourceFiles:
+            [
+                new()
+                {
+                    Path = "DbContextModelCustomizer.cs",
+                    Code = """
+using Microsoft.EntityFrameworkCore.Metadata;
+
+namespace TestNamespace;
+
+public partial class DbContextModel
+{
+    private string DefaultSchema { get; init; } = "custom";
+
+    partial void Customize()
+    {
+        RemoveAnnotation("Relational:DefaultSchema");
+        AddAnnotation("Relational:DefaultSchema", DefaultSchema);
+        RemoveRuntimeAnnotation("Relational:RelationalModel");
+
+        foreach (RuntimeEntityType entityType in ((IModel)this).GetEntityTypes())
+        {
+            Customize(entityType);
+
+            foreach (var key in entityType.GetDeclaredKeys())
+            {
+                key.RemoveRuntimeAnnotation(RelationalAnnotationNames.UniqueConstraintMappings);
+            }
+
+            foreach (var index in entityType.GetDeclaredIndexes())
+            {
+                index.RemoveRuntimeAnnotation(RelationalAnnotationNames.TableIndexMappings);
+            }
+
+            foreach (var foreignKey in entityType.GetDeclaredForeignKeys())
+            {
+                foreignKey.RemoveRuntimeAnnotation(RelationalAnnotationNames.ForeignKeyMappings);
+            }
+
+            var tableName = entityType.FindAnnotation("Relational:TableName")?.Value as string;
+            if (string.IsNullOrEmpty(tableName))
+                continue;
+
+            entityType.SetAnnotation("Relational:Schema", DefaultSchema);
+        }
+    }
+
+    private static void Customize(RuntimeTypeBase entityType)
+    {
+        entityType.RemoveRuntimeAnnotation(RelationalAnnotationNames.DefaultMappings);
+        entityType.RemoveRuntimeAnnotation(RelationalAnnotationNames.TableMappings);
+        entityType.RemoveRuntimeAnnotation(RelationalAnnotationNames.ViewMappings);
+        entityType.RemoveRuntimeAnnotation(RelationalAnnotationNames.SqlQueryMappings);
+        entityType.RemoveRuntimeAnnotation(RelationalAnnotationNames.FunctionMappings);
+        entityType.RemoveRuntimeAnnotation(RelationalAnnotationNames.InsertStoredProcedureMappings);
+        entityType.RemoveRuntimeAnnotation(RelationalAnnotationNames.DeleteStoredProcedureMappings);
+        entityType.RemoveRuntimeAnnotation(RelationalAnnotationNames.UpdateStoredProcedureMappings);
+
+        foreach (var property in entityType.GetDeclaredProperties())
+        {
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.DefaultColumnMappings);
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.TableColumnMappings);
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.ViewColumnMappings);
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.SqlQueryColumnMappings);
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.FunctionColumnMappings);
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.InsertStoredProcedureParameterMappings);
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.DeleteStoredProcedureParameterMappings);
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.UpdateStoredProcedureParameterMappings);
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.InsertStoredProcedureResultColumnMappings);
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.UpdateStoredProcedureResultColumnMappings);
+        }
+
+        foreach (var complexProperty in entityType.GetDeclaredComplexProperties())
+        {
+            Customize(complexProperty.ComplexType);
+        }
+    }
+}
+"""
+                }
+            ]);
+
     public class SpatialTypes : AbstractBase;
 
     protected override BuildSource AddReferences(BuildSource build, [CallerFilePath] string filePath = "")
diff --git a/test/EFCore.Specification.Tests/Scaffolding/CompiledModelTestBase.cs b/test/EFCore.Specification.Tests/Scaffolding/CompiledModelTestBase.cs
index a1f8f8dc61..e06bda7dd3 100644
--- a/test/EFCore.Specification.Tests/Scaffolding/CompiledModelTestBase.cs
+++ b/test/EFCore.Specification.Tests/Scaffolding/CompiledModelTestBase.cs
@@ -1233,6 +1233,7 @@ protected virtual void AddDesignTimeServices(IServiceCollection services)
         CompiledModelCodeGenerationOptions? options = null,
         Func<IServiceCollection, IServiceCollection>? addServices = null,
         Func<IServiceCollection, IServiceCollection>? addDesignTimeServices = null,
+        IEnumerable<ScaffoldedFile>? additionalSourceFiles = null,
         string? expectedExceptionMessage = null,
         [CallerMemberName] string testName = "")
         => Test<DbContext>(
@@ -1243,6 +1244,7 @@ protected virtual void AddDesignTimeServices(IServiceCollection services)
             options,
             addServices,
             addDesignTimeServices,
+            additionalSourceFiles,
             expectedExceptionMessage,
             testName);
 
@@ -1254,6 +1256,7 @@ protected virtual void AddDesignTimeServices(IServiceCollection services)
         CompiledModelCodeGenerationOptions? options = null,
         Func<IServiceCollection, IServiceCollection>? addServices = null,
         Func<IServiceCollection, IServiceCollection>? addDesignTimeServices = null,
+        IEnumerable<ScaffoldedFile>? additionalSourceFiles = null,
         string? expectedExceptionMessage = null,
         [CallerMemberName] string testName = "")
         where TContext : DbContext
@@ -1300,10 +1303,18 @@ protected virtual void AddDesignTimeServices(IServiceCollection services)
             model,
             options);
 
+        if (additionalSourceFiles != null)
+        {
+            scaffoldedFiles = scaffoldedFiles.Concat(additionalSourceFiles).ToArray();
+        }
+
         var compiledModel = CompileModel(scaffoldedFiles, options, context);
         assertModel?.Invoke(compiledModel);
 
-        TestHelpers.ModelAsserter.AssertEqual(context.Model, compiledModel);
+        if (additionalSourceFiles == null)
+        {
+            TestHelpers.ModelAsserter.AssertEqual(context.Model, compiledModel);
+        }
 
         if (useContext != null)
         {
diff --git a/test/EFCore.SqlServer.FunctionalTests/Scaffolding/Baselines/Dynamic_schema/DataEntityType.cs b/test/EFCore.SqlServer.FunctionalTests/Scaffolding/Baselines/Dynamic_schema/DataEntityType.cs
new file mode 100644
index 0000000000..15190be66a
--- /dev/null
+++ b/test/EFCore.SqlServer.FunctionalTests/Scaffolding/Baselines/Dynamic_schema/DataEntityType.cs
@@ -0,0 +1,94 @@
+// <auto-generated />
+using System;
+using System.Collections;
+using System.Linq;
+using System.Reflection;
+using Microsoft.EntityFrameworkCore.ChangeTracking;
+using Microsoft.EntityFrameworkCore.Metadata;
+using Microsoft.EntityFrameworkCore.Scaffolding;
+using Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal;
+using Microsoft.EntityFrameworkCore.Storage;
+
+#pragma warning disable 219, 612, 618
+#nullable disable
+
+namespace TestNamespace
+{
+    internal partial class DataEntityType
+    {
+        public static RuntimeEntityType Create(RuntimeModel model, RuntimeEntityType baseEntityType = null)
+        {
+            var runtimeEntityType = model.AddEntityType(
+                "Microsoft.EntityFrameworkCore.Scaffolding.CompiledModelTestBase+Data",
+                typeof(CompiledModelTestBase.Data),
+                baseEntityType,
+                propertyCount: 2,
+                keyCount: 1);
+
+            var id = runtimeEntityType.AddProperty(
+                "Id",
+                typeof(int),
+                valueGenerated: ValueGenerated.OnAdd,
+                afterSaveBehavior: PropertySaveBehavior.Throw,
+                sentinel: 0);
+            id.TypeMapping = IntTypeMapping.Default.Clone(
+                comparer: new ValueComparer<int>(
+                    (int v1, int v2) => v1 == v2,
+                    (int v) => v,
+                    (int v) => v),
+                keyComparer: new ValueComparer<int>(
+                    (int v1, int v2) => v1 == v2,
+                    (int v) => v,
+                    (int v) => v),
+                providerValueComparer: new ValueComparer<int>(
+                    (int v1, int v2) => v1 == v2,
+                    (int v) => v,
+                    (int v) => v));
+            id.AddAnnotation("SqlServer:ValueGenerationStrategy", SqlServerValueGenerationStrategy.IdentityColumn);
+
+            var blob = runtimeEntityType.AddProperty(
+                "Blob",
+                typeof(byte[]),
+                propertyInfo: typeof(CompiledModelTestBase.Data).GetProperty("Blob", BindingFlags.Public | BindingFlags.Instance | BindingFlags.DeclaredOnly),
+                fieldInfo: typeof(CompiledModelTestBase.Data).GetField("<Blob>k__BackingField", BindingFlags.NonPublic | BindingFlags.Instance | BindingFlags.DeclaredOnly),
+                nullable: true);
+            blob.TypeMapping = SqlServerByteArrayTypeMapping.Default.Clone(
+                comparer: new ValueComparer<byte[]>(
+                    (Byte[] v1, Byte[] v2) => StructuralComparisons.StructuralEqualityComparer.Equals((object)v1, (object)v2),
+                    (Byte[] v) => v.GetHashCode(),
+                    (Byte[] v) => v),
+                keyComparer: new ValueComparer<byte[]>(
+                    (Byte[] v1, Byte[] v2) => StructuralComparisons.StructuralEqualityComparer.Equals((object)v1, (object)v2),
+                    (Byte[] v) => StructuralComparisons.StructuralEqualityComparer.GetHashCode((object)v),
+                    (Byte[] source) => source.ToArray()),
+                providerValueComparer: new ValueComparer<byte[]>(
+                    (Byte[] v1, Byte[] v2) => StructuralComparisons.StructuralEqualityComparer.Equals((object)v1, (object)v2),
+                    (Byte[] v) => StructuralComparisons.StructuralEqualityComparer.GetHashCode((object)v),
+                    (Byte[] source) => source.ToArray()),
+                mappingInfo: new RelationalTypeMappingInfo(
+                    storeTypeName: "varbinary(max)"),
+                storeTypePostfix: StoreTypePostfix.None);
+            blob.AddAnnotation("SqlServer:ValueGenerationStrategy", SqlServerValueGenerationStrategy.None);
+
+            var key = runtimeEntityType.AddKey(
+                new[] { id });
+            runtimeEntityType.SetPrimaryKey(key);
+
+            return runtimeEntityType;
+        }
+
+        public static void CreateAnnotations(RuntimeEntityType runtimeEntityType)
+        {
+            runtimeEntityType.AddAnnotation("Relational:FunctionName", null);
+            runtimeEntityType.AddAnnotation("Relational:Schema", null);
+            runtimeEntityType.AddAnnotation("Relational:SqlQuery", null);
+            runtimeEntityType.AddAnnotation("Relational:TableName", "Data");
+            runtimeEntityType.AddAnnotation("Relational:ViewName", null);
+            runtimeEntityType.AddAnnotation("Relational:ViewSchema", null);
+
+            Customize(runtimeEntityType);
+        }
+
+        static partial void Customize(RuntimeEntityType runtimeEntityType);
+    }
+}
diff --git a/test/EFCore.SqlServer.FunctionalTests/Scaffolding/Baselines/Dynamic_schema/DbContextModel.cs b/test/EFCore.SqlServer.FunctionalTests/Scaffolding/Baselines/Dynamic_schema/DbContextModel.cs
new file mode 100644
index 0000000000..583ee4d90c
--- /dev/null
+++ b/test/EFCore.SqlServer.FunctionalTests/Scaffolding/Baselines/Dynamic_schema/DbContextModel.cs
@@ -0,0 +1,48 @@
+// <auto-generated />
+using Microsoft.EntityFrameworkCore;
+using Microsoft.EntityFrameworkCore.Infrastructure;
+using Microsoft.EntityFrameworkCore.Metadata;
+
+#pragma warning disable 219, 612, 618
+#nullable disable
+
+namespace TestNamespace
+{
+    [DbContext(typeof(DbContext))]
+    public partial class DbContextModel : RuntimeModel
+    {
+        private static readonly bool _useOldBehavior31751 =
+            System.AppContext.TryGetSwitch("Microsoft.EntityFrameworkCore.Issue31751", out var enabled31751) && enabled31751;
+
+        static DbContextModel()
+        {
+            var model = new DbContextModel();
+
+            if (_useOldBehavior31751)
+            {
+                model.Initialize();
+            }
+            else
+            {
+                var thread = new System.Threading.Thread(RunInitialization, 10 * 1024 * 1024);
+                thread.Start();
+                thread.Join();
+
+                void RunInitialization()
+                {
+                    model.Initialize();
+                }
+            }
+
+            model.Customize();
+            _instance = (DbContextModel)model.FinalizeModel();
+        }
+
+        private static DbContextModel _instance;
+        public static IModel Instance => _instance;
+
+        partial void Initialize();
+
+        partial void Customize();
+    }
+}
diff --git a/test/EFCore.SqlServer.FunctionalTests/Scaffolding/Baselines/Dynamic_schema/DbContextModelBuilder.cs b/test/EFCore.SqlServer.FunctionalTests/Scaffolding/Baselines/Dynamic_schema/DbContextModelBuilder.cs
new file mode 100644
index 0000000000..b62372a6a9
--- /dev/null
+++ b/test/EFCore.SqlServer.FunctionalTests/Scaffolding/Baselines/Dynamic_schema/DbContextModelBuilder.cs
@@ -0,0 +1,82 @@
+// <auto-generated />
+using System;
+using System.Collections.Generic;
+using Microsoft.EntityFrameworkCore;
+using Microsoft.EntityFrameworkCore.Infrastructure;
+using Microsoft.EntityFrameworkCore.Metadata;
+using Microsoft.EntityFrameworkCore.Metadata.Internal;
+
+#pragma warning disable 219, 612, 618
+#nullable disable
+
+namespace TestNamespace
+{
+    public partial class DbContextModel
+    {
+        private DbContextModel()
+            : base(skipDetectChanges: false, modelId: new Guid("00000000-0000-0000-0000-000000000000"), entityTypeCount: 1)
+        {
+        }
+
+        partial void Initialize()
+        {
+            var data = DataEntityType.Create(this);
+
+            DataEntityType.CreateAnnotations(data);
+
+            AddAnnotation("Relational:MaxIdentifierLength", 128);
+            AddAnnotation("SqlServer:ValueGenerationStrategy", SqlServerValueGenerationStrategy.IdentityColumn);
+            AddRuntimeAnnotation("Relational:RelationalModel", CreateRelationalModel());
+        }
+
+        private IRelationalModel CreateRelationalModel()
+        {
+            var relationalModel = new RelationalModel(this);
+
+            var data = FindEntityType("Microsoft.EntityFrameworkCore.Scaffolding.CompiledModelTestBase+Data")!;
+
+            var defaultTableMappings = new List<TableMappingBase<ColumnMappingBase>>();
+            data.SetRuntimeAnnotation("Relational:DefaultMappings", defaultTableMappings);
+            var microsoftEntityFrameworkCoreScaffoldingCompiledModelTestBaseDataTableBase = new TableBase("Microsoft.EntityFrameworkCore.Scaffolding.CompiledModelTestBase+Data", null, relationalModel);
+            var blobColumnBase = new ColumnBase<ColumnMappingBase>("Blob", "varbinary(max)", microsoftEntityFrameworkCoreScaffoldingCompiledModelTestBaseDataTableBase)
+            {
+                IsNullable = true
+            };
+            microsoftEntityFrameworkCoreScaffoldingCompiledModelTestBaseDataTableBase.Columns.Add("Blob", blobColumnBase);
+            var idColumnBase = new ColumnBase<ColumnMappingBase>("Id", "int", microsoftEntityFrameworkCoreScaffoldingCompiledModelTestBaseDataTableBase);
+            microsoftEntityFrameworkCoreScaffoldingCompiledModelTestBaseDataTableBase.Columns.Add("Id", idColumnBase);
+            relationalModel.DefaultTables.Add("Microsoft.EntityFrameworkCore.Scaffolding.CompiledModelTestBase+Data", microsoftEntityFrameworkCoreScaffoldingCompiledModelTestBaseDataTableBase);
+            var microsoftEntityFrameworkCoreScaffoldingCompiledModelTestBaseDataMappingBase = new TableMappingBase<ColumnMappingBase>(data, microsoftEntityFrameworkCoreScaffoldingCompiledModelTestBaseDataTableBase, null);
+            microsoftEntityFrameworkCoreScaffoldingCompiledModelTestBaseDataTableBase.AddTypeMapping(microsoftEntityFrameworkCoreScaffoldingCompiledModelTestBaseDataMappingBase, false);
+            defaultTableMappings.Add(microsoftEntityFrameworkCoreScaffoldingCompiledModelTestBaseDataMappingBase);
+            RelationalModel.CreateColumnMapping((ColumnBase<ColumnMappingBase>)idColumnBase, data.FindProperty("Id")!, microsoftEntityFrameworkCoreScaffoldingCompiledModelTestBaseDataMappingBase);
+            RelationalModel.CreateColumnMapping((ColumnBase<ColumnMappingBase>)blobColumnBase, data.FindProperty("Blob")!, microsoftEntityFrameworkCoreScaffoldingCompiledModelTestBaseDataMappingBase);
+
+            var tableMappings = new List<TableMapping>();
+            data.SetRuntimeAnnotation("Relational:TableMappings", tableMappings);
+            var dataTable = new Table("Data", null, relationalModel);
+            var idColumn = new Column("Id", "int", dataTable);
+            dataTable.Columns.Add("Id", idColumn);
+            var blobColumn = new Column("Blob", "varbinary(max)", dataTable)
+            {
+                IsNullable = true
+            };
+            dataTable.Columns.Add("Blob", blobColumn);
+            var pK_Data = new UniqueConstraint("PK_Data", dataTable, new[] { idColumn });
+            dataTable.PrimaryKey = pK_Data;
+            var pK_DataUc = RelationalModel.GetKey(this,
+                "Microsoft.EntityFrameworkCore.Scaffolding.CompiledModelTestBase+Data",
+                new[] { "Id" });
+            pK_Data.MappedKeys.Add(pK_DataUc);
+            RelationalModel.GetOrCreateUniqueConstraints(pK_DataUc).Add(pK_Data);
+            dataTable.UniqueConstraints.Add("PK_Data", pK_Data);
+            relationalModel.Tables.Add(("Data", null), dataTable);
+            var dataTableMapping = new TableMapping(data, dataTable, null);
+            dataTable.AddTypeMapping(dataTableMapping, false);
+            tableMappings.Add(dataTableMapping);
+            RelationalModel.CreateColumnMapping(idColumn, data.FindProperty("Id")!, dataTableMapping);
+            RelationalModel.CreateColumnMapping(blobColumn, data.FindProperty("Blob")!, dataTableMapping);
+            return relationalModel.MakeReadOnly();
+        }
+    }
+}
diff --git a/test/EFCore.SqlServer.FunctionalTests/Scaffolding/Baselines/Dynamic_schema/DbContextModelCustomizer.cs b/test/EFCore.SqlServer.FunctionalTests/Scaffolding/Baselines/Dynamic_schema/DbContextModelCustomizer.cs
new file mode 100644
index 0000000000..8d477de97c
--- /dev/null
+++ b/test/EFCore.SqlServer.FunctionalTests/Scaffolding/Baselines/Dynamic_schema/DbContextModelCustomizer.cs
@@ -0,0 +1,72 @@
+using Microsoft.EntityFrameworkCore.Metadata;
+
+namespace TestNamespace;
+
+public partial class DbContextModel
+{
+    private string DefaultSchema { get; init; } = "custom";
+
+    partial void Customize()
+    {
+        RemoveAnnotation("Relational:DefaultSchema");
+        AddAnnotation("Relational:DefaultSchema", DefaultSchema);
+        RemoveRuntimeAnnotation("Relational:RelationalModel");
+
+        foreach (RuntimeEntityType entityType in ((IModel)this).GetEntityTypes())
+        {
+            Customize(entityType);
+
+            foreach (var key in entityType.GetDeclaredKeys())
+            {
+                key.RemoveRuntimeAnnotation(RelationalAnnotationNames.UniqueConstraintMappings);
+            }
+
+            foreach (var index in entityType.GetDeclaredIndexes())
+            {
+                index.RemoveRuntimeAnnotation(RelationalAnnotationNames.TableIndexMappings);
+            }
+
+            foreach (var foreignKey in entityType.GetDeclaredForeignKeys())
+            {
+                foreignKey.RemoveRuntimeAnnotation(RelationalAnnotationNames.ForeignKeyMappings);
+            }
+
+            var tableName = entityType.FindAnnotation("Relational:TableName")?.Value as string;
+            if (string.IsNullOrEmpty(tableName))
+                continue;
+
+            entityType.SetAnnotation("Relational:Schema", DefaultSchema);
+        }
+    }
+
+    private static void Customize(RuntimeTypeBase entityType)
+    {
+        entityType.RemoveRuntimeAnnotation(RelationalAnnotationNames.DefaultMappings);
+        entityType.RemoveRuntimeAnnotation(RelationalAnnotationNames.TableMappings);
+        entityType.RemoveRuntimeAnnotation(RelationalAnnotationNames.ViewMappings);
+        entityType.RemoveRuntimeAnnotation(RelationalAnnotationNames.SqlQueryMappings);
+        entityType.RemoveRuntimeAnnotation(RelationalAnnotationNames.FunctionMappings);
+        entityType.RemoveRuntimeAnnotation(RelationalAnnotationNames.InsertStoredProcedureMappings);
+        entityType.RemoveRuntimeAnnotation(RelationalAnnotationNames.DeleteStoredProcedureMappings);
+        entityType.RemoveRuntimeAnnotation(RelationalAnnotationNames.UpdateStoredProcedureMappings);
+
+        foreach (var property in entityType.GetDeclaredProperties())
+        {
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.DefaultColumnMappings);
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.TableColumnMappings);
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.ViewColumnMappings);
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.SqlQueryColumnMappings);
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.FunctionColumnMappings);
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.InsertStoredProcedureParameterMappings);
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.DeleteStoredProcedureParameterMappings);
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.UpdateStoredProcedureParameterMappings);
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.InsertStoredProcedureResultColumnMappings);
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.UpdateStoredProcedureResultColumnMappings);
+        }
+
+        foreach (var complexProperty in entityType.GetDeclaredComplexProperties())
+        {
+            Customize(complexProperty.ComplexType);
+        }
+    }
+}
\ No newline at end of file
diff --git a/test/EFCore.Sqlite.FunctionalTests/Scaffolding/Baselines/Dynamic_schema/DataEntityType.cs b/test/EFCore.Sqlite.FunctionalTests/Scaffolding/Baselines/Dynamic_schema/DataEntityType.cs
new file mode 100644
index 0000000000..a0cb6fe06e
--- /dev/null
+++ b/test/EFCore.Sqlite.FunctionalTests/Scaffolding/Baselines/Dynamic_schema/DataEntityType.cs
@@ -0,0 +1,91 @@
+// <auto-generated />
+using System;
+using System.Collections;
+using System.Linq;
+using System.Reflection;
+using Microsoft.EntityFrameworkCore.ChangeTracking;
+using Microsoft.EntityFrameworkCore.Metadata;
+using Microsoft.EntityFrameworkCore.Scaffolding;
+using Microsoft.EntityFrameworkCore.Sqlite.Storage.Internal;
+using Microsoft.EntityFrameworkCore.Storage;
+
+#pragma warning disable 219, 612, 618
+#nullable disable
+
+namespace TestNamespace
+{
+    internal partial class DataEntityType
+    {
+        public static RuntimeEntityType Create(RuntimeModel model, RuntimeEntityType baseEntityType = null)
+        {
+            var runtimeEntityType = model.AddEntityType(
+                "Microsoft.EntityFrameworkCore.Scaffolding.CompiledModelTestBase+Data",
+                typeof(CompiledModelTestBase.Data),
+                baseEntityType,
+                propertyCount: 2,
+                keyCount: 1);
+
+            var id = runtimeEntityType.AddProperty(
+                "Id",
+                typeof(int),
+                valueGenerated: ValueGenerated.OnAdd,
+                afterSaveBehavior: PropertySaveBehavior.Throw,
+                sentinel: 0);
+            id.TypeMapping = IntTypeMapping.Default.Clone(
+                comparer: new ValueComparer<int>(
+                    (int v1, int v2) => v1 == v2,
+                    (int v) => v,
+                    (int v) => v),
+                keyComparer: new ValueComparer<int>(
+                    (int v1, int v2) => v1 == v2,
+                    (int v) => v,
+                    (int v) => v),
+                providerValueComparer: new ValueComparer<int>(
+                    (int v1, int v2) => v1 == v2,
+                    (int v) => v,
+                    (int v) => v),
+                mappingInfo: new RelationalTypeMappingInfo(
+                    storeTypeName: "INTEGER"));
+
+            var blob = runtimeEntityType.AddProperty(
+                "Blob",
+                typeof(byte[]),
+                propertyInfo: typeof(CompiledModelTestBase.Data).GetProperty("Blob", BindingFlags.Public | BindingFlags.Instance | BindingFlags.DeclaredOnly),
+                fieldInfo: typeof(CompiledModelTestBase.Data).GetField("<Blob>k__BackingField", BindingFlags.NonPublic | BindingFlags.Instance | BindingFlags.DeclaredOnly),
+                nullable: true);
+            blob.TypeMapping = SqliteByteArrayTypeMapping.Default.Clone(
+                comparer: new ValueComparer<byte[]>(
+                    (Byte[] v1, Byte[] v2) => StructuralComparisons.StructuralEqualityComparer.Equals((object)v1, (object)v2),
+                    (Byte[] v) => v.GetHashCode(),
+                    (Byte[] v) => v),
+                keyComparer: new ValueComparer<byte[]>(
+                    (Byte[] v1, Byte[] v2) => StructuralComparisons.StructuralEqualityComparer.Equals((object)v1, (object)v2),
+                    (Byte[] v) => StructuralComparisons.StructuralEqualityComparer.GetHashCode((object)v),
+                    (Byte[] source) => source.ToArray()),
+                providerValueComparer: new ValueComparer<byte[]>(
+                    (Byte[] v1, Byte[] v2) => StructuralComparisons.StructuralEqualityComparer.Equals((object)v1, (object)v2),
+                    (Byte[] v) => StructuralComparisons.StructuralEqualityComparer.GetHashCode((object)v),
+                    (Byte[] source) => source.ToArray()));
+
+            var key = runtimeEntityType.AddKey(
+                new[] { id });
+            runtimeEntityType.SetPrimaryKey(key);
+
+            return runtimeEntityType;
+        }
+
+        public static void CreateAnnotations(RuntimeEntityType runtimeEntityType)
+        {
+            runtimeEntityType.AddAnnotation("Relational:FunctionName", null);
+            runtimeEntityType.AddAnnotation("Relational:Schema", null);
+            runtimeEntityType.AddAnnotation("Relational:SqlQuery", null);
+            runtimeEntityType.AddAnnotation("Relational:TableName", "Data");
+            runtimeEntityType.AddAnnotation("Relational:ViewName", null);
+            runtimeEntityType.AddAnnotation("Relational:ViewSchema", null);
+
+            Customize(runtimeEntityType);
+        }
+
+        static partial void Customize(RuntimeEntityType runtimeEntityType);
+    }
+}
diff --git a/test/EFCore.Sqlite.FunctionalTests/Scaffolding/Baselines/Dynamic_schema/DbContextModel.cs b/test/EFCore.Sqlite.FunctionalTests/Scaffolding/Baselines/Dynamic_schema/DbContextModel.cs
new file mode 100644
index 0000000000..583ee4d90c
--- /dev/null
+++ b/test/EFCore.Sqlite.FunctionalTests/Scaffolding/Baselines/Dynamic_schema/DbContextModel.cs
@@ -0,0 +1,48 @@
+// <auto-generated />
+using Microsoft.EntityFrameworkCore;
+using Microsoft.EntityFrameworkCore.Infrastructure;
+using Microsoft.EntityFrameworkCore.Metadata;
+
+#pragma warning disable 219, 612, 618
+#nullable disable
+
+namespace TestNamespace
+{
+    [DbContext(typeof(DbContext))]
+    public partial class DbContextModel : RuntimeModel
+    {
+        private static readonly bool _useOldBehavior31751 =
+            System.AppContext.TryGetSwitch("Microsoft.EntityFrameworkCore.Issue31751", out var enabled31751) && enabled31751;
+
+        static DbContextModel()
+        {
+            var model = new DbContextModel();
+
+            if (_useOldBehavior31751)
+            {
+                model.Initialize();
+            }
+            else
+            {
+                var thread = new System.Threading.Thread(RunInitialization, 10 * 1024 * 1024);
+                thread.Start();
+                thread.Join();
+
+                void RunInitialization()
+                {
+                    model.Initialize();
+                }
+            }
+
+            model.Customize();
+            _instance = (DbContextModel)model.FinalizeModel();
+        }
+
+        private static DbContextModel _instance;
+        public static IModel Instance => _instance;
+
+        partial void Initialize();
+
+        partial void Customize();
+    }
+}
diff --git a/test/EFCore.Sqlite.FunctionalTests/Scaffolding/Baselines/Dynamic_schema/DbContextModelBuilder.cs b/test/EFCore.Sqlite.FunctionalTests/Scaffolding/Baselines/Dynamic_schema/DbContextModelBuilder.cs
new file mode 100644
index 0000000000..3a070a508d
--- /dev/null
+++ b/test/EFCore.Sqlite.FunctionalTests/Scaffolding/Baselines/Dynamic_schema/DbContextModelBuilder.cs
@@ -0,0 +1,80 @@
+// <auto-generated />
+using System;
+using System.Collections.Generic;
+using Microsoft.EntityFrameworkCore;
+using Microsoft.EntityFrameworkCore.Infrastructure;
+using Microsoft.EntityFrameworkCore.Metadata;
+using Microsoft.EntityFrameworkCore.Metadata.Internal;
+
+#pragma warning disable 219, 612, 618
+#nullable disable
+
+namespace TestNamespace
+{
+    public partial class DbContextModel
+    {
+        private DbContextModel()
+            : base(skipDetectChanges: false, modelId: new Guid("00000000-0000-0000-0000-000000000000"), entityTypeCount: 1)
+        {
+        }
+
+        partial void Initialize()
+        {
+            var data = DataEntityType.Create(this);
+
+            DataEntityType.CreateAnnotations(data);
+
+            AddRuntimeAnnotation("Relational:RelationalModel", CreateRelationalModel());
+        }
+
+        private IRelationalModel CreateRelationalModel()
+        {
+            var relationalModel = new RelationalModel(this);
+
+            var data = FindEntityType("Microsoft.EntityFrameworkCore.Scaffolding.CompiledModelTestBase+Data")!;
+
+            var defaultTableMappings = new List<TableMappingBase<ColumnMappingBase>>();
+            data.SetRuntimeAnnotation("Relational:DefaultMappings", defaultTableMappings);
+            var microsoftEntityFrameworkCoreScaffoldingCompiledModelTestBaseDataTableBase = new TableBase("Microsoft.EntityFrameworkCore.Scaffolding.CompiledModelTestBase+Data", null, relationalModel);
+            var blobColumnBase = new ColumnBase<ColumnMappingBase>("Blob", "BLOB", microsoftEntityFrameworkCoreScaffoldingCompiledModelTestBaseDataTableBase)
+            {
+                IsNullable = true
+            };
+            microsoftEntityFrameworkCoreScaffoldingCompiledModelTestBaseDataTableBase.Columns.Add("Blob", blobColumnBase);
+            var idColumnBase = new ColumnBase<ColumnMappingBase>("Id", "INTEGER", microsoftEntityFrameworkCoreScaffoldingCompiledModelTestBaseDataTableBase);
+            microsoftEntityFrameworkCoreScaffoldingCompiledModelTestBaseDataTableBase.Columns.Add("Id", idColumnBase);
+            relationalModel.DefaultTables.Add("Microsoft.EntityFrameworkCore.Scaffolding.CompiledModelTestBase+Data", microsoftEntityFrameworkCoreScaffoldingCompiledModelTestBaseDataTableBase);
+            var microsoftEntityFrameworkCoreScaffoldingCompiledModelTestBaseDataMappingBase = new TableMappingBase<ColumnMappingBase>(data, microsoftEntityFrameworkCoreScaffoldingCompiledModelTestBaseDataTableBase, null);
+            microsoftEntityFrameworkCoreScaffoldingCompiledModelTestBaseDataTableBase.AddTypeMapping(microsoftEntityFrameworkCoreScaffoldingCompiledModelTestBaseDataMappingBase, false);
+            defaultTableMappings.Add(microsoftEntityFrameworkCoreScaffoldingCompiledModelTestBaseDataMappingBase);
+            RelationalModel.CreateColumnMapping((ColumnBase<ColumnMappingBase>)idColumnBase, data.FindProperty("Id")!, microsoftEntityFrameworkCoreScaffoldingCompiledModelTestBaseDataMappingBase);
+            RelationalModel.CreateColumnMapping((ColumnBase<ColumnMappingBase>)blobColumnBase, data.FindProperty("Blob")!, microsoftEntityFrameworkCoreScaffoldingCompiledModelTestBaseDataMappingBase);
+
+            var tableMappings = new List<TableMapping>();
+            data.SetRuntimeAnnotation("Relational:TableMappings", tableMappings);
+            var dataTable = new Table("Data", null, relationalModel);
+            var idColumn = new Column("Id", "INTEGER", dataTable);
+            dataTable.Columns.Add("Id", idColumn);
+            var blobColumn = new Column("Blob", "BLOB", dataTable)
+            {
+                IsNullable = true
+            };
+            dataTable.Columns.Add("Blob", blobColumn);
+            var pK_Data = new UniqueConstraint("PK_Data", dataTable, new[] { idColumn });
+            dataTable.PrimaryKey = pK_Data;
+            var pK_DataUc = RelationalModel.GetKey(this,
+                "Microsoft.EntityFrameworkCore.Scaffolding.CompiledModelTestBase+Data",
+                new[] { "Id" });
+            pK_Data.MappedKeys.Add(pK_DataUc);
+            RelationalModel.GetOrCreateUniqueConstraints(pK_DataUc).Add(pK_Data);
+            dataTable.UniqueConstraints.Add("PK_Data", pK_Data);
+            relationalModel.Tables.Add(("Data", null), dataTable);
+            var dataTableMapping = new TableMapping(data, dataTable, null);
+            dataTable.AddTypeMapping(dataTableMapping, false);
+            tableMappings.Add(dataTableMapping);
+            RelationalModel.CreateColumnMapping(idColumn, data.FindProperty("Id")!, dataTableMapping);
+            RelationalModel.CreateColumnMapping(blobColumn, data.FindProperty("Blob")!, dataTableMapping);
+            return relationalModel.MakeReadOnly();
+        }
+    }
+}
diff --git a/test/EFCore.Sqlite.FunctionalTests/Scaffolding/Baselines/Dynamic_schema/DbContextModelCustomizer.cs b/test/EFCore.Sqlite.FunctionalTests/Scaffolding/Baselines/Dynamic_schema/DbContextModelCustomizer.cs
new file mode 100644
index 0000000000..8d477de97c
--- /dev/null
+++ b/test/EFCore.Sqlite.FunctionalTests/Scaffolding/Baselines/Dynamic_schema/DbContextModelCustomizer.cs
@@ -0,0 +1,72 @@
+using Microsoft.EntityFrameworkCore.Metadata;
+
+namespace TestNamespace;
+
+public partial class DbContextModel
+{
+    private string DefaultSchema { get; init; } = "custom";
+
+    partial void Customize()
+    {
+        RemoveAnnotation("Relational:DefaultSchema");
+        AddAnnotation("Relational:DefaultSchema", DefaultSchema);
+        RemoveRuntimeAnnotation("Relational:RelationalModel");
+
+        foreach (RuntimeEntityType entityType in ((IModel)this).GetEntityTypes())
+        {
+            Customize(entityType);
+
+            foreach (var key in entityType.GetDeclaredKeys())
+            {
+                key.RemoveRuntimeAnnotation(RelationalAnnotationNames.UniqueConstraintMappings);
+            }
+
+            foreach (var index in entityType.GetDeclaredIndexes())
+            {
+                index.RemoveRuntimeAnnotation(RelationalAnnotationNames.TableIndexMappings);
+            }
+
+            foreach (var foreignKey in entityType.GetDeclaredForeignKeys())
+            {
+                foreignKey.RemoveRuntimeAnnotation(RelationalAnnotationNames.ForeignKeyMappings);
+            }
+
+            var tableName = entityType.FindAnnotation("Relational:TableName")?.Value as string;
+            if (string.IsNullOrEmpty(tableName))
+                continue;
+
+            entityType.SetAnnotation("Relational:Schema", DefaultSchema);
+        }
+    }
+
+    private static void Customize(RuntimeTypeBase entityType)
+    {
+        entityType.RemoveRuntimeAnnotation(RelationalAnnotationNames.DefaultMappings);
+        entityType.RemoveRuntimeAnnotation(RelationalAnnotationNames.TableMappings);
+        entityType.RemoveRuntimeAnnotation(RelationalAnnotationNames.ViewMappings);
+        entityType.RemoveRuntimeAnnotation(RelationalAnnotationNames.SqlQueryMappings);
+        entityType.RemoveRuntimeAnnotation(RelationalAnnotationNames.FunctionMappings);
+        entityType.RemoveRuntimeAnnotation(RelationalAnnotationNames.InsertStoredProcedureMappings);
+        entityType.RemoveRuntimeAnnotation(RelationalAnnotationNames.DeleteStoredProcedureMappings);
+        entityType.RemoveRuntimeAnnotation(RelationalAnnotationNames.UpdateStoredProcedureMappings);
+
+        foreach (var property in entityType.GetDeclaredProperties())
+        {
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.DefaultColumnMappings);
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.TableColumnMappings);
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.ViewColumnMappings);
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.SqlQueryColumnMappings);
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.FunctionColumnMappings);
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.InsertStoredProcedureParameterMappings);
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.DeleteStoredProcedureParameterMappings);
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.UpdateStoredProcedureParameterMappings);
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.InsertStoredProcedureResultColumnMappings);
+            property.RemoveRuntimeAnnotation(RelationalAnnotationNames.UpdateStoredProcedureResultColumnMappings);
+        }
+
+        foreach (var complexProperty in entityType.GetDeclaredComplexProperties())
+        {
+            Customize(complexProperty.ComplexType);
+        }
+    }
+}
\ No newline at end of file
