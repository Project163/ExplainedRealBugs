{"url":"https://api.github.com/repos/dotnet/efcore/issues/36391","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/36391/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/36391/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/36391/events","html_url":"https://github.com/dotnet/efcore/issues/36391","id":3245005238,"node_id":"I_kwDOAPaMMs7Batm2","number":36391,"title":"Temporary key value is not generated for a key with value conversion in some cases","user":{"login":"andreimamlay","id":6378574,"node_id":"MDQ6VXNlcjYzNzg1NzQ=","avatar_url":"https://avatars.githubusercontent.com/u/6378574?v=4","gravatar_id":"","url":"https://api.github.com/users/andreimamlay","html_url":"https://github.com/andreimamlay","followers_url":"https://api.github.com/users/andreimamlay/followers","following_url":"https://api.github.com/users/andreimamlay/following{/other_user}","gists_url":"https://api.github.com/users/andreimamlay/gists{/gist_id}","starred_url":"https://api.github.com/users/andreimamlay/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andreimamlay/subscriptions","organizations_url":"https://api.github.com/users/andreimamlay/orgs","repos_url":"https://api.github.com/users/andreimamlay/repos","events_url":"https://api.github.com/users/andreimamlay/events{/privacy}","received_events_url":"https://api.github.com/users/andreimamlay/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1900941630,"node_id":"MDU6TGFiZWwxOTAwOTQxNjMw","url":"https://api.github.com/repos/dotnet/efcore/labels/area-model-building","name":"area-model-building","color":"32b37b","default":false,"description":""},{"id":9022437988,"node_id":"LA_kwDOAPaMMs8AAAACGcd6ZA","url":"https://api.github.com/repos/dotnet/efcore/labels/rc-1","name":"rc-1","color":"ACB3D7","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/204","html_url":"https://github.com/dotnet/efcore/milestone/204","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/204/labels","id":11480673,"node_id":"MI_kwDOAPaMMs4Ary5h","number":204,"title":"10.0.0","description":"","creator":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":1,"closed_issues":193,"state":"open","created_at":"2024-08-23T12:48:26Z","updated_at":"2025-11-05T08:24:30Z","due_on":null,"closed_at":null},"comments":1,"created_at":"2025-07-19T06:46:07Z","updated_at":"2025-09-08T20:07:01Z","closed_at":"2025-08-08T09:32:57Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Bug description\n\nHi!\n\nThere is a case when EF Core fails to recognize value  `0` as sentinel for `ValueGenerated.OnAdd` keys and tries to use `0` as a real value. This causes exceptions during entity insert.\n\n### Details\n\nI am using keys with value conversion (aka strongly typed ids, no packages, just a readonly record struct with a value converter). Also i am using optimised model produced with `dotnet ef dbcontext optimize`\n\nCase A) After starting an app, if i make multiple parallel inserts of entities, EF fails to recognise default value as a sentinel value and tries to insert 0 as an id, which is not allowed as IDENTITY_INSERT is off. This behaviour continues even if i wait some time and try to insert single entity.\n\nCase B) After starting an app, if i make only one insert and then try insert entities in parallel, EF recognises default value as sentinel and successfully inserts all entities without trying to implicitly insert 0 as an id.\n\nIf i get rid of value conversion and replace all ids with long, the problem no longer appears.\n\n----\nDigging into EF Core sources, i have found out that:\n1. `HasExplicitValue` from https://github.com/dotnet/efcore/blob/eaf2434a5ba4b11bc805d494a7eca5cd9b65e556/src/EFCore/ChangeTracking/Internal/InternalEntityEntry.cs#L1849 returns `true` for the case A and returns `false` for the case B\n\n2. `property.GetGetter().HasSentinelUsingContainingEntity(Entity)` which is called from within `HasExplicitValue` differs between keys with value conversion and without value conversion:\n* `entity => entity.<Id>k__BackingField == 0` for `long`\n* `entity => entity.<Id>k__BackingField.Equals(StronglyTypedId(Value = 0))` for `StronglyTypedId`, where `StronglyTypedId` is defined as the following\n```csharp\npublic readonly record struct StronglyTypedId(long Value);\n\n<...>\n\nbuilder.Property(c => c.Id)\n    .HasConversion(\n        id => id.Value,\n        value => new StronglyTypedId(value)\n    );\n```\nBoth lambda expressions are what you would expect, but it seems that if you call the code that generates said lambdas for `ClrPropertyGetter` in parallel, something (race condition?) causes `ClrPropertyGetter` https://github.com/dotnet/efcore/blob/release/9.0/src/EFCore/Metadata/Internal/ClrPropertyGetterFactory.cs to generate something else for `hasSentinelValueUsingContainingEntityExpression`, **but only** for the case with a key with value conversion. \n\n3. When `HasExplicitValue` returns `false` it causes `ValueGenerationManager.TryFindValueGenerator` to return `false`. This causes `ValueGenerationManager.Generate` to skip calling `var generatedValue = valueGenerator!.Next(entityEntry);` which means the value of the key is not replaced with temporary negative value.\n\n### Example\n\nI have created a test repository with four test cases which reproduce this behavior. \nhttps://github.com/andreimamlay/ef-bug\nIn `Program.cs` there are commented out lines with four test cases. Only the first causes this problem to appear. Other three test cases showcase the correct behavior for both `long` and `strongly typed` ids.\n\n### EF Core version\n\n9.0.7 (reproduced 9.0.3)\n\n### Target framework\n\n.net9","closed_by":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/36391/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/36391/timeline","performed_via_github_app":null,"state_reason":"completed"}