{"url":"https://api.github.com/repos/dotnet/efcore/issues/36329","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/36329/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/36329/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/36329/events","html_url":"https://github.com/dotnet/efcore/issues/36329","id":3201750932,"node_id":"I_kwDOAPaMMs6-1teU","number":36329,"title":"Cosmos: DbSet<DerivedType> throws an exception when an enum discriminator is used","user":{"login":"martinw6","id":144471667,"node_id":"U_kgDOCJx2cw","avatar_url":"https://avatars.githubusercontent.com/u/144471667?v=4","gravatar_id":"","url":"https://api.github.com/users/martinw6","html_url":"https://github.com/martinw6","followers_url":"https://api.github.com/users/martinw6/followers","following_url":"https://api.github.com/users/martinw6/following{/other_user}","gists_url":"https://api.github.com/users/martinw6/gists{/gist_id}","starred_url":"https://api.github.com/users/martinw6/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martinw6/subscriptions","organizations_url":"https://api.github.com/users/martinw6/orgs","repos_url":"https://api.github.com/users/martinw6/repos","events_url":"https://api.github.com/users/martinw6/events{/privacy}","received_events_url":"https://api.github.com/users/martinw6/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1686778100,"node_id":"MDU6TGFiZWwxNjg2Nzc4MTAw","url":"https://api.github.com/repos/dotnet/efcore/labels/area-cosmos","name":"area-cosmos","color":"32b37b","default":false,"description":""},{"id":9022438466,"node_id":"LA_kwDOAPaMMs8AAAACGcd8Qg","url":"https://api.github.com/repos/dotnet/efcore/labels/rc-2","name":"rc-2","color":"ACB3D7","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/204","html_url":"https://github.com/dotnet/efcore/milestone/204","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/204/labels","id":11480673,"node_id":"MI_kwDOAPaMMs4Ary5h","number":204,"title":"10.0.0","description":"","creator":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":1,"closed_issues":193,"state":"open","created_at":"2024-08-23T12:48:26Z","updated_at":"2025-11-05T08:24:30Z","due_on":null,"closed_at":null},"comments":2,"created_at":"2025-07-04T08:07:54Z","updated_at":"2025-10-01T15:16:11Z","closed_at":"2025-09-17T16:14:54Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Bug description\n\nWhile upgrading a project to Entity Framework Core 9.0 I seem to have found another issue related to enum discriminators on derived types.\n\nExposing a DbSet that uses the derived type is throwing an exception when it is used (if the discriminator is an enum).\n\nIt throws an exception of type System.InvalidCastException with the message: Unable to cast object of type 'CosmosDbTestApp.PetType' to type 'System.String'.\n\nSee the code below as an example that reproduces the error. The line with 'var dog = await context.Dogs.SingleAsync(x => x.Id == \"123\");' throws an exception.\n\nDowngrading the nuget package to Microsoft.EntityFrameworkCore.Cosmos 8.0.17 makes it work again. It seems to only be an issue with the NuGet packages for Entity Framework 9.0.\n\nAlso changing the type of the discriminator from an enum to a string makes it work (with both version 8.0.17 and version 9.0.6).\n\n```csharp\n// dotnet 9.0 console app with package reference\n// to Microsoft.EntityFrameworkCore.Cosmos version 9.0.6\n\nusing Microsoft.EntityFrameworkCore; \nusing Microsoft.EntityFrameworkCore.Storage.ValueConversion;\nusing Microsoft.Extensions.Logging; \n\nnamespace CosmosDbTestApp\n{\n    public class Program\n    {\n        public static async Task Main(string[] args)\n        {\n            using (var context = new MyDbContext())\n            {\n                await context.Database.EnsureDeletedAsync();\n                await context.Database.EnsureCreatedAsync();\n\n                var a = new Dog()\n                {\n                    Id = \"123\",\n                    Name = \"Rover\",\n                    PetType = PetType.Dog,\n                    DogProperty = \"test\"\n                };\n\n                await context.Dogs.AddAsync(a);\n                \n                await context.SaveChangesAsync();\n\n                // this works\n                var pet = await context.Pets.OfType<Dog>().SingleAsync(x => x.Id == \"123\");\n                Console.WriteLine(pet.Name);\n                \n                // this throws an exception: System.InvalidCastException\n                // Unable to cast object of type 'CosmosDbTestApp.PetType' to type 'System.String'.\n                var dog = await context.Dogs.SingleAsync(x => x.Id == \"123\");\n                Console.WriteLine(dog.Name);\n            }\n        }\n    }\n\n    public class MyDbContext : DbContext\n    {\n        public DbSet<Dog> Dogs { get; set; }\n        \n        public DbSet<Pet> Pets { get; set; }\n\n        protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)\n            => optionsBuilder.UseCosmos(\n                \"https://REDACTED.documents.azure.com:443/\",\n                \"REDACTED\",\n                \"TestDb\").LogTo(Console.WriteLine, LogLevel.Debug).EnableSensitiveDataLogging();\n\n        protected override void OnModelCreating(ModelBuilder modelBuilder)\n        {\n            modelBuilder.Entity<Pet>()\n                .ToContainer(nameof(Pet))\n                .HasPartitionKey(x => x.Id)\n                .HasKey(x => x.Id);\n\n            modelBuilder.Entity<Pet>().Property(e => e.PetType)\n                .HasConversion(new EnumToStringConverter<PetType>());\n\n            modelBuilder.Entity<Pet>()\n                .HasDiscriminator(x => x.PetType)\n                .HasValue<Dog>(PetType.Dog);\n\n            modelBuilder.Entity<Dog>()\n                .HasBaseType<Pet>();\n        }\n    }\n\n    public abstract record Pet\n    {\n        public string Id { get; set; }\n        \n        public PetType PetType { get; set; }\n        \n        public string Name { get; set; }\n    }\n    \n    public record Dog : Pet\n    {\n        public string DogProperty { get; set; }\n    }\n\n\n    public enum PetType\n    {\n        Dog,\n        Cat\n    }\n}\n```\n\n```text\nwarn: 04/07/2025 08:47:54.391 CoreEventId.SensitiveDataLoggingEnabledWarning[10400] (Microsoft.EntityFrameworkCore.Infrastructure) \n      Sensitive data logging is enabled. Log entries and exception messages may include sensitive application data; this mode should only be enabled during development.\ndbug: 04/07/2025 08:47:54.413 CoreEventId.ShadowPropertyCreated[10600] (Microsoft.EntityFrameworkCore.Model.Validation) \n      The property 'Pet.__jObject' was created in shadow state because there are no eligible CLR members with a matching name.\ndbug: 04/07/2025 08:47:54.446 CoreEventId.ContextInitialized[10403] (Microsoft.EntityFrameworkCore.Infrastructure) \n      Entity Framework Core 9.0.6 initialized 'MyDbContext' using provider 'Microsoft.EntityFrameworkCore.Cosmos:9.0.6' with options: SensitiveDataLoggingEnabled ServiceEndPoint=https://REDACTED.documents.azure.com:443/ Database=TestDb \ndbug: 04/07/2025 08:48:01.003 CoreEventId.ValueGenerated[10808] (Microsoft.EntityFrameworkCore.ChangeTracking) \n      'MyDbContext' generated value 'Dog' for the property 'Dog.PetType'.\ndbug: 04/07/2025 08:48:01.064 CoreEventId.StartedTracking[10806] (Microsoft.EntityFrameworkCore.ChangeTracking) \n      Context 'MyDbContext' started tracking 'Dog' entity with key '{Id: 123}'.\ndbug: 04/07/2025 08:48:01.071 CoreEventId.SaveChangesStarting[10004] (Microsoft.EntityFrameworkCore.Update) \n      SaveChanges starting for 'MyDbContext'.\ndbug: 04/07/2025 08:48:01.076 CoreEventId.DetectChangesStarting[10800] (Microsoft.EntityFrameworkCore.ChangeTracking) \n      DetectChanges starting for 'MyDbContext'.\ndbug: 04/07/2025 08:48:01.083 CoreEventId.DetectChangesCompleted[10801] (Microsoft.EntityFrameworkCore.ChangeTracking) \n      DetectChanges completed for 'MyDbContext'.\ninfo: 04/07/2025 08:48:01.657 CosmosEventId.ExecutedCreateItem[30104] (Microsoft.EntityFrameworkCore.Database.Command) \n      Executed CreateItem (518 ms, 6.67 RU) ActivityId='1b806d55-5fba-43d0-bdec-317defe30a9a', Container='Pet', Id='123', Partition='[\"123\"]'\ndbug: 04/07/2025 08:48:01.684 CoreEventId.StateChanged[10807] (Microsoft.EntityFrameworkCore.ChangeTracking) \n      The 'Dog' entity with key '{Id: 123}' tracked by 'MyDbContext' changed state from 'Added' to 'Unchanged'.\ndbug: 04/07/2025 08:48:01.694 CoreEventId.SaveChangesCompleted[10005] (Microsoft.EntityFrameworkCore.Update) \n      SaveChanges completed for 'MyDbContext' with 1 entities written to the database.\ndbug: 04/07/2025 08:48:01.772 CoreEventId.QueryCompilationStarting[10111] (Microsoft.EntityFrameworkCore.Query) \n      Compiling query expression: \n      'DbSet<Pet>()\n          .OfType<Dog>()\n          .Single(x => x.Id == \"123\")'\ndbug: 04/07/2025 08:48:01.995 CoreEventId.QueryExecutionPlanned[10107] (Microsoft.EntityFrameworkCore.Query) \n      Generated query execution expression: \n      'queryContext => ShapedQueryCompilingExpressionVisitor.SingleAsync<Dog>(\n          asyncEnumerable: new QueryingEnumerable<Dog>(\n              (CosmosQueryContext)queryContext, \n              SqlExpressionFactory, \n              QuerySqlGeneratorFactory, \n              Projection Mapping:\n                  EmptyProjectionMember -> 0\n              SELECT VALUE c\n              FROM root AS c\n              WHERE c[\"PetType\"] == \"Dog\", \n              Func<QueryContext, JToken, Dog>, \n              CosmosDbTestApp.MyDbContext, \n              EntityType: Pet Abstract, \n              List<Expression> { [Cosmos.Query.Internal.SqlConstantExpression] }, \n              False, \n              True\n          ), \n          cancellationToken: queryContext.CancellationToken)'\ninfo: 04/07/2025 08:48:02.020 CosmosEventId.ExecutingSqlQuery[30100] (Microsoft.EntityFrameworkCore.Database.Command) \n      Executing SQL query for container 'Pet' in partition '[\"123\"]' [Parameters=[]]\n      SELECT VALUE c\n      FROM root c\n      WHERE (c[\"PetType\"] = \"Dog\")\n      OFFSET 0 LIMIT 2\ninfo: 04/07/2025 08:48:02.478 CosmosEventId.ExecutedReadNext[30102] (Microsoft.EntityFrameworkCore.Database.Command) \n      Executed ReadNext (423.1014 ms, 2.92 RU) ActivityId='d8a734a2-d3a3-4f8e-8fc2-81b86df638a3', Container='Pet', Partition='[\"123\"]', Parameters=[]\n      SELECT VALUE c\n      FROM root c\n      WHERE (c[\"PetType\"] = \"Dog\")\n      OFFSET 0 LIMIT 2\nRover\ndbug: 04/07/2025 08:48:02.516 CoreEventId.QueryCompilationStarting[10111] (Microsoft.EntityFrameworkCore.Query) \n      Compiling query expression: \n      'DbSet<Dog>()\n          .Single(x => x.Id == \"123\")'\ndbug: 04/07/2025 08:48:02.638 CoreEventId.ContextDisposed[10407] (Microsoft.EntityFrameworkCore.Infrastructure) \n      'MyDbContext' disposed.\nUnhandled exception. System.InvalidCastException: Unable to cast object of type 'CosmosDbTestApp.PetType' to type 'System.String'.\n   at Microsoft.EntityFrameworkCore.ChangeTracking.ValueComparer`1.Equals(Object left, Object right)\n   at Microsoft.EntityFrameworkCore.Cosmos.Query.Internal.CosmosReadItemAndPartitionKeysExtractor.<VisitExtension>g__ProcessPropertyComparison|9_0(String propertyName, SqlExpression propertyValue, SqlExpression originalExpression)\n   at Microsoft.EntityFrameworkCore.Cosmos.Query.Internal.CosmosReadItemAndPartitionKeysExtractor.VisitExtension(Expression node)\n   at Microsoft.EntityFrameworkCore.Cosmos.Query.Internal.CosmosReadItemAndPartitionKeysExtractor.VisitExtension(Expression node)\n   at Microsoft.EntityFrameworkCore.Cosmos.Query.Internal.CosmosReadItemAndPartitionKeysExtractor.ExtractPartitionKeysAndId(CosmosQueryCompilationContext queryCompilationContext, ISqlExpressionFactory sqlExpressionFactory, Expression expression)\n   at Microsoft.EntityFrameworkCore.Cosmos.Query.Internal.CosmosQueryTranslationPostprocessor.Process(Expression query)\n   at Microsoft.EntityFrameworkCore.Query.QueryCompilationContext.CreateQueryExecutorExpression[TResult](Expression query)\n   at Microsoft.EntityFrameworkCore.Query.QueryCompilationContext.CreateQueryExecutor[TResult](Expression query)\n   at Microsoft.EntityFrameworkCore.Storage.Database.CompileQuery[TResult](Expression query, Boolean async)\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.CompileQueryCore[TResult](IDatabase database, Expression query, IModel model, Boolean async)\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.<>c__DisplayClass11_0`1.<ExecuteCore>b__0()\n   at Microsoft.EntityFrameworkCore.Query.Internal.CompiledQueryCache.GetOrAddQuery[TResult](Object cacheKey, Func`1 compiler)\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.ExecuteCore[TResult](Expression query, Boolean async, CancellationToken cancellationToken)\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.ExecuteAsync[TResult](Expression query, CancellationToken cancellationToken)\n   at Microsoft.EntityFrameworkCore.Query.Internal.EntityQueryProvider.ExecuteAsync[TResult](Expression expression, CancellationToken cancellationToken)\n   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.ExecuteAsync[TSource,TResult](MethodInfo operatorMethodInfo, IQueryable`1 source, Expression expression, CancellationToken cancellationToken)\n   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.ExecuteAsync[TSource,TResult](MethodInfo operatorMethodInfo, IQueryable`1 source, LambdaExpression expression, CancellationToken cancellationToken)\n   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.SingleAsync[TSource](IQueryable`1 source, Expression`1 predicate, CancellationToken cancellationToken)\n   at CosmosDbTestApp.Program.Main(String[] args) in /Users/martin/RiderProjects/ConsoleApp12/CosmosDbTestApp3/Program.cs:line 42\n   at CosmosDbTestApp.Program.<Main>(String[] args)\n```\n\n\n\n### Your code\n\n```csharp\nSee bug description\n```\n\n### Stack traces\n\n```text\nSee bug description\n```\n\n### Verbose output\n\n```text\n\n```\n\n### EF Core version\n\n9.0.6\n\n### Database provider\n\nComosDB\n\n### Target framework\n\n9.0.301\n\n### Operating system\n\nMacOS 15.5\n\n### IDE\n\nRider","closed_by":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/36329/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/36329/timeline","performed_via_github_app":null,"state_reason":"completed"}