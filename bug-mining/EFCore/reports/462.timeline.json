[{"id":12854825610,"node_id":"LE_lADOAPaMMs6JUlhxzwAAAAL-NRKK","url":"https://api.github.com/repos/dotnet/efcore/issues/events/12854825610","actor":{"login":"ranma42","id":1506030,"node_id":"MDQ6VXNlcjE1MDYwMzA=","avatar_url":"https://avatars.githubusercontent.com/u/1506030?v=4","gravatar_id":"","url":"https://api.github.com/users/ranma42","html_url":"https://github.com/ranma42","followers_url":"https://api.github.com/users/ranma42/followers","following_url":"https://api.github.com/users/ranma42/following{/other_user}","gists_url":"https://api.github.com/users/ranma42/gists{/gist_id}","starred_url":"https://api.github.com/users/ranma42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ranma42/subscriptions","organizations_url":"https://api.github.com/users/ranma42/orgs","repos_url":"https://api.github.com/users/ranma42/repos","events_url":"https://api.github.com/users/ranma42/events{/privacy}","received_events_url":"https://api.github.com/users/ranma42/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2024-05-18T06:10:30Z","label":{"name":"customer-reported","color":"a4a5f9"},"performed_via_github_app":null},{"id":12855016044,"node_id":"REFE_lADOAPaMMs6JUlhxzwAAAAL-N_ps","url":"https://api.github.com/repos/dotnet/efcore/issues/events/12855016044","actor":{"login":"ranma42","id":1506030,"node_id":"MDQ6VXNlcjE1MDYwMzA=","avatar_url":"https://avatars.githubusercontent.com/u/1506030?v=4","gravatar_id":"","url":"https://api.github.com/users/ranma42","html_url":"https://github.com/ranma42","followers_url":"https://api.github.com/users/ranma42/followers","following_url":"https://api.github.com/users/ranma42/following{/other_user}","gists_url":"https://api.github.com/users/ranma42/gists{/gist_id}","starred_url":"https://api.github.com/users/ranma42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ranma42/subscriptions","organizations_url":"https://api.github.com/users/ranma42/orgs","repos_url":"https://api.github.com/users/ranma42/repos","events_url":"https://api.github.com/users/ranma42/events{/privacy}","received_events_url":"https://api.github.com/users/ranma42/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"afe0005c64b77f1ffa51bf48322b97b676b67eaa","commit_url":"https://api.github.com/repos/ranma42/efcore/commits/afe0005c64b77f1ffa51bf48322b97b676b67eaa","created_at":"2024-05-18T07:58:39Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2118685046","html_url":"https://github.com/dotnet/efcore/issues/33751#issuecomment-2118685046","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/33751","id":2118685046,"node_id":"IC_kwDOAPaMMs5-SJF2","user":{"login":"ranma42","id":1506030,"node_id":"MDQ6VXNlcjE1MDYwMzA=","avatar_url":"https://avatars.githubusercontent.com/u/1506030?v=4","gravatar_id":"","url":"https://api.github.com/users/ranma42","html_url":"https://github.com/ranma42","followers_url":"https://api.github.com/users/ranma42/followers","following_url":"https://api.github.com/users/ranma42/following{/other_user}","gists_url":"https://api.github.com/users/ranma42/gists{/gist_id}","starred_url":"https://api.github.com/users/ranma42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ranma42/subscriptions","organizations_url":"https://api.github.com/users/ranma42/orgs","repos_url":"https://api.github.com/users/ranma42/repos","events_url":"https://api.github.com/users/ranma42/events{/privacy}","received_events_url":"https://api.github.com/users/ranma42/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-05-18T08:00:13Z","updated_at":"2024-05-18T08:00:13Z","body":"There is a further constraint around `NULL` values which cannot be noticed while filtering, but would affect projection\r\n\r\nAssuming that `Url` is not nullable, the following query\r\n```sql\r\nSELECT \"b\".\"BlogId\", \"b\".\"Url\", CASE\r\n      WHEN \"b\".\"Url\" = 'http://efcore/' THEN 1\r\n      WHEN \"b\".\"Url\" LIKE 'http://%' THEN 2\r\n      WHEN \"b\".\"Url\" LIKE '%/' THEN 3\r\nEND = 1 AS \"Category\"\r\nFROM \"Blogs\" AS \"b\"\r\n```\r\nclassifies all of the rows in one of the 3 categories:\r\n - `true`: `\"b\".\"Url\" = 'http://efcore/'`,\r\n - `false`: `NOT(\"b\".\"Url\" = 'http://efcore/') AND (\"b\".\"Url\" LIKE 'http://%' OR \"b\".\"Url\" LIKE '%/')`\r\n - `NULL` anything else\r\n\r\nwhile the (incorrectly) optimized version\r\n```sql\r\nSELECT \"b\".\"BlogId\", \"b\".\"Url\", \"b\".\"Url\" = 'http://efcore/' AS \"Category\"\r\nFROM \"Blogs\" AS \"b\"\r\n```\r\nclassifies all of the rows as:\r\n - `true`: `\"b\".\"Url\" = 'http://efcore/'`,\r\n - `false` anything else","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2118685046/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ranma42","id":1506030,"node_id":"MDQ6VXNlcjE1MDYwMzA=","avatar_url":"https://avatars.githubusercontent.com/u/1506030?v=4","gravatar_id":"","url":"https://api.github.com/users/ranma42","html_url":"https://github.com/ranma42","followers_url":"https://api.github.com/users/ranma42/followers","following_url":"https://api.github.com/users/ranma42/following{/other_user}","gists_url":"https://api.github.com/users/ranma42/gists{/gist_id}","starred_url":"https://api.github.com/users/ranma42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ranma42/subscriptions","organizations_url":"https://api.github.com/users/ranma42/orgs","repos_url":"https://api.github.com/users/ranma42/repos","events_url":"https://api.github.com/users/ranma42/events{/privacy}","received_events_url":"https://api.github.com/users/ranma42/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":12855083043,"node_id":"LE_lADOAPaMMs6JUlhxzwAAAAL-OQAj","url":"https://api.github.com/repos/dotnet/efcore/issues/events/12855083043","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2024-05-18T08:32:20Z","label":{"name":"area-query","color":"32b37b"},"performed_via_github_app":null},{"id":12855083344,"node_id":"LE_lADOAPaMMs6JUlhxzwAAAAL-OQFQ","url":"https://api.github.com/repos/dotnet/efcore/issues/events/12855083344","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2024-05-18T08:32:25Z","label":{"name":"type-bug","color":"f7c6c7"},"performed_via_github_app":null},{"id":12855083853,"node_id":"AE_lADOAPaMMs6JUlhxzwAAAAL-OQNN","url":"https://api.github.com/repos/dotnet/efcore/issues/events/12855083853","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"assigned","commit_id":null,"commit_url":null,"created_at":"2024-05-18T08:32:31Z","assignee":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false},"performed_via_github_app":null},{"id":12855130757,"node_id":"REFE_lADOAPaMMs6JUlhxzwAAAAL-ObqF","url":"https://api.github.com/repos/dotnet/efcore/issues/events/12855130757","actor":{"login":"ranma42","id":1506030,"node_id":"MDQ6VXNlcjE1MDYwMzA=","avatar_url":"https://avatars.githubusercontent.com/u/1506030?v=4","gravatar_id":"","url":"https://api.github.com/users/ranma42","html_url":"https://github.com/ranma42","followers_url":"https://api.github.com/users/ranma42/followers","following_url":"https://api.github.com/users/ranma42/following{/other_user}","gists_url":"https://api.github.com/users/ranma42/gists{/gist_id}","starred_url":"https://api.github.com/users/ranma42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ranma42/subscriptions","organizations_url":"https://api.github.com/users/ranma42/orgs","repos_url":"https://api.github.com/users/ranma42/repos","events_url":"https://api.github.com/users/ranma42/events{/privacy}","received_events_url":"https://api.github.com/users/ranma42/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"7903f29920da921e5a3d77538142fe1779160bed","commit_url":"https://api.github.com/repos/ranma42/efcore/commits/7903f29920da921e5a3d77538142fe1779160bed","created_at":"2024-05-18T08:45:57Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2118709931","html_url":"https://github.com/dotnet/efcore/issues/33751#issuecomment-2118709931","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/33751","id":2118709931,"node_id":"IC_kwDOAPaMMs5-SPKr","user":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-05-18T08:47:38Z","updated_at":"2024-05-18T08:47:55Z","body":"@ranma42 all makes sense, thanks for the minimal repro and the bug analysis! /cc @maumar\n\n> the sqlConstantComponent?.Value only appears once in the list of case results\n> the matchingCaseBlock is disjoint from all of the previous cases\n\nShouldn't the optimization simply collect all WHEN blocks with the specific value, and string them together with ORs? In other words:\n\n```sql\nCASE\n    WHEN x THEN 1\n    WHEN y THEN 2\n    WHEN z THEN 1\nEND = 1\n```\n\n... would get simplified to `x OR z`? I'm not sure why the requirement for matchingCaseBlock to be disjoint...\n\n> the (omitted) ELSE is never reached, aka at least one of the conditions holds\n\nCan you provide an example for this? At least in the above example, if none of the conditions hold, the CASE/WHEN would return NULL, and the simplification should return the same rows - or am I missing something?\n\n(though there may indeed be issues around NULL vs. false, we'd need to think about this a bit moer.\n\nBTW an unrelated note: I'm not sure why the optimization is limited to constants only - it seems we could widen it to arbitrary SqlExpressions (though keep in mind the cost of the deep comparisons).\n\n","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2118709931/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":12855133783,"node_id":"MEE_lADOAPaMMs6JUlhxzwAAAAL-OcZX","url":"https://api.github.com/repos/dotnet/efcore/issues/events/12855133783","actor":{"login":"ranma42","id":1506030,"node_id":"MDQ6VXNlcjE1MDYwMzA=","avatar_url":"https://avatars.githubusercontent.com/u/1506030?v=4","gravatar_id":"","url":"https://api.github.com/users/ranma42","html_url":"https://github.com/ranma42","followers_url":"https://api.github.com/users/ranma42/followers","following_url":"https://api.github.com/users/ranma42/following{/other_user}","gists_url":"https://api.github.com/users/ranma42/gists{/gist_id}","starred_url":"https://api.github.com/users/ranma42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ranma42/subscriptions","organizations_url":"https://api.github.com/users/ranma42/orgs","repos_url":"https://api.github.com/users/ranma42/repos","events_url":"https://api.github.com/users/ranma42/events{/privacy}","received_events_url":"https://api.github.com/users/ranma42/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-05-18T08:47:39Z","performed_via_github_app":null},{"id":12855133787,"node_id":"SE_lADOAPaMMs6JUlhxzwAAAAL-OcZb","url":"https://api.github.com/repos/dotnet/efcore/issues/events/12855133787","actor":{"login":"ranma42","id":1506030,"node_id":"MDQ6VXNlcjE1MDYwMzA=","avatar_url":"https://avatars.githubusercontent.com/u/1506030?v=4","gravatar_id":"","url":"https://api.github.com/users/ranma42","html_url":"https://github.com/ranma42","followers_url":"https://api.github.com/users/ranma42/followers","following_url":"https://api.github.com/users/ranma42/following{/other_user}","gists_url":"https://api.github.com/users/ranma42/gists{/gist_id}","starred_url":"https://api.github.com/users/ranma42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ranma42/subscriptions","organizations_url":"https://api.github.com/users/ranma42/orgs","repos_url":"https://api.github.com/users/ranma42/repos","events_url":"https://api.github.com/users/ranma42/events{/privacy}","received_events_url":"https://api.github.com/users/ranma42/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-05-18T08:47:39Z","performed_via_github_app":null},{"id":12855133788,"node_id":"MEE_lADOAPaMMs6JUlhxzwAAAAL-OcZc","url":"https://api.github.com/repos/dotnet/efcore/issues/events/12855133788","actor":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-05-18T08:47:39Z","performed_via_github_app":null},{"id":12855133790,"node_id":"SE_lADOAPaMMs6JUlhxzwAAAAL-OcZe","url":"https://api.github.com/repos/dotnet/efcore/issues/events/12855133790","actor":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-05-18T08:47:39Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2118717602","html_url":"https://github.com/dotnet/efcore/issues/33751#issuecomment-2118717602","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/33751","id":2118717602,"node_id":"IC_kwDOAPaMMs5-SRCi","user":{"login":"ranma42","id":1506030,"node_id":"MDQ6VXNlcjE1MDYwMzA=","avatar_url":"https://avatars.githubusercontent.com/u/1506030?v=4","gravatar_id":"","url":"https://api.github.com/users/ranma42","html_url":"https://github.com/ranma42","followers_url":"https://api.github.com/users/ranma42/followers","following_url":"https://api.github.com/users/ranma42/following{/other_user}","gists_url":"https://api.github.com/users/ranma42/gists{/gist_id}","starred_url":"https://api.github.com/users/ranma42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ranma42/subscriptions","organizations_url":"https://api.github.com/users/ranma42/orgs","repos_url":"https://api.github.com/users/ranma42/repos","events_url":"https://api.github.com/users/ranma42/events{/privacy}","received_events_url":"https://api.github.com/users/ranma42/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-05-18T09:00:09Z","updated_at":"2024-05-18T09:00:09Z","body":"> Shouldn't the optimization simply collect all WHEN blocks with the specific value, and string them together with ORs? In other words:\r\n> \r\n> ```sql\r\n> CASE\r\n>     WHEN x THEN 1\r\n>     WHEN y THEN 2\r\n>     WHEN z THEN 1\r\n> END = 1\r\n> ```\r\n> \r\n> ... would get simplified to `x OR z`? I'm not sure why the requirement for matchingCaseBlock to be disjoint...\r\nIt is not a requirement in general, but it is a requirement if we plan to only use a single condition as the current code.\r\nAlso, notice that the transformation you propose would be incorrect, as it does not take into account the fact that the third `WHEN` clause is only reached if the second one does not match:\r\n```sql\r\nCASE\r\n      WHEN \"b\".\"Url\" = 'http://efcore/' THEN 1\r\n      WHEN \"b\".\"Url\" LIKE 'http://%' THEN 2\r\n      WHEN \"b\".\"Url\" LIKE '%/' THEN 1\r\nEND = 1\r\n```\r\nshould not simplify to\r\n```sql\r\n\"b\".\"Url\" = 'http://efcore/' OR \"b\".\"Url\" LIKE '%/'\r\n```\r\nThe `CASE` would evaluate to 2 for the string `'http://bug/'`, so the first expression (`CASE ... END = 1`) would be false.\r\nInstead, the \"simplified\" expression would obviously be true for `'http://bug/'`\r\n(in fact, the second expression could be further simplified to `\"b\".\"Url\" LIKE '%/'`)\r\n\r\nIf we want to transform it, it should get simplified to `x OR (NOT(y) AND z)`, i.e.\r\n```sql\r\n\"b\".\"Url\" = 'http://efcore/' OR (NOT(\"b\".\"Url\" LIKE 'http://%') AND \"b\".\"Url\" LIKE '%/')\r\n```","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2118717602/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ranma42","id":1506030,"node_id":"MDQ6VXNlcjE1MDYwMzA=","avatar_url":"https://avatars.githubusercontent.com/u/1506030?v=4","gravatar_id":"","url":"https://api.github.com/users/ranma42","html_url":"https://github.com/ranma42","followers_url":"https://api.github.com/users/ranma42/followers","following_url":"https://api.github.com/users/ranma42/following{/other_user}","gists_url":"https://api.github.com/users/ranma42/gists{/gist_id}","starred_url":"https://api.github.com/users/ranma42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ranma42/subscriptions","organizations_url":"https://api.github.com/users/ranma42/orgs","repos_url":"https://api.github.com/users/ranma42/repos","events_url":"https://api.github.com/users/ranma42/events{/privacy}","received_events_url":"https://api.github.com/users/ranma42/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2118730714","html_url":"https://github.com/dotnet/efcore/issues/33751#issuecomment-2118730714","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/33751","id":2118730714,"node_id":"IC_kwDOAPaMMs5-SUPa","user":{"login":"ranma42","id":1506030,"node_id":"MDQ6VXNlcjE1MDYwMzA=","avatar_url":"https://avatars.githubusercontent.com/u/1506030?v=4","gravatar_id":"","url":"https://api.github.com/users/ranma42","html_url":"https://github.com/ranma42","followers_url":"https://api.github.com/users/ranma42/followers","following_url":"https://api.github.com/users/ranma42/following{/other_user}","gists_url":"https://api.github.com/users/ranma42/gists{/gist_id}","starred_url":"https://api.github.com/users/ranma42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ranma42/subscriptions","organizations_url":"https://api.github.com/users/ranma42/orgs","repos_url":"https://api.github.com/users/ranma42/repos","events_url":"https://api.github.com/users/ranma42/events{/privacy}","received_events_url":"https://api.github.com/users/ranma42/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-05-18T09:16:32Z","updated_at":"2024-05-18T09:16:32Z","body":"> Can you provide an example for this? At least in the above example, if none of the conditions hold, the CASE/WHEN would return NULL, and the simplification should return the same rows - or am I missing something?\r\n\r\nI think you missed the part about \"which cannot be noticed while filtering, but would affect projection\" ;)\r\nThe issue is not triggered when filtering (as `NULL` and `FALSE` behave the same way in a `WHERE`), but rather in a `SELECT` projection.\r\n\r\nFor a concrete example, if we simplify\r\n```sql\r\nCASE\r\n    WHEN x > 0 THEN 1\r\n    WHEN y > 0 THEN 2\r\nEND = 1\r\n```\r\nto \r\n```sql\r\nx > 2\r\n```\r\n\r\nthe values for the `x: 0, y: 0` row do not match:\r\n\r\n| x | y | CASE | CASE = 1 | x > 0  |\r\n|---|---|------|----------|--------|\r\n| 0 | 0 | NULL |   NULL   | FALSE  |\r\n| 1 | 0 |    1 |   TRUE   | TRUE   |\r\n| 0 | 1 |    2 |   FALSE  | FALSE  |\r\n\r\nYou can try it directly as:\r\n\r\n```sql\r\nWITH T(x, y) AS (VALUES (0, 0),(1, 0),(0, 1))\r\nSELECT x, y, CASE\r\n    WHEN x > 0 THEN 1\r\n    WHEN y > 0 THEN 2\r\nEND = 1 AS c,\r\nx > 0 AS simple FROM T;\r\n```","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2118730714/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ranma42","id":1506030,"node_id":"MDQ6VXNlcjE1MDYwMzA=","avatar_url":"https://avatars.githubusercontent.com/u/1506030?v=4","gravatar_id":"","url":"https://api.github.com/users/ranma42","html_url":"https://github.com/ranma42","followers_url":"https://api.github.com/users/ranma42/followers","following_url":"https://api.github.com/users/ranma42/following{/other_user}","gists_url":"https://api.github.com/users/ranma42/gists{/gist_id}","starred_url":"https://api.github.com/users/ranma42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ranma42/subscriptions","organizations_url":"https://api.github.com/users/ranma42/orgs","repos_url":"https://api.github.com/users/ranma42/repos","events_url":"https://api.github.com/users/ranma42/events{/privacy}","received_events_url":"https://api.github.com/users/ranma42/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2118743230","html_url":"https://github.com/dotnet/efcore/issues/33751#issuecomment-2118743230","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/33751","id":2118743230,"node_id":"IC_kwDOAPaMMs5-SXS-","user":{"login":"ranma42","id":1506030,"node_id":"MDQ6VXNlcjE1MDYwMzA=","avatar_url":"https://avatars.githubusercontent.com/u/1506030?v=4","gravatar_id":"","url":"https://api.github.com/users/ranma42","html_url":"https://github.com/ranma42","followers_url":"https://api.github.com/users/ranma42/followers","following_url":"https://api.github.com/users/ranma42/following{/other_user}","gists_url":"https://api.github.com/users/ranma42/gists{/gist_id}","starred_url":"https://api.github.com/users/ranma42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ranma42/subscriptions","organizations_url":"https://api.github.com/users/ranma42/orgs","repos_url":"https://api.github.com/users/ranma42/repos","events_url":"https://api.github.com/users/ranma42/events{/privacy}","received_events_url":"https://api.github.com/users/ranma42/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-05-18T09:42:22Z","updated_at":"2024-05-18T09:42:22Z","body":"> BTW an unrelated note: I'm not sure why the optimization is limited to constants only - it seems we could widen it to arbitrary SqlExpressions (though keep in mind the cost of the deep comparisons).\r\n\r\nI agree that it would make sense to handle a more general case, but some care should be taken to avoid introducing subtle issues (see my two previous comments).\r\n\r\nFrom my point of view, instead, it makes sense to limit this optimization to constants (as it makes it easy to control its complexity), but it would be natural to extend it to other binary operators. For example, we could distribute the binop and perform constant folding. This could open some more possibilities:\r\n - merging consecutive `WHEN` cases that share the same result\r\n - in filters, dropping trailing FALSE/NULL cases (this is the happy path: if we end up with a single case, we can return a filter that is simply the WHEN condition)\r\n\r\n### example of generic transform\r\n```sql\r\nCASE\r\n    WHEN a THEN 2\r\n    WHEN b THEN 1\r\n    WHEN c THEN 1\r\n    WHEN d THEN 3\r\nEND = 1\r\n```\r\n--- distribute & constand fold -->\r\n```sql\r\nCASE\r\n    WHEN a THEN FALSE\r\n    WHEN b THEN TRUE\r\n    WHEN c THEN TRUE\r\n    WHEN d THEN FALSE\r\nEND\r\n```\r\n--- merge -->\r\n```sql\r\nCASE\r\n    WHEN a THEN FALSE\r\n    WHEN b OR c THEN TRUE\r\n    WHEN d THEN FALSE\r\nEND\r\n```\r\n--- if we are in a filter -->\r\n```sql\r\nCASE\r\n    WHEN a THEN FALSE\r\n    WHEN b OR c THEN TRUE\r\nEND\r\n```\r\n\r\n### example of the \"happy path\":\r\n```sql\r\nCASE\r\n    WHEN a THEN 2\r\n    WHEN b THEN 1\r\n    WHEN c THEN 1\r\n    WHEN d THEN 3\r\nEND < 3\r\n```\r\n--- distribute & constand fold -->\r\n```sql\r\nCASE\r\n    WHEN a THEN TRUE\r\n    WHEN b THEN TRUE\r\n    WHEN c THEN TRUE\r\n    WHEN d THEN FALSE\r\nEND\r\n```\r\n--- merge -->\r\n```sql\r\nCASE\r\n    WHEN a OR b OR c THEN TRUE\r\n    WHEN d THEN FALSE\r\nEND\r\n```\r\n--- if we are in a filter -->\r\n```sql\r\na OR b OR c\r\n```\r\n\r\n","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2118743230/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ranma42","id":1506030,"node_id":"MDQ6VXNlcjE1MDYwMzA=","avatar_url":"https://avatars.githubusercontent.com/u/1506030?v=4","gravatar_id":"","url":"https://api.github.com/users/ranma42","html_url":"https://github.com/ranma42","followers_url":"https://api.github.com/users/ranma42/followers","following_url":"https://api.github.com/users/ranma42/following{/other_user}","gists_url":"https://api.github.com/users/ranma42/gists{/gist_id}","starred_url":"https://api.github.com/users/ranma42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ranma42/subscriptions","organizations_url":"https://api.github.com/users/ranma42/orgs","repos_url":"https://api.github.com/users/ranma42/repos","events_url":"https://api.github.com/users/ranma42/events{/privacy}","received_events_url":"https://api.github.com/users/ranma42/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2118743897","html_url":"https://github.com/dotnet/efcore/issues/33751#issuecomment-2118743897","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/33751","id":2118743897,"node_id":"IC_kwDOAPaMMs5-SXdZ","user":{"login":"ranma42","id":1506030,"node_id":"MDQ6VXNlcjE1MDYwMzA=","avatar_url":"https://avatars.githubusercontent.com/u/1506030?v=4","gravatar_id":"","url":"https://api.github.com/users/ranma42","html_url":"https://github.com/ranma42","followers_url":"https://api.github.com/users/ranma42/followers","following_url":"https://api.github.com/users/ranma42/following{/other_user}","gists_url":"https://api.github.com/users/ranma42/gists{/gist_id}","starred_url":"https://api.github.com/users/ranma42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ranma42/subscriptions","organizations_url":"https://api.github.com/users/ranma42/orgs","repos_url":"https://api.github.com/users/ranma42/repos","events_url":"https://api.github.com/users/ranma42/events{/privacy}","received_events_url":"https://api.github.com/users/ranma42/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-05-18T09:44:32Z","updated_at":"2024-05-18T11:31:34Z","body":"fun fact: while trying to write the test cases in https://github.com/ranma42/efcore/tree/fix-case-when-9 I hit another (apparently unrelated) issue around nullability ðŸ˜… \r\n\r\nEDIT: posted the issue as #33752","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2118743897/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ranma42","id":1506030,"node_id":"MDQ6VXNlcjE1MDYwMzA=","avatar_url":"https://avatars.githubusercontent.com/u/1506030?v=4","gravatar_id":"","url":"https://api.github.com/users/ranma42","html_url":"https://github.com/ranma42","followers_url":"https://api.github.com/users/ranma42/followers","following_url":"https://api.github.com/users/ranma42/following{/other_user}","gists_url":"https://api.github.com/users/ranma42/gists{/gist_id}","starred_url":"https://api.github.com/users/ranma42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ranma42/subscriptions","organizations_url":"https://api.github.com/users/ranma42/orgs","repos_url":"https://api.github.com/users/ranma42/repos","events_url":"https://api.github.com/users/ranma42/events{/privacy}","received_events_url":"https://api.github.com/users/ranma42/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2118806233","html_url":"https://github.com/dotnet/efcore/issues/33751#issuecomment-2118806233","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/33751","id":2118806233,"node_id":"IC_kwDOAPaMMs5-SmrZ","user":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-05-18T12:19:31Z","updated_at":"2024-05-18T12:19:31Z","body":"> If we want to transform it, it should get simplified to x OR (NOT(y) AND z), i.e.\n\nYou're absolutely right, we indeed can't ignore WHENs with other result values since they may match and therefore cause a later WHEN to not apply. I don't think it's feasible for us to recognize when WHENs are truly disjoint, and I'm not sure that rewriting a CASE/WHEN to e.g. the above `x OR (NOT(y) AND z)` has any actual value...\n\nWe may want to consider removing this optimization, or maybe reduce its scope considerably (in case it answers some specific need we have..). Leaving to @maumar to investigate and think about it...","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2118806233/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":12855807523,"node_id":"MEE_lADOAPaMMs6JUlhxzwAAAAL-RA4j","url":"https://api.github.com/repos/dotnet/efcore/issues/events/12855807523","actor":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-05-18T12:19:33Z","performed_via_github_app":null},{"id":12855807526,"node_id":"SE_lADOAPaMMs6JUlhxzwAAAAL-RA4m","url":"https://api.github.com/repos/dotnet/efcore/issues/events/12855807526","actor":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-05-18T12:19:33Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2118830792","html_url":"https://github.com/dotnet/efcore/issues/33751#issuecomment-2118830792","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/33751","id":2118830792,"node_id":"IC_kwDOAPaMMs5-SsrI","user":{"login":"ranma42","id":1506030,"node_id":"MDQ6VXNlcjE1MDYwMzA=","avatar_url":"https://avatars.githubusercontent.com/u/1506030?v=4","gravatar_id":"","url":"https://api.github.com/users/ranma42","html_url":"https://github.com/ranma42","followers_url":"https://api.github.com/users/ranma42/followers","following_url":"https://api.github.com/users/ranma42/following{/other_user}","gists_url":"https://api.github.com/users/ranma42/gists{/gist_id}","starred_url":"https://api.github.com/users/ranma42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ranma42/subscriptions","organizations_url":"https://api.github.com/users/ranma42/orgs","repos_url":"https://api.github.com/users/ranma42/repos","events_url":"https://api.github.com/users/ranma42/events{/privacy}","received_events_url":"https://api.github.com/users/ranma42/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-05-18T13:46:55Z","updated_at":"2024-05-18T13:46:55Z","body":"> > If we want to transform it, it should get simplified to x OR (NOT(y) AND z), i.e.\r\n> \r\n> You're absolutely right, we indeed can't ignore WHENs with other result values since they may match and therefore cause a later WHEN to not apply. I don't think it's feasible for us to recognize when WHENs are truly disjoint, and I'm not sure that rewriting a CASE/WHEN to e.g. the above `x OR (NOT(y) AND z)` has any actual value...\r\n\r\nIn general checking whether the cases are disjoint is hard, but some special cases might be easier, for example:\r\n - the `CompareTo` pattern ([already handled](https://github.com/dotnet/efcore/blob/v8.0.5/src/EFCore.Relational/Query/Internal/SqlExpressionSimplifyingExpressionVisitor.cs#L220-L235))\r\n - CASE expressions with an operand ```CASE x WHEN x1 THEN v1 WHEN x2 THEN v2 ... END```  could be optimized if desired (repeated test values can be dropped, after that the test values are trivially disjoint); currently it is not optimized at all\r\n - CASE expressions with only `=` tests ```CASE WHEN x = x1 THEN v1 WHEN x = x2 THEN v2 ... END``` could be handled as a CASE with an operand\r\n\r\nAs mentioned in https://github.com/dotnet/efcore/issues/33751#issuecomment-2118743230 there are also some optimization opportunities on the value expressions (opposed to the test expressions).\r\n(disjointedness makes cases commutative, but some simpler optimizations would be possible regardless of that)\r\n\r\n> \r\n> We may want to consider removing this optimization, or maybe reduce its scope considerably (in case it answers some specific need we have..). Leaving to @maumar to investigate and think about it...\r\n\r\nExcept for the (already supported) `CompareTo` pattern, it is unclear to me whether there is a lot of value in trying really hard to optimize `CASE` expressions.\r\nEither way, I would like to try and help improving the `SqlExpressionSimplifyingExpressionVisitor` (fixing the issues and/or implementing further optimizations) if there is a chance ðŸ˜‡ ","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2118830792/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ranma42","id":1506030,"node_id":"MDQ6VXNlcjE1MDYwMzA=","avatar_url":"https://avatars.githubusercontent.com/u/1506030?v=4","gravatar_id":"","url":"https://api.github.com/users/ranma42","html_url":"https://github.com/ranma42","followers_url":"https://api.github.com/users/ranma42/followers","following_url":"https://api.github.com/users/ranma42/following{/other_user}","gists_url":"https://api.github.com/users/ranma42/gists{/gist_id}","starred_url":"https://api.github.com/users/ranma42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ranma42/subscriptions","organizations_url":"https://api.github.com/users/ranma42/orgs","repos_url":"https://api.github.com/users/ranma42/repos","events_url":"https://api.github.com/users/ranma42/events{/privacy}","received_events_url":"https://api.github.com/users/ranma42/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":12855959355,"node_id":"MEE_lADOAPaMMs6JUlhxzwAAAAL-Rl87","url":"https://api.github.com/repos/dotnet/efcore/issues/events/12855959355","actor":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-05-18T13:46:56Z","performed_via_github_app":null},{"id":12855959360,"node_id":"SE_lADOAPaMMs6JUlhxzwAAAAL-Rl9A","url":"https://api.github.com/repos/dotnet/efcore/issues/events/12855959360","actor":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-05-18T13:46:56Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2119013810","html_url":"https://github.com/dotnet/efcore/issues/33751#issuecomment-2119013810","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/33751","id":2119013810,"node_id":"IC_kwDOAPaMMs5-TZWy","user":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-05-18T22:02:39Z","updated_at":"2024-05-18T22:02:39Z","body":"I also agree that the most valuable optimization is the compare one. I would not like to strip case just for the sake of doing it (i.e. `x OR (NOT(y) AND z)`). Current way we do the general-purpose simplification is wrong, causing data corruption, so we definitely should remove it. However, I do like the specific optimizations proposed by @ranma42 (constant folding, merge and prune).\r\nThey don't affect super common scenarios, but we do optimizations that don't seem very useful at first glance, because they compound on one another and sometimes a silly optimization can open up further simplifications to a real query. As long as the result is a simpler/faster query, 100% correct and the code is relatively straightforward - I think it's worth adding it.\r\n\r\n@ranma42 a PR with some `SqlExpressionSimplifyingExpressionVisitor` would be most welcome. You clearly thought about this a bit, and optimizations you propose all make sense to me.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2119013810/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":12857031570,"node_id":"MEE_lADOAPaMMs6JUlhxzwAAAAL-VruS","url":"https://api.github.com/repos/dotnet/efcore/issues/events/12857031570","actor":{"login":"ranma42","id":1506030,"node_id":"MDQ6VXNlcjE1MDYwMzA=","avatar_url":"https://avatars.githubusercontent.com/u/1506030?v=4","gravatar_id":"","url":"https://api.github.com/users/ranma42","html_url":"https://github.com/ranma42","followers_url":"https://api.github.com/users/ranma42/followers","following_url":"https://api.github.com/users/ranma42/following{/other_user}","gists_url":"https://api.github.com/users/ranma42/gists{/gist_id}","starred_url":"https://api.github.com/users/ranma42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ranma42/subscriptions","organizations_url":"https://api.github.com/users/ranma42/orgs","repos_url":"https://api.github.com/users/ranma42/repos","events_url":"https://api.github.com/users/ranma42/events{/privacy}","received_events_url":"https://api.github.com/users/ranma42/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-05-18T22:02:40Z","performed_via_github_app":null},{"id":12857031571,"node_id":"SE_lADOAPaMMs6JUlhxzwAAAAL-VruT","url":"https://api.github.com/repos/dotnet/efcore/issues/events/12857031571","actor":{"login":"ranma42","id":1506030,"node_id":"MDQ6VXNlcjE1MDYwMzA=","avatar_url":"https://avatars.githubusercontent.com/u/1506030?v=4","gravatar_id":"","url":"https://api.github.com/users/ranma42","html_url":"https://github.com/ranma42","followers_url":"https://api.github.com/users/ranma42/followers","following_url":"https://api.github.com/users/ranma42/following{/other_user}","gists_url":"https://api.github.com/users/ranma42/gists{/gist_id}","starred_url":"https://api.github.com/users/ranma42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ranma42/subscriptions","organizations_url":"https://api.github.com/users/ranma42/orgs","repos_url":"https://api.github.com/users/ranma42/repos","events_url":"https://api.github.com/users/ranma42/events{/privacy}","received_events_url":"https://api.github.com/users/ranma42/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-05-18T22:02:40Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2119017758","html_url":"https://github.com/dotnet/efcore/issues/33751#issuecomment-2119017758","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/33751","id":2119017758,"node_id":"IC_kwDOAPaMMs5-TaUe","user":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-05-18T22:24:30Z","updated_at":"2024-05-18T22:24:30Z","body":"One thought... We generally don't try to go too far with optimizations which help with \"badly-written\" LINQ queries; there's an infinite number of ways in which a query can be expressed via inefficient LINQ, and we generally avoid adding a large amount of complexity (and also compilation time!) in trying to compensate for that. However, the same optimization which may help with badly-written LINQ queries can also help with SQL generated internally with the query pipeline; of course, when that's the case the optimization can be quite important.\n\nSo I think we should be generally pragmatic here; if we know of internally-produced SQL which is improved by an optimization, that's definitely a good reason to do it. If, however, we don't think there's such a case, and the optimization would **only** help with badly-written user queries, then unless the optimization is trivial/easy, IMHO we shouldn't necessarily do it.\n\n@ranma42 I'd suggest opening an issue for the planned optimization before spending too much time in implementation, so we can discuss.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2119017758/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":12857056760,"node_id":"MEE_lADOAPaMMs6JUlhxzwAAAAL-Vx34","url":"https://api.github.com/repos/dotnet/efcore/issues/events/12857056760","actor":{"login":"ranma42","id":1506030,"node_id":"MDQ6VXNlcjE1MDYwMzA=","avatar_url":"https://avatars.githubusercontent.com/u/1506030?v=4","gravatar_id":"","url":"https://api.github.com/users/ranma42","html_url":"https://github.com/ranma42","followers_url":"https://api.github.com/users/ranma42/followers","following_url":"https://api.github.com/users/ranma42/following{/other_user}","gists_url":"https://api.github.com/users/ranma42/gists{/gist_id}","starred_url":"https://api.github.com/users/ranma42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ranma42/subscriptions","organizations_url":"https://api.github.com/users/ranma42/orgs","repos_url":"https://api.github.com/users/ranma42/repos","events_url":"https://api.github.com/users/ranma42/events{/privacy}","received_events_url":"https://api.github.com/users/ranma42/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-05-18T22:24:32Z","performed_via_github_app":null},{"id":12857056763,"node_id":"SE_lADOAPaMMs6JUlhxzwAAAAL-Vx37","url":"https://api.github.com/repos/dotnet/efcore/issues/events/12857056763","actor":{"login":"ranma42","id":1506030,"node_id":"MDQ6VXNlcjE1MDYwMzA=","avatar_url":"https://avatars.githubusercontent.com/u/1506030?v=4","gravatar_id":"","url":"https://api.github.com/users/ranma42","html_url":"https://github.com/ranma42","followers_url":"https://api.github.com/users/ranma42/followers","following_url":"https://api.github.com/users/ranma42/following{/other_user}","gists_url":"https://api.github.com/users/ranma42/gists{/gist_id}","starred_url":"https://api.github.com/users/ranma42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ranma42/subscriptions","organizations_url":"https://api.github.com/users/ranma42/orgs","repos_url":"https://api.github.com/users/ranma42/repos","events_url":"https://api.github.com/users/ranma42/events{/privacy}","received_events_url":"https://api.github.com/users/ranma42/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-05-18T22:24:32Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2119025968","html_url":"https://github.com/dotnet/efcore/issues/33751#issuecomment-2119025968","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/33751","id":2119025968,"node_id":"IC_kwDOAPaMMs5-TcUw","user":{"login":"ranma42","id":1506030,"node_id":"MDQ6VXNlcjE1MDYwMzA=","avatar_url":"https://avatars.githubusercontent.com/u/1506030?v=4","gravatar_id":"","url":"https://api.github.com/users/ranma42","html_url":"https://github.com/ranma42","followers_url":"https://api.github.com/users/ranma42/followers","following_url":"https://api.github.com/users/ranma42/following{/other_user}","gists_url":"https://api.github.com/users/ranma42/gists{/gist_id}","starred_url":"https://api.github.com/users/ranma42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ranma42/subscriptions","organizations_url":"https://api.github.com/users/ranma42/orgs","repos_url":"https://api.github.com/users/ranma42/repos","events_url":"https://api.github.com/users/ranma42/events{/privacy}","received_events_url":"https://api.github.com/users/ranma42/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-05-18T23:11:03Z","updated_at":"2024-05-18T23:11:03Z","body":"If it makes sense to you I would\r\n 1. open a PR based that fixes this issue by removing the incorrect optimization and extending the CompareTo one a little bit, to avoid regressions (I would start from https://github.com/ranma42/efcore/tree/fix-case-when-9 plus any improvements you suggest)\r\n 2. open a separate issue to evaluate the tradeoffs of adding some CASE optimizations (code complexity vs query improvement opportunities); if we find some cases that are important and/or allow for easy improvements, I'll go forward and implement them; otherwise, we will at least some \"documentation\" (the explanations in the issue) of why those optimizations were not implemented","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2119025968/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ranma42","id":1506030,"node_id":"MDQ6VXNlcjE1MDYwMzA=","avatar_url":"https://avatars.githubusercontent.com/u/1506030?v=4","gravatar_id":"","url":"https://api.github.com/users/ranma42","html_url":"https://github.com/ranma42","followers_url":"https://api.github.com/users/ranma42/followers","following_url":"https://api.github.com/users/ranma42/following{/other_user}","gists_url":"https://api.github.com/users/ranma42/gists{/gist_id}","starred_url":"https://api.github.com/users/ranma42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ranma42/subscriptions","organizations_url":"https://api.github.com/users/ranma42/orgs","repos_url":"https://api.github.com/users/ranma42/repos","events_url":"https://api.github.com/users/ranma42/events{/privacy}","received_events_url":"https://api.github.com/users/ranma42/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":12857755230,"node_id":"REFE_lADOAPaMMs6JUlhxzwAAAAL-YcZe","url":"https://api.github.com/repos/dotnet/efcore/issues/events/12857755230","actor":{"login":"ranma42","id":1506030,"node_id":"MDQ6VXNlcjE1MDYwMzA=","avatar_url":"https://avatars.githubusercontent.com/u/1506030?v=4","gravatar_id":"","url":"https://api.github.com/users/ranma42","html_url":"https://github.com/ranma42","followers_url":"https://api.github.com/users/ranma42/followers","following_url":"https://api.github.com/users/ranma42/following{/other_user}","gists_url":"https://api.github.com/users/ranma42/gists{/gist_id}","starred_url":"https://api.github.com/users/ranma42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ranma42/subscriptions","organizations_url":"https://api.github.com/users/ranma42/orgs","repos_url":"https://api.github.com/users/ranma42/repos","events_url":"https://api.github.com/users/ranma42/events{/privacy}","received_events_url":"https://api.github.com/users/ranma42/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"e85ec68b48cdc872e0f5795e99a48330cfac0806","commit_url":"https://api.github.com/repos/ranma42/efcore/commits/e85ec68b48cdc872e0f5795e99a48330cfac0806","created_at":"2024-05-19T07:20:01Z","performed_via_github_app":null}]