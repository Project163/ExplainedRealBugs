{"url":"https://api.github.com/repos/dotnet/efcore/issues/34749","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/34749/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/34749/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/34749/events","html_url":"https://github.com/dotnet/efcore/issues/34749","id":2546347245,"node_id":"I_kwDOAPaMMs6Xxizt","number":34749,"title":"Created query for projection with ownedMany and join is wrong","user":{"login":"KillerBoogie","id":42609546,"node_id":"MDQ6VXNlcjQyNjA5NTQ2","avatar_url":"https://avatars.githubusercontent.com/u/42609546?v=4","gravatar_id":"","url":"https://api.github.com/users/KillerBoogie","html_url":"https://github.com/KillerBoogie","followers_url":"https://api.github.com/users/KillerBoogie/followers","following_url":"https://api.github.com/users/KillerBoogie/following{/other_user}","gists_url":"https://api.github.com/users/KillerBoogie/gists{/gist_id}","starred_url":"https://api.github.com/users/KillerBoogie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/KillerBoogie/subscriptions","organizations_url":"https://api.github.com/users/KillerBoogie/orgs","repos_url":"https://api.github.com/users/KillerBoogie/repos","events_url":"https://api.github.com/users/KillerBoogie/events{/privacy}","received_events_url":"https://api.github.com/users/KillerBoogie/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1675384372,"node_id":"MDU6TGFiZWwxNjc1Mzg0Mzcy","url":"https://api.github.com/repos/dotnet/efcore/labels/area-query","name":"area-query","color":"32b37b","default":false,"description":""},{"id":6678623180,"node_id":"LA_kwDOAPaMMs8AAAABjhOzzA","url":"https://api.github.com/repos/dotnet/efcore/labels/area-complex-types","name":"area-complex-types","color":"32b37b","default":false,"description":""},{"id":8130499638,"node_id":"LA_kwDOAPaMMs8AAAAB5J2UNg","url":"https://api.github.com/repos/dotnet/efcore/labels/preview-1","name":"preview-1","color":"ACB3D7","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/204","html_url":"https://github.com/dotnet/efcore/milestone/204","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/204/labels","id":11480673,"node_id":"MI_kwDOAPaMMs4Ary5h","number":204,"title":"10.0.0","description":"","creator":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":1,"closed_issues":193,"state":"open","created_at":"2024-08-23T12:48:26Z","updated_at":"2025-11-05T08:24:30Z","due_on":null,"closed_at":null},"comments":13,"created_at":"2024-09-24T20:33:10Z","updated_at":"2025-06-15T20:09:58Z","closed_at":"2024-10-20T06:31:07Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Update: I also got a null exception. I connected it first to the wrong query, but it was a constructor issue for the DTO. I corrected the code below.\r\n\r\nBelow is the relevant code. It is part of a bigger project. It is not easy and very time consuming to create a reduced working project. I hope the issue can be understood by the posted code.\r\n\r\nThis is the projection that causes the issue. It just tries to return location data with nested cover images. The image Uri, width and height is pulled from the Image collection. Therefore a join is created. \r\n\r\n``` \r\nList<LocationMLResponse> Locations;\r\n\r\nvar query = dbContext.Location.AsNoTracking().AsSplitQuery()\r\n            .Select(location => new LocationMLResponse(\r\n             location.Id.Value,\r\n             location.Name.ToStringDictionary(),\r\n             location.CoverImages\r\n                 .Join(dbContext.Image.AsNoTracking(),\r\n                 danceCoverImage => danceCoverImage.ImageId,\r\n                 image => image.Id,\r\n                 (danceCoverImage, image) => new ImageItemResponse(\r\n                     danceCoverImage.ImageId.Value,\r\n                     danceCoverImage.DisplayOrder,\r\n                     danceCoverImage.Language == null ? null : danceCoverImage.Language.Tag,\r\n                     danceCoverImage.ScreenSize == null ? null : danceCoverImage.ScreenSize.Value,\r\n                     danceCoverImage.FocusPointX,\r\n                     danceCoverImage.FocusPointY,\r\n                     image.Uri.ToString(),\r\n                     image.MetaData.Width,\r\n                     image.MetaData.Height\r\n                 )).ToList(),\r\n             location.Address.MapToDto(),\r\n             location.Created,\r\n             location.LastModified,\r\n             location.Version\r\n             ));\r\n\r\n Locations = await query.ToListAsync();\r\n \r\n public record LocationMLResponse(\r\n   object Id,\r\n   Dictionary<string, string> Name,\r\n   List<ImageItemResponse> CoverImage,\r\n   AddressDto Address,\r\n   DateTime Created,\r\n   DateTime LastModified,\r\n   ulong Version\r\n   )\r\n ```\r\nThe projection creates 3 queries. The first 2 queries are sufficient and would return the correct result. The 3rd query is unnecessary. I don't understand why it is created. It leads to a wrong response.\r\n\r\n ```\r\n SELECT [l].[LocationId], [l].[Name], [l].[Created], [l].[CreatedBy], [l].[CreatedInNameOf], [l].[LastModified], [l].[LastModifiedBy], [l].[LastModifiedInNameOf], [l].[TId], [l].[Version], [l].[Address_City], [l].[Address_CountryId], [l].[Address_CountryName], [l].[Address_DeliveryInstruction], [l].[Address_State], [l].[Address_Street], [l].[Address_StreetAffix], [l].[Address_StreetNumber], [l].[Address_ZipCode]\r\n FROM [VC].[Location] AS [l]\r\n ORDER BY [l].[LocationId]\r\n \r\nSELECT [t].[ImageId], [t].[DisplayOrder], [t].[Language], [t].[ScreenSize], [t].[FocusPointX], [t].[FocusPointY], [t].[Uri], [t].[c], [t].[c0], [l].[LocationId]\r\nFROM [VC].[Location] AS [l]\r\nINNER JOIN (\r\n    SELECT [l0].[ImageId], [l0].[DisplayOrder], [l0].[Language], [l0].[ScreenSize], [l0].[FocusPointX], [l0].[FocusPointY], [i].[Uri], CAST([i].[MetaData_Width] AS bigint) AS [c], CAST([i].[MetaData_Height] AS bigint) AS [c0], [l0].[LocationId]\r\n    FROM [VC].[LocationCoverImage] AS [l0]\r\n    INNER JOIN [VC].[Image] AS [i] ON [l0].[ImageId] = [i].[ImageId]\r\n) AS [t] ON [l].[LocationId] = [t].[LocationId]\r\nORDER BY [l].[LocationId]\r\n\r\nSELECT [l0].[TId], [l0].[DisplayOrder], [l0].[FocusPointX], [l0].[FocusPointY], [l0].[ImageId], [l0].[Language], [l0].[LocationId], [l0].[ScreenSize], [l].[LocationId]\r\nFROM [VC].[Location] AS [l]\r\nINNER JOIN [VC].[LocationCoverImage] AS [l0] ON [l].[LocationId] = [l0].[LocationId]\r\nORDER BY [l].[LocationId]\r\n ```\r\n \r\nI also tried without SplitQuery. The result again has an additional `LEFT JOIN` that makes no sense.\r\n\r\n```\r\nSELECT [l].[LocationId], [l].[Name], [t].[ImageId], [t].[DisplayOrder], [t].[Language], [t].[ScreenSize], [t].[FocusPointX], [t].[FocusPointY], [t].[Uri], [t].[c], [t].[c0], [t].[TId], [t].[ImageId0], [l].[Created], [l].[CreatedBy], [l].[CreatedInNameOf], [l].[LastModified], [l].[LastModifiedBy], [l].[LastModifiedInNameOf], [l].[TId], [l].[Version], [l].[Address_City], [l].[Address_CountryId], [l].[Address_CountryName], [l].[Address_DeliveryInstruction], [l].[Address_State], [l].[Address_Street], [l].[Address_StreetAffix], [l].[Address_StreetNumber], [l].[Address_ZipCode], [l1].[TId], [l1].[DisplayOrder], [l1].[FocusPointX], [l1].[FocusPointY], [l1].[ImageId], [l1].[Language], [l1].[LocationId], [l1].[ScreenSize]\r\nFROM [VC].[Location] AS [l]\r\nLEFT JOIN (\r\n    SELECT [l0].[ImageId], [l0].[DisplayOrder], [l0].[Language], [l0].[ScreenSize], [l0].[FocusPointX], [l0].[FocusPointY], [i].[Uri], CAST([i].[MetaData_Width] AS bigint) AS [c], CAST([i].[MetaData_Height] AS bigint) AS [c0], [l0].[TId], [i].[ImageId] AS [ImageId0], [l0].[LocationId]\r\n    FROM [VC].[LocationCoverImage] AS [l0]\r\n    INNER JOIN [VC].[Image] AS [i] ON [l0].[ImageId] = [i].[ImageId]\r\n) AS [t] ON [l].[LocationId] = [t].[LocationId]\r\nLEFT JOIN [VC].[LocationCoverImage] AS [l1] ON [l].[LocationId] = [l1].[LocationId]\r\nORDER BY [l].[LocationId], [t].[TId], [t].[ImageId0]\r\n\r\n```\r\n\r\nThe `Location` object has a list of `ImageItems`. `ImageItems` link to images from the Image collection with additional properties. ML<> and MLRequired<> are value objects that allow storing text in different languages. LocationName and Address are also value objects.\r\n\r\n```\r\npublic class Location : VersionedEntity<LocationId>\r\n{\r\n    public MLRequired<LocationName> Name { get; private set; }\r\n    public IReadOnlyList<ImageItem> CoverImages => _coverImages.AsReadOnly();\r\n    private List<ImageItem> _coverImages;\r\n    public Address Address { get; private set; }\r\n\r\n#pragma warning disable CS8618 \r\n        private Location() { }\r\n#pragma warning restore CS8618 \r\n }\r\n \r\n public record ImageItem (\r\n      ImageId ImageId,\r\n      int? DisplayOrder = null,\r\n      Language? Language = null,\r\n      ScreenSize? ScreenSize = null,\r\n      decimal? FocusPointX = null, \r\n      decimal? FocusPointY = null\r\n      );\r\n  \r\npublic class Image : VersionedEntity<ImageId>\r\n{\r\n    public FileName FileName { get; private set; }\r\n    public ML<ImageDescription> Description { get; private set; }\r\n    public Uri Uri { get; private set; }\r\n    public ImageMetaData MetaData { get; private set; }\r\n\r\n#pragma warning disable CS8618\r\n        protected Image() { }\r\n#pragma warning restore CS8618  \r\n}\r\n\r\npublic record ImageMetaData\r\n{\r\n    public int? Width { get; private set; }\r\n    public int? Height { get; private set; }\r\n    public int? Size { get; private set; }\r\n\r\n    private ImageMetaData(int? size, int? width, int? height)\r\n    {\r\n        Size = size;\r\n        Width = width;\r\n        Height = height;\r\n    }\r\n}       \r\n```\r\n\r\nThis is the EF Core configuration for Location. Since we use guids as ids we add a technical cluster key (TId).\r\n\r\n``` \r\npublic class LocationConfiguration : IEntityTypeConfiguration<Location>\r\n{\r\n    public void Configure(EntityTypeBuilder<Location> entity)\r\n    {\r\n        entity.ToTable(\"Location\", VCDbContext.Schema);\r\n\r\n        entity.Property<int>(\"TId\").UseIdentityColumn().HasColumnOrder(0);\r\n        entity.HasIndex(\"TId\").IsUnique().IsClustered();\r\n\r\n        entity.HasKey(e => e.Id).IsClustered(false);\r\n        entity.Property(e => e.Id).HasColumnName(nameof(LocationId)).HasColumnOrder(1);\r\n\r\n        entity.Property(e => e.Name);\r\n\r\n        entity.OwnsMany(e => e.CoverImages, ci =>\r\n        {\r\n            ci.ToTable(\"LocationCoverImage\");\r\n            ci.WithOwner().HasForeignKey(\"LocationId\").HasConstraintName(\"FK_LocationCoverImage_Location_LocationId\");\r\n            ci.HasIndex(\"LocationId\").HasDatabaseName(\"IX_LocationCoverImage_LocationId\");\r\n            ci.Property<long>(\"TId\").HasColumnOrder(0);\r\n            ci.HasKey(\"TId\");\r\n            ci.Property(i => i.ImageId).HasColumnName(\"ImageId\").IsRequired();\r\n            ci.HasOne<Image>()\r\n                .WithMany()\r\n                .HasForeignKey(i => i.ImageId)\r\n                .HasConstraintName(\"FK_LocationCoverImage_ImageId\")\r\n                .OnDelete(DeleteBehavior.NoAction);\r\n            ci.Property(i => i.DisplayOrder);\r\n            ci.Property(i => i.FocusPointX).HasPrecision(precision:4, scale:2);\r\n            ci.Property(i => i.FocusPointY).HasPrecision(precision:4, scale:2);\r\n        });\r\n\r\n        entity.ComplexProperty(e => e.Address).Property(e => e.DeliveryInstruction);\r\n        entity.ComplexProperty(e => e.Address).Property(e => e.Street);\r\n        entity.ComplexProperty(e => e.Address).Property(e => e.StreetNumber);\r\n        entity.ComplexProperty(e => e.Address).Property(e => e.StreetAffix);\r\n        entity.ComplexProperty(e => e.Address).Property(e => e.ZipCode);\r\n        entity.ComplexProperty(e => e.Address).Property(e => e.City);\r\n        entity.ComplexProperty(e => e.Address).Property(e => e.State);\r\n        entity.ComplexProperty(e => e.Address).Property(e => e.CountryId);\r\n        entity.ComplexProperty(e => e.Address).Property(e => e.CountryName);\r\n\r\n        entity.Property(e => e.Version).IsRowVersion().HasConversion<byte[]>();\r\n    }\r\n}\r\n```\r\n\r\nImage Configuration:\r\n\r\n```\r\n public class ImageConfiguration : IEntityTypeConfiguration<Image>\r\n {\r\n     public void Configure(EntityTypeBuilder<Image> entity)\r\n     {\r\n         entity.ToTable(\"Image\", VCDbContext.Schema);\r\n\r\n         entity.Property<int>(\"TId\").UseIdentityColumn().HasColumnOrder(0);\r\n         entity.HasIndex(\"TId\").IsUnique().IsClustered();\r\n\r\n         entity.HasKey(e => e.Id).IsClustered(false);\r\n         entity.Property(e => e.Id).HasColumnName(nameof(ImageId)).HasColumnOrder(1);\r\n\r\n         entity.Property(e => e.FileName).HasMaxLength(FileName.MaxLength).HasColumnOrder(2);\r\n         entity.HasIndex(\"FileName\").IsUnique();\r\n         entity.Property(e => e.Description).HasColumnOrder(3);\r\n\r\n         entity.Property(e => e.Uri).HasColumnOrder(4);\r\n         entity.HasIndex(\"Uri\").IsUnique();\r\n         entity.ComplexProperty(e => e.MetaData).Property(e => e.Width).HasColumnOrder(5);\r\n         entity.ComplexProperty(e => e.MetaData).Property(e => e.Height).HasColumnOrder(6);\r\n         entity.ComplexProperty(e => e.MetaData).Property(e => e.Size).HasColumnOrder(7);\r\n\r\n         entity.Property(e => e.Version).IsRowVersion().HasConversion<byte[]>();\r\n     }\r\n }\r\n ```\r\n\r\n---\r\nEF Core version: 8.0.8\r\nDatabase provider: Microsoft.EntityFrameworkCore.SqlServer\r\nTarget framework: NET 8.0\r\nOperating system: Win 11\r\nVisual Studio 2022 17.11.4\r\n","closed_by":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/34749/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/34749/timeline","performed_via_github_app":null,"state_reason":"completed"}