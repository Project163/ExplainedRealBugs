{"url":"https://api.github.com/repos/dotnet/efcore/issues/27652","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/27652/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/27652/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/27652/events","html_url":"https://github.com/dotnet/efcore/issues/27652","id":1171024081,"node_id":"I_kwDOAPaMMs5FzGjR","number":27652,"title":"Diagnostics: DataReaderDisposingEventData.ReadCount accumulates the value from different readers","user":{"login":"arekpalinski","id":376551,"node_id":"MDQ6VXNlcjM3NjU1MQ==","avatar_url":"https://avatars.githubusercontent.com/u/376551?v=4","gravatar_id":"","url":"https://api.github.com/users/arekpalinski","html_url":"https://github.com/arekpalinski","followers_url":"https://api.github.com/users/arekpalinski/followers","following_url":"https://api.github.com/users/arekpalinski/following{/other_user}","gists_url":"https://api.github.com/users/arekpalinski/gists{/gist_id}","starred_url":"https://api.github.com/users/arekpalinski/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/arekpalinski/subscriptions","organizations_url":"https://api.github.com/users/arekpalinski/orgs","repos_url":"https://api.github.com/users/arekpalinski/repos","events_url":"https://api.github.com/users/arekpalinski/events{/privacy}","received_events_url":"https://api.github.com/users/arekpalinski/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":514908713,"node_id":"MDU6TGFiZWw1MTQ5MDg3MTM=","url":"https://api.github.com/repos/dotnet/efcore/labels/regression","name":"regression","color":"ff1fff","default":false,"description":null},{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1017558838,"node_id":"MDU6TGFiZWwxMDE3NTU4ODM4","url":"https://api.github.com/repos/dotnet/efcore/labels/Servicing-approved","name":"Servicing-approved","color":"048708","default":false,"description":""},{"id":1675384372,"node_id":"MDU6TGFiZWwxNjc1Mzg0Mzcy","url":"https://api.github.com/repos/dotnet/efcore/labels/area-query","name":"area-query","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/142","html_url":"https://github.com/dotnet/efcore/milestone/142","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/142/labels","id":7900564,"node_id":"MI_kwDOAPaMMs4AeI2U","number":142,"title":"6.0.6","description":null,"creator":{"login":"leecow","id":2212879,"node_id":"MDQ6VXNlcjIyMTI4Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/2212879?v=4","gravatar_id":"","url":"https://api.github.com/users/leecow","html_url":"https://github.com/leecow","followers_url":"https://api.github.com/users/leecow/followers","following_url":"https://api.github.com/users/leecow/following{/other_user}","gists_url":"https://api.github.com/users/leecow/gists{/gist_id}","starred_url":"https://api.github.com/users/leecow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/leecow/subscriptions","organizations_url":"https://api.github.com/users/leecow/orgs","repos_url":"https://api.github.com/users/leecow/repos","events_url":"https://api.github.com/users/leecow/events{/privacy}","received_events_url":"https://api.github.com/users/leecow/received_events","type":"User","user_view_type":"public","site_admin":true},"open_issues":0,"closed_issues":7,"state":"closed","created_at":"2022-04-21T17:56:01Z","updated_at":"2022-10-03T17:52:25Z","due_on":null,"closed_at":"2022-05-19T01:35:28Z"},"comments":3,"created_at":"2022-03-16T13:27:34Z","updated_at":"2025-06-15T18:46:25Z","closed_at":"2022-05-11T20:51:40Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"It looks that in the `DataReaderDisposingEventData.ReadCount` accumulates the values from different readers.\r\n### Include your code\r\n\r\nI have the following diagnostics observer:\r\n\r\n```C#\r\npublic class MyObserver : IObserver<KeyValuePair<string, object>>\r\n        {\r\n            public void OnCompleted()\r\n            {\r\n\r\n            }\r\n\r\n            public void OnError(Exception error)\r\n            {\r\n\r\n            }\r\n\r\n            public void OnNext(KeyValuePair<string, object> item)\r\n            {\r\n                var value = item.Value;\r\n                var key = item.Key;\r\n\r\n                if (value is DataReaderDisposingEventData data)\r\n                {\r\n                    Console.WriteLine(data.ReadCount);\r\n                }\r\n            }\r\n        }\r\n\r\n\r\n        public class MyDiagnosticListenerObserver : IObserver<DiagnosticListener>\r\n        {\r\n            private readonly MyObserver _observer;\r\n\r\n            internal MyDiagnosticListenerObserver(MyObserver observer)\r\n            {\r\n                this._observer = observer;\r\n            }\r\n\r\n            public void OnCompleted()\r\n            {\r\n\r\n            }\r\n\r\n            public void OnError(Exception error)\r\n            {\r\n\r\n            }\r\n\r\n            public void OnNext(DiagnosticListener value)\r\n            {\r\n                value.Subscribe(_observer);\r\n            }\r\n        }\r\n```\r\n\r\nDiagnostics initialization:\r\n\r\n```C#\r\nMyDiagnosticListenerObserver myDiagnosticListenerObserver = new MyDiagnosticListenerObserver(new MyObserver());\r\nDiagnosticListener.AllListeners.Subscribe(myDiagnosticListenerObserver);\r\n```\r\n\r\nSample code using EF (select n+1 problem):\r\n\r\n```C#\r\nusing (var db = new Entities(conStr))\r\n{\r\n\tforeach (var post in db.Posts.ToList())\r\n\t{\r\n\t\tdb.Entry(post).Collection(p => p.Comments).Load();\r\n\t}\r\n}\r\n```\r\n\r\nThe above code writes the following (expected) output to the console when using EF Core version: 5.0.15:\r\n\r\n```\r\n11\r\n5\r\n5\r\n5\r\n5\r\n5\r\n5\r\n5\r\n5\r\n5\r\n5\r\n```\r\n\r\nwhile the same code using EF Core 6.0.3  outputs the following:\r\n\r\n```\r\n11\r\n16\r\n21\r\n26\r\n31\r\n36\r\n41\r\n46\r\n51\r\n56\r\n61\r\n```\r\n\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/27652/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/27652/timeline","performed_via_github_app":null,"state_reason":"completed"}