{"url":"https://api.github.com/repos/dotnet/efcore/issues/32235","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/32235/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/32235/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/32235/events","html_url":"https://github.com/dotnet/efcore/issues/32235","id":1977512347,"node_id":"I_kwDOAPaMMs513nGb","number":32235,"title":"Buffering error in JSON deserialization with junk data","user":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1017558838,"node_id":"MDU6TGFiZWwxMDE3NTU4ODM4","url":"https://api.github.com/repos/dotnet/efcore/labels/Servicing-approved","name":"Servicing-approved","color":"048708","default":false,"description":""},{"id":1675384372,"node_id":"MDU6TGFiZWwxNjc1Mzg0Mzcy","url":"https://api.github.com/repos/dotnet/efcore/labels/area-query","name":"area-query","color":"32b37b","default":false,"description":""},{"id":4373235881,"node_id":"LA_kwDOAPaMMs8AAAABBKpIqQ","url":"https://api.github.com/repos/dotnet/efcore/labels/area-json","name":"area-json","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/185","html_url":"https://github.com/dotnet/efcore/milestone/185","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/185/labels","id":10179429,"node_id":"MI_kwDOAPaMMs4Am1Nl","number":185,"title":"8.0.1","description":null,"creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":9,"state":"closed","created_at":"2023-11-13T14:02:14Z","updated_at":"2024-04-09T08:40:08Z","due_on":null,"closed_at":"2024-04-09T08:40:08Z"},"comments":0,"created_at":"2023-11-04T21:10:32Z","updated_at":"2025-06-15T19:53:48Z","closed_at":"2023-11-14T10:24:38Z","author_association":"MEMBER","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I dug into the root cause of #32194 and I think I identified it; tl;dr, we ignore the return value of [TrySkip](https://github.com/dotnet/efcore/blob/main/src/EFCore.Relational/Query/RelationalShapedQueryCompilingExpressionVisitor.ShaperProcessingExpressionVisitor.cs#L1842) for unknown (junk) properties; if the buffering happens to cut an unknown property in the middle, we end up in a bad state.\r\n\r\nTo reproduce this with SQL Server, go to JsonQueryAdHocSqlServerTest, and replace SeekJunkInJson with the following:\r\n\r\n```c#\r\n    protected override void SeedJunkInJson(MyContextJunkInJson ctx)\r\n        => ctx.Database.ExecuteSqlRaw(\r\n            \"\"\"\r\nINSERT INTO [Entities] ([Collection], [CollectionWithCtor], [Reference], [ReferenceWithCtor], [Id])\r\nVALUES(\r\nN'[{{\"JunkReference\":{{\"Something\":\"SomeValue\" }},\"Name\":\"c11\",\"JunkProperty1\":50,\"Number\":11.5,\"JunkCollection1\":[],\"JunkCollection2\":[{{\"Foo\":\"junk value\"}}],\"NestedCollection\":[{{\"DoB\":\"2002-04-01T00:00:00\",\"DummyProp\":\"Dummy value\"}},{{\"DoB\":\"2002-04-02T00:00:00\",\"DummyReference\":{{\"Foo\":5}}}}],\"NestedReference\":{{\"DoB\":\"2002-03-01T00:00:00\"}}}},{{\"Name\":\"c12\",\"Number\":12.5,\"NestedCollection\":[{{\"DoB\":\"2002-06-01T00:00:00\"}},{{\"DoB\":\"2002-06-02T00:00:00\"}}],\"NestedDummy\":59,\"NestedReference\":{{\"DoB\":\"2002-05-01T00:00:00\"}}}}]',\r\nN'[{{\"MyBool\":true,\"Name\":\"c11 ctor\",\"JunkReference\":{{\"Something\":\"SomeValue\",\"JunkCollection\":[{{\"Foo\":\"junk value\"}}]}},\"NestedCollection\":[{{\"DoB\":\"2002-08-01T00:00:00\"}},{{\"DoB\":\"2002-08-02T00:00:00\"}}],\"NestedReference\":{{\"DoB\":\"2002-07-01T00:00:00\"}}}},{{\"MyBool\":false,\"Name\":\"c12 ctor\",\"NestedCollection\":[{{\"DoB\":\"2002-10-01T00:00:00\"}},{{\"DoB\":\"2002-10-02T00:00:00\"}}],\"JunkCollection\":[{{\"Foo\":\"junk value\"}}],\"NestedReference\":{{\"DoB\":\"2002-09-01T00:00:00\"}}}}]',\r\nN'{{\"Name\": \"r1\", \"Number\": 1.5, \"JunkReference\":{{\"Something\": \"SomeValue\" }}, \"JunkCollection\": [{{\"Foo\": \"junk value\"}}], \"NestedReference\": {{\"DoB\": \"2000-01-01T00:00:00\"}}, \"NestedCollection\": [{{\"DoB\": \"2000-02-01T00:00:00\", \"JunkReference\": {{\"Something\": \"SomeValue\"}}}}, {{\"DoB\": \"2000-02-02T00:00:00\"}}]}}',\r\nN'{{\"MyBool\":true,\"JunkCollection\":[{{\"Foo\":\"junk value\"}}],\"Name\":\"r1 ctor\",\"JunkReference\":{{\"Something\":\"SomeValue\" }},\"NestedCollection\":[{{\"DoB\":\"2001-02-01T00:00:00\"}},{{\"DoB\":\"2001-02-02T00:00:00\"}}],\"NestedReference\":{{\"JunkCollection\":[{{\"Foo\":\"junk value\"}}],\"DoB\":\"2001-01-01T00:00:00\"}}}}',\r\n1)\r\n\"\"\");\r\n```\r\n\r\nThe difference is in the 3rd row being inserted: the ordering is different and spaces have been added; this matches exactly the output that comes back on PostgreSQL, where the JSON data is saved in jsonb (not as text), and therefore a different representation gets returned. On this change is made, running the test Junk_in_json_basic_no_tracking triggers #32194, causing \"malformed JSON\" to be processed.\r\n\r\nWhen the test reaches MaterializeJsonEntityCollection, the JsonReaderData contains the following: `{\"DoB\": \"2000-02-01T00:00:00\", \"JunkReference\": {\"Something\": \"Som`. Note that the JunkReference data is cut off because of buffering; this is crucial to reproducing the bug (in the original SQL Server data, the entire thing is buffered and the bug does not occur).\r\n\r\nLooking at the actual shaper, we have the following code for parsing out the MyJsonEntityJunkInJsonNested in the collection:\r\n\r\n```\r\ntokenType = jsonReaderManager.CurrentReader.TokenType;\r\nLoop(Break: done Continue: )\r\n{\r\n\t{\r\n\t\ttokenType = jsonReaderManager.MoveNext();\r\n\t\tswitch (tokenType)\r\n\t\t{\r\n\t\t\tcase PropertyName: \r\n\t\t\t\tjsonReaderManager.CurrentReader.ValueTextEquals(DoB.EncodedUtf8Bytes) ? \r\n\t\t\t\t{\r\n\t\t\t\t\tjsonReaderManager.MoveNext();\r\n\t\t\t\t\tnamelessParameter{2} = ExpressionExtensions.ValueBufferTryReadValue<DateTime>(\r\n\t\t\t\t\t\tvalueBuffer: materializationContext3.get_ValueBuffer(), \r\n\t\t\t\t\t\tindex: 3, \r\n\t\t\t\t\t\tproperty: Property: MyEntityJunkInJson.Collection#MyJsonEntityJunkInJson.NestedCollection#MyJsonEntityJunkInJsonNested.DoB (DateTime) Required);\r\n\t\t\t\t} : default(void)\r\n\t\t\tcase EndObject: \r\n\t\t\t\tGoto(break done)\r\n\t\t\tdefault: \r\n\t\t\t\t{\r\n\t\t\t\t\tjsonReaderManager.CurrentReader.TrySkip();\r\n\t\t\t\t}\r\n\t\t}\r\n\t}}\r\n```\r\n\r\nWhen get a property, if it's the expected `DoB` property it gets assigned; otherwise, if it's an unknown property, we simply do nothing (this is the case with JunkReference). At this point we continue to the next token, which is a StartObject, and go into the default case. We call TrySkip() **but we ignore its return value**; if the value isn't fully buffered (as in this case), the skip silently fails.\r\n\r\nWe continue looping - through the JunkReference's internal tokens, until we get to the EndObject of the **inner** JunkReference and return - but we haven't consumed the EndObject of the **outer** object itself (MyJsonEntityJunkInJsonNested). So back in MaterializeJsonEntityCollection, we do MoveNext and get the containing object's EndObject, which for our logic is malformed JSON, and we fail.\r\n\r\n/cc @maumar @ajcvickers","closed_by":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/32235/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/32235/timeline","performed_via_github_app":null,"state_reason":"completed"}