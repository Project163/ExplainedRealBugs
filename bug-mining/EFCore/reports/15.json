{"url":"https://api.github.com/repos/dotnet/efcore/issues/27072","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/27072/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/27072/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/27072/events","html_url":"https://github.com/dotnet/efcore/issues/27072","id":1090528396,"node_id":"I_kwDOAPaMMs5BACSM","number":27072,"title":"Suboptimal SQL generation for query with optional navigation, its collection navigation and lateral join","user":{"login":"imb590","id":24669202,"node_id":"MDQ6VXNlcjI0NjY5MjAy","avatar_url":"https://avatars.githubusercontent.com/u/24669202?v=4","gravatar_id":"","url":"https://api.github.com/users/imb590","html_url":"https://github.com/imb590","followers_url":"https://api.github.com/users/imb590/followers","following_url":"https://api.github.com/users/imb590/following{/other_user}","gists_url":"https://api.github.com/users/imb590/gists{/gist_id}","starred_url":"https://api.github.com/users/imb590/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imb590/subscriptions","organizations_url":"https://api.github.com/users/imb590/orgs","repos_url":"https://api.github.com/users/imb590/repos","events_url":"https://api.github.com/users/imb590/events{/privacy}","received_events_url":"https://api.github.com/users/imb590/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1017558838,"node_id":"MDU6TGFiZWwxMDE3NTU4ODM4","url":"https://api.github.com/repos/dotnet/efcore/labels/Servicing-approved","name":"Servicing-approved","color":"048708","default":false,"description":""},{"id":1675384372,"node_id":"MDU6TGFiZWwxNjc1Mzg0Mzcy","url":"https://api.github.com/repos/dotnet/efcore/labels/area-query","name":"area-query","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/133","html_url":"https://github.com/dotnet/efcore/milestone/133","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/133/labels","id":7585591,"node_id":"MI_kwDOAPaMMs4Ac783","number":133,"title":"6.0.3","description":null,"creator":{"login":"leecow","id":2212879,"node_id":"MDQ6VXNlcjIyMTI4Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/2212879?v=4","gravatar_id":"","url":"https://api.github.com/users/leecow","html_url":"https://github.com/leecow","followers_url":"https://api.github.com/users/leecow/followers","following_url":"https://api.github.com/users/leecow/following{/other_user}","gists_url":"https://api.github.com/users/leecow/gists{/gist_id}","starred_url":"https://api.github.com/users/leecow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/leecow/subscriptions","organizations_url":"https://api.github.com/users/leecow/orgs","repos_url":"https://api.github.com/users/leecow/repos","events_url":"https://api.github.com/users/leecow/events{/privacy}","received_events_url":"https://api.github.com/users/leecow/received_events","type":"User","user_view_type":"public","site_admin":true},"open_issues":0,"closed_issues":9,"state":"closed","created_at":"2022-01-18T18:17:07Z","updated_at":"2022-03-22T00:31:20Z","due_on":null,"closed_at":"2022-03-22T00:31:20Z"},"comments":7,"created_at":"2021-12-29T13:40:48Z","updated_at":"2025-06-15T18:44:28Z","closed_at":"2022-02-03T12:40:35Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Consider the following code:\r\n\r\n```C#\r\nusing System.Collections.Generic;\r\nusing System.ComponentModel.DataAnnotations.Schema;\r\nusing System.Linq;\r\nusing Microsoft.EntityFrameworkCore;\r\nusing Microsoft.Extensions.DependencyInjection;\r\nusing Microsoft.Extensions.Logging;\r\n\r\nusing var db = new Context();\r\n\r\nvar result = db.Set<EntityOne>()\r\n    .Select(o => new\r\n    {\r\n        Ids = o.Two!.Children!.Select(c => new { ChildId = c.Id, ParentId = o.Two.Id }),\r\n    });\r\n\r\nSystem.Console.WriteLine(result.ToQueryString());\r\n\r\npublic class Context : DbContext\r\n{\r\n    private static ILoggerFactory LoggerFactory => new ServiceCollection().AddLogging(l => l.AddConsole().SetMinimumLevel(LogLevel.Trace)).BuildServiceProvider().GetRequiredService<ILoggerFactory>();\r\n\r\n    public DbSet<EntityOne> Ones => Set<EntityOne>();\r\n    public DbSet<EntityTwo> Twos => Set<EntityTwo>();\r\n\r\n    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)\r\n    {\r\n        optionsBuilder\r\n            .UseNpgsql(\"Host=stub\")\r\n            .EnableSensitiveDataLogging()\r\n            .UseLoggerFactory(LoggerFactory);\r\n    }\r\n}\r\n\r\npublic class EntityOne\r\n{\r\n    public int Id { get; set; }\r\n\r\n    public int? TwoId { get; set; }\r\n\r\n    [ForeignKey(nameof(TwoId))]\r\n    public EntityTwo? Two { get; set; }\r\n}\r\n\r\npublic class EntityTwo\r\n{\r\n    public int Id { get; set; }\r\n\r\n    public int? ParentId { get; set; }\r\n\r\n    [ForeignKey(nameof(ParentId))]\r\n    public EntityTwo? Parent { get; set; }\r\n\r\n    [InverseProperty(nameof(Parent))]\r\n    public ICollection<EntityTwo>? Children { get; set; }\r\n}\r\n```\r\n\r\nThe generated SQL is:\r\n```sql\r\nSELECT o.\"Id\", t.\"Id\", t0.\"ChildId\", t0.\"ParentId\"\r\nFROM \"Ones\" AS o\r\nLEFT JOIN \"Twos\" AS t ON o.\"TwoId\" = t.\"Id\"\r\nLEFT JOIN LATERAL (\r\n    SELECT t1.\"Id\" AS \"ChildId\", t.\"Id\" AS \"ParentId\"\r\n    FROM \"Twos\" AS t1\r\n    WHERE (t.\"Id\" = t1.\"ParentId\") OR ((t.\"Id\" IS NULL) AND (t1.\"ParentId\" IS NULL))\r\n) AS t0 ON TRUE\r\nORDER BY o.\"Id\", t.\"Id\"\r\n```\r\n\r\nIt is very suboptimal, since due to the unnecessary `OR ((t.\"Id\" IS NULL) AND (t1.\"ParentId\" IS NULL))` clause in the inner query, it will iterate over all `EntityTwo` having `ParentId = null` for every `EntityOne` with `TwoId = null`, creating a new output row on every iteration.\r\n\r\nIt's possible to get rid of the iteration in the database with a workaround like:\r\n```c#\r\ndb.Set<EntityOne>()\r\n    .Select(o => new\r\n    {\r\n        Ids = o.Two!.Children!.Where(c => c.ParentId != null).Select(c => new { ChildId = c.Id, ParentId = o.Two.Id }),\r\n    });\r\n```\r\n\r\n### provider and version information\r\n\r\nEF Core version: 6.0.1\r\nDatabase provider: Npgsql.EntityFrameworkCore.PostgreSQL 6.0.2\r\nTarget framework: .NET 6\r\n","closed_by":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/27072/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/27072/timeline","performed_via_github_app":null,"state_reason":"completed"}