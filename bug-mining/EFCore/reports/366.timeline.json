[{"id":10863492454,"node_id":"LE_lADOAPaMMs513f86zwAAAAKHg71m","url":"https://api.github.com/repos/dotnet/efcore/issues/events/10863492454","actor":{"login":"tim-stuyckens-materialise","id":134292323,"node_id":"U_kgDOCAEjYw","avatar_url":"https://avatars.githubusercontent.com/u/134292323?v=4","gravatar_id":"","url":"https://api.github.com/users/tim-stuyckens-materialise","html_url":"https://github.com/tim-stuyckens-materialise","followers_url":"https://api.github.com/users/tim-stuyckens-materialise/followers","following_url":"https://api.github.com/users/tim-stuyckens-materialise/following{/other_user}","gists_url":"https://api.github.com/users/tim-stuyckens-materialise/gists{/gist_id}","starred_url":"https://api.github.com/users/tim-stuyckens-materialise/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tim-stuyckens-materialise/subscriptions","organizations_url":"https://api.github.com/users/tim-stuyckens-materialise/orgs","repos_url":"https://api.github.com/users/tim-stuyckens-materialise/repos","events_url":"https://api.github.com/users/tim-stuyckens-materialise/events{/privacy}","received_events_url":"https://api.github.com/users/tim-stuyckens-materialise/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2023-11-04T19:46:49Z","label":{"name":"customer-reported","color":"a4a5f9"},"performed_via_github_app":null},{"id":10863497051,"node_id":"RTE_lADOAPaMMs513f86zwAAAAKHg89b","url":"https://api.github.com/repos/dotnet/efcore/issues/events/10863497051","actor":{"login":"tim-stuyckens-materialise","id":134292323,"node_id":"U_kgDOCAEjYw","avatar_url":"https://avatars.githubusercontent.com/u/134292323?v=4","gravatar_id":"","url":"https://api.github.com/users/tim-stuyckens-materialise","html_url":"https://github.com/tim-stuyckens-materialise","followers_url":"https://api.github.com/users/tim-stuyckens-materialise/followers","following_url":"https://api.github.com/users/tim-stuyckens-materialise/following{/other_user}","gists_url":"https://api.github.com/users/tim-stuyckens-materialise/gists{/gist_id}","starred_url":"https://api.github.com/users/tim-stuyckens-materialise/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tim-stuyckens-materialise/subscriptions","organizations_url":"https://api.github.com/users/tim-stuyckens-materialise/orgs","repos_url":"https://api.github.com/users/tim-stuyckens-materialise/repos","events_url":"https://api.github.com/users/tim-stuyckens-materialise/events{/privacy}","received_events_url":"https://api.github.com/users/tim-stuyckens-materialise/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"renamed","commit_id":null,"commit_url":null,"created_at":"2023-11-04T19:50:09Z","rename":{"from":"SqliteException \"no such column : rX.value\" when ordering on subquery value in combination with a \"where contains\"","to":"SqliteException \"no such column : rX.value\" when ordering on subquery value in combination with a \"where contains\" when upgrading from 7 to 8.0.0-rc.2.23480.1"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/1794801839","html_url":"https://github.com/dotnet/efcore/issues/32234#issuecomment-1794801839","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/32234","id":1794801839,"node_id":"IC_kwDOAPaMMs5q-oCv","user":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-11-06T13:13:52Z","updated_at":"2023-11-06T13:16:35Z","body":"@roji This looks like a regression from 7.0 with JSON-based Contains on SQLIte. Runnable repro below; still fails on daily:\r\n\r\n```C#\r\nusing (var context = new SomeDbContext())\r\n{\r\n    await context.Database.EnsureDeletedAsync();\r\n    await context.Database.EnsureCreatedAsync();\r\n\r\n    var definitionIds = new[] { 1 };\r\n    \r\n    var pageNr = 1;\r\n    var crCount = 2;\r\n    \r\n    var iterationValuesQuery = context.IterationValues\r\n        .Include(x => x.Iteration)\r\n        .ThenInclude(x => x.Record)\r\n        .ThenInclude(x => x.RecordObject)\r\n        .Where(r => definitionIds.Contains(r.Iteration!.Record.RecordDefinitionId));\r\n\r\n    var recordIdsWithMatchCriteriaCountQuery =  iterationValuesQuery\r\n        .GroupBy(x => new { x.IterationId, x.Iteration.RecordId })\r\n        .Where(x => x.Count() >= crCount)\r\n        .Select(x => new\r\n        {\r\n            x.Key.RecordId,\r\n            x.Key.IterationId,\r\n            //for debugging\r\n            Count = x.Count(),\r\n            //for sorting\r\n            MaxTimestamp = x.Select(xx=>xx.Iteration.Timestamp).Max(),\r\n        });\r\n\r\n    var ps = 20;\r\n    \r\n    var recordIdsWithMatchCriteriaCount = await  recordIdsWithMatchCriteriaCountQuery.OrderBy(x => x.MaxTimestamp)\r\n        .Skip(pageNr * ps)\r\n        .Take(ps)\r\n        .ToListAsync();\r\n}\r\n\r\npublic class SomeDbContext : DbContext\r\n{\r\n    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)\r\n        => optionsBuilder\r\n            .UseSqlite(\"Data Source=test.db\")\r\n            .LogTo(Console.WriteLine, LogLevel.Information)\r\n            .EnableSensitiveDataLogging();\r\n\r\n    public DbSet<IterationValue> IterationValues => Set<IterationValue>();\r\n\r\n    private int GetTenantId() => 1;\r\n\r\n    protected override void OnModelCreating(ModelBuilder modelBuilder)\r\n    {\r\n        var pdbSchema = \"pdb\";\r\n        var recordBuilder = modelBuilder.Entity<Record>().ToTable(\"Records\", pdbSchema);\r\n        recordBuilder.HasQueryFilter(x => x.TenantId == GetTenantId());\r\n        recordBuilder.HasMany(x => x.Iterations).WithOne(x => x.Record).IsRequired().OnDelete(DeleteBehavior.ClientCascade);\r\n\r\n        var iterationBuilder = modelBuilder.Entity<Iteration>().ToTable(\"Iterations\", pdbSchema);\r\n        iterationBuilder.HasQueryFilter(x => x.TenantId == GetTenantId());\r\n        iterationBuilder.HasMany(x => x.IterationValues)\r\n            .WithOne(x => x.Iteration).IsRequired().OnDelete(DeleteBehavior.ClientCascade);\r\n        iterationBuilder.HasOne(x => x.Record).WithMany(x => x.Iterations).IsRequired();\r\n\r\n        var iterationValueBuilder = modelBuilder.Entity<IterationValue>().ToTable(\"IterationValues\", pdbSchema);\r\n        iterationValueBuilder.HasQueryFilter(x => x.TenantId == GetTenantId());\r\n\r\n        var recordDefinitionBuilder = modelBuilder.Entity<RecordDefinition>()\r\n            .ToTable(\"RecordDefinitions\", pdbSchema);\r\n        recordDefinitionBuilder.HasMany(x => x.Records)\r\n            .WithOne(x => x.RecordDefinition)\r\n            .OnDelete(DeleteBehavior.ClientNoAction);\r\n    }\r\n}\r\n\r\npublic class RecordDefinition\r\n{\r\n    public int Id { get; set; }\r\n    public List<Record> Records { get; set; } = new();\r\n}\r\n\r\npublic class IterationValue\r\n{\r\n    public int Id { get; set; }\r\n    public int TenantId { get; set; }\r\n    public Iteration? Iteration { get; set; }\r\n    public int IterationId { get; set; }\r\n}\r\n\r\npublic class Iteration\r\n{\r\n    public int Id { get; set; }\r\n    public int TenantId { get; set; }\r\n\r\n    public int RecordId { get; set; }\r\n    public Record Record { get; set; } = null!;\r\n    \r\n    public List<IterationValue> IterationValues { get; set; } = new();\r\n    public DateTime Timestamp { get; set; }\r\n}\r\n\r\npublic class Record\r\n{\r\n    public int Id { get; set; }\r\n    public int TenantId { get; set; }\r\n    public List<Iteration> Iterations { get; set; } = new();\r\n    public RecordDefinition RecordDefinition { get; set; }\r\n    public RecordObject RecordObject { get; set; }\r\n    public int RecordDefinitionId { get; set; }\r\n}\r\n\r\npublic class RecordObject\r\n{\r\n    public int Id { get; set; }\r\n}\r\n```","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/1794801839/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":10872773319,"node_id":"MEE_lADOAPaMMs513f86zwAAAAKIEVrH","url":"https://api.github.com/repos/dotnet/efcore/issues/events/10872773319","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2023-11-06T13:13:53Z","performed_via_github_app":null},{"id":10872773329,"node_id":"SE_lADOAPaMMs513f86zwAAAAKIEVrR","url":"https://api.github.com/repos/dotnet/efcore/issues/events/10872773329","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2023-11-06T13:13:53Z","performed_via_github_app":null},{"id":10872775532,"node_id":"LE_lADOAPaMMs513f86zwAAAAKIEWNs","url":"https://api.github.com/repos/dotnet/efcore/issues/events/10872775532","actor":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2023-11-06T13:14:05Z","label":{"name":"type-bug","color":"f7c6c7"},"performed_via_github_app":null},{"id":10872775543,"node_id":"LE_lADOAPaMMs513f86zwAAAAKIEWN3","url":"https://api.github.com/repos/dotnet/efcore/issues/events/10872775543","actor":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2023-11-06T13:14:05Z","label":{"name":"regression","color":"ff1fff"},"performed_via_github_app":null},{"id":10872781027,"node_id":"LE_lADOAPaMMs513f86zwAAAAKIEXjj","url":"https://api.github.com/repos/dotnet/efcore/issues/events/10872781027","actor":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2023-11-06T13:14:33Z","label":{"name":"Servicing-consider","color":"bfd4f2"},"performed_via_github_app":null},{"id":10872781034,"node_id":"LE_lADOAPaMMs513f86zwAAAAKIEXjq","url":"https://api.github.com/repos/dotnet/efcore/issues/events/10872781034","actor":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2023-11-06T13:14:33Z","label":{"name":"area-query","color":"32b37b"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/1794818945","html_url":"https://github.com/dotnet/efcore/issues/32234#issuecomment-1794818945","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/32234","id":1794818945,"node_id":"IC_kwDOAPaMMs5q-sOB","user":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-11-06T13:24:24Z","updated_at":"2023-11-06T13:24:24Z","body":"@ajcvickers thanks for the repro - I'll put this on my high-priority list.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/1794818945/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":10872905267,"node_id":"MEE_lADOAPaMMs513f86zwAAAAKIE14z","url":"https://api.github.com/repos/dotnet/efcore/issues/events/10872905267","actor":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2023-11-06T13:24:25Z","performed_via_github_app":null},{"id":10872905283,"node_id":"SE_lADOAPaMMs513f86zwAAAAKIE15D","url":"https://api.github.com/repos/dotnet/efcore/issues/events/10872905283","actor":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2023-11-06T13:24:25Z","performed_via_github_app":null},{"id":10906172724,"node_id":"AE_lADOAPaMMs513f86zwAAAAKKDv00","url":"https://api.github.com/repos/dotnet/efcore/issues/events/10906172724","actor":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"assigned","commit_id":null,"commit_url":null,"created_at":"2023-11-08T21:48:56Z","assignee":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"performed_via_github_app":null},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/1806153111","html_url":"https://github.com/dotnet/efcore/issues/32234#issuecomment-1806153111","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/32234","id":1806153111,"node_id":"IC_kwDOAPaMMs5rp7WX","user":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-11-10T17:40:00Z","updated_at":"2023-11-12T09:53:03Z","body":"Done some deep investigation into this, here are some preliminary observations.\r\n\r\nMinimal repro query:\r\n\r\n```c#\r\n_ = await context.IterationValues\r\n    .Where(r => ids.Contains(r.IterationId))\r\n    .GroupBy(x => x.IterationId)\r\n    .Select(x => new\r\n    {\r\n        x.Key,\r\n        MaxTimestamp = x.Select(x => x.Iteration.Timestamp).Max(),\r\n    })\r\n    .OrderBy(x => x.MaxTimestamp)\r\n    .ToListAsync();\r\n```\r\n\r\n<details>\r\n<summary>Full minimal repro code</summary>\r\n\r\n```c#\r\nawait using var context = new BlogContext();\r\n\r\nawait context.Database.EnsureDeletedAsync();\r\nawait context.Database.EnsureCreatedAsync();\r\n\r\nvar ids = new[] { 1 };\r\n\r\n_ = await context.IterationValues\r\n    .Where(r => ids.Contains(r.IterationId))\r\n    .GroupBy(x => x.IterationId)\r\n    .Select(x => new\r\n    {\r\n        x.Key,\r\n        MaxTimestamp = x.Select(x => x.Iteration.Timestamp).Max(),\r\n    })\r\n    .OrderBy(x => x.MaxTimestamp)\r\n    .ToListAsync();\r\n\r\npublic class BlogContext : DbContext\r\n{\r\n    public DbSet<IterationValue> IterationValues => Set<IterationValue>();\r\n\r\n    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)\r\n        => optionsBuilder\r\n            .UseSqlServer(@\"Server=localhost;Database=test;User=SA;Password=Abcd5678;Connect Timeout=60;ConnectRetryCount=0;Encrypt=false\")\r\n            .LogTo(Console.WriteLine, LogLevel.Information)\r\n            .EnableSensitiveDataLogging();\r\n}\r\n\r\npublic class IterationValue\r\n{\r\n    public int Id { get; set; }\r\n    public Iteration? Iteration { get; set; }\r\n    public int IterationId { get; set; }\r\n}\r\n\r\npublic class Iteration\r\n{\r\n    public int Id { get; set; }\r\n\r\n    public List<IterationValue> IterationValues { get; set; } = new();\r\n    public DateTime Timestamp { get; set; }\r\n}\r\n```\r\n</details>\r\n\r\n```sql\r\nSELECT [i].[IterationId] AS [Key], (\r\n    SELECT MAX([i5].[Timestamp])\r\n    FROM [IterationValues] AS [i4]\r\n    INNER JOIN [Iteration] AS [i5] ON [i4].[IterationId] = [i5].[Id]\r\n    WHERE [i4].[IterationId] IN (\r\n        SELECT [i6].[value]\r\n        FROM OPENJSON(@__ids_0) WITH ([value] int '$') AS [i6]\r\n    ) AND [i].[IterationId] = [i4].[IterationId]) AS [MaxTimestamp]\r\nFROM [IterationValues] AS [i]\r\nWHERE [i].[IterationId] IN (\r\n    SELECT [i0].[value]\r\n    FROM OPENJSON(@__ids_0) WITH ([value] int '$') AS [i0]\r\n)\r\nGROUP BY [i].[IterationId]\r\nORDER BY (\r\n    SELECT MAX([i5].[Timestamp])\r\n    FROM [IterationValues] AS [i4]\r\n    INNER JOIN [Iteration] AS [i5] ON [i4].[IterationId] = [i5].[Id]\r\n    WHERE [i4].[IterationId] IN (\r\n        SELECT [i6].[value] -- Incorrect [i6] - should be [i3]\r\n        FROM OPENJSON(@__ids_0) WITH ([value] int '$') AS [i3]\r\n    ) AND [i].[IterationId] = [i4].[IterationId])\r\n```\r\n\r\n* MaxTimestamp here is both projected and ordered by; this is why we get duplicated SQL under both the ORDER BY and the SELECT.\r\n* Crucially, since MaxTimestamp is a scalar subquery, that means we have a single SelectExpression (inside the subquery) that's referenced from two different parts in the query (projection, ordering).\r\n* During translation, we run RelationalInferredTypeMappingApplier on the query (but this can be any visitor). That visitor updates the OPENJSON expression (applying the type mapping), meaning that the SelectExpression inside the IN gets rewritten.\r\n* And so we end up in SelectExpression.VisitChildren, where we create a new SelectExpression to replace the one that has changed ([code](https://github.com/dotnet/efcore/blob/main/src/EFCore.Relational/Query/SqlExpressions/SelectExpression.cs#L4773)).\r\n* We copy the list of table references for the new SelectExpression, but the TableReferenceExpressions themselves stay the same.\r\n    * The point of TableReferenceExpression is for ColumnExpressions to reference tables indirectly - via their containing SelectExpression and alias; this allows us to cheaply modify a SelectExpression's tables - but also the SelectExpression itself - without having to recursively hunt down all ColumnExpressions within that SelectExpression and update them.\r\n* At this point, we must go over the TableReferenceExpressions and update them to point to the new SelectExpression ([code](https://github.com/dotnet/efcore/blob/main/src/EFCore.Relational/Query/SqlExpressions/SelectExpression.cs#L4801)). But since there are two references to the SelectExpression, the other SelectExpression still references these TableReferenceExpression instances, which we've just updated to point to the new SelectExpression.\r\n* As a result, we end up with the other SelectExpression pointing to the original table, but having a column referencing a TableReferenceExpression that points to the new SelectExpression (and through it, to the new table). This is a referential integrity bug.\r\n\r\nThis seems like an infrastructural bug that was present before, and can be triggered regardless of the recent Contains/JSON changes; any time a visitor causes a SelectExpression to be replaced, and that SelectExpression is referenced from multiple places, this bug would manifest itself.\r\n\r\nOne easier/short-term way to fix this, is to recursively to over the new SelectExpression and replace the TableReferenceExpressions themselves (rather than updating them, since they may be shared). This would be relatively inefficient (this needs to be done any time we replace a SelectExpression), and makes the concept of TableReferenceExpression quite redundant (ColumnExpressions might as well just reference directly, and we'd update them).\r\n\r\nHowever, more generally, we should not end up in a situation where the same SelectExpression gets referenced from two places in the query; this is very inefficient SQL, since e.g. the potentially expensive subquery above needs to be evaluated twice. Instead, we should perform a pushdown to a subquery and apply the OrderBy over that. If we never have a SelectExpression referenced from multiple places, this problem wouldn't occur.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/1806153111/reactions","total_count":3,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}},{"actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-11-12T10:20:37Z","updated_at":"2023-11-12T10:20:37Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/dotnet/efcore/issues/32277","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/32277/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/32277/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/32277/events","html_url":"https://github.com/dotnet/efcore/issues/32277","id":1989339218,"node_id":"I_kwDOAPaMMs52kuhS","number":32277,"title":"Stop producing duplicate subqueries in SQL","user":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":130861068,"node_id":"MDU6TGFiZWwxMzA4NjEwNjg=","url":"https://api.github.com/repos/dotnet/efcore/labels/area-perf","name":"area-perf","color":"5319e7","default":false,"description":""},{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1675384372,"node_id":"MDU6TGFiZWwxNjc1Mzg0Mzcy","url":"https://api.github.com/repos/dotnet/efcore/labels/area-query","name":"area-query","color":"32b37b","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/2","html_url":"https://github.com/dotnet/efcore/milestone/2","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/2/labels","id":648040,"node_id":"MDk6TWlsZXN0b25lNjQ4MDQw","number":2,"title":"Backlog","description":"Issues that have been approved but are not scheduled a specific release.","creator":{"login":"bricelam","id":1226749,"node_id":"MDQ6VXNlcjEyMjY3NDk=","avatar_url":"https://avatars.githubusercontent.com/u/1226749?v=4","gravatar_id":"","url":"https://api.github.com/users/bricelam","html_url":"https://github.com/bricelam","followers_url":"https://api.github.com/users/bricelam/followers","following_url":"https://api.github.com/users/bricelam/following{/other_user}","gists_url":"https://api.github.com/users/bricelam/gists{/gist_id}","starred_url":"https://api.github.com/users/bricelam/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bricelam/subscriptions","organizations_url":"https://api.github.com/users/bricelam/orgs","repos_url":"https://api.github.com/users/bricelam/repos","events_url":"https://api.github.com/users/bricelam/events{/privacy}","received_events_url":"https://api.github.com/users/bricelam/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":2157,"closed_issues":10,"state":"open","created_at":"2014-05-03T18:58:28Z","updated_at":"2025-11-07T08:33:50Z","due_on":null,"closed_at":null},"comments":12,"created_at":"2023-11-12T10:20:36Z","updated_at":"2025-06-30T07:36:35Z","closed_at":null,"author_association":"MEMBER","type":{"id":1092406,"node_id":"IT_kwDOAIt-yc4AEKs2","name":"Feature","description":"A request, idea, or new functionality","color":"blue","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-10-08T09:10:05Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":16157746,"node_id":"MDEwOlJlcG9zaXRvcnkxNjE1Nzc0Ng==","name":"efcore","full_name":"dotnet/efcore","private":false,"owner":{"login":"dotnet","id":9141961,"node_id":"MDEyOk9yZ2FuaXphdGlvbjkxNDE5NjE=","avatar_url":"https://avatars.githubusercontent.com/u/9141961?v=4","gravatar_id":"","url":"https://api.github.com/users/dotnet","html_url":"https://github.com/dotnet","followers_url":"https://api.github.com/users/dotnet/followers","following_url":"https://api.github.com/users/dotnet/following{/other_user}","gists_url":"https://api.github.com/users/dotnet/gists{/gist_id}","starred_url":"https://api.github.com/users/dotnet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dotnet/subscriptions","organizations_url":"https://api.github.com/users/dotnet/orgs","repos_url":"https://api.github.com/users/dotnet/repos","events_url":"https://api.github.com/users/dotnet/events{/privacy}","received_events_url":"https://api.github.com/users/dotnet/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/dotnet/efcore","description":"EF Core is a modern object-database mapper for .NET. It supports LINQ queries, change tracking, updates, and schema migrations.","fork":false,"url":"https://api.github.com/repos/dotnet/efcore","forks_url":"https://api.github.com/repos/dotnet/efcore/forks","keys_url":"https://api.github.com/repos/dotnet/efcore/keys{/key_id}","collaborators_url":"https://api.github.com/repos/dotnet/efcore/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/dotnet/efcore/teams","hooks_url":"https://api.github.com/repos/dotnet/efcore/hooks","issue_events_url":"https://api.github.com/repos/dotnet/efcore/issues/events{/number}","events_url":"https://api.github.com/repos/dotnet/efcore/events","assignees_url":"https://api.github.com/repos/dotnet/efcore/assignees{/user}","branches_url":"https://api.github.com/repos/dotnet/efcore/branches{/branch}","tags_url":"https://api.github.com/repos/dotnet/efcore/tags","blobs_url":"https://api.github.com/repos/dotnet/efcore/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/dotnet/efcore/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/dotnet/efcore/git/refs{/sha}","trees_url":"https://api.github.com/repos/dotnet/efcore/git/trees{/sha}","statuses_url":"https://api.github.com/repos/dotnet/efcore/statuses/{sha}","languages_url":"https://api.github.com/repos/dotnet/efcore/languages","stargazers_url":"https://api.github.com/repos/dotnet/efcore/stargazers","contributors_url":"https://api.github.com/repos/dotnet/efcore/contributors","subscribers_url":"https://api.github.com/repos/dotnet/efcore/subscribers","subscription_url":"https://api.github.com/repos/dotnet/efcore/subscription","commits_url":"https://api.github.com/repos/dotnet/efcore/commits{/sha}","git_commits_url":"https://api.github.com/repos/dotnet/efcore/git/commits{/sha}","comments_url":"https://api.github.com/repos/dotnet/efcore/comments{/number}","issue_comment_url":"https://api.github.com/repos/dotnet/efcore/issues/comments{/number}","contents_url":"https://api.github.com/repos/dotnet/efcore/contents/{+path}","compare_url":"https://api.github.com/repos/dotnet/efcore/compare/{base}...{head}","merges_url":"https://api.github.com/repos/dotnet/efcore/merges","archive_url":"https://api.github.com/repos/dotnet/efcore/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/dotnet/efcore/downloads","issues_url":"https://api.github.com/repos/dotnet/efcore/issues{/number}","pulls_url":"https://api.github.com/repos/dotnet/efcore/pulls{/number}","milestones_url":"https://api.github.com/repos/dotnet/efcore/milestones{/number}","notifications_url":"https://api.github.com/repos/dotnet/efcore/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/dotnet/efcore/labels{/name}","releases_url":"https://api.github.com/repos/dotnet/efcore/releases{/id}","deployments_url":"https://api.github.com/repos/dotnet/efcore/deployments","created_at":"2014-01-23T00:52:01Z","updated_at":"2025-11-10T14:21:49Z","pushed_at":"2025-11-10T05:59:58Z","git_url":"git://github.com/dotnet/efcore.git","ssh_url":"git@github.com:dotnet/efcore.git","clone_url":"https://github.com/dotnet/efcore.git","svn_url":"https://github.com/dotnet/efcore","homepage":"https://learn.microsoft.com/ef/","size":215987,"stargazers_count":14455,"watchers_count":14455,"language":"C#","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":false,"forks_count":3324,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":2430,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["aspnet-product","c-sharp","database","dotnet-core","dotnet-framework","dotnet-standard","entity-framework","hacktoberfest","orm"],"visibility":"public","forks":3324,"open_issues":2430,"watchers":14455,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"Here's a thought dump on SQL duplication. There's no definite proposal yet below, this requires more thinking; ultimately, this may be more about how we translate GroupBy and handle pending selectors.\r\n\r\n---\r\n\r\nThe following LINQ query (see https://github.com/dotnet/efcore/issues/32234#issuecomment-1806153111 for the full repro):\r\n\r\n```c#\r\n_ = await context.IterationValues\r\n    .Where(r => ids.Contains(r.IterationId))\r\n    .GroupBy(x => x.IterationId)\r\n    .Select(x => new\r\n    {\r\n        x.Key,\r\n        MaxTimestamp = x.Select(x => x.Iteration.Timestamp).Max(),\r\n    })\r\n    .OrderBy(x => x.MaxTimestamp)\r\n    .ToListAsync();\r\n```\r\n\r\n... produces the following SQL:\r\n\r\n```sql\r\nSELECT [i].[IterationId] AS [Key], (\r\n    SELECT MAX([i5].[Timestamp])\r\n    FROM [IterationValues] AS [i4]\r\n    INNER JOIN [Iteration] AS [i5] ON [i4].[IterationId] = [i5].[Id]\r\n    WHERE [i4].[IterationId] IN (\r\n        SELECT [i6].[value]\r\n        FROM OPENJSON(@__ids_0) WITH ([value] int '$') AS [i6]\r\n    ) AND [i].[IterationId] = [i4].[IterationId]) AS [MaxTimestamp]\r\nFROM [IterationValues] AS [i]\r\nWHERE [i].[IterationId] IN (\r\n    SELECT [i0].[value]\r\n    FROM OPENJSON(@__ids_0) WITH ([value] int '$') AS [i0]\r\n)\r\nGROUP BY [i].[IterationId]\r\nORDER BY (\r\n    SELECT MAX([i5].[Timestamp])\r\n    FROM [IterationValues] AS [i4]\r\n    INNER JOIN [Iteration] AS [i5] ON [i4].[IterationId] = [i5].[Id]\r\n    WHERE [i4].[IterationId] IN (\r\n        SELECT [i3].[value]\r\n        FROM OPENJSON(@__ids_0) WITH ([value] int '$') AS [i3]\r\n    ) AND [i].[IterationId] = [i4].[IterationId])\r\n```\r\n\r\nThere is considerable subquery duplication in the above SQL: the ordering and projection contains the exact same subquery, and the OPENJSON subquery contained within it is also duplicate in the WHERE clause. This is quite inefficient, causing the database to evaluate the subquery multiple times.\r\n\r\n* One eager approach here would be to perform a pushdown in translation, when an operator is being applied that would cause duplication. For example, with the above query, when the OrderBy is applied, we'd detect that the lambda references a SelectExpression that's also in the projection, do a pushdown, and then apply the ordering on top of that. This has the disadvantage of being probably too eager: if a further Select is then applied which removes the subquery from the projection, the pushdown is no longer necessary, but we already did it too early. Also, finding out whether the OrderBy references the projection isn't trivial (either an additional visitation on all lambdas just to detect this, or to change the way we translate lambdas, passing them more context).\r\n* Another approach would be to add a phase in post-processing, where we find all SelectExpressions which are referenced multiple times, and extract those out to CTEs; this would add one pass for discovery, and another one to apply the transformation if needed (to optimize this we may gather the discovery information as part of translation and pass it forward to post-processing). There are probably some other CTE-related post-processing needs, so this visitor probably makes sense as a new post-processing step.\r\n    * For the ordering and projection duplication above, a CTE **may** be slightly less great than a simple subquery pushdown (even if perf-wise they **should** be the same). We could detect the possibility to push down instead of introduce a CTE (because the duplication is between the projection and another clause, i.e. ordering), but that may be too much trouble for what its worth.\r\n    * Note that this second approach needs to happen right after translation, before type mapping inference visitation happens - or any other visit which may rewrite the tree. This is because such a visitor may cause the SelectExpression to get duplicated, and we lose the multiple referencing.\r\n\r\nHowever, note that the WHERE clause itself also gets duplicated in the above ordering and projection. The ideal way to rewrite this query is to perform a pushdown right after the WHERE clause, so that the IN operator is only evaluated once. That does point towards approach (1), i.e. detecting that the **projection** contains a complex, potentially expensive expression which is better off being pushed down.\r\n\r\n\r\n","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/32277/reactions","total_count":11,"+1":11,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/32277/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/1807107964","html_url":"https://github.com/dotnet/efcore/issues/32234#issuecomment-1807107964","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/32234","id":1807107964,"node_id":"IC_kwDOAPaMMs5rtkd8","user":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-11-12T12:09:36Z","updated_at":"2023-11-12T12:35:42Z","body":"Note specifically on this bug:\r\n\r\n> As a result, we end up with the other SelectExpression pointing to the original table, but having a column referencing a TableReferenceExpression that points to the new SelectExpression (and through it, to the new table). This is a referential integrity bug.\r\n\r\nThis in itself isn't necessarily a bug; having a column from one select pointing to the table of another select is OK, as long as things are fully immutable (as expression trees where meant to be). The problem here comes from the fact that [table alias uniquification actually mutates the TableReferenceExpression](https://github.com/dotnet/efcore/blob/main/src/EFCore.Relational/Query/SqlExpressions/SelectExpression.Helper.cs#L416); this is what makes the sharing of TableReferenceExpressions across SelectExpressions problematic.\r\n\r\nSo ignoring the more general problem of duplicate subqueries in SQL (split out to #32277), a targeted fix here would either:\r\n1. Duplicate the TableReferenceExpressions when duplicating the SelectExpression in SelectExpression.VisitChildren. Note that there are other places which duplicate SelectExpression (not just VisitChildren), they have the same bug (at least in theory).\r\n2. Make AliasUniquifier not mutate, but rather replace the ColumnExpression. This starts to move us in the direction of immutability, and away from the original design of TableReferenceExpression; it also adds more compile-time processing.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/1807107964/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/1808220939","html_url":"https://github.com/dotnet/efcore/issues/32234#issuecomment-1808220939","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/32234","id":1808220939,"node_id":"IC_kwDOAPaMMs5rx0ML","user":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-11-13T14:01:40Z","updated_at":"2023-11-13T14:01:40Z","body":"Removing servicing-consider as a risk here is likely to be non-trivial and somewhat risky. One targeted workaround for the very specific regression above (with Contains) is to set the SQL Server compatibility level to a low value, which will tricker reverting back to the previous transaction (which has no subquery and therefore doesn't trigger this).","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/1808220939/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":10942158107,"node_id":"UNLE_lADOAPaMMs513f86zwAAAAKMNBUb","url":"https://api.github.com/repos/dotnet/efcore/issues/events/10942158107","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"unlabeled","commit_id":null,"commit_url":null,"created_at":"2023-11-13T14:01:47Z","label":{"name":"Servicing-consider","color":"bfd4f2"},"performed_via_github_app":null},{"id":10984741051,"node_id":"MIE_lADOAPaMMs513f86zwAAAAKOvdi7","url":"https://api.github.com/repos/dotnet/efcore/issues/events/10984741051","actor":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"milestoned","commit_id":null,"commit_url":null,"created_at":"2023-11-16T18:48:28Z","milestone":{"title":"9.0.0"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/1817051963","html_url":"https://github.com/dotnet/efcore/issues/32234#issuecomment-1817051963","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/32234","id":1817051963,"node_id":"IC_kwDOAPaMMs5sTgM7","user":{"login":"tim-stuyckens-materialise","id":134292323,"node_id":"U_kgDOCAEjYw","avatar_url":"https://avatars.githubusercontent.com/u/134292323?v=4","gravatar_id":"","url":"https://api.github.com/users/tim-stuyckens-materialise","html_url":"https://github.com/tim-stuyckens-materialise","followers_url":"https://api.github.com/users/tim-stuyckens-materialise/followers","following_url":"https://api.github.com/users/tim-stuyckens-materialise/following{/other_user}","gists_url":"https://api.github.com/users/tim-stuyckens-materialise/gists{/gist_id}","starred_url":"https://api.github.com/users/tim-stuyckens-materialise/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tim-stuyckens-materialise/subscriptions","organizations_url":"https://api.github.com/users/tim-stuyckens-materialise/orgs","repos_url":"https://api.github.com/users/tim-stuyckens-materialise/repos","events_url":"https://api.github.com/users/tim-stuyckens-materialise/events{/privacy}","received_events_url":"https://api.github.com/users/tim-stuyckens-materialise/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-11-17T20:22:31Z","updated_at":"2023-11-17T20:22:31Z","body":"Hi, \r\nIf I understand the compatibility workaround correctly this will work for MS SQL (similar to what is described at  https://learn.microsoft.com/en-us/ef/core/what-is-new/ef-core-8.0/breaking-changes#mitigations )\r\n\r\nAny suggestion on how this can be mitigated on SQLite or MySQL?\r\nContext: We use SQLite in our integration tests (this ticket was also about SQLite).\r\n\r\n","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/1817051963/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"tim-stuyckens-materialise","id":134292323,"node_id":"U_kgDOCAEjYw","avatar_url":"https://avatars.githubusercontent.com/u/134292323?v=4","gravatar_id":"","url":"https://api.github.com/users/tim-stuyckens-materialise","html_url":"https://github.com/tim-stuyckens-materialise","followers_url":"https://api.github.com/users/tim-stuyckens-materialise/followers","following_url":"https://api.github.com/users/tim-stuyckens-materialise/following{/other_user}","gists_url":"https://api.github.com/users/tim-stuyckens-materialise/gists{/gist_id}","starred_url":"https://api.github.com/users/tim-stuyckens-materialise/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tim-stuyckens-materialise/subscriptions","organizations_url":"https://api.github.com/users/tim-stuyckens-materialise/orgs","repos_url":"https://api.github.com/users/tim-stuyckens-materialise/repos","events_url":"https://api.github.com/users/tim-stuyckens-materialise/events{/privacy}","received_events_url":"https://api.github.com/users/tim-stuyckens-materialise/received_events","type":"User","user_view_type":"public","site_admin":false}},{"actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-11-18T22:19:16Z","updated_at":"2023-11-18T22:19:16Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/dotnet/efcore/issues/32347","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/32347/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/32347/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/32347/events","html_url":"https://github.com/dotnet/efcore/issues/32347","id":2000598758,"node_id":"I_kwDOAPaMMs53Prbm","number":32347,"title":"Invalid SQL generated for grouped query followed by `OrderBy` in SQLite and SQL Server","user":{"login":"GeorgDangl","id":10274404,"node_id":"MDQ6VXNlcjEwMjc0NDA0","avatar_url":"https://avatars.githubusercontent.com/u/10274404?v=4","gravatar_id":"","url":"https://api.github.com/users/GeorgDangl","html_url":"https://github.com/GeorgDangl","followers_url":"https://api.github.com/users/GeorgDangl/followers","following_url":"https://api.github.com/users/GeorgDangl/following{/other_user}","gists_url":"https://api.github.com/users/GeorgDangl/gists{/gist_id}","starred_url":"https://api.github.com/users/GeorgDangl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/GeorgDangl/subscriptions","organizations_url":"https://api.github.com/users/GeorgDangl/orgs","repos_url":"https://api.github.com/users/GeorgDangl/repos","events_url":"https://api.github.com/users/GeorgDangl/events{/privacy}","received_events_url":"https://api.github.com/users/GeorgDangl/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2023-11-18T22:11:48Z","updated_at":"2025-06-16T08:54:55Z","closed_at":"2023-11-30T13:25:19Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":16157746,"node_id":"MDEwOlJlcG9zaXRvcnkxNjE1Nzc0Ng==","name":"efcore","full_name":"dotnet/efcore","private":false,"owner":{"login":"dotnet","id":9141961,"node_id":"MDEyOk9yZ2FuaXphdGlvbjkxNDE5NjE=","avatar_url":"https://avatars.githubusercontent.com/u/9141961?v=4","gravatar_id":"","url":"https://api.github.com/users/dotnet","html_url":"https://github.com/dotnet","followers_url":"https://api.github.com/users/dotnet/followers","following_url":"https://api.github.com/users/dotnet/following{/other_user}","gists_url":"https://api.github.com/users/dotnet/gists{/gist_id}","starred_url":"https://api.github.com/users/dotnet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dotnet/subscriptions","organizations_url":"https://api.github.com/users/dotnet/orgs","repos_url":"https://api.github.com/users/dotnet/repos","events_url":"https://api.github.com/users/dotnet/events{/privacy}","received_events_url":"https://api.github.com/users/dotnet/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/dotnet/efcore","description":"EF Core is a modern object-database mapper for .NET. It supports LINQ queries, change tracking, updates, and schema migrations.","fork":false,"url":"https://api.github.com/repos/dotnet/efcore","forks_url":"https://api.github.com/repos/dotnet/efcore/forks","keys_url":"https://api.github.com/repos/dotnet/efcore/keys{/key_id}","collaborators_url":"https://api.github.com/repos/dotnet/efcore/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/dotnet/efcore/teams","hooks_url":"https://api.github.com/repos/dotnet/efcore/hooks","issue_events_url":"https://api.github.com/repos/dotnet/efcore/issues/events{/number}","events_url":"https://api.github.com/repos/dotnet/efcore/events","assignees_url":"https://api.github.com/repos/dotnet/efcore/assignees{/user}","branches_url":"https://api.github.com/repos/dotnet/efcore/branches{/branch}","tags_url":"https://api.github.com/repos/dotnet/efcore/tags","blobs_url":"https://api.github.com/repos/dotnet/efcore/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/dotnet/efcore/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/dotnet/efcore/git/refs{/sha}","trees_url":"https://api.github.com/repos/dotnet/efcore/git/trees{/sha}","statuses_url":"https://api.github.com/repos/dotnet/efcore/statuses/{sha}","languages_url":"https://api.github.com/repos/dotnet/efcore/languages","stargazers_url":"https://api.github.com/repos/dotnet/efcore/stargazers","contributors_url":"https://api.github.com/repos/dotnet/efcore/contributors","subscribers_url":"https://api.github.com/repos/dotnet/efcore/subscribers","subscription_url":"https://api.github.com/repos/dotnet/efcore/subscription","commits_url":"https://api.github.com/repos/dotnet/efcore/commits{/sha}","git_commits_url":"https://api.github.com/repos/dotnet/efcore/git/commits{/sha}","comments_url":"https://api.github.com/repos/dotnet/efcore/comments{/number}","issue_comment_url":"https://api.github.com/repos/dotnet/efcore/issues/comments{/number}","contents_url":"https://api.github.com/repos/dotnet/efcore/contents/{+path}","compare_url":"https://api.github.com/repos/dotnet/efcore/compare/{base}...{head}","merges_url":"https://api.github.com/repos/dotnet/efcore/merges","archive_url":"https://api.github.com/repos/dotnet/efcore/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/dotnet/efcore/downloads","issues_url":"https://api.github.com/repos/dotnet/efcore/issues{/number}","pulls_url":"https://api.github.com/repos/dotnet/efcore/pulls{/number}","milestones_url":"https://api.github.com/repos/dotnet/efcore/milestones{/number}","notifications_url":"https://api.github.com/repos/dotnet/efcore/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/dotnet/efcore/labels{/name}","releases_url":"https://api.github.com/repos/dotnet/efcore/releases{/id}","deployments_url":"https://api.github.com/repos/dotnet/efcore/deployments","created_at":"2014-01-23T00:52:01Z","updated_at":"2025-11-10T14:21:49Z","pushed_at":"2025-11-10T05:59:58Z","git_url":"git://github.com/dotnet/efcore.git","ssh_url":"git@github.com:dotnet/efcore.git","clone_url":"https://github.com/dotnet/efcore.git","svn_url":"https://github.com/dotnet/efcore","homepage":"https://learn.microsoft.com/ef/","size":215987,"stargazers_count":14455,"watchers_count":14455,"language":"C#","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":false,"forks_count":3324,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":2430,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["aspnet-product","c-sharp","database","dotnet-core","dotnet-framework","dotnet-standard","entity-framework","hacktoberfest","orm"],"visibility":"public","forks":3324,"open_issues":2430,"watchers":14455,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"We've had another integration test failing that worked before in EF Core 7. In SQLite, we're getting an error for a missing column `SQLite Error 1: 'no such column: p2.value'`, whereas SQL Server reports `The multi-part identifier \"p2.value\" could not be bound.`. I've put the full exception messages for both databases further down in code blocks.\r\n\r\nFor SQL Server, we can reproduce it both on Windows via LocalDB and on Linux via SQL Server in Docker (both DB and the EF Core process running on Linux), SQLite was only tested locally in Windows.\r\n\r\n### Include your code\r\n\r\nBelow, I've attached the full code required for reproduction, both in SQLite and SQL Server. I've been running with .NET 8 and EF Core 8.0.0. I've verified that the exact same code runs in .NET 7 with EF Core 7.0.0.\r\n\r\n```csproj\r\n<Project Sdk=\"Microsoft.NET.Sdk\">\r\n  <PropertyGroup>\r\n    <OutputType>Exe</OutputType>\r\n    <TargetFramework>net8.0</TargetFramework>\r\n    <ImplicitUsings>enable</ImplicitUsings>\r\n    <Nullable>enable</Nullable>\r\n  </PropertyGroup>\r\n  <ItemGroup>\r\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.Sqlite\" Version=\"8.0.0\" />\r\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.SqlServer\" Version=\"8.0.0\" />\r\n  </ItemGroup>\r\n</Project>\r\n```\r\n\r\n```csharp\r\nusing Microsoft.EntityFrameworkCore;\r\nusing Microsoft.Extensions.DependencyInjection;\r\n\r\nnamespace EfCoreTest\r\n{\r\n    internal class Program\r\n    {\r\n        private static async Task Main(string[] args)\r\n        {\r\n            Console.WriteLine(\"Checking SQLite\");\r\n            await SetupAndReproErrorAsync(options => options.UseSqlite(\"Data Source=data.db\"));\r\n            Console.WriteLine(\"Checking SQL Server\");\r\n            await SetupAndReproErrorAsync(options => options.UseSqlServer(\"Server=(localdb)\\\\MSSQLLocalDB;Database=EfCoreRepro;Trusted_Connection=True;MultipleActiveResultSets=true\"));\r\n        }\r\n\r\n        private static async Task SetupAndReproErrorAsync(Action<DbContextOptionsBuilder> setup)\r\n        {\r\n            var serviceCollection = new ServiceCollection();\r\n            serviceCollection.AddDbContext<ReproDbContext>(setup);\r\n            var services = serviceCollection.BuildServiceProvider();\r\n\r\n            // Create a database\r\n            using (var scope = services.CreateScope())\r\n            {\r\n                var dbContext = scope.ServiceProvider.GetRequiredService<ReproDbContext>();\r\n                await dbContext.Database.EnsureDeletedAsync();\r\n                await dbContext.Database.EnsureCreatedAsync();\r\n            }\r\n\r\n            // Run the repro that throws the exception\r\n            using (var scope = services.CreateScope())\r\n            {\r\n                var dbContext = scope.ServiceProvider.GetRequiredService<ReproDbContext>();\r\n                try\r\n                {\r\n                    await ReproDatabaseError(dbContext);\r\n                }\r\n                catch (Exception e)\r\n                {\r\n                    Console.WriteLine(e);\r\n                }\r\n            }\r\n        }\r\n\r\n        private static async Task ReproDatabaseError(ReproDbContext context)\r\n        {\r\n            var positionIdsWithoutTotalPrice = new[] { Guid.NewGuid() };\r\n            var projectProductsQuery = from rawData in (from calculationRow in context.CalculationRows\r\n                                                        join calculation in context.Calculations\r\n                                                             on calculationRow.CalculationId equals calculation.Id\r\n                                                        where !positionIdsWithoutTotalPrice.Contains(calculation.Id)\r\n                                                        select new\r\n                                                        {\r\n                                                            calculationRow.MasterProductId,\r\n                                                            calculation.Id,\r\n                                                            calculation.Name\r\n                                                        })\r\n                                       group rawData by rawData.MasterProductId\r\n                                into groups\r\n                                       select new\r\n                                       {\r\n                                           groups.FirstOrDefault().MasterProductId,\r\n                                           groups.FirstOrDefault().Name,\r\n                                       };\r\n\r\n            var canMaterializeLikeThis = await projectProductsQuery.ToListAsync();\r\n            await projectProductsQuery\r\n                    .OrderBy(p => p.Name)\r\n                    .ToListAsync();\r\n        }\r\n    }\r\n\r\n    public class ReproDbContext : DbContext\r\n    {\r\n        public ReproDbContext(DbContextOptions<ReproDbContext> options) : base(options)\r\n        {\r\n        }\r\n\r\n        public DbSet<CalculationRow> CalculationRows { get; set; }\r\n        public DbSet<Calculation> Calculations { get; set; }\r\n    }\r\n\r\n    public class Calculation\r\n    {\r\n        public Guid Id { get; set; }\r\n\r\n        public string Name { get; set; }\r\n\r\n        public List<CalculationRow> Rows { get; set; }\r\n    }\r\n\r\n    public class CalculationRow\r\n    {\r\n        public Guid Id { get; set; }\r\n\r\n        public Guid CalculationId { get; set; }\r\n        public Calculation Calculation { get; set; }\r\n\r\n        public Guid MasterProductId { get; set; }\r\n    }\r\n}\r\n\r\n```\r\n\r\n### Include stack traces\r\n\r\nRunning the code above, I'm getting exceptions both for SQLite and SQL Server. I did not try any other databases.\r\n\r\n**SQLite**\r\n```\r\nChecking SQLite\r\nMicrosoft.Data.Sqlite.SqliteException (0x80004005): SQLite Error 1: 'no such column: p2.value'.\r\n   at Microsoft.Data.Sqlite.SqliteException.ThrowExceptionForRC(Int32 rc, sqlite3 db)\r\n   at Microsoft.Data.Sqlite.SqliteCommand.PrepareAndEnumerateStatements()+MoveNext()\r\n   at Microsoft.Data.Sqlite.SqliteCommand.GetStatements()+MoveNext()\r\n   at Microsoft.Data.Sqlite.SqliteDataReader.NextResult()\r\n   at Microsoft.Data.Sqlite.SqliteCommand.ExecuteReader(CommandBehavior behavior)\r\n   at Microsoft.Data.Sqlite.SqliteCommand.ExecuteReaderAsync(CommandBehavior behavior, CancellationToken cancellationToken)\r\n   at Microsoft.Data.Sqlite.SqliteCommand.ExecuteDbDataReaderAsync(CommandBehavior behavior, CancellationToken cancellationToken)\r\n   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)\r\n   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.InitializeReaderAsync(AsyncEnumerator enumerator, CancellationToken cancellationToken)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()\r\n   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.ToListAsync[TSource](IQueryable`1 source, CancellationToken cancellationToken)\r\n   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.ToListAsync[TSource](IQueryable`1 source, CancellationToken cancellationToken)\r\n   at EfCoreTest.Program.ReproDatabaseError(ReproDbContext context) in C:\\Users\\Georg\\Downloads\\EfCoreTest\\EfCoreTest\\Program.cs:line 67\r\n   at EfCoreTest.Program.SetupAndReproErrorAsync(Action`1 setup) in C:\\Users\\Georg\\Downloads\\EfCoreTest\\EfCoreTest\\Program.cs:line 36\r\n```\r\n\r\n**SQL Server**\r\n\r\n```\r\nChecking SQL Server\r\nMicrosoft.Data.SqlClient.SqlException (0x80131904): The multi-part identifier \"p2.value\" could not be bound.\r\n   at Microsoft.Data.SqlClient.SqlCommand.<>c.<ExecuteDbDataReaderAsync>b__209_0(Task`1 result)\r\n   at System.Threading.Tasks.ContinuationResultTaskFromResultTask`2.InnerInvoke()\r\n   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)\r\n--- End of stack trace from previous location ---\r\n   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)\r\n   at System.Threading.Tasks.Task.ExecuteWithThreadLocal(Task& currentTaskSlot, Thread threadPoolThread)\r\n--- End of stack trace from previous location ---\r\n   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)\r\n   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.InitializeReaderAsync(AsyncEnumerator enumerator, CancellationToken cancellationToken)\r\n   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()\r\n   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.ToListAsync[TSource](IQueryable`1 source, CancellationToken cancellationToken)\r\n   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.ToListAsync[TSource](IQueryable`1 source, CancellationToken cancellationToken)\r\n   at EfCoreTest.Program.ReproDatabaseError(ReproDbContext context) in C:\\Users\\Georg\\Downloads\\EfCoreTest\\EfCoreTest\\Program.cs:line 67\r\n   at EfCoreTest.Program.SetupAndReproErrorAsync(Action`1 setup) in C:\\Users\\Georg\\Downloads\\EfCoreTest\\EfCoreTest\\Program.cs:line 36\r\nClientConnectionId:dc20f370-a18d-4005-968c-094b1c8406fd\r\nError Number:4104,State:1,Class:16\r\n```\r\n\r\n### Include provider and version information\r\n\r\nEF Core version:\r\nDatabase provider: `Microsoft.EntityFrameworkCore.SqlServer` and `Microsoft.EntityFrameworkCore.Sqlite`\r\nTarget framework: `.NET 8`\r\nOperating system: `Windows 10`\r\nIDE: `Visual Studio 2022 17.8.0`\r\n","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/32347/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/32347/timeline","performed_via_github_app":null,"state_reason":"duplicate"}},"event":"cross-referenced"},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/1822382933","html_url":"https://github.com/dotnet/efcore/issues/32234#issuecomment-1822382933","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/32234","id":1822382933,"node_id":"IC_kwDOAPaMMs5sn1tV","user":{"login":"zlepper","id":1499810,"node_id":"MDQ6VXNlcjE0OTk4MTA=","avatar_url":"https://avatars.githubusercontent.com/u/1499810?v=4","gravatar_id":"","url":"https://api.github.com/users/zlepper","html_url":"https://github.com/zlepper","followers_url":"https://api.github.com/users/zlepper/followers","following_url":"https://api.github.com/users/zlepper/following{/other_user}","gists_url":"https://api.github.com/users/zlepper/gists{/gist_id}","starred_url":"https://api.github.com/users/zlepper/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zlepper/subscriptions","organizations_url":"https://api.github.com/users/zlepper/orgs","repos_url":"https://api.github.com/users/zlepper/repos","events_url":"https://api.github.com/users/zlepper/events{/privacy}","received_events_url":"https://api.github.com/users/zlepper/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-11-22T09:16:48Z","updated_at":"2023-11-22T09:16:48Z","body":"This is also hitting us when updating from dotnet 7 til 8. While the compatibility workaround could work for sqlserver, it doesn't exactly help us for sqlite, and is completely blocking is from upgrading to dotnet 8. ","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/1822382933/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"zlepper","id":1499810,"node_id":"MDQ6VXNlcjE0OTk4MTA=","avatar_url":"https://avatars.githubusercontent.com/u/1499810?v=4","gravatar_id":"","url":"https://api.github.com/users/zlepper","html_url":"https://github.com/zlepper","followers_url":"https://api.github.com/users/zlepper/followers","following_url":"https://api.github.com/users/zlepper/following{/other_user}","gists_url":"https://api.github.com/users/zlepper/gists{/gist_id}","starred_url":"https://api.github.com/users/zlepper/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zlepper/subscriptions","organizations_url":"https://api.github.com/users/zlepper/orgs","repos_url":"https://api.github.com/users/zlepper/repos","events_url":"https://api.github.com/users/zlepper/events{/privacy}","received_events_url":"https://api.github.com/users/zlepper/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/1822653638","html_url":"https://github.com/dotnet/efcore/issues/32234#issuecomment-1822653638","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/32234","id":1822653638,"node_id":"IC_kwDOAPaMMs5so3zG","user":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-11-22T12:09:37Z","updated_at":"2023-11-22T12:09:37Z","body":"Everyone, thanks for reporting, I'll look at patching this for 8.0.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/1822653638/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":1,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":11035711236,"node_id":"LE_lADOAPaMMs513f86zwAAAAKRx5cE","url":"https://api.github.com/repos/dotnet/efcore/issues/events/11035711236","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2023-11-22T12:09:54Z","label":{"name":"Servicing-consider","color":"bfd4f2"},"performed_via_github_app":null},{"actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-11-27T07:43:58Z","updated_at":"2023-11-27T07:43:58Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/dotnet/efcore/issues/32412","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/32412/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/32412/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/32412/events","html_url":"https://github.com/dotnet/efcore/pull/32412","id":2011060003,"node_id":"PR_kwDOAPaMMs5gYCPi","number":32412,"title":"Implement EF.Constant","user":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2023-11-26T14:19:16Z","updated_at":"2024-02-23T09:06:31Z","closed_at":"2023-11-27T20:30:33Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":16157746,"node_id":"MDEwOlJlcG9zaXRvcnkxNjE1Nzc0Ng==","name":"efcore","full_name":"dotnet/efcore","private":false,"owner":{"login":"dotnet","id":9141961,"node_id":"MDEyOk9yZ2FuaXphdGlvbjkxNDE5NjE=","avatar_url":"https://avatars.githubusercontent.com/u/9141961?v=4","gravatar_id":"","url":"https://api.github.com/users/dotnet","html_url":"https://github.com/dotnet","followers_url":"https://api.github.com/users/dotnet/followers","following_url":"https://api.github.com/users/dotnet/following{/other_user}","gists_url":"https://api.github.com/users/dotnet/gists{/gist_id}","starred_url":"https://api.github.com/users/dotnet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dotnet/subscriptions","organizations_url":"https://api.github.com/users/dotnet/orgs","repos_url":"https://api.github.com/users/dotnet/repos","events_url":"https://api.github.com/users/dotnet/events{/privacy}","received_events_url":"https://api.github.com/users/dotnet/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/dotnet/efcore","description":"EF Core is a modern object-database mapper for .NET. It supports LINQ queries, change tracking, updates, and schema migrations.","fork":false,"url":"https://api.github.com/repos/dotnet/efcore","forks_url":"https://api.github.com/repos/dotnet/efcore/forks","keys_url":"https://api.github.com/repos/dotnet/efcore/keys{/key_id}","collaborators_url":"https://api.github.com/repos/dotnet/efcore/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/dotnet/efcore/teams","hooks_url":"https://api.github.com/repos/dotnet/efcore/hooks","issue_events_url":"https://api.github.com/repos/dotnet/efcore/issues/events{/number}","events_url":"https://api.github.com/repos/dotnet/efcore/events","assignees_url":"https://api.github.com/repos/dotnet/efcore/assignees{/user}","branches_url":"https://api.github.com/repos/dotnet/efcore/branches{/branch}","tags_url":"https://api.github.com/repos/dotnet/efcore/tags","blobs_url":"https://api.github.com/repos/dotnet/efcore/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/dotnet/efcore/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/dotnet/efcore/git/refs{/sha}","trees_url":"https://api.github.com/repos/dotnet/efcore/git/trees{/sha}","statuses_url":"https://api.github.com/repos/dotnet/efcore/statuses/{sha}","languages_url":"https://api.github.com/repos/dotnet/efcore/languages","stargazers_url":"https://api.github.com/repos/dotnet/efcore/stargazers","contributors_url":"https://api.github.com/repos/dotnet/efcore/contributors","subscribers_url":"https://api.github.com/repos/dotnet/efcore/subscribers","subscription_url":"https://api.github.com/repos/dotnet/efcore/subscription","commits_url":"https://api.github.com/repos/dotnet/efcore/commits{/sha}","git_commits_url":"https://api.github.com/repos/dotnet/efcore/git/commits{/sha}","comments_url":"https://api.github.com/repos/dotnet/efcore/comments{/number}","issue_comment_url":"https://api.github.com/repos/dotnet/efcore/issues/comments{/number}","contents_url":"https://api.github.com/repos/dotnet/efcore/contents/{+path}","compare_url":"https://api.github.com/repos/dotnet/efcore/compare/{base}...{head}","merges_url":"https://api.github.com/repos/dotnet/efcore/merges","archive_url":"https://api.github.com/repos/dotnet/efcore/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/dotnet/efcore/downloads","issues_url":"https://api.github.com/repos/dotnet/efcore/issues{/number}","pulls_url":"https://api.github.com/repos/dotnet/efcore/pulls{/number}","milestones_url":"https://api.github.com/repos/dotnet/efcore/milestones{/number}","notifications_url":"https://api.github.com/repos/dotnet/efcore/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/dotnet/efcore/labels{/name}","releases_url":"https://api.github.com/repos/dotnet/efcore/releases{/id}","deployments_url":"https://api.github.com/repos/dotnet/efcore/deployments","created_at":"2014-01-23T00:52:01Z","updated_at":"2025-11-10T14:21:49Z","pushed_at":"2025-11-10T05:59:58Z","git_url":"git://github.com/dotnet/efcore.git","ssh_url":"git@github.com:dotnet/efcore.git","clone_url":"https://github.com/dotnet/efcore.git","svn_url":"https://github.com/dotnet/efcore","homepage":"https://learn.microsoft.com/ef/","size":215987,"stargazers_count":14455,"watchers_count":14455,"language":"C#","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":false,"forks_count":3324,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":2430,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["aspnet-product","c-sharp","database","dotnet-core","dotnet-framework","dotnet-standard","entity-framework","hacktoberfest","orm"],"visibility":"public","forks":3324,"open_issues":2430,"watchers":14455,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/dotnet/efcore/pulls/32412","html_url":"https://github.com/dotnet/efcore/pull/32412","diff_url":"https://github.com/dotnet/efcore/pull/32412.diff","patch_url":"https://github.com/dotnet/efcore/pull/32412.patch","merged_at":"2023-11-27T20:30:33Z"},"body":"Closes #31552\r\n","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/32412/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/32412/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-11-29T15:55:51Z","updated_at":"2023-11-29T15:55:51Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/dotnet/efcore/issues/32455","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/32455/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/32455/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/32455/events","html_url":"https://github.com/dotnet/efcore/issues/32455","id":2016906668,"node_id":"I_kwDOAPaMMs54N42s","number":32455,"title":"Alias validation code throws false positive for subquery referenced multiple times in the tree","user":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2023-11-29T15:55:50Z","updated_at":"2025-06-16T08:54:31Z","closed_at":"2023-11-29T16:20:50Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":16157746,"node_id":"MDEwOlJlcG9zaXRvcnkxNjE1Nzc0Ng==","name":"efcore","full_name":"dotnet/efcore","private":false,"owner":{"login":"dotnet","id":9141961,"node_id":"MDEyOk9yZ2FuaXphdGlvbjkxNDE5NjE=","avatar_url":"https://avatars.githubusercontent.com/u/9141961?v=4","gravatar_id":"","url":"https://api.github.com/users/dotnet","html_url":"https://github.com/dotnet","followers_url":"https://api.github.com/users/dotnet/followers","following_url":"https://api.github.com/users/dotnet/following{/other_user}","gists_url":"https://api.github.com/users/dotnet/gists{/gist_id}","starred_url":"https://api.github.com/users/dotnet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dotnet/subscriptions","organizations_url":"https://api.github.com/users/dotnet/orgs","repos_url":"https://api.github.com/users/dotnet/repos","events_url":"https://api.github.com/users/dotnet/events{/privacy}","received_events_url":"https://api.github.com/users/dotnet/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/dotnet/efcore","description":"EF Core is a modern object-database mapper for .NET. It supports LINQ queries, change tracking, updates, and schema migrations.","fork":false,"url":"https://api.github.com/repos/dotnet/efcore","forks_url":"https://api.github.com/repos/dotnet/efcore/forks","keys_url":"https://api.github.com/repos/dotnet/efcore/keys{/key_id}","collaborators_url":"https://api.github.com/repos/dotnet/efcore/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/dotnet/efcore/teams","hooks_url":"https://api.github.com/repos/dotnet/efcore/hooks","issue_events_url":"https://api.github.com/repos/dotnet/efcore/issues/events{/number}","events_url":"https://api.github.com/repos/dotnet/efcore/events","assignees_url":"https://api.github.com/repos/dotnet/efcore/assignees{/user}","branches_url":"https://api.github.com/repos/dotnet/efcore/branches{/branch}","tags_url":"https://api.github.com/repos/dotnet/efcore/tags","blobs_url":"https://api.github.com/repos/dotnet/efcore/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/dotnet/efcore/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/dotnet/efcore/git/refs{/sha}","trees_url":"https://api.github.com/repos/dotnet/efcore/git/trees{/sha}","statuses_url":"https://api.github.com/repos/dotnet/efcore/statuses/{sha}","languages_url":"https://api.github.com/repos/dotnet/efcore/languages","stargazers_url":"https://api.github.com/repos/dotnet/efcore/stargazers","contributors_url":"https://api.github.com/repos/dotnet/efcore/contributors","subscribers_url":"https://api.github.com/repos/dotnet/efcore/subscribers","subscription_url":"https://api.github.com/repos/dotnet/efcore/subscription","commits_url":"https://api.github.com/repos/dotnet/efcore/commits{/sha}","git_commits_url":"https://api.github.com/repos/dotnet/efcore/git/commits{/sha}","comments_url":"https://api.github.com/repos/dotnet/efcore/comments{/number}","issue_comment_url":"https://api.github.com/repos/dotnet/efcore/issues/comments{/number}","contents_url":"https://api.github.com/repos/dotnet/efcore/contents/{+path}","compare_url":"https://api.github.com/repos/dotnet/efcore/compare/{base}...{head}","merges_url":"https://api.github.com/repos/dotnet/efcore/merges","archive_url":"https://api.github.com/repos/dotnet/efcore/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/dotnet/efcore/downloads","issues_url":"https://api.github.com/repos/dotnet/efcore/issues{/number}","pulls_url":"https://api.github.com/repos/dotnet/efcore/pulls{/number}","milestones_url":"https://api.github.com/repos/dotnet/efcore/milestones{/number}","notifications_url":"https://api.github.com/repos/dotnet/efcore/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/dotnet/efcore/labels{/name}","releases_url":"https://api.github.com/repos/dotnet/efcore/releases{/id}","deployments_url":"https://api.github.com/repos/dotnet/efcore/deployments","created_at":"2014-01-23T00:52:01Z","updated_at":"2025-11-10T14:21:49Z","pushed_at":"2025-11-10T05:59:58Z","git_url":"git://github.com/dotnet/efcore.git","ssh_url":"git@github.com:dotnet/efcore.git","clone_url":"https://github.com/dotnet/efcore.git","svn_url":"https://github.com/dotnet/efcore","homepage":"https://learn.microsoft.com/ef/","size":215987,"stargazers_count":14455,"watchers_count":14455,"language":"C#","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":false,"forks_count":3324,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":2430,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["aspnet-product","c-sharp","database","dotnet-core","dotnet-framework","dotnet-standard","entity-framework","hacktoberfest","orm"],"visibility":"public","forks":3324,"open_issues":2430,"watchers":14455,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"The following Northwind query:\r\n\r\n```c#\r\nAssertQuery(\r\n            async,\r\n            ss => ss.Set<OrderDetail>()\r\n                .Where(e => e.OrderID == 8)\r\n                .GroupBy(e => e.Quantity)\r\n                .Select(g => new { g.Key, MaxTimestamp = g.Select(e => e.Order.OrderDate).Max() })\r\n                .OrderBy(x => x.MaxTimestamp));\r\n```\r\n\r\n... triggers a failure in DEBUG only (also in 7.0), from [TableAliasVerifyingExpressionVisitor](https://github.com/dotnet/efcore/blob/main/src/EFCore.Relational/Query/RelationalQueryTranslationPostprocessor.cs#L144). The SQL that would get generated (without the check) is the following:\r\n\r\n```sql\r\nSELECT [o].[Quantity] AS [Key], (\r\n    SELECT MAX([o3].[OrderDate])\r\n    FROM [Order Details] AS [o2]\r\n    INNER JOIN [Orders] AS [o3] ON [o2].[OrderID] = [o3].[OrderID]\r\n    WHERE [o2].[OrderID] = 8 AND [o].[Quantity] = [o2].[Quantity]) AS [MaxTimestamp]\r\nFROM [Order Details] AS [o]\r\nWHERE [o].[OrderID] = 8\r\nGROUP BY [o].[Quantity]\r\nORDER BY (\r\n    SELECT MAX([o3].[OrderDate])\r\n    FROM [Order Details] AS [o2]\r\n    INNER JOIN [Orders] AS [o3] ON [o2].[OrderID] = [o3].[OrderID]\r\n    WHERE [o2].[OrderID] = 8 AND [o].[Quantity] = [o2].[Quantity])\r\n```\r\n\r\nNote that [o1] is missing, which is what triggers the error. The check is generally to detect referential integrity issues, but this seems to be a false positive.\r\n\r\nWhat's happening is that the same SelectExpression instance is referenced from both the ordering and the projection; when we apply the projection after translation, we uniquify the aliases within; this mutates the TableReferenceExpression, but since that's shared, the change occurs both in the ordering and in the projection.\r\n\r\nAFAICT this has no actual effect except for the aliases not being properly ordered in the final SQL (but it blocks proper testing on #32234). Ideally, if we get to a place where ColumnExpressions reference TableExpressionBases directly (no more TableReferenceExpression) and everything is properly immutable, this would go away on its own.\r\n\r\nDiscovered as part of the work on #32234 - we generally have problems with SelectExpression which are referenced multiple times.","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/32455/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/32455/timeline","performed_via_github_app":null,"state_reason":"duplicate"}},"event":"cross-referenced"},{"id":11098813058,"node_id":"REFE_lADOAPaMMs513f86zwAAAAKVinKC","url":"https://api.github.com/repos/dotnet/efcore/issues/events/11098813058","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"b8156da882b67a6f28af0160309edbb0980eb524","commit_url":"https://api.github.com/repos/roji/efcore/commits/b8156da882b67a6f28af0160309edbb0980eb524","created_at":"2023-11-29T16:31:23Z","performed_via_github_app":null},{"actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-11-29T16:37:45Z","updated_at":"2023-11-29T16:37:45Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/dotnet/efcore/issues/32456","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/32456/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/32456/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/32456/events","html_url":"https://github.com/dotnet/efcore/pull/32456","id":2016995690,"node_id":"PR_kwDOAPaMMs5gsPPp","number":32456,"title":"Fix expression cloning when table changes in SelectExpression.VisitChildren","user":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2023-11-29T16:37:44Z","updated_at":"2023-12-03T10:32:56Z","closed_at":"2023-12-03T10:32:55Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":16157746,"node_id":"MDEwOlJlcG9zaXRvcnkxNjE1Nzc0Ng==","name":"efcore","full_name":"dotnet/efcore","private":false,"owner":{"login":"dotnet","id":9141961,"node_id":"MDEyOk9yZ2FuaXphdGlvbjkxNDE5NjE=","avatar_url":"https://avatars.githubusercontent.com/u/9141961?v=4","gravatar_id":"","url":"https://api.github.com/users/dotnet","html_url":"https://github.com/dotnet","followers_url":"https://api.github.com/users/dotnet/followers","following_url":"https://api.github.com/users/dotnet/following{/other_user}","gists_url":"https://api.github.com/users/dotnet/gists{/gist_id}","starred_url":"https://api.github.com/users/dotnet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dotnet/subscriptions","organizations_url":"https://api.github.com/users/dotnet/orgs","repos_url":"https://api.github.com/users/dotnet/repos","events_url":"https://api.github.com/users/dotnet/events{/privacy}","received_events_url":"https://api.github.com/users/dotnet/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/dotnet/efcore","description":"EF Core is a modern object-database mapper for .NET. It supports LINQ queries, change tracking, updates, and schema migrations.","fork":false,"url":"https://api.github.com/repos/dotnet/efcore","forks_url":"https://api.github.com/repos/dotnet/efcore/forks","keys_url":"https://api.github.com/repos/dotnet/efcore/keys{/key_id}","collaborators_url":"https://api.github.com/repos/dotnet/efcore/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/dotnet/efcore/teams","hooks_url":"https://api.github.com/repos/dotnet/efcore/hooks","issue_events_url":"https://api.github.com/repos/dotnet/efcore/issues/events{/number}","events_url":"https://api.github.com/repos/dotnet/efcore/events","assignees_url":"https://api.github.com/repos/dotnet/efcore/assignees{/user}","branches_url":"https://api.github.com/repos/dotnet/efcore/branches{/branch}","tags_url":"https://api.github.com/repos/dotnet/efcore/tags","blobs_url":"https://api.github.com/repos/dotnet/efcore/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/dotnet/efcore/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/dotnet/efcore/git/refs{/sha}","trees_url":"https://api.github.com/repos/dotnet/efcore/git/trees{/sha}","statuses_url":"https://api.github.com/repos/dotnet/efcore/statuses/{sha}","languages_url":"https://api.github.com/repos/dotnet/efcore/languages","stargazers_url":"https://api.github.com/repos/dotnet/efcore/stargazers","contributors_url":"https://api.github.com/repos/dotnet/efcore/contributors","subscribers_url":"https://api.github.com/repos/dotnet/efcore/subscribers","subscription_url":"https://api.github.com/repos/dotnet/efcore/subscription","commits_url":"https://api.github.com/repos/dotnet/efcore/commits{/sha}","git_commits_url":"https://api.github.com/repos/dotnet/efcore/git/commits{/sha}","comments_url":"https://api.github.com/repos/dotnet/efcore/comments{/number}","issue_comment_url":"https://api.github.com/repos/dotnet/efcore/issues/comments{/number}","contents_url":"https://api.github.com/repos/dotnet/efcore/contents/{+path}","compare_url":"https://api.github.com/repos/dotnet/efcore/compare/{base}...{head}","merges_url":"https://api.github.com/repos/dotnet/efcore/merges","archive_url":"https://api.github.com/repos/dotnet/efcore/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/dotnet/efcore/downloads","issues_url":"https://api.github.com/repos/dotnet/efcore/issues{/number}","pulls_url":"https://api.github.com/repos/dotnet/efcore/pulls{/number}","milestones_url":"https://api.github.com/repos/dotnet/efcore/milestones{/number}","notifications_url":"https://api.github.com/repos/dotnet/efcore/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/dotnet/efcore/labels{/name}","releases_url":"https://api.github.com/repos/dotnet/efcore/releases{/id}","deployments_url":"https://api.github.com/repos/dotnet/efcore/deployments","created_at":"2014-01-23T00:52:01Z","updated_at":"2025-11-10T14:21:49Z","pushed_at":"2025-11-10T05:59:58Z","git_url":"git://github.com/dotnet/efcore.git","ssh_url":"git@github.com:dotnet/efcore.git","clone_url":"https://github.com/dotnet/efcore.git","svn_url":"https://github.com/dotnet/efcore","homepage":"https://learn.microsoft.com/ef/","size":215987,"stargazers_count":14455,"watchers_count":14455,"language":"C#","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":false,"forks_count":3324,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":2430,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["aspnet-product","c-sharp","database","dotnet-core","dotnet-framework","dotnet-standard","entity-framework","hacktoberfest","orm"],"visibility":"public","forks":3324,"open_issues":2430,"watchers":14455,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/dotnet/efcore/pulls/32456","html_url":"https://github.com/dotnet/efcore/pull/32456","diff_url":"https://github.com/dotnet/efcore/pull/32456.diff","patch_url":"https://github.com/dotnet/efcore/pull/32456.patch","merged_at":"2023-12-03T10:32:55Z"},"body":"When a table is changed in SelectExpression.VisitChildren() (on an immutable SelectExpression), visit the entire SelectExpression and replace ColumnExpressions to have them properly point to the new SelectExpression, without sharing TableReferenceExpression. This allows us to mutate the TableReferenceExpression later (i.e. alias uniquification) without affecting two queries in the tree.\r\n\r\nThere's a bit of added complexity here to prevent infinite recursion where the new ColumnTableReferenceUpdater that we call also uses SelectExpression.VisitChildren, but we don't want/need that to go into ColumnTableReferenceUpdater again.\r\n\r\nThis should be a temporary fix; I believe we should revisit the general design around tables, ColumnExpression and TableReferenceExpression.\r\n\r\nFinally, this isn't a super trivial fix - would appreciate a deep review (especially as we may consider this for patching).\r\n\r\nFixes #32234\r\n\r\nNote that I ran into #26104 as well while testing this, which is a debug-only issue that's very related to this one (same SelectExpression instance referenced from multiple parts of the query).","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/32456/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/32456/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"id":11099097144,"node_id":"REFE_lADOAPaMMs513f86zwAAAAKVjsg4","url":"https://api.github.com/repos/dotnet/efcore/issues/events/11099097144","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"2ac3090b2c53307ca33b6a8bb1cb0ab6bf07c342","commit_url":"https://api.github.com/repos/roji/efcore/commits/2ac3090b2c53307ca33b6a8bb1cb0ab6bf07c342","created_at":"2023-11-29T16:53:46Z","performed_via_github_app":null},{"id":11099355481,"node_id":"REFE_lADOAPaMMs513f86zwAAAAKVkrlZ","url":"https://api.github.com/repos/dotnet/efcore/issues/events/11099355481","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"cee4b79bf0b64b0097397474843c9ec6a18f4101","commit_url":"https://api.github.com/repos/roji/efcore/commits/cee4b79bf0b64b0097397474843c9ec6a18f4101","created_at":"2023-11-29T17:17:00Z","performed_via_github_app":null}]