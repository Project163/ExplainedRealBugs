{"url":"https://api.github.com/repos/dotnet/efcore/issues/28905","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/28905/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/28905/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/28905/events","html_url":"https://github.com/dotnet/efcore/issues/28905","id":1352816336,"node_id":"I_kwDOAPaMMs5QolbQ","number":28905,"title":"Incorrect simple join table determination in reverse engineering leads to incorrect code generation","user":{"login":"akarboush","id":40485241,"node_id":"MDQ6VXNlcjQwNDg1MjQx","avatar_url":"https://avatars.githubusercontent.com/u/40485241?v=4","gravatar_id":"","url":"https://api.github.com/users/akarboush","html_url":"https://github.com/akarboush","followers_url":"https://api.github.com/users/akarboush/followers","following_url":"https://api.github.com/users/akarboush/following{/other_user}","gists_url":"https://api.github.com/users/akarboush/gists{/gist_id}","starred_url":"https://api.github.com/users/akarboush/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/akarboush/subscriptions","organizations_url":"https://api.github.com/users/akarboush/orgs","repos_url":"https://api.github.com/users/akarboush/repos","events_url":"https://api.github.com/users/akarboush/events{/privacy}","received_events_url":"https://api.github.com/users/akarboush/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1017558838,"node_id":"MDU6TGFiZWwxMDE3NTU4ODM4","url":"https://api.github.com/repos/dotnet/efcore/labels/Servicing-approved","name":"Servicing-approved","color":"048708","default":false,"description":""},{"id":1900977179,"node_id":"MDU6TGFiZWwxOTAwOTc3MTc5","url":"https://api.github.com/repos/dotnet/efcore/labels/area-scaffolding","name":"area-scaffolding","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/186","html_url":"https://github.com/dotnet/efcore/milestone/186","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/186/labels","id":10201144,"node_id":"MI_kwDOAPaMMs4Am6g4","number":186,"title":"8.0.2","description":null,"creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":44,"state":"closed","created_at":"2023-11-17T09:03:59Z","updated_at":"2024-05-05T12:55:36Z","due_on":null,"closed_at":"2024-04-09T08:40:11Z"},"comments":5,"created_at":"2022-08-26T23:30:58Z","updated_at":"2025-06-15T18:52:21Z","closed_at":"2023-12-16T11:03:30Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"The current simple join table determination in version 6 and 7 does not take into account the join table with referencing forgein key(s), resulting in incorrectly generated code.\r\n\r\n**6.***\r\nhttps://github.com/dotnet/efcore/blob/7d0a8855214bd888b64f3acbe6363a094a1ec3de/src/EFCore.Design/Scaffolding/Internal/CSharpDbContextGenerator.cs#L1148\r\n\r\n**7.***\r\nhttps://github.com/dotnet/efcore/blob/376bd8b27a46558fc7b4e9dcc1bb8cb0b8f11c65/src/EFCore.Design/Extensions/ScaffoldingModelExtensions.cs#L22\r\n\r\nMicrosoft sql db script\r\n\r\n``` sql\r\nCREATE TABLE Blogs (Id int IDENTITY CONSTRAINT [PK_Blogs] PRIMARY KEY,) \r\ngo \r\n\r\nCREATE TABLE Posts (Id int IDENTITY CONSTRAINT [PK_Posts] PRIMARY KEY,) \r\ngo \r\n\r\nCREATE TABLE BlogPosts (\r\n  BlogId int NOT NULL CONSTRAINT [FK_BlogPosts_Blogs] REFERENCES Blogs ON DELETE CASCADE,\r\n  PostId int NOT NULL CONSTRAINT [FK_BlogPosts_Posts] REFERENCES Posts ON DELETE CASCADE,\r\n  CONSTRAINT [PK_BlogPosts ] PRIMARY KEY (BlogId, PostId)\r\n)\r\ngo \r\n\r\nCREATE TABLE LinkToBlogPosts (\r\n  LinkId1 int NOT NULL,\r\n  LinkId2 int NOT NULL,\r\n  CONSTRAINT [PK_LinkToBlogPosts] PRIMARY KEY (LinkId1, LinkId2),\r\n  CONSTRAINT [FK_LinkToBlogPosts_BlogPosts] FOREIGN KEY (LinkId1, LinkId2) REFERENCES BlogPosts\r\n) go\r\n ```\r\n\r\ncode generated\r\n``` csharp\r\npublic partial class Blog\r\n{\r\n/* ctor */\r\n    public int Id { get; set; }\r\n\r\n    public virtual ICollection<Post> Posts { get; set; }\r\n}\r\n\r\n public partial class Post\r\n{\r\n/* ctor */\r\n    public int Id { get; set; }\r\n\r\n    public virtual ICollection<Blog> Blogs { get; set; }\r\n}\r\n\r\n\r\n public partial class BlogPost\r\n{\r\n    public int BlogId { get; set; }\r\n    public int PostId { get; set; }\r\n\r\n    public virtual LinkToBlogPost LinkToBlogPost { get; set; } = null!;\r\n}\r\n\r\n public partial class LinkToBlogPost\r\n  {\r\n      public int LinkId1 { get; set; }\r\n      public int LinkId2 { get; set; }\r\n  \r\n      public virtual BlogPost Link { get; set; } = null!;\r\n  }\r\n\r\n\r\n\r\nprotected override void OnModelCreating(ModelBuilder modelBuilder)\r\n        {\r\n            modelBuilder.Entity<Blog>(entity =>\r\n            {\r\n                entity.HasMany(d => d.Posts)\r\n                    .WithMany(p => p.Blogs)\r\n                    .UsingEntity<Dictionary<string, object>>(\r\n                        \"BlogPost\",\r\n                        l => l.HasOne<Post>().WithMany().HasForeignKey(\"PostId\").HasConstraintName(\"FK_BlogPosts_Posts\"),\r\n                        r => r.HasOne<Blog>().WithMany().HasForeignKey(\"BlogId\").HasConstraintName(\"FK_BlogPosts_Blogs\"),\r\n                        j =>\r\n                        {\r\n                            j.HasKey(\"BlogId\", \"PostId\").HasName(\"PK_BlogPosts \");\r\n\r\n                            j.ToTable(\"BlogPosts\");\r\n                        });\r\n            });\r\n\r\n            modelBuilder.Entity<BlogPost>(entity =>\r\n            {\r\n                entity.HasKey(e => new { e.BlogId, e.PostId })\r\n                    .HasName(\"PK_BlogPosts \");\r\n\r\n// error here\r\n                entity.HasOne() \r\n                    .WithMany()\r\n                    .HasForeignKey(d => d.BlogId)\r\n                    .HasConstraintName(\"FK_BlogPosts_Blogs\");\r\n\r\n// error here\r\n                entity.HasOne() \r\n                    .WithMany()\r\n                    .HasForeignKey(d => d.PostId)\r\n                    .HasConstraintName(\"FK_BlogPosts_Posts\");\r\n            });\r\n\r\n            modelBuilder.Entity<LinkToBlogPost>(entity =>\r\n            {\r\n                entity.HasKey(e => new { e.LinkId1, e.LinkId2 });\r\n\r\n                entity.HasOne(d => d.Link)\r\n                    .WithOne(p => p.LinkToBlogPost)\r\n                    .HasForeignKey<LinkToBlogPost>(d => new { d.LinkId1, d.LinkId2 })\r\n                    .OnDelete(DeleteBehavior.ClientSetNull)\r\n                    .HasConstraintName(\"FK_LinkToBlogPosts_BlogPosts\");\r\n            });\r\n\r\n            OnModelCreatingPartial(modelBuilder);\r\n        }\r\n```\r\nAs you can see\r\n* A skip navigation for Blog and Post is created despite the BlogPost entity.\r\n* The Blog and Post navigation properties are missing from the BlogPost entity and therefore the navigation expression in the Builder module for the BlogPost is also missing.\r\n\r\nI would like to submit a PR fixing the problem as I have already experimented with it locally and fixed it adding a referencing foreign keys check. \r\nIs there anything I should consider before submitting??","closed_by":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/28905/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/28905/timeline","performed_via_github_app":null,"state_reason":"completed"}