{"url":"https://api.github.com/repos/dotnet/efcore/issues/29379","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/29379/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/29379/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/29379/events","html_url":"https://github.com/dotnet/efcore/issues/29379","id":1411812122,"node_id":"I_kwDOAPaMMs5UJosa","number":29379,"title":" Incorrect Entries Values in DbUpdateException when an error occurs in the SQL MERGE statement during insert","user":{"login":"thumer","id":8818525,"node_id":"MDQ6VXNlcjg4MTg1MjU=","avatar_url":"https://avatars.githubusercontent.com/u/8818525?v=4","gravatar_id":"","url":"https://api.github.com/users/thumer","html_url":"https://github.com/thumer","followers_url":"https://api.github.com/users/thumer/followers","following_url":"https://api.github.com/users/thumer/following{/other_user}","gists_url":"https://api.github.com/users/thumer/gists{/gist_id}","starred_url":"https://api.github.com/users/thumer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/thumer/subscriptions","organizations_url":"https://api.github.com/users/thumer/orgs","repos_url":"https://api.github.com/users/thumer/repos","events_url":"https://api.github.com/users/thumer/events{/privacy}","received_events_url":"https://api.github.com/users/thumer/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1900941009,"node_id":"MDU6TGFiZWwxOTAwOTQxMDA5","url":"https://api.github.com/repos/dotnet/efcore/labels/area-save-changes","name":"area-save-changes","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/152","html_url":"https://github.com/dotnet/efcore/milestone/152","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/152/labels","id":8392036,"node_id":"MI_kwDOAPaMMs4AgA1k","number":152,"title":"8.0.0","description":"EF Core 8.0","creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":280,"state":"closed","created_at":"2022-09-07T19:55:36Z","updated_at":"2025-04-07T08:59:46Z","due_on":null,"closed_at":"2023-11-14T14:00:33Z"},"comments":4,"created_at":"2022-10-17T15:45:26Z","updated_at":"2025-06-15T18:54:27Z","closed_at":"2022-11-17T09:52:52Z","author_association":"CONTRIBUTOR","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<details>\r\n  <summary>Entities and DbContext</summary>\r\n\r\n  ```cs\r\npublic class MyDbContext : DbContext\r\n{\r\n    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)\r\n    {\r\n        base.OnConfiguring(optionsBuilder);\r\n        optionsBuilder\r\n            .UseSqlServer(\"Server=localhost;Database=EFCore_UniqueKeyExceptionHandlingIssue_Sample;Integrated Security=true;TrustServerCertificate=True\");\r\n    }\r\n\r\n    protected override void OnModelCreating(ModelBuilder modelBuilder)\r\n    {\r\n        base.OnModelCreating(modelBuilder);\r\n\r\n        modelBuilder.Entity<BookStore>();\r\n        modelBuilder.Entity<Book>(b =>\r\n        {\r\n            b.HasIndex(book => book.Number).IsUnique();\r\n        });\r\n    }\r\n    public DbSet<BookStore> BookStores { get; set; }\r\n    public DbSet<Book> Books { get; set; }\r\n}\r\n\r\npublic sealed class BookStore\r\n{\r\n    public int Id { get; set; }\r\n    public string? Name { get; set; }\r\n\r\n    public override string ToString()\r\n     => $\"{nameof(BookStore)}: {Name}\";\r\n}\r\n\r\npublic sealed class Book\r\n{\r\n    public int Id { get; set; }\r\n    public int Number { get; set; }\r\n    public string? Title { get; set; }\r\n    public int? BookStoreId { get; set; }\r\n    public BookStore? BookStore { get; set; }\r\n\r\n    public override string ToString()\r\n        => $\"{nameof(Book)}: #{Number} - {Title}\";\r\n}\r\n  ```\r\n</details>\r\n\r\n<details>\r\n  <summary>Setup</summary>\r\n\r\n  ```cs\r\nawait using (MyDbContext dbContext = new())\r\n{\r\n    await dbContext.Database.EnsureDeletedAsync();\r\n    await dbContext.Database.EnsureCreatedAsync();\r\n}\r\n\r\nawait using (MyDbContext dbContext = new())\r\n{\r\n    Book book = new () { Number = 3, Title = \"Book3\" };\r\n    dbContext.Add(book);\r\n\r\n    await dbContext.SaveChangesAsync();\r\n}\r\n\r\nawait using (MyDbContext dbContext = new())\r\n{\r\n    BookStore store = new() { Name = \"MainBookStore\" };\r\n    dbContext.Add(store);\r\n\r\n    dbContext.AddRange(new List<Book>()\r\n    {\r\n            new Book() { Number = 1, Title = \"Book1\" },\r\n            new Book() { Number = 2, Title = \"Book2\" },\r\n            new Book() { Number = 3, Title = \"Book3\" },\r\n            new Book() { Number = 4, Title = \"Book4\" }\r\n    });\r\n\r\n    try\r\n    {\r\n        await dbContext.SaveChangesAsync();\r\n    }\r\n    catch (DbUpdateException ex) when (ex.InnerException is SqlException sqlException && sqlException.Number == 2601)\r\n    {\r\n        Console.WriteLine($\"SqlException: {sqlException.Message}\");\r\n        Console.WriteLine($\"Duplicates: {string.Join(\", \", ex.Entries.Select(e => e.Entity.ToString()).ToArray())}\");\r\n    }\r\n}\r\n  ```\r\n</details>\r\n\r\n<details>\r\n  <summary>Generated SQL</summary>\r\n\r\n```sql\r\nexec sp_executesql N'SET NOCOUNT ON;\r\nINSERT INTO [BookStores] ([Name])\r\nOUTPUT INSERTED.[Id]\r\nVALUES (@p0);\r\nMERGE [Books] USING (\r\nVALUES (@p1, @p2, @p3, 0),\r\n(@p4, @p5, @p6, 1),\r\n(@p7, @p8, @p9, 2),\r\n(@p10, @p11, @p12, 3)) AS i ([BookStoreId], [Number], [Title], _Position) ON 1=0\r\nWHEN NOT MATCHED THEN\r\nINSERT ([BookStoreId], [Number], [Title])\r\nVALUES (i.[BookStoreId], i.[Number], i.[Title])\r\nOUTPUT INSERTED.[Id], i._Position;\r\n',N'@p0 nvarchar(4000),@p1 int,@p2 int,@p3 nvarchar(4000),@p4 int,@p5 int,@p6 nvarchar(4000),@p7 int,@p8 int,@p9 nvarchar(4000),@p10 int,@p11 int,@p12 nvarchar(4000)',@p0=N'MainBookStore',@p1=NULL,@p2=1,@p3=N'Book1',@p4=NULL,@p5=2,@p6=N'Book2',@p7=NULL,@p8=3,@p9=N'Book3',@p10=NULL,@p11=4,@p12=N'Book4'\r\n```\r\n</details>\r\n\r\nIf you are catching a DbUpdateException, because of a SqlException (UniqueKey violation), the `DbUpdateException.Entries` will be deliver only the first entity, if the insert statement was a SQL MERGE Statement.\r\n\r\n**Output:**\r\n```\r\nSqlException: Cannot insert duplicate key row in object 'dbo.Books' with unique index 'IX_Books_Number'. The duplicate key value is (3).\r\nDuplicates: Book: #1 - Book1\r\n```\r\n\r\nIf you only insert 3 books and the `Books` table is configured with a trigger (-> NO MERGE STATEMENT) - it will work:\r\n\r\n**Correct Output:**\r\n```\r\nSqlException: Cannot insert duplicate key row in object 'dbo.Books' with unique index 'IX_Books_Number'. The duplicate key value is (3).\r\nDuplicates: Book: #3 - Book3\r\n```\r\n\r\nIn our production environment we also had the case that even the wrong entity was delivered. In this case - a BookStore entity instead of the Book entity. However, I could not reproduce this scenario in this example.\r\n\r\n### Include provider and version information\r\n\r\nEF Core version: 7.0 RC1\r\nDatabase provider: Microsoft.EntityFrameworkCore.SqlServer\r\nTarget framework: .NET 6.0 / .NET 7.0\r\nOperating system: Windows 11\r\nIDE: Visual Studio 2022 17.3.6","closed_by":null,"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/29379/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/29379/timeline","performed_via_github_app":null,"state_reason":"completed"}