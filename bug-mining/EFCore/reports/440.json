{"url":"https://api.github.com/repos/dotnet/efcore/issues/33327","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/33327/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/33327/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/33327/events","html_url":"https://github.com/dotnet/efcore/issues/33327","id":2187358266,"node_id":"I_kwDOAPaMMs6CYHA6","number":33327,"title":"The convention invocations have reached the recursion limit.","user":{"login":"RDoser","id":159327382,"node_id":"U_kgDOCX8klg","avatar_url":"https://avatars.githubusercontent.com/u/159327382?v=4","gravatar_id":"","url":"https://api.github.com/users/RDoser","html_url":"https://github.com/RDoser","followers_url":"https://api.github.com/users/RDoser/followers","following_url":"https://api.github.com/users/RDoser/following{/other_user}","gists_url":"https://api.github.com/users/RDoser/gists{/gist_id}","starred_url":"https://api.github.com/users/RDoser/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/RDoser/subscriptions","organizations_url":"https://api.github.com/users/RDoser/orgs","repos_url":"https://api.github.com/users/RDoser/repos","events_url":"https://api.github.com/users/RDoser/events{/privacy}","received_events_url":"https://api.github.com/users/RDoser/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":2416080466,"node_id":"MDU6TGFiZWwyNDE2MDgwNDY2","url":"https://api.github.com/repos/dotnet/efcore/labels/area-conventions","name":"area-conventions","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/180","html_url":"https://github.com/dotnet/efcore/milestone/180","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/180/labels","id":9963267,"node_id":"MI_kwDOAPaMMs4AmAcD","number":180,"title":"9.0.0","description":null,"creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":339,"state":"closed","created_at":"2023-09-25T15:41:58Z","updated_at":"2025-04-01T18:19:15Z","due_on":null,"closed_at":"2024-11-14T11:54:05Z"},"comments":7,"created_at":"2024-03-14T22:15:54Z","updated_at":"2025-06-15T20:00:12Z","closed_at":"2024-03-30T19:01:12Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## File a bug\r\nException thrown at the following:\r\n\r\n```C#\r\n    modelBuilder.Entity<Group>(entity =>\r\n    {\r\n      entity.Property(e => e.GroupID).ValueGeneratedNever();\r\n      entity.Property(e => e.RowVersion)\r\n        .IsRowVersion()\r\n        .IsConcurrencyToken();\r\n\r\n      entity.HasOne(d => d.Antecedent).WithMany(p => p.Descendants).HasConstraintName(\"FK_Group_Antecedant\");\r\n\r\n      entity.HasOne(d => d.FeeTable).WithMany(p => p.Groups).HasConstraintName(\"FK_Groups_FeeTables\");\r\n\r\n      entity.HasOne(d => d.FundOffering).WithMany(p => p.Groups).HasConstraintName(\"FK_Groups_Offerings\");\r\n\r\n      entity.HasOne(d => d.Parent).WithMany(p => p.Children).HasConstraintName(\"FK_Groups_Groups\");\r\n\r\n      entity.HasOne(d => d.RebalancingGroup).WithMany(p => p.Groups).HasConstraintName(\"FK_Groups_RebalancingGroups\");\r\n\r\n      entity.HasMany(left => left.Investments).WithMany(right => right.Groups)\r\n        .UsingEntity(join => join.ToTable(\"GroupInvestments\"));\r\n\r\n      entity.HasMany(left => left.Accounts).WithMany(right => right.Groups)\r\n        .UsingEntity(join => join.ToTable(\"GroupAccounts\"));\r\n    });\r\n```\r\nThe main Group object file is:\r\n\r\n```C#\r\nusing System;\r\nusing System.Collections.Generic;\r\nusing System.Collections.ObjectModel;\r\nusing System.ComponentModel.DataAnnotations;\r\nusing System.ComponentModel.DataAnnotations.Schema;\r\nusing HCAEntities;\r\nusing Microsoft.EntityFrameworkCore;\r\n\r\nnamespace HCAEntities.Models;\r\n\r\npublic partial class Group: EntityBase\r\n{\r\n    [Key]\r\n    private Guid _GroupID;\r\n    public Guid GroupID { \r\n        get => _GroupID; \r\n        set {\r\n            //No notifications on first load from database\r\n            if(_GroupID != value)\r\n            {\r\n                if(IsNotifyEnabled)\r\n                {\r\n                    OnPropertyChanging(nameof(GroupID));\r\n                    OnGroupIDChanging();\r\n                    _GroupID = value;\r\n                    OnPropertyChanged(nameof(GroupID));\r\n                    OnGroupIDChanged();\r\n                }\r\n                else\r\n                    _GroupID = value;\r\n            }\r\n        } \r\n    }\r\n    partial void OnGroupIDChanging();\r\n    partial void OnGroupIDChanged();\r\n\r\n    private Guid _PortfolioID;\r\n    public Guid PortfolioID { \r\n        get => _PortfolioID; \r\n        set {\r\n            //No notifications on first load from database\r\n            if(_PortfolioID != value)\r\n            {\r\n                if(IsNotifyEnabled)\r\n                {\r\n                    OnPropertyChanging(nameof(PortfolioID));\r\n                    OnPortfolioIDChanging();\r\n                    _PortfolioID = value;\r\n                    OnPropertyChanged(nameof(PortfolioID));\r\n                    OnPortfolioIDChanged();\r\n                }\r\n                else\r\n                    _PortfolioID = value;\r\n            }\r\n        } \r\n    }\r\n    partial void OnPortfolioIDChanging();\r\n    partial void OnPortfolioIDChanged();\r\n\r\n    private Guid? _ParentID;\r\n    public Guid? ParentID { \r\n        get => _ParentID; \r\n        set {\r\n            //No notifications on first load from database\r\n            if(_ParentID != value)\r\n            {\r\n                if(IsNotifyEnabled)\r\n                {\r\n                    OnPropertyChanging(nameof(ParentID));\r\n                    OnParentIDChanging();\r\n                    _ParentID = value;\r\n                    OnPropertyChanged(nameof(ParentID));\r\n                    OnParentIDChanged();\r\n                }\r\n                else\r\n                    _ParentID = value;\r\n            }\r\n        } \r\n    }\r\n    partial void OnParentIDChanging();\r\n    partial void OnParentIDChanged();\r\n\r\n    [StringLength(255)]\r\n    private string _Name;\r\n    public string Name { \r\n        get => _Name; \r\n        set {\r\n            //No notifications on first load from database\r\n            if(_Name != value)\r\n            {\r\n                if(IsNotifyEnabled)\r\n                {\r\n                    OnPropertyChanging(nameof(Name));\r\n                    OnNameChanging();\r\n                    _Name = value;\r\n                    OnPropertyChanged(nameof(Name));\r\n                    OnNameChanged();\r\n                }\r\n                else\r\n                    _Name = value;\r\n            }\r\n        } \r\n    }\r\n    partial void OnNameChanging();\r\n    partial void OnNameChanged();\r\n\r\n    [StringLength(50)]\r\n    private string _ShortName;\r\n    public string ShortName { \r\n        get => _ShortName; \r\n        set {\r\n            //No notifications on first load from database\r\n            if(_ShortName != value)\r\n            {\r\n                if(IsNotifyEnabled)\r\n                {\r\n                    OnPropertyChanging(nameof(ShortName));\r\n                    OnShortNameChanging();\r\n                    _ShortName = value;\r\n                    OnPropertyChanged(nameof(ShortName));\r\n                    OnShortNameChanged();\r\n                }\r\n                else\r\n                    _ShortName = value;\r\n            }\r\n        } \r\n    }\r\n    partial void OnShortNameChanging();\r\n    partial void OnShortNameChanged();\r\n\r\n    [Column(TypeName = \"date\")]\r\n    private DateTime? _StartDate;\r\n    public DateTime? StartDate { \r\n        get => _StartDate; \r\n        set {\r\n            //No notifications on first load from database\r\n            if(_StartDate != value)\r\n            {\r\n                if(IsNotifyEnabled)\r\n                {\r\n                    OnPropertyChanging(nameof(StartDate));\r\n                    OnStartDateChanging();\r\n                    _StartDate = value;\r\n                    OnPropertyChanged(nameof(StartDate));\r\n                    OnStartDateChanged();\r\n                }\r\n                else\r\n                    _StartDate = value;\r\n            }\r\n        } \r\n    }\r\n    partial void OnStartDateChanging();\r\n    partial void OnStartDateChanged();\r\n\r\n    [Column(TypeName = \"date\")]\r\n    private DateTime? _CalcDate;\r\n    public DateTime? CalcDate { \r\n        get => _CalcDate; \r\n        set {\r\n            //No notifications on first load from database\r\n            if(_CalcDate != value)\r\n            {\r\n                if(IsNotifyEnabled)\r\n                {\r\n                    OnPropertyChanging(nameof(CalcDate));\r\n                    OnCalcDateChanging();\r\n                    _CalcDate = value;\r\n                    OnPropertyChanged(nameof(CalcDate));\r\n                    OnCalcDateChanged();\r\n                }\r\n                else\r\n                    _CalcDate = value;\r\n            }\r\n        } \r\n    }\r\n    partial void OnCalcDateChanging();\r\n    partial void OnCalcDateChanged();\r\n\r\n    [Column(TypeName = \"date\")]\r\n    private DateTime? _EndDate;\r\n    public DateTime? EndDate { \r\n        get => _EndDate; \r\n        set {\r\n            //No notifications on first load from database\r\n            if(_EndDate != value)\r\n            {\r\n                if(IsNotifyEnabled)\r\n                {\r\n                    OnPropertyChanging(nameof(EndDate));\r\n                    OnEndDateChanging();\r\n                    _EndDate = value;\r\n                    OnPropertyChanged(nameof(EndDate));\r\n                    OnEndDateChanged();\r\n                }\r\n                else\r\n                    _EndDate = value;\r\n            }\r\n        } \r\n    }\r\n    partial void OnEndDateChanging();\r\n    partial void OnEndDateChanged();\r\n\r\n    private string _Comment;\r\n    public string Comment { \r\n        get => _Comment; \r\n        set {\r\n            //No notifications on first load from database\r\n            if(_Comment != value)\r\n            {\r\n                if(IsNotifyEnabled)\r\n                {\r\n                    OnPropertyChanging(nameof(Comment));\r\n                    OnCommentChanging();\r\n                    _Comment = value;\r\n                    OnPropertyChanged(nameof(Comment));\r\n                    OnCommentChanged();\r\n                }\r\n                else\r\n                    _Comment = value;\r\n            }\r\n        } \r\n    }\r\n    partial void OnCommentChanging();\r\n    partial void OnCommentChanged();\r\n\r\n    [StringLength(20)]\r\n    private string _MSDPortfolioID;\r\n    public string MSDPortfolioID { \r\n        get => _MSDPortfolioID; \r\n        set {\r\n            //No notifications on first load from database\r\n            if(_MSDPortfolioID != value)\r\n            {\r\n                if(IsNotifyEnabled)\r\n                {\r\n                    OnPropertyChanging(nameof(MSDPortfolioID));\r\n                    OnMSDPortfolioIDChanging();\r\n                    _MSDPortfolioID = value;\r\n                    OnPropertyChanged(nameof(MSDPortfolioID));\r\n                    OnMSDPortfolioIDChanged();\r\n                }\r\n                else\r\n                    _MSDPortfolioID = value;\r\n            }\r\n        } \r\n    }\r\n    partial void OnMSDPortfolioIDChanging();\r\n    partial void OnMSDPortfolioIDChanged();\r\n\r\n    private MSDExportFlag _MSDExport;\r\n    public MSDExportFlag MSDExport { \r\n        get => _MSDExport; \r\n        set {\r\n            //No notifications on first load from database\r\n            if(_MSDExport != value)\r\n            {\r\n                if(IsNotifyEnabled)\r\n                {\r\n                    OnPropertyChanging(nameof(MSDExport));\r\n                    OnMSDExportChanging();\r\n                    _MSDExport = value;\r\n                    OnPropertyChanged(nameof(MSDExport));\r\n                    OnMSDExportChanged();\r\n                }\r\n                else\r\n                    _MSDExport = value;\r\n            }\r\n        } \r\n    }\r\n    partial void OnMSDExportChanging();\r\n    partial void OnMSDExportChanged();\r\n\r\n    [StringLength(20)]\r\n    private string _MSDBenchmarkID;\r\n    public string MSDBenchmarkID { \r\n        get => _MSDBenchmarkID; \r\n        set {\r\n            //No notifications on first load from database\r\n            if(_MSDBenchmarkID != value)\r\n            {\r\n                if(IsNotifyEnabled)\r\n                {\r\n                    OnPropertyChanging(nameof(MSDBenchmarkID));\r\n                    OnMSDBenchmarkIDChanging();\r\n                    _MSDBenchmarkID = value;\r\n                    OnPropertyChanged(nameof(MSDBenchmarkID));\r\n                    OnMSDBenchmarkIDChanged();\r\n                }\r\n                else\r\n                    _MSDBenchmarkID = value;\r\n            }\r\n        } \r\n    }\r\n    partial void OnMSDBenchmarkIDChanging();\r\n    partial void OnMSDBenchmarkIDChanged();\r\n\r\n    private MSDExportFlag _MSDBmrkExport;\r\n    public MSDExportFlag MSDBmrkExport { \r\n        get => _MSDBmrkExport; \r\n        set {\r\n            //No notifications on first load from database\r\n            if(_MSDBmrkExport != value)\r\n            {\r\n                if(IsNotifyEnabled)\r\n                {\r\n                    OnPropertyChanging(nameof(MSDBmrkExport));\r\n                    OnMSDBmrkExportChanging();\r\n                    _MSDBmrkExport = value;\r\n                    OnPropertyChanged(nameof(MSDBmrkExport));\r\n                    OnMSDBmrkExportChanged();\r\n                }\r\n                else\r\n                    _MSDBmrkExport = value;\r\n            }\r\n        } \r\n    }\r\n    partial void OnMSDBmrkExportChanging();\r\n    partial void OnMSDBmrkExportChanged();\r\n\r\n    private SpecialGroup _Special;\r\n    public SpecialGroup Special { \r\n        get => _Special; \r\n        set {\r\n            //No notifications on first load from database\r\n            if(_Special != value)\r\n            {\r\n                if(IsNotifyEnabled)\r\n                {\r\n                    OnPropertyChanging(nameof(Special));\r\n                    OnSpecialChanging();\r\n                    _Special = value;\r\n                    OnPropertyChanged(nameof(Special));\r\n                    OnSpecialChanged();\r\n                }\r\n                else\r\n                    _Special = value;\r\n            }\r\n        } \r\n    }\r\n    partial void OnSpecialChanging();\r\n    partial void OnSpecialChanged();\r\n\r\n    [Column(TypeName = \"date\")]\r\n    private DateTime? _BackfillWithDate;\r\n    public DateTime? BackfillWithDate { \r\n        get => _BackfillWithDate; \r\n        set {\r\n            //No notifications on first load from database\r\n            if(_BackfillWithDate != value)\r\n            {\r\n                if(IsNotifyEnabled)\r\n                {\r\n                    OnPropertyChanging(nameof(BackfillWithDate));\r\n                    OnBackfillWithDateChanging();\r\n                    _BackfillWithDate = value;\r\n                    OnPropertyChanged(nameof(BackfillWithDate));\r\n                    OnBackfillWithDateChanged();\r\n                }\r\n                else\r\n                    _BackfillWithDate = value;\r\n            }\r\n        } \r\n    }\r\n    partial void OnBackfillWithDateChanging();\r\n    partial void OnBackfillWithDateChanged();\r\n\r\n    private Guid? _OfferingID;\r\n    public Guid? OfferingID { \r\n        get => _OfferingID; \r\n        set {\r\n            //No notifications on first load from database\r\n            if(_OfferingID != value)\r\n            {\r\n                if(IsNotifyEnabled)\r\n                {\r\n                    OnPropertyChanging(nameof(OfferingID));\r\n                    OnOfferingIDChanging();\r\n                    _OfferingID = value;\r\n                    OnPropertyChanged(nameof(OfferingID));\r\n                    OnOfferingIDChanged();\r\n                }\r\n                else\r\n                    _OfferingID = value;\r\n            }\r\n        } \r\n    }\r\n    partial void OnOfferingIDChanging();\r\n    partial void OnOfferingIDChanged();\r\n\r\n    private int? _RebalGroup;\r\n    public int? RebalGroup { \r\n        get => _RebalGroup; \r\n        set {\r\n            //No notifications on first load from database\r\n            if(_RebalGroup != value)\r\n            {\r\n                if(IsNotifyEnabled)\r\n                {\r\n                    OnPropertyChanging(nameof(RebalGroup));\r\n                    OnRebalGroupChanging();\r\n                    _RebalGroup = value;\r\n                    OnPropertyChanged(nameof(RebalGroup));\r\n                    OnRebalGroupChanged();\r\n                }\r\n                else\r\n                    _RebalGroup = value;\r\n            }\r\n        } \r\n    }\r\n    partial void OnRebalGroupChanging();\r\n    partial void OnRebalGroupChanged();\r\n\r\n    private Guid? _FeeTableID;\r\n    public Guid? FeeTableID { \r\n        get => _FeeTableID; \r\n        set {\r\n            //No notifications on first load from database\r\n            if(_FeeTableID != value)\r\n            {\r\n                if(IsNotifyEnabled)\r\n                {\r\n                    OnPropertyChanging(nameof(FeeTableID));\r\n                    OnFeeTableIDChanging();\r\n                    _FeeTableID = value;\r\n                    OnPropertyChanged(nameof(FeeTableID));\r\n                    OnFeeTableIDChanged();\r\n                }\r\n                else\r\n                    _FeeTableID = value;\r\n            }\r\n        } \r\n    }\r\n    partial void OnFeeTableIDChanging();\r\n    partial void OnFeeTableIDChanged();\r\n\r\n    [Column(TypeName = \"datetime\")]\r\n    private DateTime? _Updated;\r\n    public DateTime? Updated { \r\n        get => _Updated; \r\n        set {\r\n            //No notifications on first load from database\r\n            if(_Updated != value)\r\n            {\r\n                if(IsNotifyEnabled)\r\n                {\r\n                    OnPropertyChanging(nameof(Updated));\r\n                    OnUpdatedChanging();\r\n                    _Updated = value;\r\n                    OnPropertyChanged(nameof(Updated));\r\n                    OnUpdatedChanged();\r\n                }\r\n                else\r\n                    _Updated = value;\r\n            }\r\n        } \r\n    }\r\n    partial void OnUpdatedChanging();\r\n    partial void OnUpdatedChanged();\r\n\r\n    private string _Footnote;\r\n    public string Footnote { \r\n        get => _Footnote; \r\n        set {\r\n            //No notifications on first load from database\r\n            if(_Footnote != value)\r\n            {\r\n                if(IsNotifyEnabled)\r\n                {\r\n                    OnPropertyChanging(nameof(Footnote));\r\n                    OnFootnoteChanging();\r\n                    _Footnote = value;\r\n                    OnPropertyChanged(nameof(Footnote));\r\n                    OnFootnoteChanged();\r\n                }\r\n                else\r\n                    _Footnote = value;\r\n            }\r\n        } \r\n    }\r\n    partial void OnFootnoteChanging();\r\n    partial void OnFootnoteChanged();\r\n\r\n    private int? _N;\r\n    public int? N { \r\n        get => _N; \r\n        set {\r\n            //No notifications on first load from database\r\n            if(_N != value)\r\n            {\r\n                if(IsNotifyEnabled)\r\n                {\r\n                    OnPropertyChanging(nameof(N));\r\n                    OnNChanging();\r\n                    _N = value;\r\n                    OnPropertyChanged(nameof(N));\r\n                    OnNChanged();\r\n                }\r\n                else\r\n                    _N = value;\r\n            }\r\n        } \r\n    }\r\n    partial void OnNChanging();\r\n    partial void OnNChanged();\r\n\r\n    [Column(\"AntecedantID\")]\r\n    private Guid? _AntecedentID;\r\n    public Guid? AntecedentID { \r\n        get => _AntecedentID; \r\n        set {\r\n            //No notifications on first load from database\r\n            if(_AntecedentID != value)\r\n            {\r\n                if(IsNotifyEnabled)\r\n                {\r\n                    OnPropertyChanging(nameof(AntecedentID));\r\n                    OnAntecedentIDChanging();\r\n                    _AntecedentID = value;\r\n                    OnPropertyChanged(nameof(AntecedentID));\r\n                    OnAntecedentIDChanged();\r\n                }\r\n                else\r\n                    _AntecedentID = value;\r\n            }\r\n        } \r\n    }\r\n    partial void OnAntecedentIDChanging();\r\n    partial void OnAntecedentIDChanged();\r\n\r\n    private double? _MaxDuration;\r\n    public double? MaxDuration { \r\n        get => _MaxDuration; \r\n        set {\r\n            //No notifications on first load from database\r\n            if(_MaxDuration != value)\r\n            {\r\n                if(IsNotifyEnabled)\r\n                {\r\n                    OnPropertyChanging(nameof(MaxDuration));\r\n                    OnMaxDurationChanging();\r\n                    _MaxDuration = value;\r\n                    OnPropertyChanged(nameof(MaxDuration));\r\n                    OnMaxDurationChanged();\r\n                }\r\n                else\r\n                    _MaxDuration = value;\r\n            }\r\n        } \r\n    }\r\n    partial void OnMaxDurationChanging();\r\n    partial void OnMaxDurationChanged();\r\n\r\n    private Guid? _RebalancingGroupID;\r\n    public Guid? RebalancingGroupID { \r\n        get => _RebalancingGroupID; \r\n        set {\r\n            //No notifications on first load from database\r\n            if(_RebalancingGroupID != value)\r\n            {\r\n                if(IsNotifyEnabled)\r\n                {\r\n                    OnPropertyChanging(nameof(RebalancingGroupID));\r\n                    OnRebalancingGroupIDChanging();\r\n                    _RebalancingGroupID = value;\r\n                    OnPropertyChanged(nameof(RebalancingGroupID));\r\n                    OnRebalancingGroupIDChanged();\r\n                }\r\n                else\r\n                    _RebalancingGroupID = value;\r\n            }\r\n        } \r\n    }\r\n    partial void OnRebalancingGroupIDChanging();\r\n    partial void OnRebalancingGroupIDChanged();\r\n\r\n    [Required]\r\n    private byte[] _RowVersion;\r\n    public byte[] RowVersion { \r\n        get => _RowVersion; \r\n        set {\r\n            //No notifications on first load from database\r\n            if(_RowVersion != value)\r\n            {\r\n                if(IsNotifyEnabled)\r\n                {\r\n                    OnPropertyChanging(nameof(RowVersion));\r\n                    OnRowVersionChanging();\r\n                    _RowVersion = value;\r\n                    OnPropertyChanged(nameof(RowVersion));\r\n                    OnRowVersionChanged();\r\n                }\r\n                else\r\n                    _RowVersion = value;\r\n            }\r\n        } \r\n    }\r\n    partial void OnRowVersionChanging();\r\n    partial void OnRowVersionChanged();\r\n\r\n  \r\n    [InverseProperty(\"Group\")]\r\n    public virtual ObservableCollection<GroupBalance> Balances { get; set; }\r\n\r\n    [InverseProperty(\"Antecedent\")]\r\n    public virtual ObservableCollection<Group> Descendants { get; set; }\r\n\r\n    [InverseProperty(\"Parent\")]\r\n    public virtual ObservableCollection<Group> Children { get; set; }\r\n\r\n    Group _Parent;\r\n    [ForeignKey(\"ParentID\")]\r\n    [InverseProperty(\"Children\")]\r\n    public virtual Group Parent\r\n    {\r\n      get => _Parent;\r\n      set\r\n      {\r\n        if (_Parent != value)\r\n        {\r\n          if (IsNotifyEnabled)\r\n          {\r\n            OnPropertyChanging(\"Parent\");\r\n            OnParentChanging();\r\n            _Parent = value;\r\n            OnPropertyChanged(\"Parent\");\r\n            OnParentChanged();\r\n          }\r\n          else\r\n            _Parent = value;\r\n        }\r\n      }\r\n    }\r\n    partial void OnParentChanging();\r\n    partial void OnParentChanged();\r\n\r\n    Portfolio _Portfolio;\r\n    [ForeignKey(nameof(PortfolioID))]\r\n    [InverseProperty(\"Groups\")]\r\n    public virtual Portfolio Portfolio\r\n    {\r\n      get => _Portfolio;\r\n      set\r\n      {\r\n        if (_Portfolio != value)\r\n        {\r\n          if (IsNotifyEnabled)\r\n          {\r\n            OnPropertyChanging(\"Portfolio\");\r\n            OnPortfolioChanging();\r\n            _Portfolio = value;\r\n            OnPropertyChanged(\"Portfolio\");\r\n            OnPortfolioChanged();\r\n          }\r\n          else\r\n            _Portfolio = value;\r\n        }\r\n      }\r\n    }\r\n    partial void OnPortfolioChanging();\r\n    partial void OnPortfolioChanged();\r\n\r\n    [InverseProperty(\"Group\")]\r\n    public virtual ObservableCollection<GroupReturn> Returns { get; set; }\r\n\r\n    [InverseProperty(\"Group\")]\r\n    public virtual ObservableCollection<EqualWeight> EqualWeights { get; set; }\r\n\r\n    [InverseProperty(\"Group\")]\r\n    public virtual ObservableCollection<GroupBenchmarksReturn> BenchmarkReturns { get; set; }\r\n\r\n    [InverseProperty(\"Group\")]\r\n    public virtual ObservableCollection<GroupPolicy> Policies { get; set; }\r\n\r\n    [InverseProperty(\"Groups\")]\r\n    public virtual ObservableCollection<Investment> Investments { get; set; }\r\n\r\n    [InverseProperty(\"Group\")]\r\n    public virtual ObservableCollection<GroupConcern> GroupConcerns { get; set; }\r\n\r\n    FeeTable _FeeTable;\r\n    [ForeignKey(\"FeeTableID\")]\r\n    [InverseProperty(\"Groups\")]\r\n    public virtual FeeTable FeeTable\r\n    {\r\n      get => _FeeTable;\r\n      set\r\n      {\r\n        if (_FeeTable != value)\r\n        {\r\n          if (IsNotifyEnabled)\r\n          {\r\n            OnPropertyChanging(\"FeeTable\");\r\n            OnFeeTableChanging();\r\n            _FeeTable = value;\r\n            OnPropertyChanged(\"FeeTable\");\r\n            OnFeeTableChanged();\r\n          }\r\n          else\r\n            _FeeTable = value;\r\n        }\r\n      }\r\n    }\r\n    partial void OnFeeTableChanging();\r\n    partial void OnFeeTableChanged();\r\n\r\n    FundOffering _FundOffering;\r\n    [ForeignKey(\"OfferingID\")]\r\n    [InverseProperty(\"Groups\")]\r\n    public virtual FundOffering FundOffering\r\n    {\r\n      get => _FundOffering;\r\n      set\r\n      {\r\n        if (_FundOffering != value)\r\n        {\r\n          if (IsNotifyEnabled)\r\n          {\r\n            OnPropertyChanging(\"FundOffering\");\r\n            OnFundOfferingChanging();\r\n            _FundOffering = value;\r\n            OnPropertyChanged(\"FundOffering\");\r\n            OnFundOfferingChanged();\r\n          }\r\n          else\r\n            _FundOffering = value;\r\n        }\r\n      }\r\n    }\r\n    partial void OnFundOfferingChanging();\r\n    partial void OnFundOfferingChanged();\r\n\r\n    [InverseProperty(\"Group\")]\r\n    public virtual ObservableCollection<GroupComposition> Compositions { get; set; }\r\n\r\n    [InverseProperty(\"Groups\")]\r\n    public virtual ObservableCollection<Account> Accounts { get; set; }\r\n\r\n    [InverseProperty(\"Group\")]\r\n    public virtual ObservableCollection<GroupHolding> Holdings { get; set; }\r\n\r\n    Group _Antecedent;\r\n    [ForeignKey(\"AntecedentID\")]\r\n    [InverseProperty(\"Descendants\")]\r\n    public virtual Group Antecedent\r\n    {\r\n      get => _Antecedent;\r\n      set\r\n      {\r\n        if (_Antecedent != value)\r\n        {\r\n          if (IsNotifyEnabled)\r\n          {\r\n            OnPropertyChanging(\"Antecedent\");\r\n            OnAntecedentChanging();\r\n            _Antecedent = value;\r\n            OnPropertyChanged(\"Antecedent\");\r\n            OnAntecedentChanged();\r\n          }\r\n          else\r\n            _Antecedent = value;\r\n        }\r\n      }\r\n    }\r\n    partial void OnAntecedentChanging();\r\n    partial void OnAntecedentChanged();\r\n\r\n    [InverseProperty(\"Group\")]\r\n    public virtual ObservableCollection<GroupObligationStream> ObligationStreams { get; set; }\r\n\r\n    [InverseProperty(\"Group\")]\r\n    public virtual ObservableCollection<GroupLiability> Liabilities { get; set; }\r\n\r\n    RebalancingGroup _RebalancingGroup;\r\n    [ForeignKey(\"RebalancingGroupID\")]\r\n    [InverseProperty(\"Groups\")]\r\n    public virtual RebalancingGroup RebalancingGroup\r\n    {\r\n      get => _RebalancingGroup;\r\n      set\r\n      {\r\n        if (_RebalancingGroup != value)\r\n        {\r\n          if (IsNotifyEnabled)\r\n          {\r\n            OnPropertyChanging(\"RebalancingGroup\");\r\n            OnRebalancingGroupChanging();\r\n            _RebalancingGroup = value;\r\n            OnPropertyChanged(\"RebalancingGroup\");\r\n            OnRebalancingGroupChanged();\r\n          }\r\n          else\r\n            _RebalancingGroup = value;\r\n        }\r\n      }\r\n    }\r\n    partial void OnRebalancingGroupChanging();\r\n    partial void OnRebalancingGroupChanged();\r\n\r\n}\r\n```\r\nAnd an additional partial file as follows:\r\n```C#\r\nusing System.ComponentModel;\r\nusing RLDExtensions;\r\nusing System.Collections;\r\nusing System.Collections.ObjectModel;\r\nusing WPFControls;\r\n\r\nnamespace HCAEntities.Models\r\n{\r\n  [Flags]\r\n  public enum SpecialGroup\r\n  {\r\n    None = 0x0,\r\n    Core = 0x1,\r\n    Stale = 0x2,\r\n    Consolidation = 0x4,\r\n    [Description(\"Duration Segment\")]\r\n    Duration_Segment = 0x400,\r\n    [Description(\"Duration Total\")]\r\n    Duration_Total = 0x800,\r\n    [Description(\"Non Duration Total\")]\r\n    Non_Duration_Total = 0x1000,\r\n    [Description(\"Don't Estimate Missing Returns\")]\r\n    NoMissingReturnEstimates = 0x2000,\r\n    SchemeNatureMask = 0x1C00\r\n  }\r\n\r\n  [System.Diagnostics.DebuggerDisplay(\"{\" + nameof(Group.Name) + \"}\")]\r\n  public partial class Group : IRebalanceOwner, ICloneable\r\n  {\r\n    public Group Init(Portfolio port)\r\n    {\r\n      base.Init();\r\n      Portfolio = port;\r\n      return this;\r\n    }\r\n\r\n    #region Nature\r\n\r\n    public bool Conceptual\r\n    {\r\n      get => true; set { }\r\n    }\r\n\r\n    public bool Custodial_Account\r\n    {\r\n      get => false; set { }\r\n    }\r\n\r\n    public bool Model_Portfolio\r\n    {\r\n      get => false; set { }\r\n    }\r\n\r\n    public bool Money_Source\r\n    {\r\n      get => false; set { }\r\n    }\r\n\r\n    public bool Retirement\r\n    {\r\n      get => false; set { }\r\n    }\r\n\r\n    public bool Exclude_OtherIncome\r\n    {\r\n      get => false; set { }\r\n    }\r\n\r\n    public bool Separate_Account\r\n    {\r\n      get => false; set { }\r\n    }\r\n\r\n    public bool Tax_Exempt\r\n    {\r\n      get => false; set { }\r\n    }\r\n\r\n    public bool Tax_Deferred\r\n    {\r\n      get => false; set { }\r\n    }\r\n\r\n    public SchemeNature Nature\r\n    {\r\n      get => SchemeNature.Conceptual | (SchemeNature)(Special & SpecialGroup.SchemeNatureMask); set { }\r\n    }\r\n\r\n    public bool Spinoff\r\n    {\r\n      get => Antecedent != null && !Consolidation; set => Consolidation = !value;\r\n    }\r\n\r\n    public bool Consolidation\r\n    {\r\n      get => Antecedent != null && (Special & SpecialGroup.Consolidation) == SpecialGroup.Consolidation; set\r\n      {\r\n        SetSpecial(value, SpecialGroup.Consolidation);\r\n        NotifyPropertyChanged(nameof(Spinoff));\r\n      }\r\n    }\r\n\r\n    public bool IncludePredecessorEvents\r\n    {\r\n      get => false;\r\n      set { }\r\n    }\r\n\r\n    public bool LimitConsolidationHistoryToJoint\r\n    {\r\n      get => false;\r\n      set { }\r\n    }\r\n    #endregion\r\n\r\n    #region Specials\r\n\r\n    public bool Core\r\n    {\r\n      get => (Special & SpecialGroup.Core) == SpecialGroup.Core; set\r\n      {\r\n        if (SetSpecial(value, SpecialGroup.Core))\r\n        {\r\n          if (Core) //make sure there is only one \"Core\" group\r\n          {\r\n            foreach (Group grp in Portfolio.Groups.Where(g => g != this && g.Core))\r\n              grp.Core = false;\r\n            while (Accounts.Any()) //Core groups can only contain investments\r\n              Accounts.Remove(Accounts.First());\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    public bool Stale\r\n    {\r\n      get => (Special & SpecialGroup.Stale) == SpecialGroup.Stale; set => SetSpecial(value, SpecialGroup.Stale);\r\n    }\r\n\r\n    public bool Duration_Segment\r\n    {\r\n      get => (Special & SpecialGroup.Duration_Segment) == SpecialGroup.Duration_Segment;\r\n      set\r\n      {\r\n        SetSpecial(value, SpecialGroup.Duration_Segment); \r\n        NotifyPropertyChanged(nameof(NoMissingReturnEstimates));\r\n        foreach (Investment _investment in Investments)\r\n        {\r\n          _investment.NotifyPropertyChanged(nameof(Investment.HasLiabilities));\r\n        }\r\n      }\r\n    }\r\n\r\n    public bool Duration_Total\r\n    {\r\n      get => (Special & SpecialGroup.Duration_Total) == SpecialGroup.Duration_Total;\r\n      set\r\n      {\r\n        if (SetSpecial(value, SpecialGroup.Duration_Total))\r\n        {\r\n          if (value)\r\n          {\r\n            List<IScheme> schemes = Portfolio.Schemes.Where(s => s.Duration_Total && s != this).ToList();\r\n            if (Portfolio.Duration_Total)\r\n              schemes.Add(Portfolio);\r\n            foreach (IScheme scheme in schemes)\r\n              scheme.Duration_Total = false;\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    public bool Non_Duration_Total\r\n    {\r\n      get => (Special & SpecialGroup.Non_Duration_Total) == SpecialGroup.Non_Duration_Total;\r\n      set\r\n      {\r\n        if (SetSpecial(value, SpecialGroup.Non_Duration_Total))\r\n        {\r\n          if (value)\r\n          {\r\n            List<IScheme> schemes = Portfolio.Schemes.Where(s => s.Non_Duration_Total && s != this).ToList();\r\n            foreach (IScheme scheme in schemes)\r\n              scheme.Non_Duration_Total = false;\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    public List<IRebalanceItem> RebalanceItems => Portfolio.RebalanceItems;\r\n\r\n    public bool NoMissingReturnEstimates\r\n    {\r\n      get => Duration_Segment || (Special & SpecialGroup.NoMissingReturnEstimates) == SpecialGroup.NoMissingReturnEstimates; \r\n      set => SetSpecial(value, SpecialGroup.NoMissingReturnEstimates);\r\n    }\r\n\r\n    public bool ThreeThirtyEight\r\n    {\r\n      get => Portfolio.ThreeThirtyEight;\r\n      set { }\r\n    }\r\n\r\n    private bool SetSpecial(bool value, SpecialGroup flag, string propName = null)\r\n    {\r\n      if (value != ((Special & flag) == flag)) //test to see if this is a change\r\n      {\r\n        if (value)\r\n          Special = Special | flag;\r\n        else\r\n          Special &= ~flag;\r\n        NotifyPropertyChanged((propName != null) ? propName : Enum.GetName(typeof(SpecialGroup), flag));\r\n        return true; //flag was modified\r\n      }\r\n      return false; //flag was not modified\r\n    }\r\n\r\n    #endregion\r\n\r\n    public bool Active\r\n    {\r\n      get => EndDate == null; set\r\n      {\r\n        if (value && EndDate != null || !value && EndDate == null)\r\n        {\r\n          if (!value)\r\n            EndDate = Balances.Any() ? Balances.Max(b => b.EndDate) : DateTime.Now.PriorMonthEnd();\r\n          else\r\n            EndDate = null;\r\n          NotifyPropertyChanged(nameof(Active));\r\n        }\r\n      }\r\n    }\r\n\r\n    protected override void Delete_Pre()\r\n\t\t{\r\n      bool deleted = true;\r\n      LoadAllBalances();\r\n      base.Delete_Pre();\r\n      while (GroupConcerns.Any() && deleted)\r\n        deleted = GroupConcerns.First().Delete(false);\r\n      while (Returns.Any() && deleted)\r\n        deleted = Returns.First().Delete(false);\r\n      while (BenchmarkReturns.Any() && deleted)\r\n        deleted = BenchmarkReturns.First().Delete(false);\r\n      while (Balances.Any() && deleted)\r\n        deleted = Balances.First().Delete(false);\r\n      while (Holdings.Any() && deleted)\r\n        deleted = Holdings.First().Delete(false);\r\n      while (EqualWeights.Any() && deleted)\r\n        deleted = EqualWeights.First().Delete(false);\r\n      while (Policies.Any() && deleted)\r\n        deleted = Policies.First().Delete(false);\r\n      while (Compositions.Any() && deleted)\r\n        deleted = Compositions.First().Delete(false);\r\n      while (Liabilities.Any() && deleted)\r\n        deleted = Liabilities.First().Delete(false);\r\n    }\r\n\r\n    public bool IsAccountGroup => Accounts.Any(); public bool IsInvestmentGroup => Investments.Any();\r\n    //EntitySelectList<Investment> _investmentList;\r\n    public EntitySelectList<Investment> InvestmentList => new(Investments, Portfolio.Investments, \"Name\", this, \"Name\", ConstituentsChangedListener);\r\n\r\n    //EntitySelectList<Investment> _investmentList;\r\n    public EntitySelectList<Account> AccountList => new(Accounts, Portfolio.Accounts, \"Name\", this, \"Name\", ConstituentsChangedListener);\r\n\r\n    private void ConstituentsChangedListener(object sender, PropertyChangedEventArgs e)\r\n    {//Listens for Constituents to be added/removed and marks any EqualWeight Synthetics as Stale\r\n      if (e.PropertyName == \"IsChecked\")\r\n      {\r\n        if (EqualWeightSynthetic != null)\r\n        {\r\n          EqualWeightSynthetic.StaleDefinition = true;\r\n          if (EqualWeightSynthetic.EWBenchmarkSynthetic != null)\r\n            EqualWeightSynthetic.EWBenchmarkSynthetic.StaleDefinition = true;\r\n        }\r\n\r\n        if (((CheckedEntity)sender).Obj is IBalanceOwner ibo)\r\n        {\r\n          ibo.LoadBalances();\r\n          if (ibo.Balances.Any())\r\n          {\r\n            var gbals = Balances.Where(b => b.EndDate <= ibo.MaxBalanceDate && b.EndDate >= ibo.MinBalanceDate);\r\n            foreach (GroupBalance gb in gbals) gb.Dirty = true;\r\n          }\r\n        }\r\n\r\n        if (Duration_Segment && ((CheckedEntity)sender).Obj is Investment inv)\r\n        {\r\n          inv.NotifyPropertyChanged(nameof(Investment.HasLiabilities));\r\n        }\r\n      }\r\n      NotifyPropertyChanged(nameof(IsInvestmentGroup));\r\n      NotifyPropertyChanged(nameof(IsAccountGroup));\r\n    }\r\n\r\n    //Because Groups are composed of other IBalanceOwners (Investments &/or Accounts) they need a CreateBalances method in addition to the inherited Update method.\r\n    //This method will create/delete GroupBalance and GroupHoldingBalance records according to the existence or non-existence of constituent IBalanceOwner records\r\n    //before calling the Update method. In addition, it executes a single query and passes relevant constituent balances to each GroupBalance and GroupHoldingBalance CreateBalances \r\n    //method thereby saving valuable resources. Calling update will NOT add or delete records, merely re-total their contents based on there related constituent balances\r\n    public void CreateBalances(Progressor prog, DateTime? limiter = null, bool reportProgress = true)\r\n    {\r\n      if(reportProgress)\r\n        prog.ReportIndeterminate(\"Loading \" + Name + \" Balances...\");\r\n      LoadAllBalances();\r\n      Portfolio.LoadAllBalances();\r\n      DateTime calcFrom = limiter ?? (CalcDate ?? DateTime.MinValue).Max(StartDate ?? DateTime.MinValue);\r\n      DateTime ending = EndDate ?? DateTime.MaxValue;\r\n      IEnumerable<Balance> bals;\r\n      if (IsAccountGroup)\r\n        bals = Accounts.SelectMany(a => a.HoldingBalances).Where(b => b.EndDate >= calcFrom && b.EndDate <= ending);\r\n      else\r\n        bals = Investments.SelectMany(i => i.Holdings).Where(h => !(h is GroupHolding)).SelectMany(h => h.Balances)\r\n          .Where(b => b.EndDate >= calcFrom && b.EndDate <= ending).Distinct();\r\n\r\n      //DateTime[] extant = Balances.Select(b => b.EndDate).ToArray();\r\n      //DateTime[] dirty = Balances.Where(b => b.IsDirty).Select(b => b.EndDate).ToArray();\r\n      //REMOVED FROM BELOW QUERY ON 02/10/2017: where !extant.Contains(b.EndDate) || dirty.Contains(b.EndDate) \r\n      var grps = (from b in bals group b by b.EndDate into endGroup orderby endGroup.Key select \r\n                   new {EndDate = endGroup.Key, BegDate = endGroup.Min(c => c.BegDate), Recon = endGroup.Max(c => c.Recon), Balances = endGroup}).ToList();\r\n\r\n      //delete those that with no matching EndDate (if any)\r\n      var deleted = Balances.Where(b => b.EndDate > calcFrom && grps.All(g => g.EndDate != b.EndDate)).ToArray();\r\n      foreach (var bal in deleted)\r\n        bal.Delete(false);\r\n\r\n      if (reportProgress)\r\n      {\r\n        if (prog.TotalCount > 0)\r\n          prog.NewSubTotalCount(grps.Count(), \"Updating Group Balances...\");\r\n        else\r\n          prog.TotalCount = grps.Count();\r\n      }\r\n\r\n      foreach (var grp in grps)\r\n      {\r\n        GroupBalance gbal = Balances.FirstOrDefault(b => b.EndDate == grp.EndDate);\r\n        if (gbal == null)\r\n        {\r\n          if (reportProgress)\r\n          {\r\n            if (prog.SubTotalCount > 0)\r\n              prog.ReportSubProgress(\"Creating \" + grp.EndDate.ToShortDateString() + \" balance...\", 1);\r\n            else\r\n              prog.Report(\"Creating \" + grp.EndDate.ToShortDateString() + \" balance...\", 1);\r\n          }\r\n\r\n          gbal = new GroupBalance().Init(this, grp.EndDate, grp.BegDate, grp.Recon, BalanceOrigin.Sum_of_Balances);\r\n        }\r\n        else\r\n        {\r\n          gbal.BegDate = grp.BegDate;\r\n          if (reportProgress)\r\n          {\r\n            if (prog.SubTotalCount > 0)\r\n              prog.ReportSubProgress(\"Calculating \" + grp.EndDate.ToShortDateString() + \" balance...\", 1);\r\n            else\r\n              prog.Report(\"Calculating \" + grp.EndDate.ToShortDateString() + \" balance...\", 1);\r\n          }\r\n        }\r\n\r\n        gbal.CreateBalances(grp.Balances, prog);\r\n        gbal.Update();\r\n      }\r\n\r\n    }\r\n\r\n    public IEnumerable HoldingsBetween(DateTime fromDate, DateTime toDate)\r\n    {\r\n      Guid[] invArray = Investments.Select(i => i.InvestmentID).ToArray();\r\n      Guid[] acctArray = Accounts.Select(a => a.AccountID).ToArray();\r\n      //Investment weights\r\n      string CASHID = Index.GetDefaultReturnData(SmartCurrencyCode, BroadAssetClass.Cash)?.Owner.MSDPortfolioID ?? \"MISSING_SECID\";\r\n\r\n      var phldBals = from b in HighlandEntities.Context.PortfolioHoldingBalances\r\n                     where invArray.Contains(b.PortfolioHolding.InvestmentID) && b.EndDate >= fromDate && b.EndDate <= toDate\r\n                     select new\r\n                     {\r\n                       bal = (Balance)b,\r\n                       InvestID = b.PortfolioHolding.InvestmentID,\r\n                       InvestName = b.PortfolioHolding.Investment.Name,\r\n                       SecID = b.PortfolioHolding.Investment.SecID ?? CASHID\r\n                     };\r\n      var ahldBals = from c in HighlandEntities.Context.AccountHoldingBalances\r\n                     where invArray.Contains(c.AccountHolding.InvestmentID) && c.EndDate >= fromDate && c.EndDate <= toDate\r\n                     select new\r\n                     {\r\n                       bal = (Balance)c,\r\n                       InvestID = c.AccountHolding.InvestmentID,\r\n                       InvestName = c.AccountHolding.Investment.Name,\r\n                       SecID = c.AccountHolding.Investment.SecID ?? CASHID\r\n                     };\r\n      var ahldBals2 = from c in HighlandEntities.Context.AccountHoldingBalances\r\n                      where acctArray.Contains(c.AccountHolding.AccountID) && c.EndDate >= fromDate && c.EndDate <= toDate\r\n                      select new\r\n                      {\r\n                        bal = (Balance)c,\r\n                        InvestID = c.AccountHolding.InvestmentID,\r\n                        InvestName = c.AccountHolding.Investment.Name,\r\n                        SecID = c.AccountHolding.Investment.SecID ?? CASHID\r\n                      };\r\n\r\n      var ubals = IsInvestmentGroup ? phldBals.Union(ahldBals) : ahldBals2;\r\n\r\n      var hldngBals = from a in ubals\r\n                      group a by new { a.bal.EndDate, a.InvestID } into balGroup\r\n                      select\r\n                        new\r\n                        {\r\n                          EndDate = balGroup.Key,\r\n                          PortfolioID = MSDPortfolioID,\r\n                          PortfolioName = Name,\r\n                          HoldingID = balGroup.FirstOrDefault().SecID,\r\n                          HoldingName = balGroup.FirstOrDefault().InvestName,\r\n                          MV = balGroup.Sum(e => e.bal.EndMV)\r\n                        };\r\n      return hldngBals;\r\n    }\r\n\r\n    public void CreateUpdateEqualWeightedSynthetic(bool gross = false)\r\n    {\r\n      if (IsInvestmentGroup)\r\n      {        \r\n        string missing = HighlandEntities.MissingInvestmentData(Investments, true, true, true, false, false);\r\n        if (missing == string.Empty)\r\n        {\r\n          DateTime fromDate = CalcDate ?? DateTime.MinValue;\r\n\r\n          EqualWeight ew = EqualWeights.SingleOrDefault();\r\n          if (ew == null)\r\n            ew = new EqualWeight().Init(this);\r\n          else\r\n          {\r\n            if (fromDate > ew.Inception)\r\n              GlobalErrors.Add(ew.Name + \": Allocations before \" + fromDate.ToShortDateString() + \" were preserved.\", ErrorCategory.Warning);\r\n            ew.DeleteDetail(fromDate);\r\n          }\r\n\r\n          EWBenchmark ewb = ew.EWBenchmarks.FirstOrDefault();\r\n          if (ewb == null)\r\n            ewb = new EWBenchmark().Init(ew);\r\n          else\r\n            ewb.DeleteDetail(fromDate);\r\n\r\n          var added = (from i in Investments\r\n                      where i.DateAdded != null\r\n                      group i by i.DateAdded into dateGroup\r\n                      orderby dateGroup.Key\r\n                      select new { date = dateGroup.Key ?? DateTime.MaxValue, investments = dateGroup }).ToList();\r\n          var removed = (from i in Investments\r\n                        where i.DateRemoved != null\r\n                        group i by i.DateRemoved into dateGroup\r\n                        orderby dateGroup.Key\r\n                        select new { date = dateGroup.Key ?? DateTime.MaxValue, investments = dateGroup }).ToList();\r\n          List<Investment> detail = new();\r\n          int j = 0;\r\n          int k = 0;\r\n          while (j < added.Count() || k < removed.Count())\r\n          {\r\n            var addGroup = added.ElementAtOrDefault(j);\r\n            var removeGroup = removed.ElementAtOrDefault(k);\r\n            DateTime dt;\r\n            if (addGroup != null && removeGroup != null)\r\n              dt = addGroup.date.Min(removeGroup.date);\r\n            else if (addGroup != null)\r\n              dt = addGroup.date;\r\n            else\r\n              dt = removeGroup.date;\r\n\r\n            if (addGroup != null && addGroup.date == dt)\r\n            {\r\n              foreach (Investment inv in addGroup.investments)\r\n                detail.Add(inv);\r\n              j++;\r\n            }\r\n\r\n            if (removeGroup != null && removeGroup.date == dt)\r\n            {\r\n              foreach (Investment inv in removeGroup.investments)\r\n                detail.Remove(inv);\r\n              k++;\r\n            }\r\n\r\n            if (dt >= fromDate)\r\n            {\r\n              foreach (Investment inv in detail)\r\n              {\r\n                SyntheticDetail sd = new SyntheticDetail().Init(ew, dt);\r\n                sd.ReturnDataID = inv.ReturnSourceID;\r\n                sd.Pct = 1d / (double)detail.Count();\r\n              }\r\n\r\n              var bmDetail = from d in detail\r\n                             group d by d.BenchmarkOrDefault into bmGroup\r\n                             select new { returnData = bmGroup.FirstOrDefault()?.BenchmarkOrDefault, count = bmGroup.Count() };\r\n              foreach (var bm in bmDetail)\r\n              {\r\n                SyntheticDetail sd = new SyntheticDetail().Init(ewb, dt);\r\n                sd.ReturnDataID = bm.returnData.ReturnDataID;\r\n                sd.Pct = (double)bm.count / (double)detail.Count();\r\n              }\r\n            }\r\n          }\r\n\r\n          Group anteCore = Portfolio.Antecedent?.Groups.FirstOrDefault(g => g.Core);\r\n          if (anteCore != null && anteCore.EqualWeightSynthetic != null)\r\n          {\r\n            ew.ExtendWith(anteCore.EqualWeightSynthetic);\r\n            ewb.ExtendWith(anteCore.EqualWeightSynthetic.EWBenchmarkSynthetic);\r\n          }\r\n          ew.TrimUsingDetailBeginDates();\r\n          ew.StaleDefinition = false;\r\n          ewb.TrimUsingDetailBeginDates();\r\n          ewb.StaleDefinition = false;\r\n        }\r\n        else\r\n          GlobalErrors.Add(\"Can't create the Synthetic.  You are missing data for the selected investments:\\n\" + missing, ErrorCategory.Error);\r\n      }\r\n      else\r\n        GlobalErrors.Add(\"Only Groups composed of Investments and not Accounts can create an Equal Weighted Synthetic.\", ErrorCategory.Error);\r\n    }\r\n\r\n    public EqualWeight EqualWeightSynthetic\r\n    {\r\n      get => EqualWeights.SingleOrDefault(); set\r\n      {\r\n        EqualWeightSynthetic?.Delete(false);\r\n        EqualWeights.Add(value);\r\n        NotifyPropertyChanged(nameof(EqualWeightSynthetic));\r\n      }\r\n    }\r\n\r\n    public DateTime NextDate()\r\n    {\r\n      DateTime? next = Balances.OrderBy(ab => ab.EndDate).Select(ab => ab.EndDate).Last();\r\n      return next.NextPeriodEnd(SliceType.Month);\r\n    }\r\n\r\n    Synthetic IScheme.MainPolicy => MainPolicy;\r\n    public GroupPolicy MainPolicy\r\n    {\r\n      get => Policies.FirstOrDefault(); set\r\n      {\r\n        MainPolicy?.Delete(false);\r\n        Policies.Add(value);\r\n        NotifyPropertyChanged(nameof(MainPolicy));\r\n      }\r\n    }\r\n\r\n    public string BenchmarkName => FullName + \" Benchmark\";\r\n    #region IReturnCalculator Implementation\r\n    DateTime? _StaleReturnDate;\r\n    public DateTime? StaleReturnDate\r\n    {\r\n      get => _StaleReturnDate; set\r\n      {\r\n        if (_StaleReturnDate != value && (value ?? DateTime.MinValue) < this.LatestReturnDate())\r\n        {\r\n          _StaleReturnDate = value;\r\n          NotifyPropertyChanged(nameof(StaleReturnDate));\r\n        }\r\n      }\r\n    }\r\n\r\n    DateTime? _StaleBenchmarkReturnDate;\r\n    public DateTime? StaleBenchmarkReturnDate\r\n    {\r\n      get => _StaleBenchmarkReturnDate; set\r\n      {\r\n        if (_StaleBenchmarkReturnDate != value && (value ?? DateTime.MinValue) < this.LatestBenchmarkReturnDate())\r\n        {\r\n          _StaleBenchmarkReturnDate = value;\r\n          NotifyPropertyChanged(nameof(StaleBenchmarkReturnDate));\r\n        }\r\n      }\r\n    }\r\n\r\n    public Guid CalculatorEntityID => GroupID;\r\n    public double CalcPriority => (double)ReturnCalcPriority.FromBalances;\r\n    public SliceType Slice => Portfolio.Slice;\r\n\r\n    public ReturnSource Source => ReturnSource.Calculated;\r\n    //DateTime? IReturnOwner.EndDate => _EndDate;\r\n    IEnumerable<ReturnData> IReturnOwner.Returns => Returns;\r\n    public bool CanHaveBenchmarkReturns => true;\r\n    IEnumerable<ReturnData> IReturnOwner.BenchmarkReturns => BenchmarkReturns;\r\n\r\n    public IEnumerable<DateTime?> BackfillDateList\r\n    {\r\n      get\r\n      {\r\n        LazyLoad<Group, GroupBalance>(g => g.Balances);\r\n        var list = new List<DateTime?>();\r\n        list.Add(null);\r\n        list.AddRange(Balances.Where(b => b.Origin == BalanceOrigin.Sum_of_Balances).OrderBy(b => b.EndDate)\r\n          .Select(b => b.EndDate).Cast<DateTime?>());\r\n        return list;\r\n      }\r\n    }\r\n\r\n    public ReturnStream Calculate(Progressor prog, SliceType slice, DateTime limiter, bool useBenchmarks = false, bool showErrors = true)\r\n    {\r\n      ReturnStream DRS = null;\r\n      if (!useBenchmarks)\r\n        DRS = this.DietzRS(slice, limiter, showErrors);\r\n      ReturnStream WARS = this.WeightedAverageRS(slice, limiter, showErrors, useBenchmarks, BackfillWithDate, DRS);\r\n      if (!useBenchmarks)\r\n      {\r\n        ReturnStream RS = new();\r\n        RS.Slice = slice;\r\n        if (DRS != null)\r\n        {\r\n          DateTime start = (WARS == null) ? DRS.BegDate : DRS.BegDate.Min(WARS.BegDate);\r\n          DateTime end = (WARS == null || NoMissingReturnEstimates) ? DRS.EndDate : DRS.EndDate.Max(WARS.EndDate);\r\n          DateTime nextDate = end;\r\n          while (nextDate > start)\r\n          {\r\n            ReturnSlice rslice = (BackfillWithDate == null || nextDate > BackfillWithDate) ? DRS.GetReturnSlice(nextDate) : null;\r\n            if (rslice == null)\r\n            {\r\n              rslice = WARS.GetReturnSlice(nextDate);\r\n              if (rslice != null) rslice.Provisional = true;\r\n            }\r\n            if (rslice != null)\r\n              RS.Append(rslice);\r\n            else\r\n            {\r\n              GlobalErrors.Add(Name + \" | Returns truncated at \" + nextDate.ToShortDateString() + \" because no return available.\", ErrorCategory.Warning, \"Group.Calculate()\");\r\n              break;\r\n            }\r\n            nextDate = nextDate.PriorPeriodEnd(slice);\r\n          }\r\n          return RS;\r\n        }\r\n        return WARS;\r\n      }\r\n      else\r\n        return WARS;\r\n    }\r\n\r\n    public DateTime? Inception => Balances.Any() ? (from b in Balances select b.EndDate.MoveToSliceDay(Slice, 1)).Min() : (DateTime?)null;\r\n\r\n    public string CurrencyCode\r\n    {\r\n      get => Portfolio?.SmartCurrencyCode ?? \"USD\"; set { }\r\n    }\r\n\r\n    public string SmartCurrencyCode\r\n    {\r\n      get => Portfolio?.SmartCurrencyCode ?? \"USD\"; set { }\r\n    }\r\n\r\n    public ReturnData GetReturnData(SliceType slice = SliceType.Month, bool gross = true, bool benchmark = false, bool create = false)\r\n    {\r\n      ReturnData RD;\r\n      if (benchmark)\r\n      {\r\n        if ((Duration_Segment || Duration_Total) && SmartLiability != null)\r\n        {\r\n          RD = (from r in SmartLiability.Returns where r.Slice == slice && r.Gross == gross select r).FirstOrDefault();\r\n          if (RD == null && create)\r\n            RD = new LiabilityReturn().Init(SmartLiability, slice, gross);\r\n        }\r\n        else\r\n        {\r\n          RD = (from r in BenchmarkReturns where r.Slice == slice && r.Gross == gross select r).FirstOrDefault();\r\n          if (RD == null && create)\r\n            RD = new GroupBenchmarksReturn().Init(this, slice, gross);\r\n        }\r\n      }\r\n      else\r\n      {\r\n        RD = (from r in Returns where r.Slice == slice && r.Gross == gross select r).FirstOrDefault();\r\n        if (RD == null && create)\r\n          RD = new GroupReturn().Init(this, slice, gross);\r\n      }\r\n      return RD;\r\n    }\r\n\r\n    public Allocations Allocations { get; set; }\r\n\r\n    public object GetCharacteristic(CharacteristicTypes chr, DateTime asOfDate, ICurrencyReporter reporter, bool mostRecent)\r\n    {\r\n      switch (chr)\r\n      {\r\n        case CharacteristicTypes.ShortName:\r\n          return (string.IsNullOrEmpty(ShortName) ? Name : ShortName);\r\n        case CharacteristicTypes.InvestmentType:\r\n          return \"Group\";\r\n        default:\r\n          return ((IScheme)this).GetCharacteristic(chr, asOfDate, reporter, mostRecent, false);\r\n      }\r\n    }\r\n\r\n    public Dictionary<CharacteristicTypes, object> GetCharacteristics(ICollection<Characteristic> traits, DateTime asofdate, ICurrencyReporter reporter, bool mostRecent)\r\n    {\r\n      Dictionary<CharacteristicTypes, object> traitDict = new();\r\n      foreach (Characteristic chr in traits)\r\n      {\r\n        traitDict.Add(chr.What, GetCharacteristic(chr.What, asofdate, reporter, mostRecent));\r\n      }\r\n      return traitDict;\r\n    }\r\n\r\n    public void LoadConstituentReturns()\r\n    {\r\n      foreach (GroupReturn rd in Returns)\r\n        rd.LazyLoad<ReturnData, Return>(r => r.Returns);\r\n      //Switched ((IScheme)this).Investments to ((IScheme)this).Portfolio.Investments because Groups composed of Accounts have and an empty Investments collection\r\n      foreach (Investment inv in ((IScheme)this).Portfolio.Investments)\r\n        inv.LoadConstituentReturns();\r\n      LoadAllBalances();\r\n      Antecedent?.LoadConstituentReturns();\r\n      Liability?.LoadAll();\r\n    }\r\n\r\n    #endregion\r\n\r\n    #region IBalanceOwner Implementation\r\n    //TODO: What if Portfolio has PortfolioAccountTargets?\r\n    public List<Target> SchemeTargets => Portfolio.PortfolioTargets.Where(t => Investments.Contains(t.Investment)).ToList<Target>();\r\n    public double? RedirectedTarget(IRebalanceItem irc, DateTime date)\r\n    {\r\n      DateTime? dt1 = null;\r\n      TargetAdjust trgt = null;\r\n      if (((IRebalanceOwner)this).Contains(irc))\r\n      {\r\n        if (Portfolio.SchemeTargets.Any())\r\n        {\r\n          dt1 = Portfolio.SchemeTargets.Where(t => t.AsOfDate <= date).Max(t => t.AsOfDate);\r\n          trgt = irc.RedirectedTargetsFor(this).SingleOrDefault(t => t.AsOfDate == dt1);\r\n          return trgt?.TargetPct;\r\n        }\r\n        else\r\n          return Portfolio.ImputedTarget(irc, date);\r\n      }\r\n      return null;\r\n    }\r\n\r\n    IEnumerable<Balance> IBalanceOwner.Balances => Balances.Cast<Balance>();\r\n    ObservableCollection<Investment> IScheme.Investments\r\n    {\r\n      get\r\n      {\r\n        if (IsInvestmentGroup)\r\n          return Investments;\r\n        return new ObservableCollection<Investment>(Accounts.SelectMany(a => a.Investments).Distinct());\r\n      }\r\n    }\r\n\r\n    private IEnumerable<Balance> _BalanceList = null;\r\n    private DateTime _BalanceListRefreshed = DateTime.MinValue;\r\n    public IEnumerable<Balance> BalanceList => this.RefreshBalanceList(ref _BalanceList, ref _BalanceListRefreshed);\r\n\r\n    public IEnumerable<Balance> HoldingBalances\r\n    {\r\n      get\r\n      { //CHANGED 04/12/2017 TO HANDLE Antecedent\r\n        var myHoldingBals = Balances.Where(b => b.EndDate > (CalcDate ?? DateTime.MinValue)).SelectMany(b => b.HoldingBalances).ToList();\r\n        if (Antecedent != null)\r\n        {\r\n          if (Spinoff)\r\n            return myHoldingBals.Union(Antecedent.HoldingBalances.Where(b => b.EndDate < MinBalanceDate));\r\n          if (Consolidation)\r\n            return myHoldingBals.Union(Antecedent.HoldingBalances);\r\n        }\r\n        return myHoldingBals;\r\n      }\r\n    }\r\n\r\n    public IEnumerable<Balance> CompleteHoldingBalances\r\n    {\r\n      get\r\n      { //CHANGED FROM Balances to BalanceList 4/12/2017 to handle Antecedent\r\n        List<DateTime> complete = BalanceList.Where(b => b.EndMV > 0 && Math.Abs(b.ChildrenEMVs() - b.EndMV) <= 1).Select(b => b.EndDate).ToList();\r\n\r\n        return HoldingBalances.Where(b => complete.Contains(b.EndDate));\r\n      }\r\n    }\r\n\r\n    public string BalanceErrors\r\n    {\r\n      get\r\n      {\r\n        if (Inception == null)\r\n          return \"No Data!\\n\";\r\n        return string.Empty;\r\n      }\r\n    }\r\n\r\n    IEnumerable<Synthetic> IScheme.Policies => Policies as IEnumerable<Synthetic>;\r\n    IEnumerable<Composition> IScheme.Compositions => Compositions as IEnumerable<Composition>;\r\n    IEnumerable<CustodianHistory> IScheme.CustodianHistory => Portfolio.CustodianHistory;\r\n    public bool CanEditCustodians => false;\r\n    public bool HasInactives => false;\r\n    public string BestSchemeID => null;\r\n\r\n    #endregion\r\n\r\n    public FrequencyType? SmartStatementFreq\r\n    {\r\n      get => Portfolio?.StatementFreq; set { }\r\n    }\r\n\r\n    public Custodian Custodian => Portfolio.Custodian;\r\n    public double? Assets { get; set; }  //Stores assets from last call to AssetsOn()\r\n    public DateTime? AssetsDate { get; set; } //Stores asset date from last call to AssetsOn()\r\n    public double? AssetsOn(DateTime date, bool? presumeActive = null, int round = 2)\r\n    {\r\n      Balance newest;\r\n      if (!(presumeActive ?? false))\r\n        newest = Balances.Where(b => b.EndDate <= date).OrderByDescending(b => b.EndDate).FirstOrDefault();\r\n      else\r\n        newest = Portfolio.Balances.Where(b => b.EndDate <= date).OrderByDescending(b => b.EndDate).FirstOrDefault();\r\n\r\n      if (newest == null)\r\n      {\r\n        AssetsDate = null;\r\n        Assets = 0;\r\n      }\r\n      else\r\n      {\r\n        AssetsDate = newest.EndDate;\r\n        Assets = Balances.Where(b => b.EndDate == newest.EndDate).Select(b => b.EndMV).SingleOrDefault(); \r\n      }\r\n      return Assets != null ? Math.Round(Assets ?? 0, round) : Assets;\r\n    }\r\n\r\n    public DateTime? MaxBalanceDate\r\n    {\r\n      get\r\n      {\r\n        LoadBalances();\r\n        Balance bal = Balances.OrderByDescending(b => b.EndDate).FirstOrDefault();\r\n        return bal?.EndDate;\r\n      }\r\n    }\r\n\r\n    public DateTime? MinBalanceDate\r\n    {\r\n      get\r\n      {\r\n        Balance bal = Balances.OrderBy(b => b.EndDate).FirstOrDefault();\r\n        return bal?.EndDate;\r\n      }\r\n    }\r\n\r\n    public string FullName => Portfolio.Name + \": \" + Name + ((Name != null && Name.ToUpper().IndexOf(\"GROUP\") > -1) ? string.Empty : \" Group\");\r\n\r\n    public string PathName => FullName;\r\n\r\n    public IEnumerable<HoldingExport> HoldingsExport(DateTime fromDate)\r\n    {\r\n      return this.HoldingsExport(fromDate, false, false);\r\n    }\r\n\r\n    public IEnumerable<HoldingExport> BenchmarkHoldingsExport(DateTime fromDate)\r\n    {\r\n      return this.HoldingsExport(fromDate, false, true);\r\n    }\r\n\r\n    partial void OnNameChanged()\r\n    {\r\n      if(GroupConcerns ==  null) return;\r\n      foreach (GroupConcern _groupConcern in GroupConcerns)\r\n        _groupConcern.NotifyPropertyChanged(nameof(Concern.SmartFormal));\r\n    }\r\n\r\n    public List<Concern> GetConcerns(Report rpt)\r\n    {\r\n      var concerns = Returns.Select(r => new GroupConcern(r, this.GetBestReturnData(r.Slice, false, true, \"\", false), this, rpt))\r\n        .Union<Concern>(BenchmarkReturns.Select(r => new SchemeBenchmarkConcern(r, rpt)));\r\n      if (Liability != null)\r\n        concerns = concerns.Union(Liability.Returns.Select(r => new LiabilityConcern(r, N ?? 0, rpt)));\r\n      return concerns.ToList<Concern>();\r\n    }\r\n\r\n    public Domiciles? Domicile => Portfolio.Domicile;\r\n\r\n    public Domiciles? SmartDomicile\r\n    {\r\n      get => Portfolio.SmartDomicile;\r\n      set => Portfolio.SmartDomicile = value;\r\n    }\r\n\r\n    public Universes Universe\r\n    {\r\n      get\r\n      {\r\n        Universes univ = Universes.Unknown;\r\n        foreach (Investment inv in ((IScheme)this).Investments) //This ensures it works for Account Groups too\r\n          univ = univ | inv.Universe;\r\n        if ((univ & ~Universes.MM) > Universes.Unknown)\r\n          univ &= ~Universes.MM;\r\n        return univ;\r\n      }\r\n    }\r\n\r\n    public Model Model { get => null; set { } }\r\n\r\n    public ICollection<GroupBalance> SmartBalances\r\n    {\r\n      get\r\n      {\r\n        LoadBalances();\r\n        return Balances;\r\n      }\r\n\r\n    }\r\n\r\n    public void LoadBalances()\r\n    {\r\n      LazyLoad<Group, GroupBalance>(g => g.Balances);\r\n      Antecedent?.LoadAllBalances();\r\n    }\r\n\r\n    public void LoadHoldingBalances(List<DateTime> endDates)\r\n    {\r\n      foreach (GroupBalance gb in Balances.Where(b => endDates.Contains(b.EndDate)))\r\n        gb.LazyLoad<GroupBalance, GroupHoldingBalance>(g => g.HoldingBalances);\r\n    }\r\n\r\n    public void LoadAllBalances()\r\n    {\r\n      LoadBalances();\r\n      foreach (var hld in Holdings)\r\n        hld.LazyLoad<GroupHolding, GroupHoldingBalance>(g => g.GroupHoldingBalances);\r\n    }\r\n\r\n    public string ShortNameOrName => ShortName ?? Name;\r\n    int IOrdered.N\r\n    {\r\n      get => N ?? 0; set => N = value;\r\n    }\r\n\r\n    partial void OnNChanged()\r\n    {\r\n      NotifyPropertyChanged(nameof(SortBy));\r\n    }\r\n\r\n    public string SortBy => \"G:\" + ((N == null) ? Name : $\"{N:D3}\");\r\n    public bool HasAncestor(Group grp)\r\n    {\r\n      if (grp == this || grp == Parent)\r\n        return true;\r\n      else if(Parent != null)\r\n        return Parent.HasAncestor(grp);\r\n      return false;\r\n    }\r\n\r\n\r\n    public object Clone()\r\n    {\r\n      Group grp = new Group().Init() as Group;\r\n      grp.Name = this.Name + \" Copy\";\r\n      grp.ParentID = this.ParentID;\r\n      grp.ShortName = this.ShortName;\r\n      grp.StartDate = this.StartDate;\r\n      grp.CalcDate = this.CalcDate;\r\n      grp.EndDate = this.EndDate;\r\n      grp.Comment = this.Comment;\r\n      grp.MSDPortfolioID = this.MSDPortfolioID + \"xCOPY\";\r\n      grp.Special = this.Special;\r\n      grp.BackfillWithDate = this.BackfillWithDate;\r\n      grp.OfferingID = this.OfferingID;\r\n      grp.RebalGroup = this.RebalGroup;\r\n      grp.FeeTableID = this.FeeTableID;\r\n      grp.Footnote = this.Footnote;\r\n      grp.N = this.N;\r\n\r\n      foreach (Investment inv in this.Investments)\r\n        grp.Investments.Add(inv);\r\n\r\n      foreach (Account acct in Accounts)\r\n        grp.Accounts.Add(acct);\r\n\r\n      return grp;\r\n    }\r\n    IEnumerable<IScheme> IScheme.Descendants => Descendants.Cast<IScheme>();\r\n    IScheme IScheme.Antecedent\r\n    {\r\n      get => Antecedent;\r\n      set => Antecedent = value as Group;\r\n    }\r\n\r\n    public ICollection<GroupLiability> SmartLiabilities\r\n    {\r\n      get\r\n      {\r\n        LazyLoad<Group, GroupLiability>(p => p.Liabilities);\r\n        return Liabilities;\r\n      }\r\n    }\r\n\r\n    Liability _Liability;\r\n    public Liability Liability\r\n    {\r\n      get => _Liability ??= SmartLiabilities.FirstOrDefault();\r\n      set\r\n      {\r\n        if (_Liability != value)\r\n        {\r\n          _Liability = value;\r\n          NotifyPropertyChanged(nameof(Liability));\r\n          NotifyPropertyChanged(nameof(SmartLiability));\r\n        }\r\n      }\r\n    }\r\n\r\n    public Liability SmartLiability => Liability ?? Portfolio.Liability;\r\n    \r\n    public ReturnStream LiabilityRS { get; set; }\r\n    public ReturnStream AssetRS { get; set; }\r\n\r\n    public bool CanCalculate => true;\r\n\r\n    public void CreateUpdatePolicy(IEnumerable<IInvestmentTarget> selected = null)\r\n    {\r\n      if (selected == null) selected = Portfolio.PortfolioTargets;\r\n      GroupPolicy gp = MainPolicy;\r\n      DateTime fromDate = selected?.Min(t => t.AsOfDate ?? DateTime.MinValue) ?? SchemeTargets.Min(t => t.AsOfDate ?? DateTime.MinValue);\r\n      if (gp == null)\r\n        gp = new GroupPolicy().Init(this);\r\n      else\r\n        gp.DeleteDetail(fromDate);\r\n\r\n      var prcnts = from g in selected\r\n        where g.AsOfDate != null && g.TargetPct > 0\r\n        group g by new { g.AsOfDate, g.Investment.Benchmark } into bg\r\n        select new { date = bg.Key.AsOfDate, benchmark = bg.Key.Benchmark ?? Index.GetDefaultReturnData(SmartCurrencyCode, BroadAssetClass.Cash), percentage = bg.Sum(b => b.TargetPct) };\r\n\r\n      foreach (var grp in prcnts)\r\n      {\r\n        SyntheticDetail sd = new(gp, grp.date ?? DateTime.MinValue);\r\n        sd.ReturnData = grp.benchmark;\r\n        sd.ReturnDataID = grp.benchmark.ReturnDataID;\r\n        sd.Pct = grp.percentage;\r\n      }\r\n\r\n    }\r\n\r\n    public ICollection<GroupObligationStream> SmartObligationStreams\r\n    {\r\n      get\r\n      {\r\n        LazyLoad<Group, GroupObligationStream>(p => p.ObligationStreams);\r\n        return ObligationStreams;\r\n      }\r\n    }\r\n\r\n    IEnumerable<ObligationStream> IScheme.ObligationStreams => ObligationStreams;\r\n    IEnumerable<ObligationStream> IScheme.SmartObligationStreams => SmartObligationStreams;\r\n    public bool IsParticipantDirected => Portfolio.IsParticipantDirected;\r\n\r\n    public override ReloadDirection ReloadPropDirection(string navProp)\r\n    {\r\n      switch (navProp)\r\n      {\r\n        case nameof(Portfolio):\r\n        case nameof(GroupConcerns):\r\n          return ReloadDirection.Parent;\r\n        case nameof(Balances):\r\n        case nameof(Returns):\r\n        case nameof(Policies):\r\n        case nameof(BenchmarkReturns):\r\n        case nameof(Compositions):\r\n        case nameof(ObligationStreams):\r\n        case nameof(Liabilities):\r\n        case nameof(RebalancingGroup):\r\n        case nameof(Investments):\r\n        case nameof(Accounts):\r\n        case nameof(EqualWeights):\r\n          return ReloadDirection.Child;\r\n      }\r\n      return base.ReloadPropDirection(navProp);\r\n    }\r\n    public bool HasGross => Returns.Any(r => r.Gross);\r\n    public bool HasNet => Returns.Any(r => !r.Gross);\r\n    public void LoadReturns()\r\n    {\r\n      LazyLoad<Group, GroupReturn>(s => s.Returns);\r\n    }\r\n\r\n    partial void OnEndDateChanged()\r\n    {\r\n      NotifyPropertyChanged(nameof(SmartEndDate));\r\n    }\r\n\r\n    public DateTime? SmartEndDate\r\n    {\r\n      get => _EndDate;\r\n      set\r\n      {\r\n        if (value != _EndDate)\r\n        {\r\n          EndDate = value;\r\n          NotifyPropertyChanged(nameof(Active));\r\n        }\r\n      }\r\n    }\r\n\r\n    public string CustPlanID => Portfolio?.CustPlanID;\r\n  }\r\n}\r\n\r\n```\r\n\r\n### Include stack traces\r\n```\r\nSystem.InvalidOperationException\r\n  HResult=0x80131509\r\n  Message=The convention invocations have reached the recursion limit. This is likely an issue in Entity Framework, please file an issue at https://go.microsoft.com/fwlink/?linkid=2142044.\r\n  Source=Microsoft.EntityFrameworkCore\r\n  StackTrace:\r\n   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.ConventionBatch.Run()\r\n   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.ConventionBatch.Dispose()\r\n   at Microsoft.EntityFrameworkCore.Metadata.Internal.InternalModelBuilder.Entity(TypeIdentity& type, ConfigurationSource configurationSource, Nullable`1 shouldBeOwned)\r\n   at Microsoft.EntityFrameworkCore.Metadata.Internal.InternalModelBuilder.Entity(Type type, ConfigurationSource configurationSource, Nullable`1 shouldBeOwned)\r\n   at Microsoft.EntityFrameworkCore.Metadata.Builders.EntityTypeBuilder.FindRelatedEntityType(Type relatedType, String navigationName)\r\n   at Microsoft.EntityFrameworkCore.Metadata.Builders.EntityTypeBuilder`1.HasMany[TRelatedEntity](Expression`1 navigationExpression)\r\n   at HCAEntities.Models.HighlandEntities.<>c.<OnModelCreating>b__571_48(EntityTypeBuilder`1 entity) in C:\\Users\\randa\\Highland Capital Dropbox\\Randall Doser\\Visual Studio\\Projects\\HiPRA2\\HCAEntities\\Models\\HighlandEntities.cs:line 873\r\n   at Microsoft.EntityFrameworkCore.ModelBuilder.Entity[TEntity](Action`1 buildAction)\r\n   at HCAEntities.Models.HighlandEntities.OnModelCreating(ModelBuilder modelBuilder) in C:\\Users\\randa\\Highland Capital Dropbox\\Randall Doser\\Visual Studio\\Projects\\HiPRA2\\HCAEntities\\Models\\HighlandEntities.cs:line 856\r\n   at Microsoft.EntityFrameworkCore.Infrastructure.ModelCustomizer.Customize(ModelBuilder modelBuilder, DbContext context)\r\n   at Microsoft.EntityFrameworkCore.Infrastructure.ModelSource.CreateModel(DbContext context, IConventionSetBuilder conventionSetBuilder, ModelDependencies modelDependencies)\r\n   at Microsoft.EntityFrameworkCore.Infrastructure.ModelSource.GetModel(DbContext context, ModelCreationDependencies modelCreationDependencies, Boolean designTime)\r\n   at Microsoft.EntityFrameworkCore.Internal.DbContextServices.CreateModel(Boolean designTime)\r\n   at Microsoft.EntityFrameworkCore.Internal.DbContextServices.get_Model()\r\n   at Microsoft.EntityFrameworkCore.Infrastructure.EntityFrameworkServicesBuilder.<>c.<TryAddCoreServices>b__8_4(IServiceProvider p)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitFactory(FactoryCallSite factoryCallSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.Resolve(ServiceCallSite callSite, ServiceProviderEngineScope scope)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.DynamicServiceProviderEngine.<>c__DisplayClass2_0.<RealizeService>b__0(ServiceProviderEngineScope scope)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceProvider.GetService(ServiceIdentifier serviceIdentifier, ServiceProviderEngineScope serviceProviderEngineScope)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.ServiceProviderEngineScope.GetService(Type serviceType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService(IServiceProvider provider, Type serviceType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService[T](IServiceProvider provider)\r\n   at Microsoft.EntityFrameworkCore.DbContext.get_DbContextDependencies()\r\n   at Microsoft.EntityFrameworkCore.DbContext.get_ContextServices()\r\n   at Microsoft.EntityFrameworkCore.DbContext.get_InternalServiceProvider()\r\n   at Microsoft.EntityFrameworkCore.DbContext.get_ChangeTracker()\r\n   at HCAEntities.Models.HighlandEntities..ctor(ConnectionMethod cm) in C:\\Users\\randa\\Highland Capital Dropbox\\Randall Doser\\Visual Studio\\Projects\\HiPRA2\\HCAEntities\\HighlandModelPartial.cs:line 190\r\n   at HCAEntities.Models.HighlandEntities.get_Context() in C:\\Users\\randa\\Highland Capital Dropbox\\Randall Doser\\Visual Studio\\Projects\\HiPRA2\\HCAEntities\\HighlandModelPartial.cs:line 125\r\n   at HiPRA.ReportsWindow.get_Context() in C:\\Users\\randa\\Highland Capital Dropbox\\Randall Doser\\Visual Studio\\Projects\\HiPRA2\\HiPRA\\ReportsWindow.xaml.cs:line 169\r\n   at HiPRA.ReportsWindow..ctor(Window login) in C:\\Users\\randa\\Highland Capital Dropbox\\Randall Doser\\Visual Studio\\Projects\\HiPRA2\\HiPRA\\ReportsWindow.xaml.cs:line 195\r\n   at HiPRA.LoginDialog.btnLogin_Click(Object sender, RoutedEventArgs e) in C:\\Users\\randa\\Highland Capital Dropbox\\Randall Doser\\Visual Studio\\Projects\\HiPRA2\\HiPRA\\LoginDialog.xaml.cs:line 114\r\n\r\n  This exception was originally thrown at this call stack:\r\n    [External Code]\r\n    HCAEntities.Models.HighlandEntities.OnModelCreating.AnonymousMethod__571_48(Microsoft.EntityFrameworkCore.Metadata.Builders.EntityTypeBuilder<HCAEntities.Models.Group>) in HighlandEntities.cs\r\n    [External Code]\r\n    HCAEntities.Models.HighlandEntities.OnModelCreating(Microsoft.EntityFrameworkCore.ModelBuilder) in HighlandEntities.cs\r\n    [External Code]\r\n    HCAEntities.Models.HighlandEntities.HighlandEntities(HCAEntities.Models.ConnectionMethod) in HighlandModelPartial.cs\r\n    HCAEntities.Models.HighlandEntities.Context.get() in HighlandModelPartial.cs\r\n    HiPRA.ReportsWindow.Context.get() in ReportsWindow.xaml.cs\r\n    HiPRA.ReportsWindow.ReportsWindow(System.Windows.Window) in ReportsWindow.xaml.cs\r\n    HiPRA.LoginDialog.btnLogin_Click(object, System.Windows.RoutedEventArgs) in LoginDialog.xaml.cs\r\n```\r\n\r\n### Include provider and version information\r\n\r\nEF Core version: 8.0.3\r\nDatabase provider:  Microsoft.EntityFrameworkCore.SqlServer\r\nTarget framework: .NET 8.0\r\nOperating system: Windows 10.0022631 Build 22631\r\nIDE: Visual Studio 2022 17.9.2\r\n","closed_by":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/33327/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/33327/timeline","performed_via_github_app":null,"state_reason":"completed"}