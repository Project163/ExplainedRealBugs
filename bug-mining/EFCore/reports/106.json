{"url":"https://api.github.com/repos/dotnet/efcore/issues/27918","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/27918/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/27918/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/27918/events","html_url":"https://github.com/dotnet/efcore/issues/27918","id":1221586719,"node_id":"I_kwDOAPaMMs5Iz-8f","number":27918,"title":"Changes in parent owned collection cause unexpected behavior in nested owned collection","user":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1686778100,"node_id":"MDU6TGFiZWwxNjg2Nzc4MTAw","url":"https://api.github.com/repos/dotnet/efcore/labels/area-cosmos","name":"area-cosmos","color":"32b37b","default":false,"description":""},{"id":1901166749,"node_id":"MDU6TGFiZWwxOTAxMTY2NzQ5","url":"https://api.github.com/repos/dotnet/efcore/labels/area-change-tracking","name":"area-change-tracking","color":"32b37b","default":false,"description":""},{"id":3281025791,"node_id":"MDU6TGFiZWwzMjgxMDI1Nzkx","url":"https://api.github.com/repos/dotnet/efcore/labels/priority-bug","name":"priority-bug","color":"1E3932","default":false,"description":"Issues which requires API breaks and have bigger impact hence should be fixed earlier in the release"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/128","html_url":"https://github.com/dotnet/efcore/milestone/128","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/128/labels","id":7236796,"node_id":"MI_kwDOAPaMMs4Abmy8","number":128,"title":"7.0.0","description":"EF Core 7.0","creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":375,"state":"closed","created_at":"2021-10-09T18:57:40Z","updated_at":"2024-11-13T16:14:22Z","due_on":null,"closed_at":"2022-11-05T18:37:45Z"},"comments":4,"created_at":"2022-04-29T21:50:17Z","updated_at":"2025-06-15T18:46:55Z","closed_at":"2022-09-09T18:20:07Z","author_association":"MEMBER","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"In the following scenario the `Toy` is not deleted:\r\n\r\n```\r\nvar options = Fixture.CreateOptions(seed: false);\r\nusing (var context = new LiveSiteDbContext(options))\r\n{\r\n    context.Database.EnsureCreatedResiliently();\r\n    var family = new Family\r\n    {\r\n        Id = \"familyId\",\r\n        PartitionKey = \"partitionA\",\r\n        Kids = new List<Kid> { new Kid { Toys = new List<Toy> { new Toy() } } }\r\n    };\r\n    context.Families.Add(family);\r\n\r\n    await context.SaveChangesAsync();\r\n}\r\n\r\nusing (var context = new LiveSiteDbContext(options))\r\n{\r\n    var family = await context.Families.Where(f => f.Id == \"familyId\").FirstOrDefaultAsync();\r\n\r\n    var newKid = new Kid\r\n    {\r\n        Toys = new List<Toy>()\r\n    };\r\n    family.Kids.First().Name = \"name changedd\";\r\n    family.Kids.Add(newKid);\r\n    family.Kids.First().Toys.RemoveAt(0);\r\n    family.Kids.First().Toys.Add(new Toy());\r\n    family.Kids.First().Toys.Add(new Toy());\r\n            \r\n    await context.SaveChangesAsync();\r\n}\r\n\r\nusing (var context = new LiveSiteDbContext(options))\r\n{\r\n    var family = await context.Families.Where(f => f.Id == \"familyId\").FirstOrDefaultAsync();\r\n    Assert.Equal(2, family.Kids.First().Toys.Count); // This is 3\r\n}\r\n```\r\n\r\n<details>\r\n<summary>Model</summary>\r\n\r\n```C#\r\n\r\npublic class LiveSiteDbContext : DbContext\r\n{        \r\n    public DbSet<Family> Families { get; set; }\r\n\r\n\r\n    public LiveSiteDbContext(DbContextOptions options) : base(options)\r\n    {\r\n    }\r\n\r\n    protected override void OnModelCreating(ModelBuilder builder)\r\n    {\r\n        builder.Entity<Family>(b =>\r\n        {\r\n            b.HasNoDiscriminator()\r\n                .HasPartitionKey(s => s.PartitionKey)\r\n                .HasKey(s => new { s.Id, s.PartitionKey });\r\n\r\n            b.Property(s => s.Id).ToJsonProperty(\"id\");\r\n\r\n            b.OwnsMany(s => s.Kids, kb =>\r\n            {\r\n                kb.OwnsMany(k => k.Toys, tb => {\r\n                    tb.HasKey(t => t.ToyId);\r\n                });\r\n            });\r\n        });\r\n    }\r\n}\r\n    \r\npublic class Family\r\n{\r\n    public string Id { get; set; }\r\n    public string PartitionKey { get; set; }\r\n    public string Name { get; set; }\r\n\r\n    public ICollection<Kid> Kids { get; set; }\r\n}\r\n\r\npublic class Kid\r\n{\r\n    public string Name { get; set; }\r\n\r\n    public List<Toy> Toys { get; set; }\r\n}\r\n\r\npublic class Toy\r\n{\r\n    public string ToyId { get; set; }\r\n    public string Name { get; set; }\r\n\r\n    public Toy()\r\n    {\r\n        ToyId = Guid.NewGuid().ToString();\r\n        Name = \"New Toy\";\r\n    }\r\n}\r\n```\r\n\r\n</details>\r\n\r\nAdditionally if `Toy.ToyId` is removed the following exception is thrown:\r\n\r\n<details>\r\n<summary>InvalidOperationException</summary>\r\n\r\n>   System.InvalidOperationException : The property 'Toy.KidId' is part of a key and so cannot be modified or marked as modified. To change the principal of an existing entity with an identifying foreign key, first delete the dependent and invoke 'SaveChanges', and then associate the dependent with the new principal.\r\nChangeDetector.ThrowIfKeyChanged(InternalEntityEntry entry, IProperty property) line 74\r\nChangeDetector.PropertyChanged(InternalEntityEntry entry, IPropertyBase propertyBase, Boolean setModified) line 57\r\nInternalEntityEntryNotifier.PropertyChanged(InternalEntityEntry entry, IPropertyBase property, Boolean setModified) line 115\r\nInternalEntityEntry.SetProperty(IPropertyBase propertyBase, Object value, Boolean isMaterialization, Boolean setModified, Boolean isCascadeDelete, CurrentValueType valueType) line 1351\r\nInternalEntityEntry.SetTemporaryValue(IProperty property, Object value, Boolean setModified) line 706\r\nInternalEntityEntry.PropagateValue(InternalEntityEntry principalEntry, IProperty principalProperty, IProperty dependentProperty, Boolean isMaterialization, Boolean setModified) line 636\r\nNavigationFixer.SetForeignKeyProperties(InternalEntityEntry dependentEntry, InternalEntityEntry principalEntry, IForeignKey foreignKey, Boolean setModified, Boolean fromQuery) line 1254\r\nNavigationFixer.KeyPropertyChanged(InternalEntityEntry entry, IProperty property, IEnumerable`1 containingPrincipalKeys, IEnumerable`1 containingForeignKeys, Object oldValue, Object newValue) line 524\r\nInternalEntityEntryNotifier.KeyPropertyChanged(InternalEntityEntry entry, IProperty property, IEnumerable`1 keys, IEnumerable`1 foreignKeys, Object oldValue, Object newValue) line 106\r\nChangeDetector.DetectKeyChange(InternalEntityEntry entry, IProperty property) line 270\r\nChangeDetector.PropertyChanged(InternalEntityEntry entry, IPropertyBase propertyBase, Boolean setModified) line 60\r\nInternalEntityEntryNotifier.PropertyChanged(InternalEntityEntry entry, IPropertyBase property, Boolean setModified) line 115\r\nInternalEntityEntry.SetProperty(IPropertyBase propertyBase, Object value, Boolean isMaterialization, Boolean setModified, Boolean isCascadeDelete, CurrentValueType valueType) line 1351\r\nInternalEntityEntry.SetTemporaryValue(IProperty property, Object value, Boolean setModified) line 706\r\nDocumentSource.UpdateDocument(JObject document, IUpdateEntry entry, Nullable`1 ordinal) line 268\r\nDocumentSource.UpdateDocument(JObject document, IUpdateEntry entry) line 149\r\nCosmosDatabaseWrapper.SaveAsync(IUpdateEntry entry, CancellationToken cancellationToken) line 284\r\nCosmosDatabaseWrapper.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken) line 167\r\nStateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken) line 1125\r\nStateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken) line 1224\r\n<<ExecuteAsync>b__0>d.MoveNext() line 311\r\n\r\n</details>\r\n\r\nCould be related to https://github.com/dotnet/efcore/issues/28600","closed_by":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/27918/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/27918/timeline","performed_via_github_app":null,"state_reason":"completed"}