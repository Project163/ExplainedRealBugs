{"url":"https://api.github.com/repos/dotnet/efcore/issues/33858","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/33858/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/33858/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/33858/events","html_url":"https://github.com/dotnet/efcore/issues/33858","id":2326669746,"node_id":"I_kwDOAPaMMs6Krimy","number":33858,"title":"Cosmos: bad SQL generated when projecting out \"Value\"","user":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1675384372,"node_id":"MDU6TGFiZWwxNjc1Mzg0Mzcy","url":"https://api.github.com/repos/dotnet/efcore/labels/area-query","name":"area-query","color":"32b37b","default":false,"description":""},{"id":1686778100,"node_id":"MDU6TGFiZWwxNjg2Nzc4MTAw","url":"https://api.github.com/repos/dotnet/efcore/labels/area-cosmos","name":"area-cosmos","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/180","html_url":"https://github.com/dotnet/efcore/milestone/180","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/180/labels","id":9963267,"node_id":"MI_kwDOAPaMMs4AmAcD","number":180,"title":"9.0.0","description":null,"creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":339,"state":"closed","created_at":"2023-09-25T15:41:58Z","updated_at":"2025-04-01T18:19:15Z","due_on":null,"closed_at":"2024-11-14T11:54:05Z"},"comments":2,"created_at":"2024-05-30T23:04:39Z","updated_at":"2025-06-15T20:03:56Z","closed_at":"2024-06-05T08:04:16Z","author_association":"CONTRIBUTOR","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"query:\r\n\r\n```\r\nss.Set<Customer>().Select(c => new { Id = c.CustomerID, Value = c.CompanyName.Contains(c.ContactName) })\r\n```\r\n\r\n\r\nSql we generate:\r\n\r\n```\r\nSELECT c[\"CustomerID\"] AS Id, CONTAINS(c[\"CompanyName\"], c[\"ContactName\"]) AS Value\r\nFROM root c\r\nWHERE (c[\"Discriminator\"] = \"Customer\")\r\n```\r\n\r\n\r\nresult:\r\n\r\n```\r\nMessage: \r\nMicrosoft.Azure.Cosmos.CosmosException : Response status code does not indicate success: BadRequest (400); Substatus: 0; ActivityId: ; Reason: (Response status code does not indicate success: BadRequest (400); Substatus: 0; ActivityId: ; Reason: ({\"errors\":[{\"severity\":\"Error\",\"location\":{\"start\":78,\"end\":83},\"code\":\"SC1001\",\"message\":\"Syntax error, incorrect syntax near 'Value'.\"}]}););\r\n---- Microsoft.Azure.Cosmos.Query.Core.Exceptions.ExpectedQueryPartitionProviderException : {\"errors\":[{\"severity\":\"Error\",\"location\":{\"start\":78,\"end\":83},\"code\":\"SC1001\",\"message\":\"Syntax error, incorrect syntax near 'Value'.\"}]}\r\n-------- System.Runtime.InteropServices.COMException : 0x800A0B00\r\n\r\n  Stack Trace: \r\nQueryPartitionProvider.TryGetPartitionedQueryExecutionInfo(String querySpecJsonString, PartitionKeyDefinition partitionKeyDefinition, Boolean requireFormattableOrderByQuery, Boolean isContinuationExpected, Boolean allowNonValueAggregateQuery, Boolean hasLogicalPartitionKey, Boolean allowDCount, Boolean useSystemPrefix, GeospatialType geospatialType)\r\nCosmosQueryClientCore.TryGetPartitionedQueryExecutionInfoAsync(SqlQuerySpec sqlQuerySpec, ResourceType resourceType, PartitionKeyDefinition partitionKeyDefinition, Boolean requireFormattableOrderByQuery, Boolean isContinuationExpected, Boolean allowNonValueAggregateQuery, Boolean hasLogicalPartitionKey, Boolean allowDCount, Boolean useSystemPrefix, GeospatialType geospatialType, CancellationToken cancellationToken)\r\nAsyncMethodBuilderCore.Start[TStateMachine](TStateMachine& stateMachine)\r\nCosmosQueryClientCore.TryGetPartitionedQueryExecutionInfoAsync(SqlQuerySpec sqlQuerySpec, ResourceType resourceType, PartitionKeyDefinition partitionKeyDefinition, Boolean requireFormattableOrderByQuery, Boolean isContinuationExpected, Boolean allowNonValueAggregateQuery, Boolean hasLogicalPartitionKey, Boolean allowDCount, Boolean useSystemPrefix, GeospatialType geospatialType, CancellationToken cancellationToken)\r\nQueryPlanHandler.TryGetQueryInfoAsync(SqlQuerySpec sqlQuerySpec, ResourceType resourceType, PartitionKeyDefinition partitionKeyDefinition, Boolean hasLogicalPartitionKey, Boolean useSystemPrefix, GeospatialType geospatialType, CancellationToken cancellationToken)\r\nQueryPlanHandler.TryGetQueryPlanAsync(SqlQuerySpec sqlQuerySpec, ResourceType resourceType, PartitionKeyDefinition partitionKeyDefinition, QueryFeatures supportedQueryFeatures, Boolean hasLogicalPartitionKey, Boolean useSystemPrefix, GeospatialType geospatialType, CancellationToken cancellationToken)\r\nAsyncMethodBuilderCore.Start[TStateMachine](TStateMachine& stateMachine)\r\nQueryPlanHandler.TryGetQueryPlanAsync(SqlQuerySpec sqlQuerySpec, ResourceType resourceType, PartitionKeyDefinition partitionKeyDefinition, QueryFeatures supportedQueryFeatures, Boolean hasLogicalPartitionKey, Boolean useSystemPrefix, GeospatialType geospatialType, CancellationToken cancellationToken)\r\nQueryPlanRetriever.GetQueryPlanWithServiceInteropAsync(CosmosQueryClient queryClient, SqlQuerySpec sqlQuerySpec, ResourceType resourceType, PartitionKeyDefinition partitionKeyDefinition, Boolean hasLogicalPartitionKey, GeospatialType geospatialType, Boolean useSystemPrefix, ITrace trace, CancellationToken cancellationToken)\r\nAsyncMethodBuilderCore.Start[TStateMachine](TStateMachine& stateMachine)\r\n<32 more frames...>\r\nTask`1.TrySetResult(TResult result)\r\nUnwrapPromise`1.TrySetFromTask(Task task, Boolean lookForOce)\r\nUnwrapPromise`1.ProcessInnerTask(Task task)\r\nTask.RunContinuations(Object continuationObject)\r\nTask.FinishSlow(Boolean userDelegateExecute)\r\nTask.ExecuteWithThreadLocal(Task& currentTaskSlot, Thread threadPoolThread)\r\nThreadPoolWorkQueue.Dispatch()\r\nWorkerThread.WorkerThreadStart()\r\n----- Inner Stack Trace -----\r\n----- Inner Stack Trace -----\r\n\r\n  Standard Output: \r\nCompiling query expression: \r\n'DbSet<Customer>()\r\n    .Select(c => new { \r\n        Id = c.CustomerID, \r\n        Value = c.CompanyName.Contains(c.ContactName)\r\n     })'\r\n\r\nGenerated query execution expression: \r\n'queryContext => new QueryingEnumerable<<>f__AnonymousType71<string, bool>>(\r\n    (CosmosQueryContext)queryContext, \r\n    SqlExpressionFactory, \r\n    QuerySqlGeneratorFactory, \r\n    [Cosmos.Query.Internal.SelectExpression], \r\n    Func<QueryContext, JObject, <>f__AnonymousType71<string, bool>>, \r\n    TestModels.Northwind.NorthwindContext, \r\n    None, \r\n    False, \r\n    True\r\n)'\r\n\r\nExecuting SQL query for container 'NorthwindContext' in partition 'None' [Parameters=[]]\r\nSELECT c[\"CustomerID\"] AS Id, CONTAINS(c[\"CompanyName\"], c[\"ContactName\"]) AS Value\r\nFROM root c\r\nWHERE (c[\"Discriminator\"] = \"Customer\")\r\n\r\nExecuted ReadNext (86.5268 ms, 0 RU) ActivityId='(null)', Container='NorthwindContext', Partition='None', Parameters=[]\r\nSELECT c[\"CustomerID\"] AS Id, CONTAINS(c[\"CompanyName\"], c[\"ContactName\"]) AS Value\r\nFROM root c\r\nWHERE (c[\"Discriminator\"] = \"Customer\")\r\n\r\nAn exception occurred while iterating over the results of a query for context type 'Microsoft.EntityFrameworkCore.TestModels.Northwind.NorthwindContext'.\r\nMicrosoft.Azure.Cosmos.CosmosException : Response status code does not indicate success: BadRequest (400); Substatus: 0; ActivityId: ; Reason: (Response status code does not indicate success: BadRequest (400); Substatus: 0; ActivityId: ; Reason: ({\"errors\":[{\"severity\":\"Error\",\"location\":{\"start\":78,\"end\":83},\"code\":\"SC1001\",\"message\":\"Syntax error, incorrect syntax near 'Value'.\"}]}););\r\n ---> Microsoft.Azure.Cosmos.Query.Core.Exceptions.ExpectedQueryPartitionProviderException: {\"errors\":[{\"severity\":\"Error\",\"location\":{\"start\":78,\"end\":83},\"code\":\"SC1001\",\"message\":\"Syntax error, incorrect syntax near 'Value'.\"}]}\r\n ---> System.Runtime.InteropServices.COMException (0x800A0B00): 0x800A0B00\r\n   --- End of inner exception stack trace ---\r\n\r\n```","closed_by":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/33858/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/33858/timeline","performed_via_github_app":null,"state_reason":"completed"}