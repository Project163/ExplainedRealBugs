{"url":"https://api.github.com/repos/dotnet/efcore/issues/33337","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/33337/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/33337/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/33337/events","html_url":"https://github.com/dotnet/efcore/issues/33337","id":2189915107,"node_id":"I_kwDOAPaMMs6Ch3Pj","number":33337,"title":"EF Core 8.0.3 produces incorrect idempotent migration script","user":{"login":"pekspro","id":3163293,"node_id":"MDQ6VXNlcjMxNjMyOTM=","avatar_url":"https://avatars.githubusercontent.com/u/3163293?v=4","gravatar_id":"","url":"https://api.github.com/users/pekspro","html_url":"https://github.com/pekspro","followers_url":"https://api.github.com/users/pekspro/followers","following_url":"https://api.github.com/users/pekspro/following{/other_user}","gists_url":"https://api.github.com/users/pekspro/gists{/gist_id}","starred_url":"https://api.github.com/users/pekspro/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pekspro/subscriptions","organizations_url":"https://api.github.com/users/pekspro/orgs","repos_url":"https://api.github.com/users/pekspro/repos","events_url":"https://api.github.com/users/pekspro/events{/privacy}","received_events_url":"https://api.github.com/users/pekspro/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":421529609,"node_id":"MDU6TGFiZWw0MjE1Mjk2MDk=","url":"https://api.github.com/repos/dotnet/efcore/labels/Servicing-consider","name":"Servicing-consider","color":"bfd4f2","default":false,"description":""},{"id":514908713,"node_id":"MDU6TGFiZWw1MTQ5MDg3MTM=","url":"https://api.github.com/repos/dotnet/efcore/labels/regression","name":"regression","color":"ff1fff","default":false,"description":null},{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1900942474,"node_id":"MDU6TGFiZWwxOTAwOTQyNDc0","url":"https://api.github.com/repos/dotnet/efcore/labels/area-migrations","name":"area-migrations","color":"32b37b","default":false,"description":""},{"id":2486106824,"node_id":"MDU6TGFiZWwyNDg2MTA2ODI0","url":"https://api.github.com/repos/dotnet/efcore/labels/consider-for-next-release","name":"consider-for-next-release","color":"fef2c0","default":false,"description":""},{"id":3281025791,"node_id":"MDU6TGFiZWwzMjgxMDI1Nzkx","url":"https://api.github.com/repos/dotnet/efcore/labels/priority-bug","name":"priority-bug","color":"1E3932","default":false,"description":"Issues which requires API breaks and have bigger impact hence should be fixed earlier in the release"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/180","html_url":"https://github.com/dotnet/efcore/milestone/180","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/180/labels","id":9963267,"node_id":"MI_kwDOAPaMMs4AmAcD","number":180,"title":"9.0.0","description":null,"creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":339,"state":"closed","created_at":"2023-09-25T15:41:58Z","updated_at":"2025-04-01T18:19:15Z","due_on":null,"closed_at":"2024-11-14T11:54:05Z"},"comments":7,"created_at":"2024-03-16T11:06:09Z","updated_at":"2025-06-15T20:00:19Z","closed_at":"2024-10-16T00:39:46Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"After I updated a library from this:\r\n\r\n```XML\r\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore\" Version=\"8.0.2\" />\r\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.Relational\" Version=\"8.0.2\" />\r\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.SqlServer\" Version=\"8.0.2\" />\r\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.Design\" Version=\"8.0.2\">\r\n```\r\n\r\n\r\nTo this:\r\n\r\n```XML\r\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore\" Version=\"8.0.3\" />\r\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.Relational\" Version=\"8.0.3\" />\r\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.SqlServer\" Version=\"8.0.3\" />\r\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.Design\" Version=\"8.0.3\">\r\n```\r\n\r\nI get incorrect SQL when I'm build migration script. I run this command:\r\n\r\n```\r\ndotnet ef migrations script --startup-project ..\\MyStartUpProject.csproj --context MyDatabaseContext --output migrations.sql --verbose --idempotent\r\n```\r\n\r\nThen I get a large SQL script. Almost everything is correct. But this correct snippet:\r\n\r\n```SQL\r\nIF NOT EXISTS (\r\n    SELECT * FROM [__EFMigrationsHistory]\r\n    WHERE [MigrationId] = N'20200401082009_AddsCustomerGroupTables'\r\n)\r\nBEGIN\r\n    INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])\r\n    VALUES (N'20200401082009_AddsCustomerGroupTables', N'8.0.2');\r\nEND;\r\nGO\r\n```\r\n\r\nIs changed to:\r\n\r\n```SQL\r\nIF NOT EXISTS (\r\n    SELECT * FROM [__EFMigrationsHistory]\r\n    WHERE [MigrationId] = N'20200401082009_AddsCustomerGroupTables'\r\n)\r\nBEGIN\r\n\r\n\r\nEND;\r\nGO\r\n\r\nIF NOT EXISTS (\r\n    SELECT * FROM [__EFMigrationsHistory]\r\n    WHERE [MigrationId] = N'20200401082009_AddsCustomerGroupTables'\r\n)\r\nBEGIN\r\n    INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])\r\n    VALUES (N'20200401082009_AddsCustomerGroupTables', N'8.0.3');\r\nEND;\r\nGO\r\n```\r\n\r\nSomehow, a `BEGIN` followed directly by and `END` is not valid SQL I guess.\r\n\r\nI have checked this migration, and migrations before that, and I do not se anything special.\r\n\r\nUnfortunate, I havenâ€™t been able to reproduce this in a new library and I cannot share the code in public. But I do not mind sharing the code with someone in the team if needed. In my build pipeline I produced 6 migrations script, and only one of these has this problem.\r\n\r\n### Include provider and version information\r\n\r\nEF Core version: 8.0.3 / 8.0.4\r\nDatabase provider: Microsoft.EntityFrameworkCore.SqlServer\r\nTarget framework:  .NET 8.0\r\n","closed_by":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/33337/reactions","total_count":3,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/33337/timeline","performed_via_github_app":null,"state_reason":"completed"}