{"url":"https://api.github.com/repos/dotnet/efcore/issues/31583","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/31583/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/31583/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/31583/events","html_url":"https://github.com/dotnet/efcore/issues/31583","id":1872152276,"node_id":"I_kwDOAPaMMs5vlsbU","number":31583,"title":"FREETEXT search on a ntext column not working ","user":{"login":"sourabh-mehta","id":61746361,"node_id":"MDQ6VXNlcjYxNzQ2MzYx","avatar_url":"https://avatars.githubusercontent.com/u/61746361?v=4","gravatar_id":"","url":"https://api.github.com/users/sourabh-mehta","html_url":"https://github.com/sourabh-mehta","followers_url":"https://api.github.com/users/sourabh-mehta/followers","following_url":"https://api.github.com/users/sourabh-mehta/following{/other_user}","gists_url":"https://api.github.com/users/sourabh-mehta/gists{/gist_id}","starred_url":"https://api.github.com/users/sourabh-mehta/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sourabh-mehta/subscriptions","organizations_url":"https://api.github.com/users/sourabh-mehta/orgs","repos_url":"https://api.github.com/users/sourabh-mehta/repos","events_url":"https://api.github.com/users/sourabh-mehta/events{/privacy}","received_events_url":"https://api.github.com/users/sourabh-mehta/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1675384372,"node_id":"MDU6TGFiZWwxNjc1Mzg0Mzcy","url":"https://api.github.com/repos/dotnet/efcore/labels/area-query","name":"area-query","color":"32b37b","default":false,"description":""},{"id":1901073050,"node_id":"MDU6TGFiZWwxOTAxMDczMDUw","url":"https://api.github.com/repos/dotnet/efcore/labels/area-type-mapping","name":"area-type-mapping","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"bricelam","id":1226749,"node_id":"MDQ6VXNlcjEyMjY3NDk=","avatar_url":"https://avatars.githubusercontent.com/u/1226749?v=4","gravatar_id":"","url":"https://api.github.com/users/bricelam","html_url":"https://github.com/bricelam","followers_url":"https://api.github.com/users/bricelam/followers","following_url":"https://api.github.com/users/bricelam/following{/other_user}","gists_url":"https://api.github.com/users/bricelam/gists{/gist_id}","starred_url":"https://api.github.com/users/bricelam/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bricelam/subscriptions","organizations_url":"https://api.github.com/users/bricelam/orgs","repos_url":"https://api.github.com/users/bricelam/repos","events_url":"https://api.github.com/users/bricelam/events{/privacy}","received_events_url":"https://api.github.com/users/bricelam/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"bricelam","id":1226749,"node_id":"MDQ6VXNlcjEyMjY3NDk=","avatar_url":"https://avatars.githubusercontent.com/u/1226749?v=4","gravatar_id":"","url":"https://api.github.com/users/bricelam","html_url":"https://github.com/bricelam","followers_url":"https://api.github.com/users/bricelam/followers","following_url":"https://api.github.com/users/bricelam/following{/other_user}","gists_url":"https://api.github.com/users/bricelam/gists{/gist_id}","starred_url":"https://api.github.com/users/bricelam/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bricelam/subscriptions","organizations_url":"https://api.github.com/users/bricelam/orgs","repos_url":"https://api.github.com/users/bricelam/repos","events_url":"https://api.github.com/users/bricelam/events{/privacy}","received_events_url":"https://api.github.com/users/bricelam/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/180","html_url":"https://github.com/dotnet/efcore/milestone/180","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/180/labels","id":9963267,"node_id":"MI_kwDOAPaMMs4AmAcD","number":180,"title":"9.0.0","description":null,"creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":339,"state":"closed","created_at":"2023-09-25T15:41:58Z","updated_at":"2025-04-01T18:19:15Z","due_on":null,"closed_at":"2024-11-14T11:54:05Z"},"comments":3,"created_at":"2023-08-29T18:02:41Z","updated_at":"2025-06-15T19:51:03Z","closed_at":"2023-10-26T21:11:00Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## File a bug\r\nThe SQL statement generated by the EF Core (displayed in the logs) for EF.Functions.FreeText function is correct and executes successfully. However, the actual statement that is sent to SQL server is different and throws the error.\r\n\r\nfreeText parameter type for ntext column in SQL statement  is set to a size of 4000 but the SQL statement that is executed on SQL server parameter type is ntext and throws exception.\r\n\r\n### Include your code\r\n\r\nDatabase Table: ComplaintRecommendation\r\n\r\n![image](https://github.com/dotnet/efcore/assets/61746361/7eaad783-1945-4d8f-9f96-f76a106751ff)\r\n\r\n```C#\r\nvar searchText = \"woman\";\r\nExpression<Func<ComplaintRecommendation, bool>> predicate = x => (x.Title != null && EF.Functions.FreeText(x.Title, searchText)) ||\r\n                (x.Recommendation != null && EF.Functions.FreeText(x.Recommendation, searchText));\r\n\r\nContext.Set<ComplaintRecommendation>().AsNoTracking().Where(predicate).ToList();\r\n\r\n```\r\n\r\n### Include stack traces\r\n\r\n```\r\nfail: Microsoft.EntityFrameworkCore.Database.Command[20102]\r\n      Failed executing DbCommand (19ms) [Parameters=[@__searchText_1='woman' (Size = 256), @__searchText_1_1='woman' (Size = 4000)], CommandType='Text', CommandTimeout='30']\r\n      SELECT [c].[Id], [c].[Recommendation], [c].[Title]\r\n      FROM [ComplaintRecommendation] AS [c]\r\n      WHERE (([c].[Title] IS NOT NULL) AND FREETEXT([c].[Title], @__searchText_1)) OR (([c].[Recommendation] IS NOT NULL) AND FREETEXT([c].[Recommendation], @__searchText_1_1))\r\nfail: Microsoft.EntityFrameworkCore.Query[10100]\r\n      An exception occurred while iterating over the results of a query for context type 'ichs.infrastructure.Data.ApplicationDbContext'.\r\n      Microsoft.Data.SqlClient.SqlException (0x80131904): The argument type \"ntext\" is invalid for argument 2 of \"FREETEXT\".\r\n         at Microsoft.Data.SqlClient.SqlCommand.<>c.<ExecuteDbDataReaderAsync>b__208_0(Task`1 result)\r\n         at System.Threading.Tasks.ContinuationResultTaskFromResultTask`2.InnerInvoke()\r\n         at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)\r\n      --- End of stack trace from previous location ---\r\n         at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)\r\n         at System.Threading.Tasks.Task.ExecuteWithThreadLocal(Task& currentTaskSlot, Thread threadPoolThread)\r\n      --- End of stack trace from previous location ---\r\n         at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.InitializeReaderAsync(AsyncEnumerator enumerator, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()\r\n      ClientConnectionId:2e66505f-2b47-40bb-a931-ba260ec16ae9\r\n      Error Number:4110,State:6,Class:16\r\n\r\n```\r\nThe parameter @__searchText_1_1 has size set to 4000 and above statement works if executed on the SQL Server\r\n\r\n### SQL Profiler Trace\r\n\r\n![image](https://github.com/dotnet/efcore/assets/61746361/ab1a5fd8-2e38-4902-883d-348555db8585)\r\n\r\n\r\n### Include provider and version information\r\n\r\nEF Core version: 7.0.10\r\nDatabase provider: Microsoft.EntityFrameworkCore.SqlServer\r\nTarget framework: .NET 7.0\r\nOperating system: Windows 11\r\nSQL Server: Microsoft SQL Server 2022 16.0.1050.5 (X64)   Developer Edition (64-bit)\r\nIDE: Visual Studio 2022 17.6.5\r\n","closed_by":{"login":"bricelam","id":1226749,"node_id":"MDQ6VXNlcjEyMjY3NDk=","avatar_url":"https://avatars.githubusercontent.com/u/1226749?v=4","gravatar_id":"","url":"https://api.github.com/users/bricelam","html_url":"https://github.com/bricelam","followers_url":"https://api.github.com/users/bricelam/followers","following_url":"https://api.github.com/users/bricelam/following{/other_user}","gists_url":"https://api.github.com/users/bricelam/gists{/gist_id}","starred_url":"https://api.github.com/users/bricelam/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bricelam/subscriptions","organizations_url":"https://api.github.com/users/bricelam/orgs","repos_url":"https://api.github.com/users/bricelam/repos","events_url":"https://api.github.com/users/bricelam/events{/privacy}","received_events_url":"https://api.github.com/users/bricelam/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/31583/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/31583/timeline","performed_via_github_app":null,"state_reason":"completed"}