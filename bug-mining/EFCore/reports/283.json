{"url":"https://api.github.com/repos/dotnet/efcore/issues/30373","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/30373/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/30373/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/30373/events","html_url":"https://github.com/dotnet/efcore/issues/30373","id":1604599170,"node_id":"I_kwDOAPaMMs5fpD2C","number":30373,"title":"EF Core and DDD --> .OwnsMany() call on other aggregate root ids (in value object form) throws 'Object reference not set to an instance of an object' when aggregate performing the .OwnsMany() call has its own ids referenced by another aggregate root","user":{"login":"kcindric","id":44549361,"node_id":"MDQ6VXNlcjQ0NTQ5MzYx","avatar_url":"https://avatars.githubusercontent.com/u/44549361?v=4","gravatar_id":"","url":"https://api.github.com/users/kcindric","html_url":"https://github.com/kcindric","followers_url":"https://api.github.com/users/kcindric/followers","following_url":"https://api.github.com/users/kcindric/following{/other_user}","gists_url":"https://api.github.com/users/kcindric/gists{/gist_id}","starred_url":"https://api.github.com/users/kcindric/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kcindric/subscriptions","organizations_url":"https://api.github.com/users/kcindric/orgs","repos_url":"https://api.github.com/users/kcindric/repos","events_url":"https://api.github.com/users/kcindric/events{/privacy}","received_events_url":"https://api.github.com/users/kcindric/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1900941630,"node_id":"MDU6TGFiZWwxOTAwOTQxNjMw","url":"https://api.github.com/repos/dotnet/efcore/labels/area-model-building","name":"area-model-building","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/152","html_url":"https://github.com/dotnet/efcore/milestone/152","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/152/labels","id":8392036,"node_id":"MI_kwDOAPaMMs4AgA1k","number":152,"title":"8.0.0","description":"EF Core 8.0","creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":280,"state":"closed","created_at":"2022-09-07T19:55:36Z","updated_at":"2025-04-07T08:59:46Z","due_on":null,"closed_at":"2023-11-14T14:00:33Z"},"comments":9,"created_at":"2023-03-01T09:31:59Z","updated_at":"2025-06-15T19:00:10Z","closed_at":"2023-10-05T18:07:34Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I'm building an app following the DDD principles and using Aggregates, Entities and Value objects. These are my two aggregate roots for which I wrote configurations which are then used for building EF Core migrations:\r\n\r\n`Office.cs` which has a list of `DepartmentId`'s for referencing the other aggregate:\r\n```c#\r\npublic class Office : AggregateRoot<OfficeId>\r\n{\r\n    private readonly List<DepartmentId> _departmentIds = new();\r\n\r\n    public string Name { get; private set; }\r\n    public DateTime CreatedDateTime { get; private set; }\r\n    public DateTime UpdatedDateTime { get; private set; }\r\n\r\n    public IReadOnlyList<DepartmentId> DepartmentIds => _departmentIds.AsReadOnly();\r\n\r\n    private Office(OfficeId officeId, string name, DateTime createdDateTime, DateTime updatedDateTime) :\r\n        base(officeId)\r\n    {\r\n        Name = name;\r\n        CreatedDateTime = createdDateTime;\r\n        UpdatedDateTime = updatedDateTime;\r\n    }\r\n\r\n    public static Office Create(int officeId, string name)\r\n    {\r\n        return new Office(OfficeId.Create(officeId), name, DateTime.UtcNow, DateTime.UtcNow);\r\n    }\r\n\r\n    private Office(){}\r\n}\r\n```\r\n\r\n`Department.cs` which has a list of `MunicipalityId`'s for referencing `Municipality` aggregate, which is not shown here.\r\n```c#\r\npublic class Department : AggregateRoot<DepartmentId>\r\n{\r\n    private readonly List<MunicipalityId> _municipalityIds = new();\r\n\r\n    public string Name { get; private set; }\r\n    public OfficeId OfficeId { get; private set; }\r\n    public DateTime CreatedDateTime { get; private set; }\r\n    public DateTime UpdatedDateTime { get; private set; }\r\n\r\n    public IReadOnlyList<MunicipalityId> MunicipalityIds => _municipalityIds.AsReadOnly();\r\n\r\n    private Department(DepartmentId departmentId, string name, OfficeId officeId, DateTime createdDateTime, DateTime updatedDateTime) :\r\n        base(departmentId)\r\n    {\r\n        Id = departmentId;\r\n        Name = name;\r\n        OfficeId = officeId;\r\n        CreatedDateTime = createdDateTime;\r\n        UpdatedDateTime = updatedDateTime;\r\n    }\r\n\r\n    public static Department Create(DepartmentId departmentId, string name, OfficeId officeId)\r\n    {\r\n        return new Department(departmentId, name, officeId,DateTime.UtcNow, DateTime.UtcNow);\r\n    }\r\n\r\n    private Department(){}\r\n}\r\n```\r\n\r\nNow the entity builder configurations which are then used in the `OnModelCreating(ModelBuilder modelBuilder)` to create migrations.\r\n\r\n`OfficeConfigurations`\r\n```c#\r\npublic class OfficeConfigurations : IEntityTypeConfiguration<Office>\r\n{\r\n    public void Configure(EntityTypeBuilder<Office> builder)\r\n    {\r\n        ConfigureOfficeTable(builder);\r\n        ConfigureDepartmentIdTable(builder);\r\n    }\r\n\r\n    private void ConfigureOfficeTable(EntityTypeBuilder<Office> builder)\r\n    {\r\n        builder.ToTable(nameof(Office), nameof(Office));\r\n        \r\n        builder.HasKey(o => o.Id);\r\n        \r\n        builder.Property(o => o.Id)\r\n            .ValueGeneratedNever()\r\n            .HasConversion(\r\n                id => id.Value,\r\n                value => OfficeId.Create(value));\r\n    }\r\n\r\n    private void ConfigureDepartmentIdTable(EntityTypeBuilder<Office> builder)\r\n    {\r\n        builder.OwnsMany(o => o.DepartmentIds, departmentIdBuilder =>\r\n        {\r\n            departmentIdBuilder.ToTable(nameof(DepartmentId), nameof(Office));\r\n            \r\n            departmentIdBuilder.WithOwner().HasForeignKey(nameof(OfficeId));\r\n            \r\n            departmentIdBuilder.HasKey(\"Id\"); // shadow id property\r\n            \r\n            departmentIdBuilder.Property(did => did.Value)\r\n                .HasColumnName(nameof(DepartmentId))\r\n                .ValueGeneratedNever();\r\n        });\r\n        \r\n        builder.Metadata.FindNavigation(nameof(Office.DepartmentIds))!\r\n            .SetPropertyAccessMode(PropertyAccessMode.Field);\r\n    }\r\n}\r\n```\r\n\r\n`DepartmentConfigurations`\r\n```c#\r\npublic class DepartmentConfigurations : IEntityTypeConfiguration<Department>\r\n{\r\n    public void Configure(EntityTypeBuilder<Department> builder)\r\n    {\r\n        ConfigureDepartmentTable(builder);\r\n        ConfigureMunicipalityIdTable(builder);\r\n    }\r\n\r\n    private void ConfigureDepartmentTable(EntityTypeBuilder<Department> builder)\r\n    {\r\n        builder.ToTable(nameof(Department), nameof(Department));\r\n\r\n        builder.HasKey(d => d.Id);\r\n\r\n        builder.Property(d => d.Id)\r\n            .ValueGeneratedNever()\r\n            .HasConversion(\r\n                id => id.Value,\r\n                value => DepartmentId.Create(value));\r\n\r\n        builder.Property(d => d.OfficeId)\r\n            .ValueGeneratedNever()\r\n            .HasConversion(\r\n                id => id.Value,\r\n                value => OfficeId.Create(value));\r\n    }\r\n\r\n    private void ConfigureMunicipalityIdTable(EntityTypeBuilder<Department> builder)\r\n    {\r\n        builder.OwnsMany(d => d.MunicipalityIds, municipalityIdBuilder =>\r\n        {\r\n            municipalityIdBuilder.ToTable(nameof(MunicipalityId), nameof(Department));\r\n        \r\n            municipalityIdBuilder.WithOwner().HasForeignKey(nameof(DepartmentId));\r\n        \r\n            municipalityIdBuilder.HasKey(\"Id\"); // shadow id property\r\n        \r\n            municipalityIdBuilder.Property(mid => mid.Value)\r\n                .HasColumnName(nameof(MunicipalityId))\r\n                .ValueGeneratedNever();\r\n        });\r\n\r\n        builder.Metadata.FindNavigation(nameof(Department.MunicipalityIds))!\r\n            .SetPropertyAccessMode(PropertyAccessMode.Field);\r\n    }\r\n}\r\n```\r\n\r\nExample of Id value objects (`OfficeId`, `DepartmentId`, `MunicipalityId`) which all follow the same pattern:\r\n\r\n```c#\r\npublic class OfficeId : ValueObject\r\n{\r\n    public int Value { get; }\r\n\r\n    private OfficeId(int value)\r\n    {\r\n        Value = value;\r\n    }\r\n\r\n    public static OfficeId Create(int value)\r\n    {\r\n        return new OfficeId(value);\r\n    }\r\n    \r\n    public override IEnumerable<object?> GetEqualityComponents()\r\n    {\r\n        yield return Value;\r\n    }\r\n}\r\n```\r\n\r\n`DbContext` configuration, the rest of\r\n\r\n```c#\r\npublic class MyDbContext : DbContext\r\n{\r\n    public MyDbContext(DbContextOptions<MyDbContext> options) : base(options){}\r\n\r\n    public DbSet<Office> Offices { get; set; } = null!;\r\n    public DbSet<Department> Departments { get; set; } = null!;\r\n    public DbSet<Municipality> Municipalities { get; set; } = null!;\r\n    \r\n    protected override void OnModelCreating(ModelBuilder modelBuilder)\r\n    {\r\n\r\n        modelBuilder.ApplyConfiguration(new OfficeConfigurations());\r\n        modelBuilder.ApplyConfiguration(new DepartmentConfigurations());\r\n        modelBuilder.ApplyConfiguration(new MunicipalityConfigurations());\r\n        base.OnModelCreating(modelBuilder);\r\n    }\r\n}\r\n```\r\n\r\nWhen I try to add a migration using `dotnet ef migrations add InitialMigration` using just one of these configuration (either `OfficeConfigurations` or `DepartmentConfigurations`) the migration is successfully created. The problem is when I try to create a migration using both configurations, or the rest of other configurations I didn't show here I get a strange `Object reference not set to an instance of an object.` error. When running the two shown configurations the stack trace is the following:\r\n\r\n```\r\nSystem.NullReferenceException: Object reference not set to an instance of an object.\r\n   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionBatchExtensions.Run(IConventionBatch batch, InternalForeignKeyBuilder relationshipBuilder)\r\n   at Microsoft.EntityFrameworkCore.Metadata.Internal.InternalForeignKeyBuilder.ReuniquifyImplicitProperties(Boolean force)\r\n   at Microsoft.EntityFrameworkCore.Metadata.Conventions.ForeignKeyPropertyDiscoveryConvention.DiscoverProperties(IConventionForeignKeyBuilder relationshipBuilder, IConventionContext c\r\nontext)\r\n   at Microsoft.EntityFrameworkCore.Metadata.Conventions.ForeignKeyPropertyDiscoveryConvention.ProcessForeignKeyRequirednessChanged(IConventionForeignKeyBuilder relationshipBuilder, IC\r\nonventionContext`1 context)\r\n   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.ImmediateConventionScope.OnForeignKeyRequirednessChanged(IConventionForeignKeyBuilder relationshi\r\npBuilder)\r\n   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.OnForeignKeyRequirednessChangedNode.Run(ConventionDispatcher dispatcher)\r\n   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.DelayedConventionScope.Run(ConventionDispatcher dispatcher)\r\n   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.ConventionBatch.Run()\r\n   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.ConventionBatch.Run(IConventionForeignKey foreignKey)\r\n   at Microsoft.EntityFrameworkCore.Metadata.Builders.EntityTypeBuilder`1.OwnsManyBuilder[TRelatedEntity](TypeIdentity ownedType, MemberIdentity navigation)\r\n   at Microsoft.EntityFrameworkCore.Metadata.Builders.EntityTypeBuilder`1.OwnsMany[TRelatedEntity](Expression`1 navigationExpression, Action`1 buildAction)\r\n   at Ratsatak.Infrastructure.Persistence.Configurations.DepartmentConfigurations.ConfigureMunicipalityIdTable(EntityTypeBuilder`1 builder) in D:\\DevCollections\\Ratsatak\\Ratsatak.Infra\r\nstructure\\Persistence\\Configurations\\DepartmentConfigurations.cs:line 39\r\n   at Ratsatak.Infrastructure.Persistence.Configurations.DepartmentConfigurations.Configure(EntityTypeBuilder`1 builder) in D:\\DevCollections\\Ratsatak\\Ratsatak.Infrastructure\\Persisten\r\nce\\Configurations\\DepartmentConfigurations.cs:line 15\r\n   at Microsoft.EntityFrameworkCore.ModelBuilder.ApplyConfiguration[TEntity](IEntityTypeConfiguration`1 configuration)\r\n   at Ratsatak.Infrastructure.Persistence.RatsatakDbContext.OnModelCreating(ModelBuilder modelBuilder) in D:\\DevCollections\\Ratsatak\\Ratsatak.Infrastructure\\Persistence\\RatsatakDbConte\r\nxt.cs:line 33\r\n   at Microsoft.EntityFrameworkCore.Infrastructure.ModelCustomizer.Customize(ModelBuilder modelBuilder, DbContext context)\r\n   at Microsoft.EntityFrameworkCore.Infrastructure.ModelSource.CreateModel(DbContext context, IConventionSetBuilder conventionSetBuilder, ModelDependencies modelDependencies)\r\n   at Microsoft.EntityFrameworkCore.Infrastructure.ModelSource.GetModel(DbContext context, ModelCreationDependencies modelCreationDependencies, Boolean designTime)\r\n   at Microsoft.EntityFrameworkCore.Internal.DbContextServices.CreateModel(Boolean designTime)\r\n   at Microsoft.EntityFrameworkCore.Internal.DbContextServices.get_Model()\r\n   at Microsoft.EntityFrameworkCore.Infrastructure.EntityFrameworkServicesBuilder.<>c.<TryAddCoreServices>b__8_4(IServiceProvider p)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope ser\r\nviceProviderEngine, RuntimeResolverLock lockType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope ser\r\nviceProviderEngine, RuntimeResolverLock lockType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope ser\r\nviceProviderEngine, RuntimeResolverLock lockType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope ser\r\nviceProviderEngine, RuntimeResolverLock lockType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope ser\r\nviceProviderEngine, RuntimeResolverLock lockType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope ser\r\nviceProviderEngine, RuntimeResolverLock lockType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.Resolve(ServiceCallSite callSite, ServiceProviderEngineScope scope)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.DynamicServiceProviderEngine.<>c__DisplayClass2_0.<RealizeService>b__0(ServiceProviderEngineScope scope)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceProvider.GetService(Type serviceType, ServiceProviderEngineScope serviceProviderEngineScope)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.ServiceProviderEngineScope.GetService(Type serviceType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService(IServiceProvider provider, Type serviceType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService[T](IServiceProvider provider)\r\n   at Microsoft.EntityFrameworkCore.DbContext.get_DbContextDependencies()\r\n   at Microsoft.EntityFrameworkCore.DbContext.get_ContextServices()\r\n   at Microsoft.EntityFrameworkCore.DbContext.get_InternalServiceProvider()\r\n   at Microsoft.EntityFrameworkCore.DbContext.Microsoft.EntityFrameworkCore.Infrastructure.IInfrastructure<System.IServiceProvider>.get_Instance()\r\n   at Microsoft.EntityFrameworkCore.Infrastructure.Internal.InfrastructureExtensions.GetService[TService](IInfrastructure`1 accessor)\r\n   at Microsoft.EntityFrameworkCore.Infrastructure.AccessorExtensions.GetService[TService](IInfrastructure`1 accessor)\r\n   at Microsoft.EntityFrameworkCore.Design.Internal.DbContextOperations.CreateContext(Func`1 factory)\r\n   at Microsoft.EntityFrameworkCore.Design.Internal.DbContextOperations.CreateContext(String contextType)\r\n   at Microsoft.EntityFrameworkCore.Design.Internal.MigrationsOperations.AddMigration(String name, String outputDir, String contextType, String namespace)\r\n   at Microsoft.EntityFrameworkCore.Design.OperationExecutor.AddMigrationImpl(String name, String outputDir, String contextType, String namespace)\r\n   at Microsoft.EntityFrameworkCore.Design.OperationExecutor.AddMigration.<>c__DisplayClass0_0.<.ctor>b__0()\r\n   at Microsoft.EntityFrameworkCore.Design.OperationExecutor.OperationBase.<>c__DisplayClass3_0`1.<Execute>b__0()\r\n   at Microsoft.EntityFrameworkCore.Design.OperationExecutor.OperationBase.Execute(Action action)\r\nObject reference not set to an instance of an object.\r\n```\r\n\r\nWhich points out to the line `builder.OwnsMany(d => d.MunicipalityIds, municipalityIdBuilder => {...});` in `DepartmentConfigurations`.\r\n\r\nI'm clueless why when I run just one configuration, the migration succedes but the opposite is true when two configurations are involved, and the error appears to happen when defining a `.OwnsMany()` relationship which is not tied to the preceeding aggregate. It seems that when the preceeding aggregate, in this case `Office` has a list of Id value objects of the following aggregate `Department`, the `.OwnsMany()` method fails with the next in line aggregate ids (`MunicipalityId`). This happens even if I include the `MunicipalityConfigurations`.\r\n\r\n\r\n\r\nAm I missing something here or is it a EF Core bug?\r\n\r\nEF Core version:\r\nMicrosoft.EntityFrameworkCore 7.0.3\r\nMicrosoft.EntityFrameworkCore.Design 7.0.3.\r\nMicrosoft.EntityFrameworkCore.SqlServer 7.0.3.\r\n","closed_by":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/30373/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/30373/timeline","performed_via_github_app":null,"state_reason":"completed"}