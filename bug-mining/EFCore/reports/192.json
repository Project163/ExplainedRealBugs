{"url":"https://api.github.com/repos/dotnet/efcore/issues/30358","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/30358/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/30358/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/30358/events","html_url":"https://github.com/dotnet/efcore/issues/30358","id":1602011213,"node_id":"I_kwDOAPaMMs5ffMBN","number":30358,"title":"Duplicate table alias in generated select query (An item with the same key has already been added)","user":{"login":"OldrichDlouhy","id":8403048,"node_id":"MDQ6VXNlcjg0MDMwNDg=","avatar_url":"https://avatars.githubusercontent.com/u/8403048?v=4","gravatar_id":"","url":"https://api.github.com/users/OldrichDlouhy","html_url":"https://github.com/OldrichDlouhy","followers_url":"https://api.github.com/users/OldrichDlouhy/followers","following_url":"https://api.github.com/users/OldrichDlouhy/following{/other_user}","gists_url":"https://api.github.com/users/OldrichDlouhy/gists{/gist_id}","starred_url":"https://api.github.com/users/OldrichDlouhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/OldrichDlouhy/subscriptions","organizations_url":"https://api.github.com/users/OldrichDlouhy/orgs","repos_url":"https://api.github.com/users/OldrichDlouhy/repos","events_url":"https://api.github.com/users/OldrichDlouhy/events{/privacy}","received_events_url":"https://api.github.com/users/OldrichDlouhy/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":514908713,"node_id":"MDU6TGFiZWw1MTQ5MDg3MTM=","url":"https://api.github.com/repos/dotnet/efcore/labels/regression","name":"regression","color":"ff1fff","default":false,"description":null},{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1017558838,"node_id":"MDU6TGFiZWwxMDE3NTU4ODM4","url":"https://api.github.com/repos/dotnet/efcore/labels/Servicing-approved","name":"Servicing-approved","color":"048708","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/165","html_url":"https://github.com/dotnet/efcore/milestone/165","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/165/labels","id":9168950,"node_id":"MI_kwDOAPaMMs4Ai-g2","number":165,"title":"7.0.7","description":null,"creator":{"login":"rbhanda","id":30737530,"node_id":"MDQ6VXNlcjMwNzM3NTMw","avatar_url":"https://avatars.githubusercontent.com/u/30737530?v=4","gravatar_id":"","url":"https://api.github.com/users/rbhanda","html_url":"https://github.com/rbhanda","followers_url":"https://api.github.com/users/rbhanda/followers","following_url":"https://api.github.com/users/rbhanda/following{/other_user}","gists_url":"https://api.github.com/users/rbhanda/gists{/gist_id}","starred_url":"https://api.github.com/users/rbhanda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rbhanda/subscriptions","organizations_url":"https://api.github.com/users/rbhanda/orgs","repos_url":"https://api.github.com/users/rbhanda/repos","events_url":"https://api.github.com/users/rbhanda/events{/privacy}","received_events_url":"https://api.github.com/users/rbhanda/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":9,"state":"closed","created_at":"2023-03-16T17:19:58Z","updated_at":"2023-11-14T13:53:13Z","due_on":null,"closed_at":"2023-06-22T17:34:17Z"},"comments":3,"created_at":"2023-02-27T21:53:16Z","updated_at":"2025-06-15T19:00:05Z","closed_at":"2023-04-06T17:27:08Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## EF Core Query results in argument exception `An item with the same key has already been added. Key: c0` \r\n\r\ncaused by generated duplicate table alias\r\n\r\n### Code\r\n\r\nQuery causing the problem:\r\n\r\n``` CSharp\r\n        var query = dbContext.ContainerConfigurations\r\n            .AsSplitQuery()\r\n            .Include(e => e.Container)\r\n                .ThenInclude(e => e.HardwareUnit)\r\n                    .ThenInclude(e => e.CurrentConfiguration)\r\n            .Where(e => e.Fraction == entity);\r\n\r\n        query.ToQueryString();\r\n```\r\n\r\nSolution with test failing with duplicate table alias:\r\n\r\n[EFCoreDuplicateTableAlias.zip](https://github.com/dotnet/efcore/files/10844601/EFCoreDuplicateTableAlias.zip)\r\n\r\nThe issue manifested after upgrading from EF Core 6 to EF Core 7.\r\nWith MySQL Pomelo provider, the issue manifests both for split and non-split query. \r\nFor SQLite provider (unit test) it fails with split query.\r\n\r\nIt may be related to global query filters as removing the filters makes the issue go away.\r\n\r\n### Stack trace\r\n\r\n```\r\nSystem.ArgumentException\r\n  HResult=0x80070057\r\n  Message=An item with the same key has already been added. Key: c0\r\n  Source=System.Private.CoreLib\r\n  StackTrace:\r\n   at System.ThrowHelper.ThrowAddingDuplicateWithKeyArgumentException[T](T key)\r\n   at System.Collections.Generic.Dictionary`2.TryInsert(TKey key, TValue value, InsertionBehavior behavior)\r\n   at System.Collections.Generic.Dictionary`2.Add(TKey key, TValue value)\r\n   at System.Linq.Enumerable.ToDictionary[TSource,TKey](List`1 source, Func`2 keySelector, IEqualityComparer`1 comparer)\r\n   at Microsoft.EntityFrameworkCore.Query.SqlExpressions.SelectExpression.ColumnExpressionReplacingExpressionVisitor..ctor(SelectExpression oldSelectExpression, IEnumerable`1 newTableReferences)\r\n   at Microsoft.EntityFrameworkCore.Query.SqlExpressions.SelectExpression.CloningExpressionVisitor.Visit(Expression expression)\r\n   at Microsoft.EntityFrameworkCore.Query.SqlExpressions.InnerJoinExpression.VisitChildren(ExpressionVisitor visitor)\r\n   at Microsoft.EntityFrameworkCore.Query.SqlExpressions.SelectExpression.CloningExpressionVisitor.Visit(Expression expression)\r\n   at System.Linq.Enumerable.SelectListIterator`2.MoveNext()\r\n   at System.Linq.Enumerable.<OfTypeIterator>d__65`1.MoveNext()\r\n   at System.Collections.Generic.List`1..ctor(IEnumerable`1 collection)\r\n   at System.Linq.Enumerable.ToList[TSource](IEnumerable`1 source)\r\n   at Microsoft.EntityFrameworkCore.Utilities.EnumerableExtensions.ToList[TSource](IEnumerable source)\r\n   at Microsoft.EntityFrameworkCore.Query.SqlExpressions.SelectExpression.CloningExpressionVisitor.Visit(Expression expression)\r\n   at Microsoft.EntityFrameworkCore.Query.SqlExpressions.SelectExpression.ApplyProjection(Expression shaperExpression, ResultCardinality resultCardinality, QuerySplittingBehavior querySplittingBehavior)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.SelectExpressionProjectionApplyingExpressionVisitor.VisitExtension(Expression extensionExpression)\r\n   at Microsoft.EntityFrameworkCore.Query.RelationalQueryTranslationPostprocessor.Process(Expression query)\r\n   at Microsoft.EntityFrameworkCore.Sqlite.Query.Internal.SqliteQueryTranslationPostprocessor.Process(Expression query)\r\n   at Microsoft.EntityFrameworkCore.Query.QueryCompilationContext.CreateQueryExecutor[TResult](Expression query)\r\n   at Microsoft.EntityFrameworkCore.Storage.Database.CompileQuery[TResult](Expression query, Boolean async)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.CompileQueryCore[TResult](IDatabase database, Expression query, IModel model, Boolean async)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.<>c__DisplayClass9_0`1.<Execute>b__0()\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.CompiledQueryCache.GetOrAddQuery[TResult](Object cacheKey, Func`1 compiler)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.Execute[TResult](Expression query)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.EntityQueryProvider.Execute[TResult](Expression expression)\r\n   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.ToQueryString(IQueryable source)\r\n   at eGateDigi.Web.Services.Containers.Configuration.UpdateFractionHandler.<Handle>d__3.MoveNext() in C:\\Code\\eGateDigi\\eGateDigi.Web\\UpdateFraction.cs:line 89\r\n```\r\n\r\n### Provider and version information\r\n\r\nEF Core version: 7.0.3\r\nDatabase provider: Microsoft.EntityFrameworkCore.SqLite 7.0.3\r\nTarget framework: .NET 7.0\r\nOperating system: Windows 10 19044.2604\r\nIDE: Visual Studio 2022 17.4\r\n","closed_by":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/30358/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/30358/timeline","performed_via_github_app":null,"state_reason":"completed"}