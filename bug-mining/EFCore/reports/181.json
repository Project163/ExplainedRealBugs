{"url":"https://api.github.com/repos/dotnet/efcore/issues/30122","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/30122/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/30122/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/30122/events","html_url":"https://github.com/dotnet/efcore/issues/30122","id":1553580921,"node_id":"I_kwDOAPaMMs5cmcN5","number":30122,"title":"Deletion can cause error \"The association between entity types A and B has been severed...\"","user":{"login":"edwiles","id":6249086,"node_id":"MDQ6VXNlcjYyNDkwODY=","avatar_url":"https://avatars.githubusercontent.com/u/6249086?v=4","gravatar_id":"","url":"https://api.github.com/users/edwiles","html_url":"https://github.com/edwiles","followers_url":"https://api.github.com/users/edwiles/followers","following_url":"https://api.github.com/users/edwiles/following{/other_user}","gists_url":"https://api.github.com/users/edwiles/gists{/gist_id}","starred_url":"https://api.github.com/users/edwiles/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/edwiles/subscriptions","organizations_url":"https://api.github.com/users/edwiles/orgs","repos_url":"https://api.github.com/users/edwiles/repos","events_url":"https://api.github.com/users/edwiles/events{/privacy}","received_events_url":"https://api.github.com/users/edwiles/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1017558838,"node_id":"MDU6TGFiZWwxMDE3NTU4ODM4","url":"https://api.github.com/repos/dotnet/efcore/labels/Servicing-approved","name":"Servicing-approved","color":"048708","default":false,"description":""},{"id":1901166749,"node_id":"MDU6TGFiZWwxOTAxMTY2NzQ5","url":"https://api.github.com/repos/dotnet/efcore/labels/area-change-tracking","name":"area-change-tracking","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/160","html_url":"https://github.com/dotnet/efcore/milestone/160","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/160/labels","id":8944601,"node_id":"MI_kwDOAPaMMs4AiHvZ","number":160,"title":"7.0.4","description":null,"creator":{"login":"rbhanda","id":30737530,"node_id":"MDQ6VXNlcjMwNzM3NTMw","avatar_url":"https://avatars.githubusercontent.com/u/30737530?v=4","gravatar_id":"","url":"https://api.github.com/users/rbhanda","html_url":"https://github.com/rbhanda","followers_url":"https://api.github.com/users/rbhanda/followers","following_url":"https://api.github.com/users/rbhanda/following{/other_user}","gists_url":"https://api.github.com/users/rbhanda/gists{/gist_id}","starred_url":"https://api.github.com/users/rbhanda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rbhanda/subscriptions","organizations_url":"https://api.github.com/users/rbhanda/orgs","repos_url":"https://api.github.com/users/rbhanda/repos","events_url":"https://api.github.com/users/rbhanda/events{/privacy}","received_events_url":"https://api.github.com/users/rbhanda/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":15,"state":"closed","created_at":"2023-01-19T18:11:33Z","updated_at":"2023-03-16T13:51:24Z","due_on":null,"closed_at":"2023-03-16T13:51:24Z"},"comments":2,"created_at":"2023-01-23T18:42:34Z","updated_at":"2025-06-15T18:58:48Z","closed_at":"2023-02-14T18:28:43Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"When multiple cascade paths have been avoided by setting one path to `DeleteBehavior.Restrict`, deletion can fail with the error:\r\n\r\n```\r\nUnhandled exception. System.InvalidOperationException: The association between entity types 'A' and 'B' has been severed, but the relationship is either marked as required or is implicitly required because the foreign key is not nullable. If the dependent/child entity should be deleted when a required relationship is severed, configure the relationship to use cascade deletes. Consider using 'DbContextOptionsBuilder.EnableSensitiveDataLogging' to see the key values.\r\n```\r\n\r\nThe code below runs successfully with EF Core 6.0.13, but fails with 7.0.0-7.0.2.\r\n\r\n### Steps to reproduce\r\n\r\n1. Create a C# console application, with the following `.csproj` file that uses EF Core 6.\r\n\r\n```csproj\r\n<Project Sdk=\"Microsoft.NET.Sdk\">\r\n\r\n  <PropertyGroup>\r\n    <OutputType>Exe</OutputType>\r\n    <TargetFramework>net7.0</TargetFramework>\r\n    <ImplicitUsings>enable</ImplicitUsings>\r\n    <Nullable>disable</Nullable>\r\n  </PropertyGroup>\r\n\r\n  <ItemGroup>\r\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore\" Version=\"6.0.13\" />\r\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.Design\" Version=\"6.0.13\" />\r\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.Sqlite\" Version=\"6.0.13\" />\r\n  </ItemGroup>\r\n\r\n</Project>\r\n```\r\n\r\n2. Create the following code in a file `Model.cs`:\r\n\r\n```C#\r\nusing Microsoft.EntityFrameworkCore;\r\n\r\nnamespace ConsoleApp.SQLite\r\n{\r\n    public class MyContext : DbContext\r\n    {\r\n        public DbSet<Root> Roots { get; set; }\r\n        public DbSet<Inputs> Inputs { get; set; }\r\n        public DbSet<Outputs> Outputs { get; set; }\r\n        public DbSet<ThingOutputs> ThingOutputs { get; set; }\r\n        public DbSet<Thing> Thing { get; set; }\r\n\r\n        protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)\r\n        {\r\n            optionsBuilder.UseSqlite(\"Data Source=mydb\");\r\n        }\r\n\r\n        protected override void OnModelCreating(ModelBuilder modelBuilder)\r\n        {\r\n            modelBuilder.Entity<Root>().HasData(new Root { Id = 1 });\r\n            modelBuilder.Entity<Inputs>().HasData(new Inputs { Id = 1, RootId = 1 });\r\n            modelBuilder.Entity<Thing>().HasData(new Thing { Id = 1, InputsId = 1 });\r\n            modelBuilder.Entity<Outputs>().HasData(new Outputs { Id = 1, RootId = 1 });\r\n            modelBuilder.Entity<ThingOutputs>().HasData(new ThingOutputs { Id = 1, OutputsId = 1, ThingId = 1 });\r\n\r\n            // Avoid multiple cascade paths (our \"real\" code uses SQL Server)\r\n            // ON DELETE CASCADE path 1: Root -> Inputs -> Thing\r\n            // ON DELETE CASCADE path 2: Root -> Outputs -> ThingOutputs -> Thing\r\n            // Broken by removing Outputs -> ThingOutputs\r\n            SetForeignKeyDeleteBehaviour<Outputs, ThingOutputs>(modelBuilder, DeleteBehavior.Restrict);\r\n        }\r\n\r\n        private static void SetForeignKeyDeleteBehaviour<TParent, TChild>(ModelBuilder modelBuilder, DeleteBehavior deleteBehavior)\r\n        {\r\n            modelBuilder.Model.GetEntityTypes().First(t => t.ClrType == typeof(TChild))\r\n                .GetForeignKeys().First(k => k.PrincipalEntityType.ClrType == typeof(TParent))\r\n                .DeleteBehavior = deleteBehavior;\r\n        }\r\n    }\r\n\r\n    public class Root\r\n    {\r\n        public int Id { get; set; }\r\n        public Inputs Inputs { get; set; }\r\n        public Outputs Outputs { get; set; }\r\n    }\r\n\r\n    public class Inputs\r\n    {\r\n        public int Id { get; set; }\r\n        public int RootId { get; set; }\r\n        public Root Root { get; set; }\r\n        public IList<Thing> Things { get; set; }\r\n    }\r\n\r\n    public class Thing\r\n    {\r\n        public int Id { get; set; }\r\n        public int InputsId { get; set; }\r\n        public Inputs Inputs { get; set; }\r\n    }\r\n\r\n    public class Outputs\r\n    {\r\n        public int Id { get; set; }\r\n        public int RootId { get; set; }\r\n        public Root Root { get; set; }\r\n        public IList<ThingOutputs> ThingOutputs { get; set; }\r\n    }\r\n\r\n    public class ThingOutputs\r\n    {\r\n        public int Id { get; set; }\r\n        public int OutputsId { get; set; }\r\n        public Outputs Outputs { get; set; }\r\n        public int ThingId { get; set; }\r\n        public Thing Thing { get; set; }\r\n    }\r\n}\r\n```\r\n\r\n3. Create the following code in a file `Program.cs`:\r\n\r\n```C#\r\nusing Microsoft.EntityFrameworkCore;\r\n\r\nnamespace ConsoleApp.SQLite\r\n{\r\n    public class Program\r\n    {\r\n        public static void Main()\r\n        {\r\n            using var db = new MyContext();\r\n\r\n            // Get data\r\n            var outputs = db.Roots\r\n                .Include(x => x.Inputs)\r\n                    .ThenInclude(x => x.Things)\r\n                .Include(x => x.Outputs)\r\n                    .ThenInclude(x => x.ThingOutputs)\r\n                .SingleOrDefault(x => x.Id == 1);\r\n\r\n            // Delete data\r\n            DeleteData(outputs);\r\n\r\n            // Save\r\n            db.SaveChanges();\r\n        }\r\n\r\n        private static void DeleteData(Root root)\r\n        {\r\n            // We want to delete all the Things. So we clear the Things and their outputs.\r\n            root.Inputs.Things.Clear();\r\n            root.Outputs.ThingOutputs.Clear();\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n4. Create the database and run the program:\r\n\r\n```\r\ndotnet ef migrations add InitialCreate\r\ndotnet ef database update\r\ndotnet run\r\n```\r\n\r\nThe program returns successfully, without output.\r\n\r\n5. Modify the `.csproj` file to upgrade to EF Core 7:\r\n\r\n```csproj\r\n<Project Sdk=\"Microsoft.NET.Sdk\">\r\n\r\n  <PropertyGroup>\r\n    <OutputType>Exe</OutputType>\r\n    <TargetFramework>net7.0</TargetFramework>\r\n    <ImplicitUsings>enable</ImplicitUsings>\r\n    <Nullable>disable</Nullable>\r\n  </PropertyGroup>\r\n\r\n  <ItemGroup>\r\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore\" Version=\"7.0.2\" />\r\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.Design\" Version=\"7.0.2\" />\r\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.Sqlite\" Version=\"7.0.2\" />\r\n  </ItemGroup>\r\n\r\n</Project>\r\n```\r\n\r\n6. Recreate the database and run the program:\r\n\r\n```\r\ndotnet ef database drop\r\ndotnet ef database update\r\ndotnet run\r\n```\r\n\r\nThe program execution fails with the error:\r\n\r\n```\r\nUnhandled exception. System.InvalidOperationException: The association between entity types 'Outputs' and 'ThingOutputs' has been severed, but the relationship is either marked as required or is implicitly required because the foreign key is not nullable. If the dependent/child entity should be deleted when a required relationship is severed, configure the relationship to use cascade deletes. Consider using 'DbContextOptionsBuilder.EnableSensitiveDataLogging' to see the key values.\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.InternalEntityEntry.HandleConceptualNulls(Boolean sensitiveLoggingEnabled, Boolean force, Boolean isCascadeDelete)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.InternalEntityEntry.HandleNullForeignKey(IProperty property, Boolean setModified, Boolean isCascadeDelete)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.InternalEntityEntry.SetProperty(IPropertyBase propertyBase, Object value, Boolean isMaterialization, Boolean setModified, Boolean isCascadeDelete, CurrentValueType valueType)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.InternalEntityEntry.SetProperty(IPropertyBase propertyBase, Object value, Boolean isMaterialization, Boolean setModified, Boolean isCascadeDelete)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.InternalEntityEntry.set_Item(IPropertyBase propertyBase, Object value)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.NavigationFixer.ConditionallyNullForeignKeyProperties(InternalEntityEntry dependentEntry, InternalEntityEntry principalEntry, IForeignKey foreignKey)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.NavigationFixer.NavigationCollectionChanged(InternalEntityEntry entry, INavigationBase navigationBase, IEnumerable`1 added, IEnumerable`1 removed)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.InternalEntityEntryNotifier.NavigationCollectionChanged(InternalEntityEntry entry, INavigationBase navigationBase, IEnumerable`1 added, IEnumerable`1 removed)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.ChangeDetector.DetectNavigationChange(InternalEntityEntry entry, INavigationBase navigationBase)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.ChangeDetector.LocalDetectChanges(InternalEntityEntry entry)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.ChangeDetector.DetectChanges(InternalEntityEntry entry, HashSet`1 visited)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.ChangeDetector.DetectChanges(InternalEntityEntry entry, HashSet`1 visited)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.ChangeDetector.DetectChanges(InternalEntityEntry entry)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.CascadeDelete(InternalEntityEntry entry, Boolean force, IEnumerable`1 foreignKeys)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.InternalEntityEntry.SetEntityState(EntityState oldState, EntityState newState, Boolean acceptChanges, Boolean modifyProperties)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.InternalEntityEntry.SetEntityState(EntityState entityState, Boolean acceptChanges, Boolean modifyProperties, Nullable`1 forceStateWhenUnknownKey, Nullable`1 fallbackState)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.InternalEntityEntry.HandleConceptualNulls(Boolean sensitiveLoggingEnabled, Boolean force, Boolean isCascadeDelete)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.InternalEntityEntry.HandleNullForeignKey(IProperty property, Boolean setModified, Boolean isCascadeDelete)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.InternalEntityEntry.SetProperty(IPropertyBase propertyBase, Object value, Boolean isMaterialization, Boolean setModified, Boolean isCascadeDelete, CurrentValueType valueType)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.InternalEntityEntry.SetProperty(IPropertyBase propertyBase, Object value, Boolean isMaterialization, Boolean setModified, Boolean isCascadeDelete)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.InternalEntityEntry.set_Item(IPropertyBase propertyBase, Object value)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.NavigationFixer.ConditionallyNullForeignKeyProperties(InternalEntityEntry dependentEntry, InternalEntityEntry principalEntry, IForeignKey foreignKey)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.NavigationFixer.NavigationCollectionChanged(InternalEntityEntry entry, INavigationBase navigationBase, IEnumerable`1 added, IEnumerable`1 removed)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.InternalEntityEntryNotifier.NavigationCollectionChanged(InternalEntityEntry entry, INavigationBase navigationBase, IEnumerable`1 added, IEnumerable`1 removed)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.ChangeDetector.DetectNavigationChange(InternalEntityEntry entry, INavigationBase navigationBase)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.ChangeDetector.LocalDetectChanges(InternalEntityEntry entry)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.ChangeDetector.DetectChanges(IStateManager stateManager)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.ChangeTracker.DetectChanges()\r\n   at Microsoft.EntityFrameworkCore.DbContext.TryDetectChanges()\r\n   at Microsoft.EntityFrameworkCore.DbContext.SaveChanges(Boolean acceptAllChangesOnSuccess)\r\n   at Microsoft.EntityFrameworkCore.DbContext.SaveChanges()\r\n   at ConsoleApp.SQLite.Program.Main() in C:...\\Program.cs:line 23\r\n```\r\n\r\n### Further technical details\r\nEF Core version: 7.0.2\r\n.NET SDK: 7.0.100\r\nDatabase Provider: Microsoft.EntityFrameworkCore.Sqlite (though in our \"real\" code we use SqlServer)\r\nOperating system: Windows 10 Enterprise\r\nIDE: Visual Studio 17.4.2\r\n","closed_by":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/30122/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/30122/timeline","performed_via_github_app":null,"state_reason":"completed"}