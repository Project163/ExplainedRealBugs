{"url":"https://api.github.com/repos/dotnet/efcore/issues/27427","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/27427/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/27427/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/27427/events","html_url":"https://github.com/dotnet/efcore/issues/27427","id":1130526254,"node_id":"I_kwDOAPaMMs5DYnYu","number":27427,"title":"Regression in 6.0.2: The variable name '@p0' has already been declared.","user":{"login":"PawelGerr","id":7135790,"node_id":"MDQ6VXNlcjcxMzU3OTA=","avatar_url":"https://avatars.githubusercontent.com/u/7135790?v=4","gravatar_id":"","url":"https://api.github.com/users/PawelGerr","html_url":"https://github.com/PawelGerr","followers_url":"https://api.github.com/users/PawelGerr/followers","following_url":"https://api.github.com/users/PawelGerr/following{/other_user}","gists_url":"https://api.github.com/users/PawelGerr/gists{/gist_id}","starred_url":"https://api.github.com/users/PawelGerr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/PawelGerr/subscriptions","organizations_url":"https://api.github.com/users/PawelGerr/orgs","repos_url":"https://api.github.com/users/PawelGerr/repos","events_url":"https://api.github.com/users/PawelGerr/events{/privacy}","received_events_url":"https://api.github.com/users/PawelGerr/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":514908713,"node_id":"MDU6TGFiZWw1MTQ5MDg3MTM=","url":"https://api.github.com/repos/dotnet/efcore/labels/regression","name":"regression","color":"ff1fff","default":false,"description":null},{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1017558838,"node_id":"MDU6TGFiZWwxMDE3NTU4ODM4","url":"https://api.github.com/repos/dotnet/efcore/labels/Servicing-approved","name":"Servicing-approved","color":"048708","default":false,"description":""},{"id":1675384372,"node_id":"MDU6TGFiZWwxNjc1Mzg0Mzcy","url":"https://api.github.com/repos/dotnet/efcore/labels/area-query","name":"area-query","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"smitpatel","id":1528107,"node_id":"MDQ6VXNlcjE1MjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1528107?v=4","gravatar_id":"","url":"https://api.github.com/users/smitpatel","html_url":"https://github.com/smitpatel","followers_url":"https://api.github.com/users/smitpatel/followers","following_url":"https://api.github.com/users/smitpatel/following{/other_user}","gists_url":"https://api.github.com/users/smitpatel/gists{/gist_id}","starred_url":"https://api.github.com/users/smitpatel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smitpatel/subscriptions","organizations_url":"https://api.github.com/users/smitpatel/orgs","repos_url":"https://api.github.com/users/smitpatel/repos","events_url":"https://api.github.com/users/smitpatel/events{/privacy}","received_events_url":"https://api.github.com/users/smitpatel/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"smitpatel","id":1528107,"node_id":"MDQ6VXNlcjE1MjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1528107?v=4","gravatar_id":"","url":"https://api.github.com/users/smitpatel","html_url":"https://github.com/smitpatel","followers_url":"https://api.github.com/users/smitpatel/followers","following_url":"https://api.github.com/users/smitpatel/following{/other_user}","gists_url":"https://api.github.com/users/smitpatel/gists{/gist_id}","starred_url":"https://api.github.com/users/smitpatel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smitpatel/subscriptions","organizations_url":"https://api.github.com/users/smitpatel/orgs","repos_url":"https://api.github.com/users/smitpatel/repos","events_url":"https://api.github.com/users/smitpatel/events{/privacy}","received_events_url":"https://api.github.com/users/smitpatel/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/147","html_url":"https://github.com/dotnet/efcore/milestone/147","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/147/labels","id":8163188,"node_id":"MI_kwDOAPaMMs4AfI90","number":147,"title":"6.0.8","description":null,"creator":{"login":"rbhanda","id":30737530,"node_id":"MDQ6VXNlcjMwNzM3NTMw","avatar_url":"https://avatars.githubusercontent.com/u/30737530?v=4","gravatar_id":"","url":"https://api.github.com/users/rbhanda","html_url":"https://github.com/rbhanda","followers_url":"https://api.github.com/users/rbhanda/followers","following_url":"https://api.github.com/users/rbhanda/following{/other_user}","gists_url":"https://api.github.com/users/rbhanda/gists{/gist_id}","starred_url":"https://api.github.com/users/rbhanda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rbhanda/subscriptions","organizations_url":"https://api.github.com/users/rbhanda/orgs","repos_url":"https://api.github.com/users/rbhanda/repos","events_url":"https://api.github.com/users/rbhanda/events{/privacy}","received_events_url":"https://api.github.com/users/rbhanda/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":1,"state":"closed","created_at":"2022-07-05T17:12:01Z","updated_at":"2022-09-02T19:01:23Z","due_on":null,"closed_at":"2022-09-02T19:01:23Z"},"comments":7,"created_at":"2022-02-10T17:32:47Z","updated_at":"2025-06-15T18:45:35Z","closed_at":"2022-07-06T15:17:38Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Similar as in https://github.com/dotnet/efcore/issues/26754 and https://github.com/dotnet/efcore/issues/26632 but during reading data.\r\n\r\nThe issue seem to affect `Microsoft.EntityFrameworkCore.SqlServer v6.0.2` only. No issues with `Microsoft.EntityFrameworkCore.SqlServer v6.0.1`  and `Microsoft.EntityFrameworkCore.Sqlite v6.0.2`.\r\n\r\n## Repro\r\n\r\n**csproj file**\r\n```XML\r\n<Project Sdk=\"Microsoft.NET.Sdk\">\r\n\r\n   <PropertyGroup>\r\n      <OutputType>Exe</OutputType>\r\n      <TargetFramework>net6.0</TargetFramework>\r\n      <ImplicitUsings>enable</ImplicitUsings>\r\n      <Nullable>enable</Nullable>\r\n   </PropertyGroup>\r\n\r\n   <ItemGroup>\r\n      <PackageReference Include=\"Microsoft.EntityFrameworkCore.SqlServer\" Version=\"6.0.2\" />\r\n      <PackageReference Include=\"Microsoft.Extensions.Logging.Console\" Version=\"6.0.0\" />\r\n   </ItemGroup>\r\n\r\n</Project>\r\n```\r\n\r\n**DbContext and Entity**\r\n\r\n```C#\r\nusing Microsoft.EntityFrameworkCore;\r\n\r\nnamespace EfCoreVariableIssue;\r\n\r\npublic class DemoDbContext : DbContext\r\n{\r\n   public DbSet<DemoEntity> DemoEntities { get; set; }\r\n\r\n   public DemoDbContext(DbContextOptions<DemoDbContext> options)\r\n      : base(options)\r\n   {\r\n   }\r\n}\r\n\r\npublic class DemoEntity\r\n{\r\n   public Guid Id { get; set; }\r\n}\r\n```\r\n\r\n**Program.cs**\r\n```C#\r\nusing EfCoreVariableIssue;\r\nusing Microsoft.Data.SqlClient;\r\nusing Microsoft.EntityFrameworkCore;\r\nusing Microsoft.Extensions.Logging;\r\n\r\nvar loggerFactory = LoggerFactory.Create(builder => builder\r\n                                                    .SetMinimumLevel(LogLevel.Trace)\r\n                                                    .AddConsole());\r\n\r\nvar options = new DbContextOptionsBuilder<DemoDbContext>()\r\n              .UseSqlServer(\"server=localhost;database=VariableIssue;integrated security=true;\")\r\n              .UseLoggerFactory(loggerFactory)\r\n              .Options;\r\n\r\nusing var dbContext = new DemoDbContext(options);\r\ndbContext.Database.OpenConnection();\r\ndbContext.Database.EnsureCreated();\r\n```\r\n\r\nThe issue comes only when using `FromSqlRaw` + `SqlParameter` + `GroupBy` + `Select`, which has an aggregate like `g.Count()`.\r\n\r\nNo issues when using \r\n* `.FromSqlInterpolated($\"SELECT * FROM DemoEntities WHERE Id = {Guid.Empty}\")` or\r\n* `.FromSqlRaw(\"SELECT * FROM DemoEntities WHERE Id = {0}\", Guid.Empty)`\r\n\r\n```C#\r\nvar query = dbContext.DemoEntities\r\n                     .FromSqlRaw(\"SELECT * FROM DemoEntities WHERE Id = {0}\", new SqlParameter { Value = Guid.Empty })\r\n                     .Select(e => e.Id);\r\n\r\ndbContext.DemoEntities\r\n         .Where(e => query.Contains(e.Id))\r\n         .GroupBy(e => e.Id)\r\n         .Select(g => new { g.Key, Aggregate = g.Count() })\r\n         .ToList();\r\n\r\n```\r\n\r\n**Logs**\r\n\r\n```\r\nfail: Microsoft.EntityFrameworkCore.Database.Command[20102]\r\n      Failed executing DbCommand (24ms) [Parameters=[p0='?' (DbType = Guid), p0='?' (DbType = Guid)], CommandType='Text', CommandTimeout='30']\r\n      SELECT [d].[Id] AS [Key], (\r\n          SELECT COUNT(*)\r\n          FROM [DemoEntities] AS [d0]\r\n          WHERE EXISTS (\r\n              SELECT 1\r\n              FROM (\r\n                  SELECT * FROM DemoEntities WHERE Id = @p0\r\n              ) AS [e0]\r\n              WHERE [e0].[Id] = [d0].[Id]) AND ([d].[Id] = [d0].[Id])) AS [Aggregate]\r\n      FROM [DemoEntities] AS [d]\r\n      WHERE EXISTS (\r\n          SELECT 1\r\n          FROM (\r\n              SELECT * FROM DemoEntities WHERE Id = @p0\r\n          ) AS [e]\r\n          WHERE [e].[Id] = [d].[Id])\r\n      GROUP BY [d].[Id]\r\nfail: Microsoft.EntityFrameworkCore.Query[10100]\r\n      An exception occurred while iterating over the results of a query for context type 'EfCoreVariableIssue.DemoDbContext'.\r\n      Microsoft.Data.SqlClient.SqlException (0x80131904): The variable name '@p0' has already been declared. Variable names must be unique within a query batch or stored procedure.\r\n         at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)\r\n         at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)\r\n         at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLUnhandled exception. ock, Boolean asyncClose)\r\n         at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)\r\n         at Microsoft.Data.SqlClient.SqlDataReader.TryConsumeMetaData()\r\n         at Microsoft.Data.SqlClient.SqlDataReader.get_MetaData()\r\n         at Microsoft.Data.SqlClient.SqlCommand.FinishExecuteReader(SqlDataReader ds, RunBehavior runBehavior, String resetOptionsString, Boolean isInternal, Boolean forDescribeParameterEncryption, Boolean shouldCacheForAlwaysEncrypted)\r\n         at Microsoft.Data.SqlClient.SqlCommand.RunExecuteReaderTds(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, Boolean isAsync, Int32 timeout, Task& task, Boolean asyncWrite, Boolean inRetry, SqlDataReader ds, Boolean describeParameterEncryptionRequest)\r\n         at Microsoft.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, TaskCompletionSource`1 completion, Int32 timeout, Task& task, Boolean& usedCache, Boolean asyncWrite, Boolean inRetry, String method)\r\n         at Microsoft.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method)\r\n         at Microsoft.Data.SqlClient.SqlCommand.ExecuteReader(CommandBehavior behavior)\r\n         at Microsoft.Data.SqlClient.SqlCommand.ExecuteDbDataReader(CommandBehavior behavior)\r\n         at System.Data.Common.DbCommand.ExecuteReader()\r\n         at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReader(RelationalCommandParameterObject parameterObject)\r\n         at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.Enumerator.InitializeReader(Enumerator enumerator)\r\n         at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.Enumerator.<>c.<MoveNext>b__19_0(DbContext _, Enumerator enumerator)\r\n         at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.Execute[TState,TResult](TState state, Func`3 operation, Func`3 verifySucceeded)\r\n         at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.Enumerator.MoveNext()\r\n      ClientConnectionId:d7b84c89-aa05-45e7-9eb2-dfaa349e20ec\r\n      Error Number:134,State:1,Class:15\r\n      Microsoft.Data.SqlClient.SqlException (0x80131904): The variable name '@p0' has already been declared. Variable names must be unique within a query batch or stored procedure.\r\n         at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)\r\n         at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)\r\n         at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)\r\n         at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)\r\n         at Microsoft.Data.SqlClient.SqlDataReader.TryConsumeMetaData()\r\n         at Microsoft.Data.SqlClient.SqlDataReader.get_MetaData()\r\n         at Microsoft.Data.SqlClient.SqlCommand.FinishExecuteReader(SqlDataReader ds, RunBehavior runBehavior, String resetOptionsString, Boolean isInternal, Boolean forDescribeParameterEncryption, Boolean shouldCacheForAlwaysEncrypted)\r\n         at Microsoft.Data.SqlClient.SqlCommand.RunExecuteReaderTds(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, Boolean isAsync, Int32 timeout, Task& task, Boolean asyncWrite, Boolean inRetry, SqlDataReader ds, Boolean describeParameterEncryptionRequest)\r\n         at Microsoft.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, TaskCompletionSource`1 completion, Int32 timeout, Task& task, Boolean& usedCache, Boolean asyncWrite, Boolean inRetry, String method)\r\n         at Microsoft.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method)\r\n         at Microsoft.Data.SqlClient.SqlCommand.ExecuteReader(CommandBehavior behavior)\r\n         at Microsoft.Data.SqlClient.SqlCommand.ExecuteDbDataReader(CommandBehavior behavior)\r\n         at System.Data.Common.DbCommand.ExecuteReader()\r\n         at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReader(RelationalCommandParameterObject parameterObject)\r\n         at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.Enumerator.InitializeReader(Enumerator enumerator)\r\n         at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.Enumerator.<>c.<MoveNext>b__19_0(DbContext _, Enumerator enumerator)\r\n         at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.Execute[TState,TResult](TState state, Func`3 operation, Func`3 verifySucceeded)\r\n         at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.Enumerator.MoveNext()\r\n      ClientConnectionId:d7b84c89-aa05-45e7-9eb2-dfaa349e20ec\r\n      Error Number:134,State:1,Class:15\r\nMicrosoft.Data.SqlClient.SqlException (0x80131904): The variable name '@p0' has already been declared. Variable names must be unique within a query batch or stored procedure.\r\n   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)\r\n   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)\r\n   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)\r\n   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)\r\n   at Microsoft.Data.SqlClient.SqlDataReader.TryConsumeMetaData()\r\n   at Microsoft.Data.SqlClient.SqlDataReader.get_MetaData()\r\n   at Microsoft.Data.SqlClient.SqlCommand.FinishExecuteReader(SqlDataReader ds, RunBehavior runBehavior, String resetOptionsString, Boolean isInternal, Boolean forDescribeParameterEncryption, Boolean shouldCacheForAlwaysEncrypted)\r\n   at Microsoft.Data.SqlClient.SqlCommand.RunExecuteReaderTds(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, Boolean isAsync, Int32 timeout, Task& task, Boolean asyncWrite, Boolean inRetry, SqlDataReader ds, Boolean describeParameterEncryptionRequest)\r\n   at Microsoft.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, TaskCompletionSource`1 completion, Int32 timeout, Task& task, Boolean& usedCache, Boolean asyncWrite, Boolean inRetry, String method)\r\n   at Microsoft.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method)\r\n   at Microsoft.Data.SqlClient.SqlCommand.ExecuteReader(CommandBehavior behavior)\r\n   at Microsoft.Data.SqlClient.SqlCommand.ExecuteDbDataReader(CommandBehavior behavior)\r\n   at System.Data.Common.DbCommand.ExecuteReader()\r\n   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReader(RelationalCommandParameterObject parameterObject)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.Enumerator.InitializeReader(Enumerator enumerator)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.Enumerator.<>c.<MoveNext>b__19_0(DbContext _, Enumerator enumerator)\r\n   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.Execute[TState,TResult](TState state, Func`3 operation, Func`3 verifySucceeded)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.Enumerator.MoveNext()\r\n   at System.Collections.Generic.List`1..ctor(IEnumerable`1 collection)\r\n   at System.Linq.Enumerable.ToList[TSource](IEnumerable`1 source)\r\n   at Program.<Main>$(String[] args) in E:\\Projects\\Test\\Solution1\\EfCoreVariableIssue\\Program.cs:line 23\r\n```\r\n\r\n## provider and version information\r\n\r\nEF Core version: 6.0.2\r\nDatabase provider: Microsoft.EntityFrameworkCore.SqlServer\r\nTarget framework: .NET 6.0\r\nOperating system: win10 x64\r\nIDE: JetBrains Rider 2021.3.3\r\n","closed_by":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/27427/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/27427/timeline","performed_via_github_app":null,"state_reason":"completed"}