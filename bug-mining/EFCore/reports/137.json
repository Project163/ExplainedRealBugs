{"url":"https://api.github.com/repos/dotnet/efcore/issues/29530","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/29530/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/29530/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/29530/events","html_url":"https://github.com/dotnet/efcore/issues/29530","id":1444292380,"node_id":"I_kwDOAPaMMs5WFicc","number":29530,"title":"Idempotent migration script not working on EFCore7.0 for AlterColumn when nullable changed from true to false","user":{"login":"PTAdvanced","id":18699042,"node_id":"MDQ6VXNlcjE4Njk5MDQy","avatar_url":"https://avatars.githubusercontent.com/u/18699042?v=4","gravatar_id":"","url":"https://api.github.com/users/PTAdvanced","html_url":"https://github.com/PTAdvanced","followers_url":"https://api.github.com/users/PTAdvanced/followers","following_url":"https://api.github.com/users/PTAdvanced/following{/other_user}","gists_url":"https://api.github.com/users/PTAdvanced/gists{/gist_id}","starred_url":"https://api.github.com/users/PTAdvanced/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/PTAdvanced/subscriptions","organizations_url":"https://api.github.com/users/PTAdvanced/orgs","repos_url":"https://api.github.com/users/PTAdvanced/repos","events_url":"https://api.github.com/users/PTAdvanced/events{/privacy}","received_events_url":"https://api.github.com/users/PTAdvanced/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1017558838,"node_id":"MDU6TGFiZWwxMDE3NTU4ODM4","url":"https://api.github.com/repos/dotnet/efcore/labels/Servicing-approved","name":"Servicing-approved","color":"048708","default":false,"description":""},{"id":1900942474,"node_id":"MDU6TGFiZWwxOTAwOTQyNDc0","url":"https://api.github.com/repos/dotnet/efcore/labels/area-migrations","name":"area-migrations","color":"32b37b","default":false,"description":""},{"id":2272800544,"node_id":"MDU6TGFiZWwyMjcyODAwNTQ0","url":"https://api.github.com/repos/dotnet/efcore/labels/area-sqlserver","name":"area-sqlserver","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/158","html_url":"https://github.com/dotnet/efcore/milestone/158","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/158/labels","id":8728724,"node_id":"MI_kwDOAPaMMs4AhTCU","number":158,"title":"7.0.3","description":null,"creator":{"login":"rbhanda","id":30737530,"node_id":"MDQ6VXNlcjMwNzM3NTMw","avatar_url":"https://avatars.githubusercontent.com/u/30737530?v=4","gravatar_id":"","url":"https://api.github.com/users/rbhanda","html_url":"https://github.com/rbhanda","followers_url":"https://api.github.com/users/rbhanda/followers","following_url":"https://api.github.com/users/rbhanda/following{/other_user}","gists_url":"https://api.github.com/users/rbhanda/gists{/gist_id}","starred_url":"https://api.github.com/users/rbhanda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rbhanda/subscriptions","organizations_url":"https://api.github.com/users/rbhanda/orgs","repos_url":"https://api.github.com/users/rbhanda/repos","events_url":"https://api.github.com/users/rbhanda/events{/privacy}","received_events_url":"https://api.github.com/users/rbhanda/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":46,"state":"closed","created_at":"2022-12-06T18:26:17Z","updated_at":"2023-02-21T20:44:42Z","due_on":null,"closed_at":"2023-02-15T01:31:11Z"},"comments":1,"created_at":"2022-11-10T17:27:17Z","updated_at":"2025-06-15T18:55:14Z","closed_at":"2023-01-05T13:04:50Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"After upgrading to .NET7 a Azure DevOps pipeline failed. Investigating I found that the idempotent migration script we generate to be applied to the target Azure SQL Database is failing to be applied, with the error\r\n\r\n##[error]Invalid column name 'CurrentSiteInvestigationDelayStatus_InvestigationDelayInSeconds'. \r\n\r\n### Include your code\r\n\r\nGenerating the idempotent migration script locally using .NET6 and then .NET7 reveals a difference in the generated SQL migration code.\r\n\r\nI have a migration definition defined as \r\n\r\n            migrationBuilder.AlterColumn<double>(\r\n                name: \"CurrentSiteInvestigationDelayStatus_InvestigationDelayInSeconds\",\r\n                table: \"SitesSet\",\r\n                type: \"float\",\r\n                nullable: false,\r\n                defaultValue: 0.0,\r\n                oldClrType: typeof(double),\r\n                oldType: \"float\",\r\n                oldNullable: true);\r\n\r\nEssentially the property is no longer nullable, and has a default value defined.\r\n\r\nin .NET6 this migration was generated as \r\n\r\n```\r\nIF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20220127150855_AddedOccurredAtToFireSystemStateAndInvestigationDelayState')\r\nBEGIN\r\n    DECLARE @var305 sysname;\r\n    SELECT @var305 = [d].[name]\r\n    FROM [sys].[default_constraints] [d]\r\n    INNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]\r\n    WHERE ([d].[parent_object_id] = OBJECT_ID(N'[SitesSet]') AND [c].[name] = N'CurrentSiteInvestigationDelayStatus_InvestigationDelayInSeconds');\r\n    IF @var305 IS NOT NULL EXEC(N'ALTER TABLE [SitesSet] DROP CONSTRAINT [' + @var305 + '];');\r\n    ALTER TABLE [SitesSet] ALTER COLUMN [CurrentSiteInvestigationDelayStatus_InvestigationDelayInSeconds] float NOT NULL;\r\n    ALTER TABLE [SitesSet] ADD DEFAULT 0.0E0 FOR [CurrentSiteInvestigationDelayStatus_InvestigationDelayInSeconds];\r\nEND;\r\nGO\r\n```\r\n\r\nin .NET7 this is generated as \r\n\r\n```\r\nIF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20220127150855_AddedOccurredAtToFireSystemStateAndInvestigationDelayState')\r\nBEGIN\r\n    DECLARE @var305 sysname;\r\n    SELECT @var305 = [d].[name]\r\n    FROM [sys].[default_constraints] [d]\r\n    INNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]\r\n    WHERE ([d].[parent_object_id] = OBJECT_ID(N'[SitesSet]') AND [c].[name] = N'CurrentSiteInvestigationDelayStatus_InvestigationDelayInSeconds');\r\n    IF @var305 IS NOT NULL EXEC(N'ALTER TABLE [SitesSet] DROP CONSTRAINT [' + @var305 + '];');\r\n    UPDATE [SitesSet] SET [CurrentSiteInvestigationDelayStatus_InvestigationDelayInSeconds] = 0.0E0 WHERE [CurrentSiteInvestigationDelayStatus_InvestigationDelayInSeconds] IS NULL;\r\n    ALTER TABLE [SitesSet] ALTER COLUMN [CurrentSiteInvestigationDelayStatus_InvestigationDelayInSeconds] float NOT NULL;\r\n    ALTER TABLE [SitesSet] ADD DEFAULT 0.0E0 FOR [CurrentSiteInvestigationDelayStatus_InvestigationDelayInSeconds];\r\nEND;\r\nGO\r\n```\r\n\r\nThe difference is in the .NET7 migration there is a \r\n\r\n```\r\nUPDATE [SitesSet] SET [CurrentSiteInvestigationDelayStatus_InvestigationDelayInSeconds] = 0.0E0 WHERE [CurrentSiteInvestigationDelayStatus_InvestigationDelayInSeconds] IS NULL;\r\n```\r\n\r\nI understand why this has been added, as previously I have created SQL updates like this to ensure any existing rows have the default applied where the current value is NULL.\r\n\r\nHowever, in this situation the column name has since been changed in a later migration.  Therefore when running the SQL script we encounter the error \r\n\r\n```\r\nInvalid column name 'CurrentSiteInvestigationDelayStatus_InvestigationDelayInSeconds'.\r\n```\r\n\r\nThe UPDATE statement should be wrapped in an EXEC(''); as recommended in the official docs here [Arbitrary changes via raw SQL](https://learn.microsoft.com/en-us/ef/core/managing-schemas/migrations/managing?tabs=dotnet-core-cli#arbitrary-changes-via-raw-sql)\r\n\r\n> \"EXEC is used when a statement must be the first or only one in a SQL batch. It can also be used to work around parser errors in idempotent migration scripts that can occur when referenced columns don't currently exist on a table.\"\r\n\r\n### Include provider and version information\r\n\r\nEF Core version:\r\nDatabase provider: (e.g. Microsoft.EntityFrameworkCore.SqlServer)\r\nTarget framework: (e.g. .NET 7.0)\r\nOperating system: WIndows 11\r\nIDE: (e.g. Visual Studio 2022 17.4)\r\n","closed_by":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/29530/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/29530/timeline","performed_via_github_app":null,"state_reason":"completed"}