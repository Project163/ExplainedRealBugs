{"url":"https://api.github.com/repos/dotnet/efcore/issues/29814","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/29814/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/29814/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/29814/events","html_url":"https://github.com/dotnet/efcore/issues/29814","id":1487062953,"node_id":"I_kwDOAPaMMs5Yosep","number":29814,"title":"Use interpreted dynamic delegates when they're invoked just once, instead of compiling","user":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":130861068,"node_id":"MDU6TGFiZWwxMzA4NjEwNjg=","url":"https://api.github.com/repos/dotnet/efcore/labels/area-perf","name":"area-perf","color":"5319e7","default":false,"description":""},{"id":1675384372,"node_id":"MDU6TGFiZWwxNjc1Mzg0Mzcy","url":"https://api.github.com/repos/dotnet/efcore/labels/area-query","name":"area-query","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/152","html_url":"https://github.com/dotnet/efcore/milestone/152","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/152/labels","id":8392036,"node_id":"MI_kwDOAPaMMs4AgA1k","number":152,"title":"8.0.0","description":"EF Core 8.0","creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":280,"state":"closed","created_at":"2022-09-07T19:55:36Z","updated_at":"2025-04-07T08:59:46Z","due_on":null,"closed_at":"2023-11-14T14:00:33Z"},"comments":1,"created_at":"2022-12-09T16:45:50Z","updated_at":"2025-06-15T18:56:59Z","closed_at":"2023-01-02T15:29:08Z","author_association":"MEMBER","type":{"id":1092406,"node_id":"IT_kwDOAIt-yc4AEKs2","name":"Feature","description":"A request, idea, or new functionality","color":"blue","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-10-08T09:10:05Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"In various places in the code, we compile an expression tree to a delegate, and then invoke it just once. For example, in [ParameterExtractingExpressionVisitor](https://github.com/dotnet/efcore/blob/main/src/EFCore/Query/Internal/ParameterExtractingExpressionVisitor.cs#L448), fragments of the expression tree which can be client-evaluated are evaluated by compiling those fragments into a delegate and then invoking that delegate.\r\n\r\nThe expression compilation API allows controlling whether the resulting delegate is compiled to IL (to be later JITted), or whether the delegate should just be interpreted. Doing the work of compilation (and jitting!) to just run the code once is quite inefficient - see benchmark below.\r\n\r\nIn addition, it's possible that continuously compiling delegates causes code bloat (not sure of the JITted code ever goes away). Interpretation should mitigate that too.\r\n\r\n|    Method | TreeDepth | NodeType | DelegateType |              Mean |          Error |         StdDev |\r\n|---------- |---------- |--------- |------------- |------------------:|---------------:|---------------:|\r\n|      Once |         1 |      Add |     Compiled |         0.5192 ns |      0.0402 ns |      0.0356 ns |\r\n|      Once |         1 |      Add |  Interpreted |        91.9521 ns |      0.5005 ns |      0.4437 ns |\r\n|      Once |         1 |     Call |     Compiled |         0.5168 ns |      0.0041 ns |      0.0032 ns |\r\n|      Once |         1 |     Call |  Interpreted |        94.2390 ns |      0.4193 ns |      0.3502 ns |\r\n| EveryTime |         1 |      Add |     Compiled |    37,249.1127 ns |    736.1745 ns |  1,167.6508 ns |\r\n| EveryTime |         1 |      Add |  Interpreted |     1,636.6028 ns |     19.6829 ns |     18.4114 ns |\r\n| EveryTime |         1 |     Call |     Compiled |    45,410.4435 ns |    899.1323 ns |    841.0489 ns |\r\n| EveryTime |         1 |     Call |  Interpreted |     1,680.2431 ns |     12.5205 ns |     11.0991 ns |\r\n|      Once |        10 |      Add |     Compiled |         0.5199 ns |      0.0132 ns |      0.0117 ns |\r\n|      Once |        10 |      Add |  Interpreted |       265.8891 ns |      2.2637 ns |      2.1175 ns |\r\n|      Once |        10 |     Call |     Compiled |         0.0618 ns |      0.0026 ns |      0.0020 ns |\r\n|      Once |        10 |     Call |  Interpreted |       259.1131 ns |      0.6866 ns |      0.6423 ns |\r\n| EveryTime |        10 |      Add |     Compiled |    45,024.5658 ns |    887.9222 ns |  2,057.8948 ns |\r\n| EveryTime |        10 |      Add |  Interpreted |     2,802.1430 ns |      7.6220 ns |      6.7567 ns |\r\n| EveryTime |        10 |     Call |     Compiled |    75,013.6080 ns |  1,449.9254 ns |  2,170.1801 ns |\r\n| EveryTime |        10 |     Call |  Interpreted |     3,402.9787 ns |      3.6309 ns |      2.8347 ns |\r\n|      Once |       100 |      Add |     Compiled |         0.5194 ns |      0.0188 ns |      0.0166 ns |\r\n|      Once |       100 |      Add |  Interpreted |     1,885.6130 ns |      3.0590 ns |      2.5544 ns |\r\n|      Once |       100 |     Call |     Compiled |         0.5262 ns |      0.0039 ns |      0.0033 ns |\r\n|      Once |       100 |     Call |  Interpreted |     1,927.5032 ns |      3.5941 ns |      3.0012 ns |\r\n| EveryTime |       100 |      Add |     Compiled |    77,491.0032 ns |  1,016.8876 ns |    951.1973 ns |\r\n| EveryTime |       100 |      Add |  Interpreted |    13,941.0736 ns |    119.1034 ns |    105.5821 ns |\r\n| EveryTime |       100 |     Call |     Compiled |   352,433.7320 ns |  3,664.6569 ns |  3,248.6229 ns |\r\n| EveryTime |       100 |     Call |  Interpreted |    20,881.0007 ns |    175.9068 ns |    155.9368 ns |\r\n|      Once |      1000 |      Add |     Compiled |         0.5217 ns |      0.0046 ns |      0.0036 ns |\r\n|      Once |      1000 |      Add |  Interpreted |    17,504.4514 ns |     78.3508 ns |     65.4264 ns |\r\n|      Once |      1000 |     Call |     Compiled |       539.6946 ns |      4.2658 ns |      3.7815 ns |\r\n|      Once |      1000 |     Call |  Interpreted |    17,988.3271 ns |     32.0835 ns |     26.7912 ns |\r\n| EveryTime |      1000 |      Add |     Compiled |   486,345.0278 ns |  1,983.4168 ns |  1,758.2474 ns |\r\n| EveryTime |      1000 |      Add |  Interpreted |   130,073.6554 ns |  1,509.4981 ns |  1,411.9855 ns |\r\n| EveryTime |      1000 |     Call |     Compiled | 7,619,107.3270 ns | 20,203.8816 ns | 17,910.2148 ns |\r\n| EveryTime |      1000 |     Call |  Interpreted |   175,068.3599 ns |  2,508.8744 ns |  2,346.8026 ns |\r\n\r\nNotes:\r\n\r\n* The Once scenarios are only included for reference; it's obviously better to compile when the same delegate is executed many times.\r\n* The expression tree benchmarked is composed of variable number of Add or Call nodes, to see the effect for various node types and various tree depths. Interpreting is always better than compiling for one-off scenarios.\r\n\r\n<details>\r\n<summary>Benchmark code</summary>\r\n\r\n```c#\r\nBenchmarkRunner.Run<Benchmark>();\r\n\r\npublic class Benchmark\r\n{\r\n    [Params(1, 10, 100, 1000)]\r\n    public int TreeDepth { get; set; }\r\n\r\n    [Params(NodeType.Call, NodeType.Add)]\r\n    public NodeType NodeType { get; set; }\r\n\r\n    [Params(DelegateType.Compiled, DelegateType.Interpreted)]\r\n    public DelegateType DelegateType { get; set; }\r\n\r\n    private Expression<Func<int, int>> _expressionTree;\r\n    private Func<int, int> _compiledDelegate;\r\n\r\n    [GlobalSetup]\r\n    public void Setup()\r\n    {\r\n        _expressionTree = GenerateExpressionTree(TreeDepth);\r\n        _compiledDelegate = _expressionTree.Compile(preferInterpretation: DelegateType == DelegateType.Interpreted);\r\n    }\r\n\r\n    private Expression<Func<int, int>> GenerateExpressionTree(int depth)\r\n    {\r\n        var p = Expression.Parameter(typeof(int));\r\n        var node = CreateNode(p, Expression.Constant(1));\r\n\r\n        for (var i = 1; i < depth; i++)\r\n            node = CreateNode(node, Expression.Constant(1));\r\n\r\n        return Expression.Lambda<Func<int, int>>(node, p);\r\n\r\n        Expression CreateNode(Expression a, Expression b)\r\n            => NodeType == NodeType.Add\r\n                ? Expression.Add(a, b)\r\n                : Expression.Call(MyAddMethod, a, b);\r\n    }\r\n\r\n    [Benchmark]\r\n    public int Once()\r\n        => _compiledDelegate(8);\r\n\r\n    [Benchmark]\r\n    public int EveryTime()\r\n    {\r\n        var compiledDelegate = _expressionTree.Compile(preferInterpretation: DelegateType == DelegateType.Interpreted);\r\n        return compiledDelegate(8);\r\n    }\r\n\r\n    private static readonly MethodInfo MyAddMethod\r\n        = typeof(Benchmark).GetMethod(nameof(MyAdd), new[] { typeof(int), typeof(int) })!;\r\n\r\n    public static int MyAdd(int x, int y) => x + y;\r\n}\r\n\r\npublic enum DelegateType\r\n{\r\n    Compiled,\r\n    Interpreted\r\n}\r\n\r\npublic enum NodeType\r\n{\r\n    Add,\r\n    Call\r\n}\r\n```\r\n\r\n</details>","closed_by":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/29814/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/29814/timeline","performed_via_github_app":null,"state_reason":"completed"}