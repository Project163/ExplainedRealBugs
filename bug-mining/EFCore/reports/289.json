{"url":"https://api.github.com/repos/dotnet/efcore/issues/29874","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/29874/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/29874/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/29874/events","html_url":"https://github.com/dotnet/efcore/issues/29874","id":1500912920,"node_id":"I_kwDOAPaMMs5Zdh0Y","number":29874,"title":"Replacing PK to PK TPT or TPC dependent with different type fails","user":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1900941009,"node_id":"MDU6TGFiZWwxOTAwOTQxMDA5","url":"https://api.github.com/repos/dotnet/efcore/labels/area-save-changes","name":"area-save-changes","color":"32b37b","default":false,"description":""},{"id":1900941630,"node_id":"MDU6TGFiZWwxOTAwOTQxNjMw","url":"https://api.github.com/repos/dotnet/efcore/labels/area-model-building","name":"area-model-building","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/152","html_url":"https://github.com/dotnet/efcore/milestone/152","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/152/labels","id":8392036,"node_id":"MI_kwDOAPaMMs4AgA1k","number":152,"title":"8.0.0","description":"EF Core 8.0","creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":280,"state":"closed","created_at":"2022-09-07T19:55:36Z","updated_at":"2025-04-07T08:59:46Z","due_on":null,"closed_at":"2023-11-14T14:00:33Z"},"comments":0,"created_at":"2022-12-16T21:47:23Z","updated_at":"2025-06-15T18:57:25Z","closed_at":"2023-10-10T20:40:08Z","author_association":"CONTRIBUTOR","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Same scenario as #29789, except that this also did not work in EF Core 6.0.\r\n\r\nWhen using TPT, a new row is inserted for the new type, but the old row for the existing type is not removed.\r\n\r\nWhen using TPC, the following is thrown during model building:\r\n\r\n```\r\nSystem.InvalidOperationException\r\nNullable object must have a value.\r\n   at System.Nullable`1.get_Value()\r\n   at Microsoft.EntityFrameworkCore.Metadata.Internal.RelationalForeignKeyExtensions.<GetDefaultName>g__ShareAnyFragments|2_0(IReadOnlyEntityType entityType1, IReadOnlyEntityType entityType2) in C:\\github\\efcore\\src\\EFCore.Relational\\Metadata\\Internal\\RelationalForeignKeyExtensions.cs:line 334\r\n   at Microsoft.EntityFrameworkCore.Metadata.Internal.RelationalForeignKeyExtensions.GetDefaultName(IReadOnlyForeignKey foreignKey, StoreObjectIdentifier& storeObject, StoreObjectIdentifier& principalStoreObject, IDiagnosticsLogger`1 logger) in C:\\github\\efcore\\src\\EFCore.Relational\\Metadata\\Internal\\RelationalForeignKeyExtensions.cs:line 295\r\n   at Microsoft.EntityFrameworkCore.Metadata.Internal.RelationalForeignKeyExtensions.GetConstraintName(IReadOnlyForeignKey foreignKey, StoreObjectIdentifier& storeObject, StoreObjectIdentifier& principalStoreObject, IDiagnosticsLogger`1 logger) in C:\\github\\efcore\\src\\EFCore.Relational\\Metadata\\Internal\\RelationalForeignKeyExtensions.cs:line 185\r\n   at Microsoft.EntityFrameworkCore.RelationalForeignKeyExtensions.GetConstraintName(IReadOnlyForeignKey foreignKey, StoreObjectIdentifier& storeObject, StoreObjectIdentifier& principalStoreObject) in C:\\github\\efcore\\src\\EFCore.Relational\\Extensions\\RelationalForeignKeyExtensions.cs:line 48\r\n   at Microsoft.EntityFrameworkCore.Metadata.Conventions.SharedTableConvention.TryUniquifyForeignKeyNames(IConventionEntityType entityType, Dictionary`2 foreignKeys, StoreObjectIdentifier& storeObject, Int32 maxLength) in C:\\github\\efcore\\src\\EFCore.Relational\\Metadata\\Conventions\\SharedTableConvention.cs:line 486\r\n   at Microsoft.EntityFrameworkCore.Metadata.Conventions.SharedTableConvention.ProcessModelFinalizing(IConventionModelBuilder modelBuilder, IConventionContext`1 context) in C:\\github\\efcore\\src\\EFCore.Relational\\Metadata\\Conventions\\SharedTableConvention.cs:line 89\r\n   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.ImmediateConventionScope.OnModelFinalizing(IConventionModelBuilder modelBuilder) in C:\\github\\efcore\\src\\EFCore\\Metadata\\Conventions\\Internal\\ConventionDispatcher.ImmediateConventionScope.cs:line 77\r\n   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.OnModelFinalizing(IConventionModelBuilder modelBuilder) in C:\\github\\efcore\\src\\EFCore\\Metadata\\Conventions\\Internal\\ConventionDispatcher.cs:line 57\r\n   at Microsoft.EntityFrameworkCore.Metadata.Internal.Model.FinalizeModel() in C:\\github\\efcore\\src\\EFCore\\Metadata\\Internal\\Model.cs:line 921\r\n   at Microsoft.EntityFrameworkCore.ModelBuilder.FinalizeModel() in C:\\github\\efcore\\src\\EFCore\\ModelBuilder.cs:line 631\r\n   at Microsoft.EntityFrameworkCore.TestUtilities.TestModelSource.CreateModel(DbContext context, IConventionSetBuilder conventionSetBuilder, ModelDependencies modelDependencies) in C:\\github\\efcore\\test\\EFCore.Specification.Tests\\TestUtilities\\TestModelSource.cs:line 39\r\n   at Microsoft.EntityFrameworkCore.Infrastructure.ModelSource.GetModel(DbContext context, ModelCreationDependencies modelCreationDependencies, Boolean designTime) in C:\\github\\efcore\\src\\EFCore\\Infrastructure\\ModelSource.cs:line 69\r\n   at Microsoft.EntityFrameworkCore.Internal.DbContextServices.CreateModel(Boolean designTime) in C:\\github\\efcore\\src\\EFCore\\Internal\\DbContextServices.cs:line 86\r\n   at Microsoft.EntityFrameworkCore.Internal.DbContextServices.get_Model() in C:\\github\\efcore\\src\\EFCore\\Internal\\DbContextServices.cs:line 113\r\n   at Microsoft.EntityFrameworkCore.Infrastructure.EntityFrameworkServicesBuilder.<>c.<TryAddCoreServices>b__8_4(IServiceProvider p) in C:\\github\\efcore\\src\\EFCore\\Infrastructure\\EntityFrameworkServicesBuilder.cs:line 281\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitFactory(FactoryCallSite factoryCallSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.Resolve(ServiceCallSite callSite, ServiceProviderEngineScope scope)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.DynamicServiceProviderEngine.<>c__DisplayClass2_0.<RealizeService>b__0(ServiceProviderEngineScope scope)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceProvider.GetService(Type serviceType, ServiceProviderEngineScope serviceProviderEngineScope)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.ServiceProviderEngineScope.GetService(Type serviceType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService(IServiceProvider provider, Type serviceType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService[T](IServiceProvider provider)\r\n   at Microsoft.EntityFrameworkCore.DbContext.get_DbContextDependencies() in C:\\github\\efcore\\src\\EFCore\\DbContext.cs:line 464\r\n   at Microsoft.EntityFrameworkCore.DbContext.get_ContextServices() in C:\\github\\efcore\\src\\EFCore\\DbContext.cs:line 446\r\n   at Microsoft.EntityFrameworkCore.DbContext.get_InternalServiceProvider() in C:\\github\\efcore\\src\\EFCore\\DbContext.cs:line 400\r\n   at Microsoft.EntityFrameworkCore.DbContext.Microsoft.EntityFrameworkCore.Infrastructure.IInfrastructure<System.IServiceProvider>.get_Instance() in C:\\github\\efcore\\src\\EFCore\\DbContext.cs:line 2215\r\n   at Microsoft.EntityFrameworkCore.Infrastructure.Internal.InfrastructureExtensions.GetService[TService](IInfrastructure`1 accessor) in C:\\github\\efcore\\src\\EFCore\\Infrastructure\\Internal\\InfrastructureExtensions.cs:line 25\r\n   at Microsoft.EntityFrameworkCore.Infrastructure.AccessorExtensions.GetService[TService](IInfrastructure`1 accessor) in C:\\github\\efcore\\src\\EFCore\\Infrastructure\\AccessorExtensions.cs:line 42\r\n   at Microsoft.EntityFrameworkCore.Infrastructure.DatabaseFacade.get_Dependencies() in C:\\github\\efcore\\src\\EFCore\\Infrastructure\\DatabaseFacade.cs:line 31\r\n   at Microsoft.EntityFrameworkCore.Infrastructure.DatabaseFacade.CreateExecutionStrategy() in C:\\github\\efcore\\src\\EFCore\\Infrastructure\\DatabaseFacade.cs:line 352\r\n   at Microsoft.EntityFrameworkCore.TestUtilities.DatabaseFacadeExtensions.EnsureCreatedResiliently(DatabaseFacade fa√ßade) in C:\\github\\efcore\\test\\EFCore.Specification.Tests\\TestUtilities\\DatabaseFacadeExtensions.cs:line 9\r\n   at Microsoft.EntityFrameworkCore.TestUtilities.SqlServerTestStore.Initialize(Func`1 createContext, Action`1 seed, Action`1 clean) in C:\\github\\efcore\\test\\EFCore.SqlServer.FunctionalTests\\TestUtilities\\SqlServerTestStore.cs:line 101\r\n   at Microsoft.EntityFrameworkCore.TestUtilities.TestStore.<>c__DisplayClass13_0.<Initialize>b__0() in C:\\github\\efcore\\test\\EFCore.Specification.Tests\\TestUtilities\\TestStore.cs:line 36\r\n   at Microsoft.EntityFrameworkCore.TestUtilities.TestStoreIndex.CreateShared(String name, Action initializeDatabase) in C:\\github\\efcore\\test\\EFCore.Specification.Tests\\TestUtilities\\TestStoreIndex.cs:line 25\r\n   at Microsoft.EntityFrameworkCore.TestUtilities.TestStore.Initialize(IServiceProvider serviceProvider, Func`1 createContext, Action`1 seed, Action`1 clean) in C:\\github\\efcore\\test\\EFCore.Specification.Tests\\TestUtilities\\TestStore.cs:line 36\r\n   at Microsoft.EntityFrameworkCore.TestUtilities.RelationalTestStore.Initialize(IServiceProvider serviceProvider, Func`1 createContext, Action`1 seed, Action`1 clean) in C:\\github\\efcore\\test\\EFCore.Relational.Specification.Tests\\TestUtilities\\RelationalTestStore.cs:line 40\r\n   at Microsoft.EntityFrameworkCore.SharedStoreFixtureBase`1.InitializeAsync() in C:\\github\\efcore\\test\\EFCore.Specification.Tests\\SharedStoreFixtureBase.cs:line 65\r\n   at Xunit.Sdk.ExceptionAggregator.RunAsync(Func`1 code) in /_/src/xunit.core/Sdk/ExceptionAggregator.cs:line 90\r\n```","closed_by":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/29874/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/29874/timeline","performed_via_github_app":null,"state_reason":"completed"}