{"url":"https://api.github.com/repos/dotnet/efcore/issues/36903","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/36903/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/36903/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/36903/events","html_url":"https://github.com/dotnet/efcore/issues/36903","id":3476517070,"node_id":"I_kwDOAPaMMs7PN3DO","number":36903,"title":"Cosmos 11.0 CUD batching  RequestEntityTooLarge errors","user":{"login":"JoasE","id":32096708,"node_id":"MDQ6VXNlcjMyMDk2NzA4","avatar_url":"https://avatars.githubusercontent.com/u/32096708?v=4","gravatar_id":"","url":"https://api.github.com/users/JoasE","html_url":"https://github.com/JoasE","followers_url":"https://api.github.com/users/JoasE/followers","following_url":"https://api.github.com/users/JoasE/following{/other_user}","gists_url":"https://api.github.com/users/JoasE/gists{/gist_id}","starred_url":"https://api.github.com/users/JoasE/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JoasE/subscriptions","organizations_url":"https://api.github.com/users/JoasE/orgs","repos_url":"https://api.github.com/users/JoasE/repos","events_url":"https://api.github.com/users/JoasE/events{/privacy}","received_events_url":"https://api.github.com/users/JoasE/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1686778100,"node_id":"MDU6TGFiZWwxNjg2Nzc4MTAw","url":"https://api.github.com/repos/dotnet/efcore/labels/area-cosmos","name":"area-cosmos","color":"32b37b","default":false,"description":""},{"id":2402623482,"node_id":"MDU6TGFiZWwyNDAyNjIzNDgy","url":"https://api.github.com/repos/dotnet/efcore/labels/community-contribution","name":"community-contribution","color":"004caa","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/214","html_url":"https://github.com/dotnet/efcore/milestone/214","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/214/labels","id":13093949,"node_id":"MI_kwDOAPaMMs4Ax8w9","number":214,"title":"11.0.0","description":null,"creator":{"login":"cincuranet","id":4540597,"node_id":"MDQ6VXNlcjQ1NDA1OTc=","avatar_url":"https://avatars.githubusercontent.com/u/4540597?v=4","gravatar_id":"","url":"https://api.github.com/users/cincuranet","html_url":"https://github.com/cincuranet","followers_url":"https://api.github.com/users/cincuranet/followers","following_url":"https://api.github.com/users/cincuranet/following{/other_user}","gists_url":"https://api.github.com/users/cincuranet/gists{/gist_id}","starred_url":"https://api.github.com/users/cincuranet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cincuranet/subscriptions","organizations_url":"https://api.github.com/users/cincuranet/orgs","repos_url":"https://api.github.com/users/cincuranet/repos","events_url":"https://api.github.com/users/cincuranet/events{/privacy}","received_events_url":"https://api.github.com/users/cincuranet/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":62,"closed_issues":17,"state":"open","created_at":"2025-06-16T18:44:38Z","updated_at":"2025-11-09T13:05:34Z","due_on":null,"closed_at":null},"comments":25,"created_at":"2025-10-02T08:05:59Z","updated_at":"2025-10-26T13:52:05Z","closed_at":"2025-10-23T23:21:40Z","author_association":"CONTRIBUTOR","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Bug description\n\nOn the main branch, (unreleased 11.0), EFCore will throw an DbUpdateException when adding 2 or more entities of total size larger than 2MB in the same partition key. This would succeed on 10.0. It will also succeed when using AutoTransactionBehavior.Never on 11.0 as it will skip batching.\n\nThis is because the total request body size limit for both single writes and transactional batches is 2MB. Meaning all writes in a single transactional batch combined can not exceed 2MB. \n\nWe could get the current batch entry size as we are serializing to a stream already, and add a safe and/or calculated margin for request metadata. We would most likeley need to calculate the size of some request metadata like id and session token, and add a safe margin for the property serialization. Then EF Core could automatically split the writes into 2 batches, and only throw with AutoTransactionBehavior.Always. However, I am currently not 100% sure what this safe margin should be, but I found [this 200 byte margin in the cosmos db source code](https://github.com/Azure/azure-cosmos-dotnet-v3/blob/895697d6448b509d7b3df0d6773b2f84a7039e30/Microsoft.Azure.Cosmos/src/Batch/ServerBatchRequest.cs#L112). Also see: Also see: https://github.com/Azure/azure-cosmos-dotnet-v3/issues/5406. I think if a single entity is larger than 2MB, we should still throw a DbUpdateException. (by sending the request (as a single write))\n\nWe could also choose to leave the management of the batch size up to the user. The user would be responsible for adding a SaveChanges call when the request limit might have been reached. However, since ef core internally already knows much more about the request size, it would be nice if it could handle this for the user.\n\n### Your code\n\n```csharp\n[ConditionalFact]\npublic virtual async Task SaveChanges_three_1mb_entries_succeeds()\n{\n    var contextFactory = await InitializeAsync<TransactionalBatchContext>();\n\n    using var context = contextFactory.CreateContext();\n\n    context.Customers.Add(new Customer { Id = \"1\", Name = new string('x', 1_000_000), PartitionKey = \"1\" });\n    context.Customers.Add(new Customer { Id = \"2\", Name = new string('x', 1_000_000), PartitionKey = \"1\" });\n    context.Customers.Add(new Customer { Id = \"3\", Name = new string('x', 1_000_000), PartitionKey = \"1\" });\n\n    await context.SaveChangesAsync(); // Fails: DbUpdateException: CosmosException: Response status code does not indicate success: RequestEntityTooLarge \n\n    using var assertContext = contextFactory.CreateContext();\n    var customersCount = await assertContext.Customers.CountAsync();\n    Assert.Equal(3, customersCount);\n}\n```\n\n### Stack traces\n\n```text\nMicrosoft.EntityFrameworkCore.DbUpdateException : An error occurred while saving the item with id '1'. See the inner exception for details.\n  ---- Microsoft.Azure.Cosmos.CosmosException : Response status code does not indicate success: RequestEntityTooLarge (413); Substatus: 0; ActivityId: 86a70068-2c8f-4076-a1f9-fafd894c963b; Reason: ({\"code\":\"RequestEntityTooLarge\",\"message\":\"Message: {\\\"Errors\\\":[\\\"Request size is too large\\\"]}\\r\\nActivityId: 86a70068-2c8f-4076-a1f9-fafd894c963b, Request URI: /apps/DocDbApp/services/DocDbServer20/partitions/a4cb4960-38c8-11e6-8106-8cdcd42c33be/replicas/1p/, RequestStats: \\r\\nRequestStartTime: 2025-10-02T08:02:20.0451545Z, RequestEndTime: 2025-10-02T08:02:20.0520695Z,  Number of regions attempted:1\\r\\n{\\\"systemHistory\\\":[{\\\"dateUtc\\\":\\\"2025-10-02T08:01:23.5087928Z\\\",\\\"cpu\\\":7.172,\\\"memory\\\":26977176.000,\\\"threadInfo\\\":{\\\"isThreadStarving\\\":\\\"False\\\",\\\"threadWaitIntervalInMs\\\":0.0718,\\\"availableThreads\\\":32765,\\\"minThreads\\\":16,\\\"maxThreads\\\":32767},\\\"numberOfOpenTcpConnection\\\":1},{\\\"dateUtc\\\":\\\"2025-10-02T08:01:33.5241220Z\\\",\\\"cpu\\\":18.503,\\\"memory\\\":26808748.000,\\\"threadInfo\\\":{\\\"isThreadStarving\\\":\\\"False\\\",\\\"threadWaitIntervalInMs\\\":0.032,\\\"availableThreads\\\":32765,\\\"minThreads\\\":16,\\\"maxThreads\\\":32767},\\\"numberOfOpenTcpConnection\\\":1},{\\\"dateUtc\\\":\\\"2025-10-02T08:01:43.5298142Z\\\",\\\"cpu\\\":13.473,\\\"memory\\\":26748008.000,\\\"threadInfo\\\":{\\\"isThreadStarving\\\":\\\"False\\\",\\\"threadWaitIntervalInMs\\\":0.1671,\\\"availableThreads\\\":32765,\\\"minThreads\\\":16,\\\"maxThreads\\\":32767},\\\"numberOfOpenTcpConnection\\\":1},{\\\"dateUtc\\\":\\\"2025-10-02T08:01:53.5354127Z\\\",\\\"cpu\\\":10.751,\\\"memory\\\":26639312.000,\\\"threadInfo\\\":{\\\"isThreadStarving\\\":\\\"False\\\",\\\"threadWaitIntervalInMs\\\":0.3375,\\\"availableThreads\\\":32765,\\\"minThreads\\\":16,\\\"maxThreads\\\":32767},\\\"numberOfOpenTcpConnection\\\":1},{\\\"dateUtc\\\":\\\"2025-10-02T08:02:03.5497815Z\\\",\\\"cpu\\\":51.983,\\\"memory\\\":26308516.000,\\\"threadInfo\\\":{\\\"isThreadStarving\\\":\\\"False\\\",\\\"threadWaitIntervalInMs\\\":0.4465,\\\"availableThreads\\\":32765,\\\"minThreads\\\":16,\\\"maxThreads\\\":32767},\\\"numberOfOpenTcpConnection\\\":1},{\\\"dateUtc\\\":\\\"2025-10-02T08:02:13.5647290Z\\\",\\\"cpu\\\":19.250,\\\"memory\\\":26024224.000,\\\"threadInfo\\\":{\\\"isThreadStarving\\\":\\\"False\\\",\\\"threadWaitIntervalInMs\\\":0.0572,\\\"availableThreads\\\":32765,\\\"minThreads\\\":16,\\\"maxThreads\\\":32767},\\\"numberOfOpenTcpConnection\\\":1}]}\\r\\nRequestStart: 2025-10-02T08:02:20.0454558Z; ResponseTime: 2025-10-02T08:02:20.0520695Z; StoreResult: StorePhysicalAddress: rntbd://127.0.0.1:10253/apps/DocDbApp/services/DocDbServer20/partitions/a4cb4960-38c8-11e6-8106-8cdcd42c33be/replicas/1p/, LSN: -1, GlobalCommittedLsn: -1, PartitionKeyRangeId: , IsValid: False, StatusCode: 413, SubStatusCode: 0, RequestCharge: 0, ItemLSN: -1, SessionToken: , UsingLocalLSN: False, TransportException: null, BELatencyMs: , ActivityId: 86a70068-2c8f-4076-a1f9-fafd894c963b, RetryAfterInMs: , ReplicaHealthStatuses: [(port: 10253 | status: Connected | lkt: 30/09/2025 13:28:29)], TransportRequestTimeline: {\\\"requestTimeline\\\":[{\\\"event\\\": \\\"Created\\\", \\\"startTimeUtc\\\": \\\"2025-10-02T08:02:20.0454579Z\\\", \\\"durationInMs\\\": 0.0317},{\\\"event\\\": \\\"ChannelAcquisitionStarted\\\", \\\"startTimeUtc\\\": \\\"2025-10-02T08:02:20.0454896Z\\\", \\\"durationInMs\\\": 0.004},{\\\"event\\\": \\\"Pipelined\\\", \\\"startTimeUtc\\\": \\\"2025-10-02T08:02:20.0454936Z\\\", \\\"durationInMs\\\": 6.0733},{\\\"event\\\": \\\"Transit Time\\\", \\\"startTimeUtc\\\": \\\"2025-10-02T08:02:20.0515669Z\\\", \\\"durationInMs\\\": 0.1215},{\\\"event\\\": \\\"Received\\\", \\\"startTimeUtc\\\": \\\"2025-10-02T08:02:20.0516884Z\\\", \\\"durationInMs\\\": 0.0722},{\\\"event\\\": \\\"Completed\\\", \\\"startTimeUtc\\\": \\\"2025-10-02T08:02:20.0517606Z\\\", \\\"durationInMs\\\": 0}],\\\"serviceEndpointStats\\\":{\\\"inflightRequests\\\":1,\\\"openConnections\\\":1},\\\"connectionStats\\\":{\\\"waitforConnectionInit\\\":\\\"False\\\",\\\"callsPendingReceive\\\":0,\\\"lastSendAttempt\\\":\\\"2025-10-02T08:02:19.9980359Z\\\",\\\"lastSend\\\":\\\"2025-10-02T08:02:19.9980455Z\\\",\\\"lastReceive\\\":\\\"2025-10-02T08:02:19.9991617Z\\\"},\\\"requestSizeInBytes\\\":3000849,\\\"requestBodySizeInBytes\\\":3000359,\\\"responseMetadataSizeInBytes\\\":23,\\\"responseBodySizeInBytes\\\":40};\\r\\n ResourceType: Document, OperationType: Batch\\r\\n, SDK: Microsoft.Azure.Documents.Common/2.14.0\"}\n  RequestUri: https://127.0.0.1:8081/dbs/CosmosTransactionalBatchTest/colls/TransactionalBatchContext/docs;\n  RequestMethod: POST;\n  Header: Authorization Length: 80;\n  Header: x-ms-date Length: 29;\n  Header: x-ms-documentdb-partitionkey Length: 5;\n  Header: x-ms-cosmos-batch-atomic Length: 4;\n  Header: x-ms-cosmos-batch-ordered Length: 4;\n  Header: x-ms-cosmos-sdk-supportedcapabilities Length: 1;\n  Header: x-ms-cosmos-is-batch-request Length: 4;\n  Header: x-ms-activity-id Length: 36;\n  Header: Cache-Control Length: 8;\n  Header: User-Agent Length: 153;\n  Header: x-ms-version Length: 10;\n  Header: Accept Length: 16;\n  , Request URI: /dbs/CosmosTransactionalBatchTest/colls/TransactionalBatchContext/docs, RequestStats: Microsoft.Azure.Cosmos.Tracing.TraceData.ClientSideRequestStatisticsTraceDatum, SDK: Windows/10.0.26100 cosmos-netstandard-sdk/3.38.0);\n\nStack Trace: \n  CosmosDatabaseWrapper.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken) line 164\n  StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken) line 1335\n  StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken) line 1429\n  <<ExecuteAsync>b__0>d.MoveNext() line 307\n  --- End of stack trace from previous location ---\n  ExecutionStrategy.ExecuteImplementationAsync[TState,TResult](Func`4 operation, Func`4 verifySucceeded, TState state, CancellationToken cancellationToken) line 330\n  ExecutionStrategy.ExecuteImplementationAsync[TState,TResult](Func`4 operation, Func`4 verifySucceeded, TState state, CancellationToken cancellationToken) line 354\n  ExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken) line 306\n  DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken) line 787\n  DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken) line 822\n  CosmosTransactionalBatchTest.SaveChanges_three_1mb_entries_succeeds() line 267\n  --- End of stack trace from previous location ---\n  ----- Inner Stack Trace -----\n```\n\n### Verbose output\n\n```text\n\n```\n\n### EF Core version\n\n11.0.0\n\n### Database provider\n\nMicrosoft.EntityFrameworkCore.Cosmos\n\n### Target framework\n\n10.0-rc1\n\n### Operating system\n\nWindows 11\n\nRelated: #17308 ","closed_by":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/36903/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/36903/timeline","performed_via_github_app":null,"state_reason":"completed"}