{"url":"https://api.github.com/repos/dotnet/efcore/issues/27372","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/27372/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/27372/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/27372/events","html_url":"https://github.com/dotnet/efcore/issues/27372","id":1124120672,"node_id":"I_kwDOAPaMMs5DALhg","number":27372,"title":"SQL Server: Optimize SQL Server OUTPUT clause usage when retrieving database-generated values ","user":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":130861068,"node_id":"MDU6TGFiZWwxMzA4NjEwNjg=","url":"https://api.github.com/repos/dotnet/efcore/labels/area-perf","name":"area-perf","color":"5319e7","default":false,"description":""},{"id":228492857,"node_id":"MDU6TGFiZWwyMjg0OTI4NTc=","url":"https://api.github.com/repos/dotnet/efcore/labels/providers-beware","name":"providers-beware","color":"fbca04","default":false,"description":null},{"id":526662235,"node_id":"MDU6TGFiZWw1MjY2NjIyMzU=","url":"https://api.github.com/repos/dotnet/efcore/labels/breaking-change","name":"breaking-change","color":"d93f0b","default":false,"description":null},{"id":1900941009,"node_id":"MDU6TGFiZWwxOTAwOTQxMDA5","url":"https://api.github.com/repos/dotnet/efcore/labels/area-save-changes","name":"area-save-changes","color":"32b37b","default":false,"description":""},{"id":2272800544,"node_id":"MDU6TGFiZWwyMjcyODAwNTQ0","url":"https://api.github.com/repos/dotnet/efcore/labels/area-sqlserver","name":"area-sqlserver","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/128","html_url":"https://github.com/dotnet/efcore/milestone/128","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/128/labels","id":7236796,"node_id":"MI_kwDOAPaMMs4Abmy8","number":128,"title":"7.0.0","description":"EF Core 7.0","creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":375,"state":"closed","created_at":"2021-10-09T18:57:40Z","updated_at":"2024-11-13T16:14:22Z","due_on":null,"closed_at":"2022-11-05T18:37:45Z"},"comments":59,"created_at":"2022-02-04T11:54:47Z","updated_at":"2025-06-15T18:45:28Z","closed_at":"2022-03-17T11:17:54Z","author_association":"MEMBER","type":{"id":1092406,"node_id":"IT_kwDOAIt-yc4AEKs2","name":"Feature","description":"A request, idea, or new functionality","color":"blue","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-10-08T09:10:05Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"When inserting an entity with database-generated columns, we currently generate the following (as long as there's no IDENTITY column):\r\n\r\n```sql\r\nDECLARE @inserted0 TABLE ([Id] int);\r\nINSERT INTO [Blogs] ([Name]) OUTPUT INSERTED.[Id] INTO @inserted0 VALUES (@p0);\r\nSELECT [i].[Id] FROM @inserted0 i;\r\n```\r\n\r\nThis could be simplified into this:\r\n\r\n```sql\r\nINSERT INTO [Blogs] ([Name]) OUTPUT INSERTED.[Id] VALUES (@p0);\r\n```\r\n\r\nThe roundabout through the `inserted0` TVP is probably because the [OUTPUT clause](https://docs.microsoft.com/en-us/sql/t-sql/queries/output-clause-transact-sql) won't work [if there's a trigger defined](https://docs.microsoft.com/en-us/sql/t-sql/queries/output-clause-transact-sql?view=sql-server-ver15#triggers), unless it's an `OUTPUT INTO` (??) (@AndriySvyryd it this right, any more context?).\r\n\r\n\r\nUnfortunately, using `OUTPUT INTO` instead of `OUTPUT` adds a lot of overhead:\r\n\r\n```\r\n// * Summary *\r\n\r\nBenchmarkDotNet=v0.13.0, OS=ubuntu 21.10\r\nIntel Xeon W-2133 CPU 3.60GHz, 1 CPU, 12 logical and 6 physical cores\r\n.NET SDK=6.0.101\r\n  [Host]     : .NET 6.0.1 (6.0.121.56705), X64 RyuJIT\r\n  DefaultJob : .NET 6.0.1 (6.0.121.56705), X64 RyuJIT\r\n\r\n\r\n|     Method |     Mean |     Error |    StdDev | Ratio | RatioSD |\r\n|----------- |---------:|----------:|----------:|------:|--------:|\r\n|   NoOutput | 2.119 ms | 0.0423 ms | 0.0396 ms |  0.39 |    0.01 |\r\n|     Output | 1.926 ms | 0.0382 ms | 0.0497 ms |  0.36 |    0.02 |\r\n| OutputInto | 5.365 ms | 0.1068 ms | 0.2083 ms |  1.00 |    0.00 |\r\n```\r\n\r\nThat's over 3ms just for passing through a TVP! Also, mysteriously the version with no OUTPUT clause at all performs worse...\r\n\r\nRemarks:\r\n\r\n* We could default to using `OUTPUT`, and switch back to `OUTPUT INTO` if the user tells us the table has triggers (via metadata).\r\n* Note that we have #9118 for not retrieving anything; this would make this optimization a bit less valuable.\r\n* If the table has any IDENTITY column, OUTPUT isn't used at all. \r\n\r\n<details>\r\n<summary>Benchmark code</summary>\r\n\r\n```c#\r\nBenchmarkRunner.Run<SequenceBenchmark>();\r\n\r\npublic class SequenceBenchmark\r\n{\r\n    const string ConnectionString = \"Server=localhost;Database=test;User=SA;Password=Abcd5678;Connect Timeout=60;ConnectRetryCount=0;Encrypt=false\";\r\n    private SqlConnection _connection;\r\n\r\n    [GlobalSetup]\r\n    public async Task Setup()\r\n    {\r\n        _connection = new SqlConnection(ConnectionString);\r\n        await _connection.OpenAsync();\r\n\r\n        await using var cmd = new SqlCommand(@\"\r\nDROP TABLE IF EXISTS [Foo];\r\nDROP SEQUENCE IF EXISTS [FooSeq];\r\n\r\nCREATE SEQUENCE [FooSeq] AS int START WITH 1 INCREMENT BY 1 NO MINVALUE NO MAXVALUE NO CYCLE;\r\n\r\nCREATE TABLE [Foo] (\r\n    [Id] int PRIMARY KEY NOT NULL DEFAULT (NEXT VALUE FOR FooSeq),\r\n    [BAR] int\r\n);\", _connection);\r\n        await cmd.ExecuteNonQueryAsync();\r\n    }\r\n\r\n    [Benchmark]\r\n    public async Task NoOutput()\r\n    {\r\n        await using var cmd = new SqlCommand(\"INSERT INTO [Foo] ([Bar]) VALUES (8)\", _connection);\r\n        _ = await cmd.ExecuteScalarAsync();\r\n    }\r\n\r\n    [Benchmark]\r\n    public async Task Output()\r\n    {\r\n        await using var cmd = new SqlCommand(\"INSERT INTO [Foo] ([Bar]) OUTPUT INSERTED.[Id] VALUES (8)\", _connection);\r\n        _ = await cmd.ExecuteScalarAsync();\r\n    }\r\n\r\n    [Benchmark(Baseline = true)]\r\n    public async Task OutputInto()\r\n    {\r\n        await using var cmd = new SqlCommand(@\"DECLARE @inserted TABLE ([Id] int);\r\nINSERT INTO [Foo] ([Bar]) OUTPUT INSERTED.[Id] INTO @inserted VALUES (8);\r\nSELECT [i].[Id] FROM @inserted i;\r\n\", _connection);\r\n        _ = await cmd.ExecuteScalarAsync();\r\n    }\r\n\r\n    [GlobalCleanup]\r\n    public ValueTask Cleanup()\r\n        => _connection.DisposeAsync();\r\n}\r\n```\r\n\r\n</details>","closed_by":null,"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/27372/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/27372/timeline","performed_via_github_app":null,"state_reason":"completed"}