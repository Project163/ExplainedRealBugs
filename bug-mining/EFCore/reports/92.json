{"url":"https://api.github.com/repos/dotnet/efcore/issues/28065","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/28065/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/28065/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/28065/events","html_url":"https://github.com/dotnet/efcore/issues/28065","id":1242795539,"node_id":"I_kwDOAPaMMs5KE44T","number":28065,"title":"SaveChanges circular dependency in unique filtered index ","user":{"login":"jgilchrist","id":684822,"node_id":"MDQ6VXNlcjY4NDgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/684822?v=4","gravatar_id":"","url":"https://api.github.com/users/jgilchrist","html_url":"https://github.com/jgilchrist","followers_url":"https://api.github.com/users/jgilchrist/followers","following_url":"https://api.github.com/users/jgilchrist/following{/other_user}","gists_url":"https://api.github.com/users/jgilchrist/gists{/gist_id}","starred_url":"https://api.github.com/users/jgilchrist/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jgilchrist/subscriptions","organizations_url":"https://api.github.com/users/jgilchrist/orgs","repos_url":"https://api.github.com/users/jgilchrist/repos","events_url":"https://api.github.com/users/jgilchrist/events{/privacy}","received_events_url":"https://api.github.com/users/jgilchrist/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":514908713,"node_id":"MDU6TGFiZWw1MTQ5MDg3MTM=","url":"https://api.github.com/repos/dotnet/efcore/labels/regression","name":"regression","color":"ff1fff","default":false,"description":null},{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1900941009,"node_id":"MDU6TGFiZWwxOTAwOTQxMDA5","url":"https://api.github.com/repos/dotnet/efcore/labels/area-save-changes","name":"area-save-changes","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/128","html_url":"https://github.com/dotnet/efcore/milestone/128","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/128/labels","id":7236796,"node_id":"MI_kwDOAPaMMs4Abmy8","number":128,"title":"7.0.0","description":"EF Core 7.0","creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":375,"state":"closed","created_at":"2021-10-09T18:57:40Z","updated_at":"2024-11-13T16:14:22Z","due_on":null,"closed_at":"2022-11-05T18:37:45Z"},"comments":11,"created_at":"2022-05-20T08:16:30Z","updated_at":"2025-06-15T18:47:30Z","closed_at":"2022-08-31T01:00:51Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"While testing out the newest preview, I'm running into an issue with a previously working bit of code - `BatchingTopologicalSort` is throwing errors for a case that was working in EFCore 6.\r\n\r\nIt's reproducible for me with the following cut-down code:\r\n\r\nEntities:\r\n\r\n```cs\r\npublic class TestEntity\r\n{\r\n    public int Id { get; set; }\r\n}\r\n\r\npublic class TestDependentEntity\r\n{\r\n    public int Id { get; set; }\r\n    public int TestEntityId { get; set; }\r\n\r\n    public bool? UniqueOn { get; set; }\r\n    public int? ToChange { get; set; }\r\n\r\n    public class Config : IEntityTypeConfiguration<TestDependentEntity>\r\n    {\r\n        public void Configure(EntityTypeBuilder<TestDependentEntity> builder)\r\n        {\r\n            builder.HasIndex(e => new { e.TestEntityId, e.UniqueOn })\r\n                .IsUnique();\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nTo reproduce:\r\n\r\n```cs\r\nvar dbContext = new TestDbContext();\r\n\r\nvar t1 = new TestEntity();\r\n\r\ndb.Tests.Add(t1);\r\n\r\nawait db.SaveChangesAsync();\r\n\r\nvar dependent = new TestDependentEntity() {\r\n    TestEntityId = t1.Id,\r\n    UniqueOn = null,\r\n    ToChange = 1,\r\n};\r\n\r\nvar dependent2 = new TestDependentEntity() {\r\n    TestEntityId = t1.Id,\r\n    UniqueOn = null,\r\n    ToChange = 2,\r\n};\r\n\r\ndb.TestDependents.Add(dependent);\r\ndb.TestDependents.Add(dependent2);\r\n\r\nawait db.SaveChangesAsync();\r\n\r\ndependent.ToChange = null;\r\ndependent2.ToChange = null;\r\n\r\nawait db.SaveChangesAsync();\r\n```\r\n\r\nThe final `SaveChangesAsync()` will throw the following error:\r\n\r\n```\r\nSystem.InvalidOperationException: Unable to save changes because a circular dependency was detected in the data to be saved: 'TestDependentEntity { 'Id': 2 } [Modified] <-\r\nIndex { 'test_entity_id': 1, 'unique_on':  } TestDependentEntity { 'Id': 3 } [Modified] <-\r\nIndex { 'test_entity_id': 1, 'unique_on':  } TestDependentEntity { 'Id': 2 } [Modified]'.\r\n   at Microsoft.EntityFrameworkCore.Utilities.Multigraph`2.ThrowCycle(List`1 cycle, Func`2 formatCycle, Func`2 formatException)\r\n   at Microsoft.EntityFrameworkCore.Utilities.Multigraph`2.BatchingTopologicalSort(Func`4 tryBreakEdge, Func`2 formatCycle)\r\n   at Microsoft.EntityFrameworkCore.Update.Internal.CommandBatchPreparer.TopologicalSort(IEnumerable`1 commands)\r\n   at Microsoft.EntityFrameworkCore.Update.Internal.CommandBatchPreparer.BatchCommands(IList`1 entries, IUpdateAdapter updateAdapter)+MoveNext()\r\n   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)\r\n   at Npgsql.EntityFrameworkCore.PostgreSQL.Storage.Internal.NpgsqlExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)\r\n   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)\r\n   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)\r\n```\r\n\r\nIt _appears_ that this is due to the unique index, and indeed removing the index makes this work. Although I can't tell for sure, my hunch is that the code working with the index is not considering the fact that the two rows are considered unique by the index even though they both have `null` in `UniqueOn` because `NULL != NULL`?\r\n\r\nHappy to provide any more info if needed.\r\n\r\n### Info\r\n\r\nEF Core version: `7.0.0-preview.4.22229.2`\r\nDatabase provider: `Npgsql.EntityFrameworkCore.PostgreSQL`\r\nTarget framework: `.NET 6`\r\nOperating system: macOS\r\nIDE: Rider 2022.1\r\n","closed_by":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/28065/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/28065/timeline","performed_via_github_app":null,"state_reason":"completed"}