{"url":"https://api.github.com/repos/dotnet/efcore/issues/30851","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/30851/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/30851/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/30851/events","html_url":"https://github.com/dotnet/efcore/issues/30851","id":1701258771,"node_id":"I_kwDOAPaMMs5lZyYT","number":30851,"title":"Silent data loss when adding objects to an sqlite DB with PRAGMA journal_mode=DELETE in a multi-threaded environment.","user":{"login":"EdwardNickson","id":26862861,"node_id":"MDQ6VXNlcjI2ODYyODYx","avatar_url":"https://avatars.githubusercontent.com/u/26862861?v=4","gravatar_id":"","url":"https://api.github.com/users/EdwardNickson","html_url":"https://github.com/EdwardNickson","followers_url":"https://api.github.com/users/EdwardNickson/followers","following_url":"https://api.github.com/users/EdwardNickson/following{/other_user}","gists_url":"https://api.github.com/users/EdwardNickson/gists{/gist_id}","starred_url":"https://api.github.com/users/EdwardNickson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/EdwardNickson/subscriptions","organizations_url":"https://api.github.com/users/EdwardNickson/orgs","repos_url":"https://api.github.com/users/EdwardNickson/repos","events_url":"https://api.github.com/users/EdwardNickson/events{/privacy}","received_events_url":"https://api.github.com/users/EdwardNickson/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1017558838,"node_id":"MDU6TGFiZWwxMDE3NTU4ODM4","url":"https://api.github.com/repos/dotnet/efcore/labels/Servicing-approved","name":"Servicing-approved","color":"048708","default":false,"description":""},{"id":1111789566,"node_id":"MDU6TGFiZWwxMTExNzg5NTY2","url":"https://api.github.com/repos/dotnet/efcore/labels/area-adonet-sqlite","name":"area-adonet-sqlite","color":"044a64","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"bricelam","id":1226749,"node_id":"MDQ6VXNlcjEyMjY3NDk=","avatar_url":"https://avatars.githubusercontent.com/u/1226749?v=4","gravatar_id":"","url":"https://api.github.com/users/bricelam","html_url":"https://github.com/bricelam","followers_url":"https://api.github.com/users/bricelam/followers","following_url":"https://api.github.com/users/bricelam/following{/other_user}","gists_url":"https://api.github.com/users/bricelam/gists{/gist_id}","starred_url":"https://api.github.com/users/bricelam/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bricelam/subscriptions","organizations_url":"https://api.github.com/users/bricelam/orgs","repos_url":"https://api.github.com/users/bricelam/repos","events_url":"https://api.github.com/users/bricelam/events{/privacy}","received_events_url":"https://api.github.com/users/bricelam/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"bricelam","id":1226749,"node_id":"MDQ6VXNlcjEyMjY3NDk=","avatar_url":"https://avatars.githubusercontent.com/u/1226749?v=4","gravatar_id":"","url":"https://api.github.com/users/bricelam","html_url":"https://github.com/bricelam","followers_url":"https://api.github.com/users/bricelam/followers","following_url":"https://api.github.com/users/bricelam/following{/other_user}","gists_url":"https://api.github.com/users/bricelam/gists{/gist_id}","starred_url":"https://api.github.com/users/bricelam/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bricelam/subscriptions","organizations_url":"https://api.github.com/users/bricelam/orgs","repos_url":"https://api.github.com/users/bricelam/repos","events_url":"https://api.github.com/users/bricelam/events{/privacy}","received_events_url":"https://api.github.com/users/bricelam/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/175","html_url":"https://github.com/dotnet/efcore/milestone/175","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/175/labels","id":9625207,"node_id":"MI_kwDOAPaMMs4Akt53","number":175,"title":"6.0.21","description":null,"creator":{"login":"wtgodbe","id":14283640,"node_id":"MDQ6VXNlcjE0MjgzNjQw","avatar_url":"https://avatars.githubusercontent.com/u/14283640?v=4","gravatar_id":"","url":"https://api.github.com/users/wtgodbe","html_url":"https://github.com/wtgodbe","followers_url":"https://api.github.com/users/wtgodbe/followers","following_url":"https://api.github.com/users/wtgodbe/following{/other_user}","gists_url":"https://api.github.com/users/wtgodbe/gists{/gist_id}","starred_url":"https://api.github.com/users/wtgodbe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wtgodbe/subscriptions","organizations_url":"https://api.github.com/users/wtgodbe/orgs","repos_url":"https://api.github.com/users/wtgodbe/repos","events_url":"https://api.github.com/users/wtgodbe/events{/privacy}","received_events_url":"https://api.github.com/users/wtgodbe/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":1,"state":"closed","created_at":"2023-07-06T19:43:26Z","updated_at":"2023-11-14T13:52:03Z","due_on":null,"closed_at":"2023-08-08T21:10:06Z"},"comments":19,"created_at":"2023-05-09T03:39:01Z","updated_at":"2025-06-15T19:02:27Z","closed_at":"2023-07-06T23:07:15Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hi,\r\n\r\nI'm experiencing a data loss issue when using EF Core with sqlite in a multi threaded scenario. This bug seems to only happen if `PRAGMA journal_mode=DELETE`. I can't replicate it in `WAL` mode.\r\nWhat's happening is that sometimes when a new object is added and `SaveChanges` is called on a context, the database insert appears to run successfully, and `DatabaseGenerated` primary keys are created by the DB and set against the C# object, but when the database is later queried for that primary key the record doesn't exist. What's more, the next time an object is created and saved to the database it gets assigned the same primary key as the previous object. It's almost like it rolled-back the first transaction without throwing an exception. \r\n\r\nThis issue does not exist in EF Core 6, it started in EF Core 7. We have found that adding\r\n`ReplaceService<IUpdateSqlGenerator, SqliteLegacyUpdateSqlGenerator>()` to our options builder resolves this issue, so it seems to be a bug in the new `SqliteUpdateSqlGenerator`.\r\n\r\n### Sample Program\r\n\r\nThis program sets up a database with `PRAGMA journal_mode=DELETE`, creates two dBContexts for one sqlite database and then adds objects to the contexts in one-off tasks which run in parallel. After each addition it checks to ensure the primary keys set in each context's call to `SaveChanges` is unique. If the keys are not unique it throws an exception.\r\n\r\nWhat I expect to happen:\r\nThe program runs to completion with no exceptions.\r\n\r\nWhat actually happens:\r\nThe program throws an exception because the objects added to the two different contexts ended up with the same primary key.\r\n```\r\n<Project Sdk=\"Microsoft.NET.Sdk\">\r\n\r\n  <PropertyGroup>\r\n    <OutputType>Exe</OutputType>\r\n    <TargetFramework>net7.0</TargetFramework>\r\n    <ImplicitUsings>enable</ImplicitUsings>\r\n    <Nullable>enable</Nullable>\r\n  </PropertyGroup>\r\n\r\n  <ItemGroup>\r\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.Sqlite\" Version=\"7.0.5\" />\r\n  </ItemGroup>\r\n\r\n</Project>\r\n```\r\n\r\n```C#\r\nusing System.ComponentModel.DataAnnotations;\r\nusing System.ComponentModel.DataAnnotations.Schema;\r\nusing Microsoft.EntityFrameworkCore;\r\nusing Microsoft.EntityFrameworkCore.Sqlite.Update.Internal;\r\nusing Microsoft.EntityFrameworkCore.Update;\r\n\r\nnamespace collisionTest;\r\n\r\npublic class LogEvent\r\n{\r\n    [Key]\r\n    [DatabaseGenerated(DatabaseGeneratedOption.Identity)]\r\n    public int Id { get; set; }\r\n    public required string Message { get; set; }\r\n}\r\n\r\npublic class LogDbContext : DbContext\r\n{\r\n    public DbSet<LogEvent> LogEvents => Set<LogEvent>();\r\n    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)\r\n    {\r\n        optionsBuilder.UseSqlite(\"Data source=testDb.db\");\r\n\r\n        // Bug can be worked around by using legacy update SQL generator\r\n        // .ReplaceService<IUpdateSqlGenerator, SqliteLegacyUpdateSqlGenerator>();\r\n    }\r\n}\r\n\r\npublic class Program\r\n{\r\n    static async Task Main(string[] _)\r\n    {\r\n        using (var contextToCreateDb = new LogDbContext())\r\n        {\r\n            contextToCreateDb.Database.EnsureDeleted();\r\n            contextToCreateDb.Database.EnsureCreated();\r\n            using var connection = contextToCreateDb.Database.GetDbConnection();\r\n            connection.Open();\r\n            using var command = connection.CreateCommand();\r\n            command.CommandText = \"PRAGMA journal_mode=DELETE;\";\r\n            command.ExecuteNonQuery();\r\n        }\r\n\r\n        using var contextOne = new LogDbContext();\r\n        using var contextTwo = new LogDbContext();\r\n        for (int i = 0; i < 500; i++)\r\n        {\r\n            var taskOne = Task.Run(() =>\r\n            {\r\n                var logEvent = new LogEvent(){ Message = \"Log Message\" };\r\n                contextOne.Add(logEvent);\r\n                contextOne.SaveChanges();\r\n                return logEvent.Id;\r\n            });\r\n            var taskTwo = Task.Run(() =>\r\n            {\r\n                var logEvent = new LogEvent(){ Message = \"Log Message\" };\r\n                contextTwo.Add(logEvent);\r\n                contextTwo.SaveChanges();\r\n                return logEvent.Id;\r\n            });\r\n            await taskOne;\r\n            await taskTwo;\r\n            if (taskOne.Result == taskTwo.Result)\r\n            {\r\n                throw new Exception($\"Duplicate IDs Returned: {taskOne.Result}\");\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n### Include provider and version information\r\n\r\nEF Core version: 7.0.5\r\nDatabase provider: Microsoft.EntityFrameworkCore.Sqlite\r\nTarget framework: .NET 7.0\r\nOperating system: Ubuntu 18.04 & Ubuntu 20.04\r\nIDE: VS Code\r\n","closed_by":{"login":"bricelam","id":1226749,"node_id":"MDQ6VXNlcjEyMjY3NDk=","avatar_url":"https://avatars.githubusercontent.com/u/1226749?v=4","gravatar_id":"","url":"https://api.github.com/users/bricelam","html_url":"https://github.com/bricelam","followers_url":"https://api.github.com/users/bricelam/followers","following_url":"https://api.github.com/users/bricelam/following{/other_user}","gists_url":"https://api.github.com/users/bricelam/gists{/gist_id}","starred_url":"https://api.github.com/users/bricelam/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bricelam/subscriptions","organizations_url":"https://api.github.com/users/bricelam/orgs","repos_url":"https://api.github.com/users/bricelam/repos","events_url":"https://api.github.com/users/bricelam/events{/privacy}","received_events_url":"https://api.github.com/users/bricelam/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/30851/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/30851/timeline","performed_via_github_app":null,"state_reason":"completed"}