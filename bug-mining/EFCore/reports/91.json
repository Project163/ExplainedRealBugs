{"url":"https://api.github.com/repos/dotnet/efcore/issues/28654","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/28654/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/28654/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/28654/events","html_url":"https://github.com/dotnet/efcore/issues/28654","id":1334576464,"node_id":"I_kwDOAPaMMs5PjAVQ","number":28654,"title":"FK for generated key using TPC sometimes gets temporary value persisted to database on SaveChanges","user":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1900941009,"node_id":"MDU6TGFiZWwxOTAwOTQxMDA5","url":"https://api.github.com/repos/dotnet/efcore/labels/area-save-changes","name":"area-save-changes","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/128","html_url":"https://github.com/dotnet/efcore/milestone/128","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/128/labels","id":7236796,"node_id":"MI_kwDOAPaMMs4Abmy8","number":128,"title":"7.0.0","description":"EF Core 7.0","creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":375,"state":"closed","created_at":"2021-10-09T18:57:40Z","updated_at":"2024-11-13T16:14:22Z","due_on":null,"closed_at":"2022-11-05T18:37:45Z"},"comments":2,"created_at":"2022-08-10T12:49:23Z","updated_at":"2025-06-15T18:50:49Z","closed_at":"2022-08-30T21:19:52Z","author_association":"CONTRIBUTOR","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"```C#\r\nusing (var context = new AnimalsContext())\r\n{\r\n    await context.Database.EnsureDeletedAsync();\r\n\r\n    Console.WriteLine(context.Model.ToDebugString());\r\n    Console.WriteLine();\r\n\r\n    await context.Database.EnsureCreatedAsync();\r\n\r\n    var catFood = new PetFood(\"Lily's Kitchen\", LifeStage.Adult);\r\n    var dogFood = new PetFood(\"Canagan\", LifeStage.Adult);\r\n    var hay = new FarmFood(\"Hay\");\r\n    var sushi = new HumanFood(\"Sushi\", 670);\r\n\r\n    var arthur = new Human(\"Arthur\") { Food = sushi };\r\n    var wendy = new Human(\"Wendy\");\r\n    var christi = new Human(\"Christi\");\r\n\r\n    var alice = new Cat(\"Alice\", \"MBA\") { Vet = \"Pengelly\", Food = catFood, Humans = { arthur, wendy } };\r\n\r\n    var mac = new Cat(\"Mac\", \"Preschool\") { Vet = \"Pengelly\", Food = catFood, Humans = { arthur, wendy } };\r\n\r\n    var toast = new Dog(\"Toast\", \"Mr. Squirrel\") { Vet = \"Pengelly\", Food = dogFood, Humans = { arthur, wendy } };\r\n\r\n    var clyde = new FarmAnimal(\"Clyde\", \"Equus africanus asinus\") { Value = 100.0m, Food = hay };\r\n\r\n    wendy.FavoriteAnimal = toast;\r\n    arthur.FavoriteAnimal = alice;\r\n    christi.FavoriteAnimal = clyde;\r\n\r\n    await context.AddRangeAsync(wendy, arthur, christi, alice, mac, toast, clyde);\r\n    await context.SaveChangesAsync();\r\n}\r\n\r\nConsole.WriteLine();\r\n\r\nusing (var context = new AnimalsContext())\r\n{\r\n    foreach (var human in context.Humans)\r\n    {\r\n        Console.WriteLine($\"Human.FavoriteAnimalId = {context.Entry(human).Property(\"FavoriteAnimalId\").CurrentValue}\");\r\n    }\r\n}\r\n\r\npublic abstract class Animal\r\n{\r\n    protected Animal(string name)\r\n    {\r\n        Name = name;\r\n    }\r\n\r\n    public int Id { get; set; }\r\n    public string Name { get; set; }\r\n    public abstract string Species { get; }\r\n\r\n    public Food? Food { get; set; }\r\n}\r\n\r\npublic abstract class Pet : Animal\r\n{\r\n    protected Pet(string name)\r\n        : base(name)\r\n    {\r\n    }\r\n\r\n    public string? Vet { get; set; }\r\n\r\n    public ICollection<Human> Humans { get; } = new List<Human>();\r\n}\r\n\r\npublic class FarmAnimal : Animal\r\n{\r\n    public FarmAnimal(string name, string species)\r\n        : base(name)\r\n    {\r\n        Species = species;\r\n    }\r\n\r\n    public override string Species { get; }\r\n\r\n    [Precision(18, 2)]\r\n    public decimal Value { get; set; }\r\n\r\n    public override string ToString()\r\n        => $\"Farm animal '{Name}' ({Species}/{Id}) worth {Value:C} eats {Food?.ToString() ?? \"<Unknown>\"}\";\r\n}\r\n\r\npublic class Cat : Pet\r\n{\r\n    public Cat(string name, string educationLevel)\r\n        : base(name)\r\n    {\r\n        EducationLevel = educationLevel;\r\n    }\r\n\r\n    public string EducationLevel { get; set; }\r\n\r\n    public override string Species\r\n        => \"Felis catus\";\r\n\r\n    public override string ToString()\r\n        => $\"Cat '{Name}' ({Species}/{Id}) with education '{EducationLevel}' eats {Food?.ToString() ?? \"<Unknown>\"}\";\r\n}\r\n\r\npublic class Dog : Pet\r\n{\r\n    public Dog(string name, string favoriteToy)\r\n        : base(name)\r\n    {\r\n        FavoriteToy = favoriteToy;\r\n    }\r\n\r\n    public string FavoriteToy { get; set; }\r\n\r\n    public override string Species\r\n        => \"Canis familiaris\";\r\n\r\n    public override string ToString()\r\n        => $\"Dog '{Name}' ({Species}/{Id}) with favorite toy '{FavoriteToy}' eats {Food?.ToString() ?? \"<Unknown>\"}\";\r\n}\r\n\r\npublic class Human : Animal\r\n{\r\n    public Human(string name)\r\n        : base(name)\r\n    {\r\n    }\r\n\r\n    public override string Species\r\n        => \"Homo sapiens\";\r\n\r\n    public Animal? FavoriteAnimal { get; set; }\r\n    public ICollection<Pet> Pets { get; } = new List<Pet>();\r\n\r\n    public override string ToString()\r\n        => $\"Human '{Name}' ({Species}/{Id}) with favorite animal '{FavoriteAnimal?.Name ?? \"<Unknown>\"}'\"\r\n            + $\" eats {Food?.ToString() ?? \"<Unknown>\"}\";\r\n}\r\n\r\npublic abstract class Food\r\n{\r\n    public Guid Id { get; set; }\r\n}\r\n\r\npublic class PetFood : Food\r\n{\r\n    public PetFood(string brand, LifeStage lifeStage)\r\n    {\r\n        Brand = brand;\r\n        LifeStage = lifeStage;\r\n    }\r\n\r\n    public string Brand { get; set; }\r\n    public LifeStage LifeStage { get; set; }\r\n\r\n    public override string ToString()\r\n        => $\"Pet food by '{Brand}' ({Id}) for life stage {LifeStage}\";\r\n}\r\n\r\npublic enum LifeStage\r\n{\r\n    Juvenile,\r\n    Adult,\r\n    Senior\r\n}\r\n\r\npublic class HumanFood : Food\r\n{\r\n    public HumanFood(string name, int calories)\r\n    {\r\n        Name = name;\r\n        Calories = calories;\r\n    }\r\n\r\n    [Column(\"Name\")]\r\n    public string Name { get; set; }\r\n\r\n    public int Calories { get; set; }\r\n\r\n    public override string ToString()\r\n        => $\"{Name} ({Id}) with calories {Calories}\";\r\n}\r\n\r\npublic class FarmFood : Food\r\n{\r\n    public FarmFood(string name)\r\n    {\r\n        Name = name;\r\n    }\r\n\r\n    [Column(\"Name\")]\r\n    public string Name { get; set; }\r\n\r\n    public override string ToString()\r\n        => $\"{Name} ({Id})\";\r\n}\r\n\r\npublic class AnimalsContext : DbContext\r\n{\r\n    public DbSet<Animal> Animals\r\n        => Set<Animal>();\r\n\r\n    public DbSet<Pet> Pets\r\n        => Set<Pet>();\r\n\r\n    public DbSet<FarmAnimal> FarmAnimals\r\n        => Set<FarmAnimal>();\r\n\r\n    public DbSet<Cat> Cats\r\n        => Set<Cat>();\r\n\r\n    public DbSet<Dog> Dogs\r\n        => Set<Dog>();\r\n\r\n    public DbSet<Human> Humans\r\n        => Set<Human>();\r\n\r\n    public DbSet<Food> Foods\r\n        => Set<Food>();\r\n\r\n    public DbSet<PetFood> PetFoods\r\n        => Set<PetFood>();\r\n\r\n    public DbSet<FarmFood> FarmFoods\r\n        => Set<FarmFood>();\r\n\r\n    public DbSet<HumanFood> HumanFoods\r\n        => Set<HumanFood>();\r\n\r\n    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)\r\n    {\r\n        optionsBuilder\r\n            .EnableSensitiveDataLogging()\r\n            .UseSqlServer(@$\"Server=(localdb)\\mssqllocaldb;Database={GetType().Name}\");\r\n\r\n        optionsBuilder.LogTo(Console.WriteLine, LogLevel.Information);\r\n    }\r\n\r\n    protected override void OnModelCreating(ModelBuilder modelBuilder)\r\n    {\r\n        modelBuilder.Entity<Animal>().UseTpcMappingStrategy();\r\n        modelBuilder.Entity<Food>().UseTpcMappingStrategy();\r\n\r\n        modelBuilder.Entity<FarmAnimal>().Property(e => e.Species);\r\n\r\n        modelBuilder.Entity<Human>()\r\n            .HasMany(e => e.Pets)\r\n            .WithMany(e => e.Humans)\r\n            .UsingEntity<Dictionary<object, string>>(\r\n                \"PetsHumans\",\r\n                r => r.HasOne<Pet>().WithMany().OnDelete(DeleteBehavior.Cascade),\r\n                l => l.HasOne<Human>().WithMany().OnDelete(DeleteBehavior.ClientCascade));\r\n    }\r\n}\r\n\r\n```\r\n\r\n```\r\nHuman.FavoriteAnimalId = -2147482646\r\nHuman.FavoriteAnimalId = -2147482644\r\nHuman.FavoriteAnimalId = -2147482642\r\n```","closed_by":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/28654/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/28654/timeline","performed_via_github_app":null,"state_reason":"completed"}