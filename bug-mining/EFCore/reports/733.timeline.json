[{"id":20053283357,"node_id":"LE_lADOAPaMMs7PN3DOzwAAAASrRNId","url":"https://api.github.com/repos/dotnet/efcore/issues/events/20053283357","actor":{"login":"JoasE","id":32096708,"node_id":"MDQ6VXNlcjMyMDk2NzA4","avatar_url":"https://avatars.githubusercontent.com/u/32096708?v=4","gravatar_id":"","url":"https://api.github.com/users/JoasE","html_url":"https://github.com/JoasE","followers_url":"https://api.github.com/users/JoasE/followers","following_url":"https://api.github.com/users/JoasE/following{/other_user}","gists_url":"https://api.github.com/users/JoasE/gists{/gist_id}","starred_url":"https://api.github.com/users/JoasE/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JoasE/subscriptions","organizations_url":"https://api.github.com/users/JoasE/orgs","repos_url":"https://api.github.com/users/JoasE/repos","events_url":"https://api.github.com/users/JoasE/events{/privacy}","received_events_url":"https://api.github.com/users/JoasE/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2025-10-02T08:06:00Z","label":{"name":"customer-reported","color":"a4a5f9"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/3359840733","html_url":"https://github.com/dotnet/efcore/issues/36903#issuecomment-3359840733","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/36903","id":3359840733,"node_id":"IC_kwDOAPaMMs7IQxnd","user":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-10-02T08:27:44Z","updated_at":"2025-10-02T08:32:51Z","body":"> This is because the total request body size limit for both single writes and transactional batches is 2MB. Meaning all writes in a single transactional batch combined can not exceed 2MB.\n> ...\n> We could get the current batch entry size as we are serializing to a stream already, and add a safe and/or calculated margin for request metadata. We would most likeley need to calculate the size of some request metadata like id and session token, and add a safe margin for the property serialization. Then EF Core could automatically split the writes into 2 batches, and only throw with AutoTransactionBehavior.Always. However, I am currently not 100% sure what this safe margin should be, but I found [this 200 byte margin in the cosmos db source code](https://github.com/Azure/azure-cosmos-dotnet-v3/blob/895697d6448b509d7b3df0d6773b2f84a7039e30/Microsoft.Azure.Cosmos/src/Batch/ServerBatchRequest.cs#L112). Also see: Also see: https://github.com/Azure/azure-cosmos-dotnet-v3/issues/5406. I think if a single entity is larger than 2MB, we should still throw a DbUpdateException. (by sending the request (as a single write))\n\nAm noting that pre-calculating the request size isn't trivial (to know that it's under 2MB), and could add quite a performance overhead; unless I'm mistaken, we'd have to have a pass to go over all parameters and figure out their size on the wire, which probably means serializing them? I haven't looked to deeply into this, so I may be wrong here.\n\nRegardless, I'd be quite uncomfortable with some guess/heuristic margin that relies on an internal constant in the Cosmos SDK source code; if something changes or we get this wrong, then users who never cared about transactionality start getting exceptions in basic, mainline scenarios.\n\nTo me this all points to us not enabling transactional batches by default, i.e. have AutoTransactionBehavior.Never as the default; I suspect most users don't care about transactionality in most scenarios, and just like the Cosmos SDK itself requires you to opt into transactional batches by using a specific API, it makes sense for EF to require an opt-in via AutoTransactionBehavior. At that point we don't have to do any guesswork: users who need transactionality opt into it, and then they get an error if it isn't  possible for any reason (request exceeding 2MB, multiple partitions, etc.).\n\nThe one program here is with the AutoTransactionBehavior.WhenNeeded, as we won't be able to know in advance if the request is above 2MB (unless we go into pre-calculation, which as above I don't think we should). We could simply leave things as is, effectively making this a \"best effort\" feature - it usually gracefully degrades to non-transactionality (e.g. different partitions), but in some cases might still throw (request beyond 2MB).\n\nThough I'm a bit conflicted about this... If we didn't have the [performance advantage](https://github.com/dotnet/efcore/issues/17308#issuecomment-3239509178) of transactional batches, I'd argue to disable WhenNeeded altogether; transaction-wise, If you're already not guaranteed transactionality (e.g. different partitions), then what are you actually getting out of WhenNeeded? Transactionality is usually an \"either-you-have-it-or-you-don't\" kind of thing, and WhenNeeded wouldn't provide that, while still causing failures due to the 2MB limit.\n\nWe could still keep WhenNeeded (and as a default), with the rationale that it provides better speed out-of-the-box, at the expense of the 2MB limit (we could catch that error, and throw a more informative error telling the user to disable transactionality for big batches). \n \n@JoasE @AndriySvyryd what do you think about all this?\n","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/3359840733/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":20053776892,"node_id":"MEE_lADOAPaMMs7PN3DOzwAAAASrTFn8","url":"https://api.github.com/repos/dotnet/efcore/issues/events/20053776892","actor":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2025-10-02T08:27:45Z","performed_via_github_app":null},{"id":20053776927,"node_id":"SE_lADOAPaMMs7PN3DOzwAAAASrTFof","url":"https://api.github.com/repos/dotnet/efcore/issues/events/20053776927","actor":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2025-10-02T08:27:46Z","performed_via_github_app":null},{"id":20053776957,"node_id":"MEE_lADOAPaMMs7PN3DOzwAAAASrTFo9","url":"https://api.github.com/repos/dotnet/efcore/issues/events/20053776957","actor":{"login":"JoasE","id":32096708,"node_id":"MDQ6VXNlcjMyMDk2NzA4","avatar_url":"https://avatars.githubusercontent.com/u/32096708?v=4","gravatar_id":"","url":"https://api.github.com/users/JoasE","html_url":"https://github.com/JoasE","followers_url":"https://api.github.com/users/JoasE/followers","following_url":"https://api.github.com/users/JoasE/following{/other_user}","gists_url":"https://api.github.com/users/JoasE/gists{/gist_id}","starred_url":"https://api.github.com/users/JoasE/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JoasE/subscriptions","organizations_url":"https://api.github.com/users/JoasE/orgs","repos_url":"https://api.github.com/users/JoasE/repos","events_url":"https://api.github.com/users/JoasE/events{/privacy}","received_events_url":"https://api.github.com/users/JoasE/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2025-10-02T08:27:46Z","performed_via_github_app":null},{"id":20053776974,"node_id":"SE_lADOAPaMMs7PN3DOzwAAAASrTFpO","url":"https://api.github.com/repos/dotnet/efcore/issues/events/20053776974","actor":{"login":"JoasE","id":32096708,"node_id":"MDQ6VXNlcjMyMDk2NzA4","avatar_url":"https://avatars.githubusercontent.com/u/32096708?v=4","gravatar_id":"","url":"https://api.github.com/users/JoasE","html_url":"https://github.com/JoasE","followers_url":"https://api.github.com/users/JoasE/followers","following_url":"https://api.github.com/users/JoasE/following{/other_user}","gists_url":"https://api.github.com/users/JoasE/gists{/gist_id}","starred_url":"https://api.github.com/users/JoasE/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JoasE/subscriptions","organizations_url":"https://api.github.com/users/JoasE/orgs","repos_url":"https://api.github.com/users/JoasE/repos","events_url":"https://api.github.com/users/JoasE/events{/privacy}","received_events_url":"https://api.github.com/users/JoasE/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2025-10-02T08:27:46Z","performed_via_github_app":null},{"id":20053781370,"node_id":"ITAE_lADOAPaMMs7PN3DOzwAAAASrTGt6","url":"https://api.github.com/repos/dotnet/efcore/issues/events/20053781370","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"issue_type_added","commit_id":null,"commit_url":null,"created_at":"2025-10-02T08:27:54Z","performed_via_github_app":null},{"id":20053781806,"node_id":"MIE_lADOAPaMMs7PN3DOzwAAAASrTG0u","url":"https://api.github.com/repos/dotnet/efcore/issues/events/20053781806","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"milestoned","commit_id":null,"commit_url":null,"created_at":"2025-10-02T08:27:55Z","milestone":{"title":"11.0.0"},"performed_via_github_app":null},{"id":20053783636,"node_id":"LE_lADOAPaMMs7PN3DOzwAAAASrTHRU","url":"https://api.github.com/repos/dotnet/efcore/issues/events/20053783636","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2025-10-02T08:28:01Z","label":{"name":"area-cosmos","color":"32b37b"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/3361134805","html_url":"https://github.com/dotnet/efcore/issues/36903#issuecomment-3361134805","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/36903","id":3361134805,"node_id":"IC_kwDOAPaMMs7IVtjV","user":{"login":"JoasE","id":32096708,"node_id":"MDQ6VXNlcjMyMDk2NzA4","avatar_url":"https://avatars.githubusercontent.com/u/32096708?v=4","gravatar_id":"","url":"https://api.github.com/users/JoasE","html_url":"https://github.com/JoasE","followers_url":"https://api.github.com/users/JoasE/followers","following_url":"https://api.github.com/users/JoasE/following{/other_user}","gists_url":"https://api.github.com/users/JoasE/gists{/gist_id}","starred_url":"https://api.github.com/users/JoasE/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JoasE/subscriptions","organizations_url":"https://api.github.com/users/JoasE/orgs","repos_url":"https://api.github.com/users/JoasE/repos","events_url":"https://api.github.com/users/JoasE/events{/privacy}","received_events_url":"https://api.github.com/users/JoasE/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-10-02T13:01:02Z","updated_at":"2025-10-02T13:04:27Z","body":"> Am noting that pre-calculating the request size isn't trivial (to know that it's under 2MB), and could add quite a performance overhead; unless I'm mistaken, we'd have to have a pass to go over all parameters and figure out their size on the wire, which probably means serializing them? I haven't looked to deeply into this, so I may be wrong here.\n\nYes, how ever [we already serialize the entity/document to a stream](https://github.com/dotnet/efcore/blob/8fb7ff77048eb9b9d794e83f060f114dfbe7990f/src/EFCore.Cosmos/Storage/Internal/CosmosTransactionalBatchWrapper.cs#L75), so the only extra step is calculating the size of the request options we specify. Which are relatively small. \n\n> Regardless, I'd be quite uncomfortable with some guess/heuristic margin that relies on an internal constant in the Cosmos SDK source code; if something changes or we get this wrong, then users who never cared about transactionality start getting exceptions in basic, mainline scenarios.\n\nI agree, which is why I created Azure/azure-cosmos-dotnet-v3#5406 . As far as I could find the heuristic margin for serialization overhead is currently the \"best\" way of going about this, if we wanted to automatically split based on request size. I would understand if that is not feasible with this method. If this margin wasn't enough I'm pretty sure the sdk would also be producing errors in certain cases. We could do a PR to make the margin a public constant if that would help, but I could also understand if that wasn't feasible or wouldn't be enough to make this feasible. Just trying to think in solutions :p \n\nI'm pretty sure we would be able to write a unit test that would fail if something changes that would break this (create a SaveChanges that would result in exactly 2MB with all properties specified) And that also fails if the test doesn't specify all properties (a new one was added in the sdk after updating it)\n\n> Though I'm a bit conflicted about this... If we didn't have the https://github.com/dotnet/efcore/issues/17308#issuecomment-3239509178 of transactional batches, I'd argue to disable WhenNeeded altogether; transaction-wise, If you're already not guaranteed transactionality (e.g. different partitions), then what are you actually getting out of WhenNeeded? Transactionality is usually an \"either-you-have-it-or-you-don't\" kind of thing, and WhenNeeded wouldn't provide that, while still causing failures due to the 2MB limit.\n\n> We could still keep WhenNeeded (and as a default), with the rationale that it provides better speed out-of-the-box, at the expense of the 2MB limit (we could catch that error, and throw a more informative error telling the user to disable transactionality for big batches).\n\nI think the average document size is probably below 0.02MB (~20K characters) and you would need 100 of them (in the same partition) to fill up the batch. However, since the error occurs runtime and isn't very predictable to the user I am also afraid of the impact this could have. I like to lean towards caution so I think maybe having Never as default would be best if we don't implement splitting, but I don't rule out the exception with a more informative message and having WhenNeeded as default. Just a side note, is there currently a good way to change the default on AutoTransactionBehavior based on the provider?\n\nI think WhenNeeded provides enough value to at-least stay supported. But I do have to add that when #36599 is implemented, the difference might be a bit less (tho your latency will increase in some cases with bulk, and won't have an effect on larger documents as far as I could tell).\n","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/3361134805/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"JoasE","id":32096708,"node_id":"MDQ6VXNlcjMyMDk2NzA4","avatar_url":"https://avatars.githubusercontent.com/u/32096708?v=4","gravatar_id":"","url":"https://api.github.com/users/JoasE","html_url":"https://github.com/JoasE","followers_url":"https://api.github.com/users/JoasE/followers","following_url":"https://api.github.com/users/JoasE/following{/other_user}","gists_url":"https://api.github.com/users/JoasE/gists{/gist_id}","starred_url":"https://api.github.com/users/JoasE/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JoasE/subscriptions","organizations_url":"https://api.github.com/users/JoasE/orgs","repos_url":"https://api.github.com/users/JoasE/repos","events_url":"https://api.github.com/users/JoasE/events{/privacy}","received_events_url":"https://api.github.com/users/JoasE/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/3361392695","html_url":"https://github.com/dotnet/efcore/issues/36903#issuecomment-3361392695","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/36903","id":3361392695,"node_id":"IC_kwDOAPaMMs7IWsg3","user":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-10-02T14:09:41Z","updated_at":"2025-10-02T14:09:41Z","body":">> Am noting that pre-calculating the request size isn't trivial (to know that it's under 2MB), and could add quite a performance overhead; unless I'm mistaken, we'd have to have a pass to go over all parameters and figure out their size on the wire, which probably means serializing them? I haven't looked to deeply into this, so I may be wrong here.\n>\n> Yes, how ever [we already serialize the entity/document to a stream](https://github.com/dotnet/efcore/blob/8fb7ff77048eb9b9d794e83f060f114dfbe7990f/src/EFCore.Cosmos/Storage/Internal/CosmosTransactionalBatchWrapper.cs#L75), so the only extra step is calculating the size of the request options we specify. Which are relatively small.\n\nRight - looking at the code, we indeed seem to be first serializing to a MemoryStream, and then passing that to the Cosmos SDK CreateItemStream etc. The question is - do we actually have to do that... We're currently allocating a potentially large amount of memory for the MemoryStream, and reading/writing the data multiple times - this really is quite suboptimal performance-wise. Now, that has nothing to do with transaction batches or your recent contribution (we already had this inefficient implementation without batches), but I definitely wouldn't adopt a strategy that **relies** on us pre-serializing everything to memory (in that we'd depend on that for knowing the serialized size for batch splitting). \n\nIn other words, regardless of this discussion, I'd rather we looked into optimizing our current writing method to serialize in true streaming fashion, and not have an intermediate MemoryStream (unless there's something I'm missing here that would make this impossible - would be happy to know). At that point splitting batches on request sizes becomes impossible.\n\nI won't yet comment on the rest - let's first see what @AndriySvyryd thinks of this first part. If we indeed agree that precalculation isn't the way to go, we can then decide what the new default should be, etc.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/3361392695/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":20060862692,"node_id":"MEE_lADOAPaMMs7PN3DOzwAAAASruHjk","url":"https://api.github.com/repos/dotnet/efcore/issues/events/20060862692","actor":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2025-10-02T14:09:43Z","performed_via_github_app":null},{"id":20060862722,"node_id":"SE_lADOAPaMMs7PN3DOzwAAAASruHkC","url":"https://api.github.com/repos/dotnet/efcore/issues/events/20060862722","actor":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2025-10-02T14:09:43Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/3361711651","html_url":"https://github.com/dotnet/efcore/issues/36903#issuecomment-3361711651","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/36903","id":3361711651,"node_id":"IC_kwDOAPaMMs7IX6Yj","user":{"login":"JoasE","id":32096708,"node_id":"MDQ6VXNlcjMyMDk2NzA4","avatar_url":"https://avatars.githubusercontent.com/u/32096708?v=4","gravatar_id":"","url":"https://api.github.com/users/JoasE","html_url":"https://github.com/JoasE","followers_url":"https://api.github.com/users/JoasE/followers","following_url":"https://api.github.com/users/JoasE/following{/other_user}","gists_url":"https://api.github.com/users/JoasE/gists{/gist_id}","starred_url":"https://api.github.com/users/JoasE/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JoasE/subscriptions","organizations_url":"https://api.github.com/users/JoasE/orgs","repos_url":"https://api.github.com/users/JoasE/repos","events_url":"https://api.github.com/users/JoasE/events{/privacy}","received_events_url":"https://api.github.com/users/JoasE/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-10-02T15:17:34Z","updated_at":"2025-10-02T15:17:34Z","body":"> Right - looking at the code, we indeed seem to be first serializing to a MemoryStream, and then passing that to the Cosmos SDK CreateItemStream etc. The question is - do we actually have to do that... We're currently allocating a potentially large amount of memory for the MemoryStream, and reading/writing the data multiple times - this really is quite suboptimal performance-wise. Now, that has nothing to do with transaction batches or your recent contribution (we already had this inefficient implementation without batches), but I definitely wouldn't adopt a strategy that relies on us pre-serializing everything to memory (in that we'd depend on that for knowing the serialized size for batch splitting).\n\nI was wondering why that was aswell, but I assumed there probably was a reason and decided to just use it as is (as you already mentioned). I did some quick digging around and found that the cosmos db sdk already loads the full serialized string into memory (during TransactionalBatch and Bulk) \nSee [BatchExecUtils](https://github.com/Azure/azure-cosmos-dotnet-v3/blob/895697d6448b509d7b3df0d6773b2f84a7039e30/Microsoft.Azure.Cosmos/src/Batch/BatchExecUtils.cs#L28C48-L28C67) and [ItemBatchOperation](https://github.com/Azure/azure-cosmos-dotnet-v3/blob/895697d6448b509d7b3df0d6773b2f84a7039e30/Microsoft.Azure.Cosmos/src/Batch/ItemBatchOperation.cs#L232) (and L262) and also [ServerBatchRequest](https://github.com/Azure/azure-cosmos-dotnet-v3/blob/895697d6448b509d7b3df0d6773b2f84a7039e30/Microsoft.Azure.Cosmos/src/Batch/ServerBatchRequest.cs#L90)\n\nI debugged a unit test and am pretty sure this happens every time. Tho I am not sure why it is needed for `TransactionalBatch` in the cosmos sdk, but Bulk needs it as it splits your requests into ~2kb (or greater if document size is greater) ones for you and needs to know the size to do that. (bulk and batch use the same base code in this case). \nHowever, EF doing it aswell might cause the serialized string to be stored twice in memory now. \n\nLooking at the CosmosJsonDotNetSerializer and [CosmosSystemTextJsonSerializer](https://github.com/Azure/azure-cosmos-dotnet-v3/blob/895697d6448b509d7b3df0d6773b2f84a7039e30/Microsoft.Azure.Cosmos/src/Serializer/CosmosSystemTextJsonSerializer.cs#L81), they appear to serialze to a MemoryStream aswell. EF appears to be using its own serializer, but it also serializes to MemoryStream. So as far as I can see, single document writes will also always load in the full serialized string. Tho I think there is less risk here of having the same string in memory twice, as opposed to batches.\n\nThis appears to be transforming into a cross cutting issue for the cosmos SDK aswell as EF. I think it would be best to address this issue from the cosmos sdk first if there need to be changes there before we start making (more?) changes in EF. But we could also work with what the cosmos sdk offers us now (or minor changes only)","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/3361711651/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"JoasE","id":32096708,"node_id":"MDQ6VXNlcjMyMDk2NzA4","avatar_url":"https://avatars.githubusercontent.com/u/32096708?v=4","gravatar_id":"","url":"https://api.github.com/users/JoasE","html_url":"https://github.com/JoasE","followers_url":"https://api.github.com/users/JoasE/followers","following_url":"https://api.github.com/users/JoasE/following{/other_user}","gists_url":"https://api.github.com/users/JoasE/gists{/gist_id}","starred_url":"https://api.github.com/users/JoasE/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JoasE/subscriptions","organizations_url":"https://api.github.com/users/JoasE/orgs","repos_url":"https://api.github.com/users/JoasE/repos","events_url":"https://api.github.com/users/JoasE/events{/privacy}","received_events_url":"https://api.github.com/users/JoasE/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/3364644301","html_url":"https://github.com/dotnet/efcore/issues/36903#issuecomment-3364644301","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/36903","id":3364644301,"node_id":"IC_kwDOAPaMMs7IjGXN","user":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-10-03T07:47:36Z","updated_at":"2025-10-03T18:03:48Z","body":"> However, EF doing it aswell might cause the serialized string to be stored twice in memory now.\n\nExactly. Regardless of whatever is happening within the Cosmos SDK (that's outside our scope), EF should ideally should be doing things as efficiently as it can at its level, to not add additional unneeded overhead. It's also possible that at some future point the Cosmos SDK will optimized to not do that internally.\n\n> This appears to be transforming into a cross cutting issue for the cosmos SDK aswell as EF. I think it would be best to address this issue from the cosmos sdk first if there need to be changes there before we start making (more?) changes in EF. But we could also work with what the cosmos sdk offers us now (or minor changes only)\n\nI don't actually think we should link the two questions here: each layer should be doing things in a way that's as optimal as possible, regardless of what the other is doing. So I'd open an issue on the Cosmos SDK side, pointing out the inefficiencies there (hopefully they improve things), and from that point we can work on the EF side regardless of what happens in Cosmos.\n\nWhat's more interesting to me is whether the 2MB request limit is something which could be removed on the Cosmos side - as that could have a more significant impact on our design decisions in EF. If that's something that could happen, then it makes everything much simpler.\n\nFinally, we could also argue that the performance gains to be had by always trying to use transactional batches outweigh the perf downsides of serializing in-memory as we're doing today with MemoryStream. I admit that it most probably does, though I still find the pure memory requirements aspect of non-streaming serialization problematic... I'm also still unsure exactly how this all works end-to-end - like do we try to serialize the document, and if it's too big, split it? How do we know how/where to split? If we e.g. split by half, then there's a danger of edge cases where e.g. the very first item of a big batch contains one huge string which itself is over 2MB, and then we find ourselves performing many splits to find out at the end that the first item simply isn't batchable, etc. This is all potentially a **lot** of complexity with potential for bugs (where people still get >2MB exceptions because our heuristics weren't perfect) and possible performance cliffs in specific situations; it feels that it may be wiser to just let the user opt into it when they wish, instead.\n\nBut I think @AndriySvyryd believes it's something we may at least want to explore (from an offline discussion); and we can also reach out internally to the Cosmos people to get more context. \n\nBTW @AndriySvyryd pointed out to me offline that do some conceptually similar length precalculation for SQL Server ([code](https://github.com/dotnet/efcore/blob/main/src/EFCore.SqlServer/Update/Internal/SqlServerModificationCommandBatch.cs#L87)). Though that precalculation is for the SQL length only, and does not include parameters (whereas with Cosmos we basically need the wire size given a JSON document, which really means serializing it).","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/3364644301/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":20076020156,"node_id":"MEE_lADOAPaMMs7PN3DOzwAAAASsn8G8","url":"https://api.github.com/repos/dotnet/efcore/issues/events/20076020156","actor":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2025-10-03T07:47:37Z","performed_via_github_app":null},{"id":20076020187,"node_id":"SE_lADOAPaMMs7PN3DOzwAAAASsn8Hb","url":"https://api.github.com/repos/dotnet/efcore/issues/events/20076020187","actor":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2025-10-03T07:47:37Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/3367417441","html_url":"https://github.com/dotnet/efcore/issues/36903#issuecomment-3367417441","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/36903","id":3367417441,"node_id":"IC_kwDOAPaMMs7ItrZh","user":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-10-03T22:29:28Z","updated_at":"2025-10-03T22:29:28Z","body":"I think we should separate the stream discussion from this, the main reason we use that overload is to avoid CosmosSDK serialization. Perhaps we could request another overload that takes a `ReadOnlySpan<byte>`.\n\n> How do we know how/where to split?\n\nWe keep adding documents, keeping track of where the previous one ends. If we reach 2MB we rollback to the previous position and send that batch or send it as a non-batched operation if there was only one document. Splitting documents is not worth it for the complexity it would involve. That's how this is done for SQL Server in the linked piece of code.\n\nWe **have** to honor the limit in order to support AutoTransactionBehavior.WhenNeeded, relegating this to the user would require them to create an even more complex and inefficient way to do this.\n","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/3367417441/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/3368038484","html_url":"https://github.com/dotnet/efcore/issues/36903#issuecomment-3368038484","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/36903","id":3368038484,"node_id":"IC_kwDOAPaMMs7IwDBU","user":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-10-04T08:58:12Z","updated_at":"2025-10-17T09:33:37Z","body":"> I think we should separate the stream discussion from this, the main reason we use that overload is to avoid CosmosSDK serialization. Perhaps we could request another overload that takes a ReadOnlySpan<byte>.\n\nIf we aim to achieve full streaming writes (i.e. remove the MemoryStream to achieve reduced/fixed memory requirements and better write perf), that has a necessary connection with the precalculation question, which may be necessary for transactional batching. So I'm not sure they can be separate.\n\nRe `ReadOnlySpan<byte>` (I think you may mean `ReadOnlyMemory<byte>` as spans can't be passed to async method)... I'm not sure how that's any different from the current MemoryStream - wouldn't that require having the entire document in memory \nThe main point (for me) is to achieve true streaming writes, and that can be done with the current API (which accepts Stream).\n\n> How do we know how/where to split?\n\nOK, looking at the API I understand things better now - TransactionalBatch accepts separate streams for each item (I was wrongly assuming that we need to produce a single stream for the entire batch). That indeed makes things simpler, and most of what I wrote on this doesn't apply.\n\n> We have to honor the limit in order to support AutoTransactionBehavior.WhenNeeded, relegating this to the user would require them to create an even more complex and inefficient way to do this.\n\nThe point is that if we do it in EF, we need to do it generically and without knowledge of the user's scenario. Unlike us, the user knows exactly what they're doing, i.e. that they're inserting a small number of small documents, and (in the majority of cases) won't have to put together a general system like we'd have to.\n\nAm noting the following additional limitations [from the docs](https://learn.microsoft.com/en-us/azure/cosmos-db/nosql/transactional-batch?tabs=dotnet#limitations):\n\n> The Azure Cosmos DB request size limit constrains the size of the transactional batch payload to not exceed 2 MB, and the maximum execution time is 5 seconds.\n> There's a current limit of 100 operations per transactional batch to ensure the performance is as expected and within SLAs.\n\nObviously there's no way we can know in advance what the execution time will be - so again we have no way of guaranteeing that the transaction batch won't fail (where it would have succeeded without transactional batching).\n\nBecause of all these limitations, this Cosmos feature really does feel like something that users are meant to opt into when they know they're within limits, rather than a general thing that's meant to be used always, systematically (like traditional relational transactions).\n\nSo I admit I'm a bit torn here. One side of me wants to keep this opt-in (to guarantee requests always succeed), the other wants to use transactional batches by default whenever possible for the perf speedup (not for the transactionality, which isn't guaranteed with WhenNeeded in any case); though doing that would be a breaking change.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/3368038484/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/3374577818","html_url":"https://github.com/dotnet/efcore/issues/36903#issuecomment-3374577818","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/36903","id":3374577818,"node_id":"IC_kwDOAPaMMs7JI_ia","user":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-10-06T23:04:30Z","updated_at":"2025-10-06T23:04:30Z","body":"> Re ReadOnlySpan<byte> (I think you may mean ReadOnlyMemory<byte> as spans can't be passed to async method)... I'm not sure how that's any different from the current MemoryStream - wouldn't that require having the entire document in memory\n\nYes, this would signal to the Cosmos SDK that we are not streaming, so they don't need to create a copy of the data in order to process it.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/3374577818/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/3375376423","html_url":"https://github.com/dotnet/efcore/issues/36903#issuecomment-3375376423","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/36903","id":3375376423,"node_id":"IC_kwDOAPaMMs7JMCgn","user":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-10-07T06:20:41Z","updated_at":"2025-10-07T06:20:41Z","body":"@AndriySvyryd OK - IIUC you're saying that if we do decide that EF needs to buffer on its side (e.g. in order to precalculate length for batching - still not sure I'm convinced), we should at least make sure that the Cosmos SDK doesn't do an additional 2nd buffering. If so, then I'm not sure a new ReadOnlyMemory overload is needed - Stream already has Length and Seek, and the Cosmos SDK could call CanSeek to check if it can call them. So it seems like they should have everything they need today to not buffer a 2nd time.\n\nThough just to reiterate, in an ideal world nobody buffers - not EF and not the Cosmos SDK - and we do truly streaming writing across the stack. That may not be possible (e.g. because the Cosmos SDK has to know the length up-front in order to send it to the server via an HTTP header), or we may decide to sacrifice true streaming for batching (assuming we need to precalculate the length to break batches down appropriately).","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/3375376423/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":20132881850,"node_id":"MEE_lADOAPaMMs7PN3DOzwAAAASwA2W6","url":"https://api.github.com/repos/dotnet/efcore/issues/events/20132881850","actor":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2025-10-07T06:20:42Z","performed_via_github_app":null},{"id":20132881902,"node_id":"SE_lADOAPaMMs7PN3DOzwAAAASwA2Xu","url":"https://api.github.com/repos/dotnet/efcore/issues/events/20132881902","actor":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2025-10-07T06:20:42Z","performed_via_github_app":null},{"actor":{"login":"JoasE","id":32096708,"node_id":"MDQ6VXNlcjMyMDk2NzA4","avatar_url":"https://avatars.githubusercontent.com/u/32096708?v=4","gravatar_id":"","url":"https://api.github.com/users/JoasE","html_url":"https://github.com/JoasE","followers_url":"https://api.github.com/users/JoasE/followers","following_url":"https://api.github.com/users/JoasE/following{/other_user}","gists_url":"https://api.github.com/users/JoasE/gists{/gist_id}","starred_url":"https://api.github.com/users/JoasE/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JoasE/subscriptions","organizations_url":"https://api.github.com/users/JoasE/orgs","repos_url":"https://api.github.com/users/JoasE/repos","events_url":"https://api.github.com/users/JoasE/events{/privacy}","received_events_url":"https://api.github.com/users/JoasE/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-10-07T13:29:16Z","updated_at":"2025-10-07T13:29:16Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/issues/5438","repository_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3","labels_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/issues/5438/labels{/name}","comments_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/issues/5438/comments","events_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/issues/5438/events","html_url":"https://github.com/Azure/azure-cosmos-dotnet-v3/issues/5438","id":3491509767,"node_id":"I_kwDOCVBZtM7QHDYH","number":5438,"title":"Streaming writes and memory usage improvements","user":{"login":"JoasE","id":32096708,"node_id":"MDQ6VXNlcjMyMDk2NzA4","avatar_url":"https://avatars.githubusercontent.com/u/32096708?v=4","gravatar_id":"","url":"https://api.github.com/users/JoasE","html_url":"https://github.com/JoasE","followers_url":"https://api.github.com/users/JoasE/followers","following_url":"https://api.github.com/users/JoasE/following{/other_user}","gists_url":"https://api.github.com/users/JoasE/gists{/gist_id}","starred_url":"https://api.github.com/users/JoasE/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JoasE/subscriptions","organizations_url":"https://api.github.com/users/JoasE/orgs","repos_url":"https://api.github.com/users/JoasE/repos","events_url":"https://api.github.com/users/JoasE/events{/privacy}","received_events_url":"https://api.github.com/users/JoasE/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1186758043,"node_id":"MDU6TGFiZWwxMTg2NzU4MDQz","url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/labels/needs-investigation","name":"needs-investigation","color":"ddf78a","default":false,"description":""},{"id":2252695893,"node_id":"MDU6TGFiZWwyMjUyNjk1ODkz","url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/labels/customer-reported","name":"customer-reported","color":"ce3984","default":false,"description":"Issue created by a customer"}],"state":"open","locked":false,"assignee":{"login":"yash2710","id":8458233,"node_id":"MDQ6VXNlcjg0NTgyMzM=","avatar_url":"https://avatars.githubusercontent.com/u/8458233?v=4","gravatar_id":"","url":"https://api.github.com/users/yash2710","html_url":"https://github.com/yash2710","followers_url":"https://api.github.com/users/yash2710/followers","following_url":"https://api.github.com/users/yash2710/following{/other_user}","gists_url":"https://api.github.com/users/yash2710/gists{/gist_id}","starred_url":"https://api.github.com/users/yash2710/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yash2710/subscriptions","organizations_url":"https://api.github.com/users/yash2710/orgs","repos_url":"https://api.github.com/users/yash2710/repos","events_url":"https://api.github.com/users/yash2710/events{/privacy}","received_events_url":"https://api.github.com/users/yash2710/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"yash2710","id":8458233,"node_id":"MDQ6VXNlcjg0NTgyMzM=","avatar_url":"https://avatars.githubusercontent.com/u/8458233?v=4","gravatar_id":"","url":"https://api.github.com/users/yash2710","html_url":"https://github.com/yash2710","followers_url":"https://api.github.com/users/yash2710/followers","following_url":"https://api.github.com/users/yash2710/following{/other_user}","gists_url":"https://api.github.com/users/yash2710/gists{/gist_id}","starred_url":"https://api.github.com/users/yash2710/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yash2710/subscriptions","organizations_url":"https://api.github.com/users/yash2710/orgs","repos_url":"https://api.github.com/users/yash2710/repos","events_url":"https://api.github.com/users/yash2710/events{/privacy}","received_events_url":"https://api.github.com/users/yash2710/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":0,"created_at":"2025-10-07T13:29:15Z","updated_at":"2025-10-07T19:12:22Z","closed_at":null,"author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":156260788,"node_id":"MDEwOlJlcG9zaXRvcnkxNTYyNjA3ODg=","name":"azure-cosmos-dotnet-v3","full_name":"Azure/azure-cosmos-dotnet-v3","private":false,"owner":{"login":"Azure","id":6844498,"node_id":"MDEyOk9yZ2FuaXphdGlvbjY4NDQ0OTg=","avatar_url":"https://avatars.githubusercontent.com/u/6844498?v=4","gravatar_id":"","url":"https://api.github.com/users/Azure","html_url":"https://github.com/Azure","followers_url":"https://api.github.com/users/Azure/followers","following_url":"https://api.github.com/users/Azure/following{/other_user}","gists_url":"https://api.github.com/users/Azure/gists{/gist_id}","starred_url":"https://api.github.com/users/Azure/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Azure/subscriptions","organizations_url":"https://api.github.com/users/Azure/orgs","repos_url":"https://api.github.com/users/Azure/repos","events_url":"https://api.github.com/users/Azure/events{/privacy}","received_events_url":"https://api.github.com/users/Azure/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/Azure/azure-cosmos-dotnet-v3","description":".NET SDK for Azure Cosmos DB for the core SQL API","fork":false,"url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3","forks_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/forks","keys_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/keys{/key_id}","collaborators_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/teams","hooks_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/hooks","issue_events_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/issues/events{/number}","events_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/events","assignees_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/assignees{/user}","branches_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/branches{/branch}","tags_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/tags","blobs_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/git/refs{/sha}","trees_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/git/trees{/sha}","statuses_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/statuses/{sha}","languages_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/languages","stargazers_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/stargazers","contributors_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/contributors","subscribers_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/subscribers","subscription_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/subscription","commits_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/commits{/sha}","git_commits_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/git/commits{/sha}","comments_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/comments{/number}","issue_comment_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/issues/comments{/number}","contents_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/contents/{+path}","compare_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/compare/{base}...{head}","merges_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/merges","archive_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/downloads","issues_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/issues{/number}","pulls_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/pulls{/number}","milestones_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/milestones{/number}","notifications_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/labels{/name}","releases_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/releases{/id}","deployments_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/deployments","created_at":"2018-11-05T18:03:16Z","updated_at":"2025-11-08T02:37:14Z","pushed_at":"2025-11-08T02:37:10Z","git_url":"git://github.com/Azure/azure-cosmos-dotnet-v3.git","ssh_url":"git@github.com:Azure/azure-cosmos-dotnet-v3.git","clone_url":"https://github.com/Azure/azure-cosmos-dotnet-v3.git","svn_url":"https://github.com/Azure/azure-cosmos-dotnet-v3","homepage":null,"size":165731,"stargazers_count":776,"watchers_count":776,"language":"C#","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":true,"forks_count":524,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":470,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":[],"visibility":"public","forks":524,"open_issues":470,"watchers":776,"default_branch":"master","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"**Is your feature request related to a problem? Please describe.**\nAs far as I can tell, the sdk will always load in the full document/request body into memory. Even when passing in a non-seekable stream to the Stream api's. This is inefficient for memory usage. Is there a reason the sdk does this? Does it need to know the content length before sending the request to cosmos db? There is even some duplicate buffering going on (at least for [TranscationalBatch](https://github.com/Azure/azure-cosmos-dotnet-v3/blob/895697d6448b509d7b3df0d6773b2f84a7039e30/Microsoft.Azure.Cosmos/src/Batch/ServerBatchRequest.cs#L113C13-L115C1)) \n\n**Describe the solution you'd like**\nA truly streaming -write api and -caplable serializer.\n```csharp\npublic abstract class CosmosSerializer\n{\n//...\n    public abstract Task ToStreamAsync<T>(T input, Stream destinationStream);\n}\n```\n\n```csharp\npublic abstract class TransactionalBatch\n{\n//...\n    public abstract TranscationalBatch UpsertItemStream(Func<Stream, Task> streamWriter);\n}\n```\n\nAnd optimization of duplicate buffer allocations throughout Batch and Bulk api's.\n\n**Describe alternatives you've considered**\nThere are no alternatives for streaming writes as far as I could find.\n\n**Additional context**\ndotnet/efcore#36903","reactions":{"url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/issues/5438/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/Azure/azure-cosmos-dotnet-v3/issues/5438/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/3376975764","html_url":"https://github.com/dotnet/efcore/issues/36903#issuecomment-3376975764","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/36903","id":3376975764,"node_id":"IC_kwDOAPaMMs7JSI-U","user":{"login":"JoasE","id":32096708,"node_id":"MDQ6VXNlcjMyMDk2NzA4","avatar_url":"https://avatars.githubusercontent.com/u/32096708?v=4","gravatar_id":"","url":"https://api.github.com/users/JoasE","html_url":"https://github.com/JoasE","followers_url":"https://api.github.com/users/JoasE/followers","following_url":"https://api.github.com/users/JoasE/following{/other_user}","gists_url":"https://api.github.com/users/JoasE/gists{/gist_id}","starred_url":"https://api.github.com/users/JoasE/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JoasE/subscriptions","organizations_url":"https://api.github.com/users/JoasE/orgs","repos_url":"https://api.github.com/users/JoasE/repos","events_url":"https://api.github.com/users/JoasE/events{/privacy}","received_events_url":"https://api.github.com/users/JoasE/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-10-07T13:47:01Z","updated_at":"2025-10-07T13:56:32Z","body":"> @AndriySvyryd OK - IIUC you're saying that if we do decide that EF needs to buffer on its side (e.g. in order to precalculate length for batching - still not sure I'm convinced), we should at least make sure that the Cosmos SDK doesn't do an additional 2nd buffering. If so, then I'm not sure a new ReadOnlyMemory overload is needed - Stream already has Length and Seek, and the Cosmos SDK could call CanSeek to check if it can call them. So it seems like they should have everything they need today to not buffer a 2nd time.\n\nIt appears they at-least do already do this for MemoryStream: https://github.com/Azure/azure-cosmos-dotnet-v3/blob/895697d6448b509d7b3df0d6773b2f84a7039e30/Microsoft.Azure.Cosmos/src/Batch/BatchExecUtils.cs#L38C35-L38C47\n\n> Though just to reiterate, in an ideal world nobody buffers - not EF and not the Cosmos SDK - and we do truly streaming writing across the stack. That may not be possible (e.g. because the Cosmos SDK has to know the length up-front in order to send it to the server via an HTTP header), or we may decide to sacrifice true streaming for batching (assuming we need to precalculate the length to break batches down appropriately).\n\nI agree, but there currently is no way to do streaming writes with the .net cosmos sdk's api design. I don't think there is a 'pull based' json producing stream in jsondotnet aswell as newtonsoft, and even if there was the cosmos sdk would read it into memory (with the way it works now). It even reads the whole batch request into memory, not operation per operation, and with a duplicate buffer. I've created an issue for this: Azure/azure-cosmos-dotnet-v3#5438 . I think implementing this would require more than average amount of refactoring on their side.\n\nConsidering the former, I think it would be best to serialize to memory stream and calculate the request size and split when using batching in EF for now. Peak memory usage on the client will increase in 11.0 with WhenNeeded, but I think it is worth it (especially comparing to the previous non-bulk sequential writes). If and when they do release a true-streaming writes api in the cosmos sdk, we could consider an additional configuration where you can turn off the batch splitting behaviour in EF-core (and it will use the streaming apis) and guarantee <2MB SaveChanges request size yourself to optimize memory usage.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/3376975764/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"JoasE","id":32096708,"node_id":"MDQ6VXNlcjMyMDk2NzA4","avatar_url":"https://avatars.githubusercontent.com/u/32096708?v=4","gravatar_id":"","url":"https://api.github.com/users/JoasE","html_url":"https://github.com/JoasE","followers_url":"https://api.github.com/users/JoasE/followers","following_url":"https://api.github.com/users/JoasE/following{/other_user}","gists_url":"https://api.github.com/users/JoasE/gists{/gist_id}","starred_url":"https://api.github.com/users/JoasE/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JoasE/subscriptions","organizations_url":"https://api.github.com/users/JoasE/orgs","repos_url":"https://api.github.com/users/JoasE/repos","events_url":"https://api.github.com/users/JoasE/events{/privacy}","received_events_url":"https://api.github.com/users/JoasE/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":20141441769,"node_id":"MEE_lADOAPaMMs7PN3DOzwAAAASwhgLp","url":"https://api.github.com/repos/dotnet/efcore/issues/events/20141441769","actor":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2025-10-07T13:47:05Z","performed_via_github_app":null},{"id":20141441808,"node_id":"SE_lADOAPaMMs7PN3DOzwAAAASwhgMQ","url":"https://api.github.com/repos/dotnet/efcore/issues/events/20141441808","actor":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2025-10-07T13:47:05Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/3377076460","html_url":"https://github.com/dotnet/efcore/issues/36903#issuecomment-3377076460","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/36903","id":3377076460,"node_id":"IC_kwDOAPaMMs7JShjs","user":{"login":"JoasE","id":32096708,"node_id":"MDQ6VXNlcjMyMDk2NzA4","avatar_url":"https://avatars.githubusercontent.com/u/32096708?v=4","gravatar_id":"","url":"https://api.github.com/users/JoasE","html_url":"https://github.com/JoasE","followers_url":"https://api.github.com/users/JoasE/followers","following_url":"https://api.github.com/users/JoasE/following{/other_user}","gists_url":"https://api.github.com/users/JoasE/gists{/gist_id}","starred_url":"https://api.github.com/users/JoasE/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JoasE/subscriptions","organizations_url":"https://api.github.com/users/JoasE/orgs","repos_url":"https://api.github.com/users/JoasE/repos","events_url":"https://api.github.com/users/JoasE/events{/privacy}","received_events_url":"https://api.github.com/users/JoasE/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-10-07T14:09:31Z","updated_at":"2025-10-07T14:09:31Z","body":"> Obviously there's no way we can know in advance what the execution time will be - so again we have no way of guaranteeing that the transaction batch won't fail (where it would have succeeded without transactional batching).\nBecause of all these limitations, this Cosmos feature really does feel like something that users are meant to opt into when they know they're within limits, rather than a general thing that's meant to be used always, systematically (like traditional relational transactions).\nSo I admit I'm a bit torn here. One side of me wants to keep this opt-in (to guarantee requests always succeed), the other wants to use transactional batches by default whenever possible for the perf speedup (not for the transactionality, which isn't guaranteed with WhenNeeded in any case); though doing that would be a breaking change.\n\n@roji I see your point. Being the devils advocate, any request we send to cosmos db could time out. Either due to insufficient RU/s (or higher load than usual) or even the 5s request time limit (tho I don't think it's likely that is ever hit with a single write/read). The same goes for SQL Server, it will timeout if your transaction takes longer than 30 seconds to commit usually. This is configurable in sql server, but still. EF can't guarantee the transaction will succeed.\n\nI think I would be ok with having Never as the default tho, especially once #36599 support is added to EF. As TranscationalBatch will skip Bulk AFAIK.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/3377076460/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"JoasE","id":32096708,"node_id":"MDQ6VXNlcjMyMDk2NzA4","avatar_url":"https://avatars.githubusercontent.com/u/32096708?v=4","gravatar_id":"","url":"https://api.github.com/users/JoasE","html_url":"https://github.com/JoasE","followers_url":"https://api.github.com/users/JoasE/followers","following_url":"https://api.github.com/users/JoasE/following{/other_user}","gists_url":"https://api.github.com/users/JoasE/gists{/gist_id}","starred_url":"https://api.github.com/users/JoasE/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JoasE/subscriptions","organizations_url":"https://api.github.com/users/JoasE/orgs","repos_url":"https://api.github.com/users/JoasE/repos","events_url":"https://api.github.com/users/JoasE/events{/privacy}","received_events_url":"https://api.github.com/users/JoasE/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":20141983775,"node_id":"MEE_lADOAPaMMs7PN3DOzwAAAASwjkgf","url":"https://api.github.com/repos/dotnet/efcore/issues/events/20141983775","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2025-10-07T14:09:33Z","performed_via_github_app":null},{"id":20141983826,"node_id":"SE_lADOAPaMMs7PN3DOzwAAAASwjkhS","url":"https://api.github.com/repos/dotnet/efcore/issues/events/20141983826","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2025-10-07T14:09:33Z","performed_via_github_app":null}]