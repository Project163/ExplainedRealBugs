{"url":"https://api.github.com/repos/dotnet/efcore/issues/33023","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/33023/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/33023/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/33023/events","html_url":"https://github.com/dotnet/efcore/issues/33023","id":2123646890,"node_id":"I_kwDOAPaMMs5-lEeq","number":33023,"title":"Update command order with computed columns and unique constraints","user":{"login":"JustusGreiberORGADATA","id":89198375,"node_id":"MDQ6VXNlcjg5MTk4Mzc1","avatar_url":"https://avatars.githubusercontent.com/u/89198375?v=4","gravatar_id":"","url":"https://api.github.com/users/JustusGreiberORGADATA","html_url":"https://github.com/JustusGreiberORGADATA","followers_url":"https://api.github.com/users/JustusGreiberORGADATA/followers","following_url":"https://api.github.com/users/JustusGreiberORGADATA/following{/other_user}","gists_url":"https://api.github.com/users/JustusGreiberORGADATA/gists{/gist_id}","starred_url":"https://api.github.com/users/JustusGreiberORGADATA/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JustusGreiberORGADATA/subscriptions","organizations_url":"https://api.github.com/users/JustusGreiberORGADATA/orgs","repos_url":"https://api.github.com/users/JustusGreiberORGADATA/repos","events_url":"https://api.github.com/users/JustusGreiberORGADATA/events{/privacy}","received_events_url":"https://api.github.com/users/JustusGreiberORGADATA/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":514908713,"node_id":"MDU6TGFiZWw1MTQ5MDg3MTM=","url":"https://api.github.com/repos/dotnet/efcore/labels/regression","name":"regression","color":"ff1fff","default":false,"description":null},{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1900941009,"node_id":"MDU6TGFiZWwxOTAwOTQxMDA5","url":"https://api.github.com/repos/dotnet/efcore/labels/area-save-changes","name":"area-save-changes","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/180","html_url":"https://github.com/dotnet/efcore/milestone/180","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/180/labels","id":9963267,"node_id":"MI_kwDOAPaMMs4AmAcD","number":180,"title":"9.0.0","description":null,"creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":339,"state":"closed","created_at":"2023-09-25T15:41:58Z","updated_at":"2025-04-01T18:19:15Z","due_on":null,"closed_at":"2024-11-14T11:54:05Z"},"comments":2,"created_at":"2024-02-07T18:39:31Z","updated_at":"2025-06-15T19:58:28Z","closed_at":"2024-09-14T06:20:58Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Ask a question\r\n\r\nEF Core will sort UPDATE commands in the method [CommandBatchPreparer.TopologicalSort](https://github.com/dotnet/efcore/blob/v7.0.15/src/EFCore.Relational/Update/Internal/CommandBatchPreparer.cs#L340) to make sure that unique constraints of the store are not violated (while in a transaction).\r\n\r\nEF Core can do this, because it knows which columns the constraints apply to and which value changes occurred.\r\n\r\nThings get trickier if you have a computed column with a unique constraint that depends on a regular column. EF Core by default can't know how the value in the computed column is related to the value in the regular column and therefore can't generate the correct topological sort to not violate the stores constraints.\r\n\r\nUp until EF Core 6.0 we used a little \"trick\" to make EF Core aware of the data dependency: We created a property setter for the generated column, that told EF Core the relation between the columns. If you were to have a generated column like this:\r\n\r\n````csharp\r\nmodelBuilder.Entity<TestEntity>()\r\n    .Property(e => e.IsPrimaryNormalized)\r\n    .HasComputedColumnSql($\"IIF(IsPrimary, true, null)\", stored: true);\r\n\r\nmodelBuilder.Entity<TestEntity>()\r\n    .HasIndex(e => new { e.UserId, e.IsPrimaryNormalized })\r\n    .IsUnique();\r\n````\r\n\r\nWe would create the following properties inside the entity:\r\n````csharp\r\npublic bool IsPrimary { get; set; }\r\npublic bool? IsPrimaryNormalized { get => IsPrimary ? true : null; private set { } }\r\n````\r\n\r\nThis worked great - the update statements were always sorted correctly when we modified `IsPrimary`.\r\n\r\nNow we are looking into upgrading to EF Core 7 or EF Core 8 and discovered that this \"trick\" no longer works. I am aware though that using properties like this to represent this data dependency might have never been part of the official feature set (this is why I call it a \"trick\"). This therefore might not really be a breaking change.\r\n\r\nThis is why I came here to ask: Is there an official story for making EF Core aware of the expected value of computed columns or the order in which update statements need to be executed? Is the above supposed to work?\r\nOr do I just have to bite the bullet and call `SaveChanges()` twice and wrap the whole thing in an explicit transaction? (This would likely make the code more confusing for people reading it for the first time.)\r\n\r\n### Include your code\r\n\r\nQuestion is already pretty long, so I put a full setup in this gist:\r\n\r\nhttps://gist.github.com/JustusGreiberORGADATA/4f4529c282cc0abd379bb3871c11063d#file-program-cs\r\n\r\nIf this is a problem, just ping me and I will add it in a comment.\r\n\r\n### Include provider and version information\r\n\r\nEF Core version: 6. Trying to update to 7 or 8.\r\nDatabase provider: My first tests have this issue with Microsoft.EntityFrameworkCore.Sqlite. Later I also want this to work in MariaDB.\r\nTarget framework: .NET 7 for EF Core 7. .NET 8 for EF Core 8.\r\nOperating system: Windows\r\nIDE: Visual Studio 2022 17.8.6\r\n","closed_by":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/33023/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/33023/timeline","performed_via_github_app":null,"state_reason":"completed"}