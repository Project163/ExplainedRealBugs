{"url":"https://api.github.com/repos/dotnet/efcore/issues/27948","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/27948/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/27948/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/27948/events","html_url":"https://github.com/dotnet/efcore/issues/27948","id":1225124859,"node_id":"I_kwDOAPaMMs5JBev7","number":27948,"title":"Investigation into aggregates, supported operators and multiple enumerable parameters","user":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1675384372,"node_id":"MDU6TGFiZWwxNjc1Mzg0Mzcy","url":"https://api.github.com/repos/dotnet/efcore/labels/area-query","name":"area-query","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"smitpatel","id":1528107,"node_id":"MDQ6VXNlcjE1MjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1528107?v=4","gravatar_id":"","url":"https://api.github.com/users/smitpatel","html_url":"https://github.com/smitpatel","followers_url":"https://api.github.com/users/smitpatel/followers","following_url":"https://api.github.com/users/smitpatel/following{/other_user}","gists_url":"https://api.github.com/users/smitpatel/gists{/gist_id}","starred_url":"https://api.github.com/users/smitpatel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smitpatel/subscriptions","organizations_url":"https://api.github.com/users/smitpatel/orgs","repos_url":"https://api.github.com/users/smitpatel/repos","events_url":"https://api.github.com/users/smitpatel/events{/privacy}","received_events_url":"https://api.github.com/users/smitpatel/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"smitpatel","id":1528107,"node_id":"MDQ6VXNlcjE1MjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1528107?v=4","gravatar_id":"","url":"https://api.github.com/users/smitpatel","html_url":"https://github.com/smitpatel","followers_url":"https://api.github.com/users/smitpatel/followers","following_url":"https://api.github.com/users/smitpatel/following{/other_user}","gists_url":"https://api.github.com/users/smitpatel/gists{/gist_id}","starred_url":"https://api.github.com/users/smitpatel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smitpatel/subscriptions","organizations_url":"https://api.github.com/users/smitpatel/orgs","repos_url":"https://api.github.com/users/smitpatel/repos","events_url":"https://api.github.com/users/smitpatel/events{/privacy}","received_events_url":"https://api.github.com/users/smitpatel/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/128","html_url":"https://github.com/dotnet/efcore/milestone/128","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/128/labels","id":7236796,"node_id":"MI_kwDOAPaMMs4Abmy8","number":128,"title":"7.0.0","description":"EF Core 7.0","creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":375,"state":"closed","created_at":"2021-10-09T18:57:40Z","updated_at":"2024-11-13T16:14:22Z","due_on":null,"closed_at":"2022-11-05T18:37:45Z"},"comments":3,"created_at":"2022-05-04T09:25:42Z","updated_at":"2025-06-15T18:47:01Z","closed_at":"2022-05-10T02:59:01Z","author_association":"MEMBER","type":{"id":1092406,"node_id":"IT_kwDOAIt-yc4AEKs2","name":"Feature","description":"A request, idea, or new functionality","color":"blue","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-10-08T09:10:05Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I did some further investigation into what's supported across databases in terms of aggregates, operators (distinct/ordering/filtering) and multiple enumerable parameters; this is to help inform @smitpatel's work on custom aggregate support (see #27931, #27935).\r\n\r\ntl;dr:\r\n\r\n* Aggregate functions with multiple enumerable parameters are a *very* rare thing. The only example I'm seeing is creating a JSON document from two columns, which function as the keys and values (PG [jsonb_object_agg](https://www.postgresql.org/docs/current/functions-aggregate.html), MySQL [JSON_ARRAYAGG](https://dev.mysql.com/doc/refman/8.0/en/aggregate-functions.html#function_json-arrayagg), SQLite [json_group_array](https://www.sqlite.org/json1.html#jgroupobject)).\r\n* Operators are always applied at the input row level, and never at the individual argument level. In other words, I haven't found a case where one can specify different distinct/order by/filtering on different single enumerable arguments. The syntax for specifying the operators frequently conveys this, e.g. SQL Server ordering and PG filtering are outside the aggregate function's parentheses.\r\n* This means that although it is possible to express different operators in LINQ, AFAICT this won't be supported in SQL (providers will have to detect this and throw).\r\n* Not sure this has concrete implications for us. One *possible* action from this could be to for the relational query pipeline to extract operators from SqlEnumerableExpression parameters, ensure they're identical, and pass them to the aggregate method translator as separate parameters.\r\n    * This could be considered slightly \"cleaner\", since providers see the operators at the level where they actually operate in SQL, i.e. at the function level, not at the argument level.\r\n    * As in #27935, this would require translators to deal with the predicate explicitly, i.e. do a CASE/WHEN, copy it to their custom aggregate function expression or whatever.\r\n    * Given how few multiarg functions there are, this probably isn't very critical (most functions have a single enumerable arg, so  exactly where the operators are doesn't matter that much).\r\n* Writing an aggregate method translator will definitely be less trivial than a regular method translator :) \r\n\r\n<details>\r\n<summary>PostgreSQL</summary>\r\n\r\n```sql\r\nDROP TABLE IF EXISTS data;\r\nCREATE TABLE data\r\n(\r\n  id INT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,\r\n  jkey TEXT,\r\n  jval TEXT\r\n);\r\n\r\nINSERT INTO data (jkey, jval) VALUES ('foo1', 'bar1'), ('foo2', 'bar2'), ('foo3', 'bar3'), ('foo1', 'bar1');\r\n\r\n-- Distinct, ordering and filtering in regular scenario (single enumerable parameter)\r\nSELECT jsonb_agg(DISTINCT jkey) FROM data;\r\nSELECT jsonb_agg(jkey ORDER BY jkey DESC) FROM data;\r\nSELECT jsonb_agg(jkey) FILTER (WHERE jval NOT LIKE '%3') FROM data;\r\n\r\n-- Multiple enumerable arguments\r\n-- Docs for json_object_agg: https://www.postgresql.org/docs/current/functions-aggregate.html\r\nSELECT json_object_agg(jkey, jval) FROM data;\r\n\r\n-- Only one ORDER BY is supported, applying to the row, not to each enumerable argument:\r\nSELECT json_object_agg(jkey, jval ORDER BY jkey DESC) FROM data;\r\n-- ORDER BY on a specific argument is not supported:\r\nSELECT json_object_agg(jkey ORDER BY jkey DESC, jval) FROM data;\r\n\r\n-- Same with distinct: only one DISTINCT is allowed, applied to the row as a whole, at the start of the parentheses:\r\nSELECT json_object_agg(DISTINCT jkey, jval) FROM data;\r\n-- DISTINCT on a specific argument is not supported:\r\nSELECT json_object_agg(jkey, DISTINCT jval) FROM data;\r\n\r\n-- Same with filtering: the FILTER clause is specified outside the parentheses:\r\nSELECT json_object_agg(jkey, jval) FILTER (WHERE jval NOT LIKE '%3') FROM data;\r\n\r\n-- It may be possible to apply different filters/distincts on different arguments via a subquery pushdown (i.e.\r\n-- apply the aggregate function to the output of a subquery)\r\n```\r\n\r\n</details>\r\n\r\n<details>\r\n<summary>MySQL</summary>\r\n\r\n```sql\r\nDROP TABLE IF EXISTS data;\r\nCREATE TABLE data\r\n(\r\n    id INT PRIMARY KEY AUTO_INCREMENT,\r\n    jkey VARCHAR(30),\r\n    jval VARCHAR(30)\r\n);\r\n\r\nINSERT INTO data (jkey, jval) VALUES ('foo1', 'bar1'), ('foo2', 'bar2'), ('foo3', 'bar3'), ('foo1', 'bar1');\r\n\r\n-- Distinct and ordering in regular scenario (single enumerable parameter). Filtering apparently not supported.\r\nSELECT GROUP_CONCAT(DISTINCT jkey) FROM data;\r\nSELECT GROUP_CONCAT(jkey ORDER BY jkey DESC) FROM data;\r\n\r\n-- Multiple enumerable arguments\r\n-- Docs: https://dev.mysql.com/doc/refman/8.0/en/aggregate-functions.html#function_json-arrayagg\r\nSELECT JSON_OBJECTAGG(jkey, jval) FROM data;\r\n\r\n-- DISTINCT and ORDER BY not supported:\r\nSELECT JSON_OBJECTAGG(DISTINCT jkey, jval) FROM data;\r\nSELECT JSON_OBJECTAGG(jkey, jval ORDER BY jval) FROM data;\r\n```\r\n\r\n</details>\r\n\r\n<details>\r\n<summary>SQL Server</summary>\r\n\r\n```sql\r\nDROP TABLE IF EXISTS data;\r\nCREATE TABLE data\r\n(\r\n    id INT PRIMARY KEY IDENTITY,\r\n    jkey VARCHAR(MAX),\r\n    jval VARCHAR(MAX)\r\n);\r\n\r\nINSERT INTO data (jkey, jval) VALUES ('foo1', 'bar1'), ('foo2', 'bar2'), ('foo3', 'bar3'), ('foo1', 'bar1');\r\n\r\n-- Docs: https://docs.microsoft.com/en-us/sql/t-sql/functions/string-agg-transact-sql\r\nSELECT STRING_AGG(jkey, ',') FROM data;\r\n-- With ordering:\r\nSELECT STRING_AGG(jkey, ',') WITHIN GROUP (ORDER BY jkey DESC) FROM data;\r\n\r\n-- Distinct supported in regular cases:\r\nSELECT MAX(DISTINCT jkey) FROM data;\r\n-- But not with STRING_AGG (because multiple parameters?):\r\nSELECT STRING_AGG(DISTINCT jkey, ',') FROM data;\r\n\r\n-- No JSON aggregate functions, no functions with multiple enumerable parameters\r\n-- (docs: https://docs.microsoft.com/en-us/sql/t-sql/functions/aggregate-functions-transact-sql)\r\n```\r\n</details>\r\n\r\n<details>\r\n<summary>SQLite</summary>\r\n\r\n```sql\r\nDROP TABLE IF EXISTS data;\r\nCREATE TABLE data\r\n(\r\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n    jkey TEXT,\r\n    jval TEXT\r\n);\r\n\r\nINSERT INTO data (jkey, jval) VALUES ('foo1', 'bar1'), ('foo2', 'bar2'), ('foo3', 'bar3'), ('foo1', 'bar1');\r\n\r\n-- Docs: https://www.sqlite.org/json1.html#jgroupobject\r\n\r\n-- Distinct works for single enumerable parameter, ordering/filtering apparently not supported\r\nSELECT json_group_array(DISTINCT jkey) FROM data;\r\n\r\n-- Distinct not supported for multiple enumerable parameters:\r\nSELECT json_group_object(DISTINCT jkey, jval) FROM data; -- Error: DISTINCT aggregates must have exactly one argument\r\n```\r\n\r\n</details>\r\n\r\n<details>\r\n<summary>Oracle</summary>\r\n\r\nOracle also has [JSON_ARRAY_AGG](https://docs.oracle.com/en/database/oracle/oracle-database/12.2/sqlrf/JSON_ARRAYAGG.html) (single enumerable parameter) and [JSON_OBJECTAGG](https://docs.oracle.com/en/database/oracle/oracle-database/12.2/sqlrf/JSON_OBJECTAGG.html) (multiple). The former supports an order by clause, the latter does not.\r\n</details>\r\n\r\n/cc @lauxjpn","closed_by":{"login":"smitpatel","id":1528107,"node_id":"MDQ6VXNlcjE1MjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1528107?v=4","gravatar_id":"","url":"https://api.github.com/users/smitpatel","html_url":"https://github.com/smitpatel","followers_url":"https://api.github.com/users/smitpatel/followers","following_url":"https://api.github.com/users/smitpatel/following{/other_user}","gists_url":"https://api.github.com/users/smitpatel/gists{/gist_id}","starred_url":"https://api.github.com/users/smitpatel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smitpatel/subscriptions","organizations_url":"https://api.github.com/users/smitpatel/orgs","repos_url":"https://api.github.com/users/smitpatel/repos","events_url":"https://api.github.com/users/smitpatel/events{/privacy}","received_events_url":"https://api.github.com/users/smitpatel/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/27948/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/27948/timeline","performed_via_github_app":null,"state_reason":"completed"}