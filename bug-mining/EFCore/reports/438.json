{"url":"https://api.github.com/repos/dotnet/efcore/issues/33330","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/33330/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/33330/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/33330/events","html_url":"https://github.com/dotnet/efcore/issues/33330","id":2188515770,"node_id":"I_kwDOAPaMMs6Cchm6","number":33330,"title":"ValueConverter not applied to operands on ExecuteUpdateAsync ","user":{"login":"Danielku15","id":674916,"node_id":"MDQ6VXNlcjY3NDkxNg==","avatar_url":"https://avatars.githubusercontent.com/u/674916?v=4","gravatar_id":"","url":"https://api.github.com/users/Danielku15","html_url":"https://github.com/Danielku15","followers_url":"https://api.github.com/users/Danielku15/followers","following_url":"https://api.github.com/users/Danielku15/following{/other_user}","gists_url":"https://api.github.com/users/Danielku15/gists{/gist_id}","starred_url":"https://api.github.com/users/Danielku15/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Danielku15/subscriptions","organizations_url":"https://api.github.com/users/Danielku15/orgs","repos_url":"https://api.github.com/users/Danielku15/repos","events_url":"https://api.github.com/users/Danielku15/events{/privacy}","received_events_url":"https://api.github.com/users/Danielku15/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":514908713,"node_id":"MDU6TGFiZWw1MTQ5MDg3MTM=","url":"https://api.github.com/repos/dotnet/efcore/labels/regression","name":"regression","color":"ff1fff","default":false,"description":null},{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1675384372,"node_id":"MDU6TGFiZWwxNjc1Mzg0Mzcy","url":"https://api.github.com/repos/dotnet/efcore/labels/area-query","name":"area-query","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/180","html_url":"https://github.com/dotnet/efcore/milestone/180","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/180/labels","id":9963267,"node_id":"MI_kwDOAPaMMs4AmAcD","number":180,"title":"9.0.0","description":null,"creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":339,"state":"closed","created_at":"2023-09-25T15:41:58Z","updated_at":"2025-04-01T18:19:15Z","due_on":null,"closed_at":"2024-11-14T11:54:05Z"},"comments":4,"created_at":"2024-03-15T13:27:02Z","updated_at":"2025-06-15T20:00:17Z","closed_at":"2024-03-27T16:50:43Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"When upgrading from EFCore7 to EFCore8 the code below doesn't work anymore. In EFCore7 the ValueConverter configured on the property was applied to the TimeSpan operand making the update successful. \r\n\r\nIn EFCore8 the ValueConverter is not applied anymore to the expression and the SQL translates to a string which leads to an exception.  \r\n\r\n### Include your code\r\n\r\n```C#\r\nusing Microsoft.EntityFrameworkCore;\r\nusing Microsoft.Extensions.DependencyInjection;\r\nusing Microsoft.Extensions.Logging;\r\n\r\nvar services = new ServiceCollection()\r\n    .AddLogging(l =>\r\n    {\r\n        l.SetMinimumLevel(LogLevel.Trace);\r\n        l.AddConsole();\r\n    })\r\n    .AddDbContext<MyDbContext>(o=>\r\n    {\r\n        o.EnableSensitiveDataLogging();\r\n        o.UseSqlServer(\"Data Source=(local);Integrated Security=SSPI;Database=EFCore8TimeSpanModify;MultipleActiveResultSets=True;Trust Server Certificate=true;\");\r\n    }, ServiceLifetime.Singleton)\r\n    .BuildServiceProvider();\r\n\r\nvar context = services.GetRequiredService<MyDbContext>();\r\nawait context.Database.EnsureCreatedAsync();\r\n\r\nvar entity = new WithTimeSpan { TimeSpan = TimeSpan.FromTicks(100) };\r\nawait context.AddAsync(entity);\r\nawait context.SaveChangesAsync();\r\n\r\nvar interval = TimeSpan.FromTicks(10);\r\nawait context.WithTimeSpans.ExecuteUpdateAsync(x =>\r\n    x.SetProperty(e => e.TimeSpan, e => e.TimeSpan + interval)\r\n);\r\n\r\nclass WithTimeSpan\r\n{\r\n    public int Id { get; set; }\r\n    public TimeSpan TimeSpan { get; set; }\r\n}\r\n\r\nclass MyDbContext : DbContext\r\n{\r\n    public DbSet<WithTimeSpan> WithTimeSpans => Set<WithTimeSpan>();\r\n\r\n    public MyDbContext(DbContextOptions<MyDbContext> o) : base(o)\r\n    {\r\n    }\r\n    \r\n    protected override void OnModelCreating(ModelBuilder modelBuilder)\r\n    {\r\n        modelBuilder.Entity<WithTimeSpan>(e =>\r\n        {\r\n            e.HasKey(x => x.Id);\r\n            e.Property(x => x.Id).ValueGeneratedOnAdd();\r\n            e.Property(x => x.TimeSpan)\r\n                .HasColumnType(\"bigint\")\r\n                .HasConversion(v => v.Ticks,\r\n                    v => TimeSpan.FromTicks(v));\r\n        });\r\n    }\r\n}\r\n```\r\n\r\n### Include stack traces\r\n\r\n```\r\nMicrosoft.Data.SqlClient.SqlException (0x80131904): Operand type clash: time is incompatible with bigint\r\n   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)\r\n   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)\r\n   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)\r\n   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)\r\n   at Microsoft.Data.SqlClient.SqlCommand.FinishExecuteReader(SqlDataReader ds, RunBehavior runBehavior, String resetOptionsString, Boolean isInternal, Boolean forDescribeParameterEncryption, Boolean shouldCacheForAlwaysEncrypted)\r\n   at Microsoft.Data.SqlClient.SqlCommand.CompleteAsyncExecuteReader(Boolean isInternal, Boolean forDescribeParameterEncryption)\r\n   at Microsoft.Data.SqlClient.SqlCommand.InternalEndExecuteNonQuery(IAsyncResult asyncResult, Boolean isInternal, String endMethod)\r\n   at Microsoft.Data.SqlClient.SqlCommand.EndExecuteNonQueryInternal(IAsyncResult asyncResult)\r\n   at Microsoft.Data.SqlClient.SqlCommand.EndExecuteNonQueryAsync(IAsyncResult asyncResult)\r\n   at Microsoft.Data.SqlClient.SqlCommand.<>c.<InternalExecuteNonQueryAsync>b__210_1(IAsyncResult result)\r\n   at System.Threading.Tasks.TaskFactory`1.FromAsyncCoreLogic(IAsyncResult iar, Func`2 endFunction, Action`1 endAction, Task`1 promise, Boolean requiresSynchronization)\r\n--- End of stack trace from previous location ---\r\n   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteNonQueryAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)\r\n   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteNonQueryAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)\r\n   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteNonQueryAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)\r\n   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)\r\n   at Program.<Main>$(String[] args) in D:\\Dev\\Git\\EFCore8TimeSpanModify\\EFCore8TimeSpanModify\\EFCore8TimeSpanModify\\Program.cs:line 26\r\n   at Program.<Main>(String[] args)\r\n\r\n```\r\n\r\n### Include provider and version information\r\n\r\nEF Core version: 8.0.3\r\nDatabase provider: Microsoft.EntityFrameworkCore.SqlServer\r\nTarget framework: .NET 8.0\r\nOperating system: Windows 11\r\nIDE: Rider 2023.3.4\r\n\r\n### Entry point of difference\r\n\r\nIn v7 a special trick was used to translate a setter expression and unwrap it. The translated SQL expression has the ValueConverter set: \r\n\r\nhttps://github.com/dotnet/efcore/blob/c9d1c2d28f509244ffe9ad61a46d1d81f89ddd2f/src/EFCore.Relational/Query/RelationalQueryableMethodTranslatingExpressionVisitor.cs#L1372\r\n![image](https://github.com/dotnet/efcore/assets/674916/f51735f6-f006-4ea4-b0da-c8befb3a3785)\r\n\r\nIn v8 this type mapping is not applied at the respective location leading to an invalid SQL:\r\nhttps://github.com/dotnet/efcore/blob/c2f996919858eb11d2836705d47b531b5a174c79/src/EFCore.Relational/Query/RelationalQueryableMethodTranslatingExpressionVisitor.cs#L1555-L1564\r\n![image](https://github.com/dotnet/efcore/assets/674916/594cafe5-4b1b-41e7-a125-b4ce53a4f7c5)\r\n\r\n\r\n","closed_by":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/33330/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/33330/timeline","performed_via_github_app":null,"state_reason":"completed"}