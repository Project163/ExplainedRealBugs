{"url":"https://api.github.com/repos/dotnet/efcore/issues/32422","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/32422/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/32422/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/32422/events","html_url":"https://github.com/dotnet/efcore/issues/32422","id":2012440848,"node_id":"I_kwDOAPaMMs5382kQ","number":32422,"title":"Inconsistent behavior related to relationship cycle","user":{"login":"dzsibi","id":4534880,"node_id":"MDQ6VXNlcjQ1MzQ4ODA=","avatar_url":"https://avatars.githubusercontent.com/u/4534880?v=4","gravatar_id":"","url":"https://api.github.com/users/dzsibi","html_url":"https://github.com/dzsibi","followers_url":"https://api.github.com/users/dzsibi/followers","following_url":"https://api.github.com/users/dzsibi/following{/other_user}","gists_url":"https://api.github.com/users/dzsibi/gists{/gist_id}","starred_url":"https://api.github.com/users/dzsibi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dzsibi/subscriptions","organizations_url":"https://api.github.com/users/dzsibi/orgs","repos_url":"https://api.github.com/users/dzsibi/repos","events_url":"https://api.github.com/users/dzsibi/events{/privacy}","received_events_url":"https://api.github.com/users/dzsibi/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":514908713,"node_id":"MDU6TGFiZWw1MTQ5MDg3MTM=","url":"https://api.github.com/repos/dotnet/efcore/labels/regression","name":"regression","color":"ff1fff","default":false,"description":null},{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1017558838,"node_id":"MDU6TGFiZWwxMDE3NTU4ODM4","url":"https://api.github.com/repos/dotnet/efcore/labels/Servicing-approved","name":"Servicing-approved","color":"048708","default":false,"description":""},{"id":1900941630,"node_id":"MDU6TGFiZWwxOTAwOTQxNjMw","url":"https://api.github.com/repos/dotnet/efcore/labels/area-model-building","name":"area-model-building","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/186","html_url":"https://github.com/dotnet/efcore/milestone/186","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/186/labels","id":10201144,"node_id":"MI_kwDOAPaMMs4Am6g4","number":186,"title":"8.0.2","description":null,"creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":44,"state":"closed","created_at":"2023-11-17T09:03:59Z","updated_at":"2024-05-05T12:55:36Z","due_on":null,"closed_at":"2024-04-09T08:40:11Z"},"comments":11,"created_at":"2023-11-27T14:46:49Z","updated_at":"2025-06-15T19:54:56Z","closed_at":"2024-01-04T20:05:13Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hello,\r\n\r\nTake the following `DbContext`:\r\n\r\n```C#\r\nusing Microsoft.EntityFrameworkCore;\r\n\r\nnamespace CircularKeys;\r\n\r\npublic class CircularContext : DbContext\r\n{\r\n    public record ChildEntity(string ParentId, string Id);\r\n\r\n    public record ParentEntity(string Id, string? FavoriteChildId);\r\n\r\n    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)\r\n    {\r\n        optionsBuilder.UseNpgsql(\"Host=localhost;Database=postgres;Username=postgres;Password=postgres\");\r\n    }\r\n\r\n    protected override void OnModelCreating(ModelBuilder modelBuilder)\r\n    {\r\n        var parent = modelBuilder.Entity<ParentEntity>();\r\n        parent.HasKey(e => e.Id);\r\n        parent.HasOne<ChildEntity>()\r\n            .WithOne()\r\n            .HasForeignKey<ParentEntity>(x => new { x.Id, x.FavoriteChildId });\r\n\r\n        var child = modelBuilder.Entity<ChildEntity>();\r\n        child.HasKey(e => new { e.ParentId, e.Id });\r\n        child.HasOne<ParentEntity>()\r\n            .WithMany()\r\n            .HasForeignKey(e => e.ParentId);\r\n    }\r\n}\r\n\r\n```\r\n\r\nWhen I want to add a migration using `dotnet ef migrations add Init --verbose`, it works fine. Let's add another entity:\r\n\r\n```C#\r\nusing Microsoft.EntityFrameworkCore;\r\n\r\nnamespace CircularKeys;\r\n\r\npublic class CircularContext : DbContext\r\n{\r\n    public record ChildEntity(string ParentId, string Id);\r\n\r\n    public record ParentEntity(string Id, string? FavoriteChildId);\r\n    \r\n    public record AnotherEntity(string ParentId, string Id);\r\n\r\n    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)\r\n    {\r\n        optionsBuilder.UseNpgsql(\"Host=localhost;Database=postgres;Username=postgres;Password=postgres\");\r\n    }\r\n\r\n    protected override void OnModelCreating(ModelBuilder modelBuilder)\r\n    {\r\n        var parent = modelBuilder.Entity<ParentEntity>();\r\n        parent.HasKey(e => e.Id);\r\n        parent.HasOne<ChildEntity>()\r\n            .WithOne()\r\n            .HasForeignKey<ParentEntity>(x => new { x.Id, x.FavoriteChildId });\r\n\r\n        var child = modelBuilder.Entity<ChildEntity>();\r\n        child.HasKey(e => new { e.ParentId, e.Id });\r\n        child.HasOne<ParentEntity>()\r\n            .WithMany()\r\n            .HasForeignKey(e => e.ParentId);\r\n        \r\n        var another = modelBuilder.Entity<AnotherEntity>();\r\n        another.HasKey(e => new { e.ParentId, e.Id });\r\n        another.HasOne<ParentEntity>()\r\n            .WithMany()\r\n            .HasForeignKey(e => e.ParentId);\r\n    }\r\n}\r\n\r\n```\r\n\r\nA new migration can no longer be added, with the following error message:\r\n\r\n```\r\nMicrosoft.EntityFrameworkCore.Design.OperationException: Unable to create a 'DbContext' of type ''. The exception 'A relationship cycle involving the property 'AnotherEntity.ParentId' was detected. This prevents Entity Framework from determining the correct configuration. Review the foreign keys defined on the property and the corresponding principal property and either remove one of them or specify 'ValueConverter' explicitly on one of the properties.' was thrown while attempting to create an instance. For the different patterns supported at design time, see https://go.microsoft.com/fwlink/?linkid=851728\r\n ---> System.InvalidOperationException: A relationship cycle involving the property 'AnotherEntity.ParentId' was detected. This prevents Entity Framework from determining the correct configuration. Review the foreign keys defined on the property and the corresponding principal property and either remove one of them or specify 'ValueConverter' explicitly on one of the properties.\r\n   at Microsoft.EntityFrameworkCore.Metadata.Internal.Property.GetValueConverter()\r\n   at Microsoft.EntityFrameworkCore.Storage.TypeMappingInfo..ctor(IReadOnlyList`1 principals, Nullable`1 fallbackUnicode, Nullable`1 fallbackSize, Nullable`1 fallbackPrecision, Nullable`1 fallbackScale)\r\n   at Microsoft.EntityFrameworkCore.Storage.RelationalTypeMappingInfo..ctor(IReadOnlyList`1 principals, String storeTypeName, String storeTypeNameBase, Nullable`1 fallbackUnicode, Nullable`1 fallbackFixedLength, Nullable`1 fallbackSize, Nullable`1 fallbackPrecision, Nullable`1 fallbackScale)\r\n   at Microsoft.EntityFrameworkCore.Storage.RelationalTypeMappingSource.FindMapping(IProperty property)\r\n   at Microsoft.EntityFrameworkCore.Metadata.Conventions.ElementMappingConvention.<ProcessModelFinalizing>g__Validate|4_0(IConventionTypeBase typeBase)\r\n   at Microsoft.EntityFrameworkCore.Metadata.Conventions.ElementMappingConvention.ProcessModelFinalizing(IConventionModelBuilder modelBuilder, IConventionContext`1 context)\r\n   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.ImmediateConventionScope.OnModelFinalizing(IConventionModelBuilder modelBuilder)\r\n   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.OnModelFinalizing(IConventionModelBuilder modelBuilder)\r\n   at Microsoft.EntityFrameworkCore.Metadata.Internal.Model.FinalizeModel()\r\n   at Microsoft.EntityFrameworkCore.Infrastructure.ModelRuntimeInitializer.Initialize(IModel model, Boolean designTime, IDiagnosticsLogger`1 validationLogger)\r\n   at Microsoft.EntityFrameworkCore.Infrastructure.ModelSource.GetModel(DbContext context, ModelCreationDependencies modelCreationDependencies, Boolean designTime)\r\n   at Microsoft.EntityFrameworkCore.Internal.DbContextServices.CreateModel(Boolean designTime)\r\n   at Microsoft.EntityFrameworkCore.Internal.DbContextServices.get_Model()\r\n   at Microsoft.EntityFrameworkCore.Infrastructure.EntityFrameworkServicesBuilder.<>c.<TryAddCoreServices>b__8_4(IServiceProvider p)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitFactory(FactoryCallSite factoryCallSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.Resolve(ServiceCallSite callSite, ServiceProviderEngineScope scope)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.DynamicServiceProviderEngine.<>c__DisplayClass2_0.<RealizeService>b__0(ServiceProviderEngineScope scope)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceProvider.GetService(ServiceIdentifier serviceIdentifier, ServiceProviderEngineScope serviceProviderEngineScope)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceLookup.ServiceProviderEngineScope.GetService(Type serviceType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService(IServiceProvider provider, Type serviceType)\r\n   at Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService[T](IServiceProvider provider)\r\n   at Microsoft.EntityFrameworkCore.DbContext.get_DbContextDependencies()\r\n   at Microsoft.EntityFrameworkCore.DbContext.get_ContextServices()\r\n   at Microsoft.EntityFrameworkCore.DbContext.get_InternalServiceProvider()\r\n   at Microsoft.EntityFrameworkCore.DbContext.Microsoft.EntityFrameworkCore.Infrastructure.IInfrastructure<System.IServiceProvider>.get_Instance()\r\n   at Microsoft.EntityFrameworkCore.Infrastructure.Internal.InfrastructureExtensions.GetService(IInfrastructure`1 accessor, Type serviceType)\r\n   at Microsoft.EntityFrameworkCore.Infrastructure.Internal.InfrastructureExtensions.GetService[TService](IInfrastructure`1 accessor)\r\n   at Microsoft.EntityFrameworkCore.Infrastructure.AccessorExtensions.GetService[TService](IInfrastructure`1 accessor)\r\n   at Microsoft.EntityFrameworkCore.Design.Internal.DbContextOperations.CreateContext(String contextType)\r\n   --- End of inner exception stack trace ---\r\n   at Microsoft.EntityFrameworkCore.Design.Internal.DbContextOperations.CreateContext(String contextType)\r\n   at Microsoft.EntityFrameworkCore.Design.Internal.MigrationsOperations.AddMigration(String name, String outputDir, String contextType, String namespace)\r\n   at Microsoft.EntityFrameworkCore.Design.OperationExecutor.AddMigrationImpl(String name, String outputDir, String contextType, String namespace)\r\n   at Microsoft.EntityFrameworkCore.Design.OperationExecutor.AddMigration.<>c__DisplayClass0_0.<.ctor>b__0()\r\n   at Microsoft.EntityFrameworkCore.Design.OperationExecutor.OperationBase.<>c__DisplayClass3_0`1.<Execute>b__0()\r\n   at Microsoft.EntityFrameworkCore.Design.OperationExecutor.OperationBase.Execute(Action action)\r\nUnable to create a 'DbContext' of type ''. The exception 'A relationship cycle involving the property 'AnotherEntity.ParentId' was detected. This prevents Entity Framework from determining the correct configuration. Review the foreign keys defined on the property and the corresponding principal property and either remove one of them or specify 'ValueConverter' explicitly on one of the properties.' was thrown while attempting to create an instance. For the different patterns supported at design time, see https://go.microsoft.com/fwlink/?linkid=851728\r\n\r\n```\r\n\r\nThe new entity did not introduce any new relationship cycles, yet EF was able to handle the previous one just fine. So I started digging. The exception is thrown here:\r\n\r\nhttps://github.com/dotnet/efcore/blob/45673126512a0fe99ef73bf5c1e5701012fd9c26/src/EFCore/Metadata/Internal/Property.cs#L812C22-L812C22\r\n\r\nThere is this condition:\r\n\r\n```C#\r\nif (principalProperty == this || principalProperty == property)\r\n```\r\n\r\nIn the first case, on the second cycle, this condition is triggered with `principalProperty == this`, and the function returns. In the second case, with the additional entity, this does not happen, and an exception is thrown. I am not sure why this behaves like this. If the goal was to detect cycles and throw, it fails to throw on the trivial cycle in the first example. If the goal was to break cycles, it throws anyways if there is a \"leaf\", as in a related entity that is not included in the cycle.\r\n\r\nSo let's try following the recommendation in the exception, and add value converters to the properties involved:\r\n\r\n```C#\r\nusing Microsoft.EntityFrameworkCore;\r\n\r\nnamespace CircularKeys;\r\n\r\npublic class CircularContext : DbContext\r\n{\r\n    public record ChildEntity(string ParentId, string Id);\r\n\r\n    public record ParentEntity(string Id, string? FavoriteChildId);\r\n    \r\n    public record AnotherEntity(string ParentId, string Id);\r\n    \r\n\r\n    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)\r\n    {\r\n        optionsBuilder.UseNpgsql(\"Host=localhost;Database=postgres;Username=postgres;Password=postgres\");\r\n    }\r\n\r\n    protected override void OnModelCreating(ModelBuilder modelBuilder)\r\n    {\r\n        var parent = modelBuilder.Entity<ParentEntity>();\r\n        parent.HasKey(e => e.Id);\r\n        parent.HasOne<ChildEntity>()\r\n            .WithOne()\r\n            .HasForeignKey<ParentEntity>(x => new { x.Id, x.FavoriteChildId });\r\n        parent.Property(e => e.Id).HasConversion(e => e, e => e);\r\n        parent.Property(e => e.FavoriteChildId).HasConversion(e => e, e => e);\r\n\r\n        var child = modelBuilder.Entity<ChildEntity>();\r\n        child.HasKey(e => new { e.ParentId, e.Id });\r\n        child.HasOne<ParentEntity>()\r\n            .WithMany()\r\n            .HasForeignKey(e => e.ParentId);\r\n        child.Property(e => e.Id).HasConversion(e => e, e => e);\r\n        child.Property(e => e.ParentId).HasConversion(e => e, e => e);\r\n        \r\n        var another = modelBuilder.Entity<AnotherEntity>();\r\n        another.HasKey(e => new { e.ParentId, e.Id });\r\n        another.HasOne<ParentEntity>()\r\n            .WithMany()\r\n            .HasForeignKey(e => e.ParentId);\r\n    }\r\n}\r\n```\r\n\r\nThis works, and the migration is generated as expected. We are not out of the woods yet, however, as `dotnet ef database update --verbose` will fail with the following error:\r\n\r\n```\r\nSystem.InvalidOperationException: A relationship cycle involving the property 'CircularKeys.CircularContext+AnotherEntity (Dictionary<string, object>).ParentId' was detected. This prevents Entity Framework from determining the correct configuration. Review the foreign keys defined on the property and the corresponding principal property and either remove one of them or specify 'ValueConverter' explicitly on one of the properties.\r\n   at Microsoft.EntityFrameworkCore.Metadata.Internal.Property.GetValueConverter()\r\n   at Microsoft.EntityFrameworkCore.Storage.TypeMappingInfo..ctor(IReadOnlyList`1 principals, Nullable`1 fallbackUnicode, Nullable`1 fallbackSize, Nullable`1 fallbackPrecision, Nullable`1 fallbackScale)\r\n   at Microsoft.EntityFrameworkCore.Storage.RelationalTypeMappingInfo..ctor(IReadOnlyList`1 principals, String storeTypeName, String storeTypeNameBase, Nullable`1 fallbackUnicode, Nullable`1 fallbackFixedLength, Nullable`1 fallbackSize, Nullable`1 fallbackPrecision, Nullable`1 fallbackScale)\r\n   at Microsoft.EntityFrameworkCore.Storage.RelationalTypeMappingSource.FindMapping(IProperty property)\r\n   at Microsoft.EntityFrameworkCore.Metadata.Internal.Property.<>c.<get_TypeMapping>b__91_0(IProperty property)\r\n   at Microsoft.EntityFrameworkCore.Internal.NonCapturingLazyInitializer.EnsureInitialized[TParam,TValue](TValue& target, TParam param, Func`2 valueFactory)\r\n   at Microsoft.EntityFrameworkCore.Metadata.Internal.Property.get_TypeMapping()\r\n   at Microsoft.EntityFrameworkCore.Metadata.Internal.Property.Microsoft.EntityFrameworkCore.Metadata.IReadOnlyProperty.FindTypeMapping()\r\n   at Microsoft.EntityFrameworkCore.RelationalPropertyExtensions.FindRelationalTypeMapping(IReadOnlyProperty property)\r\n   at Microsoft.EntityFrameworkCore.RelationalPropertyExtensions.GetColumnType(IReadOnlyProperty property)\r\n   at Microsoft.EntityFrameworkCore.RelationalPropertyExtensions.GetColumnType(IProperty property)\r\n   at Microsoft.EntityFrameworkCore.Metadata.Internal.RelationalModel.AddDefaultMappings(RelationalModel databaseModel, IEntityType entityType, IRelationalTypeMappingSource relationalTypeMappingSource)\r\n   at Microsoft.EntityFrameworkCore.Metadata.Internal.RelationalModel.Create(IModel model, IRelationalAnnotationProvider relationalAnnotationProvider, IRelationalTypeMappingSource relationalTypeMappingSource, Boolean designTime)\r\n   at Microsoft.EntityFrameworkCore.Metadata.Internal.RelationalModel.Add(IModel model, IRelationalAnnotationProvider relationalAnnotationProvider, IRelationalTypeMappingSource relationalTypeMappingSource, Boolean designTime)\r\n   at Microsoft.EntityFrameworkCore.Infrastructure.RelationalModelRuntimeInitializer.InitializeModel(IModel model, Boolean designTime, Boolean prevalidation)\r\n   at Microsoft.EntityFrameworkCore.Infrastructure.ModelRuntimeInitializer.Initialize(IModel model, Boolean designTime, IDiagnosticsLogger`1 validationLogger)\r\n   at Microsoft.EntityFrameworkCore.Migrations.Internal.Migrator.FinalizeModel(IModel model)\r\n   at Microsoft.EntityFrameworkCore.Migrations.Internal.Migrator.GenerateUpSql(Migration migration, MigrationsSqlGenerationOptions options)\r\n   at Microsoft.EntityFrameworkCore.Migrations.Internal.Migrator.<>c__DisplayClass16_2.<GetMigrationCommandLists>b__2()\r\n   at Microsoft.EntityFrameworkCore.Migrations.Internal.Migrator.Migrate(String targetMigration)\r\n   at Npgsql.EntityFrameworkCore.PostgreSQL.Migrations.Internal.NpgsqlMigrator.Migrate(String targetMigration)\r\n   at Microsoft.EntityFrameworkCore.Design.Internal.MigrationsOperations.UpdateDatabase(String targetMigration, String connectionString, String contextType)\r\n   at Microsoft.EntityFrameworkCore.Design.OperationExecutor.UpdateDatabaseImpl(String targetMigration, String connectionString, String contextType)\r\n   at Microsoft.EntityFrameworkCore.Design.OperationExecutor.UpdateDatabase.<>c__DisplayClass0_0.<.ctor>b__0()\r\n   at Microsoft.EntityFrameworkCore.Design.OperationExecutor.OperationBase.Execute(Action action)\r\nA relationship cycle involving the property 'CircularKeys.CircularContext+AnotherEntity (Dictionary<string, object>).ParentId' was detected. This prevents Entity Framework from determining the correct configuration. Review the foreign keys defined on the property and the corresponding principal property and either remove one of them or specify 'ValueConverter' explicitly on one of the properties.\r\n```\r\n\r\nLooks familiar, but the stack is very different. It turns out that the generated migration conveniently forgot about the value converters:\r\n\r\n```C#\r\nmodelBuilder.Entity(\"CircularKeys.CircularContext+ParentEntity\", b =>\r\n    {\r\n        b.Property<string>(\"Id\")\r\n            .HasColumnType(\"text\");\r\n\r\n        b.Property<string>(\"FavoriteChildId\")\r\n            .HasColumnType(\"text\");\r\n\r\n        b.HasKey(\"Id\");\r\n\r\n        b.HasIndex(\"Id\", \"FavoriteChildId\")\r\n            .IsUnique();\r\n\r\n        b.ToTable(\"ParentEntity\");\r\n    });\r\n```\r\n\r\nAnd when this is loaded, the annotation is once again missing. We could work around this by overriding the implementation of AnnotationCodeGenerator:\r\n\r\n```C#\r\nusing Microsoft.EntityFrameworkCore.Design;\r\nusing Microsoft.EntityFrameworkCore.Infrastructure;\r\nusing Microsoft.EntityFrameworkCore.Metadata;\r\nusing Microsoft.EntityFrameworkCore.Metadata.Builders;\r\nusing Microsoft.EntityFrameworkCore.Metadata.Internal;\r\nusing Microsoft.Extensions.DependencyInjection;\r\nusing Npgsql.EntityFrameworkCore.PostgreSQL.Design.Internal;\r\n\r\nnamespace CircularKeys;\r\n\r\npublic class DesignTimeServices : IDesignTimeServices\r\n{\r\n    public void ConfigureDesignTimeServices(IServiceCollection serviceCollection)\r\n    {\r\n        serviceCollection.AddSingleton<IAnnotationCodeGenerator, CircularAnnotationCodeGenerator>();\r\n    }\r\n}\r\n\r\npublic class CircularAnnotationCodeGenerator : NpgsqlAnnotationCodeGenerator\r\n{\r\n    public CircularAnnotationCodeGenerator(AnnotationCodeGeneratorDependencies dependencies) : base(dependencies) { }\r\n\r\n    public override IReadOnlyList<MethodCallCodeFragment> GenerateFluentApiCalls(IProperty property, IDictionary<string, IAnnotation> annotations)\r\n    {\r\n        var ret = base.GenerateFluentApiCalls(property, annotations);\r\n\r\n        if ((property.DeclaringType.ClrType == typeof(CircularContext.ParentEntity) &&\r\n             property.PropertyInfo?.Name is nameof(CircularContext.ParentEntity.Id) or nameof(CircularContext.ParentEntity.FavoriteChildId)))\r\n        {\r\n            var valueConverterFragment = new MethodCallCodeFragment(\r\n                nameof(PropertyBuilder.HasAnnotation), CoreAnnotationNames.ValueConverter, null);\r\n            var providerClrTypeFragment = new MethodCallCodeFragment(\r\n                nameof(PropertyBuilder.HasAnnotation), CoreAnnotationNames.ProviderClrType, null);\r\n            return ret.Concat(new[] { valueConverterFragment, providerClrTypeFragment }).ToList();\r\n        }\r\n\r\n        return ret;\r\n    }\r\n}\r\n```\r\n\r\nThis will include a null-valued annotation in the generated code for ValueConverter and ProviderClrType, and the migration will run:\r\n\r\n```C#\r\nmodelBuilder.Entity(\"CircularKeys.CircularContext+ParentEntity\", b =>\r\n    {\r\n        b.Property<string>(\"Id\")\r\n            .HasColumnType(\"text\")\r\n            .HasAnnotation(\"ValueConverter\", null)\r\n            .HasAnnotation(\"ProviderClrType\", null);\r\n\r\n        b.Property<string>(\"FavoriteChildId\")\r\n            .HasColumnType(\"text\")\r\n            .HasAnnotation(\"ValueConverter\", null)\r\n            .HasAnnotation(\"ProviderClrType\", null);\r\n\r\n        b.HasKey(\"Id\");\r\n\r\n        b.HasIndex(\"Id\", \"FavoriteChildId\")\r\n            .IsUnique();\r\n\r\n        b.ToTable(\"ParentEntity\");\r\n    });\r\n```\r\n\r\nOnce again, I don't know whether this is intentional or not. The recommended workaround does not survive code generation, and overriding methods in AnnotationCodeGenerator seems hacky at best. To me, this whole thing smells like a bug somewhere, but I am not familiar enough with the codebase to pinpoint exactly where.\r\n\r\n### Provider and version information\r\n\r\nEF Core version: 8.0\r\nDatabase provider: Npgsql.EntityFrameworkCore.PostgreSQL\r\nTarget framework: .NET 8.0\r\nOperating system: Ubuntu 22.04\r\nIDE: JetBrains Rider 2023.2.3\r\n","closed_by":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/32422/reactions","total_count":11,"+1":9,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":1,"rocket":1,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/32422/timeline","performed_via_github_app":null,"state_reason":"completed"}