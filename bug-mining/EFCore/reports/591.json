{"url":"https://api.github.com/repos/dotnet/efcore/issues/35132","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/35132/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/35132/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/35132/events","html_url":"https://github.com/dotnet/efcore/issues/35132","id":2668181069,"node_id":"I_kwDOAPaMMs6fCTZN","number":35132,"title":"Error in Generated Migration Script for dotnet-ef 8.0.11","user":{"login":"costinbanu","id":53793170,"node_id":"MDQ6VXNlcjUzNzkzMTcw","avatar_url":"https://avatars.githubusercontent.com/u/53793170?v=4","gravatar_id":"","url":"https://api.github.com/users/costinbanu","html_url":"https://github.com/costinbanu","followers_url":"https://api.github.com/users/costinbanu/followers","following_url":"https://api.github.com/users/costinbanu/following{/other_user}","gists_url":"https://api.github.com/users/costinbanu/gists{/gist_id}","starred_url":"https://api.github.com/users/costinbanu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/costinbanu/subscriptions","organizations_url":"https://api.github.com/users/costinbanu/orgs","repos_url":"https://api.github.com/users/costinbanu/repos","events_url":"https://api.github.com/users/costinbanu/events{/privacy}","received_events_url":"https://api.github.com/users/costinbanu/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":514908713,"node_id":"MDU6TGFiZWw1MTQ5MDg3MTM=","url":"https://api.github.com/repos/dotnet/efcore/labels/regression","name":"regression","color":"ff1fff","default":false,"description":null},{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1900942474,"node_id":"MDU6TGFiZWwxOTAwOTQyNDc0","url":"https://api.github.com/repos/dotnet/efcore/labels/area-migrations","name":"area-migrations","color":"32b37b","default":false,"description":""},{"id":8130499638,"node_id":"LA_kwDOAPaMMs8AAAAB5J2UNg","url":"https://api.github.com/repos/dotnet/efcore/labels/preview-1","name":"preview-1","color":"ACB3D7","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/208","html_url":"https://github.com/dotnet/efcore/milestone/208","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/208/labels","id":11959183,"node_id":"MI_kwDOAPaMMs4AtnuP","number":208,"title":"9.0.1","description":"","creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":21,"state":"closed","created_at":"2024-11-27T13:18:00Z","updated_at":"2025-02-05T21:51:51Z","due_on":null,"closed_at":"2025-02-05T21:49:40Z"},"comments":8,"created_at":"2024-11-18T11:16:45Z","updated_at":"2025-06-15T20:12:01Z","closed_at":"2024-12-02T17:50:18Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"We have a dotnet project that we upgraded from dotnet 7 to dotnet 8. We also updated dotnet-ef from 7.0.2.0 to 8.0.11 in the pipeline that we use. This change has introduced a bug when generating migration scripts\n\n### Generated SQL script with version 8.0.11\n```sql\nIF NOT EXISTS (\n    SELECT * FROM [__EFMigrationsHistory]\n    WHERE [MigrationId] = N'myMigrationName'\n)\nBEGIN\n    EXEC sp_rename N'[dbo].[oldTableName]', N'newTableName', 'OBJECT';\n    DECLARE @defaultSchema sysname = SCHEMA_NAME();\n    EXEC(N'ALTER SCHEMA [' + @defaultSchema + N'] TRANSFER [dbo].[newTableName];');\nEND;\n\nIF NOT EXISTS (\n    SELECT * FROM [__EFMigrationsHistory]\n    WHERE [MigrationId] = N'migrationName2'\n)\nBEGIN\n    EXEC sp_rename N'[dbo].[oldTableName2]', N'newTableName2', 'OBJECT';\n    DECLARE @defaultSchema sysname = SCHEMA_NAME();\n    EXEC(N'ALTER SCHEMA [' + @defaultSchema + N'] TRANSFER [dbo].[newTableName2];');\nEND;\n```\n\nThis fails because the variable `@defaultSchema` is declared twice in the same SQL batch. Let's have a look at the old version SQL output:\n\n### Generated SQL script with version 7.0.20\n```sql\nIF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'migrationName2')\nBEGIN\n    EXEC sp_rename N'[dbo].[oldTableName2]', N'newTableName2';\n    DECLARE @defaultSchema sysname = SCHEMA_NAME();\n    EXEC(N'ALTER SCHEMA [' + @defaultSchema + N'] TRANSFER [dbo].[newTableName2];');\nEND;\nGO\n\nIF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'migrationName')\nBEGIN\n    EXEC sp_rename N'[dbo].[oldTableName]', N'newTableName';\n    DECLARE @defaultSchema sysname = SCHEMA_NAME();\n    EXEC(N'ALTER SCHEMA [' + @defaultSchema + N'] TRANSFER [dbo].[newTableName];');\nEND;\nGO\n```\n\nHere you can see that besides the order of the migrations and some formatting, the new version is lacking the sql batch separator `GO` which is, essentially, the source of the problem\n\n\n### Steps to reproduce\n- define two EF migrations that both rename a table\n- generate migration SQL script with dotnet.ef 8.0.11\n- execute SQL script\n\n### Expected behavior\nThe script is executed successfully\n\n### Actual behavior\nThe deployment fails / Azure DevOps pipeline step `SqlAzureDacpacDeployment` fails with message `##[error]The variable name '@defaultSchema' has already been declared. Variable names must be unique within a query batch or stored procedure.Check out how to troubleshoot failures at https://aka.ms/sqlazuredeployreadme#troubleshooting-\n`\n\n### Provider and version information\n\nEF Core version: 8.0.11\nDatabase provider: Microsoft.EntityFrameworkCore.SqlServer\nTarget framework: .NET 8.0\nOperating system: private Azure DevOps pipeline agent running on Windows 10 x64\nIDE: ","closed_by":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/35132/reactions","total_count":2,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":2,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/35132/timeline","performed_via_github_app":null,"state_reason":"completed"}