{"url":"https://api.github.com/repos/dotnet/efcore/issues/32939","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/32939/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/32939/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/32939/events","html_url":"https://github.com/dotnet/efcore/issues/32939","id":2103631202,"node_id":"I_kwDOAPaMMs59Yt1i","number":32939,"title":"Accidentally using field instead of property for JSON metadata produce hard to understand exception","user":{"login":"joakimriedel","id":429478,"node_id":"MDQ6VXNlcjQyOTQ3OA==","avatar_url":"https://avatars.githubusercontent.com/u/429478?v=4","gravatar_id":"","url":"https://api.github.com/users/joakimriedel","html_url":"https://github.com/joakimriedel","followers_url":"https://api.github.com/users/joakimriedel/followers","following_url":"https://api.github.com/users/joakimriedel/following{/other_user}","gists_url":"https://api.github.com/users/joakimriedel/gists{/gist_id}","starred_url":"https://api.github.com/users/joakimriedel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/joakimriedel/subscriptions","organizations_url":"https://api.github.com/users/joakimriedel/orgs","repos_url":"https://api.github.com/users/joakimriedel/repos","events_url":"https://api.github.com/users/joakimriedel/events{/privacy}","received_events_url":"https://api.github.com/users/joakimriedel/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1675384372,"node_id":"MDU6TGFiZWwxNjc1Mzg0Mzcy","url":"https://api.github.com/repos/dotnet/efcore/labels/area-query","name":"area-query","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/180","html_url":"https://github.com/dotnet/efcore/milestone/180","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/180/labels","id":9963267,"node_id":"MI_kwDOAPaMMs4AmAcD","number":180,"title":"9.0.0","description":null,"creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":339,"state":"closed","created_at":"2023-09-25T15:41:58Z","updated_at":"2025-04-01T18:19:15Z","due_on":null,"closed_at":"2024-11-14T11:54:05Z"},"comments":0,"created_at":"2024-01-27T15:17:08Z","updated_at":"2025-06-15T19:57:49Z","closed_at":"2024-02-02T22:49:51Z","author_association":"CONTRIBUTOR","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## File a bug\r\n\r\nI (ok Github Copilot ☺️) accidentially snuck in a field into a JSON metadata for a JSON column, instead of a proper property (get/set). This was during quite a large refactoring, so it took me quite some time before I spotted the error since the resulting exception did not point me in the right direction. \r\n\r\nCould the DX be improved here please? Ideally there should be some error already when generating the migrations, but a more precise error thrown would help as well such as \"_The Baz field of Metadata should have been declared as a property with get/set_\".\r\n\r\n### Include your code\r\n\r\n```C#\r\nusing Microsoft.EntityFrameworkCore;\r\nusing Microsoft.Extensions.Logging;\r\n\r\nawait using var context = new TestContext();\r\n\r\ncontext.Database.EnsureDeleted();\r\ncontext.Database.EnsureCreated();\r\n\r\n// Index was out of range. Must be non-negative and less than the size of the collection.\r\nvar models = await context.BaseModels.ToListAsync();\r\n\r\npublic sealed class TestContext : DbContext\r\n{\r\n    public DbSet<TestModel> BaseModels => Set<TestModel>();\r\n\r\n    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)\r\n        => optionsBuilder\r\n            .UseSqlServer(@\"Server=(localdb)\\mssqllocaldb;Database=EFCoreJSONColumns;Integrated Security=True;TrustServerCertificate=true\")\r\n            .LogTo(Console.WriteLine, LogLevel.Information)\r\n            .EnableSensitiveDataLogging();\r\n    \r\n    protected override void OnModelCreating(ModelBuilder modelBuilder)\r\n    {\r\n        modelBuilder.Entity<TestModel>().OwnsOne(x => x.Json, b => b.ToJson());\r\n    }\r\n}\r\n\r\npublic class TestModel\r\n{\r\n    public int Id { get; set; }\r\n\r\n    public class Metadata\r\n    {\r\n        // this works\r\n        //public required TestEnum Baz { get; set; }\r\n\r\n        // this doesn't\r\n        public required TestEnum Baz;\r\n    };\r\n\r\n    public Metadata? Json { get; set; }\r\n}\r\n\r\npublic enum TestEnum\r\n{\r\n    Foo = 1,\r\n    Bar = 2\r\n}\r\n\r\n```\r\n\r\n### Include stack traces\r\n\r\nInclude the full exception message and stack trace for any exception you encounter.\r\n\r\nUse triple-tick fences for stack traces. For example:\r\n\r\n```\r\n   at System.ThrowHelper.ThrowArgumentOutOfRange_IndexMustBeLessException()\r\n   at System.Collections.Generic.List`1.get_Item(Int32 index)\r\n   at Microsoft.EntityFrameworkCore.Query.RelationalShapedQueryCompilingExpressionVisitor.ShaperProcessingExpressionVisitor.JsonEntityMaterializerRewriter.<VisitSwitch>g__GenerateJsonPropertyReadLoop|11_0(ParameterExpression managerVariable, ParameterExpression tokenTypeVariable, List`1 finalBlockVariables, List`1 valueBufferTryReadValueMethodsToProcess)\r\n   at Microsoft.EntityFrameworkCore.Query.RelationalShapedQueryCompilingExpressionVisitor.ShaperProcessingExpressionVisitor.JsonEntityMaterializerRewriter.VisitSwitch(SwitchExpression switchExpression)\r\n   at System.Linq.Expressions.ExpressionVisitor.VisitBinary(BinaryExpression node)\r\n   at System.Dynamic.Utils.ExpressionVisitorUtils.VisitBlockExpressions(ExpressionVisitor visitor, BlockExpression block)\r\n   at System.Linq.Expressions.ExpressionVisitor.VisitBlock(BlockExpression node)\r\n   at System.Linq.Expressions.ExpressionVisitor.VisitConditional(ConditionalExpression node)\r\n   at Microsoft.EntityFrameworkCore.Query.RelationalShapedQueryCompilingExpressionVisitor.ShaperProcessingExpressionVisitor.JsonEntityMaterializerRewriter.VisitConditional(ConditionalExpression conditionalExpression)\r\n   at System.Linq.Expressions.ExpressionVisitor.VisitConditional(ConditionalExpression node)\r\n   at Microsoft.EntityFrameworkCore.Query.RelationalShapedQueryCompilingExpressionVisitor.ShaperProcessingExpressionVisitor.JsonEntityMaterializerRewriter.VisitConditional(ConditionalExpression conditionalExpression)\r\n   at System.Dynamic.Utils.ExpressionVisitorUtils.VisitBlockExpressions(ExpressionVisitor visitor, BlockExpression block)\r\n   at System.Linq.Expressions.ExpressionVisitor.VisitBlock(BlockExpression node)\r\n   at Microsoft.EntityFrameworkCore.Query.RelationalShapedQueryCompilingExpressionVisitor.ShaperProcessingExpressionVisitor.JsonEntityMaterializerRewriter.Rewrite(BlockExpression jsonEntityShaperMaterializer)\r\n   at Microsoft.EntityFrameworkCore.Query.RelationalShapedQueryCompilingExpressionVisitor.ShaperProcessingExpressionVisitor.CreateJsonShapers(IEntityType entityType, Boolean nullable, ParameterExpression jsonReaderDataParameter, ParameterExpression keyValuesParameter, Expression parentEntityExpression, INavigation navigation)\r\n   at Microsoft.EntityFrameworkCore.Query.RelationalShapedQueryCompilingExpressionVisitor.ShaperProcessingExpressionVisitor.VisitExtension(Expression extensionExpression)\r\n   at Microsoft.EntityFrameworkCore.Query.RelationalShapedQueryCompilingExpressionVisitor.ShaperProcessingExpressionVisitor.ProcessShaper(Expression shaperExpression, RelationalCommandCache& relationalCommandCache, IReadOnlyList`1& readerColumns, LambdaExpression& relatedDataLoaders, Int32& collectionId)\r\n   at Microsoft.EntityFrameworkCore.Query.RelationalShapedQueryCompilingExpressionVisitor.VisitShapedQuery(ShapedQueryExpression shapedQueryExpression)\r\n   at Microsoft.EntityFrameworkCore.Query.ShapedQueryCompilingExpressionVisitor.VisitExtension(Expression extensionExpression)\r\n   at Microsoft.EntityFrameworkCore.Query.RelationalShapedQueryCompilingExpressionVisitor.VisitExtension(Expression extensionExpression)\r\n   at Microsoft.EntityFrameworkCore.Query.QueryCompilationContext.CreateQueryExecutor[TResult](Expression query)\r\n   at Microsoft.EntityFrameworkCore.Storage.Database.CompileQuery[TResult](Expression query, Boolean async)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.CompileQueryCore[TResult](IDatabase database, Expression query, IModel model, Boolean async)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.<>c__DisplayClass12_0`1.<ExecuteAsync>b__0()\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.CompiledQueryCache.GetOrAddQuery[TResult](Object cacheKey, Func`1 compiler)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.ExecuteAsync[TResult](Expression query, CancellationToken cancellationToken)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.EntityQueryProvider.ExecuteAsync[TResult](Expression expression, CancellationToken cancellationToken)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.EntityQueryable`1.GetAsyncEnumerator(CancellationToken cancellationToken)\r\n   at Microsoft.EntityFrameworkCore.Internal.InternalDbSet`1.System.Collections.Generic.IAsyncEnumerable<TEntity>.GetAsyncEnumerator(CancellationToken cancellationToken)\r\n   at System.Runtime.CompilerServices.ConfiguredCancelableAsyncEnumerable`1.GetAsyncEnumerator()\r\n   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.<ToListAsync>d__67`1.MoveNext()\r\n   at Program.<<Main>$>d__0.MoveNext() in D:\\repos\\EFCoreJSONColumns\\Program.cs:line 9\r\n   at Program.<<Main>$>d__0.MoveNext() in D:\\repos\\EFCoreJSONColumns\\Program.cs:line 9\r\n```\r\n\r\n\r\n### Include provider and version information\r\n\r\nEF Core version: 8.0.1\r\nTarget framework: .NET 8.0\r\n","closed_by":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/32939/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/32939/timeline","performed_via_github_app":null,"state_reason":"completed"}