{"url":"https://api.github.com/repos/dotnet/efcore/issues/35856","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/35856/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/35856/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/35856/events","html_url":"https://github.com/dotnet/efcore/issues/35856","id":2952736422,"node_id":"I_kwDOAPaMMs6v_y6m","number":35856,"title":"Concurrency error in HandleTransactionCompleted (RelationalConnection)","user":{"login":"FlipEX","id":3669438,"node_id":"MDQ6VXNlcjM2Njk0Mzg=","avatar_url":"https://avatars.githubusercontent.com/u/3669438?v=4","gravatar_id":"","url":"https://api.github.com/users/FlipEX","html_url":"https://github.com/FlipEX","followers_url":"https://api.github.com/users/FlipEX/followers","following_url":"https://api.github.com/users/FlipEX/following{/other_user}","gists_url":"https://api.github.com/users/FlipEX/gists{/gist_id}","starred_url":"https://api.github.com/users/FlipEX/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/FlipEX/subscriptions","organizations_url":"https://api.github.com/users/FlipEX/orgs","repos_url":"https://api.github.com/users/FlipEX/repos","events_url":"https://api.github.com/users/FlipEX/events{/privacy}","received_events_url":"https://api.github.com/users/FlipEX/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1900941009,"node_id":"MDU6TGFiZWwxOTAwOTQxMDA5","url":"https://api.github.com/repos/dotnet/efcore/labels/area-save-changes","name":"area-save-changes","color":"32b37b","default":false,"description":""},{"id":9022438466,"node_id":"LA_kwDOAPaMMs8AAAACGcd8Qg","url":"https://api.github.com/repos/dotnet/efcore/labels/rc-2","name":"rc-2","color":"ACB3D7","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},{"login":"Copilot","id":198982749,"node_id":"BOT_kgDOC9w8XQ","avatar_url":"https://avatars.githubusercontent.com/in/1143301?v=4","gravatar_id":"","url":"https://api.github.com/users/Copilot","html_url":"https://github.com/apps/copilot-swe-agent","followers_url":"https://api.github.com/users/Copilot/followers","following_url":"https://api.github.com/users/Copilot/following{/other_user}","gists_url":"https://api.github.com/users/Copilot/gists{/gist_id}","starred_url":"https://api.github.com/users/Copilot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Copilot/subscriptions","organizations_url":"https://api.github.com/users/Copilot/orgs","repos_url":"https://api.github.com/users/Copilot/repos","events_url":"https://api.github.com/users/Copilot/events{/privacy}","received_events_url":"https://api.github.com/users/Copilot/received_events","type":"Bot","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/204","html_url":"https://github.com/dotnet/efcore/milestone/204","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/204/labels","id":11480673,"node_id":"MI_kwDOAPaMMs4Ary5h","number":204,"title":"10.0.0","description":"","creator":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":1,"closed_issues":193,"state":"open","created_at":"2024-08-23T12:48:26Z","updated_at":"2025-11-05T08:24:30Z","due_on":null,"closed_at":null},"comments":5,"created_at":"2025-03-27T12:07:11Z","updated_at":"2025-09-08T20:08:38Z","closed_at":"2025-08-29T17:56:10Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Bug description\n\nWe are \"randomly\" experiencing the exception \"System.InvalidOperationException: A root ambient transaction was completed before the nested transaction. The nested transactions should be completed first.\". When looking at our code, we don't have any root ambient transaction, being completed before a nested transaction. The problem, however, is when using distributed transactions and having the MSTDC \"fire\" an exception.\nAs it doesn't happen all the time (it's somewhat of a timings issue), I am not able to create a repo that reproduces the problem. However, I think I have tracked down where the error is. The error occurs in Microsoft.EntityFrameworkCore.Storage.RelationalConnection https://github.com/dotnet/efcore/blob/4b0d9dc416c57368b1cf76e9d76de365cc5e6d9f/src/EFCore.Relational/Storage/RelationalConnection.cs\nThe problem occurs when HandleTransactionCompleted is called at a time when ClearTransactions has just exactly popped the givet ambientTransaction from _ambientTransactions (line 697); but not yet called ambientTransaction.TransactionCompleted -= HandleTransactionCompleted (line 697) which makes sure that HandleTransactionCompleted is not called;\nAs stated in HandleTransactionCompleted: _This could be invoked on a different thread at arbitrary time after the transaction completes_ we need to have some kind of concurrency handling in ClearTransactions  and HandleTransactionCompleted. I don't know what the best solution to the problem is.\nLet me know if you have any questions.\n\n@dshuvaev is tagged as I believe he introduced the error in this commit: https://github.com/dotnet/efcore/commit/daa1ed2aab6ddde7a66c602ae41031e5de03c5d2\n\n\n### Your code\n\n```csharp\nAs stated above the error only happens in very specific timing cases, which is why I haven't been able to create code that reproduces the exception on a regular basis.\n```\n\n### Stack traces\n\n```text\n\n```\n\n### Verbose output\n\n```text\n\n```\n\n### EF Core version\n\n8.0.10\n\n### Database provider\n\n_No response_\n\n### Target framework\n\n.NET 8\n\n### Operating system\n\nWindows Server 2022\n\n### IDE\n\n_No response_","closed_by":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/35856/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/35856/timeline","performed_via_github_app":null,"state_reason":"completed"}