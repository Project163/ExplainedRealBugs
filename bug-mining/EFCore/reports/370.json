{"url":"https://api.github.com/repos/dotnet/efcore/issues/32555","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/32555/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/32555/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/32555/events","html_url":"https://github.com/dotnet/efcore/issues/32555","id":2032213466,"node_id":"I_kwDOAPaMMs55IR3a","number":32555,"title":"Migration rollback resulting in weird behavior in Snapshot file","user":{"login":"zengouu","id":8158470,"node_id":"MDQ6VXNlcjgxNTg0NzA=","avatar_url":"https://avatars.githubusercontent.com/u/8158470?v=4","gravatar_id":"","url":"https://api.github.com/users/zengouu","html_url":"https://github.com/zengouu","followers_url":"https://api.github.com/users/zengouu/followers","following_url":"https://api.github.com/users/zengouu/following{/other_user}","gists_url":"https://api.github.com/users/zengouu/gists{/gist_id}","starred_url":"https://api.github.com/users/zengouu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zengouu/subscriptions","organizations_url":"https://api.github.com/users/zengouu/orgs","repos_url":"https://api.github.com/users/zengouu/repos","events_url":"https://api.github.com/users/zengouu/events{/privacy}","received_events_url":"https://api.github.com/users/zengouu/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1900942474,"node_id":"MDU6TGFiZWwxOTAwOTQyNDc0","url":"https://api.github.com/repos/dotnet/efcore/labels/area-migrations","name":"area-migrations","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/180","html_url":"https://github.com/dotnet/efcore/milestone/180","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/180/labels","id":9963267,"node_id":"MI_kwDOAPaMMs4AmAcD","number":180,"title":"9.0.0","description":null,"creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":339,"state":"closed","created_at":"2023-09-25T15:41:58Z","updated_at":"2025-04-01T18:19:15Z","due_on":null,"closed_at":"2024-11-14T11:54:05Z"},"comments":5,"created_at":"2023-12-08T08:38:30Z","updated_at":"2025-06-15T19:55:37Z","closed_at":"2024-01-04T18:19:44Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I'm currently seeing a new behavior in ContextModelSnapshot.cs after rollbacking a migration. Here are the steps and results:\r\n\r\n1. I add a string property to my User.cs entity to simulate entity change\r\n2. I create a new migration (dotnet ef migrations add)\r\n3. I rollback the migration (dotnet ef migrations remove)\r\n\r\nWhat I'm expecting to happen, based on earlier situations:\r\n\r\n- My migration file and its designer file are removed\r\n- ContextModelSnapshot is rollbacked fully\r\n\r\nBut after the rollback, I'm now seeing that ContextModelSnapshot is actually being changed in a way that is new and weird at least for me. Here are screenshots of the changes coming to Snapshot after rollback:\r\n\r\n![image](https://github.com/dotnet/efcore/assets/8158470/8cb5c019-39d1-4f3a-934b-16bd847fe537)\r\n\r\n![image](https://github.com/dotnet/efcore/assets/8158470/d7ffb6d1-8dbe-435b-b5cf-e5c84b7e0d10)\r\n\r\nSo to recap: these changes don't show when the snapshot is changed when adding a migration but only after rollback.\r\n\r\nCodebase has been unchanged for 2ish years regarding to classes and namespaces involved that snapshot is changing.\r\n\r\nThe output from dotnet ef command is:\r\n```\r\nBuild started...\r\nBuild succeeded.\r\n\r\nThe entity type 'Buyer' is an optional dependent using table sharing without any required non shared property that could be used to identify whether the entity exists. If all nullable properties contain a null value in database then an object instance won't be created in the query. Add a required property to create instances with null values for other properties or mark the incoming navigation as required to always create an instance.\r\n\r\nUnable to check if the migration '20231208081727_Testing' has been applied to the database. If it has, you will need to manually revert its changes. Error encountered while checking: LocalDB is not supported on this platform.\r\n\r\nRemoving migration '20231208081727_Testing'.\r\nReverting the model snapshot.\r\nDone.\r\n```\r\n\r\nI can also manually rollback the snapshot, but it becomes impossible if I make multiple small migrations and while doing that want to remove the latest to add/fix something, without affecting the earlier ones deemed working.\r\n\r\nSo the question is, am I safe to just push the weird new hashtags in the snapshot forward, without breaking anything?\r\n\r\n\r\nProvider and version information\r\n\r\nEF Tool version: 7.0.14\r\nEF Core version: 7.0.10\r\nDatabase provider: Microsoft.EntityFrameworkCore.SqlServer\r\nTarget framework: NET 6.0\r\nOperating system: MacOS Sonoma - Version 14.1.2\r\nIDE: Rider 2023.3\r\n","closed_by":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/32555/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/32555/timeline","performed_via_github_app":null,"state_reason":"completed"}