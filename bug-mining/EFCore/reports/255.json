{"url":"https://api.github.com/repos/dotnet/efcore/issues/27679","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/27679/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/27679/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/27679/events","html_url":"https://github.com/dotnet/efcore/issues/27679","id":1175374598,"node_id":"I_kwDOAPaMMs5GDssG","number":27679,"title":"How to get Point-Read with EF Core 6.0 & CosmosDB, Find & FindAsync methods","user":{"login":"shahabganji","id":4405518,"node_id":"MDQ6VXNlcjQ0MDU1MTg=","avatar_url":"https://avatars.githubusercontent.com/u/4405518?v=4","gravatar_id":"","url":"https://api.github.com/users/shahabganji","html_url":"https://github.com/shahabganji","followers_url":"https://api.github.com/users/shahabganji/followers","following_url":"https://api.github.com/users/shahabganji/following{/other_user}","gists_url":"https://api.github.com/users/shahabganji/gists{/gist_id}","starred_url":"https://api.github.com/users/shahabganji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shahabganji/subscriptions","organizations_url":"https://api.github.com/users/shahabganji/orgs","repos_url":"https://api.github.com/users/shahabganji/repos","events_url":"https://api.github.com/users/shahabganji/events{/privacy}","received_events_url":"https://api.github.com/users/shahabganji/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2022-03-21T13:17:09Z","updated_at":"2025-06-16T09:08:35Z","closed_at":"2024-02-16T09:23:05Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## How to get a point read with Find or FindAsync methods.\r\n\r\nI saw in the documentations of [What's new? For EF Core 6.0](https://docs.microsoft.com/en-us/ef/core/what-is-new/ef-core-6.0/whatsnew#diagnostics) that a point read could be achieved if `Id` and `PartitionKey` passed to the `Find` method; however, this seems to not be working no matter how the entity ID configured, I tried various configurations, but none worked properly. [This repository](https://github.com/shahabisblogging/EFCore-Array-String/tree/question/point-read) helps to reproduce the issue we have at the Production.\r\n\r\nCode sample from Microsoft Documentation:\r\n```cs\r\nvar isosceles = context.Triangles.Find(\"Isosceles\", \"TrianglesPartition\");\r\n```\r\n\r\n```bash\r\ninfo: 8/30/2021 14:53:39.326 CosmosEventId.ExecutingReadItem[30101] (Microsoft.EntityFrameworkCore.Database.Command)\r\n      Reading resource 'Isosceles' item from container 'Shapes' in partition 'TrianglesPartition'.\r\ninfo: 8/30/2021 14:53:39.330 CosmosEventId.ExecutedReadItem[30103] (Microsoft.EntityFrameworkCore.Database.Command)\r\n      Executed ReadItem (1 ms, 1 RU) ActivityId='3c278643-4e7f-4bb2-9953-6055b5f1288f', Container='Shapes', Id='Isosceles', Partition='TrianglesPartition'\r\n```\r\n\r\n<hr />\r\n\r\nFollowings are two different approaches I tried,\r\n```cs\r\n// omitted code for clarity\r\n  builder.HasKey(p => new {p.Id, p.Owner});\r\n        builder.Property(p => p.Id)\r\n            .ToJsonProperty(\"id\")\r\n            .IsRequired();\r\n        \r\n        builder.HasPartitionKey(p => p.Owner);\r\n        builder.Property(p => p.Owner).IsRequired();\r\n// omitted code for clarity\r\n```\r\n\r\n```cs\r\n// omitted code for clarity\r\n   builder.HasKey(p => p.Id);\r\n        builder.Property(p => p.Id)\r\n            .ToJsonProperty(\"id\")\r\n            .IsRequired();\r\n        \r\n        builder.HasPartitionKey(p => p.Owner);\r\n        builder.Property(p => p.Owner).IsRequired();\r\n// omitted code for clarity\r\n```\r\n\r\nThe latter one, is throwing an exception at runtime if you pass both `Id` and `PartitionKey` mentioning that the entity is configured with one key; this approach might be useful when both the ID and partition key are the same property, tho. It did not work for entities with that condition too, the same property being partition key and id. \r\n\r\n```bash\r\nUnhandled exception. System.ArgumentException: Entity type 'Draft' is defined with a single key property, but 2 values were passed to the 'Find' method.\r\n   at Microsoft.EntityFrameworkCore.Internal.EntityFinder`1.FindTracked(Object[] keyValues, IReadOnlyList`1& keyProperties)\r\n   at Microsoft.EntityFrameworkCore.Internal.EntityFinder`1.FindAsync(Object[] keyValues, CancellationToken cancellationToken)\r\n   at Microsoft.EntityFrameworkCore.Internal.InternalDbSet`1.FindAsync(Object[] keyValues)\r\n   at Program.<Main>$(String[] args) in C:\\Users\\saeed.ganji\\dev\\playground\\EFCore-Array-String\\Sample.EFCore.ArrayPrimitiveTypes\\Program.cs:line 37\r\n\r\n```\r\n\r\nAll the time it results to a SQL Query instead of a point read.\r\n\r\n```cs\r\nvar draft = await context.Drafts.FindAsync(Guid.Parse(\"4042662c-3b7a-4970-aee5-8bdc6d5e7d1d\"), \"Sample\");\r\n```\r\n\r\n```bash\r\ndbug: 3/21/2022 14:20:19.826 CoreEventId.QueryCompilationStarting[10111] (Microsoft.EntityFrameworkCore.Query)\r\n      Compiling query expression:\r\n      'DbSet<Draft>()\r\n          .FirstOrDefault(e => object.Equals(\r\n              objA: EF.Property<object>(e, \"Id\"),\r\n              objB: (object)__get_Item_0) && EF.Property<string>(e, \"Owner\") == __p_1)'\r\ndbug: 3/21/2022 14:20:19.917 CoreEventId.QueryExecutionPlanned[10107] (Microsoft.EntityFrameworkCore.Query)\r\n      Generated query execution expression:\r\n      'queryContext => ShapedQueryCompilingExpressionVisitor.SingleOrDefaultAsync<Draft>(\r\n          asyncEnumerable: new QueryingEnumerable<Draft>(\r\n              (CosmosQueryContext)queryContext,\r\n              SqlExpressionFactory,\r\n              QuerySqlGeneratorFactory,\r\n              [Cosmos.Query.Internal.SelectExpression],\r\n              Func<QueryContext, JObject, Draft>,\r\n              Sample.EFCore.ArrayPrimitiveTypes.Storage.BooksContext,\r\n              null,\r\n              False,\r\n              True\r\n          ),\r\n          cancellationToken: queryContext.CancellationToken)'\r\ninfo: 3/21/2022 14:20:19.994 CosmosEventId.ExecutingSqlQuery[30100] (Microsoft.EntityFrameworkCore.Database.Command)\r\n      Executing SQL query for container 'Drafts' in partition 'Sample' [Parameters=[@__get_Item_0='4042662c-3b7a-4970-aee5-8bdc6d5e7d1d']]\r\n      SELECT c\r\n      FROM root c\r\n      WHERE (c[\"id\"] = @__get_Item_0)\r\n      OFFSET 0 LIMIT 1\r\ninfo: 3/21/2022 14:20:21.259 CosmosEventId.ExecutedReadNext[30102] (Microsoft.EntityFrameworkCore.Database.Command)\r\n      Executed ReadNext (845.2267 ms, 2.79 RU) ActivityId='ec4b24b1-60a2-4ff7-8077-a64854c6f893', Container='Drafts', Partition='Sample', Parameters=[@__get_Item_0='4042662c-3b7a-4970-aee5-8bdc6d5e7d1d']\r\n      SELECT c\r\n      FROM root c\r\n      WHERE (c[\"id\"] = @__get_Item_0)\r\n      OFFSET 0 LIMIT 1\r\n\r\n```\r\n\r\n\r\n\r\n### Include provider and version information\r\n\r\nEF Core version: 6.0.3\r\nDatabase provider: Microsoft.EntityFrameworkCore.Cosmos\r\nTarget framework:  .NET 6.0\r\nOperating system: Windows 10\r\nIDE: Rider 2021.3.3\r\n","closed_by":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/27679/reactions","total_count":2,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":2},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/27679/timeline","performed_via_github_app":null,"state_reason":"duplicate"}