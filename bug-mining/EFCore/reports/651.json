{"url":"https://api.github.com/repos/dotnet/efcore/issues/36105","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/36105/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/36105/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/36105/events","html_url":"https://github.com/dotnet/efcore/issues/36105","id":3074971901,"node_id":"I_kwDOAPaMMs63SFj9","number":36105,"title":"Parentheses missing with some set operation combinations","user":{"login":"Charlieface","id":124264953,"node_id":"U_kgDOB2gh-Q","avatar_url":"https://avatars.githubusercontent.com/u/124264953?v=4","gravatar_id":"","url":"https://api.github.com/users/Charlieface","html_url":"https://github.com/Charlieface","followers_url":"https://api.github.com/users/Charlieface/followers","following_url":"https://api.github.com/users/Charlieface/following{/other_user}","gists_url":"https://api.github.com/users/Charlieface/gists{/gist_id}","starred_url":"https://api.github.com/users/Charlieface/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Charlieface/subscriptions","organizations_url":"https://api.github.com/users/Charlieface/orgs","repos_url":"https://api.github.com/users/Charlieface/repos","events_url":"https://api.github.com/users/Charlieface/events{/privacy}","received_events_url":"https://api.github.com/users/Charlieface/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1017558838,"node_id":"MDU6TGFiZWwxMDE3NTU4ODM4","url":"https://api.github.com/repos/dotnet/efcore/labels/Servicing-approved","name":"Servicing-approved","color":"048708","default":false,"description":""},{"id":1675384372,"node_id":"MDU6TGFiZWwxNjc1Mzg0Mzcy","url":"https://api.github.com/repos/dotnet/efcore/labels/area-query","name":"area-query","color":"32b37b","default":false,"description":""},{"id":5191268537,"node_id":"LA_kwDOAPaMMs8AAAABNWx4uQ","url":"https://api.github.com/repos/dotnet/efcore/labels/area-set-operations","name":"area-set-operations","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/215","html_url":"https://github.com/dotnet/efcore/milestone/215","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/215/labels","id":13199229,"node_id":"MI_kwDOAPaMMs4AyWd9","number":215,"title":"9.0.7","description":"","creator":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":2,"state":"open","created_at":"2025-07-04T06:56:31Z","updated_at":"2025-08-04T22:26:23Z","due_on":null,"closed_at":null},"comments":4,"created_at":"2025-05-19T20:42:15Z","updated_at":"2025-07-04T06:57:00Z","closed_at":"2025-05-29T11:58:24Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Bug description\n\nWhen set operators (`Union` `Intersect` `Except` `Concat`) are used in a nested fashion, they are in some cases parenthesized in the SQL. This preserves the intended logic, as the precedence is left-to-right, except for `INTERSECT` which is higher. They are only parenthesized when a set operator is followed by a different set operator.\n\nSo `a.Union(b).Union(c)` is not parenthesized, but `a.Except(b).Union(c)` or `a.Union(b).Except(c)` is parenthesized. When there is nesting on the right side, the same logic is applied. `a.Union(b.Union(c))` is not, and `a.Union(b.Except(c))` is parenthesized.\n\nIn the case of only `Except` operators, this is not correct. `a.Except(b).Except(c)` does not need, but `a.Except(b.Except(c))` **does** need, and is currently **not** parenthesized. The generated SQL is:\n```sql\nSELECT id\nFROM Test\nEXCEPT\nSELECT id\nFROM Test\nEXCEPT\nSELECT id\nFROM Test;\n```\ninstead of\n```sql\nSELECT id\nFROM Test\nEXCEPT (\n    SELECT id\n    FROM Test\n    EXCEPT\n    SELECT id\n    FROM Test\n);\n```\nFor clarity, you can see the difference between these two in this [dbfiddle](https://dbfiddle.uk/FJJysXfs).\n____\nThe issue appears to be on [this line](https://github.com/dotnet/efcore/blob/c281f3cd587cbf8ae5151e50bab74476ba2f574c/src/EFCore.Relational/Query/QuerySqlGenerator.cs#L1360) of `QuerySqlGenerator.cs`\n```cs\n// INTERSECT has higher precedence over UNION and EXCEPT, but otherwise evaluation is left-to-right.\n// To preserve meaning, add parentheses whenever a set operation is nested within a different set operation.\nif (IsNonComposedSetOperation(operand)\n    && operand.Tables[0].GetType() != setOperation.GetType())\n```\nIt should be something like\n```cs\n    && (operand.Tables[0] is ExceptExpression || operand.Tables[0].GetType() != setOperation.GetType()))\n```\nThis issue only applies to `Except` as it's the only operator that isn't commutative.\n\nReported on [StackOverflow here](https://stackoverflow.com/questions/79150544/is-it-possible-to-specify-the-order-in-which-except-operations-are-executed-in-s)\n\n### Your code\n\nThis easily reproduced using the following script:\n```cs\npublic class MyContext : DbContext\n{\n    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)\n    {\n        optionsBuilder.UseSqlServer(\"Data Source=.\");\n    }\n\n    public DbSet<TestEntity> Tests {get;set;} = null!;\n}\n\npublic class TestEntity\n{\n    public int Id {get;set;}\n}\n\n\nusing var ctx = new MyContext();\nvar baseQuery = ctx.Tests;\nvar results = baseQuery\n    .Except(\n        baseQuery\n\t.Except(\n\t    baseQuery\n        )\n\t//.Where(t => EF.Constant(1) == EF.Constant((short)1))\n    );\nConsole.WriteLine(results.ToQueryString());\n```\nIf you uncomment the workaround with the `Where` line, you will see it correctly generated, as this forces a pushdown.\n\n[dotnetfiddle](https://dotnetfiddle.net/5dEjtK#)\n\n### EF Core version\n\n9.0.5\n\n### Target framework\n\n.NET 9.0\n","closed_by":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/36105/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/36105/timeline","performed_via_github_app":null,"state_reason":"completed"}