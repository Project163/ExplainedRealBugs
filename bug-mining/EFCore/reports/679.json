{"url":"https://api.github.com/repos/dotnet/efcore/issues/34280","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/34280/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/34280/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/34280/events","html_url":"https://github.com/dotnet/efcore/issues/34280","id":2427419385,"node_id":"I_kwDOAPaMMs6Qr3r5","number":34280,"title":"GroupBySplitQueryingEnumerable not disposing related data readers","user":{"login":"invdev-rh","id":43938504,"node_id":"MDQ6VXNlcjQzOTM4NTA0","avatar_url":"https://avatars.githubusercontent.com/u/43938504?v=4","gravatar_id":"","url":"https://api.github.com/users/invdev-rh","html_url":"https://github.com/invdev-rh","followers_url":"https://api.github.com/users/invdev-rh/followers","following_url":"https://api.github.com/users/invdev-rh/following{/other_user}","gists_url":"https://api.github.com/users/invdev-rh/gists{/gist_id}","starred_url":"https://api.github.com/users/invdev-rh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/invdev-rh/subscriptions","organizations_url":"https://api.github.com/users/invdev-rh/orgs","repos_url":"https://api.github.com/users/invdev-rh/repos","events_url":"https://api.github.com/users/invdev-rh/events{/privacy}","received_events_url":"https://api.github.com/users/invdev-rh/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1017558838,"node_id":"MDU6TGFiZWwxMDE3NTU4ODM4","url":"https://api.github.com/repos/dotnet/efcore/labels/Servicing-approved","name":"Servicing-approved","color":"048708","default":false,"description":""},{"id":1675384372,"node_id":"MDU6TGFiZWwxNjc1Mzg0Mzcy","url":"https://api.github.com/repos/dotnet/efcore/labels/area-query","name":"area-query","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/207","html_url":"https://github.com/dotnet/efcore/milestone/207","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/207/labels","id":11921436,"node_id":"MI_kwDOAPaMMs4Ategc","number":207,"title":"9.0.x","description":"","creator":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":4,"state":"open","created_at":"2024-11-19T22:03:43Z","updated_at":"2025-08-04T22:26:30Z","due_on":null,"closed_at":null},"comments":2,"created_at":"2024-07-24T12:08:24Z","updated_at":"2025-08-04T22:26:30Z","closed_at":"2025-08-04T22:26:30Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Description\r\n\r\nI'm working with the `DbCommandInterceptor` to track some bits around `DataReaderClosing` and I am getting different results when the query is for `GroupBySplitQueryingEnumerable` than I do when it's for `SplitQueryingEnumerable`.\r\n\r\nThe GroupBy version does not appear to directly dispose of the data reader(s) that are held by the `SplitQueryResultCoordinator` (_resultCoordinator).\r\n\r\nThis means a lack of call to the `DataReaderClosing` method on the `DbCommandInterceptor` at least for a time (unable to get it to work in my scenario).\r\nWhen dealing with other enumerable types so far seems consistent and very timely, but the GroupBy version is different.  (same looks true for it's Async dispose method)\r\n\r\nInclusive of it not being called the same way, I would like to highlight a potential for these related data readers to not be disposed correctly, can you check that?\r\n\r\n[Here is the disposal code](https://github.com/dotnet/efcore/blob/a673d8128eeb975925511215d74355fde03578a1/src/EFCore.Relational/Query/Internal/GroupBySplitQueryingEnumerable.cs#L362) for `GroupBySplitQueryingEnumerable` which does not dispose the related data readers\r\n\r\n[Here is the disposal code](https://github.com/dotnet/efcore/blob/a673d8128eeb975925511215d74355fde03578a1/src/EFCore.Relational/Query/Internal/SplitQueryingEnumerable.cs#L288) for `SplitQueryingEnumerable` which iterates the data readers on the `SplitQueryResultCoordinator` and disposes of each\r\n\r\n### Example code to force the dispose in my app\r\n\r\n```C#\r\n// some random query for an example\r\nvar grpByQuery = context.Users\r\n\t.Include(x => x.Addresses)\r\n\t.GroupBy(x => x.Age)\r\n\t.AsSplitQuery();\r\n\r\nusing var enumerator = grpByQuery.GetEnumerator();\r\nwhile (enumerator.MoveNext())\r\n{\r\n    // trigger the enumerable to do it's querying\r\n    // and that will also boot up the _resultCoordinator shown below\r\n}\r\n// stick a dispose of the enumerator in here, it doesn't close all readers\r\n\r\n// this code will do the missing parts that the dispose method could/should do\r\nif (enumerator.GetType()\r\n    .GetField(\"_resultCoordinator\", BindingFlags.NonPublic | BindingFlags.Instance)?\r\n    .GetValue(enumerator) is SplitQueryResultCoordinator coordinator)\r\n{\r\n    foreach (var dataReader in coordinator.DataReaders)\r\n    {\r\n        dataReader?.DataReader.Dispose();\r\n    }\r\n    coordinator.DataReaders.Clear();\r\n}\r\n```\r\n\r\n### Include provider and version information\r\n\r\nEF Core version: 8.0.4\r\nDatabase provider: (e.g. Microsoft.EntityFrameworkCore.Sqlite)\r\nTarget framework: 8.0\r\nOperating system: Windows 11 Pro\r\nIDE: Rider 2024.1.4\r\n","closed_by":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/34280/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/34280/timeline","performed_via_github_app":null,"state_reason":"completed"}