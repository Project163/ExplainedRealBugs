{"url":"https://api.github.com/repos/dotnet/efcore/issues/32739","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/32739/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/32739/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/32739/events","html_url":"https://github.com/dotnet/efcore/issues/32739","id":2068860953,"node_id":"I_kwDOAPaMMs57UFAZ","number":32739,"title":"Optimized model no longer using correct schemas in EF 8.0.0","user":{"login":"chriscameron-vertexinc","id":101140818,"node_id":"U_kgDOBgdJUg","avatar_url":"https://avatars.githubusercontent.com/u/101140818?v=4","gravatar_id":"","url":"https://api.github.com/users/chriscameron-vertexinc","html_url":"https://github.com/chriscameron-vertexinc","followers_url":"https://api.github.com/users/chriscameron-vertexinc/followers","following_url":"https://api.github.com/users/chriscameron-vertexinc/following{/other_user}","gists_url":"https://api.github.com/users/chriscameron-vertexinc/gists{/gist_id}","starred_url":"https://api.github.com/users/chriscameron-vertexinc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chriscameron-vertexinc/subscriptions","organizations_url":"https://api.github.com/users/chriscameron-vertexinc/orgs","repos_url":"https://api.github.com/users/chriscameron-vertexinc/repos","events_url":"https://api.github.com/users/chriscameron-vertexinc/events{/privacy}","received_events_url":"https://api.github.com/users/chriscameron-vertexinc/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1900941630,"node_id":"MDU6TGFiZWwxOTAwOTQxNjMw","url":"https://api.github.com/repos/dotnet/efcore/labels/area-model-building","name":"area-model-building","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/180","html_url":"https://github.com/dotnet/efcore/milestone/180","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/180/labels","id":9963267,"node_id":"MI_kwDOAPaMMs4AmAcD","number":180,"title":"9.0.0","description":null,"creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":339,"state":"closed","created_at":"2023-09-25T15:41:58Z","updated_at":"2025-04-01T18:19:15Z","due_on":null,"closed_at":"2024-11-14T11:54:05Z"},"comments":4,"created_at":"2024-01-06T22:25:22Z","updated_at":"2025-06-15T19:56:53Z","closed_at":"2024-01-16T19:30:51Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"EF Core version: 8.0.0\r\nDatabase provider: Npgsql.EntityFrameworkCore.PostgreSQL\r\nTarget framework: .NET 8.0\r\nOperating system: Windows 10\r\nIDE: Visual Studio 2022 17.8.0\r\n\r\nHello!\r\n\r\nI've been using Optimized Models in EF7 with great success.\r\n\r\nMy database model shards tenants at the schema level, so I'll have common tables in the `dbo` schema, and tenant tables in the `tenant_xyz` schema. My optimized model partial does the following to make this work:\r\n\r\n```\r\npublic partial class DatabaseContextModel\r\n{\r\n    private readonly List<RuntimeEntityType> m_EntityTypes = new();\r\n\r\n    private string DefaultSchema { get; init; } = \"dbo\";\r\n\r\n    public static IModel GetInstance(string schema)\r\n    {\r\n        model = new DatabaseContextModel\r\n        {\r\n            DefaultSchema = schema\r\n        };\r\n        model.Initialize();\r\n        model.Customize();\r\n\r\n        return model;\r\n    }\r\n\r\n    public override RuntimeEntityType AddEntityType(string name, Type type, RuntimeEntityType? baseType = null,\r\n                                                    bool sharedClrType = false,\r\n                                                    string? discriminatorProperty = null,\r\n                                                    ChangeTrackingStrategy changeTrackingStrategy =\r\n                                                        ChangeTrackingStrategy.Snapshot,\r\n                                                    PropertyInfo? indexerPropertyInfo = null,\r\n                                                    bool propertyBag = false,\r\n                                                    object? discriminatorValue = null)\r\n    {\r\n        var entityType =\r\n            base.AddEntityType(name, type, baseType, sharedClrType, discriminatorProperty,\r\n                               changeTrackingStrategy, indexerPropertyInfo, propertyBag, discriminatorValue);\r\n\r\n        m_EntityTypes.Add(entityType);\r\n\r\n        return entityType;\r\n    }\r\n\r\n    partial void Customize()\r\n    {\r\n        if (DefaultSchema == \"dbo\")\r\n            return;\r\n\r\n        RemoveAnnotation(\"Relational:DefaultSchema\");\r\n        AddAnnotation(\"Relational:DefaultSchema\", DefaultSchema);\r\n\r\n        foreach (var entityType in m_EntityTypes)\r\n            Customize(entityType);\r\n    }\r\n\r\n    private void Customize(RuntimeEntityType entityType)\r\n    {\r\n        // Can't specify schema for shared CLR types\r\n        if (((IReadOnlyTypeBase)entityType).HasSharedClrType)\r\n            return;\r\n\r\n        var tableName = entityType.FindAnnotation(\"Relational:TableName\")?.Value as string;\r\n        if (string.IsNullOrEmpty(tableName))\r\n            return;\r\n\r\n        var isTenant = SchemaUtils.IsTenantSchema(tableName);\r\n        if (!isTenant)\r\n            return;\r\n\r\n        entityType.RemoveAnnotation(\"Relational:Schema\");\r\n        entityType.AddAnnotation(\"Relational:Schema\", DefaultSchema);\r\n    }\r\n```\r\n\r\nSince upgrading to EF 8 it looks like my DbContext no longer uses the appropriate schema for tenant tables, and is instead looking in dbo for everything.\r\n\r\nI've debugged the resulting model and it looks like all of the annotations are correct.\r\n\r\nWhen I remove the DbContextOptionsBuilder UseModel call my context works just fine, albeit slower.\r\n\r\nHow can I ensure that optimized models in EF 8 are using the appropriate schemas per table?","closed_by":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/32739/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/32739/timeline","performed_via_github_app":null,"state_reason":"completed"}