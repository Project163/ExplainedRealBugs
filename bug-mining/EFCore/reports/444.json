{"url":"https://api.github.com/repos/dotnet/efcore/issues/33354","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/33354/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/33354/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/33354/events","html_url":"https://github.com/dotnet/efcore/issues/33354","id":2195256992,"node_id":"I_kwDOAPaMMs6C2Pag","number":33354,"title":"DbContext from pool contains many InternalEntityEntry instances after clearing change tracker","user":{"login":"mu88","id":4560672,"node_id":"MDQ6VXNlcjQ1NjA2NzI=","avatar_url":"https://avatars.githubusercontent.com/u/4560672?v=4","gravatar_id":"","url":"https://api.github.com/users/mu88","html_url":"https://github.com/mu88","followers_url":"https://api.github.com/users/mu88/followers","following_url":"https://api.github.com/users/mu88/following{/other_user}","gists_url":"https://api.github.com/users/mu88/gists{/gist_id}","starred_url":"https://api.github.com/users/mu88/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mu88/subscriptions","organizations_url":"https://api.github.com/users/mu88/orgs","repos_url":"https://api.github.com/users/mu88/repos","events_url":"https://api.github.com/users/mu88/events{/privacy}","received_events_url":"https://api.github.com/users/mu88/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1900941009,"node_id":"MDU6TGFiZWwxOTAwOTQxMDA5","url":"https://api.github.com/repos/dotnet/efcore/labels/area-save-changes","name":"area-save-changes","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":16,"created_at":"2024-03-19T15:15:09Z","updated_at":"2025-06-16T08:51:13Z","closed_at":"2024-04-26T18:25:35Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Ask a question\r\n\r\nI've implemented a job scheduler that processes many records from our PostgreSQL database every few minutes. Within one of our Grafana dashboards, I noticed that the Gen2 size slowly increases over time and finally reaches a plateau:  \r\n![image](https://github.com/dotnet/efcore/assets/4560672/7b2d0233-4a65-4f6c-a6b8-df422c2ab834)\r\n\r\nSo I was wondering what causes Gen2 to become that large and created a memory dump. To my surprise, there are thousands of `InternalEntityEntry` objects which retain more than a million objects from being GCed:  \r\n![image](https://github.com/dotnet/efcore/assets/4560672/d758622b-5b82-45da-96fd-5e1a0c046a0e)\r\n\r\nTo be honest, this comes to my surprise as I'd have expected that `context.ChangeTracker.Clear()` discards those elements after saving them - but maybe I'm misunderstanding something? ðŸ¤”\r\n\r\nSo I'd like to know whether\r\na) that is normal/expected behavior and if yes,\r\nb) why is it that there are so many `InternalEntityEntry` objects ending up in Gen2?\r\n\r\n### Include your code\r\n\r\n```C#\r\npublic class InteractionPoint\r\n{\r\n    public int Key { get; set; }\r\n    public ProcessState State { get; set; } = ProcessState.Received;\r\n}\r\n\r\npublic enum ProcessState\r\n{\r\n    Received = 0,\r\n    Incomplete = 1,\r\n    Processed = 2,\r\n    TombstoneReceived = 3,\r\n    TombstoneProcessed = 4\r\n}\r\n\r\npublic class DeliveryPlanDbContext : DbContext\r\n{\r\n    public DeliveryPlanDbContext(DbContextOptions options)\r\n        : base(options)\r\n    {\r\n    }\r\n\r\n    public DbSet<InteractionPoint> InteractionPoints { get; set; }\r\n}\r\n\r\npublic async Task Foo(IDbContextFactory<MyDbContext> factory, ILogger logger)\r\n{\r\n    var context = factory.CreateDbContext();\r\n    \r\n    var strategy = context.Database.CreateExecutionStrategy();\r\n    await strategy.ExecuteAsync(async () => \r\n    {\r\n        using IDbContextTransaction transaction = await context.Database.BeginTransactionAsync(ct);\r\n        \r\n        var entities = await dbContext.Set<InteractionPoint>()\r\n            .Where(entity => entity.State == ProcessState.Received)\r\n            .OrderBy(entity => entity.Key)\r\n            .Take(1000)\r\n            .AsTracking()\r\n            .ToListAsync(ct);\r\n        await HandleEntitiesAsync(entities, ct);\r\n        \r\n        await context.SaveChangesAsync(ct);\r\n        context.ChangeTracker.Clear();\r\n        await transaction.CommitAsync();\r\n    });\r\n}\r\n\r\npublic async Task HandleEntitiesAsync(List<InteractionPoint> entities, CancellationToken ct)\r\n{\r\n    foreach (var entity in entities)\r\n    {\r\n        // do some processing\r\n        entity.State = ProcessState.Processed;\r\n    }\r\n}\r\n```\r\n\r\n...and the configuration:\r\n```csharp\r\nvoid Options(IServiceProvider provider, DbContextOptionsBuilder builder)\r\n{\r\n    builder\r\n        .UseQueryTrackingBehavior(QueryTrackingBehavior.NoTracking)\r\n        .UseNpgsql(\r\n            connectionString,\r\n            sqlOptions => sqlOptions.CommandTimeout(40));\r\n}\r\n\r\nservices.AddDbContextPool<DeliveryPlanDbContext>(Options);\r\nservices.AddPooledDbContextFactory<DeliveryPlanDbContext>(Options);\r\n```\r\n\r\nFor a full repro case, see this repo: https://github.com/mu88/Repro_EFCore_MemoryUsage\r\n\r\n### Include stack traces\r\n\r\nThere are no errors or exceptions.\r\n\r\n### Include verbose output\r\n\r\n```\r\nUsing project 'C:\\work\\Bitbucket\\MyOrg\\my-app\\src\\MyCompany.MyApp.Service\\MyCompany.MyApp.Service.csproj'.\r\nUsing startup project 'C:\\work\\Bitbucket\\MyOrg\\my-app\\src\\MyCompany.MyApp.Service\\MyCompany.MyApp.Service.csproj'.\r\nWriting 'C:\\work\\Bitbucket\\MyOrg\\my-app\\src\\MyCompany.MyApp.Service\\obj\\MyCompany.MyApp.Service.csproj.EntityFrameworkCore.targets'...\r\ndotnet msbuild /target:GetEFProjectMetadata /property:EFProjectMetadataFile=C:\\Users\\MyUser\\AppData\\Local\\Temp\\tmp5chq3h.tmp /verbosity:quiet /nologo C:\\work\\Bitbucket\\MyOrg\\my-app\\src\\MyCompany.MyApp.Service\\MyCompany.MyApp.Service.csproj\r\nWriting 'C:\\work\\Bitbucket\\MyOrg\\my-app\\src\\MyCompany.MyApp.Service\\obj\\MyCompany.MyApp.Service.csproj.EntityFrameworkCore.targets'...\r\ndotnet msbuild /target:GetEFProjectMetadata /property:EFProjectMetadataFile=C:\\Users\\MyUser\\AppData\\Local\\Temp\\tmpj3tm2x.tmp /verbosity:quiet /nologo C:\\work\\Bitbucket\\MyOrg\\my-app\\src\\MyCompany.MyApp.Service\\MyCompany.MyApp.Service.csproj\r\nBuild started...\r\ndotnet build C:\\work\\Bitbucket\\MyOrg\\my-app\\src\\MyCompany.MyApp.Service\\MyCompany.MyApp.Service.csproj /verbosity:quiet /nologo /p:PublishAot=false\r\n\r\nBuild succeeded.\r\n    0 Warning(s)\r\n    0 Error(s)\r\n\r\nTime Elapsed 00:00:05.15\r\nBuild succeeded.\r\ndotnet exec --depsfile C:\\work\\Bitbucket\\MyOrg\\my-app\\src\\MyCompany.MyApp.Service\\bin\\Debug\\net7.0\\MyCompany.MyApp.Service.deps.json --additionalprobingpath C:\\Users\\MyUser\\.nuget\\packages --additionalprobingpath \"C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\NuGetPackages\" --additionalprobingpath \"C:\\Program Files\\dotnet\\sdk\\NuGetFallbackFolder\" --runtimeconfig C:\\work\\Bitbucket\\MyOrg\\my-app\\src\\MyCompany.MyApp.Service\\bin\\Debug\\net7.0\\MyCompany.MyApp.Service.runtimeconfig.json C:\\Users\\MyUser\\.dotnet\\tools\\.store\\dotnet-ef\\8.0.1\\dotnet-ef\\8.0.1\\tools\\net8.0\\any\\tools\\netcoreapp2.0\\any\\ef.dll dbcontext list --assembly C:\\work\\Bitbucket\\MyOrg\\my-app\\src\\MyCompany.MyApp.Service\\bin\\Debug\\net7.0\\MyCompany.MyApp.Service.dll --project C:\\work\\Bitbucket\\MyOrg\\my-app\\src\\MyCompany.MyApp.Service\\MyCompany.MyApp.Service.csproj --startup-assembly C:\\work\\Bitbucket\\MyOrg\\my-app\\src\\MyCompany.MyApp.Service\\bin\\Debug\\net7.0\\MyCompany.MyApp.Service.dll --startup-project C:\\work\\Bitbucket\\MyOrg\\my-app\\src\\MyCompany.MyApp.Service\\MyCompany.MyApp.Service.csproj --project-dir C:\\work\\Bitbucket\\MyOrg\\my-app\\src\\MyCompany.MyApp.Service\\ --root-namespace MyCompany.MyApp.Service --language C# --framework net7.0 --nullable --working-dir C:\\work\\Bitbucket\\MyOrg\\my-app\\src\\MyCompany.MyApp.Service --verbose\r\nUsing assembly 'MyCompany.MyApp.Service'.\r\nUsing startup assembly 'MyCompany.MyApp.Service'.\r\nUsing application base 'C:\\work\\Bitbucket\\MyOrg\\my-app\\src\\MyCompany.MyApp.Service\\bin\\Debug\\net7.0'.\r\nUsing working directory 'C:\\work\\Bitbucket\\MyOrg\\my-app\\src\\MyCompany.MyApp.Service'.\r\nUsing root namespace 'MyCompany.MyApp.Service'.\r\nUsing project directory 'C:\\work\\Bitbucket\\MyOrg\\my-app\\src\\MyCompany.MyApp.Service\\'.\r\nRemaining arguments: .\r\nFinding DbContext classes...\r\nFinding IDesignTimeDbContextFactory implementations...\r\nFinding application service provider in assembly 'MyCompany.MyApp.Service'...\r\nFinding Microsoft.Extensions.Hosting service provider...\r\nUsing environment 'Development'.\r\nUsing application service provider from Microsoft.Extensions.Hosting.\r\nFound DbContext 'DeliveryPlanDbContext'.\r\nFinding DbContext classes in the project...\r\nMyCompany.MyApp.Core.Persistence.DeliveryPlanDbContext\r\n```\r\n\r\n### Include provider and version information\r\n\r\nEF Core version: 7.0\r\nDatabase provider: `Npgsql.EntityFrameworkCore.PostgreSQL`\r\nTarget framework: .NET 7.0\r\nOperating system: Alpine Linux\r\nIDE: not relevant as it happens on production\r\n","closed_by":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/33354/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/33354/timeline","performed_via_github_app":null,"state_reason":"duplicate"}