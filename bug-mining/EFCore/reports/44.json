{"url":"https://api.github.com/repos/dotnet/efcore/issues/27343","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/27343/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/27343/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/27343/events","html_url":"https://github.com/dotnet/efcore/issues/27343","id":1121769630,"node_id":"I_kwDOAPaMMs5C3Nie","number":27343,"title":"ArgumentException thrown When GroupJoin is applied on a DbSet as a first join and NOT when applied as a second or later","user":{"login":"ankitmatrix08","id":18023679,"node_id":"MDQ6VXNlcjE4MDIzNjc5","avatar_url":"https://avatars.githubusercontent.com/u/18023679?v=4","gravatar_id":"","url":"https://api.github.com/users/ankitmatrix08","html_url":"https://github.com/ankitmatrix08","followers_url":"https://api.github.com/users/ankitmatrix08/followers","following_url":"https://api.github.com/users/ankitmatrix08/following{/other_user}","gists_url":"https://api.github.com/users/ankitmatrix08/gists{/gist_id}","starred_url":"https://api.github.com/users/ankitmatrix08/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ankitmatrix08/subscriptions","organizations_url":"https://api.github.com/users/ankitmatrix08/orgs","repos_url":"https://api.github.com/users/ankitmatrix08/repos","events_url":"https://api.github.com/users/ankitmatrix08/events{/privacy}","received_events_url":"https://api.github.com/users/ankitmatrix08/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1382547263,"node_id":"MDU6TGFiZWwxMzgyNTQ3MjYz","url":"https://api.github.com/repos/dotnet/efcore/labels/good%20first%20issue","name":"good first issue","color":"fef2c0","default":true,"description":"This issue should be relatively straightforward to fix."},{"id":1675384372,"node_id":"MDU6TGFiZWwxNjc1Mzg0Mzcy","url":"https://api.github.com/repos/dotnet/efcore/labels/area-query","name":"area-query","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"smitpatel","id":1528107,"node_id":"MDQ6VXNlcjE1MjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1528107?v=4","gravatar_id":"","url":"https://api.github.com/users/smitpatel","html_url":"https://github.com/smitpatel","followers_url":"https://api.github.com/users/smitpatel/followers","following_url":"https://api.github.com/users/smitpatel/following{/other_user}","gists_url":"https://api.github.com/users/smitpatel/gists{/gist_id}","starred_url":"https://api.github.com/users/smitpatel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smitpatel/subscriptions","organizations_url":"https://api.github.com/users/smitpatel/orgs","repos_url":"https://api.github.com/users/smitpatel/repos","events_url":"https://api.github.com/users/smitpatel/events{/privacy}","received_events_url":"https://api.github.com/users/smitpatel/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"smitpatel","id":1528107,"node_id":"MDQ6VXNlcjE1MjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1528107?v=4","gravatar_id":"","url":"https://api.github.com/users/smitpatel","html_url":"https://github.com/smitpatel","followers_url":"https://api.github.com/users/smitpatel/followers","following_url":"https://api.github.com/users/smitpatel/following{/other_user}","gists_url":"https://api.github.com/users/smitpatel/gists{/gist_id}","starred_url":"https://api.github.com/users/smitpatel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smitpatel/subscriptions","organizations_url":"https://api.github.com/users/smitpatel/orgs","repos_url":"https://api.github.com/users/smitpatel/repos","events_url":"https://api.github.com/users/smitpatel/events{/privacy}","received_events_url":"https://api.github.com/users/smitpatel/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/128","html_url":"https://github.com/dotnet/efcore/milestone/128","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/128/labels","id":7236796,"node_id":"MI_kwDOAPaMMs4Abmy8","number":128,"title":"7.0.0","description":"EF Core 7.0","creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":375,"state":"closed","created_at":"2021-10-09T18:57:40Z","updated_at":"2024-11-13T16:14:22Z","due_on":null,"closed_at":"2022-11-05T18:37:45Z"},"comments":14,"created_at":"2022-02-02T10:48:21Z","updated_at":"2025-06-15T18:45:25Z","closed_at":"2022-05-25T00:28:16Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**1. Exception Case:**\r\nLINQ: Here, I have a query which is doing a GroupJoin on an DbSet and then adding other inner joins.\r\n**Repository.ConvertToBigIntTable** -> This is an output of a call to a Table-Valued function which returns an IQueryable<T> (T is a Keyless entity having a **long Id** field)\r\n\r\n```C#\r\nprivate IQueryable<IDocumentTypePermission> GetDocumentTypePermissionsTest<T>(IQueryable<T> entitySet) where T : class, IDocumentType\r\n        {\r\n            var userGroupIds = RunComponent(GetActiveUserGroupsOfCurrentUser.New(new GetActiveUserGroupsOfCurrentUserParam() { CurrentUserId = CurrentUserId })).UserGroupIds;\r\n            return (from documentType in entitySet\r\n                    join userGroupId in Repository.ConvertToBigIntTable(userGroupIds, \"userGroupId\")\r\n                    on documentType.Id equals userGroupId.Id into UserGroupIds\r\n                    from userGroupId in UserGroupIds.DefaultIfEmpty()\r\n                    join documentTypePermission in Repository.DocumentTypePermissions\r\n                    on documentType.Id equals documentTypePermission.DocumentTypeId\r\n                    join userSelectionParam in Repository.UserSelectionParams\r\n                    on documentTypePermission.UserSelectionId equals userSelectionParam.Id\r\n\r\n                    \r\n                    where documentTypePermission.IsActive && ((userSelectionParam.UserGroupId != null && userGroupId.Id != null)\r\n                                                              || (userSelectionParam.UserId != null && userSelectionParam.UserId == CurrentUserId))\r\n                    select documentTypePermission);\r\n        }\r\n```\r\n\r\n```\r\nDbSet<EDocumentType>()\r\n    .GroupJoin(\r\n        inner: BananaContext.ConvertCSVToBigIntTable(\r\n            List: <>c__DisplayClass958_0.List, \r\n            Delim: <>c__DisplayClass958_0.Delim), \r\n        outerKeySelector: documentType => documentType.Id, \r\n        innerKeySelector: userGroupId => userGroupId.Id, \r\n        resultSelector: (documentType, UserGroupIds) => new { \r\n            documentType = documentType, \r\n            UserGroupIds = UserGroupIds\r\n         })\r\n    .SelectMany(\r\n        collectionSelector: <>h__TransparentIdentifier0 => <>h__TransparentIdentifier0.UserGroupIds\r\n            .DefaultIfEmpty(), \r\n        resultSelector: (<>h__TransparentIdentifier0, userGroupId) => new { \r\n            <>h__TransparentIdentifier0 = <>h__TransparentIdentifier0, \r\n            userGroupId = userGroupId\r\n         })\r\n    .Join(\r\n        inner: DbSet<EDocumentTypePermission>(), \r\n        outerKeySelector: <>h__TransparentIdentifier1 => (long?)<>h__TransparentIdentifier1.<>h__TransparentIdentifier0.documentType.Id, \r\n        innerKeySelector: documentTypePermission => documentTypePermission.DocumentTypeId, \r\n        resultSelector: (<>h__TransparentIdentifier1, documentTypePermission) => new { \r\n            <>h__TransparentIdentifier1 = <>h__TransparentIdentifier1, \r\n            documentTypePermission = documentTypePermission\r\n         })\r\n    .Join(\r\n        inner: DbSet<EUserSelectionParam>(), \r\n        outerKeySelector: <>h__TransparentIdentifier2 => <>h__TransparentIdentifier2.documentTypePermission.UserSelectionId, \r\n        innerKeySelector: userSelectionParam => (long?)userSelectionParam.Id, \r\n        resultSelector: (<>h__TransparentIdentifier2, userSelectionParam) => new { \r\n            <>h__TransparentIdentifier2 = <>h__TransparentIdentifier2, \r\n            userSelectionParam = userSelectionParam\r\n         })\r\n    .Where(<>h__TransparentIdentifier3 => <>h__TransparentIdentifier3.<>h__TransparentIdentifier2.documentTypePermission.IsActive && <>h__TransparentIdentifier3.userSelectionParam.UserGroupId != null && (long?)<>h__TransparentIdentifier3.<>h__TransparentIdentifier2.<>h__TransparentIdentifier1.userGroupId.Id != null || <>h__TransparentIdentifier3.userSelectionParam.UserId != null && <>h__TransparentIdentifier3.userSelectionParam.UserId == (long?)AbstractDomainBehavior.CurrentUserId)\r\n    .Select(<>h__TransparentIdentifier3 => <>h__TransparentIdentifier3.<>h__TransparentIdentifier2.documentTypePermission)\r\n```\r\n\r\n**Exception:**\r\n\r\n```\r\nExpression of type 'System.Func`2[Lw.Domain.IDocumentType,System.Int64]' cannot be used for parameter of type 'System.Linq.Expressions.Expression`1[System.Func`2[Lw.Domain.EDocumentType,System.Int64]]' of method 'System.Linq.IQueryable`1[<>f__AnonymousType290`2[<>f__AnonymousType289`2[Lw.Domain.IDocumentType,System.Collections.Generic.IEnumerable`1[Lw.Sys.Repository.ITableValueFunctionResult]],Lw.Sys.Repository.ITableValueFunctionResult]] LeftJoin[EDocumentType,ITableValueFunctionResult,Int64,<>f__AnonymousType290`2](System.Linq.IQueryable`1[Lw.Domain.EDocumentType], System.Collections.Generic.IEnumerable`1[Lw.Sys.Repository.ITableValueFunctionResult], System.Linq.Expressions.Expression`1[System.Func`2[Lw.Domain.EDocumentType,System.Int64]], System.Linq.Expressions.Expression`1[System.Func`2[Lw.Sys.Repository.ITableValueFunctionResult,System.Int64]], System.Linq.Expressions.Expression`1[System.Func`3[Lw.Domain.EDocumentType,Lw.Sys.Repository.ITableValueFunctionResult,<>f__AnonymousType290`2[<>f__AnonymousType289`2[Lw.Domain.IDocumentType,System.Collections.Generic.IEnumerable`1[Lw.Sys.Repository.ITableValueFunctionResult]],Lw.Sys.Repository.ITableValueFunctionResult]]])' (Parameter 'arg2')\r\n```\r\nStack Trace:\r\n\r\n```\r\n   at System.Dynamic.Utils.ExpressionUtils.ValidateOneArgument(MethodBase method, ExpressionType nodeKind, Expression arguments, ParameterInfo pi, String methodParamName, String argumentParamName, Int32 index)\r\n   at System.Linq.Expressions.Expression.Call(MethodInfo method, Expression arg0, Expression arg1, Expression arg2, Expression arg3, Expression arg4)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryableMethodNormalizingExpressionVisitor.TryFlattenGroupJoinSelectMany(MethodCallExpression methodCallExpression)\r\n   at System.Dynamic.Utils.ExpressionVisitorUtils.VisitArguments(ExpressionVisitor visitor, IArgumentProvider nodes)\r\n   at System.Linq.Expressions.ExpressionVisitor.VisitMethodCall(MethodCallExpression node)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryableMethodNormalizingExpressionVisitor.VisitMethodCall(MethodCallExpression methodCallExpression)\r\n   at System.Dynamic.Utils.ExpressionVisitorUtils.VisitArguments(ExpressionVisitor visitor, IArgumentProvider nodes)\r\n   at System.Linq.Expressions.ExpressionVisitor.VisitMethodCall(MethodCallExpression node)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryableMethodNormalizingExpressionVisitor.VisitMethodCall(MethodCallExpression methodCallExpression)\r\n   at System.Dynamic.Utils.ExpressionVisitorUtils.VisitArguments(ExpressionVisitor visitor, IArgumentProvider nodes)\r\n   at System.Linq.Expressions.ExpressionVisitor.VisitMethodCall(MethodCallExpression node)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryableMethodNormalizingExpressionVisitor.VisitMethodCall(MethodCallExpression methodCallExpression)\r\n   at System.Dynamic.Utils.ExpressionVisitorUtils.VisitArguments(ExpressionVisitor visitor, IArgumentProvider nodes)\r\n   at System.Linq.Expressions.ExpressionVisitor.VisitMethodCall(MethodCallExpression node)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryableMethodNormalizingExpressionVisitor.VisitMethodCall(MethodCallExpression methodCallExpression)\r\n   at Microsoft.EntityFrameworkCore.Query.QueryTranslationPreprocessor.NormalizeQueryableMethod(Expression expression)\r\n   at Microsoft.EntityFrameworkCore.Query.RelationalQueryTranslationPreprocessor.NormalizeQueryableMethod(Expression expression)\r\n   at Microsoft.EntityFrameworkCore.Query.QueryTranslationPreprocessor.Process(Expression query)\r\n   at Microsoft.EntityFrameworkCore.Query.QueryCompilationContext.CreateQueryExecutor[TResult](Expression query)\r\n   at Microsoft.EntityFrameworkCore.Storage.Database.CompileQuery[TResult](Expression query, Boolean async)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.CompileQueryCore[TResult](IDatabase database, Expression query, IModel model, Boolean async)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.<>c__DisplayClass9_0`1.<Execute>b__0()\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.CompiledQueryCache.GetOrAddQuery[TResult](Object cacheKey, Func`1 compiler)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.Execute[TResult](Expression query)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.EntityQueryProvider.Execute[TResult](Expression expression)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.EntityQueryable`1.GetEnumerator()\r\n   at System.Collections.Generic.LargeArrayBuilder`1.AddRange(IEnumerable`1 items)\r\n   at System.Collections.Generic.EnumerableHelpers.ToArray[T](IEnumerable`1 source)\r\n   at System.Linq.SystemCore_EnumerableDebugView`1.get_Items()\r\n```\r\n**_NOTE: Interestingly trying to do a very similar operation on LinqPad7 seems to work:_**\r\n![image](https://user-images.githubusercontent.com/18023679/152138185-374ea97d-dc03-47d9-a092-aaf62ad43cb5.png)\r\n\r\n\r\n**2. Working Case**\r\nLINQ: Here, I have a query which is performing inner joins on few DbSets and then applying GroupJoin on one of the DbSet.\r\n**Repository.ConvertToBigIntTable** -> This is an output of a call to a Table-Valued function which returns an IQueryable<T> (T is a Keyless entity having a **long Id** field)\r\n\r\n```C#\r\n private IQueryable<IDocumentTypePermission> GetDocumentTypePermissions<T>(IQueryable<T> entitySet) where T : class, IDocumentType\r\n        {\r\n            var userGroupIds = RunComponent(GetActiveUserGroupsOfCurrentUser.New(new GetActiveUserGroupsOfCurrentUserParam() { CurrentUserId = CurrentUserId })).UserGroupIds;\r\n            return (from documentType in entitySet\r\n                    join documentTypePermission in Repository.DocumentTypePermissions on documentType.Id equals documentTypePermission.DocumentTypeId\r\n                    join userSelectionParam in Repository.UserSelectionParams on documentTypePermission.UserSelectionId equals userSelectionParam.Id\r\n                    join userGroupId in Repository.ConvertToBigIntTable(userGroupIds, \"userGroupId\")\r\n                    on userSelectionParam.UserGroupId equals userGroupId.Id into UserGroupIds\r\n                    from userGroupId in UserGroupIds.DefaultIfEmpty()\r\n                    where documentTypePermission.IsActive && ((userSelectionParam.UserGroupId != null && userGroupId.Id != null)\r\n                                                              || (userSelectionParam.UserId != null && userSelectionParam.UserId == CurrentUserId))\r\n                    select documentTypePermission);\r\n        }\r\n```\r\n\r\n**Generated Expression:**\r\n\r\n```\r\nDbSet<EDocumentType>()\r\n    .Join(\r\n        inner: DbSet<EDocumentTypePermission>(), \r\n        outerKeySelector: documentType => (long?)documentType.Id, \r\n        innerKeySelector: documentTypePermission => documentTypePermission.DocumentTypeId, \r\n        resultSelector: (documentType, documentTypePermission) => new { \r\n            documentType = documentType, \r\n            documentTypePermission = documentTypePermission\r\n         })\r\n    .Join(\r\n        inner: DbSet<EUserSelectionParam>(), \r\n        outerKeySelector: <>h__TransparentIdentifier0 => <>h__TransparentIdentifier0.documentTypePermission.UserSelectionId, \r\n        innerKeySelector: userSelectionParam => (long?)userSelectionParam.Id, \r\n        resultSelector: (<>h__TransparentIdentifier0, userSelectionParam) => new { \r\n            <>h__TransparentIdentifier0 = <>h__TransparentIdentifier0, \r\n            userSelectionParam = userSelectionParam\r\n         })\r\n    .GroupJoin(\r\n        inner: BananaContext.ConvertCSVToBigIntTable(\r\n            List: <>c__DisplayClass958_0.List, \r\n            Delim: <>c__DisplayClass958_0.Delim), \r\n        outerKeySelector: <>h__TransparentIdentifier1 => <>h__TransparentIdentifier1.userSelectionParam.UserGroupId, \r\n        innerKeySelector: userGroupId => (long?)userGroupId.Id, \r\n        resultSelector: (<>h__TransparentIdentifier1, UserGroupIds) => new { \r\n            <>h__TransparentIdentifier1 = <>h__TransparentIdentifier1, \r\n            UserGroupIds = UserGroupIds\r\n         })\r\n    .SelectMany(\r\n        collectionSelector: <>h__TransparentIdentifier2 => <>h__TransparentIdentifier2.UserGroupIds\r\n            .DefaultIfEmpty(), \r\n        resultSelector: (<>h__TransparentIdentifier2, userGroupId) => new { \r\n            <>h__TransparentIdentifier2 = <>h__TransparentIdentifier2, \r\n            userGroupId = userGroupId\r\n         })\r\n    .Where(<>h__TransparentIdentifier3 => <>h__TransparentIdentifier3.<>h__TransparentIdentifier2.<>h__TransparentIdentifier1.<>h__TransparentIdentifier0.documentTypePermission.IsActive && <>h__TransparentIdentifier3.<>h__TransparentIdentifier2.<>h__TransparentIdentifier1.userSelectionParam.UserGroupId != null && (long?)<>h__TransparentIdentifier3.userGroupId.Id != null || <>h__TransparentIdentifier3.<>h__TransparentIdentifier2.<>h__TransparentIdentifier1.userSelectionParam.UserId != null && <>h__TransparentIdentifier3.<>h__TransparentIdentifier2.<>h__TransparentIdentifier1.userSelectionParam.UserId == (long?)AbstractDomainBehavior.CurrentUserId)\r\n    .Select(<>h__TransparentIdentifier3 => <>h__TransparentIdentifier3.<>h__TransparentIdentifier2.<>h__TransparentIdentifier1.<>h__TransparentIdentifier0.documentTypePermission)\r\n```\r\n**Generated SQL:**\r\n\r\n```sql\r\nDECLARE @__List_1 nvarchar(4000) = N'1,5,6,7,8,14,15,44,46,62,63,64,67,69,73,85,88';\r\nDECLARE @__Delim_2 nvarchar(1) = N',';\r\nDECLARE @__CurrentUserId_3 bigint = CAST(1 AS bigint);\r\n\r\nSELECT [d0].[Id], [d0].[Condition], [d0].[CreatedById], [d0].[CreatedTime], [d0].[DocumentTypeId], [d0].[IsActive], [d0].[IsOverridable], [d0].[IsReevaluate], [d0].[RowVersion], [d0].[UpdatedById], [d0].[UpdatedTime], [d0].[UserSelectionId], [d0].[AssignmentType], [d0].[ConditionFor], [d0].[CreationAllowed], [d0].[Permission]\r\nFROM [DocumentTypes] AS [d]\r\nINNER JOIN [DocumentTypePermissions] AS [d0] ON [d].[Id] = [d0].[DocumentTypeId]\r\nINNER JOIN [UserSelectionParams] AS [u] ON [d0].[UserSelectionId] = [u].[Id]\r\nLEFT JOIN [dbo].[ConvertCSVToBigIntTable](@__List_1, @__Delim_2) AS [c] ON [u].[UserGroupId] = [c].[Id]\r\nWHERE ([d0].[IsActive] = CAST(1 AS bit)) AND (([u].[UserGroupId] IS NOT NULL AND [c].[Id] IS NOT NULL) OR ([u].[UserId] IS NOT NULL AND ([u].[UserId] = @__CurrentUserId_3)))\r\n```\r\n\r\nEF Core version: 6.0.1\r\nDatabase provider:  Microsoft.EntityFrameworkCore.SqlServer\r\nTarget framework: .NET 6.0\r\nOperating system: Win 10 Pro\r\nIDE: Visual Studio 2022 v17.0.4\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/27343/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/27343/timeline","performed_via_github_app":null,"state_reason":"completed"}