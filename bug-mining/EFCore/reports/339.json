{"url":"https://api.github.com/repos/dotnet/efcore/issues/32084","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/32084/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/32084/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/32084/events","html_url":"https://github.com/dotnet/efcore/issues/32084","id":1949564069,"node_id":"I_kwDOAPaMMs50M_yl","number":32084,"title":"Differnce in behavior between TPH and TPT/TPC with new entity added through navigation property","user":{"login":"Euphoric","id":2451173,"node_id":"MDQ6VXNlcjI0NTExNzM=","avatar_url":"https://avatars.githubusercontent.com/u/2451173?v=4","gravatar_id":"","url":"https://api.github.com/users/Euphoric","html_url":"https://github.com/Euphoric","followers_url":"https://api.github.com/users/Euphoric/followers","following_url":"https://api.github.com/users/Euphoric/following{/other_user}","gists_url":"https://api.github.com/users/Euphoric/gists{/gist_id}","starred_url":"https://api.github.com/users/Euphoric/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Euphoric/subscriptions","organizations_url":"https://api.github.com/users/Euphoric/orgs","repos_url":"https://api.github.com/users/Euphoric/repos","events_url":"https://api.github.com/users/Euphoric/events{/privacy}","received_events_url":"https://api.github.com/users/Euphoric/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1901166749,"node_id":"MDU6TGFiZWwxOTAxMTY2NzQ5","url":"https://api.github.com/repos/dotnet/efcore/labels/area-change-tracking","name":"area-change-tracking","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/180","html_url":"https://github.com/dotnet/efcore/milestone/180","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/180/labels","id":9963267,"node_id":"MI_kwDOAPaMMs4AmAcD","number":180,"title":"9.0.0","description":null,"creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":339,"state":"closed","created_at":"2023-09-25T15:41:58Z","updated_at":"2025-04-01T18:19:15Z","due_on":null,"closed_at":"2024-11-14T11:54:05Z"},"comments":8,"created_at":"2023-10-18T11:54:45Z","updated_at":"2025-06-15T19:53:03Z","closed_at":"2023-12-10T15:00:46Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## File a bug\r\n\r\nI'm having an issue where TPH works but TPT/TPC does not. When I'm creating a new entity and adding it by assigning it to navigation property.\r\n\r\n### Include your code\r\n\r\nFull code to reproduce : https://github.com/Euphoric/EfCore.InheritanceIssue/blob/main/EfCore.InheritanceIssue/EfCore.InheritanceIssue/Program.cs\r\n\r\nThe relevant pieces are :\r\n\r\n```C#\r\n\r\npublic class ParentEntity\r\n{\r\n    public Guid Id { get; set; }\r\n    public ChildBaseEntity? Child { get; set; }\r\n}\r\n\r\npublic abstract class ChildBaseEntity\r\n{\r\n    public Guid Id { get; set; }\r\n    public Guid ParentId { get; set; }\r\n}\r\n\r\npublic class ChildEntity : ChildBaseEntity\r\n{\r\n    public String? ChildValue { get; set; }\r\n}\r\n\r\npublic class TestDbContext : DbContext\r\n{\r\n    public TestDbContext(DbContextOptions options)\r\n        : base(options)\r\n    {\r\n    }\r\n\r\n    public DbSet<ParentEntity> Parents { get; private set; } = null!;\r\n\r\n    protected override void OnModelCreating(ModelBuilder modelBuilder)\r\n    {\r\n        var parent = modelBuilder.Entity<ParentEntity>();\r\n        parent.HasOne(x => x.Child)\r\n            .WithOne()\r\n            .HasForeignKey<ChildBaseEntity>(x=>x.ParentId)\r\n            ;\r\n        var childBase = modelBuilder.Entity<ChildBaseEntity>();\r\n        //childBase.UseTphMappingStrategy(); // Case 1 : Works correctly\r\n        //childBase.UseTptMappingStrategy(); // Case 2 : Doesn't work\r\n        childBase.UseTpcMappingStrategy(); // Case 3 : Doesn't work\r\n        \r\n        var child = modelBuilder.Entity<ChildEntity>();\r\n        child.HasBaseType<ChildBaseEntity>();\r\n    }\r\n}\r\n\r\n// And when executed:\r\n\r\nvar parentId = Guid.NewGuid();\r\ncontext.Parents.Add(new ParentEntity {Id = parentId});\r\n\r\nvar parent = await context.Parents.FindAsync(parentId);\r\nvar child = new ChildEntity {Id = Guid.NewGuid(), ParentId = parent!.Id, ChildValue = \"test value\"};\r\n//await context.Set<ChildBaseEntity>().AddAsync(child); // fixes\r\nparent.Child = child;\r\nawait context.SaveChangesAsync();\r\n```\r\n\r\nWhen using TPH, this code works as expected.\r\nBut when using TPT or TPC this code fails when trying to save changes:\r\n```\r\n     An exception occurred in the database while saving changes for context type 'EfCore.InheritanceIssue.TestDbContext'.\r\n      Microsoft.EntityFrameworkCore.DbUpdateConcurrencyException: The database operation was expected to affect 1 row(s), but actually affected 0 row(s); data may have been modified or deleted since entities were loaded. See http://go.microsoft.com/fwlink/?LinkId=527962 for information on understandi\r\n         at Npgsql.EntityFrameworkCore.PostgreSQL.Update.Internal.NpgsqlModificationCommandBatch.ThrowAggregateUpdateConcurrencyExceptionAsync(RelationalDataReader reader, Int32 commandIndex, Int32 expectedRowsAffected, Int32 rowsAffected, CancellationToken cancellationToken)\r\n         at Npgsql.EntityFrameworkCore.PostgreSQL.Update.Internal.NpgsqlModificationCommandBatch.Consume(RelationalDataReader reader, Boolean async, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)\r\n         at Npgsql.EntityFrameworkCore.PostgreSQL.Storage.Internal.NpgsqlExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)\r\n```\r\n\r\nLooking at log, the difference is that for TPH, EF generates INSERT:\r\n\r\n```\r\n      Executed DbCommand (6ms) [Parameters=[@p0='?' (DbType = Guid), @p1='?', @p2='?', @p3='?' (DbType = Guid)], CommandType='Text', CommandTimeout='30']\r\n      INSERT INTO \"ChildBaseEntity\" (\"Id\", \"ChildValue\", \"Discriminator\", \"ParentId\")\r\n      VALUES (@p0, @p1, @p2, @p3);\r\n```\r\n\r\nBut for TPC, EF generates UPDATE, even though the row was never inserted before:\r\n\r\n```\r\n      Executed DbCommand (8ms) [Parameters=[@p2='?' (DbType = Guid), @p0='?', @p1='?' (DbType = Guid)], CommandType='Text', CommandTimeout='30']\r\n      UPDATE \"ChildEntity\" SET \"ChildValue\" = @p0, \"ParentId\" = @p1\r\n      WHERE \"Id\" = @p2;\r\n```\r\n\r\nI have also verified this is issue on both PosgreSql and SqlServer.\r\n\r\n### Workaround\r\n\r\nAdding the child entity explicity fixes the issue and makes EF insert it as new entity.\r\n\r\n### Question\r\n\r\nIs this expected behavior?\r\nIf yes, is it possible to configure EF so it maps to table-per-concretetype and works correctly even without adding the new referenced entity explicitly?\r\n\r\n### Include provider and version information\r\n\r\nEF Core version: 7.0.12\r\nDatabase provider: PostgreSql, SqlServer\r\nTarget framework: .NET 7\r\nOperating system: Windows 10\r\nIDE: Rider 2023.2.2\r\n","closed_by":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/32084/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/32084/timeline","performed_via_github_app":null,"state_reason":"completed"}