{"url":"https://api.github.com/repos/dotnet/efcore/issues/30493","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/30493/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/30493/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/30493/events","html_url":"https://github.com/dotnet/efcore/issues/30493","id":1625988061,"node_id":"I_kwDOAPaMMs5g6pvd","number":30493,"title":"\"Where\" clause with \"!string.Contains\" produces incorrect SQL","user":{"login":"corthner","id":41489346,"node_id":"MDQ6VXNlcjQxNDg5MzQ2","avatar_url":"https://avatars.githubusercontent.com/u/41489346?v=4","gravatar_id":"","url":"https://api.github.com/users/corthner","html_url":"https://github.com/corthner","followers_url":"https://api.github.com/users/corthner/followers","following_url":"https://api.github.com/users/corthner/following{/other_user}","gists_url":"https://api.github.com/users/corthner/gists{/gist_id}","starred_url":"https://api.github.com/users/corthner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/corthner/subscriptions","organizations_url":"https://api.github.com/users/corthner/orgs","repos_url":"https://api.github.com/users/corthner/repos","events_url":"https://api.github.com/users/corthner/events{/privacy}","received_events_url":"https://api.github.com/users/corthner/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1675384372,"node_id":"MDU6TGFiZWwxNjc1Mzg0Mzcy","url":"https://api.github.com/repos/dotnet/efcore/labels/area-query","name":"area-query","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/152","html_url":"https://github.com/dotnet/efcore/milestone/152","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/152/labels","id":8392036,"node_id":"MI_kwDOAPaMMs4AgA1k","number":152,"title":"8.0.0","description":"EF Core 8.0","creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":280,"state":"closed","created_at":"2022-09-07T19:55:36Z","updated_at":"2025-04-07T08:59:46Z","due_on":null,"closed_at":"2023-11-14T14:00:33Z"},"comments":3,"created_at":"2023-03-15T17:46:01Z","updated_at":"2025-06-15T19:00:41Z","closed_at":"2023-08-16T19:39:49Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"When querying an entity string column using the expression \"**!string.Contains('somestring)**\"  the generated SQL does not account for (nor bring back) NULL string values.\r\n\r\nNormally I would simply change my expression to a working version like \"**string.Contains('somestring') == false**\" (which does work correctly) but the expression is not within my control.  Its wrapped up in a 3rd party tool that is applying \"!string.contains('somevalue')\" against the generic IQueryable interface.\r\n\r\nIs there anyway I can work around this issue at present?\r\n\r\n\r\nReproduction steps:\r\nUse the following table & data:\r\n```SQL\r\nSET ANSI_NULLS ON\r\nGO\r\n\r\nSET QUOTED_IDENTIFIER ON\r\nGO\r\n\r\nCREATE TABLE [dbo].[Test](\r\n\t[Id] [uniqueidentifier] NOT NULL,\r\n\t[Comment] [varchar](500) NULL,\r\n CONSTRAINT [PK_Test] PRIMARY KEY CLUSTERED \r\n(\r\n\t[Id] ASC\r\n)WITH (STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]\r\n) ON [PRIMARY]\r\nGO\r\n\r\nALTER TABLE [dbo].[Test] ADD  CONSTRAINT [DF_Test_Id]  DEFAULT (newid()) FOR [Id]\r\nGO\r\n\r\n\r\nINSERT INTO dbo.Test (Comment) VALUES ('Green tree');\r\nINSERT INTO dbo.Test (Comment) VALUES ('Blue frog');\r\nINSERT INTO dbo.Test (Comment) VALUES ('');\r\nINSERT INTO dbo.Test (Comment) VALUES (NULL);\r\nINSERT INTO dbo.Test (Comment) VALUES (NULL);\r\n```\r\nentity framework core model:\r\n```C#\r\n  modelBuilder.Entity<Test>(entity =>\r\n  {\r\n      entity.Property(e => e.Id).HasDefaultValueSql(\"(newid())\");\r\n\r\n      entity.Property(e => e.Comment)\r\n          .HasMaxLength(500)\r\n          .IsUnicode(false);\r\n  });\r\n```\r\n#### Expression 1, uses !string.Contains, (incorrect results)\r\n```C#\r\nvar w = _dbContext.Test.Where(x => !x.Comment.Contains(\"tree\")).ToList();\r\n```\r\ngenerates the SQL\r\n```SQL\r\nSELECT [t].[Id], [t].[Comment]\r\nFROM [Test] AS [t]\r\nWHERE NOT ([t].[Comment] LIKE '%tree%')\r\n```\r\nand results in\r\n| Id | Comment|\r\n| ----------- | ----------- |\r\n| 902B4451-0B5D-4453-8DE0-5DDA186934D3 |  |\r\n| A8F05A2D-FF33-4433-AAEF-AE6482E06A10 | Blue frog |\r\n* note: the records with Comment == NULL are not returned\r\n#### Expression 2, uses string.contans == false (correct results)\r\n```C#\r\nvar z = _dbContext.Test.Where(x => x.Comment.Contains(\"tree\") == false).ToList()\r\n```\r\ngenerates the SQL\r\n```SQL\r\nSELECT [t].[Id], [t].[Comment]\r\nFROM [Test] AS [t]\r\nWHERE CASE\r\n\tWHEN [t].[Comment] LIKE '%tree%' THEN CAST(1 AS bit)\r\n\tELSE CAST(0 AS bit)\r\nEND = CAST(0 AS bit)\r\n```\r\nand results in\r\n| Id | Comment|\r\n| ----------- | ----------- |\r\n|78B92B89-0CAC-4B72-9A65-5DC4619C3DFC | NULL |\r\n|902B4451-0B5D-4453-8DE0-5DDA186934D3 ||\r\n|A8F05A2D-FF33-4433-AAEF-AE6482E06A10\t| Blue frog|\r\n|82CD26CF-C205-4FDB-831C-D549C863E103|NULL|\r\n* note: the records with Comment == NULL ARE returned\r\n\r\n#### Expression 3, uses string.contans != true (correct results)\r\n```C#\r\nvar z = _dbContext.Test.Where(x => x.Comment.Contains(\"tree\") != true).ToList()\r\n```\r\ngenerates the SQL\r\n```SQL\r\nSELECT [t].[Id], [t].[Comment]\r\nFROM [Test] AS [t]\r\nWHERE CASE\r\n    WHEN [t].[Comment] LIKE '%tree%' THEN CAST(1 AS bit)\r\n    ELSE CAST(0 AS bit)\r\nEND <> CAST(1 AS bit) OR (CASE\r\n    WHEN [t].[Comment] LIKE '%tree%' THEN CAST(1 AS bit)\r\n    ELSE CAST(0 AS bit)\r\nEND IS NULL)\r\n```\r\nand results in\r\n| Id | Comment|\r\n| ----------- | ----------- |\r\n|78B92B89-0CAC-4B72-9A65-5DC4619C3DFC | NULL |\r\n|902B4451-0B5D-4453-8DE0-5DDA186934D3 ||\r\n|A8F05A2D-FF33-4433-AAEF-AE6482E06A10\t| Blue frog|\r\n|82CD26CF-C205-4FDB-831C-D549C863E103|NULL|\r\n* note: the records with Comment == NULL ARE returned\r\n\\\r\n\\\r\n\\\r\nEF Core version:  7.0.3, Microsoft.EntityFrameworkCore.Design (7.0.3)\r\nDatabase provider: Microsoft.EntityFrameworkCore.SqlServer (7.0.3)\r\nTarget framework: NET 6.0\r\nIDE: Visual Studio 2022 17.4.3\r\n\\\r\nThanks so much in advance, Cheers.\r\n","closed_by":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/30493/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/30493/timeline","performed_via_github_app":null,"state_reason":"completed"}