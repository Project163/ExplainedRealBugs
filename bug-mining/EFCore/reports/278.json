{"url":"https://api.github.com/repos/dotnet/efcore/issues/29638","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/29638/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/29638/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/29638/events","html_url":"https://github.com/dotnet/efcore/issues/29638","id":1458136367,"node_id":"I_kwDOAPaMMs5W6WUv","number":29638,"title":"GroupBy generates invalid SQL when using custom database function","user":{"login":"andreikarkkanen","id":103993161,"node_id":"U_kgDOBjLPSQ","avatar_url":"https://avatars.githubusercontent.com/u/103993161?v=4","gravatar_id":"","url":"https://api.github.com/users/andreikarkkanen","html_url":"https://github.com/andreikarkkanen","followers_url":"https://api.github.com/users/andreikarkkanen/followers","following_url":"https://api.github.com/users/andreikarkkanen/following{/other_user}","gists_url":"https://api.github.com/users/andreikarkkanen/gists{/gist_id}","starred_url":"https://api.github.com/users/andreikarkkanen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andreikarkkanen/subscriptions","organizations_url":"https://api.github.com/users/andreikarkkanen/orgs","repos_url":"https://api.github.com/users/andreikarkkanen/repos","events_url":"https://api.github.com/users/andreikarkkanen/events{/privacy}","received_events_url":"https://api.github.com/users/andreikarkkanen/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1017558838,"node_id":"MDU6TGFiZWwxMDE3NTU4ODM4","url":"https://api.github.com/repos/dotnet/efcore/labels/Servicing-approved","name":"Servicing-approved","color":"048708","default":false,"description":""},{"id":1675384372,"node_id":"MDU6TGFiZWwxNjc1Mzg0Mzcy","url":"https://api.github.com/repos/dotnet/efcore/labels/area-query","name":"area-query","color":"32b37b","default":false,"description":""},{"id":5092427335,"node_id":"LA_kwDOAPaMMs8AAAABL4hGRw","url":"https://api.github.com/repos/dotnet/efcore/labels/area-groupby","name":"area-groupby","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/181","html_url":"https://github.com/dotnet/efcore/milestone/181","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/181/labels","id":9968309,"node_id":"MI_kwDOAPaMMs4AmBq1","number":181,"title":"7.0.13","description":null,"creator":{"login":"rbhanda","id":30737530,"node_id":"MDQ6VXNlcjMwNzM3NTMw","avatar_url":"https://avatars.githubusercontent.com/u/30737530?v=4","gravatar_id":"","url":"https://api.github.com/users/rbhanda","html_url":"https://github.com/rbhanda","followers_url":"https://api.github.com/users/rbhanda/followers","following_url":"https://api.github.com/users/rbhanda/following{/other_user}","gists_url":"https://api.github.com/users/rbhanda/gists{/gist_id}","starred_url":"https://api.github.com/users/rbhanda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rbhanda/subscriptions","organizations_url":"https://api.github.com/users/rbhanda/orgs","repos_url":"https://api.github.com/users/rbhanda/repos","events_url":"https://api.github.com/users/rbhanda/events{/privacy}","received_events_url":"https://api.github.com/users/rbhanda/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":3,"state":"closed","created_at":"2023-09-26T17:19:17Z","updated_at":"2023-11-14T13:46:11Z","due_on":null,"closed_at":"2023-11-14T13:46:11Z"},"comments":5,"created_at":"2022-11-21T15:29:54Z","updated_at":"2025-06-15T18:56:01Z","closed_at":"2023-10-05T15:49:23Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"When executing the following query an exception is thrown\r\n\r\n```C#\r\nvar orderIds = new [] { Guid.NewGuid(), Guid.NewGuid() };\r\n\r\nvar orders = dbContext.Orders\r\n    .Where(c => dbContext.AsQueryable(orderIds).Contains(c.OrderId))\r\n    .Select(c => new\r\n    {\r\n        c.Project.Code,\r\n        c.Project.Revenue\r\n    })\r\n    .GroupBy(c => new\r\n    {\r\n        c.Code\r\n    })\r\n    .Select(c => new\r\n    {\r\n        c.Key.Code,\r\n        Sum = c.Sum(e => e.Revenue)\r\n    }).ToList();\r\n```\r\n`Microsoft.Data.SqlClient.SqlException (0x80131904): The multi-part identifier \"s.Value\" could not be bound.`\r\n\r\n```SQL\r\nexec sp_executesql N'SELECT [p].[Code], (\r\n    SELECT COALESCE(SUM([p1].[Revenue]), 0.0)\r\n    FROM [Orders] AS [o0]\r\n    INNER JOIN [Projects] AS [p0] ON [o0].[ProjectId] = [p0].[ProjectId]\r\n    INNER JOIN [Projects] AS [p1] ON [o0].[ProjectId] = [p1].[ProjectId]\r\n    WHERE EXISTS (\r\n        SELECT 1\r\n        FROM STRING_SPLIT(@__source_1, @__separator_2) AS [s0]\r\n        WHERE CONVERT(UNIQUEIDENTIFIER, [s0].[Value]) = [o0].[OrderId]) AND [p].[Code] = [p0].[Code]) AS [Sum]\r\nFROM [Orders] AS [o]\r\nINNER JOIN [Projects] AS [p] ON [o].[ProjectId] = [p].[ProjectId]\r\nWHERE EXISTS (\r\n    SELECT 1\r\n    FROM STRING_SPLIT(@__source_1, @__separator_2) AS [s0]\r\n    WHERE CONVERT(UNIQUEIDENTIFIER, [s].[Value]) = [o].[OrderId])\r\nGROUP BY [p].[Code]',N'@__source_1 nvarchar(4000),@__separator_2 nvarchar(4000)',@__source_1=N'7bd14254-eac8-413d-9328-2fda4725b690,e624c495-55dd-436a-8c62-6a7e49c8435d',@__separator_2=N','\r\n```\r\nThe incorrect part is\r\n```SQL\r\nWHERE CONVERT(UNIQUEIDENTIFIER, [s].[Value]) = [o].[OrderId]\r\n```\r\nThe .AsQueriable() solves a cache plan pollution problem. The full solution is in the attachment.\r\n\r\n[ConsoleApp1.zip](https://github.com/dotnet/efcore/files/10057762/ConsoleApp1.zip)\r\n\r\nOr\r\n```C#\r\nusing Microsoft.EntityFrameworkCore;\r\nusing Microsoft.EntityFrameworkCore.Query.SqlExpressions;\r\n\r\nvar optionsBuilder = new DbContextOptionsBuilder<TestContext>();\r\noptionsBuilder.UseSqlServer(\"Server=TestDb;Database=CustomerDb;Trusted_Connection=True;Encrypt=False;\");\r\n\r\nusing var dbContext = new TestContext(optionsBuilder.Options);\r\ndbContext.Database.EnsureDeleted();\r\ndbContext.Database.EnsureCreated();\r\n\r\nvar orderIds = new [] { Guid.NewGuid(), Guid.NewGuid() };\r\n\r\nvar orders = dbContext.Orders\r\n    .Where(c => dbContext.AsQueryable(orderIds).Contains(c.OrderId))\r\n    .Select(c => new\r\n    {\r\n        c.Project.Code,\r\n        c.Project.Revenue\r\n    })\r\n    .GroupBy(c => new\r\n    {\r\n        c.Code\r\n    })\r\n    .Select(c => new\r\n    {\r\n        c.Key.Code,\r\n        Sum = c.Sum(e => e.Revenue)\r\n    }).ToList();\r\n\r\npublic class Project\r\n{\r\n    public Guid ProjectId { get; set; }\r\n    public decimal Revenue { get; set; }\r\n    public string Code { get; set; }\r\n}\r\n\r\npublic class Order\r\n{\r\n    public Guid OrderId { get; set; }\r\n    public Guid ProjectId { get; set; }\r\n\r\n    public Project Project { get; set; }\r\n}\r\n\r\npublic class TestContext : DbContext\r\n{\r\n    public TestContext(DbContextOptions options)\r\n        : base(options)\r\n    {\r\n    }\r\n\r\n    public DbSet<Project> Projects { get; set; }\r\n    public DbSet<Order> Orders { get; set; }\r\n\r\n    protected override void OnModelCreating(ModelBuilder modelBuilder)\r\n    {\r\n        modelBuilder.ConfigureDbFunctions();\r\n    }\r\n\r\n    [Keyless]\r\n    private class StringSplitResult\r\n    {\r\n        public string Value { get; set; }\r\n    }\r\n        \r\n    [DbFunction(IsBuiltIn = true, Name = \"STRING_SPLIT\")]\r\n    private IQueryable<StringSplitResult> Split(string source, string separator)\r\n        => FromExpression(() => Split(source, separator));\r\n\r\n    public IQueryable<Guid> AsQueryable(IEnumerable<Guid> source)\r\n        => Split(string.Join(\",\", source.Select(x => Convert.ToString(x))), \",\")\r\n            .Select(s => DbFunctionExtensions.ToGuid(s.Value)!.Value);\r\n}\r\n\r\npublic static class DbFunctionExtensions\r\n{\r\n    public static Guid? ToGuid(string value) => throw new NotImplementedException();\r\n\r\n    public static void ConfigureDbFunctions(this ModelBuilder modelBuilder)\r\n\t{\r\n\t\tvar type = typeof(DbFunctionExtensions);\r\n\r\n        modelBuilder.HasDbFunction(type.GetMethod(nameof(ToGuid))!)\r\n\t\t\t.HasTranslation(t => new SqlFunctionExpression(\r\n\t\t\t\tfunctionName: \"CONVERT\",\r\n\t\t\t\targuments: new[] { new SqlFragmentExpression(\"UNIQUEIDENTIFIER\"), t[0] },\r\n\t\t\t\tnullable: true,\r\n\t\t\t\targumentsPropagateNullability: new[] { false, true },\r\n\t\t\t\ttypeof(Guid),\r\n\t\t\t\ttypeMapping: null))\r\n\t\t\t.IsBuiltIn();\r\n    }\r\n}\r\n```\r\nEnvironment details:\r\nEF Core: 7.0.0\r\nDatabase provider: Microsoft.EntityFrameworkCore.SqlServer\r\nTarget framework: .NET 7.0\r\nOperating system: Windows 10\r\nIDE: Visual Studio 2022 17.4.1\r\n","closed_by":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/29638/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/29638/timeline","performed_via_github_app":null,"state_reason":"completed"}