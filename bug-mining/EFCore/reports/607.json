{"url":"https://api.github.com/repos/dotnet/efcore/issues/35224","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/35224/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/35224/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/35224/events","html_url":"https://github.com/dotnet/efcore/issues/35224","id":2699146081,"node_id":"I_kwDOAPaMMs6g4bNh","number":35224,"title":"Cosmos: EF Core 9 fails to find document with '|' character in it's id","user":{"login":"mvaisanen","id":135060901,"node_id":"U_kgDOCAzdpQ","avatar_url":"https://avatars.githubusercontent.com/u/135060901?v=4","gravatar_id":"","url":"https://api.github.com/users/mvaisanen","html_url":"https://github.com/mvaisanen","followers_url":"https://api.github.com/users/mvaisanen/followers","following_url":"https://api.github.com/users/mvaisanen/following{/other_user}","gists_url":"https://api.github.com/users/mvaisanen/gists{/gist_id}","starred_url":"https://api.github.com/users/mvaisanen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mvaisanen/subscriptions","organizations_url":"https://api.github.com/users/mvaisanen/orgs","repos_url":"https://api.github.com/users/mvaisanen/repos","events_url":"https://api.github.com/users/mvaisanen/events{/privacy}","received_events_url":"https://api.github.com/users/mvaisanen/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1675384372,"node_id":"MDU6TGFiZWwxNjc1Mzg0Mzcy","url":"https://api.github.com/repos/dotnet/efcore/labels/area-query","name":"area-query","color":"32b37b","default":false,"description":""},{"id":1686778100,"node_id":"MDU6TGFiZWwxNjg2Nzc4MTAw","url":"https://api.github.com/repos/dotnet/efcore/labels/area-cosmos","name":"area-cosmos","color":"32b37b","default":false,"description":""},{"id":8130499638,"node_id":"LA_kwDOAPaMMs8AAAAB5J2UNg","url":"https://api.github.com/repos/dotnet/efcore/labels/preview-1","name":"preview-1","color":"ACB3D7","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/204","html_url":"https://github.com/dotnet/efcore/milestone/204","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/204/labels","id":11480673,"node_id":"MI_kwDOAPaMMs4Ary5h","number":204,"title":"10.0.0","description":"","creator":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":1,"closed_issues":193,"state":"open","created_at":"2024-08-23T12:48:26Z","updated_at":"2025-11-05T08:24:30Z","due_on":null,"closed_at":null},"comments":6,"created_at":"2024-11-27T16:45:35Z","updated_at":"2025-02-10T22:11:53Z","closed_at":"2025-01-04T01:48:03Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I'm working on a project which for legacy reasons have lots of documents with the '|' character in their id. To be precise, these used to be '/' in another database and since cosmos doesnt support those, they were converted to '|'. There needs to be some special character in the id as parts of business logic relies on that (and converting the id to base64 would make other matters difficult).\n\nUp until EF Core 9 they worked fine (EF Core 8.0.11 works). However, when upgrading to EF Core 9, these documents cannot be found by the framework. Here is a small .NET 8 console app demonstrating the issue. Example run against Cosmos DB Emulator database \"TestDatabase\", Autoscale max 4000 RU/s, having 1 container \"TestContainer\" with partition key \"/id\".\n\nProgram.cs\n```C#\nusing Microsoft.EntityFrameworkCore;\n\nnamespace CosmosTestingApp\n{\n    internal class Program\n    {\n        static void Main(string[] args)\n        {\n            DoWork().GetAwaiter().GetResult();\n\n            Console.ReadKey();\n        }\n\n        private static async Task<int> DoWork()\n        {\n            var endpoint = \"https://localhost:8081\";\n            var cosmosKey = \"C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw==\";\n            var DbName = \"TestDatabase\";\n\n            using (var ctx = new PetContext(new DbContextOptionsBuilder<PetContext>().LogTo(Console.WriteLine).UseCosmos(endpoint, cosmosKey, DbName).Options))\n            {\n                ctx.Cats.Add(new Cat() { Id = \"Cat|1\", Name = \"First Cat\" });\n                ctx.Cats.Add(new Cat() { Id = \"Cat2\", Name = \"Second Cat\" });\n                await ctx.SaveChangesAsync();\n            }\n\n            using (var ctx2 = new PetContext(new DbContextOptionsBuilder<PetContext>().LogTo(Console.WriteLine).UseCosmos(endpoint, cosmosKey, DbName).Options))\n            {\n                var cat2 = await ctx2.Cats.Where(c => c.Id == \"Cat2\").SingleAsync();\n                Console.WriteLine($\"Cat name: {cat2.Name}\");\n                var cat1 = await ctx2.Cats.Where(c => c.Id == \"Cat|1\").SingleAsync();\n                Console.WriteLine($\"Cat name: {cat1.Name}\");\n            }\n\n            return 0;\n        }\n    }\n}\n```\n\nPetContext.cs\n```C#\nusing Microsoft.EntityFrameworkCore;\n\nnamespace CosmosTestingApp\n{\n    public class PetContext: DbContext\n    {\n        public PetContext(DbContextOptions<PetContext> options) : base(options)\n        {\n        }\n\n        public DbSet<Cat> Cats { get; set; }\n\n        protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)\n        {\n            optionsBuilder.EnableSensitiveDataLogging();\n        }\n\n        protected override void OnModelCreating(ModelBuilder modelBuilder)\n        {\n            base.OnModelCreating(modelBuilder);\n\n            modelBuilder.Entity<Cat>(e =>\n            {\n                e.ToContainer(\"TestContainer\");\n                e.HasPartitionKey(s => s.Id);\n                e.HasDiscriminator<string>(\"Discriminator\");\n            });\n        }\n    }\n}\n```\n\nPet.cs\n```C#\nnamespace CosmosTestingApp\n{\n    public class Cat\n    {\n        public string Id { get; set; }\n        public string Name { get; set; }\n        public string Discriminator { get; set; }\n    }\n}\n```\n.csproj\n```C#\n<Project Sdk=\"Microsoft.NET.Sdk\">\n\n  <PropertyGroup>\n    <OutputType>Exe</OutputType>\n    <TargetFramework>net8.0</TargetFramework>\n    <ImplicitUsings>enable</ImplicitUsings>\n    <Nullable>enable</Nullable>\n  </PropertyGroup>\n\n  <ItemGroup>\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.Cosmos\" Version=\"9.0.0\" />\n  </ItemGroup>\n\n</Project>\n```\n\nWhen running the app, second cat is found as expected, but query against the first fails with \"Sequence contains no elements\". Doesnt work with FindAsync() etc either. Examining the logs, it seems EF Core inserts an extra '^' character to the id of the first cat query, which explains why it fails on db level.\n\n```\ndbug: 27.11.2024 18:19:45.154 CoreEventId.QueryCompilationStarting[10111] (Microsoft.EntityFrameworkCore.Query)\n      Compiling query expression:\n      'DbSet<Cat>()\n          .Where(c => c.Id == \"Cat2\")\n          .Single()'\ndbug: 27.11.2024 18:19:45.390 CoreEventId.QueryExecutionPlanned[10107] (Microsoft.EntityFrameworkCore.Query)\n      Generated query execution expression:\n      'queryContext => ShapedQueryCompilingExpressionVisitor.SingleAsync<Cat>(\n          asyncEnumerable: new ReadItemQueryingEnumerable<Cat>(\n              (CosmosQueryContext)queryContext,\n              EntityType: Cat,\n              List<Expression> { [Cosmos.Query.Internal.SqlConstantExpression] },\n              ReadItemInfo,\n              Func<QueryContext, JToken, Cat>,\n              CosmosTestingApp.PetContext,\n              False,\n              True\n          ),\n          cancellationToken: queryContext.CancellationToken)'\ninfo: 27.11.2024 18:19:45.408 CosmosEventId.ExecutingReadItem[30101] (Microsoft.EntityFrameworkCore.Database.Command)\n      Reading resource 'Cat2' item from container 'TestContainer' in partition '[\"Cat2\"]'.\n\n<SNIP>\n\ndbug: 27.11.2024 18:19:47.904 CoreEventId.QueryCompilationStarting[10111] (Microsoft.EntityFrameworkCore.Query)\n      Compiling query expression:\n      'DbSet<Cat>()\n          .Where(c => c.Id == \"Cat|1\")\n          .Single()'\ndbug: 27.11.2024 18:19:47.915 CoreEventId.QueryExecutionPlanned[10107] (Microsoft.EntityFrameworkCore.Query)\n      Generated query execution expression:\n      'queryContext => ShapedQueryCompilingExpressionVisitor.SingleAsync<Cat>(\n          asyncEnumerable: new ReadItemQueryingEnumerable<Cat>(\n              (CosmosQueryContext)queryContext,\n              EntityType: Cat,\n              List<Expression> { [Cosmos.Query.Internal.SqlConstantExpression] },\n              ReadItemInfo,\n              Func<QueryContext, JToken, Cat>,\n              CosmosTestingApp.PetContext,\n              False,\n              True\n          ),\n          cancellationToken: queryContext.CancellationToken)'\ninfo: 27.11.2024 18:19:47.919 CosmosEventId.ExecutingReadItem[30101] (Microsoft.EntityFrameworkCore.Database.Command)\n      Reading resource 'Cat^|1' item from container 'TestContainer' in partition '[\"Cat|1\"]'.\n```\n\nI'm aware of the recommendation to use only alphanumeric ids (https://learn.microsoft.com/en-us/azure/cosmos-db/concepts-limits), however this used to work ok on earlier versions, and still works just fine when running manual queries against cosmos. The issue seems to be just that EF Core corrupts the id intended to be queried. However, as the example shows, even saving works just fine.\n\n### Provider and version information\nEF Core version: 9.0.0\nDatabase provider: Microsoft.EntityFrameworkCore.Cosmos\nTarget framework: NET 8.0\nOperating system: Win10 Enterprise\nIDE: Visual Studio 2022 17.9.4\n","closed_by":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/35224/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/35224/timeline","performed_via_github_app":null,"state_reason":"completed"}