{"url":"https://api.github.com/repos/dotnet/efcore/issues/30818","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/30818/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/30818/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/30818/events","html_url":"https://github.com/dotnet/efcore/issues/30818","id":1693886605,"node_id":"I_kwDOAPaMMs5k9qiN","number":30818,"title":"Convert.ToInt32 could not be translated when argument is user-defined function","user":{"login":"LaXiS96","id":8070973,"node_id":"MDQ6VXNlcjgwNzA5NzM=","avatar_url":"https://avatars.githubusercontent.com/u/8070973?v=4","gravatar_id":"","url":"https://api.github.com/users/LaXiS96","html_url":"https://github.com/LaXiS96","followers_url":"https://api.github.com/users/LaXiS96/followers","following_url":"https://api.github.com/users/LaXiS96/following{/other_user}","gists_url":"https://api.github.com/users/LaXiS96/gists{/gist_id}","starred_url":"https://api.github.com/users/LaXiS96/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/LaXiS96/subscriptions","organizations_url":"https://api.github.com/users/LaXiS96/orgs","repos_url":"https://api.github.com/users/LaXiS96/repos","events_url":"https://api.github.com/users/LaXiS96/events{/privacy}","received_events_url":"https://api.github.com/users/LaXiS96/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1382547263,"node_id":"MDU6TGFiZWwxMzgyNTQ3MjYz","url":"https://api.github.com/repos/dotnet/efcore/labels/good%20first%20issue","name":"good first issue","color":"fef2c0","default":true,"description":"This issue should be relatively straightforward to fix."},{"id":1675384372,"node_id":"MDU6TGFiZWwxNjc1Mzg0Mzcy","url":"https://api.github.com/repos/dotnet/efcore/labels/area-query","name":"area-query","color":"32b37b","default":false,"description":""},{"id":2402623482,"node_id":"MDU6TGFiZWwyNDAyNjIzNDgy","url":"https://api.github.com/repos/dotnet/efcore/labels/community-contribution","name":"community-contribution","color":"004caa","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/180","html_url":"https://github.com/dotnet/efcore/milestone/180","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/180/labels","id":9963267,"node_id":"MI_kwDOAPaMMs4AmAcD","number":180,"title":"9.0.0","description":null,"creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":339,"state":"closed","created_at":"2023-09-25T15:41:58Z","updated_at":"2025-04-01T18:19:15Z","due_on":null,"closed_at":"2024-11-14T11:54:05Z"},"comments":7,"created_at":"2023-05-03T11:25:00Z","updated_at":"2025-06-15T19:02:21Z","closed_at":"2024-06-05T11:17:39Z","author_association":"NONE","type":{"id":1092406,"node_id":"IT_kwDOAIt-yc4AEKs2","name":"Feature","description":"A request, idea, or new functionality","color":"blue","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-10-08T09:10:05Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hello,\r\nI am refactoring/rewriting an application which has been using EFCore since around 2.0 and stores `Dictionary<string, object?>` entity properties as JSON string columns in SQL Server.\r\nThe original implementation abused internal EFCore classes to rewrite dictionary accesses to `JSON_VALUE` SQL functions, among other things. I have now switched to EFCore 7.0, using value converters and interceptors to try and achieve the same (and more) functionality, but I'm getting stuck somewhere.\r\nI cannot use the recently introduced JSON columns support because my dictionaries are dynamic and cannot be mapped to a static model.\r\n\r\nI have a `JsonDictionary` class which extends `Dictionary<string, object?>` and implements equality interfaces and overrides, plus value converter and comparer for JSON serialization and change tracking. CRUD operations on the `DbContext` are working as expected.\r\n\r\nMy entity looks like this:\r\n```csharp\r\npublic class Entity {\r\n    public JsonDictionary Dictionary { get; private set; }\r\n}\r\n```\r\n\r\nI need to filter values within the Dictionary property in SQL, which is why I configured this user defined function for `JSON_VALUE`:\r\n```csharp\r\n// Function method:\r\nstring? JsonValue(object propertyReference, string path)\r\n    => throw new InvalidOperationException(\"This function call should have been translated to SQL!\");\r\n\r\n// Function configuration:\r\nmodelBuilder.HasDbFunction(JsonValue, builder =>\r\n{\r\n    builder.HasName(\"JSON_VALUE\").IsBuiltIn();\r\n    // https://github.com/dotnet/efcore/issues/28393#issuecomment-1181498610\r\n    builder.HasParameter(\"propertyReference\").HasStoreType(\"nvarchar(max)\");\r\n    builder.HasParameter(\"path\");\r\n});\r\n```\r\n\r\nI then have an `IQueryExpressionInterceptor` which replaces calls to dictionary indexers and `get_Item` with calls to `JsonValue` defined above.\r\nFor example, `entity.Dictionary[\"key\"]` is translated to `JsonValue(entity.Dictionary, $\"$.\\\"key\\\"\")` within the LINQ expression tree.\r\n\r\nHere is the issue I am having, this works as expected:\r\n```csharp\r\ncontext.Set<Entity>.Where(s => s.Dictionary[\"test\"] == (object)1234).ToList();\r\n```\r\nwhile this doesn't:\r\n```csharp\r\ncontext.Set<Entity>.Where(s => Convert.ToInt32(s.Dictionary[\"test\"]) == 1234).ToList();\r\n```\r\n\r\nThe Expression DebugView after my interceptor in the former case is:\r\n```\r\n.Call System.Linq.Queryable.Where(\r\n    .Extension<Microsoft.EntityFrameworkCore.Query.EntityQueryRootExpression>,\r\n    '(.Lambda #Lambda1<System.Func`2[Entity,System.Boolean]>))\r\n\r\n.Lambda #Lambda1<System.Func`2[Entity,System.Boolean]>(Entity $s)\r\n{\r\n    .Call DbFunctionsExtensions.JsonValue($s.Properties, \"$.\"test\"\") == (System.Object)1234\r\n}\r\n```\r\nwhile for the latter it is:\r\n```\r\n.Call System.Linq.Queryable.Where(\r\n    .Extension<Microsoft.EntityFrameworkCore.Query.EntityQueryRootExpression>,\r\n    '(.Lambda #Lambda1<System.Func`2[Entity,System.Boolean]>))\r\n\r\n.Lambda #Lambda1<System.Func`2[Entity,System.Boolean]>(Entity $s)\r\n{\r\n    .Call System.Convert.ToInt32(.Call DbFunctionsExtensions.JsonValue($s.Properties, \"$.\"test\"\")) == 1234\r\n}\r\n```\r\nand this is the exception I get in this case:\r\n```\r\nSystem.InvalidOperationException: The LINQ expression 'DbSet<Entity>()\r\n    .Where(s => Convert.ToInt32(DbFunctionsExtensions.JsonValue(\r\n        propertyReference: s.Properties,\r\n        path: \"$.\"test\"\")) == 1234)' could not be translated. Additional information: Translation of method 'System.Convert.ToInt32' failed. If this method can be mapped to your custom function, see https://go.microsoft.com/fwlink/?linkid=2132413 for more information. Either rewrite the query in a form that can be translated, or switch to client evaluation explicitly by inserting a call to 'AsEnumerable', 'AsAsyncEnumerable', 'ToList', or 'ToListAsync'. See https://go.microsoft.com/fwlink/?linkid=2101038 for more information.\r\n   at Microsoft.EntityFrameworkCore.Query.QueryableMethodTranslatingExpressionVisitor.<VisitMethodCall>g__CheckTranslated|15_0(ShapedQueryExpression translated, <>c__DisplayClass15_0& )\r\n   at Microsoft.EntityFrameworkCore.Query.QueryableMethodTranslatingExpressionVisitor.VisitMethodCall(MethodCallExpression methodCallExpression)\r\n   at Microsoft.EntityFrameworkCore.Query.RelationalQueryableMethodTranslatingExpressionVisitor.VisitMethodCall(MethodCallExpression methodCallExpression)\r\n   at System.Linq.Expressions.MethodCallExpression.Accept(ExpressionVisitor visitor)\r\n   at System.Linq.Expressions.ExpressionVisitor.Visit(Expression node)\r\n   at Microsoft.EntityFrameworkCore.Query.QueryCompilationContext.CreateQueryExecutor[TResult](Expression query)\r\n   at Microsoft.EntityFrameworkCore.Storage.Database.CompileQuery[TResult](Expression query, Boolean async)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.CompileQueryCore[TResult](IDatabase database, Expression query, IModel model, Boolean async)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.<>c__DisplayClass9_0`1.<Execute>b__0()\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.CompiledQueryCache.GetOrAddQuery[TResult](Object cacheKey, Func`1 compiler)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.Execute[TResult](Expression query)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.EntityQueryProvider.Execute[TResult](Expression expression)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.EntityQueryable`1.GetEnumerator()\r\n   at System.Collections.Generic.List`1..ctor(IEnumerable`1 collection)\r\n   at System.Linq.Enumerable.ToList[TSource](IEnumerable`1 source)\r\n   at ConsoleApp1.Program.Main(String[] args) in C:\\Users\\me\\Source\\Repos\\ConsoleApp1\\Program.cs:line 54\r\n   at ConsoleApp1.Program.<Main>(String[] args)\r\n```\r\n\r\nI was expecting `Convert.ToInt32(entity.Dictionary[\"key\"]) == value` to be translated to `CONVERT(int, JSON_VALUE([Dictionary], '$.\"key\"')) = @value` or something along those lines.\r\nWhy does EFCore complain about not being able to translate `Convert.ToInt32` calls (which should be supported by the SQL Server provider according to documentation)?\r\nIs there something wrong with my database function setup?\r\n\r\nThank you for any insight you might have\r\n\r\n### Include provider and version information\r\n\r\nEF Core version: 7.0\r\nDatabase provider: Microsoft.EntityFrameworkCore.SqlServer 7.0.5\r\nTarget framework: net6.0\r\nOperating system: Windows 10\r\nIDE: Visual Studio 2022 17.5.5","closed_by":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/30818/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/30818/timeline","performed_via_github_app":null,"state_reason":"completed"}