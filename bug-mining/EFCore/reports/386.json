{"url":"https://api.github.com/repos/dotnet/efcore/issues/32558","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/32558/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/32558/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/32558/events","html_url":"https://github.com/dotnet/efcore/issues/32558","id":2032445053,"node_id":"I_kwDOAPaMMs55JKZ9","number":32558,"title":"Look into making SelectExpression (more) immutable, getting rid of TableReferenceExpression","user":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1675384372,"node_id":"MDU6TGFiZWwxNjc1Mzg0Mzcy","url":"https://api.github.com/repos/dotnet/efcore/labels/area-query","name":"area-query","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/180","html_url":"https://github.com/dotnet/efcore/milestone/180","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/180/labels","id":9963267,"node_id":"MI_kwDOAPaMMs4AmAcD","number":180,"title":"9.0.0","description":null,"creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":339,"state":"closed","created_at":"2023-09-25T15:41:58Z","updated_at":"2025-04-01T18:19:15Z","due_on":null,"closed_at":"2024-11-14T11:54:05Z"},"comments":3,"created_at":"2023-12-08T11:03:47Z","updated_at":"2025-06-15T19:55:39Z","closed_at":"2024-01-18T07:56:40Z","author_association":"MEMBER","type":{"id":1092406,"node_id":"IT_kwDOAIt-yc4AEKs2","name":"Feature","description":"A request, idea, or new functionality","color":"blue","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-10-08T09:10:05Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Our ColumnExpressions currently reference their tables via TableReferenceExpressions, which are themselves mutable; this is the source of many bugs, e.g. when the SelectExpression is copied (e.g. when a visitor changes something inside), but the columns remain shared between the two copies, causing various referential integrity problems (e.g. #32234). This system also adds substantial complexity to keep everything in sync, again adding a source of bugs.\r\n\r\nTo simplify this, we'll consider removing TableReferenceExpression altogether, and have ColumnExpression reference its TableExpressionBase via its string alias only; there would be no actual .NET reference  between the column and the table.\r\n\r\n* This makes the SQL tree **almost** immutable\r\n    * SelectExpression still has a temporary mutable mode during translation - this is orthogonal to the table/column relationship and their mutability.\r\n    * At the moment, the table alias is a property on TableExpressionBase; there's no easy way to immutably change that alias - it's a mutable property. We need to make that immutable as well.\r\n* Any visitor that needs the actual TableExpressionBase given a ColumnExpression would need to track aliases/tables as part of its state and perform lookups.\r\n    * This effectively moves the referential relationship between column and table out of the expression tree, and into visitor state, which is temporary/point-in-time.\r\n    * There are only a few such actual needs; the type mapping inference visitor is one, and the pruner makes an optional use of this as well. In any case, the additional work for tracking alias/table mappings is negligible and does not add any considerable complexity.\r\n* Once we're fully immutable, we can consider removing expression cloning altogether. We may still decide to continue doing it only so that cloned fragments inside the same tree have different table aliases (though note that we've never had fully unique aliases in the tree). Note that we'd ideally stop having cloned duplicates within the same query tree (i.e. GroupBy), at which point this will become totally moot. \r\n* Note that this depends on a change in how we manage aliases (see [#32784](https://github.com/dotnet/efcore/issues/32784)).\r\n    * Currently, we generate temporary aliases for tables created in SQL fragments, and then run a uniquifying visitor when that fragment is added to a SelectExpression in the tree (predicate, ordering...).\r\n    * This \"late\" alias uniquification would require us to also replace all columns referencing the table (and is generally inefficient even without that).\r\n    * Instead, we should generate a unique alias up-front, and pass it to the table when it's created, not changing it later (except for post-processing, at which point we'd need a pass to rewrite the referencing columns).\r\n\r\nNote that we considered two alternatives:\r\n\r\n* Have ColumnExpression directly reference its TableExpressionBase (without TableReferenceExpression).\r\n    * This is also a fully immutable model; but it means that any change to a TableExpressionBase requires a additional recursive visit to all the SelectExpression's clauses to replace any ColumnExpressions (and their containing expressions). Recall that a table can be a SELECT subquery, at which point any modification within would trigger such a recursive rewrite. This is quite a heavy alternative.\r\n    * Referencing the table via its alias is a bit similar, but only requires recursive rewriting when the alias changes, and otherwies allows effort-less replacing of tables. The only visitor which currently modifies aliases is the alias manager post-processor (which closes alias gaps due to e.g. truncated tables); this seems very acceptable (and the postprocessing step is also completely optional/esthetic).\r\n* Keep TableReferenceExpression, but make it owned by TableExpressionBase rather than the SelectExpression\r\n    * Each TableExpressionBase would reference its TableReferenceExpression.\r\n    * When a table needs to be replaced, we go to the old table's TRE and set it to point to the new table. Crucially, the new table must also share the same TRE from the moment it's created, to ensure that we don't have two TREs.\r\n    * This would resolve a lot of the book-keeping and complexity concerns associated with maintaining a list of TableReferenceExpressions on SelectExpression, mirroring the list of tables.\r\n    * This keeps the SQL tree mutable, meaning that we need to clone to reuse, etc.\r\n\r\nNote that this has nothing to do with the SelectExpression having a \"mutable mode\", where its projection hasn't yet been applied (that's completely orthogonal to this).","closed_by":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/32558/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/32558/timeline","performed_via_github_app":null,"state_reason":"completed"}