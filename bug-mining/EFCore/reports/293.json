{"url":"https://api.github.com/repos/dotnet/efcore/issues/29156","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/29156/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/29156/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/29156/events","html_url":"https://github.com/dotnet/efcore/issues/29156","id":1378540753,"node_id":"I_kwDOAPaMMs5SKtzR","number":29156,"title":"TemporalAll for temporal owned entities mapped to parent table.","user":{"login":"fiseni","id":24314310,"node_id":"MDQ6VXNlcjI0MzE0MzEw","avatar_url":"https://avatars.githubusercontent.com/u/24314310?v=4","gravatar_id":"","url":"https://api.github.com/users/fiseni","html_url":"https://github.com/fiseni","followers_url":"https://api.github.com/users/fiseni/followers","following_url":"https://api.github.com/users/fiseni/following{/other_user}","gists_url":"https://api.github.com/users/fiseni/gists{/gist_id}","starred_url":"https://api.github.com/users/fiseni/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fiseni/subscriptions","organizations_url":"https://api.github.com/users/fiseni/orgs","repos_url":"https://api.github.com/users/fiseni/repos","events_url":"https://api.github.com/users/fiseni/events{/privacy}","received_events_url":"https://api.github.com/users/fiseni/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":4528277234,"node_id":"LA_kwDOAPaMMs8AAAABDegG8g","url":"https://api.github.com/repos/dotnet/efcore/labels/area-temporal-tables","name":"area-temporal-tables","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/152","html_url":"https://github.com/dotnet/efcore/milestone/152","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/152/labels","id":8392036,"node_id":"MI_kwDOAPaMMs4AgA1k","number":152,"title":"8.0.0","description":"EF Core 8.0","creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":280,"state":"closed","created_at":"2022-09-07T19:55:36Z","updated_at":"2025-04-07T08:59:46Z","due_on":null,"closed_at":"2023-11-14T14:00:33Z"},"comments":3,"created_at":"2022-09-19T21:24:28Z","updated_at":"2025-06-15T18:53:25Z","closed_at":"2023-10-12T19:18:34Z","author_association":"NONE","type":{"id":1092406,"node_id":"IT_kwDOAIt-yc4AEKs2","name":"Feature","description":"A request, idea, or new functionality","color":"blue","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-10-08T09:10:05Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hi All,\r\n\r\nThere are several related issues, but I couldn't find any issue on this specific topic. I apologize if it's a duplicate.\r\nI read the conversations. I do see the point regarding data inconsistencies in cases where we have to include the navigations, especially from non-temporal tables. But, how about this scenario (which is very common)\r\n\r\n- I have defined an owned entity mapped to the same parent table.\r\n- The parent entity is defined as temporal.\r\n- The owned entity is defined as temporal.\r\n- Both, the parent and owned entity have mapped the period properties to the same columns (it's an EF requirement actually).\r\n\r\nIssues:\r\n- I can't use TemporalAll (with or without projection).\r\n- I can't get correct data even with a raw query.\r\n- I can't even exclude the navigation (since it's an owned entity).\r\n\r\nIt would be great if we can get any solution. I mean even some workaround. I'm open to any ideas from the team and community.\r\n\r\n### Environment\r\n\r\n.NET SDK (reflecting any global.json):\r\n Version:   6.0.400\r\n Commit:    7771abd614\r\n \r\nMicrosoft.EntityFrameworkCore.SqlServer\r\n Version:   \"7.0.0-rc.1.22426.7\"\r\n\r\n### Full sample (ready to run). I listed 6 possible options.\r\n\r\n```c#\r\nusing Microsoft.EntityFrameworkCore;\r\nusing System.Text.Json;\r\n\r\nawait SeedAsync();\r\n\r\n//await Read_Version1(); // Throws\r\n//await Read_Version2(); // Throws\r\n//await Read_Version3(); // Throws\r\nawait Read_Version4();\r\nawait Read_Version5();\r\nawait Read_Version6();\r\n\r\n\r\n/// Throws an exception.\r\n/// Navigation expansion is only supported for 'AsOf' temporal operation. For other operations use join manually.\r\nasync Task Read_Version1()\r\n{\r\n    using var dbContext = new AppDbContext();\r\n\r\n    var customers = await dbContext.Customers\r\n        .TemporalAll()\r\n        .ToListAsync();\r\n\r\n    Print(customers);\r\n}\r\n\r\n/// Throws with projection too.\r\n/// Navigation expansion is only supported for 'AsOf' temporal operation. For other operations use join manually.\r\nasync Task Read_Version2()\r\n{\r\n    using var dbContext = new AppDbContext();\r\n\r\n    var customers = await dbContext.Customers\r\n        .TemporalAll()\r\n        .Select(x => new\r\n        {\r\n            Id = x.Id,\r\n            Name = x.Name,\r\n            Email = x.Contact.Email,\r\n            PeriodStart = EF.Property<DateTime>(x, \"PeriodStart\"),\r\n            PeriodEnd = EF.Property<DateTime>(x, \"PeriodEnd\")\r\n        })\r\n        .ToListAsync();\r\n\r\n    Print(customers);\r\n}\r\n\r\n/// Throws an exception (since both the parent and the owned entity contain these columns).\r\n/// The column 'PeriodEnd' was specified multiple times for 'c'.\r\nasync Task Read_Version3()\r\n{\r\n    var table = \"Customers\";\r\n    using var dbContext = new AppDbContext();\r\n\r\n    var queryString = dbContext.Customers.ToQueryString();\r\n\r\n    var sql = queryString.Replace($\"[{table}]\", $\"[{table}] FOR SYSTEM_TIME ALL\");\r\n    var data = await dbContext.Customers\r\n        .FromSqlRaw(sql)\r\n        .AsNoTracking()\r\n        .ToListAsync();\r\n\r\n    Print(data);\r\n}\r\n\r\n/// Returns incorrect data. It return 3 records, and all of them have \"Email1_Updated\" value for Email.\r\n/// It takes only the recent values of the owned type and assigns to all records.\r\n/// Also, PeriodStart and PeriodEnd are omitted from the results. \r\n/// I assume since FromSqlRaw operates on Set<Customer>, and those are shadow fields only?\r\nasync Task Read_Version4()\r\n{\r\n    var table = \"Customers\";\r\n    using var dbContext = new AppDbContext();\r\n\r\n    var queryString = dbContext.Customers\r\n        .Select(x => new\r\n        {\r\n            Id = x.Id,\r\n            Name = x.Name,\r\n            Email = x.Contact.Email,\r\n            PeriodStart = EF.Property<DateTime>(x, \"PeriodStart\"),\r\n            PeriodEnd = EF.Property<DateTime>(x, \"PeriodEnd\")\r\n        })\r\n        .ToQueryString();\r\n\r\n    var sql = queryString.Replace($\"[{table}]\", $\"[{table}] FOR SYSTEM_TIME ALL\");\r\n    var data = await dbContext.Customers\r\n        .FromSqlRaw(sql)\r\n        .AsNoTracking()\r\n        .ToListAsync();\r\n\r\n    Print(data);\r\n}\r\n\r\n/// Same issues as version 4.\r\nasync Task Read_Version5()\r\n{\r\n    using var dbContext = new AppDbContext();\r\n\r\n    var data = await dbContext.Customers\r\n        .FromSqlRaw(\"SELECT [c].[Id], [c].[Name], [c].[Contact_Email], [c].[PeriodStart], [c].[PeriodEnd] FROM [Customers] FOR SYSTEM_TIME ALL AS [c]\")\r\n        .AsNoTracking()\r\n        .ToListAsync();\r\n\r\n    Print(data);\r\n}\r\n\r\n/// Finally PeriodStart and PeriodEnd are projected to the result.\r\n/// The Email values are still incorrect.\r\nasync Task Read_Version6()\r\n{\r\n    using var dbContext = new AppDbContext();\r\n\r\n    var data = await dbContext.Customers\r\n        .FromSqlRaw(\"SELECT [c].[Id], [c].[Name], [c].[Contact_Email], [c].[PeriodStart], [c].[PeriodEnd] FROM [Customers] FOR SYSTEM_TIME ALL AS [c]\")\r\n        .Select(x => new\r\n        {\r\n            Id = x.Id,\r\n            Name = x.Name,\r\n            Email = x.Contact.Email,\r\n            PeriodStart = EF.Property<DateTime>(x, \"PeriodStart\"),\r\n            PeriodEnd = EF.Property<DateTime>(x, \"PeriodEnd\")\r\n        })\r\n        .ToListAsync();\r\n\r\n    Print(data);\r\n}\r\n\r\n\r\nasync Task SeedAsync()\r\n{\r\n    using var dbContext = new AppDbContext();\r\n    await dbContext.Database.EnsureDeletedAsync();\r\n    await dbContext.Database.EnsureCreatedAsync();\r\n    var customer = new Customer\r\n    {\r\n        Name = \"Customer1\",\r\n        Contact = new Contact { Email = \"Email1\" }\r\n    };\r\n    dbContext.Customers.Add(customer);\r\n    await dbContext.SaveChangesAsync();\r\n\r\n    customer.Name = \"Customer1_Updated\";\r\n    await dbContext.SaveChangesAsync();\r\n\r\n    customer.Contact.Email = \"Email1_Updated\";\r\n    await dbContext.SaveChangesAsync();\r\n}\r\n\r\nstatic void Print<T>(T data)\r\n{\r\n    var result = JsonSerializer.Serialize(data, new JsonSerializerOptions\r\n    {\r\n        WriteIndented = true\r\n    });\r\n\r\n    Console.WriteLine(result);\r\n}\r\n\r\nclass AppDbContext : DbContext\r\n{\r\n    public DbSet<Customer> Customers => Set<Customer>();\r\n\r\n    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)\r\n    {\r\n        optionsBuilder.UseSqlServer(\"Data Source=(localdb)\\\\MSSQLLocalDB;Initial Catalog=EFTemporalDemo;Integrated Security=SSPI;ConnectRetryCount=0;\");\r\n    }\r\n\r\n    protected override void OnModelCreating(ModelBuilder modelBuilder)\r\n    {\r\n        modelBuilder.Entity<Customer>().ToTable(x => x.IsTemporal());\r\n        modelBuilder.Entity<Customer>().Property<DateTime>(\"PeriodStart\").HasColumnName(\"PeriodStart\");\r\n        modelBuilder.Entity<Customer>().Property<DateTime>(\"PeriodEnd\").HasColumnName(\"PeriodEnd\");\r\n\r\n        modelBuilder.Entity<Customer>().OwnsOne(x => x.Contact, cb =>\r\n        {\r\n            cb.ToTable(x => x.IsTemporal());\r\n            cb.Property<DateTime>(\"PeriodStart\").HasColumnName(\"PeriodStart\");\r\n            cb.Property<DateTime>(\"PeriodEnd\").HasColumnName(\"PeriodEnd\");\r\n        });\r\n    }\r\n}\r\n\r\nclass Customer\r\n{\r\n    public int Id { get; set; }\r\n    public string? Name { get; set; }\r\n    public Contact Contact { get; set; } = default!;\r\n}\r\n\r\nclass Contact\r\n{\r\n    public string? Email { get; set; }\r\n}\r\n```","closed_by":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/29156/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/29156/timeline","performed_via_github_app":null,"state_reason":"completed"}