{"url":"https://api.github.com/repos/dotnet/efcore/issues/28377","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/28377/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/28377/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/28377/events","html_url":"https://github.com/dotnet/efcore/issues/28377","id":1296054506,"node_id":"I_kwDOAPaMMs5NQDjq","number":28377,"title":"Identity Annotation is not updated by migration","user":{"login":"wdhenrik","id":75376147,"node_id":"MDQ6VXNlcjc1Mzc2MTQ3","avatar_url":"https://avatars.githubusercontent.com/u/75376147?v=4","gravatar_id":"","url":"https://api.github.com/users/wdhenrik","html_url":"https://github.com/wdhenrik","followers_url":"https://api.github.com/users/wdhenrik/followers","following_url":"https://api.github.com/users/wdhenrik/following{/other_user}","gists_url":"https://api.github.com/users/wdhenrik/gists{/gist_id}","starred_url":"https://api.github.com/users/wdhenrik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wdhenrik/subscriptions","organizations_url":"https://api.github.com/users/wdhenrik/orgs","repos_url":"https://api.github.com/users/wdhenrik/repos","events_url":"https://api.github.com/users/wdhenrik/events{/privacy}","received_events_url":"https://api.github.com/users/wdhenrik/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1900942474,"node_id":"MDU6TGFiZWwxOTAwOTQyNDc0","url":"https://api.github.com/repos/dotnet/efcore/labels/area-migrations","name":"area-migrations","color":"32b37b","default":false,"description":""},{"id":2272800544,"node_id":"MDU6TGFiZWwyMjcyODAwNTQ0","url":"https://api.github.com/repos/dotnet/efcore/labels/area-sqlserver","name":"area-sqlserver","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/180","html_url":"https://github.com/dotnet/efcore/milestone/180","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/180/labels","id":9963267,"node_id":"MI_kwDOAPaMMs4AmAcD","number":180,"title":"9.0.0","description":null,"creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":339,"state":"closed","created_at":"2023-09-25T15:41:58Z","updated_at":"2025-04-01T18:19:15Z","due_on":null,"closed_at":"2024-11-14T11:54:05Z"},"comments":11,"created_at":"2022-07-06T16:01:22Z","updated_at":"2025-06-15T18:49:04Z","closed_at":"2024-01-27T23:44:39Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I had created a typical ID field with identity.  Then I realized I needed to set a seed value of 20000 so I updated the Configuration:\r\n```\r\n  public void Configure(EntityTypeBuilder<Ticket> builder)\r\n  {\r\n    builder.HasKey(x => x.Id);\r\n    builder.Property(x => x.Id)\r\n      .UseIdentityColumn(20_000, 1);\r\n}\r\n```\r\nThis was discovered correctly by the migration:\r\n```\r\n            migrationBuilder.AlterColumn<int>(\r\n                name: \"Id\",\r\n                schema: \"ArpWork\",\r\n                table: \"Ticket\",\r\n                type: \"int\",\r\n                nullable: false,\r\n                oldClrType: typeof(int),\r\n                oldType: \"int\")\r\n                .Annotation(\"SqlServer:Identity\", \"20000, 1\")\r\n                .OldAnnotation(\"SqlServer:Identity\", \"1, 1\");\r\n        }\r\n```\r\nbut the SQL script generated as \r\n```\r\nDECLARE @var0 sysname;\r\nSELECT @var0 = [d].[name]\r\nFROM [sys].[default_constraints] [d]\r\nINNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]\r\nWHERE ([d].[parent_object_id] = OBJECT_ID(N'[ArpWork].[Ticket]') AND [c].[name] = N'Id');\r\nIF @var0 IS NOT NULL EXEC(N'ALTER TABLE [ArpWork].[Ticket] DROP CONSTRAINT [' + @var0 + '];');\r\nALTER TABLE [ArpWork].[Ticket] ALTER COLUMN [Id] int NOT NULL;\r\nGO\r\n```\r\n**This does not have any affect as the table definition is still**\r\n```\r\nCREATE TABLE [ArpWork].[Ticket](\r\n\t[Id] [INT] IDENTITY(1,1) NOT NULL,\r\n```\r\n\r\nIf I remove migrations and create the table with the new identity value in place, it works fine.  \r\n\r\n**However, even with the correct value in place, there is nothing in the default_constraints table.**\r\n```\r\nDECLARE @var0 sysname;\r\nSELECT @var0 = [d].[name]\r\nFROM [sys].[default_constraints] [d]\r\nINNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]\r\nWHERE ([d].[parent_object_id] = OBJECT_ID(N'[ArpWork].[Ticket]') AND [c].[name] = N'Id');\r\n```\r\nThat returns an empty set.\r\n\r\nIt could be modified to use:\r\n```\r\nIF EXISTS (\r\nSELECT *\r\nFROM sys.identity_columns AS i\r\nINNER JOIN sys.columns AS c ON c.column_id = i.column_id AND c.object_id = i.object_id\r\nWHERE i.object_id = OBJECT_ID(N'ArpWork.Ticket') AND c.name = N'Id')\r\nBEGIN\r\n    DBCC CHECKIDENT(N'ArpWork.Ticket', RESEED,20000)\r\nEND\r\n```\r\nbut that only changes the current Seed value.  If the table were truncated, the seed would restart at the original value (1) again.\r\n\r\nThe only way to ensure that the column identity seed definition is changed would be creating a new table, copying the data and dropping the old table.\r\n\r\nIn my opinion, changing the seed is rare, and it is only reset by a truncate.  I propose that changing the current seed value using CHECKIDENT is sufficient for this type of change.  I think this would be preferable rather than the concerns of changing the PK and related FK constraints throughout the database.\r\n\r\nIf a truncate happens and existing data is being brought over, it would be the responsibility of the DBA to ensure the keys are set properly.  If the table is dropped and recreated by EF, the new identity definition would be used at table creation.\r\n\r\n\r\n### Include provider and version information\r\n\r\nEF Core version: 6.0.6\r\nDatabase provider: Microsoft.EntityFrameworkCore.SqlServer\r\nTarget framework: .NET 6.0\r\nOperating system: Windows 10\r\nIDE: Visual Studio 2022 17.2.1\r\n","closed_by":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/28377/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/28377/timeline","performed_via_github_app":null,"state_reason":"completed"}