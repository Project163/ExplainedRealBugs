{"url":"https://api.github.com/repos/dotnet/efcore/issues/35089","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/35089/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/35089/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/35089/events","html_url":"https://github.com/dotnet/efcore/issues/35089","id":2654450569,"node_id":"I_kwDOAPaMMs6eN7OJ","number":35089,"title":"Represent query parameters with a dedicated type instead of ParameterExpression","user":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":228492857,"node_id":"MDU6TGFiZWwyMjg0OTI4NTc=","url":"https://api.github.com/repos/dotnet/efcore/labels/providers-beware","name":"providers-beware","color":"fbca04","default":false,"description":null},{"id":1675384372,"node_id":"MDU6TGFiZWwxNjc1Mzg0Mzcy","url":"https://api.github.com/repos/dotnet/efcore/labels/area-query","name":"area-query","color":"32b37b","default":false,"description":""},{"id":8130499638,"node_id":"LA_kwDOAPaMMs8AAAAB5J2UNg","url":"https://api.github.com/repos/dotnet/efcore/labels/preview-1","name":"preview-1","color":"ACB3D7","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/204","html_url":"https://github.com/dotnet/efcore/milestone/204","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/204/labels","id":11480673,"node_id":"MI_kwDOAPaMMs4Ary5h","number":204,"title":"10.0.0","description":"","creator":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":1,"closed_issues":193,"state":"open","created_at":"2024-08-23T12:48:26Z","updated_at":"2025-11-05T08:24:30Z","due_on":null,"closed_at":null},"comments":0,"created_at":"2024-11-13T06:58:46Z","updated_at":"2025-06-15T20:11:46Z","closed_at":"2024-11-19T16:11:33Z","author_association":"MEMBER","type":{"id":1092406,"node_id":"IT_kwDOAIt-yc4AEKs2","name":"Feature","description":"A request, idea, or new functionality","color":"blue","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-10-08T09:10:05Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Our funcletizer identifies captured variables in the incoming query tree (member accesses over compiler-generated closure types), and converts these to ParameterExpressions which represent external query parameters; these are later translated to e.g. SqlParameter. These ParameterExpressions have a very different meaning than the incoming compiler-generated ParameterExpression, which represent lambda parameters which never exist in the final translation of the query (they are replaced during translation with the thing they represent).\n\nThis design has the following issues:\n\n* The query pipeline needs to handle these two types of ParameterExpressions in different ways (query parameters are translated to SqlParameter, lambda parameters aren't). To distinguish between the two, we prefix query parameters with `__`, and use string pattern matching. This is a good solution, and probably means that if someone has a lambda parameter starting with `__`, that would fail in various ways. We later also need to remove the prefix, since the actual SqlParameter should have it.\n* We're starting to need to know various \"extra\" information about query parameters:\n    * When precompiling queries, static analysis of the query provides us with NRT nullability information for reference types; that is, we're able to know whether a ParameterExpression of type string can actually contain null or not. Since this information can't be transmitted via ParameterExpression, we have QueryCompilationContext.NonNullableReferenceTypeParameters, to record which parameters are non-nullable.\n    * Similarly, in 9.0 we changed the behavior of EF.Parameter() to record that a query node is not to be constantized, even if it otherwise would ([#34345](https://github.com/dotnet/efcore/issues/34345)). To implement this, we again introduced QueryCompilationContext.ParametersToNotConstantize\n* This is generally not a great design: the extra information is kept in external data structures rather than in the node itself (and so the structures need to be passed around). More importantly, the data structures refer to the ParameterExpressions by their name, to prevent a situation where some visitor replaces a ParameterExpression for any reason, and we lose referential integrity. Referencing by name also isn't ideal (at least in theory names may be changed as well). @cincuranet we discussed this while designing [#34345](https://github.com/dotnet/efcore/issues/34345) and friends).\n\nThe solution here seems quite simple: introduce a new QueryParameterExpression which is completely unrelated to ParameterExpression (extension node):\n\n* As we'd own this type, we can add whatever metadata we want (non-nullable, not-to-be-constantized...). No more need for external data structures referencing ParameterExpressions in some way. \n* We'd have a clear node type distinction between query parameters and lambda parameters. This is a good idea, since we always want to do different things for the two node types.\n* We already have lots of other EF extension types in the pretranslated query tree (e.g. all the query roots), so there would be nothing new here really.\n\nNote: this would be a breaking change to (non-relational) providers as they'd need to translate the new node to whatever their query parameter is (SqlExpression for relational).","closed_by":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/35089/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/35089/timeline","performed_via_github_app":null,"state_reason":"completed"}