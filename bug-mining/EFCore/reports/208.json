{"url":"https://api.github.com/repos/dotnet/efcore/issues/30601","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/30601/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/30601/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/30601/events","html_url":"https://github.com/dotnet/efcore/issues/30601","id":1648853832,"node_id":"I_kwDOAPaMMs5iR4NI","number":30601,"title":"SaveChanges circular dependency in unique unfiltered index (when change doesn't affect any column from unique index).","user":{"login":"jmalczak","id":1000144,"node_id":"MDQ6VXNlcjEwMDAxNDQ=","avatar_url":"https://avatars.githubusercontent.com/u/1000144?v=4","gravatar_id":"","url":"https://api.github.com/users/jmalczak","html_url":"https://github.com/jmalczak","followers_url":"https://api.github.com/users/jmalczak/followers","following_url":"https://api.github.com/users/jmalczak/following{/other_user}","gists_url":"https://api.github.com/users/jmalczak/gists{/gist_id}","starred_url":"https://api.github.com/users/jmalczak/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jmalczak/subscriptions","organizations_url":"https://api.github.com/users/jmalczak/orgs","repos_url":"https://api.github.com/users/jmalczak/repos","events_url":"https://api.github.com/users/jmalczak/events{/privacy}","received_events_url":"https://api.github.com/users/jmalczak/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":514908713,"node_id":"MDU6TGFiZWw1MTQ5MDg3MTM=","url":"https://api.github.com/repos/dotnet/efcore/labels/regression","name":"regression","color":"ff1fff","default":false,"description":null},{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1017558838,"node_id":"MDU6TGFiZWwxMDE3NTU4ODM4","url":"https://api.github.com/repos/dotnet/efcore/labels/Servicing-approved","name":"Servicing-approved","color":"048708","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/165","html_url":"https://github.com/dotnet/efcore/milestone/165","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/165/labels","id":9168950,"node_id":"MI_kwDOAPaMMs4Ai-g2","number":165,"title":"7.0.7","description":null,"creator":{"login":"rbhanda","id":30737530,"node_id":"MDQ6VXNlcjMwNzM3NTMw","avatar_url":"https://avatars.githubusercontent.com/u/30737530?v=4","gravatar_id":"","url":"https://api.github.com/users/rbhanda","html_url":"https://github.com/rbhanda","followers_url":"https://api.github.com/users/rbhanda/followers","following_url":"https://api.github.com/users/rbhanda/following{/other_user}","gists_url":"https://api.github.com/users/rbhanda/gists{/gist_id}","starred_url":"https://api.github.com/users/rbhanda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rbhanda/subscriptions","organizations_url":"https://api.github.com/users/rbhanda/orgs","repos_url":"https://api.github.com/users/rbhanda/repos","events_url":"https://api.github.com/users/rbhanda/events{/privacy}","received_events_url":"https://api.github.com/users/rbhanda/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":9,"state":"closed","created_at":"2023-03-16T17:19:58Z","updated_at":"2023-11-14T13:53:13Z","due_on":null,"closed_at":"2023-06-22T17:34:17Z"},"comments":0,"created_at":"2023-03-31T07:46:20Z","updated_at":"2025-06-15T19:01:10Z","closed_at":"2023-04-06T18:33:27Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## When using Attach and IsModified to update column without first fetching whole entity from database, SaveChanges throws circular dependency in unique unfiltered index, even if updated column is not part of the index. This code works fine in ef core 6.\r\n\r\n### Repro steps\r\n\r\n```C#\r\n [Fact]\r\n    public void SaveChangesShouldNotThrow()\r\n    {\r\n        var context = new TestDbContext();\r\n\r\n        var e = new TestEntity { Id = Guid.NewGuid(), Name = \"n1\" };\r\n        var e2 = new TestEntity { Id = Guid.NewGuid(), Name = \"n2\" };\r\n\r\n        context.TestEntities.Attach(e);\r\n        context.TestEntities.Attach(e2);\r\n\r\n        context.Entry(e).Property(p => p.Name).IsModified = true;\r\n        context.Entry(e2).Property(p => p.Name).IsModified = true;\r\n\r\n        context.SaveChanges();\r\n    }\r\n\r\n    public class TestDbContext : DbContext\r\n    {\r\n        public DbSet<TestEntity> TestEntities { get; set; }\r\n\r\n        protected override void OnConfiguring(\r\n            DbContextOptionsBuilder optionsBuilder)\r\n        {\r\n            if (!optionsBuilder.IsConfigured || optionsBuilder.Options.Extensions.Count() <= 1)\r\n            {\r\n                optionsBuilder.UseSqlServer(\"Server=.;Initial Catalog=test;User Id=sa;Password=test;TrustServerCertificate=true\");\r\n\r\n                base.OnConfiguring(optionsBuilder);\r\n            }\r\n        }\r\n\r\n        protected override void OnModelCreating(ModelBuilder modelBuilder)\r\n        {\r\n            base.OnModelCreating(modelBuilder);\r\n\r\n            modelBuilder.Entity<TestEntity>()\r\n                .HasKey(t => t.Id);\r\n\r\n            modelBuilder.Entity<TestEntity>()\r\n                .HasIndex(t => new { t.Id1, t.Id2 })\r\n                .IsUnique();\r\n        }\r\n    }\r\n\r\n    public class TestEntity\r\n    {\r\n        public Guid Id { get; set; }\r\n        public string Name { get; set; }\r\n        public Guid Id1 { get; set; }\r\n        public Guid Id2 { get; set; }\r\n    }\r\n```\r\n\r\n### Stack trace\r\n\r\n```\r\nSystem.InvalidOperationException\r\nUnable to save changes because a circular dependency was detected in the data to be saved: 'TestEntity [Modified] <-\r\nIndex { 'Id1', 'Id2' } TestEntity [Modified] <-\r\nIndex { 'Id1', 'Id2' } TestEntity [Modified]To show additional information call 'DbContextOptionsBuilder.EnableSensitiveDataLogging'.'.\r\n   at Microsoft.EntityFrameworkCore.Utilities.Multigraph`2.ThrowCycle(List`1 cycle, Func`2 formatCycle, Func`2 formatException)\r\n   at Microsoft.EntityFrameworkCore.Utilities.Multigraph`2.TopologicalSortCore(Boolean withBatching, Func`4 tryBreakEdge, Func`2 formatCycle, Func`2 formatException)\r\n   at Microsoft.EntityFrameworkCore.Utilities.Multigraph`2.BatchingTopologicalSort(Func`4 tryBreakEdge, Func`2 formatCycle, Func`2 formatException)\r\n   at Microsoft.EntityFrameworkCore.Update.Internal.CommandBatchPreparer.TopologicalSort(IEnumerable`1 commands)\r\n   at Microsoft.EntityFrameworkCore.Update.Internal.CommandBatchPreparer.BatchCommands(IList`1 entries, IUpdateAdapter updateAdapter)+MoveNext()\r\n   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.Execute(IEnumerable`1 commandBatches, IRelationalConnection connection)\r\n   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChanges(IList`1 entries)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(IList`1 entriesToSave)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(StateManager stateManager, Boolean acceptAllChangesOnSuccess)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.<>c.<SaveChanges>b__107_0(DbContext _, ValueTuple`2 t)\r\n   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.Execute[TState,TResult](TState state, Func`3 operation, Func`3 verifySucceeded)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(Boolean acceptAllChangesOnSuccess)\r\n   at Microsoft.EntityFrameworkCore.DbContext.SaveChanges(Boolean acceptAllChangesOnSuccess)\r\n   at Microsoft.EntityFrameworkCore.DbContext.SaveChanges()**\r\n**\r\n```\r\n\r\n### Include provider and version information\r\n\r\nEF Core version:\r\nDatabase provider: Microsoft.EntityFrameworkCore.SqlServer\r\nTarget framework: .NET 7.0.202, ef core 7.0.3 (it was working fine in ef core 6.*)\r\n","closed_by":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/30601/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/30601/timeline","performed_via_github_app":null,"state_reason":"completed"}