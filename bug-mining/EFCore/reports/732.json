{"url":"https://api.github.com/repos/dotnet/efcore/issues/36917","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/36917/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/36917/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/36917/events","html_url":"https://github.com/dotnet/efcore/issues/36917","id":3486721934,"node_id":"I_kwDOAPaMMs7P0yeO","number":36917,"title":"Regression in EF Core 10: SQL Parameter Name Collision on SQL Server due to Case-Insensitive Variable Names","user":{"login":"davidroth","id":338856,"node_id":"MDQ6VXNlcjMzODg1Ng==","avatar_url":"https://avatars.githubusercontent.com/u/338856?v=4","gravatar_id":"","url":"https://api.github.com/users/davidroth","html_url":"https://github.com/davidroth","followers_url":"https://api.github.com/users/davidroth/followers","following_url":"https://api.github.com/users/davidroth/following{/other_user}","gists_url":"https://api.github.com/users/davidroth/gists{/gist_id}","starred_url":"https://api.github.com/users/davidroth/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidroth/subscriptions","organizations_url":"https://api.github.com/users/davidroth/orgs","repos_url":"https://api.github.com/users/davidroth/repos","events_url":"https://api.github.com/users/davidroth/events{/privacy}","received_events_url":"https://api.github.com/users/davidroth/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":514908713,"node_id":"MDU6TGFiZWw1MTQ5MDg3MTM=","url":"https://api.github.com/repos/dotnet/efcore/labels/regression","name":"regression","color":"ff1fff","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/204","html_url":"https://github.com/dotnet/efcore/milestone/204","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/204/labels","id":11480673,"node_id":"MI_kwDOAPaMMs4Ary5h","number":204,"title":"10.0.0","description":"","creator":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":1,"closed_issues":193,"state":"open","created_at":"2024-08-23T12:48:26Z","updated_at":"2025-11-05T08:24:30Z","due_on":null,"closed_at":null},"comments":1,"created_at":"2025-10-06T11:01:57Z","updated_at":"2025-10-09T09:47:34Z","closed_at":"2025-10-09T09:47:33Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"EF Core 10's query translation generates invalid SQL when a LINQ query uses two different C# variables whose names differ only by casing (e.g., a method parameter named id and a local variable named ID). This causes a parameter name collision on case-insensitive databases like SQL Server.\n\nThe issue is not specific to any data type (Guid, int, etc.) or value source (constants, properties, variables). It is a general parameter naming bug where C# variable names are translated too directly into SQL parameter names without ensuring their uniqueness in a case-insensitive context.\n\nThis is a regression from EF Core 9, where parameter names were correctly sanitized to prevent these collisions. The change in behavior appears to be related to the parameter naming improvements introduced by PR [#35200](https://github.com/dotnet/efcore/pull/35200).\n\n#### Steps to Reproduce\nThe following code reliably reproduces the issue. It uses a method parameter named guid  (Guid) and references typeof(Order).GUID in the local expression.\n\n\n```csharp\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Logging;\nusing System;\nusing System.Linq;\nusing System.Threading.Tasks;\n\npublic static async Task Main()\n{\n\tusing (var context = new SampleContext())\n\t{\n\t\tawait context.Database.EnsureDeletedAsync();\n\t\tawait context.Database.EnsureCreatedAsync();\n\n\t\tvar orders = References(context.Orders, Guid.New());\n\n\t\tvar query = (from order in orders\n\t\t\t\t\t where order.SomeGuid == typeof(Order).GUID\n\t\t\t\t\t select order);\n\n\t\tConsole.WriteLine(query.ToQueryString());\n\n\t\t// This will throw the exception\n\t\tawait query.ToListAsync();\n\t}\n}\n\n// Helper method to simulate a query filter which gets its guid from a method variable named \"guid\"\npublic static IQueryable<Order> References(IQueryable<Order> query, Guid guid)\n{\n\treturn query.Where(q => q.SomeGuid == guid);\n}\n\npublic class Order\n{\n\tpublic int Id { get; set; }\n\tpublic Guid SomeGuid { get; set; }\n}\n\npublic class SampleContext : DbContext\n{\n\tpublic DbSet<Order> Orders { get; set; }\n\n\tprotected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)\n\t{\n\t\toptionsBuilder\n\t\t\t.UseSqlServer(\"Server=(localdb)\\\\MSSQLLocalDB;Integrated Security=true;Initial Catalog=EFCoreGuidBugTest\")\n\t\t\t.LogTo(Console.WriteLine, LogLevel.Information);\n\t}\n}\n```\n\n#### Actual Behavior (EF Core 10) \nEF Core 10 generates SQL that declares two variables whose names differ only in casing, causing a failure.\n\nGenerated SQL (EF Core 10 - Incorrect):\n\n```sql\nDECLARE @guid uniqueIdentifier = 'f3aaf539-13b4-343f-a029-271153b3c1c5';\nDECLARE @GUID uniqueIdentifier = 'f3aaf539-13b4-343f-a029-271153b3c1c5';\n\nSELECT [o].[Id], [o].[SomeGuid]\nFROM [Orders] AS [o]\nWHERE [o].[SomeGuid] = @guid AND [o].[SomeGuid] = @GUID\n```\n\n### Resulting Exception:\n\nMicrosoft.Data.SqlClient.SqlException (0x80131904): The variable name '@GUID' has already been declared. Variable names must be unique within a query batch or stored procedure.\n\n\n### Expected Behavior (Matches EF Core 9) üëç\nThe expected behavior is for EF Core to generate valid SQL with unique parameter names, as it did in EF Core 9.\n\n```sql\nDECLARE @__guid_0 uniqueIdentifier = 'e8f5a6c9-1172-3d0a-81a1-01341665983e';\nDECLARE @__GUID_1 uniqueIdentifier = 'e8f5a6c9-1172-3d0a-81a1-01341665983e';\n\nSELECT [o].[Id], [o].[SomeGuid]\nFROM [Orders] AS [o]\nWHERE [o].[SomeGuid] = @__guid_0 AND [o].[SomeGuid] = @__GUID_1\n```\n\n### Additional Notes\nI want to add that I appreciate the improvements for more readable parameter names made in PR [#35200](https://github.com/dotnet/efcore/pull/35200). The goal of this issue is not to request a revert to the old naming scheme (e.g., @__guid_0).\n\nThe ideal solution would be for the new naming strategy to also handle potential case-insensitivity collisions, for example by adding a numeric suffix (@guid, @guid1) when a conflict is detected. This would preserve the enhanced readability while ensuring the generated SQL is always valid.","closed_by":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/36917/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/36917/timeline","performed_via_github_app":null,"state_reason":"completed"}