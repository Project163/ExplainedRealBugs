{"url":"https://api.github.com/repos/dotnet/efcore/issues/27455","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/27455/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/27455/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/27455/events","html_url":"https://github.com/dotnet/efcore/issues/27455","id":1139886602,"node_id":"I_kwDOAPaMMs5D8UoK","number":27455,"title":"InvalidOperationException on save after upgrading from 5 to 6","user":{"login":"csmager","id":5575049,"node_id":"MDQ6VXNlcjU1NzUwNDk=","avatar_url":"https://avatars.githubusercontent.com/u/5575049?v=4","gravatar_id":"","url":"https://api.github.com/users/csmager","html_url":"https://github.com/csmager","followers_url":"https://api.github.com/users/csmager/followers","following_url":"https://api.github.com/users/csmager/following{/other_user}","gists_url":"https://api.github.com/users/csmager/gists{/gist_id}","starred_url":"https://api.github.com/users/csmager/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/csmager/subscriptions","organizations_url":"https://api.github.com/users/csmager/orgs","repos_url":"https://api.github.com/users/csmager/repos","events_url":"https://api.github.com/users/csmager/events{/privacy}","received_events_url":"https://api.github.com/users/csmager/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":514908713,"node_id":"MDU6TGFiZWw1MTQ5MDg3MTM=","url":"https://api.github.com/repos/dotnet/efcore/labels/regression","name":"regression","color":"ff1fff","default":false,"description":null},{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1017558838,"node_id":"MDU6TGFiZWwxMDE3NTU4ODM4","url":"https://api.github.com/repos/dotnet/efcore/labels/Servicing-approved","name":"Servicing-approved","color":"048708","default":false,"description":""},{"id":1900941009,"node_id":"MDU6TGFiZWwxOTAwOTQxMDA5","url":"https://api.github.com/repos/dotnet/efcore/labels/area-save-changes","name":"area-save-changes","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/136","html_url":"https://github.com/dotnet/efcore/milestone/136","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/136/labels","id":7681399,"node_id":"MI_kwDOAPaMMs4AdTV3","number":136,"title":"6.0.4","description":null,"creator":{"login":"rbhanda","id":30737530,"node_id":"MDQ6VXNlcjMwNzM3NTMw","avatar_url":"https://avatars.githubusercontent.com/u/30737530?v=4","gravatar_id":"","url":"https://api.github.com/users/rbhanda","html_url":"https://github.com/rbhanda","followers_url":"https://api.github.com/users/rbhanda/followers","following_url":"https://api.github.com/users/rbhanda/following{/other_user}","gists_url":"https://api.github.com/users/rbhanda/gists{/gist_id}","starred_url":"https://api.github.com/users/rbhanda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rbhanda/subscriptions","organizations_url":"https://api.github.com/users/rbhanda/orgs","repos_url":"https://api.github.com/users/rbhanda/repos","events_url":"https://api.github.com/users/rbhanda/events{/privacy}","received_events_url":"https://api.github.com/users/rbhanda/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":4,"state":"closed","created_at":"2022-02-15T18:31:44Z","updated_at":"2022-04-18T13:25:06Z","due_on":null,"closed_at":"2022-04-15T20:39:26Z"},"comments":2,"created_at":"2022-02-16T11:25:06Z","updated_at":"2025-06-15T18:45:41Z","closed_at":"2022-03-11T11:30:01Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"On attempting to upgrade our project from EF Core 5 to 6, most of our integration tests fail. I've narrowed this down to a small repro below. An entity `Foo` has many `FooPeriods`. One of these is 'current'. So we have a 1:many and a 1:1 relationship:\r\n\r\n```csharp\r\npublic class Foo\r\n{\r\n    public int Id { get; set; }\r\n    public int? CurrentPeriodNumber { get; set; }\r\n    public FooPeriod? CurrentPeriod { get; set; }\r\n    public ICollection<FooPeriod> Periods { get; } = new HashSet<FooPeriod>();\r\n}\r\n\r\npublic class FooPeriod\r\n{\r\n    public int FooId { get; set; }    \r\n    public int PeriodNumber { get; set; }    \r\n    public Foo? Foo { get; set; }\r\n}\r\n```\r\nThis is configured via the fluent builder as below:\r\n```csharp\r\npublic class Context : DbContext\r\n{\r\n    public Context(DbContextOptions<Context> options)\r\n        :base(options)\r\n    {\r\n        \r\n    }\r\n\r\n    public DbSet<Foo> Foos => Set<Foo>();\r\n    \r\n    protected override void OnModelCreating(ModelBuilder modelBuilder)\r\n    {\r\n        modelBuilder.Entity<Foo>(entity =>\r\n        {\r\n            entity.HasKey(x => x.Id);\r\n            entity.Property(x => x.Id)\r\n                .ValueGeneratedOnAdd();\r\n            entity.HasOne(x => x.CurrentPeriod)\r\n                .WithOne()\r\n                .HasForeignKey<Foo>(x => new { x.Id, x.CurrentPeriodNumber });\r\n        });\r\n\r\n        modelBuilder.Entity<FooPeriod>(entity =>\r\n        {\r\n            entity.HasKey(x => new { x.FooId, x.PeriodNumber });\r\n            entity.HasOne(x => x.Foo)\r\n                .WithMany(x => x.Periods)\r\n                .HasForeignKey(x => x.FooId);\r\n        });\r\n    }\r\n}\r\n```\r\nIf I insert a new period as below:\r\n```csharp\r\nvar period = new FooPeriod\r\n{\r\n    PeriodNumber = 1,\r\n    Foo = new Foo()\r\n};\r\n\r\ncontext.Add(period);\r\ncontext.SaveChanges();\r\n```\r\nThen I get this exception:\r\n```text\r\nUnhandled exception. Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.\r\n ---> System.InvalidOperationException: The property 'FooPeriod.FooId' cannot be assigned a value generated by the database. Store-generated values can only be assigned to properties configured to use store-generated values.\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.InternalEntityEntry.SetStoreGeneratedValue(IProperty property, Object value)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.InternalEntityEntry.PropagateValue(InternalEntityEntry principalEntry, IProperty principalProperty, IProperty dependentProperty, Boolean isMaterialization, Boolean setModified)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.NavigationFixer.SetForeignKeyProperties(InternalEntityEntry dependentEntry, InternalEntityEntry principalEntry, IForeignKey foreignKey, Boolean setModified, Boolean fromQuery)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.NavigationFixer.KeyPropertyChanged(InternalEntityEntry entry, IProperty property, IEnumerable`1 containingPrincipalKeys, IEnumerable`1 containingForeignKeys, Object oldValue, Object newValue)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.InternalEntityEntryNotifier.KeyPropertyChanged(InternalEntityEntry entry, IProperty property, IEnumerable`1 keys, IEnumerable`1 foreignKeys, Object oldValue, Object newValue)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.ChangeDetector.DetectKeyChange(InternalEntityEntry entry, IProperty property)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.ChangeDetector.PropertyChanged(InternalEntityEntry entry, IPropertyBase propertyBase, Boolean setModified)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.InternalEntityEntryNotifier.PropertyChanged(InternalEntityEntry entry, IPropertyBase property, Boolean setModified)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.InternalEntityEntry.SetProperty(IPropertyBase propertyBase, Object value, Boolean isMaterialization, Boolean setModified, Boolean isCascadeDelete, CurrentValueType valueType)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.InternalEntityEntry.SetStoreGeneratedValue(IProperty property, Object value)\r\n   at Microsoft.EntityFrameworkCore.Update.ColumnModification.set_Value(Object value)\r\n   at Microsoft.EntityFrameworkCore.Update.ModificationCommand.PropagateResults(ValueBuffer valueBuffer)\r\n   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetWithPropagation(Int32 commandIndex, RelationalDataReader reader)\r\n   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.Consume(RelationalDataReader reader)\r\n   --- End of inner exception stack trace ---\r\n   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.Consume(RelationalDataReader reader)\r\n   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.Execute(IRelationalConnection connection)\r\n   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.Execute(IEnumerable`1 commandBatches, IRelationalConnection connection)\r\n   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChanges(IList`1 entries)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(IList`1 entriesToSave)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(StateManager stateManager, Boolean acceptAllChangesOnSuccess)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.<>c.<SaveChanges>b__104_0(DbContext _, ValueTuple`2 t)\r\n   at Microsoft.EntityFrameworkCore.Storage.NonRetryingExecutionStrategy.Execute[TState,TResult](TState state, Func`3 operation, Func`3 verifySucceeded)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(Boolean acceptAllChangesOnSuccess)\r\n   at Microsoft.EntityFrameworkCore.DbContext.SaveChanges(Boolean acceptAllChangesOnSuccess)\r\n   at Microsoft.EntityFrameworkCore.DbContext.SaveChanges()\r\n```\r\nI've dug around to see what might have changed between 5 and 6 and am pretty confident the change in behaviour was caused by the fix for https://github.com/dotnet/efcore/issues/22603. I also note that this is the same sort of model as https://github.com/dotnet/efcore/issues/26629 (which prevented us updating to 6.0.0).\r\n\r\nEF Core version: 6.0.2\r\nDatabase provider: I've tried Microsoft.EntityFrameworkCore.SqlServer and Microsoft.EntityFrameworkCore.Sqlite\r\nTarget framework: .NET 6.0\r\nOperating system: macOS\r\n","closed_by":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/27455/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/27455/timeline","performed_via_github_app":null,"state_reason":"completed"}