{"url":"https://api.github.com/repos/dotnet/efcore/issues/32052","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/32052/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/32052/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/32052/events","html_url":"https://github.com/dotnet/efcore/issues/32052","id":1943377802,"node_id":"I_kwDOAPaMMs5z1ZeK","number":32052,"title":"Increased query memory usage on EFCore 8 RC2","user":{"login":"gabynevada","id":20828017,"node_id":"MDQ6VXNlcjIwODI4MDE3","avatar_url":"https://avatars.githubusercontent.com/u/20828017?v=4","gravatar_id":"","url":"https://api.github.com/users/gabynevada","html_url":"https://github.com/gabynevada","followers_url":"https://api.github.com/users/gabynevada/followers","following_url":"https://api.github.com/users/gabynevada/following{/other_user}","gists_url":"https://api.github.com/users/gabynevada/gists{/gist_id}","starred_url":"https://api.github.com/users/gabynevada/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gabynevada/subscriptions","organizations_url":"https://api.github.com/users/gabynevada/orgs","repos_url":"https://api.github.com/users/gabynevada/repos","events_url":"https://api.github.com/users/gabynevada/events{/privacy}","received_events_url":"https://api.github.com/users/gabynevada/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":2272800544,"node_id":"MDU6TGFiZWwyMjcyODAwNTQ0","url":"https://api.github.com/repos/dotnet/efcore/labels/area-sqlserver","name":"area-sqlserver","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/152","html_url":"https://github.com/dotnet/efcore/milestone/152","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/152/labels","id":8392036,"node_id":"MI_kwDOAPaMMs4AgA1k","number":152,"title":"8.0.0","description":"EF Core 8.0","creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":280,"state":"closed","created_at":"2022-09-07T19:55:36Z","updated_at":"2025-04-07T08:59:46Z","due_on":null,"closed_at":"2023-11-14T14:00:33Z"},"comments":8,"created_at":"2023-10-14T16:15:31Z","updated_at":"2025-06-15T19:52:55Z","closed_at":"2023-10-17T17:04:22Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I'm getting memory buildup problem from RC2 onwards while streaming from an IAsyncEnumerable. (Tested with latest daily build).\r\n\r\nI'm using IAsyncEnuerable to stream data from database and save it an Azure Storage account.  From RC2 onwards it keeps consuming memory until the process crashes. If I revert back to RC1 the process works as expected and no significant memory buildup occurs.\r\n\r\nThis is the expected memory allocations if using RC1\r\n![image](https://github.com/dotnet/efcore/assets/20828017/9472dc06-0cdf-42c2-b8ac-16c0eb801d42)\r\n\r\nThis is latest daily build memory allocations\r\n![image](https://github.com/dotnet/efcore/assets/20828017/6e3c22ba-26ed-4d4f-8b8c-c27c93a4af37)\r\n\r\n\r\n### Include your code\r\n\r\nSample code of IAsyncEnumerable\r\n```c#\r\nvay testAsyncEnumerable = _context.MyModel\r\n      .AsNoTracking()\r\n      .OrderBy(e => e.Field2)\r\n      .Select(\r\n        e =>\r\n          new MyImportDto(\r\n            e.Field1,\r\n            e.Field2,\r\n            e.Field3\r\n          )\r\n      )\r\n      .AsAsyncEnumerable();\r\n```\r\n\r\nSample code I'm using to use the IAsyncEnumerable to stream from database query to storage account\r\n```C#\r\n    private async Task<ImportResultDto> UploadDataToSource<T>(\r\n        string fileName,\r\n        IAsyncEnumerable<T> dataList\r\n    )\r\n    {\r\n        var blobHttpHeaders = new BlobHttpHeaders { ContentType = \"application/protobuf\", };\r\n        var blobServiceClient = new BlobServiceClient(shouldBeAConnectionString);\r\n        var containerClient = blobServiceClient.GetBlobContainerClient(containerName);\r\n        var blobClient = containerClient.GetBlockBlobClient(fileName);\r\n        await using var stream = await blobClient.OpenWriteAsync(\r\n            true,\r\n            new BlockBlobOpenWriteOptions { HttpHeaders = blobHttpHeaders, }\r\n        );\r\n        await using var compressor = new GZipStream(stream, CompressionLevel.SmallestSize);\r\n        var totalRecordsImported = 0;\r\n        await foreach (var dataItem in dataList)\r\n        {\r\n            Serializer.SerializeWithLengthPrefix(compressor, dataItem, PrefixStyle.Base128, 1);\r\n            totalRecordsImported++;\r\n        }\r\n\r\n        return new ImportResultDto(totalRecordsImported);\r\n    }\r\n```\r\n\r\n### Include stack traces\r\n\r\nStack trace for the Out of memory exception\r\n\r\n```\r\nfail: Microsoft.EntityFrameworkCore.Query[10100]\r\n      An exception occurred while iterating over the results of a query for context type 'MyContext'.\r\n      System.OutOfMemoryException: Exception of type 'System.OutOfMemoryException' was thrown.\r\n         at Microsoft.EntityFrameworkCore.Query.Internal.BufferedDataReader.BufferedDataRecord.DoubleBufferCapacity()\r\n         at Microsoft.EntityFrameworkCore.Query.Internal.BufferedDataReader.BufferedDataRecord.ReadRow()\r\n         at Microsoft.EntityFrameworkCore.Query.Internal.BufferedDataReader.BufferedDataRecord.InitializeAsync(DbDataReader reader, IReadOnlyList`1 columns, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.Query.Internal.BufferedDataReader.InitializeAsync(IReadOnlyList`1 columns, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.Query.Internal.BufferedDataReader.InitializeAsync(IReadOnlyList`1 columns, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.InitializeReaderAsync(AsyncEnumerator enumerator, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.Storage.ExecutionStrategy.<>c__DisplayClass30_0`2.<<ExecuteAsync>b__0>d.MoveNext()\r\n      --- End of stack trace from previous location ---\r\n         at Microsoft.EntityFrameworkCore.Storage.ExecutionStrategy.ExecuteImplementationAsync[TState,TResult](Func`4 operation, Func`4 verifySucceeded, TState state, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.Storage.ExecutionStrategy.ExecuteImplementationAsync[TState,TResult](Func`4 operation, Func`4 verifySucceeded, TState state, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.Storage.ExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()\r\n      System.OutOfMemoryException: Exception of type 'System.OutOfMemoryException' was thrown.\r\n         at Microsoft.EntityFrameworkCore.Query.Internal.BufferedDataReader.BufferedDataRecord.DoubleBufferCapacity()\r\n         at Microsoft.EntityFrameworkCore.Query.Internal.BufferedDataReader.BufferedDataRecord.ReadRow()\r\n         at Microsoft.EntityFrameworkCore.Query.Internal.BufferedDataReader.BufferedDataRecord.InitializeAsync(DbDataReader reader, IReadOnlyList`1 columns, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.Query.Internal.BufferedDataReader.InitializeAsync(IReadOnlyList`1 columns, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.Query.Internal.BufferedDataReader.InitializeAsync(IReadOnlyList`1 columns, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.InitializeReaderAsync(AsyncEnumerator enumerator, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.Storage.ExecutionStrategy.<>c__DisplayClass30_0`2.<<ExecuteAsync>b__0>d.MoveNext()\r\n      --- End of stack trace from previous location ---\r\n         at Microsoft.EntityFrameworkCore.Storage.ExecutionStrategy.ExecuteImplementationAsync[TState,TResult](Func`4 operation, Func`4 verifySucceeded, TState state, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.Storage.ExecutionStrategy.ExecuteImplementationAsync[TState,TResult](Func`4 operation, Func`4 verifySucceeded, TState state, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.Storage.ExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)\r\n         at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()\r\n```\r\n\r\nStack trace for suspicious object allocations\r\n```\r\nAllocated type : System.Object[]\r\n  Objects : n/a\r\n  Bytes   : 671088664\r\n\r\nAllocated by\r\n   100%  DoubleBufferCapacity • 640.00 MB / 640.00 MB • Microsoft.EntityFrameworkCore.Query.Internal.BufferedDataReader+BufferedDataRecord.DoubleBufferCapacity()\r\n     100%  ReadRow • 640.00 MB / - • Microsoft.EntityFrameworkCore.Query.Internal.BufferedDataReader+BufferedDataRecord.ReadRow()\r\n       100%  MoveNext • 640.00 MB / - • Microsoft.EntityFrameworkCore.Query.Internal.BufferedDataReader+BufferedDataRecord+<InitializeAsync>d__90.MoveNext()\r\n         100%  RunInternal • 640.00 MB / - • System.Threading.ExecutionContext.RunInternal(ExecutionContext, ContextCallback, Object)\r\n           100%  MoveNext • 640.00 MB / - • System.Runtime.CompilerServices.AsyncTaskMethodBuilder+AsyncStateMachineBox<TResult, TStateMachine>.MoveNext(Thread)\r\n             100%  RunOrScheduleAction • 640.00 MB / - • System.Threading.Tasks.AwaitTaskContinuation.RunOrScheduleAction(IAsyncStateMachineBox, Boolean)\r\n               100%  RunContinuations • 640.00 MB / - • System.Threading.Tasks.Task.RunContinuations(Object)\r\n                 100%  CompleteAsyncCall • 640.00 MB / - • Microsoft.Data.SqlClient.SqlDataReader.CompleteAsyncCall<T>(Task<TResult>, SqlDataReader+SqlDataReaderBaseAsyncCallContext<T>)\r\n                   100%  RunFromThreadPoolDispatchLoop • 640.00 MB / - • System.Threading.ExecutionContext.RunFromThreadPoolDispatchLoop(Thread, ExecutionContext, ContextCallback, Object)\r\n                     100%  ExecuteWithThreadLocal • 640.00 MB / - • System.Threading.Tasks.Task.ExecuteWithThreadLocal(Task, Thread)\r\n                       100%  Dispatch • 640.00 MB / - • System.Threading.ThreadPoolWorkQueue.Dispatch()\r\n                         100%  WorkerDoWork • 640.00 MB / - • System.Threading.PortableThreadPool+WorkerThread.WorkerDoWork(PortableThreadPool, Boolean)\r\n                           100%  WorkerThreadStart • 640.00 MB / - • System.Threading.PortableThreadPool+WorkerThread.WorkerThreadStart()\r\n                             100%  RunWorker • 640.00 MB / - • System.Threading.Thread+StartHelper.RunWorker()\r\n                               100%  Run • 640.00 MB / - • System.Threading.Thread+StartHelper.Run()\r\n                                 100%  StartCallback • 640.00 MB / - • System.Threading.Thread.StartCallback()\r\n                                  ►  100%  [AllThreadsRoot] • 640.00 MB / - • [AllThreadsRoot]\r\n\r\n#stacktrace\r\n```\r\n\r\nStacktrace for BufferedDataReader from memory allocation profiling\r\n```\r\nAllocating method : Microsoft.EntityFrameworkCore.Query.Internal.BufferedDataReader+BufferedDataRecord.DoubleBufferCapacity()\r\n  Objects : n/a\r\n  Bytes   : 1593835616\r\n\r\nTop allocated types:\r\n 640.00 MB Object[]\r\n 384.00 MB DateTime[]\r\n 384.00 MB Guid[]\r\n 112.00 MB Boolean[]\r\n\r\nStacktrace:\r\n   100%  DoubleBufferCapacity • 1.48 GB / 1.48 GB • Microsoft.EntityFrameworkCore.Query.Internal.BufferedDataReader+BufferedDataRecord.DoubleBufferCapacity()\r\n     100%  ReadRow • 1.48 GB / - • Microsoft.EntityFrameworkCore.Query.Internal.BufferedDataReader+BufferedDataRecord.ReadRow()\r\n       100%  MoveNext • 1.48 GB / - • Microsoft.EntityFrameworkCore.Query.Internal.BufferedDataReader+BufferedDataRecord+<InitializeAsync>d__90.MoveNext()\r\n         100%  RunInternal • 1.48 GB / - • System.Threading.ExecutionContext.RunInternal(ExecutionContext, ContextCallback, Object)\r\n           100%  MoveNext • 1.48 GB / - • System.Runtime.CompilerServices.AsyncTaskMethodBuilder+AsyncStateMachineBox<TResult, TStateMachine>.MoveNext(Thread)\r\n             100%  RunOrScheduleAction • 1.48 GB / - • System.Threading.Tasks.AwaitTaskContinuation.RunOrScheduleAction(IAsyncStateMachineBox, Boolean)\r\n               100%  RunContinuations • 1.48 GB / - • System.Threading.Tasks.Task.RunContinuations(Object)\r\n                 100%  CompleteAsyncCall • 1.48 GB / - • Microsoft.Data.SqlClient.SqlDataReader.CompleteAsyncCall<T>(Task<TResult>, SqlDataReader+SqlDataReaderBaseAsyncCallContext<T>)\r\n                   100%  RunFromThreadPoolDispatchLoop • 1.48 GB / - • System.Threading.ExecutionContext.RunFromThreadPoolDispatchLoop(Thread, ExecutionContext, ContextCallback, Object)\r\n                     100%  ExecuteWithThreadLocal • 1.48 GB / - • System.Threading.Tasks.Task.ExecuteWithThreadLocal(Task, Thread)\r\n                       100%  Dispatch • 1.48 GB / - • System.Threading.ThreadPoolWorkQueue.Dispatch()\r\n                         100%  WorkerDoWork • 1.48 GB / - • System.Threading.PortableThreadPool+WorkerThread.WorkerDoWork(PortableThreadPool, Boolean)\r\n                           100%  WorkerThreadStart • 1.48 GB / - • System.Threading.PortableThreadPool+WorkerThread.WorkerThreadStart()\r\n                             100%  RunWorker • 1.48 GB / - • System.Threading.Thread+StartHelper.RunWorker()\r\n                               100%  Run • 1.48 GB / - • System.Threading.Thread+StartHelper.Run()\r\n                                 100%  StartCallback • 1.48 GB / - • System.Threading.Thread.StartCallback()\r\n                                  ►  100%  [AllThreadsRoot] • 1.48 GB / - • [AllThreadsRoot]\r\n\r\n#stacktrace\r\n```\r\n\r\n### Include provider and version information\r\n\r\nEF Core version: 8.0.0-rtm.23513.13\r\nDatabase provider: Microsoft.EntityFrameworkCore.SqlServer\r\nTarget framework: .NET 8.0\r\nOperating system: macOS Sonoma\r\nIDE: JetBrains Rider 2023.3 EAP 2\r\n","closed_by":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/32052/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/32052/timeline","performed_via_github_app":null,"state_reason":"completed"}