{"url":"https://api.github.com/repos/dotnet/efcore/issues/28805","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/28805/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/28805/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/28805/events","html_url":"https://github.com/dotnet/efcore/issues/28805","id":1345285903,"node_id":"I_kwDOAPaMMs5QL28P","number":28805,"title":"Stored procs with TPH doesn't work with multiple subtypes","user":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1900941009,"node_id":"MDU6TGFiZWwxOTAwOTQxMDA5","url":"https://api.github.com/repos/dotnet/efcore/labels/area-save-changes","name":"area-save-changes","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/128","html_url":"https://github.com/dotnet/efcore/milestone/128","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/128/labels","id":7236796,"node_id":"MI_kwDOAPaMMs4Abmy8","number":128,"title":"7.0.0","description":"EF Core 7.0","creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":375,"state":"closed","created_at":"2021-10-09T18:57:40Z","updated_at":"2024-11-13T16:14:22Z","due_on":null,"closed_at":"2022-11-05T18:37:45Z"},"comments":1,"created_at":"2022-08-20T20:47:31Z","updated_at":"2025-06-15T18:51:43Z","closed_at":"2022-08-25T16:43:52Z","author_association":"CONTRIBUTOR","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Start with sample here: https://github.com/dotnet/EntityFramework.Docs/pull/3989\r\n\r\nChange Program.cs to run `StoredProcedureMappingSample.Inset_Update_and_Delete_using_stored_procedures_with_TPH();`\r\n\r\n```\r\nfail: 8/20/2022 21:47:02.279 RelationalEventId.CommandError[20102] (Microsoft.EntityFrameworkCore.Database.Command)\r\n      Failed executing DbCommand (24ms) [Parameters=[@p0='Book' (Nullable = false) (Size = 4000), @p1='Extreme Programming Explained' (Nullable = false) (Size = 4000), @p2='190', @p3='2000-01-01T00:00:00.0000000', @p4=NULL (Size = 8000) (DbType = Binary), @p5='201-61641-6' (Size = 4000), @p6='Book' (Nullable =\r\nfalse) (Size = 4000), @p7='Java Puzzlers' (Nullable = false) (Size = 4000), @p8='283', @p9='2005-01-01T00:00:00.0000000', @p10=NULL (Size = 8000) (DbType = Binary), @p11='0-321-33678-X' (Size = 4000), @p12='Book' (Nullable = false) (Size = 4000), @p13='Effective Java' (Nullable = false) (Size = 4000), @p14='252\r\n', @p15='2001-01-01T00:00:00.0000000', @p16='0x010203040506070809' (Size = 8000), @p17='0-201-31005-8' (Size = 4000), @p18='Book' (Nullable = false) (Size = 4000), @p19='Test-Driven Development By Example' (Nullable = false) (Size = 4000), @p20='220', @p21='2003-01-01T00:00:00.0000000', @p22=NULL (Size = 8000)\r\n(DbType = Binary), @p23='0-321-14653-0' (Size = 4000), @p24='Kent Beck' (Nullable = false) (Size = 4000), @p25='Joshua Bloch' (Nullable = false) (Size = 4000), @p26='Neal Gafter' (Nullable = false) (Size = 4000), @p27='Simon Rockman' (Nullable = false) (Size = 4000)], CommandType='Text', CommandTimeout='30']\r\n      SET NOCOUNT ON;\r\n      EXEC [Document_Insert] @p0, @p1, @p2, @p3, @p4, @p5;\r\n      EXEC [Document_Insert] @p6, @p7, @p8, @p9, @p10, @p11;\r\n      EXEC [Document_Insert] @p12, @p13, @p14, @p15, @p16, @p17;\r\n      EXEC [Document_Insert] @p18, @p19, @p20, @p21, @p22, @p23;\r\n      EXEC [Person_Insert] @p24;\r\n      EXEC [Person_Insert] @p25;\r\n      EXEC [Person_Insert] @p26;\r\n      EXEC [Person_Insert] @p27;\r\nfail: 8/20/2022 21:47:02.294 CoreEventId.SaveChangesFailed[10000] (Microsoft.EntityFrameworkCore.Update)\r\n      An exception occurred in the database while saving changes for context type 'NewInEfCore7.TphDocumentsContext'.\r\n      Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.\r\n       ---> Microsoft.Data.SqlClient.SqlException (0x80131904): Procedure or function 'Document_Insert' expects parameter '@CoverPrice', which was not supplied.\r\n      Procedure or function 'Document_Insert' expects parameter '@CoverPrice', which was not supplied.\r\n      Procedure or function 'Document_Insert' expects parameter '@CoverPrice', which was not supplied.\r\n      Procedure or function 'Document_Insert' expects parameter '@CoverPrice', which was not supplied.\r\n         at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)\r\n         at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)\r\n         at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)\r\n         at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)\r\n         at Microsoft.Data.SqlClient.SqlDataReader.TryConsumeMetaData()\r\n         at Microsoft.Data.SqlClient.SqlDataReader.get_MetaData()\r\n         at Microsoft.Data.SqlClient.SqlCommand.FinishExecuteReader(SqlDataReader ds, RunBehavior runBehavior, String resetOptionsString, Boolean isInternal, Boolean forDescribeParameterEncryption, Boolean shouldCacheForAlwaysEncrypted)\r\n         at Microsoft.Data.SqlClient.SqlCommand.RunExecuteReaderTds(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, Boolean isAsync, Int32 timeout, Task& task, Boolean asyncWrite, Boolean inRetry, SqlDataReader ds, Boolean describeParameterEncryptionRequest)\r\n         at Microsoft.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, TaskCompletionSource`1 completion, Int32 timeout, Task& task, Boolean& usedCache, Boolean asyncWrite, Boolean inRetry, String method)\r\n         at Microsoft.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method)\r\n         at Microsoft.Data.SqlClient.SqlCommand.ExecuteReader(CommandBehavior behavior)\r\n         at Microsoft.Data.SqlClient.SqlCommand.ExecuteDbDataReader(CommandBehavior behavior)\r\n         at System.Data.Common.DbCommand.ExecuteReader()\r\n         at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReader(RelationalCommandParameterObject parameterObject)\r\n         at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.Execute(IRelationalConnection connection)\r\n      ClientConnectionId:c8c014cf-98e9-4691-91c7-4ed9b89ef0ae\r\n      Error Number:201,State:4,Class:16\r\n         --- End of inner exception stack trace ---\r\n         at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.Execute(IRelationalConnection connection)\r\n         at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.Execute(IRelationalConnection connection)\r\n         at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.Execute(IEnumerable`1 commandBatches, IRelationalConnection connection)\r\n         at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChanges(IList`1 entries)\r\n         at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(IList`1 entriesToSave)\r\n         at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(StateManager stateManager, Boolean acceptAllChangesOnSuccess)\r\n         at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.<>c.<SaveChanges>b__107_0(DbContext _, ValueTuple`2 t)\r\n         at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.Execute[TState,TResult](TState state, Func`3 operation, Func`3 verifySucceeded)\r\n         at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(Boolean acceptAllChangesOnSuccess)\r\n         at Microsoft.EntityFrameworkCore.DbContext.SaveChanges(Boolean acceptAllChangesOnSuccess)\r\nUnhandled exception. Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.\r\n ---> Microsoft.Data.SqlClient.SqlException (0x80131904): Procedure or function 'Document_Insert' expects parameter '@CoverPrice', which was not supplied.\r\nProcedure or function 'Document_Insert' expects parameter '@CoverPrice', which was not supplied.\r\nProcedure or function 'Document_Insert' expects parameter '@CoverPrice', which was not supplied.\r\nProcedure or function 'Document_Insert' expects parameter '@CoverPrice', which was not supplied.\r\n   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)\r\n   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)\r\n   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)\r\n   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)\r\n   at Microsoft.Data.SqlClient.SqlDataReader.TryConsumeMetaData()\r\n   at Microsoft.Data.SqlClient.SqlDataReader.get_MetaData()\r\n   at Microsoft.Data.SqlClient.SqlCommand.FinishExecuteReader(SqlDataReader ds, RunBehavior runBehavior, String resetOptionsString, Boolean isInternal, Boolean forDescribeParameterEncryption, Boolean shouldCacheForAlwaysEncrypted)\r\n   at Microsoft.Data.SqlClient.SqlCommand.RunExecuteReaderTds(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, Boolean isAsync, Int32 timeout, Task& task, Boolean asyncWrite, Boolean inRetry, SqlDataReader ds, Boolean describeParameterEncryptionRequest)\r\n   at Microsoft.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, TaskCompletionSource`1 completion, Int32 timeout, Task& task, Boolean& usedCache, Boolean asyncWrite, Boolean inRetry, String method)\r\n   at Microsoft.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method)\r\n   at Microsoft.Data.SqlClient.SqlCommand.ExecuteReader(CommandBehavior behavior)\r\n   at Microsoft.Data.SqlClient.SqlCommand.ExecuteDbDataReader(CommandBehavior behavior)\r\n   at System.Data.Common.DbCommand.ExecuteReader()\r\n   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReader(RelationalCommandParameterObject parameterObject)\r\n   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.Execute(IRelationalConnection connection)\r\nClientConnectionId:c8c014cf-98e9-4691-91c7-4ed9b89ef0ae\r\nError Number:201,State:4,Class:16\r\n   --- End of inner exception stack trace ---\r\n   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.Execute(IRelationalConnection connection)\r\n   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.Execute(IRelationalConnection connection)\r\n   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.Execute(IEnumerable`1 commandBatches, IRelationalConnection connection)\r\n   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChanges(IList`1 entries)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(IList`1 entriesToSave)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(StateManager stateManager, Boolean acceptAllChangesOnSuccess)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.<>c.<SaveChanges>b__107_0(DbContext _, ValueTuple`2 t)\r\n   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.Execute[TState,TResult](TState state, Func`3 operation, Func`3 verifySucceeded)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(Boolean acceptAllChangesOnSuccess)\r\n   at Microsoft.EntityFrameworkCore.DbContext.SaveChanges(Boolean acceptAllChangesOnSuccess)\r\n   at Microsoft.EntityFrameworkCore.DbContext.SaveChanges()\r\n   at NewInEfCore7.DocumentsContext.Seed() in C:\\github\\EntityFramework.Docs\\samples\\core\\Miscellaneous\\NewInEFCore7\\DocumentsContext.cs:line 564\r\n   at NewInEfCore7.StoredProcedureMappingSample.SprocMappingTest[TContext]() in C:\\github\\EntityFramework.Docs\\samples\\core\\Miscellaneous\\NewInEFCore7\\StoredProcedureMappingSample.cs:line 40\r\n   at NewInEfCore7.StoredProcedureMappingSample.Inset_Update_and_Delete_using_stored_procedures_with_TPH() in C:\\github\\EntityFramework.Docs\\samples\\core\\Miscellaneous\\NewInEFCore7\\StoredProcedureMappingSample.cs:line 10\r\n   at Program.Main() in C:\\github\\EntityFramework.Docs\\samples\\core\\Miscellaneous\\NewInEFCore7\\Program.cs:line 25\r\n```","closed_by":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/28805/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/28805/timeline","performed_via_github_app":null,"state_reason":"completed"}