{"url":"https://api.github.com/repos/dotnet/efcore/issues/31547","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/31547/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/31547/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/31547/events","html_url":"https://github.com/dotnet/efcore/issues/31547","id":1865402006,"node_id":"I_kwDOAPaMMs5vL8aW","number":31547,"title":"Specifying enum typed discriminator on an entity type results in opaque ArgumentExceptions at query time","user":{"login":"ZTonks","id":21169977,"node_id":"MDQ6VXNlcjIxMTY5OTc3","avatar_url":"https://avatars.githubusercontent.com/u/21169977?v=4","gravatar_id":"","url":"https://api.github.com/users/ZTonks","html_url":"https://github.com/ZTonks","followers_url":"https://api.github.com/users/ZTonks/followers","following_url":"https://api.github.com/users/ZTonks/following{/other_user}","gists_url":"https://api.github.com/users/ZTonks/gists{/gist_id}","starred_url":"https://api.github.com/users/ZTonks/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ZTonks/subscriptions","organizations_url":"https://api.github.com/users/ZTonks/orgs","repos_url":"https://api.github.com/users/ZTonks/repos","events_url":"https://api.github.com/users/ZTonks/events{/privacy}","received_events_url":"https://api.github.com/users/ZTonks/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1686778100,"node_id":"MDU6TGFiZWwxNjg2Nzc4MTAw","url":"https://api.github.com/repos/dotnet/efcore/labels/area-cosmos","name":"area-cosmos","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/152","html_url":"https://github.com/dotnet/efcore/milestone/152","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/152/labels","id":8392036,"node_id":"MI_kwDOAPaMMs4AgA1k","number":152,"title":"8.0.0","description":"EF Core 8.0","creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":280,"state":"closed","created_at":"2022-09-07T19:55:36Z","updated_at":"2025-04-07T08:59:46Z","due_on":null,"closed_at":"2023-11-14T14:00:33Z"},"comments":2,"created_at":"2023-08-24T15:26:15Z","updated_at":"2025-06-15T19:50:51Z","closed_at":"2023-10-03T00:08:52Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## File a bug\r\n\r\n[x] Please check that the documentation does not explain the behavior you are seeing.\r\n[x] Please search in both open and closed issues to check that your bug has not already been filed.\r\n\r\n### Description\r\n\r\nWhen specifying a discriminator on an enum typed value for a model, a fairly opaque `ArgumentException` is thrown at runtime when querying the `DbSet` referencing the model. This was found using the CosmosDb provider.\r\n\r\nThe exception is resolved if removing the discriminator or specifying a string typed discriminator.\r\n\r\nI believe the bottom of the stack trace is [in this class](https://github.com/dotnet/efcore/blob/cf9391b184ffa61593e3253e7fc364e4ffa5f316/src/EFCore.Relational/Query/RelationalStructuralTypeShaperExpression.cs#L79C17-L79C110) but cannot be more specific without codemaps. `typeof(string)` is used fairly liberally throughout within the `Constant`s which leads me to believe only string typed discriminators are supported.\r\n\r\nShould targeting an enum type with an enum type discriminator be supported?\r\n\r\nIf it shouldn't be supported (at least with the Cosmos provider):\r\n1. Could we exclude enum types from being targeted as discriminator at compile time?\r\n2. If this isn't possible, could we throw a less opaque runtime error?\r\n3. Could this be done at model building time rather than at query time?\r\n\r\n### Include your code\r\n\r\nMinimal non working example follows:\r\n\r\n```C#\r\n// MyAppContext.cs\r\npublic class MyAppContext : DbContext\r\n{\r\n   public MyAppContext(\r\n      DbContextOptions<MyAppContext> dbContextOptions)\r\n         : base(dbContextOptions)\r\n   {\r\n   }\r\n\r\n   public virtual DbSet<Model> MyModels => Set<Model>();\r\n\r\n   protected override void OnModelCreating(ModelBuilder modelBuilder)\r\n   {\r\n      modelBuilder.Entity<Model>()\r\n            .ToContainer(nameof(Model))\r\n            .HasDiscriminator(m => m.MyEnum); // Apparently wrong\r\n\r\n      base.OnModelCreating(modelBuilder);\r\n   }\r\n}\r\n\r\n// MyEnum.cs\r\npublic enum MyEnum\r\n{\r\n   Foo,\r\n   Bar,\r\n}\r\n\r\n// Model.cs\r\npublic class Model\r\n{\r\n   public string Id { get; set; } = string.Empty;\r\n\r\n   public MyEnum MyEnum { get; set; } // I am chosen as the EF discriminator\r\n}\r\n\r\n// Program.cs\r\nvar services = Host.CreateDefaultBuilder(args)\r\n    .ConfigureServices(o =>\r\n        o.AddDbContext<MyAppContext>(j => j.UseCosmos(\r\n            \"https://localhost:8081\",\r\n            { accountkey },\r\n            \"MyTest\"),\r\n        ServiceLifetime.Singleton))\r\n    .Build()\r\n    .Services;\r\n\r\nvar appContext = services.GetRequiredService<MyAppContext>();\r\n\r\nawait appContext.Database.EnsureCreatedAsync();\r\n\r\nvar model = new Model\r\n{\r\n    Id = Guid.NewGuid().ToString(),\r\n    MyEnum = MyEnum.Foo,\r\n};\r\n\r\nappContext.MyModels.Add(model);\r\n\r\nawait appContext.SaveChangesAsync();\r\n\r\nvar myModels = await appContext.MyModels.ToListAsync(); // Throws\r\n\r\n```\r\n\r\n### Include stack traces\r\n\r\n```\r\nSystem.ArgumentException: 'Argument types do not match'\r\n   at System.Linq.Expressions.Expression.Constant(Object value, Type type)\r\n   at Microsoft.EntityFrameworkCore.Query.EntityShaperExpression.GenerateMaterializationCondition(IEntityType entityType, Boolean nullable)\r\n   at Microsoft.EntityFrameworkCore.Query.EntityShaperExpression..ctor(IEntityType entityType, Expression valueBufferExpression, Boolean nullable, LambdaExpression materializationCondition)\r\n   at Microsoft.EntityFrameworkCore.Cosmos.Query.Internal.CosmosQueryableMethodTranslatingExpressionVisitor.CreateShapedQueryExpression(IEntityType entityType, Expression queryExpression)\r\n   at Microsoft.EntityFrameworkCore.Query.QueryableMethodTranslatingExpressionVisitor.VisitExtension(Expression extensionExpression)\r\n   at System.Linq.Expressions.Expression.Accept(ExpressionVisitor visitor)\r\n   at Microsoft.EntityFrameworkCore.Cosmos.Query.Internal.CosmosQueryableMethodTranslatingExpressionVisitor.Visit(Expression expression)\r\n   at Microsoft.EntityFrameworkCore.Query.QueryCompilationContext.CreateQueryExecutor[TResult](Expression query)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.<>c__DisplayClass12_0`1.<ExecuteAsync>b__0()\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.CompiledQueryCache.GetOrAddQuery[TResult](Object cacheKey, Func`1 compiler)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.ExecuteAsync[TResult](Expression query, CancellationToken cancellationToken)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.EntityQueryProvider.ExecuteAsync[TResult](Expression expression, CancellationToken cancellationToken)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.EntityQueryable`1.GetAsyncEnumerator(CancellationToken cancellationToken)\r\n   at Microsoft.EntityFrameworkCore.Internal.InternalDbSet`1.System.Collections.Generic.IAsyncEnumerable<TEntity>.GetAsyncEnumerator(CancellationToken cancellationToken)\r\n   at System.Runtime.CompilerServices.ConfiguredCancelableAsyncEnumerable`1.GetAsyncEnumerator()\r\n   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.<ToListAsync>d__65`1.MoveNext()\r\n   at Program.<<Main>$>d__0.MoveNext() in C:\\Projects\\ef-bug-mwe\\Program.cs:line 30\r\n```\r\n\r\n### Include provider and version information\r\n\r\nEF Core version: 6.0.21\r\nDatabase provider: Microsoft.EntityFrameworkCore.Cosmos\r\nTarget framework: .NET 6.0\r\nOperating system: Windows\r\nIDE: Visual Studio 2022 17.4","closed_by":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/31547/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/31547/timeline","performed_via_github_app":null,"state_reason":"completed"}