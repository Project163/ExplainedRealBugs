{"url":"https://api.github.com/repos/dotnet/efcore/issues/32430","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/32430/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/32430/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/32430/events","html_url":"https://github.com/dotnet/efcore/issues/32430","id":2014092047,"node_id":"I_kwDOAPaMMs54DJsP","number":32430,"title":"Property conversions are lost on base type is subtype is registered to model afterwards after upgrade to EFCore 8","user":{"login":"zlepper","id":1499810,"node_id":"MDQ6VXNlcjE0OTk4MTA=","avatar_url":"https://avatars.githubusercontent.com/u/1499810?v=4","gravatar_id":"","url":"https://api.github.com/users/zlepper","html_url":"https://github.com/zlepper","followers_url":"https://api.github.com/users/zlepper/followers","following_url":"https://api.github.com/users/zlepper/following{/other_user}","gists_url":"https://api.github.com/users/zlepper/gists{/gist_id}","starred_url":"https://api.github.com/users/zlepper/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zlepper/subscriptions","organizations_url":"https://api.github.com/users/zlepper/orgs","repos_url":"https://api.github.com/users/zlepper/repos","events_url":"https://api.github.com/users/zlepper/events{/privacy}","received_events_url":"https://api.github.com/users/zlepper/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":514908713,"node_id":"MDU6TGFiZWw1MTQ5MDg3MTM=","url":"https://api.github.com/repos/dotnet/efcore/labels/regression","name":"regression","color":"ff1fff","default":false,"description":null},{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1017558838,"node_id":"MDU6TGFiZWwxMDE3NTU4ODM4","url":"https://api.github.com/repos/dotnet/efcore/labels/Servicing-approved","name":"Servicing-approved","color":"048708","default":false,"description":""},{"id":1900941630,"node_id":"MDU6TGFiZWwxOTAwOTQxNjMw","url":"https://api.github.com/repos/dotnet/efcore/labels/area-model-building","name":"area-model-building","color":"32b37b","default":false,"description":""},{"id":1901073050,"node_id":"MDU6TGFiZWwxOTAxMDczMDUw","url":"https://api.github.com/repos/dotnet/efcore/labels/area-type-mapping","name":"area-type-mapping","color":"32b37b","default":false,"description":""},{"id":4725071141,"node_id":"LA_kwDOAPaMMs8AAAABGaLdJQ","url":"https://api.github.com/repos/dotnet/efcore/labels/area-primitive-collections","name":"area-primitive-collections","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/186","html_url":"https://github.com/dotnet/efcore/milestone/186","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/186/labels","id":10201144,"node_id":"MI_kwDOAPaMMs4Am6g4","number":186,"title":"8.0.2","description":null,"creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":44,"state":"closed","created_at":"2023-11-17T09:03:59Z","updated_at":"2024-05-05T12:55:36Z","due_on":null,"closed_at":"2024-04-09T08:40:11Z"},"comments":1,"created_at":"2023-11-28T10:13:39Z","updated_at":"2025-06-15T19:54:59Z","closed_at":"2024-01-04T15:09:50Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## File a bug\r\n\r\nIf you register a property converter on a type, and then register a subclass of that type, the property converter is lost. (At least for primitive collections, i have no tested complex types). Instead EF uses the new automatic json conversion available for collections of primitive types. \r\n\r\nThis used to work fine in EFCore 7.\r\n\r\nThis is currently breaking all existing data we have that was written to the database with EF 7 and below, which is quite bad. Unit tests did not catch this on our side when we upgraded as they always generate new data and ended up just using the default json converter. \r\n\r\n\r\n### Include your code\r\nDb context:\r\n```c#\r\nusing System.Diagnostics;\r\nusing Microsoft.EntityFrameworkCore;\r\nusing Microsoft.EntityFrameworkCore.Infrastructure;\r\nusing Microsoft.EntityFrameworkCore.Metadata;\r\n\r\nnamespace something;\r\n\r\npublic class MyDbContext : DbContext\r\n{\r\n    public DbSet<MyBaseClass> MyThings { get; set; } = null!;\r\n\r\n    private Action<ModelBuilder> _modelBuilderAction;\r\n\r\n    public MyDbContext(DbContextOptions options, Action<ModelBuilder> modelBuilderAction) : base(options)\r\n    {\r\n        _modelBuilderAction = modelBuilderAction;\r\n    }\r\n\r\n    protected override void OnModelCreating(ModelBuilder modelBuilder)\r\n    {\r\n        _modelBuilderAction(modelBuilder);\r\n        base.OnModelCreating(modelBuilder);\r\n    }\r\n\r\n    public static void Works(ModelBuilder modelBuilder)\r\n    {\r\n        \r\n        modelBuilder.Entity<MyConcreteClass>();\r\n        modelBuilder.Entity<MyBaseClass>(myBaseClass =>\r\n        {\r\n            myBaseClass.Property(c => c.SomeGuids).HasConversion(gs => string.Join(',', gs),\r\n                s => s.Split(',', StringSplitOptions.RemoveEmptyEntries).Select(Guid.Parse).ToList());\r\n        });\r\n        var prop = modelBuilder.Model.FindEntityType(typeof(MyBaseClass))!.FindProperty(nameof(MyBaseClass.SomeGuids))!;\r\n        ConversionBrokeException.ThrowIfPrimitive(prop);\r\n\r\n        throw new Exception(\"Worked: \" + prop.DeclaringType.Model.ToDebugString(MetadataDebugStringOptions.LongDefault));\r\n    }\r\n\r\n    public static void Broken(ModelBuilder modelBuilder)\r\n    {\r\n        \r\n        modelBuilder.Entity<MyBaseClass>(myBaseClass =>\r\n        {\r\n            myBaseClass.Property(c => c.SomeGuids).HasConversion(gs => string.Join(',', gs),\r\n                s => s.Split(',', StringSplitOptions.RemoveEmptyEntries).Select(Guid.Parse).ToList());\r\n        });\r\n        var prop = modelBuilder.Model.FindEntityType(typeof(MyBaseClass))!.FindProperty(nameof(MyBaseClass.SomeGuids))!;\r\n        ConversionBrokeException.ThrowIfPrimitive(prop);\r\n\r\n        modelBuilder.Entity<MyConcreteClass>();\r\n        ConversionBrokeException.ThrowIfPrimitive(prop);\r\n    }\r\n}\r\n\r\npublic abstract class MyBaseClass\r\n{\r\n    public int Id { get; set; }\r\n    \r\n    public List<Guid> SomeGuids { get; set; } = new();\r\n}\r\n\r\npublic class MyConcreteClass : MyBaseClass\r\n{\r\n    \r\n}\r\n\r\npublic class ConversionBrokeException : Exception\r\n{\r\n    public ConversionBrokeException(string? message) : base(message)\r\n    {\r\n    }\r\n\r\n    public static void ThrowIfPrimitive(IMutableProperty prop)\r\n    {\r\n        if (prop.IsPrimitiveCollection)\r\n        {\r\n            throw new ConversionBrokeException(prop.DeclaringType.Model.ToDebugString(MetadataDebugStringOptions.LongDefault));\r\n        }\r\n    }\r\n}\r\n\r\n```\r\nUnit tests\r\n```c#\r\nusing Microsoft.EntityFrameworkCore;\r\nusing NUnit.Framework;\r\n\r\nnamespace something;\r\n\r\n[TestFixture]\r\npublic class MyTests\r\n{\r\n    [Test]\r\n    public void Works()\r\n    {\r\n        Assert.That(() =>\r\n        {\r\n            var opts = new DbContextOptionsBuilder<MyDbContext>().UseSqlServer(\"\").Options;\r\n            var ctx = new MyDbContext(opts, MyDbContext.Works);\r\n            ctx.MyThings.ToList();\r\n        }, Throws.Exception.Not.TypeOf<ConversionBrokeException>());\r\n    }\r\n    \r\n// This tests fails as the ConversionBrokeException is thrown.\r\n    [Test]\r\n    public void Broken()\r\n    {\r\n        Assert.That(() =>\r\n        {\r\n            var opts = new DbContextOptionsBuilder<MyDbContext>().UseSqlServer(\"\").Options;\r\n            var ctx = new MyDbContext(opts, MyDbContext.Broken);\r\n            ctx.MyThings.ToList();\r\n        }, Throws.Exception.Not.TypeOf<ConversionBrokeException>());\r\n    }\r\n}\r\n\r\n```\r\n\r\nZip with entire project should be attached also\r\n[efwtf.zip](https://github.com/dotnet/efcore/files/13486543/efwtf.zip)\r\n\r\n### Include stack traces\r\n\r\nI'm throwing the exceptions myself in the example code to make it clear that stuff has broken. \r\n\r\n### Include provider and version information\r\n\r\nEF Core version:8.0.0\r\nDatabase provider:Microsoft.EntityFrameworkCore.SqlServer\r\nTarget framework: net8.0\r\nOperating system: Windows 10\r\nIDE:\r\n```\r\nJetBrains Rider 2023.2.3\r\nBuild #RD-232.10203.29, built on November 1, 2023\r\nLicensed to XXX\r\nYou have a perpetual fallback license for this version.\r\nSubscription is active until September 19, 2024.\r\nRuntime version: 17.0.8.1+7-b1000.32 amd64\r\nVM: OpenJDK 64-Bit Server VM by JetBrains s.r.o.\r\nWindows 10.0\r\n.NET Core v7.0.7 x64 (Server GC)\r\nGC: G1 Young Generation, G1 Old Generation\r\nMemory: 12000M\r\nCores: 64\r\nRegistry:\r\n    vcs.empty.toolwindow.show=false\r\n    eslint.additional.file.extensions=svelte\r\n    ide.new.project.model.index.case.sensitivity=true\r\n    database.show.search.tab=false\r\n    http.client.file.variables.available=true\r\n\r\nNon-Bundled Plugins:\r\n    org.jetbrains.plugins.go-template (232.9921.89)\r\n    Batch Scripts Support (1.0.13)\r\n    com.github.copilot (1.4.2.3864)\r\n    com.intellij.plugin.adernov.powershell (2.3.0)\r\n    org.intellij.plugins.hcl (232.8660.88)\r\n    org.toml.lang (232.8660.88)\r\n    idea.plugin.protoeditor (232.9559.10)\r\n    com.intellij.kubernetes (232.10203.2)\r\n    com.intellij.bigdatatools.core (232.10203.10)\r\n    dev.blachut.svelte.lang (232.9921.36)\r\n    verify-rider (2023.2.0)\r\n\r\n```\r\n\r\n\r\n### Additional information\r\nWorking model:\r\n```\r\nModel: \r\n  EntityType: MyBaseClass Abstract\r\n    Properties: \r\n      Id (int) Required PK AfterSave:Throw ValueGenerated.OnAdd\r\n      Discriminator (no field, string) Shadow Required AfterSave:Throw\r\n        Annotations: \r\n          AfterSaveBehavior: Throw\r\n          ValueGeneratorFactoryType: Microsoft.EntityFrameworkCore.ValueGeneration.DiscriminatorValueGeneratorFactory\r\n      SomeGuids (List<Guid>) Required\r\n        Annotations: \r\n          ProviderClrType: \r\n          ValueConverter: Microsoft.EntityFrameworkCore.Storage.ValueConversion.ValueConverter`2[System.Collections.Generic.List`1[System.Guid],System.String]\r\n    Keys: \r\n      Id PK\r\n    Annotations: \r\n      DiscriminatorProperty: Discriminator\r\n      DiscriminatorValue: MyBaseClass\r\n      Relational:TableName: MyThings\r\n      RelationshipDiscoveryConvention:NavigationCandidates: System.Collections.Immutable.ImmutableSortedDictionary`2[System.Reflection.PropertyInfo,System.ValueTuple`2[System.Type,System.Nullable`1[System.Boolean]]]\r\n  EntityType: MyConcreteClass Base: MyBaseClass\r\n    Annotations: \r\n      DiscriminatorValue: MyConcreteClass\r\n      RelationshipDiscoveryConvention:NavigationCandidates: System.Collections.Immutable.ImmutableSortedDictionary`2[System.Reflection.PropertyInfo,System.ValueTuple`2[System.Type,System.Nullable`1[System.Boolean]]]\r\nAnnotations: \r\n  BaseTypeDiscoveryConvention:DerivedTypes: System.Collections.Generic.Dictionary`2[System.Type,System.Collections.Generic.List`1[Microsoft.EntityFrameworkCore.Metadata.IConventionEntityType]]\r\n  NonNullableConventionState: System.Reflection.NullabilityInfoContext\r\n  ProductVersion: 8.0.0\r\n  Relational:MaxIdentifierLength: 128\r\n  RelationshipDiscoveryConvention:InverseNavigationCandidates: System.Collections.Generic.Dictionary`2[System.Type,System.Collections.Generic.SortedSet`1[System.Type]]\r\n  SqlServer:ValueGenerationStrategy: IdentityColumn\r\n```\r\n\r\n\r\nBroken model:\r\n```\r\nModel: \r\n  EntityType: MyBaseClass Abstract\r\n    Properties: \r\n      Id (int) Required PK AfterSave:Throw ValueGenerated.OnAdd\r\n      Discriminator (no field, string) Shadow Required AfterSave:Throw\r\n        Annotations: \r\n          AfterSaveBehavior: Throw\r\n          ValueGeneratorFactoryType: Microsoft.EntityFrameworkCore.ValueGeneration.DiscriminatorValueGeneratorFactory\r\n      SomeGuids (List<Guid>) Required Element type: Guid Required\r\n        Annotations: \r\n          ElementType: Element type: Guid Required\r\n          ProviderClrType: \r\n          ValueConverter: \r\n          ValueConverterType: \r\n    Keys: \r\n      Id PK\r\n    Annotations: \r\n      DiscriminatorProperty: Discriminator\r\n      DiscriminatorValue: MyBaseClass\r\n      Relational:TableName: MyThings\r\n      RelationshipDiscoveryConvention:NavigationCandidates: System.Collections.Immutable.ImmutableSortedDictionary`2[System.Reflection.PropertyInfo,System.ValueTuple`2[System.Type,System.Nullable`1[System.Boolean]]]\r\n  EntityType: MyConcreteClass Base: MyBaseClass\r\n    Annotations: \r\n      DiscriminatorValue: MyConcreteClass\r\n      RelationshipDiscoveryConvention:NavigationCandidates: System.Collections.Immutable.ImmutableSortedDictionary`2[System.Reflection.PropertyInfo,System.ValueTuple`2[System.Type,System.Nullable`1[System.Boolean]]]\r\nAnnotations: \r\n  BaseTypeDiscoveryConvention:DerivedTypes: System.Collections.Generic.Dictionary`2[System.Type,System.Collections.Generic.List`1[Microsoft.EntityFrameworkCore.Metadata.IConventionEntityType]]\r\n  NonNullableConventionState: System.Reflection.NullabilityInfoContext\r\n  ProductVersion: 8.0.0\r\n  Relational:MaxIdentifierLength: 128\r\n  RelationshipDiscoveryConvention:InverseNavigationCandidates: System.Collections.Generic.Dictionary`2[System.Type,System.Collections.Generic.SortedSet`1[System.Type]]\r\n  SqlServer:ValueGenerationStrategy: IdentityColumn\r\n```\r\n","closed_by":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/32430/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/32430/timeline","performed_via_github_app":null,"state_reason":"completed"}