{"url":"https://api.github.com/repos/dotnet/efcore/issues/30575","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/30575/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/30575/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/30575/events","html_url":"https://github.com/dotnet/efcore/issues/30575","id":1639440762,"node_id":"I_kwDOAPaMMs5ht-F6","number":30575,"title":"Multiple LeftJoins (GroupJoins) lead to GroupJoin Exception when the same where is used twice","user":{"login":"Mr-Pearce","id":13457314,"node_id":"MDQ6VXNlcjEzNDU3MzE0","avatar_url":"https://avatars.githubusercontent.com/u/13457314?v=4","gravatar_id":"","url":"https://api.github.com/users/Mr-Pearce","html_url":"https://github.com/Mr-Pearce","followers_url":"https://api.github.com/users/Mr-Pearce/followers","following_url":"https://api.github.com/users/Mr-Pearce/following{/other_user}","gists_url":"https://api.github.com/users/Mr-Pearce/gists{/gist_id}","starred_url":"https://api.github.com/users/Mr-Pearce/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Mr-Pearce/subscriptions","organizations_url":"https://api.github.com/users/Mr-Pearce/orgs","repos_url":"https://api.github.com/users/Mr-Pearce/repos","events_url":"https://api.github.com/users/Mr-Pearce/events{/privacy}","received_events_url":"https://api.github.com/users/Mr-Pearce/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1017558838,"node_id":"MDU6TGFiZWwxMDE3NTU4ODM4","url":"https://api.github.com/repos/dotnet/efcore/labels/Servicing-approved","name":"Servicing-approved","color":"048708","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/165","html_url":"https://github.com/dotnet/efcore/milestone/165","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/165/labels","id":9168950,"node_id":"MI_kwDOAPaMMs4Ai-g2","number":165,"title":"7.0.7","description":null,"creator":{"login":"rbhanda","id":30737530,"node_id":"MDQ6VXNlcjMwNzM3NTMw","avatar_url":"https://avatars.githubusercontent.com/u/30737530?v=4","gravatar_id":"","url":"https://api.github.com/users/rbhanda","html_url":"https://github.com/rbhanda","followers_url":"https://api.github.com/users/rbhanda/followers","following_url":"https://api.github.com/users/rbhanda/following{/other_user}","gists_url":"https://api.github.com/users/rbhanda/gists{/gist_id}","starred_url":"https://api.github.com/users/rbhanda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rbhanda/subscriptions","organizations_url":"https://api.github.com/users/rbhanda/orgs","repos_url":"https://api.github.com/users/rbhanda/repos","events_url":"https://api.github.com/users/rbhanda/events{/privacy}","received_events_url":"https://api.github.com/users/rbhanda/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":9,"state":"closed","created_at":"2023-03-16T17:19:58Z","updated_at":"2023-11-14T13:53:13Z","due_on":null,"closed_at":"2023-06-22T17:34:17Z"},"comments":5,"created_at":"2023-03-24T13:55:06Z","updated_at":"2025-06-15T19:01:06Z","closed_at":"2023-05-04T08:52:37Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## File a bug\r\n\r\nThe code below (doesntwork) throws \r\n\r\n```\r\nThe LINQ expression 'DbSet<Message>()\r\n    .GroupJoin(\r\n        inner: DbSet<Recipient>(), \r\n        outerKeySelector: message => message.Id, \r\n        innerKeySelector: recipient => recipient.Message.Id, \r\n        resultSelector: (message, recipientGrouping) => new { \r\n            message = message, \r\n            recipientGrouping = recipientGrouping\r\n         })' could not be translated. Either rewrite the query in a form that can be translated, or switch to client evaluation explicitly by inserting a call to 'AsEnumerable', 'AsAsyncEnumerable', 'ToList', or 'ToListAsync'. See https://go.microsoft.com/fwlink/?linkid=2101038 for more information.\r\n```\r\n\r\nbut the other two are working fine.\r\n\r\nThe Generated SQL is from npgsql Core but the same exception happens with the InMemoryDatabase in the example project.\r\n\r\n### Include your code\r\n[BrokenLeftJoin.zip](https://github.com/dotnet/efcore/files/11062534/BrokenLeftJoin.zip)\r\nExample is in the `Program.cs`\r\n\r\n```C#\r\nGuid userId = Guid.Parse(\"a74fe6ee-11ae-4cc2-bdbe-6e9e880db745\");\r\n```\r\n```C#\r\nvar works = await (\r\n\tfrom message in dbcontext.Messages\r\n\tjoin recipient in dbcontext.Recipient\r\n\t\ton message.Id equals recipient.Message.Id into recipientGrouping\r\n\tfrom recipientg in recipientGrouping.Where(x => x.UserId == Guid.Parse(\"a74fe6ee-11ae-4cc2-bdbe-6e9e880db745\")).DefaultIfEmpty()\r\n\tjoin reads in dbcontext.ReadBy\r\n\t\ton message.Id equals reads.Message.Id into readsGrouping\r\n\tfrom readsg in readsGrouping.Where(x => x.UserId == Guid.Parse(\"a74fe6ee-11ae-4cc2-bdbe-6e9e880db745\")).DefaultIfEmpty()\r\n\tselect new { message, recipientg, readsg }\r\n\t\t ).ToListAsync();\r\n```\r\n```SQL\r\n//works  creates\r\nExecuting DbCommand [Parameters=[], CommandType='Text', CommandTimeout='30']\r\nSELECT m.\"Id\", t.\"Id\", t.\"MessageId\", t.\"UserId\", t0.\"Id\", t0.\"MessageId\", t0.\"UserId\"\r\nFROM dbo.\"Message\" AS m\r\nLEFT JOIN (\r\n  SELECT r.\"Id\", r.\"MessageId\", r.\"UserId\", m0.\"Id\" AS \"Id0\"\r\n  FROM dbo.\"Recipient\" AS r\r\n  INNER JOIN dbo.\"Message\" AS m0 ON r.\"MessageId\" = m0.\"Id\"\r\n  WHERE r.\"UserId\" = 'a74fe6ee-11ae-4cc2-bdbe-6e9e880db745'\r\n) AS t ON m.\"Id\" = t.\"Id0\"\r\nLEFT JOIN (\r\n  SELECT r0.\"Id\", r0.\"MessageId\", r0.\"UserId\", m1.\"Id\" AS \"Id0\"\r\n  FROM dbo.\"ReadBy\" AS r0\r\n  INNER JOIN dbo.\"Message\" AS m1 ON r0.\"MessageId\" = m1.\"Id\"\r\n  WHERE r0.\"UserId\" = 'a74fe6ee-11ae-4cc2-bdbe-6e9e880db745'\r\n) AS t0 ON m.\"Id\" = t0.\"Id0\"\r\n```\r\n\r\n\r\n```C#\r\nvar workstoo = await (\r\n\tfrom message in dbcontext.Messages\r\n\tjoin recipient in dbcontext.Recipient\r\n\t\ton message.Id equals recipient.Message.Id into recipientGrouping\r\n\tfrom recipientg in recipientGrouping.Where(x => x.UserId == Guid.Parse(\"a74fe6ee-11ae-4cc2-bdbe-6e9e880db745\")).DefaultIfEmpty()\r\n\tjoin reads in dbcontext.ReadBy\r\n\t\ton message.Id equals reads.Message.Id into readsGrouping\r\n\tfrom readsg in readsGrouping.Where(x => x.UserId == userId).DefaultIfEmpty()\r\n\tselect new { message, recipientg, readsg }\r\n ).ToListAsync();\r\n```\r\n```SQL\r\n//workstoo creates\r\nExecuting DbCommand [Parameters=[@__userId_0='a74fe6ee-11ae-4cc2-bdbe-6e9e880db745'], CommandType='Text', CommandTimeout='30']\r\nSELECT m.\"Id\", t.\"Id\", t.\"MessageId\", t.\"UserId\", t0.\"Id\", t0.\"MessageId\", t0.\"UserId\"\r\nFROM dbo.\"Message\" AS m\r\nLEFT JOIN (\r\n  SELECT r.\"Id\", r.\"MessageId\", r.\"UserId\", m0.\"Id\" AS \"Id0\"\r\n  FROM dbo.\"Recipient\" AS r\r\n  INNER JOIN dbo.\"Message\" AS m0 ON r.\"MessageId\" = m0.\"Id\"\r\n  WHERE r.\"UserId\" = 'a74fe6ee-11ae-4cc2-bdbe-6e9e880db745'\r\n) AS t ON m.\"Id\" = t.\"Id0\"\r\nLEFT JOIN LATERAL (\r\n  SELECT r0.\"Id\", r0.\"MessageId\", r0.\"UserId\"\r\n  FROM dbo.\"ReadBy\" AS r0\r\n  INNER JOIN dbo.\"Message\" AS m1 ON r0.\"MessageId\" = m1.\"Id\"\r\n  WHERE m.\"Id\" = m1.\"Id\" AND r0.\"UserId\" = @__userId_0\r\n) AS t0 ON TRUE\r\n```\r\n\r\n\r\n```C#\r\n//Throws Groupjoin Exception\r\nvar dosntwork = await (from message in dbcontext.Messages\r\n\t\t\t\t\t   join recipient in dbcontext.Recipient\r\n\t\t\t\t\t\t\ton message.Id equals recipient.Message.Id into recipientGrouping\r\n\t\t\t\t\t   from recipientg in recipientGrouping.Where(x => x.UserId == userId).DefaultIfEmpty()\r\n\t\t\t\t\t   join reads in dbcontext.ReadBy\r\n\t\t\t\t\t\t\ton message.Id equals reads.Message.Id into readsGrouping\r\n\t\t\t\t\t   from readsg in readsGrouping.Where(x => x.UserId == userId).DefaultIfEmpty()\r\n\t\t\t\t\t   select new { message, recipientg, readsg }\r\n\t\t\t\t\t\t ).ToListAsync();\r\n```\r\n\r\n### Include stack traces\r\n\r\n### Include verbose output\r\n\r\nPlease include `--verbose` output when filing bugs about the `dotnet ef` or Package Manager Console tools.\r\n\r\nUse triple-tick fences for tool output. For example:\r\n\r\n```\r\nPS C:\\SVN\\test\\BrokenLeftJoin\\BrokenLeftJoin> dotnet ef dbcontext list --verbose\r\nUsing project 'C:\\SVN\\test\\BrokenLeftJoin\\BrokenLeftJoin\\BrokenLeftJoin.csproj'.\r\nUsing startup project 'C:\\SVN\\test\\BrokenLeftJoin\\BrokenLeftJoin\\BrokenLeftJoin.csproj'.\r\nWriting 'C:\\SVN\\test\\BrokenLeftJoin\\BrokenLeftJoin\\obj\\BrokenLeftJoin.csproj.EntityFrameworkCore.targets'...\r\ndotnet msbuild /target:GetEFProjectMetadata \"/property:EFProjectMetadataFile=C:\\Users\\Me\\AppData\\Local\\Temp\\tmpFCE2.tmp\" /verbosity:quiet /nologo C:\\SVN\\test\\BrokenLeftJoin\\BrokenLeftJoin\\BrokenLeftJoin.csproj\r\nWriting 'C:\\SVN\\test\\BrokenLeftJoin\\BrokenLeftJoin\\obj\\BrokenLeftJoin.csproj.EntityFrameworkCore.targets'...\r\ndotnet msbuild /target:GetEFProjectMetadata \"/property:EFProjectMetadataFile=C:\\Users\\Me\\AppData\\Local\\Temp\\tmpFF64.tmp\" /verbosity:quiet /nologo C:\\SVN\\test\\BrokenLeftJoin\\BrokenLeftJoin\\BrokenLeftJoin.csproj\r\nBuild started...\r\ndotnet build C:\\SVN\\test\\BrokenLeftJoin\\BrokenLeftJoin\\BrokenLeftJoin.csproj /verbosity:quiet /nologo\r\nC:\\SVN\\test\\BrokenLeftJoin\\BrokenLeftJoin\\Program.cs(106,30): warning CS0168: Die Variable \"ex\" ist deklariert, wird aber nie verwendet. [C:\\SVN\\test\\BrokenLeftJoin\\BrokenLeftJoin\\BrokenLeftJoin.csproj]\r\n\r\nDer Buildvorgang wurde erfolgreich ausgef√ºhrt.\r\n\r\nC:\\SVN\\test\\BrokenLeftJoin\\BrokenLeftJoin\\Program.cs(106,30): warning CS0168: Die Variable \"ex\" ist deklariert, wird aber nie verwendet. [C:\\SVN\\test\\BrokenLeftJoin\\BrokenLeftJoin\\BrokenLeftJoin.csproj]\r\n    1 Warnung(en)\r\n    0 Fehler\r\n\r\nVerstrichene Zeit 00:00:01.76\r\nBuild succeeded.\r\ndotnet exec --depsfile C:\\SVN\\test\\BrokenLeftJoin\\BrokenLeftJoin\\bin\\Debug\\net7.0\\BrokenLeftJoin.deps.json --additionalprobingpath \"C:\\Users\\Me\\.nuget\\packages\" --additionalprobingpath \"C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\NuGetPackages\" --runtimeconfig C:\\SVN\\test\\BrokenLeftJoin\\BrokenLeftJoin\\bin\\Debug\\net7.0\\BrokenLeftJoin.runtimeconfig.json \"C:\\Users\\Me\\.dotnet\\tools\\.store\\dotnet-ef\\7.0.4\\dotnet-ef\\7.0.4\\tools\\net6.0\\any\\tools\\netcoreapp2.0\\any\\ef.dll\" dbcontext list --assembly C:\\SVN\\test\\BrokenLeftJoin\\BrokenLeftJoin\\bin\\Debug\\net7.0\\BrokenLeftJoin.dll --project C:\\SVN\\test\\BrokenLeftJoin\\BrokenLeftJoin\\BrokenLeftJoin.csproj --startup-assembly C:\\SVN\\test\\BrokenLeftJoin\\BrokenLeftJoin\\bin\\Debug\\net7.0\\BrokenLeftJoin.dll --startup-project C:\\SVN\\test\\BrokenLeftJoin\\BrokenLeftJoin\\BrokenLeftJoin.csproj --project-dir C:\\SVN\\test\\BrokenLeftJoin\\BrokenLeftJoin\\ --root-namespace BrokenLeftJoin --language C# --framework net7.0 --nullable --working-dir C:\\SVN\\test\\BrokenLeftJoin\\BrokenLeftJoin --verbose\r\nUsing assembly 'BrokenLeftJoin'.\r\nUsing startup assembly 'BrokenLeftJoin'.\r\nUsing application base 'C:\\SVN\\test\\BrokenLeftJoin\\BrokenLeftJoin\\bin\\Debug\\net7.0'.\r\nUsing working directory 'C:\\SVN\\test\\BrokenLeftJoin\\BrokenLeftJoin'.\r\nUsing root namespace 'BrokenLeftJoin'.\r\nUsing project directory 'C:\\SVN\\test\\BrokenLeftJoin\\BrokenLeftJoin\\'.\r\nRemaining arguments: .\r\nFinding DbContext classes...\r\nFinding IDesignTimeDbContextFactory implementations...\r\nFinding application service provider in assembly 'BrokenLeftJoin'...\r\nFinding Microsoft.Extensions.Hosting service provider...\r\nUsing environment 'Development'.\r\nUsing application service provider from Microsoft.Extensions.Hosting.\r\nFound DbContext 'TestDbContext'.\r\nFinding DbContext classes in the project...\r\nBrokenLeftJoin.TestDbContext\r\n```\r\n\r\n### Include provider and version information\r\n\r\nEF Core version:\r\nDatabase providers: \r\nMicrosoft.EntityFrameworkCore.InMemory 7.0.4\r\nNpgsql.EntityFrameworkCore.PostgreSQL 7.0.4\r\nTarget framework: (e.g. .NET 7.0)\r\nOperating system:\r\nIDE: (e.g. Visual Studio 2022 17.5.2)\r\n","closed_by":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/30575/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/30575/timeline","performed_via_github_app":null,"state_reason":"completed"}