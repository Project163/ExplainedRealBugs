{"url":"https://api.github.com/repos/dotnet/efcore/issues/31664","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/31664/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/31664/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/31664/events","html_url":"https://github.com/dotnet/efcore/issues/31664","id":1887987696,"node_id":"I_kwDOAPaMMs5wiGfw","number":31664,"title":"A property on a nested owned entity is not being saved in the CosmosDB document","user":{"login":"martinw6","id":144471667,"node_id":"U_kgDOCJx2cw","avatar_url":"https://avatars.githubusercontent.com/u/144471667?v=4","gravatar_id":"","url":"https://api.github.com/users/martinw6","html_url":"https://github.com/martinw6","followers_url":"https://api.github.com/users/martinw6/followers","following_url":"https://api.github.com/users/martinw6/following{/other_user}","gists_url":"https://api.github.com/users/martinw6/gists{/gist_id}","starred_url":"https://api.github.com/users/martinw6/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martinw6/subscriptions","organizations_url":"https://api.github.com/users/martinw6/orgs","repos_url":"https://api.github.com/users/martinw6/repos","events_url":"https://api.github.com/users/martinw6/events{/privacy}","received_events_url":"https://api.github.com/users/martinw6/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":526662235,"node_id":"MDU6TGFiZWw1MjY2NjIyMzU=","url":"https://api.github.com/repos/dotnet/efcore/labels/breaking-change","name":"breaking-change","color":"d93f0b","default":false,"description":null},{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1686778100,"node_id":"MDU6TGFiZWwxNjg2Nzc4MTAw","url":"https://api.github.com/repos/dotnet/efcore/labels/area-cosmos","name":"area-cosmos","color":"32b37b","default":false,"description":""},{"id":1900941630,"node_id":"MDU6TGFiZWwxOTAwOTQxNjMw","url":"https://api.github.com/repos/dotnet/efcore/labels/area-model-building","name":"area-model-building","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/152","html_url":"https://github.com/dotnet/efcore/milestone/152","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/152/labels","id":8392036,"node_id":"MI_kwDOAPaMMs4AgA1k","number":152,"title":"8.0.0","description":"EF Core 8.0","creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":280,"state":"closed","created_at":"2022-09-07T19:55:36Z","updated_at":"2025-04-07T08:59:46Z","due_on":null,"closed_at":"2023-11-14T14:00:33Z"},"comments":2,"created_at":"2023-09-08T16:29:09Z","updated_at":"2025-06-15T19:51:25Z","closed_at":"2023-10-03T00:08:25Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"While developing our application I have noticed what appears to be some strange behaviour with the Entity Framework CosmosDB provider (we are using the Microsoft.EntityFrameworkCore.Cosmos NuGet package version 6.0.8).\r\n\r\nWe have a 'User' entity that has a nested owned entity (a referrer), the referrer references the ID of another user entity.\r\n\r\nWhen the user entity is saved, the property on the nested owned entity is not saved at all when the property on the C# record is called 'UserId'. If it is called anything else then it is saved successfully.\r\n\r\nI'm not sure if this behaviour is expected or if it is a bug, so I thought it could be worth reporting.\r\n\r\nI have managed to replicate the issue in a simplified form in a console app using the code below:\r\n\r\n```C#\r\nusing Microsoft.EntityFrameworkCore; //using Microsoft.EntityFrameworkCore.Cosmos 6.0.8\r\n\r\nnamespace CosmosDbTestApp\r\n{\r\n    public class Program\r\n    {\r\n        public static async Task Main(string[] args)\r\n        {\r\n            using (var context = new MyDbContext())\r\n            {\r\n                await context.Database.EnsureDeletedAsync();\r\n                await context.Database.EnsureCreatedAsync();\r\n\r\n                var user1 = new User\r\n                {\r\n                    Id = \"1\",\r\n                    Name = \"Bob\"\r\n                };\r\n\r\n                context.Add(user1);\r\n                \r\n                await context.SaveChangesAsync();\r\n                \r\n                var user2 = new User\r\n                {\r\n                    Id = \"2\",\r\n                    Name = \"Fred\",\r\n                    Referrer = new Referrer\r\n                    {\r\n                        UserId = \"1\",\r\n                        ReasonForReferral = \"IntroductionByFriend\"\r\n                    }\r\n                };\r\n\r\n                context.Add(user2);\r\n\r\n                await context.SaveChangesAsync();\r\n            }\r\n        }\r\n    }\r\n\r\n    public class MyDbContext : DbContext\r\n    {\r\n        public DbSet<User> Users { get; set; }\r\n\r\n        protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)\r\n            => optionsBuilder.UseCosmos(\r\n                \"https://REDACTED.documents.azure.com:443/\",\r\n                \"REDACTED\",\r\n                \"TestDb\");\r\n\r\n        protected override void OnModelCreating(ModelBuilder modelBuilder)\r\n        {\r\n            modelBuilder.Entity<User>()\r\n                .ToContainer(nameof(User))\r\n                .HasNoDiscriminator()\r\n                .HasPartitionKey(d => d.Id)\r\n                .HasKey(d => d.Id);\r\n            \r\n            modelBuilder.Entity<User>()\r\n                .Property(d => d.Id);\r\n\r\n            modelBuilder.Entity<User>().OwnsOne(\r\n                o => o.Referrer,\r\n                r =>\r\n                {\r\n                    r.Property(p => p.UserId);\r\n                    r.Property(p => p.ReasonForReferral);\r\n                });\r\n        }\r\n    }\r\n\r\n    public record User\r\n    {\r\n        public string Id { get; set; }\r\n        public string Name { get; set; } = default!;\r\n        public Referrer? Referrer { get; set; }\r\n    }\r\n\r\n    public record Referrer\r\n    {\r\n        // If this property is named anything other than 'UserId' everything works as expected.\r\n        // if it is called 'UserId' then this property is not saved in the Cosmos document JSON.\r\n        public string UserId { get; set; }\r\n        public string ReasonForReferral { get; set; } = default!;\r\n    }\r\n}\r\n```\r\n\r\nRunning this code saves two entities like this, as you can see the second user is missing the '\"UserId\": \"1\"' property:\r\n\r\n<img width=\"822\" alt=\"1\" src=\"https://github.com/dotnet/efcore/assets/144471667/19a6f242-789f-4e0d-b90f-b33f97985dab\">\r\n\r\nIf the 'UserId' on the 'Referrer' C# record is renamed to something else, then it saves as expected:\r\n\r\n<img width=\"711\" alt=\"2\" src=\"https://github.com/dotnet/efcore/assets/144471667/e16c472a-0809-4bc5-b7b0-aafa6b464b04\">\r\n\r\nMy guess was that this could be something to do with the way the implicit shadow primary key is working as mentioned here:\r\n\r\nhttps://learn.microsoft.com/en-us/ef/core/modeling/owned-entities#implicit-keys\r\n\r\nSo I tried adding a key to the nested entity. This saves a 'UserId' property on the referrer, but it saves it with the UserId of the current entity (a 2 instead of a 1):\r\n\r\n```C#\r\nusing Microsoft.EntityFrameworkCore; //using Microsoft.EntityFrameworkCore.Cosmos 6.0.8\r\n\r\nnamespace CosmosDbTestApp\r\n{\r\n    public class Program\r\n    {\r\n        public static async Task Main(string[] args)\r\n        {\r\n            using (var context = new MyDbContext())\r\n            {\r\n                await context.Database.EnsureDeletedAsync();\r\n                await context.Database.EnsureCreatedAsync();\r\n\r\n                var user1 = new User\r\n                {\r\n                    Id = \"1\",\r\n                    Name = \"Bob\"\r\n                };\r\n\r\n                context.Add(user1);\r\n                \r\n                await context.SaveChangesAsync();\r\n                \r\n                var user2 = new User\r\n                {\r\n                    Id = \"2\",\r\n                    Name = \"Fred\",\r\n                    Referrer = new Referrer\r\n                    {\r\n                        Id = \"R1\",\r\n                        UserId = \"1\",\r\n                        ReasonForReferral = \"IntroductionByFriend\"\r\n                    }\r\n                };\r\n\r\n                context.Add(user2);\r\n\r\n                await context.SaveChangesAsync();\r\n            }\r\n        }\r\n    }\r\n\r\n    public class MyDbContext : DbContext\r\n    {\r\n        public DbSet<User> Users { get; set; }\r\n\r\n        protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)\r\n            => optionsBuilder.UseCosmos(\r\n                \"https://REDACTED.documents.azure.com:443/\",\r\n                \"REDACTED\",\r\n                \"TestDb\");\r\n\r\n        protected override void OnModelCreating(ModelBuilder modelBuilder)\r\n        {\r\n            modelBuilder.Entity<User>()\r\n                .ToContainer(nameof(User))\r\n                .HasNoDiscriminator()\r\n                .HasPartitionKey(d => d.Id)\r\n                .HasKey(d => d.Id);\r\n            \r\n            modelBuilder.Entity<User>()\r\n                .Property(d => d.Id);\r\n\r\n            modelBuilder.Entity<User>().OwnsOne(\r\n                o => o.Referrer,\r\n                r =>\r\n                {\r\n                    r.HasKey(p => p.Id);\r\n                    r.Property(p => p.UserId);\r\n                    r.Property(p => p.ReasonForReferral);\r\n                });\r\n        }\r\n    }\r\n\r\n    public record User\r\n    {\r\n        public string Id { get; set; }\r\n        public string Name { get; set; } = default!;\r\n        public Referrer? Referrer { get; set; }\r\n    }\r\n\r\n    public record Referrer\r\n    {\r\n        public string Id { get; set; } // Adding an explicit key to the nested entity make it save, but with the wrong ID, it uses the ID (2 instead of 1)\r\n        \r\n        // If this property is named anything other than 'UserId' everything works as expected.\r\n        // if it is called 'UserId' then this property is not saved in the Cosmos document JSON.\r\n        public string UserId { get; set; }\r\n        public string ReasonForReferral { get; set; } = default!;\r\n    }\r\n}\r\n```\r\n\r\n<img width=\"851\" alt=\"3\" src=\"https://github.com/dotnet/efcore/assets/144471667/2dc255c2-08f0-4fcb-acaa-c1ce72de93b7\">\r\n\r\nI also tried adding 'ToJsonProperty(\"UserId\")' on the referrer user ID mapping like this:\r\n\r\n```C#\r\nmodelBuilder.Entity<User>().OwnsOne(\r\n        o => o.Referrer,\r\n       r =>\r\n       {\r\n              r.Property(p => p.UserId).ToJsonProperty(\"UserId\");\r\n              r.Property(p => p.ReasonForReferral);\r\n        });\r\n\r\n```\r\n\r\nHowever this also results in the wrong ID being saved (2 instead of 1).\r\n\r\nI am thinking this must have something to do with the fact that the property on the nested owned entity has the same name as the entity ('User') plus the name of the 'key' property for the main entity ('Id').\r\n\r\nThe simple workaround is to use a different name for this property (which is what we have done), but it would be good to get an understanding why Entity Framework is behaving this way or if we have done something wrong in the mapping.\r\n\r\n","closed_by":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/31664/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/31664/timeline","performed_via_github_app":null,"state_reason":"completed"}