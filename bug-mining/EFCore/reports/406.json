{"url":"https://api.github.com/repos/dotnet/efcore/issues/31890","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/31890/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/31890/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/31890/events","html_url":"https://github.com/dotnet/efcore/issues/31890","id":1917277826,"node_id":"I_kwDOAPaMMs5yR1aC","number":31890,"title":"Concurrency Detector loses lock when multiple contexts are used in a thread.","user":{"login":"poymanovm","id":132376206,"node_id":"U_kgDOB-Pmjg","avatar_url":"https://avatars.githubusercontent.com/u/132376206?v=4","gravatar_id":"","url":"https://api.github.com/users/poymanovm","html_url":"https://github.com/poymanovm","followers_url":"https://api.github.com/users/poymanovm/followers","following_url":"https://api.github.com/users/poymanovm/following{/other_user}","gists_url":"https://api.github.com/users/poymanovm/gists{/gist_id}","starred_url":"https://api.github.com/users/poymanovm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/poymanovm/subscriptions","organizations_url":"https://api.github.com/users/poymanovm/orgs","repos_url":"https://api.github.com/users/poymanovm/repos","events_url":"https://api.github.com/users/poymanovm/events{/privacy}","received_events_url":"https://api.github.com/users/poymanovm/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1902925253,"node_id":"MDU6TGFiZWwxOTAyOTI1MjUz","url":"https://api.github.com/repos/dotnet/efcore/labels/area-dbcontext","name":"area-dbcontext","color":"32b37b","default":false,"description":""},{"id":2402623482,"node_id":"MDU6TGFiZWwyNDAyNjIzNDgy","url":"https://api.github.com/repos/dotnet/efcore/labels/community-contribution","name":"community-contribution","color":"004caa","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/180","html_url":"https://github.com/dotnet/efcore/milestone/180","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/180/labels","id":9963267,"node_id":"MI_kwDOAPaMMs4AmAcD","number":180,"title":"9.0.0","description":null,"creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":339,"state":"closed","created_at":"2023-09-25T15:41:58Z","updated_at":"2025-04-01T18:19:15Z","due_on":null,"closed_at":"2024-11-14T11:54:05Z"},"comments":2,"created_at":"2023-09-28T11:15:22Z","updated_at":"2025-06-15T19:52:16Z","closed_at":"2024-02-05T10:05:27Z","author_association":"CONTRIBUTOR","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Concurrency Detector loses lock when multiple contexts are used in a thread.\r\n\r\nI have a caching layer that loads an entity in a separate context. Subsequently, the entity is detached from this separate context and attached back to the original context. Simplified, this can be represented like this:\r\n```c#\r\n    private static Customer GetOrderCustomerFromCahce(int orderId, Context originalCtx)\r\n    {\r\n       // init \"cache\"\r\n        var context = new Context();\r\n        var orders = context.Orders.ToArray();\r\n        var order = orders.First(o => o.OrderId == orderId);\r\n\r\n\r\n        context.Entry(order).State = EntityState.Detached;\r\n        context.Dispose();\r\n\r\n        var orderCopy = new Order(originalCtx.GetService<ILazyLoader>())\r\n        {\r\n            OrderId = order.OrderId,\r\n            OrderDate = order.OrderDate,\r\n            CustomerId = order.CustomerId\r\n        };\r\n\r\n        var entity = originalCtx.Attach(orderCopy);\r\n\r\n        entity.State = EntityState.Unchanged;\r\n\r\n        return orderCopy.Customer;\r\n    }\r\n``` \r\nAnd the code that uses this cache in a request within the original context\r\n```c#\r\ncontext.Orders.Select(o => new { Date = o.OrderDate, Name = GetOrderCustomerFromCahce(o.OrderId, context) }\r\n``` \r\n–ênd as a result, I get an exception\r\n```\r\nInvalidOperationException: A second operation was started on this context instance before a previous operation completed. This is usually caused by different threads concurrently using the same instance of DbContext. For more information on how to avoid threading issues with DbContext, see https://go.microsoft.com/fwlink/?linkid=2097913.\r\n``` \r\n\r\nThe issue occurs because the ConcurrencyDetector tracks lock acquisition using a static AsyncLocal<bool> variable. This variable is shared between contexts on a single thread.\r\nhttps://github.com/dotnet/efcore/blob/ea24bdd61de394dd82972be560db79b3fda050ee/src/EFCore/Infrastructure/Internal/ConcurrencyDetector.cs#L15\r\n\r\nTherefore, if we have a request in the second context inside a request in the first context, the inner request clears the lock acquisition mark for the first context.\r\n\r\nIt can be fixed by changing the AsyncLocal variable type from bool to int and tracking not only the fact of lock acquisition but also the total number of locks held by the thread.\r\n\r\nI made a [PR](https://github.com/dotnet/efcore/issues/31890) with these small changes, and it also contains a unit test that fails without my changes, reproducing the described problem.\r\n\r\n\r\nEF Core version: 7.0\r\nDatabase provider: Microsoft.EntityFrameworkCore.SqlServer)\r\nTarget framework: NET 6.0\r\n\r\n","closed_by":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/31890/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/31890/timeline","performed_via_github_app":null,"state_reason":"completed"}