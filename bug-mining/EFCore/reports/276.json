{"url":"https://api.github.com/repos/dotnet/efcore/issues/31539","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/31539/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/31539/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/31539/events","html_url":"https://github.com/dotnet/efcore/issues/31539","id":1863281924,"node_id":"I_kwDOAPaMMs5vD20E","number":31539,"title":"Memory Issue with EF Core 7 DbContext ServiceProviderCache","user":{"login":"easaevik","id":29543642,"node_id":"MDQ6VXNlcjI5NTQzNjQy","avatar_url":"https://avatars.githubusercontent.com/u/29543642?v=4","gravatar_id":"","url":"https://api.github.com/users/easaevik","html_url":"https://github.com/easaevik","followers_url":"https://api.github.com/users/easaevik/followers","following_url":"https://api.github.com/users/easaevik/following{/other_user}","gists_url":"https://api.github.com/users/easaevik/gists{/gist_id}","starred_url":"https://api.github.com/users/easaevik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/easaevik/subscriptions","organizations_url":"https://api.github.com/users/easaevik/orgs","repos_url":"https://api.github.com/users/easaevik/repos","events_url":"https://api.github.com/users/easaevik/events{/privacy}","received_events_url":"https://api.github.com/users/easaevik/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1017558838,"node_id":"MDU6TGFiZWwxMDE3NTU4ODM4","url":"https://api.github.com/repos/dotnet/efcore/labels/Servicing-approved","name":"Servicing-approved","color":"048708","default":false,"description":""},{"id":1901073050,"node_id":"MDU6TGFiZWwxOTAxMDczMDUw","url":"https://api.github.com/repos/dotnet/efcore/labels/area-type-mapping","name":"area-type-mapping","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/182","html_url":"https://github.com/dotnet/efcore/milestone/182","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/182/labels","id":9968313,"node_id":"MI_kwDOAPaMMs4AmBq5","number":182,"title":"6.0.24","description":null,"creator":{"login":"rbhanda","id":30737530,"node_id":"MDQ6VXNlcjMwNzM3NTMw","avatar_url":"https://avatars.githubusercontent.com/u/30737530?v=4","gravatar_id":"","url":"https://api.github.com/users/rbhanda","html_url":"https://github.com/rbhanda","followers_url":"https://api.github.com/users/rbhanda/followers","following_url":"https://api.github.com/users/rbhanda/following{/other_user}","gists_url":"https://api.github.com/users/rbhanda/gists{/gist_id}","starred_url":"https://api.github.com/users/rbhanda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rbhanda/subscriptions","organizations_url":"https://api.github.com/users/rbhanda/orgs","repos_url":"https://api.github.com/users/rbhanda/repos","events_url":"https://api.github.com/users/rbhanda/events{/privacy}","received_events_url":"https://api.github.com/users/rbhanda/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":3,"state":"closed","created_at":"2023-09-26T17:20:33Z","updated_at":"2023-11-14T13:46:08Z","due_on":null,"closed_at":"2023-11-14T13:46:08Z"},"comments":18,"created_at":"2023-08-23T12:55:59Z","updated_at":"2025-06-15T19:50:47Z","closed_at":"2023-10-05T15:49:21Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"We have a .net 7 app using EF Core 7 running on Azure App Service. It's an API for both our web app and mobile app. Memory usage typically grows from 50MB to 3GB during peak hours (8-16) and only get released when things calm down at approximately 16 in the afternoon. During these 8 hours we have around 60k requests to our API. It's a multitenant app with Azure Sql database per tenant and approximately 180 tenants. We use ModelCacheKeyFactory to get correct global query filters for each tenant. Not only that, but we also have to differentiate between user roles in a tenant, given that we do authorization through EF Core global query filters.\r\n\r\n![image](https://github.com/dotnet/efcore/assets/29543642/23d32c30-3dbd-40b4-aae6-2c888be61873)\r\n\r\nNot sure what happens in the afternoon, but could it be IIS recycling? It's not restarting, that I have checked. Anyway, what could possibly cause such a big pile-up of memory in Gen 2 and the DbContext ServiceProviderCache?\r\n\r\n![image](https://github.com/dotnet/efcore/assets/29543642/7d560f56-6c31-4b8d-a1bf-ad62a07cdfa1)\r\n\r\n![image](https://github.com/dotnet/efcore/assets/29543642/2385ded1-2cb4-4998-ab32-beb4637002d1)\r\n\r\n![image](https://github.com/dotnet/efcore/assets/29543642/fb894cf1-3d71-4287-ab9a-1622c5abf0ff)\r\n\r\nAs for the code I have tried to short it down to the essentials. In out startup.cs we use services.AddDbContext<IXDbContext, XDbContext>(); so nothing fancy there, but in the DbContext there is a lot more going on:\r\n\r\n![image](https://github.com/dotnet/efcore/assets/29543642/7003ff04-fff3-4366-94a5-8585c1c51f90)\r\n\r\n![image](https://github.com/dotnet/efcore/assets/29543642/06955e25-72c0-4761-8a58-22900221b6e6)\r\n\r\nThe EntityDbContextManager uses reflection to get the correct Authorization handler:\r\n\r\n![image](https://github.com/dotnet/efcore/assets/29543642/f5ca61ec-e04e-48c8-8bb1-71cd493fb2e6)\r\n\r\nA typical Authorization handler for a given entity (i.e. User) looks like this:\r\n\r\n![image](https://github.com/dotnet/efcore/assets/29543642/7b232a18-501d-4cdc-88e1-c53eb90acb19)\r\n\r\nSo all in all a lot going on here. The question is why does ServiceProviderCache retain so much memory under load? The system works as it should, just not happy with all this retained bytes ending up in Gen 2. I fear there could be problems ahead as more tenants are added. Any help would be greatly appreciated.","closed_by":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/31539/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/31539/timeline","performed_via_github_app":null,"state_reason":"completed"}