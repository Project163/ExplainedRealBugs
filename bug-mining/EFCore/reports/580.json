{"url":"https://api.github.com/repos/dotnet/efcore/issues/35152","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/35152/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/35152/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/35152/events","html_url":"https://github.com/dotnet/efcore/issues/35152","id":2674005194,"node_id":"I_kwDOAPaMMs6fYhTK","number":35152,"title":"[Regression] Unexpected unbound variable error with closure","user":{"login":"BladeWise","id":127625,"node_id":"MDQ6VXNlcjEyNzYyNQ==","avatar_url":"https://avatars.githubusercontent.com/u/127625?v=4","gravatar_id":"","url":"https://api.github.com/users/BladeWise","html_url":"https://github.com/BladeWise","followers_url":"https://api.github.com/users/BladeWise/followers","following_url":"https://api.github.com/users/BladeWise/following{/other_user}","gists_url":"https://api.github.com/users/BladeWise/gists{/gist_id}","starred_url":"https://api.github.com/users/BladeWise/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BladeWise/subscriptions","organizations_url":"https://api.github.com/users/BladeWise/orgs","repos_url":"https://api.github.com/users/BladeWise/repos","events_url":"https://api.github.com/users/BladeWise/events{/privacy}","received_events_url":"https://api.github.com/users/BladeWise/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":514908713,"node_id":"MDU6TGFiZWw1MTQ5MDg3MTM=","url":"https://api.github.com/repos/dotnet/efcore/labels/regression","name":"regression","color":"ff1fff","default":false,"description":null},{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1017558838,"node_id":"MDU6TGFiZWwxMDE3NTU4ODM4","url":"https://api.github.com/repos/dotnet/efcore/labels/Servicing-approved","name":"Servicing-approved","color":"048708","default":false,"description":""},{"id":1675384372,"node_id":"MDU6TGFiZWwxNjc1Mzg0Mzcy","url":"https://api.github.com/repos/dotnet/efcore/labels/area-query","name":"area-query","color":"32b37b","default":false,"description":""},{"id":8130499638,"node_id":"LA_kwDOAPaMMs8AAAAB5J2UNg","url":"https://api.github.com/repos/dotnet/efcore/labels/preview-1","name":"preview-1","color":"ACB3D7","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/208","html_url":"https://github.com/dotnet/efcore/milestone/208","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/208/labels","id":11959183,"node_id":"MI_kwDOAPaMMs4AtnuP","number":208,"title":"9.0.1","description":"","creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":21,"state":"closed","created_at":"2024-11-27T13:18:00Z","updated_at":"2025-02-05T21:51:51Z","due_on":null,"closed_at":"2025-02-05T21:49:40Z"},"comments":4,"created_at":"2024-11-20T01:00:03Z","updated_at":"2025-06-15T20:12:07Z","closed_at":"2024-11-25T16:06:50Z","author_association":"CONTRIBUTOR","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Using EFCore 9 the following code (which uses a closure in an order-by condition)\n```C#\nstatic async Task OrderByClosureInt(SampleDbContext dbContext)\n{\n    int v = 1;\n    Expression<Func<Dummy, object>> f = x => v;\n    var q = dbContext.Set<Dummy>()\n                     .OrderBy(f);\n\n    await q.FirstOrDefaultAsync();\n}\n```\nthrows at runtime with the following error:\n```Shell\nSystem.InvalidOperationException: An exception was thrown while attempting to evaluate the LINQ query parameter expression 'x => Convert(__v_0, Object)'. See the inner exception for more information.\n       ---> System.InvalidOperationException: unbound variable: __v_0\n```\n<details>\n<summary>Stacktrace</summary>\n\n```Shell\n      System.InvalidOperationException: An exception was thrown while attempting to evaluate the LINQ query parameter expression 'x => Convert(__v_0, Object)'. See the inner exception for more information.\n       ---> System.InvalidOperationException: unbound variable: __v_0\n         at System.Linq.Expressions.Interpreter.LightCompiler.EnsureAvailableForClosure(ParameterExpression expr)\n         at System.Linq.Expressions.Interpreter.LightCompiler.CompileQuoteUnaryExpression(Expression expr)\n         at System.Linq.Expressions.Interpreter.LightCompiler.Compile(Expression expr)\n         at System.Linq.Expressions.Interpreter.LightCompiler.CompileConvertUnaryExpression(Expression expr)\n         at System.Linq.Expressions.Interpreter.LightCompiler.Compile(Expression expr)\n         at System.Linq.Expressions.Interpreter.LightCompiler.CompileTop(LambdaExpression node)\n         at System.Linq.Expressions.Expression`1.Compile(Boolean preferInterpretation)\n         at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.<Evaluate>g__EvaluateCore|70_0(Expression expression, String& parameterName, Boolean& isContextAccessor)\n         --- End of inner exception stack trace ---\n         at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.<Evaluate>g__EvaluateCore|70_0(Expression expression, String& parameterName, Boolean& isContextAccessor)\n         at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.Evaluate(Expression expression, String& parameterName, Boolean& isContextAccessor)\n         at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.ProcessEvaluatableRoot(Expression evaluatableRoot, State& state, Boolean forceEvaluation)\n         at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.EvaluateList(IReadOnlyList`1 expressions, State[] expressionStates, List`1& children, Func`2 pathFromParentGenerator)\n         at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.VisitMethodCall(MethodCallExpression methodCall)\n         at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.Visit(Expression expression)\n         at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.Visit[T](ReadOnlyCollection`1 expressions, Func`2 elementVisitor, StateType& aggregateStateType, State[]& expressionStates, Boolean poolExpressionStates)\n         at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.Visit(ReadOnlyCollection`1 expressions, StateType& aggregateStateType, State[]& expressionStates, Boolean poolExpressionStates)\n         at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.VisitMethodCall(MethodCallExpression methodCall)\n         at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.Visit(Expression expression, State& state)\n         at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.ExtractParameters(Expression expression, IParameterValues parameterValues, Boolean parameterize, Boolean clearParameterizedValues, Boolean precompiledQuery, IReadOnlySet`1& nonNullableReferenceTypeParameters)\n         at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.ExtractParameters(Expression expression, IParameterValues parameterValues, Boolean parameterize, Boolean clearParameterizedValues)\n         at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.ExtractParameters(Expression query, IParameterValues parameterValues, IDiagnosticsLogger`1 logger, Boolean compiledQuery, Boolean generateContextAccessors)\n         at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.ExecuteCore[TResult](Expression query, Boolean async, CancellationToken cancellationToken)\n         at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.ExecuteAsync[TResult](Expression query, CancellationToken cancellationToken)\n         at Microsoft.EntityFrameworkCore.Query.Internal.EntityQueryProvider.ExecuteAsync[TResult](Expression expression, CancellationToken cancellationToken)\n         at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.ExecuteAsync[TSource,TResult](MethodInfo operatorMethodInfo, IQueryable`1 source, Expression expression, CancellationToken cancellationToken)\n         at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.ExecuteAsync[TSource,TResult](MethodInfo operatorMethodInfo, IQueryable`1 source, CancellationToken cancellationToken)\n         at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.FirstOrDefaultAsync[TSource](IQueryable`1 source, CancellationToken cancellationToken)\n         at Program.<<Main>$>g__OrderByClosureInt|0_2(SampleDbContext dbContext) in C:\\repos\\EFIssueRepo\\EFIssueRepo\\Program.cs:line 67\n         at Program.<Main>$(String[] args) in C:\\repos\\EFIssueRepo\\EFIssueRepo\\Program.cs:line 52\n```\n</details>\n\nThe same code completes successfully using EFCore 8.\nMoreover, if the boxing is moved out of the expression like below\n```C#\nstatic async Task OrderByClosureInt(SampleDbContext dbContext)\n{\n    object v = 1;\n    Expression<Func<Dummy, object>> f = x => v;\n    var q = dbContext.Set<Dummy>()\n                     .OrderBy(f);\n\n    await q.FirstOrDefaultAsync();\n}\n```\nthe queryable is interpreted successfully.\n\nThe database provider is not relevant, because the exception is thrown at interpretation time (nevertheless, I have tested with both InMemory and PostgreSQL).\n\nI have created a [gist](https://gist.github.com/BladeWise/985506f66230c8cbe899ef79ad172e9d) to reproduce the issue\n<details>\n<summary>Gist output</summary>\n\n```Shell\ndbug: Microsoft.EntityFrameworkCore.Infrastructure[10401]\n      An 'IServiceProvider' was created for internal use by Entity Framework.\nwarn: Microsoft.EntityFrameworkCore.Model.Validation[10400]\n      Sensitive data logging is enabled. Log entries and exception messages may include sensitive application data; this mode should only be enabled during development.\ndbug: Microsoft.EntityFrameworkCore.Infrastructure[10403]\n      Entity Framework Core 9.0.0 initialized 'SampleDbContext' using provider 'Microsoft.EntityFrameworkCore.InMemory:9.0.0' with options: SensitiveDataLoggingEnabled StoreName=test\ndbug: Microsoft.EntityFrameworkCore.ChangeTracking[10806]\n      Context 'SampleDbContext' started tracking 'Dummy' entity with key '{Id: 1}'.\ndbug: Microsoft.EntityFrameworkCore.Update[10004]\n      SaveChanges starting for 'SampleDbContext'.\ndbug: Microsoft.EntityFrameworkCore.ChangeTracking[10800]\n      DetectChanges starting for 'SampleDbContext'.\ndbug: Microsoft.EntityFrameworkCore.ChangeTracking[10801]\n      DetectChanges completed for 'SampleDbContext'.\ninfo: Microsoft.EntityFrameworkCore.Update[30100]\n      Saved 1 entities to in-memory store.\ndbug: Microsoft.EntityFrameworkCore.ChangeTracking[10807]\n      The 'Dummy' entity with key '{Id: 1}' tracked by 'SampleDbContext' changed state from 'Added' to 'Unchanged'.\ndbug: Microsoft.EntityFrameworkCore.Update[10005]\n      SaveChanges completed for 'SampleDbContext' with 1 entities written to the database.\ninfo: Program[0]\n      Executing test OrderByClosureInt...\nfail: Program[0]\n      Test OrderByClosureInt failed\n      System.InvalidOperationException: An exception was thrown while attempting to evaluate the LINQ query parameter expression 'x => Convert(__v_0, Object)'. See the inner exception for more information.\n       ---> System.InvalidOperationException: unbound variable: __v_0\n         at System.Linq.Expressions.Interpreter.LightCompiler.EnsureAvailableForClosure(ParameterExpression expr)\n         at System.Linq.Expressions.Interpreter.LightCompiler.CompileQuoteUnaryExpression(Expression expr)\n         at System.Linq.Expressions.Interpreter.LightCompiler.Compile(Expression expr)\n         at System.Linq.Expressions.Interpreter.LightCompiler.CompileConvertUnaryExpression(Expression expr)\n         at System.Linq.Expressions.Interpreter.LightCompiler.Compile(Expression expr)\n         at System.Linq.Expressions.Interpreter.LightCompiler.CompileTop(LambdaExpression node)\n         at System.Linq.Expressions.Expression`1.Compile(Boolean preferInterpretation)\n         at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.<Evaluate>g__EvaluateCore|70_0(Expression expression, String& parameterName, Boolean& isContextAccessor)\n         --- End of inner exception stack trace ---\n         at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.<Evaluate>g__EvaluateCore|70_0(Expression expression, String& parameterName, Boolean& isContextAccessor)\n         at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.Evaluate(Expression expression, String& parameterName, Boolean& isContextAccessor)\n         at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.ProcessEvaluatableRoot(Expression evaluatableRoot, State& state, Boolean forceEvaluation)\n         at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.EvaluateList(IReadOnlyList`1 expressions, State[] expressionStates, List`1& children, Func`2 pathFromParentGenerator)\n         at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.VisitMethodCall(MethodCallExpression methodCall)\n         at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.Visit(Expression expression)\n         at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.Visit[T](ReadOnlyCollection`1 expressions, Func`2 elementVisitor, StateType& aggregateStateType, State[]& expressionStates, Boolean poolExpressionStates)\n         at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.Visit(ReadOnlyCollection`1 expressions, StateType& aggregateStateType, State[]& expressionStates, Boolean poolExpressionStates)\n         at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.VisitMethodCall(MethodCallExpression methodCall)\n         at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.Visit(Expression expression, State& state)\n         at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.ExtractParameters(Expression expression, IParameterValues parameterValues, Boolean parameterize, Boolean clearParameterizedValues, Boolean precompiledQuery, IReadOnlySet`1& nonNullableReferenceTypeParameters)\n         at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.ExtractParameters(Expression expression, IParameterValues parameterValues, Boolean parameterize, Boolean clearParameterizedValues)\n         at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.ExtractParameters(Expression query, IParameterValues parameterValues, IDiagnosticsLogger`1 logger, Boolean compiledQuery, Boolean generateContextAccessors)\n         at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.ExecuteCore[TResult](Expression query, Boolean async, CancellationToken cancellationToken)\n         at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.ExecuteAsync[TResult](Expression query, CancellationToken cancellationToken)\n         at Microsoft.EntityFrameworkCore.Query.Internal.EntityQueryProvider.ExecuteAsync[TResult](Expression expression, CancellationToken cancellationToken)\n         at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.ExecuteAsync[TSource,TResult](MethodInfo operatorMethodInfo, IQueryable`1 source, Expression expression, CancellationToken cancellationToken)\n         at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.ExecuteAsync[TSource,TResult](MethodInfo operatorMethodInfo, IQueryable`1 source, CancellationToken cancellationToken)\n         at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.FirstOrDefaultAsync[TSource](IQueryable`1 source, CancellationToken cancellationToken)\n         at Program.<<Main>$>g__OrderByClosureInt|0_2(SampleDbContext dbContext) in C:\\repos\\EFIssueRepo\\EFIssueRepo\\Program.cs:line 67\n         at Program.<Main>$(String[] args) in C:\\repos\\EFIssueRepo\\EFIssueRepo\\Program.cs:line 52\ninfo: Program[0]\n      Executing test OrderByClosureObject...\ndbug: Microsoft.EntityFrameworkCore.Query[10111]\n      Compiling query expression:\n      'DbSet<Dummy>()\n          .OrderBy(x => __v_0)\n          .FirstOrDefault()'\ndbug: Microsoft.EntityFrameworkCore.Query[10107]\n      Generated query execution expression:\n      'queryContext => ShapedQueryCompilingExpressionVisitor.SingleOrDefaultAsync<Dummy>(\n          asyncEnumerable: new QueryingEnumerable<Dummy>(\n              queryContext,\n              new ResultEnumerable(() => InMemoryShapedQueryCompilingExpressionVisitor.Table(\n                  queryContext: queryContext,\n                  entityType: EntityType: Dummy)\n                  .OrderBy(valueBuffer => InMemoryExpressionTranslatingExpressionVisitor.GetParameterValue<object>(\n                      queryContext: queryContext,\n                      parameterName: \"__v_0\"))\n                  .Select(valueBuffer => new ValueBuffer(new object[]{ (object)ExpressionExtensions.ValueBufferTryReadValue<int>(\n                      valueBuffer: valueBuffer,\n                      index: 0,\n                      property: Property: Dummy.Id (int) Required PK AfterSave:Throw ValueGenerated.OnAdd) }))\n                  .FirstOrDefault()),\n              Func<QueryContext, ValueBuffer, Dummy>,\n              SampleDbContext,\n              False,\n              True\n          ),\n          cancellationToken: queryContext.CancellationToken)'\ninfo: Program[0]\n      Test OrderByClosureObject succeeded\ndbug: Microsoft.EntityFrameworkCore.Infrastructure[10407]\n      'SampleDbContext' disposed.\n```\n</details>\n\n","closed_by":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/35152/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/35152/timeline","performed_via_github_app":null,"state_reason":"completed"}