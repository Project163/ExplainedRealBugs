{"url":"https://api.github.com/repos/dotnet/efcore/issues/32701","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/32701/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/32701/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/32701/events","html_url":"https://github.com/dotnet/efcore/issues/32701","id":2062824973,"node_id":"I_kwDOAPaMMs569DYN","number":32701,"title":"IndexOutOfRange for EntityEntry.GetDatabaseValues() with complex type and TPH","user":{"login":"Wasserwecken","id":15609168,"node_id":"MDQ6VXNlcjE1NjA5MTY4","avatar_url":"https://avatars.githubusercontent.com/u/15609168?v=4","gravatar_id":"","url":"https://api.github.com/users/Wasserwecken","html_url":"https://github.com/Wasserwecken","followers_url":"https://api.github.com/users/Wasserwecken/followers","following_url":"https://api.github.com/users/Wasserwecken/following{/other_user}","gists_url":"https://api.github.com/users/Wasserwecken/gists{/gist_id}","starred_url":"https://api.github.com/users/Wasserwecken/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Wasserwecken/subscriptions","organizations_url":"https://api.github.com/users/Wasserwecken/orgs","repos_url":"https://api.github.com/users/Wasserwecken/repos","events_url":"https://api.github.com/users/Wasserwecken/events{/privacy}","received_events_url":"https://api.github.com/users/Wasserwecken/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1017558838,"node_id":"MDU6TGFiZWwxMDE3NTU4ODM4","url":"https://api.github.com/repos/dotnet/efcore/labels/Servicing-approved","name":"Servicing-approved","color":"048708","default":false,"description":""},{"id":1902925253,"node_id":"MDU6TGFiZWwxOTAyOTI1MjUz","url":"https://api.github.com/repos/dotnet/efcore/labels/area-dbcontext","name":"area-dbcontext","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/188","html_url":"https://github.com/dotnet/efcore/milestone/188","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/188/labels","id":10432910,"node_id":"MI_kwDOAPaMMs4AnzGO","number":188,"title":"8.0.3","description":null,"creator":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":22,"state":"closed","created_at":"2024-01-18T01:09:32Z","updated_at":"2024-04-09T08:41:20Z","due_on":null,"closed_at":"2024-04-09T08:41:20Z"},"comments":2,"created_at":"2024-01-02T19:03:11Z","updated_at":"2025-06-15T19:56:37Z","closed_at":"2024-02-07T12:57:48Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Problem\r\nI want to update the original values of an entity manually, therefore I use `GetDatabaseValues`.\r\nUnfortunately in a specific edge case the indicies for `IProperty` on `ArrayPropertyValues` are partially invalid.\r\nThis results in an IndexOutOfRangeException because TPH properties indicies do not fit the underlying value array.\r\nThe root of the problem might be that\r\n- complex type values are not loaded\r\n- and the indicies TPH properties therfore do not match the value array length.\r\n\r\nNot only does this result in an exception, this also:\r\n- affects `EntityEntry.Reload()` because it does the same internally.\r\n- complex property data does not get reloaded / loaded.\r\n\r\nThis problems only occures on TPH properties, there is no exception with normal entities.\r\n\r\n## Details\r\nThe value set loaded contains all proeprties except the complex type ones.\r\n![image](https://github.com/dotnet/efcore/assets/15609168/8893b80e-ebd5-48b5-b227-d3fe490a6950)\r\n\r\nBut the index of the additional property of the `Supplier`-Type does returns `4` with `dbValues.Properties.ToArray()[3].GetIndex()`\r\nwhich results in an IndexOutOfRangeException\r\n\r\n```\r\nSystem.IndexOutOfRangeException\r\n  HResult=0x80131508\r\n  Message=Index was outside the bounds of the array.\r\n  Source=Microsoft.EntityFrameworkCore\r\n  StackTrace:\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.ArrayPropertyValues.get_Item(String propertyName)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.EntryPropertyValues.SetValues(PropertyValues propertyValues)\r\n   at ConsoleApp2.Program.Main(String[] args) in C:\\Users\\ericd\\source\\repos\\ConsoleApp2\\ConsoleApp2\\Program.cs:line 22\r\n```\r\n\r\n## Example\r\nThe following code should reproduce the exception on the line `entry.OriginalValues.SetValues(dbValues);`.\r\nIm using .NET 8.0 with EFCore 8.0.0 and VS Studio 17.8.3.\r\nBefore running the code, migrations have to be added (`Add-Migration Init`)\r\n\r\n``` c#\r\nusing Microsoft.EntityFrameworkCore;\r\nusing Microsoft.EntityFrameworkCore.Diagnostics;\r\nusing System.ComponentModel.DataAnnotations.Schema;\r\n\r\nnamespace ConsoleApp2\r\n{\r\n    internal class Program\r\n    {\r\n        static void Main(string[] args)\r\n        {\r\n            using (var ctx = new CustomContext())\r\n            {\r\n                ctx.Database.Migrate();\r\n                ctx.Add(new Supplier() { Name = \"FooBar\", Address = new() { Street = \"WhereEver\" } });\r\n                ctx.SaveChanges();\r\n            }\r\n\r\n            using (var ctx = new CustomContext())\r\n            {\r\n                var entry = ctx.Entry(ctx.Suppliers.First());\r\n                var dbValues = entry.GetDatabaseValues()!;\r\n                entry.OriginalValues.SetValues(dbValues);\r\n            }\r\n\r\n            Console.WriteLine(\"Done!\");\r\n            Console.ReadLine();\r\n        }\r\n    }\r\n}\r\n\r\npublic class CustomContext : DbContext\r\n{\r\n    public DbSet<Contact> Contacts { get; set; }\r\n    public DbSet<Supplier> Suppliers { get; set; }\r\n    public DbSet<Customer> Customers { get; set; }\r\n\r\n    protected override void OnConfiguring(DbContextOptionsBuilder builder)\r\n    {\r\n        builder.LogTo(Console.WriteLine, new[] { RelationalEventId.CommandExecuting }).EnableSensitiveDataLogging();\r\n        builder.UseSqlServer(@\"Server=(localdb)\\mssqllocaldb;Database=TestDb;Trusted_Connection=True\");\r\n    }\r\n\r\n    protected override void OnModelCreating(ModelBuilder builder)\r\n    {\r\n        builder.Entity<Contact>().HasDiscriminator(e => e.Discriminator);\r\n    }\r\n}\r\n\r\npublic abstract class Contact\r\n{\r\n    public int Id { get; set; }\r\n    public string? Discriminator { get; set; }\r\n    public required string Name { get; set; }\r\n    public required Address Address { get; set; }\r\n}\r\n\r\npublic class Supplier : Contact\r\n{\r\n    public string? Foo { get; set; }\r\n}\r\n\r\npublic class Customer : Contact\r\n{\r\n    public string? Bar { get; set; }\r\n}\r\n\r\n[ComplexType]\r\npublic class Address\r\n{\r\n    public required string Street { get; set; }\r\n}\r\n```\r\n\r\n","closed_by":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/32701/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/32701/timeline","performed_via_github_app":null,"state_reason":"completed"}