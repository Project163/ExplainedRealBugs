{"url":"https://api.github.com/repos/dotnet/efcore/issues/34883","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/34883/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/34883/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/34883/events","html_url":"https://github.com/dotnet/efcore/issues/34883","id":2580022887,"node_id":"I_kwDOAPaMMs6ZyAZn","number":34883,"title":"EF9: Unbound variable error when combining db and non-db condition","user":{"login":"alaatm","id":2095803,"node_id":"MDQ6VXNlcjIwOTU4MDM=","avatar_url":"https://avatars.githubusercontent.com/u/2095803?v=4","gravatar_id":"","url":"https://api.github.com/users/alaatm","html_url":"https://github.com/alaatm","followers_url":"https://api.github.com/users/alaatm/followers","following_url":"https://api.github.com/users/alaatm/following{/other_user}","gists_url":"https://api.github.com/users/alaatm/gists{/gist_id}","starred_url":"https://api.github.com/users/alaatm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alaatm/subscriptions","organizations_url":"https://api.github.com/users/alaatm/orgs","repos_url":"https://api.github.com/users/alaatm/repos","events_url":"https://api.github.com/users/alaatm/events{/privacy}","received_events_url":"https://api.github.com/users/alaatm/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":514908713,"node_id":"MDU6TGFiZWw1MTQ5MDg3MTM=","url":"https://api.github.com/repos/dotnet/efcore/labels/regression","name":"regression","color":"ff1fff","default":false,"description":null},{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1675384372,"node_id":"MDU6TGFiZWwxNjc1Mzg0Mzcy","url":"https://api.github.com/repos/dotnet/efcore/labels/area-query","name":"area-query","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/180","html_url":"https://github.com/dotnet/efcore/milestone/180","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/180/labels","id":9963267,"node_id":"MI_kwDOAPaMMs4AmAcD","number":180,"title":"9.0.0","description":null,"creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":339,"state":"closed","created_at":"2023-09-25T15:41:58Z","updated_at":"2025-04-01T18:19:15Z","due_on":null,"closed_at":"2024-11-14T11:54:05Z"},"comments":1,"created_at":"2024-10-10T23:10:06Z","updated_at":"2025-06-15T20:10:40Z","closed_at":"2024-10-12T07:50:04Z","author_association":"CONTRIBUTOR","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"The following used to work fine in efcore 8.0 but in efcore 9.0, its throwing an exception:\n\n```\nSystem.InvalidOperationException: 'An exception was thrown while attempting to evaluate the LINQ query parameter expression '(SomeCondition() AndAlso (p.Dispute != null))'. See the inner exception for more information.'\n\nInner exception\nInvalidOperationException: unbound variable: p\n```\n\n```C#\npublic class MyContext : DbContext\n{\n    public DbSet<Trip> Trips { get; set; } = default!;\n\n    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder) => optionsBuilder\n        .UseSqlServer(@\"Server=.;Database=EFUnboundVarIssue;Trusted_Connection=True;MultipleActiveResultSets=true;encrypt=false\")\n        .EnableSensitiveDataLogging()\n        .LogTo(p => Debug.WriteLine(p));\n}\n\npublic class Trip\n{\n    public int Id { get; set; }\n    public TripDispute? Dispute { get; set; }\n}\n\npublic class TripDispute\n{\n    public int Id { get; set; }\n}\n\nclass Program\n{\n    static void Main()\n    {\n        using (var db = new MyContext())\n        {\n            db.Database.EnsureDeleted();\n            db.Database.EnsureCreated();\n            db.Trips.Add(new Trip());\n            db.Trips.Add(new Trip { Dispute = new TripDispute() });\n            db.SaveChanges();\n        }\n\n        using (var db = new MyContext())\n        {\n            var q = db.Trips.Select(p => new\n            {\n                p.Id,\n               /* NOTE: If SomeCondition() evaluates to true, it works fine */\n                Dispute = SomeCondition() && p.Dispute != null ? p.Dispute!.Id : -1\n            });\n\n            var result = q.ToArray();\n        }\n    }\n\n    static bool SomeCondition() => Random.Shared.Next(1000) == 5;\n}\n```\n\nI also tried calculating condition value before executing query:\n\n```C#\nvar condition = SomeCondition();\n\nvar q = db.Trips.Select(p => new\n{\n    p.Id,\n    Dispute = condition && p.Dispute != null ? p.Dispute!.Id : -1\n});\n\nvar result = q.ToArray();\n```\n\nBut still getting same error:\n\n```\nSystem.InvalidOperationException: 'An exception was thrown while attempting to evaluate the LINQ query parameter expression '(value(Program+<>c__DisplayClass0_0).condition AndAlso (p.Dispute != null))'. See the inner exception for more information.'\n\nInner exception\nInvalidOperationException: unbound variable: p\n```\n\nI tried putting just `false` and still getting the same error:\n\n```C#\nusing (var db = new MyContext())\n{\n    var q = db.Trips.Select(p => new\n    {\n        p.Id,\n        Dispute = false && p.Dispute != null ? p.Dispute!.Id : -1\n    });\n\n    var result = q.ToArray();\n}\n```\n\n```\nSystem.InvalidOperationException: 'An exception was thrown while attempting to evaluate the LINQ query parameter expression '(False AndAlso (p.Dispute != null))'. See the inner exception for more information.'\n\nInner exception\nInvalidOperationException: unbound variable: p\n```\n\nAll of these were working in ef 8.0\n\n### stack trace\n\n```\n   at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.<Evaluate>g__EvaluateCore|70_0(Expression expression, String& parameterName, Boolean& isContextAccessor)\n   at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.Evaluate(Expression expression, String& parameterName, Boolean& isContextAccessor)\n   at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.Evaluate(Expression expression)\n   at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.VisitConditional(ConditionalExpression conditional)\n   at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.Visit(Expression expression)\n   at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.Visit[T](ReadOnlyCollection`1 expressions, Func`2 elementVisitor, StateType& aggregateStateType, State[]& expressionStates, Boolean poolExpressionStates)\n   at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.Visit(ReadOnlyCollection`1 expressions, StateType& aggregateStateType, State[]& expressionStates, Boolean poolExpressionStates)\n   at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.VisitNew(NewExpression new)\n   at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.Visit(Expression expression, State& state)\n   at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.VisitLambda[T](Expression`1 lambda)\n   at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.Visit(Expression expression, State& state)\n   at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.VisitUnary(UnaryExpression unary)\n   at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.Visit(Expression expression)\n   at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.Visit[T](ReadOnlyCollection`1 expressions, Func`2 elementVisitor, StateType& aggregateStateType, State[]& expressionStates, Boolean poolExpressionStates)\n   at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.Visit(ReadOnlyCollection`1 expressions, StateType& aggregateStateType, State[]& expressionStates, Boolean poolExpressionStates)\n   at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.VisitMethodCall(MethodCallExpression methodCall)\n   at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.Visit(Expression expression, State& state)\n   at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.ExtractParameters(Expression expression, IParameterValues parameterValues, Boolean parameterize, Boolean clearParameterizedValues, Boolean precompiledQuery, IReadOnlySet`1& nonNullableReferenceTypeParameters)\n   at Microsoft.EntityFrameworkCore.Query.Internal.ExpressionTreeFuncletizer.ExtractParameters(Expression expression, IParameterValues parameterValues, Boolean parameterize, Boolean clearParameterizedValues)\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.ExtractParameters(Expression query, IParameterValues parameterValues, IDiagnosticsLogger`1 logger, Boolean compiledQuery, Boolean generateContextAccessors)\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.ExecuteCore[TResult](Expression query, Boolean async, CancellationToken cancellationToken)\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.Execute[TResult](Expression query)\n   at Microsoft.EntityFrameworkCore.Query.Internal.EntityQueryProvider.Execute[TResult](Expression expression)\n   at Microsoft.EntityFrameworkCore.Query.Internal.EntityQueryable`1.GetEnumerator()\n   at System.Collections.Generic.SegmentedArrayBuilder`1.AddNonICollectionRangeInlined(IEnumerable`1 source)\n   at System.Linq.Enumerable.<ToArray>g__EnumerableToArray|314_0[TSource](IEnumerable`1 source)\n   at Program.Main() in C:\\Users\\alaam\\source\\repos\\EFUnboundVarIssue\\Program.cs:line 25\n```\n\n### Include verbose output\n\nPlease include `--verbose` output when filing bugs about the `dotnet ef` or Package Manager Console tools.\n\nUse triple-tick fences for tool output. For example:\n\n```\n‚ùØ dotnet ef dbcontext list --verbose\nUsing project 'C:\\Users\\alaam\\source\\repos\\EFUnboundVarIssue\\EFUnboundVarIssue.csproj'.\nUsing startup project 'C:\\Users\\alaam\\source\\repos\\EFUnboundVarIssue\\EFUnboundVarIssue.csproj'.\ndotnet msbuild /target:GetEFProjectMetadata /property:EFProjectMetadataFile=C:\\Users\\alaam\\AppData\\Local\\Temp\\tmpeznphc.tmp /verbosity:quiet /nologo C:\\Users\\alaam\\source\\repos\\EFUnboundVarIssue\\EFUnboundVarIssue.csproj\ndotnet msbuild /target:GetEFProjectMetadata /property:EFProjectMetadataFile=C:\\Users\\alaam\\AppData\\Local\\Temp\\tmphzdqbp.tmp /verbosity:quiet /nologo C:\\Users\\alaam\\source\\repos\\EFUnboundVarIssue\\EFUnboundVarIssue.csproj\nBuild started...\ndotnet build C:\\Users\\alaam\\source\\repos\\EFUnboundVarIssue\\EFUnboundVarIssue.csproj /verbosity:quiet /nologo /p:PublishAot=false\n\nBuild succeeded.\n    0 Warning(s)\n    0 Error(s)\n\nTime Elapsed 00:00:00.96\n\nBuild succeeded.\ndotnet exec --depsfile C:\\Users\\alaam\\source\\repos\\EFUnboundVarIssue\\bin\\Debug\\net9.0\\EFUnboundVarIssue.deps.json --additionalprobingpath C:\\Users\\alaam\\.nuget\\packages --additionalprobingpath \"C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\NuGetPackages\" --runtimeconfig C:\\Users\\alaam\\source\\repos\\EFUnboundVarIssue\\bin\\Debug\\net9.0\\EFUnboundVarIssue.runtimeconfig.json C:\\Users\\alaam\\.nuget\\packages\\dotnet-ef\\9.0.0-rc.2.24474.1\\tools\\net8.0\\any\\tools\\netcoreapp2.0\\any\\ef.dll dbcontext list --assembly C:\\Users\\alaam\\source\\repos\\EFUnboundVarIssue\\bin\\Debug\\net9.0\\EFUnboundVarIssue.dll --project C:\\Users\\alaam\\source\\repos\\EFUnboundVarIssue\\EFUnboundVarIssue.csproj --startup-assembly C:\\Users\\alaam\\source\\repos\\EFUnboundVarIssue\\bin\\Debug\\net9.0\\EFUnboundVarIssue.dll --startup-project C:\\Users\\alaam\\source\\repos\\EFUnboundVarIssue\\EFUnboundVarIssue.csproj --project-dir C:\\Users\\alaam\\source\\repos\\EFUnboundVarIssue\\ --root-namespace EFUnboundVarIssue --language C# --framework net9.0 --nullable --working-dir C:\\Users\\alaam\\source\\repos\\EFUnboundVarIssue --verbose\nUsing assembly 'EFUnboundVarIssue'.\nUsing startup assembly 'EFUnboundVarIssue'.\nUsing application base 'C:\\Users\\alaam\\source\\repos\\EFUnboundVarIssue\\bin\\Debug\\net9.0'.\nUsing working directory 'C:\\Users\\alaam\\source\\repos\\EFUnboundVarIssue'.\nUsing root namespace 'EFUnboundVarIssue'.\nUsing project directory 'C:\\Users\\alaam\\source\\repos\\EFUnboundVarIssue\\'.\nRemaining arguments: .\nFinding DbContext classes...\nFinding IDesignTimeDbContextFactory implementations...\nFinding DbContext classes in the project...\nFound DbContext 'MyContext'.\nFinding application service provider in assembly 'EFUnboundVarIssue'...\nFinding Microsoft.Extensions.Hosting service provider...\nNo static method 'CreateHostBuilder(string[])' was found on class 'Program'.\nNo application service provider was found.\nEFUnboundVarIssue.MyContext\n```\n\n### Include provider and version information\n\nEF Core version:\nDatabase provider: Microsoft.EntityFrameworkCore.SqlServer 9.0.0-rc.2.24474.1\nTarget framework: .net 9.0\n","closed_by":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/34883/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/34883/timeline","performed_via_github_app":null,"state_reason":"completed"}