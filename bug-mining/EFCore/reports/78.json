{"url":"https://api.github.com/repos/dotnet/efcore/issues/28803","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/28803/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/28803/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/28803/events","html_url":"https://github.com/dotnet/efcore/issues/28803","id":1345283825,"node_id":"I_kwDOAPaMMs5QL2bx","number":28803,"title":"Exception: \"Unable to cast object of type\" in many stored procs mapping cases","user":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1900941009,"node_id":"MDU6TGFiZWwxOTAwOTQxMDA5","url":"https://api.github.com/repos/dotnet/efcore/labels/area-save-changes","name":"area-save-changes","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/128","html_url":"https://github.com/dotnet/efcore/milestone/128","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/128/labels","id":7236796,"node_id":"MI_kwDOAPaMMs4Abmy8","number":128,"title":"7.0.0","description":"EF Core 7.0","creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":375,"state":"closed","created_at":"2021-10-09T18:57:40Z","updated_at":"2024-11-13T16:14:22Z","due_on":null,"closed_at":"2022-11-05T18:37:45Z"},"comments":5,"created_at":"2022-08-20T20:36:53Z","updated_at":"2025-06-15T18:51:40Z","closed_at":"2022-09-01T23:20:57Z","author_association":"CONTRIBUTOR","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Start with sample here: https://github.com/dotnet/EntityFramework.Docs/pull/3989\r\n\r\nSeems to happen a lot when a batch contains multiple updates, but also in other cases. For example, remove the first call to `SaveChanges` in `SprocMappingTest`\r\n\r\n```\r\n      Executed DbCommand (11ms) [Parameters=[@p0='2', @p1='3', @p2='1', @p3='1', @p4='2', @p5='2', @p6='2', @p7='3', @p8='3', @p9='2', @p10='2', @p11='0x00000000000007D2' (Size = 8), @p12='Java Puzzlers (New Edition!)' (Nullable = false) (Size = 4000), @p13='283', @p14='2005-01-01T00:00:00.0000000', @p15=NULL (\r\nSize = 8000) (DbType = Binary), @p16='2022-08-20T20:35:53.5200000', @p17='0-321-33678-X' (Size = 4000), @p18=NULL (Nullable = false) (Direction = Output) (DbType = DateTime2), @p19=NULL (Size = 8) (Direction = Output) (DbType = Binary), @p20='3', @p21='0x00000000000007D3' (Size = 8), @p22='Effective Java (New E\r\ndition!)' (Nullable = false) (Size = 4000), @p23='252', @p24='2001-01-01T00:00:00.0000000', @p25='0x010203040506070809' (Size = 8000), @p26='2022-08-20T20:35:53.5200000', @p27='0-201-31005-8' (Size = 4000), @p28=NULL (Nullable = false) (Direction = Output) (DbType = DateTime2), @p29=NULL (Size = 8) (Direction =\r\n Output) (DbType = Binary), @p30='4', @p31='0x00000000000007D4' (Size = 8), @p32='Test-Driven Development By Example (New Edition!)' (Nullable = false) (Size = 4000), @p33='220', @p34='2003-01-01T00:00:00.0000000', @p35=NULL (Size = 8000) (DbType = Binary), @p36='2022-08-20T20:35:53.5200000', @p37='0-321-14653-\r\n0' (Size = 4000), @p38=NULL (Nullable = false) (Direction = Output) (DbType = DateTime2), @p39=NULL (Size = 8) (Direction = Output) (DbType = Binary), @p40='5', @p41='0x00000000000007D5' (Size = 8), @p42='6', @p43='0x00000000000007D6' (Size = 8), @p44='Amiga Computing' (Nullable = false) (Size = 4000), @p45='90\r\n', @p46='1988-05-16T00:00:00.0000000', @p47=NULL (Size = 8000) (DbType = Binary), @p48='2.95' (Nullable = true) (Precision = 18) (Scale = 2), @p49='1', @p50='4', @p51='2022-08-20T20:35:53.5600000', @p52=NULL (Nullable = false) (Direction = Output) (DbType = DateTime2), @p53=NULL (Size = 8) (Direction = Output)\r\n(DbType = Binary), @p54='1', @p55='0x00000000000007D1' (Size = 8), @p56='2', @p57='3', @p58='2', @p59='Joshua Bloch' (Nullable = false) (Size = 4000), @p60='3', @p61='Neal Gafter' (Nullable = false) (Size = 4000)], CommandType='Text', CommandTimeout='30']\r\n      SET NOCOUNT ON;\r\n      EXEC [Addresses_Delete] @p0;\r\n      EXEC [Addresses_Delete] @p1;\r\n      EXEC [BookPerson_Delete] @p2, @p3;\r\n      EXEC [BookPerson_Delete] @p4, @p5;\r\n      EXEC [BookPerson_Delete] @p6, @p7;\r\n      EXEC [BookPerson_Delete] @p8, @p9;\r\n      EXEC [Book_Update] @p10, @p11, @p12, @p13, @p14, @p15, @p16, @p17, @p18 OUTPUT, @p19 OUTPUT;\r\n      EXEC [Book_Update] @p20, @p21, @p22, @p23, @p24, @p25, @p26, @p27, @p28 OUTPUT, @p29 OUTPUT;\r\n      EXEC [Book_Update] @p30, @p31, @p32, @p33, @p34, @p35, @p36, @p37, @p38 OUTPUT, @p39 OUTPUT;\r\n      EXEC [Magazine_Delete] @p40, @p41;\r\n      EXEC [Magazine_Update] @p42, @p43, @p44, @p45, @p46, @p47, @p48, @p49, @p50, @p51, @p52 OUTPUT, @p53 OUTPUT;\r\n      EXEC [Book_Delete] @p54, @p55;\r\n      EXEC [Contacts_Delete] @p56;\r\n      EXEC [Contacts_Delete] @p57;\r\n      EXEC [Person_Delete] @p58, @p59;\r\n      EXEC [Person_Delete] @p60, @p61;\r\nfail: 8/20/2022 21:35:53.947 CoreEventId.SaveChangesFailed[10000] (Microsoft.EntityFrameworkCore.Update)\r\n      An exception occurred in the database while saving changes for context type 'NewInEfCore7.TpcDocumentsContext'.\r\n      Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.\r\n       ---> System.InvalidCastException: Unable to cast object of type 'System.Int32' to type 'System.DateTime'.\r\n         at Microsoft.EntityFrameworkCore.ChangeTracking.ValueComparer`1.Equals(Object left, Object right)\r\n         at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.InternalEntityEntry.AreEqual(Object value, Object otherValue, IProperty property)\r\n         at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.InternalEntityEntry.SetProperty(IPropertyBase propertyBase, Object value, Boolean isMaterialization, Boolean setModified, Boolean isCascadeDelete, CurrentValueType valueType)\r\n         at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.InternalEntityEntry.SetStoreGeneratedValue(IProperty property, Object value)\r\n         at Microsoft.EntityFrameworkCore.Update.ColumnModification.set_Value(Object value)\r\n         at Microsoft.EntityFrameworkCore.Update.ModificationCommand.PropagateOutputParameters(DbParameterCollection parameterCollection, Int32 baseParameterIndex)\r\n         at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.Consume(RelationalDataReader reader)\r\n         --- End of inner exception stack trace ---\r\n         at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.Consume(RelationalDataReader reader)\r\n         at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.Execute(IRelationalConnection connection)\r\n         at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.Execute(IRelationalConnection connection)\r\n         at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.Execute(IEnumerable`1 commandBatches, IRelationalConnection connection)\r\n         at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChanges(IList`1 entries)\r\n         at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(IList`1 entriesToSave)\r\n         at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(StateManager stateManager, Boolean acceptAllChangesOnSuccess)\r\n         at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.<>c.<SaveChanges>b__107_0(DbContext _, ValueTuple`2 t)\r\n         at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.Execute[TState,TResult](TState state, Func`3 operation, Func`3 verifySucceeded)\r\n         at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(Boolean acceptAllChangesOnSuccess)\r\n         at Microsoft.EntityFrameworkCore.DbContext.SaveChanges(Boolean acceptAllChangesOnSuccess)\r\nUnhandled exception. Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.\r\n ---> System.InvalidCastException: Unable to cast object of type 'System.Int32' to type 'System.DateTime'.\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.ValueComparer`1.Equals(Object left, Object right)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.InternalEntityEntry.AreEqual(Object value, Object otherValue, IProperty property)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.InternalEntityEntry.SetProperty(IPropertyBase propertyBase, Object value, Boolean isMaterialization, Boolean setModified, Boolean isCascadeDelete, CurrentValueType valueType)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.InternalEntityEntry.SetStoreGeneratedValue(IProperty property, Object value)\r\n   at Microsoft.EntityFrameworkCore.Update.ColumnModification.set_Value(Object value)\r\n   at Microsoft.EntityFrameworkCore.Update.ModificationCommand.PropagateOutputParameters(DbParameterCollection parameterCollection, Int32 baseParameterIndex)\r\n   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.Consume(RelationalDataReader reader)\r\n   --- End of inner exception stack trace ---\r\n   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.Consume(RelationalDataReader reader)\r\n   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.Execute(IRelationalConnection connection)\r\n   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.Execute(IRelationalConnection connection)\r\n   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.Execute(IEnumerable`1 commandBatches, IRelationalConnection connection)\r\n   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChanges(IList`1 entries)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(IList`1 entriesToSave)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(StateManager stateManager, Boolean acceptAllChangesOnSuccess)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.<>c.<SaveChanges>b__107_0(DbContext _, ValueTuple`2 t)\r\n   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.Execute[TState,TResult](TState state, Func`3 operation, Func`3 verifySucceeded)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(Boolean acceptAllChangesOnSuccess)\r\n   at Microsoft.EntityFrameworkCore.DbContext.SaveChanges(Boolean acceptAllChangesOnSuccess)\r\n   at Microsoft.EntityFrameworkCore.DbContext.SaveChanges()\r\n   at NewInEfCore7.StoredProcedureMappingSample.SprocMappingTest[TContext]() in C:\\github\\EntityFramework.Docs\\samples\\core\\Miscellaneous\\NewInEFCore7\\StoredProcedureMappingSample.cs:line 65\r\n   at NewInEfCore7.StoredProcedureMappingSample.Inset_Update_and_Delete_using_stored_procedures_with_TPC() in C:\\github\\EntityFramework.Docs\\samples\\core\\Miscellaneous\\NewInEFCore7\\StoredProcedureMappingSample.cs:line 26\r\n   at Program.Main() in C:\\github\\EntityFramework.Docs\\samples\\core\\Miscellaneous\\NewInEFCore7\\Program.cs:line 27\r\n```","closed_by":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/28803/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/28803/timeline","performed_via_github_app":null,"state_reason":"completed"}