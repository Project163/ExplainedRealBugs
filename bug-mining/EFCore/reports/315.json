{"url":"https://api.github.com/repos/dotnet/efcore/issues/32267","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/32267/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/32267/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/32267/events","html_url":"https://github.com/dotnet/efcore/issues/32267","id":1985457752,"node_id":"I_kwDOAPaMMs52V65Y","number":32267,"title":"DB Context pooling with proxies resulting in memory issues in 8.0 RC2","user":{"login":"o-tto","id":3421213,"node_id":"MDQ6VXNlcjM0MjEyMTM=","avatar_url":"https://avatars.githubusercontent.com/u/3421213?v=4","gravatar_id":"","url":"https://api.github.com/users/o-tto","html_url":"https://github.com/o-tto","followers_url":"https://api.github.com/users/o-tto/followers","following_url":"https://api.github.com/users/o-tto/following{/other_user}","gists_url":"https://api.github.com/users/o-tto/gists{/gist_id}","starred_url":"https://api.github.com/users/o-tto/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/o-tto/subscriptions","organizations_url":"https://api.github.com/users/o-tto/orgs","repos_url":"https://api.github.com/users/o-tto/repos","events_url":"https://api.github.com/users/o-tto/events{/privacy}","received_events_url":"https://api.github.com/users/o-tto/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":526662235,"node_id":"MDU6TGFiZWw1MjY2NjIyMzU=","url":"https://api.github.com/repos/dotnet/efcore/labels/breaking-change","name":"breaking-change","color":"d93f0b","default":false,"description":null},{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1017558838,"node_id":"MDU6TGFiZWwxMDE3NTU4ODM4","url":"https://api.github.com/repos/dotnet/efcore/labels/Servicing-approved","name":"Servicing-approved","color":"048708","default":false,"description":""},{"id":4169895545,"node_id":"LA_kwDOAPaMMs74i455","url":"https://api.github.com/repos/dotnet/efcore/labels/area-proxies","name":"area-proxies","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/186","html_url":"https://github.com/dotnet/efcore/milestone/186","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/186/labels","id":10201144,"node_id":"MI_kwDOAPaMMs4Am6g4","number":186,"title":"8.0.2","description":null,"creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":44,"state":"closed","created_at":"2023-11-17T09:03:59Z","updated_at":"2024-05-05T12:55:36Z","due_on":null,"closed_at":"2024-04-09T08:40:11Z"},"comments":6,"created_at":"2023-11-09T11:49:53Z","updated_at":"2025-06-15T19:53:52Z","closed_at":"2024-01-04T15:09:57Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## DB Context pooling with proxies enabled \r\n\r\nIssue #25486 describes that this issue should be resolved in .NET 8 RC1.  When comparing .NET7 with .NET8 RC2 no differences in memory handling are noticable. \r\nWhen running the code below the process quickly passes the 1GB memory mark. When disabling proxies or using adddbcontext instead of pooling the memory usage is more consistent (as it should be after disposing the scope, I assume).\r\n\r\n\r\n### Code example\r\n\r\n\r\n\r\n```C#\r\n\r\n\r\nvar testProcess = new TestSetup();\r\ntestProcess.InitializeServiceProvider();\r\nawait testProcess.QueryTest();\r\n\r\npublic class TestSetup\r\n{\r\n    private IServiceProvider _serviceProvider;\r\n    public IServiceProvider InitializeServiceProvider()\r\n    {\r\n        var sc = new ServiceCollection();\r\n        sc.AddDbContextPool<Context>(options =>\r\n        {\r\n            options.UseInMemoryDatabase(\"test\").UseLazyLoadingProxies();\r\n        });\r\n\r\n        // For comparison (does not result in high memory usage)\r\n        //sc.AddDbContext<Context>(options =>\r\n        //{\r\n        //    options.UseInMemoryDatabase(\"test\").UseLazyLoadingProxies();\r\n        //});\r\n\r\n        _serviceProvider = sc.BuildServiceProvider();\r\n        return _serviceProvider;\r\n    }\r\n\r\n    public async Task QueryTest()\r\n    {\r\n        await using ( var insertScope = _serviceProvider.CreateAsyncScope())\r\n        {\r\n            var insertScopeSp = insertScope.ServiceProvider;\r\n            var insertScopeCt = insertScopeSp.GetRequiredService<Context>();\r\n            for (var x = 1; x <= 10000; x++)\r\n                insertScopeCt.TestModels.Add(new TestModel() {Id = x, Test = \"test\"});\r\n            await insertScopeCt.SaveChangesAsync();\r\n        }\r\n\r\n        var i = 0;\r\n        while (i < 100000)\r\n        {\r\n            i++;\r\n            await using var scope = _serviceProvider.CreateAsyncScope();\r\n            var sp = scope.ServiceProvider;\r\n            var contextInstance = sp.GetRequiredService<Context>();\r\n            var list = await contextInstance.TestModels.ToListAsync();\r\n        }\r\n\r\n        Console.ReadLine();\r\n\r\n    }\r\n\r\n\r\n    // DB Context\r\n    public class TestModel\r\n    {\r\n        public long Id { get; set; }\r\n        public string Test { get; set; }\r\n    }\r\n    public class Context : DbContext\r\n    {\r\n        public Context(DbContextOptions options) : base(options) { }\r\n        public DbSet<TestModel> TestModels { get; set; }\r\n    }\r\n}\r\n\r\n\r\n\r\n```\r\n\r\n###  \r\n\r\n\r\nMemory snapshot comparison with Pooling only\r\n![image](https://github.com/dotnet/efcore/assets/3421213/e25dc6e0-8de5-4030-b98a-07493235a447)\r\n\r\n![image](https://github.com/dotnet/efcore/assets/3421213/96677f16-3671-4a5a-9ea7-e8b1cfc343a1)\r\n\r\n\r\nMemory snapshot comparison with Pooling and proxies enabled\r\n![image](https://github.com/dotnet/efcore/assets/3421213/9d8c7b20-d08e-4d30-9158-31e156e511e1)\r\n\r\n![image](https://github.com/dotnet/efcore/assets/3421213/cd9048b3-c9a2-4667-a692-33027cf53c6b)\r\n\r\n\r\n\r\n\r\n\r\nEF Core version: \r\n```XML\r\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore\" Version=\"8.0.0-rc.2.23480.1\" />\r\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.InMemory\" Version=\"8.0.0-rc.2.23480.1\" />\r\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.Proxies\" Version=\"8.0.0-rc.2.23480.1\" />\r\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.Tools\" Version=\"8.0.0-rc.2.23480.1\">\r\n```\r\nDatabase provider: InMemory\r\nTarget framework: 8.0\r\nOperating system: Win-11 \r\nIDE: VS 2022 Preview 17.8.0 Preview 3\r\n","closed_by":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/32267/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/32267/timeline","performed_via_github_app":null,"state_reason":"completed"}