{"url":"https://api.github.com/repos/dotnet/efcore/issues/35127","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/35127/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/35127/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/35127/events","html_url":"https://github.com/dotnet/efcore/issues/35127","id":2665107735,"node_id":"I_kwDOAPaMMs6e2lEX","number":35127,"title":"EF Core 9 migration behaviour change causes an exception with surrounding user transaction","user":{"login":"DvdKhl","id":3011432,"node_id":"MDQ6VXNlcjMwMTE0MzI=","avatar_url":"https://avatars.githubusercontent.com/u/3011432?v=4","gravatar_id":"","url":"https://api.github.com/users/DvdKhl","html_url":"https://github.com/DvdKhl","followers_url":"https://api.github.com/users/DvdKhl/followers","following_url":"https://api.github.com/users/DvdKhl/following{/other_user}","gists_url":"https://api.github.com/users/DvdKhl/gists{/gist_id}","starred_url":"https://api.github.com/users/DvdKhl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DvdKhl/subscriptions","organizations_url":"https://api.github.com/users/DvdKhl/orgs","repos_url":"https://api.github.com/users/DvdKhl/repos","events_url":"https://api.github.com/users/DvdKhl/events{/privacy}","received_events_url":"https://api.github.com/users/DvdKhl/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":514908713,"node_id":"MDU6TGFiZWw1MTQ5MDg3MTM=","url":"https://api.github.com/repos/dotnet/efcore/labels/regression","name":"regression","color":"ff1fff","default":false,"description":null},{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1900942474,"node_id":"MDU6TGFiZWwxOTAwOTQyNDc0","url":"https://api.github.com/repos/dotnet/efcore/labels/area-migrations","name":"area-migrations","color":"32b37b","default":false,"description":""},{"id":8130499638,"node_id":"LA_kwDOAPaMMs8AAAAB5J2UNg","url":"https://api.github.com/repos/dotnet/efcore/labels/preview-1","name":"preview-1","color":"ACB3D7","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/208","html_url":"https://github.com/dotnet/efcore/milestone/208","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/208/labels","id":11959183,"node_id":"MI_kwDOAPaMMs4AtnuP","number":208,"title":"9.0.1","description":"","creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":21,"state":"closed","created_at":"2024-11-27T13:18:00Z","updated_at":"2025-02-05T21:51:51Z","due_on":null,"closed_at":"2025-02-05T21:49:40Z"},"comments":13,"created_at":"2024-11-16T23:49:34Z","updated_at":"2025-06-15T20:11:58Z","closed_at":"2024-12-04T17:28:07Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"We use multiple DbContexts within our application, which need to be either all fully migrated or none of them in case of an exception. To achieve this we have surrounded everything in a transaction during the migration.  \nWith EF8 this worked well, but with EF9 we're getting the exception `System.NotSupportedException: 'User transaction is not supported with a TransactionSuppressed migrations or a retrying execution strategy.`'\n\nWe found the related(?) issue https://github.com/dotnet/efcore/issues/35096 but I can't apply the solution in it since it doesn't fail at a `.Sql()` call.\nAnd we're at least not changing any retrying strategy and I'm not sure how to disable it if it is enabled.\n\n### Minimal repo:\nAdd the `Microsoft.EntityFrameworkCore.SqlServer` package and notice that this code works in EF8 but throws the exception above in EF9.  \n```csharp\nusing Microsoft.Data.SqlClient;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.EntityFrameworkCore.Infrastructure;\nusing Microsoft.EntityFrameworkCore.Migrations;\nusing System.ComponentModel.DataAnnotations;\n\nusing var conn = new SqlConnection();\nconn.ConnectionString = $\"Data Source=localhost;Initial Catalog=Main;User ID=username;Password=userpassword;Trust Server Certificate=True\";\nawait conn.OpenAsync();\n\nusing (var tran = conn.BeginTransaction()) {\n  using (var aContext = new AContext()) {\n    aContext.Database.SetDbConnection(conn);\n    using var aCtxTran = await aContext.Database.UseTransactionAsync(tran);\n\n    await aContext.Database.MigrateAsync();\n  }\n\n  using (var bContext = new BContext()) {\n    bContext.Database.SetDbConnection(conn);\n    using var bCtxTran = await bContext.Database.UseTransactionAsync(tran);\n\n    await bContext.Database.MigrateAsync();\n  }\n\n  await tran.CommitAsync();\n}\n\npublic class AContext : DbContext { public DbSet<A> AEntites { get; set; } = null!; protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder) => optionsBuilder.UseSqlServer(); }\npublic class A { [Key] public int Id { get; set; } }\npublic class BContext : DbContext { public DbSet<B> BEntites { get; set; } = null!; protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder) => optionsBuilder.UseSqlServer(); }\npublic class B { [Key] public int Id { get; set; } }\n\n#region Migrations\n#nullable disable\n\nnamespace MultiEFContextMigration.Migrations {\n  /// <inheritdoc />\n  public partial class AMigration : Migration {\n    /// <inheritdoc />\n    protected override void Up(MigrationBuilder migrationBuilder) {\n      migrationBuilder.CreateTable(\n        name: \"AEntites\",\n        columns: table => new {\n          Id = table.Column<int>(type: \"int\", nullable: false)\n            .Annotation(\"SqlServer:Identity\", \"1, 1\")\n        },\n        constraints: table => {\n          table.PrimaryKey(\"PK_AEntites\", x => x.Id);\n        });\n    }\n\n    /// <inheritdoc />\n    protected override void Down(MigrationBuilder migrationBuilder) {\n      migrationBuilder.DropTable(\n        name: \"AEntites\");\n    }\n  }\n}\n\n#nullable disable\n\nnamespace MultiEFContextMigration.Migrations {\n  [DbContext(typeof(AContext))]\n  [Migration(\"20241116225124_AMigration\")]\n  partial class AMigration {\n    /// <inheritdoc />\n    protected override void BuildTargetModel(ModelBuilder modelBuilder) {\n#pragma warning disable 612, 618\n      modelBuilder\n        .HasAnnotation(\"ProductVersion\", \"9.0.0\")\n        .HasAnnotation(\"Relational:MaxIdentifierLength\", 128);\n\n      SqlServerModelBuilderExtensions.UseIdentityColumns(modelBuilder);\n\n      modelBuilder.Entity(\"A\", b => {\n        b.Property<int>(\"Id\")\n          .ValueGeneratedOnAdd()\n          .HasColumnType(\"int\");\n\n        SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>(\"Id\"));\n\n        b.HasKey(\"Id\");\n\n        b.ToTable(\"AEntites\");\n      });\n#pragma warning restore 612, 618\n    }\n  }\n}\n\n#nullable disable\n\nnamespace MultiEFContextMigration.Migrations {\n  [DbContext(typeof(AContext))]\n  partial class AContextModelSnapshot : ModelSnapshot {\n    protected override void BuildModel(ModelBuilder modelBuilder) {\n#pragma warning disable 612, 618\n      modelBuilder\n        .HasAnnotation(\"ProductVersion\", \"9.0.0\")\n        .HasAnnotation(\"Relational:MaxIdentifierLength\", 128);\n\n      SqlServerModelBuilderExtensions.UseIdentityColumns(modelBuilder);\n\n      modelBuilder.Entity(\"A\", b => {\n        b.Property<int>(\"Id\")\n          .ValueGeneratedOnAdd()\n          .HasColumnType(\"int\");\n\n        SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>(\"Id\"));\n\n        b.HasKey(\"Id\");\n\n        b.ToTable(\"AEntites\");\n      });\n#pragma warning restore 612, 618\n    }\n  }\n}\n\n#nullable disable\n\nnamespace MultiEFContextMigration.Migrations.B {\n  /// <inheritdoc />\n  public partial class BMigration : Migration {\n    /// <inheritdoc />\n    protected override void Up(MigrationBuilder migrationBuilder) {\n      migrationBuilder.CreateTable(\n        name: \"BEntites\",\n        columns: table => new {\n          Id = table.Column<int>(type: \"int\", nullable: false)\n            .Annotation(\"SqlServer:Identity\", \"1, 1\")\n        },\n        constraints: table => {\n          table.PrimaryKey(\"PK_BEntites\", x => x.Id);\n        });\n    }\n\n    /// <inheritdoc />\n    protected override void Down(MigrationBuilder migrationBuilder) {\n      migrationBuilder.DropTable(\n        name: \"BEntites\");\n    }\n  }\n}\n\n#nullable disable\n\nnamespace MultiEFContextMigration.Migrations.B {\n  [DbContext(typeof(BContext))]\n  [Migration(\"20241116225139_BMigration\")]\n  partial class BMigration {\n    /// <inheritdoc />\n    protected override void BuildTargetModel(ModelBuilder modelBuilder) {\n#pragma warning disable 612, 618\n      modelBuilder\n        .HasAnnotation(\"ProductVersion\", \"9.0.0\")\n        .HasAnnotation(\"Relational:MaxIdentifierLength\", 128);\n\n      SqlServerModelBuilderExtensions.UseIdentityColumns(modelBuilder);\n\n      modelBuilder.Entity(\"B\", b => {\n        b.Property<int>(\"Id\")\n          .ValueGeneratedOnAdd()\n          .HasColumnType(\"int\");\n\n        SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>(\"Id\"));\n\n        b.HasKey(\"Id\");\n\n        b.ToTable(\"BEntites\");\n      });\n#pragma warning restore 612, 618\n    }\n  }\n}\n\n#nullable disable\n\nnamespace MultiEFContextMigration.Migrations.B {\n  [DbContext(typeof(BContext))]\n  partial class BContextModelSnapshot : ModelSnapshot {\n    protected override void BuildModel(ModelBuilder modelBuilder) {\n#pragma warning disable 612, 618\n      modelBuilder\n        .HasAnnotation(\"ProductVersion\", \"9.0.0\")\n        .HasAnnotation(\"Relational:MaxIdentifierLength\", 128);\n\n      SqlServerModelBuilderExtensions.UseIdentityColumns(modelBuilder);\n\n      modelBuilder.Entity(\"B\", b => {\n        b.Property<int>(\"Id\")\n          .ValueGeneratedOnAdd()\n          .HasColumnType(\"int\");\n\n        SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>(\"Id\"));\n\n        b.HasKey(\"Id\");\n\n        b.ToTable(\"BEntites\");\n      });\n#pragma warning restore 612, 618\n    }\n  }\n}\n#endregion\n```\n\n\n### Stack traces:\n```\nUnhandled exception. System.NotSupportedException: User transaction is not supported with a TransactionSuppressed migrations or a retrying execution strategy.\n   at Microsoft.EntityFrameworkCore.Migrations.Internal.MigrationCommandExecutor.ExecuteNonQueryAsync(IReadOnlyList`1 migrationCommands, IRelationalConnection connection, MigrationExecutionState executionState, Boolean commitTransaction, Nullable`1 isolationLevel, CancellationToken cancellationToken)\n   at Microsoft.EntityFrameworkCore.Migrations.HistoryRepository.Microsoft.EntityFrameworkCore.Migrations.IHistoryRepository.CreateIfNotExistsAsync(CancellationToken cancellationToken)\n   at Microsoft.EntityFrameworkCore.Migrations.Internal.Migrator.<>c.<<MigrateAsync>b__22_0>d.MoveNext()\n--- End of stack trace from previous location ---\n   at Microsoft.EntityFrameworkCore.Migrations.Internal.Migrator.<>c.<<MigrateAsync>b__22_0>d.MoveNext()\n--- End of stack trace from previous location ---\n   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)\n   at Microsoft.EntityFrameworkCore.Migrations.Internal.Migrator.MigrateAsync(String targetMigration, CancellationToken cancellationToken)\n   at Microsoft.EntityFrameworkCore.Migrations.Internal.Migrator.MigrateAsync(String targetMigration, CancellationToken cancellationToken)\n   at Program.<Main>$(String[] args) in E:\\source\\MultiEFContextMigration\\MultiEFContextMigration\\Program.cs:line 16\n   at Program.<Main>(String[] args)\n```\n\n### Include provider and version information\nEF Core version: 9.0.0\nDatabase provider: Microsoft.EntityFrameworkCore.SqlServer\nTarget framework: .NET 9.0\nOperating system: Win11 23H2 (OS Build 22631.4317)\nIDE: Visual Studio 2022 17.12.0\n","closed_by":{"login":"DvdKhl","id":3011432,"node_id":"MDQ6VXNlcjMwMTE0MzI=","avatar_url":"https://avatars.githubusercontent.com/u/3011432?v=4","gravatar_id":"","url":"https://api.github.com/users/DvdKhl","html_url":"https://github.com/DvdKhl","followers_url":"https://api.github.com/users/DvdKhl/followers","following_url":"https://api.github.com/users/DvdKhl/following{/other_user}","gists_url":"https://api.github.com/users/DvdKhl/gists{/gist_id}","starred_url":"https://api.github.com/users/DvdKhl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DvdKhl/subscriptions","organizations_url":"https://api.github.com/users/DvdKhl/orgs","repos_url":"https://api.github.com/users/DvdKhl/repos","events_url":"https://api.github.com/users/DvdKhl/events{/privacy}","received_events_url":"https://api.github.com/users/DvdKhl/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/35127/reactions","total_count":5,"+1":5,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/35127/timeline","performed_via_github_app":null,"state_reason":"completed"}