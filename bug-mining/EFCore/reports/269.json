{"url":"https://api.github.com/repos/dotnet/efcore/issues/31559","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/31559/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/31559/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/31559/events","html_url":"https://github.com/dotnet/efcore/issues/31559","id":1868235722,"node_id":"I_kwDOAPaMMs5vWwPK","number":31559,"title":"Temporary Key is inserted as ForeignKey","user":{"login":"jluki","id":12140388,"node_id":"MDQ6VXNlcjEyMTQwMzg4","avatar_url":"https://avatars.githubusercontent.com/u/12140388?v=4","gravatar_id":"","url":"https://api.github.com/users/jluki","html_url":"https://github.com/jluki","followers_url":"https://api.github.com/users/jluki/followers","following_url":"https://api.github.com/users/jluki/following{/other_user}","gists_url":"https://api.github.com/users/jluki/gists{/gist_id}","starred_url":"https://api.github.com/users/jluki/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jluki/subscriptions","organizations_url":"https://api.github.com/users/jluki/orgs","repos_url":"https://api.github.com/users/jluki/repos","events_url":"https://api.github.com/users/jluki/events{/privacy}","received_events_url":"https://api.github.com/users/jluki/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1901166749,"node_id":"MDU6TGFiZWwxOTAxMTY2NzQ5","url":"https://api.github.com/repos/dotnet/efcore/labels/area-change-tracking","name":"area-change-tracking","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/152","html_url":"https://github.com/dotnet/efcore/milestone/152","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/152/labels","id":8392036,"node_id":"MI_kwDOAPaMMs4AgA1k","number":152,"title":"8.0.0","description":"EF Core 8.0","creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":280,"state":"closed","created_at":"2022-09-07T19:55:36Z","updated_at":"2025-04-07T08:59:46Z","due_on":null,"closed_at":"2023-11-14T14:00:33Z"},"comments":1,"created_at":"2023-08-26T18:46:45Z","updated_at":"2025-06-15T19:50:55Z","closed_at":"2023-09-27T20:56:13Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I have a `Book` that has an n:m relationship with `Author`. The primary key of `Book` is a `Guid` and that of `Author` is `int`, which is additionally defined as a `ColumnIdentity`. There is an intermediate class `BookAuthor` with an `int` primary key `Id`, which is also defined as `ColumnIdentity`.\r\n\r\n![image](https://github.com/dotnet/efcore/assets/12140388/1de5554b-2cac-4700-ad08-112884bb9102)\r\n\r\n`DemoDbContext` looks like:\r\n\r\n```C#\r\npublic class DemoDbContext : DbContext\r\n{\r\n\r\n    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)\r\n    {\r\n        optionsBuilder.UseSqlServer(\"Server=localhost;Database=DemoDb;Trusted_Connection=True;TrustServerCertificate=True;Integrated Security=true\");\r\n    }\r\n\r\n    protected override void OnModelCreating(ModelBuilder modelBuilder)\r\n    {\r\n        // handle keys\r\n        modelBuilder.Entity<Author>().HasKey(a => a.Id);\r\n        modelBuilder.Entity<Author>().Property(a => a.Id).UseIdentityColumn();\r\n\r\n        modelBuilder.Entity<BookAuthor>().HasKey(ma => ma.Id);\r\n        modelBuilder.Entity<BookAuthor>().Property(ma => ma.Id).UseIdentityColumn();\r\n\r\n        modelBuilder.Entity<Book>().HasKey(b => b.Id);\r\n\r\n        // handle table names\r\n        modelBuilder.Entity<Author>().ToTable(\"Author\");\r\n        modelBuilder.Entity<Book>().ToTable(\"Book\");\r\n        modelBuilder.Entity<BookAuthor>().ToTable(\"BookAuthor\");\r\n\r\n        modelBuilder.Entity<Author>()\r\n            .HasMany(author => author.Books)\r\n            .WithMany(book => book.Authors)\r\n            .UsingEntity<BookAuthor>();\r\n    }\r\n\r\n    public DbSet<Author> Authors { get; set; } = null!;\r\n\r\n    public DbSet<Book> Books { get; set; } = null!;\r\n\r\n    public DbSet<BookAuthor> BookAuthors { get; set; } = null!;\r\n}\r\n```\r\n\r\nNow when I try to add some data with the following code, I get a conflict with a foreign key constraint.\r\n\r\n```C#\r\nusing var db = new DemoDbContext();\r\n\r\nAuthor marques = new Author { Name = \"Gabriel García Márquez\" };\r\nAuthor goethe = new Author { Name = \"Johann Wolfgang von Goethe\" };\r\n\r\nBook hundred = new Book { Title = \"One Hundred Years of Solitude\" };\r\nBook faust = new Book { Title = \"Faust\" };\r\n\r\nhundred.Authors.Add(marques);\r\nfaust.Authors.Add(goethe);\r\n\r\ndb.Books.Add(hundred);\r\ndb.Books.Add(faust);\r\n\r\ndb.SaveChanges();\r\n```\r\nresults in\r\n```\r\nMicrosoft.EntityFrameworkCore.DbUpdateException: 'An error occurred while saving the entity changes. See the inner exception for details.'\r\n\r\nInner Exception\r\nSqlException: The MERGE statement conflicted with the FOREIGN KEY constraint \"FK_BookAuthor_Author_AuthorId\". The conflict occurred in database \"DemoDb\", table \"dbo.Author\", column 'Id'.\r\n```\r\n\r\nIf I set a breakpoint on `db.SaveChanges()` and remove the foreign key constraint in the database, the `SaveChanges()` method succeeds. But in the `BookAuthor` table, the foreign key values for `Authors `contain the negative **temporary keys** and not the positive final keys.\r\n\r\nI have attached a small solution that illustrates the problem: [TempKeyBugExample.zip](https://github.com/dotnet/efcore/files/12446471/TempKeyBugExample.zip)\r\n\r\nThe database tables look like:\r\n\r\n![image](https://github.com/dotnet/efcore/assets/12140388/0f206244-8d88-46e8-b11a-2851088cb94b)\r\n![image](https://github.com/dotnet/efcore/assets/12140388/cb7838df-8927-4de6-8a3a-02212fc5f9b5)\r\n![image](https://github.com/dotnet/efcore/assets/12140388/e14f167d-c20f-4308-b321-6dd86bd370d2)\r\n\r\nOf course, you could add and save the authors beforehand. The following code works:\r\n\r\n```C#\r\nusing var db = new DemoDbContext();\r\n\r\ndb.Database.EnsureDeleted();\r\ndb.Database.EnsureCreated();\r\n\r\nAuthor marques = new Author { Name = \"Gabriel García Márquez\" };\r\nAuthor goethe = new Author { Name = \"Johann Wolfgang von Goethe\" };\r\n\r\nBook hundred = new Book { Title = \"One Hundred Years of Solitude\" };\r\nBook faust = new Book { Title = \"Faust\" };\r\n\r\ndb.Authors.Add(marques);\r\ndb.Authors.Add(goethe);\r\ndb.SaveChanges();\r\n\r\nhundred.Authors.Add(marques);\r\nfaust.Authors.Add(goethe);\r\n\r\ndb.Books.Add(hundred);\r\ndb.Books.Add(faust);\r\n\r\ndb.SaveChanges();\r\n```\r\n\r\nBut shouldn't the first code mentioned work from scratch? Am I missing something?\r\n\r\n### provider and version information\r\n\r\nEF Core version: 7.0.10\r\nDatabase provider: Microsoft.EntityFrameworkCore.SqlServer\r\nTarget framework: .NET 7.0\r\nOperating system: Windows 11 Pro\r\nIDE: Visual Studio 2022 17.7.2\r\n","closed_by":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/31559/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/31559/timeline","performed_via_github_app":null,"state_reason":"completed"}