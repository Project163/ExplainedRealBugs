{"url":"https://api.github.com/repos/dotnet/efcore/issues/34760","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/34760/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/34760/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/34760/events","html_url":"https://github.com/dotnet/efcore/issues/34760","id":2549621996,"node_id":"I_kwDOAPaMMs6X-CTs","number":34760,"title":"`NullReferenceException` for a custom `ValueConverter` in EF Core 9 RC 1.","user":{"login":"maliming","id":6908465,"node_id":"MDQ6VXNlcjY5MDg0NjU=","avatar_url":"https://avatars.githubusercontent.com/u/6908465?v=4","gravatar_id":"","url":"https://api.github.com/users/maliming","html_url":"https://github.com/maliming","followers_url":"https://api.github.com/users/maliming/followers","following_url":"https://api.github.com/users/maliming/following{/other_user}","gists_url":"https://api.github.com/users/maliming/gists{/gist_id}","starred_url":"https://api.github.com/users/maliming/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maliming/subscriptions","organizations_url":"https://api.github.com/users/maliming/orgs","repos_url":"https://api.github.com/users/maliming/repos","events_url":"https://api.github.com/users/maliming/events{/privacy}","received_events_url":"https://api.github.com/users/maliming/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":514908713,"node_id":"MDU6TGFiZWw1MTQ5MDg3MTM=","url":"https://api.github.com/repos/dotnet/efcore/labels/regression","name":"regression","color":"ff1fff","default":false,"description":null},{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1675384372,"node_id":"MDU6TGFiZWwxNjc1Mzg0Mzcy","url":"https://api.github.com/repos/dotnet/efcore/labels/area-query","name":"area-query","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/180","html_url":"https://github.com/dotnet/efcore/milestone/180","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/180/labels","id":9963267,"node_id":"MI_kwDOAPaMMs4AmAcD","number":180,"title":"9.0.0","description":null,"creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":339,"state":"closed","created_at":"2023-09-25T15:41:58Z","updated_at":"2025-04-01T18:19:15Z","due_on":null,"closed_at":"2024-11-14T11:54:05Z"},"comments":9,"created_at":"2024-09-26T06:19:45Z","updated_at":"2025-06-15T20:10:06Z","closed_at":"2024-10-16T00:39:47Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"The `csproj` and code to reproduce:\r\n\r\n```cs\r\n<Project Sdk=\"Microsoft.NET.Sdk\">\r\n\r\n    <PropertyGroup>\r\n        <OutputType>Exe</OutputType>\r\n        <TargetFramework>net9.0</TargetFramework>\r\n        <ImplicitUsings>enable</ImplicitUsings>\r\n        <Nullable>enable</Nullable>\r\n    </PropertyGroup>\r\n\r\n    <ItemGroup>\r\n      <PackageReference Include=\"Microsoft.EntityFrameworkCore.Design\" Version=\"9.0.0-rc.1.24451.1\">\r\n        <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>\r\n        <PrivateAssets>all</PrivateAssets>\r\n      </PackageReference>\r\n      <PackageReference Include=\"Microsoft.EntityFrameworkCore.Sqlite\" Version=\"9.0.0-rc.1.24451.1\" />\r\n    </ItemGroup>\r\n\r\n</Project>\r\n```\r\n\r\n```cs\r\nusing Microsoft.EntityFrameworkCore;\r\nusing Microsoft.EntityFrameworkCore.Storage.ValueConversion;\r\n\r\nvar db = new BookContext();\r\n\r\nawait db.Books.AddAsync( new Book()\r\n{\r\n    CreationDate = DateTime.Now\r\n});\r\n\r\nawait db.SaveChangesAsync();\r\n\r\nvar result =  await db.Books\r\n    .GroupBy(t => t.Id)\r\n    .Select(g => new\r\n    {\r\n        Day = g.Min(t => t.CreationDate)\r\n    })\r\n    .ToListAsync();\r\n\r\npublic class BookContext : DbContext\r\n{\r\n    public DbSet<Book> Books { get; set; }\r\n\r\n    public string DbPath { get; }\r\n\r\n    public BookContext()\r\n    {\r\n        var folder = Environment.SpecialFolder.LocalApplicationData;\r\n        var path = Environment.GetFolderPath(folder);\r\n        DbPath = Path.Join(path, \"book.db\");\r\n    }\r\n\r\n    protected override void OnModelCreating(ModelBuilder modelBuilder)\r\n    {\r\n        modelBuilder.Entity<Book>().Property(e => e.CreationDate).HasConversion(new MyDateTimeValueConverter(new MyDatetimeConverter()));\r\n    }\r\n\r\n    protected override void OnConfiguring(DbContextOptionsBuilder options)\r\n        => options.UseSqlite($\"Data Source={DbPath}\", builder => builder.UseQuerySplittingBehavior(QuerySplittingBehavior.SplitQuery)).EnableDetailedErrors();\r\n}\r\n\r\npublic class MyDateTimeValueConverter : ValueConverter<DateTime, DateTime>\r\n{\r\n    public MyDateTimeValueConverter(MyDatetimeConverter myDatetimeConverter, ConverterMappingHints? mappingHints = null)\r\n        : base(\r\n            x => myDatetimeConverter.Normalize(x),\r\n            x => myDatetimeConverter.Normalize(x),\r\n            mappingHints)\r\n    {\r\n    }\r\n}\r\n\r\npublic class Book\r\n{\r\n    public Guid Id { get; set; }\r\n\r\n    public virtual DateTime CreationDate { get;  set; }\r\n}\r\n\r\n\r\npublic class MyDatetimeConverter\r\n{\r\n    public virtual DateTime Normalize(DateTime dateTime)\r\n    {\r\n        return dateTime.Date;\r\n    }\r\n}\r\n\r\n```\r\n\r\n```cs\r\nUnhandled exception. System.InvalidOperationException: An error occurred while reading a database value. The expected type was 'System.Nullable`1[System.DateTime]' but the actual value was null.\r\n ---> System.NullReferenceException: Object reference not set to an instance of an object.\r\n   at lambda_method34(Closure, QueryContext, DbDataReader, ResultContext, SplitQueryResultCoordinator)\r\n   --- End of inner exception stack trace ---\r\n   at lambda_method34(Closure, QueryContext, DbDataReader, ResultContext, SplitQueryResultCoordinator)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.SplitQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()\r\n   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.ToListAsync[TSource](IQueryable`1 source, CancellationToken cancellationToken)\r\n   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.ToListAsync[TSource](IQueryable`1 source, CancellationToken cancellationToken)\r\n   at Program.<Main>$(String[] args) in ConsoleApp\\ConsoleApp\\Program.cs:line 13\r\n   at Program.<Main>(String[] args)\r\n\r\n```\r\n\r\n---\r\n\r\nIt works if I create the `MyDatetimeConverter()` object in the expression parameter.\r\nAnd the all code works in EF Core 8.0.\r\n\r\n```cs\r\npublic class MyDateTimeValueConverter : ValueConverter<DateTime, DateTime>\r\n{\r\n    public MyDateTimeValueConverter(MyDatetimeConverter myDatetimeConverter, ConverterMappingHints? mappingHints = null)\r\n        : base(\r\n            x => new MyDatetimeConverter().Normalize(x),\r\n            x => new MyDatetimeConverter().Normalize(x),\r\n            mappingHints)\r\n    {\r\n    }\r\n}\r\n```","closed_by":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/34760/reactions","total_count":4,"+1":4,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/34760/timeline","performed_via_github_app":null,"state_reason":"completed"}