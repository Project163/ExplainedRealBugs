[{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2474102337","html_url":"https://github.com/dotnet/efcore/issues/35096#issuecomment-2474102337","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/35096","id":2474102337,"node_id":"IC_kwDOAPaMMs6Td85B","user":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-11-13T16:23:44Z","updated_at":"2024-11-13T16:23:44Z","body":"@Tornhoof can you please share the part of the migration which causes the error when executing in a transaction?","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2474102337/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":15285867375,"node_id":"MEE_lADOAPaMMs6eT84nzwAAAAOPG9Nv","url":"https://api.github.com/repos/dotnet/efcore/issues/events/15285867375","actor":{"login":"Tornhoof","id":7989549,"node_id":"MDQ6VXNlcjc5ODk1NDk=","avatar_url":"https://avatars.githubusercontent.com/u/7989549?v=4","gravatar_id":"","url":"https://api.github.com/users/Tornhoof","html_url":"https://github.com/Tornhoof","followers_url":"https://api.github.com/users/Tornhoof/followers","following_url":"https://api.github.com/users/Tornhoof/following{/other_user}","gists_url":"https://api.github.com/users/Tornhoof/gists{/gist_id}","starred_url":"https://api.github.com/users/Tornhoof/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Tornhoof/subscriptions","organizations_url":"https://api.github.com/users/Tornhoof/orgs","repos_url":"https://api.github.com/users/Tornhoof/repos","events_url":"https://api.github.com/users/Tornhoof/events{/privacy}","received_events_url":"https://api.github.com/users/Tornhoof/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-11-13T16:23:45Z","performed_via_github_app":null},{"id":15285867389,"node_id":"SE_lADOAPaMMs6eT84nzwAAAAOPG9N9","url":"https://api.github.com/repos/dotnet/efcore/issues/events/15285867389","actor":{"login":"Tornhoof","id":7989549,"node_id":"MDQ6VXNlcjc5ODk1NDk=","avatar_url":"https://avatars.githubusercontent.com/u/7989549?v=4","gravatar_id":"","url":"https://api.github.com/users/Tornhoof","html_url":"https://github.com/Tornhoof","followers_url":"https://api.github.com/users/Tornhoof/followers","following_url":"https://api.github.com/users/Tornhoof/following{/other_user}","gists_url":"https://api.github.com/users/Tornhoof/gists{/gist_id}","starred_url":"https://api.github.com/users/Tornhoof/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Tornhoof/subscriptions","organizations_url":"https://api.github.com/users/Tornhoof/orgs","repos_url":"https://api.github.com/users/Tornhoof/repos","events_url":"https://api.github.com/users/Tornhoof/events{/privacy}","received_events_url":"https://api.github.com/users/Tornhoof/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-11-13T16:23:45Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2474227864","html_url":"https://github.com/dotnet/efcore/issues/35096#issuecomment-2474227864","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/35096","id":2474227864,"node_id":"IC_kwDOAPaMMs6TebiY","user":{"login":"Tornhoof","id":7989549,"node_id":"MDQ6VXNlcjc5ODk1NDk=","avatar_url":"https://avatars.githubusercontent.com/u/7989549?v=4","gravatar_id":"","url":"https://api.github.com/users/Tornhoof","html_url":"https://github.com/Tornhoof","followers_url":"https://api.github.com/users/Tornhoof/followers","following_url":"https://api.github.com/users/Tornhoof/following{/other_user}","gists_url":"https://api.github.com/users/Tornhoof/gists{/gist_id}","starred_url":"https://api.github.com/users/Tornhoof/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Tornhoof/subscriptions","organizations_url":"https://api.github.com/users/Tornhoof/orgs","repos_url":"https://api.github.com/users/Tornhoof/repos","events_url":"https://api.github.com/users/Tornhoof/events{/privacy}","received_events_url":"https://api.github.com/users/Tornhoof/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-11-13T17:05:04Z","updated_at":"2024-11-13T17:05:04Z","body":"I'm not sure how much you need, what specifically fails are the 4 sql statements in the log file, the first first one in that file fails.\nThis is directly the first call to `` migrationBuilder.Sql`` in this specific migration source file. If I comment it or use the suppressTransaction arg everything works. It's not the first migration file, nor the last, nor is it the first or last using sql statements or even the aforementioned TVP_BigInt.\n\nThe full migration file, which includes these sql statements is below in details. The migration is basically three different sql scripts, first one cleans some SQL graph tables up, then removes a column in a SQL Graph tables and changes a few constrains and the third one recreates an unrelated table-valued-parameter. The migrations are just used to run the scripts, there are no EF core model changes involved.\n\n<details>\n\n```csharp\n\nnamespace WebApp.Viewing.Graph.Migrations\n{\n    public static class GraphTableMigrationExtension\n    {\n\n       // THIS ONE FAILS\n        private const string CleanupDanglingPredecessorsSql = @\"\nDECLARE @ToDeletePredecessor AS TVP_BIGINT;\nINSERT INTO @ToDeletePredecessor SELECT DISTINCT e.Id FROM isPredecessorOf e LEFT OUTER JOIN Nodes n1 ON n1.$node_id = e.$from_id LEFT OUTER JOIN Nodes n2 ON n2.$node_id = e.$to_id WHERE n1.Id IS NULL OR n2.Id IS NULL;\nDELETE FROM GraphPaths WHERE Id IN (SELECT [Value] FROM @ToDeletePredecessor);\nDELETE FROM isPredecessorOf WHERE Id IN (SELECT [Value] FROM @ToDeletePredecessor)\n\";\n\n\t\n\t\tpublic static void CleanupDanglingPredecessors(this MigrationBuilder migrationBuilder)\n        {\n            migrationBuilder.Sql(CleanupDanglingPredecessorsSql, suppressTransaction:true); // requires suppressTransaction in .NET 9 atm\n        }\n\n        private const string RemoveMetadataIdColumn = @\"\nIF COL_LENGTH('dbo.Nodes', 'MetadataId') IS NOT NULL\nBEGIN\n    ALTER TABLE Nodes ADD CONSTRAINT FK_Nodes_Metadata_Id FOREIGN KEY (Id) REFERENCES Metadata (Id) ON DELETE CASCADE;\n    ALTER TABLE Nodes DROP CONSTRAINT C_Nodes_Id_MetadataId;\n    DROP INDEX IX_Nodes_MetadataId ON Nodes;\n    ALTER TABLE Nodes DROP COLUMN MetadataId;\n    ALTER TABLE isParentOf ADD CONSTRAINT EC_isParentOf CONNECTION (Nodes TO Nodes) ON DELETE CASCADE;\n    ALTER TABLE isFollowerOf ADD CONSTRAINT EC_isFollowerOf CONNECTION (Nodes TO Nodes) ON DELETE CASCADE;\n    ALTER TABLE isPredecessorOf ADD CONSTRAINT EC_isPredecessorOf CONNECTION (Nodes TO Nodes) ON DELETE CASCADE;\nEND\n\";\n        public static void RemoveMetadataId(this MigrationBuilder migrationBuilder)\n        {\n            migrationBuilder.Sql(RemoveMetadataIdColumn);\n        }\n\t\t\n\t\tprivate const string DropNodeTvp = \"DROP TYPE IF EXISTS TVP_Nodes\";\n\t\t\n        private const string CreateNodeTvp = @\"\nIF TYPE_ID(N'TVP_Nodes') IS NULL\nCREATE TYPE [TVP_Nodes] AS TABLE(\n\t[Id] BIGINT NOT NULL,\n\t[NodeType] INT NOT NULL,\n\t[Text] NVARCHAR(523),\n\tINDEX IX_TVP_Nodes_Id ([Id])\n);\";\t\t\n\t\t\n        public static void RecreateNodeTvpStatement(this MigrationBuilder migrationBuilder)\n        {\n            migrationBuilder.DropNodeTvpStatement();\n            migrationBuilder.CreateNodeTvpStatement();\n        }\n\t\n\t}\n}\t  \n\n\nusing WebApp.Viewing.Graph.Extensions;\nusing Microsoft.EntityFrameworkCore.Migrations;\n\n#nullable disable\n\nnamespace WebApp.Viewing.Graph.Migrations\n{\n    /// <inheritdoc />\n    public partial class RemoveNodesMetadataId : Migration\n    {\n        /// <inheritdoc />\n        protected override void Up(MigrationBuilder migrationBuilder)\n        {\n            // this is to add the later node constraints\n            migrationBuilder.CleanupDanglingPredecessors();\n            migrationBuilder.RemoveMetadataId();\n            migrationBuilder.RecreateNodeTvpStatement();\n        }\n\n        /// <inheritdoc />\n        protected override void Down(MigrationBuilder migrationBuilder)\n        {\n            // not supported\n        }\n    }\n}\n\n\n// <auto-generated />\nusing System;\nusing WebApp.Viewing.Graph.Infrastructure;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.EntityFrameworkCore.Infrastructure;\nusing Microsoft.EntityFrameworkCore.Metadata;\nusing Microsoft.EntityFrameworkCore.Migrations;\nusing Microsoft.EntityFrameworkCore.Storage.ValueConversion;\n\n#nullable disable\n\nnamespace WebApp.Viewing.Graph.Migrations\n{\n    [DbContext(typeof(GraphContext))]\n    [Migration(\"20230313093754_RemoveNodesMetadataId\")]\n    partial class RemoveNodesMetadataId\n    {\n        /// <inheritdoc />\n        protected override void BuildTargetModel(ModelBuilder modelBuilder)\n        {\n#pragma warning disable 612, 618\n            modelBuilder\n                .HasAnnotation(\"ProductVersion\", \"7.0.3\")\n                .HasAnnotation(\"Relational:MaxIdentifierLength\", 128);\n\n            SqlServerModelBuilderExtensions.UseIdentityColumns(modelBuilder);\n\n            modelBuilder.Entity(\"WebApp.Viewing.Graph.Data.CustomAttribute\", b =>\n                {\n                    b.Property<long>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"bigint\");\n\n                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<long>(\"Id\"));\n\n                    b.Property<string>(\"Key\")\n                        .HasMaxLength(100)\n                        .HasColumnType(\"nvarchar(100)\");\n\n                    b.Property<long>(\"MetadataId\")\n                        .HasColumnType(\"bigint\");\n\n                    b.Property<int>(\"Order\")\n                        .HasColumnType(\"int\");\n\n                    b.Property<byte[]>(\"RowVersion\")\n                        .IsConcurrencyToken()\n                        .IsRequired()\n                        .ValueGeneratedOnAddOrUpdate()\n                        .HasColumnType(\"rowversion\");\n\n                    b.Property<int>(\"Type\")\n                        .HasColumnType(\"int\");\n\n                    b.Property<string>(\"Value\")\n                        .IsRequired()\n                        .HasColumnType(\"nvarchar(max)\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"Type\");\n\n                    b.HasIndex(\"MetadataId\", \"Order\")\n                        .IsUnique();\n\n                    b.ToTable(\"Attributes\", (string)null);\n                });\n\n            modelBuilder.Entity(\"WebApp.Viewing.Graph.Data.GraphPath\", b =>\n                {\n                    b.Property<long>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"bigint\");\n\n                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<long>(\"Id\"));\n\n                    b.Property<DateTimeOffset>(\"Created\")\n                        .HasColumnType(\"datetimeoffset\");\n\n                    b.Property<string>(\"Key\")\n                        .IsRequired()\n                        .HasMaxLength(128)\n                        .HasColumnType(\"nvarchar(128)\");\n\n                    b.Property<long>(\"MetadataId\")\n                        .HasColumnType(\"bigint\");\n\n                    b.Property<byte[]>(\"RowVersion\")\n                        .IsConcurrencyToken()\n                        .IsRequired()\n                        .ValueGeneratedOnAddOrUpdate()\n                        .HasColumnType(\"rowversion\");\n\n                    b.Property<int>(\"Type\")\n                        .HasColumnType(\"int\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"Key\")\n                        .IsUnique();\n\n                    b.HasIndex(\"MetadataId\");\n\n                    b.HasIndex(\"Type\");\n\n                    b.ToTable(\"GraphPaths\", (string)null);\n                });\n\n            modelBuilder.Entity(\"WebApp.Viewing.Graph.Data.Metadata\", b =>\n                {\n                    b.Property<long>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"bigint\");\n\n                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<long>(\"Id\"));\n\n                    b.Property<bool>(\"Extended\")\n                        .HasColumnType(\"bit\");\n\n                    b.Property<byte?>(\"Operation\")\n                        .HasColumnType(\"tinyint\");\n\n                    b.Property<string>(\"Path\")\n                        .HasMaxLength(500)\n                        .HasColumnType(\"nvarchar(500)\");\n\n                    b.Property<byte[]>(\"RowVersion\")\n                        .IsConcurrencyToken()\n                        .IsRequired()\n                        .ValueGeneratedOnAddOrUpdate()\n                        .HasColumnType(\"rowversion\");\n\n                    b.Property<string>(\"SourceGroupId\")\n                        .HasMaxLength(100)\n                        .HasColumnType(\"nvarchar(100)\");\n\n                    b.Property<string>(\"SourceNodeId\")\n                        .HasMaxLength(100)\n                        .HasColumnType(\"nvarchar(100)\");\n\n                    b.Property<string>(\"SourceOperationReference\")\n                        .HasMaxLength(200)\n                        .HasColumnType(\"nvarchar(200)\");\n\n                    b.Property<int>(\"Type\")\n                        .HasColumnType(\"int\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"Path\")\n                        .HasFilter(\"[Path] IS NOT NULL AND [Type] != 105\");\n\n                    b.HasIndex(\"SourceNodeId\");\n\n                    b.HasIndex(\"Type\");\n\n                    b.ToTable(\"Metadata\", (string)null);\n                });\n\n            modelBuilder.Entity(\"WebApp.Viewing.Graph.Data.VdmIndexedAttributeType\", b =>\n                {\n                    b.Property<int>(\"Type\")\n                        .HasColumnType(\"int\");\n\n                    b.Property<bool>(\"Mode\")\n                        .HasColumnType(\"bit\");\n\n                    b.HasKey(\"Type\");\n\n                    b.ToTable(\"VdmIndexedAttributeTypes\", (string)null);\n                });\n\n            modelBuilder.Entity(\"WebApp.Viewing.Graph.Data.CustomAttribute\", b =>\n                {\n                    b.HasOne(\"WebApp.Viewing.Graph.Data.Metadata\", null)\n                        .WithMany(\"CustomAttributes\")\n                        .HasForeignKey(\"MetadataId\")\n                        .OnDelete(DeleteBehavior.Cascade)\n                        .IsRequired();\n                });\n\n            modelBuilder.Entity(\"WebApp.Viewing.Graph.Data.Metadata\", b =>\n                {\n                    b.Navigation(\"CustomAttributes\");\n                });\n#pragma warning restore 612, 618\n        }\n    }\n}\n\n```\n\n</details>","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2474227864/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Tornhoof","id":7989549,"node_id":"MDQ6VXNlcjc5ODk1NDk=","avatar_url":"https://avatars.githubusercontent.com/u/7989549?v=4","gravatar_id":"","url":"https://api.github.com/users/Tornhoof","html_url":"https://github.com/Tornhoof","followers_url":"https://api.github.com/users/Tornhoof/followers","following_url":"https://api.github.com/users/Tornhoof/following{/other_user}","gists_url":"https://api.github.com/users/Tornhoof/gists{/gist_id}","starred_url":"https://api.github.com/users/Tornhoof/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Tornhoof/subscriptions","organizations_url":"https://api.github.com/users/Tornhoof/orgs","repos_url":"https://api.github.com/users/Tornhoof/repos","events_url":"https://api.github.com/users/Tornhoof/events{/privacy}","received_events_url":"https://api.github.com/users/Tornhoof/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2474231548","html_url":"https://github.com/dotnet/efcore/issues/35096#issuecomment-2474231548","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/35096","id":2474231548,"node_id":"IC_kwDOAPaMMs6Tecb8","user":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-11-13T17:06:34Z","updated_at":"2024-11-13T17:06:34Z","body":"How does it fail, what's the error? We need some details in order to investigate this.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2474231548/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2474264820","html_url":"https://github.com/dotnet/efcore/issues/35096#issuecomment-2474264820","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/35096","id":2474264820,"node_id":"IC_kwDOAPaMMs6Tekj0","user":{"login":"Tornhoof","id":7989549,"node_id":"MDQ6VXNlcjc5ODk1NDk=","avatar_url":"https://avatars.githubusercontent.com/u/7989549?v=4","gravatar_id":"","url":"https://api.github.com/users/Tornhoof","html_url":"https://github.com/Tornhoof","followers_url":"https://api.github.com/users/Tornhoof/followers","following_url":"https://api.github.com/users/Tornhoof/following{/other_user}","gists_url":"https://api.github.com/users/Tornhoof/gists{/gist_id}","starred_url":"https://api.github.com/users/Tornhoof/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Tornhoof/subscriptions","organizations_url":"https://api.github.com/users/Tornhoof/orgs","repos_url":"https://api.github.com/users/Tornhoof/repos","events_url":"https://api.github.com/users/Tornhoof/events{/privacy}","received_events_url":"https://api.github.com/users/Tornhoof/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-11-13T17:20:24Z","updated_at":"2024-11-13T17:20:24Z","body":"\nIt happens during the unit tests which create a db via ``graphContext.Database.MigrateAsync`` on an non-existing db.\nIt also happens if I run the affected migration against an existing db which has old enough state.\nThe exception is the following:\n```ini\n  System.InvalidOperationException : An exception has been raised that is likely due to a transient failure. Consider enabling transient error resiliency by adding 'EnableRetryOnFailure' to the 'UseSqlServer' call.\n  ---- Microsoft.Data.SqlClient.SqlException : Transaction (Process ID 54) was deadlocked on lock resources with another process and has been chosen as the deadlock victim. Rerun the transaction.\n  Stack Trace:\nWebApp.Annotation.LongTests.AnnotationHandlerTests.FindRangeMultipleMetadataIdsConsecutive(count: 100, extraIds: True) [FAIL]\n       at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)\n       at Microsoft.EntityFrameworkCore.Migrations.Internal.MigrationCommandExecutor.ExecuteNonQueryAsync(IReadOnlyList`1 migrationCommands, IRelationalConnection connection, MigrationExecutionState executionState, Boolean commitTransaction, Nullable`1 isolationLevel, CancellationToken cancellationToken)\n       at Microsoft.EntityFrameworkCore.Migrations.Internal.Migrator.MigrateImplementationAsync(DbContext context, String targetMigration, MigrationExecutionState state, Boolean useTransaction, CancellationToken cancellationToken)\n       at Microsoft.EntityFrameworkCore.Migrations.Internal.Migrator.MigrateImplementationAsync(DbContext context, String targetMigration, MigrationExecutionState state, Boolean useTransaction, CancellationToken cancellationToken)\n       at Microsoft.EntityFrameworkCore.Migrations.Internal.Migrator.<>c.<<MigrateAsync>b__22_1>d.MoveNext()\n    --- End of stack trace from previous location ---\n       at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)\n       at Microsoft.EntityFrameworkCore.Migrations.Internal.Migrator.MigrateAsync(String targetMigration, CancellationToken cancellationToken)\n       at Microsoft.EntityFrameworkCore.Migrations.Internal.Migrator.MigrateAsync(String targetMigration, CancellationToken cancellationToken)\n    C:\\agent\\_work\\8\\s\\Backend\\NGP\\QA\\WebApp.Annotation.LongTests\\AnnotationLongTestFixture.cs(45,0): at WebApp.Annotation.LongTests.AnnotationLongTestFixture.GetGraphContext()\n    C:\\agent\\_work\\8\\s\\Backend\\NGP\\QA\\WebApp.Annotation.LongTests\\AnnotationLongTestFixture.cs(34,0): at WebApp.Annotation.LongTests.AnnotationLongTestFixture.InitializeAsync()\n    ----- Inner Stack Trace -----\n       at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)\n       at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)\n       at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, SqlCommand command, Boolean callerHasConnectionLock, Boolean asyncClose)\n       at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)\n       at Microsoft.Data.SqlClient.SqlCommand.InternalEndExecuteNonQuery(IAsyncResult asyncResult, Boolean isInternal, String endMethod)\n       at Microsoft.Data.SqlClient.SqlCommand.EndExecuteNonQueryInternal(IAsyncResult asyncResult)\n       at Microsoft.Data.SqlClient.SqlCommand.EndExecuteNonQueryAsync(IAsyncResult asyncResult)\n       at Microsoft.Data.SqlClient.SqlCommand.<>c.<InternalExecuteNonQueryAsync>b__193_1(IAsyncResult asyncResult)\n       at System.Threading.Tasks.TaskFactory`1.FromAsyncCoreLogic(IAsyncResult iar, Func`2 endFunction, Action`1 endAction, Task`1 promise, Boolean requiresSynchronization)\n    --- End of stack trace from previous location ---\n       at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteNonQueryAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)\n       at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteNonQueryAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)\n       at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteNonQueryAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)\n       at Microsoft.EntityFrameworkCore.Migrations.Internal.MigrationCommandExecutor.ExecuteAsync(IReadOnlyList`1 migrationCommands, IRelationalConnection connection, MigrationExecutionState executionState, Boolean beginTransaction, Boolean commitTransaction, Nullable`1 isolationLevel, CancellationToken cancellationToken)\n       at Microsoft.EntityFrameworkCore.Migrations.Internal.MigrationCommandExecutor.ExecuteAsync(IReadOnlyList`1 migrationCommands, IRelationalConnection connection, MigrationExecutionState executionState, Boolean beginTransaction, Boolean commitTransaction, Nullable`1 isolationLevel, CancellationToken cancellationToken)\n       at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)\n\n```\n\nIf I read the What's new Document correctly, EF Core 9 now tries to block concurrent migrations,  I don't know if Resource deadlock is the expected error if that happens, but I'm really sure that there are no concurrent migrations here and commenting out a specific sql statement should have no impact on concurrent migrations anyway, so I did put that into the topic.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2474264820/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Tornhoof","id":7989549,"node_id":"MDQ6VXNlcjc5ODk1NDk=","avatar_url":"https://avatars.githubusercontent.com/u/7989549?v=4","gravatar_id":"","url":"https://api.github.com/users/Tornhoof","html_url":"https://github.com/Tornhoof","followers_url":"https://api.github.com/users/Tornhoof/followers","following_url":"https://api.github.com/users/Tornhoof/following{/other_user}","gists_url":"https://api.github.com/users/Tornhoof/gists{/gist_id}","starred_url":"https://api.github.com/users/Tornhoof/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Tornhoof/subscriptions","organizations_url":"https://api.github.com/users/Tornhoof/orgs","repos_url":"https://api.github.com/users/Tornhoof/repos","events_url":"https://api.github.com/users/Tornhoof/events{/privacy}","received_events_url":"https://api.github.com/users/Tornhoof/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":15290328361,"node_id":"LE_lADOAPaMMs6eT84nzwAAAAOPX-Up","url":"https://api.github.com/repos/dotnet/efcore/issues/events/15290328361","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2024-11-13T22:43:45Z","label":{"name":"area-migrations","color":"32b37b"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2474974761","html_url":"https://github.com/dotnet/efcore/issues/35096#issuecomment-2474974761","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/35096","id":2474974761,"node_id":"IC_kwDOAPaMMs6ThR4p","user":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-11-13T22:44:18Z","updated_at":"2024-11-13T22:44:18Z","body":"That's very odd indeed. Are you able to put together a minimal repro that shows this happening? That would be the best way to help us investigate and fix this.\n\n/cc @AndriySvyryd ","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2474974761/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":15290332509,"node_id":"MEE_lADOAPaMMs6eT84nzwAAAAOPX_Vd","url":"https://api.github.com/repos/dotnet/efcore/issues/events/15290332509","actor":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-11-13T22:44:19Z","performed_via_github_app":null},{"id":15290332524,"node_id":"SE_lADOAPaMMs6eT84nzwAAAAOPX_Vs","url":"https://api.github.com/repos/dotnet/efcore/issues/events/15290332524","actor":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-11-13T22:44:19Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2474977855","html_url":"https://github.com/dotnet/efcore/issues/35096#issuecomment-2474977855","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/35096","id":2474977855,"node_id":"IC_kwDOAPaMMs6ThSo_","user":{"login":"Tornhoof","id":7989549,"node_id":"MDQ6VXNlcjc5ODk1NDk=","avatar_url":"https://avatars.githubusercontent.com/u/7989549?v=4","gravatar_id":"","url":"https://api.github.com/users/Tornhoof","html_url":"https://github.com/Tornhoof","followers_url":"https://api.github.com/users/Tornhoof/followers","following_url":"https://api.github.com/users/Tornhoof/following{/other_user}","gists_url":"https://api.github.com/users/Tornhoof/gists{/gist_id}","starred_url":"https://api.github.com/users/Tornhoof/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Tornhoof/subscriptions","organizations_url":"https://api.github.com/users/Tornhoof/orgs","repos_url":"https://api.github.com/users/Tornhoof/repos","events_url":"https://api.github.com/users/Tornhoof/events{/privacy}","received_events_url":"https://api.github.com/users/Tornhoof/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-11-13T22:46:09Z","updated_at":"2024-11-13T22:46:09Z","body":"I'll see what I can cobble together ","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2474977855/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Tornhoof","id":7989549,"node_id":"MDQ6VXNlcjc5ODk1NDk=","avatar_url":"https://avatars.githubusercontent.com/u/7989549?v=4","gravatar_id":"","url":"https://api.github.com/users/Tornhoof","html_url":"https://github.com/Tornhoof","followers_url":"https://api.github.com/users/Tornhoof/followers","following_url":"https://api.github.com/users/Tornhoof/following{/other_user}","gists_url":"https://api.github.com/users/Tornhoof/gists{/gist_id}","starred_url":"https://api.github.com/users/Tornhoof/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Tornhoof/subscriptions","organizations_url":"https://api.github.com/users/Tornhoof/orgs","repos_url":"https://api.github.com/users/Tornhoof/repos","events_url":"https://api.github.com/users/Tornhoof/events{/privacy}","received_events_url":"https://api.github.com/users/Tornhoof/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2475587878","html_url":"https://github.com/dotnet/efcore/issues/35096#issuecomment-2475587878","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/35096","id":2475587878,"node_id":"IC_kwDOAPaMMs6Tjnkm","user":{"login":"Tornhoof","id":7989549,"node_id":"MDQ6VXNlcjc5ODk1NDk=","avatar_url":"https://avatars.githubusercontent.com/u/7989549?v=4","gravatar_id":"","url":"https://api.github.com/users/Tornhoof","html_url":"https://github.com/Tornhoof","followers_url":"https://api.github.com/users/Tornhoof/followers","following_url":"https://api.github.com/users/Tornhoof/following{/other_user}","gists_url":"https://api.github.com/users/Tornhoof/gists{/gist_id}","starred_url":"https://api.github.com/users/Tornhoof/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Tornhoof/subscriptions","organizations_url":"https://api.github.com/users/Tornhoof/orgs","repos_url":"https://api.github.com/users/Tornhoof/repos","events_url":"https://api.github.com/users/Tornhoof/events{/privacy}","received_events_url":"https://api.github.com/users/Tornhoof/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-11-14T07:16:00Z","updated_at":"2024-11-14T07:16:00Z","body":"I wrote a repro here: https://github.com/Tornhoof/MigrationRepro, just clone it and run it (see program.cs for connection string).\nIt contains two migrations, one creates a tvp, the other one uses it.\nAs expected above it is the TVP.\nApparently I was wrong and it's the first use of any TVP in any migration, every other migration just creates them.\n","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2475587878/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Tornhoof","id":7989549,"node_id":"MDQ6VXNlcjc5ODk1NDk=","avatar_url":"https://avatars.githubusercontent.com/u/7989549?v=4","gravatar_id":"","url":"https://api.github.com/users/Tornhoof","html_url":"https://github.com/Tornhoof","followers_url":"https://api.github.com/users/Tornhoof/followers","following_url":"https://api.github.com/users/Tornhoof/following{/other_user}","gists_url":"https://api.github.com/users/Tornhoof/gists{/gist_id}","starred_url":"https://api.github.com/users/Tornhoof/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Tornhoof/subscriptions","organizations_url":"https://api.github.com/users/Tornhoof/orgs","repos_url":"https://api.github.com/users/Tornhoof/repos","events_url":"https://api.github.com/users/Tornhoof/events{/privacy}","received_events_url":"https://api.github.com/users/Tornhoof/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2476059550","html_url":"https://github.com/dotnet/efcore/issues/35096#issuecomment-2476059550","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/35096","id":2476059550,"node_id":"IC_kwDOAPaMMs6Tlaue","user":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-11-14T11:08:17Z","updated_at":"2024-11-14T11:08:17Z","body":"Confirmed, see below for a minimal repro without EF: trying to create a TVP and to declare a variable with that TVP in a transaction fails on SQL Server because of a deadlock.\n\nNote that this was a problem in previous versions of EF; the following migration triggers a deadlock also with EF 8.0:\n\n```c#\nprotected override void Up(MigrationBuilder migrationBuilder)\n{\n    migrationBuilder.Sql(\"\"\"\nCREATE TYPE TVP_BigInt AS TABLE  (\n[Value] BIGINT,\nPRIMARY KEY ([Value])\n);\n\"\"\");\n    migrationBuilder.Sql(\"DECLARE @ToDeletePredecessor AS TVP_BIGINT\");\n}\n```\n\nThe difference in 9.0 is that the transaction extends across migrations, so the deadlock occurs even when the creation and the declaration are spread across different migrations.\n\nI don't think there's anything we can do here really - the workaround for now would be to suppress the transaction as @Tornhoof said above. We can also reach out to the SQL Server people and discuss this.\n\n<details>\n<summary>Minimal repro without EF</summary>\n\n```c#\nawait using var connection = new SqlConnection(\"Server=localhost;Database=test;User=SA;Password=Abcd5678;Connect Timeout=60;ConnectRetryCount=0;Encrypt=false\");\nawait connection.OpenAsync();\n\nawait using var command = connection.CreateCommand();\ncommand.CommandText = \"DROP TYPE IF EXISTS TVP_BigInt\";\nawait command.ExecuteNonQueryAsync();\n\nawait using var transaction = (SqlTransaction)await connection.BeginTransactionAsync();\ncommand.Transaction = transaction;\n\ncommand.CommandText = \"\"\"\nCREATE TYPE TVP_BigInt AS TABLE  (\n    [Value] BIGINT,\n    PRIMARY KEY ([Value])\n)\n\"\"\";\nawait command.ExecuteNonQueryAsync();\n\ncommand.CommandText = \"DECLARE @ToDeletePredecessor AS TVP_BIGINT\";\nawait command.ExecuteNonQueryAsync();\n\nawait transaction.CommitAsync();\n```\n\n</details>","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2476059550/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":15296907992,"node_id":"MEE_lADOAPaMMs6eT84nzwAAAAOPxErY","url":"https://api.github.com/repos/dotnet/efcore/issues/events/15296907992","actor":{"login":"Tornhoof","id":7989549,"node_id":"MDQ6VXNlcjc5ODk1NDk=","avatar_url":"https://avatars.githubusercontent.com/u/7989549?v=4","gravatar_id":"","url":"https://api.github.com/users/Tornhoof","html_url":"https://github.com/Tornhoof","followers_url":"https://api.github.com/users/Tornhoof/followers","following_url":"https://api.github.com/users/Tornhoof/following{/other_user}","gists_url":"https://api.github.com/users/Tornhoof/gists{/gist_id}","starred_url":"https://api.github.com/users/Tornhoof/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Tornhoof/subscriptions","organizations_url":"https://api.github.com/users/Tornhoof/orgs","repos_url":"https://api.github.com/users/Tornhoof/repos","events_url":"https://api.github.com/users/Tornhoof/events{/privacy}","received_events_url":"https://api.github.com/users/Tornhoof/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-11-14T11:08:20Z","performed_via_github_app":null},{"id":15296908004,"node_id":"SE_lADOAPaMMs6eT84nzwAAAAOPxErk","url":"https://api.github.com/repos/dotnet/efcore/issues/events/15296908004","actor":{"login":"Tornhoof","id":7989549,"node_id":"MDQ6VXNlcjc5ODk1NDk=","avatar_url":"https://avatars.githubusercontent.com/u/7989549?v=4","gravatar_id":"","url":"https://api.github.com/users/Tornhoof","html_url":"https://github.com/Tornhoof","followers_url":"https://api.github.com/users/Tornhoof/followers","following_url":"https://api.github.com/users/Tornhoof/following{/other_user}","gists_url":"https://api.github.com/users/Tornhoof/gists{/gist_id}","starred_url":"https://api.github.com/users/Tornhoof/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Tornhoof/subscriptions","organizations_url":"https://api.github.com/users/Tornhoof/orgs","repos_url":"https://api.github.com/users/Tornhoof/repos","events_url":"https://api.github.com/users/Tornhoof/events{/privacy}","received_events_url":"https://api.github.com/users/Tornhoof/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-11-14T11:08:20Z","performed_via_github_app":null},{"id":15296908614,"node_id":"LE_lADOAPaMMs6eT84nzwAAAAOPxE1G","url":"https://api.github.com/repos/dotnet/efcore/issues/events/15296908614","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2024-11-14T11:08:23Z","label":{"name":"needs-design","color":"fbca04"},"performed_via_github_app":null},{"id":15296910152,"node_id":"LE_lADOAPaMMs6eT84nzwAAAAOPxFNI","url":"https://api.github.com/repos/dotnet/efcore/issues/events/15296910152","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2024-11-14T11:08:32Z","label":{"name":"area-sqlserver","color":"32b37b"},"performed_via_github_app":null},{"id":15299498519,"node_id":"LE_lADOAPaMMs6eT84nzwAAAAOP69IX","url":"https://api.github.com/repos/dotnet/efcore/issues/events/15299498519","actor":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2024-11-14T14:38:04Z","label":{"name":"customer-reported","color":"a4a5f9"},"performed_via_github_app":null},{"id":15320858956,"node_id":"RTE_lADOAPaMMs6eT84nzwAAAAORMcFM","url":"https://api.github.com/repos/dotnet/efcore/issues/events/15320858956","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"renamed","commit_id":null,"commit_url":null,"created_at":"2024-11-16T08:03:33Z","rename":{"from":"EF Core 9 Migration Transaction change?","to":"EF9: single transaction spanning all migrations causes transaction-incompatible SQL to fail"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2480472415","html_url":"https://github.com/dotnet/efcore/issues/35096#issuecomment-2480472415","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/35096","id":2480472415,"node_id":"IC_kwDOAPaMMs6T2QFf","user":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-11-16T08:06:11Z","updated_at":"2024-11-16T08:06:11Z","body":"Thanks for bringing to our attention @Tornhoof. I unfortunately don't think there's anything actionable for us here, plus the problem existed before as well, if you happened to perform both actions in a single migration...\n\nIn addition to the workaround of suppressing the transaction, you can also simply apply the two migrations separately, by explicitly specifying on the command-line which migration state you want to migrate to (although you'd have to remember to do that every time).\n\nOther than that, I'll send a note to the SQL Server people about this so that they're aware - you can also follow up with them yourself.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2480472415/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":15320865105,"node_id":"CE_lADOAPaMMs6eT84nzwAAAAORMdlR","url":"https://api.github.com/repos/dotnet/efcore/issues/events/15320865105","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2024-11-16T08:06:12Z","state_reason":"not_planned","performed_via_github_app":null},{"id":15320865130,"node_id":"MEE_lADOAPaMMs6eT84nzwAAAAORMdlq","url":"https://api.github.com/repos/dotnet/efcore/issues/events/15320865130","actor":{"login":"Tornhoof","id":7989549,"node_id":"MDQ6VXNlcjc5ODk1NDk=","avatar_url":"https://avatars.githubusercontent.com/u/7989549?v=4","gravatar_id":"","url":"https://api.github.com/users/Tornhoof","html_url":"https://github.com/Tornhoof","followers_url":"https://api.github.com/users/Tornhoof/followers","following_url":"https://api.github.com/users/Tornhoof/following{/other_user}","gists_url":"https://api.github.com/users/Tornhoof/gists{/gist_id}","starred_url":"https://api.github.com/users/Tornhoof/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Tornhoof/subscriptions","organizations_url":"https://api.github.com/users/Tornhoof/orgs","repos_url":"https://api.github.com/users/Tornhoof/repos","events_url":"https://api.github.com/users/Tornhoof/events{/privacy}","received_events_url":"https://api.github.com/users/Tornhoof/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-11-16T08:06:12Z","performed_via_github_app":null},{"id":15320865134,"node_id":"SE_lADOAPaMMs6eT84nzwAAAAORMdlu","url":"https://api.github.com/repos/dotnet/efcore/issues/events/15320865134","actor":{"login":"Tornhoof","id":7989549,"node_id":"MDQ6VXNlcjc5ODk1NDk=","avatar_url":"https://avatars.githubusercontent.com/u/7989549?v=4","gravatar_id":"","url":"https://api.github.com/users/Tornhoof","html_url":"https://github.com/Tornhoof","followers_url":"https://api.github.com/users/Tornhoof/followers","following_url":"https://api.github.com/users/Tornhoof/following{/other_user}","gists_url":"https://api.github.com/users/Tornhoof/gists{/gist_id}","starred_url":"https://api.github.com/users/Tornhoof/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Tornhoof/subscriptions","organizations_url":"https://api.github.com/users/Tornhoof/orgs","repos_url":"https://api.github.com/users/Tornhoof/repos","events_url":"https://api.github.com/users/Tornhoof/events{/privacy}","received_events_url":"https://api.github.com/users/Tornhoof/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-11-16T08:06:12Z","performed_via_github_app":null},{"id":15320866492,"node_id":"UNLE_lADOAPaMMs6eT84nzwAAAAORMd68","url":"https://api.github.com/repos/dotnet/efcore/issues/events/15320866492","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"unlabeled","commit_id":null,"commit_url":null,"created_at":"2024-11-16T08:06:55Z","label":{"name":"needs-design","color":"fbca04"},"performed_via_github_app":null},{"id":15320866691,"node_id":"LE_lADOAPaMMs6eT84nzwAAAAORMd-D","url":"https://api.github.com/repos/dotnet/efcore/issues/events/15320866691","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2024-11-16T08:07:01Z","label":{"name":"closed-external","color":"777777"},"performed_via_github_app":null},{"actor":{"login":"DvdKhl","id":3011432,"node_id":"MDQ6VXNlcjMwMTE0MzI=","avatar_url":"https://avatars.githubusercontent.com/u/3011432?v=4","gravatar_id":"","url":"https://api.github.com/users/DvdKhl","html_url":"https://github.com/DvdKhl","followers_url":"https://api.github.com/users/DvdKhl/followers","following_url":"https://api.github.com/users/DvdKhl/following{/other_user}","gists_url":"https://api.github.com/users/DvdKhl/gists{/gist_id}","starred_url":"https://api.github.com/users/DvdKhl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DvdKhl/subscriptions","organizations_url":"https://api.github.com/users/DvdKhl/orgs","repos_url":"https://api.github.com/users/DvdKhl/repos","events_url":"https://api.github.com/users/DvdKhl/events{/privacy}","received_events_url":"https://api.github.com/users/DvdKhl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-11-16T23:49:35Z","updated_at":"2024-11-16T23:49:35Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/dotnet/efcore/issues/35127","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/35127/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/35127/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/35127/events","html_url":"https://github.com/dotnet/efcore/issues/35127","id":2665107735,"node_id":"I_kwDOAPaMMs6e2lEX","number":35127,"title":"EF Core 9 migration behaviour change causes an exception with surrounding user transaction","user":{"login":"DvdKhl","id":3011432,"node_id":"MDQ6VXNlcjMwMTE0MzI=","avatar_url":"https://avatars.githubusercontent.com/u/3011432?v=4","gravatar_id":"","url":"https://api.github.com/users/DvdKhl","html_url":"https://github.com/DvdKhl","followers_url":"https://api.github.com/users/DvdKhl/followers","following_url":"https://api.github.com/users/DvdKhl/following{/other_user}","gists_url":"https://api.github.com/users/DvdKhl/gists{/gist_id}","starred_url":"https://api.github.com/users/DvdKhl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DvdKhl/subscriptions","organizations_url":"https://api.github.com/users/DvdKhl/orgs","repos_url":"https://api.github.com/users/DvdKhl/repos","events_url":"https://api.github.com/users/DvdKhl/events{/privacy}","received_events_url":"https://api.github.com/users/DvdKhl/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":514908713,"node_id":"MDU6TGFiZWw1MTQ5MDg3MTM=","url":"https://api.github.com/repos/dotnet/efcore/labels/regression","name":"regression","color":"ff1fff","default":false,"description":null},{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1900942474,"node_id":"MDU6TGFiZWwxOTAwOTQyNDc0","url":"https://api.github.com/repos/dotnet/efcore/labels/area-migrations","name":"area-migrations","color":"32b37b","default":false,"description":""},{"id":8130499638,"node_id":"LA_kwDOAPaMMs8AAAAB5J2UNg","url":"https://api.github.com/repos/dotnet/efcore/labels/preview-1","name":"preview-1","color":"ACB3D7","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/208","html_url":"https://github.com/dotnet/efcore/milestone/208","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/208/labels","id":11959183,"node_id":"MI_kwDOAPaMMs4AtnuP","number":208,"title":"9.0.1","description":"","creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":21,"state":"closed","created_at":"2024-11-27T13:18:00Z","updated_at":"2025-02-05T21:51:51Z","due_on":null,"closed_at":"2025-02-05T21:49:40Z"},"comments":13,"created_at":"2024-11-16T23:49:34Z","updated_at":"2025-06-15T20:11:58Z","closed_at":"2024-12-04T17:28:07Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":16157746,"node_id":"MDEwOlJlcG9zaXRvcnkxNjE1Nzc0Ng==","name":"efcore","full_name":"dotnet/efcore","private":false,"owner":{"login":"dotnet","id":9141961,"node_id":"MDEyOk9yZ2FuaXphdGlvbjkxNDE5NjE=","avatar_url":"https://avatars.githubusercontent.com/u/9141961?v=4","gravatar_id":"","url":"https://api.github.com/users/dotnet","html_url":"https://github.com/dotnet","followers_url":"https://api.github.com/users/dotnet/followers","following_url":"https://api.github.com/users/dotnet/following{/other_user}","gists_url":"https://api.github.com/users/dotnet/gists{/gist_id}","starred_url":"https://api.github.com/users/dotnet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dotnet/subscriptions","organizations_url":"https://api.github.com/users/dotnet/orgs","repos_url":"https://api.github.com/users/dotnet/repos","events_url":"https://api.github.com/users/dotnet/events{/privacy}","received_events_url":"https://api.github.com/users/dotnet/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/dotnet/efcore","description":"EF Core is a modern object-database mapper for .NET. It supports LINQ queries, change tracking, updates, and schema migrations.","fork":false,"url":"https://api.github.com/repos/dotnet/efcore","forks_url":"https://api.github.com/repos/dotnet/efcore/forks","keys_url":"https://api.github.com/repos/dotnet/efcore/keys{/key_id}","collaborators_url":"https://api.github.com/repos/dotnet/efcore/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/dotnet/efcore/teams","hooks_url":"https://api.github.com/repos/dotnet/efcore/hooks","issue_events_url":"https://api.github.com/repos/dotnet/efcore/issues/events{/number}","events_url":"https://api.github.com/repos/dotnet/efcore/events","assignees_url":"https://api.github.com/repos/dotnet/efcore/assignees{/user}","branches_url":"https://api.github.com/repos/dotnet/efcore/branches{/branch}","tags_url":"https://api.github.com/repos/dotnet/efcore/tags","blobs_url":"https://api.github.com/repos/dotnet/efcore/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/dotnet/efcore/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/dotnet/efcore/git/refs{/sha}","trees_url":"https://api.github.com/repos/dotnet/efcore/git/trees{/sha}","statuses_url":"https://api.github.com/repos/dotnet/efcore/statuses/{sha}","languages_url":"https://api.github.com/repos/dotnet/efcore/languages","stargazers_url":"https://api.github.com/repos/dotnet/efcore/stargazers","contributors_url":"https://api.github.com/repos/dotnet/efcore/contributors","subscribers_url":"https://api.github.com/repos/dotnet/efcore/subscribers","subscription_url":"https://api.github.com/repos/dotnet/efcore/subscription","commits_url":"https://api.github.com/repos/dotnet/efcore/commits{/sha}","git_commits_url":"https://api.github.com/repos/dotnet/efcore/git/commits{/sha}","comments_url":"https://api.github.com/repos/dotnet/efcore/comments{/number}","issue_comment_url":"https://api.github.com/repos/dotnet/efcore/issues/comments{/number}","contents_url":"https://api.github.com/repos/dotnet/efcore/contents/{+path}","compare_url":"https://api.github.com/repos/dotnet/efcore/compare/{base}...{head}","merges_url":"https://api.github.com/repos/dotnet/efcore/merges","archive_url":"https://api.github.com/repos/dotnet/efcore/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/dotnet/efcore/downloads","issues_url":"https://api.github.com/repos/dotnet/efcore/issues{/number}","pulls_url":"https://api.github.com/repos/dotnet/efcore/pulls{/number}","milestones_url":"https://api.github.com/repos/dotnet/efcore/milestones{/number}","notifications_url":"https://api.github.com/repos/dotnet/efcore/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/dotnet/efcore/labels{/name}","releases_url":"https://api.github.com/repos/dotnet/efcore/releases{/id}","deployments_url":"https://api.github.com/repos/dotnet/efcore/deployments","created_at":"2014-01-23T00:52:01Z","updated_at":"2025-11-10T14:21:49Z","pushed_at":"2025-11-10T05:59:58Z","git_url":"git://github.com/dotnet/efcore.git","ssh_url":"git@github.com:dotnet/efcore.git","clone_url":"https://github.com/dotnet/efcore.git","svn_url":"https://github.com/dotnet/efcore","homepage":"https://learn.microsoft.com/ef/","size":215987,"stargazers_count":14455,"watchers_count":14455,"language":"C#","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":false,"forks_count":3324,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":2430,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["aspnet-product","c-sharp","database","dotnet-core","dotnet-framework","dotnet-standard","entity-framework","hacktoberfest","orm"],"visibility":"public","forks":3324,"open_issues":2430,"watchers":14455,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"We use multiple DbContexts within our application, which need to be either all fully migrated or none of them in case of an exception. To achieve this we have surrounded everything in a transaction during the migration.  \nWith EF8 this worked well, but with EF9 we're getting the exception `System.NotSupportedException: 'User transaction is not supported with a TransactionSuppressed migrations or a retrying execution strategy.`'\n\nWe found the related(?) issue https://github.com/dotnet/efcore/issues/35096 but I can't apply the solution in it since it doesn't fail at a `.Sql()` call.\nAnd we're at least not changing any retrying strategy and I'm not sure how to disable it if it is enabled.\n\n### Minimal repo:\nAdd the `Microsoft.EntityFrameworkCore.SqlServer` package and notice that this code works in EF8 but throws the exception above in EF9.  \n```csharp\nusing Microsoft.Data.SqlClient;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.EntityFrameworkCore.Infrastructure;\nusing Microsoft.EntityFrameworkCore.Migrations;\nusing System.ComponentModel.DataAnnotations;\n\nusing var conn = new SqlConnection();\nconn.ConnectionString = $\"Data Source=localhost;Initial Catalog=Main;User ID=username;Password=userpassword;Trust Server Certificate=True\";\nawait conn.OpenAsync();\n\nusing (var tran = conn.BeginTransaction()) {\n  using (var aContext = new AContext()) {\n    aContext.Database.SetDbConnection(conn);\n    using var aCtxTran = await aContext.Database.UseTransactionAsync(tran);\n\n    await aContext.Database.MigrateAsync();\n  }\n\n  using (var bContext = new BContext()) {\n    bContext.Database.SetDbConnection(conn);\n    using var bCtxTran = await bContext.Database.UseTransactionAsync(tran);\n\n    await bContext.Database.MigrateAsync();\n  }\n\n  await tran.CommitAsync();\n}\n\npublic class AContext : DbContext { public DbSet<A> AEntites { get; set; } = null!; protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder) => optionsBuilder.UseSqlServer(); }\npublic class A { [Key] public int Id { get; set; } }\npublic class BContext : DbContext { public DbSet<B> BEntites { get; set; } = null!; protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder) => optionsBuilder.UseSqlServer(); }\npublic class B { [Key] public int Id { get; set; } }\n\n#region Migrations\n#nullable disable\n\nnamespace MultiEFContextMigration.Migrations {\n  /// <inheritdoc />\n  public partial class AMigration : Migration {\n    /// <inheritdoc />\n    protected override void Up(MigrationBuilder migrationBuilder) {\n      migrationBuilder.CreateTable(\n        name: \"AEntites\",\n        columns: table => new {\n          Id = table.Column<int>(type: \"int\", nullable: false)\n            .Annotation(\"SqlServer:Identity\", \"1, 1\")\n        },\n        constraints: table => {\n          table.PrimaryKey(\"PK_AEntites\", x => x.Id);\n        });\n    }\n\n    /// <inheritdoc />\n    protected override void Down(MigrationBuilder migrationBuilder) {\n      migrationBuilder.DropTable(\n        name: \"AEntites\");\n    }\n  }\n}\n\n#nullable disable\n\nnamespace MultiEFContextMigration.Migrations {\n  [DbContext(typeof(AContext))]\n  [Migration(\"20241116225124_AMigration\")]\n  partial class AMigration {\n    /// <inheritdoc />\n    protected override void BuildTargetModel(ModelBuilder modelBuilder) {\n#pragma warning disable 612, 618\n      modelBuilder\n        .HasAnnotation(\"ProductVersion\", \"9.0.0\")\n        .HasAnnotation(\"Relational:MaxIdentifierLength\", 128);\n\n      SqlServerModelBuilderExtensions.UseIdentityColumns(modelBuilder);\n\n      modelBuilder.Entity(\"A\", b => {\n        b.Property<int>(\"Id\")\n          .ValueGeneratedOnAdd()\n          .HasColumnType(\"int\");\n\n        SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>(\"Id\"));\n\n        b.HasKey(\"Id\");\n\n        b.ToTable(\"AEntites\");\n      });\n#pragma warning restore 612, 618\n    }\n  }\n}\n\n#nullable disable\n\nnamespace MultiEFContextMigration.Migrations {\n  [DbContext(typeof(AContext))]\n  partial class AContextModelSnapshot : ModelSnapshot {\n    protected override void BuildModel(ModelBuilder modelBuilder) {\n#pragma warning disable 612, 618\n      modelBuilder\n        .HasAnnotation(\"ProductVersion\", \"9.0.0\")\n        .HasAnnotation(\"Relational:MaxIdentifierLength\", 128);\n\n      SqlServerModelBuilderExtensions.UseIdentityColumns(modelBuilder);\n\n      modelBuilder.Entity(\"A\", b => {\n        b.Property<int>(\"Id\")\n          .ValueGeneratedOnAdd()\n          .HasColumnType(\"int\");\n\n        SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>(\"Id\"));\n\n        b.HasKey(\"Id\");\n\n        b.ToTable(\"AEntites\");\n      });\n#pragma warning restore 612, 618\n    }\n  }\n}\n\n#nullable disable\n\nnamespace MultiEFContextMigration.Migrations.B {\n  /// <inheritdoc />\n  public partial class BMigration : Migration {\n    /// <inheritdoc />\n    protected override void Up(MigrationBuilder migrationBuilder) {\n      migrationBuilder.CreateTable(\n        name: \"BEntites\",\n        columns: table => new {\n          Id = table.Column<int>(type: \"int\", nullable: false)\n            .Annotation(\"SqlServer:Identity\", \"1, 1\")\n        },\n        constraints: table => {\n          table.PrimaryKey(\"PK_BEntites\", x => x.Id);\n        });\n    }\n\n    /// <inheritdoc />\n    protected override void Down(MigrationBuilder migrationBuilder) {\n      migrationBuilder.DropTable(\n        name: \"BEntites\");\n    }\n  }\n}\n\n#nullable disable\n\nnamespace MultiEFContextMigration.Migrations.B {\n  [DbContext(typeof(BContext))]\n  [Migration(\"20241116225139_BMigration\")]\n  partial class BMigration {\n    /// <inheritdoc />\n    protected override void BuildTargetModel(ModelBuilder modelBuilder) {\n#pragma warning disable 612, 618\n      modelBuilder\n        .HasAnnotation(\"ProductVersion\", \"9.0.0\")\n        .HasAnnotation(\"Relational:MaxIdentifierLength\", 128);\n\n      SqlServerModelBuilderExtensions.UseIdentityColumns(modelBuilder);\n\n      modelBuilder.Entity(\"B\", b => {\n        b.Property<int>(\"Id\")\n          .ValueGeneratedOnAdd()\n          .HasColumnType(\"int\");\n\n        SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>(\"Id\"));\n\n        b.HasKey(\"Id\");\n\n        b.ToTable(\"BEntites\");\n      });\n#pragma warning restore 612, 618\n    }\n  }\n}\n\n#nullable disable\n\nnamespace MultiEFContextMigration.Migrations.B {\n  [DbContext(typeof(BContext))]\n  partial class BContextModelSnapshot : ModelSnapshot {\n    protected override void BuildModel(ModelBuilder modelBuilder) {\n#pragma warning disable 612, 618\n      modelBuilder\n        .HasAnnotation(\"ProductVersion\", \"9.0.0\")\n        .HasAnnotation(\"Relational:MaxIdentifierLength\", 128);\n\n      SqlServerModelBuilderExtensions.UseIdentityColumns(modelBuilder);\n\n      modelBuilder.Entity(\"B\", b => {\n        b.Property<int>(\"Id\")\n          .ValueGeneratedOnAdd()\n          .HasColumnType(\"int\");\n\n        SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>(\"Id\"));\n\n        b.HasKey(\"Id\");\n\n        b.ToTable(\"BEntites\");\n      });\n#pragma warning restore 612, 618\n    }\n  }\n}\n#endregion\n```\n\n\n### Stack traces:\n```\nUnhandled exception. System.NotSupportedException: User transaction is not supported with a TransactionSuppressed migrations or a retrying execution strategy.\n   at Microsoft.EntityFrameworkCore.Migrations.Internal.MigrationCommandExecutor.ExecuteNonQueryAsync(IReadOnlyList`1 migrationCommands, IRelationalConnection connection, MigrationExecutionState executionState, Boolean commitTransaction, Nullable`1 isolationLevel, CancellationToken cancellationToken)\n   at Microsoft.EntityFrameworkCore.Migrations.HistoryRepository.Microsoft.EntityFrameworkCore.Migrations.IHistoryRepository.CreateIfNotExistsAsync(CancellationToken cancellationToken)\n   at Microsoft.EntityFrameworkCore.Migrations.Internal.Migrator.<>c.<<MigrateAsync>b__22_0>d.MoveNext()\n--- End of stack trace from previous location ---\n   at Microsoft.EntityFrameworkCore.Migrations.Internal.Migrator.<>c.<<MigrateAsync>b__22_0>d.MoveNext()\n--- End of stack trace from previous location ---\n   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)\n   at Microsoft.EntityFrameworkCore.Migrations.Internal.Migrator.MigrateAsync(String targetMigration, CancellationToken cancellationToken)\n   at Microsoft.EntityFrameworkCore.Migrations.Internal.Migrator.MigrateAsync(String targetMigration, CancellationToken cancellationToken)\n   at Program.<Main>$(String[] args) in E:\\source\\MultiEFContextMigration\\MultiEFContextMigration\\Program.cs:line 16\n   at Program.<Main>(String[] args)\n```\n\n### Include provider and version information\nEF Core version: 9.0.0\nDatabase provider: Microsoft.EntityFrameworkCore.SqlServer\nTarget framework: .NET 9.0\nOperating system: Win11 23H2 (OS Build 22631.4317)\nIDE: Visual Studio 2022 17.12.0\n","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/35127/reactions","total_count":5,"+1":5,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/35127/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"},{"actor":{"login":"cincuranet","id":4540597,"node_id":"MDQ6VXNlcjQ1NDA1OTc=","avatar_url":"https://avatars.githubusercontent.com/u/4540597?v=4","gravatar_id":"","url":"https://api.github.com/users/cincuranet","html_url":"https://github.com/cincuranet","followers_url":"https://api.github.com/users/cincuranet/followers","following_url":"https://api.github.com/users/cincuranet/following{/other_user}","gists_url":"https://api.github.com/users/cincuranet/gists{/gist_id}","starred_url":"https://api.github.com/users/cincuranet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cincuranet/subscriptions","organizations_url":"https://api.github.com/users/cincuranet/orgs","repos_url":"https://api.github.com/users/cincuranet/repos","events_url":"https://api.github.com/users/cincuranet/events{/privacy}","received_events_url":"https://api.github.com/users/cincuranet/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-11-18T12:04:16Z","updated_at":"2024-11-18T12:04:16Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/dotnet/efcore/issues/35133","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/35133/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/35133/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/35133/events","html_url":"https://github.com/dotnet/efcore/issues/35133","id":2668322892,"node_id":"I_kwDOAPaMMs6fC2BM","number":35133,"title":"efcore9: Migration with .Sql that suppresses a transaction logs an error even though it works","user":{"login":"ChristophHornung","id":18534790,"node_id":"MDQ6VXNlcjE4NTM0Nzkw","avatar_url":"https://avatars.githubusercontent.com/u/18534790?v=4","gravatar_id":"","url":"https://api.github.com/users/ChristophHornung","html_url":"https://github.com/ChristophHornung","followers_url":"https://api.github.com/users/ChristophHornung/followers","following_url":"https://api.github.com/users/ChristophHornung/following{/other_user}","gists_url":"https://api.github.com/users/ChristophHornung/gists{/gist_id}","starred_url":"https://api.github.com/users/ChristophHornung/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChristophHornung/subscriptions","organizations_url":"https://api.github.com/users/ChristophHornung/orgs","repos_url":"https://api.github.com/users/ChristophHornung/repos","events_url":"https://api.github.com/users/ChristophHornung/events{/privacy}","received_events_url":"https://api.github.com/users/ChristophHornung/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1900942474,"node_id":"MDU6TGFiZWwxOTAwOTQyNDc0","url":"https://api.github.com/repos/dotnet/efcore/labels/area-migrations","name":"area-migrations","color":"32b37b","default":false,"description":""},{"id":8130499638,"node_id":"LA_kwDOAPaMMs8AAAAB5J2UNg","url":"https://api.github.com/repos/dotnet/efcore/labels/preview-1","name":"preview-1","color":"ACB3D7","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/208","html_url":"https://github.com/dotnet/efcore/milestone/208","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/208/labels","id":11959183,"node_id":"MI_kwDOAPaMMs4AtnuP","number":208,"title":"9.0.1","description":"","creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":21,"state":"closed","created_at":"2024-11-27T13:18:00Z","updated_at":"2025-02-05T21:51:51Z","due_on":null,"closed_at":"2025-02-05T21:49:40Z"},"comments":7,"created_at":"2024-11-18T11:58:55Z","updated_at":"2025-06-15T20:12:02Z","closed_at":"2024-12-06T01:42:29Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":16157746,"node_id":"MDEwOlJlcG9zaXRvcnkxNjE1Nzc0Ng==","name":"efcore","full_name":"dotnet/efcore","private":false,"owner":{"login":"dotnet","id":9141961,"node_id":"MDEyOk9yZ2FuaXphdGlvbjkxNDE5NjE=","avatar_url":"https://avatars.githubusercontent.com/u/9141961?v=4","gravatar_id":"","url":"https://api.github.com/users/dotnet","html_url":"https://github.com/dotnet","followers_url":"https://api.github.com/users/dotnet/followers","following_url":"https://api.github.com/users/dotnet/following{/other_user}","gists_url":"https://api.github.com/users/dotnet/gists{/gist_id}","starred_url":"https://api.github.com/users/dotnet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dotnet/subscriptions","organizations_url":"https://api.github.com/users/dotnet/orgs","repos_url":"https://api.github.com/users/dotnet/repos","events_url":"https://api.github.com/users/dotnet/events{/privacy}","received_events_url":"https://api.github.com/users/dotnet/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/dotnet/efcore","description":"EF Core is a modern object-database mapper for .NET. It supports LINQ queries, change tracking, updates, and schema migrations.","fork":false,"url":"https://api.github.com/repos/dotnet/efcore","forks_url":"https://api.github.com/repos/dotnet/efcore/forks","keys_url":"https://api.github.com/repos/dotnet/efcore/keys{/key_id}","collaborators_url":"https://api.github.com/repos/dotnet/efcore/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/dotnet/efcore/teams","hooks_url":"https://api.github.com/repos/dotnet/efcore/hooks","issue_events_url":"https://api.github.com/repos/dotnet/efcore/issues/events{/number}","events_url":"https://api.github.com/repos/dotnet/efcore/events","assignees_url":"https://api.github.com/repos/dotnet/efcore/assignees{/user}","branches_url":"https://api.github.com/repos/dotnet/efcore/branches{/branch}","tags_url":"https://api.github.com/repos/dotnet/efcore/tags","blobs_url":"https://api.github.com/repos/dotnet/efcore/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/dotnet/efcore/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/dotnet/efcore/git/refs{/sha}","trees_url":"https://api.github.com/repos/dotnet/efcore/git/trees{/sha}","statuses_url":"https://api.github.com/repos/dotnet/efcore/statuses/{sha}","languages_url":"https://api.github.com/repos/dotnet/efcore/languages","stargazers_url":"https://api.github.com/repos/dotnet/efcore/stargazers","contributors_url":"https://api.github.com/repos/dotnet/efcore/contributors","subscribers_url":"https://api.github.com/repos/dotnet/efcore/subscribers","subscription_url":"https://api.github.com/repos/dotnet/efcore/subscription","commits_url":"https://api.github.com/repos/dotnet/efcore/commits{/sha}","git_commits_url":"https://api.github.com/repos/dotnet/efcore/git/commits{/sha}","comments_url":"https://api.github.com/repos/dotnet/efcore/comments{/number}","issue_comment_url":"https://api.github.com/repos/dotnet/efcore/issues/comments{/number}","contents_url":"https://api.github.com/repos/dotnet/efcore/contents/{+path}","compare_url":"https://api.github.com/repos/dotnet/efcore/compare/{base}...{head}","merges_url":"https://api.github.com/repos/dotnet/efcore/merges","archive_url":"https://api.github.com/repos/dotnet/efcore/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/dotnet/efcore/downloads","issues_url":"https://api.github.com/repos/dotnet/efcore/issues{/number}","pulls_url":"https://api.github.com/repos/dotnet/efcore/pulls{/number}","milestones_url":"https://api.github.com/repos/dotnet/efcore/milestones{/number}","notifications_url":"https://api.github.com/repos/dotnet/efcore/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/dotnet/efcore/labels{/name}","releases_url":"https://api.github.com/repos/dotnet/efcore/releases{/id}","deployments_url":"https://api.github.com/repos/dotnet/efcore/deployments","created_at":"2014-01-23T00:52:01Z","updated_at":"2025-11-10T14:21:49Z","pushed_at":"2025-11-10T05:59:58Z","git_url":"git://github.com/dotnet/efcore.git","ssh_url":"git@github.com:dotnet/efcore.git","clone_url":"https://github.com/dotnet/efcore.git","svn_url":"https://github.com/dotnet/efcore","homepage":"https://learn.microsoft.com/ef/","size":215987,"stargazers_count":14455,"watchers_count":14455,"language":"C#","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":false,"forks_count":3324,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":2430,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["aspnet-product","c-sharp","database","dotnet-core","dotnet-framework","dotnet-standard","entity-framework","hacktoberfest","orm"],"visibility":"public","forks":3324,"open_issues":2430,"watchers":14455,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"When switching to efcore9 existing migrations that include a `.Sql(..., suppressTransaction: true)` will generate an error in the log even though they work.\nThe [what is new documentation](https://learn.microsoft.com/en-us/ef/core/what-is-new/ef-core-9.0/whatsnew#migrations) states this should only issues a warning.\n\n### Include your code\n\nI uploaded a minimal reproduction [here](https://github.com/ChristophHornung/ErrorOnOutOfTransactionMigration).\n\n### Include verbose output\n\nThe log outputs the fail message but also shows that the SQL is executed correctly.\n```\ninfo: Microsoft.EntityFrameworkCore.Migrations[20402]\n      Applying migration '20241118110903_NonTransactable'.\nfail: Microsoft.EntityFrameworkCore.Migrations[20410]\n      The migration operation 'UPDATE Posts SET NewPostId = PostId+1\n      ' from migration 'NonTransactable' cannot be executed in a transaction. If the app is terminated or an unrecoverable error occurs while this operation is being executed then the migration will be left in a partially applied state and would need to be reverted manually before it can be applied again. Create a separate migration that contains just this operation.\ninfo: Microsoft.EntityFrameworkCore.Database.Command[20101]\n      Executed DbCommand (0ms) [Parameters=[], CommandType='Text', CommandTimeout='30']\n      ALTER TABLE \"Posts\" ADD \"NewPostId\" INTEGER NOT NULL DEFAULT 0;\ninfo: Microsoft.EntityFrameworkCore.Database.Command[20101]\n      Executed DbCommand (0ms) [Parameters=[], CommandType='Text', CommandTimeout='30']\n      UPDATE Posts SET NewPostId = PostId+1\ninfo: Microsoft.EntityFrameworkCore.Database.Command[20101]\n      Executed DbCommand (2ms) [Parameters=[], CommandType='Text', CommandTimeout='30']\n      INSERT INTO \"__EFMigrationsHistory\" (\"MigrationId\", \"ProductVersion\")\n      VALUES ('20241118110903_NonTransactable', '9.0.0');\n```\n\n### Include provider and version information\n\nEF Core version: no error log on 8, but error logged on 9\nDatabase provider: tested with SQL and SQLite\nTarget framework: .NET8 and .NET9","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/35133/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/35133/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2485814891","html_url":"https://github.com/dotnet/efcore/issues/35096#issuecomment-2485814891","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/35096","id":2485814891,"node_id":"IC_kwDOAPaMMs6UKoZr","user":{"login":"akamor","id":9391841,"node_id":"MDQ6VXNlcjkzOTE4NDE=","avatar_url":"https://avatars.githubusercontent.com/u/9391841?v=4","gravatar_id":"","url":"https://api.github.com/users/akamor","html_url":"https://github.com/akamor","followers_url":"https://api.github.com/users/akamor/followers","following_url":"https://api.github.com/users/akamor/following{/other_user}","gists_url":"https://api.github.com/users/akamor/gists{/gist_id}","starred_url":"https://api.github.com/users/akamor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/akamor/subscriptions","organizations_url":"https://api.github.com/users/akamor/orgs","repos_url":"https://api.github.com/users/akamor/repos","events_url":"https://api.github.com/users/akamor/events{/privacy}","received_events_url":"https://api.github.com/users/akamor/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-11-19T14:05:51Z","updated_at":"2024-11-19T14:05:51Z","body":"@roji We are seeing perhaps similar behavior and its odd.\n\nPrior to the dotnet9 upgrade the SQL generated by our migrations wrapped each migration in its own BEGIN...COMMIT block.  So each migration had its own transaction.  In dotnet9 that is gone and the entire migration history is a single transaction.\n\nOne of our migrations modifies an enum value and then a subsequent migration that references the enum errors with the PG message:\n\n```\n    MessageText: unsafe use of new value \"ParseFiles\" of enum type job_type\n    Hint: New enum values must be committed before they can be used.\n```\n\nThis didn't happen before because altering the ENUM in a previous migration was committed prior to the latter migration being run.\n\nIs this expected behavior in dotnet9?  If so, this seems like it could potentially break a lot of databases unless I am missing something (which is entirely possible).  \n\nIn terms of workarounds I could go modify the old migration and explicitly commit the ALTER TYPE command.  Any other ideas?","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/2485814891/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"akamor","id":9391841,"node_id":"MDQ6VXNlcjkzOTE4NDE=","avatar_url":"https://avatars.githubusercontent.com/u/9391841?v=4","gravatar_id":"","url":"https://api.github.com/users/akamor","html_url":"https://github.com/akamor","followers_url":"https://api.github.com/users/akamor/followers","following_url":"https://api.github.com/users/akamor/following{/other_user}","gists_url":"https://api.github.com/users/akamor/gists{/gist_id}","starred_url":"https://api.github.com/users/akamor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/akamor/subscriptions","organizations_url":"https://api.github.com/users/akamor/orgs","repos_url":"https://api.github.com/users/akamor/repos","events_url":"https://api.github.com/users/akamor/events{/privacy}","received_events_url":"https://api.github.com/users/akamor/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":15350102801,"node_id":"MEE_lADOAPaMMs6eT84nzwAAAAOS7_sR","url":"https://api.github.com/repos/dotnet/efcore/issues/events/15350102801","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-11-19T14:05:54Z","performed_via_github_app":null},{"id":15350102820,"node_id":"SE_lADOAPaMMs6eT84nzwAAAAOS7_sk","url":"https://api.github.com/repos/dotnet/efcore/issues/events/15350102820","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-11-19T14:05:54Z","performed_via_github_app":null}]