{"url":"https://api.github.com/repos/dotnet/efcore/issues/33547","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/33547/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/33547/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/33547/events","html_url":"https://github.com/dotnet/efcore/issues/33547","id":2245680504,"node_id":"I_kwDOAPaMMs6F2l14","number":33547,"title":"Breaking Change in 8.0.4: System.InvalidOperationException: The data is NULL at ordinal 0. This method can't be called on NULL values. Check using IsDBNull before calling.","user":{"login":"eisbaer66","id":3314597,"node_id":"MDQ6VXNlcjMzMTQ1OTc=","avatar_url":"https://avatars.githubusercontent.com/u/3314597?v=4","gravatar_id":"","url":"https://api.github.com/users/eisbaer66","html_url":"https://github.com/eisbaer66","followers_url":"https://api.github.com/users/eisbaer66/followers","following_url":"https://api.github.com/users/eisbaer66/following{/other_user}","gists_url":"https://api.github.com/users/eisbaer66/gists{/gist_id}","starred_url":"https://api.github.com/users/eisbaer66/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eisbaer66/subscriptions","organizations_url":"https://api.github.com/users/eisbaer66/orgs","repos_url":"https://api.github.com/users/eisbaer66/repos","events_url":"https://api.github.com/users/eisbaer66/events{/privacy}","received_events_url":"https://api.github.com/users/eisbaer66/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":514908713,"node_id":"MDU6TGFiZWw1MTQ5MDg3MTM=","url":"https://api.github.com/repos/dotnet/efcore/labels/regression","name":"regression","color":"ff1fff","default":false,"description":null},{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1017558838,"node_id":"MDU6TGFiZWwxMDE3NTU4ODM4","url":"https://api.github.com/repos/dotnet/efcore/labels/Servicing-approved","name":"Servicing-approved","color":"048708","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/198","html_url":"https://github.com/dotnet/efcore/milestone/198","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/198/labels","id":11035505,"node_id":"MI_kwDOAPaMMs4AqGNx","number":198,"title":"8.0.7","description":null,"creator":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":9,"state":"closed","created_at":"2024-05-09T17:10:21Z","updated_at":"2024-11-13T15:19:12Z","due_on":null,"closed_at":"2024-08-26T09:11:07Z"},"comments":8,"created_at":"2024-04-16T10:21:04Z","updated_at":"2025-06-15T20:01:48Z","closed_at":"2024-05-09T17:15:23Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## File a bug\r\n\r\nI have run into this problem when upgrading from 8.0.3 to 8.0.4.\r\nI have a Parent type that contains an optional Child.\r\n```\r\npublic class Parent\r\n{\r\n\tpublic int Id { get; set; }\r\n\tpublic Child? Child { get; set; }\r\n}\r\n```\r\n\r\nThe Child contains a simple type, that is saved as a ComplexProperty.\r\n```\r\npublic class Child\r\n{\r\n\tpublic int Id { get; set; }\r\n\tpublic required Complex Complex { get; set; }\r\n\tpublic bool Deleted { get; set; }\r\n}\r\n```\r\n\r\nThere is a QueryFilter defined for the Child (simple bool property \"Deleted\").\r\n```\r\npublic class ApplicationDbContext : DbContext\r\n{\r\n\tpublic DbSet<Parent> Parents { get; set; }\r\n\r\n\r\n\tpublic ApplicationDbContext(DbContextOptions<ApplicationDbContext> options)\r\n\t\t: base (options)\r\n\t{\r\n\t}\r\n\r\n\tprotected override void OnModelCreating(ModelBuilder modelBuilder)\r\n\t{\r\n\t\tbase.OnModelCreating (modelBuilder);\r\n\r\n\t\tmodelBuilder.Entity<Child> ()\r\n\t\t            .ComplexProperty (x => x.Complex);\r\n\r\n\t\tmodelBuilder.Entity<Child> ().HasQueryFilter (x => !x.Deleted);\r\n\t}\r\n}\r\n```\r\n\r\nThe Complex type contains a `enum`.\r\n```\r\npublic class Complex\r\n{\r\n\tpublic MyEnum Enum { get; set; }\r\n}\r\npublic enum MyEnum\r\n{\r\n\tNone    = 0,\r\n\tEnabled = 1,\r\n}\r\n```\r\n\r\nWhen I now try to query the enum coming from the Parent type though the Child and Complex types, I want the result to be `null`, if the (optional) Child is not set (is `null`).\r\n```\r\nvar my_enum = db_context.Parents\r\n                        .Select (p => p.Child != null ? (MyEnum?)p.Child.Complex.Enum : null)\r\n                        .FirstOrDefault ();\r\n```\r\nBut i get a InvalidOperationException instead.\r\n\r\nDowngrading back to 8.0.3 restores the expected behavior again.\r\n\r\n### Include your code\r\n\r\nI have created a small solution with one console project to reproduce the problem:\r\n[efcore-enum-in-optional-complex-property-with-queryfilter-repro.zip](https://github.com/dotnet/efcore/files/14995283/efcore-enum-in-optional-complex-property-with-queryfilter-repro.zip)\r\n\r\nIt creates a sqlite database (deleting any existing \"test.db\" file beforehand) so you should be able to just run it (again and again) to reproduce the exception.\r\n\r\n### Stack traces\r\n\r\n```\r\nUnhandled exception. System.InvalidOperationException: An error occurred while reading a database value. The expected type was 'efcore_enum_in_optional_complex_property_repro.Entites.MyEnum' but the actual value was null.\r\n ---> System.InvalidOperationException: The data is NULL at ordinal 0. This method can't be called on NULL values. Check using IsDBNull before calling.\r\n   at Microsoft.Data.Sqlite.SqliteValueReader.GetInt64(Int32 ordinal)\r\n   at Microsoft.Data.Sqlite.SqliteValueReader.GetInt32(Int32 ordinal)\r\n   at Microsoft.Data.Sqlite.SqliteDataReader.GetInt32(Int32 ordinal)\r\n   at lambda_method31(Closure, QueryContext, DbDataReader, ResultContext, SingleQueryResultCoordinator)\r\n   --- End of inner exception stack trace ---\r\n   at lambda_method31(Closure, QueryContext, DbDataReader, ResultContext, SingleQueryResultCoordinator)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.Enumerator.MoveNext()\r\n   at System.Linq.Enumerable.TryGetSingle[TSource](IEnumerable`1 source, Boolean& found)\r\n   at lambda_method32(Closure, QueryContext)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.Execute[TResult](Expression query)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.EntityQueryProvider.Execute[TResult](Expression expression)\r\n   at System.Linq.Queryable.FirstOrDefault[TSource](IQueryable`1 source)\r\n   at Program.<<Main>$>g__Act|0_2(<>c__DisplayClass0_0&) in %path-to-repos%\\efcore-enum-in-optional-complex-property-with-queryfilter-repro\\efcore-enum-in-optional-complex-property-repro\\Program.cs:line 49\r\n   at Program.<Main>$(String[] args) in %path-to-repos%\\efcore-enum-in-optional-complex-property-with-queryfilter-repro\\efcore-enum-in-optional-complex-property-repro\\Program.cs:line 12\r\n```\r\n\r\n### Include provider and version information\r\n\r\nEF Core version: 8.0.4 (still works in 8.0.3)\r\nDatabase provider: Microsoft.EntityFrameworkCore.Sqlite 8.0.4 (same error happens with Microsoft.EntityFrameworkCore.SqlServer 8.0.4)\r\nTarget framework: .NET 8.0\r\nOperating system: Windows 11\r\nIDE: Visual Studio 2022 17.9.5\r\n","closed_by":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/33547/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/33547/timeline","performed_via_github_app":null,"state_reason":"completed"}