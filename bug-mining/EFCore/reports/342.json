{"url":"https://api.github.com/repos/dotnet/efcore/issues/27597","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/27597/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/27597/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/27597/events","html_url":"https://github.com/dotnet/efcore/issues/27597","id":1163126468,"node_id":"I_kwDOAPaMMs5FU-bE","number":27597,"title":"Wrong ErrorCode reported by SqliteException","user":{"login":"Giorgi","id":580749,"node_id":"MDQ6VXNlcjU4MDc0OQ==","avatar_url":"https://avatars.githubusercontent.com/u/580749?v=4","gravatar_id":"","url":"https://api.github.com/users/Giorgi","html_url":"https://github.com/Giorgi","followers_url":"https://api.github.com/users/Giorgi/followers","following_url":"https://api.github.com/users/Giorgi/following{/other_user}","gists_url":"https://api.github.com/users/Giorgi/gists{/gist_id}","starred_url":"https://api.github.com/users/Giorgi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Giorgi/subscriptions","organizations_url":"https://api.github.com/users/Giorgi/orgs","repos_url":"https://api.github.com/users/Giorgi/repos","events_url":"https://api.github.com/users/Giorgi/events{/privacy}","received_events_url":"https://api.github.com/users/Giorgi/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1111789566,"node_id":"MDU6TGFiZWwxMTExNzg5NTY2","url":"https://api.github.com/repos/dotnet/efcore/labels/area-adonet-sqlite","name":"area-adonet-sqlite","color":"044a64","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/180","html_url":"https://github.com/dotnet/efcore/milestone/180","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/180/labels","id":9963267,"node_id":"MI_kwDOAPaMMs4AmAcD","number":180,"title":"9.0.0","description":null,"creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":339,"state":"closed","created_at":"2023-09-25T15:41:58Z","updated_at":"2025-04-01T18:19:15Z","due_on":null,"closed_at":"2024-11-14T11:54:05Z"},"comments":7,"created_at":"2022-03-08T21:11:30Z","updated_at":"2025-06-15T18:46:13Z","closed_at":"2023-12-15T17:36:59Z","author_association":"CONTRIBUTOR","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"When using `sqlite3_limit` to limit length of string or blob (`SQLITE_LIMIT_LENGTH` from https://www.sqlite.org/c3ref/c_limit_attached.html) and running an insert statement with value larger than the limit, the `SqliteException` has wrong `SqliteErrorCode` and `SqliteExtendedErrorCode`\r\n\r\n### Include your code\r\n\r\n```csharp\r\nvar connection = new SqliteConnection(\"Data Source=sqlite_test.db;\");\r\n\r\nconnection.Open();\r\n\r\nvar command = connection.CreateCommand();\r\ncommand.CommandText = @\"CREATE TABLE \"\"Products\"\" (\r\n          \"\"Id\"\" INTEGER NOT NULL CONSTRAINT \"\"PK_Products\"\" PRIMARY KEY AUTOINCREMENT,\r\n          \"\"Name\"\" TEXT NOT NULL\r\n      );\";\r\ncommand.ExecuteNonQuery();\r\n\r\nvar limit = SetLimit(connection.Handle, 0, 10);\r\n\r\ncommand.CommandText = @\"INSERT INTO \"\"Products\"\" (\"\"Name\"\")  VALUES (@p0);\";\r\ncommand.Parameters.Add(\"@p0\", SqliteType.Text);\r\ncommand.Parameters[0].Value = new string('A', 15);\r\n\r\ntry\r\n{\r\n    command.ExecuteReader();\r\n}\r\ncatch (SqliteException ex)\r\n{\r\n    Console.WriteLine($\"Sqlite error: {ex.SqliteErrorCode} {ex.SqliteExtendedErrorCode}\");\r\n}\r\nfinally\r\n{\r\n    connection.Close();\r\n}\r\n\r\n[DllImport(\"e_sqlite3\", CallingConvention = CallingConvention.Cdecl, EntryPoint = \"sqlite3_limit\")]\r\nstatic extern int SetLimit(sqlite3 db, int id, int newVal);\r\n```\r\n\r\nThis prints 19 and 1299 (`SQLITE_CONSTRAINT` and `SQLITE_CONSTRAINT_NOTNULL` respectively) instead of printing 18 and 18 (`SQLITE_TOOBIG`)\r\n\r\nIf I put the value directly in the SQL statement the correct error code is reported:\r\n\r\n`command.CommandText = @\"INSERT INTO \"\"Products\"\" (\"\"Name\"\")  VALUES ('AAAAAAAAAAAAAAA');\";`\r\n\r\nAlso, when using EF Core and SQLite together the behavior in EF Core 3.1.1 and Microsoft.Data.SQLite was that the insert statement was failing with the correct error code (`SQLITE_TOOBIG`). I have a unit test that verifies that behavior: https://github.com/Giorgi/EntityFramework.Exceptions/blob/main/EntityFramework.Exceptions.Tests/SqliteTests.cs#L24 but the test fails when I upgrade to EF Core 6. Did the interaction between EF Core and SQLite provider change so drasticly between these versions that result in the new behavior? For example, did the EF Core 3 not use parameterized insert statements or is there a change in the way parameters are passed to the SQLite driver?\r\n\r\nFinally, the SQLite shell works as expected:\r\n\r\n![image](https://user-images.githubusercontent.com/580749/157325636-b8d3f5a8-b611-40d7-9bd9-bf19320bbcc3.png)\r\n\r\n\r\n### Version information\r\n\r\nMicrosoft.Data.Sqlite version: 6.0.3\r\nTarget framework: .Net 6\r\nOperating system: Windows\r\n","closed_by":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/27597/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/27597/timeline","performed_via_github_app":null,"state_reason":"completed"}