{"url":"https://api.github.com/repos/dotnet/efcore/issues/34211","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/34211/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/34211/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/34211/events","html_url":"https://github.com/dotnet/efcore/issues/34211","id":2404926358,"node_id":"I_kwDOAPaMMs6PWEOW","number":34211,"title":"Issue occurs when trying to generate query string when mapping entity with json to a view with a custom schema","user":{"login":"vave-dev","id":28763561,"node_id":"MDQ6VXNlcjI4NzYzNTYx","avatar_url":"https://avatars.githubusercontent.com/u/28763561?v=4","gravatar_id":"","url":"https://api.github.com/users/vave-dev","html_url":"https://github.com/vave-dev","followers_url":"https://api.github.com/users/vave-dev/followers","following_url":"https://api.github.com/users/vave-dev/following{/other_user}","gists_url":"https://api.github.com/users/vave-dev/gists{/gist_id}","starred_url":"https://api.github.com/users/vave-dev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vave-dev/subscriptions","organizations_url":"https://api.github.com/users/vave-dev/orgs","repos_url":"https://api.github.com/users/vave-dev/repos","events_url":"https://api.github.com/users/vave-dev/events{/privacy}","received_events_url":"https://api.github.com/users/vave-dev/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1900941630,"node_id":"MDU6TGFiZWwxOTAwOTQxNjMw","url":"https://api.github.com/repos/dotnet/efcore/labels/area-model-building","name":"area-model-building","color":"32b37b","default":false,"description":""},{"id":2416082108,"node_id":"MDU6TGFiZWwyNDE2MDgyMTA4","url":"https://api.github.com/repos/dotnet/efcore/labels/area-relational-mapping","name":"area-relational-mapping","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/180","html_url":"https://github.com/dotnet/efcore/milestone/180","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/180/labels","id":9963267,"node_id":"MI_kwDOAPaMMs4AmAcD","number":180,"title":"9.0.0","description":null,"creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":339,"state":"closed","created_at":"2023-09-25T15:41:58Z","updated_at":"2025-04-01T18:19:15Z","due_on":null,"closed_at":"2024-11-14T11:54:05Z"},"comments":0,"created_at":"2024-07-12T07:19:44Z","updated_at":"2025-06-15T20:06:43Z","closed_at":"2024-08-08T01:50:22Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"\r\n\r\n\r\n\r\n**Description**: Issue occurs when trying to generate query string. We are trying to generate query based on `OwnsMany` relationship on JSON column. Data is consumed through view. If everything is in the default DB schema it works fine. However, if view is in different DB schema then exception occurs. \r\n\r\n**Note**: Undesirable workaround is to use `modelBuilder.HasDefaultSchema(\"Catalog\")` as this functionality seems to be working only in default DB schema.\r\n\r\n**Repro**:\r\n\r\n1. Create Database\r\n2. Create Catalog schema\r\n3. You may create table - but as query is not executed, it is not necessary\r\n4. Execute following code:\r\n\r\n```c#\r\n\r\npublic class ApplicationDbContext(string connectionString) : DbContext\r\n{\r\n    public DbSet<Item> ItemsView => Set<Item>();\r\n\r\n    protected override void OnConfiguring(DbContextOptionsBuilder options)\r\n        => options.UseSqlServer(connectionString);\r\n\r\n    protected override void OnModelCreating(ModelBuilder modelBuilder)\r\n    {\r\n        modelBuilder.Entity<Item>()\r\n            .ToView(nameof(ItemsView), \"Catalog\");\r\n        \r\n        modelBuilder.Entity<Item>()\r\n            .OwnsMany(x => x.Locations, builder =>\r\n            {\r\n                builder.ToJson();\r\n            });\r\n        \r\n        base.OnModelCreating(modelBuilder);\r\n    }\r\n}\r\n\r\npublic sealed class Item\r\n{\r\n    public Guid Id { get; private set; }\r\n    public List<Location> Locations { get; private set; } = default!;\r\n\r\n    public Item(List<Location> locations)\r\n    {\r\n        Locations = locations;\r\n    }\r\n\r\n    public Item()\r\n    {\r\n    }\r\n}\r\n\r\npublic sealed class Location\r\n{\r\n    public string City { get; private set; } = default!;\r\n    public string Address { get; private set; } = default!;\r\n\r\n    public Location(string city, string address)\r\n    {\r\n        City = city;\r\n        Address = address;\r\n    }\r\n\r\n    public Location()\r\n    {\r\n    }\r\n}\r\n\r\nvar context = new ApplicationDbContext(\"Server=(localdb)\\\\MSSQLLocalDB;Database=issue-reproduce\");\r\n\r\nvar queryItems = context.ItemsView;\r\n\r\nConsole.WriteLine($\"Items query ({queryItems.ToQueryString()})\");\r\n\r\nvar items = queryItems.ToList();\r\n\r\nConsole.WriteLine($\"Total items ({items.Count})\");\r\n\r\n\r\nConsole.ReadLine();\r\n\r\n\r\n```\r\n\r\n**Exception**:\r\n\r\n```\r\n\r\nSystem.NullReferenceException: Object reference not set to an instance of an object.\r\n   at Microsoft.EntityFrameworkCore.Query.SqlExpressions.SelectExpression.AddJsonNavigationBindings(IEntityType entityType, StructuralTypeProjectionExpression projection, Dictionary`2 propertyExpressions, TableReferenceExpression tableReferenceExpression)\r\n   at Microsoft.EntityFrameworkCore.Query.SqlExpressions.SelectExpression.<.ctor>g__GenerateNonHierarchyNonSplittingEntityType|26_0(ITableBase table, TableExpressionBase tableExpression, <>c__DisplayClass26_0&)\r\n   at Microsoft.EntityFrameworkCore.Query.SqlExpressions.SelectExpression..ctor(IEntityType entityType, ISqlExpressionFactory sqlExpressionFactory)\r\n   at Microsoft.EntityFrameworkCore.Query.SqlExpressionFactory.Select(IEntityType entityType)\r\n   at Microsoft.EntityFrameworkCore.Query.RelationalQueryableMethodTranslatingExpressionVisitor.CreateShapedQueryExpression(IEntityType entityType)\r\n   at Microsoft.EntityFrameworkCore.Query.QueryableMethodTranslatingExpressionVisitor.VisitExtension(Expression extensionExpression)\r\n   at Microsoft.EntityFrameworkCore.Query.RelationalQueryableMethodTranslatingExpressionVisitor.VisitExtension(Expression extensionExpression)\r\n   at Microsoft.EntityFrameworkCore.SqlServer.Query.Internal.SqlServerQueryableMethodTranslatingExpressionVisitor.VisitExtension(Expression extensionExpression)\r\n   at Microsoft.EntityFrameworkCore.Query.QueryableMethodTranslatingExpressionVisitor.VisitMethodCall(MethodCallExpression methodCallExpression)\r\n   at Microsoft.EntityFrameworkCore.Query.RelationalQueryableMethodTranslatingExpressionVisitor.VisitMethodCall(MethodCallExpression methodCallExpression)\r\n   at Microsoft.EntityFrameworkCore.Query.QueryableMethodTranslatingExpressionVisitor.Translate(Expression expression)\r\n   at Microsoft.EntityFrameworkCore.Query.RelationalQueryableMethodTranslatingExpressionVisitor.Translate(Expression expression)\r\n   at Microsoft.EntityFrameworkCore.Query.QueryCompilationContext.CreateQueryExecutor[TResult](Expression query)\r\n   at Microsoft.EntityFrameworkCore.Storage.Database.CompileQuery[TResult](Expression query, Boolean async)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.CompileQueryCore[TResult](IDatabase database, Expression query, IModel model, Boolean async)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.<>c__DisplayClass9_0`1.<Execute>b__0()\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.CompiledQueryCache.GetOrAddQuery[TResult](Object cacheKey, Func`1 compiler)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.Execute[TResult](Expression query)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.EntityQueryProvider.Execute[TResult](Expression expression)\r\n   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.ToQueryString(IQueryable source)\r\n   at Program.<Main>$(String[] args) in C:\\dev\\projects\\EfCoreJsonSchemaIssue\\Program.cs:line 8\r\n\r\n```\r\n\r\n**Expected**: Query string\r\n\r\n**EF Core version:**\r\nDatabase provider: `Microsoft.EntityFrameworkCore.SqlServer 8.0.7`\r\nTarget framework: `.NET 8.0`\r\n","closed_by":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/34211/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/34211/timeline","performed_via_github_app":null,"state_reason":"completed"}