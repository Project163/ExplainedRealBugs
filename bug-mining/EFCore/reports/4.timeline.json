[{"id":5836304047,"node_id":"LE_lADOAPaMMs5BIOHqzwAAAAFb3u6v","url":"https://api.github.com/repos/dotnet/efcore/issues/events/5836304047","actor":{"login":"bachratyg","id":8447770,"node_id":"MDQ6VXNlcjg0NDc3NzA=","avatar_url":"https://avatars.githubusercontent.com/u/8447770?v=4","gravatar_id":"","url":"https://api.github.com/users/bachratyg","html_url":"https://github.com/bachratyg","followers_url":"https://api.github.com/users/bachratyg/followers","following_url":"https://api.github.com/users/bachratyg/following{/other_user}","gists_url":"https://api.github.com/users/bachratyg/gists{/gist_id}","starred_url":"https://api.github.com/users/bachratyg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bachratyg/subscriptions","organizations_url":"https://api.github.com/users/bachratyg/orgs","repos_url":"https://api.github.com/users/bachratyg/repos","events_url":"https://api.github.com/users/bachratyg/events{/privacy}","received_events_url":"https://api.github.com/users/bachratyg/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2022-01-03T17:07:54Z","label":{"name":"customer-reported","color":"a4a5f9"},"performed_via_github_app":null},{"id":5836658579,"node_id":"LE_lADOAPaMMs5BIOHqzwAAAAFb5FeT","url":"https://api.github.com/repos/dotnet/efcore/issues/events/5836658579","actor":{"login":"smitpatel","id":1528107,"node_id":"MDQ6VXNlcjE1MjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1528107?v=4","gravatar_id":"","url":"https://api.github.com/users/smitpatel","html_url":"https://github.com/smitpatel","followers_url":"https://api.github.com/users/smitpatel/followers","following_url":"https://api.github.com/users/smitpatel/following{/other_user}","gists_url":"https://api.github.com/users/smitpatel/gists{/gist_id}","starred_url":"https://api.github.com/users/smitpatel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smitpatel/subscriptions","organizations_url":"https://api.github.com/users/smitpatel/orgs","repos_url":"https://api.github.com/users/smitpatel/repos","events_url":"https://api.github.com/users/smitpatel/events{/privacy}","received_events_url":"https://api.github.com/users/smitpatel/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2022-01-03T18:40:26Z","label":{"name":"area-query","color":"32b37b"},"performed_via_github_app":null},{"id":5836658584,"node_id":"LE_lADOAPaMMs5BIOHqzwAAAAFb5FeY","url":"https://api.github.com/repos/dotnet/efcore/issues/events/5836658584","actor":{"login":"smitpatel","id":1528107,"node_id":"MDQ6VXNlcjE1MjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1528107?v=4","gravatar_id":"","url":"https://api.github.com/users/smitpatel","html_url":"https://github.com/smitpatel","followers_url":"https://api.github.com/users/smitpatel/followers","following_url":"https://api.github.com/users/smitpatel/following{/other_user}","gists_url":"https://api.github.com/users/smitpatel/gists{/gist_id}","starred_url":"https://api.github.com/users/smitpatel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smitpatel/subscriptions","organizations_url":"https://api.github.com/users/smitpatel/orgs","repos_url":"https://api.github.com/users/smitpatel/repos","events_url":"https://api.github.com/users/smitpatel/events{/privacy}","received_events_url":"https://api.github.com/users/smitpatel/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2022-01-03T18:40:26Z","label":{"name":"type-bug","color":"f7c6c7"},"performed_via_github_app":null},{"id":5842732129,"node_id":"AE_lADOAPaMMs5BIOHqzwAAAAFcQQRh","url":"https://api.github.com/repos/dotnet/efcore/issues/events/5842732129","actor":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"assigned","commit_id":null,"commit_url":null,"created_at":"2022-01-04T20:35:52Z","assignee":{"login":"smitpatel","id":1528107,"node_id":"MDQ6VXNlcjE1MjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1528107?v=4","gravatar_id":"","url":"https://api.github.com/users/smitpatel","html_url":"https://github.com/smitpatel","followers_url":"https://api.github.com/users/smitpatel/followers","following_url":"https://api.github.com/users/smitpatel/following{/other_user}","gists_url":"https://api.github.com/users/smitpatel/gists{/gist_id}","starred_url":"https://api.github.com/users/smitpatel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smitpatel/subscriptions","organizations_url":"https://api.github.com/users/smitpatel/orgs","repos_url":"https://api.github.com/users/smitpatel/repos","events_url":"https://api.github.com/users/smitpatel/events{/privacy}","received_events_url":"https://api.github.com/users/smitpatel/received_events","type":"User","user_view_type":"public","site_admin":false},"performed_via_github_app":null},{"id":5842732413,"node_id":"LE_lADOAPaMMs5BIOHqzwAAAAFcQQV9","url":"https://api.github.com/repos/dotnet/efcore/issues/events/5842732413","actor":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2022-01-04T20:35:57Z","label":{"name":"Servicing-consider","color":"bfd4f2"},"performed_via_github_app":null},{"id":5842732580,"node_id":"MIE_lADOAPaMMs5BIOHqzwAAAAFcQQYk","url":"https://api.github.com/repos/dotnet/efcore/issues/events/5842732580","actor":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"milestoned","commit_id":null,"commit_url":null,"created_at":"2022-01-04T20:36:00Z","milestone":{"title":"6.0.x"},"performed_via_github_app":null},{"id":5844023692,"node_id":"LE_lADOAPaMMs5BIOHqzwAAAAFcVLmM","url":"https://api.github.com/repos/dotnet/efcore/issues/events/5844023692","actor":{"login":"smitpatel","id":1528107,"node_id":"MDQ6VXNlcjE1MjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1528107?v=4","gravatar_id":"","url":"https://api.github.com/users/smitpatel","html_url":"https://github.com/smitpatel","followers_url":"https://api.github.com/users/smitpatel/followers","following_url":"https://api.github.com/users/smitpatel/following{/other_user}","gists_url":"https://api.github.com/users/smitpatel/gists{/gist_id}","starred_url":"https://api.github.com/users/smitpatel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smitpatel/subscriptions","organizations_url":"https://api.github.com/users/smitpatel/orgs","repos_url":"https://api.github.com/users/smitpatel/repos","events_url":"https://api.github.com/users/smitpatel/events{/privacy}","received_events_url":"https://api.github.com/users/smitpatel/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2022-01-05T03:38:39Z","label":{"name":"closed-fixed","color":"777777"},"performed_via_github_app":null},{"id":5844032735,"node_id":"REFE_lADOAPaMMs5BIOHqzwAAAAFcVNzf","url":"https://api.github.com/repos/dotnet/efcore/issues/events/5844032735","actor":{"login":"smitpatel","id":1528107,"node_id":"MDQ6VXNlcjE1MjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1528107?v=4","gravatar_id":"","url":"https://api.github.com/users/smitpatel","html_url":"https://github.com/smitpatel","followers_url":"https://api.github.com/users/smitpatel/followers","following_url":"https://api.github.com/users/smitpatel/following{/other_user}","gists_url":"https://api.github.com/users/smitpatel/gists{/gist_id}","starred_url":"https://api.github.com/users/smitpatel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smitpatel/subscriptions","organizations_url":"https://api.github.com/users/smitpatel/orgs","repos_url":"https://api.github.com/users/smitpatel/repos","events_url":"https://api.github.com/users/smitpatel/events{/privacy}","received_events_url":"https://api.github.com/users/smitpatel/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"4546961887aaf9df289627200e0fb357090d4d80","commit_url":"https://api.github.com/repos/dotnet/efcore/commits/4546961887aaf9df289627200e0fb357090d4d80","created_at":"2022-01-05T03:43:03Z","performed_via_github_app":null},{"actor":{"login":"smitpatel","id":1528107,"node_id":"MDQ6VXNlcjE1MjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1528107?v=4","gravatar_id":"","url":"https://api.github.com/users/smitpatel","html_url":"https://github.com/smitpatel","followers_url":"https://api.github.com/users/smitpatel/followers","following_url":"https://api.github.com/users/smitpatel/following{/other_user}","gists_url":"https://api.github.com/users/smitpatel/gists{/gist_id}","starred_url":"https://api.github.com/users/smitpatel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smitpatel/subscriptions","organizations_url":"https://api.github.com/users/smitpatel/orgs","repos_url":"https://api.github.com/users/smitpatel/repos","events_url":"https://api.github.com/users/smitpatel/events{/privacy}","received_events_url":"https://api.github.com/users/smitpatel/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-01-05T03:49:39Z","updated_at":"2022-01-05T03:49:39Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/dotnet/efcore/issues/27108","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/27108/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/27108/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/27108/events","html_url":"https://github.com/dotnet/efcore/pull/27108","id":1093952297,"node_id":"PR_kwDOAPaMMs4wikh6","number":27108,"title":"[6.0.2] Lift GroupByAggregate when correlation predicate matches","user":{"login":"smitpatel","id":1528107,"node_id":"MDQ6VXNlcjE1MjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1528107?v=4","gravatar_id":"","url":"https://api.github.com/users/smitpatel","html_url":"https://github.com/smitpatel","followers_url":"https://api.github.com/users/smitpatel/followers","following_url":"https://api.github.com/users/smitpatel/following{/other_user}","gists_url":"https://api.github.com/users/smitpatel/gists{/gist_id}","starred_url":"https://api.github.com/users/smitpatel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smitpatel/subscriptions","organizations_url":"https://api.github.com/users/smitpatel/orgs","repos_url":"https://api.github.com/users/smitpatel/repos","events_url":"https://api.github.com/users/smitpatel/events{/privacy}","received_events_url":"https://api.github.com/users/smitpatel/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1017558838,"node_id":"MDU6TGFiZWwxMDE3NTU4ODM4","url":"https://api.github.com/repos/dotnet/efcore/labels/Servicing-approved","name":"Servicing-approved","color":"048708","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-01-05T03:49:39Z","updated_at":"2022-02-11T20:47:22Z","closed_at":"2022-01-10T19:07:18Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":16157746,"node_id":"MDEwOlJlcG9zaXRvcnkxNjE1Nzc0Ng==","name":"efcore","full_name":"dotnet/efcore","private":false,"owner":{"login":"dotnet","id":9141961,"node_id":"MDEyOk9yZ2FuaXphdGlvbjkxNDE5NjE=","avatar_url":"https://avatars.githubusercontent.com/u/9141961?v=4","gravatar_id":"","url":"https://api.github.com/users/dotnet","html_url":"https://github.com/dotnet","followers_url":"https://api.github.com/users/dotnet/followers","following_url":"https://api.github.com/users/dotnet/following{/other_user}","gists_url":"https://api.github.com/users/dotnet/gists{/gist_id}","starred_url":"https://api.github.com/users/dotnet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dotnet/subscriptions","organizations_url":"https://api.github.com/users/dotnet/orgs","repos_url":"https://api.github.com/users/dotnet/repos","events_url":"https://api.github.com/users/dotnet/events{/privacy}","received_events_url":"https://api.github.com/users/dotnet/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/dotnet/efcore","description":"EF Core is a modern object-database mapper for .NET. It supports LINQ queries, change tracking, updates, and schema migrations.","fork":false,"url":"https://api.github.com/repos/dotnet/efcore","forks_url":"https://api.github.com/repos/dotnet/efcore/forks","keys_url":"https://api.github.com/repos/dotnet/efcore/keys{/key_id}","collaborators_url":"https://api.github.com/repos/dotnet/efcore/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/dotnet/efcore/teams","hooks_url":"https://api.github.com/repos/dotnet/efcore/hooks","issue_events_url":"https://api.github.com/repos/dotnet/efcore/issues/events{/number}","events_url":"https://api.github.com/repos/dotnet/efcore/events","assignees_url":"https://api.github.com/repos/dotnet/efcore/assignees{/user}","branches_url":"https://api.github.com/repos/dotnet/efcore/branches{/branch}","tags_url":"https://api.github.com/repos/dotnet/efcore/tags","blobs_url":"https://api.github.com/repos/dotnet/efcore/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/dotnet/efcore/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/dotnet/efcore/git/refs{/sha}","trees_url":"https://api.github.com/repos/dotnet/efcore/git/trees{/sha}","statuses_url":"https://api.github.com/repos/dotnet/efcore/statuses/{sha}","languages_url":"https://api.github.com/repos/dotnet/efcore/languages","stargazers_url":"https://api.github.com/repos/dotnet/efcore/stargazers","contributors_url":"https://api.github.com/repos/dotnet/efcore/contributors","subscribers_url":"https://api.github.com/repos/dotnet/efcore/subscribers","subscription_url":"https://api.github.com/repos/dotnet/efcore/subscription","commits_url":"https://api.github.com/repos/dotnet/efcore/commits{/sha}","git_commits_url":"https://api.github.com/repos/dotnet/efcore/git/commits{/sha}","comments_url":"https://api.github.com/repos/dotnet/efcore/comments{/number}","issue_comment_url":"https://api.github.com/repos/dotnet/efcore/issues/comments{/number}","contents_url":"https://api.github.com/repos/dotnet/efcore/contents/{+path}","compare_url":"https://api.github.com/repos/dotnet/efcore/compare/{base}...{head}","merges_url":"https://api.github.com/repos/dotnet/efcore/merges","archive_url":"https://api.github.com/repos/dotnet/efcore/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/dotnet/efcore/downloads","issues_url":"https://api.github.com/repos/dotnet/efcore/issues{/number}","pulls_url":"https://api.github.com/repos/dotnet/efcore/pulls{/number}","milestones_url":"https://api.github.com/repos/dotnet/efcore/milestones{/number}","notifications_url":"https://api.github.com/repos/dotnet/efcore/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/dotnet/efcore/labels{/name}","releases_url":"https://api.github.com/repos/dotnet/efcore/releases{/id}","deployments_url":"https://api.github.com/repos/dotnet/efcore/deployments","created_at":"2014-01-23T00:52:01Z","updated_at":"2025-11-10T14:21:49Z","pushed_at":"2025-11-10T05:59:58Z","git_url":"git://github.com/dotnet/efcore.git","ssh_url":"git@github.com:dotnet/efcore.git","clone_url":"https://github.com/dotnet/efcore.git","svn_url":"https://github.com/dotnet/efcore","homepage":"https://learn.microsoft.com/ef/","size":215987,"stargazers_count":14455,"watchers_count":14455,"language":"C#","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":false,"forks_count":3324,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":2430,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["aspnet-product","c-sharp","database","dotnet-core","dotnet-framework","dotnet-standard","entity-framework","hacktoberfest","orm"],"visibility":"public","forks":3324,"open_issues":2430,"watchers":14455,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/dotnet/efcore/pulls/27108","html_url":"https://github.com/dotnet/efcore/pull/27108","diff_url":"https://github.com/dotnet/efcore/pull/27108.diff","patch_url":"https://github.com/dotnet/efcore/pull/27108.patch","merged_at":"2022-01-10T19:07:18Z"},"body":"Earlier, we didn't match on exact predicate\r\n\r\nAlso fix bug in LikeExpression.Equals\r\n\r\nResolves #27102\r\n\r\n**Description**\r\n\r\nWhen projection after group by has an aggregation term which is not aggregate on grouping, incorrect SQL is generated which generates incorrect results or invalid SQL.\r\n\r\n**Customer impact**\r\n\r\nCustomer queries will either give incorrect result or throw exception with invalid SQL.\r\n\r\n**How found**\r\n\r\nCustomer reported on 6.0.1\r\n\r\n**Regression**\r\n\r\nYes, From 5.0\r\n\r\n**Testing**\r\n\r\nAdded test for user scenario which validates non grouping related aggregation.\r\n\r\n**Risk**\r\n\r\nVery low. Added quirk to revert to previous behavior.","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/27108/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/27108/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"actor":{"login":"smitpatel","id":1528107,"node_id":"MDQ6VXNlcjE1MjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1528107?v=4","gravatar_id":"","url":"https://api.github.com/users/smitpatel","html_url":"https://github.com/smitpatel","followers_url":"https://api.github.com/users/smitpatel/followers","following_url":"https://api.github.com/users/smitpatel/following{/other_user}","gists_url":"https://api.github.com/users/smitpatel/gists{/gist_id}","starred_url":"https://api.github.com/users/smitpatel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smitpatel/subscriptions","organizations_url":"https://api.github.com/users/smitpatel/orgs","repos_url":"https://api.github.com/users/smitpatel/repos","events_url":"https://api.github.com/users/smitpatel/events{/privacy}","received_events_url":"https://api.github.com/users/smitpatel/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-01-05T05:53:01Z","updated_at":"2022-01-05T05:53:01Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/dotnet/efcore/issues/27082","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/27082/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/27082/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/27082/events","html_url":"https://github.com/dotnet/efcore/issues/27082","id":1091481098,"node_id":"I_kwDOAPaMMs5BDq4K","number":27082,"title":"Subquery is not translated","user":{"login":"fschick","id":7911094,"node_id":"MDQ6VXNlcjc5MTEwOTQ=","avatar_url":"https://avatars.githubusercontent.com/u/7911094?v=4","gravatar_id":"","url":"https://api.github.com/users/fschick","html_url":"https://github.com/fschick","followers_url":"https://api.github.com/users/fschick/followers","following_url":"https://api.github.com/users/fschick/following{/other_user}","gists_url":"https://api.github.com/users/fschick/gists{/gist_id}","starred_url":"https://api.github.com/users/fschick/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fschick/subscriptions","organizations_url":"https://api.github.com/users/fschick/orgs","repos_url":"https://api.github.com/users/fschick/repos","events_url":"https://api.github.com/users/fschick/events{/privacy}","received_events_url":"https://api.github.com/users/fschick/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2021-12-31T08:50:06Z","updated_at":"2025-06-16T09:11:09Z","closed_at":"2022-10-16T20:20:55Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":16157746,"node_id":"MDEwOlJlcG9zaXRvcnkxNjE1Nzc0Ng==","name":"efcore","full_name":"dotnet/efcore","private":false,"owner":{"login":"dotnet","id":9141961,"node_id":"MDEyOk9yZ2FuaXphdGlvbjkxNDE5NjE=","avatar_url":"https://avatars.githubusercontent.com/u/9141961?v=4","gravatar_id":"","url":"https://api.github.com/users/dotnet","html_url":"https://github.com/dotnet","followers_url":"https://api.github.com/users/dotnet/followers","following_url":"https://api.github.com/users/dotnet/following{/other_user}","gists_url":"https://api.github.com/users/dotnet/gists{/gist_id}","starred_url":"https://api.github.com/users/dotnet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dotnet/subscriptions","organizations_url":"https://api.github.com/users/dotnet/orgs","repos_url":"https://api.github.com/users/dotnet/repos","events_url":"https://api.github.com/users/dotnet/events{/privacy}","received_events_url":"https://api.github.com/users/dotnet/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/dotnet/efcore","description":"EF Core is a modern object-database mapper for .NET. It supports LINQ queries, change tracking, updates, and schema migrations.","fork":false,"url":"https://api.github.com/repos/dotnet/efcore","forks_url":"https://api.github.com/repos/dotnet/efcore/forks","keys_url":"https://api.github.com/repos/dotnet/efcore/keys{/key_id}","collaborators_url":"https://api.github.com/repos/dotnet/efcore/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/dotnet/efcore/teams","hooks_url":"https://api.github.com/repos/dotnet/efcore/hooks","issue_events_url":"https://api.github.com/repos/dotnet/efcore/issues/events{/number}","events_url":"https://api.github.com/repos/dotnet/efcore/events","assignees_url":"https://api.github.com/repos/dotnet/efcore/assignees{/user}","branches_url":"https://api.github.com/repos/dotnet/efcore/branches{/branch}","tags_url":"https://api.github.com/repos/dotnet/efcore/tags","blobs_url":"https://api.github.com/repos/dotnet/efcore/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/dotnet/efcore/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/dotnet/efcore/git/refs{/sha}","trees_url":"https://api.github.com/repos/dotnet/efcore/git/trees{/sha}","statuses_url":"https://api.github.com/repos/dotnet/efcore/statuses/{sha}","languages_url":"https://api.github.com/repos/dotnet/efcore/languages","stargazers_url":"https://api.github.com/repos/dotnet/efcore/stargazers","contributors_url":"https://api.github.com/repos/dotnet/efcore/contributors","subscribers_url":"https://api.github.com/repos/dotnet/efcore/subscribers","subscription_url":"https://api.github.com/repos/dotnet/efcore/subscription","commits_url":"https://api.github.com/repos/dotnet/efcore/commits{/sha}","git_commits_url":"https://api.github.com/repos/dotnet/efcore/git/commits{/sha}","comments_url":"https://api.github.com/repos/dotnet/efcore/comments{/number}","issue_comment_url":"https://api.github.com/repos/dotnet/efcore/issues/comments{/number}","contents_url":"https://api.github.com/repos/dotnet/efcore/contents/{+path}","compare_url":"https://api.github.com/repos/dotnet/efcore/compare/{base}...{head}","merges_url":"https://api.github.com/repos/dotnet/efcore/merges","archive_url":"https://api.github.com/repos/dotnet/efcore/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/dotnet/efcore/downloads","issues_url":"https://api.github.com/repos/dotnet/efcore/issues{/number}","pulls_url":"https://api.github.com/repos/dotnet/efcore/pulls{/number}","milestones_url":"https://api.github.com/repos/dotnet/efcore/milestones{/number}","notifications_url":"https://api.github.com/repos/dotnet/efcore/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/dotnet/efcore/labels{/name}","releases_url":"https://api.github.com/repos/dotnet/efcore/releases{/id}","deployments_url":"https://api.github.com/repos/dotnet/efcore/deployments","created_at":"2014-01-23T00:52:01Z","updated_at":"2025-11-10T14:21:49Z","pushed_at":"2025-11-10T05:59:58Z","git_url":"git://github.com/dotnet/efcore.git","ssh_url":"git@github.com:dotnet/efcore.git","clone_url":"https://github.com/dotnet/efcore.git","svn_url":"https://github.com/dotnet/efcore","homepage":"https://learn.microsoft.com/ef/","size":215987,"stargazers_count":14455,"watchers_count":14455,"language":"C#","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":false,"forks_count":3324,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":2430,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["aspnet-product","c-sharp","database","dotnet-core","dotnet-framework","dotnet-standard","entity-framework","hacktoberfest","orm"],"visibility":"public","forks":3324,"open_issues":2430,"watchers":14455,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"## Subquery is not translated\r\nWhen explicit subquery should be used, it's translated to wrong MIN aggregate\r\n\r\nThe following query:\r\n```csharp\r\nExpression<Func<Order, bool>> someFilterFromOutside = x => x.Number != \"A1\";\r\n\r\nvar orders = await dbContext\r\n    .Set<Order>()\r\n    .Where(someFilterFromOutside)\r\n    .GroupBy(x => new { x.CustomerId, x.Number })\r\n    .Select(x => new\r\n    {\r\n        x.Key.CustomerId,\r\n        // ==> SUBQUERY VIA 'dbContext'\r\n        CustomerMinHourlyRate = dbContext.Set<Order>().Where(n => n.CustomerId == x.Key.CustomerId).Min(h => h.HourlyRate),\r\n        HourlyRate = x.Min(f => f.HourlyRate),\r\n        Count = x.Count()\r\n    })\r\n    .ToListAsync();\r\n```\r\nIs translated to:\r\n```sql\r\nSELECT \"o\".\"CustomerId\",\r\n\tMIN(\"o\".\"HourlyRate\") AS \"CustomerMinHourlyRate\", -- <== THIS IS WRONG\r\n\tCOUNT(*) AS \"Count\"\r\nFROM \"Order\" AS \"o\"\r\nWHERE (\"o\".\"Number\" <> 'A1') OR \"o\".\"Number\" IS NULL\r\nGROUP BY \"o\".\"CustomerId\",\r\n\t\"o\".\"Number\"\r\n```\r\nThe generated `MIN` selects the minimum of filtered and fully grouped (`CustomerId` and `Number`) orders instead of (sub) querying `Order`filtered by `CustomerId` only.\r\n\r\nSee [WhenSubSelectIsUsed_MinHourlyRatePerCustomerIsSelectedProperly](https://github.com/fschick/EF.GeneratedSelectBug/blob/260a8a0c31bdd265343d72a587eef346b6649077/EF.GeneratedSelectBug.Tests/SqlTranslationTests.cs#L61) to reproduce\r\n\r\n### Code to reproduce\r\n```bash\r\ngit clone https://github.com/fschick/EF.GeneratedSelectBug.git\r\ncd EF.GeneratedSelectBug\r\ndotnet test\r\n```\r\n### Provider and version information\r\nEF Core version: 6.0.1\r\nDatabase provider: at least Microsoft.EntityFrameworkCore.SqlServer and Microsoft.EntityFrameworkCore.Sqlite\r\nTarget framework: .NET 6.0\r\nOperating system: All\r\nIDE: All","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/27082/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/27082/timeline","performed_via_github_app":null,"state_reason":"duplicate"}},"event":"cross-referenced"},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/1005415084","html_url":"https://github.com/dotnet/efcore/issues/27102#issuecomment-1005415084","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/27102","id":1005415084,"node_id":"IC_kwDOAPaMMs477Wqs","user":{"login":"smitpatel","id":1528107,"node_id":"MDQ6VXNlcjE1MjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1528107?v=4","gravatar_id":"","url":"https://api.github.com/users/smitpatel","html_url":"https://github.com/smitpatel","followers_url":"https://api.github.com/users/smitpatel/followers","following_url":"https://api.github.com/users/smitpatel/following{/other_user}","gists_url":"https://api.github.com/users/smitpatel/gists{/gist_id}","starred_url":"https://api.github.com/users/smitpatel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smitpatel/subscriptions","organizations_url":"https://api.github.com/users/smitpatel/orgs","repos_url":"https://api.github.com/users/smitpatel/repos","events_url":"https://api.github.com/users/smitpatel/events{/privacy}","received_events_url":"https://api.github.com/users/smitpatel/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-01-05T06:23:13Z","updated_at":"2022-01-05T06:23:13Z","body":"Generated SQL after fix\r\n```SQL\r\nSELECT [t].[Value] AS [A], (\r\n    SELECT MAX([t0].[Id])\r\n    FROM [Table] AS [t0]\r\n    WHERE ([t0].[Value] = ((\r\n        SELECT MAX([t1].[Id])\r\n        FROM [Table] AS [t1]\r\n        WHERE ([t].[Value] = [t1].[Value]) OR ([t].[Value] IS NULL AND [t1].[Value] IS NULL)) * 6)) OR ([t0].[Value] IS NULL AND (\r\n        SELECT MAX([t1].[Id])\r\n        FROM [Table] AS [t1]\r\n        WHERE ([t].[Value] = [t1].[Value]) OR ([t].[Value] IS NULL AND [t1].[Value] IS NULL)) IS NULL)) AS [B]\r\nFROM [Table] AS [t]\r\nGROUP BY [t].[Value]\r\n```","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/1005415084/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"smitpatel","id":1528107,"node_id":"MDQ6VXNlcjE1MjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1528107?v=4","gravatar_id":"","url":"https://api.github.com/users/smitpatel","html_url":"https://github.com/smitpatel","followers_url":"https://api.github.com/users/smitpatel/followers","following_url":"https://api.github.com/users/smitpatel/following{/other_user}","gists_url":"https://api.github.com/users/smitpatel/gists{/gist_id}","starred_url":"https://api.github.com/users/smitpatel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smitpatel/subscriptions","organizations_url":"https://api.github.com/users/smitpatel/orgs","repos_url":"https://api.github.com/users/smitpatel/repos","events_url":"https://api.github.com/users/smitpatel/events{/privacy}","received_events_url":"https://api.github.com/users/smitpatel/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/1005537705","html_url":"https://github.com/dotnet/efcore/issues/27102#issuecomment-1005537705","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/27102","id":1005537705,"node_id":"IC_kwDOAPaMMs4770mp","user":{"login":"bachratyg","id":8447770,"node_id":"MDQ6VXNlcjg0NDc3NzA=","avatar_url":"https://avatars.githubusercontent.com/u/8447770?v=4","gravatar_id":"","url":"https://api.github.com/users/bachratyg","html_url":"https://github.com/bachratyg","followers_url":"https://api.github.com/users/bachratyg/followers","following_url":"https://api.github.com/users/bachratyg/following{/other_user}","gists_url":"https://api.github.com/users/bachratyg/gists{/gist_id}","starred_url":"https://api.github.com/users/bachratyg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bachratyg/subscriptions","organizations_url":"https://api.github.com/users/bachratyg/orgs","repos_url":"https://api.github.com/users/bachratyg/repos","events_url":"https://api.github.com/users/bachratyg/events{/privacy}","received_events_url":"https://api.github.com/users/bachratyg/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-01-05T09:55:19Z","updated_at":"2022-01-05T18:45:16Z","body":"Is the query complexity due to `UseRelationalNulls(false)`?\r\n\r\nThis may have some perf issues since the base query is repeated in the subquery.\r\n\r\nEdit/clarification:\r\nby perf issue I didn't mean the extra code to compensate for c# null semantics but that the subquery is hitting the table more times than necessary. With db null semantics I'd expect this would be the translation:\r\n```sql\r\nSELECT [t].[Value] AS [A], (\r\n    SELECT MAX([t0].[Id])\r\n    FROM [Table] AS [t0]\r\n    WHERE ([t0].[Value] = (\r\n        SELECT MAX([t1].[Id])\r\n        FROM [Table] AS [t1]\r\n        WHERE [t].[Value] = [t1].[Value]) * 6)) AS [B]\r\nFROM [Table] AS [t]\r\nGROUP BY [t].[Value]\r\n```","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/1005537705/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"bachratyg","id":8447770,"node_id":"MDQ6VXNlcjg0NDc3NzA=","avatar_url":"https://avatars.githubusercontent.com/u/8447770?v=4","gravatar_id":"","url":"https://api.github.com/users/bachratyg","html_url":"https://github.com/bachratyg","followers_url":"https://api.github.com/users/bachratyg/followers","following_url":"https://api.github.com/users/bachratyg/following{/other_user}","gists_url":"https://api.github.com/users/bachratyg/gists{/gist_id}","starred_url":"https://api.github.com/users/bachratyg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bachratyg/subscriptions","organizations_url":"https://api.github.com/users/bachratyg/orgs","repos_url":"https://api.github.com/users/bachratyg/repos","events_url":"https://api.github.com/users/bachratyg/events{/privacy}","received_events_url":"https://api.github.com/users/bachratyg/received_events","type":"User","user_view_type":"public","site_admin":false}},{"actor":{"login":"bachratyg","id":8447770,"node_id":"MDQ6VXNlcjg0NDc3NzA=","avatar_url":"https://avatars.githubusercontent.com/u/8447770?v=4","gravatar_id":"","url":"https://api.github.com/users/bachratyg","html_url":"https://github.com/bachratyg","followers_url":"https://api.github.com/users/bachratyg/followers","following_url":"https://api.github.com/users/bachratyg/following{/other_user}","gists_url":"https://api.github.com/users/bachratyg/gists{/gist_id}","starred_url":"https://api.github.com/users/bachratyg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bachratyg/subscriptions","organizations_url":"https://api.github.com/users/bachratyg/orgs","repos_url":"https://api.github.com/users/bachratyg/repos","events_url":"https://api.github.com/users/bachratyg/events{/privacy}","received_events_url":"https://api.github.com/users/bachratyg/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-01-05T18:08:29Z","updated_at":"2022-01-05T18:08:29Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/dotnet/efcore/issues/27094","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/27094/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/27094/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/27094/events","html_url":"https://github.com/dotnet/efcore/issues/27094","id":1092469536,"node_id":"I_kwDOAPaMMs5BHcMg","number":27094,"title":"StackOverflowException in nested GroupBy query","user":{"login":"bachratyg","id":8447770,"node_id":"MDQ6VXNlcjg0NDc3NzA=","avatar_url":"https://avatars.githubusercontent.com/u/8447770?v=4","gravatar_id":"","url":"https://api.github.com/users/bachratyg","html_url":"https://github.com/bachratyg","followers_url":"https://api.github.com/users/bachratyg/followers","following_url":"https://api.github.com/users/bachratyg/following{/other_user}","gists_url":"https://api.github.com/users/bachratyg/gists{/gist_id}","starred_url":"https://api.github.com/users/bachratyg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bachratyg/subscriptions","organizations_url":"https://api.github.com/users/bachratyg/orgs","repos_url":"https://api.github.com/users/bachratyg/repos","events_url":"https://api.github.com/users/bachratyg/events{/privacy}","received_events_url":"https://api.github.com/users/bachratyg/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1017558838,"node_id":"MDU6TGFiZWwxMDE3NTU4ODM4","url":"https://api.github.com/repos/dotnet/efcore/labels/Servicing-approved","name":"Servicing-approved","color":"048708","default":false,"description":""},{"id":1675384372,"node_id":"MDU6TGFiZWwxNjc1Mzg0Mzcy","url":"https://api.github.com/repos/dotnet/efcore/labels/area-query","name":"area-query","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"smitpatel","id":1528107,"node_id":"MDQ6VXNlcjE1MjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1528107?v=4","gravatar_id":"","url":"https://api.github.com/users/smitpatel","html_url":"https://github.com/smitpatel","followers_url":"https://api.github.com/users/smitpatel/followers","following_url":"https://api.github.com/users/smitpatel/following{/other_user}","gists_url":"https://api.github.com/users/smitpatel/gists{/gist_id}","starred_url":"https://api.github.com/users/smitpatel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smitpatel/subscriptions","organizations_url":"https://api.github.com/users/smitpatel/orgs","repos_url":"https://api.github.com/users/smitpatel/repos","events_url":"https://api.github.com/users/smitpatel/events{/privacy}","received_events_url":"https://api.github.com/users/smitpatel/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"smitpatel","id":1528107,"node_id":"MDQ6VXNlcjE1MjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1528107?v=4","gravatar_id":"","url":"https://api.github.com/users/smitpatel","html_url":"https://github.com/smitpatel","followers_url":"https://api.github.com/users/smitpatel/followers","following_url":"https://api.github.com/users/smitpatel/following{/other_user}","gists_url":"https://api.github.com/users/smitpatel/gists{/gist_id}","starred_url":"https://api.github.com/users/smitpatel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smitpatel/subscriptions","organizations_url":"https://api.github.com/users/smitpatel/orgs","repos_url":"https://api.github.com/users/smitpatel/repos","events_url":"https://api.github.com/users/smitpatel/events{/privacy}","received_events_url":"https://api.github.com/users/smitpatel/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/131","html_url":"https://github.com/dotnet/efcore/milestone/131","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/131/labels","id":7423545,"node_id":"MI_kwDOAPaMMs4AcUY5","number":131,"title":"6.0.2","description":null,"creator":{"login":"leecow","id":2212879,"node_id":"MDQ6VXNlcjIyMTI4Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/2212879?v=4","gravatar_id":"","url":"https://api.github.com/users/leecow","html_url":"https://github.com/leecow","followers_url":"https://api.github.com/users/leecow/followers","following_url":"https://api.github.com/users/leecow/following{/other_user}","gists_url":"https://api.github.com/users/leecow/gists{/gist_id}","starred_url":"https://api.github.com/users/leecow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/leecow/subscriptions","organizations_url":"https://api.github.com/users/leecow/orgs","repos_url":"https://api.github.com/users/leecow/repos","events_url":"https://api.github.com/users/leecow/events{/privacy}","received_events_url":"https://api.github.com/users/leecow/received_events","type":"User","user_view_type":"public","site_admin":true},"open_issues":0,"closed_issues":15,"state":"closed","created_at":"2021-11-23T18:23:38Z","updated_at":"2022-01-26T04:32:42Z","due_on":null,"closed_at":"2022-01-26T04:32:42Z"},"comments":6,"created_at":"2022-01-03T12:26:23Z","updated_at":"2025-06-15T18:44:35Z","closed_at":"2022-01-10T23:10:01Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":16157746,"node_id":"MDEwOlJlcG9zaXRvcnkxNjE1Nzc0Ng==","name":"efcore","full_name":"dotnet/efcore","private":false,"owner":{"login":"dotnet","id":9141961,"node_id":"MDEyOk9yZ2FuaXphdGlvbjkxNDE5NjE=","avatar_url":"https://avatars.githubusercontent.com/u/9141961?v=4","gravatar_id":"","url":"https://api.github.com/users/dotnet","html_url":"https://github.com/dotnet","followers_url":"https://api.github.com/users/dotnet/followers","following_url":"https://api.github.com/users/dotnet/following{/other_user}","gists_url":"https://api.github.com/users/dotnet/gists{/gist_id}","starred_url":"https://api.github.com/users/dotnet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dotnet/subscriptions","organizations_url":"https://api.github.com/users/dotnet/orgs","repos_url":"https://api.github.com/users/dotnet/repos","events_url":"https://api.github.com/users/dotnet/events{/privacy}","received_events_url":"https://api.github.com/users/dotnet/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/dotnet/efcore","description":"EF Core is a modern object-database mapper for .NET. It supports LINQ queries, change tracking, updates, and schema migrations.","fork":false,"url":"https://api.github.com/repos/dotnet/efcore","forks_url":"https://api.github.com/repos/dotnet/efcore/forks","keys_url":"https://api.github.com/repos/dotnet/efcore/keys{/key_id}","collaborators_url":"https://api.github.com/repos/dotnet/efcore/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/dotnet/efcore/teams","hooks_url":"https://api.github.com/repos/dotnet/efcore/hooks","issue_events_url":"https://api.github.com/repos/dotnet/efcore/issues/events{/number}","events_url":"https://api.github.com/repos/dotnet/efcore/events","assignees_url":"https://api.github.com/repos/dotnet/efcore/assignees{/user}","branches_url":"https://api.github.com/repos/dotnet/efcore/branches{/branch}","tags_url":"https://api.github.com/repos/dotnet/efcore/tags","blobs_url":"https://api.github.com/repos/dotnet/efcore/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/dotnet/efcore/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/dotnet/efcore/git/refs{/sha}","trees_url":"https://api.github.com/repos/dotnet/efcore/git/trees{/sha}","statuses_url":"https://api.github.com/repos/dotnet/efcore/statuses/{sha}","languages_url":"https://api.github.com/repos/dotnet/efcore/languages","stargazers_url":"https://api.github.com/repos/dotnet/efcore/stargazers","contributors_url":"https://api.github.com/repos/dotnet/efcore/contributors","subscribers_url":"https://api.github.com/repos/dotnet/efcore/subscribers","subscription_url":"https://api.github.com/repos/dotnet/efcore/subscription","commits_url":"https://api.github.com/repos/dotnet/efcore/commits{/sha}","git_commits_url":"https://api.github.com/repos/dotnet/efcore/git/commits{/sha}","comments_url":"https://api.github.com/repos/dotnet/efcore/comments{/number}","issue_comment_url":"https://api.github.com/repos/dotnet/efcore/issues/comments{/number}","contents_url":"https://api.github.com/repos/dotnet/efcore/contents/{+path}","compare_url":"https://api.github.com/repos/dotnet/efcore/compare/{base}...{head}","merges_url":"https://api.github.com/repos/dotnet/efcore/merges","archive_url":"https://api.github.com/repos/dotnet/efcore/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/dotnet/efcore/downloads","issues_url":"https://api.github.com/repos/dotnet/efcore/issues{/number}","pulls_url":"https://api.github.com/repos/dotnet/efcore/pulls{/number}","milestones_url":"https://api.github.com/repos/dotnet/efcore/milestones{/number}","notifications_url":"https://api.github.com/repos/dotnet/efcore/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/dotnet/efcore/labels{/name}","releases_url":"https://api.github.com/repos/dotnet/efcore/releases{/id}","deployments_url":"https://api.github.com/repos/dotnet/efcore/deployments","created_at":"2014-01-23T00:52:01Z","updated_at":"2025-11-10T14:21:49Z","pushed_at":"2025-11-10T05:59:58Z","git_url":"git://github.com/dotnet/efcore.git","ssh_url":"git@github.com:dotnet/efcore.git","clone_url":"https://github.com/dotnet/efcore.git","svn_url":"https://github.com/dotnet/efcore","homepage":"https://learn.microsoft.com/ef/","size":215987,"stargazers_count":14455,"watchers_count":14455,"language":"C#","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":false,"forks_count":3324,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":2430,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["aspnet-product","c-sharp","database","dotnet-core","dotnet-framework","dotnet-standard","entity-framework","hacktoberfest","orm"],"visibility":"public","forks":3324,"open_issues":2430,"watchers":14455,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"A StackOverflow occurs when a nested group by references an expression from an outer group by. This is a regression, it used to work in EF Core 5.\r\n\r\n### Repro\r\n```csproj\r\n<Project Sdk=\"Microsoft.NET.Sdk\">\r\n  <PropertyGroup>\r\n    <OutputType>Exe</OutputType>\r\n    <TargetFramework>net6.0</TargetFramework>\r\n  </PropertyGroup>\r\n  <ItemGroup>\r\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.SqlServer\" Version=\"6.0.1\" />\r\n  </ItemGroup>\r\n</Project>\r\n```\r\n```c#\r\nclass Program\r\n{\r\n\tpublic class Table\r\n\t{\r\n\t\tpublic int Id { get; set; }\r\n\t\tpublic int? Value { get; set; }\r\n\t}\r\n\tpublic class TestDb : DbContext\r\n\t{\r\n\t\tpublic DbSet<Table> Table { get; set; }\r\n\t\tprotected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)\r\n\t\t{\r\n\t\t\toptionsBuilder.UseSqlServer(\"data source=dummy\");\r\n\t\t}\r\n\t}\r\n\tstatic void Main()\r\n\t{\r\n\t\tusing var db = new TestDb();\r\n\t\tvar q = from t in db.Table\r\n\t\t\tgroup t.Id by t.Value into tg\r\n\t\t\tselect new\r\n\t\t\t{\r\n\t\t\t\tA = tg.Key,\r\n\t\t\t\tB = tg.Sum(),\r\n\t\t\t\tC = (from t in db.Table\r\n\t\t\t\t\t group t.Id by t.Value into tg2\r\n\t\t\t\t\t select tg.Sum() + tg2.Sum()\r\n\t\t\t\t\t ).FirstOrDefault()\r\n\t\t\t};\r\n\t\tvar sql = q.ToQueryString();\r\n\t}\r\n}\r\n```\r\n\r\nExpected translation (approx):\r\n```sql\r\nSELECT\r\n    t1.Value AS A,\r\n    SUM(t1.Id) AS B,\r\n    (\r\n        SELECT SUM(t1.Id) + SUM(t2.Id)\r\n        FROM Table t2\r\n        GROUP BY t2.Value\r\n    ) AS C\r\nFROM Table t1\r\nGROUP BY t1.Value\r\n```\r\n\r\nActual result:\r\n```\r\nStack overflow.\r\nRepeat 16011 times:\r\n--------------------------------\r\n   at Microsoft.EntityFrameworkCore.Query.SqlExpressions.SelectExpression+GroupByAggregateLiftingExpressionVisitor.Visit(System.Linq.Expressions.Expression)\r\n--------------------------------\r\n   at Microsoft.EntityFrameworkCore.Query.SqlExpressions.ScalarSubqueryExpression.VisitChildren(System.Linq.Expressions.ExpressionVisitor)\r\n   at System.Linq.Expressions.ExpressionVisitor.VisitExtension(System.Linq.Expressions.Expression)\r\n   at System.Linq.Expressions.Expression.Accept(System.Linq.Expressions.ExpressionVisitor)\r\n   at Microsoft.EntityFrameworkCore.Query.SqlExpressions.SqlFunctionExpression.VisitChildren(System.Linq.Expressions.ExpressionVisitor)\r\n   at System.Linq.Expressions.ExpressionVisitor.VisitExtension(System.Linq.Expressions.Expression)\r\n   at System.Linq.Expressions.Expression.Accept(System.Linq.Expressions.ExpressionVisitor)\r\n   at Microsoft.EntityFrameworkCore.Query.SqlExpressions.SelectExpression.TryLiftGroupByAggregate(Microsoft.EntityFrameworkCore.Query.SqlExpressions.SqlExpression)\r\n   at Microsoft.EntityFrameworkCore.Query.SqlExpressions.SelectExpression.AddToProjection(Microsoft.EntityFrameworkCore.Query.SqlExpressions.SqlExpression, System.String, Boolean)\r\n   at Microsoft.EntityFrameworkCore.Query.SqlExpressions.SelectExpression.ApplyProjection(System.Linq.Expressions.Expression, Microsoft.EntityFrameworkCore.Query.ResultCardinality, Microsoft.EntityFrameworkCore.QuerySplittingBehavior)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.SelectExpressionProjectionApplyingExpressionVisitor.VisitExtension(System.Linq.Expressions.Expression)\r\n   at System.Linq.Expressions.Expression.Accept(System.Linq.Expressions.ExpressionVisitor)\r\n   at System.Linq.Expressions.ExpressionVisitor.Visit(System.Linq.Expressions.Expression)\r\n   at Microsoft.EntityFrameworkCore.Query.RelationalQueryTranslationPostprocessor.Process(System.Linq.Expressions.Expression)\r\n   at Microsoft.EntityFrameworkCore.Query.QueryCompilationContext.CreateQueryExecutor[[System.__Canon, System.Private.CoreLib, Version=6.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]](System.Linq.Expressions.Expression)\r\n   at Microsoft.EntityFrameworkCore.Storage.Database.CompileQuery[[System.__Canon, System.Private.CoreLib, Version=6.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]](System.Linq.Expressions.Expression, Boolean)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.CompileQueryCore[[System.__Canon, System.Private.CoreLib, Version=6.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]](Microsoft.EntityFrameworkCore.Storage.IDatabase, System.Linq.Expressions.Expression, Microsoft.EntityFrameworkCore.Metadata.IModel, Boolean)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler+<>c__DisplayClass9_0`1[[System.__Canon, System.Private.CoreLib, Version=6.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]].<Execute>b__0()\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.CompiledQueryCache.GetOrAddQuery[[System.__Canon, System.Private.CoreLib, Version=6.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]](System.Object, System.Func`1<System.Func`2<Microsoft.EntityFrameworkCore.Query.QueryContext,System.__Canon>>)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.Execute[[System.__Canon, System.Private.CoreLib, Version=6.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]](System.Linq.Expressions.Expression)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.EntityQueryProvider.Execute[[System.__Canon, System.Private.CoreLib, Version=6.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]](System.Linq.Expressions.Expression)\r\n   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.ToQueryString(System.Linq.IQueryable)\r\n   at Program.Main()\r\n```\r\n\r\n### provider and version information\r\n\r\nEF Core version: 6.0.1\r\nDatabase provider: Microsoft.EntityFrameworkCore.SqlServer 6.0.1\r\nTarget framework: .NET 6.0\r\nOperating system: Windows 10 21H1\r\nIDE: Visual Studio 2022 17.0.4\r\n","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/27094/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/27094/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"},{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/1005958373","html_url":"https://github.com/dotnet/efcore/issues/27102#issuecomment-1005958373","issue_url":"https://api.github.com/repos/dotnet/efcore/issues/27102","id":1005958373,"node_id":"IC_kwDOAPaMMs479bTl","user":{"login":"smitpatel","id":1528107,"node_id":"MDQ6VXNlcjE1MjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1528107?v=4","gravatar_id":"","url":"https://api.github.com/users/smitpatel","html_url":"https://github.com/smitpatel","followers_url":"https://api.github.com/users/smitpatel/followers","following_url":"https://api.github.com/users/smitpatel/following{/other_user}","gists_url":"https://api.github.com/users/smitpatel/gists{/gist_id}","starred_url":"https://api.github.com/users/smitpatel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smitpatel/subscriptions","organizations_url":"https://api.github.com/users/smitpatel/orgs","repos_url":"https://api.github.com/users/smitpatel/repos","events_url":"https://api.github.com/users/smitpatel/events{/privacy}","received_events_url":"https://api.github.com/users/smitpatel/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-01-05T18:10:49Z","updated_at":"2022-01-05T18:10:49Z","body":"`Value` and the result of max both can be null hence we need additional comparison to match results to C#.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/comments/1005958373/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"smitpatel","id":1528107,"node_id":"MDQ6VXNlcjE1MjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1528107?v=4","gravatar_id":"","url":"https://api.github.com/users/smitpatel","html_url":"https://github.com/smitpatel","followers_url":"https://api.github.com/users/smitpatel/followers","following_url":"https://api.github.com/users/smitpatel/following{/other_user}","gists_url":"https://api.github.com/users/smitpatel/gists{/gist_id}","starred_url":"https://api.github.com/users/smitpatel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smitpatel/subscriptions","organizations_url":"https://api.github.com/users/smitpatel/orgs","repos_url":"https://api.github.com/users/smitpatel/repos","events_url":"https://api.github.com/users/smitpatel/events{/privacy}","received_events_url":"https://api.github.com/users/smitpatel/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":5864518955,"node_id":"LE_lADOAPaMMs5BIOHqzwAAAAFdjXUr","url":"https://api.github.com/repos/dotnet/efcore/issues/events/5864518955","actor":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2022-01-10T09:27:57Z","label":{"name":"Servicing-approved","color":"048708"},"performed_via_github_app":null},{"id":5864519914,"node_id":"UNLE_lADOAPaMMs5BIOHqzwAAAAFdjXjq","url":"https://api.github.com/repos/dotnet/efcore/issues/events/5864519914","actor":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"unlabeled","commit_id":null,"commit_url":null,"created_at":"2022-01-10T09:28:07Z","label":{"name":"Servicing-consider","color":"bfd4f2"},"performed_via_github_app":null},{"id":5864520414,"node_id":"DEME_lADOAPaMMs5BIOHqzwAAAAFdjXre","url":"https://api.github.com/repos/dotnet/efcore/issues/events/5864520414","actor":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"demilestoned","commit_id":null,"commit_url":null,"created_at":"2022-01-10T09:28:12Z","milestone":{"title":"6.0.x"},"performed_via_github_app":null},{"id":5864520417,"node_id":"MIE_lADOAPaMMs5BIOHqzwAAAAFdjXrh","url":"https://api.github.com/repos/dotnet/efcore/issues/events/5864520417","actor":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"milestoned","commit_id":null,"commit_url":null,"created_at":"2022-01-10T09:28:12Z","milestone":{"title":"6.0.2"},"performed_via_github_app":null},{"id":5867896684,"node_id":"REFE_lADOAPaMMs5BIOHqzwAAAAFdwP9s","url":"https://api.github.com/repos/dotnet/efcore/issues/events/5867896684","actor":{"login":"smitpatel","id":1528107,"node_id":"MDQ6VXNlcjE1MjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1528107?v=4","gravatar_id":"","url":"https://api.github.com/users/smitpatel","html_url":"https://github.com/smitpatel","followers_url":"https://api.github.com/users/smitpatel/followers","following_url":"https://api.github.com/users/smitpatel/following{/other_user}","gists_url":"https://api.github.com/users/smitpatel/gists{/gist_id}","starred_url":"https://api.github.com/users/smitpatel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smitpatel/subscriptions","organizations_url":"https://api.github.com/users/smitpatel/orgs","repos_url":"https://api.github.com/users/smitpatel/repos","events_url":"https://api.github.com/users/smitpatel/events{/privacy}","received_events_url":"https://api.github.com/users/smitpatel/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"490b5eaf1b5b0c3cce399e1651fe97bed02ed549","commit_url":"https://api.github.com/repos/dotnet/efcore/commits/490b5eaf1b5b0c3cce399e1651fe97bed02ed549","created_at":"2022-01-10T18:10:21Z","performed_via_github_app":null},{"id":5868189808,"node_id":"REFE_lADOAPaMMs5BIOHqzwAAAAFdxXhw","url":"https://api.github.com/repos/dotnet/efcore/issues/events/5868189808","actor":{"login":"smitpatel","id":1528107,"node_id":"MDQ6VXNlcjE1MjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1528107?v=4","gravatar_id":"","url":"https://api.github.com/users/smitpatel","html_url":"https://github.com/smitpatel","followers_url":"https://api.github.com/users/smitpatel/followers","following_url":"https://api.github.com/users/smitpatel/following{/other_user}","gists_url":"https://api.github.com/users/smitpatel/gists{/gist_id}","starred_url":"https://api.github.com/users/smitpatel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smitpatel/subscriptions","organizations_url":"https://api.github.com/users/smitpatel/orgs","repos_url":"https://api.github.com/users/smitpatel/repos","events_url":"https://api.github.com/users/smitpatel/events{/privacy}","received_events_url":"https://api.github.com/users/smitpatel/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"4907571899eda7a51d1586f6c2c37d59f83757e6","commit_url":"https://api.github.com/repos/dotnet/efcore/commits/4907571899eda7a51d1586f6c2c37d59f83757e6","created_at":"2022-01-10T19:07:21Z","performed_via_github_app":null},{"id":5869386903,"node_id":"CE_lADOAPaMMs5BIOHqzwAAAAFd17yX","url":"https://api.github.com/repos/dotnet/efcore/issues/events/5869386903","actor":{"login":"smitpatel","id":1528107,"node_id":"MDQ6VXNlcjE1MjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1528107?v=4","gravatar_id":"","url":"https://api.github.com/users/smitpatel","html_url":"https://github.com/smitpatel","followers_url":"https://api.github.com/users/smitpatel/followers","following_url":"https://api.github.com/users/smitpatel/following{/other_user}","gists_url":"https://api.github.com/users/smitpatel/gists{/gist_id}","starred_url":"https://api.github.com/users/smitpatel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smitpatel/subscriptions","organizations_url":"https://api.github.com/users/smitpatel/orgs","repos_url":"https://api.github.com/users/smitpatel/repos","events_url":"https://api.github.com/users/smitpatel/events{/privacy}","received_events_url":"https://api.github.com/users/smitpatel/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":"4907571899eda7a51d1586f6c2c37d59f83757e6","commit_url":"https://api.github.com/repos/dotnet/efcore/commits/4907571899eda7a51d1586f6c2c37d59f83757e6","created_at":"2022-01-10T23:10:00Z","state_reason":null,"performed_via_github_app":null},{"actor":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-02-11T20:44:32Z","updated_at":"2022-02-11T20:44:32Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/dotnet/efcore/issues/27427","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/27427/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/27427/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/27427/events","html_url":"https://github.com/dotnet/efcore/issues/27427","id":1130526254,"node_id":"I_kwDOAPaMMs5DYnYu","number":27427,"title":"Regression in 6.0.2: The variable name '@p0' has already been declared.","user":{"login":"PawelGerr","id":7135790,"node_id":"MDQ6VXNlcjcxMzU3OTA=","avatar_url":"https://avatars.githubusercontent.com/u/7135790?v=4","gravatar_id":"","url":"https://api.github.com/users/PawelGerr","html_url":"https://github.com/PawelGerr","followers_url":"https://api.github.com/users/PawelGerr/followers","following_url":"https://api.github.com/users/PawelGerr/following{/other_user}","gists_url":"https://api.github.com/users/PawelGerr/gists{/gist_id}","starred_url":"https://api.github.com/users/PawelGerr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/PawelGerr/subscriptions","organizations_url":"https://api.github.com/users/PawelGerr/orgs","repos_url":"https://api.github.com/users/PawelGerr/repos","events_url":"https://api.github.com/users/PawelGerr/events{/privacy}","received_events_url":"https://api.github.com/users/PawelGerr/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":514908713,"node_id":"MDU6TGFiZWw1MTQ5MDg3MTM=","url":"https://api.github.com/repos/dotnet/efcore/labels/regression","name":"regression","color":"ff1fff","default":false,"description":null},{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1017558838,"node_id":"MDU6TGFiZWwxMDE3NTU4ODM4","url":"https://api.github.com/repos/dotnet/efcore/labels/Servicing-approved","name":"Servicing-approved","color":"048708","default":false,"description":""},{"id":1675384372,"node_id":"MDU6TGFiZWwxNjc1Mzg0Mzcy","url":"https://api.github.com/repos/dotnet/efcore/labels/area-query","name":"area-query","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"smitpatel","id":1528107,"node_id":"MDQ6VXNlcjE1MjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1528107?v=4","gravatar_id":"","url":"https://api.github.com/users/smitpatel","html_url":"https://github.com/smitpatel","followers_url":"https://api.github.com/users/smitpatel/followers","following_url":"https://api.github.com/users/smitpatel/following{/other_user}","gists_url":"https://api.github.com/users/smitpatel/gists{/gist_id}","starred_url":"https://api.github.com/users/smitpatel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smitpatel/subscriptions","organizations_url":"https://api.github.com/users/smitpatel/orgs","repos_url":"https://api.github.com/users/smitpatel/repos","events_url":"https://api.github.com/users/smitpatel/events{/privacy}","received_events_url":"https://api.github.com/users/smitpatel/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"smitpatel","id":1528107,"node_id":"MDQ6VXNlcjE1MjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1528107?v=4","gravatar_id":"","url":"https://api.github.com/users/smitpatel","html_url":"https://github.com/smitpatel","followers_url":"https://api.github.com/users/smitpatel/followers","following_url":"https://api.github.com/users/smitpatel/following{/other_user}","gists_url":"https://api.github.com/users/smitpatel/gists{/gist_id}","starred_url":"https://api.github.com/users/smitpatel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smitpatel/subscriptions","organizations_url":"https://api.github.com/users/smitpatel/orgs","repos_url":"https://api.github.com/users/smitpatel/repos","events_url":"https://api.github.com/users/smitpatel/events{/privacy}","received_events_url":"https://api.github.com/users/smitpatel/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/147","html_url":"https://github.com/dotnet/efcore/milestone/147","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/147/labels","id":8163188,"node_id":"MI_kwDOAPaMMs4AfI90","number":147,"title":"6.0.8","description":null,"creator":{"login":"rbhanda","id":30737530,"node_id":"MDQ6VXNlcjMwNzM3NTMw","avatar_url":"https://avatars.githubusercontent.com/u/30737530?v=4","gravatar_id":"","url":"https://api.github.com/users/rbhanda","html_url":"https://github.com/rbhanda","followers_url":"https://api.github.com/users/rbhanda/followers","following_url":"https://api.github.com/users/rbhanda/following{/other_user}","gists_url":"https://api.github.com/users/rbhanda/gists{/gist_id}","starred_url":"https://api.github.com/users/rbhanda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rbhanda/subscriptions","organizations_url":"https://api.github.com/users/rbhanda/orgs","repos_url":"https://api.github.com/users/rbhanda/repos","events_url":"https://api.github.com/users/rbhanda/events{/privacy}","received_events_url":"https://api.github.com/users/rbhanda/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":1,"state":"closed","created_at":"2022-07-05T17:12:01Z","updated_at":"2022-09-02T19:01:23Z","due_on":null,"closed_at":"2022-09-02T19:01:23Z"},"comments":7,"created_at":"2022-02-10T17:32:47Z","updated_at":"2025-06-15T18:45:35Z","closed_at":"2022-07-06T15:17:38Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":16157746,"node_id":"MDEwOlJlcG9zaXRvcnkxNjE1Nzc0Ng==","name":"efcore","full_name":"dotnet/efcore","private":false,"owner":{"login":"dotnet","id":9141961,"node_id":"MDEyOk9yZ2FuaXphdGlvbjkxNDE5NjE=","avatar_url":"https://avatars.githubusercontent.com/u/9141961?v=4","gravatar_id":"","url":"https://api.github.com/users/dotnet","html_url":"https://github.com/dotnet","followers_url":"https://api.github.com/users/dotnet/followers","following_url":"https://api.github.com/users/dotnet/following{/other_user}","gists_url":"https://api.github.com/users/dotnet/gists{/gist_id}","starred_url":"https://api.github.com/users/dotnet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dotnet/subscriptions","organizations_url":"https://api.github.com/users/dotnet/orgs","repos_url":"https://api.github.com/users/dotnet/repos","events_url":"https://api.github.com/users/dotnet/events{/privacy}","received_events_url":"https://api.github.com/users/dotnet/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/dotnet/efcore","description":"EF Core is a modern object-database mapper for .NET. It supports LINQ queries, change tracking, updates, and schema migrations.","fork":false,"url":"https://api.github.com/repos/dotnet/efcore","forks_url":"https://api.github.com/repos/dotnet/efcore/forks","keys_url":"https://api.github.com/repos/dotnet/efcore/keys{/key_id}","collaborators_url":"https://api.github.com/repos/dotnet/efcore/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/dotnet/efcore/teams","hooks_url":"https://api.github.com/repos/dotnet/efcore/hooks","issue_events_url":"https://api.github.com/repos/dotnet/efcore/issues/events{/number}","events_url":"https://api.github.com/repos/dotnet/efcore/events","assignees_url":"https://api.github.com/repos/dotnet/efcore/assignees{/user}","branches_url":"https://api.github.com/repos/dotnet/efcore/branches{/branch}","tags_url":"https://api.github.com/repos/dotnet/efcore/tags","blobs_url":"https://api.github.com/repos/dotnet/efcore/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/dotnet/efcore/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/dotnet/efcore/git/refs{/sha}","trees_url":"https://api.github.com/repos/dotnet/efcore/git/trees{/sha}","statuses_url":"https://api.github.com/repos/dotnet/efcore/statuses/{sha}","languages_url":"https://api.github.com/repos/dotnet/efcore/languages","stargazers_url":"https://api.github.com/repos/dotnet/efcore/stargazers","contributors_url":"https://api.github.com/repos/dotnet/efcore/contributors","subscribers_url":"https://api.github.com/repos/dotnet/efcore/subscribers","subscription_url":"https://api.github.com/repos/dotnet/efcore/subscription","commits_url":"https://api.github.com/repos/dotnet/efcore/commits{/sha}","git_commits_url":"https://api.github.com/repos/dotnet/efcore/git/commits{/sha}","comments_url":"https://api.github.com/repos/dotnet/efcore/comments{/number}","issue_comment_url":"https://api.github.com/repos/dotnet/efcore/issues/comments{/number}","contents_url":"https://api.github.com/repos/dotnet/efcore/contents/{+path}","compare_url":"https://api.github.com/repos/dotnet/efcore/compare/{base}...{head}","merges_url":"https://api.github.com/repos/dotnet/efcore/merges","archive_url":"https://api.github.com/repos/dotnet/efcore/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/dotnet/efcore/downloads","issues_url":"https://api.github.com/repos/dotnet/efcore/issues{/number}","pulls_url":"https://api.github.com/repos/dotnet/efcore/pulls{/number}","milestones_url":"https://api.github.com/repos/dotnet/efcore/milestones{/number}","notifications_url":"https://api.github.com/repos/dotnet/efcore/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/dotnet/efcore/labels{/name}","releases_url":"https://api.github.com/repos/dotnet/efcore/releases{/id}","deployments_url":"https://api.github.com/repos/dotnet/efcore/deployments","created_at":"2014-01-23T00:52:01Z","updated_at":"2025-11-10T14:21:49Z","pushed_at":"2025-11-10T05:59:58Z","git_url":"git://github.com/dotnet/efcore.git","ssh_url":"git@github.com:dotnet/efcore.git","clone_url":"https://github.com/dotnet/efcore.git","svn_url":"https://github.com/dotnet/efcore","homepage":"https://learn.microsoft.com/ef/","size":215987,"stargazers_count":14455,"watchers_count":14455,"language":"C#","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":false,"forks_count":3324,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":2430,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["aspnet-product","c-sharp","database","dotnet-core","dotnet-framework","dotnet-standard","entity-framework","hacktoberfest","orm"],"visibility":"public","forks":3324,"open_issues":2430,"watchers":14455,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"Similar as in https://github.com/dotnet/efcore/issues/26754 and https://github.com/dotnet/efcore/issues/26632 but during reading data.\r\n\r\nThe issue seem to affect `Microsoft.EntityFrameworkCore.SqlServer v6.0.2` only. No issues with `Microsoft.EntityFrameworkCore.SqlServer v6.0.1`  and `Microsoft.EntityFrameworkCore.Sqlite v6.0.2`.\r\n\r\n## Repro\r\n\r\n**csproj file**\r\n```XML\r\n<Project Sdk=\"Microsoft.NET.Sdk\">\r\n\r\n   <PropertyGroup>\r\n      <OutputType>Exe</OutputType>\r\n      <TargetFramework>net6.0</TargetFramework>\r\n      <ImplicitUsings>enable</ImplicitUsings>\r\n      <Nullable>enable</Nullable>\r\n   </PropertyGroup>\r\n\r\n   <ItemGroup>\r\n      <PackageReference Include=\"Microsoft.EntityFrameworkCore.SqlServer\" Version=\"6.0.2\" />\r\n      <PackageReference Include=\"Microsoft.Extensions.Logging.Console\" Version=\"6.0.0\" />\r\n   </ItemGroup>\r\n\r\n</Project>\r\n```\r\n\r\n**DbContext and Entity**\r\n\r\n```C#\r\nusing Microsoft.EntityFrameworkCore;\r\n\r\nnamespace EfCoreVariableIssue;\r\n\r\npublic class DemoDbContext : DbContext\r\n{\r\n   public DbSet<DemoEntity> DemoEntities { get; set; }\r\n\r\n   public DemoDbContext(DbContextOptions<DemoDbContext> options)\r\n      : base(options)\r\n   {\r\n   }\r\n}\r\n\r\npublic class DemoEntity\r\n{\r\n   public Guid Id { get; set; }\r\n}\r\n```\r\n\r\n**Program.cs**\r\n```C#\r\nusing EfCoreVariableIssue;\r\nusing Microsoft.Data.SqlClient;\r\nusing Microsoft.EntityFrameworkCore;\r\nusing Microsoft.Extensions.Logging;\r\n\r\nvar loggerFactory = LoggerFactory.Create(builder => builder\r\n                                                    .SetMinimumLevel(LogLevel.Trace)\r\n                                                    .AddConsole());\r\n\r\nvar options = new DbContextOptionsBuilder<DemoDbContext>()\r\n              .UseSqlServer(\"server=localhost;database=VariableIssue;integrated security=true;\")\r\n              .UseLoggerFactory(loggerFactory)\r\n              .Options;\r\n\r\nusing var dbContext = new DemoDbContext(options);\r\ndbContext.Database.OpenConnection();\r\ndbContext.Database.EnsureCreated();\r\n```\r\n\r\nThe issue comes only when using `FromSqlRaw` + `SqlParameter` + `GroupBy` + `Select`, which has an aggregate like `g.Count()`.\r\n\r\nNo issues when using \r\n* `.FromSqlInterpolated($\"SELECT * FROM DemoEntities WHERE Id = {Guid.Empty}\")` or\r\n* `.FromSqlRaw(\"SELECT * FROM DemoEntities WHERE Id = {0}\", Guid.Empty)`\r\n\r\n```C#\r\nvar query = dbContext.DemoEntities\r\n                     .FromSqlRaw(\"SELECT * FROM DemoEntities WHERE Id = {0}\", new SqlParameter { Value = Guid.Empty })\r\n                     .Select(e => e.Id);\r\n\r\ndbContext.DemoEntities\r\n         .Where(e => query.Contains(e.Id))\r\n         .GroupBy(e => e.Id)\r\n         .Select(g => new { g.Key, Aggregate = g.Count() })\r\n         .ToList();\r\n\r\n```\r\n\r\n**Logs**\r\n\r\n```\r\nfail: Microsoft.EntityFrameworkCore.Database.Command[20102]\r\n      Failed executing DbCommand (24ms) [Parameters=[p0='?' (DbType = Guid), p0='?' (DbType = Guid)], CommandType='Text', CommandTimeout='30']\r\n      SELECT [d].[Id] AS [Key], (\r\n          SELECT COUNT(*)\r\n          FROM [DemoEntities] AS [d0]\r\n          WHERE EXISTS (\r\n              SELECT 1\r\n              FROM (\r\n                  SELECT * FROM DemoEntities WHERE Id = @p0\r\n              ) AS [e0]\r\n              WHERE [e0].[Id] = [d0].[Id]) AND ([d].[Id] = [d0].[Id])) AS [Aggregate]\r\n      FROM [DemoEntities] AS [d]\r\n      WHERE EXISTS (\r\n          SELECT 1\r\n          FROM (\r\n              SELECT * FROM DemoEntities WHERE Id = @p0\r\n          ) AS [e]\r\n          WHERE [e].[Id] = [d].[Id])\r\n      GROUP BY [d].[Id]\r\nfail: Microsoft.EntityFrameworkCore.Query[10100]\r\n      An exception occurred while iterating over the results of a query for context type 'EfCoreVariableIssue.DemoDbContext'.\r\n      Microsoft.Data.SqlClient.SqlException (0x80131904): The variable name '@p0' has already been declared. Variable names must be unique within a query batch or stored procedure.\r\n         at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)\r\n         at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)\r\n         at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLUnhandled exception. ock, Boolean asyncClose)\r\n         at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)\r\n         at Microsoft.Data.SqlClient.SqlDataReader.TryConsumeMetaData()\r\n         at Microsoft.Data.SqlClient.SqlDataReader.get_MetaData()\r\n         at Microsoft.Data.SqlClient.SqlCommand.FinishExecuteReader(SqlDataReader ds, RunBehavior runBehavior, String resetOptionsString, Boolean isInternal, Boolean forDescribeParameterEncryption, Boolean shouldCacheForAlwaysEncrypted)\r\n         at Microsoft.Data.SqlClient.SqlCommand.RunExecuteReaderTds(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, Boolean isAsync, Int32 timeout, Task& task, Boolean asyncWrite, Boolean inRetry, SqlDataReader ds, Boolean describeParameterEncryptionRequest)\r\n         at Microsoft.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, TaskCompletionSource`1 completion, Int32 timeout, Task& task, Boolean& usedCache, Boolean asyncWrite, Boolean inRetry, String method)\r\n         at Microsoft.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method)\r\n         at Microsoft.Data.SqlClient.SqlCommand.ExecuteReader(CommandBehavior behavior)\r\n         at Microsoft.Data.SqlClient.SqlCommand.ExecuteDbDataReader(CommandBehavior behavior)\r\n         at System.Data.Common.DbCommand.ExecuteReader()\r\n         at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReader(RelationalCommandParameterObject parameterObject)\r\n         at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.Enumerator.InitializeReader(Enumerator enumerator)\r\n         at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.Enumerator.<>c.<MoveNext>b__19_0(DbContext _, Enumerator enumerator)\r\n         at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.Execute[TState,TResult](TState state, Func`3 operation, Func`3 verifySucceeded)\r\n         at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.Enumerator.MoveNext()\r\n      ClientConnectionId:d7b84c89-aa05-45e7-9eb2-dfaa349e20ec\r\n      Error Number:134,State:1,Class:15\r\n      Microsoft.Data.SqlClient.SqlException (0x80131904): The variable name '@p0' has already been declared. Variable names must be unique within a query batch or stored procedure.\r\n         at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)\r\n         at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)\r\n         at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)\r\n         at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)\r\n         at Microsoft.Data.SqlClient.SqlDataReader.TryConsumeMetaData()\r\n         at Microsoft.Data.SqlClient.SqlDataReader.get_MetaData()\r\n         at Microsoft.Data.SqlClient.SqlCommand.FinishExecuteReader(SqlDataReader ds, RunBehavior runBehavior, String resetOptionsString, Boolean isInternal, Boolean forDescribeParameterEncryption, Boolean shouldCacheForAlwaysEncrypted)\r\n         at Microsoft.Data.SqlClient.SqlCommand.RunExecuteReaderTds(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, Boolean isAsync, Int32 timeout, Task& task, Boolean asyncWrite, Boolean inRetry, SqlDataReader ds, Boolean describeParameterEncryptionRequest)\r\n         at Microsoft.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, TaskCompletionSource`1 completion, Int32 timeout, Task& task, Boolean& usedCache, Boolean asyncWrite, Boolean inRetry, String method)\r\n         at Microsoft.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method)\r\n         at Microsoft.Data.SqlClient.SqlCommand.ExecuteReader(CommandBehavior behavior)\r\n         at Microsoft.Data.SqlClient.SqlCommand.ExecuteDbDataReader(CommandBehavior behavior)\r\n         at System.Data.Common.DbCommand.ExecuteReader()\r\n         at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReader(RelationalCommandParameterObject parameterObject)\r\n         at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.Enumerator.InitializeReader(Enumerator enumerator)\r\n         at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.Enumerator.<>c.<MoveNext>b__19_0(DbContext _, Enumerator enumerator)\r\n         at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.Execute[TState,TResult](TState state, Func`3 operation, Func`3 verifySucceeded)\r\n         at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.Enumerator.MoveNext()\r\n      ClientConnectionId:d7b84c89-aa05-45e7-9eb2-dfaa349e20ec\r\n      Error Number:134,State:1,Class:15\r\nMicrosoft.Data.SqlClient.SqlException (0x80131904): The variable name '@p0' has already been declared. Variable names must be unique within a query batch or stored procedure.\r\n   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)\r\n   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)\r\n   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)\r\n   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)\r\n   at Microsoft.Data.SqlClient.SqlDataReader.TryConsumeMetaData()\r\n   at Microsoft.Data.SqlClient.SqlDataReader.get_MetaData()\r\n   at Microsoft.Data.SqlClient.SqlCommand.FinishExecuteReader(SqlDataReader ds, RunBehavior runBehavior, String resetOptionsString, Boolean isInternal, Boolean forDescribeParameterEncryption, Boolean shouldCacheForAlwaysEncrypted)\r\n   at Microsoft.Data.SqlClient.SqlCommand.RunExecuteReaderTds(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, Boolean isAsync, Int32 timeout, Task& task, Boolean asyncWrite, Boolean inRetry, SqlDataReader ds, Boolean describeParameterEncryptionRequest)\r\n   at Microsoft.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, TaskCompletionSource`1 completion, Int32 timeout, Task& task, Boolean& usedCache, Boolean asyncWrite, Boolean inRetry, String method)\r\n   at Microsoft.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method)\r\n   at Microsoft.Data.SqlClient.SqlCommand.ExecuteReader(CommandBehavior behavior)\r\n   at Microsoft.Data.SqlClient.SqlCommand.ExecuteDbDataReader(CommandBehavior behavior)\r\n   at System.Data.Common.DbCommand.ExecuteReader()\r\n   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReader(RelationalCommandParameterObject parameterObject)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.Enumerator.InitializeReader(Enumerator enumerator)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.Enumerator.<>c.<MoveNext>b__19_0(DbContext _, Enumerator enumerator)\r\n   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.Execute[TState,TResult](TState state, Func`3 operation, Func`3 verifySucceeded)\r\n   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.Enumerator.MoveNext()\r\n   at System.Collections.Generic.List`1..ctor(IEnumerable`1 collection)\r\n   at System.Linq.Enumerable.ToList[TSource](IEnumerable`1 source)\r\n   at Program.<Main>$(String[] args) in E:\\Projects\\Test\\Solution1\\EfCoreVariableIssue\\Program.cs:line 23\r\n```\r\n\r\n## provider and version information\r\n\r\nEF Core version: 6.0.2\r\nDatabase provider: Microsoft.EntityFrameworkCore.SqlServer\r\nTarget framework: .NET 6.0\r\nOperating system: win10 x64\r\nIDE: JetBrains Rider 2021.3.3\r\n","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/27427/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/27427/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"},{"actor":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-02-16T02:41:43Z","updated_at":"2022-02-16T02:41:43Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/dotnet/efcore/issues/27433","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/27433/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/27433/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/27433/events","html_url":"https://github.com/dotnet/efcore/issues/27433","id":1135567253,"node_id":"I_kwDOAPaMMs5Dr2GV","number":27433,"title":"Bug report: When Substring is used in GroupBy, the query is not created correctly 6.0.2","user":{"login":"KAJOOSH","id":47478490,"node_id":"MDQ6VXNlcjQ3NDc4NDkw","avatar_url":"https://avatars.githubusercontent.com/u/47478490?v=4","gravatar_id":"","url":"https://api.github.com/users/KAJOOSH","html_url":"https://github.com/KAJOOSH","followers_url":"https://api.github.com/users/KAJOOSH/followers","following_url":"https://api.github.com/users/KAJOOSH/following{/other_user}","gists_url":"https://api.github.com/users/KAJOOSH/gists{/gist_id}","starred_url":"https://api.github.com/users/KAJOOSH/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/KAJOOSH/subscriptions","organizations_url":"https://api.github.com/users/KAJOOSH/orgs","repos_url":"https://api.github.com/users/KAJOOSH/repos","events_url":"https://api.github.com/users/KAJOOSH/events{/privacy}","received_events_url":"https://api.github.com/users/KAJOOSH/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":514908713,"node_id":"MDU6TGFiZWw1MTQ5MDg3MTM=","url":"https://api.github.com/repos/dotnet/efcore/labels/regression","name":"regression","color":"ff1fff","default":false,"description":null},{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1675384372,"node_id":"MDU6TGFiZWwxNjc1Mzg0Mzcy","url":"https://api.github.com/repos/dotnet/efcore/labels/area-query","name":"area-query","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"smitpatel","id":1528107,"node_id":"MDQ6VXNlcjE1MjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1528107?v=4","gravatar_id":"","url":"https://api.github.com/users/smitpatel","html_url":"https://github.com/smitpatel","followers_url":"https://api.github.com/users/smitpatel/followers","following_url":"https://api.github.com/users/smitpatel/following{/other_user}","gists_url":"https://api.github.com/users/smitpatel/gists{/gist_id}","starred_url":"https://api.github.com/users/smitpatel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smitpatel/subscriptions","organizations_url":"https://api.github.com/users/smitpatel/orgs","repos_url":"https://api.github.com/users/smitpatel/repos","events_url":"https://api.github.com/users/smitpatel/events{/privacy}","received_events_url":"https://api.github.com/users/smitpatel/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"smitpatel","id":1528107,"node_id":"MDQ6VXNlcjE1MjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1528107?v=4","gravatar_id":"","url":"https://api.github.com/users/smitpatel","html_url":"https://github.com/smitpatel","followers_url":"https://api.github.com/users/smitpatel/followers","following_url":"https://api.github.com/users/smitpatel/following{/other_user}","gists_url":"https://api.github.com/users/smitpatel/gists{/gist_id}","starred_url":"https://api.github.com/users/smitpatel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smitpatel/subscriptions","organizations_url":"https://api.github.com/users/smitpatel/orgs","repos_url":"https://api.github.com/users/smitpatel/repos","events_url":"https://api.github.com/users/smitpatel/events{/privacy}","received_events_url":"https://api.github.com/users/smitpatel/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/128","html_url":"https://github.com/dotnet/efcore/milestone/128","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/128/labels","id":7236796,"node_id":"MI_kwDOAPaMMs4Abmy8","number":128,"title":"7.0.0","description":"EF Core 7.0","creator":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":375,"state":"closed","created_at":"2021-10-09T18:57:40Z","updated_at":"2024-11-13T16:14:22Z","due_on":null,"closed_at":"2022-11-05T18:37:45Z"},"comments":9,"created_at":"2022-02-13T09:49:55Z","updated_at":"2025-06-15T18:45:36Z","closed_at":"2022-05-04T21:28:33Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":16157746,"node_id":"MDEwOlJlcG9zaXRvcnkxNjE1Nzc0Ng==","name":"efcore","full_name":"dotnet/efcore","private":false,"owner":{"login":"dotnet","id":9141961,"node_id":"MDEyOk9yZ2FuaXphdGlvbjkxNDE5NjE=","avatar_url":"https://avatars.githubusercontent.com/u/9141961?v=4","gravatar_id":"","url":"https://api.github.com/users/dotnet","html_url":"https://github.com/dotnet","followers_url":"https://api.github.com/users/dotnet/followers","following_url":"https://api.github.com/users/dotnet/following{/other_user}","gists_url":"https://api.github.com/users/dotnet/gists{/gist_id}","starred_url":"https://api.github.com/users/dotnet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dotnet/subscriptions","organizations_url":"https://api.github.com/users/dotnet/orgs","repos_url":"https://api.github.com/users/dotnet/repos","events_url":"https://api.github.com/users/dotnet/events{/privacy}","received_events_url":"https://api.github.com/users/dotnet/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/dotnet/efcore","description":"EF Core is a modern object-database mapper for .NET. It supports LINQ queries, change tracking, updates, and schema migrations.","fork":false,"url":"https://api.github.com/repos/dotnet/efcore","forks_url":"https://api.github.com/repos/dotnet/efcore/forks","keys_url":"https://api.github.com/repos/dotnet/efcore/keys{/key_id}","collaborators_url":"https://api.github.com/repos/dotnet/efcore/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/dotnet/efcore/teams","hooks_url":"https://api.github.com/repos/dotnet/efcore/hooks","issue_events_url":"https://api.github.com/repos/dotnet/efcore/issues/events{/number}","events_url":"https://api.github.com/repos/dotnet/efcore/events","assignees_url":"https://api.github.com/repos/dotnet/efcore/assignees{/user}","branches_url":"https://api.github.com/repos/dotnet/efcore/branches{/branch}","tags_url":"https://api.github.com/repos/dotnet/efcore/tags","blobs_url":"https://api.github.com/repos/dotnet/efcore/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/dotnet/efcore/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/dotnet/efcore/git/refs{/sha}","trees_url":"https://api.github.com/repos/dotnet/efcore/git/trees{/sha}","statuses_url":"https://api.github.com/repos/dotnet/efcore/statuses/{sha}","languages_url":"https://api.github.com/repos/dotnet/efcore/languages","stargazers_url":"https://api.github.com/repos/dotnet/efcore/stargazers","contributors_url":"https://api.github.com/repos/dotnet/efcore/contributors","subscribers_url":"https://api.github.com/repos/dotnet/efcore/subscribers","subscription_url":"https://api.github.com/repos/dotnet/efcore/subscription","commits_url":"https://api.github.com/repos/dotnet/efcore/commits{/sha}","git_commits_url":"https://api.github.com/repos/dotnet/efcore/git/commits{/sha}","comments_url":"https://api.github.com/repos/dotnet/efcore/comments{/number}","issue_comment_url":"https://api.github.com/repos/dotnet/efcore/issues/comments{/number}","contents_url":"https://api.github.com/repos/dotnet/efcore/contents/{+path}","compare_url":"https://api.github.com/repos/dotnet/efcore/compare/{base}...{head}","merges_url":"https://api.github.com/repos/dotnet/efcore/merges","archive_url":"https://api.github.com/repos/dotnet/efcore/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/dotnet/efcore/downloads","issues_url":"https://api.github.com/repos/dotnet/efcore/issues{/number}","pulls_url":"https://api.github.com/repos/dotnet/efcore/pulls{/number}","milestones_url":"https://api.github.com/repos/dotnet/efcore/milestones{/number}","notifications_url":"https://api.github.com/repos/dotnet/efcore/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/dotnet/efcore/labels{/name}","releases_url":"https://api.github.com/repos/dotnet/efcore/releases{/id}","deployments_url":"https://api.github.com/repos/dotnet/efcore/deployments","created_at":"2014-01-23T00:52:01Z","updated_at":"2025-11-10T14:21:49Z","pushed_at":"2025-11-10T05:59:58Z","git_url":"git://github.com/dotnet/efcore.git","ssh_url":"git@github.com:dotnet/efcore.git","clone_url":"https://github.com/dotnet/efcore.git","svn_url":"https://github.com/dotnet/efcore","homepage":"https://learn.microsoft.com/ef/","size":215987,"stargazers_count":14455,"watchers_count":14455,"language":"C#","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":false,"forks_count":3324,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":2430,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["aspnet-product","c-sharp","database","dotnet-core","dotnet-framework","dotnet-standard","entity-framework","hacktoberfest","orm"],"visibility":"public","forks":3324,"open_issues":2430,"watchers":14455,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"This problem only occurs in version 6.0.2 and does not occur in version 6.0.1.\r\n\r\n### Repro\r\n\r\nConsoleApp.csproj:\r\n```xml\r\n<Project Sdk=\"Microsoft.NET.Sdk\">\r\n  <PropertyGroup>\r\n    <OutputType>Exe</OutputType>\r\n    <TargetFramework>net6.0</TargetFramework>\r\n    <ImplicitUsings>enable</ImplicitUsings>\r\n  </PropertyGroup>\r\n  <ItemGroup>\r\n    <PackageReference Include=\"Microsoft.AspNetCore.Identity.EntityFrameworkCore\" Version=\"6.0.2\" />\r\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore\" Version=\"6.0.2\" />\r\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.Abstractions\" Version=\"6.0.2\" />\r\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.Analyzers\" Version=\"6.0.2\" />\r\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.Design\" Version=\"6.0.2\">\r\n      <PrivateAssets>all</PrivateAssets>\r\n      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>\r\n    </PackageReference>\r\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.Relational\" Version=\"6.0.2\" />\r\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.SqlServer\" Version=\"6.0.2\" />\r\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.Tools\" Version=\"6.0.2\">\r\n      <PrivateAssets>all</PrivateAssets>\r\n      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>\r\n    </PackageReference>\r\n  </ItemGroup>\r\n  <ItemGroup>\r\n    <Folder Include=\"Migrations\\\" />\r\n  </ItemGroup>\r\n</Project>\r\n```\r\n\r\n\r\n\r\nApplicationDbContext.cs:\r\n```c#\r\nusing Microsoft.EntityFrameworkCore;\r\nusing Microsoft.EntityFrameworkCore.ChangeTracking;\r\nusing Microsoft.EntityFrameworkCore.Metadata;\r\nusing Microsoft.Extensions.Options;\r\nusing System;\r\nusing System.Collections.Generic;\r\nusing System.Linq;\r\nusing System.Text;\r\nnamespace ConsoleApp1.Data\r\n{\r\n    public class ApplicationDbContext : DbContext\r\n    {\r\n        public virtual DbSet<Model.DepartmentStaff> CustomerSystemStaff { get; set; }\r\n        public virtual DbSet<Model.Department> Departments { get; set; }\r\n        public virtual DbSet<Model.TicketTask> TicketTasks { get; set; }\r\n        public ApplicationDbContext() : base(GetOptions())\r\n        {\r\n        }\r\n        public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options)\r\n            : base(options)\r\n        {\r\n        }\r\n        protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)\r\n        {\r\n            optionsBuilder\r\n               .UseSqlServer(\"Data Source=.;Initial Catalog=test;User ID=sa;Password=100+200\");\r\n\r\n            optionsBuilder\r\n             .UseSqlServer(o =>\r\n                 o.UseQuerySplittingBehavior(QuerySplittingBehavior.SplitQuery)\r\n             );\r\n        }\r\n        protected override void OnModelCreating(ModelBuilder modelBuilder)\r\n        {\r\n            base.OnModelCreating(modelBuilder);\r\n            modelBuilder.Entity<Model.Department>()\r\n            .HasMany<Model.DepartmentStaff>(g => g._DepartmentStaff)\r\n            .WithOne(s => s.Department)\r\n            .HasForeignKey(s => s.DepartmentID)\r\n            .OnDelete(DeleteBehavior.Cascade);\r\n\r\n\r\n            modelBuilder.Entity<Model.Department>()\r\n            .HasMany<Model.TicketTask>(g => g._TicketTaskActDepartment)\r\n            .WithOne(s => s.ActDepartment)\r\n            .HasForeignKey(s => s.ActDepartmentID)\r\n            .OnDelete(DeleteBehavior.NoAction);\r\n\r\n            modelBuilder.Entity<Model.ApplicationUser>()\r\n            .HasMany<Model.Department>(g => g._DepartmentUserManager)\r\n            .WithOne(s => s.UserManager)\r\n            .HasForeignKey(s => s.UserManagerID)\r\n            .OnDelete(DeleteBehavior.NoAction);\r\n\r\n            modelBuilder.Entity<Model.ApplicationUser>()\r\n            .HasMany<Model.DepartmentStaff>(g => g._DepartmentStaffUser)\r\n            .WithOne(s => s.User)\r\n            .HasForeignKey(s => s.UserID)\r\n            .OnDelete(DeleteBehavior.NoAction);\r\n\r\n            modelBuilder.Entity<Model.ApplicationUser>()\r\n            .HasMany<Model.TicketTask>(g => g._TicketTaskActUser)\r\n            .WithOne(s => s.ActUser)\r\n            .HasForeignKey(s => s.ActUserID)\r\n            .OnDelete(DeleteBehavior.NoAction);\r\n\r\n\r\n            modelBuilder.Entity<Model.Department>()\r\n            .HasMany<Model.Department>(g => g._Children)\r\n            .WithOne(s => s.Parent)\r\n            .HasForeignKey(s => s.ParentId)\r\n            .OnDelete(DeleteBehavior.NoAction);\r\n\r\n\r\n\r\n            modelBuilder.Entity<Model.TicketTask>().Property(m => m.InsertedDatePersian).HasComputedColumnSql(\"(format([InsertedDate],'yyyy/MM/dd HH:mm:ss','fa'))\").HasColumnName(\"InsertedDatePersian\");\r\n            modelBuilder.Entity<Model.TicketTask>().Property(m => m.DoneDatePersian).HasComputedColumnSql(\"(format([DoneDate],'yyyy/MM/dd HH:mm:ss','fa'))\").HasColumnName(\"DoneDatePersian\");\r\n\r\n\r\n        }\r\n        private static DbContextOptions<ApplicationDbContext> GetOptions()\r\n        {\r\n            return SqlServerDbContextOptionsExtensions.UseSqlServer(new DbContextOptionsBuilder<ApplicationDbContext>(), \"Data Source=.;Initial Catalog=test;User ID=sa;Password=100+200\").Options;\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nApplicationUser.cs:\r\n```C#\r\nusing System;\r\nusing System.Collections.Generic;\r\nusing System.ComponentModel.DataAnnotations;\r\nusing System.ComponentModel.DataAnnotations.Schema;\r\n\r\nnamespace Model\r\n{\r\n    public class ApplicationUser \r\n    {\r\n\r\n        public ApplicationUser()\r\n        {\r\n\r\n            this._DepartmentUserManager = new HashSet<Model.Department>();\r\n\r\n            this._DepartmentStaffUser = new HashSet<Model.DepartmentStaff>();\r\n            this._TicketTaskActUser = new HashSet<Model.TicketTask>();\r\n\r\n        }\r\n\r\n        public virtual ICollection<Model.Department> _DepartmentUserManager { get; set; }\r\n        public virtual ICollection<Model.DepartmentStaff> _DepartmentStaffUser { get; set; }\r\n        public virtual ICollection<Model.TicketTask> _TicketTaskActUser { get; set; }\r\n\r\n\r\n\r\n        [Key]\r\n        [DatabaseGenerated(DatabaseGeneratedOption.Identity)]\r\n        public int ID { get; set; }\r\n\r\n    }\r\n}\r\n```\r\n\r\nDepartment.cs:\r\n```C#\r\nusing System;\r\nusing System.Collections.Generic;\r\nusing System.ComponentModel.DataAnnotations;\r\nusing System.ComponentModel.DataAnnotations.Schema;\r\nusing System.Linq;\r\nusing System.Text;\r\nusing System.Text.Json.Serialization;\r\nusing System.Threading.Tasks;\r\n\r\nnamespace Model\r\n{\r\n    [Table(\"Department\")]\r\n    public class Department\r\n    {\r\n\r\n        public Department()\r\n        {\r\n            this._DepartmentStaff = new HashSet<Model.DepartmentStaff>();\r\n            this._TicketTaskActDepartment = new HashSet<Model.TicketTask>();\r\n            this._Children = new HashSet<Model.Department>();\r\n\r\n        }\r\n\r\n        public virtual ICollection<Model.DepartmentStaff> _DepartmentStaff { get; set; }\r\n        public virtual ICollection<Model.TicketTask> _TicketTaskActDepartment { get; set; }\r\n        public virtual ICollection<Model.Department> _Children { get; set; }\r\n\r\n        [Key]\r\n        [DatabaseGenerated(DatabaseGeneratedOption.Identity)]\r\n        public int ID { get; set; }\r\n        public string Title { get; set; }\r\n\r\n        public int? UserManagerID { get; set; }\r\n        public virtual Model.ApplicationUser UserManager { get; set; }\r\n\r\n        public int? ParentId { get; set; }\r\n        public virtual Model.Department Parent { get; set; }\r\n\r\n    }\r\n}\r\n```\r\n\r\nDepartmentStaff.cs:\r\n```C#\r\nusing System;\r\nusing System.Collections.Generic;\r\nusing System.ComponentModel.DataAnnotations;\r\nusing System.ComponentModel.DataAnnotations.Schema;\r\nusing System.Text;\r\n\r\nnamespace Model\r\n{\r\n    [Table(\"DepartmentStaff\")]\r\n    public class DepartmentStaff\r\n    {\r\n\r\n        public int ID { get; set; }\r\n\r\n\r\n        public int DepartmentID { get; set; }\r\n        public virtual Model.Department Department { get; set; }\r\n\r\n\r\n        public int UserID { get; set; }\r\n        public virtual Model.ApplicationUser User { get; set; }\r\n\r\n\r\n    }\r\n}\r\n```\r\n\r\nTask.cs:\r\n```C#\r\nusing System;\r\nusing System.Collections.Generic;\r\nusing System.ComponentModel.DataAnnotations;\r\nusing System.ComponentModel.DataAnnotations.Schema;\r\nusing System.Text;\r\n\r\nnamespace Model\r\n{\r\n    [Table(\"TicketTask\")]\r\n    public class TicketTask\r\n    {\r\n\r\n        [Key]\r\n        [DatabaseGenerated(DatabaseGeneratedOption.Identity)]\r\n        public int ID { get; set; }\r\n\r\n        public int TicketID { get; set; }\r\n        //public virtual Model.Ticket Ticket { get; set; }\r\n\r\n        [Column(TypeName = \"DateTime\")]\r\n        public DateTime InsertedDate { get; set; }\r\n\r\n        public int? ActDepartmentID { get; set; }\r\n        public virtual Model.Department ActDepartment { get; set; }\r\n\r\n        public int? ActUserID { get; set; }\r\n        public virtual Model.ApplicationUser ActUser { get; set; }\r\n\r\n        public bool isDone { get; set; }\r\n\r\n        [Column(TypeName = \"DateTime\")]\r\n        public DateTime? DoneDate { get; set; }\r\n\r\n        [DatabaseGenerated(DatabaseGeneratedOption.Computed)]\r\n        public string InsertedDatePersian { get; }\r\n\r\n        [DatabaseGenerated(DatabaseGeneratedOption.Computed)]\r\n        public string DoneDatePersian { get; }\r\n\r\n    }\r\n}\r\n```\r\n\r\nProgram.cs:\r\n```C#\r\nusing Microsoft.EntityFrameworkCore;\r\n\r\nvar _context = new  ConsoleApp1.Data.ApplicationDbContext();\r\n\r\nvar query = _context\r\n    .TicketTasks\r\n    .Where(x => x.isDone == false && (x.ActDepartment._DepartmentStaff.Any(c => c.UserID == 4) || x.ActUserID == 4))\r\n    .GroupBy(x => x.InsertedDatePersian.Substring(0, 10))\r\n    .Select(g => new { Date = g.Key, Count = g.Count() })\r\n    .AsQueryable();\r\n\r\nvar queryString = query.ToQueryString();\r\n\r\nvar r = await query.ToListAsync();\r\n```\r\n\r\n### Error\r\n```\r\nColumn 'TicketTask.InsertedDatePersian' is invalid in the select list because it is not contained in either an aggregate function or the GROUP BY clause.\r\n```\r\n\r\n### Query String\r\n\r\nQuery created in version 6.0.1:\r\n```sql\r\nSELECT SUBSTRING([t].[InsertedDatePersian], 0 + 1, 10) AS [Date], COUNT(*) AS [Count]\r\nFROM [TicketTask] AS [t]\r\nLEFT JOIN [Department] AS [d] ON [t].[ActDepartmentID] = [d].[ID]\r\nWHERE ([t].[isDone] = CAST(0 AS bit)) AND (EXISTS (\r\n    SELECT 1\r\n    FROM [DepartmentStaff] AS [d0]\r\n    WHERE ([d].[ID] IS NOT NULL AND ([d].[ID] = [d0].[DepartmentID])) AND ([d0].[UserID] = 4)) OR ([t].[ActUserID] = 4))\r\nGROUP BY SUBSTRING([t].[InsertedDatePersian], 0 + 1, 10)\r\n```\r\n\r\nQuery created in version 6.0.2:\r\n```sql\r\nSELECT SUBSTRING([t].[InsertedDatePersian], 0 + 1, 10) AS [Date], (\r\n    SELECT COUNT(*)\r\n    FROM [TicketTask] AS [t0]\r\n    LEFT JOIN [Department] AS [d1] ON [t0].[ActDepartmentID] = [d1].[ID]\r\n    WHERE (([t0].[isDone] = CAST(0 AS bit)) AND (EXISTS (\r\n        SELECT 1\r\n        FROM [DepartmentStaff] AS [d2]\r\n        WHERE (([d1].[ID] IS NOT NULL) AND ([d1].[ID] = [d2].[DepartmentID])) AND ([d2].[UserID] = 4)) OR ([t0].[ActUserID] = 4))) AND ((SUBSTRING([t].[InsertedDatePersian], 0 + 1, 10) = SUBSTRING([t0].[InsertedDatePersian], 0 + 1, 10)) OR (([t].[InsertedDatePersian] IS NULL) AND ([t0].[InsertedDatePersian] IS NULL)))) AS [Count]\r\nFROM [TicketTask] AS [t]\r\nLEFT JOIN [Department] AS [d] ON [t].[ActDepartmentID] = [d].[ID]\r\nWHERE ([t].[isDone] = CAST(0 AS bit)) AND (EXISTS (\r\n    SELECT 1\r\n    FROM [DepartmentStaff] AS [d0]\r\n    WHERE (([d].[ID] IS NOT NULL) AND ([d].[ID] = [d0].[DepartmentID])) AND ([d0].[UserID] = 4)) OR ([t].[ActUserID] = 4))\r\nGROUP BY SUBSTRING([t].[InsertedDatePersian], 0 + 1, 10)\r\n```\r\n\r\n### Include provider and version information\r\n\r\nEF Core version:\r\nDatabase provider: (e.g. Microsoft.EntityFrameworkCore.SqlServer)\r\nTarget framework: (e.g. .NET 6.0)\r\nOperating system:\r\nIDE: (e.g. Visual Studio 2022 17.0.6)\r\n","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/27433/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":1,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/27433/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"},{"actor":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-01T00:40:03Z","updated_at":"2022-03-01T00:40:03Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/dotnet/efcore/issues/27185","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/27185/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/27185/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/27185/events","html_url":"https://github.com/dotnet/efcore/issues/27185","id":1102034668,"node_id":"I_kwDOAPaMMs5Br7bs","number":27185,"title":".NET Data Biweekly Updates (2022)","user":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/9","html_url":"https://github.com/dotnet/efcore/milestone/9","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/9/labels","id":692755,"node_id":"MDk6TWlsZXN0b25lNjkyNzU1","number":9,"title":"Discussions","description":"<!--\r\n@huboard:{\"order\":101}\r\n-->","creator":{"login":"rowanmiller","id":4741851,"node_id":"MDQ6VXNlcjQ3NDE4NTE=","avatar_url":"https://avatars.githubusercontent.com/u/4741851?v=4","gravatar_id":"","url":"https://api.github.com/users/rowanmiller","html_url":"https://github.com/rowanmiller","followers_url":"https://api.github.com/users/rowanmiller/followers","following_url":"https://api.github.com/users/rowanmiller/following{/other_user}","gists_url":"https://api.github.com/users/rowanmiller/gists{/gist_id}","starred_url":"https://api.github.com/users/rowanmiller/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rowanmiller/subscriptions","organizations_url":"https://api.github.com/users/rowanmiller/orgs","repos_url":"https://api.github.com/users/rowanmiller/repos","events_url":"https://api.github.com/users/rowanmiller/events{/privacy}","received_events_url":"https://api.github.com/users/rowanmiller/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":6,"closed_issues":195,"state":"open","created_at":"2014-06-16T19:38:35Z","updated_at":"2025-10-17T12:37:21Z","due_on":null,"closed_at":null},"comments":21,"created_at":"2022-01-13T16:53:02Z","updated_at":"2024-08-31T17:24:44Z","closed_at":"2024-05-15T15:40:37Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":16157746,"node_id":"MDEwOlJlcG9zaXRvcnkxNjE1Nzc0Ng==","name":"efcore","full_name":"dotnet/efcore","private":false,"owner":{"login":"dotnet","id":9141961,"node_id":"MDEyOk9yZ2FuaXphdGlvbjkxNDE5NjE=","avatar_url":"https://avatars.githubusercontent.com/u/9141961?v=4","gravatar_id":"","url":"https://api.github.com/users/dotnet","html_url":"https://github.com/dotnet","followers_url":"https://api.github.com/users/dotnet/followers","following_url":"https://api.github.com/users/dotnet/following{/other_user}","gists_url":"https://api.github.com/users/dotnet/gists{/gist_id}","starred_url":"https://api.github.com/users/dotnet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dotnet/subscriptions","organizations_url":"https://api.github.com/users/dotnet/orgs","repos_url":"https://api.github.com/users/dotnet/repos","events_url":"https://api.github.com/users/dotnet/events{/privacy}","received_events_url":"https://api.github.com/users/dotnet/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/dotnet/efcore","description":"EF Core is a modern object-database mapper for .NET. It supports LINQ queries, change tracking, updates, and schema migrations.","fork":false,"url":"https://api.github.com/repos/dotnet/efcore","forks_url":"https://api.github.com/repos/dotnet/efcore/forks","keys_url":"https://api.github.com/repos/dotnet/efcore/keys{/key_id}","collaborators_url":"https://api.github.com/repos/dotnet/efcore/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/dotnet/efcore/teams","hooks_url":"https://api.github.com/repos/dotnet/efcore/hooks","issue_events_url":"https://api.github.com/repos/dotnet/efcore/issues/events{/number}","events_url":"https://api.github.com/repos/dotnet/efcore/events","assignees_url":"https://api.github.com/repos/dotnet/efcore/assignees{/user}","branches_url":"https://api.github.com/repos/dotnet/efcore/branches{/branch}","tags_url":"https://api.github.com/repos/dotnet/efcore/tags","blobs_url":"https://api.github.com/repos/dotnet/efcore/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/dotnet/efcore/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/dotnet/efcore/git/refs{/sha}","trees_url":"https://api.github.com/repos/dotnet/efcore/git/trees{/sha}","statuses_url":"https://api.github.com/repos/dotnet/efcore/statuses/{sha}","languages_url":"https://api.github.com/repos/dotnet/efcore/languages","stargazers_url":"https://api.github.com/repos/dotnet/efcore/stargazers","contributors_url":"https://api.github.com/repos/dotnet/efcore/contributors","subscribers_url":"https://api.github.com/repos/dotnet/efcore/subscribers","subscription_url":"https://api.github.com/repos/dotnet/efcore/subscription","commits_url":"https://api.github.com/repos/dotnet/efcore/commits{/sha}","git_commits_url":"https://api.github.com/repos/dotnet/efcore/git/commits{/sha}","comments_url":"https://api.github.com/repos/dotnet/efcore/comments{/number}","issue_comment_url":"https://api.github.com/repos/dotnet/efcore/issues/comments{/number}","contents_url":"https://api.github.com/repos/dotnet/efcore/contents/{+path}","compare_url":"https://api.github.com/repos/dotnet/efcore/compare/{base}...{head}","merges_url":"https://api.github.com/repos/dotnet/efcore/merges","archive_url":"https://api.github.com/repos/dotnet/efcore/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/dotnet/efcore/downloads","issues_url":"https://api.github.com/repos/dotnet/efcore/issues{/number}","pulls_url":"https://api.github.com/repos/dotnet/efcore/pulls{/number}","milestones_url":"https://api.github.com/repos/dotnet/efcore/milestones{/number}","notifications_url":"https://api.github.com/repos/dotnet/efcore/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/dotnet/efcore/labels{/name}","releases_url":"https://api.github.com/repos/dotnet/efcore/releases{/id}","deployments_url":"https://api.github.com/repos/dotnet/efcore/deployments","created_at":"2014-01-23T00:52:01Z","updated_at":"2025-11-10T14:21:49Z","pushed_at":"2025-11-10T05:59:58Z","git_url":"git://github.com/dotnet/efcore.git","ssh_url":"git@github.com:dotnet/efcore.git","clone_url":"https://github.com/dotnet/efcore.git","svn_url":"https://github.com/dotnet/efcore","homepage":"https://learn.microsoft.com/ef/","size":215987,"stargazers_count":14455,"watchers_count":14455,"language":"C#","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":false,"forks_count":3324,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":2430,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["aspnet-product","c-sharp","database","dotnet-core","dotnet-framework","dotnet-standard","entity-framework","hacktoberfest","orm"],"visibility":"public","forks":3324,"open_issues":2430,"watchers":14455,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"Biweekly status updates for [2022](https://github.com/dotnet/efcore/issues/27185)\r\n\r\nFor 2023, see [Latest news and progress on .NET 8 and EF8](https://github.com/dotnet/efcore/issues/29989)\r\n\r\nFor previous years, see:\r\n\r\n* [2021](https://github.com/dotnet/efcore/issues/23884)\r\n* [2020](https://github.com/dotnet/efcore/issues/19549)\r\n* [2019](https://github.com/dotnet/efcore/issues/15403)","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/27185/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/27185/timeline","performed_via_github_app":null,"state_reason":"not_planned"}},"event":"cross-referenced"},{"actor":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-23T00:16:59Z","updated_at":"2022-03-23T00:16:59Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/dotnet/efcore/issues/27621","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/27621/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/27621/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/27621/events","html_url":"https://github.com/dotnet/efcore/issues/27621","id":1166175258,"node_id":"I_kwDOAPaMMs5Fgmwa","number":27621,"title":"After upgrading from EF 6.0.1 to EF 6.0.2: broken query generation when using aggregate","user":{"login":"farlop","id":2676254,"node_id":"MDQ6VXNlcjI2NzYyNTQ=","avatar_url":"https://avatars.githubusercontent.com/u/2676254?v=4","gravatar_id":"","url":"https://api.github.com/users/farlop","html_url":"https://github.com/farlop","followers_url":"https://api.github.com/users/farlop/followers","following_url":"https://api.github.com/users/farlop/following{/other_user}","gists_url":"https://api.github.com/users/farlop/gists{/gist_id}","starred_url":"https://api.github.com/users/farlop/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/farlop/subscriptions","organizations_url":"https://api.github.com/users/farlop/orgs","repos_url":"https://api.github.com/users/farlop/repos","events_url":"https://api.github.com/users/farlop/events{/privacy}","received_events_url":"https://api.github.com/users/farlop/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":8,"created_at":"2022-03-11T09:10:55Z","updated_at":"2025-06-16T09:08:47Z","closed_at":"2022-10-16T20:28:50Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":16157746,"node_id":"MDEwOlJlcG9zaXRvcnkxNjE1Nzc0Ng==","name":"efcore","full_name":"dotnet/efcore","private":false,"owner":{"login":"dotnet","id":9141961,"node_id":"MDEyOk9yZ2FuaXphdGlvbjkxNDE5NjE=","avatar_url":"https://avatars.githubusercontent.com/u/9141961?v=4","gravatar_id":"","url":"https://api.github.com/users/dotnet","html_url":"https://github.com/dotnet","followers_url":"https://api.github.com/users/dotnet/followers","following_url":"https://api.github.com/users/dotnet/following{/other_user}","gists_url":"https://api.github.com/users/dotnet/gists{/gist_id}","starred_url":"https://api.github.com/users/dotnet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dotnet/subscriptions","organizations_url":"https://api.github.com/users/dotnet/orgs","repos_url":"https://api.github.com/users/dotnet/repos","events_url":"https://api.github.com/users/dotnet/events{/privacy}","received_events_url":"https://api.github.com/users/dotnet/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/dotnet/efcore","description":"EF Core is a modern object-database mapper for .NET. It supports LINQ queries, change tracking, updates, and schema migrations.","fork":false,"url":"https://api.github.com/repos/dotnet/efcore","forks_url":"https://api.github.com/repos/dotnet/efcore/forks","keys_url":"https://api.github.com/repos/dotnet/efcore/keys{/key_id}","collaborators_url":"https://api.github.com/repos/dotnet/efcore/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/dotnet/efcore/teams","hooks_url":"https://api.github.com/repos/dotnet/efcore/hooks","issue_events_url":"https://api.github.com/repos/dotnet/efcore/issues/events{/number}","events_url":"https://api.github.com/repos/dotnet/efcore/events","assignees_url":"https://api.github.com/repos/dotnet/efcore/assignees{/user}","branches_url":"https://api.github.com/repos/dotnet/efcore/branches{/branch}","tags_url":"https://api.github.com/repos/dotnet/efcore/tags","blobs_url":"https://api.github.com/repos/dotnet/efcore/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/dotnet/efcore/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/dotnet/efcore/git/refs{/sha}","trees_url":"https://api.github.com/repos/dotnet/efcore/git/trees{/sha}","statuses_url":"https://api.github.com/repos/dotnet/efcore/statuses/{sha}","languages_url":"https://api.github.com/repos/dotnet/efcore/languages","stargazers_url":"https://api.github.com/repos/dotnet/efcore/stargazers","contributors_url":"https://api.github.com/repos/dotnet/efcore/contributors","subscribers_url":"https://api.github.com/repos/dotnet/efcore/subscribers","subscription_url":"https://api.github.com/repos/dotnet/efcore/subscription","commits_url":"https://api.github.com/repos/dotnet/efcore/commits{/sha}","git_commits_url":"https://api.github.com/repos/dotnet/efcore/git/commits{/sha}","comments_url":"https://api.github.com/repos/dotnet/efcore/comments{/number}","issue_comment_url":"https://api.github.com/repos/dotnet/efcore/issues/comments{/number}","contents_url":"https://api.github.com/repos/dotnet/efcore/contents/{+path}","compare_url":"https://api.github.com/repos/dotnet/efcore/compare/{base}...{head}","merges_url":"https://api.github.com/repos/dotnet/efcore/merges","archive_url":"https://api.github.com/repos/dotnet/efcore/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/dotnet/efcore/downloads","issues_url":"https://api.github.com/repos/dotnet/efcore/issues{/number}","pulls_url":"https://api.github.com/repos/dotnet/efcore/pulls{/number}","milestones_url":"https://api.github.com/repos/dotnet/efcore/milestones{/number}","notifications_url":"https://api.github.com/repos/dotnet/efcore/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/dotnet/efcore/labels{/name}","releases_url":"https://api.github.com/repos/dotnet/efcore/releases{/id}","deployments_url":"https://api.github.com/repos/dotnet/efcore/deployments","created_at":"2014-01-23T00:52:01Z","updated_at":"2025-11-10T14:21:49Z","pushed_at":"2025-11-10T05:59:58Z","git_url":"git://github.com/dotnet/efcore.git","ssh_url":"git@github.com:dotnet/efcore.git","clone_url":"https://github.com/dotnet/efcore.git","svn_url":"https://github.com/dotnet/efcore","homepage":"https://learn.microsoft.com/ef/","size":215987,"stargazers_count":14455,"watchers_count":14455,"language":"C#","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":false,"forks_count":3324,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":2430,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["aspnet-product","c-sharp","database","dotnet-core","dotnet-framework","dotnet-standard","entity-framework","hacktoberfest","orm"],"visibility":"public","forks":3324,"open_issues":2430,"watchers":14455,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"Having some code that generates this query in EF 6.0.1:\r\n\r\n```sql\r\n SELECT [t].[Code] AS [CustomerCode], [t].[Description] AS [CustomerDescription], [o].[Year], [o].[WeekNumber], [o].[FamilyCode], MAX([t0].[ArrivalDate]) AS [MaxArrivalDate]\r\n      FROM [OrderRequirements] AS [o]\r\n      INNER JOIN (\r\n          SELECT [c].[Id], [c].[Code], [c].[Description]\r\n          FROM [Customers] AS [c]\r\n          WHERE [c].[Enabled] = CAST(1 AS bit)\r\n      ) AS [t] ON [o].[CustomerId] = [t].[Id]\r\n      INNER JOIN (\r\n          SELECT [o0].[ArrivalDate], [o0].[OrderRequirementId]\r\n          FROM [OrderRequirementDetails] AS [o0]\r\n          INNER JOIN (\r\n              SELECT [d].[Id], [d].[Enabled]\r\n              FROM [Depots] AS [d]\r\n              WHERE [d].[Enabled] = CAST(1 AS bit)\r\n          ) AS [t1] ON [o0].[DepotId] = [t1].[Id]\r\n          WHERE [t1].[Enabled] = CAST(1 AS bit)\r\n      ) AS [t0] ON [o].[Id] = [t0].[OrderRequirementId]\r\n      WHERE ((([o].[Enabled] = CAST(1 AS bit)) AND [t].[Code] IN (N'10', N'12')) AND [o].[PublishedAt] IS NOT NULL) AND EXISTS (\r\n          SELECT 1\r\n          FROM [dbo].[fGrowerAssignments](NULL, NULL, NULL, NULL, NULL, @__published_7) AS [f]\r\n          WHERE ([f].[GrowerCode] = @__query_GrowerCode_8) AND (((([f].[CustomerCode] = [t].[Code]) AND ([f].[Year] = [o].[Year])) AND ([f].[WeekNumber] = [o].[WeekNumber])) AND (([f].[FamilyCode] = [o].[FamilyCode]) OR ([f].[FamilyCode] IS NULL AND [o].[FamilyCode] IS NULL))))\r\n      GROUP BY [t].[Code], [t].[Description], [o].[Year], [o].[WeekNumber], [o].[FamilyCode]\r\n      ORDER BY MAX([t0].[ArrivalDate]) DESC, [t].[Description], [o].[FamilyCode]\r\n      OFFSET @__p_9 ROWS FETCH NEXT @__p_10 ROWS ONLY\r\n```\r\n\r\nAfter upgrading to EF 6.0.2, the query generated is broken when trying to get `MAX([t0].[ArrivalDate]) AS [MaxArrivalDate]`, adding a new subquery that also is broken and fails as wrong table identifiers (f3) is used in every [fGrowerAssignments] use:\r\n\r\n```sql\r\n SELECT [t].[Code] AS [CustomerCode], [t].[Description] AS [CustomerDescription], [o].[Year], [o].[WeekNumber], [o].[FamilyCode], (\r\n-- BEGIN WRONG SUBQUERY FOR 'MAXARRIVALDATE' AGGREGATE\r\n          SELECT MAX([t4].[ArrivalDate])\r\n          FROM [OrderRequirements] AS [o2]\r\n          INNER JOIN (\r\n              SELECT [c1].[Id], [c1].[ArrivalsEmailNotification], [c1].[Code], [c1].[CreateLoadingOrderClosed], [c1].[CustomsManagement], [c1].[Description], [c1].[Enabled], [c1].[ProgramByFamily], [c1].[ProgramDuration], [c1].[ProgramStartDay], [c1].[UpdatedAt], [c1].[UpdatedBy]\r\n              FROM [Customers] AS [c1]\r\n              WHERE [c1].[Enabled] = CAST(1 AS bit)\r\n          ) AS [t3] ON [o2].[CustomerId] = [t3].[Id]\r\n          INNER JOIN (\r\n              SELECT [o3].[ArrivalDate], [o3].[Id], [t5].[Id] AS [Id0], [o3].[OrderRequirementId]\r\n              FROM [OrderRequirementDetails] AS [o3]\r\n              INNER JOIN (\r\n                  SELECT [d0].[Id], [d0].[Code], [d0].[DepotType], [d0].[Description], [d0].[Enabled], [d0].[TransitDays], [d0].[UnloadingOrder], [d0].[UpdatedAt], [d0].[UpdatedBy]\r\n                  FROM [Depots] AS [d0]\r\n                  WHERE [d0].[Enabled] = CAST(1 AS bit)\r\n              ) AS [t5] ON [o3].[DepotId] = [t5].[Id]\r\n              WHERE [t5].[Enabled] = CAST(1 AS bit)\r\n          ) AS [t4] ON [o2].[Id] = [t4].[OrderRequirementId]\r\n          WHERE (((([o2].[Enabled] = CAST(1 AS bit)) AND [t3].[Code] IN (N'10', N'12')) AND ([o2].[PublishedAt] IS NOT NULL)) AND EXISTS (\r\n              SELECT 1\r\n              FROM [dbo].[fGrowerAssignments](NULL, NULL, NULL, NULL, NULL, @__published_7) AS [f3]\r\n              WHERE ([f2].[GrowerCode] = @__query_GrowerCode_8) AND (((([f2].[CustomerCode] = [t3].[Code]) AND ([f2].[Year] = [o2].[Year])) AND ([f2].[WeekNumber] = [o2].[WeekNumber])) AND (([f2].[FamilyCode] = [o2].[FamilyCode]) OR (([f2].[FamilyCode] IS NULL) AND ([o2].[FamilyCode] IS NULL)))))) AND ((((([t].[Code] = [t3].[Code]) AND ([t].[Description] = [t3].[Description])) AND ([o].[Year] = [o2].[Year])) AND ([o].[WeekNumber] = [o2].[WeekNumber])) AND (([o].[FamilyCode] = [o2].[FamilyCode]) OR (([o].[FamilyCode] IS NULL) AND ([o2].[FamilyCode] IS NULL))))) AS [MaxArrivalDate]\r\n-- END\r\n      FROM [OrderRequirements] AS [o]\r\n      INNER JOIN (\r\n          SELECT [c].[Id], [c].[Code], [c].[Description]\r\n          FROM [Customers] AS [c]\r\n          WHERE [c].[Enabled] = CAST(1 AS bit)\r\n      ) AS [t] ON [o].[CustomerId] = [t].[Id]\r\n      WHERE ((([o].[Enabled] = CAST(1 AS bit)) AND [t].[Code] IN (N'10', N'12')) AND ([o].[PublishedAt] IS NOT NULL)) AND EXISTS (\r\n          SELECT 1\r\n          FROM [dbo].[fGrowerAssignments](NULL, NULL, NULL, NULL, NULL, @__published_7) AS [f3] -- ERROR: named [f3], but used as [f] in line below\r\n          WHERE ([f].[GrowerCode] = @__query_GrowerCode_8) AND (((([f].[CustomerCode] = [t].[Code]) AND ([f].[Year] = [o].[Year])) AND ([f].[WeekNumber] = [o].[WeekNumber])) AND (([f].[FamilyCode] = [o].[FamilyCode]) OR (([f].[FamilyCode] IS NULL) AND ([o].[FamilyCode] IS NULL)))))\r\n      GROUP BY [t].[Code], [t].[Description], [o].[Year], [o].[WeekNumber], [o].[FamilyCode]\r\n      ORDER BY (\r\n-- WRONG ORDER BY MaxArrivalDate\r\n          SELECT MAX([t4].[ArrivalDate])\r\n          FROM [OrderRequirements] AS [o2]\r\n          INNER JOIN (\r\n              SELECT [c1].[Id], [c1].[ArrivalsEmailNotification], [c1].[Code], [c1].[CreateLoadingOrderClosed], [c1].[CustomsManagement], [c1].[Description], [c1].[Enabled], [c1].[ProgramByFamily], [c1].[ProgramDuration], [c1].[ProgramStartDay], [c1].[UpdatedAt], [c1].[UpdatedBy]\r\n              FROM [Customers] AS [c1]\r\n              WHERE [c1].[Enabled] = CAST(1 AS bit)\r\n          ) AS [t3] ON [o2].[CustomerId] = [t3].[Id]\r\n          INNER JOIN (\r\n              SELECT [o3].[ArrivalDate], [o3].[Id], [t5].[Id] AS [Id0], [o3].[OrderRequirementId]\r\n              FROM [OrderRequirementDetails] AS [o3]\r\n              INNER JOIN (\r\n                  SELECT [d0].[Id], [d0].[Code], [d0].[DepotType], [d0].[Description], [d0].[Enabled], [d0].[TransitDays], [d0].[UnloadingOrder], [d0].[UpdatedAt], [d0].[UpdatedBy]\r\n                  FROM [Depots] AS [d0]\r\n                  WHERE [d0].[Enabled] = CAST(1 AS bit)\r\n              ) AS [t5] ON [o3].[DepotId] = [t5].[Id]\r\n              WHERE [t5].[Enabled] = CAST(1 AS bit)\r\n          ) AS [t4] ON [o2].[Id] = [t4].[OrderRequirementId]\r\n          WHERE (((([o2].[Enabled] = CAST(1 AS bit)) AND [t3].[Code] IN (N'10', N'12')) AND ([o2].[PublishedAt] IS NOT NULL)) AND EXISTS (\r\n              SELECT 1\r\n              FROM [dbo].[fGrowerAssignments](NULL, NULL, NULL, NULL, NULL, @__published_7) AS [f3] -- ERROR: named [f3], but used as [f2] in line below\r\n              WHERE ([f2].[GrowerCode] = @__query_GrowerCode_8) AND (((([f2].[CustomerCode] = [t3].[Code]) AND ([f2].[Year] = [o2].[Year])) AND ([f2].[WeekNumber] = [o2].[WeekNumber])) AND (([f2].[FamilyCode] = [o2].[FamilyCode]) OR (([f2].[FamilyCode] IS NULL) AND ([o2].[FamilyCode] IS NULL)))))) AND ((((([t].[Code] = [t3].[Code]) AND ([t].[Description] = [t3].[Description])) AND ([o].[Year] = [o2].[Year])) AND ([o].[WeekNumber] = [o2].[WeekNumber])) AND (([o].[FamilyCode] = [o2].[FamilyCode]) OR (([o].[FamilyCode] IS NULL) AND ([o2].[FamilyCode] IS NULL))))) DESC, [t].[Description], [o].[FamilyCode]\r\n      OFFSET @__p_9 ROWS FETCH NEXT @__p_10 ROWS ONLY\r\n```\r\n\r\nThis is failing with message:\r\n```\r\n Microsoft.Data.SqlClient.SqlException (0x80131904): El identificador formado por varias partes 'f.GrowerCode' no se pudo enlazar.\r\n      El identificador formado por varias partes 'f.CustomerCode' no se pudo enlazar.\r\n      El identificador formado por varias partes 'f.Year' no se pudo enlazar.\r\n      El identificador formado por varias partes 'f.WeekNumber' no se pudo enlazar.\r\n      El identificador formado por varias partes 'f.FamilyCode' no se pudo enlazar.\r\n      El identificador formado por varias partes 'f.FamilyCode' no se pudo enlazar.\r\n      El identificador formado por varias partes 'f2.GrowerCode' no se pudo enlazar.\r\n      El identificador formado por varias partes 'f2.CustomerCode' no se pudo enlazar.\r\n      El identificador formado por varias partes 'f2.Year' no se pudo enlazar.\r\n      El identificador formado por varias partes 'f2.WeekNumber' no se pudo enlazar.\r\n      El identificador formado por varias partes 'f2.FamilyCode' no se pudo enlazar.\r\n      El identificador formado por varias partes 'f2.FamilyCode' no se pudo enlazar.\r\n      El identificador formado por varias partes 'f2.GrowerCode' no se pudo enlazar.\r\n      El identificador formado por varias partes 'f2.CustomerCode' no se pudo enlazar.\r\n      El identificador formado por varias partes 'f2.Year' no se pudo enlazar.\r\n      El identificador formado por varias partes 'f2.WeekNumber' no se pudo enlazar.\r\n      El identificador formado por varias partes 'f2.FamilyCode' no se pudo enlazar.\r\n      El identificador formado por varias partes 'f2.FamilyCode' no se pudo enlazar.\r\n```\r\n\r\nHere is more information about Model:\r\n\r\n```c#\r\npublic class OrderRequirementConfiguration : IEntityTypeConfiguration<OrderRequirement>\r\n{\r\n    public void Configure(EntityTypeBuilder<OrderRequirement> builder)\r\n    {\r\n        ...\r\n        builder.HasOne(x => x.Customer).WithMany().OnDelete(DeleteBehavior.Restrict);\r\n\r\n        builder.HasMany(x => x.OrderRequirementDetails).WithOne(x => x.OrderRequirement).OnDelete(DeleteBehavior.Cascade);\r\n        ...\r\n    }\r\n}\r\n\r\npublic class OrderRequirementDetailConfiguration : IEntityTypeConfiguration<OrderRequirementDetail>\r\n{\r\n    public void Configure(EntityTypeBuilder<OrderRequirementDetail> builder)\r\n    {\r\n        builder.ToTable(\"OrderRequirementDetails\");\r\n        ...\r\n        builder.HasOne(x => x.Depot).WithMany().OnDelete(DeleteBehavior.Restrict);\r\n\r\n        builder.HasOne(x => x.OrderRequirement).WithMany(x => x.OrderRequirementDetails).OnDelete(DeleteBehavior.Cascade);\r\n\r\n        builder.HasQueryFilter(x => x.Depot.Enabled);\r\n        ...\r\n    }\r\n}\r\n\r\npublic class GrowerAssignmentViewConfiguration : IEntityTypeConfiguration<GrowerAssignmentView>\r\n{\r\n    public void Configure(EntityTypeBuilder<GrowerAssignmentView> builder)\r\n    {\r\n        builder.HasNoKey();\r\n        ...\r\n    }\r\n}\r\n\r\nprotected override void OnModelCreating(ModelBuilder modelBuilder)\r\n    {\r\n        ....\r\n        modelBuilder.ApplyConfiguration(new OrderRequirementConfiguration());\r\n        modelBuilder.ApplyConfiguration(new OrderRequirementDetailConfiguration());\r\n        modelBuilder.ApplyConfiguration(new GrowerAssignmentViewConfiguration());\r\n\r\n        modelBuilder.HasDbFunction(() => GrowerAssignmentsView(default, default, default, default, default, default))\r\n            .HasName(\"fGrowerAssignments\");\r\n        ....\r\n    }\r\n```\r\n\r\n\r\nEF Core version: 6.0.2\r\nDatabase provider: Microsoft.EntityFrameworkCore.SqlServer\r\nTarget framework: NET 6.0\r\nOperating system: Windows 11\r\nIDE: Visual Studio 2022 17.2 Preview 1\r\n","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/27621/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/27621/timeline","performed_via_github_app":null,"state_reason":"duplicate"}},"event":"cross-referenced"},{"actor":{"login":"sgaertner","id":1118920,"node_id":"MDQ6VXNlcjExMTg5MjA=","avatar_url":"https://avatars.githubusercontent.com/u/1118920?v=4","gravatar_id":"","url":"https://api.github.com/users/sgaertner","html_url":"https://github.com/sgaertner","followers_url":"https://api.github.com/users/sgaertner/followers","following_url":"https://api.github.com/users/sgaertner/following{/other_user}","gists_url":"https://api.github.com/users/sgaertner/gists{/gist_id}","starred_url":"https://api.github.com/users/sgaertner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sgaertner/subscriptions","organizations_url":"https://api.github.com/users/sgaertner/orgs","repos_url":"https://api.github.com/users/sgaertner/repos","events_url":"https://api.github.com/users/sgaertner/events{/privacy}","received_events_url":"https://api.github.com/users/sgaertner/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-06-24T08:41:25Z","updated_at":"2022-06-24T08:41:25Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/dotnet/efcore/issues/28309","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/28309/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/28309/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/28309/events","html_url":"https://github.com/dotnet/efcore/issues/28309","id":1283446137,"node_id":"I_kwDOAPaMMs5Mf9V5","number":28309,"title":"GroupBy with to-many relation leads to exception and overly complex SQL (regression since 6.0.2)","user":{"login":"sgaertner","id":1118920,"node_id":"MDQ6VXNlcjExMTg5MjA=","avatar_url":"https://avatars.githubusercontent.com/u/1118920?v=4","gravatar_id":"","url":"https://api.github.com/users/sgaertner","html_url":"https://github.com/sgaertner","followers_url":"https://api.github.com/users/sgaertner/followers","following_url":"https://api.github.com/users/sgaertner/following{/other_user}","gists_url":"https://api.github.com/users/sgaertner/gists{/gist_id}","starred_url":"https://api.github.com/users/sgaertner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sgaertner/subscriptions","organizations_url":"https://api.github.com/users/sgaertner/orgs","repos_url":"https://api.github.com/users/sgaertner/repos","events_url":"https://api.github.com/users/sgaertner/events{/privacy}","received_events_url":"https://api.github.com/users/sgaertner/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-06-24T08:41:24Z","updated_at":"2025-06-16T09:06:54Z","closed_at":"2022-06-29T08:40:01Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":16157746,"node_id":"MDEwOlJlcG9zaXRvcnkxNjE1Nzc0Ng==","name":"efcore","full_name":"dotnet/efcore","private":false,"owner":{"login":"dotnet","id":9141961,"node_id":"MDEyOk9yZ2FuaXphdGlvbjkxNDE5NjE=","avatar_url":"https://avatars.githubusercontent.com/u/9141961?v=4","gravatar_id":"","url":"https://api.github.com/users/dotnet","html_url":"https://github.com/dotnet","followers_url":"https://api.github.com/users/dotnet/followers","following_url":"https://api.github.com/users/dotnet/following{/other_user}","gists_url":"https://api.github.com/users/dotnet/gists{/gist_id}","starred_url":"https://api.github.com/users/dotnet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dotnet/subscriptions","organizations_url":"https://api.github.com/users/dotnet/orgs","repos_url":"https://api.github.com/users/dotnet/repos","events_url":"https://api.github.com/users/dotnet/events{/privacy}","received_events_url":"https://api.github.com/users/dotnet/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/dotnet/efcore","description":"EF Core is a modern object-database mapper for .NET. It supports LINQ queries, change tracking, updates, and schema migrations.","fork":false,"url":"https://api.github.com/repos/dotnet/efcore","forks_url":"https://api.github.com/repos/dotnet/efcore/forks","keys_url":"https://api.github.com/repos/dotnet/efcore/keys{/key_id}","collaborators_url":"https://api.github.com/repos/dotnet/efcore/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/dotnet/efcore/teams","hooks_url":"https://api.github.com/repos/dotnet/efcore/hooks","issue_events_url":"https://api.github.com/repos/dotnet/efcore/issues/events{/number}","events_url":"https://api.github.com/repos/dotnet/efcore/events","assignees_url":"https://api.github.com/repos/dotnet/efcore/assignees{/user}","branches_url":"https://api.github.com/repos/dotnet/efcore/branches{/branch}","tags_url":"https://api.github.com/repos/dotnet/efcore/tags","blobs_url":"https://api.github.com/repos/dotnet/efcore/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/dotnet/efcore/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/dotnet/efcore/git/refs{/sha}","trees_url":"https://api.github.com/repos/dotnet/efcore/git/trees{/sha}","statuses_url":"https://api.github.com/repos/dotnet/efcore/statuses/{sha}","languages_url":"https://api.github.com/repos/dotnet/efcore/languages","stargazers_url":"https://api.github.com/repos/dotnet/efcore/stargazers","contributors_url":"https://api.github.com/repos/dotnet/efcore/contributors","subscribers_url":"https://api.github.com/repos/dotnet/efcore/subscribers","subscription_url":"https://api.github.com/repos/dotnet/efcore/subscription","commits_url":"https://api.github.com/repos/dotnet/efcore/commits{/sha}","git_commits_url":"https://api.github.com/repos/dotnet/efcore/git/commits{/sha}","comments_url":"https://api.github.com/repos/dotnet/efcore/comments{/number}","issue_comment_url":"https://api.github.com/repos/dotnet/efcore/issues/comments{/number}","contents_url":"https://api.github.com/repos/dotnet/efcore/contents/{+path}","compare_url":"https://api.github.com/repos/dotnet/efcore/compare/{base}...{head}","merges_url":"https://api.github.com/repos/dotnet/efcore/merges","archive_url":"https://api.github.com/repos/dotnet/efcore/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/dotnet/efcore/downloads","issues_url":"https://api.github.com/repos/dotnet/efcore/issues{/number}","pulls_url":"https://api.github.com/repos/dotnet/efcore/pulls{/number}","milestones_url":"https://api.github.com/repos/dotnet/efcore/milestones{/number}","notifications_url":"https://api.github.com/repos/dotnet/efcore/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/dotnet/efcore/labels{/name}","releases_url":"https://api.github.com/repos/dotnet/efcore/releases{/id}","deployments_url":"https://api.github.com/repos/dotnet/efcore/deployments","created_at":"2014-01-23T00:52:01Z","updated_at":"2025-11-10T14:21:49Z","pushed_at":"2025-11-10T05:59:58Z","git_url":"git://github.com/dotnet/efcore.git","ssh_url":"git@github.com:dotnet/efcore.git","clone_url":"https://github.com/dotnet/efcore.git","svn_url":"https://github.com/dotnet/efcore","homepage":"https://learn.microsoft.com/ef/","size":215987,"stargazers_count":14455,"watchers_count":14455,"language":"C#","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":false,"forks_count":3324,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":2430,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["aspnet-product","c-sharp","database","dotnet-core","dotnet-framework","dotnet-standard","entity-framework","hacktoberfest","orm"],"visibility":"public","forks":3324,"open_issues":2430,"watchers":14455,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"With 6.0.2 the following code leads to an exception with Npgsql and _at least_ an overly complex SQL with other providers. All is fine with previous EF core versions (3.1, 5.0, 6.0.1). The issue is probably caused by the fix for #27102.\r\n\r\n### How to reproduce\r\n\r\nVery simple example, using the EF core tutorial model: [GroupByExists.zip](https://github.com/dotnet/efcore/files/8974370/GroupByExists.zip)\r\n\r\nThe query in question:\r\n\r\n```C#\r\n// calculate count of blogs with and without any posts\r\nvar counts = context.Blogs\r\n    .GroupBy(b => b.Posts.Any(), (k, ts) => new { Key = k, Count = ts.Count() })\r\n    .ToDictionary(t => t.Key, t => t.Count);\r\n```\r\n\r\nThis has worked flawlessly with Npgsql until EF core 6.0.1 and throws an exception with EF core 6.0.2:\r\n\r\n```\r\nfail: Microsoft.EntityFrameworkCore.Query[10100]\r\n      An exception occurred while iterating over the results of a query for context type 'GroupByExists.BloggingContext'.\r\n      Npgsql.PostgresException (0x80004005): 42803: subquery uses ungrouped column \"b.BlogId\" from outer query\r\n```\r\n\r\nThe exception is caused by an overly complex SQL, which is also generated with other providers (e.g. Sqlite).\r\n\r\n### Expected SQL (as generated until EF core 6.0.1)\r\n\r\n```SQL\r\nSELECT\r\n    EXISTS (SELECT 1 FROM \"Posts\" AS \"p\" WHERE \"b\".\"BlogId\" = \"p\".\"BlogId\") AS \"Key\",\r\n    COUNT(*) AS \"Count\"\r\nFROM \"Blogs\" AS \"b\"\r\nGROUP BY\r\n    EXISTS (SELECT 1 FROM \"Posts\" AS \"p\" WHERE \"b\".\"BlogId\" = \"p\".\"BlogId\")\r\n```\r\n\r\n### Generated SQL (since EF core 6.0.2)\r\n\r\n```SQL\r\nSELECT\r\n    EXISTS (SELECT 1 FROM \"Posts\" AS \"p\" WHERE \"b\".\"BlogId\" = \"p\".\"BlogId\") AS \"Key\",\r\n    (SELECT COUNT(*)\r\n        FROM \"Blogs\" AS \"b0\"\r\n        WHERE\r\n            EXISTS (SELECT 1 FROM \"Posts\" AS \"p0\" WHERE \"b\".\"BlogId\" = \"p0\".\"BlogId\")\r\n            = EXISTS (SELECT 1 FROM \"Posts\" AS \"p1\" WHERE \"b0\".\"BlogId\" = \"p1\".\"BlogId\")) AS \"Count\"\r\nFROM \"Blogs\" AS \"b\"\r\nGROUP BY\r\n    EXISTS (SELECT 1 FROM \"Posts\" AS \"p\" WHERE \"b\".\"BlogId\" = \"p\".\"BlogId\")\r\n```\r\n\r\nThe only difference is the `\"Count\"` calculation, which is now done with an unnecessary subquery. This subquery uses `\"b\".\"BlogId\"`, which is not grouped. It could be argued that the whole EXISTS expression **is** actually grouped, but this is at least not supported by PostgreSQL and also leads to an unnecessarily complex SQL.\r\n\r\n### Include provider and version information\r\n\r\nEF Core version: 6.0.2\r\nDatabase provider: Microsoft.EntityFrameworkCore.Sqlite, Npgsql.EntityFrameworkCore.PostgreSQL\r\nTarget framework: .NET 6.0\r\nOperating system: macOS 12.3\r\nIDE: VS code","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/28309/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/28309/timeline","performed_via_github_app":null,"state_reason":"duplicate"}},"event":"cross-referenced"},{"actor":{"login":"maumar","id":1591930,"node_id":"MDQ6VXNlcjE1OTE5MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1591930?v=4","gravatar_id":"","url":"https://api.github.com/users/maumar","html_url":"https://github.com/maumar","followers_url":"https://api.github.com/users/maumar/followers","following_url":"https://api.github.com/users/maumar/following{/other_user}","gists_url":"https://api.github.com/users/maumar/gists{/gist_id}","starred_url":"https://api.github.com/users/maumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maumar/subscriptions","organizations_url":"https://api.github.com/users/maumar/orgs","repos_url":"https://api.github.com/users/maumar/repos","events_url":"https://api.github.com/users/maumar/events{/privacy}","received_events_url":"https://api.github.com/users/maumar/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-07-13T20:12:31Z","updated_at":"2023-07-13T20:12:31Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/dotnet/efcore/issues/31255","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/31255/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/31255/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/31255/events","html_url":"https://github.com/dotnet/efcore/issues/31255","id":1802559807,"node_id":"I_kwDOAPaMMs5rcOE_","number":31255,"title":"An issue with query filtering and aggregation, after upgrading from 6.0.0 to 6.0.16","user":{"login":"NivZo","id":73710786,"node_id":"MDQ6VXNlcjczNzEwNzg2","avatar_url":"https://avatars.githubusercontent.com/u/73710786?v=4","gravatar_id":"","url":"https://api.github.com/users/NivZo","html_url":"https://github.com/NivZo","followers_url":"https://api.github.com/users/NivZo/followers","following_url":"https://api.github.com/users/NivZo/following{/other_user}","gists_url":"https://api.github.com/users/NivZo/gists{/gist_id}","starred_url":"https://api.github.com/users/NivZo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/NivZo/subscriptions","organizations_url":"https://api.github.com/users/NivZo/orgs","repos_url":"https://api.github.com/users/NivZo/repos","events_url":"https://api.github.com/users/NivZo/events{/privacy}","received_events_url":"https://api.github.com/users/NivZo/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2023-07-13T09:10:25Z","updated_at":"2024-02-04T09:31:20Z","closed_at":"2023-09-06T18:10:20Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":16157746,"node_id":"MDEwOlJlcG9zaXRvcnkxNjE1Nzc0Ng==","name":"efcore","full_name":"dotnet/efcore","private":false,"owner":{"login":"dotnet","id":9141961,"node_id":"MDEyOk9yZ2FuaXphdGlvbjkxNDE5NjE=","avatar_url":"https://avatars.githubusercontent.com/u/9141961?v=4","gravatar_id":"","url":"https://api.github.com/users/dotnet","html_url":"https://github.com/dotnet","followers_url":"https://api.github.com/users/dotnet/followers","following_url":"https://api.github.com/users/dotnet/following{/other_user}","gists_url":"https://api.github.com/users/dotnet/gists{/gist_id}","starred_url":"https://api.github.com/users/dotnet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dotnet/subscriptions","organizations_url":"https://api.github.com/users/dotnet/orgs","repos_url":"https://api.github.com/users/dotnet/repos","events_url":"https://api.github.com/users/dotnet/events{/privacy}","received_events_url":"https://api.github.com/users/dotnet/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/dotnet/efcore","description":"EF Core is a modern object-database mapper for .NET. It supports LINQ queries, change tracking, updates, and schema migrations.","fork":false,"url":"https://api.github.com/repos/dotnet/efcore","forks_url":"https://api.github.com/repos/dotnet/efcore/forks","keys_url":"https://api.github.com/repos/dotnet/efcore/keys{/key_id}","collaborators_url":"https://api.github.com/repos/dotnet/efcore/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/dotnet/efcore/teams","hooks_url":"https://api.github.com/repos/dotnet/efcore/hooks","issue_events_url":"https://api.github.com/repos/dotnet/efcore/issues/events{/number}","events_url":"https://api.github.com/repos/dotnet/efcore/events","assignees_url":"https://api.github.com/repos/dotnet/efcore/assignees{/user}","branches_url":"https://api.github.com/repos/dotnet/efcore/branches{/branch}","tags_url":"https://api.github.com/repos/dotnet/efcore/tags","blobs_url":"https://api.github.com/repos/dotnet/efcore/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/dotnet/efcore/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/dotnet/efcore/git/refs{/sha}","trees_url":"https://api.github.com/repos/dotnet/efcore/git/trees{/sha}","statuses_url":"https://api.github.com/repos/dotnet/efcore/statuses/{sha}","languages_url":"https://api.github.com/repos/dotnet/efcore/languages","stargazers_url":"https://api.github.com/repos/dotnet/efcore/stargazers","contributors_url":"https://api.github.com/repos/dotnet/efcore/contributors","subscribers_url":"https://api.github.com/repos/dotnet/efcore/subscribers","subscription_url":"https://api.github.com/repos/dotnet/efcore/subscription","commits_url":"https://api.github.com/repos/dotnet/efcore/commits{/sha}","git_commits_url":"https://api.github.com/repos/dotnet/efcore/git/commits{/sha}","comments_url":"https://api.github.com/repos/dotnet/efcore/comments{/number}","issue_comment_url":"https://api.github.com/repos/dotnet/efcore/issues/comments{/number}","contents_url":"https://api.github.com/repos/dotnet/efcore/contents/{+path}","compare_url":"https://api.github.com/repos/dotnet/efcore/compare/{base}...{head}","merges_url":"https://api.github.com/repos/dotnet/efcore/merges","archive_url":"https://api.github.com/repos/dotnet/efcore/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/dotnet/efcore/downloads","issues_url":"https://api.github.com/repos/dotnet/efcore/issues{/number}","pulls_url":"https://api.github.com/repos/dotnet/efcore/pulls{/number}","milestones_url":"https://api.github.com/repos/dotnet/efcore/milestones{/number}","notifications_url":"https://api.github.com/repos/dotnet/efcore/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/dotnet/efcore/labels{/name}","releases_url":"https://api.github.com/repos/dotnet/efcore/releases{/id}","deployments_url":"https://api.github.com/repos/dotnet/efcore/deployments","created_at":"2014-01-23T00:52:01Z","updated_at":"2025-11-10T14:21:49Z","pushed_at":"2025-11-10T05:59:58Z","git_url":"git://github.com/dotnet/efcore.git","ssh_url":"git@github.com:dotnet/efcore.git","clone_url":"https://github.com/dotnet/efcore.git","svn_url":"https://github.com/dotnet/efcore","homepage":"https://learn.microsoft.com/ef/","size":215987,"stargazers_count":14455,"watchers_count":14455,"language":"C#","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":false,"forks_count":3324,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":2430,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["aspnet-product","c-sharp","database","dotnet-core","dotnet-framework","dotnet-standard","entity-framework","hacktoberfest","orm"],"visibility":"public","forks":3324,"open_issues":2430,"watchers":14455,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"Hello,\r\n\r\nWe recently upgraded `Microsoft.EntitiyFrameworkCore.SqlServer` from 6.0.0 to 6.0.2, and it seems like this caused a regression n an unchanged part of our code.\r\n\r\n```C#\r\n// The EventTable decleration\r\npublic DbSet<EventTableEntity> EventTable { get; set; }\r\n// ---------------------------------------------------------------------\r\n// When the table context (`ctx` below) is created, it is done with:\r\nmodelBuilder.Entity<EventTableEntity>()\r\n                .HasQueryFilter(ConvertFilterExpression(this.IsEventReadableExpression<EventScope>(), typeof(EventTableEntity)));\r\n// IsEventReadableExpression is intended to filter EventTable entities based on user permissions and roles.\r\n// ---------------------------------------------------------------------\r\n// The failing code\r\nawait someFilterFunction(ctx.EventTable\r\n                .AsNoTracking()\r\n                .Where(event => event.FirstSeen >= date.AddHours(-1 * lookbackInHours) && event.FirstSeen < date))\r\n                .GroupBy(event => (EF.Functions.DateDiffDay(lookbackTimestamp, event.FirstSeen) * MinutesInDay)\r\n                    + (event.FirstSeen.Value.Hour * MinutesInHour)\r\n                    + ((event.FirstSeen.Value.Minute / 10) * 10))\r\n                .Select(g => new { key = g.Key, count = g.Count() })\r\n                .ToListAsync();\r\n```\r\n\r\nI want to emphasize that we didnt change the code at all, only upgraded nugets. From some reason, it seems EF doesnt succeed to deal with the count aggregation as it did before.\r\n\r\nBelow is the succeeding SQL query that was the result of the code running with version 6.0.0:\r\n```SQL\r\nDECLARE @__lookbackTimestamp_3 datetime2 = '2023-07-10T07:40:00.000';\r\nDECLARE @__ef_filter__p_0 smallint = 32;\r\nDECLARE @__ef_filter__p_1 bit = 0;\r\nDECLARE @__ef_filter__ProductsUserIsScopedIn_3 smallint = 32;\r\nDECLARE @__AddHours_0 datetime2 = '2023-07-10T07:43:17.318';\r\nDECLARE @__date_1 datetime2 = '2023-07-11T07:43:17.318';\r\n\r\nexec sys.sp_set_session_context @key = N'IsExposedToAllProducts', @value = 1;\r\nexec sys.sp_set_session_context @key = N'ProductContext', @value = 'Mtp';\r\n\r\n\r\nSELECT ((DATEDIFF(day, @__lookbackTimestamp_3, [r].[FirstSeen]) * 1440) + (DATEPART(hour, [r].[FirstSeen]) * 60)) + ((DATEPART(minute, [r].[FirstSeen]) / 10) * 10) AS [key], COUNT(*) AS [count]\r\nFROM [Tenant1].[EventTable] AS [r]\r\nWHERE (((@__ef_filter__p_0 & [r].[BitwiseProducts]) = [r].[BitwiseProducts]) AND ((((@__ef_filter__p_1 = CAST(1 AS bit)) OR [r].[ServiceSource] NOT IN (128, 16)) OR (([r].[BitwiseProducts] & @__ef_filter__ProductsUserIsScopedIn_3) = CAST(0 AS smallint))) OR (\r\n    SELECT TOP(1) [a].[EventId]\r\n    FROM [Tenant1].[EventScopes] AS [a]\r\n    WHERE ([r].[EventId] = [a].[EventId]) AND [a].[EvidenceId] IS NULL\r\n    GROUP BY [a].[EventId]\r\n    HAVING COUNT(DISTINCT (CASE\r\n        WHEN CASE\r\n            WHEN ([a].[ScopeType] = CAST(1 AS tinyint)) AND ([a].[ScopeValue] <> 'Dlp_AdminUnits_1') THEN CAST(0 AS tinyint)\r\n            ELSE [a].[ScopeType]\r\n        END <> CAST(0 AS tinyint) THEN CASE\r\n            WHEN ([a].[ScopeType] = CAST(1 AS tinyint)) AND ([a].[ScopeValue] <> 'Dlp_AdminUnits_1') THEN CAST(0 AS tinyint)\r\n            ELSE [a].[ScopeType]\r\n        END\r\n    END)) = COUNT(DISTINCT ([a].[ScopeType]))) IS NOT NULL)) AND (([r].[FirstSeen] >= @__AddHours_0) AND ([r].[FirstSeen] < @__date_1))\r\nGROUP BY ((DATEDIFF(day, @__lookbackTimestamp_3, [r].[FirstSeen]) * 1440) + (DATEPART(hour, [r].[FirstSeen]) * 60)) + ((DATEPART(minute, [r].[FirstSeen]) / 10) * 10)\r\n```\r\n\r\nAnd there's the failing SQL query that was the result of the code running with version 6.0.2:\r\n```SQL\r\nDECLARE @__lookbackTimestamp_3 datetime2 = '2023-07-10T10:20:00.000';\r\nDECLARE @__ef_filter__p_0 smallint = 32;\r\nDECLARE @__ef_filter__p_1 bit = 0;\r\nDECLARE @__ef_filter__ProductsUserIsScopedIn_3 smallint = 32;\r\nDECLARE @__AddHours_0 datetime2 = '2023-07-10T10:25:23.694';\r\nDECLARE @__date_1 datetime2 = '2023-07-11T10:25:23.694';\r\n\r\nexec sys.sp_set_session_context @key = N'IsExposedToAllProducts', @value = 1;\r\nexec sys.sp_set_session_context @key = N'ProductContext', @value = 'Mtp';\r\nSELECT ((DATEDIFF(day, @__lookbackTimestamp_3, [r].[FirstSeen]) * 1440) + (DATEPART(hour, [r].[FirstSeen]) * 60)) + ((DATEPART(minute, [r].[FirstSeen]) / 10) * 10) AS [key], (\r\n    SELECT COUNT(*)\r\n    FROM [Tenant1].[EventTable] AS [r0]\r\n    WHERE ((((@__ef_filter__p_0 & [r0].[BitwiseProducts]) = [r0].[BitwiseProducts]) AND ((((@__ef_filter__p_1 = CAST(1 AS bit)) OR [r0].[ServiceSource] NOT IN (128, 16)) OR (([r0].[BitwiseProducts] & @__ef_filter__ProductsUserIsScopedIn_3) = CAST(0 AS smallint))) OR ((\r\n        SELECT TOP(1) [a0].[EventId]\r\n        FROM [Tenant1].[EventScopes] AS [a0]\r\n        WHERE ([r0].[EventId] = [a0].[EventId]) AND ([a0].[EvidenceId] IS NULL)\r\n        GROUP BY [a0].[EventId]\r\n        HAVING COUNT(DISTINCT (CASE\r\n            WHEN CASE\r\n                WHEN ([a0].[ScopeType] = CAST(1 AS tinyint)) AND ([a0].[ScopeValue] <> 'Dlp_AdminUnits_1') THEN CAST(0 AS tinyint)\r\n                ELSE [a0].[ScopeType]\r\n            END <> CAST(0 AS tinyint) THEN CASE\r\n                WHEN ([a0].[ScopeType] = CAST(1 AS tinyint)) AND ([a0].[ScopeValue] <> 'Dlp_AdminUnits_1') THEN CAST(0 AS tinyint)\r\n                ELSE [a0].[ScopeType]\r\n            END\r\n        END)) = COUNT(DISTINCT ([a0].[ScopeType]))) IS NOT NULL))) AND (([r0].[FirstSeen] >= @__AddHours_0) AND ([r0].[FirstSeen] < @__date_1))) AND (((((DATEDIFF(day, @__lookbackTimestamp_3, [r].[FirstSeen]) * 1440) + (DATEPART(hour, [r].[FirstSeen]) * 60)) + ((DATEPART(minute, [r].[FirstSeen]) / 10) * 10)) = (((DATEDIFF(day, @__lookbackTimestamp_3, [r0].[FirstSeen]) * 1440) + (DATEPART(hour, [r0].[FirstSeen]) * 60)) + ((DATEPART(minute, [r0].[FirstSeen]) / 10) * 10))) OR (([r].[FirstSeen] IS NULL) AND ([r0].[FirstSeen] IS NULL)))) AS [count]\r\nFROM [Tenant1].[EventTable] AS [r]\r\nWHERE (((@__ef_filter__p_0 & [r].[BitwiseProducts]) = [r].[BitwiseProducts]) AND ((((@__ef_filter__p_1 = CAST(1 AS bit)) OR [r].[ServiceSource] NOT IN (128, 16)) OR (([r].[BitwiseProducts] & @__ef_filter__ProductsUserIsScopedIn_3) = CAST(0 AS smallint))) OR ((\r\n    SELECT TOP(1) [a].[EventId]\r\n    FROM [Tenant1].[EventScopes] AS [a]\r\n    WHERE ([r].[EventId] = [a].[EventId]) AND ([a].[EvidenceId] IS NULL)\r\n    GROUP BY [a].[EventId]\r\n    HAVING COUNT(DISTINCT (CASE\r\n        WHEN CASE\r\n            WHEN ([a].[ScopeType] = CAST(1 AS tinyint)) AND ([a].[ScopeValue] <> 'Dlp_AdminUnits_1') THEN CAST(0 AS tinyint)\r\n            ELSE [a].[ScopeType]\r\n        END <> CAST(0 AS tinyint) THEN CASE\r\n            WHEN ([a].[ScopeType] = CAST(1 AS tinyint)) AND ([a].[ScopeValue] <> 'Dlp_AdminUnits_1') THEN CAST(0 AS tinyint)\r\n            ELSE [a].[ScopeType]\r\n        END\r\n    END)) = COUNT(DISTINCT ([a].[ScopeType]))) IS NOT NULL))) AND (([r].[FirstSeen] >= @__AddHours_0) AND ([r].[FirstSeen] < @__date_1))\r\nGROUP BY ((DATEDIFF(day, @__lookbackTimestamp_3, [r].[FirstSeen]) * 1440) + (DATEPART(hour, [r].[FirstSeen]) * 60)) + ((DATEPART(minute, [r].[FirstSeen]) / 10) * 10)\r\n```\r\n\r\nAs you'll be able to find out from the examples above, the part that differs between the queries is `count = g.Count()` in the EFC code that's mapped to `COUNT(*) AS [count]` in the resulting working SQL query, but on the failed one, it's mapped to an entire subquery that is failing (and looks somewhat like a duplicate of other parts of the query). \r\n\r\nThanks in advance.\r\n\r\nP.S.\r\nWe actually updated to version 6.0.16 in the beginning, which is also the version that resulted in the failed query above.\r\nHowever, our testing shows that the issue actually emerged in version 6.0.2 and not 6.0.16, which is why I chose to mention 6.0.2 throughout the issue.","reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/31255/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/31255/timeline","performed_via_github_app":null,"state_reason":"not_planned"}},"event":"cross-referenced"},{"id":18158717877,"node_id":"UNLE_lADOAPaMMs5BIOHqzwAAAAQ6WAu1","url":"https://api.github.com/repos/dotnet/efcore/issues/events/18158717877","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"unlabeled","commit_id":null,"commit_url":null,"created_at":"2025-06-15T18:44:39Z","label":{"name":"type-bug","color":"f7c6c7"},"performed_via_github_app":null},{"id":18158717998,"node_id":"ITAE_lADOAPaMMs5BIOHqzwAAAAQ6WAwu","url":"https://api.github.com/repos/dotnet/efcore/issues/events/18158717998","actor":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"issue_type_added","commit_id":null,"commit_url":null,"created_at":"2025-06-15T18:44:40Z","performed_via_github_app":null}]