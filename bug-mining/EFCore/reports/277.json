{"url":"https://api.github.com/repos/dotnet/efcore/issues/31782","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/31782/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/31782/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/31782/events","html_url":"https://github.com/dotnet/efcore/issues/31782","id":1900070168,"node_id":"I_kwDOAPaMMs5xQMUY","number":31782,"title":"Possible finalizer thread stuck on System.RuntimeMethodHandle.Destroy","user":{"login":"vtortola","id":704420,"node_id":"MDQ6VXNlcjcwNDQyMA==","avatar_url":"https://avatars.githubusercontent.com/u/704420?v=4","gravatar_id":"","url":"https://api.github.com/users/vtortola","html_url":"https://github.com/vtortola","followers_url":"https://api.github.com/users/vtortola/followers","following_url":"https://api.github.com/users/vtortola/following{/other_user}","gists_url":"https://api.github.com/users/vtortola/gists{/gist_id}","starred_url":"https://api.github.com/users/vtortola/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vtortola/subscriptions","organizations_url":"https://api.github.com/users/vtortola/orgs","repos_url":"https://api.github.com/users/vtortola/repos","events_url":"https://api.github.com/users/vtortola/events{/privacy}","received_events_url":"https://api.github.com/users/vtortola/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":130861068,"node_id":"MDU6TGFiZWwxMzA4NjEwNjg=","url":"https://api.github.com/repos/dotnet/efcore/labels/area-perf","name":"area-perf","color":"5319e7","default":false,"description":""},{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1017558838,"node_id":"MDU6TGFiZWwxMDE3NTU4ODM4","url":"https://api.github.com/repos/dotnet/efcore/labels/Servicing-approved","name":"Servicing-approved","color":"048708","default":false,"description":""},{"id":1675384372,"node_id":"MDU6TGFiZWwxNjc1Mzg0Mzcy","url":"https://api.github.com/repos/dotnet/efcore/labels/area-query","name":"area-query","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"roji","id":1862641,"node_id":"MDQ6VXNlcjE4NjI2NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1862641?v=4","gravatar_id":"","url":"https://api.github.com/users/roji","html_url":"https://github.com/roji","followers_url":"https://api.github.com/users/roji/followers","following_url":"https://api.github.com/users/roji/following{/other_user}","gists_url":"https://api.github.com/users/roji/gists{/gist_id}","starred_url":"https://api.github.com/users/roji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roji/subscriptions","organizations_url":"https://api.github.com/users/roji/orgs","repos_url":"https://api.github.com/users/roji/repos","events_url":"https://api.github.com/users/roji/events{/privacy}","received_events_url":"https://api.github.com/users/roji/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/182","html_url":"https://github.com/dotnet/efcore/milestone/182","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/182/labels","id":9968313,"node_id":"MI_kwDOAPaMMs4AmBq5","number":182,"title":"6.0.24","description":null,"creator":{"login":"rbhanda","id":30737530,"node_id":"MDQ6VXNlcjMwNzM3NTMw","avatar_url":"https://avatars.githubusercontent.com/u/30737530?v=4","gravatar_id":"","url":"https://api.github.com/users/rbhanda","html_url":"https://github.com/rbhanda","followers_url":"https://api.github.com/users/rbhanda/followers","following_url":"https://api.github.com/users/rbhanda/following{/other_user}","gists_url":"https://api.github.com/users/rbhanda/gists{/gist_id}","starred_url":"https://api.github.com/users/rbhanda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rbhanda/subscriptions","organizations_url":"https://api.github.com/users/rbhanda/orgs","repos_url":"https://api.github.com/users/rbhanda/repos","events_url":"https://api.github.com/users/rbhanda/events{/privacy}","received_events_url":"https://api.github.com/users/rbhanda/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":3,"state":"closed","created_at":"2023-09-26T17:20:33Z","updated_at":"2023-11-14T13:46:08Z","due_on":null,"closed_at":"2023-11-14T13:46:08Z"},"comments":26,"created_at":"2023-09-13T10:54:01Z","updated_at":"2025-06-15T19:51:43Z","closed_at":"2023-10-05T15:49:22Z","author_association":"NONE","type":{"id":1092406,"node_id":"IT_kwDOAIt-yc4AEKs2","name":"Feature","description":"A request, idea, or new functionality","color":"blue","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-10-08T09:10:05Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description\r\n\r\nWhen a single application instance reaches ~1700 Rps and ~85% Cpu usage during a short period of time due a traffic spike, around a 25% of our servers experiment what it seems to be a blockage in the finalizer thread and the application starts hoarding memory and increasing latency. Eventually we have to kill the server when memory is at 10X of what it uses normally and latency is not acceptable.\r\n\r\nExploring with dotnet-dump, we see that after the requests spike the finalizer queue starts to accumulate objects.  Taking multiple dumps shows that the \"Ready for finalization\" keep growing in each heap.\r\n\r\nWhen exploring the threads, there is always a thread `0x001B` that is stuck in this frame:\r\n\r\n```\r\n> clrstack -a                                                                                                                                                                                                                     \r\nOS Thread Id: 0x1b (21)\r\n        Child SP               IP Call Site\r\n00007F0002EC9930 00007f00081947b2 [InlinedCallFrame: 00007f0002ec9930] \r\n00007F0002EC9930 00007eff88696957 [InlinedCallFrame: 00007f0002ec9930] \r\n00007F0002EC9920 00007EFF88696957 System.RuntimeMethodHandle.Destroy(System.RuntimeMethodHandleInternal)\r\n    PARAMETERS:\r\n        method = <no data>\r\n\r\n00007F0002EC99C0 00007EFF9623E087 System.Reflection.Emit.DynamicResolver+DestroyScout.Finalize() [/_/src/coreclr/System.Private.CoreLib/src/System/Reflection/Emit/DynamicILGenerator.cs @ 669]\r\n    PARAMETERS:\r\n        this = <no data>\r\n\r\n00007F0002EC9D30 00007f0007957cc6 [DebuggerU2MCatchHandlerFrame: 00007f0002ec9d30] \r\n```\r\nIf I take a dump 30 minutes later, it still shows this frame with this same data in this thread.\r\n\r\n\r\nThose servers keep having a higher % of time in GC\r\n![image](https://github.com/dotnet/runtime/assets/704420/16f7269a-e55a-4437-91cd-7e0d07c5be42)\r\n\r\n### Configuration\r\n\r\nServer is an Azure [Standard_F16s_v2](https://learn.microsoft.com/en-us/azure/virtual-machines/fsv2-series) (16 cores, 32 GiB RAM).\r\n\r\nDocker image `mcr.microsoft.com/dotnet/aspnet:7.0.11`.\r\n\r\n```\r\n# dotnet --info                                                                                                                                                                               \r\n\r\nHost:\r\n  Version:      7.0.11\r\n  Architecture: x64\r\n  Commit:       ecb34f85ec\r\n\r\n.NET SDKs installed:\r\n  No SDKs were found.\r\n\r\n.NET runtimes installed:\r\n  Microsoft.AspNetCore.App 7.0.11 [/usr/share/dotnet/shared/Microsoft.AspNetCore.App]\r\n  Microsoft.NETCore.App 7.0.11 [/usr/share/dotnet/shared/Microsoft.NETCore.App]\r\n\r\n```\r\n\r\n```\r\n# uname -a\r\nLinux live-api-75fcf998d-hcwvz 5.15.0-1041-azure dotnet/runtime#48-Ubuntu SMP Tue Jun 20 20:34:08 UTC 2023 x86_64 GNU/Linux\r\n```\r\n\r\n### Regression?\r\n\r\nWe are not completely sure, but we have the feeling it started happening when we moved to .NET7 from .NET6.\r\nWhen we were in .NET6 we did not do see this kind of situation. After we moved to .NET7 we started seeing some machines using an unexpected big amount of memory that starts on a traffic spike situation.\r\n\r\n### Data\r\n\r\n```\r\n> syncblk                                                                                                                                                                                                                         \r\nIndex         SyncBlock MonitorHeld Recursion Owning Thread Info          SyncBlock Owner\r\n-----------------------------\r\nTotal           2661\r\nFree            793\r\n\r\n```\r\n\r\n```\r\n> finalizequeue -stat                                                                                                                                                                                                             \r\nSyncBlocks to be cleaned up: 0\r\nFree-Threaded Interfaces to be released: 0\r\nMTA Interfaces to be released: 0\r\nSTA Interfaces to be released: 0\r\n----------------------------------\r\n\r\nHeap 0\r\ngeneration 0 has 29 objects (7ef79c121920->7ef79c121a08)\r\ngeneration 1 has 2,464 objects (7ef79c11cc20->7ef79c121920)\r\ngeneration 2 has 0 objects (7ef79c11cc20->7ef79c11cc20)\r\nReady for finalization 560 objects (7ef79c123438->7ef79c1245b8)\r\n------------------------------\r\nHeap 1\r\ngeneration 0 has 5 objects (7ef5f820ada8->7ef5f820add0)\r\ngeneration 1 has 2,013 objects (7ef5f8206ec0->7ef5f820ada8)\r\ngeneration 2 has 0 objects (7ef5f8206ec0->7ef5f8206ec0)\r\nReady for finalization 309 objects (7ef5f820b480->7ef5f820be28)\r\n------------------------------\r\nHeap 2\r\ngeneration 0 has 7 objects (7ef5bc101488->7ef5bc1014c0)\r\ngeneration 1 has 1,409 objects (7ef5bc0fe880->7ef5bc101488)\r\ngeneration 2 has 0 objects (7ef5bc0fe880->7ef5bc0fe880)\r\nReady for finalization 321 objects (7ef5bc101ea0->7ef5bc1028a8)\r\n------------------------------\r\nHeap 3\r\ngeneration 0 has 14 objects (7ef6142535b8->7ef614253628)\r\ngeneration 1 has 1,295 objects (7ef614250d40->7ef6142535b8)\r\ngeneration 2 has 0 objects (7ef614250d40->7ef614250d40)\r\nReady for finalization 321 objects (7ef6142540a0->7ef614254aa8)\r\n------------------------------\r\nHeap 4\r\ngeneration 0 has 2 objects (7ef7a0bbfa88->7ef7a0bbfa98)\r\ngeneration 1 has 729 objects (7ef7a0bbe3c0->7ef7a0bbfa88)\r\ngeneration 2 has 0 objects (7ef7a0bbe3c0->7ef7a0bbe3c0)\r\nReady for finalization 322 objects (7ef7a0bc05c0->7ef7a0bc0fd0)\r\n------------------------------\r\nHeap 5\r\ngeneration 0 has 10 objects (7eff84129200->7eff84129250)\r\ngeneration 1 has 992 objects (7eff84127300->7eff84129200)\r\ngeneration 2 has 0 objects (7eff84127300->7eff84127300)\r\nReady for finalization 388 objects (7eff84129bd0->7eff8412a7f0)\r\n------------------------------\r\nHeap 6\r\ngeneration 0 has 5 objects (7ef694166578->7ef6941665a0)\r\ngeneration 1 has 1,511 objects (7ef694163640->7ef694166578)\r\ngeneration 2 has 0 objects (7ef694163640->7ef694163640)\r\nReady for finalization 339 objects (7ef694166fa8->7ef694167a40)\r\n------------------------------\r\nHeap 7\r\ngeneration 0 has 2 objects (7ef65c27acc0->7ef65c27acd0)\r\ngeneration 1 has 1,692 objects (7ef65c2777e0->7ef65c27acc0)\r\ngeneration 2 has 0 objects (7ef65c2777e0->7ef65c2777e0)\r\nReady for finalization 316 objects (7ef65c27b690->7ef65c27c070)\r\n------------------------------\r\nHeap 8\r\ngeneration 0 has 5 objects (7ef79c180c20->7ef79c180c48)\r\ngeneration 1 has 594 objects (7ef79c17f990->7ef79c180c20)\r\ngeneration 2 has 0 objects (7ef79c17f990->7ef79c17f990)\r\nReady for finalization 376 objects (7ef79c1818f0->7ef79c1824b0)\r\n------------------------------\r\nHeap 9\r\ngeneration 0 has 7 objects (7ef770377290->7ef7703772c8)\r\ngeneration 1 has 832 objects (7ef770375890->7ef770377290)\r\ngeneration 2 has 0 objects (7ef770375890->7ef770375890)\r\nReady for finalization 388 objects (7ef770377bd0->7ef7703787f0)\r\n------------------------------\r\nHeap 10\r\ngeneration 0 has 10 objects (7ef79c245ce0->7ef79c245d30)\r\ngeneration 1 has 804 objects (7ef79c2443c0->7ef79c245ce0)\r\ngeneration 2 has 0 objects (7ef79c2443c0->7ef79c2443c0)\r\nReady for finalization 390 objects (7ef79c246408->7ef79c247038)\r\n------------------------------\r\nHeap 11\r\ngeneration 0 has 8 objects (7ef6881c80c8->7ef6881c8108)\r\ngeneration 1 has 1,297 objects (7ef6881c5840->7ef6881c80c8)\r\ngeneration 2 has 0 objects (7ef6881c5840->7ef6881c5840)\r\nReady for finalization 327 objects (7ef6881c8b78->7ef6881c95b0)\r\n------------------------------\r\nHeap 12\r\ngeneration 0 has 10 objects (7ef79c2af180->7ef79c2af1d0)\r\ngeneration 1 has 2,222 objects (7ef79c2aac10->7ef79c2af180)\r\ngeneration 2 has 0 objects (7ef79c2aac10->7ef79c2aac10)\r\nReady for finalization 485 objects (7ef79c2afc38->7ef79c2b0b60)\r\n------------------------------\r\nHeap 13\r\ngeneration 0 has 13 objects (7ef74815af60->7ef74815afc8)\r\ngeneration 1 has 350 objects (7ef74815a470->7ef74815af60)\r\ngeneration 2 has 0 objects (7ef74815a470->7ef74815a470)\r\nReady for finalization 329 objects (7ef74815b948->7ef74815c390)\r\n------------------------------\r\nHeap 14\r\ngeneration 0 has 8 objects (7ef79c79e070->7ef79c79e0b0)\r\ngeneration 1 has 322 objects (7ef79c79d660->7ef79c79e070)\r\ngeneration 2 has 0 objects (7ef79c79d660->7ef79c79d660)\r\nReady for finalization 25,489 objects (7ef79c79e9b8->7ef79c7d0640)\r\n------------------------------\r\nHeap 15\r\ngeneration 0 has 7 objects (7ef6802dadd0->7ef6802dae08)\r\ngeneration 1 has 508 objects (7ef6802d9df0->7ef6802dadd0)\r\ngeneration 2 has 0 objects (7ef6802d9df0->7ef6802d9df0)\r\nReady for finalization 404,766 objects (7ef6802db588->7ef6805f1e78)\r\n------------------------------\r\nStatistics for all finalizable objects (including all objects ready for finalization):\r\nStatistics:\r\n          MT   Count  TotalSize Class Name\r\n\r\n[...]\r\n\r\n7eff8de90098     538     17,216 Microsoft.Win32.SafeHandles.SafeEvpMdCtxHandle\r\n7eff917fa6f8      70     18,480 Microsoft.Data.SqlClient.SNI.SNISslStream\r\n7eff90117f28     355     19,880 System.Runtime.CompilerServices.ConditionalWeakTable<System.Text.Json.JsonSerializerOptions, System.Object>+Container\r\n7eff9433c1f0     361     20,216 System.IO.Compression.Deflater\r\n7eff8c2c7b88     316     20,224 System.Net.Sockets.SafeSocketHandle\r\n7eff8d8ce2c8     663     21,216 Microsoft.Win32.SafeHandles.SafeX509Handle\r\n7eff8d830920   1,255     30,120 System.Threading.TimerHolder\r\n7eff9433efe8     394     31,520 System.IO.Compression.ZLibNative+ZLibStreamHandle\r\n7eff8c2c5228     316     37,920 System.Net.Sockets.Socket\r\n7eff927f5370     180     44,640 Microsoft.AspNetCore.Server.Kestrel.Transport.Sockets.Internal.SocketReceiver\r\n7eff8d859958     223     62,440 System.Net.Sockets.Socket+AwaitableSocketAsyncEventArgs\r\n7eff9146acb8     389     80,912 Microsoft.Data.SqlClient.SqlConnection\r\n7eff9149f348     980    290,080 Microsoft.Data.SqlClient.SqlCommand\r\n7eff89253d70   4,192    301,824 System.Threading.Thread\r\n7eff90b81468 247,708  5,944,992 System.Reflection.Emit.DynamicResolver+DestroyScout\r\n7eff8ad24450 199,413 14,357,736 System..Reflection.Emit.DynamicResolver\r\nTotal 460,012 objects, 21,441,768 bytes\r\n```\r\n\r\n```\r\n> dumpheap -stat\r\n\r\n[...]\r\n\r\n7eff8acfc688   207,010   9,936,480 System.Reflection.Emit.DynamicMethod+RTDynamicMethod\r\n7eff8ad200a8   207,010   9,936,480 System.Reflection.Emit.ScopeTree\r\n7eff8acfcf68   208,325   9,999,600 System.Reflection.Emit.SignatureHelper\r\n7eff8919ec38   605,088  14,522,112 System.RuntimeTypeHandle\r\n7eff8ad24450   207,001  14,904,072 System.Reflection.Emit.DynamicResolver\r\n7eff89817a20   212,441  20,394,336 System.RuntimeMethodInfoStub\r\n7eff8acfbda0   207,010  23,185,120 System.Reflection.Emit.DynamicMethod\r\n7eff8912a508   358,123  25,959,536 System.Object[]\r\n7eff8acfb6e8   207,010  31,465,520 System.Reflection.Emit.DynamicILGenerator\r\n7eff89251038 1,241,746 120,095,736 System.String\r\n7eff89773338 1,070,259 136,469,834 System.Byte[]\r\n7eff892b7aa8    90,512 260,066,802 System.Char[]\r\n55fb5eb4e900    55,769 364,019,016 Free\r\nTotal 10,141,843 objects, 1,321,079,065 bytes\r\n```\r\n\r\n```\r\n[System.Runtime]\r\n    % Time in GC since last GC (%)                                         5    \r\n    Allocation Rate (B / 1 sec)                                       6.2155e+08   \r\n    CPU Usage (%)                                                         57.81 \r\n    Exception Count (Count / 1 sec)                                       94    \r\n    GC Committed Bytes (MB)                                            1,675.366\r\n    GC Fragmentation (%)                                                  44.356\r\n    GC Heap Size (MB)                                                    637.815\r\n    Gen 0 GC Count (Count / 1 sec)                                         2    \r\n    Gen 0 Size (B)                                                 4,236,872    \r\n    Gen 1 GC Count (Count / 1 sec)                                         1    \r\n    Gen 1 Size (B)                                                11,126,616    \r\n    Gen 2 GC Count (Count / 1 sec)                                         0    \r\n    Gen 2 Size (B)                                                    5.2245e+08   \r\n    IL Bytes Jitted (B)                                               3.1923e+08   \r\n    LOH Size (B)                                                      5.7157e+08   \r\n    Monitor Lock Contention Count (Count / 1 sec)                      1,212    \r\n    Number of Active Timers                                               46    \r\n    Number of Assemblies Loaded                                          252    \r\n    Number of Methods Jitted                                       9,647,443    \r\n    POH (Pinned Object Heap) Size (B)                              4,465,760    \r\n    ThreadPool Completed Work Item Count (Count / 1 sec)              23,982    \r\n```\r\n","closed_by":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/31782/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/31782/timeline","performed_via_github_app":null,"state_reason":"completed"}