{"url":"https://api.github.com/repos/dotnet/efcore/issues/32730","repository_url":"https://api.github.com/repos/dotnet/efcore","labels_url":"https://api.github.com/repos/dotnet/efcore/issues/32730/labels{/name}","comments_url":"https://api.github.com/repos/dotnet/efcore/issues/32730/comments","events_url":"https://api.github.com/repos/dotnet/efcore/issues/32730/events","html_url":"https://github.com/dotnet/efcore/issues/32730","id":2067587073,"node_id":"I_kwDOAPaMMs57POAB","number":32730,"title":"SQL Server Migrations - SqlOperation.Sql is stripped of all empty lines","user":{"login":"sergeitemkin","id":12854677,"node_id":"MDQ6VXNlcjEyODU0Njc3","avatar_url":"https://avatars.githubusercontent.com/u/12854677?v=4","gravatar_id":"","url":"https://api.github.com/users/sergeitemkin","html_url":"https://github.com/sergeitemkin","followers_url":"https://api.github.com/users/sergeitemkin/followers","following_url":"https://api.github.com/users/sergeitemkin/following{/other_user}","gists_url":"https://api.github.com/users/sergeitemkin/gists{/gist_id}","starred_url":"https://api.github.com/users/sergeitemkin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sergeitemkin/subscriptions","organizations_url":"https://api.github.com/users/sergeitemkin/orgs","repos_url":"https://api.github.com/users/sergeitemkin/repos","events_url":"https://api.github.com/users/sergeitemkin/events{/privacy}","received_events_url":"https://api.github.com/users/sergeitemkin/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":936619505,"node_id":"MDU6TGFiZWw5MzY2MTk1MDU=","url":"https://api.github.com/repos/dotnet/efcore/labels/customer-reported","name":"customer-reported","color":"a4a5f9","default":false,"description":""},{"id":1017558838,"node_id":"MDU6TGFiZWwxMDE3NTU4ODM4","url":"https://api.github.com/repos/dotnet/efcore/labels/Servicing-approved","name":"Servicing-approved","color":"048708","default":false,"description":""},{"id":1900942474,"node_id":"MDU6TGFiZWwxOTAwOTQyNDc0","url":"https://api.github.com/repos/dotnet/efcore/labels/area-migrations","name":"area-migrations","color":"32b37b","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/dotnet/efcore/milestones/188","html_url":"https://github.com/dotnet/efcore/milestone/188","labels_url":"https://api.github.com/repos/dotnet/efcore/milestones/188/labels","id":10432910,"node_id":"MI_kwDOAPaMMs4AnzGO","number":188,"title":"8.0.3","description":null,"creator":{"login":"AndriySvyryd","id":6539701,"node_id":"MDQ6VXNlcjY1Mzk3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/6539701?v=4","gravatar_id":"","url":"https://api.github.com/users/AndriySvyryd","html_url":"https://github.com/AndriySvyryd","followers_url":"https://api.github.com/users/AndriySvyryd/followers","following_url":"https://api.github.com/users/AndriySvyryd/following{/other_user}","gists_url":"https://api.github.com/users/AndriySvyryd/gists{/gist_id}","starred_url":"https://api.github.com/users/AndriySvyryd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndriySvyryd/subscriptions","organizations_url":"https://api.github.com/users/AndriySvyryd/orgs","repos_url":"https://api.github.com/users/AndriySvyryd/repos","events_url":"https://api.github.com/users/AndriySvyryd/events{/privacy}","received_events_url":"https://api.github.com/users/AndriySvyryd/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":22,"state":"closed","created_at":"2024-01-18T01:09:32Z","updated_at":"2024-04-09T08:41:20Z","due_on":null,"closed_at":"2024-04-09T08:41:20Z"},"comments":0,"created_at":"2024-01-05T15:56:23Z","updated_at":"2025-06-15T19:56:45Z","closed_at":"2024-02-07T12:57:45Z","author_association":"NONE","type":{"id":1092402,"node_id":"IT_kwDOAIt-yc4AEKsy","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T11:45:43Z","updated_at":"2024-07-26T10:20:14Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"We've upgraded to EF Core 8.0.0 (from 7.0.8) and have started experiencing an issue with `MigrationBuilder.Sql` where all empty lines are dropped from the SQL executed by the resulting migration. This seems to be a result of the change in `SqlServerMigrationsSqlGenerator.Generate(SqlOperation operation...)` that was done to fix a regex timeout.\r\n\r\nIn the current code, it seems that new `string.IsNullOrWhiteSpace(line)` check is causing this issue. Here's the related snippet from [SqlServerMigrationsSqlGenerator](https://github.com/dotnet/efcore/blob/main/src/EFCore.SqlServer/Migrations/SqlServerMigrationsSqlGenerator.cs):\r\n\r\n```csharp\r\nprotected override void Generate(SqlOperation operation, IModel? model, MigrationCommandListBuilder builder)\r\n{\r\n    var preBatched = operation.Sql\r\n        .Replace(\"\\\\\\n\", \"\")\r\n        .Replace(\"\\\\\\r\\n\", \"\")\r\n        .Split(new[] { \"\\r\\n\", \"\\n\" }, StringSplitOptions.None);\r\n\r\n    var batchBuilder = new StringBuilder();\r\n    foreach (var line in preBatched)\r\n    {\r\n        if (string.IsNullOrWhiteSpace(line)) <--- breaking change\r\n        {\r\n            continue;\r\n        }\r\n```\r\n\r\nWhile some empty lines could be considered inconsequential, some are not, and currently all of them seem to be removed. For example, a migration like this:\r\n\r\n```csharp\r\npublic partial class TestMigrationWithLineBreaks : Migration\r\n{\r\n    protected override void Up(MigrationBuilder migrationBuilder)\r\n    {\r\n        migrationBuilder.Sql(\"INSERT INTO SomeTable SELECT 'Some\\n\\nValue'\");\r\n    }\r\n    protected override void Down(MigrationBuilder migrationBuilder) { }\r\n}\r\n```\r\n\r\nResults in the below SQL execution (note the missing empty line):\r\n```SQL\r\nINSERT INTO SomeTable SELECT 'Some\r\nValue'\r\n```\r\n\r\n[Sample Code w/ Issue](https://github.com/dotnet/efcore/files/13843961/EfMigrationsIssue.zip)\r\n\r\nAnother of our current use cases involves using `MigrationBuilder.Sql` to manage changes to stored procedures and other db objects, and the dropped empty lines reduce readability of the definitions for these objects in the db.\r\n\r\nMy current workaround is to create a separate generator that inherits from `SqlServerMigrationsSqlGenerator`, override the `Generate(SqlOperation operation...)` method with the addition of `batchBuilder.AppendLine(line)` inside of the aforementioned `if` block, and replacing the `IMigrationsSqlGenerator` service with this new implementation via `UseSqlServer().ReplaceService<>`. However, it would be awesome to not have to do that as we're losing potential future optimizations of the generator and introducing potential for incompatibility and maintenance overhead for our future EF Core updates.\r\n\r\nEF Core version: 8.0.0\r\nDatabase provider: Microsoft.EntityFrameworkCore.SqlServer\r\nTarget framework: .NET 8.0\r\nOperating system: Windows 11 Pro 22H2\r\nIDE: Visual Studio 2022 17.8.3","closed_by":{"login":"ajcvickers","id":1430078,"node_id":"MDQ6VXNlcjE0MzAwNzg=","avatar_url":"https://avatars.githubusercontent.com/u/1430078?v=4","gravatar_id":"","url":"https://api.github.com/users/ajcvickers","html_url":"https://github.com/ajcvickers","followers_url":"https://api.github.com/users/ajcvickers/followers","following_url":"https://api.github.com/users/ajcvickers/following{/other_user}","gists_url":"https://api.github.com/users/ajcvickers/gists{/gist_id}","starred_url":"https://api.github.com/users/ajcvickers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajcvickers/subscriptions","organizations_url":"https://api.github.com/users/ajcvickers/orgs","repos_url":"https://api.github.com/users/ajcvickers/repos","events_url":"https://api.github.com/users/ajcvickers/events{/privacy}","received_events_url":"https://api.github.com/users/ajcvickers/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/dotnet/efcore/issues/32730/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/dotnet/efcore/issues/32730/timeline","performed_via_github_app":null,"state_reason":"completed"}