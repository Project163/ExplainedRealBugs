{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3176","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3176/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3176/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3176/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3176","id":384631704,"node_id":"MDU6SXNzdWUzODQ2MzE3MDQ=","number":3176,"title":"faster KeyedTuple","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269142,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141273966,"node_id":"MDU6TGFiZWwxMTQxMjczOTY2","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/orm","name":"orm","color":"20C0B0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/42","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/42","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/42/labels","id":3850611,"node_id":"MDk6TWlsZXN0b25lMzg1MDYxMQ==","number":42,"title":"1.0","description":null,"creator":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":101,"state":"closed","created_at":"2018-11-27T04:04:03Z","updated_at":"2018-11-28T16:49:52Z","due_on":null,"closed_at":"2018-11-28T16:49:52Z"},"comments":6,"created_at":"2014-08-28T15:53:13Z","updated_at":"2014-08-28T17:30:44Z","closed_at":"2014-08-28T16:42:32Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by Michael Bayer ([@zzzeek](https://github.com/zzzeek))**\n\ncollections.namedtuple() is much much faster on creation of tuples, and KeyedTuple is actually slower than straight object.  But namedtuple() is very slow to create new types as the code to do so uses eval(), stack frame inspection, and other overbuilt things that slow us down too much on a per-query basis.  What to do?   We can hedge between both approaches.  Here is a speed breakdown:\n\n\n```\nimport collections\nimport timeit\n\nfrom sqlalchemy.util import KeyedTuple, lightweight_named_tuple\n\n\ndef go1(size):\n    nt = collections.namedtuple('a', ['x', 'y', 'z'])\n    result = [\n        nt(1, 2, 3) for i in range(size)\n    ]\n\n\ndef go2(size):\n    labels = ['x', 'y', 'z']\n    result = [\n        KeyedTuple([1, 2, 3], labels) for i in range(size)\n    ]\n\n\ndef go3(size):\n    nt = lightweight_named_tuple('a', ['x', 'y', 'z'])\n    result = [\n        nt([1, 2, 3]) for i in range(size)\n    ]\n\nfor size, num in [\n    (10, 10000),\n    (100, 1000),\n    (10000, 100),\n    (1000000, 10),\n]:\n    print \"-----------------\"\n    print \"size=%d num=%d\" % (size, num)\n    print \"namedtuple:\", timeit.timeit(\"go1(%s)\" % size, \"from __main__ import go1\", number=num)\n    print \"keyedtuple:\", timeit.timeit(\"go2(%s)\" % size, \"from __main__ import go2\", number=num)\n    print \"lw keyed tuple:\", timeit.timeit(\"go3(%s)\" % size, \"from __main__ import go3\", number=num)\n\n```\n\noutput:\n\n```\n#!\n\n\n-----------------\nsize=10 num=10000\nnamedtuple: 3.60116696358\nkeyedtuple: 0.257042884827\nlw keyed tuple: 0.571335792542\n-----------------\nsize=100 num=1000\nnamedtuple: 0.362484931946\nkeyedtuple: 0.24974322319\nlw keyed tuple: 0.0887930393219\n-----------------\nsize=10000 num=100\nnamedtuple: 0.562417030334\nkeyedtuple: 2.53507685661\nlw keyed tuple: 0.607440948486\n-----------------\nsize=1000000 num=10\nnamedtuple: 5.84964299202\nkeyedtuple: 28.8070271015\nlw keyed tuple: 6.69921588898\n\n```\n\nwe can see that namedtuple is very slow for lots of distinct types.  But then that keyedtuple is *really* slow for a lot of instances on a small number of types.   the new lw_tuple is almost as fast as namedtuple on instance create and just a bit slower than keyedtuple on making new types.   it is definitely the best option in the graph.\n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3176/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3176/timeline","performed_via_github_app":null,"state_reason":"completed"}