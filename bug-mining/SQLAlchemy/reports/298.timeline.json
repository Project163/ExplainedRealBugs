[{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441927930","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3330#issuecomment-441927930","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3330","id":441927930,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkyNzkzMA==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-03-17T03:42:32Z","updated_at":"2018-11-27T05:42:42Z","body":"**Michael Bayer ([@zzzeek](https://github.com/zzzeek)) wrote:**\n\nwe should call it \"_soft_close()\" and keep it separate from .close().\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441927930/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441927931","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3330#issuecomment-441927931","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3330","id":441927931,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkyNzkzMQ==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-03-17T03:54:58Z","updated_at":"2018-11-27T05:42:43Z","body":"**Michael Bayer ([@zzzeek](https://github.com/zzzeek)) wrote:**\n\nhere's a patch which also addresses #3329, however we might want 3329 in 0.9:\n\n\n```\ndiff --git a/lib/sqlalchemy/engine/result.py b/lib/sqlalchemy/engine/result.py\nindex 3c31ae1..74fe2c3 100644\n--- a/lib/sqlalchemy/engine/result.py\n+++ b/lib/sqlalchemy/engine/result.py\n@@ -620,6 +620,16 @@ class ResultProxy(object):\n \n         return self._saved_cursor.description\n \n+    def _soft_close(self, _autoclose_connection=True):\n+        if self.cursor is None:\n+            return\n+        cursor = self.cursor\n+        self.connection._safe_close_cursor(cursor)\n+        if _autoclose_connection and \\\n+                self.connection.should_close_with_result:\n+            self.connection.close()\n+        self.cursor = None\n+\n     def close(self, _autoclose_connection=True):\n         \"\"\"Close this ResultProxy.\n \n@@ -641,12 +651,7 @@ class ResultProxy(object):\n \n         if not self.closed:\n             self.closed = True\n-            self.connection._safe_close_cursor(self.cursor)\n-            if _autoclose_connection and \\\n-                    self.connection.should_close_with_result:\n-                self.connection.close()\n-            # allow consistent errors\n-            self.cursor = None\n+            self._soft_close(_autoclose_connection)\n \n     def __iter__(self):\n         while True:\n@@ -837,7 +842,7 @@ class ResultProxy(object):\n         try:\n             return self.cursor.fetchone()\n         except AttributeError:\n-            self._non_result()\n+            return self._non_result(None)\n \n     def _fetchmany_impl(self, size=None):\n         try:\n@@ -846,22 +851,24 @@ class ResultProxy(object):\n             else:\n                 return self.cursor.fetchmany(size)\n         except AttributeError:\n-            self._non_result()\n+            return self._non_result([])\n \n     def _fetchall_impl(self):\n         try:\n             return self.cursor.fetchall()\n         except AttributeError:\n-            self._non_result()\n+            return self._non_result([])\n \n-    def _non_result(self):\n+    def _non_result(self, default):\n         if self._metadata is None:\n             raise exc.ResourceClosedError(\n                 \"This result object does not return rows. \"\n                 \"It has been closed automatically.\",\n             )\n-        else:\n+        elif self.closed:\n             raise exc.ResourceClosedError(\"This result object is closed.\")\n+        else:\n+            return default\n \n     def process_rows(self, rows):\n         process_row = self._process_row\n@@ -884,7 +891,7 @@ class ResultProxy(object):\n \n         try:\n             l = self.process_rows(self._fetchall_impl())\n-            self.close()\n+            self._soft_close()\n             return l\n         except Exception as e:\n             self.connection._handle_dbapi_exception(\n@@ -903,7 +910,7 @@ class ResultProxy(object):\n         try:\n             l = self.process_rows(self._fetchmany_impl(size))\n             if len(l) == 0:\n-                self.close()\n+                self._soft_close()\n             return l\n         except Exception as e:\n             self.connection._handle_dbapi_exception(\n@@ -922,7 +929,7 @@ class ResultProxy(object):\n             if row is not None:\n                 return self.process_rows([row])[0]\n             else:\n-                self.close()\n+                self._soft_close()\n                 return None\n         except Exception as e:\n             self.connection._handle_dbapi_exception(\n@@ -936,7 +943,7 @@ class ResultProxy(object):\n \n         \"\"\"\n         if self._metadata is None:\n-            self._non_result()\n+            return self._non_result(None)\n \n         try:\n             row = self._fetchone_impl()\n@@ -951,7 +958,7 @@ class ResultProxy(object):\n             else:\n                 return None\n         finally:\n-            self.close()\n+            self._soft_close()\n \n     def scalar(self):\n         \"\"\"Fetch the first column of the first row, and close the result set.\ndiff --git a/test/engine/test_execute.py b/test/engine/test_execute.py\nindex 730ef44..a5318c0 100644\n--- a/test/engine/test_execute.py\n+++ b/test/engine/test_execute.py\n@@ -1070,6 +1070,9 @@ class AlternateResultProxyTest(fixtures.TestBase):\n         rows = r.fetchmany(6)\n         eq_(rows, [(i, \"t_%d\" % i) for i in range(1, 6)])\n \n+        rows = r.fetchmany(2)\n+        eq_(rows, [])\n+\n     def test_plain(self):\n         self._test_proxy(_result.ResultProxy)\n \ndiff --git a/test/sql/test_query.py b/test/sql/test_query.py\nindex eeec487..08afc32 100644\n--- a/test/sql/test_query.py\n+++ b/test/sql/test_query.py\n@@ -993,6 +993,9 @@ class QueryTest(fixtures.TestBase):\n     def test_fetchone_til_end(self):\n         result = testing.db.execute(\"select * from query_users\")\n         eq_(result.fetchone(), None)\n+        eq_(result.fetchone(), None)\n+        eq_(result.fetchone(), None)\n+        result.close()\n         assert_raises_message(\n             exc.ResourceClosedError,\n             \"This result object is closed.\",\n```\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441927931/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441927933","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3330#issuecomment-441927933","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3330","id":441927933,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkyNzkzMw==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-03-17T16:34:23Z","updated_at":"2018-11-27T05:42:43Z","body":"**Michael Bayer ([@zzzeek](https://github.com/zzzeek)) wrote:**\n\n- The \"auto close\" for :class:`.ResultProxy` is now a \"soft\" close.\nThat is, after exhausing all rows using the fetch methods, the\nDBAPI cursor is released as before and the object may be safely\ndiscarded, but the fetch methods may continue to be called for which\nthey will return an end-of-result object (None for fetchone, empty list\nfor fetchmany and fetchall).   Only if :meth:`.ResultProxy.close`\nis called explicitly will these methods raise the \"result is closed\"\nerror.\nfixes #3330 fixes #3329\n\n\nâ†’ b7e151ac5cf5\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441927933/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441927934","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3330#issuecomment-441927934","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3330","id":441927934,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkyNzkzNA==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-03-17T16:34:23Z","updated_at":"2018-11-27T05:42:43Z","body":"**Changes by Michael Bayer ([@zzzeek](https://github.com/zzzeek)):**\n\n* changed **status** to closed\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441927934/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":1988618967,"node_id":"MDExOkNsb3NlZEV2ZW50MTk4ODYxODk2Nw==","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/events/1988618967","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2015-03-17T16:34:23Z","state_reason":null,"performed_via_github_app":null},{"id":1988618959,"node_id":"MDEyOkxhYmVsZWRFdmVudDE5ODg2MTg5NTk=","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/events/1988618959","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2018-11-27T05:42:42Z","label":{"name":"bug","color":"d73a4a"},"performed_via_github_app":null},{"id":1988618960,"node_id":"MDEyOkxhYmVsZWRFdmVudDE5ODg2MTg5NjA=","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/events/1988618960","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2018-11-27T05:42:42Z","label":{"name":"engine","color":"B04040"},"performed_via_github_app":null},{"id":1988618962,"node_id":"MDE1Ok1pbGVzdG9uZWRFdmVudDE5ODg2MTg5NjI=","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/events/1988618962","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"milestoned","commit_id":null,"commit_url":null,"created_at":"2018-11-27T05:42:42Z","milestone":{"title":"1.0"},"performed_via_github_app":null}]