{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/1280","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/1280/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/1280/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/1280/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/1280","id":384616254,"node_id":"MDU6SXNzdWUzODQ2MTYyNTQ=","number":1280,"title":"Some Decimal types are not converted correctly in mssql.py","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269142,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141273873,"node_id":"MDU6TGFiZWwxMTQxMjczODcz","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/high%20priority","name":"high priority","color":"C0B0E0","default":false,"description":null},{"id":1141277259,"node_id":"MDU6TGFiZWwxMTQxMjc3MjU5","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/SQL%20Server","name":"SQL Server","color":"C02080","default":false,"description":"Microsoft SQL Server, e.g. mssql"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/38","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/38","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/38/labels","id":3850607,"node_id":"MDk6TWlsZXN0b25lMzg1MDYwNw==","number":38,"title":"0.5.1","description":null,"creator":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":8,"state":"closed","created_at":"2018-11-27T04:02:16Z","updated_at":"2018-11-28T16:49:51Z","due_on":null,"closed_at":"2018-11-28T16:49:51Z"},"comments":4,"created_at":"2009-01-14T17:13:32Z","updated_at":"2014-02-23T18:14:02Z","closed_at":"2009-01-17T16:01:07Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by Anonymous**\n\nHi developers,\n\nI discovered this bug as I was working with a field of type Decimal(38,20) on Microsoft SQL Server. I tried to update this field with a value of Decimal('1500000.00000000000000000000'). Don't ask about this weird value, it's Microsoft Dynamics NAV ERP.\n\nHere is the exception:\n\n\n    sqlalchemy.exc.DataError: (DataError) ('22003', '[22003](22003) [Microsoft](Microsoft)[SQL Se\n    rver Driver](ODBC)[Server](SQL)Error de desbordamiento aritm\\xe9tico al convertir varch\n    ar al tipo de datos numeric. (8115) (SQLExecDirectW); [01000](01000) [Microsoft](Microsoft)[S\n    QL Server Driver](ODBC)[Server](SQL)Se termin\\xf3 la instrucci\\xf3n. (3621)') u'UPDATE \n    [Bizak$Customer](Bizak$Customer) SET [Limit (LCY)](Credit)=? WHERE [Bizak$Customer](Bizak$Customer).[No_](No_) = ?' ['CL003920']('\n    0.0000000000000000000150000000000000000000000000',)\n\n\nAfter some debugging I found the erroneous routine.\n\nHave a look at the following test case where I included the original algorithm found in mssql.py and also my proposed solution.\n\n\n    #!/usr/bin/python\n    \n    import decimal\n    \n    def original_algorithm(value):\n        \"\"\"sqlalchemy/databases/mssql.py line 337\"\"\" \n        if isinstance(value, decimal.Decimal) and value._exp < -6:\n    \tvalue = ((value < 0 and '-' or '')\n    \t    + '0.'\n    \t    + '0' * -(value._exp+1)\n    \t    + value._int)\n    \treturn value\n        else:\n    \treturn str(value)\n    \n    def new_algorithm(value):\n        if isinstance(value, decimal.Decimal):\n    \tsign = (value < 0 and '-' or '') \n    \tif value._exp > -1:\n    \t    return sign + value._int + '0' * value._exp\n    \telse:\n    \t    s = value._int.zfill(-value._exp+1)\n    \t    pos = len(s) + value._exp\n    \t    return sign + s[:pos](:pos) + '.' + s[pos:](pos:)\n        else:\n    \treturn str(value)\n    \n    for d in ['-1500000.00000000000000000000',\n    \t  '1500000', '0.0000000000000000002', '0.2', '-0.0000000000000000002',\n    \t  '156666.458923543', '-156666.458923543', '1', '-1', '1234',\n    \t  '2E-12', '4E8', '3E-6', '3E-7']('1500000.00000000000000000000',):\n        d = decimal.Decimal(d)\n        o = original_algorithm(d)\n        n = new_algorithm(d)\n        if o != n:\n    \tprint 'Fail', o, n\n        else:\n    \tprint 'Ok', o, n\n    \n\n\nAs you can see the original algorithm fails when converting some of the values. And, therefore you can suppose that sqlalchemy failed to UPDATE the record with such big string values.\n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/1280/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/1280/timeline","performed_via_github_app":null,"state_reason":"completed"}