{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/11370","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/11370/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/11370/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/11370/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/11370","id":2286064647,"node_id":"I_kwDOCX5JB86IQpQH","number":11370,"title":"TypeAlias cannot be found in type_annotation_map","user":{"login":"RazerM","id":1337586,"node_id":"MDQ6VXNlcjEzMzc1ODY=","avatar_url":"https://avatars.githubusercontent.com/u/1337586?v=4","gravatar_id":"","url":"https://api.github.com/users/RazerM","html_url":"https://github.com/RazerM","followers_url":"https://api.github.com/users/RazerM/followers","following_url":"https://api.github.com/users/RazerM/following{/other_user}","gists_url":"https://api.github.com/users/RazerM/gists{/gist_id}","starred_url":"https://api.github.com/users/RazerM/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/RazerM/subscriptions","organizations_url":"https://api.github.com/users/RazerM/orgs","repos_url":"https://api.github.com/users/RazerM/repos","events_url":"https://api.github.com/users/RazerM/events{/privacy}","received_events_url":"https://api.github.com/users/RazerM/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269142,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":4578353090,"node_id":"LA_kwDOCX5JB88AAAABEOQfwg","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/orm%20-%20annotated%20declarative","name":"orm - annotated declarative","color":"BF61D1","default":false,"description":"issues with the new annotations-based declarative ORM approach"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/92","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/92","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/92/labels","id":7662069,"node_id":"MI_kwDOCX5JB84AdOn1","number":92,"title":"2.1","description":null,"creator":{"login":"zzzeek","id":128223,"node_id":"MDQ6VXNlcjEyODIyMw==","avatar_url":"https://avatars.githubusercontent.com/u/128223?v=4","gravatar_id":"","url":"https://api.github.com/users/zzzeek","html_url":"https://github.com/zzzeek","followers_url":"https://api.github.com/users/zzzeek/followers","following_url":"https://api.github.com/users/zzzeek/following{/other_user}","gists_url":"https://api.github.com/users/zzzeek/gists{/gist_id}","starred_url":"https://api.github.com/users/zzzeek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zzzeek/subscriptions","organizations_url":"https://api.github.com/users/zzzeek/orgs","repos_url":"https://api.github.com/users/zzzeek/repos","events_url":"https://api.github.com/users/zzzeek/events{/privacy}","received_events_url":"https://api.github.com/users/zzzeek/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":13,"closed_issues":88,"state":"open","created_at":"2022-02-10T03:35:57Z","updated_at":"2025-11-08T19:55:20Z","due_on":null,"closed_at":null},"comments":9,"created_at":"2024-05-08T17:10:02Z","updated_at":"2024-12-11T19:50:00Z","closed_at":"2024-12-11T19:49:59Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\n\nI have a `TypeAlias` that I'm trying to put in `type_annotation_map` but SQLAlchemy can't seem to find it.\r\n\r\n(my naive understanding was that `Json` in the example would be looked up directly by hash in the annotation map)\n\n### Optional link from https://docs.sqlalchemy.org which documents the behavior that is expected\n\n_No response_\n\n### SQLAlchemy Version in Use\n\n2.0.30\n\n### DBAPI (i.e. the database driver)\n\npsycopg2\n\n### Database Vendor and Major Version\n\nPostgreSQL 12\n\n### Python Version\n\n3.10\n\n### Operating system\n\nmacOS\n\n### To Reproduce\n\n```python\nfrom typing import Annotated, Dict, List, Optional, TypeAlias, Union\r\n\r\nfrom sqlalchemy.dialects.postgresql import JSONB\r\nfrom sqlalchemy.orm import DeclarativeBase, Mapped, mapped_column\r\n\r\nJsonPrimitive: TypeAlias = Union[str, int, float, bool, None]\r\nJsonObject: TypeAlias = Dict[str, \"Json\"]\r\nJsonArray: TypeAlias = List[\"Json\"]\r\nJson: TypeAlias = Union[JsonObject, JsonArray, JsonPrimitive]\r\n\r\n\r\nclass Base(DeclarativeBase):\r\n    type_annotation_map = {\r\n        Json: JSONB(none_as_null=True),\r\n    }\r\n\r\n\r\nclass Model(Base):\r\n    __tablename__ = \"model\"\r\n\r\n    id: Mapped[int] = mapped_column(primary_key=True)\r\n    data: Mapped[Optional[Json]]\n```\n\n\n### Error\n\n```\r\nTraceback (most recent call last):\r\n  File \"/scratch_184.py\", line 25, in <module>\r\n    class Model(Base):\r\n  File \"/venv/lib/python3.10/site-packages/sqlalchemy/orm/decl_api.py\", line 836, in __init_subclass__\r\n    _as_declarative(cls._sa_registry, cls, cls.__dict__)\r\n  File \"/venv/lib/python3.10/site-packages/sqlalchemy/orm/decl_base.py\", line 244, in _as_declarative\r\n    return _MapperConfig.setup_mapping(registry, cls, dict_, None, {})\r\n  File \"/venv/lib/python3.10/site-packages/sqlalchemy/orm/decl_base.py\", line 325, in setup_mapping\r\n    return _ClassScanMapperConfig(\r\n  File \"/venv/lib/python3.10/site-packages/sqlalchemy/orm/decl_base.py\", line 571, in __init__\r\n    self._extract_mappable_attributes()\r\n  File \"/venv/lib/python3.10/site-packages/sqlalchemy/orm/decl_base.py\", line 1541, in _extract_mappable_attributes\r\n    value.declarative_scan(\r\n  File \"/venv/lib/python3.10/site-packages/sqlalchemy/orm/properties.py\", line 709, in declarative_scan\r\n    self._init_column_for_annotation(\r\n  File \"/venv/lib/python3.10/site-packages/sqlalchemy/orm/properties.py\", line 880, in _init_column_for_annotation\r\n    raise sa_exc.ArgumentError(\r\nsqlalchemy.exc.ArgumentError: Could not locate SQLAlchemy Core type for Python type typing.Union[str, int, bool, float, typing.Dict[str, ForwardRef('Json')], typing.List[ForwardRef('Json')]] inside the 'data' attribute Mapped annotation\r\n``` \n\n### Additional context\n\nThere's still an error even if the TypeAlias is not self-referential:\r\n\r\n```python\r\nJsonPrimitive: TypeAlias = Union[str, int, float, bool, None]\r\nJsonObject: TypeAlias = Dict[str, object]\r\nJsonArray: TypeAlias = List[object]\r\nJson: TypeAlias = Union[JsonObject, JsonArray, JsonPrimitive]\r\n```\r\n\r\nbut weirdly it works if `JsonPrimitive` doesn't have `None`:\r\n\r\n```python\r\nJsonPrimitive: TypeAlias = Union[str, int, float, bool]\r\nJsonObject: TypeAlias = Dict[str, object]\r\nJsonArray: TypeAlias = List[object]\r\nJson: TypeAlias = Union[JsonArray, str, int, float]\r\n```\r\n\r\n(both of these types aren't very useful, so I would specify the JSONB explicitly in `mapped_column`, but I thought it's worth mentioning what I'd tried).","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/11370/reactions","total_count":2,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/11370/timeline","performed_via_github_app":null,"state_reason":"completed"}