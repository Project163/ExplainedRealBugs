{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/6161","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/6161/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/6161/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/6161/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/6161","id":844973468,"node_id":"MDU6SXNzdWU4NDQ5NzM0Njg=","number":6161,"title":"Incorrect column nullable value when column is of type domain (and domain is nullable and column is not) Postgres","user":{"login":"adstruble","id":21082644,"node_id":"MDQ6VXNlcjIxMDgyNjQ0","avatar_url":"https://avatars.githubusercontent.com/u/21082644?v=4","gravatar_id":"","url":"https://api.github.com/users/adstruble","html_url":"https://github.com/adstruble","followers_url":"https://api.github.com/users/adstruble/followers","following_url":"https://api.github.com/users/adstruble/following{/other_user}","gists_url":"https://api.github.com/users/adstruble/gists{/gist_id}","starred_url":"https://api.github.com/users/adstruble/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adstruble/subscriptions","organizations_url":"https://api.github.com/users/adstruble/orgs","repos_url":"https://api.github.com/users/adstruble/repos","events_url":"https://api.github.com/users/adstruble/events{/privacy}","received_events_url":"https://api.github.com/users/adstruble/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269142,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141273914,"node_id":"MDU6TGFiZWwxMTQxMjczOTE0","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/postgresql","name":"postgresql","color":"60A070","default":false,"description":""},{"id":1142415575,"node_id":"MDU6TGFiZWwxMTQyNDE1NTc1","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/reflection","name":"reflection","color":"60e0cb","default":false,"description":"reflection of tables, columns, constraints, defaults, sequences, views, everything else"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/90","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/90","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/90/labels","id":4888003,"node_id":"MDk6TWlsZXN0b25lNDg4ODAwMw==","number":90,"title":"1.3.x","description":null,"creator":{"login":"zzzeek","id":128223,"node_id":"MDQ6VXNlcjEyODIyMw==","avatar_url":"https://avatars.githubusercontent.com/u/128223?v=4","gravatar_id":"","url":"https://api.github.com/users/zzzeek","html_url":"https://github.com/zzzeek","followers_url":"https://api.github.com/users/zzzeek/followers","following_url":"https://api.github.com/users/zzzeek/following{/other_user}","gists_url":"https://api.github.com/users/zzzeek/gists{/gist_id}","starred_url":"https://api.github.com/users/zzzeek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zzzeek/subscriptions","organizations_url":"https://api.github.com/users/zzzeek/orgs","repos_url":"https://api.github.com/users/zzzeek/repos","events_url":"https://api.github.com/users/zzzeek/events{/privacy}","received_events_url":"https://api.github.com/users/zzzeek/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":279,"state":"closed","created_at":"2019-11-28T15:49:07Z","updated_at":"2024-07-03T20:28:12Z","due_on":null,"closed_at":"2023-01-27T18:28:50Z"},"comments":7,"created_at":"2021-03-30T17:54:48Z","updated_at":"2021-03-30T22:44:11Z","closed_at":"2021-03-30T22:44:11Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\r\nIf a table has a \"not null\" column that is a domain and the domain type is nullable, the reflection of the column incorrectly reports the column as nullable\r\n\r\n**Expected behavior**\r\nThe column should not be nullable in the case where the column is set to \"not null\" even if the domain is nullable\r\n\r\n**To Reproduce**\r\nRun provided Python code with postgres \r\n\r\nI used: PostgreSQL 11.11 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-44), 64-bit\r\n\r\n```py\r\ndatabase_params = {\"host\": 'hostnme',\r\n                                  \"database\": \"db_name\",\r\n                                  \"user\": \"user_name\",\r\n                                 \"password\": \"user_password\"}\r\n\r\nconn_string = \"postgresql://{}:{}@{}/{}\".format(database_params['user'],\r\n                                              database_params['password'],\r\n                                              database_params['host'],\r\n                                              database_params['database'])\r\n\r\ndef main():\r\n    engine = sqlalchemy.create_engine(conn_string)\r\n\r\n    with engine.begin() as conn:\r\n\r\n        with conn.connection.cursor() as cursor:\r\n\r\n            cursor.execute(\"CREATE DOMAIN nullable_domain AS TEXT CHECK (VALUE IN('FOO', 'BAR'));\")\r\n            cursor.execute(\"CREATE TABLE sqlalchemy_domain_test (not_nullable_domain_col nullable_domain not null);\")\r\n\r\n    with engine.begin() as conn:\r\n\r\n        meta = MetaData(bind=conn)\r\n        sql_table = Table(\"sqlalchemy_domain_test\", meta, autoload=True)\r\n\r\n        # The not nullable_domain_col should not be nullable because even though the domain is nullable the col is not.\r\n        # If the domain was NOT nullable then the col should obey the domain. But in this case, the domain nullability\r\n        # should not be used since the column is stricter.\r\n        if sql_table.c[\"not_nullable_domain_col\"].nullable:\r\n            print(\"FAIL\")\r\n        else:\r\n            print(\"PASS\")\r\n\r\n        with conn.connection.cursor() as cursor:\r\n            cursor.execute(\"DROP TABLE sqlalchemy_domain_test;\")\r\n            cursor.execute(\"DROP DOMAIN nullable_domain\")\r\n\r\n\r\nif __name__ == '__main__':\r\n    main()\r\n```\r\n\r\n**Error**\r\n\r\n```\r\nThere is no stacktrace, the error is that the nullable value is incorrect for the column\r\n```\r\n\r\n**Versions.**\r\n - OS: Pop!_os 19.04 ubuntu\r\n - Python:3.7.3\r\n - SQLAlchemy: 1.4.3\r\n - Database: (in a docker container) PostgreSQL 11.11 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-44), 64-bit\r\n - DBAPI: psycopg2 2.8.3\r\n\r\n**Additional context**\r\nNone\r\n\r\n**Have a nice day!**\r\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/6161/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/6161/timeline","performed_via_github_app":null,"state_reason":"completed"}