{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3461","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3461/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3461/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3461/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3461","id":384634289,"node_id":"MDU6SXNzdWUzODQ2MzQyODk=","number":3461,"title":"Autoloading table from database causes ~1 minute delay when shutting down PostgreSQL","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269142,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141273863,"node_id":"MDU6TGFiZWwxMTQxMjczODYz","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/low%20priority","name":"low priority","color":"90C0D0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":14,"created_at":"2015-06-19T08:40:45Z","updated_at":"2015-06-19T18:55:01Z","closed_at":"2015-06-19T15:50:33Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by Jurie Horneman ([@jhorneman](https://github.com/jhorneman))**\n\nWhen I connect to a PostgreSQL database and autoload a table, and do nothing else, shutting down PostgreSQL hangs for about a minute, unless I call engine.dispose() before doing so.\n\nI'm not sure if this is a bug or something that I missed in the documentation. I only found out yesterday by trial and error how to solve this, and it wasn't clear from me from the docs that I needed to do this.\n\nMy environment:\n\n* Windows 7 Professional SP1\n* Python 2.7.8 64 bit\n* PostgreSQL 9.3.3\n* SQLAlchemy==1.0.5\n* psycopg2==2.6.1\n\n(Also happens with:\n\n* SQLAlchemy==0.9.3\n* psycopg2==2.5.3)\n\nRepro code:\n\n\n```\nimport logging\nfrom sqlalchemy import *\n\n\nlogger = logging.getLogger(__name__)\n\n\ndef repro(_host, _port, _username, _password, _dbname, _table_name):\n    \"\"\"Reproduce slow PostgreSQL shutdown issue.\n\n    Keyword arguments:\n    _host -- The host address of the PostgreSQL database server.\n    _port -- The port used by the PostgreSQL database server.\n    _username -- The username to be used with the PostgreSQL database server.\n    _password -- The password for the PostgreSQL database server.\n    _dbname -- The name of the database in the PostgreSQL database server.\n    _table_name -- The name of any table in the database.\n    \"\"\"\n\n    # Maximum logging.\n    \n    # See http://docs.sqlalchemy.org/en/rel_0_9/core/engines.html#configuring-logging.\n    # \"set to logging.INFO for SQL query output\"\n    logging.getLogger(\"sqlalchemy.engine\").setLevel(logging.INFO)\n    # \"set to logging.INFO or lower to log connection pool checkouts/checkins.\"\n    logging.getLogger(\"sqlalchemy.pool\").setLevel(logging.INFO)\n    # \"set to logging.INFO for information on mapper configurations.\"\n    logging.getLogger(\"sqlalchemy.orm\").setLevel(logging.INFO)\n    # See http://docs.sqlalchemy.org/en/rel_0_9/dialects/postgresql.html.\n    # \"The psycopg2 dialect will log Postgresql NOTICE messages via the\n    #  sqlalchemy.dialects.postgresql logger\"\n    logging.getLogger(\"sqlalchemy.dialects.postgresql\").setLevel(logging.INFO)\n\n    # Create engine for the indended database.\n    engine = _create_engine(_host, _port, _username, _password, _dbname, True)\n\n    # Load tables from the database.\n    metadata = MetaData(bind=engine)\n    a_table = Table(_table_name, metadata, autoload=True)\n\n    # With the following line disabled, shutting down PostgreSQL will take about 1 minute longer.\n    # engine.dispose()\n\n\ndef _build_database_URI(_host, _port, _username, _password, _dbname):\n    return \"postgresql+psycopg2://{user}:{password}@{host}:{port}/{dbname}\".\\\n        format(user=_username, password=_password, host=_host, port=_port, dbname=_dbname)\n\ndef _create_engine(_host, _port, _username, _password, _dbname, _debug):\n    return create_engine(_build_database_URI(_host, _port, _username, _password, _dbname), echo=_debug, echo_pool=_debug)\n\n\nif __name__ == \"__main__\":\n    # Set up logging.\n    console_handler = logging.StreamHandler()\n    console_handler.setLevel(logging.INFO)\n    console_handler.setFormatter(logging.Formatter('%(message)s'))\n\n    root_logger = logging.getLogger(\"\")\n    root_logger.setLevel(logging.DEBUG)\n    root_logger.addHandler(console_handler)\n\n    logger.info(\"Connecting to the database...\")\n    repro(\n        _host = \"localhost\",\n        _port = 5439,\n        _username = \"<user>\",\n        _password = \"<password>\",\n        _dbname = \"<db name>\",\n        _table_name =\"<any table name>\"        \n    )\n\n    logger.info(\"Connected to the database. Try stopping the PostgreSQL server.\")\n\n    raw_input(\"Press enter to stop...\")\n\n```\n\nRepro steps:\n\n* Start PostgreSQL server.\n* Start Python code above.\n* Shut down PostgreSQL server.\n\nStopping the PostgreSQL server takes about a minute (and may fail).\n\nEnable the engine.dispose() line, repeat, shutting down PostgreSQL takes under a second.\n\nMy use case is unusual: I have a Windows executable that starts and stops its own local PostgreSQL server.\n\nI can sorta see in retrospect that the autoloading does something that stops the shutdown from proceeding smoothly, but overall this behavior was surprising to me.\n\nThe documentation of engine.dispose() does not indicate to me that this is something I need to call to enable a smooth PostgreSQL shutdown. I also couldn't find other obvious \"here's how to shut down bits of SQLAlchemy\" advice in the documentation.\n\nOnce I had more or less accidentally reduced the problem to these few lines, I found this solution by going through the APIs of Engine, Metadata, and Table, and trying to call everything that sounded like it should be called during shutdown.\n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3461/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3461/timeline","performed_via_github_app":null,"state_reason":"completed"}