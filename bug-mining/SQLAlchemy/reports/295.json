{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3054","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3054/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3054/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3054/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3054","id":384630532,"node_id":"MDU6SXNzdWUzODQ2MzA1MzI=","number":3054,"title":"new idea for bake","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141273873,"node_id":"MDU6TGFiZWwxMTQxMjczODcz","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/high%20priority","name":"high priority","color":"C0B0E0","default":false,"description":null},{"id":1141273925,"node_id":"MDU6TGFiZWwxMTQxMjczOTI1","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/feature","name":"feature","color":"306080","default":false,"description":null},{"id":1141273966,"node_id":"MDU6TGFiZWwxMTQxMjczOTY2","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/orm","name":"orm","color":"20C0B0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/42","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/42","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/42/labels","id":3850611,"node_id":"MDk6TWlsZXN0b25lMzg1MDYxMQ==","number":42,"title":"1.0","description":null,"creator":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":101,"state":"closed","created_at":"2018-11-27T04:04:03Z","updated_at":"2018-11-28T16:49:52Z","due_on":null,"closed_at":"2018-11-28T16:49:52Z"},"comments":28,"created_at":"2014-05-16T19:48:33Z","updated_at":"2015-03-12T07:33:45Z","closed_at":"2015-03-12T00:31:35Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by Michael Bayer ([@zzzeek](https://github.com/zzzeek))**\n\nThe issue with \"bake\" has always been the ability to derive an appropriate cache key for a query.   Based on the observation of other SQL products that a Python code object presents a direct way of establishing a unique line number in a unique source file, I'd like to see if we can make use of lambdas in order to establish this as a key.   Example:\n\n```\ndef do_something(session):\n    x1 = 5\n    x2 = 10\n\n    q = session.query(Foo).filter(Foo.x == bindparam('x1')).\\\n                 filter(Foo.y == bindparam('x2'))\n\n    baked = Bake(lambda: q)\n\n    return baked.params(x1=x1, x2=x2).all()\n\n```\n\nthe above:\n\n1. receives the lambda within Bake.  We use the code object present here to retrieve the source file and line number.\n\n2. we establish some kind of cache, perhaps within the namespace of the source module itself, that will store everything we need about this query keyed to the line number.\n\n3. Assuming the line number is not in the cache:\n\n    a. we call the lambda and get the Query back.  We scan this query for bound parameters and establish those as the arguments we'd use in params().  Note that this includes bound parameters that were created implicitly (see below).\n\n    b. we do the various \"bake\" things that we do in the [baked query recipe](https://bitbucket.org/zzzeek/sqlalchemy/wiki/UsageRecipes/BakedQuery) with this new Query object.  We store what we need in the cache.\n\n    c. we invoke the query with the params and return results.\n\n4. if the line number *is* in the cache:\n\n    a. we get the Query that we've \"baked\" from this lambda.\n\n    b. we apply the current session, invoke the query with the params and return results.\n\nNote that we can pull out the bound parameters without calling bindparam() as well.  *And*, if the whole Query is placed into the lambda, then we *dont even need to build the query* in order to get the cached version:\n\n\n```\ndef do_something(session):\n    x1 = 5\n    x2 = 10\n\n    baked = Bake(lambda: \\\n                       session.query(Foo).\n                         filter(Foo.x == 5).filter(Foo.y == 10)\n                  )\n\n    return baked.params(x1, x2).all()\n\n\n```\n\nto support the usage of the params without any explicit keys, the `params()` method will also maintain the order in which it encounters these bound parameters and allow the values to be passed positionally in that order.\n\n----------------------------------------\nAttachments: [baked.1.py](../wiki/imported_issue_attachments/3054/baked.1.py) | [baked.py](../wiki/imported_issue_attachments/3054/baked.py)\n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3054/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3054/timeline","performed_via_github_app":null,"state_reason":"completed"}