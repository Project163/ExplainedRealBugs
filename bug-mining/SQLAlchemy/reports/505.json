{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3887","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3887/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3887/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3887/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3887","id":384638209,"node_id":"MDU6SXNzdWUzODQ2MzgyMDk=","number":3887,"title":"Index with postgresql_concurrently=True fails to create","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269142,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141273914,"node_id":"MDU6TGFiZWwxMTQxMjczOTE0","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/postgresql","name":"postgresql","color":"60A070","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2017-01-12T19:40:42Z","updated_at":"2017-01-12T20:59:46Z","closed_at":"2017-01-12T20:59:46Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by Andrew Wason ([@rectalogic](https://github.com/rectalogic))**\n\nCreating an index with postgresql_concurrently=True fails to create because it is created in a transaction which is not supported. It raises an exception \"CREATE INDEX CONCURRENTLY cannot run inside a transaction block\". I attempted to create the index in various ways with transactions disabled but could not find a way.\n\nsqlalchemy 1.1.4\npsycopg2 2.6.2\nPostgreSQL 9.6.1\npython 2.7.6\n\n\n```\n>>> import sqlalchemy as sa\n>>> engine = sa.create_engine(\"postgresql://cureatr@localhost/cureatr_mongodb?sslmode=require\")\n>>> metadata = sa.MetaData()\n>>> table = sa.Table(\"foo\", metadata, sa.Column(\"id\", sa.String))\n>>> table.create(engine)\n>>> index = sa.Index(\"foo_idx\", table.c.id, postgresql_concurrently=True)\n>>> index.create(engine)\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/sql/schema.py\", line 3362, in create\n    bind._run_visitor(ddl.SchemaGenerator, self)\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1920, in _run_visitor\n    conn._run_visitor(visitorcallable, element, **kwargs)\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1529, in _run_visitor\n    **kwargs).traverse_single(element)\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/sql/visitors.py\", line 121, in traverse_single\n    return meth(obj, **kw)\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/sql/ddl.py\", line 791, in visit_index\n    self.connection.execute(CreateIndex(index))\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 945, in execute\n    return meth(self, multiparams, params)\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/sql/ddl.py\", line 68, in _execute_on_connection\n    return connection._execute_ddl(self, multiparams, params)\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1002, in _execute_ddl\n    compiled\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1189, in _execute_context\n    context)\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1393, in _handle_dbapi_exception\n    exc_info\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/util/compat.py\", line 202, in raise_from_cause\n    reraise(type(exception), exception, tb=exc_tb, cause=cause)\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1182, in _execute_context\n    context)\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/engine/default.py\", line 469, in do_execute\n    cursor.execute(statement, parameters)\nsqlalchemy.exc.InternalError: (psycopg2.InternalError) CREATE INDEX CONCURRENTLY cannot run inside a transaction block\n [SQL: 'CREATE INDEX CONCURRENTLY foo_idx ON foo (id)']\n>>> with engine.connect().execution_options(autocommit=True) as conn:\n...     index.create(conn)\n...\nTraceback (most recent call last):\n  File \"<stdin>\", line 2, in <module>\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/sql/schema.py\", line 3362, in create\n    bind._run_visitor(ddl.SchemaGenerator, self)\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1529, in _run_visitor\n    **kwargs).traverse_single(element)\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/sql/visitors.py\", line 121, in traverse_single\n    return meth(obj, **kw)\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/sql/ddl.py\", line 791, in visit_index\n    self.connection.execute(CreateIndex(index))\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 945, in execute\n    return meth(self, multiparams, params)\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/sql/ddl.py\", line 68, in _execute_on_connection\n    return connection._execute_ddl(self, multiparams, params)\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1002, in _execute_ddl\n    compiled\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1189, in _execute_context\n    context)\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1393, in _handle_dbapi_exception\n    exc_info\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/util/compat.py\", line 202, in raise_from_cause\n    reraise(type(exception), exception, tb=exc_tb, cause=cause)\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1182, in _execute_context\n    context)\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/engine/default.py\", line 469, in do_execute\n    cursor.execute(statement, parameters)\nsqlalchemy.exc.InternalError: (psycopg2.InternalError) CREATE INDEX CONCURRENTLY cannot run inside a transaction block\n [SQL: 'CREATE INDEX CONCURRENTLY foo_idx ON foo (id)']\n>>> engine.execute(sa.schema.CreateIndex(index).execution_options(autocommit=False))\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 2055, in execute\n    return connection.execute(statement, *multiparams, **params)\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 945, in execute\n    return meth(self, multiparams, params)\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/sql/ddl.py\", line 68, in _execute_on_connection\n    return connection._execute_ddl(self, multiparams, params)\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1002, in _execute_ddl\n    compiled\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1189, in _execute_context\n    context)\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1393, in _handle_dbapi_exception\n    exc_info\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/util/compat.py\", line 202, in raise_from_cause\n    reraise(type(exception), exception, tb=exc_tb, cause=cause)\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1182, in _execute_context\n    context)\n  File \"/virtualenv/local/lib/python2.7/site-packages/sqlalchemy/engine/default.py\", line 469, in do_execute\n    cursor.execute(statement, parameters)\nsqlalchemy.exc.InternalError: (psycopg2.InternalError) CREATE INDEX CONCURRENTLY cannot run inside a transaction block\n [SQL: 'CREATE INDEX CONCURRENTLY foo_idx ON foo (id)']\n```\n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3887/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3887/timeline","performed_via_github_app":null,"state_reason":"completed"}