{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3352","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3352/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3352/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3352/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3352","id":384633329,"node_id":"MDU6SXNzdWUzODQ2MzMzMjk=","number":3352,"title":"nested \"begin_nested\" blocks don't track owning states","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269142,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141273873,"node_id":"MDU6TGFiZWwxMTQxMjczODcz","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/high%20priority","name":"high priority","color":"C0B0E0","default":false,"description":null},{"id":1141273966,"node_id":"MDU6TGFiZWwxMTQxMjczOTY2","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/orm","name":"orm","color":"20C0B0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/76","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/76","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/76/labels","id":3850662,"node_id":"MDk6TWlsZXN0b25lMzg1MDY2Mg==","number":76,"title":"0.9.10","description":null,"creator":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":14,"state":"closed","created_at":"2018-11-27T04:34:43Z","updated_at":"2018-11-28T16:50:03Z","due_on":null,"closed_at":"2018-11-28T16:50:03Z"},"comments":5,"created_at":"2015-04-02T15:53:23Z","updated_at":"2015-04-02T16:22:13Z","closed_at":"2015-04-02T16:22:13Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by Michael Bayer ([@zzzeek](https://github.com/zzzeek))**\n\nas a result of #2452 in 9cf10db8aa4692dc6, the scope of objects within a begin_nested() is tracked based on dirtyness only.  This fails when there was another begin_nested() completing successfully within the block, because dirtyness is reset in that case.   Additional bookkeeping will be needed to ensure objects that are dirtied within the nested trans are tracked without being reset by a sub-transaction.\n\n\n```\nfrom sqlalchemy import Column, Integer\nfrom sqlalchemy import create_engine\nfrom sqlalchemy.ext.declarative import declarative_base\nfrom sqlalchemy.orm import Session\n\nBase = declarative_base()\n\n\nclass Test(Base):\n    __tablename__ = 'test'\n    id = Column(Integer, primary_key=True)\n    value = Column(Integer)\n\nengine = create_engine('postgresql://scott:tiger@localhost/test', echo='debug')\n\nBase.metadata.drop_all(engine)\nBase.metadata.create_all(engine)\n\ns = Session(engine)\nt1 = Test(value=1)\nt2 = Test(value=1)\nt3 = Test(value=1)\ns.add_all([t1, t2, t3])\ns.commit()\n\ntry:\n    with s.begin_nested():\n        t1.value = 2\n        with s.begin_nested():\n            t2.value = 2\n        t3.value = 2\n        raise ValueError(\"x\")\nexcept ValueError:\n    assert (t1.value, t2.value, t3.value) == (1, 1, 1), (t1.value, t2.value, t3.value)\nelse:\n    assert False\n\n```\n\nit seems like the \"_dirty\" list on transaction is only populated in the subtransaction within the flush, so this never has a chance to propagate outwards on a successful commit.  We will need to add something to SessionTransaction.commit() so that the subtransaction has a chance to propagate its dirty list to the parent.\n\nmay be safe for a 0.9.10 backport.\n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3352/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3352/timeline","performed_via_github_app":null,"state_reason":"completed"}