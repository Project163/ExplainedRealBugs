{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3677","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3677/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3677/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3677/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3677","id":384636286,"node_id":"MDU6SXNzdWUzODQ2MzYyODY=","number":3677,"title":"double check conflicting \"row switch\" instance for previously deleted","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269142,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141273873,"node_id":"MDU6TGFiZWwxMTQxMjczODcz","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/high%20priority","name":"high priority","color":"C0B0E0","default":false,"description":null},{"id":1141273966,"node_id":"MDU6TGFiZWwxMTQxMjczOTY2","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/orm","name":"orm","color":"20C0B0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/41","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/41","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/41/labels","id":3850610,"node_id":"MDk6TWlsZXN0b25lMzg1MDYxMA==","number":41,"title":"1.1","description":null,"creator":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":96,"state":"closed","created_at":"2018-11-27T04:03:36Z","updated_at":"2018-11-28T16:49:52Z","due_on":null,"closed_at":"2018-11-28T16:49:52Z"},"comments":4,"created_at":"2016-03-14T21:21:41Z","updated_at":"2016-03-14T21:57:27Z","closed_at":"2016-03-14T21:57:27Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by Michael Bayer ([@zzzeek](https://github.com/zzzeek))**\n\ntest case:\n\n\n```\nfrom sqlalchemy import *\nfrom sqlalchemy.orm import *\nfrom sqlalchemy.ext.declarative import declarative_base\n\nBase = declarative_base()\n\n\nclass A(Base):\n    __tablename__ = 'a'\n    id = Column(Integer, primary_key=True)\n\ne = create_engine(\"sqlite://\", echo=True)\nBase.metadata.drop_all(e)\nBase.metadata.create_all(e)\n\ns = Session(e, autocommit=True)\n\ntry:\n    with s.begin():\n        a1 = A(id=1)\n        s.add(a1)\n\n        s.flush()\n\n        del a1\n\n        a1 = s.query(A).first()\n\n        # exception is raised\n        raise Exception(\"something broke\")\nexcept Exception:\n    with s.begin():\n        a2 = A(id=1)\n        s.add(a2)\n```\nraises:\n\n\n```\n#!\n\n File \"/home/classic/dev/sqlalchemy/lib/sqlalchemy/orm/persistence.py\", line 303, in _organize_states_for_save\n    state_str(existing)))\nsqlalchemy.orm.exc.FlushError: New instance <A at 0x7f2d0fe5bf90> with identity key (<class '__main__.A'>, (1,)) conflicts with persistent instance <A at 0x7f2d0f8ca050>\n\n```\n\nbecause A was loaded again and isn't in the \"rollback\" buffer.\n\nif we look for expired objects and test them when we look for row switch we avoid this issue:\n\n\n```\ndiff --git a/lib/sqlalchemy/orm/persistence.py b/lib/sqlalchemy/orm/persistence.py\nindex 5d69f51..79ec669 100644\n--- a/lib/sqlalchemy/orm/persistence.py\n+++ b/lib/sqlalchemy/orm/persistence.py\n@@ -293,22 +293,24 @@ def _organize_states_for_save(base_mapper, states, uowtransaction):\n             instance = \\\n                 uowtransaction.session.identity_map[instance_key]\n             existing = attributes.instance_state(instance)\n-            if not uowtransaction.is_deleted(existing):\n-                raise orm_exc.FlushError(\n-                    \"New instance %s with identity key %s conflicts \"\n-                    \"with persistent instance %s\" %\n-                    (state_str(state), instance_key,\n-                     state_str(existing)))\n-\n-            base_mapper._log_debug(\n-                \"detected row switch for identity %s.  \"\n-                \"will update %s, remove %s from \"\n-                \"transaction\", instance_key,\n-                state_str(state), state_str(existing))\n-\n-            # remove the \"delete\" flag from the existing element\n-            uowtransaction.remove_state_actions(existing)\n-            row_switch = existing\n+\n+            if not uowtransaction.was_already_deleted(existing):\n+                if not uowtransaction.is_deleted(existing):\n+                    raise orm_exc.FlushError(\n+                        \"New instance %s with identity key %s conflicts \"\n+                        \"with persistent instance %s\" %\n+                        (state_str(state), instance_key,\n+                         state_str(existing)))\n+\n+                base_mapper._log_debug(\n+                    \"detected row switch for identity %s.  \"\n+                    \"will update %s, remove %s from \"\n+                    \"transaction\", instance_key,\n+                    state_str(state), state_str(existing))\n+\n+                # remove the \"delete\" flag from the existing element\n+                uowtransaction.remove_state_actions(existing)\n+                row_switch = existing\n \n         if (has_identity or row_switch) and mapper.version_id_col is not None:\n             update_version_id = mapper._get_committed_state_attr_by_column(\ndiff --git a/lib/sqlalchemy/orm/unitofwork.py b/lib/sqlalchemy/orm/unitofwork.py\nindex 8b4ae64..95a5401 100644\n--- a/lib/sqlalchemy/orm/unitofwork.py\n+++ b/lib/sqlalchemy/orm/unitofwork.py\n@@ -16,6 +16,7 @@ organizes them in order of dependency, and executes.\n from .. import util, event\n from ..util import topological\n from . import attributes, persistence, util as orm_util\n+from . import exc as orm_exc\n import itertools\n \n \n@@ -155,6 +156,19 @@ class UOWTransaction(object):\n     def has_work(self):\n         return bool(self.states)\n \n+    def was_already_deleted(self, state):\n+        \"\"\"return true if the given state is expired and was deleted\n+        previously.\n+        \"\"\"\n+        if state.expired:\n+            try:\n+                # MARKMARK\n+                state._load_expired(state, attributes.PASSIVE_OFF)\n+            except orm_exc.ObjectDeletedError:\n+                self.session._remove_newly_deleted([state])\n+                return True\n+        return False\n+\n     def is_deleted(self, state):\n         \"\"\"return true if the given state is marked as deleted\n         within this uowtransaction.\"\"\"\n\n```\n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3677/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3677/timeline","performed_via_github_app":null,"state_reason":"completed"}