{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3307","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3307/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3307/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3307/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3307","id":384632899,"node_id":"MDU6SXNzdWUzODQ2MzI4OTk=","number":3307,"title":"Performance with PyPy","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269142,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141273966,"node_id":"MDU6TGFiZWwxMTQxMjczOTY2","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/orm","name":"orm","color":"20C0B0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/19","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/19","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/19/labels","id":3850573,"node_id":"MDk6TWlsZXN0b25lMzg1MDU3Mw==","number":19,"title":"1.x.xx","description":null,"creator":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":166,"state":"closed","created_at":"2018-11-27T03:49:23Z","updated_at":"2023-01-27T18:28:44Z","due_on":null,"closed_at":"2023-01-27T18:28:44Z"},"comments":15,"created_at":"2015-02-13T10:20:43Z","updated_at":"2015-02-19T06:15:11Z","closed_at":"2015-02-13T16:49:13Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by zoomorph ([@zoomorph](https://github.com/zoomorph))**\n\nSQLAlchemy seems to run quite a bit slower (2-3x) under PyPy. I've gathered some pstats profiles comparing the two.\n\nPyPy (latest nightly build) + SQLAlchemy (master branch) + psycopg2cffi:\n\n```\n        1    0.000    0.000    0.017    0.017 /myapp/tpserv/client/client.py:285(handle_client_line)\n        1    0.000    0.000    0.017    0.017 /myapp/tpserv/client/client.py:859(handle_request_statistics)\n        1    0.000    0.000    0.017    0.017 /myapp/tpserv/tank/tank.py:419(initial_load)\n        1    0.000    0.000    0.014    0.014 /myapp/env_pypy/site-packages/sqlalchemy/orm/query.py:2435(first)\n        1    0.000    0.000    0.014    0.014 /myapp/env_pypy/site-packages/sqlalchemy/orm/query.py:2267(__getitem__)\n        1    0.000    0.000    0.012    0.012 /myapp/env_pypy/site-packages/sqlalchemy/orm/query.py:2516(__iter__)\n        1    0.000    0.000    0.010    0.010 /myapp/env_pypy/site-packages/sqlalchemy/orm/query.py:2530(_execute_and_instances)\n        1    0.000    0.000    0.010    0.010 /myapp/env_pypy/site-packages/sqlalchemy/engine/base.py:846(execute)\n        1    0.000    0.000    0.010    0.010 /myapp/env_pypy/site-packages/sqlalchemy/sql/elements.py:322(_execute_on_connection)\n        1    0.000    0.000    0.010    0.010 /myapp/env_pypy/site-packages/sqlalchemy/engine/base.py:975(_execute_clauseelement)\n        1    0.000    0.000    0.005    0.005 <string>:1(<lambda>)\n        1    0.000    0.000    0.005    0.005 /myapp/env_pypy/site-packages/sqlalchemy/sql/elements.py:431(compile)\n        1    0.000    0.000    0.005    0.005 /myapp/env_pypy/site-packages/sqlalchemy/sql/elements.py:496(_compiler)\n        1    0.000    0.000    0.005    0.005 /myapp/env_pypy/site-packages/sqlalchemy/sql/compiler.py:328(__init__)\n        1    0.000    0.000    0.005    0.005 /myapp/env_pypy/site-packages/sqlalchemy/sql/compiler.py:166(__init__)\n      2/1    0.000    0.000    0.005    0.005 /myapp/env_pypy/site-packages/sqlalchemy/sql/compiler.py:211(process)\n        1    0.000    0.000    0.005    0.005 /myapp/env_pypy/site-packages/sqlalchemy/engine/base.py:1062(_execute_context)\n     50/1    0.002    0.000    0.005    0.005 /myapp/env_pypy/site-packages/sqlalchemy/sql/visitors.py:75(_compiler_dispatch)\n        1    0.000    0.000    0.005    0.005 /myapp/env_pypy/site-packages/sqlalchemy/sql/compiler.py:1474(visit_select)\n       22    0.000    0.000    0.003    0.000 /myapp/env_pypy/site-packages/sqlalchemy/sql/compiler.py:1254(_label_select_column)\n        1    0.000    0.000    0.003    0.003 /myapp/env_pypy/site-packages/sqlalchemy/dialects/postgresql/psycopg2.py:457(get_result_proxy)\n        1    0.000    0.000    0.003    0.003 /myapp/env_pypy/site-packages/sqlalchemy/engine/result.py:407(__init__)\n        1    0.000    0.000    0.003    0.003 /myapp/env_pypy/site-packages/sqlalchemy/engine/result.py:423(_init_metadata)\n        1    0.003    0.003    0.003    0.003 /myapp/env_pypy/site-packages/sqlalchemy/engine/result.py:189(__init__)\n       22    0.000    0.000    0.003    0.000 /myapp/env_pypy/site-packages/sqlalchemy/sql/compiler.py:551(visit_label)\n        2    0.000    0.000    0.002    0.001 /myapp/env_pypy/site-packages/sqlalchemy/orm/loading.py:27(instances)\n        2    0.000    0.000    0.002    0.001 /myapp/env_pypy/site-packages/psycopg2cffi/_impl/cursor.py:18(check_closed_)\n        1    0.000    0.000    0.002    0.002 /myapp/env_pypy/site-packages/sqlalchemy/orm/query.py:2934(_compile_context)\n        2    0.000    0.000    0.001    0.001 /usr/local/pypy/lib-python/2.7/logging/__init__.py:1163(info)\n        2    0.000    0.000    0.001    0.001 /usr/local/pypy/lib-python/2.7/logging/__init__.py:1273(_log)\n        1    0.000    0.000    0.001    0.001 /myapp/env_pypy/site-packages/sqlalchemy/engine/default.py:441(do_execute)\n        1    0.000    0.000    0.001    0.001 /myapp/env_pypy/site-packages/psycopg2cffi/_impl/cursor.py:193(execute)\n     10/5    0.000    0.000    0.001    0.000 /myapp/env_pypy/site-packages/sqlalchemy/sql/operators.py:294(__eq__)\n        2    0.000    0.000    0.001    0.001 /usr/local/pypy/lib-python/2.7/logging/__init__.py:1294(handle)\n      9/7    0.000    0.000    0.001    0.000 {operator.eq}\n        2    0.000    0.000    0.001    0.001 /usr/local/pypy/lib-python/2.7/logging/__init__.py:1326(callHandlers)\n        1    0.000    0.000    0.001    0.001 /myapp/env_pypy/site-packages/sqlalchemy/orm/query.py:3297(setup_context)\n        6    0.000    0.000    0.001    0.000 /usr/local/pypy/lib-python/2.7/logging/__init__.py:757(handle)\n        3    0.000    0.000    0.001    0.000 /myapp/env_pypy/site-packages/sqlalchemy/orm/attributes.py:174(operate)\n       48    0.001    0.000    0.001    0.000 /myapp/env_pypy/site-packages/sqlalchemy/orm/interfaces.py:459(_get_context_loader)\n        1    0.001    0.001    0.001    0.001 /myapp/env_pypy/site-packages/psycopg2cffi/_impl/cursor.py:675(_pq_execute)\n       24    0.000    0.000    0.001    0.000 /myapp/env_pypy/site-packages/sqlalchemy/orm/interfaces.py:491(setup)\n        2    0.000    0.000    0.001    0.001 /myapp/env_pypy/site-packages/sqlalchemy/orm/relationships.py:950(__eq__)\n        6    0.000    0.000    0.001    0.000 /usr/local/pypy/lib-python/2.7/logging/__init__.py:860(emit)\n        1    0.000    0.000    0.001    0.001 /myapp/env_pypy/site-packages/sqlalchemy/orm/query.py:3258(row_processor)\n        1    0.000    0.000    0.001    0.001 /myapp/env_pypy/site-packages/sqlalchemy/orm/loading.py:221(instance_processor)\n        1    0.000    0.000    0.001    0.001 /myapp/env_pypy/site-packages/sqlalchemy/engine/result.py:806(fetchall)\n        1    0.000    0.000    0.001    0.001 /myapp/env_pypy/site-packages/sqlalchemy/engine/result.py:775(_fetchall_impl)\n```\n\nPython 2.7 + SQLAlchemy (master branch) + psycopg2:\n\n```\n        1    0.000    0.000    0.005    0.005 /myapp/tpserv/client/client.py:285(handle_client_line)\n        1    0.000    0.000    0.005    0.005 /myapp/tpserv/client/client.py:859(handle_request_statistics)\n        1    0.000    0.000    0.005    0.005 /myapp/tpserv/tank/tank.py:419(initial_load)\n        1    0.000    0.000    0.004    0.004 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/orm/query.py:2435(first)\n        1    0.000    0.000    0.004    0.004 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/orm/query.py:2267(__getitem__)\n        1    0.000    0.000    0.003    0.003 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/orm/query.py:2516(__iter__)\n        1    0.000    0.000    0.003    0.003 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/orm/query.py:2530(_execute_and_instances)\n        1    0.000    0.000    0.003    0.003 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py:846(execute)\n        1    0.000    0.000    0.003    0.003 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/sql/elements.py:322(_execute_on_connection)\n        1    0.000    0.000    0.003    0.003 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py:975(_execute_clauseelement)\n        1    0.000    0.000    0.001    0.001 <string>:1(<lambda>)\n        1    0.000    0.000    0.001    0.001 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/sql/elements.py:431(compile)\n        1    0.000    0.000    0.001    0.001 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/sql/elements.py:496(_compiler)\n        1    0.000    0.000    0.001    0.001 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/sql/compiler.py:328(__init__)\n        1    0.000    0.000    0.001    0.001 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/sql/compiler.py:166(__init__)\n        1    0.000    0.000    0.001    0.001 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py:1062(_execute_context)\n      2/1    0.000    0.000    0.001    0.001 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/sql/compiler.py:211(process)\n     50/1    0.000    0.000    0.001    0.001 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/sql/visitors.py:75(_compiler_dispatch)\n        1    0.000    0.000    0.001    0.001 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/sql/compiler.py:1474(visit_select)\n        2    0.000    0.000    0.001    0.000 /usr/lib/python2.7/logging/__init__.py:1142(info)\n        2    0.000    0.000    0.001    0.000 /usr/lib/python2.7/logging/__init__.py:1252(_log)\n        2    0.000    0.000    0.001    0.000 /usr/lib/python2.7/logging/__init__.py:1273(handle)\n        2    0.000    0.000    0.001    0.000 /usr/lib/python2.7/logging/__init__.py:1305(callHandlers)\n        6    0.000    0.000    0.001    0.000 /usr/lib/python2.7/logging/__init__.py:736(handle)\n       22    0.000    0.000    0.001    0.000 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/sql/compiler.py:1254(_label_select_column)\n        1    0.000    0.000    0.001    0.001 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/engine/default.py:441(do_execute)\n        1    0.001    0.001    0.001    0.001 {method 'execute' of 'psycopg2._psycopg.cursor' objects}\n        6    0.000    0.000    0.001    0.000 /usr/lib/python2.7/logging/__init__.py:839(emit)\n       22    0.000    0.000    0.001    0.000 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/sql/compiler.py:551(visit_label)\n        4    0.000    0.000    0.001    0.000 /usr/lib/python2.7/logging/handlers.py:68(emit)\n     10/5    0.000    0.000    0.001    0.000 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/sql/operators.py:294(__eq__)\n        4    0.000    0.000    0.001    0.000 /usr/lib/python2.7/logging/__init__.py:933(emit)\n      9/7    0.000    0.000    0.001    0.000 {operator.eq}\n        1    0.000    0.000    0.001    0.001 /usr/lib/python2.7/contextlib.py:21(__exit__)\n        1    0.000    0.000    0.001    0.001 /myapp/tpcommon/profile.py:11(profile)\n        3    0.000    0.000    0.000    0.000 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/orm/attributes.py:174(operate)\n        2    0.000    0.000    0.000    0.000 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/orm/relationships.py:950(__eq__)\n        1    0.000    0.000    0.000    0.000 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/orm/query.py:2934(_compile_context)\n        2    0.000    0.000    0.000    0.000 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/orm/loading.py:27(instances)\n        1    0.000    0.000    0.000    0.000 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/sql/compiler.py:1616(_compose_select_body)\n       26    0.000    0.000    0.000    0.000 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/sql/compiler.py:590(visit_column)\n        1    0.000    0.000    0.000    0.000 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/dialects/postgresql/psycopg2.py:457(get_result_proxy)\n      8/2    0.000    0.000    0.000    0.000 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/sql/visitors.py:86(_compiler_dispatch)\n        1    0.000    0.000    0.000    0.000 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/engine/result.py:407(__init__)\n        1    0.000    0.000    0.000    0.000 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/engine/result.py:423(_init_metadata)\n      7/6    0.000    0.000    0.000    0.000 {method 'join' of 'str' objects}\n        1    0.000    0.000    0.000    0.000 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/engine/default.py:507(_init_compiled)\n      2/1    0.000    0.000    0.000    0.000 /myapp/env_python/local/lib/python2.7/site-packages/sqlalchemy/sql/compiler.py:705(visit_clauselist)\n```\n\ninitial_load basically executes one select query.\n\nPerhaps some optimizations can be made for better PyPy performance? I will try to gather more data.\n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3307/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3307/timeline","performed_via_github_app":null,"state_reason":"completed"}