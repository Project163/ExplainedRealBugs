{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3145","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3145/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3145/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3145/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3145","id":384631388,"node_id":"MDU6SXNzdWUzODQ2MzEzODg=","number":3145,"title":"evaulate lazy loader's \"reset\" of a given collection; usually not necessary, plus can step on an eager loader","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269142,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141273966,"node_id":"MDU6TGFiZWwxMTQxMjczOTY2","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/orm","name":"orm","color":"20C0B0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/42","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/42","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/42/labels","id":3850611,"node_id":"MDk6TWlsZXN0b25lMzg1MDYxMQ==","number":42,"title":"1.0","description":null,"creator":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":101,"state":"closed","created_at":"2018-11-27T04:04:03Z","updated_at":"2018-11-28T16:49:52Z","due_on":null,"closed_at":"2018-11-28T16:49:52Z"},"comments":19,"created_at":"2014-07-29T23:31:47Z","updated_at":"2015-07-07T15:07:10Z","closed_at":"2014-08-29T00:08:40Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by Dobes Vandermeer ([@dobesv](https://github.com/dobesv))**\n\nUnder certain circumstances the above error can occur.  It's a bit hard to explain, but I will try.\n\nIn our case:\n\n1. An entity joins to itself in a parent/child relation\n2. An instance has its parent relation set to itself\n3. A collection in the parent entity is eagerly loaded as part of a query\n4. The properties of the entity are ordered such that the collection is loaded after the parent\n\nThis triggers a sequence of events in which:\n\n1. The child is loaded\n2. The parent is loaded as part of loading properties, the parent is set as the same object as the child because they are the same entity (same id)\n3. The parent initializes the collection for eager loading, this updates different things in a few places\n4. The child continues setting up its properties, setting the same collection up for lazy loading, but leaving an indirect weak reference to the collection in context.attributes that the eager loader set up\n5. The collection set up in the parent to collect the eagerly loaded entities is garbage collected because it only has a weak reference to it at this point\n6. When a member of the collection is loaded, there is a crash because the underlying collection was garbage collected\n\nThe stack trace is as follows:\n\n\n```\nTraceback (most recent call last):\n  File \"/home/dobes/sqlalchemy/test/orm/test_temp.py\", line 64, in test_bug\n    session.query(A).join(A.b).join(b_parent, b_parent.b_id == B.parent_id).join(b_parent.z).filter(BC.value>0).options(joinedload('b').joinedload('parent').joinedload('z')).all()\n  File \"/home/dobes/sqlalchemy/test/../lib/sqlalchemy/orm/query.py\", line 2293, in all\n    return list(self)\n  File \"/home/dobes/sqlalchemy/test/../lib/sqlalchemy/orm/loading.py\", line 72, in instances\n    rows = [process[0](row, None) for row in fetch]\n  File \"/home/dobes/sqlalchemy/test/../lib/sqlalchemy/orm/loading.py\", line 452, in _instance\n    populate_state(state, dict_, row, isnew, only_load_props)\n  File \"/home/dobes/sqlalchemy/test/../lib/sqlalchemy/orm/loading.py\", line 305, in populate_state\n    populator(state, dict_, row)\n  File \"/home/dobes/sqlalchemy/test/../lib/sqlalchemy/orm/strategies.py\", line 1419, in load_scalar_from_joined_existing_row\n    existing = _instance(row, None)\n  File \"/home/dobes/sqlalchemy/test/../lib/sqlalchemy/orm/loading.py\", line 481, in _instance\n    populate_state(state, dict_, row, isnew, attrs)\n  File \"/home/dobes/sqlalchemy/test/../lib/sqlalchemy/orm/loading.py\", line 309, in populate_state\n    populator(state, dict_, row)\n  File \"/home/dobes/sqlalchemy/test/../lib/sqlalchemy/orm/strategies.py\", line 1419, in load_scalar_from_joined_existing_row\n    existing = _instance(row, None)\n  File \"/home/dobes/sqlalchemy/test/../lib/sqlalchemy/orm/loading.py\", line 481, in _instance\n    populate_state(state, dict_, row, isnew, attrs)\n  File \"/home/dobes/sqlalchemy/test/../lib/sqlalchemy/orm/loading.py\", line 309, in populate_state\n    populator(state, dict_, row)\n  File \"/home/dobes/sqlalchemy/test/../lib/sqlalchemy/orm/strategies.py\", line 1401, in load_collection_from_joined_existing_row\n    _instance(row, result_list)\n  File \"/home/dobes/sqlalchemy/test/../lib/sqlalchemy/orm/loading.py\", line 500, in _instance\n    result.append(instance)\n  File \"/home/dobes/sqlalchemy/test/../lib/sqlalchemy/util/_collections.py\", line 753, in append\n    self._data_appender(item)\n  File \"/home/dobes/sqlalchemy/test/../lib/sqlalchemy/orm/collections.py\", line 655, in append_without_event\n    self._data()._sa_appender(item, _sa_initiator=False)\nAttributeError: 'NoneType' object has no attribute '_sa_appender'\n```\n\nI've attached a test case that reproduces the issue.  Note that because the order of properties is significant, I did a bit of a hack to sort the properties.\n\nWorkaround:\n\nWhat seems to be working for me is to specify eager loading for both collections - the one on the parent and the one on the child.  For example to modify the query options in the attached test case like:\n\n```\n        res = (session.query(A)\n               .join(A.b)\n               .join(b_parent, b_parent.b_id == B.parent_id)\n               .join(b_parent.z).filter(BC.value>0)\n               .options(joinedload('b').joinedload('z'))\n               .options(joinedload('b').joinedload('parent').joinedload('z')).all()\n        )\n```\n\nwill not crash, it seems.\n\n----------------------------------------\nAttachments: [test_temp.1.py](../wiki/imported_issue_attachments/3145/test_temp.1.py) | [test_temp.py](../wiki/imported_issue_attachments/3145/test_temp.py)\n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3145/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3145/timeline","performed_via_github_app":null,"state_reason":"completed"}