{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3297","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3297/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3297/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3297/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3297","id":384632812,"node_id":"MDU6SXNzdWUzODQ2MzI4MTI=","number":3297,"title":"Add MutableSet / MutableList classes to sqlalchemy.ext.mutable","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141273925,"node_id":"MDU6TGFiZWwxMTQxMjczOTI1","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/feature","name":"feature","color":"306080","default":false,"description":null},{"id":1141286348,"node_id":"MDU6TGFiZWwxMTQxMjg2MzQ4","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/sqlalchemy.ext","name":"sqlalchemy.ext","color":"90E060","default":false,"description":"extension modules, most of which are ORM related"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/19","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/19","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/19/labels","id":3850573,"node_id":"MDk6TWlsZXN0b25lMzg1MDU3Mw==","number":19,"title":"1.x.xx","description":null,"creator":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":166,"state":"closed","created_at":"2018-11-27T03:49:23Z","updated_at":"2023-01-27T18:28:44Z","due_on":null,"closed_at":"2023-01-27T18:28:44Z"},"comments":16,"created_at":"2015-01-23T13:06:44Z","updated_at":"2016-02-16T20:51:14Z","closed_at":"2016-02-16T20:51:14Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by Eoghan Murray ([@EoghanMurray](https://github.com/EoghanMurray))**\n\nthese are basic classes that should be present, they are only missing because we need implementations + unit tests.\n\n\noriginal:\n\nEdit: I've solved it in the comment, but I've no idea what I'm doing...\nMaybe the ticket should be amended to 'Provide canonical implementations for MutableSet and MutableList in ext.mutable'\n-------\n\nI've created a MutableSet class, closely following the MutableDict class in ext.mutable.\n\nUnfortunately it doesn't pickle correctly and I can't figure out what the problem is.\n\n```\nfrom sqlalchemy import *\nfrom sqlalchemy.ext.mutable import Mutable, MutableDict\ntest_table = Table('test_table, metadata,\n    Column('test_pk', String(40), primary_key=True),\n    Column('as_dict', MutableDict.as_mutable(JsonType)),\n    Column('as_set', MutableSet.as_mutable(JsonType))\n```\n\n\n my error message after using pickle.dumps on an object that contains the MutableSet column.\nNote the 'remove' function mentioned in the error is to do with  _parents WeakRef rather than MutableSet.remove)\n\n\n```\n  File \"/usr/lib/python2.7/pickle.py\", line 748, in save_global\n    (obj, module, name))\nPicklingError: Can't pickle <function remove at 0xb48a041c>: it's not found as weakref.remove\n```\n\nAnd the MutableSet class (and JsonType supporting class - included for completeness)\n\n```\nclass MutableSet(Mutable, set):\n    @classmethod\n    def coerce(cls, key, value):\n        \"Convert plain sets to MutableSet.\"\n\n        if not isinstance(value, MutableSet):\n            if isinstance(value, set):\n                return MutableSet(value)\n            elif isinstance(value, dict):\n                return MutableDict(value)\n            # this call will raise ValueError\n            return Mutable.coerce(key, value)\n        else:\n            return value\n    def __getstate__(self):\n        return set(self)\n    def __setstate__(self, state):\n        self.update(state)\n    def update(self, *args):\n        set.update(self, *args, **kwargs)\n        self.changed()\n    def intersection_update(self, *args):\n        set.intersection_update(self, *args)\n        self.changed()\n    def difference_update(self, *args):\n        set.difference_update(self, *args)\n        self.changed()\n    def symmetric_difference_update(self, *args):\n        set.symmetric_difference_update(self, *args)\n        self.changed()\n    def add(self, elem):\n        set.add(self, elem)\n        self.changed()\n    def remove(self, elem):\n        set.remove(self, elem)\n        self.changed()\n    def discard(self, elem):\n        set.discard(self, elem)\n        self.changed()\n    def pop(self):\n        set.pop(self)\n        self.changed()\n    def clear(self):\n        set.clear(self)\n        self.changed()\n```\n\n\n```\nclass JsonType(types.TypeDecorator):\n    impl = types.Unicode\n\n    def process_bind_param(self, value, engine):\n        import jsonpickle\n        if isinstance(value, MutableList):\n            value = [v for v in value]\n        if isinstance(value, MutableDict):\n            value = dict(value)\n        if isinstance(value, MutableSet):\n            value = set(value)\n        return unicode(jsonpickle.encode(value))\n\n    def process_result_value(self, value, engine):\n        import jsonpickle\n        if value:\n            return jsonpickle.decode(value)\n        else:\n            return {}\n\n    def copy_value(self, value):\n        return deepcopy(value)\n\n    def compare_values(self, x, y):\n        return x == y\n\n```\n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3297/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3297/timeline","performed_via_github_app":null,"state_reason":"completed"}