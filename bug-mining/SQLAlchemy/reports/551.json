{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/9870","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/9870/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/9870/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/9870/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/9870","id":1734681852,"node_id":"I_kwDOCX5JB85nZST8","number":9870,"title":"undefer_group with selectin/subqueryload raises exception","user":{"login":"phy1729","id":360504,"node_id":"MDQ6VXNlcjM2MDUwNA==","avatar_url":"https://avatars.githubusercontent.com/u/360504?v=4","gravatar_id":"","url":"https://api.github.com/users/phy1729","html_url":"https://github.com/phy1729","followers_url":"https://api.github.com/users/phy1729/followers","following_url":"https://api.github.com/users/phy1729/following{/other_user}","gists_url":"https://api.github.com/users/phy1729/gists{/gist_id}","starred_url":"https://api.github.com/users/phy1729/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/phy1729/subscriptions","organizations_url":"https://api.github.com/users/phy1729/orgs","repos_url":"https://api.github.com/users/phy1729/repos","events_url":"https://api.github.com/users/phy1729/events{/privacy}","received_events_url":"https://api.github.com/users/phy1729/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269142,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141273966,"node_id":"MDU6TGFiZWwxMTQxMjczOTY2","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/orm","name":"orm","color":"20C0B0","default":false,"description":null},{"id":1154021464,"node_id":"MDU6TGFiZWwxMTU0MDIxNDY0","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/regression","name":"regression","color":"b60205","default":false,"description":"something worked and was broken by a change"},{"id":1959689852,"node_id":"MDU6TGFiZWwxOTU5Njg5ODUy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/great%20mcve","name":"great mcve","color":"dcf972","default":false,"description":"An issue with a great mcve"},{"id":3975556043,"node_id":"LA_kwDOCX5JB87s9ivL","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/near-term%20release","name":"near-term release","color":"eba834","default":false,"description":"addition to the milestone which indicates this should be in a near-term release"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/100","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/100","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/100/labels","id":8974115,"node_id":"MI_kwDOCX5JB84AiO8j","number":100,"title":"2.0.x","description":"","creator":{"login":"CaselIT","id":16175304,"node_id":"MDQ6VXNlcjE2MTc1MzA0","avatar_url":"https://avatars.githubusercontent.com/u/16175304?v=4","gravatar_id":"","url":"https://api.github.com/users/CaselIT","html_url":"https://github.com/CaselIT","followers_url":"https://api.github.com/users/CaselIT/followers","following_url":"https://api.github.com/users/CaselIT/following{/other_user}","gists_url":"https://api.github.com/users/CaselIT/gists{/gist_id}","starred_url":"https://api.github.com/users/CaselIT/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/CaselIT/subscriptions","organizations_url":"https://api.github.com/users/CaselIT/orgs","repos_url":"https://api.github.com/users/CaselIT/repos","events_url":"https://api.github.com/users/CaselIT/events{/privacy}","received_events_url":"https://api.github.com/users/CaselIT/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":68,"closed_issues":416,"state":"open","created_at":"2023-01-27T12:23:11Z","updated_at":"2025-11-08T19:58:19Z","due_on":null,"closed_at":null},"comments":4,"created_at":"2023-05-31T17:32:32Z","updated_at":"2023-06-12T13:54:41Z","closed_at":"2023-06-12T13:54:40Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\n\nA query that uses `undefer_group` with either `selectinload` or `subqueryload` raises an `AttributeError` exception.\n\n### Optional link from https://docs.sqlalchemy.org which documents the behavior that is expected\n\n_No response_\n\n### SQLAlchemy Version in Use\n\n2.0.15\n\n### DBAPI (i.e. the database driver)\n\npysqlite\n\n### Database Vendor and Major Version\n\nSQLite\n\n### Python Version\n\n3.10.11\n\n### Operating system\n\nLinux\n\n### To Reproduce\n\n```python\nfrom sqlalchemy import ForeignKey\r\nfrom sqlalchemy import create_engine\r\nfrom sqlalchemy import select\r\nfrom sqlalchemy.orm import DeclarativeBase\r\nfrom sqlalchemy.orm import Mapped\r\nfrom sqlalchemy.orm import Session\r\nfrom sqlalchemy.orm import mapped_column\r\nfrom sqlalchemy.orm import relationship\r\nfrom sqlalchemy.orm import selectinload\r\nfrom sqlalchemy.orm import undefer_group\r\n\r\n\r\nclass Base(DeclarativeBase):\r\n    pass\r\n\r\n\r\nclass User(Base):\r\n    __tablename__ = 'user'\r\n\r\n    id: Mapped[int] = mapped_column(primary_key=True)\r\n    name: Mapped[str] = mapped_column(deferred_group='name')\r\n\r\n    addresses: Mapped[list['Address']] = relationship()\r\n\r\n\r\nclass Address(Base):\r\n    __tablename__ = 'address'\r\n\r\n    id: Mapped[int] = mapped_column(primary_key=True)\r\n    user_id: Mapped[int] = mapped_column(ForeignKey(User.id))\r\n    address: Mapped[str]\r\n\r\n\r\nengine = create_engine('sqlite://')\r\nBase.metadata.create_all(engine)\r\n\r\n\r\nwith Session(engine) as session:\r\n    user = User(name='name')\r\n    session.add(user)\r\n    session.commit()\r\n\r\nwith Session(engine) as session:\r\n    session.execute(select(User).options(\r\n        selectinload(User.addresses),\r\n        undefer_group('name'),\r\n    )).scalars().all()\n```\n\n\n### Error\n\n```\r\nTraceback (most recent call last):\r\n  File \"/home/phy1729/sqla-demo/demo.py\", line 47, in <module>\r\n    )).scalars().all()\r\n  File \"/home/phy1729/sqla-demo/venv/lib/python3.10/site-packages/sqlalchemy/engine/result.py\", line 1784, in all\r\n    return self._allrows()\r\n  File \"/home/phy1729/sqla-demo/venv/lib/python3.10/site-packages/sqlalchemy/engine/result.py\", line 557, in _allrows\r\n    rows = self._fetchall_impl()\r\n  File \"/home/phy1729/sqla-demo/venv/lib/python3.10/site-packages/sqlalchemy/engine/result.py\", line 1691, in _fetchall_impl\r\n    return self._real_result._fetchall_impl()\r\n  File \"/home/phy1729/sqla-demo/venv/lib/python3.10/site-packages/sqlalchemy/engine/result.py\", line 2291, in _fetchall_impl\r\n    return list(self.iterator)\r\n  File \"/home/phy1729/sqla-demo/venv/lib/python3.10/site-packages/sqlalchemy/orm/loading.py\", line 218, in chunks\r\n    post_load.invoke(context, path)\r\n  File \"/home/phy1729/sqla-demo/venv/lib/python3.10/site-packages/sqlalchemy/orm/loading.py\", line 1515, in invoke\r\n    loader(\r\n  File \"/home/phy1729/sqla-demo/venv/lib/python3.10/site-packages/sqlalchemy/orm/strategies.py\", line 3217, in _load_for_path\r\n    self._load_via_parent(\r\n  File \"/home/phy1729/sqla-demo/venv/lib/python3.10/site-packages/sqlalchemy/orm/strategies.py\", line 3293, in _load_via_parent\r\n    context.session.execute(\r\n  File \"/home/phy1729/sqla-demo/venv/lib/python3.10/site-packages/sqlalchemy/orm/session.py\", line 2232, in execute\r\n    return self._execute_internal(\r\n  File \"/home/phy1729/sqla-demo/venv/lib/python3.10/site-packages/sqlalchemy/orm/session.py\", line 2127, in _execute_internal\r\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\r\n  File \"/home/phy1729/sqla-demo/venv/lib/python3.10/site-packages/sqlalchemy/orm/context.py\", line 293, in orm_execute_statement\r\n    result = conn.execute(\r\n  File \"/home/phy1729/sqla-demo/venv/lib/python3.10/site-packages/sqlalchemy/engine/base.py\", line 1413, in execute\r\n    return meth(\r\n  File \"/home/phy1729/sqla-demo/venv/lib/python3.10/site-packages/sqlalchemy/sql/elements.py\", line 483, in _execute_on_connection\r\n    return connection._execute_clauseelement(\r\n  File \"/home/phy1729/sqla-demo/venv/lib/python3.10/site-packages/sqlalchemy/engine/base.py\", line 1629, in _execute_clauseelement\r\n    compiled_sql, extracted_params, cache_hit = elem._compile_w_cache(\r\n  File \"/home/phy1729/sqla-demo/venv/lib/python3.10/site-packages/sqlalchemy/sql/elements.py\", line 671, in _compile_w_cache\r\n    compiled_sql = self._compiler(\r\n  File \"/home/phy1729/sqla-demo/venv/lib/python3.10/site-packages/sqlalchemy/sql/elements.py\", line 288, in _compiler\r\n    return dialect.statement_compiler(dialect, self, **kw)\r\n  File \"/home/phy1729/sqla-demo/venv/lib/python3.10/site-packages/sqlalchemy/sql/compiler.py\", line 1426, in __init__\r\n    Compiled.__init__(self, dialect, statement, **kwargs)\r\n  File \"/home/phy1729/sqla-demo/venv/lib/python3.10/site-packages/sqlalchemy/sql/compiler.py\", line 867, in __init__\r\n    self.string = self.process(self.statement, **compile_kwargs)\r\n  File \"/home/phy1729/sqla-demo/venv/lib/python3.10/site-packages/sqlalchemy/sql/compiler.py\", line 912, in process\r\n    return obj._compiler_dispatch(self, **kwargs)\r\n  File \"/home/phy1729/sqla-demo/venv/lib/python3.10/site-packages/sqlalchemy/sql/visitors.py\", line 143, in _compiler_dispatch\r\n    return meth(self, **kw)  # type: ignore  # noqa: E501\r\n  File \"/home/phy1729/sqla-demo/venv/lib/python3.10/site-packages/sqlalchemy/sql/compiler.py\", line 4592, in visit_select\r\n    compile_state = select_stmt._compile_state_factory(\r\n  File \"/home/phy1729/sqla-demo/venv/lib/python3.10/site-packages/sqlalchemy/sql/base.py\", line 678, in create_for_statement\r\n    return klass.create_for_statement(statement, compiler, **kw)\r\n  File \"/home/phy1729/sqla-demo/venv/lib/python3.10/site-packages/sqlalchemy/orm/context.py\", line 1122, in create_for_statement\r\n    opt.process_compile_state(self)\r\n  File \"/home/phy1729/sqla-demo/venv/lib/python3.10/site-packages/sqlalchemy/orm/strategy_options.py\", line 905, in process_compile_state\r\n    self._process(\r\n  File \"/home/phy1729/sqla-demo/venv/lib/python3.10/site-packages/sqlalchemy/orm/strategy_options.py\", line 1377, in _process\r\n    new_path = self._chop_path(start_path, current_path)\r\n  File \"/home/phy1729/sqla-demo/venv/lib/python3.10/site-packages/sqlalchemy/orm/strategy_options.py\", line 938, in _chop_path\r\n    and c_token != p_token.key  # type: ignore\r\nAttributeError: 'Mapper' object has no attribute 'key'\r\n``` \n\n### Additional context\n\nThe `undefer_group` needs to be at the top level e.g. `selectinload(Foo.bar).undefer_group('baz')` does not error. Issue bisects to 91501e06a17d873902114275d7149ba24973db6a.\r\n\r\nI have a potential fix at https://github.com/phy1729/sqlalchemy/commit/b2722932eb7d0ad33300aaf475fc96a11151f5ba, but the contributing docs ask that an issue be opened first.","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/9870/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/9870/timeline","performed_via_github_app":null,"state_reason":"completed"}