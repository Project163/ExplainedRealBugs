[{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919097","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919097","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919097,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTA5Nw==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2013-04-05T09:56:10Z","updated_at":"2018-11-27T05:16:55Z","body":"**Michael Bayer ([@zzzeek](https://github.com/zzzeek)) wrote:**\n\nthe transaction knows that its a savepoint so it's probably reasonable to be ready for the SAVEPOINT to be missing.   this condition should be easy to simulate in a test by just manually reverting the savepoint, then throwing an exception.   \n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919097/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919142","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919142","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919142,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTE0Mg==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2013-04-05T09:56:10Z","updated_at":"2018-11-27T05:17:00Z","body":"**Changes by Michael Bayer ([@zzzeek](https://github.com/zzzeek)):**\n\n* added labels: **high priority**\n* set **milestone** to \"0.8.xx\"\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919142/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919099","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919099","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919099,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTA5OQ==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2013-04-06T21:24:27Z","updated_at":"2018-11-27T05:16:56Z","body":"**Michael Bayer ([@zzzeek](https://github.com/zzzeek)) wrote:**\n\nok here's that stack trace matched up exactly:\n\n\n    from sqlalchemy.orm import Session\n    from sqlalchemy import create_engine, Column, Integer\n    from sqlalchemy.ext.declarative import declarative_base\n    \n    Base = declarative_base()\n    class A(Base):\n        __tablename__ = 'a'\n        id = Column(Integer, primary_key=True, autoincrement=False)\n    \n    e = create_engine(\"mysql://scott:tiger@localhost/test\", echo=True)\n    Base.metadata.drop_all(e)\n    Base.metadata.create_all(e)\n    \n    s = Session(e)\n    t = s.begin_nested()\n    s.execute(\"rollback\")\n    s.add(A(id=None))\n    s.commit()\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919099/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919100","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919100","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919100,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTEwMA==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2013-04-18T16:09:36Z","updated_at":"2018-11-27T05:16:56Z","body":"**Michael Bayer ([@zzzeek](https://github.com/zzzeek)) wrote:**\n\nthis problem really fixes itself in python3.  If I add a straight exception throw to SessionTransaction.rollback() (because on Py3K I can only test sqlite or postgresql), then run a bad flush, in Python2 we get just the exception in rollback, with no mention of the flush exception:\n\n\n    Traceback (most recent call last):\n      File \"../sa3k/test.py\", line 17, in <module>\n        s.commit()\n      File \"/Users/classic/dev/sqlalchemy/lib/sqlalchemy/orm/session.py\", line 722, in commit\n        self.transaction.commit()\n      File \"/Users/classic/dev/sqlalchemy/lib/sqlalchemy/orm/session.py\", line 353, in commit\n        self._prepare_impl()\n      File \"/Users/classic/dev/sqlalchemy/lib/sqlalchemy/orm/session.py\", line 333, in _prepare_impl\n        self.session.flush()\n      File \"/Users/classic/dev/sqlalchemy/lib/sqlalchemy/orm/session.py\", line 1817, in flush\n        self._flush(objects)\n      File \"/Users/classic/dev/sqlalchemy/lib/sqlalchemy/orm/session.py\", line 1935, in _flush\n        transaction.rollback(_capture_exception=True)\n      File \"/Users/classic/dev/sqlalchemy/lib/sqlalchemy/util/langhelpers.py\", line 61, in __exit__\n        compat.reraise(type_, value, traceback)\n      File \"/Users/classic/dev/sqlalchemy/lib/sqlalchemy/orm/session.py\", line 1935, in _flush\n        transaction.rollback(_capture_exception=True)\n      File \"/Users/classic/dev/sqlalchemy/lib/sqlalchemy/orm/session.py\", line 371, in rollback\n        raise Exception(\"crap\")\n    Exception: crap\n\n\nbut on Py3K, repeated stack traces are chained together using `__cause__`.  The interpreter gives all the information without us doing anything:\n\n\n    Traceback (most recent call last):\n      File \"/Users/classic/dev/sa3k/lib/sqlalchemy/engine/base.py\", line 872, in _execute_context\n        context)\n      File \"/Users/classic/dev/sa3k/lib/sqlalchemy/engine/default.py\", line 326, in do_execute\n        cursor.execute(statement, parameters)\n    psycopg2.IntegrityError: null value in column \"id\" violates not-null constraint\n    \n    \n    The above exception was the direct cause of the following exception:\n    \n    Traceback (most recent call last):\n      File \"/Users/classic/dev/sa3k/lib/sqlalchemy/orm/session.py\", line 1896, in _flush\n        flush_context.execute()\n      File \"/Users/classic/dev/sa3k/lib/sqlalchemy/orm/unitofwork.py\", line 372, in execute\n        rec.execute(self)\n      File \"/Users/classic/dev/sa3k/lib/sqlalchemy/orm/unitofwork.py\", line 525, in execute\n        uow\n      File \"/Users/classic/dev/sa3k/lib/sqlalchemy/orm/persistence.py\", line 63, in save_obj\n        table, insert)\n      File \"/Users/classic/dev/sa3k/lib/sqlalchemy/orm/persistence.py\", line 565, in _emit_insert_statements\n        execute(statement, params)\n      File \"/Users/classic/dev/sa3k/lib/sqlalchemy/engine/base.py\", line 665, in execute\n        params)\n      File \"/Users/classic/dev/sa3k/lib/sqlalchemy/engine/base.py\", line 765, in _execute_clauseelement\n        compiled_sql, distilled_params\n      File \"/Users/classic/dev/sa3k/lib/sqlalchemy/engine/base.py\", line 879, in _execute_context\n        context)\n      File \"/Users/classic/dev/sa3k/lib/sqlalchemy/engine/base.py\", line 1035, in _handle_dbapi_exception\n        from e\n    sqlalchemy.exc.IntegrityError: (IntegrityError) null value in column \"id\" violates not-null constraint\n     'INSERT INTO a DEFAULT VALUES RETURNING a.id' {}\n    \n    During handling of the above exception, another exception occurred:\n    \n    Traceback (most recent call last):\n      File \"test.py\", line 17, in <module>\n        s.commit()\n      File \"/Users/classic/dev/sa3k/lib/sqlalchemy/orm/session.py\", line 719, in commit\n        self.transaction.commit()\n      File \"/Users/classic/dev/sa3k/lib/sqlalchemy/orm/session.py\", line 352, in commit\n        self._prepare_impl()\n      File \"/Users/classic/dev/sa3k/lib/sqlalchemy/orm/session.py\", line 332, in _prepare_impl\n        self.session.flush()\n      File \"/Users/classic/dev/sa3k/lib/sqlalchemy/orm/session.py\", line 1814, in flush\n        self._flush(objects)\n      File \"/Users/classic/dev/sa3k/lib/sqlalchemy/orm/session.py\", line 1931, in _flush\n        transaction.rollback(_capture_exception=True)\n      File \"/Users/classic/dev/sa3k/lib/sqlalchemy/orm/session.py\", line 374, in rollback\n        raise Exception(\"crap\")\n    Exception: crap\n\n\nPy3k has already solved this issue so anything we do is going to be redundant.   Since it's an extremely rare MySQL issue in the first place I think we're better off waiting for Py3K adoption.\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919100/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919143","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919143","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919143,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTE0Mw==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2013-04-18T16:09:36Z","updated_at":"2018-11-27T05:17:00Z","body":"**Changes by Michael Bayer ([@zzzeek](https://github.com/zzzeek)):**\n\n* added labels: **wontfix**\n* changed **status** to closed\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919143/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919101","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919101","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919101,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTEwMQ==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2013-04-20T07:24:40Z","updated_at":"2018-11-27T05:16:56Z","body":"**Anonymous wrote:**\n\nIndeed, I had forgotten that py3k nicety :-)\nLet's just wait for its adoption then (only 2-3 dependencies missing on my side to eventually be able to jump the gap).\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919101/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919102","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919102","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919102,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTEwMg==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-09-17T01:06:59Z","updated_at":"2018-11-27T05:16:56Z","body":"**Michael Bayer ([@zzzeek](https://github.com/zzzeek)) wrote:**\n\nfixing resolution which seems to have gotten lost in trac migration\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919102/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919144","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919144","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919144,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTE0NA==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-09-17T01:06:59Z","updated_at":"2018-11-27T05:17:00Z","body":"**Changes by Michael Bayer ([@zzzeek](https://github.com/zzzeek)):**\n\n* added labels: **wontfix**\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919144/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919103","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919103","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919103,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTEwMw==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-09-17T01:07:19Z","updated_at":"2018-11-27T05:16:56Z","body":"**Michael Bayer ([@zzzeek](https://github.com/zzzeek)) wrote:**\n\nnow, we are seeing this in neutron, so need to potentially revisit this: https://bugs.launchpad.net/oslo.db/+bug/1496651\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919103/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919105","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919105","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919105,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTEwNQ==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-09-17T16:22:19Z","updated_at":"2018-11-27T05:16:56Z","body":"**Michael Bayer ([@zzzeek](https://github.com/zzzeek)) wrote:**\n\nIssue #3535 was marked as a duplicate of this issue.\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919105/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919106","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919106","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919106,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTEwNg==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-09-17T16:22:57Z","updated_at":"2018-11-27T05:16:56Z","body":"**Michael Bayer ([@zzzeek](https://github.com/zzzeek)) wrote:**\n\nthis is really getting in the way now.  not sure what i can do though.\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919106/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919146","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919146","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919146,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTE0Ng==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-09-17T16:22:57Z","updated_at":"2018-11-27T05:17:00Z","body":"**Changes by Michael Bayer ([@zzzeek](https://github.com/zzzeek)):**\n\n* removed labels: **wontfix**\n* changed **status** to reopened\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919146/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919108","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919108","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919108,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTEwOA==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-09-17T18:11:12Z","updated_at":"2018-11-27T05:16:57Z","body":"**Michael Bayer ([@zzzeek](https://github.com/zzzeek)) wrote:**\n\nlet's apply this patch and backport to 1.0:\n\n\n```\ndiff --git a/lib/sqlalchemy/util/compat.py b/lib/sqlalchemy/util/compat.py\nindex 5b6f691..f400031 100644\n--- a/lib/sqlalchemy/util/compat.py\n+++ b/lib/sqlalchemy/util/compat.py\n@@ -8,6 +8,7 @@\n \"\"\"Handle Python version/platform incompatibilities.\"\"\"\n \n import sys\n+import warnings\n \n try:\n     import threading\n@@ -188,6 +189,8 @@ if py3k:\n         reraise(type(exception), exception, tb=exc_tb, cause=exc_value)\n else:\n     exec(\"def reraise(tp, value, tb=None, cause=None):\\n\"\n+         \"    if cause:\\n\"\n+         \"        warnings.warn('Original exception cause: %r' % cause)\\n\"\n          \"    raise tp, value, tb\\n\")\n \n     def raise_from_cause(exception, exc_info=None):\n@@ -196,7 +199,7 @@ else:\n         if exc_info is None:\n             exc_info = sys.exc_info()\n         exc_type, exc_value, exc_tb = exc_info\n-        reraise(type(exception), exception, tb=exc_tb)\n+        reraise(type(exception), exception, tb=exc_tb, cause=exc_value)\n \n if py3k:\n     exec_ = getattr(builtins, 'exec')\n\n```\n\nit's not spectacular but will dump into logs a pretty good clue of what happened.\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919108/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919109","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919109","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919109,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTEwOQ==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-09-21T21:37:45Z","updated_at":"2018-11-27T05:16:57Z","body":"**Michael Bayer ([@zzzeek](https://github.com/zzzeek)) wrote:**\n\nunfortunately we can't do it that way because caught exceptions cant be distinguished; we get lots of this in the logs:\n\n/Users/classic/dev/redhat/openstack/oslo.db/.tox/py27/lib/python2.7/site-packages/sqlalchemy/util/compat.py:3: UserWarning: nested exception: (1146, u\"Table 'test.foo' doesn't exist\")\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919109/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919110","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919110","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919110,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTExMA==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-09-21T21:54:39Z","updated_at":"2018-11-27T05:16:57Z","body":"**Michael Bayer ([@zzzeek](https://github.com/zzzeek)) wrote:**\n\nOK, then we will do this:\n\n\n```\ndiff --git a/lib/sqlalchemy/orm/session.py b/lib/sqlalchemy/orm/session.py\nindex c726443..b987ab4 100644\n--- a/lib/sqlalchemy/orm/session.py\n+++ b/lib/sqlalchemy/orm/session.py\n@@ -412,7 +412,17 @@ class SessionTransaction(object):\n         if self._state in (ACTIVE, PREPARED):\n             for transaction in self._iterate_parents():\n                 if transaction._parent is None or transaction.nested:\n-                    transaction._rollback_impl()\n+                    try:\n+                        transaction._rollback_impl()\n+                    except Exception as e:\n+                        if _capture_exception:\n+                            util.warn(\n+                                \"While handling a Session error during \"\n+                                \"a persistence operation, encountered an \"\n+                                \"additional error attempting to ROLLBACK a \"\n+                                \"transaction: %s\" % e)\n+                        else:\n+                            raise\n                     transaction._state = DEACTIVE\n                     boundary = transaction\n                     break\n\n```\n\n\nhowever I'm nervous about this being a 1.0 thing.\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919110/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919147","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919147","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919147,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTE0Nw==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-09-21T21:54:56Z","updated_at":"2018-11-27T05:17:00Z","body":"**Changes by Michael Bayer ([@zzzeek](https://github.com/zzzeek)):**\n\n* edited description\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919147/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919149","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919149","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919149,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTE0OQ==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-09-21T21:54:56Z","updated_at":"2018-11-27T05:17:00Z","body":"**Changes by Michael Bayer ([@zzzeek](https://github.com/zzzeek)):**\n\n* set **milestone** to \"1.1\"\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919149/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919113","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919113","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919113,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTExMw==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-09-21T22:19:58Z","updated_at":"2018-11-27T05:16:57Z","body":"**Michael Bayer ([@zzzeek](https://github.com/zzzeek)) wrote:**\n\nhere's a patch with a test:\n\n\n```\ndiff --git a/lib/sqlalchemy/orm/session.py b/lib/sqlalchemy/orm/session.py\nindex c726443..b987ab4 100644\n--- a/lib/sqlalchemy/orm/session.py\n+++ b/lib/sqlalchemy/orm/session.py\n@@ -412,7 +412,17 @@ class SessionTransaction(object):\n         if self._state in (ACTIVE, PREPARED):\n             for transaction in self._iterate_parents():\n                 if transaction._parent is None or transaction.nested:\n-                    transaction._rollback_impl()\n+                    try:\n+                        transaction._rollback_impl()\n+                    except Exception as e:\n+                        if _capture_exception:\n+                            util.warn(\n+                                \"While handling a Session error during \"\n+                                \"a persistence operation, encountered an \"\n+                                \"additional error attempting to ROLLBACK a \"\n+                                \"transaction: %s\" % e)\n+                        else:\n+                            raise\n                     transaction._state = DEACTIVE\n                     boundary = transaction\n                     break\ndiff --git a/lib/sqlalchemy/testing/assertions.py b/lib/sqlalchemy/testing/assertions.py\nindex 21dc3e7..6366765 100644\n--- a/lib/sqlalchemy/testing/assertions.py\n+++ b/lib/sqlalchemy/testing/assertions.py\n@@ -121,7 +121,7 @@ def uses_deprecated(*messages):\n def _expect_warnings(exc_cls, messages, regex=True, assert_=True):\n \n     if regex:\n-        filters = [re.compile(msg, re.I) for msg in messages]\n+        filters = [re.compile(msg, re.I | re.S) for msg in messages]\n     else:\n         filters = messages\n \ndiff --git a/test/orm/test_transaction.py b/test/orm/test_transaction.py\nindex 73c6b97..6ca1d5e 100644\n--- a/test/orm/test_transaction.py\n+++ b/test/orm/test_transaction.py\n@@ -657,6 +657,33 @@ class SessionTransactionTest(FixtureTest):\n         assert session.transaction is not None, \\\n             'autocommit=False should start a new transaction'\n \n+    @testing.requires.savepoints\n+    def test_report_primary_error_when_rollback_fails(self):\n+        User, users = self.classes.User, self.tables.users\n+\n+        mapper(User, users)\n+\n+        session = Session(testing.db)\n+\n+        with expect_warnings(\n+                \".*ROLLBACK TO SAVEPOINT\",\n+                \".*Session's state has been changed\"):\n+            session.begin_nested()\n+            savepoint = session.\\\n+                connection()._Connection__transaction._savepoint\n+\n+            # force the savepoint to disappear\n+            session.execute(\"RELEASE SAVEPOINT %s\" % savepoint)\n+\n+            # now do a broken flush\n+            session.add_all([User(id=1), User(id=1)])\n+\n+            assert_raises_message(\n+                sa_exc.DBAPIError,\n+                \"INSERT INTO \",\n+                session.flush\n+            )\n+\n \n class _LocalFixture(FixtureTest):\n     run_setup_mappers = 'once'\n\n```\n\nhowever, this still is dangerous:  if code is specifically trying to catch certain IntegrityErrors in code that's inside of a SAVEPOINT, then retrying, in this case the SAVEPOINT is not being rolled back.   This code would normally except out fully due to the failing ROLLBACK.    We would be making assumptions here as to what conditions are causing the savepoint rollback to fail.\n\nSo, still not seeing a solution here.\n \n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919113/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919114","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919114","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919114,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTExNA==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-09-21T22:34:52Z","updated_at":"2018-11-27T05:16:57Z","body":"**Michael Bayer ([@zzzeek](https://github.com/zzzeek)) wrote:**\n\nyeah, here is exactly a common use case that will no longer throw an exception if the rollback fails:\n\n```\nfrom sqlalchemy import *\nfrom sqlalchemy.orm import *\nfrom sqlalchemy.ext.declarative import declarative_base\nfrom sqlalchemy import exc\n\nBase = declarative_base()\n\n\nclass A(Base):\n    __tablename__ = 'a'\n    id = Column(Integer, primary_key=True)\n\ne = create_engine(\"postgresql://scott:tiger@localhost/test\", echo=True)\nBase.metadata.drop_all(e)\nBase.metadata.create_all(e)\n\n\ns = Session(e)\ns.add(A(id=1))\ns.flush()\n\ntry:\n    with s.begin_nested():\n        s.connection()\n\n        # force the savepoint to disappear; e.g. simulate the SAVEPOINT\n        # has been broken\n        s.execute(\"RELEASE SAVEPOINT sa_savepoint_1\")\n\n        s.add(A(id=1))\n        s.flush()\nexcept exc.IntegrityError:\n    pass\n\n\n```\n\nWith the patch in place, we end up at the IntegrityError, but the ROLLBACK TO SAVEPOINT has failed!  Again, the cases we're seeing with MySQL as well as this \"fake\" case sort of end up working anyway, but this is still a huge behavioral change and has the risk that rollback failures are going to be squashed.\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919114/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919116","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919116","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919116,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTExNg==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-10-05T14:26:03Z","updated_at":"2018-11-27T05:16:57Z","body":"**Michael Bayer ([@zzzeek](https://github.com/zzzeek)) wrote:**\n\nnext idea - warn on the *original* exception!   this might be better.   \n\n\n```\ndiff --git a/lib/sqlalchemy/orm/session.py b/lib/sqlalchemy/orm/session.py\nindex c726443..4272d7d 100644\n--- a/lib/sqlalchemy/orm/session.py\n+++ b/lib/sqlalchemy/orm/session.py\n@@ -408,11 +408,23 @@ class SessionTransaction(object):\n             for subtransaction in stx._iterate_parents(upto=self):\n                 subtransaction.close()\n \n+        if _capture_exception:\n+            captured_exception = sys.exc_info()[1]\n+\n         boundary = self\n         if self._state in (ACTIVE, PREPARED):\n             for transaction in self._iterate_parents():\n                 if transaction._parent is None or transaction.nested:\n-                    transaction._rollback_impl()\n+                    try:\n+                        transaction._rollback_impl()\n+                    except Exception:\n+                        if _capture_exception:\n+                            util.warn(\n+                                \"An exception raised during a Session \"\n+                                \"persistence operation cannot be raised \"\n+                                \"due to an additional ROLLBACK exception; \"\n+                                \"the exception is: %s\" % captured_exception)\n+                        raise\n                     transaction._state = DEACTIVE\n                     boundary = transaction\n                     break\n@@ -434,7 +446,7 @@ class SessionTransaction(object):\n \n         self.close()\n         if self._parent and _capture_exception:\n-            self._parent._rollback_exception = sys.exc_info()[1]\n+            self._parent._rollback_exception = captured_exception\n \n         sess.dispatch.after_soft_rollback(sess, self)\n \n\n```\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919116/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919117","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919117","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919117,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTExNw==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-10-05T14:29:56Z","updated_at":"2018-11-27T05:16:57Z","body":"**Michael Bayer ([@zzzeek](https://github.com/zzzeek)) wrote:**\n\nhere's that in full...this is probably good\n\n\n```\ndiff --git a/lib/sqlalchemy/orm/session.py b/lib/sqlalchemy/orm/session.py\nindex c726443..4272d7d 100644\n--- a/lib/sqlalchemy/orm/session.py\n+++ b/lib/sqlalchemy/orm/session.py\n@@ -408,11 +408,23 @@ class SessionTransaction(object):\n             for subtransaction in stx._iterate_parents(upto=self):\n                 subtransaction.close()\n \n+        if _capture_exception:\n+            captured_exception = sys.exc_info()[1]\n+\n         boundary = self\n         if self._state in (ACTIVE, PREPARED):\n             for transaction in self._iterate_parents():\n                 if transaction._parent is None or transaction.nested:\n-                    transaction._rollback_impl()\n+                    try:\n+                        transaction._rollback_impl()\n+                    except Exception:\n+                        if _capture_exception:\n+                            util.warn(\n+                                \"An exception raised during a Session \"\n+                                \"persistence operation cannot be raised \"\n+                                \"due to an additional ROLLBACK exception; \"\n+                                \"the exception is: %s\" % captured_exception)\n+                        raise\n                     transaction._state = DEACTIVE\n                     boundary = transaction\n                     break\n@@ -434,7 +446,7 @@ class SessionTransaction(object):\n \n         self.close()\n         if self._parent and _capture_exception:\n-            self._parent._rollback_exception = sys.exc_info()[1]\n+            self._parent._rollback_exception = captured_exception\n \n         sess.dispatch.after_soft_rollback(sess, self)\n \ndiff --git a/lib/sqlalchemy/testing/assertions.py b/lib/sqlalchemy/testing/assertions.py\nindex 21dc3e7..6366765 100644\n--- a/lib/sqlalchemy/testing/assertions.py\n+++ b/lib/sqlalchemy/testing/assertions.py\n@@ -121,7 +121,7 @@ def uses_deprecated(*messages):\n def _expect_warnings(exc_cls, messages, regex=True, assert_=True):\n \n     if regex:\n-        filters = [re.compile(msg, re.I) for msg in messages]\n+        filters = [re.compile(msg, re.I | re.S) for msg in messages]\n     else:\n         filters = messages\n \ndiff --git a/test/orm/test_transaction.py b/test/orm/test_transaction.py\nindex 73c6b97..3ec6b9c 100644\n--- a/test/orm/test_transaction.py\n+++ b/test/orm/test_transaction.py\n@@ -657,6 +657,31 @@ class SessionTransactionTest(FixtureTest):\n         assert session.transaction is not None, \\\n             'autocommit=False should start a new transaction'\n \n+    @testing.requires.savepoints\n+    def test_report_primary_error_when_rollback_fails(self):\n+        User, users = self.classes.User, self.tables.users\n+\n+        mapper(User, users)\n+\n+        session = Session(testing.db)\n+\n+        with expect_warnings(\".*due to an additional ROLLBACK.*INSERT INTO\"):\n+            session.begin_nested()\n+            savepoint = session.\\\n+                connection()._Connection__transaction._savepoint\n+\n+            # force the savepoint to disappear\n+            session.execute(\"RELEASE SAVEPOINT %s\" % savepoint)\n+\n+            # now do a broken flush\n+            session.add_all([User(id=1), User(id=1)])\n+\n+            assert_raises_message(\n+                sa_exc.DBAPIError,\n+                \"ROLLBACK TO SAVEPOINT \",\n+                session.flush\n+            )\n+\n \n class _LocalFixture(FixtureTest):\n     run_setup_mappers = 'once'\n\n```\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919117/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919118","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919118","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919118,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTExOA==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-11-19T20:47:19Z","updated_at":"2018-11-27T05:16:57Z","body":"**Michael Bayer ([@zzzeek](https://github.com/zzzeek)) wrote:**\n\n- A rare case which occurs when a :meth:`.Session.rollback` fails in the\nscope of a :meth:`.Session.flush` operation that's raising an\nexception, as has been observed in some MySQL SAVEPOINT cases, prevents\nthe original  database exception from being observed when it was\nemitted during  flush, but only on Py2K because Py2K does not support\nexception  chaining; on Py3K the originating exception is chained.  As\na workaround, a warning is emitted in this specific case showing at\nleast the string message of the original database error before we\nproceed to raise  the rollback-originating exception.\nfixes #2696\n\n\n a6fe4dc0c8eb\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919118/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919120","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919120","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919120,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTEyMA==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-11-19T20:47:19Z","updated_at":"2018-11-27T05:16:58Z","body":"**Michael Bayer ([@zzzeek](https://github.com/zzzeek)) wrote:**\n\n- A rare case which occurs when a :meth:`.Session.rollback` fails in the\nscope of a :meth:`.Session.flush` operation that's raising an\nexception, as has been observed in some MySQL SAVEPOINT cases, prevents\nthe original  database exception from being observed when it was\nemitted during  flush, but only on Py2K because Py2K does not support\nexception  chaining; on Py3K the originating exception is chained.  As\na workaround, a warning is emitted in this specific case showing at\nleast the string message of the original database error before we\nproceed to raise  the rollback-originating exception.\nfixes #2696\n\n(cherry picked from commit a6fe4dc0c8ebc346a90dd849a86dac9345d74515)\n\n\n caef13d8cf01\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919120/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919150","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919150","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919150,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTE1MA==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-11-19T20:47:19Z","updated_at":"2018-11-27T05:17:00Z","body":"**Changes by Michael Bayer ([@zzzeek](https://github.com/zzzeek)):**\n\n* changed **status** to closed\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919150/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919121","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919121","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919121,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTEyMQ==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-12-12T23:47:55Z","updated_at":"2018-11-27T05:16:58Z","body":"**Timothy Cardenas ([@trcarden](https://github.com/trcarden)) wrote:**\n\nOn latest sqlalchemy (1.0.10) a related issue occurs with the \"core\" (not using the ORM) where a given transaction will have a \"is_active\" set to True despite the database having already rolledback the transaction. \n\n\n```\nconnection = engine.connect()\ntrans = connection.begin()\ntry:\n    r1 = connection.execute(table1.select())\n    connection.execute(table1.insert(), col1=7, col2='this insert causes a mysql deadlock')\n    trans.commit()\nexcept:\n    # This property reports True after mysql deadlock exception has occurred, the \n    # transaction is actually closed already\n    if trans.is_active:  \n       trans.rollback()\n    raise\n```\n\nWhen we trigger a rollback we get the same error message as the original reporter noticed which is:\n\n\n```\nsqlalchemy.exc.ProgrammingError: (mysql.connector.errors.ProgrammingError) 1305 (42000): SAVEPOINT sa_savepoint_1 does not exist [SQL: 'ROLLBACK TO SAVEPOINT sa_savepoint_1']\n```\n\n\nDo you know if this is known issue or if we need to do anything special to get the transaction state to update correctly after a deadlock exception?\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919121/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919122","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919122","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919122,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTEyMg==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-12-13T02:24:13Z","updated_at":"2018-11-27T05:16:58Z","body":"**Michael Bayer ([@zzzeek](https://github.com/zzzeek)) wrote:**\n\nhi Timothy -\n\nthe issue up here is strictly one of reporting exceptions within the ORM.  so the issue you're dealing with as part of Core would be something separate.\n\nIt seems though that perhaps you've come across what the actual MySQL issue is that people are having.   That is, with MySQL deadlock exceptions (need to know the exact message, version of MySQL / MariaDB  / Galera / Percona / etc. in use, how to reproduce, thanks) are automatically rolling back transactions.\n\nI'd love to know what specific case that is so if you can please produce a fully reproducing case (e.g. follow guidlelines at http://stackoverflow.com/help/mcve) we can perhaps add rules to the dialect  such that we can accomodate this.  Though the Core overall would need new architectures to support accomodation of exceptions that don't invalidate the whole connection but do invalidate a transaction.   This would be an all new issue once we have your reproduction case, thanks!\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919122/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919125","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919125","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919125,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTEyNQ==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2016-01-28T14:49:04Z","updated_at":"2018-11-27T05:16:58Z","body":"**Warren Spencer ([@warrenspe](https://github.com/warrenspe)) wrote:**\n\nI'm experiencing a very similar (if not the same) issue as Timothy. I'm currently running MySQL version: 5.6.26-74.0 Percona Server (GPL), Release 74.0, Revision 32f8dfd\nI'm attempting to use SQLAlchemy CORE to perform an update to a MySQL table within two nested transactions (started with begin_nested) and receiving:\n\n\n```\n  File \"/env/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1585, in __exit__\n    self.rollback()\n  File \"/env/local/lib/python2.7/site-packages/sqlalchemy/util/langhelpers.py\", line 63, in __exit__\n    compat.reraise(type_, value, traceback)\n  File \"/env/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1585, in __exit__\n    self.rollback()\n  File \"/env/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1559, in rollback\n    self._do_rollback()\n  File \"/env/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1621, in _do_rollback\n    self._savepoint, self._parent)\n  File \"/env/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 717, in _rollback_to_savepoint_impl\n    self.engine.dialect.do_rollback_to_savepoint(self, name)\n  File \"/env/local/lib/python2.7/site-packages/sqlalchemy/engine/default.py\", line 441, in do_rollback_to_savepoint\n    connection.execute(expression.RollbackToSavepointClause(name))\n  File \"/env/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 914, in execute\n    return meth(self, multiparams, params)\n  File \"/env/local/lib/python2.7/site-packages/sqlalchemy/sql/elements.py\", line 323, in _execute_on_connection\n    return connection._execute_clauseelement(self, multiparams, params)\n  File \"/env/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1010, in _execute_clauseelement\n    compiled_sql, distilled_params\n  File \"/env/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1146, in _execute_context\n    context)\n  File \"/env/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1341, in _handle_dbapi_exception\n    exc_info\n  File \"/env/local/lib/python2.7/site-packages/sqlalchemy/util/compat.py\", line 199, in raise_from_cause\n    reraise(type(exception), exception, tb=exc_tb)\n  File \"/env/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1139, in _execute_context\n    context)\n  File \"/env/local/lib/python2.7/site-packages/sqlalchemy/engine/default.py\", line 450, in do_execute\n    cursor.execute(statement, parameters)\n  File \"/env/local/lib/python2.7/site-packages/MySQLdb/cursors.py\", line 174, in execute\n    self.errorhandler(self, exc, value)\n  File \"/env/local/lib/python2.7/site-packages/MySQLdb/connections.py\", line 36, in defaulterrorhandler\n    raise errorclass, errorvalue\nOperationalError: (_mysql_exceptions.OperationalError) (1305, 'SAVEPOINT sa_savepoint_2 does not exist') [SQL: u'ROLLBACK TO SAVEPOINT sa_savepoint_2']\n```\nUnfortunately while I am able to reproduce the issue, it occurs within my company's code, so I cannot exactly copy paste table schemas/queries.\n\nIt does appear however, that sqlalchemy is performing an invalid sequence of operations on the database, from the contents of my general query log:\n\n\n```\n#!\n                143394 Query    SAVEPOINT sa_savepoint_2\n                143394 Query    UPDATE mytable ... # Query \n                143394 Query    RELEASE SAVEPOINT sa_savepoint_2\n                143394 Query    ROLLBACK TO SAVEPOINT sa_savepoint_2\n```\n\nI have also narrowed it down to this function within /engine/base.py\n\n\n```\n    def __exit__(self, type, value, traceback):\n        if type is None and self.is_active:\n            try:\n                self.commit()\n            except:\n                with util.safe_reraise():\n                    self.rollback()\n        else:\n            self.rollback()\n```\n\nWhen the code within the with statement has finished and __exit__ is called, self.is_active is True and traceback is None, the savepoint has been acquired and the query has been run.  From checking the general query log I can assert that sqlalchemy has not tried to release the savepoint, but also that it doesn't appear to be active (from show innodb status:)\n```\n#!\n---TRANSACTION 555453261, not started\nMySQL thread id 144053, OS thread handle 0x7f67b6dcf700, query id 1231274943 localhost user_write cleaning up\n\n```\n\nThen, within the try except a :\n\n```\nTraceback (most recent call last):\n  File \"/env/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1582, in __exit__\n    self.commit()\n  File \"/env/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1570, in commit\n    self._do_commit()\n  File \"/env/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1630, in _do_commit\n    self._savepoint, self._parent)\n  File \"/env/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 727, in _release_savepoint_impl\n    self.engine.dialect.do_release_savepoint(self, name)\n  File \"/env/local/lib/python2.7/site-packages/sqlalchemy/engine/default.py\", line 444, in do_release_savepoint\n    connection.execute(expression.ReleaseSavepointClause(name))\n  File \"/env/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 914, in execute\n    return meth(self, multiparams, params)\n  File \"/env/local/lib/python2.7/site-packages/sqlalchemy/sql/elements.py\", line 323, in _execute_on_connection\n    return connection._execute_clauseelement(self, multiparams, params)\n  File \"/env/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1010, in _execute_clauseelement\n    compiled_sql, distilled_params\n  File \"/env/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1146, in _execute_context\n    context)\n  File \"/env/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1341, in _handle_dbapi_exception\n    exc_info\n  File \"/env/local/lib/python2.7/site-packages/sqlalchemy/util/compat.py\", line 199, in raise_from_cause\n    reraise(type(exception), exception, tb=exc_tb)\n  File \"/env/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1139, in _execute_context\n    context)\n  File \"/env/local/lib/python2.7/site-packages/sqlalchemy/engine/default.py\", line 450, in do_execute\n    cursor.execute(statement, parameters)\n  File \"/env/local/lib/python2.7/site-packages/MySQLdb/cursors.py\", line 174, in execute\n    self.errorhandler(self, exc, value)\n  File \"/env/local/lib/python2.7/site-packages/MySQLdb/connections.py\", line 36, in defaulterrorhandler\n    raise errorclass, errorvalue\nOperationalError: (_mysql_exceptions.OperationalError) (1305, 'SAVEPOINT sa_savepoint_2 does not exist') [SQL: u'RELEASE SAVEPOINT sa_savepoint_2']\n\n```\nis raised within the self.commit function call, and SQLAlchemy has also attempted to release the savepoint.\n```\n#!\n                143781 Query    RELEASE SAVEPOINT sa_savepoint_2\n```\n\nThis error is likely caused by, as you mentioned, a deadlock causing MySQL to rollback the initial transaction that SQLAlchemy is attempting to commit - however after this has all happened SQLAlchemy then attempts to roll back the exception (within the util.safe_reraise() call), which results in the error in the first traceback I've posted.\n\nIf there's anything else I can do to assist investigation into this please let me know.\n\nCheers\n\nEDIT: I am less convinced now that MySQL is rolling back the transaction because of a deadlock; after setting deadlock reporting to true I am seeing none being reported to the error log.\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919125/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919126","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919126","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919126,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTEyNg==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2016-01-28T16:01:52Z","updated_at":"2018-11-27T05:16:58Z","body":"**Michael Bayer ([@zzzeek](https://github.com/zzzeek)) wrote:**\n\nHi @warrenspe  -\n\nThere is one way that this codepath could perform that way and it's if the RELEASE itself fails.\n\nThat is, if I make this adjustment:\n\n\n```\ndiff --git a/lib/sqlalchemy/engine/base.py b/lib/sqlalchemy/engine/base.py\nindex 0b92856..8200528 100644\n--- a/lib/sqlalchemy/engine/base.py\n+++ b/lib/sqlalchemy/engine/base.py\n@@ -1671,6 +1671,7 @@ class NestedTransaction(Transaction):\n         if self.is_active:\n             self.connection._release_savepoint_impl(\n                 self._savepoint, self._parent)\n+            raise Exception(\"release failed\")\n \n \n class TwoPhaseTransaction(Transaction):\n\n```\n\nthen we use any block that is of the commit/rollback form, e.g.:\n\n\n```\ntry:\n    s.commit()\nexcept:\n    s.rollback()\n    raise\n\n```\n\nwhich is what we see in the `__exit__()` method of both base.Connection as well as Session:\n\n\n```\nfrom sqlalchemy import *\nfrom sqlalchemy.orm import *\nfrom sqlalchemy.ext.declarative import declarative_base\n\nBase = declarative_base()\n\nclass A(Base):\n    __tablename__ = 'a'\n    id = Column(Integer, primary_key=True)\n    data = Column(Integer, unique=True)\n\ne = create_engine(\"mysql://scott:tiger@localhost/test\", echo=True)\nBase.metadata.drop_all(e)\nBase.metadata.create_all(e)\n\ns = Session(e)\n\nwith s.begin_nested()\n    s.add(A(data=1))\n\n\n```\n\nthen I can get that sequence of calls:\n\n\n```\n#!\n\n2016-01-28 10:53:26,437 INFO sqlalchemy.engine.base.Engine BEGIN (implicit)\n2016-01-28 10:53:26,438 INFO sqlalchemy.engine.base.Engine SAVEPOINT sa_savepoint_1\n2016-01-28 10:53:26,438 INFO sqlalchemy.engine.base.Engine ()\n2016-01-28 10:53:26,439 INFO sqlalchemy.engine.base.Engine INSERT INTO a (data) VALUES (%s)\n2016-01-28 10:53:26,439 INFO sqlalchemy.engine.base.Engine (1,)\n2016-01-28 10:53:26,441 INFO sqlalchemy.engine.base.Engine RELEASE SAVEPOINT sa_savepoint_1\n2016-01-28 10:53:26,441 INFO sqlalchemy.engine.base.Engine ()\n2016-01-28 10:53:26,441 INFO sqlalchemy.engine.base.Engine ROLLBACK TO SAVEPOINT sa_savepoint_1\n2016-01-28 10:53:26,441 INFO sqlalchemy.engine.base.Engine ()\nTraceback (most recent call last):\n  File \"test.py\", line 25, in <module>\n    s.rollback()\n  File \"/home/classic/dev/sqlalchemy/lib/sqlalchemy/orm/session.py\", line 768, in rollback\n    self.transaction.rollback()\n  File \"/home/classic/dev/sqlalchemy/lib/sqlalchemy/orm/session.py\", line 419, in rollback\n    transaction._rollback_impl()\n  File \"/home/classic/dev/sqlalchemy/lib/sqlalchemy/orm/session.py\", line 457, in _rollback_impl\n    t[1].rollback()\n  File \"/home/classic/dev/sqlalchemy/lib/sqlalchemy/engine/base.py\", line 1606, in rollback\n    self._do_rollback()\n  File \"/home/classic/dev/sqlalchemy/lib/sqlalchemy/engine/base.py\", line 1668, in _do_rollback\n    self._savepoint, self._parent)\n  File \"/home/classic/dev/sqlalchemy/lib/sqlalchemy/engine/base.py\", line 748, in _rollback_to_savepoint_impl\n    self.engine.dialect.do_rollback_to_savepoint(self, name)\n  File \"/home/classic/dev/sqlalchemy/lib/sqlalchemy/engine/default.py\", line 453, in do_rollback_to_savepoint\n    connection.execute(expression.RollbackToSavepointClause(name))\n  File \"/home/classic/dev/sqlalchemy/lib/sqlalchemy/engine/base.py\", line 945, in execute\n    return meth(self, multiparams, params)\n  File \"/home/classic/dev/sqlalchemy/lib/sqlalchemy/sql/elements.py\", line 262, in _execute_on_connection\n    return connection._execute_clauseelement(self, multiparams, params)\n  File \"/home/classic/dev/sqlalchemy/lib/sqlalchemy/engine/base.py\", line 1053, in _execute_clauseelement\n    compiled_sql, distilled_params\n  File \"/home/classic/dev/sqlalchemy/lib/sqlalchemy/engine/base.py\", line 1189, in _execute_context\n    context)\n  File \"/home/classic/dev/sqlalchemy/lib/sqlalchemy/engine/base.py\", line 1384, in _handle_dbapi_exception\n    exc_info\n  File \"/home/classic/dev/sqlalchemy/lib/sqlalchemy/util/compat.py\", line 200, in raise_from_cause\n    reraise(type(exception), exception, tb=exc_tb, cause=cause)\n  File \"/home/classic/dev/sqlalchemy/lib/sqlalchemy/engine/base.py\", line 1182, in _execute_context\n    context)\n  File \"/home/classic/dev/sqlalchemy/lib/sqlalchemy/engine/default.py\", line 462, in do_execute\n    cursor.execute(statement, parameters)\n  File \"/home/classic/.venv/lib/python2.7/site-packages/MySQLdb/cursors.py\", line 174, in execute\n    self.errorhandler(self, exc, value)\n  File \"/home/classic/.venv/lib/python2.7/site-packages/MySQLdb/connections.py\", line 36, in defaulterrorhandler\n    raise errorclass, errorvalue\nsqlalchemy.exc.OperationalError: (_mysql_exceptions.OperationalError) (1305, 'SAVEPOINT sa_savepoint_1 does not exist') [SQL: u'ROLLBACK TO SAVEPOINT sa_savepoint_1']\n\n\n```\n\nso the assumption here would be MySQL fails the RELEASE for an unknown reason, but then *erases the savepoint anyway*.  That's unexpected on MySQL's part.\n\nHowever, it also means that the thing we fixed in this issue is still not working; in this codepath, we aren't sending this exception over to the warning that we added here; this patch would resolve that:\n\n```\ndiff --git a/lib/sqlalchemy/orm/session.py b/lib/sqlalchemy/orm/session.py\nindex 5651386..fcfd405 100644\n--- a/lib/sqlalchemy/orm/session.py\n+++ b/lib/sqlalchemy/orm/session.py\n@@ -492,9 +492,9 @@ class SessionTransaction(object):\n         if type is None:\n             try:\n                 self.commit()\n-            except:\n+            except Exception as e:\n                 with util.safe_reraise():\n-                    self.rollback()\n+                    self.rollback(_capture_exception=e)\n         else:\n             self.rollback()\n \n\n```\n\nCare to try the latter patch, reproduce your error, and get us some clue what MySQL is actually raising?\n\n\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919126/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919128","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919128","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919128,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTEyOA==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2016-01-28T16:02:13Z","updated_at":"2018-11-27T05:16:58Z","body":"**Michael Bayer ([@zzzeek](https://github.com/zzzeek)) wrote:**\n\nthere's at least one codepath that still does not warn, if the release itself fails.\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919128/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919152","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696#issuecomment-441919152","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","id":441919152,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkxOTE1Mg==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2016-01-28T16:02:13Z","updated_at":"2018-11-27T05:17:01Z","body":"**Changes by Michael Bayer ([@zzzeek](https://github.com/zzzeek)):**\n\n* changed **status** to reopened\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441919152/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}}]