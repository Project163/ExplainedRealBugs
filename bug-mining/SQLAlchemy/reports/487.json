{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3657","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3657/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3657/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3657/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3657","id":384636114,"node_id":"MDU6SXNzdWUzODQ2MzYxMTQ=","number":3657,"title":"positional result column logic failing","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269142,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141273873,"node_id":"MDU6TGFiZWwxMTQxMjczODcz","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/high%20priority","name":"high priority","color":"C0B0E0","default":false,"description":null},{"id":1141274001,"node_id":"MDU6TGFiZWwxMTQxMjc0MDAx","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/sql","name":"sql","color":"5060F0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/57","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/57","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/57/labels","id":3850634,"node_id":"MDk6TWlsZXN0b25lMzg1MDYzNA==","number":57,"title":"1.0.xx","description":null,"creator":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":127,"state":"closed","created_at":"2018-11-27T04:15:49Z","updated_at":"2018-11-28T16:49:57Z","due_on":null,"closed_at":"2018-11-28T16:49:57Z"},"comments":8,"created_at":"2016-02-20T05:27:54Z","updated_at":"2016-02-22T03:49:45Z","closed_at":"2016-02-21T01:44:21Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by Michael Bayer ([@zzzeek](https://github.com/zzzeek))**\n\nHavent fully tracked this down yet, suspect the query wrapping in mssql for LIMIT/OFFSET is causing this to happen.\n\nvery heisenbuggy, set PYTHONHASHEED=random and run lots of times against mssql:\n\n\n```\nimport sqlalchemy as sa\nimport sqlalchemy.orm as saorm\nfrom sqlalchemy.ext.declarative import declarative_base\n\n#engine = sa.create_engine('mssql+pymssql://badams:password@192.168.56.101:1443/testdb', echo=True)\n\nengine = sa.create_engine('mssql+pymssql://scott:tiger@192.168.122.232:1213/test', echo=True)\n\nsession = saorm.sessionmaker(bind=engine)()\n\nBase = declarative_base()\n\nclass Person(Base):\n    __tablename__ = 'people'\n    id = sa.Column(sa.Integer, primary_key=True)\n    name = sa.Column(sa.String)\n\nBase.metadata.create_all(engine)\n\nsession.query(Person).delete()\n\nsession.add(Person(name='foo'))\nsession.add(Person(name='bar'))\n\nsession.commit()\n\nresults = session.query(\n    Person.name.label('person'),\n).add_entity(\n    Person\n).order_by(\n    Person.name\n)\n\nprint results.count()\nprint results.limit(1).offset(1).all()\n\n\n```\n\nthe stack is a lie; to really make this fail we have to raise here (and this is another issue for 1.1, why aren't we raising here? )\n\n```\n--- a/lib/sqlalchemy/engine/result.py\n+++ b/lib/sqlalchemy/engine/result.py\n@@ -420,7 +427,8 @@ class ResultMetaData(object):\n         if key in self._keymap:\n             processor, obj, index = self._keymap[key]\n         else:\n-            ret = self._key_fallback(key, False)\n+            # MARKMARK\n+            ret = self._key_fallback(key) #, False)\n             if ret is None:\n                 return None\n             processor, obj, index = ret\n\n```\n\n\nso ultimately the compiler._result_columns is wrong.  on a bad run its:\n\n\n```\n[\n\n('person', 'person', (Column('name', String(), table=<people>), 'person', 'person'), String()), \n('people_id', 'people_id', (Column('id', Integer(), table=<people>, primary_key=True, nullable=False), 'people_id', 'people_id'), Integer()), ('people_name', 'people_name', (Column('name', String(), table=<people>), 'people_name', 'people_name'), String())\n\n]\n\n```\n\non a good run it's:\n\n```\n[\n\n('person', 'person', (<sqlalchemy.sql.elements.Label object at 0x7f46cc3dcf10>, 'person', 'person'), String()), \n('people_id', 'people_id', (Column('id', Integer(), table=<people>, primary_key=True, nullable=False), 'people_id', 'people_id'), Integer()), ('people_name', 'people_name', (Column('name', String(), table=<people>), 'people_name', 'people_name'), String())\n]\n\n```\n\nso our label is occasionally getting whacked from the result list, and its a dictionary ordering issue.   the LIMIT wrapping in mssql/base.py -> visit_select seems like it may be significant also.  \n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3657/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3657/timeline","performed_via_github_app":null,"state_reason":"completed"}