[{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441926171","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3208#issuecomment-441926171","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3208","id":441926171,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkyNjE3MQ==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2014-09-18T19:42:06Z","updated_at":"2018-11-27T05:37:44Z","body":"**Michael Bayer ([@zzzeek](https://github.com/zzzeek)) wrote:**\n\nOK well that cls() there is a weakref, so if it's returning None that means the weakref was garbage collected.  What happens next is that _remove_item gets called, but if that hasn't been called yet before something calls add_item(), that would cause this.\n\nPython's GC can be doing this asynchronously so this kind of thing can happen, however, it indicates you have a declarative class somewhere that is being garbage collected, which is the odd case here.  \n\nBut it doesn't matter, because this is all just to emit a warning and isn't so critical, and the loop there can just skip those references that aren't active.\n\nthe upcoming changeset will close this issue as fixed, if your issue persists with that changeset then reopen.\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441926171/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441926172","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3208#issuecomment-441926172","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3208","id":441926172,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkyNjE3Mg==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2014-09-18T19:42:57Z","updated_at":"2018-11-27T05:37:44Z","body":"**Michael Bayer ([@zzzeek](https://github.com/zzzeek)) wrote:**\n\n- Fixed an unlikely race condition observed in some exotic end-user\nsetups, where the attempt to check for \"duplicate class name\" in\ndeclarative would hit upon a not-totally-cleaned-up weak reference\nrelated to some other class being removed; the check here now ensures\nthe weakref still references an object before calling upon it further.\nfixes #3208\n\n\n→ c7ec21b29e92\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441926172/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441926174","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3208#issuecomment-441926174","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3208","id":441926174,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkyNjE3NA==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2014-09-18T19:42:57Z","updated_at":"2018-11-27T05:37:44Z","body":"**Michael Bayer ([@zzzeek](https://github.com/zzzeek)) wrote:**\n\n- Fixed an unlikely race condition observed in some exotic end-user\nsetups, where the attempt to check for \"duplicate class name\" in\ndeclarative would hit upon a not-totally-cleaned-up weak reference\nrelated to some other class being removed; the check here now ensures\nthe weakref still references an object before calling upon it further.\nfixes #3208\n\n\n→ 80cd802296af\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441926174/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441926177","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3208#issuecomment-441926177","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3208","id":441926177,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkyNjE3Nw==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2014-09-18T19:42:57Z","updated_at":"2018-11-27T05:37:44Z","body":"**Changes by Michael Bayer ([@zzzeek](https://github.com/zzzeek)):**\n\n* changed **status** to closed\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441926177/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":1988612648,"node_id":"MDExOkNsb3NlZEV2ZW50MTk4ODYxMjY0OA==","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/events/1988612648","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2014-09-18T19:42:57Z","state_reason":null,"performed_via_github_app":null},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441926178","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3208#issuecomment-441926178","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3208","id":441926178,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkyNjE3OA==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2014-09-18T19:44:12Z","updated_at":"2018-11-27T05:37:44Z","body":"**Changes by Michael Bayer ([@zzzeek](https://github.com/zzzeek)):**\n\n* set **milestone** to \"0.9.8\"\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441926178/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441926175","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3208#issuecomment-441926175","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3208","id":441926175,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkyNjE3NQ==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2014-09-19T22:29:38Z","updated_at":"2018-11-27T05:37:44Z","body":"**Scott Milliken ([@smilliken](https://github.com/smilliken)) wrote:**\n\nYour hypothesis seems like the most reasonable cause. Running your fix in production for lack of a way to reproduce, but I'm certain that'll address it.\n\nAppreciate you taking the time to look into this!\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441926175/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":1988612641,"node_id":"MDEyOkxhYmVsZWRFdmVudDE5ODg2MTI2NDE=","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/events/1988612641","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2018-11-27T05:37:43Z","label":{"name":"declarative","color":"602050"},"performed_via_github_app":null},{"id":1988612642,"node_id":"MDEyOkxhYmVsZWRFdmVudDE5ODg2MTI2NDI=","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/events/1988612642","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2018-11-27T05:37:43Z","label":{"name":"bug","color":"d73a4a"},"performed_via_github_app":null},{"id":1988612643,"node_id":"MDEyOkxhYmVsZWRFdmVudDE5ODg2MTI2NDM=","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/events/1988612643","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2018-11-27T05:37:43Z","label":{"name":"low priority","color":"90C0D0"},"performed_via_github_app":null},{"id":1988612644,"node_id":"MDE1Ok1pbGVzdG9uZWRFdmVudDE5ODg2MTI2NDQ=","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/events/1988612644","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"milestoned","commit_id":null,"commit_url":null,"created_at":"2018-11-27T05:37:43Z","milestone":{"title":"0.9.8"},"performed_via_github_app":null},{"actor":{"login":"yilei","id":581947,"node_id":"MDQ6VXNlcjU4MTk0Nw==","avatar_url":"https://avatars.githubusercontent.com/u/581947?v=4","gravatar_id":"","url":"https://api.github.com/users/yilei","html_url":"https://github.com/yilei","followers_url":"https://api.github.com/users/yilei/followers","following_url":"https://api.github.com/users/yilei/following{/other_user}","gists_url":"https://api.github.com/users/yilei/gists{/gist_id}","starred_url":"https://api.github.com/users/yilei/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yilei/subscriptions","organizations_url":"https://api.github.com/users/yilei/orgs","repos_url":"https://api.github.com/users/yilei/repos","events_url":"https://api.github.com/users/yilei/events{/privacy}","received_events_url":"https://api.github.com/users/yilei/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-12-19T20:41:36Z","updated_at":"2023-12-19T20:41:36Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/10782","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/10782/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/10782/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/10782/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/10782","id":2049402396,"node_id":"I_kwDOCX5JB856J2Yc","number":10782,"title":"`RuntimeError: Set changed size during iteration` raised in clsregistry _MultipleClassMarker.add_item","user":{"login":"yilei","id":581947,"node_id":"MDQ6VXNlcjU4MTk0Nw==","avatar_url":"https://avatars.githubusercontent.com/u/581947?v=4","gravatar_id":"","url":"https://api.github.com/users/yilei","html_url":"https://github.com/yilei","followers_url":"https://api.github.com/users/yilei/followers","following_url":"https://api.github.com/users/yilei/following{/other_user}","gists_url":"https://api.github.com/users/yilei/gists{/gist_id}","starred_url":"https://api.github.com/users/yilei/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yilei/subscriptions","organizations_url":"https://api.github.com/users/yilei/orgs","repos_url":"https://api.github.com/users/yilei/repos","events_url":"https://api.github.com/users/yilei/events{/privacy}","received_events_url":"https://api.github.com/users/yilei/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269142,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/89","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/89","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/89/labels","id":4398560,"node_id":"MDk6TWlsZXN0b25lNDM5ODU2MA==","number":89,"title":"1.4.x","description":null,"creator":{"login":"zzzeek","id":128223,"node_id":"MDQ6VXNlcjEyODIyMw==","avatar_url":"https://avatars.githubusercontent.com/u/128223?v=4","gravatar_id":"","url":"https://api.github.com/users/zzzeek","html_url":"https://github.com/zzzeek","followers_url":"https://api.github.com/users/zzzeek/followers","following_url":"https://api.github.com/users/zzzeek/following{/other_user}","gists_url":"https://api.github.com/users/zzzeek/gists{/gist_id}","starred_url":"https://api.github.com/users/zzzeek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zzzeek/subscriptions","organizations_url":"https://api.github.com/users/zzzeek/orgs","repos_url":"https://api.github.com/users/zzzeek/repos","events_url":"https://api.github.com/users/zzzeek/events{/privacy}","received_events_url":"https://api.github.com/users/zzzeek/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":522,"state":"open","created_at":"2019-06-11T16:37:26Z","updated_at":"2025-06-19T15:15:28Z","due_on":null,"closed_at":null},"comments":5,"created_at":"2023-12-19T20:41:35Z","updated_at":"2023-12-24T13:44:44Z","closed_at":"2023-12-24T13:44:43Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":159271175,"node_id":"MDEwOlJlcG9zaXRvcnkxNTkyNzExNzU=","name":"sqlalchemy","full_name":"sqlalchemy/sqlalchemy","private":false,"owner":{"login":"sqlalchemy","id":6043126,"node_id":"MDEyOk9yZ2FuaXphdGlvbjYwNDMxMjY=","avatar_url":"https://avatars.githubusercontent.com/u/6043126?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy","html_url":"https://github.com/sqlalchemy","followers_url":"https://api.github.com/users/sqlalchemy/followers","following_url":"https://api.github.com/users/sqlalchemy/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy/orgs","repos_url":"https://api.github.com/users/sqlalchemy/repos","events_url":"https://api.github.com/users/sqlalchemy/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/sqlalchemy/sqlalchemy","description":"The Database Toolkit for Python","fork":false,"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","forks_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/forks","keys_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/keys{/key_id}","collaborators_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/teams","hooks_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/hooks","issue_events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/events{/number}","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/events","assignees_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/assignees{/user}","branches_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/branches{/branch}","tags_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/tags","blobs_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/git/refs{/sha}","trees_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/git/trees{/sha}","statuses_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/statuses/{sha}","languages_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/languages","stargazers_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/stargazers","contributors_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/contributors","subscribers_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/subscribers","subscription_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/subscription","commits_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/commits{/sha}","git_commits_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/git/commits{/sha}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/comments{/number}","issue_comment_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments{/number}","contents_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/contents/{+path}","compare_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/compare/{base}...{head}","merges_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/merges","archive_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/downloads","issues_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues{/number}","pulls_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/pulls{/number}","milestones_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones{/number}","notifications_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels{/name}","releases_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/releases{/id}","deployments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/deployments","created_at":"2018-11-27T03:35:03Z","updated_at":"2025-11-10T08:14:59Z","pushed_at":"2025-11-09T19:21:36Z","git_url":"git://github.com/sqlalchemy/sqlalchemy.git","ssh_url":"git@github.com:sqlalchemy/sqlalchemy.git","clone_url":"https://github.com/sqlalchemy/sqlalchemy.git","svn_url":"https://github.com/sqlalchemy/sqlalchemy","homepage":"https://www.sqlalchemy.org","size":97110,"stargazers_count":11107,"watchers_count":11107,"language":"Python","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":true,"forks_count":1596,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":219,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["python","sql","sqlalchemy"],"visibility":"public","forks":1596,"open_issues":219,"watchers":11107,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"### Describe the bug\r\n\r\nWe have several tests that use flask and sqlalchemy, they create & destroy the database multiple times for each test case in a single test invocation. They use automap_base to generate mapped classes.\r\n\r\nWe saw the tests can fail with a `RuntimeError: Set changed size during iteration` raised here:\r\nhttps://github.com/sqlalchemy/sqlalchemy/blob/6e089c3dbf7e7348da84dfc62cc1c6100a257fd4/lib/sqlalchemy/orm/clsregistry.py#L245\r\n\r\nUpon investigation, when running the list comprehension `[ref() for ref in self.contents]`, the `self.contents` set itself could be modified during a GC cycle when `_remove_item` is called.\r\n\r\nI believe this is a similar issue as https://github.com/sqlalchemy/sqlalchemy/issues/3208 linked in a comment from `add_item`, and the fix is to protect this by making a copy:\r\n\r\n```python\r\n        # protect against class registration race condition against\r\n        # asynchronous garbage collection calling _remove_item,\r\n        # [ticket:3208]\r\n        modules = {\r\n            cls.__module__\r\n            for cls in [ref() for ref in self.contents.copy()]\r\n            if cls is not None\r\n        }\r\n```\r\n\r\n### Optional link from https://docs.sqlalchemy.org which documents the behavior that is expected\r\n\r\n_No response_\r\n\r\n### SQLAlchemy Version in Use\r\n\r\n1.4.35\r\n\r\n### DBAPI (i.e. the database driver)\r\n\r\npymysql\r\n\r\n### Database Vendor and Major Version\r\n\r\nMySQL 5.6\r\n\r\n### Python Version\r\n\r\n3.11\r\n\r\n### Operating system\r\n\r\nLinux\r\n\r\n### To Reproduce\r\n\r\nUnfortunately, the tests we have are fairly large, and I have only been successfully reproduce it in the tests, not a stripped down version.\r\n\r\nI hope this is understandable since the bug is triggered by a Python GC cycle, and I also hope the fix should be clear.\r\n\r\n### Error\r\n\r\n```\r\n  File \"sqlalchemy/ext/automap.py\", line 891, in prepare\r\n    mapped_cls = type(\r\n                 ^^^^^\r\n  File \"sqlalchemy/orm/decl_api.py\", line 72, in __init__\r\n    _as_declarative(reg, cls, dict_)\r\n  File \"sqlalchemy/orm/decl_base.py\", line 126, in _as_declarative\r\n    return _MapperConfig.setup_mapping(registry, cls, dict_, None, {})\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"sqlalchemy/orm/decl_base.py\", line 177, in setup_mapping\r\n    return cfg_cls(registry, cls_, dict_, table, mapper_kw)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"sqlalchemy/orm/decl_base.py\", line 314, in __init__\r\n    clsregistry.add_class(\r\n  File \"sqlalchemy/orm/clsregistry.py\", line 69, in add_class\r\n    module.add_class(classname, cls)\r\n  File \"sqlalchemy/orm/clsregistry.py\", line 231, in add_class\r\n    existing.add_item(cls)\r\n  File \"sqlalchemy/orm/clsregistry.py\", line 171, in <listcomp>\r\n  for cls in [ref() for ref in self.contents]\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nRuntimeError: Set changed size during iteration\r\n```\r\n\r\n### Additional context\r\n\r\nI'm also reading the code in sqlalchemy 2.0, it has a new `bookkeeping` mechanism in automap prepare while the 1.x versions don't:\r\n\r\nhttps://github.com/sqlalchemy/sqlalchemy/blob/6e089c3dbf7e7348da84dfc62cc1c6100a257fd4/lib/sqlalchemy/ext/automap.py#L1243-L1245\r\n\r\nThis _might_ also make this bug no longer reproducible, since in our tests they are using a shared `AutomapBase` for different test cases, and the new bookkeeping appears to make it no longer re-creating the classes when we call prepare with new instances of the databases.","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/10782/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/10782/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"}]