{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3199","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3199/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3199/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3199/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3199","id":384631918,"node_id":"MDU6SXNzdWUzODQ2MzE5MTg=","number":3199,"title":"deduplication of events doesn't work for wrapped events","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269142,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141275752,"node_id":"MDU6TGFiZWwxMTQxMjc1NzUy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/engine","name":"engine","color":"B04040","default":false,"description":"engines, connections, transactions, isolation levels, execution options"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/58","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/58","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/58/labels","id":3850635,"node_id":"MDk6TWlsZXN0b25lMzg1MDYzNQ==","number":58,"title":"0.9.8","description":null,"creator":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":35,"state":"closed","created_at":"2018-11-27T04:17:17Z","updated_at":"2018-11-28T16:49:57Z","due_on":null,"closed_at":"2018-11-28T16:49:57Z"},"comments":24,"created_at":"2014-09-16T15:15:42Z","updated_at":"2014-09-19T11:29:26Z","closed_at":"2014-09-18T19:27:54Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by Leonardo Rossi ([@hachreak](https://github.com/hachreak))**\n\nupdate: this specifically hits the _stored_in_collection assertion because the check for `if event_key._listen_fn not in self.listeners` fails for an event key with wrapping.  \n\nI'm using Invenio 2.0 and try to replace old version of SQLAlchemy 0.8.7 with the last 0.9.7.\nThe utility to automaticaly create the db works (inveniomanage database recreate --yes-i-know).\n\nBut when I start tests with: python setup.py test\n\nIt return me a error:\n\n    test_fisrt_blueprint (invenio.testsuite.test_ext_template.TemplateLoaderCase) ... --------------------------------------------------------------------------------\n    ERROR in wrappers [/home/vagrant/.virtualenvs/invenio2/src/invenio/invenio/ext/logging/wrappers.py:310]:\n    \n    --------------------------------------------------------------------------------\n    Traceback (most recent call last):\n      File \"/home/vagrant/.virtualenvs/invenio2/src/invenio/invenio/ext/legacy/__init__.py\", line 124, in __call__\n        response = self.app.full_dispatch_request()\n      File \"/home/vagrant/.virtualenvs/invenio2/local/lib/python2.7/site-packages/flask/app.py\", line 1470, in full_dispatch_request\n        self.try_trigger_before_first_request_functions()\n      File \"/home/vagrant/.virtualenvs/invenio2/local/lib/python2.7/site-packages/flask/app.py\", line 1497, in try_trigger_before_first_request_functions\n        func()\n      File \"/home/vagrant/.virtualenvs/invenio2/src/invenio/invenio/modules/messages/views.py\", line 264, in invoke_email_alert_register\n        email_alert_register()\n      File \"/home/vagrant/.virtualenvs/invenio2/src/invenio/invenio/modules/messages/models.py\", line 202, in email_alert_register\n        event.listen(MsgMESSAGE, 'after_insert', email_alert)\n      File \"/home/vagrant/.virtualenvs/invenio2/local/lib/python2.7/site-packages/sqlalchemy/event/api.py\", line 63, in listen\n        _event_key(target, identifier, fn).listen(*args, **kw)\n      File \"/home/vagrant/.virtualenvs/invenio2/local/lib/python2.7/site-packages/sqlalchemy/event/registry.py\", line 187, in listen\n        self.dispatch_target.dispatch._listen(self, *args, **kw)\n      File \"/home/vagrant/.virtualenvs/invenio2/local/lib/python2.7/site-packages/sqlalchemy/orm/events.py\", line 547, in _listen\n        event_key.base_listen(**kw)\n      File \"/home/vagrant/.virtualenvs/invenio2/local/lib/python2.7/site-packages/sqlalchemy/event/registry.py\", line 226, in base_listen\n        for_modify(target.dispatch).append(self, propagate)\n      File \"/home/vagrant/.virtualenvs/invenio2/local/lib/python2.7/site-packages/sqlalchemy/event/attr.py\", line 328, in append\n        event_key.append_to_list(self, self.listeners)\n      File \"/home/vagrant/.virtualenvs/invenio2/local/lib/python2.7/site-packages/sqlalchemy/event/registry.py\", line 237, in append_to_list\n        _stored_in_collection(self, owner)\n      File \"/home/vagrant/.virtualenvs/invenio2/local/lib/python2.7/site-packages/sqlalchemy/event/registry.py\", line 74, in _stored_in_collection\n        assert dispatch_reg[owner_ref] == listen_ref\n    AssertionError\n\nIn /home/vagrant/.virtualenvs/invenio2/src/invenio/invenio/modules/messages/views.py (row 264)\n\n    \n\n```\n# Registration of email_alert invoked from blueprint\n# in order to use before_app_first_request.\n# Reading config CFG_WEBMESSAGE_EMAIL_ALERT\n# required app context.\n@blueprint.before_app_first_request\ndef invoke_email_alert_register():\n    email_alert_register()\n```\n\n\nIn /home/vagrant/.virtualenvs/invenio2/src/invenio/invenio/modules/messages/models.py (row 202)\n\n\n```\n# Registration of email_alert invoked from blueprint\n# in order to use before_app_first_request.\n# Reading config CFG_WEBMESSAGE_EMAIL_ALERT\n# required app context.\ndef email_alert_register():\n    if cfg['CFG_WEBMESSAGE_EMAIL_ALERT']:\n        from sqlalchemy import event\n        # Register after insert callback.\n        event.listen(MsgMESSAGE, 'after_insert', email_alert)\n```\n\n\nSomeone can help me? :)\n(Sorry, this is my first issues and I don't know how to set \"kind\", etc... T_T)\n\nInstalled:\n\n*     -e git+https://github.com/mitsuhiko/flask-sqlalchemy@c7eccba63314f3ea77e2c6217d3d3c8b0d2552fd#egg=Flask_SQLAlchemy-2.0\n*     MySQL-python==1.2.5\n*     SQLAlchemy==0.9.7\n*     SQLAlchemy-Utils==0.23.5\n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3199/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3199/timeline","performed_via_github_app":null,"state_reason":"completed"}