{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3208","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3208/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3208/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3208/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3208","id":384631996,"node_id":"MDU6SXNzdWUzODQ2MzE5OTY=","number":3208,"title":"AttributeError in sqlalchemy.ext.declarative.clsregistry._MultipleClassMarker.add_item","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269142,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141273863,"node_id":"MDU6TGFiZWwxMTQxMjczODYz","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/low%20priority","name":"low priority","color":"90C0D0","default":false,"description":null},{"id":1141297829,"node_id":"MDU6TGFiZWwxMTQxMjk3ODI5","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/declarative","name":"declarative","color":"602050","default":false,"description":"has to do with the declarative API, scanning classes and mixins for attributes to be mapped"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/58","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/58","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/58/labels","id":3850635,"node_id":"MDk6TWlsZXN0b25lMzg1MDYzNQ==","number":58,"title":"0.9.8","description":null,"creator":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":35,"state":"closed","created_at":"2018-11-27T04:17:17Z","updated_at":"2018-11-28T16:49:57Z","due_on":null,"closed_at":"2018-11-28T16:49:57Z"},"comments":6,"created_at":"2014-09-18T19:22:49Z","updated_at":"2014-09-19T22:29:38Z","closed_at":"2014-09-18T19:42:57Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by Scott Milliken ([@smilliken](https://github.com/smilliken))**\n\nWe've been getting occasional AttributeError exceptions raised from the `sqlalchemy.ext.declarative.clsregistry._MultipleClassMarker.add_item` method as it tries to access a `__module__` attribute here: https://github.com/zzzeek/sqlalchemy/blob/28dd15081db4b7e978fa7a187c3aef1c0e4ad4e3/lib/sqlalchemy/ext/declarative/clsregistry.py#L106.\n\nI haven't been able to identify the root cause or reliably reproduce the bug, but we are doing something fancy that's almost certainly related.\n\nUsing SQLAlchemy 0.9.6, Python 2.7.2, running inside Apache2.\n\nStacktrace:\n\n```\n Module ourmodule1:37 in __init__\n<<\n>>  partition = aliased(get_partition_model(session, PartitionedTable))\nModule ourmodule2:203 in get_partition_model\nModule ourmodule2:190 in cons_model\nModule sqlalchemy.ext.declarative.api:53 in __init__\n<<      def __init__(cls, classname, bases, dict_):\n               if '_decl_class_registry' not in cls.__dict__:\n                   _as_declarative(cls, classname, cls.__dict__)\n               type.__init__(cls, classname, bases, dict_)\n>>  _as_declarative(cls, classname, cls.__dict__)\nModule sqlalchemy.ext.declarative.base:148 in _as_declarative\n<<          table_args = None\n      \n           clsregistry.add_class(classname, cls)\n           our_stuff = util.OrderedDict()\n>>  clsregistry.add_class(classname, cls)\nModule sqlalchemy.ext.declarative.clsregistry:64 in add_class\n<<          for token in tokens:\n                   module = module.get_module(token)\n               module.add_class(classname, cls)\n>>  module.add_class(classname, cls)\nModule sqlalchemy.ext.declarative.clsregistry:160 in add_class\n<<          if name in self.contents:\n                   existing = self.contents[name]\n                   existing.add_item(cls)\n               else:\n                   existing = self.contents[name] = \\\n>>  existing.add_item(cls)\nModule sqlalchemy.ext.declarative.clsregistry:105 in add_item\n<<      def add_item(self, item):\n               modules = set([cls().__module__ for cls in self.contents])\n               if item.__module__ in modules:\n                   util.warn(\n>>  modules = set([cls().__module__ for cls in self.contents])\nAttributeError: 'NoneType' object has no attribute '__module__'\n```\n\nThe fanciness I mentioned is the `get_partition_model` function referenced in the stacktrace. The purpose of this function is to take the SQLAlchemy model for a PostgreSQL paritioned table (using table inheritance), and return a new SQLAlchemy model for the named partition. We cannot use SQLAlchemy's inheritance facilities because there's no discriminator column in the table partitions we can use. Here's the implementation of this function:\n\n\n```\ndef get_partition_model(session, model, partition_id=None):\n    '''\n    Get a model specialized for the child partition identified by @partition_id.\n\n    Assumes partitions are named like '%(parent_table)s_%(partition_id)s'.\n\n    If @partition_id is None, then the partition with the latest lexical sort will be returned.\n    '''\n    def cons_model(partition_name):\n        classname = str('%s%s' % (model.__name__, partition_name.split('_')[-1]))\n        if classname in model._decl_class_registry:\n            return model._decl_class_registry[classname]\n        newtable = copy.copy(model.__table__)\n        newtable.name = partition_name\n        for col in newtable.columns:\n            col.table = newtable\n        return type(classname, (model,), {\n            '__table__': newtable,\n            '__tablename__': partition_name,\n            '__mapper_args__': {'concrete': True}\n        })\n    tablename = model.__table__.name\n    # NB: get_child_tables returns a list of partition tables using pg_class and pg_inherits\n    partitions = get_child_tables(session, tablename)\n    if not partitions:\n        return\n    if partition_id:\n        partition_name = '%s_%s' % (tablename, partition_id)\n        if partition_name not in partitions:\n            raise ValueError('No such partition %r for %r' % (partition_id, tablename))\n    else:\n        partition_name = max(partitions)\n    return cons_model(partition_name)\n```\n\nThis code works approximately 100% of the time, but on rare occasions triggers the AttributeError mentioned. If I were to guess, I'd assume there's a race condition/thread safety issue (not neccessarily in SQLAlchemy).\n\nAdmittedly, this is a poor bug report since we're doing something fancy with dynamically created models, and I haven't given you any way to reproduce this. I thought I'd report it anyway in case it's obvious to you what's going on or if it invalidates some assumption in the code.\n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3208/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3208/timeline","performed_via_github_app":null,"state_reason":"completed"}