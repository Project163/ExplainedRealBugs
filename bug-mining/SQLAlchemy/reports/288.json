{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3310","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3310/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3310/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3310/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3310","id":384632933,"node_id":"MDU6SXNzdWUzODQ2MzI5MzM=","number":3310,"title":"Relationship __ne__ does not handle aliased() properly when comparing NULL","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269142,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141273966,"node_id":"MDU6TGFiZWwxMTQxMjczOTY2","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/orm","name":"orm","color":"20C0B0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/73","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/73","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/73/labels","id":3850657,"node_id":"MDk6TWlsZXN0b25lMzg1MDY1Nw==","number":73,"title":"0.9.9","description":null,"creator":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":14,"state":"closed","created_at":"2018-11-27T04:29:57Z","updated_at":"2018-11-28T16:50:02Z","due_on":null,"closed_at":"2018-11-28T16:50:02Z"},"comments":11,"created_at":"2015-02-20T18:47:03Z","updated_at":"2015-02-20T20:17:45Z","closed_at":"2015-02-20T20:17:45Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by Brandon Clarke ([@bc2297](https://github.com/bc2297))**\n\nFound from SO post [Here](https://stackoverflow.com/questions/28610563/sqlalchemy-different-output-on-queries-field-is-null-and-is-not-null-on-ali).\n\nSample code to reproduce:\n\n    from sqlalchemy import *\n    from sqlalchemy.orm import aliased\n    from sqlalchemy.ext.declarative import declarative_base\n    from sqlalchemy.orm import relation, sessionmaker, relationship, backref\n\n    Base = declarative_base()\n\n    class Parent(Base):\n        __tablename__ = 'parent'\n        id = Column(Integer, primary_key=True)\n        children = relation('Child', back_populates='parents')\n\n    class Child(Base):\n        __tablename__ = 'child'\n        id = Column(Integer, primary_key=True)\n        parent_id = Column(Integer, ForeignKey('parent.id'))\n        parents = relation('Parent', back_populates='children', uselist=False)\n\n    aChild = aliased(Child)\n\n    Session = sessionmaker()\n    Session = Session()\n\n    print Session.query(aChild.id).filter(~(aChild.parents == None))\n    \"\"\" SELECT children_1.id AS children_1_id\n        FROM children AS children_1\n        WHERE children_1.parent_id IS NOT NULL\n    \"\"\"\n\n    print Session.query(aChild.id).filter(aChild.parents != None) #failing case\n    \"\"\" SELECT children_1.id AS children_1_id\n        FROM children AS children_1, children\n        WHERE children.parent_id IS NOT NULL\n    \"\"\"\n\nI did some poking around and have a proposed fix in relationships.py, below:\n\n    @@ -1291,8 +1291,8 @@ class RelationshipProperty(StrategizedProperty):\n             \"\"\"\n                 if isinstance(other, (util.NoneType, expression.Null)):\n                     if self.property.direction == MANYTOONE:\n    -                    return sql.or_(*[x != None for x in\n    -                                     self.property._calculated_foreign_keys])\n    +                    return _orm_annotate(~self.property._optimized_compare(\n    +                        None, adapt_source=self.adapter))\n\nI basically used the logic in place for __eq__ and inverted it. It passes all existing test cases, I'm just working on creating a test case for this failure mode. I was planning on wrapping up a pull request today. If there are any suggestions for where to locate the test, please let me know. First time submitting anything here, so if I'm doing anything wrong, please let me know that too\n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3310/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3310/timeline","performed_via_github_app":null,"state_reason":"completed"}