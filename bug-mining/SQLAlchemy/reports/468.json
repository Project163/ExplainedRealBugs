{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2349","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2349/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2349/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2349/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2349","id":384624669,"node_id":"MDU6SXNzdWUzODQ2MjQ2Njk=","number":2349,"title":"passive_deletes for joined table inheritance","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141273925,"node_id":"MDU6TGFiZWwxMTQxMjczOTI1","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/feature","name":"feature","color":"306080","default":false,"description":null},{"id":1141273966,"node_id":"MDU6TGFiZWwxMTQxMjczOTY2","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/orm","name":"orm","color":"20C0B0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/41","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/41","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/41/labels","id":3850610,"node_id":"MDk6TWlsZXN0b25lMzg1MDYxMA==","number":41,"title":"1.1","description":null,"creator":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":96,"state":"closed","created_at":"2018-11-27T04:03:36Z","updated_at":"2018-11-28T16:49:52Z","due_on":null,"closed_at":"2018-11-28T16:49:52Z"},"comments":5,"created_at":"2011-12-15T10:16:51Z","updated_at":"2016-01-20T23:01:01Z","closed_at":"2016-01-20T23:00:43Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by Michael Bayer ([@zzzeek](https://github.com/zzzeek))**\n\nthis is not supported right now, a SELECT is emitted in all cases if the PK of the child table is not synonymous with the parent.\n\n\n    from sqlalchemy import *\n    from sqlalchemy.orm import *\n    from sqlalchemy.ext.declarative import declarative_base\n    \n    Base= declarative_base()\n    \n    class A(Base):\n        __tablename__ = \"a\"\n        id = Column('id', Integer, primary_key=True)\n        type = Column(String)\n        __mapper_args__ = {\n            'polymorphic_on':type,\n            'polymorphic_identity':'a'\n        }\n    class B(A):\n        __tablename__ = 'b'\n        b_table_id = Column('b_table_id', Integer, primary_key=True)\n        bid = Column('bid', Integer, ForeignKey('a.id'))\n        data = Column('data', String)\n        __mapper_args__ = {\n            'polymorphic_identity':'b'\n        }\n    \n    e = create_engine(\"postgresql://scott:tiger@localhost/test\", echo=True)\n    Base.metadata.drop_all(e)\n    Base.metadata.create_all(e)\n    s = Session(e)\n    \n    s.add(B(b_table_id=5))\n    s.commit()\n    s.close()\n    \n    b1 = s.query(A).first()\n    s.delete(b1)\n    # emits load for \"b\" as we don't have b_table_id\n    s.commit()\n\n\nnow here is the thing.   We are in fact just loading the \"B\" row based on the FK:\n\n\n    SELECT b.bid AS b_bid, b.b_table_id AS b_b_table_id, b.data AS b_data \n    FROM b \n    WHERE %(param_1)s = b.bid\n    {'param_1': 1}\n    DELETE FROM b WHERE b.b_table_id = %(b_table_id)s\n    {'b_table_id': 5}\n    DELETE FROM a WHERE a.id = %(id)s\n\n\nso in theory, we could at least skip the need for the SELECT if we emitted the DELETE based on the FK criterion !   That would work in all cases without a flag.   The DELETE would check that exactly one row was deleted.\n\nThis would be a non-trivial enhancement as the whole mechanism of mapper._delete_obj() would become more complex.\n\nA passive_deletes equivalent flag would also make mapper._delete_obj() more complex but not as much as it means we just skip the dependent table, rather than constructing a new kind of DELETE.\n\nConsider opening a second ticket to distinguish the \"delete on FKs\" optimization from the \"add passive_deletes\" optimization.  In all likelihood we'd skip the more elaborate one as the new flag would be the better solution in any case, if the target backend supports ON DELETE CASCADE.\n\nMake sure this caveat is documented in the inheritance docs, and suggest query.delete() and passive_deletes=True as preferred workarounds to the \"SELECT a row to DELETE it\" problem.\n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2349/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2349/timeline","performed_via_github_app":null,"state_reason":"completed"}