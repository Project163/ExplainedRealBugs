{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3592","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3592/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3592/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3592/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3592","id":384635491,"node_id":"MDU6SXNzdWUzODQ2MzU0OTE=","number":3592,"title":"logic to ensure parent cols present in joined eager load inappropriately turns off for m2m","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269142,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141273966,"node_id":"MDU6TGFiZWwxMTQxMjczOTY2","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/orm","name":"orm","color":"20C0B0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/57","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/57","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/57/labels","id":3850634,"node_id":"MDk6TWlsZXN0b25lMzg1MDYzNA==","number":57,"title":"1.0.xx","description":null,"creator":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":127,"state":"closed","created_at":"2018-11-27T04:15:49Z","updated_at":"2018-11-28T16:49:57Z","due_on":null,"closed_at":"2018-11-28T16:49:57Z"},"comments":4,"created_at":"2015-11-21T21:32:42Z","updated_at":"2015-11-21T21:48:20Z","closed_at":"2015-11-21T21:48:20Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by Michael Bayer ([@zzzeek](https://github.com/zzzeek))**\n\nthis issue is usually missed because a. we always undefer the primary columns of the parent mapper and b. the join condition of a relationship almost always refers to the primary columns of the parent mapper.     if we are using joined-table-inheritance, then c. the PK col in the subclass is usually named the same as the parent PK col, is grouped into the same attribute name, and is therefore undeferred via the logic in https://bitbucket.org/zzzeek/sqlalchemy/src/ef9a4cb60b4e7fe305367c5223e8bb2cbf2b3b0f/lib/sqlalchemy/orm/strategies.py?at=master&fileviewer=file-view-default#strategies.py-230.\n\nIf all of the above is *not* the case, then the logic at https://bitbucket.org/zzzeek/sqlalchemy/src/ef9a4cb60b4e7fe305367c5223e8bb2cbf2b3b0f/lib/sqlalchemy/orm/strategies.py?at=master&fileviewer=file-view-default#strategies.py-1370 adds the column to the query anyway, but *only* if there's no secondaryjoin.  The whole block here appears to be uncovered by tests in any case.\n\nSo the criteria is:\n\n1. The query defers/excludes a parent column used in the join condition\n2. joinedload is used\n3. the excluded column is not part of the *mapper* primary key of the parent, note this includes both columns that are totally not PK or are a differently-named PK col on a joined-inh subtable\n4. the relationship includes \"secondary\"\n5. the query uses limit/offset so is subject to the subquery-on-joinedload behavior.\n\nIf you have all five of those things, here's the bug:\n\n\n\n```\nfrom sqlalchemy import *\nfrom sqlalchemy.orm import *\nfrom sqlalchemy.ext.declarative import declarative_base\n\nBase = declarative_base()\n\n\nclass A(Base):\n    __tablename__ = 'a'\n    id = Column(Integer, primary_key=True)\n\n\nclass ASub(A):\n    __tablename__ = 'asub'\n    sub_id = Column(ForeignKey('a.id'), primary_key=True)\n\n    bs = relationship(\"B\", secondary=Table(\n    \t'atob', Base.metadata,\n    \tColumn('aid', ForeignKey('asub.sub_id')),\n    \tColumn('bid', ForeignKey('b.id'))\n    ))\n\n\nclass B(Base):\n    __tablename__ = 'b'\n    id = Column(Integer, primary_key=True)\n\ne = create_engine(\"sqlite://\", echo=True)\nBase.metadata.create_all(e)\n\ns = Session(e)\ns.query(ASub).options(load_only('id'), joinedload(ASub.bs)).limit(10).all()\n```\n\nerror:\n\n\n```\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such column: asub.sub_id [SQL: u'SELECT anon_1.a_id AS anon_1_a_id, anon_2.b_1_id AS b_1_id \\nFROM (SELECT a.id AS a_id \\nFROM a JOIN asub ON a.id = asub.sub_id\\n LIMIT ? OFFSET ?) AS anon_1 LEFT OUTER JOIN (SELECT atob_1.aid AS atob_1_aid, atob_1.bid AS atob_1_bid, b_1.id AS b_1_id \\nFROM atob AS atob_1 JOIN b AS b_1 ON b_1.id = atob_1.bid) AS anon_2 ON asub.sub_id = anon_2.atob_1_aid'] [parameters: (10, 0)]\n\n```\n\npatch!  \n\n\n```\ndiff --git a/lib/sqlalchemy/orm/strategies.py b/lib/sqlalchemy/orm/strategies.py\nindex 67dac1c..7de470d 100644\n--- a/lib/sqlalchemy/orm/strategies.py\n+++ b/lib/sqlalchemy/orm/strategies.py\n@@ -1367,8 +1367,7 @@ class JoinedLoader(AbstractRelationshipLoader):\n         # send a hint to the Query as to where it may \"splice\" this join\n         eagerjoin.stop_on = entity.selectable\n \n-        if self.parent_property.secondary is None and \\\n-                not parentmapper:\n+        if not parentmapper:\n             # for parentclause that is the non-eager end of the join,\n             # ensure all the parent cols in the primaryjoin are actually\n             # in the\n\n```\n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3592/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3592/timeline","performed_via_github_app":null,"state_reason":"completed"}