{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3220","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3220/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3220/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3220/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3220","id":384632132,"node_id":"MDU6SXNzdWUzODQ2MzIxMzI=","number":3220,"title":"Several small issues with Oracle recursive queries","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269142,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141275752,"node_id":"MDU6TGFiZWwxMTQxMjc1NzUy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/engine","name":"engine","color":"B04040","default":false,"description":"engines, connections, transactions, isolation levels, execution options"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/42","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/42","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/42/labels","id":3850611,"node_id":"MDk6TWlsZXN0b25lMzg1MDYxMQ==","number":42,"title":"1.0","description":null,"creator":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":101,"state":"closed","created_at":"2018-11-27T04:04:03Z","updated_at":"2018-11-28T16:49:52Z","due_on":null,"closed_at":"2018-11-28T16:49:52Z"},"comments":48,"created_at":"2014-10-03T19:18:55Z","updated_at":"2015-03-20T02:35:45Z","closed_at":"2014-12-05T00:46:06Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by Mariano Mara ([@marplatense](https://github.com/marplatense))**\n\nHi Mike, I'm trying to use the same CTE I have working for PG with Oracle (since Oracle now supports CTE), however there are several small issues that prevents the use of SQLAlchemy's CTE with Oracle as transparently as it is possible with PG (I need to make it work with SQL Server too but so far I have not tested it). \n\n1- The first issue is regarding the **RECURSIVE** keyword. Here is a simple script that includes everything required to reproduce the problem.\n\n\n```\nfrom sqlalchemy.orm import aliased\nfrom sqlalchemy import String, Integer, Column, func, create_engine\nfrom sqlalchemy.ext.declarative import declarative_base\nfrom sqlalchemy.orm import sessionmaker\nengine = create_engine('oracle://scott:tiger@localhost:1521/xe', echo=True)\nBase = declarative_base()\nclass Part(Base):\n    __tablename__ = 'part'\n    part = Column(String(200), primary_key=True)\n    sub_part = Column(String(200), primary_key=True)\n    quantity = Column(Integer)\nBase.metadata.create_all(engine)\nSession = sessionmaker(bind=engine)\nsession = Session()\nincluded_parts = session.query(\n                Part.sub_part,\n                Part.part,\n                Part.quantity).\\\n                    filter(Part.part==\"our part\").\\\n                    cte(name=\"included_parts\", recursive=True)\n\nincl_alias = aliased(included_parts, name=\"pr1\")\nparts_alias = aliased(Part, name=\"p\")\nincluded_parts = included_parts.union_all(\n    session.query(\n        parts_alias.sub_part,\n        parts_alias.part,\n        parts_alias.quantity).\\\n            filter(parts_alias.part==included_parts.c.sub_part)\n    )\n\nq = session.query(\n        included_parts.c.sub_part,\n        func.sum(included_parts.c.quantity).\n            label('total_quantity')\n    ).\\\n    group_by(included_parts.c.sub_part)\nsession.execute(q)\n```\nif you try to execute this version, you will get the following error (because Oracle does not like the word RECURSIVE):\n\n```\nsqlalchemy.exc.DatabaseError: (DatabaseError) ORA-00905: missing keyword\n 'WITH RECURSIVE included_parts(sub_part, part, quantity) AS \\n(SELECT part.sub_part AS sub_part, part.part AS part, part.quantity AS quantity \\nFROM part \\nWHERE part.part = :part_1 UNION ALL SELECT p.sub_part AS p_sub_part, p.part AS p_part, p.quantity AS p_quantity \\nFROM part p, included_parts \\nWHERE p.part = included_parts.sub_part)\\n SELECT included_parts.sub_part AS included_parts_sub_part, sum(included_parts.quantity) AS total_quantity \\nFROM included_parts GROUP BY included_parts.sub_part' {'part_1': 'our part'}\n```\n\nso, of course, we change the CTE (even if we are doing a recursive query) from\n\n\n```\nincluded_parts = session.query(\n                Part.sub_part,\n                Part.part,\n                Part.quantity).\\\n                    filter(Part.part==\"our part\").\\\n                    cte(name=\"included_parts\", recursive=True)\n```\n\nto\n\n\n```\nincluded_parts = session.query(\n                Part.sub_part,\n                Part.part,\n                Part.quantity).\\\n                    filter(Part.part==\"our part\").\\\n                    cte(name=\"included_parts\", recursive=False)\n```\n\nbut now we get\n\n\n```\nsqlalchemy.exc.DatabaseError: (DatabaseError) ORA-32039: recursive WITH clause must have column alias list\n 'WITH included_parts AS \\n(SELECT part.sub_part AS sub_part, part.part AS part, part.quantity AS quantity \\nFROM part \\nWHERE part.part = :part_1 UNION ALL SELECT p.sub_part AS p_sub_part, p.part AS p_part, p.quantity AS p_quantity \\nFROM part p, included_parts \\nWHERE p.part = included_parts.sub_part)\\n SELECT included_parts.sub_part AS included_parts_sub_part, sum(included_parts.quantity) AS total_quantity \\nFROM included_parts GROUP BY included_parts.sub_part' {'part_1': 'our part'}\n```\nbecause we are now missing the list of columns required.\n\n2- the second issue deals with some special keywords oracle has in order to provide ordering and to prevent cycle issues within a recursive query. The complete spec is available [here](http://docs.oracle.com/cd/E11882_01/server.112/e41084/statements_10002.htm#BCEDDGGE) and I found these [two](http://rwijk.blogspot.jp/2009/11/recursive-subquery-factoring.html) [examples](http://rajeshwaranbtech.blogspot.com.ar/2012/12/recursive-with-clause-to-implement.html) floating around. The **cycle** option is specially useful since it can prevent circular errors in the recursive relation.  In PG you can do some magic with *arrays*, *rows* and *any* but in Oracle it is really hard to prevent circular issues unless you use the suggested features.\n\nTo tell you the thruth it looks like a pretty troublesome extension to add to sqlalchemy but I guess it could be great if at least we can input some text() condition with this .\n\nThanks for your patience reading this and I am available for anything you need me to test in case you think this issue is worth your time.\n\nMariano\n\n----------------------------------------\nAttachments: [3220.2.patch](../wiki/imported_issue_attachments/3220/3220.2.patch) | [3220.1.patch](../wiki/imported_issue_attachments/3220/3220.1.patch) | [3220.patch](../wiki/imported_issue_attachments/3220/3220.patch)\n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3220/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3220/timeline","performed_via_github_app":null,"state_reason":"completed"}