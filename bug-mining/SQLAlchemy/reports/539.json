{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/7245","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/7245/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/7245/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/7245/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/7245","id":1037508784,"node_id":"I_kwDOCX5JB8491yCw","number":7245,"title":"Enum with AsyncPG and NullPool performance issue","user":{"login":"Boodbarbak","id":21223707,"node_id":"MDQ6VXNlcjIxMjIzNzA3","avatar_url":"https://avatars.githubusercontent.com/u/21223707?v=4","gravatar_id":"","url":"https://api.github.com/users/Boodbarbak","html_url":"https://github.com/Boodbarbak","followers_url":"https://api.github.com/users/Boodbarbak/followers","following_url":"https://api.github.com/users/Boodbarbak/following{/other_user}","gists_url":"https://api.github.com/users/Boodbarbak/gists{/gist_id}","starred_url":"https://api.github.com/users/Boodbarbak/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Boodbarbak/subscriptions","organizations_url":"https://api.github.com/users/Boodbarbak/orgs","repos_url":"https://api.github.com/users/Boodbarbak/repos","events_url":"https://api.github.com/users/Boodbarbak/events{/privacy}","received_events_url":"https://api.github.com/users/Boodbarbak/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141273862,"node_id":"MDU6TGFiZWwxMTQxMjczODYy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/documentation","name":"documentation","color":"ffe7a8","default":true,"description":""},{"id":1141273914,"node_id":"MDU6TGFiZWwxMTQxMjczOTE0","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/postgresql","name":"postgresql","color":"60A070","default":false,"description":""},{"id":1143451229,"node_id":"MDU6TGFiZWwxMTQzNDUxMjI5","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/external%20driver%20issues","name":"external driver issues","color":"2d6eb7","default":false,"description":"the issue involves a misbehavior on the part of the DBAPI itself, probably not SQLAlchemy"},{"id":2296459902,"node_id":"MDU6TGFiZWwyMjk2NDU5OTAy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/asyncio","name":"asyncio","color":"ef7fac","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"CaselIT","id":16175304,"node_id":"MDQ6VXNlcjE2MTc1MzA0","avatar_url":"https://avatars.githubusercontent.com/u/16175304?v=4","gravatar_id":"","url":"https://api.github.com/users/CaselIT","html_url":"https://github.com/CaselIT","followers_url":"https://api.github.com/users/CaselIT/followers","following_url":"https://api.github.com/users/CaselIT/following{/other_user}","gists_url":"https://api.github.com/users/CaselIT/gists{/gist_id}","starred_url":"https://api.github.com/users/CaselIT/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/CaselIT/subscriptions","organizations_url":"https://api.github.com/users/CaselIT/orgs","repos_url":"https://api.github.com/users/CaselIT/repos","events_url":"https://api.github.com/users/CaselIT/events{/privacy}","received_events_url":"https://api.github.com/users/CaselIT/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"CaselIT","id":16175304,"node_id":"MDQ6VXNlcjE2MTc1MzA0","avatar_url":"https://avatars.githubusercontent.com/u/16175304?v=4","gravatar_id":"","url":"https://api.github.com/users/CaselIT","html_url":"https://github.com/CaselIT","followers_url":"https://api.github.com/users/CaselIT/followers","following_url":"https://api.github.com/users/CaselIT/following{/other_user}","gists_url":"https://api.github.com/users/CaselIT/gists{/gist_id}","starred_url":"https://api.github.com/users/CaselIT/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/CaselIT/subscriptions","organizations_url":"https://api.github.com/users/CaselIT/orgs","repos_url":"https://api.github.com/users/CaselIT/repos","events_url":"https://api.github.com/users/CaselIT/events{/privacy}","received_events_url":"https://api.github.com/users/CaselIT/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":7,"created_at":"2021-10-27T14:41:33Z","updated_at":"2022-02-10T03:38:33Z","closed_at":"2022-02-10T03:38:33Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\r\n\r\nThe use of columns with Enum type seems to add a big performance overhead on each INSERT and SELECT on PostgreSQL db with DBAPI AsyncPG and a NullPool engine.\r\nWithout NullPool, the overhead is only on the first INSERT or SELECT query on the table with Enums.\r\nI haven't noticed any overhead with a sync DBAPI (I tried with pypostgresql) nor did I with an async DBAPI for another dialect (I tried with aiosqlite).\r\n\r\n### To Reproduce\r\n\r\n```python\r\nimport enum\r\nimport asyncio\r\n\r\nfrom sqlalchemy import Column, Enum, inspect, Integer\r\nfrom sqlalchemy.ext.asyncio import (\r\n    AsyncSession,\r\n    create_async_engine,\r\n)\r\nfrom sqlalchemy.ext.asyncio.engine import AsyncConnection\r\nfrom sqlalchemy.ext.declarative import DeclarativeMeta, declarative_base\r\nfrom sqlalchemy.orm import sessionmaker\r\nfrom sqlalchemy.pool import NullPool\r\n\r\n\r\nengine = create_async_engine(\r\n    \"postgresql+asyncpg://user:password@localhost/tmp\",\r\n    future=True,\r\n    echo=True,\r\n    poolclass=NullPool,\r\n)\r\nSession = sessionmaker(\r\n    engine, future=True, class_=AsyncSession, expire_on_commit=False\r\n)\r\n\r\nBase: DeclarativeMeta = declarative_base()\r\n\r\n\r\nclass Enum1(int, enum.Enum):\r\n    VALUE_1 = 1\r\n    VALUE_2 = 2\r\n    VALUE_3 = 3\r\n\r\n\r\nclass Enum2(int, enum.Enum):\r\n    VALUE_1 = 1\r\n    VALUE_2 = 2\r\n    VALUE_3 = 3\r\n\r\n\r\nclass Foo(Base):\r\n    __tablename__ = \"foos\"\r\n\r\n    id = Column(Integer, primary_key=True)\r\n    enum1 = Column(Enum(Enum1, name=\"Enum1\"))\r\n    enum2 = Column(Enum(Enum2, name=\"Enum2\"))\r\n\r\n\r\ndef is_db_empty(conn: AsyncConnection) -> bool:\r\n    db_tables = inspect(conn).get_table_names()\r\n    return len(db_tables) == 0\r\n\r\n\r\nasync def main() -> None:\r\n    async with engine.begin() as conn:\r\n        if await conn.run_sync(is_db_empty):\r\n            await conn.run_sync(Base.metadata.create_all)\r\n\r\n    async with Session() as db:\r\n        foo = Foo()\r\n        db.add(foo)\r\n        await db.commit()   # This takes over 2s on my system!\r\n        id = foo.id\r\n\r\n        await db.refresh(foo)\r\n        await db.get(Foo, id)\r\n        await db.commit()   # This takes over 2s on my system!\r\n\r\n        await db.refresh(foo)\r\n        await db.get(Foo, id)\r\n        await db.commit()   # This takes over 2s on my system!\r\n\r\n        await db.refresh(foo)\r\n        await db.get(Foo, id)\r\n        await db.commit()   # This takes over 2s on my system!\r\n\r\n        await db.delete(foo)\r\n        await db.commit()\r\n\r\n\r\nasyncio.run(main())\r\n```\r\n\r\n\r\n### Error\r\n\r\n```\r\n2021-10-27 16:25:00,004 INFO sqlalchemy.engine.Engine select pg_catalog.version()\r\n2021-10-27 16:25:00,004 INFO sqlalchemy.engine.Engine [raw sql] ()\r\n2021-10-27 16:25:00,008 INFO sqlalchemy.engine.Engine select current_schema()\r\n2021-10-27 16:25:00,008 INFO sqlalchemy.engine.Engine [raw sql] ()\r\n2021-10-27 16:25:00,011 INFO sqlalchemy.engine.Engine show standard_conforming_strings\r\n2021-10-27 16:25:00,011 INFO sqlalchemy.engine.Engine [raw sql] ()\r\n2021-10-27 16:25:00,016 INFO sqlalchemy.engine.Engine BEGIN (implicit)\r\n2021-10-27 16:25:00,018 INFO sqlalchemy.engine.Engine SELECT c.relname FROM pg_class c JOIN pg_namespace n ON n.oid = c.relnamespace WHERE n.nspname = %s AND c.relkind in ('r', 'p')\r\n2021-10-27 16:25:00,019 INFO sqlalchemy.engine.Engine [generated in 0.00039s] ('public',)\r\n2021-10-27 16:25:00,024 INFO sqlalchemy.engine.Engine COMMIT\r\n2021-10-27 16:25:00,037 INFO sqlalchemy.engine.Engine BEGIN (implicit)\r\n2021-10-27 16:25:00,040 INFO sqlalchemy.engine.Engine INSERT INTO foos (enum1, enum2) VALUES (%s, %s) RETURNING foos.id\r\n2021-10-27 16:25:00,041 INFO sqlalchemy.engine.Engine [generated in 0.00039s] (None, None)\r\n2021-10-27 16:25:02,827 INFO sqlalchemy.engine.Engine COMMIT\r\n2021-10-27 16:25:02,848 INFO sqlalchemy.engine.Engine BEGIN (implicit)\r\n2021-10-27 16:25:02,854 INFO sqlalchemy.engine.Engine SELECT foos.id, foos.enum1, foos.enum2 \r\nFROM foos \r\nWHERE foos.id = %s\r\n2021-10-27 16:25:02,854 INFO sqlalchemy.engine.Engine [generated in 0.00053s] (16,)\r\n2021-10-27 16:25:05,067 INFO sqlalchemy.engine.Engine COMMIT\r\n2021-10-27 16:25:05,087 INFO sqlalchemy.engine.Engine BEGIN (implicit)\r\n2021-10-27 16:25:05,088 INFO sqlalchemy.engine.Engine SELECT foos.id, foos.enum1, foos.enum2 \r\nFROM foos \r\nWHERE foos.id = %s\r\n2021-10-27 16:25:05,088 INFO sqlalchemy.engine.Engine [cached since 2.234s ago] (16,)\r\n2021-10-27 16:25:07,247 INFO sqlalchemy.engine.Engine COMMIT\r\n2021-10-27 16:25:07,268 INFO sqlalchemy.engine.Engine BEGIN (implicit)\r\n2021-10-27 16:25:07,269 INFO sqlalchemy.engine.Engine SELECT foos.id, foos.enum1, foos.enum2 \r\nFROM foos \r\nWHERE foos.id = %s\r\n2021-10-27 **16:25:07,269** INFO sqlalchemy.engine.Engine [cached since 4.415s ago] (16,)\r\n2021-10-27 **16:25:09,441** INFO sqlalchemy.engine.Engine COMMIT\r\n2021-10-27 16:25:09,461 INFO sqlalchemy.engine.Engine BEGIN (implicit)\r\n2021-10-27 16:25:09,463 INFO sqlalchemy.engine.Engine DELETE FROM foos WHERE foos.id = %s\r\n2021-10-27 16:25:09,464 INFO sqlalchemy.engine.Engine [generated in 0.00035s] (16,)\r\n2021-10-27 16:25:09,469 INFO sqlalchemy.engine.Engine COMMIT\r\n``` \r\n\r\n### Versions\r\n\r\n- OS: Ubuntu 21.04\r\n- Python: 3.9.7\r\n- SQLAlchemy: 1.4.26\r\n- Database: PostgreSQL 13.4 (Docker image postgres:alpine)\r\n- DBAPI : asyncpg 0.24.0\r\n\r\n\r\n### Additional context\r\n\r\n_No response_","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/7245/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/7245/timeline","performed_via_github_app":null,"state_reason":"completed"}