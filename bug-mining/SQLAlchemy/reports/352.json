{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3419","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3419/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3419/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3419/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3419","id":384633916,"node_id":"MDU6SXNzdWUzODQ2MzM5MTY=","number":3419,"title":"connection record not immediately checked back in when connection fails after failed checkout event handler","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269142,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141275054,"node_id":"MDU6TGFiZWwxMTQxMjc1MDU0","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/connection%20pool","name":"connection pool","color":"4cc5c9","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/79","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/79","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/79/labels","id":3850666,"node_id":"MDk6TWlsZXN0b25lMzg1MDY2Ng==","number":79,"title":"1.0.5","description":null,"creator":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":7,"state":"closed","created_at":"2018-11-27T04:35:17Z","updated_at":"2018-11-28T16:50:04Z","due_on":null,"closed_at":"2018-11-28T16:50:04Z"},"comments":2,"created_at":"2015-05-14T17:50:20Z","updated_at":"2015-05-14T17:59:24Z","closed_at":"2015-05-14T17:59:24Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by Michael Bayer ([@zzzeek](https://github.com/zzzeek))**\n\n\n```\nfrom sqlalchemy import event\nimport mock\nimport sys\nimport sqlalchemy as sa\n\nengine = sa.create_engine(\n    \"postgresql://scott:tiger@localhost/test\",\n    pool_size=1, max_overflow=0, pool_timeout=0, pool_recycle=3600)\n\n\n@event.listens_for(engine, 'checkout')\ndef handle_checkout_event(dbapi_con, con_record, con_proxy):\n    try:\n        with dbapi_con.cursor() as cur:\n            cur.execute(\"SELECT 1\")\n            cur.fetchone()\n    except Exception:\n        raise sa.exc.DisconnectionError()\n\n# act as though the DB is turned off\nconn = engine.connect()\ndbapi_conn = conn.connection.connection\nconn.close()\n\ndbapi_conn.close()\n\n\ndef shutdown_backend():\n    raise dbapi_conn.OperationalError(\"closed the connection\")\n\npatcher = mock.patch.object(engine.pool, \"_creator\", shutdown_backend)\npatcher.start()\n\ntry:\n    with engine.begin() as conn:\n        pass\nexcept sa.exc.OperationalError as e:\n    print >>sys.stderr, \"Got an (expected) error: \", e\n\n# sys.exc_clear()\n\ntry:\n    with engine.begin() as conn:\n        pass\nexcept sa.exc.OperationalError as e:\n    print >>sys.stderr, \"Got an (expected) error: \", e\n\nassert True\n\n\n\n```\n\nthe pool checkout fails on the second run because the single ConnectionRecord hasn't been checked in.\n\n\n```\ndiff --git a/lib/sqlalchemy/pool.py b/lib/sqlalchemy/pool.py\nindex 0a4cdad..b38aefb 100644\n--- a/lib/sqlalchemy/pool.py\n+++ b/lib/sqlalchemy/pool.py\n@@ -732,7 +732,13 @@ class _ConnectionFairy(object):\n                 pool.logger.info(\n                     \"Disconnection detected on checkout: %s\", e)\n                 fairy._connection_record.invalidate(e)\n-                fairy.connection = fairy._connection_record.get_connection()\n+                try:\n+                    fairy.connection = \\\n+                        fairy._connection_record.get_connection()\n+                except:\n+                    with util.safe_reraise():\n+                        fairy._connection_record.checkin()\n+\n                 attempts -= 1\n \n         pool.logger.info(\"Reconnection attempts exhausted on checkout\")\n\n```\n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3419/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3419/timeline","performed_via_github_app":null,"state_reason":"completed"}