{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3175","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3175/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3175/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3175/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3175","id":384631690,"node_id":"MDU6SXNzdWUzODQ2MzE2OTA=","number":3175,"title":"create resultproxy._getter to remove overhead of column lookups","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141273873,"node_id":"MDU6TGFiZWwxMTQxMjczODcz","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/high%20priority","name":"high priority","color":"C0B0E0","default":false,"description":null},{"id":1141273925,"node_id":"MDU6TGFiZWwxMTQxMjczOTI1","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/feature","name":"feature","color":"306080","default":false,"description":null},{"id":1141273966,"node_id":"MDU6TGFiZWwxMTQxMjczOTY2","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/orm","name":"orm","color":"20C0B0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/42","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/42","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/42/labels","id":3850611,"node_id":"MDk6TWlsZXN0b25lMzg1MDYxMQ==","number":42,"title":"1.0","description":null,"creator":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":101,"state":"closed","created_at":"2018-11-27T04:04:03Z","updated_at":"2018-11-28T16:49:52Z","due_on":null,"closed_at":"2018-11-28T16:49:52Z"},"comments":6,"created_at":"2014-08-28T03:44:54Z","updated_at":"2014-08-29T00:08:40Z","closed_at":"2014-08-28T16:42:32Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by Michael Bayer ([@zzzeek](https://github.com/zzzeek))**\n\nproof of concept, see if we can get into the C code to speed this up\n\nnote also it looks like collections.namedtuple() might be faster in the majority of cases, tricky one though as it is slow on the init\n\n```\ndiff --git a/lib/sqlalchemy/engine/result.py b/lib/sqlalchemy/engine/result.py\nindex 06a81aa..8e43709 100644\n--- a/lib/sqlalchemy/engine/result.py\n+++ b/lib/sqlalchemy/engine/result.py\n@@ -268,6 +268,19 @@ class ResultMetaData(object):\n         # high precedence keymap.\n         keymap.update(primary_keymap)\n \n+    def _getter(self, key):\n+        try:\n+            processor, obj, index = self._keymap[key]\n+        except KeyError:\n+            processor, obj, index = self._parent._key_fallback(key)\n+\n+        if index is None:\n+            raise exc.InvalidRequestError(\n+                \"Ambiguous column name '%s' in result set! \"\n+                \"try 'use_labels' option on select statement.\" % key)\n+\n+        return operator.itemgetter(index)\n+\n     @util.pending_deprecation(\"0.8\", \"sqlite dialect uses \"\n                               \"_translate_colname() now\")\n     def _set_keymap_synonym(self, name, origname):\n@@ -517,6 +530,9 @@ class ResultProxy(object):\n         \"\"\"\n         return self.context.isinsert\n \n+    def _getter(self, key):\n+        return self._metadata._getter(key)\n+\n     def _cursor_description(self):\n         \"\"\"May be overridden by subclasses.\"\"\"\n \ndiff --git a/lib/sqlalchemy/orm/loading.py b/lib/sqlalchemy/orm/loading.py\nindex 232eb89..098bf73 100644\n--- a/lib/sqlalchemy/orm/loading.py\n+++ b/lib/sqlalchemy/orm/loading.py\n@@ -12,7 +12,7 @@ the functions here are called primarily by Query, Mapper,\n as well as some of the attribute loading strategies.\n \n \"\"\"\n-\n+from __future__ import absolute_import\n \n from .. import util\n from . import attributes, exc as orm_exc, state as statelib\n@@ -20,6 +20,7 @@ from .interfaces import EXT_CONTINUE\n from ..sql import util as sql_util\n from .util import _none_set, state_str\n from .. import exc as sa_exc\n+import collections\n \n _new_runid = util.counter()\n \n@@ -50,10 +51,13 @@ def instances(query, cursor, context):\n     (process, labels) = \\\n         list(zip(*[\n             query_entity.row_processor(query,\n-                                       context, custom_rows)\n+                                       context, custom_rows, cursor)\n             for query_entity in query._entities\n         ]))\n \n+    if not custom_rows and not single_entity:\n+        keyed_tuple = collections.namedtuple('result', labels)\n+\n     while True:\n         context.progress = {}\n         context.partials = {}\n@@ -72,8 +76,9 @@ def instances(query, cursor, context):\n         elif single_entity:\n             rows = [process[0](row, None) for row in fetch]\n         else:\n-            rows = [util.KeyedTuple([proc(row, None) for proc in process],\n-                                    labels) for row in fetch]\n+            rows = [\n+                keyed_tuple(*[proc(row, None) for proc in process])\n+                for row in fetch]\n \n         if filtered:\n             rows = util.unique_list(rows, filter_fn)\ndiff --git a/lib/sqlalchemy/orm/query.py b/lib/sqlalchemy/orm/query.py\nindex 12e11b2..10097d0 100644\n--- a/lib/sqlalchemy/orm/query.py\n+++ b/lib/sqlalchemy/orm/query.py\n@@ -3082,7 +3082,7 @@ class _MapperEntity(_QueryEntity):\n \n         return ret\n \n-    def row_processor(self, query, context, custom_rows):\n+    def row_processor(self, query, context, custom_rows, result):\n         adapter = self._get_entity_clauses(query, context)\n \n         if context.adapter and adapter:\n@@ -3344,7 +3344,7 @@ class _BundleEntity(_QueryEntity):\n         for ent in self._entities:\n             ent.setup_context(query, context)\n \n-    def row_processor(self, query, context, custom_rows):\n+    def row_processor(self, query, context, custom_rows, result):\n         procs, labels = zip(\n             *[ent.row_processor(query, context, custom_rows)\n               for ent in self._entities]\n@@ -3473,15 +3473,17 @@ class _ColumnEntity(_QueryEntity):\n     def _resolve_expr_against_query_aliases(self, query, expr, context):\n         return query._adapt_clause(expr, False, True)\n \n-    def row_processor(self, query, context, custom_rows):\n+    def row_processor(self, query, context, custom_rows, result):\n         column = self._resolve_expr_against_query_aliases(\n             query, self.column, context)\n \n         if context.adapter:\n             column = context.adapter.columns[column]\n \n+        getter = result._getter(column)\n+\n         def proc(row, result):\n-            return row[column]\n+            return getter(row)\n \n         return proc, self._label_name\n \ndiff --git a/lib/sqlalchemy/orm/strategies.py b/lib/sqlalchemy/orm/strategies.py\nindex c3edbf6..27dcce5 100644\n--- a/lib/sqlalchemy/orm/strategies.py\n+++ b/lib/sqlalchemy/orm/strategies.py\n@@ -165,8 +165,10 @@ class ColumnLoader(LoaderStrategy):\n             if adapter:\n                 col = adapter.columns[col]\n             if col is not None and col in row:\n+                getter = row._parent._getter(col)\n+\n                 def fetch_col(state, dict_, row):\n-                    dict_[key] = row[col]\n+                    dict_[key] = getter(row)\n                 return fetch_col, None, None\n         else:\n             def expire_for_non_present_col(state, dict_, row):\n\n```\n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3175/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3175/timeline","performed_via_github_app":null,"state_reason":"completed"}