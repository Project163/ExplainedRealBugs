{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3593","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3593/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3593/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3593/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3593","id":384635497,"node_id":"MDU6SXNzdWUzODQ2MzU0OTc=","number":3593,"title":"eager loading + single inh polymorphic join issue","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269142,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141273873,"node_id":"MDU6TGFiZWwxMTQxMjczODcz","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/high%20priority","name":"high priority","color":"C0B0E0","default":false,"description":null},{"id":1141273966,"node_id":"MDU6TGFiZWwxMTQxMjczOTY2","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/orm","name":"orm","color":"20C0B0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/57","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/57","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/57/labels","id":3850634,"node_id":"MDk6TWlsZXN0b25lMzg1MDYzNA==","number":57,"title":"1.0.xx","description":null,"creator":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":127,"state":"closed","created_at":"2018-11-27T04:15:49Z","updated_at":"2018-11-28T16:49:57Z","due_on":null,"closed_at":"2018-11-28T16:49:57Z"},"comments":8,"created_at":"2015-11-25T01:19:15Z","updated_at":"2015-12-21T11:37:37Z","closed_at":"2015-11-25T20:33:06Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by Michael Bayer ([@zzzeek](https://github.com/zzzeek))**\n\nbreaks as of 0.8.1 !!  637232709770de034caf67c is the changeset.   this is a deep one, taking out polymorphic resolves so this is an old school one.   \n\n\n```\nfrom __future__ import print_function, unicode_literals\n\nimport sqlalchemy as sa\nimport sqlalchemy.orm\nimport sqlalchemy.ext.declarative\nimport sqlalchemy.ext.orderinglist\n\nBase = sqlalchemy.ext.declarative.declarative_base()\n\n\nclass Node(Base):\n    __tablename__ = 'todo_elements'\n\n    element_id = sa.Column(sa.Integer, nullable=False, primary_key=True)\n    element_type = sa.Column(sa.String(20), nullable=False)\n\n    __mapper_args__ = {\n        'polymorphic_on': element_type,\n        'with_polymorphic': ('*', None),\n    }\n\n\nclass NodeWithEdges(Node):\n    __mapper_args__ = {'polymorphic_identity': 'todo.list'}\n\n\nclass LeafNode(Node):\n    __mapper_args__ = {'polymorphic_identity': 'todo.item'}\n\n    my_flag = sa.Column(sa.Boolean, default=False)\n\n\nclass Edge(Base):\n    __tablename__ = 'todo_links'\n    __table_args__ = (\n        sa.PrimaryKeyConstraint('parent_id', 'child_id'),\n        sa.ForeignKeyConstraint(['parent_id'], [Node.element_id]),\n        sa.ForeignKeyConstraint(['child_id'], [Node.element_id]),\n    )\n\n    parent_id = sa.Column(sa.Integer, nullable=False)\n    child_id = sa.Column(sa.Integer, nullable=False)\n\n\nEdge.child = sa.orm.relationship(\n    Node,\n    uselist=False,\n    primaryjoin=Edge.child_id == Node.element_id,\n    lazy=False,\n    cascade='all',\n    passive_updates=False,\n    join_depth=8,\n)\n\n\nNodeWithEdges.links = sa.orm.relationship(\n    Edge,\n    primaryjoin=NodeWithEdges.element_id == Edge.parent_id,\n    lazy=False,\n    cascade='all, delete-orphan',\n    single_parent=True,\n    passive_updates=False,\n    join_depth=8,\n)\n\n\n#engine = sa.create_engine('sqlite:///:memory:', echo=True)\nengine = sa.create_engine('postgresql://scott:tiger@localhost/test', echo=True)\n\nBase.metadata.drop_all(engine)\nBase.metadata.create_all(engine)\n\nSession = sa.orm.sessionmaker(bind=engine)\nsession = Session()\n\n\n#\n# 1 --> 2 --> 3\n#         --> 4\n#         --> 5\n#\n\nn1 = NodeWithEdges(element_id=1)\nn2 = NodeWithEdges(element_id=2)\nn3 = LeafNode(element_id=3)\nn4 = LeafNode(element_id=4, my_flag=True)\nn5 = LeafNode(element_id=5)\n\ne12 = Edge(parent_id=n1.element_id, child_id=n2.element_id)\ne23 = Edge(parent_id=n2.element_id, child_id=n3.element_id)\ne24 = Edge(parent_id=n2.element_id, child_id=n4.element_id)\ne25 = Edge(parent_id=n2.element_id, child_id=n5.element_id)\n\nsession.add_all([n1, n2, n3, n4, n5, e12, e23, e24, e25])\nsession.commit()\nsession.expunge_all()\n\nnew_n1 = session.query(NodeWithEdges).filter(\n    NodeWithEdges.element_id == 1).all()[0] #first()\n#print(session.identity_map.keys())\n\n\ndef traverse(node, f, depth=0):\n    f(node, depth)\n    if hasattr(node, 'links'):\n        for link in node.links:\n            traverse(link.child, f, depth + 1)\n\n\ndef indent_print(node, depth):\n    print('  ' * depth + str(node.element_id))\n    if hasattr(node, 'my_flag'):\n        print(node.my_flag)\n\n# recursion overflow after commit \ntraverse(new_n1, indent_print)\n\n```\n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3593/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3593/timeline","performed_via_github_app":null,"state_reason":"completed"}