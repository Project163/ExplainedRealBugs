{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/12077","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/12077/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/12077/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/12077/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/12077","id":2647223227,"node_id":"I_kwDOCX5JB86dyWu7","number":12077,"title":"anyio taskgroup cancellation leading to asyncpg connection leak","user":{"login":"jraby","id":2365261,"node_id":"MDQ6VXNlcjIzNjUyNjE=","avatar_url":"https://avatars.githubusercontent.com/u/2365261?v=4","gravatar_id":"","url":"https://api.github.com/users/jraby","html_url":"https://github.com/jraby","followers_url":"https://api.github.com/users/jraby/followers","following_url":"https://api.github.com/users/jraby/following{/other_user}","gists_url":"https://api.github.com/users/jraby/gists{/gist_id}","starred_url":"https://api.github.com/users/jraby/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jraby/subscriptions","organizations_url":"https://api.github.com/users/jraby/orgs","repos_url":"https://api.github.com/users/jraby/repos","events_url":"https://api.github.com/users/jraby/events{/privacy}","received_events_url":"https://api.github.com/users/jraby/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141275752,"node_id":"MDU6TGFiZWwxMTQxMjc1NzUy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/engine","name":"engine","color":"B04040","default":false,"description":"engines, connections, transactions, isolation levels, execution options"},{"id":1959689852,"node_id":"MDU6TGFiZWwxOTU5Njg5ODUy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/great%20mcve","name":"great mcve","color":"dcf972","default":false,"description":"An issue with a great mcve"},{"id":2296459902,"node_id":"MDU6TGFiZWwyMjk2NDU5OTAy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/asyncio","name":"asyncio","color":"ef7fac","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2024-11-10T13:12:22Z","updated_at":"2025-01-21T00:35:21Z","closed_at":"2025-01-21T00:35:21Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\n\nI hit a connection leak when cancelling an http handler task in a fastapi + starlette + BaseHTTPMiddleware + SA + asyncpg setup and managed to reproduce it with the code below.\r\n\r\nFrom my understanding, when cancelling an `anyio` taskgroup which contains a task that checked out a connection from the pool, SA tries to close the connection, but most (all?) `await` calls within that code path bail with `asyncio.CancelledError`, leading to SA and asyncpg thinking that the connection was closed / released, but the socket is still alive and idle from postgres's point of view.\r\n\r\nThis is related to https://github.com/MagicStack/asyncpg/issues/1156 which doesn't currently have a resolution.\r\n\r\nThe following code leaks a connection on every loop operation, as observed by running  `select * from pg_stat_activity where datname='postgres';` in the db while the script is running.\r\n\r\n#12076 is an attempt a fixing this behavior by shielding connection termination from `asyncio.CancelledError`\n\n### Optional link from https://docs.sqlalchemy.org which documents the behavior that is expected\n\n_No response_\n\n### SQLAlchemy Version in Use\n\n2.0.36\n\n### DBAPI (i.e. the database driver)\n\nasyncpg\n\n### Database Vendor and Major Version\n\npostgres 17\n\n### Python Version\n\n3.12\n\n### Operating system\n\nlinux\n\n### To Reproduce\n\n```python\nimport asyncio\r\nimport asyncpg\r\nimport anyio\r\n\r\nfrom sqlalchemy.ext.asyncio import async_sessionmaker, create_async_engine\r\nfrom sqlalchemy.sql import text\r\n\r\nSQLALCHEMY_DATABASE_URL = \"postgresql+asyncpg://postgres:postgres@localhost/postgres\"\r\nengine = create_async_engine(SQLALCHEMY_DATABASE_URL, pool_size=1, max_overflow=0, echo_pool=\"debug\")\r\nasync_session = async_sessionmaker(engine, expire_on_commit=False)\r\n\r\nasync def anyio_tg_wrapper(func, *args, **kwargs):\r\n    async with anyio.create_task_group() as tg:\r\n        tg.start_soon(func, *args, **kwargs)\r\n\r\nasync def tg_wrapper(f):\r\n    async with asyncio.TaskGroup() as tg:\r\n        tg.create_task(f)\r\n\r\n\r\nasync def querier():\r\n    async with async_session() as session, session.begin():\r\n        res = await session.execute(text(\"select 1\"))\r\n        print([row for row in res])\r\n        \r\n        # simulate other async io work while holding the session\r\n        await asyncio.sleep(10)\r\n\r\nasync def main():\r\n    while True:\r\n        t = asyncio.create_task(anyio_tg_wrapper(querier))\r\n        \r\n        # asyncio task group does not lead to a leak\r\n        #t = asyncio.create_task(tg_wrapper(querier()))\r\n\r\n        async def timeouter():\r\n            await asyncio.sleep(1)\r\n            t.cancel()\r\n\r\n        asyncio.create_task(timeouter())\r\n\r\n        try:\r\n            await t\r\n        except asyncio.CancelledError:\r\n            print(\"cancelled\")\r\n\r\nif __name__ == '__main__':\r\n    asyncio.run(main())\n```\n\n\n### Error\n\nThis is the output from the script above.\r\n```\r\n2024-11-10 08:07:01,830 DEBUG sqlalchemy.pool.impl.AsyncAdaptedQueuePool Created new connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7e46b7088e60>>\r\n2024-11-10 08:07:01,831 DEBUG sqlalchemy.pool.impl.AsyncAdaptedQueuePool Connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7e46b7088e60>> checked out from pool\r\n[(1,)]\r\n2024-11-10 08:07:02,252 INFO sqlalchemy.pool.impl.AsyncAdaptedQueuePool Invalidate connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7e46b7088e60>> (reason: CancelledError:Cancelled by cancel scope 7e46b705a690)\r\n2024-11-10 08:07:02,253 DEBUG sqlalchemy.pool.impl.AsyncAdaptedQueuePool Hard-closing connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7e46b7088e60>>\r\n```\r\nat this point, the \"hard-closed\" connection, is not in the pool anymore. But still alive.\r\n\r\nWhen using an `asyncio`  task group instead of an `anyio` task group, the session is rolled back and put back in the pool, which is probably a better outcome than closing the connection in this case.\r\n\r\n```\r\n2024-11-10 08:10:56,558 DEBUG sqlalchemy.pool.impl.AsyncAdaptedQueuePool Created new connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7e75c812caa0>>\r\n2024-11-10 08:10:56,564 DEBUG sqlalchemy.pool.impl.AsyncAdaptedQueuePool Connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7e75c812caa0>> checked out from pool\r\n[(1,)]\r\n2024-11-10 08:10:57,526 DEBUG sqlalchemy.pool.impl.AsyncAdaptedQueuePool Connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7e75c812caa0>> being returned to pool\r\n2024-11-10 08:10:57,526 DEBUG sqlalchemy.pool.impl.AsyncAdaptedQueuePool Connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7e75c812caa0>> rollback-on-return\r\n```\n\n### Additional context\n\n_No response_","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/12077/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/12077/timeline","performed_via_github_app":null,"state_reason":"completed"}