{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3177","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3177/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3177/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3177/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3177","id":384631719,"node_id":"MDU6SXNzdWUzODQ2MzE3MTk=","number":3177,"title":"Single table polymorphic count issue","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269142,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141273966,"node_id":"MDU6TGFiZWwxMTQxMjczOTY2","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/orm","name":"orm","color":"20C0B0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/42","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/42","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/42/labels","id":3850611,"node_id":"MDk6TWlsZXN0b25lMzg1MDYxMQ==","number":42,"title":"1.0","description":null,"creator":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":101,"state":"closed","created_at":"2018-11-27T04:04:03Z","updated_at":"2018-11-28T16:49:52Z","due_on":null,"closed_at":"2018-11-28T16:49:52Z"},"comments":8,"created_at":"2014-08-29T15:19:14Z","updated_at":"2014-08-29T23:10:06Z","closed_at":"2014-08-29T16:05:55Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by mjallday ([@mjallday](https://github.com/mjallday))**\n\nOriginally posted at [StackOverflow](https://stackoverflow.com/questions/25222025/sqlalchemy-generates-a-different-query-for-counts-than-expected-with-a-polymorph)\n\nWhen using a polymorphic identity and attempting to count the number of records, incorrect SQL is generated. This SQL will count the entire table rather than the items matching the polymorphic discriminator.\n\nIterating all the results works as expected, I've only experienced this bug using `.count()`.\n\n```python\nfrom sqlalchemy.ext.declarative import declarative_base\nfrom sqlalchemy import Table, Column, Unicode, Integer, create_engine, MetaData, func\nfrom sqlalchemy.orm import scoped_session, sessionmaker\n\nmetadata = MetaData()\nBase = declarative_base(metadata=metadata)\n\n\nwidgets = Table(\n    'widgets', metadata,\n    Column('id', Integer, primary_key=True),\n    Column('type', Unicode),\n    Column('state', Unicode)\n)\n\n\nclass Widget(Base):\n    __table__ = widgets\n\n    class types(object):\n        FOO_WIDGET = 'foo'\n        BAR_WIDGET = 'bar'\n\n    __mapper_args__ = {\n        'polymorphic_on': widgets.c.type,\n    }\n\n\nclass FooWidget(Widget):\n\n    __mapper_args__ = {\n        'polymorphic_identity': Widget.types.FOO_WIDGET\n    }\n\n\ndb_engine = create_engine('sqlite:///:memory:', echo=True)\nSession = scoped_session(sessionmaker())\nSession.configure(bind=db_engine)\n\nmetadata.create_all(db_engine)\n\nitems = Session.query(FooWidget.id).filter_by(\n    state='new'\n)\n\nprint str(items)\nprint 'i expect the next statement to print something approximating:'\nprint '''\nselect count(*) from widgets where type = 'foo' and state = 'new'\n'''\nprint items.count()\n# What this actually prints\n'''\n2014-08-28 09:55:15,055 INFO sqlalchemy.engine.base.Engine SELECT count(*) AS count_1\nFROM widgets, (SELECT widgets.id AS widgets_id\nFROM widgets\nWHERE widgets.state = ?) AS anon_1\nWHERE widgets.type IN (?)\n'''\n```\n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3177/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3177/timeline","performed_via_github_app":null,"state_reason":"completed"}