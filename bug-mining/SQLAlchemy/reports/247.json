{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3251","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3251/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3251/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3251/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3251","id":384632417,"node_id":"MDU6SXNzdWUzODQ2MzI0MTc=","number":3251,"title":"Possible Memory Leak on relationships","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269142,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141273966,"node_id":"MDU6TGFiZWwxMTQxMjczOTY2","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/orm","name":"orm","color":"20C0B0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/73","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/73","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/73/labels","id":3850657,"node_id":"MDk6TWlsZXN0b25lMzg1MDY1Nw==","number":73,"title":"0.9.9","description":null,"creator":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":14,"state":"closed","created_at":"2018-11-27T04:29:57Z","updated_at":"2018-11-28T16:50:02Z","due_on":null,"closed_at":"2018-11-28T16:50:02Z"},"comments":5,"created_at":"2014-11-13T15:08:51Z","updated_at":"2014-11-13T18:18:31Z","closed_at":"2014-11-13T18:18:17Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by Francisco Fernández Castaño ([@fcofdez](https://github.com/fcofdez))**\n\nHi,\nI've the tables shown in the code mapped to some classes and I need to run a query using a custom selectable that gives me augmented information about Accounts through FollowAssociation depending on a given user_id and then join to Broadcast orm object this custom selectable defined on runtime, creating a new relationship with the same name. But with this solution, that probably is not sqlalchemy idiomatic I'm getting memory leaks. The RelationshipProperty objects are never freed so memory don't stop growing. I dind't be able to find an alternative way to achieve this goal and probably is my fault, but just in case here is a runnable snippet that shows how memory grows over time.\n\nsqlalchemy==0.9.8\n\n```\nfrom sqlalchemy import create_engine, Column, Integer, ForeignKey, DateTime, case, and_\nfrom sqlalchemy.orm import sessionmaker, relationship, aliased, mapper\nfrom sqlalchemy.ext.declarative import declarative_base\nimport datetime\nimport random\nfrom guppy import hpy\n\n\nengine = create_engine('sqlite:///:memory:', echo=False)\nSession = sessionmaker(bind=engine)\nBase = declarative_base()\nsession = Session()\n\n\nclass FollowAssociation(Base):\n    __tablename__ = 'followers_followees'\n\n    follower_id = Column(Integer, ForeignKey('accounts.id'), primary_key=True)\n    followee_id = Column(Integer, ForeignKey('accounts.id'), primary_key=True)\n    created_at = Column(DateTime, default=datetime.datetime.now)\n\n\nali = aliased(FollowAssociation)\n\n\nclass Account(Base):\n    __tablename__ = 'accounts'\n\n    id = Column(Integer, primary_key=True)\n\n    followers = relationship('Account', secondary='followers_followees',\n                             primaryjoin=(FollowAssociation.followee_id == id),\n                             secondaryjoin=(FollowAssociation.follower_id == id),\n                             backref='followees')\n\n\nclass Broadcast(Base):\n    __tablename__ = 'broadcasts'\n\n    id = Column(Integer, primary_key=True)\n\n    account_id = Column(Integer, ForeignKey('accounts.id'))\n\n\nBase.metadata.create_all(engine)\na1 = Account()\na2 = Account()\na3 = Account()\nb = Broadcast()\na3.followers.append(a2)\nsession.add_all([a1, a2, a3, b])\nsession.commit()\nh = hpy()\n\n\ndef custom_query(user_id):\n    query = session.query(\n        Account,\n        case([(FollowAssociation.follower_id == None, False)], else_=True).label('follower'),\n        case([(ali.follower_id == None, False) ], else_=True).label('followee')\n    ).outerjoin(\n        FollowAssociation,\n        and_(Account.id == FollowAssociation.followee_id, FollowAssociation.follower_id == user_id)\n    ).outerjoin(ali, and_(Account.id == ali.follower_id, ali.followee_id == user_id))\n\n    class CustomAccount(object):\n        pass\n\n    CustomAccount = type('CustomAccount', (object,), {})\n\n    mapper(CustomAccount, query.statement.alias())\n\n    return CustomAccount\n\n\ndef execute():\n    for i in range(200000):\n        custom_account = custom_query(random.randint(1, 200))\n        Broadcast.account_with_follow_info = relationship(custom_account)\n        session.query(Broadcast).first()\n        if i % 1000 == 0:\n            print i\n            print h.heap()\n            print h.heap().more\n\nexecute()\n\n```\n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3251/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3251/timeline","performed_via_github_app":null,"state_reason":"completed"}