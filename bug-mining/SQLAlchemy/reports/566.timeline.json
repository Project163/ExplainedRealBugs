[{"id":15241071624,"node_id":"LE_lADOCX5JB86dyWu7zwAAAAOMcEwI","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/events/15241071624","actor":{"login":"jraby","id":2365261,"node_id":"MDQ6VXNlcjIzNjUyNjE=","avatar_url":"https://avatars.githubusercontent.com/u/2365261?v=4","gravatar_id":"","url":"https://api.github.com/users/jraby","html_url":"https://github.com/jraby","followers_url":"https://api.github.com/users/jraby/followers","following_url":"https://api.github.com/users/jraby/following{/other_user}","gists_url":"https://api.github.com/users/jraby/gists{/gist_id}","starred_url":"https://api.github.com/users/jraby/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jraby/subscriptions","organizations_url":"https://api.github.com/users/jraby/orgs","repos_url":"https://api.github.com/users/jraby/repos","events_url":"https://api.github.com/users/jraby/events{/privacy}","received_events_url":"https://api.github.com/users/jraby/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2024-11-10T13:12:22Z","label":{"name":"requires triage","color":"ffff00"},"performed_via_github_app":null},{"actor":{"login":"jraby","id":2365261,"node_id":"MDQ6VXNlcjIzNjUyNjE=","avatar_url":"https://avatars.githubusercontent.com/u/2365261?v=4","gravatar_id":"","url":"https://api.github.com/users/jraby","html_url":"https://github.com/jraby","followers_url":"https://api.github.com/users/jraby/followers","following_url":"https://api.github.com/users/jraby/following{/other_user}","gists_url":"https://api.github.com/users/jraby/gists{/gist_id}","starred_url":"https://api.github.com/users/jraby/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jraby/subscriptions","organizations_url":"https://api.github.com/users/jraby/orgs","repos_url":"https://api.github.com/users/jraby/repos","events_url":"https://api.github.com/users/jraby/events{/privacy}","received_events_url":"https://api.github.com/users/jraby/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-11-10T13:12:44Z","updated_at":"2024-11-10T13:12:44Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/12076","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/12076/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/12076/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/12076/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/pull/12076","id":2647185317,"node_id":"PR_kwDOCX5JB86BbXKA","number":12076,"title":"asyncpg: shield connection close in terminate to avoid connection leak","user":{"login":"jraby","id":2365261,"node_id":"MDQ6VXNlcjIzNjUyNjE=","avatar_url":"https://avatars.githubusercontent.com/u/2365261?v=4","gravatar_id":"","url":"https://api.github.com/users/jraby","html_url":"https://github.com/jraby","followers_url":"https://api.github.com/users/jraby/followers","following_url":"https://api.github.com/users/jraby/following{/other_user}","gists_url":"https://api.github.com/users/jraby/gists{/gist_id}","starred_url":"https://api.github.com/users/jraby/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jraby/subscriptions","organizations_url":"https://api.github.com/users/jraby/orgs","repos_url":"https://api.github.com/users/jraby/repos","events_url":"https://api.github.com/users/jraby/events{/privacy}","received_events_url":"https://api.github.com/users/jraby/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":18,"created_at":"2024-11-10T12:31:40Z","updated_at":"2025-01-21T00:35:22Z","closed_at":"2025-01-21T00:35:22Z","author_association":"NONE","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":159271175,"node_id":"MDEwOlJlcG9zaXRvcnkxNTkyNzExNzU=","name":"sqlalchemy","full_name":"sqlalchemy/sqlalchemy","private":false,"owner":{"login":"sqlalchemy","id":6043126,"node_id":"MDEyOk9yZ2FuaXphdGlvbjYwNDMxMjY=","avatar_url":"https://avatars.githubusercontent.com/u/6043126?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy","html_url":"https://github.com/sqlalchemy","followers_url":"https://api.github.com/users/sqlalchemy/followers","following_url":"https://api.github.com/users/sqlalchemy/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy/orgs","repos_url":"https://api.github.com/users/sqlalchemy/repos","events_url":"https://api.github.com/users/sqlalchemy/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/sqlalchemy/sqlalchemy","description":"The Database Toolkit for Python","fork":false,"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","forks_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/forks","keys_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/keys{/key_id}","collaborators_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/teams","hooks_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/hooks","issue_events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/events{/number}","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/events","assignees_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/assignees{/user}","branches_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/branches{/branch}","tags_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/tags","blobs_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/git/refs{/sha}","trees_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/git/trees{/sha}","statuses_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/statuses/{sha}","languages_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/languages","stargazers_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/stargazers","contributors_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/contributors","subscribers_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/subscribers","subscription_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/subscription","commits_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/commits{/sha}","git_commits_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/git/commits{/sha}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/comments{/number}","issue_comment_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments{/number}","contents_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/contents/{+path}","compare_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/compare/{base}...{head}","merges_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/merges","archive_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/downloads","issues_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues{/number}","pulls_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/pulls{/number}","milestones_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones{/number}","notifications_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels{/name}","releases_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/releases{/id}","deployments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/deployments","created_at":"2018-11-27T03:35:03Z","updated_at":"2025-11-10T08:14:59Z","pushed_at":"2025-11-09T19:21:36Z","git_url":"git://github.com/sqlalchemy/sqlalchemy.git","ssh_url":"git@github.com:sqlalchemy/sqlalchemy.git","clone_url":"https://github.com/sqlalchemy/sqlalchemy.git","svn_url":"https://github.com/sqlalchemy/sqlalchemy","homepage":"https://www.sqlalchemy.org","size":97110,"stargazers_count":11107,"watchers_count":11107,"language":"Python","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":true,"forks_count":1596,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":219,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["python","sql","sqlalchemy"],"visibility":"public","forks":1596,"open_issues":219,"watchers":11107,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/pulls/12076","html_url":"https://github.com/sqlalchemy/sqlalchemy/pull/12076","diff_url":"https://github.com/sqlalchemy/sqlalchemy/pull/12076.diff","patch_url":"https://github.com/sqlalchemy/sqlalchemy/pull/12076.patch","merged_at":null},"body":"I hit a connection leak when cancelling a task in a fastapi + starlette + BaseHTTPMiddleware + SA + asyncpg setup and managed to reproduce it with the code below.\r\n\r\nFrom my understanding, when cancelling an `anyio` taskgroup which contains a task that checked out a connection from the pool, SA tries to close the connection, but most (all?) `await` calls within that code path bail with `asyncio.CancelledError`, leading to SA and asyncpg thinking that the connection was closed / released, but the socket is still alive and idle from postgres's point of view.\r\n\r\nThis is related to https://github.com/MagicStack/asyncpg/issues/1156 which doesn't currently have a resolution.\r\n\r\nThe solution proposed here might not be the right place to fix this issue, but it does fix my reproducer :)\r\n\r\n\r\nThe following code leaks a connection on every loop iteration:\r\n```\r\nimport asyncio\r\nimport asyncpg\r\nimport anyio\r\n\r\nfrom sqlalchemy.ext.asyncio import async_sessionmaker, create_async_engine\r\nfrom sqlalchemy.sql import text\r\n\r\nSQLALCHEMY_DATABASE_URL = \"postgresql+asyncpg://postgres:postgres@localhost/postgres\"\r\nengine = create_async_engine(SQLALCHEMY_DATABASE_URL, pool_size=1, max_overflow=0, echo_pool=\"debug\")\r\nasync_session = async_sessionmaker(engine, expire_on_commit=False)\r\n\r\nasync def anyio_tg_wrapper(func, *args, **kwargs):\r\n    async with anyio.create_task_group() as tg:\r\n        tg.start_soon(func, *args, **kwargs)\r\n\r\nasync def tg_wrapper(f):\r\n    async with asyncio.TaskGroup() as tg:\r\n        tg.create_task(f)\r\n\r\n\r\nasync def querier():\r\n    async with async_session() as session, session.begin():\r\n        res = await session.execute(text(\"select 1\"))\r\n        print([row for row in res])\r\n        \r\n        # simulate other async io work while holding the session\r\n        await asyncio.sleep(10)\r\n\r\nasync def main():\r\n    while True:\r\n        t = asyncio.create_task(anyio_tg_wrapper(querier))\r\n        \r\n        # asyncio task group does not lead to a leak\r\n        #t = asyncio.create_task(tg_wrapper(querier()))\r\n\r\n        async def timeouter():\r\n            await asyncio.sleep(1)\r\n            t.cancel()\r\n\r\n        asyncio.create_task(timeouter())\r\n\r\n        try:\r\n            await t\r\n        except asyncio.CancelledError:\r\n            print(\"cancelled\")\r\n\r\nif __name__ == '__main__':\r\n    asyncio.run(main())\r\n```\r\n### Description\r\n\r\nIf terminate is called from an asyncio.CancelledError exception handler, under an anyio task group, await will bail with asyncio.CancelledError right away, leading to a connection leak.\r\n\r\nShielding the close() call allows the connection to be properly closed in those cases.\r\n\r\nTentatively removed the asyncio.CancelledError except clause since close() doesn't raise it itself so it shouldn't be possible to get it.\r\n\r\nFixes #12077 ","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/12076/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/12076/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"id":15255293048,"node_id":"UNLE_lADOCX5JB86dyWu7zwAAAAONSUx4","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/events/15255293048","actor":{"login":"CaselIT","id":16175304,"node_id":"MDQ6VXNlcjE2MTc1MzA0","avatar_url":"https://avatars.githubusercontent.com/u/16175304?v=4","gravatar_id":"","url":"https://api.github.com/users/CaselIT","html_url":"https://github.com/CaselIT","followers_url":"https://api.github.com/users/CaselIT/followers","following_url":"https://api.github.com/users/CaselIT/following{/other_user}","gists_url":"https://api.github.com/users/CaselIT/gists{/gist_id}","starred_url":"https://api.github.com/users/CaselIT/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/CaselIT/subscriptions","organizations_url":"https://api.github.com/users/CaselIT/orgs","repos_url":"https://api.github.com/users/CaselIT/repos","events_url":"https://api.github.com/users/CaselIT/events{/privacy}","received_events_url":"https://api.github.com/users/CaselIT/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"unlabeled","commit_id":null,"commit_url":null,"created_at":"2024-11-11T20:43:33Z","label":{"name":"requires triage","color":"ffff00"},"performed_via_github_app":null},{"id":15255293055,"node_id":"LE_lADOCX5JB86dyWu7zwAAAAONSUx_","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/events/15255293055","actor":{"login":"CaselIT","id":16175304,"node_id":"MDQ6VXNlcjE2MTc1MzA0","avatar_url":"https://avatars.githubusercontent.com/u/16175304?v=4","gravatar_id":"","url":"https://api.github.com/users/CaselIT","html_url":"https://github.com/CaselIT","followers_url":"https://api.github.com/users/CaselIT/followers","following_url":"https://api.github.com/users/CaselIT/following{/other_user}","gists_url":"https://api.github.com/users/CaselIT/gists{/gist_id}","starred_url":"https://api.github.com/users/CaselIT/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/CaselIT/subscriptions","organizations_url":"https://api.github.com/users/CaselIT/orgs","repos_url":"https://api.github.com/users/CaselIT/repos","events_url":"https://api.github.com/users/CaselIT/events{/privacy}","received_events_url":"https://api.github.com/users/CaselIT/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2024-11-11T20:43:33Z","label":{"name":"engine","color":"B04040"},"performed_via_github_app":null},{"id":15255293059,"node_id":"LE_lADOCX5JB86dyWu7zwAAAAONSUyD","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/events/15255293059","actor":{"login":"CaselIT","id":16175304,"node_id":"MDQ6VXNlcjE2MTc1MzA0","avatar_url":"https://avatars.githubusercontent.com/u/16175304?v=4","gravatar_id":"","url":"https://api.github.com/users/CaselIT","html_url":"https://github.com/CaselIT","followers_url":"https://api.github.com/users/CaselIT/followers","following_url":"https://api.github.com/users/CaselIT/following{/other_user}","gists_url":"https://api.github.com/users/CaselIT/gists{/gist_id}","starred_url":"https://api.github.com/users/CaselIT/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/CaselIT/subscriptions","organizations_url":"https://api.github.com/users/CaselIT/orgs","repos_url":"https://api.github.com/users/CaselIT/repos","events_url":"https://api.github.com/users/CaselIT/events{/privacy}","received_events_url":"https://api.github.com/users/CaselIT/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2024-11-11T20:43:33Z","label":{"name":"great mcve","color":"dcf972"},"performed_via_github_app":null},{"id":15255293063,"node_id":"LE_lADOCX5JB86dyWu7zwAAAAONSUyH","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/events/15255293063","actor":{"login":"CaselIT","id":16175304,"node_id":"MDQ6VXNlcjE2MTc1MzA0","avatar_url":"https://avatars.githubusercontent.com/u/16175304?v=4","gravatar_id":"","url":"https://api.github.com/users/CaselIT","html_url":"https://github.com/CaselIT","followers_url":"https://api.github.com/users/CaselIT/followers","following_url":"https://api.github.com/users/CaselIT/following{/other_user}","gists_url":"https://api.github.com/users/CaselIT/gists{/gist_id}","starred_url":"https://api.github.com/users/CaselIT/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/CaselIT/subscriptions","organizations_url":"https://api.github.com/users/CaselIT/orgs","repos_url":"https://api.github.com/users/CaselIT/repos","events_url":"https://api.github.com/users/CaselIT/events{/privacy}","received_events_url":"https://api.github.com/users/CaselIT/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2024-11-11T20:43:33Z","label":{"name":"asyncio","color":"ef7fac"},"performed_via_github_app":null},{"actor":{"login":"jraby","id":2365261,"node_id":"MDQ6VXNlcjIzNjUyNjE=","avatar_url":"https://avatars.githubusercontent.com/u/2365261?v=4","gravatar_id":"","url":"https://api.github.com/users/jraby","html_url":"https://github.com/jraby","followers_url":"https://api.github.com/users/jraby/followers","following_url":"https://api.github.com/users/jraby/following{/other_user}","gists_url":"https://api.github.com/users/jraby/gists{/gist_id}","starred_url":"https://api.github.com/users/jraby/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jraby/subscriptions","organizations_url":"https://api.github.com/users/jraby/orgs","repos_url":"https://api.github.com/users/jraby/repos","events_url":"https://api.github.com/users/jraby/events{/privacy}","received_events_url":"https://api.github.com/users/jraby/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-11-14T17:14:31Z","updated_at":"2024-11-14T17:14:31Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/12099","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/12099/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/12099/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/12099/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/12099","id":2659500741,"node_id":"I_kwDOCX5JB86ehMLF","number":12099,"title":"Task cancellation with SA connection pool + asyncpg + direct_tls can lead to connection leak","user":{"login":"jraby","id":2365261,"node_id":"MDQ6VXNlcjIzNjUyNjE=","avatar_url":"https://avatars.githubusercontent.com/u/2365261?v=4","gravatar_id":"","url":"https://api.github.com/users/jraby","html_url":"https://github.com/jraby","followers_url":"https://api.github.com/users/jraby/followers","following_url":"https://api.github.com/users/jraby/following{/other_user}","gists_url":"https://api.github.com/users/jraby/gists{/gist_id}","starred_url":"https://api.github.com/users/jraby/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jraby/subscriptions","organizations_url":"https://api.github.com/users/jraby/orgs","repos_url":"https://api.github.com/users/jraby/repos","events_url":"https://api.github.com/users/jraby/events{/privacy}","received_events_url":"https://api.github.com/users/jraby/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269144,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQ0","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/duplicate","name":"duplicate","color":"cfd3d7","default":true,"description":"This issue or pull request already exists"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2024-11-14T17:14:29Z","updated_at":"2024-11-14T23:15:59Z","closed_at":"2024-11-14T17:58:54Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":159271175,"node_id":"MDEwOlJlcG9zaXRvcnkxNTkyNzExNzU=","name":"sqlalchemy","full_name":"sqlalchemy/sqlalchemy","private":false,"owner":{"login":"sqlalchemy","id":6043126,"node_id":"MDEyOk9yZ2FuaXphdGlvbjYwNDMxMjY=","avatar_url":"https://avatars.githubusercontent.com/u/6043126?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy","html_url":"https://github.com/sqlalchemy","followers_url":"https://api.github.com/users/sqlalchemy/followers","following_url":"https://api.github.com/users/sqlalchemy/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy/orgs","repos_url":"https://api.github.com/users/sqlalchemy/repos","events_url":"https://api.github.com/users/sqlalchemy/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/sqlalchemy/sqlalchemy","description":"The Database Toolkit for Python","fork":false,"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","forks_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/forks","keys_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/keys{/key_id}","collaborators_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/teams","hooks_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/hooks","issue_events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/events{/number}","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/events","assignees_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/assignees{/user}","branches_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/branches{/branch}","tags_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/tags","blobs_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/git/refs{/sha}","trees_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/git/trees{/sha}","statuses_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/statuses/{sha}","languages_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/languages","stargazers_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/stargazers","contributors_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/contributors","subscribers_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/subscribers","subscription_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/subscription","commits_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/commits{/sha}","git_commits_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/git/commits{/sha}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/comments{/number}","issue_comment_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments{/number}","contents_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/contents/{+path}","compare_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/compare/{base}...{head}","merges_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/merges","archive_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/downloads","issues_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues{/number}","pulls_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/pulls{/number}","milestones_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones{/number}","notifications_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels{/name}","releases_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/releases{/id}","deployments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/deployments","created_at":"2018-11-27T03:35:03Z","updated_at":"2025-11-10T08:14:59Z","pushed_at":"2025-11-09T19:21:36Z","git_url":"git://github.com/sqlalchemy/sqlalchemy.git","ssh_url":"git@github.com:sqlalchemy/sqlalchemy.git","clone_url":"https://github.com/sqlalchemy/sqlalchemy.git","svn_url":"https://github.com/sqlalchemy/sqlalchemy","homepage":"https://www.sqlalchemy.org","size":97110,"stargazers_count":11107,"watchers_count":11107,"language":"Python","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":true,"forks_count":1596,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":219,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["python","sql","sqlalchemy"],"visibility":"public","forks":1596,"open_issues":219,"watchers":11107,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"### Describe the bug\r\n\r\nHi, while tracking down #12076  / #12077 we found that we were hitting another connection leak under similar circumstances.\r\n\r\nThe setup is as follows:\r\n- SA connection pool + asyncpg with a `direct_tls=true` connection.\r\n- an asyncio task takes a session from the pool, starts a transaction and locks some rows with `SELECT ... FOR UPDATE`, then does some async work, while holding the lock + transaction\r\n- the asyncio task is cancelled.\r\n\r\nAt this point, it is possible that the connection holding the lock will leak (and still hold the lock).\r\n\r\nThe `direct_tls` stuff is what is used to connect to GCP CloudSQL instances with the [gcp cloud sql python connector](https://github.com/GoogleCloudPlatform/cloud-sql-python-connector), where we were having the issue in the first place.\r\n\r\n### Optional link from https://docs.sqlalchemy.org which documents the behavior that is expected\r\n\r\n_No response_\r\n\r\n### SQLAlchemy Version in Use\r\n\r\n2.0.36\r\n\r\n### DBAPI (i.e. the database driver)\r\n\r\nasyncpg\r\n\r\n### Database Vendor and Major Version\r\n\r\npostgresql 16\r\n\r\n### Python Version\r\n\r\n3.12\r\n\r\n### Operating system\r\n\r\nlinux\r\n\r\n### To Reproduce\r\nThe setup is a little bit involved, so I created a repo with a docker compose config to make it easier to reproduce:\r\n\r\nhttps://github.com/brittlesoft/repro-starlette-sa-conn-leak\r\n\r\nThe idea is to:\r\n- install the deps\r\n- docker compose up to start postgres + nginx (ssl connection termination)\r\n- run direct_tls_leak.py\r\n- watch the number of connections grow beyond the configured pool size.\r\n\r\n\r\nHere's a copy of the script.\r\n\r\n```python\r\n\r\nimport asyncio\r\nimport asyncpg\r\n\r\nfrom sqlalchemy.ext.asyncio import async_sessionmaker, create_async_engine\r\nfrom sqlalchemy.sql import text\r\n\r\n# direct_tls seems to be the key to seeing the issue\r\nSQLALCHEMY_DATABASE_URL = \"postgresql+asyncpg://postgres:postgres@localhost:5443/postgres?direct_tls=true\"\r\n\r\n# pool_size must be >1\r\nengine = create_async_engine(SQLALCHEMY_DATABASE_URL, pool_size=2, max_overflow=0, echo_pool=\"debug\")\r\nasync_session = async_sessionmaker(engine, expire_on_commit=False)\r\n\r\nasync def querier():\r\n    async with async_session() as session, session.begin():\r\n        # locking rows is important for reproducing the issue\r\n        res = await session.execute(text(\"select * from test for update;\"))\r\n        print([row for row in res])\r\n\r\n        # simulate more asyncio work while tx is open and lock is held\r\n        # task will be cancelled during this\r\n        await asyncio.sleep(10)\r\n\r\nasync def main():\r\n\r\n    async with async_session() as session, session.begin():\r\n        res = await session.execute(text(\"create table if not exists test (a text);\"))\r\n        print(res)\r\n        res = await session.execute(text(\"insert into test values ('patate');\"))\r\n        print(res)\r\n\r\n    while True:\r\n        ts = []\r\n        for i in range(3):  # 1 more than pool size\r\n            ts.append(asyncio.create_task(querier()))\r\n\r\n        async def timeouter():\r\n            await asyncio.sleep(1)\r\n            for t in ts:\r\n                t.cancel()\r\n\r\n        asyncio.create_task(timeouter())\r\n\r\n        try:\r\n            await asyncio.gather(*ts)\r\n        except asyncio.CancelledError:\r\n            print(\"cancelled\")\r\n\r\nif __name__ == '__main__':\r\n    asyncio.run(main())\r\n```\r\n\r\n\r\n### Error\r\n\r\n```\r\n2024-11-14 11:44:58,563 DEBUG sqlalchemy.pool.impl.AsyncAdaptedQueuePool Created new connection <AdaptedConnection <asyncpg.connection.Connection object at 0x1224d1040>>\r\n2024-11-14 11:44:58,564 DEBUG sqlalchemy.pool.impl.AsyncAdaptedQueuePool Created new connection <AdaptedConnection <asyncpg.connection.Connection object at 0x1224d1130>>\r\n2024-11-14 11:44:58,566 DEBUG sqlalchemy.pool.impl.AsyncAdaptedQueuePool Connection <AdaptedConnection <asyncpg.connection.Connection object at 0x1224d1040>> checked out from pool\r\n2024-11-14 11:44:58,567 DEBUG sqlalchemy.pool.impl.AsyncAdaptedQueuePool Connection <AdaptedConnection <asyncpg.connection.Connection object at 0x1224d1130>> checked out from pool\r\n2024-11-14 11:44:59,521 INFO sqlalchemy.pool.impl.AsyncAdaptedQueuePool Invalidate connection <AdaptedConnection <asyncpg.connection.Connection object at 0x1224d1040>> (reason: CancelledError:)\r\n2024-11-14 11:44:59,521 DEBUG sqlalchemy.pool.impl.AsyncAdaptedQueuePool Hard-closing connection <AdaptedConnection <asyncpg.connection.Connection object at 0x1224d1040>>\r\n2024-11-14 11:44:59,522 INFO sqlalchemy.pool.impl.AsyncAdaptedQueuePool Invalidate connection <AdaptedConnection <asyncpg.connection.Connection object at 0x1224d1130>> (reason: CancelledError:)\r\n2024-11-14 11:44:59,522 DEBUG sqlalchemy.pool.impl.AsyncAdaptedQueuePool Hard-closing connection <AdaptedConnection <asyncpg.connection.Connection object at 0x1224d1130>>\r\n``` \r\n\r\nthe `hard-closed` connections are not closed.\r\n\r\n### Additional context\r\n\r\nI am not sure where the issue lies exactly, is it in asyncpg  + tls handling or in the error handling for sessions holding a transaction + lock ?\r\n\r\nI'm also not sure what would be the best behavior here, when the lock is released / transaction is rolled back, should the session be returned to the pool or hard closed like it is trying to do currently?","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/12099/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/12099/timeline","performed_via_github_app":null,"state_reason":"not_planned"}},"event":"cross-referenced"},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/2478897403","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/12077#issuecomment-2478897403","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/12077","id":2478897403,"node_id":"IC_kwDOCX5JB86TwPj7","user":{"login":"sqla-tester","id":8250554,"node_id":"MDQ6VXNlcjgyNTA1NTQ=","avatar_url":"https://avatars.githubusercontent.com/u/8250554?v=4","gravatar_id":"","url":"https://api.github.com/users/sqla-tester","html_url":"https://github.com/sqla-tester","followers_url":"https://api.github.com/users/sqla-tester/followers","following_url":"https://api.github.com/users/sqla-tester/following{/other_user}","gists_url":"https://api.github.com/users/sqla-tester/gists{/gist_id}","starred_url":"https://api.github.com/users/sqla-tester/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqla-tester/subscriptions","organizations_url":"https://api.github.com/users/sqla-tester/orgs","repos_url":"https://api.github.com/users/sqla-tester/repos","events_url":"https://api.github.com/users/sqla-tester/events{/privacy}","received_events_url":"https://api.github.com/users/sqla-tester/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-11-15T13:55:57Z","updated_at":"2024-11-15T13:55:57Z","body":"**Jean Raby** has proposed a fix for this issue in the **main** branch:\n\n**asyncpg: shield connection close in terminate to avoid connection leak** https://gerrit.sqlalchemy.org/c/sqlalchemy/sqlalchemy/+/5594","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/2478897403/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqla-tester","id":8250554,"node_id":"MDQ6VXNlcjgyNTA1NTQ=","avatar_url":"https://avatars.githubusercontent.com/u/8250554?v=4","gravatar_id":"","url":"https://api.github.com/users/sqla-tester","html_url":"https://github.com/sqla-tester","followers_url":"https://api.github.com/users/sqla-tester/followers","following_url":"https://api.github.com/users/sqla-tester/following{/other_user}","gists_url":"https://api.github.com/users/sqla-tester/gists{/gist_id}","starred_url":"https://api.github.com/users/sqla-tester/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqla-tester/subscriptions","organizations_url":"https://api.github.com/users/sqla-tester/orgs","repos_url":"https://api.github.com/users/sqla-tester/repos","events_url":"https://api.github.com/users/sqla-tester/events{/privacy}","received_events_url":"https://api.github.com/users/sqla-tester/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/2599125641","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/12077#issuecomment-2599125641","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/12077","id":2599125641,"node_id":"IC_kwDOCX5JB86a64KJ","user":{"login":"sqla-tester","id":8250554,"node_id":"MDQ6VXNlcjgyNTA1NTQ=","avatar_url":"https://avatars.githubusercontent.com/u/8250554?v=4","gravatar_id":"","url":"https://api.github.com/users/sqla-tester","html_url":"https://github.com/sqla-tester","followers_url":"https://api.github.com/users/sqla-tester/followers","following_url":"https://api.github.com/users/sqla-tester/following{/other_user}","gists_url":"https://api.github.com/users/sqla-tester/gists{/gist_id}","starred_url":"https://api.github.com/users/sqla-tester/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqla-tester/subscriptions","organizations_url":"https://api.github.com/users/sqla-tester/orgs","repos_url":"https://api.github.com/users/sqla-tester/repos","events_url":"https://api.github.com/users/sqla-tester/events{/privacy}","received_events_url":"https://api.github.com/users/sqla-tester/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-01-17T20:18:53Z","updated_at":"2025-01-17T20:18:53Z","body":"**Federico Caselli** has proposed a fix for this issue in the **rel_2_0** branch:\n\n**asyncpg: shield connection close in terminate to avoid connection leak** https://gerrit.sqlalchemy.org/c/sqlalchemy/sqlalchemy/+/5667","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/2599125641/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqla-tester","id":8250554,"node_id":"MDQ6VXNlcjgyNTA1NTQ=","avatar_url":"https://avatars.githubusercontent.com/u/8250554?v=4","gravatar_id":"","url":"https://api.github.com/users/sqla-tester","html_url":"https://github.com/sqla-tester","followers_url":"https://api.github.com/users/sqla-tester/followers","following_url":"https://api.github.com/users/sqla-tester/following{/other_user}","gists_url":"https://api.github.com/users/sqla-tester/gists{/gist_id}","starred_url":"https://api.github.com/users/sqla-tester/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqla-tester/subscriptions","organizations_url":"https://api.github.com/users/sqla-tester/orgs","repos_url":"https://api.github.com/users/sqla-tester/repos","events_url":"https://api.github.com/users/sqla-tester/events{/privacy}","received_events_url":"https://api.github.com/users/sqla-tester/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":16005585486,"node_id":"CE_lADOCX5JB86dyWu7zwAAAAO6AdpO","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/events/16005585486","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":"2f6ca6554ddd725849dd6b2d32bf495391087bec","commit_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/commits/2f6ca6554ddd725849dd6b2d32bf495391087bec","created_at":"2025-01-21T00:35:21Z","state_reason":null,"performed_via_github_app":null},{"id":16005585653,"node_id":"REFE_lADOCX5JB86dyWu7zwAAAAO6Adr1","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/events/16005585653","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"9eb87f47aeb591fd9d354bd9b3d2918d561e6011","commit_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/commits/9eb87f47aeb591fd9d354bd9b3d2918d561e6011","created_at":"2025-01-21T00:35:22Z","performed_via_github_app":null}]