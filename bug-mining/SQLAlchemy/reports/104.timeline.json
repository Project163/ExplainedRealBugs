[{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441922616","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2985#issuecomment-441922616","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2985","id":441922616,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkyMjYxNg==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2014-03-05T06:08:30Z","updated_at":"2018-11-27T05:27:55Z","body":"**Michael Bayer ([@zzzeek](https://github.com/zzzeek)) wrote:**\n\ntest case.  In this test, the current method calls engine.dispose() about seven times and seven pools are created.   using the new system, only one pool is created.\n\n```\nfrom sqlalchemy.pool import QueuePool\nfrom sqlalchemy import create_engine, exc\nimport mock\nimport time\nimport threading\nimport random\n\ndef slow_close():\n    slow_closing_connection._slow_close()\n    time.sleep(.5)\n\nslow_closing_connection = mock.Mock()\nslow_closing_connection.connect.return_value = mock.Mock()\nslow_closing_connection.connect.return_value.close = slow_close\n\nclass Error(Exception):\n    pass\n\ndialect = mock.Mock()\ndialect.is_disconnect = lambda *arg, **kw: True\ndialect.dbapi.Error = Error\n\npools = []\nclass TrackQueuePool(QueuePool):\n    def __init__(self, *arg, **kw):\n        pools.append(self)\n        super(TrackQueuePool, self).__init__(*arg, **kw)\n\ndef creator():\n    return slow_closing_connection.connect()\np1 = TrackQueuePool(creator=creator, pool_size=20)\n\neng = create_engine(\"postgresql://\", pool=p1, _initialize=False)\neng.dialect = dialect\n\n# 15 total connections\nconns = [eng.connect() for i in range(15)]\n\n\n# return 8 back to the pool\nfor conn in conns[3:10]:\n    conn.close()\n\ndef attempt(conn):\n    time.sleep(random.random())\n    try:\n        conn._handle_dbapi_exception(Error(), \"statement\", {}, mock.Mock(), mock.Mock())\n    except exc.DBAPIError:\n        pass\n\n# run an error + invalidate operation on the remaining 7 open connections\nthreads = []\nfor conn in conns:\n    t = threading.Thread(target=attempt, args=(conn, ))\n    t.start()\n    threads.append(t)\n\nfor t in threads:\n    t.join()\n\n# return all 15 connections to the pool\nfor conn in conns:\n    conn.close()\n\n# re-open 15 total connections\nconns = [eng.connect() for i in range(15)]\n\n# 15 connections have been fully closed due to invalidate\nassert slow_closing_connection._slow_close.call_count == 15\n\n# 15 initial connections + 15 reconnections\nassert slow_closing_connection.connect.call_count == 30\nassert len(pools) <= 2, len(pools)\n\n\n\n```\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441922616/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441922618","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2985#issuecomment-441922618","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2985","id":441922618,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkyMjYxOA==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2014-03-22T22:46:06Z","updated_at":"2018-11-27T05:27:56Z","body":"**Michael Bayer ([@zzzeek](https://github.com/zzzeek)) wrote:**\n\n- A major improvement made to the mechanics by which the :class:`.Engine`\nrecycles the connection pool when a \"disconnect\" condition is detected;\ninstead of discarding the pool and explicitly closing out connections,\nthe pool is retained and a \"generational\" timestamp is updated to\nreflect the current time, thereby causing all existing connections\nto be recycled when they are next checked out.   This greatly simplifies\nthe recycle process, removes the need for \"waking up\" connect attempts\nwaiting on the old pool and eliminates the race condition that many\nimmediately-discarded \"pool\" objects could be created during the\nrecycle operation. fixes #2985\n\n\n→ eed9cfc3ae02\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441922618/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441922624","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2985#issuecomment-441922624","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2985","id":441922624,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkyMjYyNA==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2014-03-22T22:46:07Z","updated_at":"2018-11-27T05:27:56Z","body":"**Changes by Michael Bayer ([@zzzeek](https://github.com/zzzeek)):**\n\n* changed **status** to closed\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441922624/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":1988601073,"node_id":"MDExOkNsb3NlZEV2ZW50MTk4ODYwMTA3Mw==","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/events/1988601073","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2014-03-22T22:46:07Z","state_reason":null,"performed_via_github_app":null},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441922622","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2985#issuecomment-441922622","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2985","id":441922622,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkyMjYyMg==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2014-03-22T23:34:39Z","updated_at":"2018-11-27T05:27:56Z","body":"**Michael Bayer ([@zzzeek](https://github.com/zzzeek)) wrote:**\n\n- restore the old behavior of the connection pool replacing itself just\nwithin userland engine.dispose(); as some SQLA tests already failed when the replace step\nwas removed, due to those conns still being referenced, it's likely this will\ncreate surprises for all those users that incorrectly use dispose()\nand it's not really worth dealing with.  This doesn't affect the change\nwe made for ref: #2985.\n\n\n→ 8e10ab92df0d\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441922622/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441922623","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2985#issuecomment-441922623","issue_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2985","id":441922623,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTkyMjYyMw==","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2014-05-10T19:51:45Z","updated_at":"2018-11-27T05:27:56Z","body":"**Michael Bayer ([@zzzeek](https://github.com/zzzeek)) wrote:**\n\n- Fixed some \"double invalidate\" situations were detected where\na connection invalidation could occur within an already critical section\nlike a connection.close(); ultimately, these conditions are caused\nby the change in :ticket:`2907`, in that the \"reset on return\" feature\ncalls out to the Connection/Transaction in order to handle it, where\n\"disconnect detection\" might be caught.  However, it's possible that\nthe more recent change in :ticket:`2985` made it more likely for this\nto be seen as the \"connection invalidate\" operation is much quicker,\nas the issue is more reproducible on 0.9.4 than 0.9.3.\n\nChecks are now added within any section that\nan invalidate might occur to halt further disallowed operations\non the invalidated connection.  This includes two fixes both at the\nengine level and at the pool level.   While the issue was observed\nwith highly concurrent gevent cases, it could in theory occur in\nany kind of scenario where a disconnect occurs within the connection\nclose operation.\nfixes #3043\nref #2985\nref #2907\n\n- add some defensive checks during an invalidate situation:\n1. _ConnectionRecord.invalidate might be called twice within finalize_fairy\nif the _reset() raises an invalidate condition, invalidates, raises and then\ngoes to invalidate the CR.  so check for this.\n2. similarly within Conneciton, anytime we do handle_dbapi_error(), we might become invalidated.\nso a following finally must check self.__invalid before dealing with the connection\nany futher.\n\n\n→ 85d1899b76a3\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments/441922623/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":1988601065,"node_id":"MDEyOkxhYmVsZWRFdmVudDE5ODg2MDEwNjU=","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/events/1988601065","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2018-11-27T05:27:55Z","label":{"name":"high priority","color":"C0B0E0"},"performed_via_github_app":null},{"id":1988601066,"node_id":"MDEyOkxhYmVsZWRFdmVudDE5ODg2MDEwNjY=","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/events/1988601066","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2018-11-27T05:27:55Z","label":{"name":"bug","color":"d73a4a"},"performed_via_github_app":null},{"id":1988601068,"node_id":"MDE1Ok1pbGVzdG9uZWRFdmVudDE5ODg2MDEwNjg=","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/events/1988601068","actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"milestoned","commit_id":null,"commit_url":null,"created_at":"2018-11-27T05:27:55Z","milestone":{"title":"0.9.4"},"performed_via_github_app":null},{"actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-11-27T05:30:26Z","updated_at":"2018-11-27T05:30:26Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3043","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3043/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3043/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3043/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3043","id":384630419,"node_id":"MDU6SXNzdWUzODQ2MzA0MTk=","number":3043,"title":"Error \"File descriptor was closed in another greenlet\" using v0.9.4 and gevent.monkey.patch_all","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269142,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141273873,"node_id":"MDU6TGFiZWwxMTQxMjczODcz","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/high%20priority","name":"high priority","color":"C0B0E0","default":false,"description":null},{"id":1141275054,"node_id":"MDU6TGFiZWwxMTQxMjc1MDU0","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/connection%20pool","name":"connection pool","color":"4cc5c9","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/68","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/68","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/68/labels","id":3850651,"node_id":"MDk6TWlsZXN0b25lMzg1MDY1MQ==","number":68,"title":"0.9.5","description":null,"creator":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":42,"state":"closed","created_at":"2018-11-27T04:28:42Z","updated_at":"2018-11-28T16:50:00Z","due_on":null,"closed_at":"2018-11-28T16:50:00Z"},"comments":33,"created_at":"2014-05-06T08:07:58Z","updated_at":"2016-09-21T18:27:28Z","closed_at":"2014-05-10T19:51:45Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":159271175,"node_id":"MDEwOlJlcG9zaXRvcnkxNTkyNzExNzU=","name":"sqlalchemy","full_name":"sqlalchemy/sqlalchemy","private":false,"owner":{"login":"sqlalchemy","id":6043126,"node_id":"MDEyOk9yZ2FuaXphdGlvbjYwNDMxMjY=","avatar_url":"https://avatars.githubusercontent.com/u/6043126?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy","html_url":"https://github.com/sqlalchemy","followers_url":"https://api.github.com/users/sqlalchemy/followers","following_url":"https://api.github.com/users/sqlalchemy/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy/orgs","repos_url":"https://api.github.com/users/sqlalchemy/repos","events_url":"https://api.github.com/users/sqlalchemy/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/sqlalchemy/sqlalchemy","description":"The Database Toolkit for Python","fork":false,"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","forks_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/forks","keys_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/keys{/key_id}","collaborators_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/teams","hooks_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/hooks","issue_events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/events{/number}","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/events","assignees_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/assignees{/user}","branches_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/branches{/branch}","tags_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/tags","blobs_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/git/refs{/sha}","trees_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/git/trees{/sha}","statuses_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/statuses/{sha}","languages_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/languages","stargazers_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/stargazers","contributors_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/contributors","subscribers_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/subscribers","subscription_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/subscription","commits_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/commits{/sha}","git_commits_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/git/commits{/sha}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/comments{/number}","issue_comment_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments{/number}","contents_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/contents/{+path}","compare_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/compare/{base}...{head}","merges_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/merges","archive_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/downloads","issues_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues{/number}","pulls_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/pulls{/number}","milestones_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones{/number}","notifications_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels{/name}","releases_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/releases{/id}","deployments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/deployments","created_at":"2018-11-27T03:35:03Z","updated_at":"2025-11-10T08:14:59Z","pushed_at":"2025-11-09T19:21:36Z","git_url":"git://github.com/sqlalchemy/sqlalchemy.git","ssh_url":"git@github.com:sqlalchemy/sqlalchemy.git","clone_url":"https://github.com/sqlalchemy/sqlalchemy.git","svn_url":"https://github.com/sqlalchemy/sqlalchemy","homepage":"https://www.sqlalchemy.org","size":97110,"stargazers_count":11107,"watchers_count":11107,"language":"Python","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":true,"forks_count":1596,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":219,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["python","sql","sqlalchemy"],"visibility":"public","forks":1596,"open_issues":219,"watchers":11107,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"**Migrated issue, originally created by Gaofeng Liang**\n\nI'm using gevent and sqlalchemy in my thrift(RPC) project. I upgraded SQLAlchemy from v0.9.3 to v0.9.4 a few days ago and then found the error.\nFollowing is how I use sqlalchemy and gevent:\n\n* scoped_session(thread-local)\n* use gevent.spawn to handle every request and session.close after finishing handling\n\nThe error is gone when SQLAlchemy is  downgraded to v0.9.3.\n\nI noticed that the version 0.9.4 has \"Key fixes include an enhancement to the mechanics of connection pool recycling to be more efficient \".  Does it have anything to do with the error.\n\n\n```\nFile \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/orm/attributes.py\", line 233, in __get__\n    return self.impl.get(instance_state(instance), dict_)\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/orm/attributes.py\", line 577, in get\n    value = callable_(state, passive)\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/orm/state.py\", line 360, in __call__\n    self.manager.deferred_scalar_loader(self, toload)\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/orm/loading.py\", line 606, in load_scalar_attributes\n    \n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/orm/loading.py\", line 230, in load_on_ident\n    return q.one()\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/orm/query.py\", line 2361, in one\n    raise orm_exc.NoResultFound(\"No row was found for one()\")\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/orm/query.py\", line 2404, in __iter__\n    conn = conn.execution_options(**self._execution_options)\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/orm/query.py\", line 2419, in _execute_and_instances\n    returned by this :class:`.Query`.\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 720, in execute\n    \"\"\"Execute a sql.FunctionElement object.\"\"\"\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/sql/elements.py\", line 317, in _execute_on_connection\n    return connection._execute_clauseelement(self, multiparams, params)\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 817, in _execute_clauseelement\n    self.dispatch.after_execute(self,\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 947, in _execute_context\n    context._fetch_implicit_returning(result)\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1108, in _handle_dbapi_exception\n    The operations inside the function are all invoked within the\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/util/compat.py\", line 185, in raise_from_cause\n    reraise(type(exception), exception, tb=exc_tb)\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 940, in _execute_context\n    context.post_insert()\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/engine/default.py\", line 435, in do_execute\n    # after the initial set of 'isolation_level', if any, so is\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/pymysql/cursors.py\", line 132, in execute\n    result = self._query(query)\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/pymysql/cursors.py\", line 271, in _query\n    conn.query(q)\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/pymysql/connections.py\", line 726, in query\n    self._affected_rows = self._read_query_result(unbuffered=unbuffered)\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/pymysql/connections.py\", line 861, in _read_query_result\n    result.read()\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/pymysql/connections.py\", line 1064, in read\n    first_packet = self.connection._read_packet()\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/pymysql/connections.py\", line 825, in _read_packet\n    packet = packet_type(self)\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/pymysql/connections.py\", line 242, in __init__\n    self._recv_packet(connection)\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/pymysql/connections.py\", line 248, in _recv_packet\n    packet_header = connection._read_bytes(4)\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/pymysql/connections.py\", line 838, in _read_bytes\n    2013, \"Lost connection to MySQL server during query (%r)\" % (e,))\nOperationalError: (OperationalError) (2013, \"Lost connection to MySQL server during query (error(9, 'File descriptor was closed in another greenlet'))\")\n\n\n\n```\n\n","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3043/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3043/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"},{"actor":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-11-27T05:39:49Z","updated_at":"2018-11-27T05:39:49Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3258","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3258/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3258/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3258/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3258","id":384632470,"node_id":"MDU6SXNzdWUzODQ2MzI0NzA=","number":3258,"title":"a gevent killed greenlet causes pymysql (and mysqlconnector?) to continue on the wrong/a broken connection","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269142,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141275752,"node_id":"MDU6TGFiZWwxMTQxMjc1NzUy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/engine","name":"engine","color":"B04040","default":false,"description":"engines, connections, transactions, isolation levels, execution options"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":28,"created_at":"2014-11-27T09:16:30Z","updated_at":"2016-09-21T18:26:43Z","closed_at":"2014-11-27T16:35:09Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":159271175,"node_id":"MDEwOlJlcG9zaXRvcnkxNTkyNzExNzU=","name":"sqlalchemy","full_name":"sqlalchemy/sqlalchemy","private":false,"owner":{"login":"sqlalchemy","id":6043126,"node_id":"MDEyOk9yZ2FuaXphdGlvbjYwNDMxMjY=","avatar_url":"https://avatars.githubusercontent.com/u/6043126?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy","html_url":"https://github.com/sqlalchemy","followers_url":"https://api.github.com/users/sqlalchemy/followers","following_url":"https://api.github.com/users/sqlalchemy/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy/orgs","repos_url":"https://api.github.com/users/sqlalchemy/repos","events_url":"https://api.github.com/users/sqlalchemy/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/sqlalchemy/sqlalchemy","description":"The Database Toolkit for Python","fork":false,"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","forks_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/forks","keys_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/keys{/key_id}","collaborators_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/teams","hooks_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/hooks","issue_events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/events{/number}","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/events","assignees_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/assignees{/user}","branches_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/branches{/branch}","tags_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/tags","blobs_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/git/refs{/sha}","trees_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/git/trees{/sha}","statuses_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/statuses/{sha}","languages_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/languages","stargazers_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/stargazers","contributors_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/contributors","subscribers_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/subscribers","subscription_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/subscription","commits_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/commits{/sha}","git_commits_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/git/commits{/sha}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/comments{/number}","issue_comment_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/comments{/number}","contents_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/contents/{+path}","compare_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/compare/{base}...{head}","merges_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/merges","archive_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/downloads","issues_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues{/number}","pulls_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/pulls{/number}","milestones_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones{/number}","notifications_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels{/name}","releases_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/releases{/id}","deployments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/deployments","created_at":"2018-11-27T03:35:03Z","updated_at":"2025-11-10T08:14:59Z","pushed_at":"2025-11-09T19:21:36Z","git_url":"git://github.com/sqlalchemy/sqlalchemy.git","ssh_url":"git@github.com:sqlalchemy/sqlalchemy.git","clone_url":"https://github.com/sqlalchemy/sqlalchemy.git","svn_url":"https://github.com/sqlalchemy/sqlalchemy","homepage":"https://www.sqlalchemy.org","size":97110,"stargazers_count":11107,"watchers_count":11107,"language":"Python","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":true,"forks_count":1596,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":219,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["python","sql","sqlalchemy"],"visibility":"public","forks":1596,"open_issues":219,"watchers":11107,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"**Migrated issue, originally created by lxyu ([@lxyu](https://github.com/lxyu))**\n\nthe same error reported in https://bitbucket.org/zzzeek/sqlalchemy/issue/3043/error-file-descriptor-was-closed-in back again.\n\nCurrently the most stable version is 0.9.3, which only produce small amount of AttributeError, and versions after produces different exceptions, especially more excs since 0.9.5\n\nI tested python-mysql-connector + gevent + sqlalchemy too and the problem is the same, so I assume the bug is in the sqlalchemy side.\n\nThe test was done with your benchmark script, both test script and produced log pasted here:\n\nhttps://gist.github.com/lxyu/7cbd6cbe83b47e581c8d\n\nThe bug is very serious since it may cause strange bug in mysql transaction, we have captured situation where only part of the transaction succeed in our prod servers.\n\n","reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3258/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3258/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"}]