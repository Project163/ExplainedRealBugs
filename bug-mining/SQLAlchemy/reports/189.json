{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3163","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3163/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3163/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3163/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3163","id":384631570,"node_id":"MDU6SXNzdWUzODQ2MzE1NzA=","number":3163,"title":"use deque() for event lists so that remove() raises during an event","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269142,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141275752,"node_id":"MDU6TGFiZWwxMTQxMjc1NzUy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/engine","name":"engine","color":"B04040","default":false,"description":"engines, connections, transactions, isolation levels, execution options"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/42","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/42","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/42/labels","id":3850611,"node_id":"MDk6TWlsZXN0b25lMzg1MDYxMQ==","number":42,"title":"1.0","description":null,"creator":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":101,"state":"closed","created_at":"2018-11-27T04:04:03Z","updated_at":"2018-11-28T16:49:52Z","due_on":null,"closed_at":"2018-11-28T16:49:52Z"},"comments":3,"created_at":"2014-08-12T16:12:22Z","updated_at":"2014-08-14T18:40:55Z","closed_at":"2014-08-14T18:40:56Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by Michael Bayer ([@zzzeek](https://github.com/zzzeek))**\n\nquick test:\n\n\n```\nimport unittest\n\nfrom sqlalchemy import event\nfrom sqlalchemy.orm import Session\n\n\nclass Receiver(object):\n    def __init__(self, instance, remove):\n        self.instance = instance\n        self.remove = remove\n\n    def __call__(self, session, context):\n        self.instance.calls += 1\n        if self.remove:\n            event.remove(self.instance.session, 'after_flush_postexec', self)\n\n    @classmethod\n    def register(cls, instance, remove):\n        self = cls(instance, remove=remove)\n        event.listen(instance.session, 'after_flush_postexec', self)\n\n\nclass FlushingTest(unittest.TestCase):\n\n    def setUp(self):\n        self.session = Session()\n        self.calls = 0\n\n    def flush(self):\n        self.session.dispatch.after_flush_postexec(self.session, {})\n\n    def testTripleRemove(self):\n        Receiver.register(self, remove=True)\n        Receiver.register(self, remove=True)\n        Receiver.register(self, remove=True)\n        self.flush()\n        self.assertEqual(self.calls, 3)\n\nunittest.main()\n\n```\n\nwhich fails, because we're iterating through a list.\n\nThis patch replaces the lists with a deque, just as fast or faster than a list, all tests pass:\n\n\n```\ndiff --git a/lib/sqlalchemy/event/attr.py b/lib/sqlalchemy/event/attr.py\nindex 7641b59..dba1063 100644\n--- a/lib/sqlalchemy/event/attr.py\n+++ b/lib/sqlalchemy/event/attr.py\n@@ -37,6 +37,7 @@ from . import registry\n from . import legacy\n from itertools import chain\n import weakref\n+import collections\n \n \n class RefCollection(object):\n@@ -96,8 +97,8 @@ class _DispatchDescriptor(RefCollection):\n                 self.update_subclass(cls)\n             else:\n                 if cls not in self._clslevel:\n-                    self._clslevel[cls] = []\n-                self._clslevel[cls].insert(0, event_key._listen_fn)\n+                    self._clslevel[cls] = collections.deque()\n+                self._clslevel[cls].appendleft(event_key._listen_fn)\n         registry._stored_in_collection(event_key, self)\n \n     def append(self, event_key, propagate):\n@@ -113,13 +114,13 @@ class _DispatchDescriptor(RefCollection):\n                 self.update_subclass(cls)\n             else:\n                 if cls not in self._clslevel:\n-                    self._clslevel[cls] = []\n+                    self._clslevel[cls] = collections.deque()\n                 self._clslevel[cls].append(event_key._listen_fn)\n         registry._stored_in_collection(event_key, self)\n \n     def update_subclass(self, target):\n         if target not in self._clslevel:\n-            self._clslevel[target] = []\n+            self._clslevel[target] = collections.deque()\n         clslevel = self._clslevel[target]\n         for cls in target.__mro__[1:]:\n             if cls in self._clslevel:\n@@ -145,7 +146,7 @@ class _DispatchDescriptor(RefCollection):\n         to_clear = set()\n         for dispatcher in self._clslevel.values():\n             to_clear.update(dispatcher)\n-            dispatcher[:] = []\n+            dispatcher.clear()\n         registry._clear(self, to_clear)\n \n     def for_modify(self, obj):\n@@ -287,7 +288,7 @@ class _ListenerCollection(RefCollection, _CompoundListener):\n         self.parent_listeners = parent._clslevel[target_cls]\n         self.parent = parent\n         self.name = parent.__name__\n-        self.listeners = []\n+        self.listeners = collections.deque()\n         self.propagate = set()\n \n     def for_modify(self, obj):\n@@ -337,7 +338,7 @@ class _ListenerCollection(RefCollection, _CompoundListener):\n     def clear(self):\n         registry._clear(self, self.listeners)\n         self.propagate.clear()\n-        self.listeners[:] = []\n+        self.listeners.clear()\n \n \n class _JoinedDispatchDescriptor(object):\ndiff --git a/lib/sqlalchemy/event/registry.py b/lib/sqlalchemy/event/registry.py\nindex a34de3c..ba2f671 100644\n--- a/lib/sqlalchemy/event/registry.py\n+++ b/lib/sqlalchemy/event/registry.py\n@@ -243,4 +243,4 @@ class _EventKey(object):\n \n     def prepend_to_list(self, owner, list_):\n         _stored_in_collection(self, owner)\n-        list_.insert(0, self._listen_fn)\n+        list_.appendleft(self._listen_fn)\n\n```\n\nthe deque(), nicely enough, raises!\n\n    RuntimeError: deque mutated during iteration\n\nthis is a totally easy win.\n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3163/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3163/timeline","performed_via_github_app":null,"state_reason":"completed"}