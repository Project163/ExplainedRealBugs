{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/2696","id":384627503,"node_id":"MDU6SXNzdWUzODQ2Mjc1MDM=","number":2696,"title":"Misleading exception triggered on session.commit() low-level error","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269142,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141273873,"node_id":"MDU6TGFiZWwxMTQxMjczODcz","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/high%20priority","name":"high priority","color":"C0B0E0","default":false,"description":null},{"id":1141273966,"node_id":"MDU6TGFiZWwxMTQxMjczOTY2","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/orm","name":"orm","color":"20C0B0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/23","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/23","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/23/labels","id":3850579,"node_id":"MDk6TWlsZXN0b25lMzg1MDU3OQ==","number":23,"title":"0.8.xx","description":null,"creator":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":125,"state":"closed","created_at":"2018-11-27T03:53:30Z","updated_at":"2018-11-28T16:49:46Z","due_on":null,"closed_at":"2018-11-28T16:49:46Z"},"comments":40,"created_at":"2013-04-05T07:28:33Z","updated_at":"2016-01-28T20:03:56Z","closed_at":"2016-01-28T20:03:56Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by Anonymous**\n\nWe got weird (\"(OperationalError) (1305, 'SAVEPOINT sa_savepoint_1 does not exist') in our prod, and after investigation, this is due to the fact that our mysql server fails a commit (we don't know why), and the handling of that exception in sqlalchemy leads to an automatic rollback to last savepoint. But that auto-rollback fails too (probably because mysql has already automatically rolled back by itself, and so destroyed savepoints), and thus the new exception \"SAVEPOINT does not exist\" hides the original error that caused all that trouble.\n\nHere is the faulting code line, in latest development branch, in sqlalchemy/orm/session.py, line 1930:\n\n            except:\n                transaction.rollback(_capture_exception=True)\n                raise\n\n\nSince we don't know the actual state of the mysql transaction at that moment, I guess that this automatic rollback should be protected by a try...except, so that if it fails, it's the original error that will be reraised in any case. Or shouldn't it ? \n\n\nHere is the full traceback we got in prod (with sqlalchemy 0.7.3, but the faulty lines are still present in latest sqlalchemy versions):\n\n    \n    File \"/home/pimsprod/PIMS/src/pims/processing/processor_abstract.py\", line 213, in retrieve_user\n        session.commit() # COMMIT SAVEPOINT\n      File \"/home/pimsprod/PIMS/src/pims/database_tools.py\", line 85, in commit\n        super(SafeSessionClass, self).commit(*args, **kwargs)\n      File \"/usr/local/lib/python2.7/site-packages/sqlalchemy/orm/session.py\", line 645, in commit\n        self.transaction.commit()\n      File \"/usr/local/lib/python2.7/site-packages/sqlalchemy/orm/session.py\", line 313, in commit\n        self._prepare_impl()\n      File \"/usr/local/lib/python2.7/site-packages/sqlalchemy/orm/session.py\", line 297, in _prepare_impl\n        self.session.flush()\n      File \"/home/pimsprod/PIMS/src/pims/database_tools.py\", line 77, in flush\n        super(SafeSessionClass, self).flush(*args, **kwargs)\n      File \"/usr/local/lib/python2.7/site-packages/sqlalchemy/orm/session.py\", line 1547, in flush\n        self._flush(objects)\n      File \"/usr/local/lib/python2.7/site-packages/sqlalchemy/orm/session.py\", line 1634, in _flush\n        transaction.rollback(_capture_exception=True)\n      File \"/usr/local/lib/python2.7/site-packages/sqlalchemy/orm/session.py\", line 338, in rollback\n        transaction._rollback_impl()\n      File \"/usr/local/lib/python2.7/site-packages/sqlalchemy/orm/session.py\", line 356, in _rollback_impl\n        t[1](1).rollback()\n      File \"/usr/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1960, in rollback\n        self._do_rollback()\n      File \"/usr/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 2020, in _do_rollback\n        self._savepoint, self._parent)\n      File \"/usr/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1249, in _rollback_to_savepoint_impl\n        self.engine.dialect.do_rollback_to_savepoint(self, name)\n      File \"/usr/local/lib/python2.7/site-packages/sqlalchemy/engine/default.py\", line 321, in do_rollback_to_savepoint\n        connection.execute(expression.RollbackToSavepointClause(name))\n      File \"/usr/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1399, in execute\n        params)\n      File \"/usr/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1532, in _execute_clauseelement\n        compiled_sql, distilled_params\n      File \"/usr/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1640, in _execute_context\n        context)\n      File \"/usr/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1633, in _execute_context\n        context)\n      File \"/usr/local/lib/python2.7/site-packages/sqlalchemy/engine/default.py\", line 330, in do_execute\n        cursor.execute(statement, parameters)\n      File \"/usr/local/lib/python2.7/site-packages/MySQLdb/cursors.py\", line 174, in execute\n        self.errorhandler(self, exc, value)\n      File \"/usr/local/lib/python2.7/site-packages/MySQLdb/connections.py\", line 36, in defaulterrorhandler\n        raise errorclass, errorvalue\n    OperationalError: (OperationalError) (1305, 'SAVEPOINT sa_savepoint_1 does not exist') 'ROLLBACK TO SAVEPOINT sa_savepoint_1' ()\n    \n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/2696/timeline","performed_via_github_app":null,"state_reason":"completed"}