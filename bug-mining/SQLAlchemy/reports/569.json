{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/12600","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/12600/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/12600/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/12600/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/12600","id":3069482733,"node_id":"I_kwDOCX5JB8629Jbt","number":12600,"title":"Reflection regression in postgresql","user":{"login":"CaselIT","id":16175304,"node_id":"MDQ6VXNlcjE2MTc1MzA0","avatar_url":"https://avatars.githubusercontent.com/u/16175304?v=4","gravatar_id":"","url":"https://api.github.com/users/CaselIT","html_url":"https://github.com/CaselIT","followers_url":"https://api.github.com/users/CaselIT/followers","following_url":"https://api.github.com/users/CaselIT/following{/other_user}","gists_url":"https://api.github.com/users/CaselIT/gists{/gist_id}","starred_url":"https://api.github.com/users/CaselIT/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/CaselIT/subscriptions","organizations_url":"https://api.github.com/users/CaselIT/orgs","repos_url":"https://api.github.com/users/CaselIT/repos","events_url":"https://api.github.com/users/CaselIT/events{/privacy}","received_events_url":"https://api.github.com/users/CaselIT/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269142,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141273914,"node_id":"MDU6TGFiZWwxMTQxMjczOTE0","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/postgresql","name":"postgresql","color":"60A070","default":false,"description":""},{"id":1142415575,"node_id":"MDU6TGFiZWwxMTQyNDE1NTc1","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/reflection","name":"reflection","color":"60e0cb","default":false,"description":"reflection of tables, columns, constraints, defaults, sequences, views, everything else"},{"id":1154021464,"node_id":"MDU6TGFiZWwxMTU0MDIxNDY0","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/regression","name":"regression","color":"b60205","default":false,"description":"something worked and was broken by a change"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/100","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/100","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/100/labels","id":8974115,"node_id":"MI_kwDOCX5JB84AiO8j","number":100,"title":"2.0.x","description":"","creator":{"login":"CaselIT","id":16175304,"node_id":"MDQ6VXNlcjE2MTc1MzA0","avatar_url":"https://avatars.githubusercontent.com/u/16175304?v=4","gravatar_id":"","url":"https://api.github.com/users/CaselIT","html_url":"https://github.com/CaselIT","followers_url":"https://api.github.com/users/CaselIT/followers","following_url":"https://api.github.com/users/CaselIT/following{/other_user}","gists_url":"https://api.github.com/users/CaselIT/gists{/gist_id}","starred_url":"https://api.github.com/users/CaselIT/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/CaselIT/subscriptions","organizations_url":"https://api.github.com/users/CaselIT/orgs","repos_url":"https://api.github.com/users/CaselIT/repos","events_url":"https://api.github.com/users/CaselIT/events{/privacy}","received_events_url":"https://api.github.com/users/CaselIT/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":68,"closed_issues":416,"state":"open","created_at":"2023-01-27T12:23:11Z","updated_at":"2025-11-08T19:58:19Z","due_on":null,"closed_at":null},"comments":19,"created_at":"2025-05-16T16:52:37Z","updated_at":"2025-05-21T07:34:01Z","closed_at":"2025-05-20T21:32:21Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"\n\n\n\n\nApologies if this is a different issue, but I'm also seeing a regression with postgres after updating from 2.0.40 to 2.0.41. Something relating to how tables are reflected seems to have broken.\n\nI'm using psycopg as the driver. Here's the relevant error and traceback:\n\n```\nsqlalchemy.exc.InternalError: (psycopg.errors.InternalError_) failed to find conversion function from unknown to text\n[SQL: SELECT attr.conrelid, array_agg(CAST(attr.attname AS TEXT) ORDER BY attr.ord) AS cols, attr.conname, min(attr.description) AS description, min(attr.indnkeyatts) AS indnkeyatts, bool_and(attr.indnullsnotdistinct) AS indnullsnotdistinct \nFROM (SELECT con.conrelid AS conrelid, con.conname AS conname, con.description AS description, con.ord AS ord, con.indnkeyatts AS indnkeyatts, con.indnullsnotdistinct AS indnullsnotdistinct, pg_catalog.pg_attribute.attname AS attname \nFROM pg_catalog.pg_attribute JOIN (SELECT pg_catalog.pg_constraint.conrelid AS conrelid, pg_catalog.pg_constraint.conname AS conname, unnest(pg_catalog.pg_index.indkey) AS attnum, generate_subscripts(pg_catalog.pg_index.indkey, %(generate_subscripts_1)s::INTEGER) AS ord, NULL AS indnkeyatts, false AS indnullsnotdistinct, pg_catalog.pg_description.description AS description \nFROM pg_catalog.pg_constraint JOIN pg_catalog.pg_index ON pg_catalog.pg_constraint.conindid = pg_catalog.pg_index.indexrelid LEFT OUTER JOIN pg_catalog.pg_description ON pg_catalog.pg_description.objoid = pg_catalog.pg_constraint.oid \nWHERE pg_catalog.pg_constraint.contype = %(contype)s::VARCHAR AND pg_catalog.pg_constraint.conrelid IN (%(oids_1)s)) AS con ON pg_catalog.pg_attribute.attnum = con.attnum AND pg_catalog.pg_attribute.attrelid = con.conrelid \nWHERE con.conrelid IN (%(oids_1)s)) AS attr GROUP BY attr.conrelid, attr.conname ORDER BY attr.conrelid, attr.conname]\n[parameters: {'generate_subscripts_1': 1, 'contype': 'p', 'oids_1': 1067720}]\n(Background on this error at: https://sqlalche.me/e/20/2j85)\n  File \"/usr/local/lib/python3.12/concurrent/futures/thread.py\", line 59, in run\n    result = self.fn(*self.args, **self.kwargs)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/dlt/extract/utils.py\", line 260, in _parallel_gen\n    return next(gen)  # type: ignore[call-overload]\n           ^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/dlt/sources/sql_database/helpers.py\", line 254, in table_rows\n    table = Table(\n            ^^^^^^\n  File \"<string>\", line 2, in __new__\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/util/deprecations.py\", line 281, in warned\n    return fn(*args, **kwargs)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/sql/schema.py\", line 429, in __new__\n    return cls._new(*args, **kw)\n           ^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/sql/schema.py\", line 483, in _new\n    with util.safe_reraise():\n         ^^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py\", line 224, in __exit__\n    raise exc_value.with_traceback(exc_tb)\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/sql/schema.py\", line 479, in _new\n    table.__init__(name, metadata, *args, _no_init=False, **kw)\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/sql/schema.py\", line 861, in __init__\n    self._autoload(\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/sql/schema.py\", line 893, in _autoload\n    conn_insp.reflect_table(\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/reflection.py\", line 1536, in reflect_table\n    _reflect_info = self._get_reflection_info(\n                    ^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/reflection.py\", line 2022, in _get_reflection_info\n    pk_constraint=run(self.get_multi_pk_constraint),\n                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/reflection.py\", line 2005, in run\n    res = meth(filter_names=_fn, **kw)\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/reflection.py\", line 1018, in get_multi_pk_constraint\n    return dict(\n           ^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/base.py\", line 4296, in <genexpr>\n    for table_name, cols, pk_name, comment, opts in result\n                                                    ^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/base.py\", line 4211, in _reflect_constraint\n    result = connection.execute(\n             ^^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\", line 1415, in execute\n    return meth(\n           ^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py\", line 523, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\", line 1637, in _execute_clauseelement\n    ret = self._execute_context(\n          ^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\", line 1842, in _execute_context\n    return self._exec_single_context(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\", line 1982, in _exec_single_context\n    self._handle_dbapi_exception(\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\", line 2351, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py\", line 1963, in _exec_single_context\n    self.dialect.do_execute(\n  File \"/app/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py\", line 943, in do_execute\n    cursor.execute(statement, parameters)\n  File \"/app/.venv/lib/python3.12/site-packages/psycopg/cursor.py\", line 97, in execute\n    raise ex.with_traceback(None)\n```\n\n_Originally posted by @cbini in https://github.com/sqlalchemy/sqlalchemy/discussions/12592#discussioncomment-13172692_\n\n\nInitial analysis this seems like a regression from https://github.com/sqlalchemy/sqlalchemy/pull/12485 that implemented https://github.com/sqlalchemy/sqlalchemy/issues/10665","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/12600/reactions","total_count":3,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/12600/timeline","performed_via_github_app":null,"state_reason":"completed"}