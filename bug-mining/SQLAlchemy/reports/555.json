{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/9911","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/9911/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/9911/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/9911/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/9911","id":1747937549,"node_id":"I_kwDOCX5JB85oL2kN","number":9911,"title":"Enum `values_callable` assumes the result has the same order as iterating through `__members__`","user":{"login":"huwcbjones","id":5251487,"node_id":"MDQ6VXNlcjUyNTE0ODc=","avatar_url":"https://avatars.githubusercontent.com/u/5251487?v=4","gravatar_id":"","url":"https://api.github.com/users/huwcbjones","html_url":"https://github.com/huwcbjones","followers_url":"https://api.github.com/users/huwcbjones/followers","following_url":"https://api.github.com/users/huwcbjones/following{/other_user}","gists_url":"https://api.github.com/users/huwcbjones/gists{/gist_id}","starred_url":"https://api.github.com/users/huwcbjones/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/huwcbjones/subscriptions","organizations_url":"https://api.github.com/users/huwcbjones/orgs","repos_url":"https://api.github.com/users/huwcbjones/repos","events_url":"https://api.github.com/users/huwcbjones/events{/privacy}","received_events_url":"https://api.github.com/users/huwcbjones/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141273862,"node_id":"MDU6TGFiZWwxMTQxMjczODYy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/documentation","name":"documentation","color":"ffe7a8","default":true,"description":""},{"id":1143569068,"node_id":"MDU6TGFiZWwxMTQzNTY5MDY4","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/datatypes","name":"datatypes","color":"59d67b","default":false,"description":"things to do with database types, like VARCHAR and others"},{"id":1171369643,"node_id":"MDU6TGFiZWwxMTcxMzY5NjQz","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/PRs%20(with%20tests!)%20welcome","name":"PRs (with tests!) welcome","color":"b8e0f9","default":false,"description":"a fix or feature which is appropriate to be implemented by volunteers"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2023-06-08T13:50:25Z","updated_at":"2023-09-16T09:41:18Z","closed_at":"2023-09-16T09:41:18Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\n\nThe `values_callable` paramater to `Enum` doesn't mention that the return value should be in the same order that the enum was defined.\r\n\r\nThis means that if the order of the values returned from values_callable does not match the order of the enum members, then SQLAlchemy will load models with the wrong enum values!\r\n\r\nThe minimal reproduction below will result in \"invalid\" values being loaded about 2/3s of the time.\n\n### Optional link from https://docs.sqlalchemy.org which documents the behavior that is expected\n\nhttp://docs.sqlalchemy.org/en/20/core/type_basics.html#sqlalchemy.types.Enum.params.values_callable\n\n### SQLAlchemy Version in Use\n\n1.4.46\n\n### DBAPI (i.e. the database driver)\n\nasyncpg\n\n### Database Vendor and Major Version\n\nPostgreSQL 13.10 (Debian 13.10-0+deb11u1)\n\n### Python Version\n\n3.9.2\n\n### Operating system\n\nDebian 11.4\n\n### To Reproduce\n\n```python\nfrom enum import Enum\r\n\r\nimport sqlalchemy as sa\r\nfrom sqlalchemy.orm import declarative_base\r\n\r\nBase = declarative_base()\r\n\r\n\r\nclass Visibility(Enum):\r\n    PUBLIC = \"public\"\r\n    UNLISTED = \"unlisted\"\r\n    PRIVATE = \"private\"\r\n    \r\n    @classmethod\r\n    def values(cls) -> set:\r\n        return set(i.value for i in cls)\r\n\r\n\r\nclass FooModel(Base):\r\n    __tablename__ = \"foo\"\r\n    \r\n    visibility = sa.Column(\r\n        sa.Enum(Visibility, values_callable=lambda m: list(m.values()))\r\n    )\n```\n\n\n### Error\n\nNo errors - but lots of confusion\n\n### Additional context\n\nI'd probably be happy with a documentation fix (and maybe an example).\r\nHowever, I agree with @ethanfurman in https://github.com/sqlalchemy/sqlalchemy/discussions/8934\r\n\r\nAnother option might be to replace `values_callable` with a `store_values` boolean that iterates through the enum instead of forcing the user to do the conversion themself.","closed_by":{"login":"CaselIT","id":16175304,"node_id":"MDQ6VXNlcjE2MTc1MzA0","avatar_url":"https://avatars.githubusercontent.com/u/16175304?v=4","gravatar_id":"","url":"https://api.github.com/users/CaselIT","html_url":"https://github.com/CaselIT","followers_url":"https://api.github.com/users/CaselIT/followers","following_url":"https://api.github.com/users/CaselIT/following{/other_user}","gists_url":"https://api.github.com/users/CaselIT/gists{/gist_id}","starred_url":"https://api.github.com/users/CaselIT/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/CaselIT/subscriptions","organizations_url":"https://api.github.com/users/CaselIT/orgs","repos_url":"https://api.github.com/users/CaselIT/repos","events_url":"https://api.github.com/users/CaselIT/events{/privacy}","received_events_url":"https://api.github.com/users/CaselIT/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/9911/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/9911/timeline","performed_via_github_app":null,"state_reason":"completed"}