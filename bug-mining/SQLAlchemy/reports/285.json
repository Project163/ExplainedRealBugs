{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3237","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3237/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3237/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3237/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3237","id":384632296,"node_id":"MDU6SXNzdWUzODQ2MzIyOTY=","number":3237,"title":"mysql dialect discards cast to float, should probably emit a warning","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269142,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141273954,"node_id":"MDU6TGFiZWwxMTQxMjczOTU0","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/mysql","name":"mysql","color":"30A040","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/42","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/42","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/42/labels","id":3850611,"node_id":"MDk6TWlsZXN0b25lMzg1MDYxMQ==","number":42,"title":"1.0","description":null,"creator":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":101,"state":"closed","created_at":"2018-11-27T04:04:03Z","updated_at":"2018-11-28T16:49:52Z","due_on":null,"closed_at":"2018-11-28T16:49:52Z"},"comments":18,"created_at":"2014-10-28T21:59:54Z","updated_at":"2015-02-09T20:29:47Z","closed_at":"2015-02-09T20:29:47Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by MartinH ([@dwt](https://github.com/dwt))**\n\nWhile debugging an error stemming from the incompatibility of decimal.Decimal with certain numerical operations in python, we discovered that sqlalchemy actually returns decimal when computing the average of an integer column in mysql, even if we wrap the query in a cast to float.\n\nPlease see this example:\n```\nimport sqlalchemy\nprint \"sqlalchemy.__version__\", sqlalchemy.__version__\n\nengine = sqlalchemy.create_engine('mysql://yeepa_demo:yeepa_demo@localhost/yeepa_demo?charset=utf8', echo=True)\nfrom sqlalchemy.ext.declarative import declarative_base\nBase = declarative_base()\nfrom sqlalchemy import Column, Integer, String\nclass Track(Base):\n    __tablename__ = 'track'\n    id = Column('idtrack', Integer, primary_key=True)\n    score = Column('score', Integer, server_default=\"0\", nullable=False)\n    user_id = Column('userid', Integer, nullable=False)\n\nfrom sqlalchemy.orm import sessionmaker\nSession = sessionmaker(bind=engine)\nsession = Session()\nfrom sqlalchemy.sql.expression import cast\nfrom sqlalchemy.types import Integer, Float\nfrom sqlalchemy import func, desc, not_\n# print session.query(cast(func.avg(func.coalesce(Track.score, 0)), Float).label('average_game_score'))\nprint session.query(Track.score, Track.user_id).limit(20).all()\nprint session.query(cast(func.avg(func.coalesce(Track.score, 0)), Float).label('average_game_score')).group_by(Track.user_id).all()\n```\n\nWhich creates this output:\n\n```\n% ./sqlalchemy_test.py\nsqlalchemy.__version__ 0.9.8\n2014-10-28 22:44:36,051 INFO sqlalchemy.engine.base.Engine SHOW VARIABLES LIKE 'sql_mode'\n2014-10-28 22:44:36,051 INFO sqlalchemy.engine.base.Engine ()\n2014-10-28 22:44:36,053 INFO sqlalchemy.engine.base.Engine SELECT DATABASE()\n2014-10-28 22:44:36,053 INFO sqlalchemy.engine.base.Engine ()\n2014-10-28 22:44:36,053 INFO sqlalchemy.engine.base.Engine show collation where `Charset` = 'utf8' and `Collation` = 'utf8_bin'\n2014-10-28 22:44:36,053 INFO sqlalchemy.engine.base.Engine ()\n2014-10-28 22:44:36,055 INFO sqlalchemy.engine.base.Engine SELECT CAST('test plain returns' AS CHAR(60)) AS anon_1\n2014-10-28 22:44:36,056 INFO sqlalchemy.engine.base.Engine ()\n2014-10-28 22:44:36,056 INFO sqlalchemy.engine.base.Engine SELECT CAST('test unicode returns' AS CHAR(60)) AS anon_1\n2014-10-28 22:44:36,056 INFO sqlalchemy.engine.base.Engine ()\n2014-10-28 22:44:36,057 INFO sqlalchemy.engine.base.Engine SELECT CAST('test collated returns' AS CHAR CHARACTER SET utf8) COLLATE utf8_bin AS anon_1\n2014-10-28 22:44:36,057 INFO sqlalchemy.engine.base.Engine ()\n2014-10-28 22:44:36,059 INFO sqlalchemy.engine.base.Engine BEGIN (implicit)\n2014-10-28 22:44:36,059 INFO sqlalchemy.engine.base.Engine SELECT track.score AS track_score, track.userid AS track_userid \nFROM track \n LIMIT %s\n2014-10-28 22:44:36,060 INFO sqlalchemy.engine.base.Engine (20,)\n[(30L, 11L), (40L, 12L), (50L, 13L), (60L, 14L), (70L, 15L), (60L, 16L), (70L, 17L), (80L, 18L), (90L, 19L), (50L, 20L), (50L, 21L), (40L, 22L), (40L, 23L), (30L, 11L), (40L, 12L), (50L, 13L), (60L, 14L), (70L, 15L), (60L, 16L), (70L, 17L)]\n2014-10-28 22:44:36,062 INFO sqlalchemy.engine.base.Engine SELECT avg(coalesce(track.score, %s)) AS average_game_score \nFROM track GROUP BY track.userid\n2014-10-28 22:44:36,062 INFO sqlalchemy.engine.base.Engine (0,)\n[(Decimal('222.4444'),), (Decimal('215.1481'),), (Decimal('23.6667'),), (Decimal('60.0000'),), (Decimal('70.0000'),), (Decimal('60.0000'),), (Decimal('70.0000'),), (Decimal('80.0000'),), (Decimal('90.0000'),), (Decimal('50.0000'),), (Decimal('50.0000'),), (Decimal('52.5000'),), (Decimal('45.0000'),), (Decimal('14.5000'),), (Decimal('0.0000'),), (Decimal('121.5000'),), (Decimal('42.0000'),), (Decimal('550.0000'),)]\n```\n\nThis shows that the cast is actually discarded in sql (which makes some sense as mysql can't cast to float, but only to decimal - which doesn't make sense, but seems to be the case). But more importantly, there seems to be no better way to express what format the returned column should have. In normal columns I can tell SQLAlchemy that we want the type to be Float, even though the underlying type might be NUMERIC, and still sqlalchemy will convert the result to float for us. To my understanding because Float implies Float(asdecimal=false).\n\nAs a workaround we added this custom type:\n```\nimport sqlalchemy.types as types\nclass MyFloat(types.TypeDecorator):\n\n    impl = types.Float\n\n    def process_bind_param(self, value, dialect):\n        return value\n\n    def process_result_value(self, value, dialect):\n        return float(value)\n\n    def copy(self):\n        return MyFloat()\n\nprint session.query(cast(func.avg(func.coalesce(Track.score, 0)), MyFloat).label('average_game_score')).group_by(Track.user_id).all()\n```\n\nwhich creates the output\n```\n2014-10-28 22:44:36,067 INFO sqlalchemy.engine.base.Engine SELECT avg(coalesce(track.score, %s)) AS average_game_score \nFROM track GROUP BY track.userid\n2014-10-28 22:44:36,067 INFO sqlalchemy.engine.base.Engine (0,)\n[(222.4444,), (215.1481,), (23.6667,), (60.0,), (70.0,), (60.0,), (70.0,), (80.0,), (90.0,), (50.0,), (50.0,), (52.5,), (45.0,), (14.5,), (0.0,), (121.5,), (42.0,), (550.0,)]\n```\n\nIs it the intentional and expected behavior for a cast to float for the result of a column in a query that it is just discarded? If so, how do I annotate a query to tell sqlalchemy that I would please like to get the result in a specific type?\n\nI think there is a good argument that the type Float(asdecimal=False) would behave more consistently if it would would allow to convert a column from a query via the cast operator as well as the column from a model. Or perhaps a different operator than cast should/could be chosen? Right now, the current behavior certainly surprised me.\n\nWould you change sqlalchemys Float implementation to force the conversion to float in ```def process_result_value(...)``` or is there some other better way to achieve this?\n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3237/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3237/timeline","performed_via_github_app":null,"state_reason":"completed"}