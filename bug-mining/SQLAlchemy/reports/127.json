{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3043","repository_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3043/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3043/comments","events_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3043/events","html_url":"https://github.com/sqlalchemy/sqlalchemy/issues/3043","id":384630419,"node_id":"MDU6SXNzdWUzODQ2MzA0MTk=","number":3043,"title":"Error \"File descriptor was closed in another greenlet\" using v0.9.4 and gevent.monkey.patch_all","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141269142,"node_id":"MDU6TGFiZWwxMTQxMjY5MTQy","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141273873,"node_id":"MDU6TGFiZWwxMTQxMjczODcz","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/high%20priority","name":"high priority","color":"C0B0E0","default":false,"description":null},{"id":1141275054,"node_id":"MDU6TGFiZWwxMTQxMjc1MDU0","url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/labels/connection%20pool","name":"connection pool","color":"4cc5c9","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/68","html_url":"https://github.com/sqlalchemy/sqlalchemy/milestone/68","labels_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/milestones/68/labels","id":3850651,"node_id":"MDk6TWlsZXN0b25lMzg1MDY1MQ==","number":68,"title":"0.9.5","description":null,"creator":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":42,"state":"closed","created_at":"2018-11-27T04:28:42Z","updated_at":"2018-11-28T16:50:00Z","due_on":null,"closed_at":"2018-11-28T16:50:00Z"},"comments":33,"created_at":"2014-05-06T08:07:58Z","updated_at":"2016-09-21T18:27:28Z","closed_at":"2014-05-10T19:51:45Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by Gaofeng Liang**\n\nI'm using gevent and sqlalchemy in my thrift(RPC) project. I upgraded SQLAlchemy from v0.9.3 to v0.9.4 a few days ago and then found the error.\nFollowing is how I use sqlalchemy and gevent:\n\n* scoped_session(thread-local)\n* use gevent.spawn to handle every request and session.close after finishing handling\n\nThe error is gone when SQLAlchemy is  downgraded to v0.9.3.\n\nI noticed that the version 0.9.4 has \"Key fixes include an enhancement to the mechanics of connection pool recycling to be more efficient \".  Does it have anything to do with the error.\n\n\n```\nFile \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/orm/attributes.py\", line 233, in __get__\n    return self.impl.get(instance_state(instance), dict_)\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/orm/attributes.py\", line 577, in get\n    value = callable_(state, passive)\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/orm/state.py\", line 360, in __call__\n    self.manager.deferred_scalar_loader(self, toload)\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/orm/loading.py\", line 606, in load_scalar_attributes\n    \n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/orm/loading.py\", line 230, in load_on_ident\n    return q.one()\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/orm/query.py\", line 2361, in one\n    raise orm_exc.NoResultFound(\"No row was found for one()\")\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/orm/query.py\", line 2404, in __iter__\n    conn = conn.execution_options(**self._execution_options)\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/orm/query.py\", line 2419, in _execute_and_instances\n    returned by this :class:`.Query`.\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 720, in execute\n    \"\"\"Execute a sql.FunctionElement object.\"\"\"\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/sql/elements.py\", line 317, in _execute_on_connection\n    return connection._execute_clauseelement(self, multiparams, params)\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 817, in _execute_clauseelement\n    self.dispatch.after_execute(self,\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 947, in _execute_context\n    context._fetch_implicit_returning(result)\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 1108, in _handle_dbapi_exception\n    The operations inside the function are all invoked within the\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/util/compat.py\", line 185, in raise_from_cause\n    reraise(type(exception), exception, tb=exc_tb)\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py\", line 940, in _execute_context\n    context.post_insert()\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/sqlalchemy/engine/default.py\", line 435, in do_execute\n    # after the initial set of 'isolation_level', if any, so is\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/pymysql/cursors.py\", line 132, in execute\n    result = self._query(query)\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/pymysql/cursors.py\", line 271, in _query\n    conn.query(q)\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/pymysql/connections.py\", line 726, in query\n    self._affected_rows = self._read_query_result(unbuffered=unbuffered)\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/pymysql/connections.py\", line 861, in _read_query_result\n    result.read()\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/pymysql/connections.py\", line 1064, in read\n    first_packet = self.connection._read_packet()\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/pymysql/connections.py\", line 825, in _read_packet\n    packet = packet_type(self)\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/pymysql/connections.py\", line 242, in __init__\n    self._recv_packet(connection)\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/pymysql/connections.py\", line 248, in _recv_packet\n    packet_header = connection._read_bytes(4)\n  File \"/srv/virtualenvs/zeus2env/local/lib/python2.7/site-packages/pymysql/connections.py\", line 838, in _read_bytes\n    2013, \"Lost connection to MySQL server during query (%r)\" % (e,))\nOperationalError: (OperationalError) (2013, \"Lost connection to MySQL server during query (error(9, 'File descriptor was closed in another greenlet'))\")\n\n\n\n```\n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3043/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/sqlalchemy/issues/3043/timeline","performed_via_github_app":null,"state_reason":"completed"}