<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:21:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[QPID-2994] transactions atomicity violated by &apos;transparent&apos; failover</title>
                <link>https://issues.apache.org/jira/browse/QPID-2994</link>
                <project id="12310520" key="QPID">Qpid</project>
                    <description>&lt;p&gt;The messages published within a batch at the point the connection failsover appear to be replayed outside of any transaction.&lt;/p&gt;

&lt;p&gt;Steps to Reproduce:&lt;br/&gt;
1. start transactional session on failover enabled connection&lt;br/&gt;
2. send batches of messages in transactions&lt;br/&gt;
3. kill the cluster node the client is connected to, to trigger failover mid&lt;br/&gt;
transaction&lt;/p&gt;

&lt;p&gt;This happens due to the lower layer replaying unacked messages upon resuming the connection.&lt;br/&gt;
Message replay should not happen on a transacted session as there is no benefit of doing so.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12495202">QPID-2994</key>
            <summary>transactions atomicity violated by &apos;transparent&apos; failover</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rajith">Rajith Muditha Attapattu</assignee>
                                    <reporter username="rajith">Rajith Muditha Attapattu</reporter>
                        <labels>
                    </labels>
                <created>Tue, 11 Jan 2011 02:57:13 +0000</created>
                <updated>Tue, 14 Mar 2017 20:07:42 +0000</updated>
                            <resolved>Tue, 15 Mar 2011 22:57:22 +0000</resolved>
                                    <version>0.6</version>
                    <version>0.7</version>
                    <version>0.8</version>
                                    <fixVersion>0.10</fixVersion>
                                    <component>JMS AMQP 0-x</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12980092" author="gsim" created="Tue, 11 Jan 2011 13:15:38 +0000"  >&lt;p&gt;We should also ensure that in failover an exception indicating the automatic rollback of the transaction is thrown to that can be caught and used to redo the transaction.&lt;/p&gt;</comment>
                            <comment id="12991728" author="rajith" created="Tue, 8 Feb 2011 00:09:23 +0000"  >&lt;p&gt;The commit made in rev 1057460 uncovered a more deeper issue that violates the atomicity of a transaction that was disrupted by failover.&lt;br/&gt;
The symptom was one or two messages seems to get onto the queue outside of the transaction boundaries.&lt;br/&gt;
Upon closer inspection these were messages that were in the failed transaction. If the application  re-tries the failed transaction it results in duplicates further complicating the issue.&lt;/p&gt;

&lt;p&gt;The underlying root cause is as follows.&lt;br/&gt;
1. When a message-transfer reaches the invoke method in Session.java and if the session-state is detached at that time, the thread waits until the session is OPEN or CLOSED.&lt;/p&gt;

&lt;p&gt;2. If failover completes within the wait period and the session is resumed, thereby being marked OPEN and the message transfer in progress just resumes and reaches the broker.&lt;/p&gt;

&lt;p&gt;3. At this point the session is still not marked transactional (and there is no logic in place to ever issue a txSelect after failover as well) so the message is enqueued.&lt;/p&gt;

&lt;p&gt;4. In the meantime the JMS session used by the application gets to know that failover happens and is marked dirty and an exception is received.&lt;/p&gt;

&lt;p&gt;5. If the application chooses to resume the session (ignoring the exception) then subsequent message transfers will get to the queue on the broker but the session will get closed once it sends a commit (or a rollback) as the broker will complain that the session is not transactional.&lt;/p&gt;

&lt;p&gt;6. If the application chooses to create a new session then it will start sending sub sequent messages within transaction boundaries and work as expected. But will still have that extra one or two messages that sneaked in when the old session was reopned. If the application retired the aborted transaction then it will result in duplicates due to the messages that sneaked in.&lt;/p&gt;

&lt;p&gt;A reasonable solution to this issue is to,&lt;br/&gt;
1) Close a session marked transactional immediately when the session detaches. i.e a transactional session is never resumed and a new session should be created to continue. &lt;/p&gt;

&lt;p&gt;2) We also need to document that clearly.&lt;/p&gt;

&lt;p&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Also during investigation I found a race condition where an application could create a new session (recreating due to an exception or a completely new session in the midst of failover) before the connection is open.&lt;br/&gt;
This results in session attach being sent before the connection negotiation is completed. All though the connect method and the createSession method in Connection.java contends for the same lock, the connect method which acquires it early, will releases the lock when it waits (until the connection achieves OPEN state) and the createSession method waiting on the lock will get it and continue. This actually exposed a bug in the C++ broker. See &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-3033&quot; title=&quot;Bug 674183 - Segmentation fault while processing session.attach&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-3033&quot;&gt;&lt;del&gt;QPID-3033&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
We need to ensure that createSession method is not executed until the connection achieve OPEN state. I will open a separate JIRA for this.&lt;/p&gt;

&lt;p&gt;(*)Another race condition found is that if a session is created (after the connection is setup and is marked OPEN) but before the resume method (in Connection.java) is called, it results in the new session being reattached again. This could result in unnecessary duplication of messages.&lt;br/&gt;
We need to ensure that createSession method does not get executed until the resume method is completed. Again I will open a separate JIRA for this.&lt;/p&gt;</comment>
                            <comment id="12991756" author="rajith" created="Tue, 8 Feb 2011 01:01:11 +0000"  >&lt;p&gt;The patch contains a fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-2994&quot; title=&quot;transactions atomicity violated by &amp;#39;transparent&amp;#39; failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-2994&quot;&gt;&lt;del&gt;QPID-2994&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-3042&quot; title=&quot;Session.attach could be sent before the connection is open.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-3042&quot;&gt;&lt;del&gt;QPID-3042&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-3043&quot; title=&quot;If a new session is created during failover, but before &amp;#39;resume&amp;#39; is completed, the new session gets reattached again.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-3043&quot;&gt;&lt;del&gt;QPID-3043&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;1. For &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-2994&quot; title=&quot;transactions atomicity violated by &amp;#39;transparent&amp;#39; failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-2994&quot;&gt;&lt;del&gt;QPID-2994&lt;/del&gt;&lt;/a&gt; - If a transactional session gets detached the session is now removed and an exception is thrown.&lt;/p&gt;

&lt;p&gt;2. For &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-3042&quot; title=&quot;Session.attach could be sent before the connection is open.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-3042&quot;&gt;&lt;del&gt;QPID-3042&lt;/del&gt;&lt;/a&gt; - The createSession method now waits until the connection state == OPEN before it issues a session attach.&lt;/p&gt;

&lt;p&gt;3. &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-3043&quot; title=&quot;If a new session is created during failover, but before &amp;#39;resume&amp;#39; is completed, the new session gets reattached again.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-3043&quot;&gt;&lt;del&gt;QPID-3043&lt;/del&gt;&lt;/a&gt; - A failover-lock is now used to ensure that session.create does not proceed while the &apos;resume&apos; method is in progress. However we should also consider the possibility of the race condition where sessionCreate is called before session resume is even started. There this fix is incomplete.&lt;/p&gt;</comment>
                            <comment id="12992086" author="rajith" created="Tue, 8 Feb 2011 18:23:19 +0000"  >&lt;p&gt;We do throw an exception indicating that failover has happened and the session is closed.&lt;br/&gt;
However I think we need to explicitly mention that the transaction is rollbacked.&lt;/p&gt;

&lt;p&gt;We also need to document,&lt;br/&gt;
1. Which exceptions will destroy a session&lt;br/&gt;
2. And which exceptions can be handled and continue with the session.&lt;/p&gt;</comment>
                            <comment id="13007257" author="rajith" created="Tue, 15 Mar 2011 22:57:22 +0000"  >&lt;p&gt;Fixed along with related issues - &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-3042&quot; title=&quot;Session.attach could be sent before the connection is open.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-3042&quot;&gt;&lt;del&gt;QPID-3042&lt;/del&gt;&lt;/a&gt; &amp;amp; &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-3043&quot; title=&quot;If a new session is created during failover, but before &amp;#39;resume&amp;#39; is completed, the new session gets reattached again.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-3043&quot;&gt;&lt;del&gt;QPID-3043&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
Tested manually and added a test case to the test harness in testkit.py&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12470535" name="QPID-2994.patch" size="3674" author="rajith" created="Tue, 8 Feb 2011 01:01:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>169653</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 36 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0bofj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>66070</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>