<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:21:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[QPID-3562] the 0-10 client path does not act as expected with asynchronous consumers using a prefetch of 1 on transacted sessions</title>
                <link>https://issues.apache.org/jira/browse/QPID-3562</link>
                <project id="12310520" key="QPID">Qpid</project>
                    <description>&lt;p&gt;the 0-10 client path does not act as expected with asynchronous consumers using a prefetch of 1 on transacted sessions, as the client is able to hold a 2nd message during processing of a slow onMessage handler. This is because completions are sent to ensure credit does not dry up, allowing a large-than-prefetch number of messages to be consume in a given transaction. However, this is done prior to delivery to the client application, which causes the client to get sent a 2nd message by the broker.&lt;/p&gt;

&lt;p&gt;This should isntead occur after delivery has completed (if it is necessary: the client may have committed, which sends accepting completions anyway) to give the expected behaviour.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12529420">QPID-3562</key>
            <summary>the 0-10 client path does not act as expected with asynchronous consumers using a prefetch of 1 on transacted sessions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="robbie">Robbie Gemmell</assignee>
                                    <reporter username="robbie">Robbie Gemmell</reporter>
                        <labels>
                    </labels>
                <created>Sun, 30 Oct 2011 18:36:20 +0000</created>
                <updated>Tue, 14 Mar 2017 20:07:43 +0000</updated>
                            <resolved>Sun, 30 Oct 2011 18:49:00 +0000</resolved>
                                    <version>0.12</version>
                                    <fixVersion>0.13</fixVersion>
                                    <component>JMS AMQP 0-x</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13139703" author="gemmellr" created="Sun, 30 Oct 2011 18:49:00 +0000"  >&lt;p&gt;Completion sending moved to postDeliver, and in addition to previous restrictions only occurs if the transaction wasnt committed (in the asynchronous delivery case).&lt;/p&gt;</comment>
                            <comment id="13151354" author="rajith" created="Wed, 16 Nov 2011 17:32:09 +0000"  >&lt;p&gt;I have the following test case for prefetch=0 &amp;amp; prefetch=1&lt;br/&gt;
I don&apos;t believe it covers all cases. I&apos;d appreciate some feedback on the test.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    /**
     * Test Goal : For prefetch 0, verify that the client does not get any messages unless receive() is called.
     *             For prefetch 1, verify that the client gets only 1 message and not more than that. 
     *             
     * Test Strategy: Create two consumers on the same queue, one with prefetch disabled (zero) and one with prefetch=1.
     *                Note : Created the one with prefetch disabled first.
     *                Send a single message to the queue and verify that the message only goes to the one with prefetch=1.
     *                
     *                Next, send 3 messages
     */
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testPrefetchZeroAndOneWithSyncReceive() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception
    {
        setTestClientSystemProperty(ClientProperties.MAX_PREFETCH_PROP_NAME, &lt;span class=&quot;code-quote&quot;&gt;&quot;0&quot;&lt;/span&gt;);
        Connection con = getConnection();
        con.start();
        Session ssn = con.createSession(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, Session.AUTO_ACKNOWLEDGE);
        Destination destWithZeroCapacity = ssn.createQueue(&lt;span class=&quot;code-quote&quot;&gt;&quot;ADDR:my-queue;{create: always}&quot;&lt;/span&gt;);
        
        MessageProducer prod = ssn.createProducer(destWithZeroCapacity);
        prod.send(ssn.createTextMessage(&lt;span class=&quot;code-quote&quot;&gt;&quot;Msg&quot;&lt;/span&gt;));
        
        MessageConsumer consumerWithZeroPrefetch = ssn.createConsumer(destWithZeroCapacity);
        
        Destination destWithPrefetchEnabled = ssn.createQueue(&lt;span class=&quot;code-quote&quot;&gt;&quot;ADDR:my-queue;{create: always, link:{capacity:1}}&quot;&lt;/span&gt;);
        MessageConsumer consumerWithPretch = ssn.createConsumer(destWithPrefetchEnabled);
        TextMessage msg = (TextMessage)consumerWithPretch.receive(1000);
        assertNotNull(&lt;span class=&quot;code-quote&quot;&gt;&quot;The message should only go to the consumer with prefetch enabled&quot;&lt;/span&gt;,msg);
                
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i=0; i&amp;lt;5;i++) 
        {
           prod.send(ssn.createTextMessage(&lt;span class=&quot;code-quote&quot;&gt;&quot;Msg&quot;&lt;/span&gt; + i));
        }
        
        msg = (TextMessage)consumerWithZeroPrefetch.receive(1000);
        assertNotNull(&lt;span class=&quot;code-quote&quot;&gt;&quot;When receive is called a message should be fetched from the broker&quot;&lt;/span&gt;,msg);
        assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;Consumer with zero prefetch should receive Msg1, &quot;&lt;/span&gt; +
        		&lt;span class=&quot;code-quote&quot;&gt;&quot;as Msg 0 is given to the consumer with prefetch=1&quot;&lt;/span&gt;,msg.getText(),&lt;span class=&quot;code-quote&quot;&gt;&quot;Msg1&quot;&lt;/span&gt;);
        
        &lt;span class=&quot;code-comment&quot;&gt;// Verify that the other 2 messages have not been given to the consumer with zero prefetch.
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i=0; i&amp;lt;2; i++)
        {
            &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; j = i + i*1; &lt;span class=&quot;code-comment&quot;&gt;// done to get Msg0 &amp;amp; Msg2, skipping Msg1.
&lt;/span&gt;            msg = (TextMessage)consumerWithPretch.receive(1000);
            assertNotNull(&lt;span class=&quot;code-quote&quot;&gt;&quot;The consumer with prefetch enabled should receive the message&quot;&lt;/span&gt;,msg);
            assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;The consumer with prefetch enabled should receive Msg&quot;&lt;/span&gt; + j,msg.getText(),&lt;span class=&quot;code-quote&quot;&gt;&quot;Msg&quot;&lt;/span&gt;+j);
        }
        
        &lt;span class=&quot;code-comment&quot;&gt;// Verify that the prefetch=1 consumer has not accumulated more messages than it should due to errors.
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// Note Msg3 should be in &lt;span class=&quot;code-quote&quot;&gt;&quot;consumer with prefetch=1&quot;&lt;/span&gt; (in it&apos;s prefetch buffer), but Msg4 should not be.
&lt;/span&gt;        msg = (TextMessage)consumerWithZeroPrefetch.receive(1000);
        assertNotNull(&lt;span class=&quot;code-quote&quot;&gt;&quot;When receive is called a message should be fetched from the broker&quot;&lt;/span&gt;,msg);
        assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;Consumer with zero prefetch should receive Msg4 &quot;&lt;/span&gt;,msg.getText(),&lt;span class=&quot;code-quote&quot;&gt;&quot;Msg4&quot;&lt;/span&gt;);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13152359" author="gemmellr" created="Thu, 17 Nov 2011 21:42:18 +0000"  >&lt;p&gt;I would probably have chosen to test prefetch=0 and preftech=1 in isolation rather than in the same test, but it seems reasonable enough (I would consume &apos;Msg3&apos; for completeness though). The Javadoc mentions 3 more messages but the test sends 5 more. &lt;/p&gt;

&lt;p&gt;I dont think it covers this JIRA at all though, given the use of synchronous consumers and the different handling of prefetch from onMessage that goes along with that being what prompted the JIRA to be raised.&lt;/p&gt;</comment>
                            <comment id="13152382" author="rajith" created="Thu, 17 Nov 2011 21:59:41 +0000"  >&lt;p&gt;Thanks for the feedback. I was trying to get some feel for the test cases. I will fix the discrepancy in the java doc.&lt;/p&gt;

&lt;p&gt;Sorry should have mentioned that this was not really to cover this specific JIRA but rather as a starting point for a general test case for prefetch=0 and prefetch=1. In hindsight I should have opened a separate JIRA for prefetch=1 and prefetch=0 and put it there (was a bit lazy and used this).&lt;/p&gt;

&lt;p&gt;Also as correctly pointed out by you we need tests for synchronous and asynchronous consumers and also test the various ACK modes including transactions, as the behaviour does change for those different combinations. I am hoping to get a base test case and then see if I could use that with the different combinations. Ex client with sync and client-ack with async etc..&lt;/p&gt;

&lt;p&gt;And as you said, perhaps it&apos;s better to have separate tests for prefetch=0 and prefetch=1. I started with prefetch=0, but realized that I needed prefetch=1 to get it going &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Thanks again for your feedback/comments, as always highly appreciated.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>215280</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 1 week, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0bkb3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>65402</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>