<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:22:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[QPID-3911] Consumer.close() and session.rollback() deadlocks </title>
                <link>https://issues.apache.org/jira/browse/QPID-3911</link>
                <project id="12310520" key="QPID">Qpid</project>
                    <description>&lt;p&gt;Found one Java-level deadlock:&lt;br/&gt;
=============================&lt;br/&gt;
&quot;Dispatcher-Channel-0&quot;:&lt;br/&gt;
   waiting to lock monitor 0x0000000001e65ec8 (object &lt;br/&gt;
0x00000007c180bd58, a java.lang.Object),&lt;br/&gt;
   which is held by &quot;main&quot;&lt;br/&gt;
&quot;main&quot;:&lt;br/&gt;
   waiting to lock monitor 0x0000000001cffbc8 (object &lt;br/&gt;
0x00000007c2e10c08, a java.lang.Object),&lt;br/&gt;
   which is held by &quot;Dispatcher-Channel-0&quot;&lt;/p&gt;

&lt;p&gt;Java stack information for the threads listed above:&lt;br/&gt;
===================================================&lt;br/&gt;
&quot;Dispatcher-Channel-0&quot;:&lt;br/&gt;
     at &lt;br/&gt;
org.apache.qpid.client.AMQConnection.exceptionReceived(AMQConnection.java:1255)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting to lock &amp;lt;0x00000007c180bd58&amp;gt; (a java.lang.Object)&lt;br/&gt;
     at &lt;br/&gt;
org.apache.qpid.client.AMQSession_0_10.setCurrentException(AMQSession_0_10.java:1057)&lt;br/&gt;
     at &lt;br/&gt;
org.apache.qpid.client.AMQSession_0_10.sync(AMQSession_0_10.java:1034)&lt;br/&gt;
     at &lt;br/&gt;
org.apache.qpid.client.AMQSession_0_10.sendSuspendChannel(AMQSession_0_10.java:851)&lt;br/&gt;
     at &lt;br/&gt;
org.apache.qpid.client.AMQSession.suspendChannel(AMQSession.java:3075)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00000007c2c3d330&amp;gt; (a java.lang.Object)&lt;br/&gt;
     at org.apache.qpid.client.AMQSession.rollback(AMQSession.java:1854)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00000007c2c3d330&amp;gt; (a java.lang.Object)&lt;br/&gt;
     at &lt;br/&gt;
QpidConsumerCloseRollbackDeadlock$QpidMqHandler.onMessage(QpidConsumerCloseRollbackDeadlock.java:208)&lt;br/&gt;
     at &lt;br/&gt;
org.apache.qpid.client.BasicMessageConsumer.notifyMessage(BasicMessageConsumer.java:745)&lt;br/&gt;
     at &lt;br/&gt;
org.apache.qpid.client.BasicMessageConsumer_0_10.notifyMessage(BasicMessageConsumer_0_10.java:141)&lt;br/&gt;
     at &lt;br/&gt;
org.apache.qpid.client.BasicMessageConsumer.notifyMessage(BasicMessageConsumer.java:719)&lt;br/&gt;
     at &lt;br/&gt;
org.apache.qpid.client.BasicMessageConsumer_0_10.notifyMessage(BasicMessageConsumer_0_10.java:186)&lt;br/&gt;
     at &lt;br/&gt;
org.apache.qpid.client.BasicMessageConsumer_0_10.notifyMessage(BasicMessageConsumer_0_10.java:54)&lt;br/&gt;
     at &lt;br/&gt;
org.apache.qpid.client.AMQSession$Dispatcher.notifyConsumer(AMQSession.java:3467)&lt;br/&gt;
     at &lt;br/&gt;
org.apache.qpid.client.AMQSession$Dispatcher.dispatchMessage(AMQSession.java:3406)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00000007c2c3d350&amp;gt; (a java.lang.Object)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00000007c2e10c08&amp;gt; (a java.lang.Object)&lt;br/&gt;
     at &lt;br/&gt;
org.apache.qpid.client.AMQSession$Dispatcher.access$1000(AMQSession.java:3180)&lt;br/&gt;
     at org.apache.qpid.client.AMQSession.dispatch(AMQSession.java:3173)&lt;br/&gt;
     at &lt;br/&gt;
org.apache.qpid.client.message.UnprocessedMessage.dispatch(UnprocessedMessage.java:54)&lt;br/&gt;
     at &lt;br/&gt;
org.apache.qpid.client.AMQSession$Dispatcher.run(AMQSession.java:3329)&lt;br/&gt;
     at java.lang.Thread.run(Thread.java:636)&lt;br/&gt;
&quot;main&quot;:&lt;br/&gt;
     at &lt;br/&gt;
org.apache.qpid.client.AMQSession$Dispatcher.rejectPending(AMQSession.java:3211)&lt;/li&gt;
	&lt;li&gt;waiting to lock &amp;lt;0x00000007c2e10c08&amp;gt; (a java.lang.Object)&lt;br/&gt;
     at &lt;br/&gt;
org.apache.qpid.client.AMQSession.confirmConsumerCancelled(AMQSession.java:903)&lt;br/&gt;
     at &lt;br/&gt;
org.apache.qpid.client.BasicMessageConsumer_0_10.sendCancel(BasicMessageConsumer_0_10.java:170)&lt;br/&gt;
     at &lt;br/&gt;
org.apache.qpid.client.BasicMessageConsumer.close(BasicMessageConsumer.java:593)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00000007c180bd58&amp;gt; (a java.lang.Object)&lt;br/&gt;
     at &lt;br/&gt;
org.apache.qpid.client.BasicMessageConsumer.close(BasicMessageConsumer.java:555)&lt;br/&gt;
     at &lt;br/&gt;
QpidConsumerCloseRollbackDeadlock.main(QpidConsumerCloseRollbackDeadlock.java:77)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Found 1 deadlock.&lt;/p&gt;</description>
                <environment>&lt;p&gt;0.16(beta/RC1) Java Client and Java Broker&lt;/p&gt;</environment>
        <key id="12547707">QPID-3911</key>
            <summary>Consumer.close() and session.rollback() deadlocks </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="robbie">Robbie Gemmell</assignee>
                                    <reporter username="lefthandmagic">Praveen Murugesan</reporter>
                        <labels>
                            <label>java</label>
                            <label>qpidclient</label>
                    </labels>
                <created>Thu, 22 Mar 2012 22:58:22 +0000</created>
                <updated>Tue, 14 Mar 2017 20:07:30 +0000</updated>
                            <resolved>Fri, 6 Apr 2012 10:59:20 +0000</resolved>
                                    <version>0.15</version>
                                    <fixVersion>0.16</fixVersion>
                                    <component>JMS AMQP 0-x</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13236148" author="lefthandmagic" created="Thu, 22 Mar 2012 22:59:11 +0000"  >&lt;p&gt;Test to simulate the scenario&lt;/p&gt;</comment>
                            <comment id="13236150" author="lefthandmagic" created="Thu, 22 Mar 2012 22:59:31 +0000"  >&lt;p&gt;Deadlock stack traces.&lt;/p&gt;</comment>
                            <comment id="13240559" author="alex.rufous" created="Wed, 28 Mar 2012 17:16:52 +0000"  >&lt;p&gt;Invoking of MessageConsumer#close() and Session#rollback from a consumer listener results in a deadlock on 0-10 path and a timeout exception on 0-9 path&lt;/p&gt;

&lt;p&gt;On 0-10  path the deadlock is caused by an ExecutionException sent from the broker in response to message.stop, message.flow commands (sent from Session#rollback for suspension of the channel) when message.stop or message.flow command is delivered to broker after message.cancel command which is sent as part of MessageConsumer#close(). Command message.cancel results in a deletion of a subscription on a broker side and for the following message.stop or message.flow commands the subscription cannot be found and ExceutionException is reported:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.qpid.AMQException: ch=0 id=2 ExecutionException(errorCode=NOT_FOUND, commandId=20, classCode=4, commandCode=12, fieldIndex=0, description=not-found: Unknown destination 1 session=guest@QPID.89a222e3-e3ca-4aee-8e4f-a78468f4fed1 (qpid/broker/SemanticState.cpp:569), errorInfo={}) [error code 404: not found]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The ExecutionException is sent from both Java and C++ Brokers&lt;/p&gt;

&lt;p&gt;On receiving an ExecutionException connection tries to acquire the FailoverMutex in order to close itself in AMQConnection#exceptionReceived method.&lt;/p&gt;

&lt;p&gt;However, the FailoverMutex is acquired in MessageConsumer#close() which is waiting for a release of a session dispatcher lock. The last is hold in a dispatcher thread. The closing of a connection occurs in a dispatcher thread and this results in a deadlock.&lt;/p&gt;</comment>
                            <comment id="13240560" author="alex.rufous" created="Wed, 28 Mar 2012 17:18:46 +0000"  >&lt;p&gt;I attached a patch fixing the issue&lt;/p&gt;</comment>
                            <comment id="13240634" author="lefthandmagic" created="Wed, 28 Mar 2012 19:01:10 +0000"  >&lt;p&gt;Thanks a lot Alex for getting to this real quick &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;</comment>
                            <comment id="13240716" author="jiraposter@reviews.apache.org" created="Wed, 28 Mar 2012 20:45:28 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/4546/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/4546/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Review request for qpid, Robbie Gemmell, rajith attapattu, Keith Wall, and Rob Godfrey.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Invoking of MessageConsumer#close() and Session#rollback from a consumer listener results in a deadlock on 0-10 path and a timeout exception on 0-9 path&lt;/p&gt;

&lt;p&gt;On 0-10 path the deadlock is caused by an ExecutionException sent from the broker in response to message.stop, message.flow commands (sent from Session#rollback for the suspension of the channel) when message.stop or message.flow command is delivered to the broker after message.cancel command which is sent as part of MessageConsumer#close(). Command message.cancel results in a deletion of a subscription on the broker side and for the following message.stop or message.flow command the subscription cannot be found and ExceutionException is reported:&lt;/p&gt;

&lt;p&gt;org.apache.qpid.AMQException: ch=0 id=2 ExecutionException(errorCode=NOT_FOUND, commandId=20, classCode=4, commandCode=12, fieldIndex=0, description=not-found: Unknown destination 1 session=guest@QPID.89a222e3-e3ca-4aee-8e4f-a78468f4fed1 (qpid/broker/SemanticState.cpp:569), errorInfo={}) &lt;span class=&quot;error&quot;&gt;&amp;#91;error code 404: not found&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;The ExecutionException is sent from both Java and C++ Brokers&lt;/p&gt;

&lt;p&gt;On receiving an ExecutionException connection tries to acquire the FailoverMutex in order to close itself in AMQConnection#exceptionReceived method.&lt;/p&gt;

&lt;p&gt;However, the FailoverMutex is acquired in MessageConsumer#close() which is waiting for a release of a session dispatcher lock. The last is hold in a dispatcher thread. The closing of a connection occurs in a dispatcher thread and this results in a deadlock.&lt;/p&gt;


&lt;p&gt;The suggested patch introduces the following changes:&lt;br/&gt;
 Adds synchronization on AMSession#_messageDeliveryLock into MessageConsumer#close() in order to block until message listener in progress has completed(as required in JMS javadoc for MessageConsumer#close())&lt;br/&gt;
 Changes the session dispatcher to stop the message delivery into consumer local message queue if the consumer in the process of closing. This eliminates the need to stop the dispatcher on rejecting pending messages for closing consumer.&lt;br/&gt;
 Removes the synchronization on a session dispatcher lock from AMQSession.Dispatcher#rejectPending and code to stop the dispatcher as we are synchronizing on a deliveryLock now and incoming messages are not dispatched into closing consumer anymore.&lt;br/&gt;
 Adds a system test to reproduce the deadlock&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-3911&quot; title=&quot;Consumer.close() and session.rollback() deadlocks &quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-3911&quot;&gt;&lt;del&gt;QPID-3911&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-3911&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/QPID-3911&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  /trunk/qpid/java/client/src/main/java/org/apache/qpid/client/AMQSession.java 1306567 &lt;br/&gt;
  /trunk/qpid/java/client/src/main/java/org/apache/qpid/client/BasicMessageConsumer.java 1306567 &lt;br/&gt;
  /trunk/qpid/java/systests/src/main/java/org/apache/qpid/test/unit/close/MessageConsumerCloseTest.java PRE-CREATION &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/4546/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/4546/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Oleksandr&lt;/p&gt;
</comment>
                            <comment id="13248233" author="gemmellr" created="Fri, 6 Apr 2012 10:59:20 +0000"  >&lt;p&gt;Rob and I both looked over the patch separately and think it seems ok, and it passes the tests fine locally. I have applied it to trunk and we will to subject it to CI over the weekend to give it fuller workout before asking for inclusion in 0.16.&lt;/p&gt;</comment>
                            <comment id="13250758" author="justi9" created="Tue, 10 Apr 2012 15:41:51 +0000"  >&lt;p&gt;Reviewed by Robbie and Rob, as indicated in the comments above.  Approved for 0.16.&lt;/p&gt;</comment>
                            <comment id="13251428" author="gemmellr" created="Wed, 11 Apr 2012 09:15:11 +0000"  >&lt;p&gt;Changes merged to the 0.16 branch.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12519536" name="DeadLockStackTraces.txt" size="3185" author="lefthandmagic" created="Thu, 22 Mar 2012 22:59:31 +0000"/>
                            <attachment id="12520292" name="QPID-3911-Fix-deadlock-on-concurrent-invocation-of-MessageConsumer-close-and-Session-rollback.patch" size="6806" author="orudyy" created="Wed, 28 Mar 2012 17:18:07 +0000"/>
                            <attachment id="12519535" name="QpidConsumerCloseRollbackDeadlock.java" size="5066" author="lefthandmagic" created="Thu, 22 Mar 2012 22:59:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>232804</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 32 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0bggv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>64780</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>