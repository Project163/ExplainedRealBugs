<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:21:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[QPID-2418]  Existing durable subscription with selector is not unsubscribed during change to new subscription</title>
                <link>https://issues.apache.org/jira/browse/QPID-2418</link>
                <project id="12310520" key="QPID">Qpid</project>
                    <description>&lt;p&gt;AMQSession.createDurableSubscriber(topic, name, messageSelector, noLocal) does not unsubscribe existing durable subscriptions. Whilst it does check for existing durable subscriptions in use by the client with the same name, it instead simply closes the subscriptions then creates a new one. As a result of not unsubscribing, the queue backing the subscription is not deleted before being used by the updated subscription as it should be (and as happens in the 0_8 and 0_10 subclasses when using durable subscriptions without selectors).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12457306">QPID-2418</key>
            <summary> Existing durable subscription with selector is not unsubscribed during change to new subscription</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="robbie">Robbie Gemmell</assignee>
                                    <reporter username="robbie">Robbie Gemmell</reporter>
                        <labels>
                    </labels>
                <created>Wed, 24 Feb 2010 16:39:50 +0000</created>
                <updated>Tue, 14 Mar 2017 20:07:29 +0000</updated>
                            <resolved>Thu, 2 Dec 2010 12:58:09 +0000</resolved>
                                    <version>M4</version>
                    <version>0.5</version>
                    <version>0.6</version>
                                    <fixVersion>0.7</fixVersion>
                                    <component>JMS AMQP 0-x</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12849709" author="andrew.kennedy" created="Thu, 25 Mar 2010 14:23:28 +0000"  >&lt;p&gt;Unsubscribe existing durable subscriptions on create when they change&lt;/p&gt;</comment>
                            <comment id="12850103" author="gemmellr" created="Fri, 26 Mar 2010 11:55:01 +0000"  >&lt;p&gt;The approach taken in the patch looks good, but I spotted some issues wih it that need addressed, and an opportunity to get rid of a lot of &lt;span class=&quot;error&quot;&gt;&amp;#91;pre-existing&amp;#93;&lt;/span&gt; duplication:&lt;/p&gt;


&lt;p&gt;The unsubscribe method synchronises around the _subscriptions map, but nothing else appears to. The content in the various maps within the block are accessed/updated from a few other locations (in AMQsession, and its 0_8 and 0_10 subclasses), and the content in multiple maps is generally directly related (eg subscriptions and reverse subscriptions maps, and the topics and selectors maps) so there could still be threading issues despite the synchorized block in unsubscribe. The various other uses of the maps should also be protected to ensure the associated information in the multiple maps they access/update is properly matched.&lt;/p&gt;

&lt;p&gt;When a new durable subscription is made without a selector, it should also check if any known existing/previous subscription using the same name DID have a selector, and if so should both unsubscribe the subscription name &lt;em&gt;and&lt;/em&gt; remove the existing selector from the selectors map.&lt;/p&gt;

&lt;p&gt;In AMQSession.createDurableSubscriber(Topic topic, String name, String messageSelector, boolean noLocal), when removing an entry from the reverseSubscriptionsMap the subscription is given as the key. It should actually be the parent Consumer which is provided as the key. The same applies in the unsubscribe method (existing bug).&lt;/p&gt;

&lt;p&gt;When adding the selector to the subscriptionSelectors map the value is not permitted to be null, but the selector value is not checked before adding it. The value can quite easily be null here, as although it is retrieved from the consumer object it is the same String that is passed into the create method, meaning it can be provided null and is actually set to null in the method itself if the selector string given &apos;isBlank&apos;.&lt;/p&gt;

&lt;p&gt;A small update was made in the AMQSession_0_8 and 0_10 subclasses. Examining the almost-identical methods more closesly seems to show that although they look to do slightly different things and call differnet methods to achieve their result, they do infact ultimately end up doing exactly the same thing. These methods (and those they call) should be rationalised and the createDurableSubscriber(Topic, String) method implementation moved into the abstract superclass with the comparible selector method variant which already resides there (those 2 methods can then potentially be reduced to a common implementation too).&lt;/p&gt;</comment>
                            <comment id="12851350" author="andrew.kennedy" created="Tue, 30 Mar 2010 10:56:19 +0000"  >&lt;p&gt;Updated patches for branch and trunk&lt;/p&gt;</comment>
                            <comment id="12851830" author="gemmellr" created="Wed, 31 Mar 2010 11:59:58 +0000"  >&lt;p&gt;On line 1086 (after patching) this code segment needs updated: &lt;br/&gt;
           if (_subscriptionTopics.containsKey(name) &amp;amp;&amp;amp; _subscriptionSelectors.containsKey(name))&lt;br/&gt;
            {&lt;br/&gt;
                if (!_subscriptionTopics.get(name).equals(topic) || !_subscriptionSelectors.get(name).equals(messageSelector))&lt;/p&gt;
                {
                    _logger.info(&quot;Unsubscribing from topic &quot; + topic + &quot; with subscription exchange &quot; + name
                                    + &quot; and selector &quot; + messageSelector);
                    unsubscribe(name);
                }
&lt;p&gt;            }&lt;/p&gt;

&lt;p&gt;If the subscription name has been seen before but used without a selector, then in the outer if statement the first test will success but the second will fail, causing the inner if statement to detect subscription change not to be evaluated. However, if the new subscription with reused name happens to be adding a selector then this should be classified as a selector change (from no selector) and cause unsubscription before proceeding.&lt;/p&gt;

&lt;p&gt;Also, there is possibility of deadlock when creation of a new durable subscriber occurs with the same subscription name as an existing open subscriber, which will cause unsubscribe+closure of the old subscriber. The create method will hold the new lock added, but closing the subscription will contact the broker, which will reply and then a different thread will execute the returned BasicCancelOK method and try to aquire the lock in deregisterConsumer() in order to complete the closure, causing the first thread executing the close to timeout and throw an exception. Looking at the map usages it seems there is actually no need to acquire the same lock in deregisterConsumer(), only a need to govern access to the subscriptions and reverseSubscriptionMaps, which could be achieved using a second lock that doesnt encompass the subscriber.close() operation.&lt;/p&gt;</comment>
                            <comment id="12851997" author="rajith" created="Wed, 31 Mar 2010 17:57:00 +0000"  >&lt;p&gt;When investigating the test failure for &quot;testResubscribeWithChangedSelector&quot; in the DurableSubscriptionTest, I was a bit shocked to see the amount of code duplication.&lt;br/&gt;
This may have been due to a merge, but we definitely need to fix this. So thx for taking care of this.&lt;/p&gt;

&lt;p&gt;I haven&apos;t had chance to have a closer look at the patches, but please make sure tests pass against both the C++ and Java Broker before committing it.&lt;/p&gt;

&lt;p&gt;Also the change made in rev 929095 to the DurableSubscriptionTest.java (method testResubscribeWithChangedSelector) is somehow passing for the Java broker.&lt;br/&gt;
Bcos we have the bug mentioned in this bug, it should be failing in both brokers.&lt;br/&gt;
I am not so happy about checking in the change to the test case before a fix is committed as this has broken our automated builds.&lt;/p&gt;

&lt;p&gt;Perhaps the Java broker is creating a new queue as the arguments list is different (the selector being different) ?&lt;br/&gt;
Isn&apos;t that a bug? Perhaps worthwhile investigating this.&lt;/p&gt;</comment>
                            <comment id="12852032" author="gemmellr" created="Wed, 31 Mar 2010 18:36:00 +0000"  >&lt;p&gt;The changes made to DurableSubscriptionTest were not intended to yet expose this bug any more than it was, and were deliberately kept short so that they wouldnt (the comment is innacurate youll note, as it isnt doing what it was originally and I forgot to update that). The new test added in DurableSubscriberTest that absolutely would expose it was excluded until it is fixed so that automated builds wouldnt be been broken. What I didnt do was run the test using the C++ broker as I didnt think I was changing anything of any particular note, but I failed to consider that it could behave slightly differently due to use of client side selectors rather than the server side selectors used by the Java broker. The broker doenst create a new queue, but it does change the filters used to select messages meaning that messges never get onto the queue which will on the C++ broker, which I imagine is where the test now fails. I&apos;ll take that into account when updating it.&lt;/p&gt;</comment>
                            <comment id="12852046" author="rajith" created="Wed, 31 Mar 2010 18:54:37 +0000"  >&lt;p&gt;Interesting, the queue declare with the new selector merely updates the the selector on the queue?&lt;br/&gt;
The AMQP spec doesn&apos;t really define the behaviour if a queue declare is sent with the same name but different args (in this case the selector).&lt;br/&gt;
So I wouldn&apos;t argue that the Java broker is wrong. The c++ client merely ignores the queue declare.&lt;br/&gt;
IMO I think both brokers are wrong as this can lead to subtle errors that can go undetected -  but thats separate topic all together.&lt;/p&gt;

&lt;p&gt;So on the C++ side, the queue is not deleted due to the java client bug. &lt;br/&gt;
So the message is there and gets sent to the client who now has a new selector (with 0-10 client side selectors) which matches and the message is delivered.&lt;/p&gt;

&lt;p&gt;Anyways once we fix the Java client to issue a queue this should be taken care of.&lt;br/&gt;
Always a good idea to run the default java and c++ profiles before an update.&lt;/p&gt;</comment>
                            <comment id="12852389" author="andrew.kennedy" created="Thu, 1 Apr 2010 13:48:15 +0000"  >&lt;p&gt;Revised patches. These do &lt;b&gt;not&lt;/b&gt; fix this issue completely, since the information stored regarding subscriptions on the client is per-session, and should really be per-connection for behaviour to be consistent. In order not to introduce such inconsistent behaviour, I have changed the code to throw a JMS IllegalStateException on any attempt to re-create a subscription (with the same paramaters) that already exists on the session, and unsubscribe if the re-created subscription is a change to an existing open subscription on the session, otherwise behaviour is unchanged. The code adds locking of the subscription information and gets rid of duplicated code across protocol  versions, but a complete fix for this issue will require more extensive changes.&lt;/p&gt;</comment>
                            <comment id="12852747" author="gemmellr" created="Fri, 2 Apr 2010 07:56:45 +0000"  >&lt;p&gt;Applied patch to the branch only.&lt;/p&gt;

&lt;p&gt;Trunk patch still needs to be reviewed and applied.&lt;/p&gt;</comment>
                            <comment id="12852805" author="rajith" created="Fri, 2 Apr 2010 13:05:25 +0000"  >&lt;p&gt;Robbie,&lt;/p&gt;

&lt;p&gt;When are you planning to apply the trunk patch?&lt;/p&gt;

&lt;p&gt;Rajith&lt;/p&gt;
</comment>
                            <comment id="12852820" author="gemmellr" created="Fri, 2 Apr 2010 13:55:43 +0000"  >&lt;p&gt;At some point next week.&lt;/p&gt;</comment>
                            <comment id="12895380" author="rajith" created="Wed, 4 Aug 2010 19:34:56 +0000"  >&lt;p&gt;Robbie,&lt;/p&gt;

&lt;p&gt;I believe you put this on hold based on a request from me.&lt;br/&gt;
Sorry for not following up with you on this.&lt;/p&gt;

&lt;p&gt;Would you like to go ahead and commit this patch now?&lt;/p&gt;

&lt;p&gt;Regards,&lt;/p&gt;

&lt;p&gt;Rajith&lt;/p&gt;</comment>
                            <comment id="12895645" author="gemmellr" created="Thu, 5 Aug 2010 10:55:44 +0000"  >&lt;p&gt;The patch has definitely rotted a bit and needs updating, plus i think the tests still need updated to account for the difference in queue behaviour between brokers when selectors are used (and also, the 0-10 java client not currently sending the server side selector argument to the Java broker too I think ), but Andrew or myself will get to this some time soon.&lt;/p&gt;

&lt;p&gt;Robbie.&lt;/p&gt;</comment>
                            <comment id="12896409" author="gemmellr" created="Sun, 8 Aug 2010 21:11:38 +0000"  >&lt;p&gt;Adding an updated version of the original patch, named &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-2418&quot; title=&quot; Existing durable subscription with selector is not unsubscribed during change to new subscription&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-2418&quot;&gt;&lt;del&gt;QPID-2418&lt;/del&gt;&lt;/a&gt;-trunk_new.patch&lt;/p&gt;

&lt;p&gt;The only changes made were to update import statements and add any modifications required to address code updates since the original patch was created, in order that it will apply and compile. Further modifications are still required to address testing issues with the C++ and 0-10 Java profiles.&lt;/p&gt;</comment>
                            <comment id="12902695" author="gemmellr" created="Wed, 25 Aug 2010 23:07:18 +0000"  >&lt;p&gt;Adding a further updated version of the patch, &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-2418&quot; title=&quot; Existing durable subscription with selector is not unsubscribed during change to new subscription&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-2418&quot;&gt;&lt;del&gt;QPID-2418&lt;/del&gt;&lt;/a&gt;-trunk_new2.patch&lt;/p&gt;

&lt;p&gt;These additional updates allow the new/updated tests to pass when run using either the C++ broker profiles (with the tests removed from the relevant excludes file), or the Java 0-8/0-9 broker profiles. The Java 0-10 profiles still fail some of the tests and require further investigation.&lt;/p&gt;</comment>
                            <comment id="12903883" author="gemmellr" created="Sat, 28 Aug 2010 20:36:40 +0000"  >&lt;p&gt;Adding a further updated version of the patch, &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-2418&quot; title=&quot; Existing durable subscription with selector is not unsubscribed during change to new subscription&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-2418&quot;&gt;&lt;del&gt;QPID-2418&lt;/del&gt;&lt;/a&gt;-trunk_new3.patch&lt;/p&gt;

&lt;p&gt;Streamlines some of the previous additions and fixes one of the test failures on the Java 0-10 profiles, which seemed to relate to the asynchronous batched acks performed by the 0-10 client in AUTO_ACK mode as it appeared that the messages hadnt been acked when the queue count was checked after consumption; switching to a transacted session alleviated the issue. &lt;/p&gt;

&lt;p&gt;There is 1 remaining failure on the Java 0-10 profiles still requiring investigation (DurableSubscriptionTest#testResubscribeWithChangedSelector, where it seems a message is received which should not be).&lt;/p&gt;</comment>
                            <comment id="12906365" author="gemmellr" created="Sun, 5 Sep 2010 18:57:09 +0000"  >&lt;p&gt;Attaching &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-2418&quot; title=&quot; Existing durable subscription with selector is not unsubscribed during change to new subscription&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-2418&quot;&gt;&lt;del&gt;QPID-2418&lt;/del&gt;&lt;/a&gt;-trunk_robbies_additions.patch, that when paired with the &apos;original&apos; &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-2418&quot; title=&quot; Existing durable subscription with selector is not unsubscribed during change to new subscription&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-2418&quot;&gt;&lt;del&gt;QPID-2418&lt;/del&gt;&lt;/a&gt;-trunk_new.patch enables all the tests to pass. &lt;/p&gt;

&lt;p&gt;(This was done to allow properly attributing the changes and to keep the updates separate to ease review for anyone else, as I have already reviewed the significant original patch)&lt;/p&gt;</comment>
                            <comment id="12906366" author="gemmellr" created="Sun, 5 Sep 2010 19:00:54 +0000"  >&lt;p&gt;Original patch updated (&lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-2418&quot; title=&quot; Existing durable subscription with selector is not unsubscribed during change to new subscription&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-2418&quot;&gt;&lt;del&gt;QPID-2418&lt;/del&gt;&lt;/a&gt;-trunk_new.patch) and applied to trunk, and modifications added to enable the tests to pass on all profiles.&lt;/p&gt;</comment>
                            <comment id="12911080" author="gemmellr" created="Sat, 18 Sep 2010 20:17:46 +0000"  >&lt;p&gt;As per Andrews earlier comments, the updates do not fully resolve the issue when using 0-8/0-9/0-9-1 clients as the information on previous subscribers is only held per-session, and regardless of this it is not possible with these protocol versions to determine when connecting whether any existing server side selector (if any) matches the new one (if any) as the arguments can not be queried. It is only possible to tell from the queue bindings whether the Topic in use differs differs.&lt;/p&gt;

&lt;p&gt;The updates I made to augment the original patch do allow the 0-10 client to determine that the selector is changing even without knowledge of any prior subscribers on the session and so should fully resolve the issue. This was achieved by always sending the selector argument but giving it an empty value if no selector is in use (the broker interprets the empty argument as lack of a selector just as it would if the argument was not present), as this allows querying the broker upon (re)connection whether the selector argument matches any existing argument. Additionally, the client side selectors in the 0-10 client would already protect from reciept of messages which do not match the selector in use at any given point.&lt;/p&gt;</comment>
                            <comment id="12966098" author="marnie" created="Thu, 2 Dec 2010 12:58:09 +0000"  >&lt;p&gt;Patches reviewed/applied by RGe.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12440520" name="0001-QPID-2418-branch.patch" size="51875" author="andrew.kennedy" created="Thu, 1 Apr 2010 15:49:03 +0000"/>
                            <attachment id="12440522" name="0001-QPID-2418-trunk.patch" size="53871" author="andrew.kennedy" created="Thu, 1 Apr 2010 16:06:09 +0000"/>
                            <attachment id="12451535" name="QPID-2418-trunk_new.patch" size="51332" author="robbie" created="Sun, 8 Aug 2010 21:11:38 +0000"/>
                            <attachment id="12453904" name="QPID-2418-trunk_robbies_additions.patch" size="21206" author="robbie" created="Sun, 5 Sep 2010 18:57:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>169153</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 51 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0bptr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>66296</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>