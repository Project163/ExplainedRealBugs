<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:20:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[QPID-1871] During Rollback Client Rejects Message after sending TxRollback</title>
                <link>https://issues.apache.org/jira/browse/QPID-1871</link>
                <project id="12310520" key="QPID">Qpid</project>
                    <description>&lt;p&gt;Summary:&lt;br/&gt;
See &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-1864&quot; title=&quot;java 0-10 client sometimes releases messages in non queue order on rollback&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-1864&quot;&gt;&lt;del&gt;QPID-1864&lt;/del&gt;&lt;/a&gt; for annotated log output.&lt;/p&gt;

&lt;p&gt;The log output is from a run with the Java broker, but highlights that the client dispatcher thread is not synchronized with the main thread during rollback.&lt;br/&gt;
As a result the main thread sends the TxRollback before the Dispatcher has sent its Reject message. This results, on the java broker, in the unrejected message being redelivered, which may be out of order depending on what other messages have been released on the message queue.&lt;/p&gt;

&lt;p&gt;If we are to continue to rely on the dispatcher thread rejecting/releasing the message it is currently processing (i.e. the message that is neither in the _queue preDispatchQueue nor the _synchronousQueue for receiver delivery) then we will need to synchronize with the main thread&apos;s rollback/recover calls so that the dispatcher can finish processing its message before the rollback/recover completes.&lt;/p&gt;

&lt;p&gt;The message that the Dispatcher thread has can be seen in AMQSession L:2866:dispatchMessage(). &lt;br/&gt;
On Rollback we stop the dispatcher (L2763) which can result in the dispatcher thread stopping on L2877 and holding on the the message it is in the middle of delivery. More likely during recover the dispatcher will block on the lock L2870.&lt;/p&gt;

&lt;p&gt;When the dispatcher is restarted (L2792) it is then free to reject its message. However, the thread that restarted the dispatcher&apos;s next call is to send the rollback command(L1553) Which is where the race condition occurs.&lt;/p&gt;

&lt;p&gt;Potential Fix:&lt;br/&gt;
Message Rejection should be performed BEFORE we stop the dispatcher.&lt;br/&gt;
On L:2825 we remove the message from the _queue (preDispatchQueue) and then potentailly sit on the message L:2877 when we get stopped.&lt;/p&gt;

&lt;p&gt;If the reject call in L:2888 was before the wait then we could reject the message rather than sit on it.&lt;/p&gt;

&lt;p&gt;Note: Now that I look at this a bit more the rollback (L2754) code looks to be over synchronized. I&apos;m not sure the dispatcher will actually ever stop on the wait L2877 during rollback as the dispatcher is stopped and started again inside the one syncronisation which would prevent the dispatcher getting to the wait. So will more likely block on the sync L2870&lt;br/&gt;
Moving the setConnectionStopped calls out of the sync block along and ensuring that the _rollbackMark is updated before the connection is stopped then we should ok.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12426096">QPID-1871</key>
            <summary>During Rollback Client Rejects Message after sending TxRollback</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="7">Later</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="ritchiem">Martin Ritchie</reporter>
                        <labels>
                    </labels>
                <created>Fri, 22 May 2009 09:36:41 +0000</created>
                <updated>Mon, 5 Sep 2011 21:45:41 +0000</updated>
                            <resolved>Mon, 5 Sep 2011 21:45:41 +0000</resolved>
                                    <version>M4</version>
                    <version>0.5</version>
                                    <fixVersion>JIRA Cleanup</fixVersion>
                                    <component>Broker-J</component>
                    <component>JMS AMQP 0-x</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12712005" author="ritchiem" created="Fri, 22 May 2009 09:41:51 +0000"  >&lt;p&gt;SImply waiting for the dispatcher thread to finish processing sounds good but  things become more complicated if you are calling rollback from the dispatcher thread.. such as from onMessage.&lt;/p&gt;</comment>
                            <comment id="12712015" author="ritchiem" created="Fri, 22 May 2009 10:21:19 +0000"  >&lt;p&gt;What I was thinking at the end there was that simply signallying to the dispatcher to stop is not enough. This is partially the problem we have just now.&lt;/p&gt;

&lt;p&gt;We need to know that it as finished processing and hit the wait L2877 before we can safely complete rollback.&lt;/p&gt;

&lt;p&gt;I think the best thing to do would be to push all the rollback code in to the dispatcher and have the dispatcher thread process the rollback. As the Rollback has session wide effect it makes sence to me that the dispatcher thread is the right place to do this work. Otherwise we have to ensure that we have stopped the dispatcher before proceeding. The logic around that stopping will become complex when we have to handle the onMessage case.&lt;br/&gt;
Making the dispatcher thread responsible should make the locking far simpler. It should also be clearer that a call from a different thread should request rollback from the dispatcher and block whilst the dispatcher thread (from onMessage) can perform the rollback.&lt;/p&gt;

&lt;p&gt;To ensure message order is preserved we will need to have a method in to the Transport Layer to know that all buffers have been purged. This will then allow the dispatcher to reject all the messages with confidence that it will not miss one. &lt;/p&gt;

&lt;p&gt;The dispatcher will know when it has procesed all the messages on the session and can safely send the TxRollback.&lt;/p&gt;</comment>
                            <comment id="12757073" author="ritchiem" created="Fri, 18 Sep 2009 09:19:21 +0000"  >&lt;p&gt;=== &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-1871&quot; title=&quot;During Rollback Client Rejects Message after sending TxRollback&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-1871&quot;&gt;&lt;del&gt;QPID-1871&lt;/del&gt;&lt;/a&gt; Spec ===&lt;/p&gt;

&lt;p&gt;During Rollback Client Rejects Message after sending TxRollback&lt;/p&gt;

&lt;p&gt;Problem:&lt;/p&gt;

&lt;p&gt;Broker does not obey Flow=false when the client calls TxRollback. In the TxRollbackHandler we rollback &lt;br/&gt;
any TxOps then resend any unacknowledged messages.&lt;/p&gt;

&lt;p&gt;The question is who is wrong here.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Is the client wrong in requsting TxRollback whilst in a Flowed state.&lt;/li&gt;
	&lt;li&gt;Is the broker wrong for sending messages when the client has requested flow.false.&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;Either way the client is erroneously requesting TxRollback before it has fully verified&lt;br/&gt;
that it no longer has any messages in the session.&lt;/p&gt;

&lt;p&gt;The problem occurs here as the Dispatcher has the ability to hold on to a message so when the rollback &lt;br/&gt;
process is beleived to have completed the Dispatcher then rejects the final message AFTER the TxRollback&lt;br/&gt;
so that one message gets sent ahead of the other messages. The reject is dropped as the message has been &lt;br/&gt;
resent.&lt;/p&gt;

&lt;p&gt;Analysis of current process:&lt;/p&gt;

&lt;p&gt;session.rollback()&lt;/p&gt;

&lt;p&gt;0-8 : Client Side&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Suspend the Channel&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for ClientAck &amp;amp;&amp;amp; Tx&lt;/li&gt;
	&lt;li&gt;Reject all the delivered messages, Reject (requeue=true)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if we have a dispatcher (.rollback)&lt;/li&gt;
	&lt;li&gt;verify connection is stopped&lt;/li&gt;
	&lt;li&gt;loops all active consumers&lt;/li&gt;
	&lt;li&gt;rolling them back, if they are Consumers
	&lt;ul&gt;
		&lt;li&gt;
		&lt;ul&gt;
			&lt;li&gt;Consumer Rollback&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;clearing their recieve Queue, if they are Browsers&lt;/li&gt;
	&lt;li&gt;If we are in a Transacted Session we hae recorded all the consumers that have been closed.&lt;/li&gt;
	&lt;li&gt;we then rollback and remove each of these recorded consumers from the list.
	&lt;ul&gt;
		&lt;li&gt;
		&lt;ul&gt;
			&lt;li&gt;Consumer Rollback&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;restore the connection state(i.e. if we were stopped stay stopped)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Send Rollback&lt;/li&gt;
	&lt;li&gt;Mark Session Clean&lt;/li&gt;
	&lt;li&gt;Unsuspend the channel&lt;br/&gt;
&amp;#8212;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Consumer Rollback&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Not sure why the recorded sessions would need to rollback as the first check in this method is&lt;br/&gt;
 to check if there are any messages pending for this consumer.&lt;/li&gt;
	&lt;li&gt;All deregistered consumers will have an empty queue... I would have thought.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The contents of the synchronouseQueue are then processed.&lt;/li&gt;
	&lt;li&gt;Any AbstractJMSMessages are rejected (requeue=true)&lt;/li&gt;
	&lt;li&gt;Any thing else is dropped from the queue.&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;hr /&gt;
&lt;p&gt;Java Broker Side	&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;all TxOps are rollback&lt;/li&gt;
	&lt;li&gt;TxRollbackOk is sent then&lt;/li&gt;
	&lt;li&gt;channel.resend is called which resends all currently unacked messages&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;Other Issues:&lt;br/&gt;
Java doc wrong: rollback does NOT commit all messages!&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;Solution Approach:&lt;/p&gt;

&lt;p&gt;I believe there are two possibilities.&lt;/p&gt;

&lt;p&gt;1) If we do not reject the delivered messages then the channel.resend process will resend all the messages&lt;br/&gt;
back to the client. The order of receipt will be identical to the first time.&lt;/p&gt;

&lt;p&gt;2) We can correct the dispatcher flaw so that all messages are correctly rejected so the resend will have &lt;br/&gt;
nothing to do. This means that the order of received messages may change but will be in line with the JMS API.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Expired messages will expire&lt;/li&gt;
	&lt;li&gt;Priority messages will be expodited.&lt;/li&gt;
	&lt;li&gt;Also those messages will be made available to other consumers of that queue (Ordering on that client is not defined by JMS)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Whilst 1 is simpist I beleive performing 2 is the correct thing to do.&lt;/p&gt;</comment>
                            <comment id="12757094" author="ritchiem" created="Fri, 18 Sep 2009 10:41:23 +0000"  >&lt;p&gt;In answering one of the questions above about who is &apos;wrong&apos;. Nobody. The client must request TxRollback whilst suspsended or it will continue to receive new messages on the queue. The broker is also correct in sending the messages even though the channel is suspended as if the channel is not suspended then new messages on the queue will be received ahead of the redelivered messages.&lt;/p&gt;</comment>
                            <comment id="12757148" author="ritchiem" created="Fri, 18 Sep 2009 13:04:42 +0000"  >&lt;p&gt;Running the modified RollbackOrderTest has highlighted another race condition bug.&lt;/p&gt;

&lt;p&gt;The error the broker reports is that the client is acking an unknown delivery tag. Which suggests that the client has somehow still got a hold of a message from before the rollback, which it then acks but as the unacked map has been cleared(individually rejected, then redelivered) the deilveryTag is no longer  valid.&lt;/p&gt;

&lt;p&gt;On the revised version of the RollbackOrderTest this occurs regularly.&lt;/p&gt;</comment>
                            <comment id="12757150" author="ritchiem" created="Fri, 18 Sep 2009 13:05:53 +0000"  >&lt;p&gt;Current patch in local test.&lt;/p&gt;</comment>
                            <comment id="12757889" author="ritchiem" created="Mon, 21 Sep 2009 13:21:28 +0000"  >&lt;p&gt;Change design posted here:&lt;br/&gt;
&lt;a href=&quot;http://cwiki.apache.org/confluence/display/qpid/0.6+Java+Client+Dispatcher+Changes&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cwiki.apache.org/confluence/display/qpid/0.6+Java+Client+Dispatcher+Changes&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13097369" author="gemmellr" created="Mon, 5 Sep 2011 21:45:41 +0000"  >&lt;p&gt;Closing issue out as part of JIRA cleanup. Issue may already be resolved, may be invalid, or may never be fixed. See &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-3469&quot; title=&quot;JIRA clean up for Java client/broker&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-3469&quot;&gt;&lt;del&gt;QPID-3469&lt;/del&gt;&lt;/a&gt; for further details.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12420019" name="AckBug.txt" size="919818" author="ritchiem" created="Fri, 18 Sep 2009 13:04:42 +0000"/>
                            <attachment id="12420020" name="RollbackOrderTest.patch" size="5250" author="ritchiem" created="Fri, 18 Sep 2009 13:05:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>62604</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 11 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0bmcf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>65732</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>