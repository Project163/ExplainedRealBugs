<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:22:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[QPID-6374] [Java Client] Eliminate deadlocks by acquiring locks in a consistent order</title>
                <link>https://issues.apache.org/jira/browse/QPID-6374</link>
                <project id="12310520" key="QPID">Qpid</project>
                    <description>&lt;p&gt;A number of JIRAs exist relating to deadlocks in the Java client.&lt;/p&gt;

&lt;p&gt;Deadlocks can generally be avoided if locks are always acquired in the same order however the Java client threading model can make this hard.&lt;/p&gt;

&lt;p&gt;Two locks which in combination cause particular issues are the messageDeliveryLock and the failoverMutex.&lt;/p&gt;

&lt;p&gt;The semantic purpose of the messageDeliveryLock is to meet the requirements of JMS that session.close(), connection.close() and consumer.close() block while the application is receiving a message in onMessage() or from receive().  The lock should only be acquired from an application thread or from the onMessage dispatcher thread - it should not be held by a thread acting on behalf of processing caused by io processing (e.g. the broker closing the session or connection).  The lock is session specific.&lt;/p&gt;

&lt;p&gt;The semantic purpose of the failover mutex is to ensure that application actions which cause state change at the broker can are not engaged in while failover is occurring.  The lock is connection wide.  In general the lock should only be held by application threads, except for when failover is occurring, in which case the thread managing failover will hold the lock.&lt;/p&gt;

&lt;p&gt;Since messageDeliveryLock has a narrower scope (session) than the failoverMutex (which is connection scoped) it makes sense to ensure that the messageDeliveryLock is always acquired first.  Changing this ordering where necessary, and removing and path where the messageDeliveryLock can be acquired by a non-application thread will greatly reduce the number of deadlocks seen.&lt;/p&gt;

&lt;p&gt;Other deadlocks can be eliminated by removing the failoverMutex being acquired by threads acting on behalf of io processing, and by only holding the sessionCreationLock when setting the closed state or when actually creating a session.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12773580">QPID-6374</key>
            <summary>[Java Client] Eliminate deadlocks by acquiring locks in a consistent order</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rgodfrey">Robert Godfrey</assignee>
                                    <reporter username="rgodfrey">Robert Godfrey</reporter>
                        <labels>
                    </labels>
                <created>Mon, 9 Feb 2015 21:30:57 +0000</created>
                <updated>Wed, 2 Oct 2019 19:20:45 +0000</updated>
                            <resolved>Wed, 11 Feb 2015 10:59:01 +0000</resolved>
                                                    <fixVersion>0.31</fixVersion>
                                    <component>JMS AMQP 0-x</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14313893" author="jira-bot" created="Tue, 10 Feb 2015 09:32:26 +0000"  >&lt;p&gt;Commit 1658652 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=godfrer&quot; class=&quot;user-hover&quot; rel=&quot;godfrer&quot;&gt;godfrer&lt;/a&gt; in branch &apos;qpid/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1658652&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1658652&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-6374&quot; title=&quot;[Java Client] Eliminate deadlocks by acquiring locks in a consistent order&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-6374&quot;&gt;&lt;del&gt;QPID-6374&lt;/del&gt;&lt;/a&gt; : Reorder ock aquisition and remove synchronization where it is not desired to reduce deadlocks&lt;/p&gt;</comment>
                            <comment id="14313942" author="gemmellr" created="Tue, 10 Feb 2015 10:11:58 +0000"  >&lt;p&gt;I took a quick look at the patch and didnt see any issues (said that about client patches before though &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;). I ran the 0-9-1 and 0-10 &apos;mms&apos; test profiles and they passed.&lt;/p&gt;

&lt;p&gt;Leaving the JIRA reviewable for now, should anyone else like to give it a glance over.&lt;/p&gt;</comment>
                            <comment id="14314065" author="jira-bot" created="Tue, 10 Feb 2015 11:59:03 +0000"  >&lt;p&gt;Commit 1658689 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=godfrer&quot; class=&quot;user-hover&quot; rel=&quot;godfrer&quot;&gt;godfrer&lt;/a&gt; in branch &apos;qpid/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1658689&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1658689&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-6374&quot; title=&quot;[Java Client] Eliminate deadlocks by acquiring locks in a consistent order&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-6374&quot;&gt;&lt;del&gt;QPID-6374&lt;/del&gt;&lt;/a&gt; : Always call exception listener from connection task pool, rather than from within the failover mutex&lt;/p&gt;</comment>
                            <comment id="14314179" author="jira-bot" created="Tue, 10 Feb 2015 13:37:01 +0000"  >&lt;p&gt;Commit 1658714 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=godfrer&quot; class=&quot;user-hover&quot; rel=&quot;godfrer&quot;&gt;godfrer&lt;/a&gt; in branch &apos;qpid/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1658714&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1658714&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-6374&quot; title=&quot;[Java Client] Eliminate deadlocks by acquiring locks in a consistent order&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-6374&quot;&gt;&lt;del&gt;QPID-6374&lt;/del&gt;&lt;/a&gt; : tidyup calls to connection task pool&lt;/p&gt;</comment>
                            <comment id="14316029" author="k-wall" created="Wed, 11 Feb 2015 10:58:42 +0000"  >&lt;p&gt;Changes look reasonable to me.&lt;/p&gt;</comment>
                            <comment id="14318636" author="jira-bot" created="Thu, 12 Feb 2015 17:57:12 +0000"  >&lt;p&gt;Commit 1659341 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=godfrer&quot; class=&quot;user-hover&quot; rel=&quot;godfrer&quot;&gt;godfrer&lt;/a&gt; in branch &apos;qpid/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1659341&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1659341&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-6374&quot; title=&quot;[Java Client] Eliminate deadlocks by acquiring locks in a consistent order&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-6374&quot;&gt;&lt;del&gt;QPID-6374&lt;/del&gt;&lt;/a&gt; : avoid taking a lock when not modifying a value&lt;/p&gt;</comment>
                            <comment id="14320390" author="jira-bot" created="Fri, 13 Feb 2015 17:06:09 +0000"  >&lt;p&gt;Commit 1659605 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kwall&quot; class=&quot;user-hover&quot; rel=&quot;kwall&quot;&gt;kwall&lt;/a&gt; in branch &apos;qpid/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1659605&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1659605&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-6374&quot; title=&quot;[Java Client] Eliminate deadlocks by acquiring locks in a consistent order&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-6374&quot;&gt;&lt;del&gt;QPID-6374&lt;/del&gt;&lt;/a&gt;: &lt;span class=&quot;error&quot;&gt;&amp;#91;Java Broker&amp;#93;&lt;/span&gt; 0-10 Failover: the thread performing the failover prep now syncs the dispatch queue (avoids possibility of app level dead lock)&lt;/p&gt;</comment>
                            <comment id="14369063" author="justi9" created="Thu, 19 Mar 2015 12:22:49 +0000"  >&lt;p&gt;Released in Qpid 0.32, &lt;a href=&quot;http://qpid.apache.org/releases/qpid-0.32/index.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://qpid.apache.org/releases/qpid-0.32/index.html&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                            <outwardlinks description="incorporates">
                                        <issuelink>
            <issuekey id="12652703">QPID-4922</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12605694">QPID-4276</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12631478">QPID-4574</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12650744">QPID-4906</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12667124">QPID-5117</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12667277">QPID-5118</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12667279">QPID-5119</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12783222">QPID-6461</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12697585" name="client_deadlock_3.diff" size="12774" author="rgodfrey" created="Mon, 9 Feb 2015 22:37:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 35 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i25dwv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>