<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:21:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[QPID-3016] Java JMS client ReplyTo memory leak</title>
                <link>https://issues.apache.org/jira/browse/QPID-3016</link>
                <project id="12310520" key="QPID">Qpid</project>
                    <description>&lt;p&gt;I&apos;m using the Java 0.8 client JMS interface. Relevant Client code is below.&lt;/p&gt;

&lt;p&gt;If I make async requests to a queue with setJMSReplyTo as temporary queue for responses, the client process will run out of memory after about 3.2M request/response message pairs. This is at 512MB max java heap, though growth appears to be consistently linear.  Note that I use a semaphore between request and response to keep ~1000 unanswered requests open in the client and block before sending more. Thus this should not be a matter of simply saturating the client with unsent messages.&lt;/p&gt;

&lt;p&gt;Here is the top of the jhat histogram from jmap heap dump shortly before client runs out of memory:&lt;/p&gt;

&lt;p&gt;class org.apache.qpid.collections.ReferenceMap$SoftRef  3253120         143137280&lt;br/&gt;
class org.apache.qpid.collections.ReferenceMap$Entry    3253120         117112320&lt;br/&gt;
class [Lorg.apache.qpid.collections.ReferenceMap$Entry;       1         67108880&lt;br/&gt;
class org.apache.qpid.transport.ReplyTo                 3253120         61809280&lt;/p&gt;

&lt;p&gt;Note that 3253120 appears to match the total number of request/replies successfully processed by the client up to this point. Or in other words, its leaking one ReplyTo object and associated (not so?) soft references per request/response.&lt;/p&gt;

&lt;p&gt;If instead I replace the temporary queue with a fixed response and drop use of setJMSReplyTo(), the client works fine, no memory leak.&lt;/p&gt;

&lt;p&gt;Below are more details when running with the temp response queue:&lt;/p&gt;

&lt;p&gt;% qpid-config queues&lt;/p&gt;

&lt;p&gt;Queue Name                                     Attributes&lt;br/&gt;
======================================================================&lt;br/&gt;
TempQueued4051d9d-37d3-4306-a1fc-91b93f7082c8  auto-del excl&lt;br/&gt;
iudex-brutefuzzy-request                       --max-queue-size=100000 --limit-policy=reject&lt;/p&gt;

&lt;p&gt;Client startup Log:&lt;/p&gt;

&lt;p&gt;635  &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; INFO  o.a.q.j.PropertiesFileInitialContextFactory - No Provider URL specified.&lt;br/&gt;
726  &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; INFO  o.a.qpid.client.AMQConnection - Connection:amqp://qpid:********@default-client/default-vhost?brokerlist=&apos;tcp://localhost:5672&apos;&lt;br/&gt;
973  &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; INFO  o.a.q.c.p.AMQProtocolSession - Using ProtocolVersion for Session:0-10&lt;br/&gt;
990  &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; INFO  o.a.q.c.h.ClientMethodDispatcherImpl - New Method Dispatcher:AMQProtocolSession&lt;span class=&quot;error&quot;&gt;&amp;#91;null&amp;#93;&lt;/span&gt;&lt;br/&gt;
1002 &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; INFO  o.a.qpid.client.AMQConnection - Connecting with ProtocolHandler Version:0-10&lt;br/&gt;
1150 &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; INFO  o.a.qpid.client.AMQConnection - Connected with ProtocolHandler Version:0-10&lt;br/&gt;
1192 &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; INFO  o.a.qpid.client.AMQSession - Created session:org.apache.qpid.client.AMQSession_0_10@1b7c63f&lt;br/&gt;
1280 &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; INFO  o.a.q.c.BasicMessageProducer_0_10 - MessageProducer org.apache.qpid.client.BasicMessageProducer_0_10@1727745 using publish mode : ASYNC_PUBLISH_ALL&lt;br/&gt;
1503 &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; INFO  o.a.qpid.client.AMQSession - Prefetching delayed existing messages will not flow until requested via receive*() or setML().&lt;br/&gt;
1586 &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; INFO  o.a.q.c.AMQSession.Dispatcher - Dispatcher-Channel-1 created&lt;br/&gt;
1586 &lt;span class=&quot;error&quot;&gt;&amp;#91;Dispatcher-Channel-1&amp;#93;&lt;/span&gt; INFO  o.a.q.c.AMQSession.Dispatcher - Dispatcher-Channel-1 started&lt;/p&gt;


&lt;p&gt;Relevent client code:&lt;/p&gt;

&lt;p&gt;public class Client&lt;br/&gt;
    implements MessageListener, Closeable, ExceptionListener&lt;br/&gt;
{&lt;br/&gt;
    public Client( JMSContext context )&lt;br/&gt;
        throws JMSException, NamingException&lt;/p&gt;
    {
        _connection = context.createConnection();

        _session = context.createSession( _connection );

        Destination requestQueue =
            context.lookupDestination( &quot;iudex-brutefuzzy-request&quot; );
        _producer = _session.createProducer( requestQueue );

        context.close();

        _responseQueue = _session.createTemporaryQueue();
        _session.createConsumer( _responseQueue ).setMessageListener(this);

        _connection.start();

    }

&lt;p&gt;    public void sendRequest( long simhash, boolean doAdd )&lt;br/&gt;
        throws JMSException, InterruptedException&lt;br/&gt;
    {&lt;br/&gt;
        Builder bldr = Request.newBuilder();&lt;br/&gt;
        bldr.setSimhash( simhash );&lt;br/&gt;
        bldr.setAction( doAdd ? RequestAction.ADD : RequestAction.CHECK_ONLY );&lt;/p&gt;

&lt;p&gt;        BytesMessage response = _session.createBytesMessage();&lt;br/&gt;
        response.writeBytes( bldr.build().toByteArray() );&lt;/p&gt;

&lt;p&gt;        if( _responseQueue != null ) &lt;/p&gt;
{
            response.setJMSReplyTo( _responseQueue );
        }
&lt;p&gt;        _semaphore.acquire();&lt;/p&gt;

&lt;p&gt;        _producer.send( response );&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;    @Override&lt;br/&gt;
    public void onMessage( Message msg )&lt;br/&gt;
    {&lt;br/&gt;
        try &lt;/p&gt;
{
            //Handle response
            msg.acknowledge();
            _semaphore.release();
        }
&lt;p&gt;        catch( JMSException x ) {&lt;br/&gt;
            if( _log.isDebugEnabled() ) _log.error( &quot;onMessage:&quot;, x );&lt;br/&gt;
            else _log.error( &quot;onMessage: {}&quot;, x.toString() );&lt;br/&gt;
        }&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;    private Session _session;&lt;br/&gt;
    private MessageProducer _producer;&lt;br/&gt;
    private boolean _createTemporaryResponseQueue = true;&lt;br/&gt;
    private Destination _responseQueue = null;&lt;br/&gt;
    private Connection _connection = null;&lt;br/&gt;
    private final Semaphore _semaphore = new Semaphore( 1000 );&lt;br/&gt;
    private Logger _log = LoggerFactory.getLogger( getClass() );&lt;br/&gt;
}&lt;/p&gt;</description>
                <environment>&lt;p&gt;Fedora 14: 2.6.35.10-74.fc14.x86_64&lt;/p&gt;

&lt;p&gt;Broker: qpidd (qpidc) version 0.8&lt;/p&gt;

&lt;p&gt;Java Client 0.8&lt;/p&gt;

&lt;p&gt;OpenJDK Runtime Environment (IcedTea6 1.9.3) (fedora-49.1.9.3.fc14-x86_64)&lt;br/&gt;
OpenJDK 64-Bit Server VM (build 19.0-b09, mixed mode)&lt;/p&gt;</environment>
        <key id="12496405">QPID-3016</key>
            <summary>Java JMS client ReplyTo memory leak</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="robbie">Robbie Gemmell</assignee>
                                    <reporter username="dekellum">David Kellum</reporter>
                        <labels>
                    </labels>
                <created>Sun, 23 Jan 2011 00:59:54 +0000</created>
                <updated>Tue, 14 Mar 2017 20:07:26 +0000</updated>
                            <resolved>Thu, 17 Feb 2011 00:55:59 +0000</resolved>
                                    <version>0.8</version>
                                    <fixVersion>0.9</fixVersion>
                                    <component>JMS AMQP 0-x</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12989660" author="andrew.kennedy" created="Wed, 2 Feb 2011 15:03:04 +0000"  >&lt;p&gt;I think this should be fixed by caching only a soft reference to the destination in the 0-10 AMQConnectionDelegate class, which I appear to have done for some other reason in an unrelated patch. I will check if this is indeed the case, and update.&lt;/p&gt;</comment>
                            <comment id="12995615" author="andrew.kennedy" created="Thu, 17 Feb 2011 00:55:02 +0000"  >&lt;p&gt;Please review&lt;/p&gt;</comment>
                            <comment id="12995616" author="andrew.kennedy" created="Thu, 17 Feb 2011 00:55:59 +0000"  >&lt;p&gt;Ready for review&lt;/p&gt;</comment>
                            <comment id="13088493" author="gemmellr" created="Sun, 21 Aug 2011 23:44:52 +0000"  >&lt;p&gt;Relating this to &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-3440&quot; title=&quot;the reply-to Destination cache in AMQMessageDelegate_0_10 does not work&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-3440&quot;&gt;&lt;del&gt;QPID-3440&lt;/del&gt;&lt;/a&gt;, as the changes made here dont really fix the underlying issue.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12519630">QPID-3440</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>64274</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 13 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0bmr3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>65798</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>