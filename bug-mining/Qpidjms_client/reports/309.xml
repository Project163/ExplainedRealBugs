<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:21:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[QPID-2559] When a subscription is created, message credits should only be set if the dispatcher is not null.</title>
                <link>https://issues.apache.org/jira/browse/QPID-2559</link>
                <project id="12310520" key="QPID">Qpid</project>
                    <description>&lt;p&gt;When a subscription is created, message credits should only be set if the dispatcher is not null.&lt;br/&gt;
If the dispatcher is null, the session is suspended temporarily until a dispatcher is created.&lt;br/&gt;
And then when the session is unsuspended, message credits will be set again, resulting in granting more credits than intended.&lt;/p&gt;

&lt;p&gt;Please note in order for this error condition to happen the dispatcher should be null and the broker should have enough messages.&lt;br/&gt;
If the connection is not started and the message consumer is the very first to be created for that session, then the dispatcher thread for that session is null.&lt;/p&gt;

&lt;p&gt;Steps To Reproduce&lt;br/&gt;
----------------------------&lt;br/&gt;
1. create connection, but not start it&lt;br/&gt;
1. create a session with client ack&lt;br/&gt;
2. send 20 messages to a queue&lt;br/&gt;
3. create receiver with capacity (prefetch) as 10.&lt;br/&gt;
4. start connection.&lt;br/&gt;
5. receive 10 messages&lt;br/&gt;
Look at the client and broker logs and observe that the broker sends more messages than needed.&lt;/p&gt;

&lt;p&gt;Expected Result.&lt;br/&gt;
------------------------&lt;br/&gt;
At any given time we should only receive n messages, where n == maxprefetch (capacity as defined for the destination)&lt;/p&gt;

&lt;p&gt;Actual Result&lt;br/&gt;
-------------------&lt;br/&gt;
For the above conditions, we get double than what we want (provided the broker has enough messages on the queue).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12463353">QPID-2559</key>
            <summary>When a subscription is created, message credits should only be set if the dispatcher is not null.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="2">Won&apos;t Fix</resolution>
                                        <assignee username="rajith">Rajith Muditha Attapattu</assignee>
                                    <reporter username="rajith">Rajith Muditha Attapattu</reporter>
                        <labels>
                            <label>possibly_complete</label>
                    </labels>
                <created>Thu, 29 Apr 2010 17:20:30 +0000</created>
                <updated>Tue, 30 Jan 2018 17:22:10 +0000</updated>
                            <resolved>Tue, 30 Jan 2018 17:22:10 +0000</resolved>
                                    <version>0.6</version>
                                                    <component>JMS AMQP 0-x</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12868661" author="ritchiem" created="Tue, 18 May 2010 14:37:55 +0000"  >&lt;p&gt;Hi Rajith,&lt;/p&gt;

&lt;p&gt;The AMQConnectionTest is still failing. Not sure if you noticed your actually using transacted sessions on your consumers.&lt;/p&gt;

&lt;p&gt;I&apos;ve attached an updated test that tests your example client ack scenario. &lt;br/&gt;
I have included the transacted scenario you were testing.&lt;/p&gt;

&lt;p&gt;The client-ack test case works on all java profiles.(default,java,java.0.10)&lt;br/&gt;
The transacted case failes on 0.10, it appears that MAX_PREFTECH is being ignored by the java broker.&lt;/p&gt;

&lt;p&gt;The cpp doesn&apos;t currently build on my desktop. Do attached tests accurately represent your problem?&lt;/p&gt;

&lt;p&gt;Would be good to exclude the current test as it fails on on 0.10 code paths. Client A is not guaranteed to get 2 messages. But one of them A or B will.&lt;/p&gt;</comment>
                            <comment id="12868696" author="rajith" created="Tue, 18 May 2010 15:58:29 +0000"  >&lt;p&gt;Hi Martin,&lt;/p&gt;

&lt;p&gt;I am a little confused about your comment  - &quot;Not sure if you noticed your actually using transacted sessions on your consumers.&quot; .&lt;br/&gt;
The consumer session is using AUTO_ACK and now both consumers are created off the same session.&lt;br/&gt;
Also I have modified the test in rev 945444 with a detailed explanation (check the svn commits tab on this JIRA) to make sure it works after the change I made in rev 942293.&lt;/p&gt;

&lt;p&gt;However this test is now failing when I run it against the java test profile. &lt;br/&gt;
This is probably bcos the flow control semantics are different in 0-8 ?&lt;br/&gt;
(I also noticed that even when I used java.0.10.testprofile the test output was still using 0-8 - so maybe there is a bug? )&lt;/p&gt;


&lt;p&gt;I think the original test case (before my modification in rev 945444) would have been a good test for this bug if CLIENT-ACK or TRANSACTED is used.&lt;br/&gt;
As in that case the completions would have only being sent when acked or the transaction committed.&lt;br/&gt;
But the original test would fail for AUTO-ACK due to reasons mentioned in commit log for rev 945444.&lt;/p&gt;

&lt;p&gt;So perhaps we could have a switch in the test code to create both consumers using the same session if AUTO-ACK and each on it&apos;s own session otherwise.&lt;br/&gt;
Let me use the code you attached to create the test. Please have a look and see if I have missed anything.&lt;/p&gt;</comment>
                            <comment id="12868707" author="rajith" created="Tue, 18 May 2010 16:20:53 +0000"  >&lt;p&gt;Minor correction.&lt;br/&gt;
The current AMQConnectionTest is working properly with the java.0.10.testprofile.&lt;/p&gt;</comment>
                            <comment id="12868770" author="rajith" created="Tue, 18 May 2010 18:14:17 +0000"  >&lt;p&gt;Martin,&lt;/p&gt;

&lt;p&gt;I checked in a fix for AMQConnectionTest#testPrefetchSystemProperty() to work with both the 0-8 and 0-10 codepaths.&lt;br/&gt;
I think it&apos;s best if we leave that as a test for testing the system prop instead of using as a test for the issue raised in this JIRA.&lt;/p&gt;

&lt;p&gt;I think we should write some specialized test cases around capacity (aka prefetch. aka consumer flow control) to test this issue and &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-2604&quot; title=&quot;Incorrect logic for handling message credits in BasicMessageConsumer_0_10  could result in the client receiving more messages than it needs.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-2604&quot;&gt;&lt;del&gt;QPID-2604&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
Actually I have some test cases in my local and these issues were identified as a result of running those test cases.&lt;br/&gt;
I don&apos;t think we have any existing tests around capacity. So I am hoping to add some today.&lt;br/&gt;
If you have any further ideas please feel free to add more tests.&lt;br/&gt;
I will use your patch when creating the new test cases.&lt;/p&gt;

&lt;p&gt;Rajith&lt;/p&gt;</comment>
                            <comment id="12868781" author="gemmellr" created="Tue, 18 May 2010 18:39:33 +0000"  >&lt;p&gt;&amp;gt;Hi Martin,&lt;/p&gt;

&lt;p&gt;&amp;gt;I am a little confused about your comment - &quot;Not sure if you noticed your actually using transacted sessions on your consumers.&quot; .&lt;br/&gt;
&amp;gt;The consumer session is using AUTO_ACK and now both consumers are created off the same session. &lt;/p&gt;


&lt;p&gt;I believe Martin would have been referencing the fact that the test you are modifying uses consumer sessions which are created with the code below, which has transacted = true and thereby ignores the acknowledgeMode parameter as per the JMS spec:&lt;/p&gt;

&lt;p&gt; connection.createSession(true, Session.AUTO_ACKNOWLEDGE);&lt;/p&gt;</comment>
                            <comment id="12868791" author="rajith" created="Tue, 18 May 2010 19:06:42 +0000"  >&lt;p&gt;I was as blind as a bat there. I completely missed that !&lt;br/&gt;
I will fix the code to set it to &quot;false&quot;.&lt;/p&gt;

&lt;p&gt;I think I need to investigate why the original test didn&apos;t work when the ack mode was transacted.&lt;br/&gt;
Th credits should not have been replenished unless session.commit() was called.&lt;/p&gt;</comment>
                            <comment id="12868834" author="rajith" created="Tue, 18 May 2010 21:14:08 +0000"  >&lt;p&gt;&amp;gt;I think I need to investigate why the original test didn&apos;t work when the ack mode was transacted.&lt;br/&gt;
&amp;gt;The credits should not have been replenished unless session.commit() was called. &lt;/p&gt;

&lt;p&gt;I found the reason. If the session is transacted, we use the &quot;addDeliveredMessage&quot; method in AMQSession_0_10.java to record the non committed messages.&lt;br/&gt;
However we use the following heuristic to send completions to replenish credits.&lt;/p&gt;

&lt;p&gt;if (_connection.getMaxPrefetch() == 1 ||&lt;br/&gt;
                _connection.getMaxPrefetch() != 0 &amp;amp;&amp;amp; _txSize % (_connection.getMaxPrefetch() / 2) == 0)&lt;/p&gt;
 {
           // send completed so consumer credits don&apos;t dry up
           messageAcknowledge(_txRangeSet, false);
 }

&lt;p&gt;Since we use a prefetch of just 2 messages, we easily triggered the condition, hence we acked after just consuming one message.&lt;br/&gt;
That is the reason why consumerA got the other two messages as well (even though the session wasn&apos;t committed) before consumerB who was on a different session was able to get those two messages.&lt;/p&gt;</comment>
                            <comment id="16345421" author="k-wall" created="Tue, 30 Jan 2018 17:22:10 +0000"  >&lt;p&gt;Won&apos;t Fix.  Development work on this Qpid JMS AMQP 0-x client has ceased.  For a JMS client under active development, see the Qpid JMS&lt;br/&gt;
AMQP 1.0 client - &lt;a href=&quot;https://qpid.apache.org/components/jms/index.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://qpid.apache.org/components/jms/index.html&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12444800" name="QPID-2559.test" size="2899" author="ritchiem" created="Tue, 18 May 2010 14:37:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>169272</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 41 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0bi1j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>65035</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>