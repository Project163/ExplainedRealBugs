<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:21:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[QPID-3532] Fix the blocking of JMS operations when failover happens</title>
                <link>https://issues.apache.org/jira/browse/QPID-3532</link>
                <project id="12310520" key="QPID">Qpid</project>
                    <description>&lt;p&gt;When connection is lost and failover is started the Qpid Client should block on invocation of JMS operations which require sending or receiving data over the network.&lt;br/&gt;
With current implementation the performing of certain operations during failover can lead to unexpected behaviour.&lt;br/&gt;
For example, closing QueueBrowsers during failover has been observed to cause  issues because it is possible to send the old subscription destination in a cancel command to the new broker as the close and failover are allowed to progress concurrently. As result of it the broker might close the session with a NOT_FOUND execution exception because failover has not finished queue re-creation on a new broker&lt;/p&gt;</description>
                <environment></environment>
        <key id="12526181">QPID-3532</key>
            <summary>Fix the blocking of JMS operations when failover happens</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="orudyy">Alex Rudyy</assignee>
                                    <reporter username="orudyy">Alex Rudyy</reporter>
                        <labels>
                    </labels>
                <created>Fri, 7 Oct 2011 11:29:26 +0000</created>
                <updated>Tue, 14 Mar 2017 20:07:32 +0000</updated>
                            <resolved>Wed, 15 Feb 2012 23:14:52 +0000</resolved>
                                                    <fixVersion>0.13</fixVersion>
                                    <component>JMS AMQP 0-x</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13131710" author="alex.rufous" created="Thu, 20 Oct 2011 15:52:39 +0000"  >&lt;p&gt;Attached a patch fixing the issue&lt;/p&gt;</comment>
                            <comment id="13131734" author="jiraposter@reviews.apache.org" created="Thu, 20 Oct 2011 16:25:10 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2469/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2469/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Review request for qpid and rajith attapattu.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-3532&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/QPID-3532&lt;/a&gt; describes some issues with non-blocking behaviour of 0-10 client failover.&lt;/p&gt;

&lt;p&gt;This patch makes the 0-10 client hold the failover mutex during the failover. It also alters the Address resolution code to allow resolving addresses after failover and adds some more failover tests (inc ADDR based ones). Additionally, it makes the failover process notify any waiters in the session to abort and let failover proceed as they would otherwise prevent the failover from occurring until they timed out after 60 seconds.&lt;/p&gt;

&lt;p&gt;This work does not go as far as we would like but still represents a functional improvement to failover. Additional improvements to the client locking model (such as an introduction a single connection lock) will require further iteration.&lt;/p&gt;

&lt;p&gt;The patch was worked on by myself and Robbie.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-3532&quot; title=&quot;Fix the blocking of JMS operations when failover happens&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-3532&quot;&gt;&lt;del&gt;QPID-3532&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-3532&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/QPID-3532&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  &lt;a href=&quot;http://svn.apache.org/repos/asf/qpid/trunk/qpid/java/client/src/main/java/org/apache/qpid/client/AMQConnection.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/repos/asf/qpid/trunk/qpid/java/client/src/main/java/org/apache/qpid/client/AMQConnection.java&lt;/a&gt; 1186863 &lt;br/&gt;
  &lt;a href=&quot;http://svn.apache.org/repos/asf/qpid/trunk/qpid/java/client/src/main/java/org/apache/qpid/client/AMQConnectionDelegate_0_10.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/repos/asf/qpid/trunk/qpid/java/client/src/main/java/org/apache/qpid/client/AMQConnectionDelegate_0_10.java&lt;/a&gt; 1186863 &lt;br/&gt;
  &lt;a href=&quot;http://svn.apache.org/repos/asf/qpid/trunk/qpid/java/client/src/main/java/org/apache/qpid/client/AMQDestination.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/repos/asf/qpid/trunk/qpid/java/client/src/main/java/org/apache/qpid/client/AMQDestination.java&lt;/a&gt; 1186863 &lt;br/&gt;
  &lt;a href=&quot;http://svn.apache.org/repos/asf/qpid/trunk/qpid/java/client/src/main/java/org/apache/qpid/client/AMQSession_0_10.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/repos/asf/qpid/trunk/qpid/java/client/src/main/java/org/apache/qpid/client/AMQSession_0_10.java&lt;/a&gt; 1186863 &lt;br/&gt;
  &lt;a href=&quot;http://svn.apache.org/repos/asf/qpid/trunk/qpid/java/client/src/main/java/org/apache/qpid/client/BasicMessageProducer_0_10.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/repos/asf/qpid/trunk/qpid/java/client/src/main/java/org/apache/qpid/client/BasicMessageProducer_0_10.java&lt;/a&gt; 1186863 &lt;br/&gt;
  &lt;a href=&quot;http://svn.apache.org/repos/asf/qpid/trunk/qpid/java/common/src/main/java/org/apache/qpid/transport/Connection.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/repos/asf/qpid/trunk/qpid/java/common/src/main/java/org/apache/qpid/transport/Connection.java&lt;/a&gt; 1186863 &lt;br/&gt;
  &lt;a href=&quot;http://svn.apache.org/repos/asf/qpid/trunk/qpid/java/common/src/main/java/org/apache/qpid/transport/Session.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/repos/asf/qpid/trunk/qpid/java/common/src/main/java/org/apache/qpid/transport/Session.java&lt;/a&gt; 1186863 &lt;br/&gt;
  &lt;a href=&quot;http://svn.apache.org/repos/asf/qpid/trunk/qpid/java/systests/src/main/java/org/apache/qpid/client/failover/FailoverBehaviourTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/repos/asf/qpid/trunk/qpid/java/systests/src/main/java/org/apache/qpid/client/failover/FailoverBehaviourTest.java&lt;/a&gt; 1186863 &lt;br/&gt;
  &lt;a href=&quot;http://svn.apache.org/repos/asf/qpid/trunk/qpid/java/test-profiles/JavaPre010Excludes&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/repos/asf/qpid/trunk/qpid/java/test-profiles/JavaPre010Excludes&lt;/a&gt; 1186863 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2469/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2469/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Oleksandr&lt;/p&gt;
</comment>
                            <comment id="13131835" author="rajith" created="Thu, 20 Oct 2011 17:54:41 +0000"  >&lt;p&gt;What kind of testing has been done on this patch? &lt;br/&gt;
Has there been any testing done in a clustered setup?&lt;/p&gt;

&lt;p&gt;This change obviously impacts any failover operation. Given that failover is our Achilles heel and that the Failover mutex being a source of many race conditions and deadlocks, I&apos;m quite concerned about making this change just before the deadline.&lt;/p&gt;

&lt;p&gt;I am also concerned that certain changes made in the last week have been backed out, giving the impression that we&apos;ve been hurried by the looming deadline. Perhaps we will benefit by taking more time to think through and verify these changes and target these fixes for our next release.&lt;/p&gt;

&lt;p&gt;Also what would be beneficial is a summary of changes being done on the client. It&apos;s true we discussed the issues and possible solutions. But I think it&apos;s equally important to have an outline of the code changes being made especially given that they were made very close to the release. This makes it easy for anybody reviewing those changes.&lt;/p&gt;

&lt;p&gt;Again given the fact that we don&apos;t have quality tests to verify these changes with confidence, I&apos;m of the opinion that we make these changes after the 0.14 release.&lt;/p&gt;

&lt;p&gt;Regards,&lt;/p&gt;

&lt;p&gt;Rajith &lt;/p&gt;</comment>
                            <comment id="13131865" author="gemmellr" created="Thu, 20 Oct 2011 18:19:48 +0000"  >&lt;p&gt;The testing done is the failover behaviour tests added both before this patch, and in this patch. There has been no testing in a clustered environment, only the standalone Java and C++ broker profiles. We are not in a position to test the cluster, which is why this is up for review and was not simply committed.&lt;/p&gt;

&lt;p&gt;What change backouts are you referring to? No changes have been backed out that I can think of other than 1 trivial revert I did earlier today of some completely irrelevant code change, which was simply restored to its previous state because it looked nicer. That did not need reverted, as there was no functional difference between the two versions, but it looked cleaner the way it was.&lt;/p&gt;

&lt;p&gt;The summary of changes for the patch is as given in the review posting. There is not a lot to say about it since it is just a small amount of change and leaves little to really describe.&lt;/p&gt;

&lt;p&gt;More tests could be useful, but I am at least happy we do have signficantly more (i.e &amp;gt; 0) automated tests of the shipping behaviour of the client for these failover+addressing changes than most of the others made in the past 18months have.&lt;/p&gt;

&lt;p&gt;I&apos;m not particularly bothered whether this makes into 0.14 or not, we have just been sitting on an incomplete version of it for long enough now that it was time to get it finished and posted &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13131926" author="rajith" created="Thu, 20 Oct 2011 19:18:32 +0000"  >&lt;p&gt;Robbie, thanks for the quick response.&lt;/p&gt;

&lt;p&gt;I can try to test this out with a clustered setup, however we have our f2f meeting next week so if I don&apos;t get it done by tomorrow then it will be delayed by a week. Hence one reason for my reluctance to see this go through for 0.14.&lt;/p&gt;

&lt;p&gt;While it is nice to have automated tests, through experience I&apos;ve come to realize that they only provide very little confidence for a feature like failover. All most all of the previous failover issues were identified by manual testing with more real life scenarios or in production environments.&lt;/p&gt;

&lt;p&gt;Most issues tend to happen when failover happens in the middle of a client going full steam (with operations like producing/consuming/creating/querying ..etc). It is almost impossible to replicate this kind of scenario with the automated testing. The fact that there was no testing resembling production scenarios on your end makes a me a bit concerned about the changes.&lt;/p&gt;

&lt;p&gt;I&apos;ve tried to semi automate tests like this using the python testkit, but never got around to really get it to a reasonable state as it kept failing behind with changes made on the clustering side and brokertest.py .&lt;/p&gt;

&lt;p&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Another hidden danger of such a change could be an impact on performance. Something that cannot be verified by merely running automated tests. Again if we have an agreed upon framework where we can benchmark before and after fixes we suspect of being perf sensitive that would have been great. We could also run them on a per release basis to ensure that we have either improved or regressed on the perf front.&lt;/p&gt;

&lt;p&gt;Anyways, If you feel confident about these changes and strongly feel they should be included in 0.14 then I&apos;d accept your word on it and will not make a fuss about it. But I have to note that I have very little confidence in the changes or the testing being done here so far. Please note it&apos;s not a reflection of the work you&apos;ve done for this particular patch, rather more on the inadequate testing strategy we have with the client in general.&lt;/p&gt;

&lt;p&gt;Regards,&lt;/p&gt;

&lt;p&gt;Rajith&lt;/p&gt;</comment>
                            <comment id="13131977" author="gemmellr" created="Thu, 20 Oct 2011 20:10:15 +0000"  >&lt;p&gt;I do feel this is a reasonable improvement over what we have, considering failover was previously allowed to proceed concurrently with the client in any old state and as per the QueueBrowser tests could often allow completely incorrect behaviour as a result. Most of the operations the client does already do hold the failover mutex (ironically enough its mainly only 0-10 failover that didnt), so there shouldnt be much performance difference in these changes as there are basically only a few if statements in there now which werent there already.&lt;/p&gt;

&lt;p&gt;As I say, I&apos;m not overly bothered whether this makes into 0.14 or not. That said, since this is only the alpha deadline, its at best 6 weeks until 0.14 ships (assuming we arent a month late like the last couple releases were), a month before an RC is due, and these changes are somewhat tiny and easily revertable, I wouldnt feel at all concerned about putting them in now even supposing we did have to take them out again in the next few weeks.&lt;/p&gt;</comment>
                            <comment id="13132078" author="rajith" created="Thu, 20 Oct 2011 21:40:16 +0000"  >&lt;p&gt;Cool, go for it !&lt;/p&gt;</comment>
                            <comment id="13132578" author="gemmellr" created="Fri, 21 Oct 2011 10:15:36 +0000"  >&lt;p&gt;Committed for the alpha build as agreed, would appreciate you giving it a once over with a clustered setup to see whether it stays in or not.&lt;/p&gt;</comment>
                            <comment id="13208939" author="gemmellr" created="Wed, 15 Feb 2012 23:14:52 +0000"  >&lt;p&gt;Closing out, patch was applied and included in the last release.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12499877" name="QPID-3532-make-the-0-10-client-hold-the-failover-mutex-during-failover.patch" size="26176" author="orudyy" created="Thu, 20 Oct 2011 15:52:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>49914</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 40 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0bj0f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>65192</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>