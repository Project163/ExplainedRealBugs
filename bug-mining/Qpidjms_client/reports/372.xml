<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:21:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[QPID-3214] Deadlock between the failover mutex (in AMQConnection.java) and the current_exception_lock (in AMQSession.java)</title>
                <link>https://issues.apache.org/jira/browse/QPID-3214</link>
                <project id="12310520" key="QPID">Qpid</project>
                    <description>&lt;p&gt;As per the following thread dump you can clearly see the deadlock between the failover mutex in AMQConnection.java and the current_exception_lock in AMQSession.java&lt;br/&gt;
This is a regression and was introduced in rev 985262&lt;/p&gt;

&lt;p&gt;  Found one Java-level deadlock:&lt;br/&gt;
  =============================&lt;br/&gt;
  &quot;IoReceiver - localhost/127.0.0.1:15672&quot;:&lt;br/&gt;
    waiting to lock monitor 0x0000002ac2ea3b70 (object 0x0000002ab70156b0, a java.lang.Object),&lt;br/&gt;
    which is held by &quot;main&quot;&lt;br/&gt;
  &quot;main&quot;:&lt;br/&gt;
    waiting to lock monitor 0x0000002ac28db1b8 (object 0x0000002ab7048d70, a java.lang.Object),&lt;br/&gt;
    which is held by &quot;IoReceiver - localhost/127.0.0.1:15672&quot;&lt;/p&gt;

&lt;p&gt;  Java stack information for the threads listed above:&lt;br/&gt;
  ===================================================&lt;br/&gt;
  &quot;IoReceiver - localhost/127.0.0.1:15672&quot;:&lt;br/&gt;
     at org.apache.qpid.client.AMQConnection.exceptionReceived(AMQConnection.java:1297)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting to lock&amp;lt;0x0000002ab70156b0&amp;gt;  (a java.lang.Object)&lt;br/&gt;
     at org.apache.qpid.client.AMQSession_0_10.setCurrentException(AMQSession_0_10.java:1033)&lt;/li&gt;
	&lt;li&gt;locked&amp;lt;0x0000002ab7048d70&amp;gt;  (a java.lang.Object)&lt;br/&gt;
     at org.apache.qpid.client.AMQSession_0_10.exception(AMQSession_0_10.java:913)&lt;br/&gt;
     at org.apache.qpid.transport.SessionDelegate.executionException(SessionDelegate.java:156)&lt;br/&gt;
     at org.apache.qpid.transport.SessionDelegate.executionException(SessionDelegate.java:32)&lt;br/&gt;
     at org.apache.qpid.transport.ExecutionException.dispatch(ExecutionException.java:112)&lt;br/&gt;
     at org.apache.qpid.transport.SessionDelegate.command(SessionDelegate.java:50)&lt;br/&gt;
     at org.apache.qpid.transport.SessionDelegate.command(SessionDelegate.java:32)&lt;br/&gt;
     at org.apache.qpid.transport.Method.delegate(Method.java:159)&lt;br/&gt;
     at org.apache.qpid.transport.Session.received(Session.java:528)&lt;br/&gt;
     at org.apache.qpid.transport.Connection.dispatch(Connection.java:404)&lt;br/&gt;
     at org.apache.qpid.transport.ConnectionDelegate.handle(ConnectionDelegate.java:64)&lt;br/&gt;
     at org.apache.qpid.transport.ConnectionDelegate.handle(ConnectionDelegate.java:40)&lt;br/&gt;
     at org.apache.qpid.transport.MethodDelegate.executionException(MethodDelegate.java:110)&lt;br/&gt;
     at org.apache.qpid.transport.ExecutionException.dispatch(ExecutionException.java:112)&lt;br/&gt;
     at org.apache.qpid.transport.ConnectionDelegate.command(ConnectionDelegate.java:54)&lt;br/&gt;
     at org.apache.qpid.transport.ConnectionDelegate.command(ConnectionDelegate.java:40)&lt;br/&gt;
     at org.apache.qpid.transport.Method.delegate(Method.java:159)&lt;br/&gt;
     at org.apache.qpid.transport.Connection.received(Connection.java:369)&lt;br/&gt;
     at org.apache.qpid.transport.Connection.received(Connection.java:59)&lt;br/&gt;
     at org.apache.qpid.transport.network.Assembler.emit(Assembler.java:95)&lt;br/&gt;
     at org.apache.qpid.transport.network.Assembler.assemble(Assembler.java:196)&lt;br/&gt;
     at org.apache.qpid.transport.network.Assembler.frame(Assembler.java:129)&lt;br/&gt;
     at org.apache.qpid.transport.network.Frame.delegate(Frame.java:133)&lt;br/&gt;
     at org.apache.qpid.transport.network.Assembler.received(Assembler.java:100)&lt;br/&gt;
     at org.apache.qpid.transport.network.Assembler.received(Assembler.java:42)&lt;br/&gt;
     at org.apache.qpid.transport.network.InputHandler.next(InputHandler.java:187)&lt;br/&gt;
     at org.apache.qpid.transport.network.InputHandler.received(InputHandler.java:103)&lt;br/&gt;
     at org.apache.qpid.transport.network.InputHandler.received(InputHandler.java:42)&lt;br/&gt;
     at org.apache.qpid.transport.network.io.IoReceiver.run(IoReceiver.java:128)&lt;br/&gt;
     at java.lang.Thread.run(Thread.java:619)&lt;br/&gt;
  &quot;main&quot;:&lt;br/&gt;
     at org.apache.qpid.client.AMQSession_0_10.setCurrentException(AMQSession_0_10.java:1025)&lt;/li&gt;
	&lt;li&gt;waiting to lock&amp;lt;0x0000002ab7048d70&amp;gt;  (a java.lang.Object)&lt;br/&gt;
     at org.apache.qpid.client.BasicMessageConsumer_0_10.sendCancel(BasicMessageConsumer_0_10.java:193)&lt;br/&gt;
     at org.apache.qpid.client.BasicMessageConsumer.close(BasicMessageConsumer.java:573)&lt;/li&gt;
	&lt;li&gt;locked&amp;lt;0x0000002ab70156b0&amp;gt;  (a java.lang.Object)&lt;br/&gt;
     at org.apache.qpid.client.BasicMessageConsumer.close(BasicMessageConsumer.java:535)&lt;br/&gt;
     at org.apache.qpid.client.AMQQueueBrowser.close(AMQQueueBrowser.java:102)&lt;br/&gt;
     at org.apache.qpid.test.client.QueueBrowserAutoAckTest.testFailoverWithQueueBrowser(QueueBrowserAutoAckTest.java:501)&lt;br/&gt;
     at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
     at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
     at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
     at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
     at junit.framework.TestCase.runTest(TestCase.java:154)&lt;br/&gt;
     at junit.framework.TestCase.runBare(TestCase.java:127)&lt;br/&gt;
     at org.apache.qpid.test.utils.QpidBrokerTestCase.runBare(QpidBrokerTestCase.java:234)&lt;br/&gt;
     at junit.framework.TestResult$1.protect(TestResult.java:106)&lt;br/&gt;
     at junit.framework.TestResult.runProtected(TestResult.java:124)&lt;br/&gt;
     at junit.framework.TestResult.run(TestResult.java:109)&lt;br/&gt;
     at junit.framework.TestCase.run(TestCase.java:118)&lt;br/&gt;
     at org.apache.qpid.test.utils.QpidTestCase.run(QpidTestCase.java:120)&lt;br/&gt;
     at junit.framework.TestSuite.runTest(TestSuite.java:208)&lt;br/&gt;
     at junit.framework.TestSuite.run(TestSuite.java:203)&lt;br/&gt;
     at org.apache.tools.ant.taskdefs.optional.junit.JUnitTestRunner.run(JUnitTestRunner.java:297)&lt;br/&gt;
     at org.apache.tools.ant.taskdefs.optional.junit.JUnitTestRunner.launch(JUnitTestRunner.java:672)&lt;br/&gt;
     at org.apache.tools.ant.taskdefs.optional.junit.JUnitTestRunner.main(JUnitTestRunner.java:546)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;  Found 1 deadlock&lt;/p&gt;</description>
                <environment></environment>
        <key id="12504665">QPID-3214</key>
            <summary>Deadlock between the failover mutex (in AMQConnection.java) and the current_exception_lock (in AMQSession.java)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rajith">Rajith Muditha Attapattu</assignee>
                                    <reporter username="rajith">Rajith Muditha Attapattu</reporter>
                        <labels>
                    </labels>
                <created>Tue, 19 Apr 2011 14:48:28 +0000</created>
                <updated>Tue, 14 Mar 2017 20:07:59 +0000</updated>
                            <resolved>Thu, 7 Jul 2011 02:31:55 +0000</resolved>
                                    <version>0.10</version>
                                    <fixVersion>0.11</fixVersion>
                                    <component>JMS AMQP 0-x</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13022101" author="gsim" created="Wed, 20 Apr 2011 13:04:15 +0000"  >&lt;p&gt;Suggested fix. This simply takes the call to connection.exceptionReceived() outside the scope of the current_exception_lock in the session.&lt;/p&gt;

&lt;p&gt;Holding the session lock over that call would not in any case prevent other sessions calling in on the connection, so its not clear what value there is in doing so.&lt;/p&gt;</comment>
                            <comment id="13022110" author="gsim" created="Wed, 20 Apr 2011 13:20:22 +0000"  >&lt;p&gt;AMQSession_0_10.java seems to be duplicating in part what the transport.Session is doing (i.e. holding exception). In the trace above the threads are each trying to set the current exception on the session to the same thing I believe. My suggested &apos;fix&apos; btw is a workaround of the deadlock only. It doesn&apos;t try to untangle the code.&lt;/p&gt;</comment>
                            <comment id="13022150" author="rajith" created="Wed, 20 Apr 2011 14:27:33 +0000"  >&lt;p&gt;I am actually keen to fix the exception handling part rather than addressing the deadlock directly.&lt;br/&gt;
I agree with Gordon that the exception handling code could be improved a bit. &lt;br/&gt;
I am hoping to work out a patch soon.&lt;/p&gt;</comment>
                            <comment id="13022341" author="rajith" created="Wed, 20 Apr 2011 19:56:47 +0000"  >&lt;p&gt;After looking at the code, I believe the exception handling is not exactly correct.&lt;/p&gt;

&lt;p&gt;1. For starters we shouldn&apos;t really notify the connection&apos;s exception listener when there is a session level error. If we avoid that we can certainly get rid of the deadlock. The JMS API doc clearly states,&lt;br/&gt;
   &quot;If a JMS provider detects a serious problem with a Connection  object, it informs the Connection object&apos;s ExceptionListener, if one has been registered. It does this by calling the listener&apos;s onException method, passing it a JMSException argument describing the problem. &quot;&lt;/p&gt;

&lt;p&gt;  So certainly execution exceptions which only invalidates the session should not be notified via the exception listener.&lt;/p&gt;

&lt;p&gt;2. Going further if one looks at the AMQConnection.java exceptionReceived() method, it again looks wrong to me.&lt;br/&gt;
   It seems that an execution exception can in fact close the underlying connection (and the rest of the sessions) due to the following piece of logic.&lt;/p&gt;

&lt;p&gt;   if (hardError(cause))&lt;br/&gt;
   {&lt;br/&gt;
       closer = (!_closed.getAndSet(true)) || closer;&lt;/p&gt;
       {
            _logger.info(&quot;Closing AMQConnection due to :&quot; + cause);
       }
&lt;p&gt;   }&lt;/p&gt;

&lt;p&gt;   Digging further for any AMQException hardError method will return true.&lt;br/&gt;
   Therefore we need to rework that piece of code.&lt;/p&gt;

&lt;p&gt;3. The 0-10 code client (if using the Java IO transport) has a separate code path to notify the Connection if a connection level error is there.&lt;br/&gt;
   Therefore we definitely do not need to notify anything from the session.&lt;/p&gt;

&lt;p&gt;I believe the MINA transport notifies the IOException etc via the ProtocolSession, perhaps the reason for this code in the first place.&lt;br/&gt;
For now I believe we need to do two things.&lt;/p&gt;

&lt;p&gt;1. Remove the following line from AMQSession_0_10.setCurrentException(SessionException se) method &lt;br/&gt;
   _connection.exceptionReceived(amqe);&lt;/p&gt;

&lt;p&gt;2. Fix the AMQConnection.isHardError method and the AMQException.isHardError method.&lt;/p&gt;
</comment>
                            <comment id="13022399" author="rajith" created="Wed, 20 Apr 2011 22:15:03 +0000"  >&lt;p&gt;I used review board to post the patch just to get the hang of it.&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/642/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/642/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13028247" author="rajith" created="Tue, 3 May 2011 14:30:49 +0000"  >&lt;p&gt;Committed Gordon&apos;s suggested fix.&lt;br/&gt;
It seems for some situations the exception listener is the only way to get notified about a session exception.&lt;br/&gt;
However there was a bug which prevented exceptions being notified in some cases(see &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-3233&quot; title=&quot;In some cases the JMS Session does not get notified of the AMQP session closed, due to an execution exception received from the broker.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-3233&quot;&gt;&lt;del&gt;QPID-3233&lt;/del&gt;&lt;/a&gt;) and has since been fixed.&lt;br/&gt;
Therefore I believe Gordon&apos;s suggestion is probably the correct way to go.&lt;/p&gt;</comment>
                            <comment id="13061007" author="rajith" created="Thu, 7 Jul 2011 02:31:55 +0000"  >&lt;p&gt;Fixed. Test cases that were previously deadlocking due to this issue have been working properly since the fix was committed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12476886" name="QPID-3214.patch" size="704" author="gsim" created="Wed, 20 Apr 2011 13:04:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>68930</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 20 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0bniv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>65923</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>