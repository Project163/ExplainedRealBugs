<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:22:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[QPID-6784] Client may send frames that are too large and broker does wrong frame size validation for AMQP 0-91</title>
                <link>https://issues.apache.org/jira/browse/QPID-6784</link>
                <project id="12310520" key="QPID">Qpid</project>
                    <description>&lt;p&gt;The Client does not include the frame attributes (except for 1 byte) in its calculation of the AMQP Frame size thus creating frames which are 7 bytes too large. This happens in &lt;tt&gt;org.apache.qpid.client.BasicMessageProducer_0_8#calculateContentBodyFrameCount&lt;/tt&gt; and maybe other places.&lt;br/&gt;
The broker on the other end does an incorrect validation (in &lt;tt&gt;AMQDecoder#decodable&lt;/tt&gt; at least) where it does not take any of the attributes into account thus accepting too large frames.&lt;/p&gt;

&lt;p&gt;Besides not being compliant with the spec this causes problems in &lt;tt&gt;NonBlockingConnectionPlainDelegate#processData&lt;/tt&gt; where the frame does not fit into a single networkBuffer.&lt;/p&gt;

&lt;p&gt;I did not investigate other protocol versions.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12903791">QPID-6784</key>
            <summary>Client may send frames that are too large and broker does wrong frame size validation for AMQP 0-91</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kwall">Keith Wall</assignee>
                                    <reporter username="lorenz.quack">Lorenz Quack</reporter>
                        <labels>
                    </labels>
                <created>Fri, 9 Oct 2015 16:42:47 +0000</created>
                <updated>Fri, 16 Oct 2015 13:01:22 +0000</updated>
                            <resolved>Fri, 16 Oct 2015 13:01:15 +0000</resolved>
                                    <version>0.17</version>
                    <version>0.32</version>
                                    <fixVersion>qpid-java-6.0</fixVersion>
                                    <component>Broker-J</component>
                    <component>JMS AMQP 0-x</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14952002" author="rgodfrey" created="Sat, 10 Oct 2015 19:17:32 +0000"  >&lt;p&gt;The way frame &quot;size&quot; is defined in AMQP 0-8/9 is that it is not clear whether it includes the type (1 octet), channel (2 octets), size (4 octets) or frame-end (1 octet).  In 0-9-1 it was made explicit that these values should be included.&lt;/p&gt;

&lt;p&gt;As such from the perspective of the max frame size communicated on the wire, if the parties have agreed a max frame size of X then the maximal number of bytes sent would, indeed, be X+8 (I think we implemented sending on maximally X+7 because of an incompatibility with the C++ broker). &lt;/p&gt;

&lt;p&gt;If we want to ensure that we want to receive no more than S bytes in a single work unit, for AMQP 0-8/0-9 then the broker needs to send the &quot;max frame size&quot; it accepts as S-8 when it sends this value to the client.  For AMQP 0-9-1 it can use the value of S.&lt;/p&gt;</comment>
                            <comment id="14952798" author="lorenz.quack" created="Mon, 12 Oct 2015 08:21:33 +0000"  >&lt;p&gt;While you are right that 0-8 and 0-9 are not explicit in saying that the frame size includes the 1+2+4+1 bytes I have problems interpreting it in any other way.&lt;br/&gt;
Section 2.3.5 (0-9 spec) starts with &lt;blockquote&gt;&lt;p&gt;All frames consist of a header, a payload of arbitrary size and a &apos;frame-end&apos; octet &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&lt;/p&gt;&lt;/blockquote&gt;&lt;br/&gt;
I did not find any place where the notion that the header (and eof byte) is part of the frame is contradicted (e.g., the payload size is consistently referred to as payload size).&lt;/p&gt;

&lt;p&gt;I wonder what other implementations are doing.&lt;/p&gt;</comment>
                            <comment id="14952808" author="rgodfrey" created="Mon, 12 Oct 2015 08:28:07 +0000"  >&lt;p&gt;It depends on how you parse &quot;max frame size&quot;  ... It is possible to parse that as &quot;the maximum value the size field of the frame may take&quot;...  Certainly there was always confusion about whether the frame end octet was included.&lt;/p&gt;

&lt;p&gt;I think that the only viable approach for the code from now on is to be lax(ish) in accepting frames that are max frame size + 8 bytes, while only sending frames where the total size including 7 octet header and 1 octet frame end marker does not exceed the agreed max frame size.&lt;/p&gt;

&lt;p&gt;Anything else will lead to interop issues with any client which took a different interpretation (including our own client by the sounds of it).&lt;/p&gt;</comment>
                            <comment id="14952845" author="lorenz.quack" created="Mon, 12 Oct 2015 09:24:29 +0000"  >&lt;p&gt;Considering the parameter name in 0-9 for this is &quot;frame-max&quot; and not &quot;frame-size-max&quot; I find this interpretation very dubious but okay... I&apos;m going to back of.&lt;br/&gt;
In the spirit of being lenient about what you accept and strict about what you send I suggest the following:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;make sure the client is 0-9-1 compliant, i.e., including header and eof byte in the frame size calculation&lt;/li&gt;
	&lt;li&gt;keep the brokers current behaviour but change the default max frame size it negotiates to be 8 bytes smaller than the buffer size to avoid the problems in &lt;tt&gt;NonBlockingConnectionPlainDelegate#processData&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14953390" author="jira-bot" created="Mon, 12 Oct 2015 17:08:45 +0000"  >&lt;p&gt;Commit 1708165 from orudyy@apache.org in branch &apos;java/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1708165&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1708165&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-6784&quot; title=&quot;Client may send frames that are too large and broker does wrong frame size validation for AMQP 0-91&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-6784&quot;&gt;&lt;del&gt;QPID-6784&lt;/del&gt;&lt;/a&gt;: &lt;span class=&quot;error&quot;&gt;&amp;#91;Java Broker, Java Client&amp;#93;&lt;/span&gt; Fix max frame size related issue on AMQP 0-8/0-9-x&lt;/p&gt;

&lt;p&gt;           On client adopt 0-9-1 interpretation of max frame size which includes 7 headers bytes, payload size and 1 end of frame byte.&lt;br/&gt;
           On broker change default max frame size to fit over-sized frames from old clients into a single network buffer&lt;/p&gt;</comment>
                            <comment id="14958833" author="k-wall" created="Thu, 15 Oct 2015 12:40:05 +0000"  >&lt;p&gt;I think &lt;tt&gt;NBC._unexpectedByteBufferSizeUsed&lt;/tt&gt; needs to be volatile to avoid a publication issue.  NonBlockingConnections are run by any thread in the IO pools.  Also the name does not convey the purpose - should it not be _unexpectedByteBufferSizeReported?&lt;/p&gt;</comment>
                            <comment id="14960465" author="jira-bot" created="Fri, 16 Oct 2015 10:09:34 +0000"  >&lt;p&gt;Commit 1708945 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lorenz.quack&quot; class=&quot;user-hover&quot; rel=&quot;lorenz.quack&quot;&gt;lorenz.quack&lt;/a&gt; in branch &apos;java/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1708945&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1708945&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-6784&quot; title=&quot;Client may send frames that are too large and broker does wrong frame size validation for AMQP 0-91&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-6784&quot;&gt;&lt;del&gt;QPID-6784&lt;/del&gt;&lt;/a&gt;: &lt;span class=&quot;error&quot;&gt;&amp;#91;Java Broker&amp;#93;&lt;/span&gt; Make _unexpectedByteBufferSizeReported volatile to avoid publication issue.&lt;/p&gt;

&lt;p&gt;Addresses review comments from Keith Wall.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 5 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2mtrb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>