<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:20:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[QPID-1642] JMS ReceiveNowait does not return a message even if the queue is not empty</title>
                <link>https://issues.apache.org/jira/browse/QPID-1642</link>
                <project id="12310520" key="QPID">Qpid</project>
                    <description>&lt;p&gt;Description:&lt;br/&gt;
The first invocation of receiveNoWait does not return a message even if the queue is full. &lt;br/&gt;
How to replicate:&lt;br/&gt;
1) create a queue &lt;br/&gt;
2) send a message &lt;br/&gt;
3) try to consume this message using receiveNoWait &lt;br/&gt;
==&amp;gt; we get null even if there is a message seating in the queue &lt;br/&gt;
Solution:&lt;br/&gt;
When a JMS consumer first invokes receiveNowait then BasicMessageConsumer_0_10 request for more credits and then poll the _synchronousQueue. This does not leave enough time for the message to be enqueued. &lt;br/&gt;
One solution would be to query the queue size before allowing the credits: Something like that would work: &lt;br/&gt;
public Object getMessageFromQueue(long l) throws InterruptedException&lt;br/&gt;
    {&lt;br/&gt;
        long size = 0;&lt;br/&gt;
        if(l &amp;lt; 0)&lt;/p&gt;
        {
               size =  _0_10session.requestQueueDepth(getDestination()) ;
        }
&lt;p&gt;        if (isStrated() &amp;amp;&amp;amp; ! getSession().prefetch() &amp;amp;&amp;amp; _synchronousQueue.isEmpty())&lt;/p&gt;
        {
            _0_10session.getQpidSession().messageFlow(getConsumerTagString(),
                                                      MessageCreditUnit.MESSAGE, 1);
        }
&lt;p&gt;        if (! getSession().prefetch())&lt;/p&gt;
        {
            _syncReceive.set(true);
        }
&lt;p&gt;        Object o;// = super.getMessageFromQueue(l);&lt;br/&gt;
        if (l &amp;gt; 0)&lt;/p&gt;
         {
             o = _synchronousQueue.poll(l, TimeUnit.MILLISECONDS);
         }
&lt;p&gt;         else if (l &amp;lt; 0)&lt;br/&gt;
         {           &lt;br/&gt;
              if(size &amp;lt;= 0 )&lt;/p&gt;
              {
                 o = _synchronousQueue.poll();
              }
&lt;p&gt;              else&lt;/p&gt;
              {
                 o = _synchronousQueue.take();
              }
&lt;p&gt;         }&lt;br/&gt;
         else&lt;/p&gt;
         {
             o = _synchronousQueue.take();
         }
&lt;p&gt;        if (! getSession().prefetch())&lt;/p&gt;
        {
            _syncReceive.set(false);
        }
&lt;p&gt;        return o;&lt;br/&gt;
    }&lt;/p&gt;</description>
                <environment></environment>
        <key id="12414022">QPID-1642</key>
            <summary>JMS ReceiveNowait does not return a message even if the queue is not empty</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="arnaudsimon">Arnaud Simon</reporter>
                        <labels>
                    </labels>
                <created>Wed, 4 Feb 2009 18:15:07 +0000</created>
                <updated>Mon, 5 Sep 2011 21:51:09 +0000</updated>
                            <resolved>Mon, 5 Sep 2011 21:50:17 +0000</resolved>
                                    <version>M4</version>
                                    <fixVersion>JIRA Cleanup</fixVersion>
                                    <component>JMS AMQP 0-x</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12670393" author="arnaudsimon" created="Wed, 4 Feb 2009 18:15:47 +0000"  >&lt;p&gt;Can you validate the solution? &lt;/p&gt;</comment>
                            <comment id="12670399" author="arnaudsimon" created="Wed, 4 Feb 2009 18:27:22 +0000"  >&lt;p&gt;Actually we cannot do a take as the message may have been consumed by another consumer &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;br/&gt;
Maybe the solution would just be to poll with a small timeout that would let a chance for the message to be delivered. &lt;/p&gt;</comment>
                            <comment id="12672599" author="gsim" created="Wed, 11 Feb 2009 11:18:56 +0000"  >&lt;p&gt;Question: is the issue that the send in step (2) is asynchronous (i.e. the return from the send method does not imply the message is enqueued)? &lt;/p&gt;</comment>
                            <comment id="12676300" author="arnaudsimon" created="Tue, 24 Feb 2009 14:48:43 +0000"  >&lt;p&gt;no, the problem is that we need to know whether messages have been sent to the client after messageFlow returns. &lt;br/&gt;
I believe that a way to achieve that is to do something like &lt;/p&gt;

&lt;p&gt; _0_10session.getQpidSession().messageFlow(getConsumerTagString(),&lt;br/&gt;
                                                      MessageCreditUnit.MESSAGE, 1); &lt;br/&gt;
_0_10session.getQpidSession().messageFlush();&lt;br/&gt;
_0_10session.getQpidSession().sync();&lt;/p&gt;

&lt;p&gt;According to messageFlush definition:&lt;br/&gt;
&quot;Forces the sender to exhaust his credit supply. The sender&apos;s credit will always be zero when this command completes.&lt;br/&gt;
The command completes when immediately available message data has been transferred, or when the credit supply&lt;br/&gt;
is exhausted.&quot;&lt;br/&gt;
Once the sync ope returns potentially available messages will have been transfered and ready to consume form our local queue synchronousQueue &lt;/p&gt;

</comment>
                            <comment id="12698026" author="ritchiem" created="Sat, 11 Apr 2009 00:00:47 +0000"  >&lt;p&gt;Hi Rafi, is there any more work required?&lt;/p&gt;</comment>
                            <comment id="13097584" author="gemmellr" created="Mon, 5 Sep 2011 21:50:17 +0000"  >&lt;p&gt;Review-OK&apos;ing issue as part of JIRA cleanup. Issue could be resolved, but may not be: see &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-3469&quot; title=&quot;JIRA clean up for Java client/broker&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-3469&quot;&gt;&lt;del&gt;QPID-3469&lt;/del&gt;&lt;/a&gt; for further details.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>62420</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 11 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0blbb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>65565</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>