<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:19:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[QPID-572] broker delivers messages out of order</title>
                <link>https://issues.apache.org/jira/browse/QPID-572</link>
                <project id="12310520" key="QPID">Qpid</project>
                    <description>&lt;p&gt;ConcurrentSelectorDeliveryManager will sometimes deliver messages out of order. This is caused by the code in deliver(...) that attempts to short-circuit message queuing when there is an available subscription. This code can result in the currently published message skipping ahead of queued messages causing out of order delivery. Although unrelated to transactions, I have observed this failure occuring in TransactedTest both in testCommit and testRollback. Normally it does not happen very frequently, however placing a Thread.sleep(500) in the async delivery thread will cause the failure to occur almost all the time.&lt;/p&gt;

&lt;p&gt;I tried fixing the problem by only attempting synchronous delivery when there are no queued messages, however this appears to break other tests that use selectors. This makes me suspect that the selector implementation is somehow incorrectly coupled to synchronous delivery.&lt;/p&gt;

&lt;p&gt;I have only verfied this issue on the trunk, however I believe it effects M2 as well.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12377482">QPID-572</key>
            <summary>broker delivers messages out of order</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rgodfrey">Robert Godfrey</assignee>
                                    <reporter username="rhs">Rafael H. Schloming</reporter>
                        <labels>
                    </labels>
                <created>Tue, 4 Sep 2007 18:14:29 +0000</created>
                <updated>Wed, 11 Feb 2015 20:06:11 +0000</updated>
                            <resolved>Tue, 5 Aug 2008 16:18:04 +0000</resolved>
                                    <version>M2</version>
                    <version>M2.1</version>
                    <version>M3</version>
                                    <fixVersion>M3</fixVersion>
                                    <component>Broker-J</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12525726" author="ritchiem" created="Fri, 7 Sep 2007 14:39:53 +0000"  >&lt;p&gt;the nextSubscriber method used by the deliver(...) method MUST only return a subscriber that is ready and able to receive a message.&lt;br/&gt;
i.e. it is not suspended and there are no queued messages for that subscriber.&lt;/p&gt;

&lt;p&gt;The bug is that the SubscriptionImp only checks if it is queuing msgs when there is a filter in place. If there is no filter it doesn&apos;t check the main queue for messages. &lt;/p&gt;

&lt;p&gt;            if (!(subscription.isSuspended() || subscription.wouldSuspend(msg)))&lt;br/&gt;
            {&lt;br/&gt;
                if (subscription.hasInterest(msg))&lt;br/&gt;
                {&lt;br/&gt;
                    // if the queue is empty then this client is ready to receive a message.&lt;br/&gt;
                    //FIXME the queue could be full of sent messages.&lt;br/&gt;
                    // Either need to clean all PDQs after sending a message&lt;br/&gt;
                    // OR have a clean up thread that runs the PDQs expunging the messages.&lt;br/&gt;
&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;        if (!subscription.filtersMessages() || subscription.getPreDeliveryQueue().isEmpty())&lt;/p&gt;

&lt;p&gt;// Should be something like this:&lt;br/&gt;
/// if there is a filter does this subscription have any pending messages || if there are no messages pending(This method doesn&apos;t exist).&lt;br/&gt;
                    if ((subscription.filtersMessages() &amp;amp;&amp;amp; subscription.getPreDeliveryQueue().isEmpty() ) ||  subscription.getDeliveryQueue().isEmpty )&lt;/p&gt;
</comment>
                            <comment id="12525760" author="rhs" created="Fri, 7 Sep 2007 16:03:29 +0000"  >&lt;p&gt;As far as I can tell there is no Subscription.getDeliveryQueue() method.&lt;/p&gt;

&lt;p&gt;Also, I&apos;m unsure how message selectors are supposed to work for the async delivery path, and as I said above I&apos;m a bit concerned that turning of the synchronous delivery path caused selectors to break. Isn&apos;t it true that the synchronous delivery path is just an optimization? Where exactly is the message filtering performed for the asynchronous delivery path?&lt;/p&gt;</comment>
                            <comment id="12526031" author="rgreig" created="Sun, 9 Sep 2007 21:53:48 +0000"  >&lt;p&gt;Rafi, I have tried reproducing this. Hardware is a 4 way dual-core opteron box running RHEL 4. Java 6 update 2.&lt;/p&gt;

&lt;p&gt;I ran the tests several times without modifying the code and they all passed.&lt;/p&gt;

&lt;p&gt;I tried adding in a sleep (500) and the tests still passed. Maybe I didn&apos;t add the sleep to the right place? I added it to the ConcurrentSelectorDeliveryManager, to run run() method of the inner Runner class:&lt;/p&gt;

&lt;p&gt;       public void run()&lt;br/&gt;
        {&lt;br/&gt;
            boolean running = true;&lt;br/&gt;
            while (running &amp;amp;&amp;amp; !_movingMessages.get())&lt;br/&gt;
            {&lt;br/&gt;
                  try &lt;/p&gt;
{ Thread.sleep(500); }
&lt;p&gt; catch (Exception e) {}&lt;br/&gt;
                processQueue();&lt;/p&gt;

&lt;p&gt;Is that right? I haven&apos;t had much time to investigate the problem so I was really just trying to make the changes and run the tests a few times to see what happens.&lt;/p&gt;</comment>
                            <comment id="12526148" author="rhs" created="Mon, 10 Sep 2007 12:19:36 +0000"  >&lt;p&gt;That&apos;s what I did. With those steps it occurs consistently for me when running TransactedTest. Were you testing on the trunk or M2? If M2 then you could try the same steps on the trunk where the bug is known to exist. If it doesn&apos;t occur for you on the trunk then we know that it is a timing issue related to our different environments.&lt;/p&gt;

&lt;p&gt;It&apos;s possible that your extra cores are making the problem harder to reproduce since your consumer will be running on its own core. Reproducing the problem requires there to be messages backed up in the queue in order for the async delivery thread to be able to kick in. If your consuming thread has its own core, that may never happen. It may be that we need to rate limit the consumer in order to get the same effect on your machine. You could try putting an additional Thread.sleep() in dispatchMessage inside AMQSession.&lt;/p&gt;</comment>
                            <comment id="12526151" author="rgreig" created="Mon, 10 Sep 2007 12:28:15 +0000"  >&lt;p&gt;Ah of course I had forgotten that the async thread may never be invoked at all.&lt;/p&gt;

&lt;p&gt;I will put in the additional sleep then test against trunk if that still shows up &quot;clean&quot;.&lt;/p&gt;</comment>
                            <comment id="12526152" author="rgreig" created="Mon, 10 Sep 2007 12:33:51 +0000"  >&lt;p&gt;OK with a sleep in the dispatchMessage method it fails on M2 too.&lt;/p&gt;</comment>
                            <comment id="12526188" author="ritchiem" created="Mon, 10 Sep 2007 16:57:56 +0000"  >&lt;p&gt;I too managed to replicate the issue however I had to put a delay in of 1500s and therefore ensure that I upped the receive(...) methods in the TransactedTest. I also edited the TTest so that it used a local broker rather than inVM.&lt;/p&gt;

&lt;p&gt;I&apos;ll attach the patch that should address the issue. I haven&apos;t had time to fully test it so apologies if it doesn&apos;t do it. I haven&apos;t run the python tests but the only maven time test that failed was TopicSessionTest. but as usual running the test in Intelij works just fine.&lt;/p&gt;
</comment>
                            <comment id="12526191" author="rhs" created="Mon, 10 Sep 2007 17:07:53 +0000"  >&lt;p&gt;Hmm, interesting...&lt;/p&gt;

&lt;p&gt;That is almost the exact same as the fix I tried, however it seemed to cause quite a few failures when I tried it. In particular selectors no longer seemed to reliably work. I&apos;m in the middle of a few changes currently, however when my checkout is clean I&apos;ll try applying your patch and seeing if it works for me. My version of the fix was slightly different in that it didn&apos;t call nextSubscriber() at all if hasQueuedMessages() returned true, otherwise it was the same.&lt;/p&gt;</comment>
                            <comment id="12526370" author="ritchiem" created="Tue, 11 Sep 2007 07:04:18 +0000"  >&lt;p&gt;Ah, that would do it. as nextSubscriber() returns the next subscriber that is able to consume this message. This includes this test&lt;/p&gt;

&lt;p&gt;subscription.getPreDeliveryQueue().isEmpty()&lt;/p&gt;

&lt;p&gt;Which inessence is the selector. Hence why I suggested we needed the additional subscription.getDeliveryQueue().isEmpty() method. However, it makes more sence to put that check at the top level as it pertains to the queue as a whole. &lt;/p&gt;

&lt;p&gt;I need to write up how the selectors work but the short hand is that each message that is delivered is evaluated once against each selector using subscriber via subscriber.hasInterest() if they are interested then the msgs is added to a PreDelivery Queue that is unique to each subscriber. To prevent two subscribers getting the same message the message now has a notion of taken(). So the getNextMessage() method checks for this and simply removes any taken msgs when looking for the next message to send. Ideally we could have a reaper thread doing some of this but I haven&apos;t had time to design that as there are a number of other tasks such a reaper thread should do. TTL being one of them. One of my next tasks is to improve some of the technical documentation so I shall do the CSDM / selector work first to help review the selector changes.&lt;/p&gt;</comment>
                            <comment id="12526715" author="aidan" created="Wed, 12 Sep 2007 09:07:49 +0000"  >&lt;p&gt;patch to add a test case to cover this situation&lt;/p&gt;</comment>
                            <comment id="12527194" author="rhs" created="Thu, 13 Sep 2007 17:30:45 +0000"  >&lt;p&gt;I&apos;m now seeing the same failur on the M2 branch as I saw on the trunk when I tried the same fix originally. In particular I am now reliably seeing the following failure in TopicSessionTest:&lt;/p&gt;

&lt;p&gt;junit.framework.AssertionFailedError&lt;br/&gt;
        at junit.framework.Assert.fail(Assert.java:47)&lt;br/&gt;
        at junit.framework.Assert.assertTrue(Assert.java:20)&lt;br/&gt;
        at junit.framework.Assert.assertNotNull(Assert.java:220)&lt;br/&gt;
        at junit.framework.Assert.assertNotNull(Assert.java:213)&lt;br/&gt;
        at org.apache.qpid.test.unit.topic.TopicSessionTest.testNoLocal(TopicSessionTest.java:338)&lt;/p&gt;

&lt;p&gt;It occurs reliably when I run the full suite of client tests, however it does not occur when I run TopicSessionTest on its own. I believe this is because selectors do not function properly when there are messages queued for asynchronous delivery, and this change makes that situation more likely.&lt;/p&gt;</comment>
                            <comment id="12527624" author="rhs" created="Fri, 14 Sep 2007 20:31:41 +0000"  >&lt;p&gt;I believe the original fix for this issue is actually more correct than the modified fix, although the modified fix might be considered a reasonable M2 workaround for &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-601&quot; title=&quot;messages may be stranded when selectors are used&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-601&quot;&gt;&lt;del&gt;QPID-601&lt;/del&gt;&lt;/a&gt;. Please see my comments on &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-601&quot; title=&quot;messages may be stranded when selectors are used&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-601&quot;&gt;&lt;del&gt;QPID-601&lt;/del&gt;&lt;/a&gt; for details.&lt;/p&gt;</comment>
                            <comment id="12579380" author="ritchiem" created="Mon, 17 Mar 2008 10:25:29 +0000"  >&lt;p&gt;Rafi,&lt;/p&gt;

&lt;p&gt;Do you belive that the changes made has addressed this issue? &lt;/p&gt;

&lt;p&gt;Cheers&lt;/p&gt;</comment>
                            <comment id="12619944" author="rgodfrey" created="Tue, 5 Aug 2008 16:18:04 +0000"  >&lt;p&gt;Fixed by the refactoring which removed CSDM&lt;/p&gt;</comment>
                            <comment id="12621765" author="rgodfrey" created="Tue, 12 Aug 2008 10:36:23 +0000"  >&lt;p&gt;As described in &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-950&quot; title=&quot;Refactor Java Broker&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-950&quot;&gt;&lt;del&gt;QPID-950&lt;/del&gt;&lt;/a&gt;, the subscriber now uses a pointer to the strictly ordered queue and will only attempt delivery from the queue - it cannot be &quot;short-circuited&quot;.  On message arrival a fast-path is used if it is detected that the message would be the next one that a subscription would consider delivering.  See the description of &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-950&quot; title=&quot;Refactor Java Broker&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-950&quot;&gt;&lt;del&gt;QPID-950&lt;/del&gt;&lt;/a&gt; for an overview of the design of the new queuing model.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12394559">QPID-950</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12365622" name="QPID-572-testcase.patch" size="5644" author="aidan" created="Wed, 12 Sep 2007 09:07:49 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>167588</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            17 years, 15 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0bxjj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>67546</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>