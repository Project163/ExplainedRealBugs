<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:19:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[QPID-823] AMQP session Dispatcher threads still running after the session is closed </title>
                <link>https://issues.apache.org/jira/browse/QPID-823</link>
                <project id="12310520" key="QPID">Qpid</project>
                    <description></description>
                <environment></environment>
        <key id="12389877">QPID-823</key>
            <summary>AMQP session Dispatcher threads still running after the session is closed </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="arnaudsimon">Arnaud Simon</assignee>
                                    <reporter username="arnaudsimon">Arnaud Simon</reporter>
                        <labels>
                    </labels>
                <created>Fri, 29 Feb 2008 14:23:58 +0000</created>
                <updated>Tue, 14 Mar 2017 20:02:38 +0000</updated>
                            <resolved>Thu, 4 Dec 2008 11:28:33 +0000</resolved>
                                    <version>M3</version>
                                    <fixVersion>M4</fixVersion>
                                    <component>JMS AMQP 0-x</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12573763" author="arnaudsimon" created="Fri, 29 Feb 2008 14:30:00 +0000"  >&lt;p&gt;The dispatcher thread is closed before consumers are canceled. When  consumers are canceled a cancel ok message is received resulting in a new dispatcher thread  being created. A simple solution is to stop the dispatcher thread after consumers have been canceled (this has already been done in the M2 branch already).     &lt;/p&gt;</comment>
                            <comment id="12573773" author="rhs" created="Fri, 29 Feb 2008 15:00:10 +0000"  >&lt;p&gt;That fix is a good one to apply, however I believe there may still be at least a hypothetical issue with the current approach to stopping the dispatcher thread. In particular the general approach of using interrupts to stop the thread is rather fragile. I have further changes that make this process more robust by using a closeable queue rather than depending on interrupts to stop the thread.&lt;/p&gt;</comment>
                            <comment id="12573777" author="arnaudsimon" created="Fri, 29 Feb 2008 15:09:01 +0000"  >&lt;p&gt;yea, I agree with that, we should never use interrupt really but rather notify on the lock (_lock). &lt;/p&gt;</comment>
                            <comment id="12573778" author="rhs" created="Fri, 29 Feb 2008 15:11:16 +0000"  >&lt;p&gt;I&apos;ve also modified ConnectionCloseTest to check the number of threads created during iteration (it opens/closes about 1000 connections). This should prevent this bug from cropping up again.&lt;/p&gt;</comment>
                            <comment id="12574968" author="arnaudsimon" created="Tue, 4 Mar 2008 12:58:21 +0000"  >&lt;p&gt;I believe that we can close this JIRA. &lt;/p&gt;</comment>
                            <comment id="12577004" author="rhs" created="Mon, 10 Mar 2008 14:31:01 +0000"  >&lt;p&gt;I believe there are several issues in the dispatcher code that need to be rectified, so if we close this JIRA we should open at least one new one to cover these issues:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The dispatcher thread uses it&apos;s own _closed variable which shadows the session&apos;s. It&apos;s unclear why this is so, and at least some of the leaked dispatcher threads observed would have exited had the dispatcher code reference the session&apos;s closed variable rather than its own.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The fact that the dispatcher thread is instantiated on demand seems both unnecessary and accident prone. This is also responsible for some of the leaked threads observed, particularly in combination with the above issue where a dispatcher thread is created on demand after the session is closed.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The dispatcher object itself has code on it that would be better as private methods on the session. Because this code is on the dispatcher class, the dispatcher has to be re-instantiated just to call it. This was the cause of the leaked dispatcher threads as Arnaud describes above.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The code in confirmConsumerCancelled(...) that checks if the dispatcher is null and the starts it if necessary is not thread safe. This should either be synchronized, or eliminated entirely by not instantiating the dispatcher thread on demand and/or moving rejectPending(...) out to the session so it can be called without access to the dispatcher object.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;As mentioned above, interrupt() is not a safe way to shutdown the dispatcher thread. As coded it could at least hypothetically interrupt the application while it&apos;s in the middle of a message handler, and, by causing the thread to exit after removing a message from the queue, but prior to handling or releasing the message, it may cause the client to drop messages should have either been handled or released.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12653261" author="marnie" created="Thu, 4 Dec 2008 11:28:33 +0000"  >&lt;p&gt;Raising new JIRA as oer Rafi&apos;s comments&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12409945">QPID-1515</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>167812</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 51 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0bwkv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>67390</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>