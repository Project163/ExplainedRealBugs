<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:22:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[QPID-6672] Message dispatching after dispatcher close can cause thread to terminate with IllegalStateException</title>
                <link>https://issues.apache.org/jira/browse/QPID-6672</link>
                <project id="12310520" key="QPID">Qpid</project>
                    <description>&lt;p&gt;There is a race between the dispatcher thread and another thread closing a session.  In the unlucky case, the dispatcher thread can die with an ISE as below.&lt;/p&gt;

&lt;p&gt;The issue appears to be that the Dispatcher#close method does not await the shutdown for the dispatcher before returning, so the Dispatcher may run on for another iteration whilst the dispatcher reference has been nulled.&lt;/p&gt;

&lt;p&gt;This appears to be a longstanding issue (the fixme goes back to 2007) and is showing up now owing to r1693225, which makes uncaught exceptions fail the test.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2015-07-29 18:16:37,498         ERROR [Dispatcher-4-Conn-32] o.a.q.t.LoggingUncaughtExceptionHandler Uncaught exception in thread &quot;Dispatcher-4-Conn-32&quot;
java.lang.IllegalStateException: dispatcher is not started
	at org.apache.qpid.client.AMQSession.dispatch(AMQSession.java:3267) ~[qpid-client-6.0.0-SNAPSHOT.jar:na]
	at org.apache.qpid.client.message.UnprocessedMessage.dispatch(UnprocessedMessage.java:54) ~[qpid-client-6.0.0-SNAPSHOT.jar:na]
	at org.apache.qpid.client.AMQSession$Dispatcher.run(AMQSession.java:3408) ~[qpid-client-6.0.0-SNAPSHOT.jar:na]
	at java.lang.Thread.run(Thread.java:745) ~[na:1.7.0_67]

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment></environment>
        <key id="12850574">QPID-6672</key>
            <summary>Message dispatching after dispatcher close can cause thread to terminate with IllegalStateException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="orudyy">Alex Rudyy</assignee>
                                    <reporter username="kwall">Keith Wall</reporter>
                        <labels>
                    </labels>
                <created>Fri, 31 Jul 2015 11:35:57 +0000</created>
                <updated>Wed, 19 Aug 2015 10:55:49 +0000</updated>
                            <resolved>Wed, 19 Aug 2015 10:55:49 +0000</resolved>
                                                    <fixVersion>qpid-java-6.0</fixVersion>
                                    <component>JMS AMQP 0-x</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14695329" author="lorenz.quack" created="Thu, 13 Aug 2015 14:57:58 +0000"  >&lt;p&gt;Here is a patch for this issue.&lt;br/&gt;
TBH, I&apos;m not quite happy with it.&lt;br/&gt;
It should fix the IllegalStateException being thrown but opens the possibility for a RuntimeError being thrown instead &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
Problem continues to be a race between session.close and the dispatcher both synchronizing on the _messageDeliveryLock.&lt;br/&gt;
In the unlucky case a thread calls session.close() which acquires the _messageDeliveryLock but before setting the isClosed flag on the session the dispatcherThread tries to synchronize on the _messageDeliveryLock in Dispatcher#dispatchMessage().&lt;br/&gt;
    Obviously this will block and the await on the _closeCompleted latch in Dispatcher#close() will timeout throwing the RuntimeException.&lt;/p&gt;

&lt;p&gt;I&apos;ll look further into it but I wanted to publish my WIP.&lt;/p&gt;</comment>
                            <comment id="14697256" author="lorenz.quack" created="Fri, 14 Aug 2015 15:46:22 +0000"  >&lt;p&gt;This has some minor cleanups compared to the previous patch.&lt;br/&gt;
It still has the potential for RuntimeExceptions in case the _closeComplete latch timesout because the dispatcherThread is trying to synchronise on the messageDeliveryLock which is held be session#close.&lt;/p&gt;</comment>
                            <comment id="14697275" author="lorenz.quack" created="Fri, 14 Aug 2015 15:57:22 +0000"  >&lt;p&gt;This patch is a little bit more intrusive.&lt;br/&gt;
It removes the messageDeliveryLock.&lt;br/&gt;
On the upside the should resolve the issue of this JIRA without an RuntimeException being thrown because of lock contention (it can still be thrown if a dispatch takes a long time, but that is what the timeout is there for).&lt;br/&gt;
On the downside it is hard to reason about whether this introduce any new locking issues or race conditions (due to the messageDeliveryLock being gone).&lt;br/&gt;
Please thoroughly review.&lt;/p&gt;</comment>
                            <comment id="14699199" author="lorenz.quack" created="Mon, 17 Aug 2015 08:41:10 +0000"  >&lt;p&gt;fixed oversight in previous _v3 patch&lt;/p&gt;</comment>
                            <comment id="14701283" author="lorenz.quack" created="Tue, 18 Aug 2015 13:54:58 +0000"  >&lt;p&gt;Latest version of my patch.&lt;br/&gt;
This is build on *_v2 (e.g., it keeps the messageDeliveryLock)&lt;/p&gt;

&lt;p&gt;To fix the reported issue I converted the messageDeliveryLock into an explicit ReentrantLock. in Dispatcher#dispatchThread() we now tryLock() the messageDeliveryLock in a loop while checking whether the session is being closed. The rest of the locking semantic are untouched.&lt;/p&gt;

&lt;p&gt;This should fix the issue and not introduce new ones. The best of both worlds.&lt;/p&gt;

&lt;p&gt;Please review.&lt;/p&gt;</comment>
                            <comment id="14702750" author="lorenz.quack" created="Wed, 19 Aug 2015 09:20:21 +0000"  >&lt;p&gt;Use fair reentrant lock.&lt;/p&gt;</comment>
                            <comment id="14702843" author="jira-bot" created="Wed, 19 Aug 2015 10:46:00 +0000"  >&lt;p&gt;Commit 1696553 from orudyy@apache.org in branch &apos;java/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1696553&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1696553&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-6672&quot; title=&quot;Message dispatching after dispatcher close can cause thread to terminate with IllegalStateException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-6672&quot;&gt;&lt;del&gt;QPID-6672&lt;/del&gt;&lt;/a&gt;: &lt;span class=&quot;error&quot;&gt;&amp;#91;Java Client&amp;#93;&lt;/span&gt; Message dispatching after dispatcher close can cause thread to terminate with IllegalStateException.&lt;/p&gt;

&lt;p&gt;work by Lorenz Quack &amp;lt;quack.lorenz@gmail.com&amp;gt;&lt;/p&gt;</comment>
                            <comment id="14702848" author="alex.rufous" created="Wed, 19 Aug 2015 10:55:49 +0000"  >&lt;p&gt;Reviewed and committed patch provided by Lorenz with no comments&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12750295" name="0001-QPID-6672-Java-Client-Message-dispatching-after-disp.patch" size="6664" author="lorenz.quack" created="Thu, 13 Aug 2015 14:57:58 +0000"/>
                            <attachment id="12750531" name="0001-QPID-6672-Java-Client-Message-dispatching-after-disp_v2.patch" size="10202" author="lorenz.quack" created="Fri, 14 Aug 2015 15:46:22 +0000"/>
                            <attachment id="12750773" name="0001-QPID-6672-Java-Client-Message-dispatching-after-disp_v3.patch" size="15439" author="lorenz.quack" created="Mon, 17 Aug 2015 08:41:10 +0000"/>
                            <attachment id="12751247" name="0001-QPID-6672-Java-Client-Message-dispatching-after-disp_v4.patch" size="14813" author="lorenz.quack" created="Wed, 19 Aug 2015 09:20:21 +0000"/>
                            <attachment id="12751038" name="0001-QPID-6672-Java-Client-Message-dispatching-after-disp_v4.patch" size="14521" author="lorenz.quack" created="Tue, 18 Aug 2015 13:54:58 +0000"/>
                            <attachment id="12748158" name="TEST-org.apache.qpid.test.unit.transacted.TransactionTimeoutTest.testConsumerIdleRollback.txt" size="179483" author="kwall" created="Fri, 31 Jul 2015 11:37:18 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 13 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2i6dz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>