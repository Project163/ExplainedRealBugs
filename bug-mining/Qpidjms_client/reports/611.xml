<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:23:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[QPID-7237] Excessive threads creation when suspending/resuming flow</title>
                <link>https://issues.apache.org/jira/browse/QPID-7237</link>
                <project id="12310520" key="QPID">Qpid</project>
                    <description>&lt;p&gt;In high load situations, with a NO_ACKNOWLEDGE session, it is possible for the client to create an excessive amount of threads to suspend/resume the channel.&lt;br/&gt;
I&apos;m providing a patch to avoid creating a new thread if the previous thread has not completed its operation. This patch appears to avoid the problem in our environment. Notice we are using version 0.24, but the code is the same in the latest version.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12963783">QPID-7237</key>
            <summary>Excessive threads creation when suspending/resuming flow</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kwall">Keith Wall</assignee>
                                    <reporter username="flavio">Flavio Pellanda</reporter>
                        <labels>
                    </labels>
                <created>Fri, 29 Apr 2016 07:54:00 +0000</created>
                <updated>Wed, 2 Oct 2019 19:22:07 +0000</updated>
                            <resolved>Thu, 12 May 2016 07:27:20 +0000</resolved>
                                    <version>0.24</version>
                    <version>qpid-java-6.0.2</version>
                                    <fixVersion>qpid-java-6.0.3</fixVersion>
                    <fixVersion>qpid-java-6.1</fixVersion>
                                    <component>JMS AMQP 0-x</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15263713" author="flavio" created="Fri, 29 Apr 2016 07:58:47 +0000"  >&lt;p&gt;This is somewhat connected to &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-1084&quot; title=&quot;[Java Client] Race condition suspending channel in no-ack flow control situations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-1084&quot;&gt;&lt;del&gt;QPID-1084&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15266788" author="k-wall" created="Mon, 2 May 2016 15:29:02 +0000"  >&lt;p&gt;Thanks for the contribution, Flavio.  I hope to have time to take a look later on this week.&lt;/p&gt;</comment>
                            <comment id="15276145" author="jira-bot" created="Mon, 9 May 2016 09:20:08 +0000"  >&lt;p&gt;Commit 1742900 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kwall&quot; class=&quot;user-hover&quot; rel=&quot;kwall&quot;&gt;kwall&lt;/a&gt; in branch &apos;java/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1742900&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1742900&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-7237&quot; title=&quot;Excessive threads creation when suspending/resuming flow&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-7237&quot;&gt;&lt;del&gt;QPID-7237&lt;/del&gt;&lt;/a&gt;: &lt;span class=&quot;error&quot;&gt;&amp;#91;Java Client&amp;#93;&lt;/span&gt; Use single thread thread-pool to perform flow control on no-ack sessions&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Avoids spawning new thread for each state change&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15276149" author="k-wall" created="Mon, 9 May 2016 09:22:56 +0000"  >&lt;p&gt;Flavio, I changed the code to use a thread pool rather than spawning new threads.  I think this should resolve your problem.  Would you mind testing the change from trunk and confirming?&lt;/p&gt;</comment>
                            <comment id="15276214" author="flavio" created="Mon, 9 May 2016 10:44:52 +0000"  >&lt;p&gt;Keith, unfortunately I had this behavior only in the production environment, where I can&apos;t take the risk to test the new implementation.&lt;/p&gt;

&lt;p&gt;I reviewed your proposal, and I agree it would avoid the error I got after the client spawned over 8k threads. However, in the situation I observed, it would create tasks in the executor service queue, which might get out of control anyway - and filling the heap rather than exhausting the available threads, so the likelihood of this happening is quite lower.&lt;/p&gt;</comment>
                            <comment id="15279833" author="k-wall" created="Wed, 11 May 2016 09:11:19 +0000"  >&lt;p&gt;Flavio,&lt;/p&gt;

&lt;p&gt;For the number of threads created to be excessive, I think you must be creating the NO_ACK session using JMS&apos;s default &lt;tt&gt;javax.jms.Connection#createSession(boolean, int)&lt;/tt&gt;.  When created in this way, the high and low watermarks of the underlying queue get set to the same value (default 500).  Having the two values set the same makes the &lt;tt&gt;FlowControlBlockingQueue&lt;/tt&gt; rapid oscillate the flow control state - causing the stream of threads.  If you use &lt;tt&gt;org.apache.qpid.jms.Connection#createSession(boolean, int, int, int)&lt;/tt&gt; instead, and set the low value sensibly e.g. &lt;tt&gt;org.apache.qpid.jms.Connection#createSession(false, org.apache.qpid.jms.Session#NO_ACKNOWLEDGE, 500, 250)&lt;/tt&gt;  , you should be able to achieve more efficient elastic behaviour with far fewer transitions.  This approach will work with the releases as they stands today.&lt;/p&gt;
</comment>
                            <comment id="15280233" author="jira-bot" created="Wed, 11 May 2016 14:39:30 +0000"  >&lt;p&gt;Commit 1743383 from orudyy@apache.org in branch &apos;java/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1743383&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1743383&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-7237&quot; title=&quot;Excessive threads creation when suspending/resuming flow&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-7237&quot;&gt;&lt;del&gt;QPID-7237&lt;/del&gt;&lt;/a&gt;: Coalesce flow control tasks for no-ack sessions and change the lower prefetch threshold to be half of upper prefetch threshold when the same values for thresholds are specified&lt;/p&gt;</comment>
                            <comment id="15280265" author="jira-bot" created="Wed, 11 May 2016 15:11:02 +0000"  >&lt;p&gt;Commit 1743387 from orudyy@apache.org in branch &apos;java/branches/6.0.x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1743387&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1743387&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-7237&quot; title=&quot;Excessive threads creation when suspending/resuming flow&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-7237&quot;&gt;&lt;del&gt;QPID-7237&lt;/del&gt;&lt;/a&gt;: &lt;span class=&quot;error&quot;&gt;&amp;#91;Java Client&amp;#93;&lt;/span&gt; Use single thread thread-pool to perform flow control on no-ack sessions&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Avoids spawning new thread for each state change&lt;/li&gt;
	&lt;li&gt;Coalesce flow control tasks for no-ack sessions&lt;/li&gt;
	&lt;li&gt;Change the lower prefetch threshold to be half of upper prefetch threshold when the same values for thresholds are specified&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;merged from trunk using&lt;br/&gt;
svn merge -c 1742900,1743383  ^/qpid/java/trunk&lt;/p&gt;</comment>
                            <comment id="15281279" author="k-wall" created="Thu, 12 May 2016 07:27:12 +0000"  >&lt;p&gt;Alex and I paired on these changes.  Confirmed merged to 6.0.3.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12801415" name="QPID-7237.patch" size="10326" author="flavio" created="Fri, 29 Apr 2016 07:54:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 27 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2wybr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>