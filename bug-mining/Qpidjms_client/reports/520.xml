<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:22:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[QPID-5050] Clients calling Connection#stop() (or #close()) from within an ExceptionListener have potential for deadlock</title>
                <link>https://issues.apache.org/jira/browse/QPID-5050</link>
                <project id="12310520" key="QPID">Qpid</project>
                    <description>&lt;p&gt;A deadlock possibility exists for client applications calling Connection#stop within an application owned ExceptionListener.&lt;/p&gt;

&lt;p&gt;Unfortunately a common messaging framework (Spring), installs such a ExceptionListener.&lt;/p&gt;

&lt;p&gt;In a recent support call, such a deadlock had occurred between the dispatcher thread (whose onMessage was in the process of creating a session) and a pooled thread bouncing a message back to the application. (The bounced messages is returned to the application via the exception listener).&lt;/p&gt;

&lt;p&gt;The deadlock involves the Dispatcher._lock and AMQConnection._failoverMutex.&lt;/p&gt;

&lt;p&gt;The deadlock was reproduced with a system test (attached to Jira) and deadlock captured with jstack -l &amp;lt;pid&amp;gt; (output below).&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Dispatcher-1-Conn-4                  pool-8-thread-1
 + acquires c888 (Dispatcher#_lock)    + acquires ca68 (AMQConnection#_failoverMutex)
 + tries to acquire ca68               + tries to acquire c888
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;



&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Found one Java-level deadlock:
=============================
&quot;pool-8-thread-1&quot;:
  waiting to lock monitor 0x000000005b0d3560 (object 0x00000000f70bc888, a java.lang.Object),
  which is held by &quot;Dispatcher-1-Conn-4&quot;
&quot;Dispatcher-1-Conn-4&quot;:
  waiting to lock monitor 0x000000005b187308 (object 0x00000000f70bca68, a java.lang.Object),
  which is held by &quot;pool-8-thread-1&quot;

Java stack information for the threads listed above:
===================================================
&quot;pool-8-thread-1&quot;:
        at org.apache.qpid.client.AMQSession$Dispatcher.setConnectionStopped(AMQSession.java:3276)
        - waiting to lock &amp;lt;0x00000000f70bc888&amp;gt; (a java.lang.Object)
        at org.apache.qpid.client.AMQSession.stop(AMQSession.java:2382)
        at org.apache.qpid.client.AMQConnection.stop(AMQConnection.java:835)
        at org.apache.qpid.test.unit.client.connection.ExceptionListenerTest$4.onException(ExceptionListenerTest.java:206)
        at org.apache.qpid.client.AMQConnection.exceptionReceived(AMQConnection.java:1329)
        - locked &amp;lt;0x00000000f70bca68&amp;gt; (a java.lang.Object)
        at org.apache.qpid.client.AMQSession_0_8$4.run(AMQSession_0_8.java:600)
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
        at java.lang.Thread.run(Thread.java:662)
&quot;Dispatcher-1-Conn-4&quot;:
        at org.apache.qpid.client.AMQConnectionDelegate_8_0.executeRetrySupport(AMQConnectionDelegate_8_0.java:333)
        - waiting to lock &amp;lt;0x00000000f70bca68&amp;gt; (a java.lang.Object)
        at org.apache.qpid.client.AMQConnection.executeRetrySupport(AMQConnection.java:624)
        at org.apache.qpid.client.failover.FailoverRetrySupport.execute(FailoverRetrySupport.java:102)
        at org.apache.qpid.client.AMQSession.createProducerImpl(AMQSession.java:2600)
        at org.apache.qpid.client.AMQSession.createProducer(AMQSession.java:1176)
        at org.apache.qpid.client.AMQSession.createProducer(AMQSession.java:98)
        at org.apache.qpid.test.unit.client.connection.ExceptionListenerTest$5.onMessage(ExceptionListenerTest.java:229)
        at org.apache.qpid.client.BasicMessageConsumer.notifyMessage(BasicMessageConsumer.java:744)
        at org.apache.qpid.client.BasicMessageConsumer.notifyMessage(BasicMessageConsumer.java:718)
        at org.apache.qpid.client.AMQSession$Dispatcher.notifyConsumer(AMQSession.java:3388)
        at org.apache.qpid.client.AMQSession$Dispatcher.dispatchMessage(AMQSession.java:3327)
        - locked &amp;lt;0x00000000f71747e0&amp;gt; (a java.lang.Object)
        - locked &amp;lt;0x00000000f70bc888&amp;gt; (a java.lang.Object)
        at org.apache.qpid.client.AMQSession$Dispatcher.access$900(AMQSession.java:3114)
        at org.apache.qpid.client.AMQSession.dispatch(AMQSession.java:3107)
        at org.apache.qpid.client.message.UnprocessedMessage.dispatch(UnprocessedMessage.java:54)
        at org.apache.qpid.client.AMQSession$Dispatcher.run(AMQSession.java:3250)
        at java.lang.Thread.run(Thread.java:662)

Found 1 deadlock.

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;



</description>
                <environment></environment>
        <key id="12662412">QPID-5050</key>
            <summary>Clients calling Connection#stop() (or #close()) from within an ExceptionListener have potential for deadlock</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kwall">Keith Wall</assignee>
                                    <reporter username="kwall">Keith Wall</reporter>
                        <labels>
                    </labels>
                <created>Wed, 7 Aug 2013 15:51:53 +0000</created>
                <updated>Wed, 2 Oct 2019 19:21:35 +0000</updated>
                            <resolved>Fri, 16 Aug 2013 12:47:57 +0000</resolved>
                                    <version>0.8</version>
                    <version>0.10</version>
                    <version>0.12</version>
                    <version>0.14</version>
                    <version>0.16</version>
                    <version>0.18</version>
                    <version>0.20</version>
                    <version>0.22</version>
                                    <fixVersion>0.25</fixVersion>
                                    <component>JMS AMQP 0-x</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13732115" author="k-wall" created="Wed, 7 Aug 2013 15:55:13 +0000"  >&lt;p&gt;I note that &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-2657&quot; title=&quot;Verify/correct error handling on client 0-10 codepath&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-2657&quot;&gt;&lt;del&gt;QPID-2657&lt;/del&gt;&lt;/a&gt; changed the behaviour of AMQConnection#exceptionReceived().  This jira changed the algorithm so that the failoverMutex is held &lt;b&gt;whilst&lt;/b&gt; the application&apos;s exception listener is invoked.  I can&apos;t see the justification for holding this lock whilst executing application owned code.    &lt;/p&gt;</comment>
                            <comment id="13738289" author="k-wall" created="Tue, 13 Aug 2013 14:29:37 +0000"  >&lt;p&gt;Hi Phil, I attach patch.  Could you review pls?&lt;/p&gt;</comment>
                            <comment id="13741143" author="philharveyonline" created="Thu, 15 Aug 2013 16:25:31 +0000"  >&lt;p&gt;The patch looks fine on the whole. Some non-essential things I&apos;d change:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;The comment on testExceptionListenerStopsConnection_IsAllowed (and arguably the name) is misleading because you actually expect connection.stop() to throw an exception. Similarly, the test should fail if this exception is not thrown.&lt;/li&gt;
	&lt;li&gt;As discussed, neither of us are certain whether it would be appropriate to commit the rather specific testExceptionListenerConnectionStopDeadlock test.
	&lt;ul&gt;
		&lt;li&gt;I&apos;m actually happy either way, with a slight preference for committing it (it does at least test that you can do JMS work inside both the message listener and the exception listener without anything blowing up, whether as a deadlock or not).&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13741144" author="philharveyonline" created="Thu, 15 Aug 2013 16:26:05 +0000"  >&lt;p&gt;Reviewed - see previous comment&lt;/p&gt;</comment>
                            <comment id="13742128" author="jira-bot" created="Fri, 16 Aug 2013 11:54:03 +0000"  >&lt;p&gt;Commit 1514664 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kwall&quot; class=&quot;user-hover&quot; rel=&quot;kwall&quot;&gt;kwall&lt;/a&gt; in branch &apos;qpid/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1514664&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1514664&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-5050&quot; title=&quot;Clients calling Connection#stop() (or #close()) from within an ExceptionListener have potential for deadlock&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-5050&quot;&gt;&lt;del&gt;QPID-5050&lt;/del&gt;&lt;/a&gt;: Move invocation of ExceptionListener to after the failoverMutex is released avoiding deadlock possibility&lt;/p&gt;

&lt;p&gt;Previously, the ExceptionListener was invoked whilst the failoverMutex was held, between the&lt;br/&gt;
two potential state changes (connection state change and session state change).&lt;/p&gt;

&lt;p&gt;This commit reorders the statements so that the ExceptionListner is fired after the failoverMutex&lt;br/&gt;
is released. It also means that the ExceptionListener is fired &lt;b&gt;after&lt;/b&gt; both connection/session&lt;br/&gt;
have undergone any state changes. The exceptionListener member is also made thread safe.&lt;/p&gt;</comment>
                            <comment id="13742166" author="k-wall" created="Fri, 16 Aug 2013 12:47:57 +0000"  >&lt;p&gt;Phil&apos;s review comments are addressed and patch applied.&lt;/p&gt;</comment>
                            <comment id="13905236" author="justi9" created="Wed, 19 Feb 2014 11:30:18 +0000"  >&lt;p&gt;Released in Qpid 0.26, &lt;a href=&quot;http://qpid.apache.org/releases/qpid-0.26/index.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://qpid.apache.org/releases/qpid-0.26/index.html&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12470070">QPID-2756</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12596814" name="0001-QPID-5050-Move-invocation-of-ExceptionListener-to-af.patch" size="17966" author="kwall" created="Thu, 8 Aug 2013 09:38:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>342416</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 39 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1n1wv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>342721</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>