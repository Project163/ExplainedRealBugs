<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:22:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[QPID-3575] session exceptions do not properly close connections, causing connections leak</title>
                <link>https://issues.apache.org/jira/browse/QPID-3575</link>
                <project id="12310520" key="QPID">Qpid</project>
                    <description>&lt;p&gt;Description of problem:&lt;br/&gt;
There is a connection leak as described below.&lt;/p&gt;

&lt;p&gt;A session level exception is designed to close the underlying connection (along with the other sessions). However this is not true as there are at least two scenarios leading in an orphaned connection that can&apos;t be further used&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; (along with any session created on it) but it can&apos;t be deleted.&lt;/p&gt;

&lt;p&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Once an exception is raised, the connection, a session created on it or a producer/consumer created on such a session can&apos;t be effectivelly used - any usage ends up in an exception like the connection would be closed.&lt;/p&gt;


&lt;p&gt;---------------&lt;br/&gt;
First scenario:&lt;br/&gt;
If qpid.declare_queues is set to false and an attempt to subscribe to a non-existing queue is made, an exception is raised and subsequent connection.close() method does not close the TCP connection at all.&lt;/p&gt;

&lt;p&gt;Steps to Reproduce:&lt;br/&gt;
1. Start a fresh qpid broker with auth=no - make sure no&lt;br/&gt;
&quot;some.unreal.destination&quot; queue is there&lt;br/&gt;
2. Run attached Java program TestQpidLeak.java&lt;br/&gt;
3. Do &lt;em&gt;not&lt;/em&gt; terminate it when a prompt appears in it&lt;br/&gt;
4. Run qpid-stat -c in parallel&lt;/p&gt;

&lt;p&gt;Actual results:&lt;br/&gt;
qpid-stat shows 10 connections made by the client and despite connection.close() has been called for each of them.&lt;/p&gt;

&lt;p&gt;Expected results:&lt;br/&gt;
qpid-stat does not show the 10 connections.&lt;/p&gt;


&lt;p&gt;---------------&lt;br/&gt;
Second scenario:&lt;br/&gt;
Try to send 500 messages into a queue with max-queue-count 10. Again, a session exception is raised, connection is attempted to be closed but with no impact.&lt;/p&gt;

&lt;p&gt;Steps to Reproduce:&lt;br/&gt;
1. Start a fresh qpid broker with auth=no&lt;br/&gt;
2. qpid-config add queue testQueue --max-queue-count 10&lt;br/&gt;
3. Run attached Java program QueueFull.java&lt;br/&gt;
3. Do &lt;em&gt;not&lt;/em&gt; terminate it when a prompt appears in it&lt;br/&gt;
4. Run qpid-stat -c in parallel&lt;/p&gt;

&lt;p&gt;Actual results:&lt;br/&gt;
qpid-stat shows 1 connection made by the client and despite connection.close() has been called.&lt;br/&gt;
Sometimes (using a slightly different Java program that I can&apos;t revoke) the invoking of connection.close() method in finally-block does not terminate.&lt;/p&gt;

&lt;p&gt;Expected results:&lt;br/&gt;
qpid-stat does not show the connection from the client.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12529866">QPID-3575</key>
            <summary>session exceptions do not properly close connections, causing connections leak</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rajith">Rajith Muditha Attapattu</assignee>
                                    <reporter username="pmoravec">Pavel Moravec</reporter>
                        <labels>
                            <label>exception-handling</label>
                    </labels>
                <created>Wed, 2 Nov 2011 14:36:22 +0000</created>
                <updated>Tue, 14 Mar 2017 20:12:49 +0000</updated>
                            <resolved>Wed, 12 Sep 2012 21:05:58 +0000</resolved>
                                    <version>0.10</version>
                    <version>0.12</version>
                    <version>0.13</version>
                                    <fixVersion>0.17</fixVersion>
                                    <component>JMS AMQP 0-x</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13142190" author="pmoravec" created="Wed, 2 Nov 2011 14:37:31 +0000"  >&lt;p&gt;reproducer program&lt;/p&gt;</comment>
                            <comment id="13142224" author="pmoravec" created="Wed, 2 Nov 2011 15:46:55 +0000"  >&lt;p&gt;Root cause of the bug:&lt;/p&gt;

&lt;p&gt;1) Due to the nonexisting queue disallowed to be created, exception&lt;br/&gt;
&quot;javax.jms.JMSException: Error registering consumer:&lt;br/&gt;
org.apache.qpid.AMQException .. Bind failed. No such queue: ..&quot; is thrown and&lt;br/&gt;
managed in AMQSession_0_10::setCurrentException and&lt;br/&gt;
AMQConnection::exceptionReceived is called.&lt;/p&gt;

&lt;p&gt;2) hardError called to the cause returns true, causing &lt;br/&gt;
closer = (!_closed.getAndSet(true)) || closer;&lt;br/&gt;
is called. This has two consequences: a) _closed is set to true and b)&lt;br/&gt;
closeAllSessions is called later on.&lt;/p&gt;

&lt;p&gt;3) Both a) and b) (even independently) sets _closed to true at the end.&lt;/p&gt;

&lt;p&gt;4) When connection.close() method is called, close(List&amp;lt;AMQSession&amp;gt; sessions,&lt;br/&gt;
long timeout) method evaluates the main if-statement to false end directly&lt;br/&gt;
finishes. While we need doClose(sessions, timeout); to be called.&lt;/p&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-3289&quot; title=&quot;Session exceptions should only be notified via the exception listener, if it cannot be thrown directly to the application.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-3289&quot;&gt;&lt;del&gt;QPID-3289&lt;/del&gt;&lt;/a&gt; and  &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-3234&quot; title=&quot;Exception handling logic is incorrect in AMQConnection.java&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-3234&quot;&gt;&lt;del&gt;QPID-3234&lt;/del&gt;&lt;/a&gt; refer to the core problem of session exceptions (which are soft&lt;br/&gt;
errors as per the spec) are still treated as hard errors.&lt;/p&gt;</comment>
                            <comment id="13143248" author="pmoravec" created="Thu, 3 Nov 2011 15:45:31 +0000"  >&lt;p&gt;Description of the issue rewritten after playing more around.&lt;/p&gt;</comment>
                            <comment id="13143251" author="pmoravec" created="Thu, 3 Nov 2011 15:46:58 +0000"  >&lt;p&gt;Java program for the second replication scenario&lt;/p&gt;</comment>
                            <comment id="13143909" author="k-wall" created="Fri, 4 Nov 2011 10:55:03 +0000"  >&lt;p&gt;I&apos;ve reproduced on release 0-10.  I confirm I can see this problem on 0-12 and 0-13.&lt;/p&gt;</comment>
                            <comment id="13147550" author="k-wall" created="Thu, 10 Nov 2011 08:24:52 +0000"  >&lt;p&gt;Alex and I spent some time looking at this issue.   We could not find a clean manner to arrange for the client to close the connection without introducing new race conditions and requiring some XA re-work.   It seems to us that the correct way to resolve this problem is to address &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-3234&quot; title=&quot;Exception handling logic is incorrect in AMQConnection.java&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-3234&quot;&gt;&lt;del&gt;QPID-3234&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13189703" author="pmoravec" created="Fri, 20 Jan 2012 09:16:46 +0000"  >&lt;p&gt;The patch proposed by Alex in &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-3234&quot; title=&quot;Exception handling logic is incorrect in AMQConnection.java&quot; class=&quot;issue-link&quot; data-issue-key=&quot;QPID-3234&quot;&gt;&lt;del&gt;QPID-3234&lt;/del&gt;&lt;/a&gt; resolves this JIRA halfly: session object is closed and can be re-created smoothly, but invoking connection.close(); raises exception &quot;Error closing session: org.apache.qpid.AMQException: ch=0 id=0 ExecutionException(errorCode=RESOURCE_LIMIT_EXCEEDED ..&quot; and the underlying TCP connection isn&apos;t closed.&lt;/p&gt;</comment>
                            <comment id="13268213" author="pmoravec" created="Fri, 4 May 2012 09:10:35 +0000"  >&lt;p&gt;A dirty workaround patch (jira-3575_workaround-patch.patch) that allows (under some further described changes in client&apos;s code - see below) proper closure of connection. The patch includes / is based on the patch proposed in &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-3234&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/QPID-3234&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;From black-box perspective, patch + client&apos;s code changes resolves the issue but I don&apos;t recommend the patch content to be put into upstream. As it 1) rather fixes already existing problem than prevents it (moreover doing so by a nasty way, changing privateness of a method) and 2) requires some changes in client&apos;s source code.&lt;/p&gt;

&lt;p&gt;-------&lt;br/&gt;
Code changes in client&apos;s application required:&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Once a session exception is raised and caught in application code, the session object needs to be re-created as follows:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;import org.apache.qpid.client.*; // required to be added due to session closure &lt;br/&gt;
.. &lt;br/&gt;
try { &lt;br/&gt;
    // do something that can raise a session exception - like sending a message to some full queue &lt;br/&gt;
} &lt;br/&gt;
catch (javax.jms.JMSException exp) { &lt;br/&gt;
    .. &lt;br/&gt;
    ((AMQSession) session).close(-1,false); // the session needs to be closed in this way; keep in mind this instance of the method (with two parameters) is not in JMS specification neither in usual qpid java client library&lt;br/&gt;
    session=connection.createSession( .. ); &lt;br/&gt;
    .. &lt;br/&gt;
} &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If all sessions are re-created as above (plus re-creating producers and consumers as well), then:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;no session or connection is stuck and no session or connection leak shall occur&lt;/li&gt;
	&lt;li&gt;the session shall be usable without a problem&lt;/li&gt;
	&lt;li&gt;the underlying TCP connection is operating all the time properly&lt;/li&gt;
	&lt;li&gt;other sessions established in parallel on the same connection are unaffected&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13454358" author="gemmellr" created="Wed, 12 Sep 2012 21:05:58 +0000"  >&lt;p&gt;Rajith committed changes to fix this JIRA for 0.18, so assigning and resolving.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12502169" name="QueueFull.java" size="1843" author="pmoravec" created="Thu, 3 Nov 2011 15:46:58 +0000"/>
                            <attachment id="12501969" name="TestQpidLeak.java" size="1863" author="pmoravec" created="Wed, 2 Nov 2011 14:37:31 +0000"/>
                            <attachment id="12525581" name="jira-3575_workaround-patch.patch" size="6249" author="pmoravec" created="Fri, 4 May 2012 09:10:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>215725</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 10 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0be5z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>64407</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>