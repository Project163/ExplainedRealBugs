{"url":"https://api.github.com/repos/python-poetry/poetry/issues/6329","repository_url":"https://api.github.com/repos/python-poetry/poetry","labels_url":"https://api.github.com/repos/python-poetry/poetry/issues/6329/labels{/name}","comments_url":"https://api.github.com/repos/python-poetry/poetry/issues/6329/comments","events_url":"https://api.github.com/repos/python-poetry/poetry/issues/6329/events","html_url":"https://github.com/python-poetry/poetry/issues/6329","id":1358788521,"node_id":"I_kwDOB1l16s5Q_Xep","number":6329,"title":"Git dependencies fail to clone with HTTPS->SSH `insteadOf` in git config","user":{"login":"ghost","id":10137,"node_id":"MDQ6VXNlcjEwMTM3","avatar_url":"https://avatars.githubusercontent.com/u/10137?v=4","gravatar_id":"","url":"https://api.github.com/users/ghost","html_url":"https://github.com/ghost","followers_url":"https://api.github.com/users/ghost/followers","following_url":"https://api.github.com/users/ghost/following{/other_user}","gists_url":"https://api.github.com/users/ghost/gists{/gist_id}","starred_url":"https://api.github.com/users/ghost/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ghost/subscriptions","organizations_url":"https://api.github.com/users/ghost/orgs","repos_url":"https://api.github.com/users/ghost/repos","events_url":"https://api.github.com/users/ghost/events{/privacy}","received_events_url":"https://api.github.com/users/ghost/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":851628021,"node_id":"MDU6TGFiZWw4NTE2MjgwMjE=","url":"https://api.github.com/repos/python-poetry/poetry/labels/kind/bug","name":"kind/bug","color":"f74a2a","default":false,"description":"Something isn't working as expected"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-09-01T12:43:20Z","updated_at":"2024-03-01T11:06:11Z","closed_at":"2022-09-14T21:20:05Z","author_association":"NONE","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\n  Hi there! Thank you for discovering and submitting an issue.\r\n\r\n  Before you submit this; let's make sure of a few things.\r\n  Please make sure the following boxes are ticked if they are correct.\r\n  If not, please try and fulfill these first.\r\n-->\r\n\r\n<!-- Checked checkbox should look like this: [x] -->\r\n- [x] I am on the [latest](https://github.com/python-poetry/poetry/releases/latest) Poetry version.\r\n- [x] I have searched the [issues](https://github.com/python-poetry/poetry/issues) of this repo and believe that this is not a duplicate.\r\n- [x] If an exception occurs when executing a command, I executed it again in debug mode (`-vvv` option).\r\n\r\n<!--\r\n  Once those are done, if you're able to fill in the following list with your information,\r\n  it'd be very helpful to whoever handles the issue.\r\n-->\r\n\r\n- **OS version and name**: Debian 11\r\n- **Poetry version**: 1.2.0\r\n- **Link of a [Gist](https://gist.github.com/) with the contents of your pyproject.toml file**: https://gist.github.com/nyuszika7h/da9d938a8043a58e175bfd9e09f8bf0d\r\n\r\n## Issue\r\n<!-- Now feel free to write your issue, but please be descriptive! Thanks again ğŸ™Œ â¤ï¸ -->\r\nI have the following in `~/.config/git/config`:\r\n```\r\n[url \"git@github.com:\"]\r\n        insteadOf = https://github.com/\r\n```\r\n\r\nPoetry 1.2.0 seems to have introduced a regression where this causes git clones to fail:\r\n```\r\nâ¯ poetry init -n\r\nâ¯ poetry add -vvv git+https://github.com/nyuszika7h/m3u8.git\r\nLoading configuration file /home/nyuszika7h/.config/pypoetry/config.toml\r\nCreating virtualenv test in /home/nyuszika7h/test/.venv\r\nUsing virtualenv: /home/nyuszika7h/test/.venv\r\n\r\n  Stack trace:\r\n\r\n  3  ~/.local/share/pypoetry/venv/lib/python3.10/site-packages/dulwich/client.py:1121 in fetch_pack\r\n      1119â”‚         with proto:\r\n      1120â”‚             try:\r\n    â†’ 1121â”‚                 refs, server_capabilities = read_pkt_refs(proto.read_pkt_seq())\r\n      1122â”‚             except HangupException:\r\n      1123â”‚                 raise _remote_error_from_stderr(stderr)\r\n\r\n  2  ~/.local/share/pypoetry/venv/lib/python3.10/site-packages/dulwich/client.py:240 in read_pkt_refs\r\n       238â”‚     refs = {}\r\n       239â”‚     # Receive refs from server\r\n    â†’  240â”‚     for pkt in pkt_seq:\r\n       241â”‚         (sha, ref) = pkt.rstrip(b\"\\n\").split(None, 1)\r\n       242â”‚         if sha == b\"ERR\":\r\n\r\n  1  ~/.local/share/pypoetry/venv/lib/python3.10/site-packages/dulwich/protocol.py:287 in read_pkt_seq\r\n      285â”‚             flush-pkt.\r\n      286â”‚         \"\"\"\r\n    â†’ 287â”‚         pkt = self.read_pkt_line()\r\n      288â”‚         while pkt:\r\n      289â”‚             yield pkt\r\n\r\n  HangupException\r\n\r\n  The remote server unexpectedly closed the connection.\r\n\r\n  at ~/.local/share/pypoetry/venv/lib/python3.10/site-packages/dulwich/protocol.py:232 in read_pkt_line\r\n      228â”‚\r\n      229â”‚         try:\r\n      230â”‚             sizestr = read(4)\r\n      231â”‚             if not sizestr:\r\n    â†’ 232â”‚                 raise HangupException()\r\n      233â”‚             size = int(sizestr, 16)\r\n      234â”‚             if size == 0:\r\n      235â”‚                 if self.report_activity:\r\n      236â”‚                     self.report_activity(4, \"read\")\r\n\r\nThe following error occurred when trying to handle this error:\r\n\r\n\r\n  Stack trace:\r\n\r\n  20  ~/.local/share/pypoetry/venv/lib/python3.10/site-packages/cleo/application.py:329 in run\r\n       327â”‚\r\n       328â”‚             try:\r\n     â†’ 329â”‚                 exit_code = self._run(io)\r\n       330â”‚             except Exception as e:\r\n       331â”‚                 if not self._catch_exceptions:\r\n\r\n  19  ~/.local/share/pypoetry/venv/lib/python3.10/site-packages/poetry/console/application.py:185 in _run\r\n       183â”‚         self._load_plugins(io)\r\n       184â”‚\r\n     â†’ 185â”‚         exit_code: int = super()._run(io)\r\n       186â”‚         return exit_code\r\n       187â”‚\r\n\r\n  18  ~/.local/share/pypoetry/venv/lib/python3.10/site-packages/cleo/application.py:423 in _run\r\n       421â”‚             io.input.set_stream(stream)\r\n       422â”‚\r\n     â†’ 423â”‚         exit_code = self._run_command(command, io)\r\n       424â”‚         self._running_command = None\r\n       425â”‚\r\n\r\n  17  ~/.local/share/pypoetry/venv/lib/python3.10/site-packages/cleo/application.py:465 in _run_command\r\n       463â”‚\r\n       464â”‚         if error is not None:\r\n     â†’ 465â”‚             raise error\r\n       466â”‚\r\n       467â”‚         return event.exit_code\r\n\r\n  16  ~/.local/share/pypoetry/venv/lib/python3.10/site-packages/cleo/application.py:449 in _run_command\r\n       447â”‚\r\n       448â”‚             if event.command_should_run():\r\n     â†’ 449â”‚                 exit_code = command.run(io)\r\n       450â”‚             else:\r\n       451â”‚                 exit_code = ConsoleCommandEvent.RETURN_CODE_DISABLED\r\n\r\n  15  ~/.local/share/pypoetry/venv/lib/python3.10/site-packages/cleo/commands/base_command.py:119 in run\r\n       117â”‚         io.input.validate()\r\n       118â”‚\r\n     â†’ 119â”‚         status_code = self.execute(io)\r\n       120â”‚\r\n       121â”‚         if status_code is None:\r\n\r\n  14  ~/.local/share/pypoetry/venv/lib/python3.10/site-packages/cleo/commands/command.py:83 in execute\r\n        81â”‚\r\n        82â”‚         try:\r\n     â†’  83â”‚             return self.handle()\r\n        84â”‚         except KeyboardInterrupt:\r\n        85â”‚             return 1\r\n\r\n  13  ~/.local/share/pypoetry/venv/lib/python3.10/site-packages/poetry/console/commands/add.py:154 in handle\r\n       152â”‚             return 0\r\n       153â”‚\r\n     â†’ 154â”‚         requirements = self._determine_requirements(\r\n       155â”‚             packages,\r\n       156â”‚             allow_prereleases=self.option(\"allow-prereleases\"),\r\n\r\n  12  ~/.local/share/pypoetry/venv/lib/python3.10/site-packages/poetry/console/commands/init.py:357 in _determine_requirements\r\n       355â”‚\r\n       356â”‚         result = []\r\n     â†’ 357â”‚         for requirement in self._parse_requirements(requires):\r\n       358â”‚             if \"git\" in requirement or \"url\" in requirement or \"path\" in requirement:\r\n       359â”‚                 result.append(requirement)\r\n\r\n  11  ~/.local/share/pypoetry/venv/lib/python3.10/site-packages/poetry/console/commands/init.py:416 in _parse_requirements\r\n       414â”‚             cwd = Path.cwd()\r\n       415â”‚\r\n     â†’ 416â”‚         return [\r\n       417â”‚             parse_dependency_specification(\r\n       418â”‚                 requirement=requirement,\r\n\r\n  10  ~/.local/share/pypoetry/venv/lib/python3.10/site-packages/poetry/console/commands/init.py:417 in <listcomp>\r\n       415â”‚\r\n       416â”‚         return [\r\n     â†’ 417â”‚             parse_dependency_specification(\r\n       418â”‚                 requirement=requirement,\r\n       419â”‚                 env=self.env if isinstance(self, EnvCommand) else None,\r\n\r\n   9  ~/.local/share/pypoetry/venv/lib/python3.10/site-packages/poetry/utils/dependency_specification.py:216 in parse_dependency_specification\r\n       214â”‚\r\n       215â”‚     specification = (\r\n     â†’ 216â”‚         _parse_dependency_specification_url(requirement, env=env)\r\n       217â”‚         or _parse_dependency_specification_path(requirement, cwd=cwd)\r\n       218â”‚         or _parse_dependency_specification_simple(requirement)\r\n\r\n   8  ~/.local/share/pypoetry/venv/lib/python3.10/site-packages/poetry/utils/dependency_specification.py:68 in _parse_dependency_specification_url\r\n        66â”‚\r\n        67â”‚     if url_parsed.scheme in [\"git+https\", \"git+ssh\"]:\r\n     â†’  68â”‚         return _parse_dependency_specification_git_url(requirement, env)\r\n        69â”‚\r\n        70â”‚     if url_parsed.scheme in [\"http\", \"https\"]:\r\n\r\n   7  ~/.local/share/pypoetry/venv/lib/python3.10/site-packages/poetry/utils/dependency_specification.py:49 in _parse_dependency_specification_git_url\r\n        47â”‚\r\n        48â”‚     source_root = env.path.joinpath(\"src\") if env else None\r\n     â†’  49â”‚     package = Provider.get_package_from_vcs(\r\n        50â”‚         \"git\",\r\n        51â”‚         url=url.url,\r\n\r\n   6  ~/.local/share/pypoetry/venv/lib/python3.10/site-packages/poetry/puzzle/provider.py:342 in get_package_from_vcs\r\n       340â”‚             raise ValueError(f\"Unsupported VCS dependency {vcs}\")\r\n       341â”‚\r\n     â†’ 342â”‚         return _get_package_from_git(\r\n       343â”‚             url=url,\r\n       344â”‚             branch=branch,\r\n\r\n   5  ~/.local/share/pypoetry/venv/lib/python3.10/site-packages/poetry/puzzle/provider.py:96 in _get_package_from_git\r\n        94â”‚     source_root: Path | None = None,\r\n        95â”‚ ) -> Package:\r\n     â†’  96â”‚     source = Git.clone(\r\n        97â”‚         url=url,\r\n        98â”‚         source_root=source_root,\r\n\r\n   4  ~/.local/share/pypoetry/venv/lib/python3.10/site-packages/poetry/vcs/git/backend.py:426 in clone\r\n       424â”‚         try:\r\n       425â”‚             if not cls.is_using_legacy_client():\r\n     â†’ 426â”‚                 local = cls._clone(url=url, refspec=refspec, target=target)\r\n       427â”‚                 cls._clone_submodules(repo=local)\r\n       428â”‚                 return local\r\n\r\n   3  ~/.local/share/pypoetry/venv/lib/python3.10/site-packages/poetry/vcs/git/backend.py:258 in _clone\r\n       256â”‚             local = Repo(str(target))\r\n       257â”‚\r\n     â†’ 258â”‚         remote_refs = cls._fetch_remote_refs(url=url, local=local)\r\n       259â”‚\r\n       260â”‚         logger.debug(\r\n\r\n   2  ~/.local/share/pypoetry/venv/lib/python3.10/site-packages/poetry/vcs/git/backend.py:201 in _fetch_remote_refs\r\n       199â”‚\r\n       200â”‚         with local:\r\n     â†’ 201â”‚             result: FetchPackResult = client.fetch(\r\n       202â”‚                 path,\r\n       203â”‚                 local,\r\n\r\n   1  ~/.local/share/pypoetry/venv/lib/python3.10/site-packages/dulwich/client.py:824 in fetch\r\n        822â”‚             f, commit, abort = target.object_store.add_pack()\r\n        823â”‚         try:\r\n     â†’  824â”‚             result = self.fetch_pack(\r\n        825â”‚                 path,\r\n        826â”‚                 determine_wants,\r\n\r\n  HangupException\r\n\r\n  ssh: Could not resolve hostname https: Name or service not known\r\n\r\n  at ~/.local/share/pypoetry/venv/lib/python3.10/site-packages/dulwich/client.py:1123 in fetch_pack\r\n      1119â”‚         with proto:\r\n      1120â”‚             try:\r\n      1121â”‚                 refs, server_capabilities = read_pkt_refs(proto.read_pkt_seq())\r\n      1122â”‚             except HangupException:\r\n    â†’ 1123â”‚                 raise _remote_error_from_stderr(stderr)\r\n      1124â”‚             (\r\n      1125â”‚                 negotiated_capabilities,\r\n      1126â”‚                 symrefs,\r\n      1127â”‚                 agent,\r\n```\r\n\r\nThis works fine, however:\r\n```\r\n[url \"ssh://git@github.com/\"]\r\n        insteadOf = https://github.com/\r\n```","closed_by":{"login":"mkniewallner","id":5970971,"node_id":"MDQ6VXNlcjU5NzA5NzE=","avatar_url":"https://avatars.githubusercontent.com/u/5970971?v=4","gravatar_id":"","url":"https://api.github.com/users/mkniewallner","html_url":"https://github.com/mkniewallner","followers_url":"https://api.github.com/users/mkniewallner/followers","following_url":"https://api.github.com/users/mkniewallner/following{/other_user}","gists_url":"https://api.github.com/users/mkniewallner/gists{/gist_id}","starred_url":"https://api.github.com/users/mkniewallner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mkniewallner/subscriptions","organizations_url":"https://api.github.com/users/mkniewallner/orgs","repos_url":"https://api.github.com/users/mkniewallner/repos","events_url":"https://api.github.com/users/mkniewallner/events{/privacy}","received_events_url":"https://api.github.com/users/mkniewallner/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python-poetry/poetry/issues/6329/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python-poetry/poetry/issues/6329/timeline","performed_via_github_app":null,"state_reason":"completed"}