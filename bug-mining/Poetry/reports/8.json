{"url":"https://api.github.com/repos/python-poetry/poetry/issues/603","repository_url":"https://api.github.com/repos/python-poetry/poetry","labels_url":"https://api.github.com/repos/python-poetry/poetry/issues/603/labels{/name}","comments_url":"https://api.github.com/repos/python-poetry/poetry/issues/603/comments","events_url":"https://api.github.com/repos/python-poetry/poetry/issues/603/events","html_url":"https://github.com/python-poetry/poetry/issues/603","id":378048547,"node_id":"MDU6SXNzdWUzNzgwNDg1NDc=","number":603,"title":"Building sdist is slow with wide exclude pattern","user":{"login":"Lothiraldan","id":243665,"node_id":"MDQ6VXNlcjI0MzY2NQ==","avatar_url":"https://avatars.githubusercontent.com/u/243665?v=4","gravatar_id":"","url":"https://api.github.com/users/Lothiraldan","html_url":"https://github.com/Lothiraldan","followers_url":"https://api.github.com/users/Lothiraldan/followers","following_url":"https://api.github.com/users/Lothiraldan/following{/other_user}","gists_url":"https://api.github.com/users/Lothiraldan/gists{/gist_id}","starred_url":"https://api.github.com/users/Lothiraldan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Lothiraldan/subscriptions","organizations_url":"https://api.github.com/users/Lothiraldan/orgs","repos_url":"https://api.github.com/users/Lothiraldan/repos","events_url":"https://api.github.com/users/Lothiraldan/events{/privacy}","received_events_url":"https://api.github.com/users/Lothiraldan/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":851628021,"node_id":"MDU6TGFiZWw4NTE2MjgwMjE=","url":"https://api.github.com/repos/python-poetry/poetry/labels/kind/bug","name":"kind/bug","color":"f74a2a","default":false,"description":"Something isn't working as expected"},{"id":851634863,"node_id":"MDU6TGFiZWw4NTE2MzQ4NjM=","url":"https://api.github.com/repos/python-poetry/poetry/labels/area/build-system","name":"area/build-system","color":"7e56c4","default":false,"description":"Related to PEP 517 packaging (see poetry-core)"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2018-11-06T21:51:08Z","updated_at":"2024-03-03T18:04:54Z","closed_at":"2018-11-08T03:32:41Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\n  Hi there! Thank you for wanting to make Poetry better.\r\n\r\n  Before you submit this; let's make sure of a few things.\r\n  Please make sure the following boxes are ticked if they are correct.\r\n  If not, please try and fulfill these first.\r\n-->\r\n\r\n<!-- Checked checkbox should look like this: [x] -->\r\n- [x] I have searched the [issues](https://github.com/sdispater/poetry/issues) of this repo and believe that this is not a duplicate.\r\n\r\n## Issue\r\n\r\nI'm working on a project with the following `pyproject.toml`: https://gist.github.com/Lothiraldan/2c0b5ce0171e8450490e3b493e7c2960 and I want to ship a React project inside my package.\r\n\r\nInclude and exclude are working great, far easier to configure than `MANIFEST.IN` IMHO.\r\n\r\nMy issue is that the builder code is walking all of the directories and for each file check that it's not in the excluded list. One of my exclude pattern is `\"balto/web_interfaces/balto_react/node_modules/**/*\"` which generates a lot of matching files. The length of the excluded file list is `28761` in my case.\r\n\r\nThis makes the following line https://github.com/sdispater/poetry/blob/master/poetry/masonry/builders/sdist.py#L281 quite slow. A build takes about 4 minutes on my laptop.\r\n\r\nHere is a `py-spy` dump of the process:\r\n```\r\nCollecting samples from 'pid: 31302' (python v3.6.6)\r\nTotal Samples 5100\r\nGIL: 0.00%, Active: 95.50%, Threads: 1\r\n\r\n  %Own   %Total  OwnTime  TotalTime  Function (filename:line)                                                                                                                                                        \r\n 38.00%  51.00%   10.55s    14.14s   __eq__ (4/python3.6/pathlib.py:736)\r\n 29.00%  93.00%    6.64s    24.87s   <listcomp> (/home/lothiraldan/.local/pipx/venvs/poetry/lib64/python3.6/site-packages/poetry/masonry/builders/sdist.py:281)\r\n 16.50%  16.50%    4.38s     4.38s   _cparts (4/python3.6/pathlib.py:728)\r\n  7.50%  11.00%    2.81s     3.65s   __eq__ (4/python3.6/pathlib.py:734)\r\n  1.50%   1.50%   0.015s    0.015s   run (/home/lothiraldan/.local/pipx/venvs/poetry/lib64/python3.6/site-packages/cleo/application.py:104)\r\n  1.00%   1.00%   0.130s    0.130s   _cparts (4/python3.6/pathlib.py:724)\r\n  1.00%   2.00%   0.315s    0.435s   __eq__ (4/python3.6/pathlib.py:733)\r\n  0.50%   0.50%   0.025s    0.035s   parse_parts (4/python3.6/pathlib.py:87)\r\n  0.50%   0.50%   0.165s    0.180s   wrapped (4/python3.6/pathlib.py:387)\r\n  0.00%   1.00%   0.000s    0.355s   find_packages (/home/lothiraldan/.local/pipx/venvs/poetry/lib64/python3.6/site-packages/poetry/masonry/builders/sdist.py:277)\r\n  0.00%   0.00%   0.030s    0.030s   _get_sep (4/python3.6/posixpath.py:45)\r\n  0.00%  94.00%   0.000s    25.36s   execute (/home/lothiraldan/.local/pipx/venvs/poetry/lib64/python3.6/site-packages/cleo/commands/command.py:107)\r\n  0.00%   0.00%   0.010s    0.075s   <listcomp> (/home/lothiraldan/.local/pipx/venvs/poetry/lib64/python3.6/site-packages/poetry/masonry/builders/sdist.py:276)\r\n  0.00%   0.00%   0.025s    0.025s   _select_from (4/python3.6/pathlib.py:529)\r\n  0.00%  94.00%   0.000s    25.36s   do_run (/home/lothiraldan/.local/pipx/venvs/poetry/lib64/python3.6/site-packages/cleo/application.py:197)\r\n  0.00%  94.00%   0.000s    25.36s   build (/home/lothiraldan/.local/pipx/venvs/poetry/lib64/python3.6/site-packages/poetry/masonry/builder.py:21)\r\n  0.00%  94.00%   0.000s    25.36s   do_run (/home/lothiraldan/.local/pipx/venvs/poetry/lib64/python3.6/site-packages/poetry/console/application.py:88)\r\n\r\nPress Control-C to quit, or ? for help.\r\n```\r\n\r\nI have some ideas about how to make it faster, I will send some patches if that's okay.","closed_by":{"login":"sdispater","id":555648,"node_id":"MDQ6VXNlcjU1NTY0OA==","avatar_url":"https://avatars.githubusercontent.com/u/555648?v=4","gravatar_id":"","url":"https://api.github.com/users/sdispater","html_url":"https://github.com/sdispater","followers_url":"https://api.github.com/users/sdispater/followers","following_url":"https://api.github.com/users/sdispater/following{/other_user}","gists_url":"https://api.github.com/users/sdispater/gists{/gist_id}","starred_url":"https://api.github.com/users/sdispater/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sdispater/subscriptions","organizations_url":"https://api.github.com/users/sdispater/orgs","repos_url":"https://api.github.com/users/sdispater/repos","events_url":"https://api.github.com/users/sdispater/events{/privacy}","received_events_url":"https://api.github.com/users/sdispater/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python-poetry/poetry/issues/603/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python-poetry/poetry/issues/603/timeline","performed_via_github_app":null,"state_reason":"completed"}