{"url":"https://api.github.com/repos/python-poetry/poetry/issues/4688","repository_url":"https://api.github.com/repos/python-poetry/poetry","labels_url":"https://api.github.com/repos/python-poetry/poetry/issues/4688/labels{/name}","comments_url":"https://api.github.com/repos/python-poetry/poetry/issues/4688/comments","events_url":"https://api.github.com/repos/python-poetry/poetry/issues/4688/events","html_url":"https://github.com/python-poetry/poetry/issues/4688","id":1039605622,"node_id":"I_kwDOB1l16s499x92","number":4688,"title":"\"Unable to find installation candidates for\" packages cached from a LegacyRepository (`/simple`)","user":{"login":"awilkins","id":368399,"node_id":"MDQ6VXNlcjM2ODM5OQ==","avatar_url":"https://avatars.githubusercontent.com/u/368399?v=4","gravatar_id":"","url":"https://api.github.com/users/awilkins","html_url":"https://github.com/awilkins","followers_url":"https://api.github.com/users/awilkins/followers","following_url":"https://api.github.com/users/awilkins/following{/other_user}","gists_url":"https://api.github.com/users/awilkins/gists{/gist_id}","starred_url":"https://api.github.com/users/awilkins/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/awilkins/subscriptions","organizations_url":"https://api.github.com/users/awilkins/orgs","repos_url":"https://api.github.com/users/awilkins/repos","events_url":"https://api.github.com/users/awilkins/events{/privacy}","received_events_url":"https://api.github.com/users/awilkins/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":851628021,"node_id":"MDU6TGFiZWw4NTE2MjgwMjE=","url":"https://api.github.com/repos/python-poetry/poetry/labels/kind/bug","name":"kind/bug","color":"f74a2a","default":false,"description":"Something isn't working as expected"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":11,"created_at":"2021-10-29T14:05:49Z","updated_at":"2024-03-02T14:03:46Z","closed_at":"2021-11-19T14:58:14Z","author_association":"NONE","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"- [X] I am on the [latest](https://github.com/python-poetry/poetry/releases/latest) Poetry version.\r\n- [X] I have searched the [issues](https://github.com/python-poetry/poetry/issues) of this repo and believe that this is not a duplicate.\r\n   - Caveat : I have insufficient detail to decide if #4679 is a dupe of this issue, but it is possible since it has similar symptoms\r\n- [X] If an exception occurs when executing a command, I executed it again in debug mode (`-vvv` option).\r\n\r\n- CodeBuild image `aws/codebuild/standard:5.0` (Ubuntu 20.04)\r\n- Poetry 1.1.11 : as installed by `pip`\r\n  - Yes, this is not the recommended way to install Poetry\r\n  - However, the recommended way ought to have the same issue (installs same version of `cachecontrol`, at present)\r\n  - Confirmed that using `install-poetry.py` on a fresh install reproduces this issue\r\n\r\n## Issue\r\n\r\nHave been debugging this inside a container based on `aws/codebuild/standard:5.0` (since this is the target build container for our CI pipelines).\r\n\r\nPipelines are installing poetry via `pip` and failing. Build works fine on my workstation, even after a `poetry self update`, which doesn't seem to update dependencies if they already meet the version constraints (like `pip`).\r\n\r\nAfter a fresh install of Poetry 1.1.11 via `install-poetry.py`, now also having similar issues (with different symptoms but I presume the same cause) locally.\r\n\r\nIssues are resolved by activating Poetry's venv and running\r\n\r\n```\r\npip install cachecontrol==0.12.6\r\n```\r\n\r\nThis only applies to packages installed (from a Nexus repo) via the `/simple` interface, which uses the LegacyRepository class.\r\n\r\n## Suspected issue\r\n\r\nWorking on a deeper diagnosis, but thought I'd get the bug report opened.\r\n\r\n`cachecontrol` released `0.12.7` as of 12 hours ago, clearly there is a bug or change in behaviour (aka - bug, for a patch version bump) that breaks Poetry for this use case.\r\n\r\nThe issue seems to be caching of the HTML metadata from the `/simple` type repo ; while the cache file on disk is successfully updated each time it is fetched, the cache-wrapped response object for the metadata returns an empty byte buffer to the program. This results in the `Page` object not finding any links and `get_links_for_package` failing.\r\n\r\nIn a tree with a lockfile and in an environment with an empty cache, this means you will be able to install that package once and once only - the first time caches the metadata, which then subsequently triggers this bug and prevents further access to the metadata. Sadly all my pipelines build multiple packages with common dependencies.\r\n\r\nNow going to look and see what the problem in `cachecontrol` is.\r\n\r\nMight I humbly suggest that as a tool which promotes stable builds ... that Poetry use some of it's own medicine to install itself, and use a lockfile or output of `pip freeze` to create a reproducible install for a given version. This is definitely not the first occasion on which a reproducible installation would have prevented issues - see #4523 and possibly also #4528\r\n\r\n## Terminal output\r\n\r\n```\r\nroot@d829437ec7b5:/home/src/python/account# poetry install -vvv\r\nDebug wait\r\nDebug attached\r\nUsing virtualenv: /root/.cache/pypoetry/virtualenvs/account-D8L0MJuz-py3.9\r\nInstalling dependencies from lock file\r\n\r\nFinding the necessary packages for the current system\r\n\r\nPackage operations: 45 installs, 0 updates, 0 removals, 2 skipped\r\n\r\n  • Removing importlib-metadata (4.8.1): Pending...\r\n  • Removing importlib-metadata (4.8.1): Skipped for the following reason: Not currently installed\r\n  • Removing zipp (3.5.1): Pending...\r\n  • Removing zipp (3.5.1): Skipped for the following reason: Not currently installed\r\n  • Installing six (1.16.0): Pending...\r\n  • Installing six (1.16.0): Failed\r\n\r\n  RuntimeError\r\n\r\n  Unable to find installation candidates for six (1.16.0)\r\n\r\n  at ~/.pyenv/versions/3.9.1/lib/python3.9/site-packages/poetry/installation/chooser.py:72 in choose_for\r\n       68│ \r\n       69│             links.append(link)\r\n       70│ \r\n       71│         if not links:\r\n    →  72│             raise RuntimeError(\r\n       73│                 \"Unable to find installation candidates for {}\".format(package)\r\n       74│             )\r\n       75│ \r\n       76│         # Get the best link\r\n```\r\n\r\nalso\r\n\r\n```\r\n❯ poetry update\r\nUpdating dependencies\r\nResolving dependencies... (0.8s)\r\n\r\n  PackageNotFound\r\n\r\n  Package six (1.16.0) not found.\r\n\r\n  at ~/.local/share/pypoetry/venv/lib/python3.9/site-packages/poetry/repositories/pool.py:149 in package\r\n      145│                     self._packages.append(package)\r\n      146│ \r\n      147│                     return package\r\n      148│ \r\n    → 149│         raise PackageNotFound(\"Package {} ({}) not found.\".format(name, version))\r\n      150│ \r\n      151│     def find_packages(\r\n      152│         self, dependency,\r\n      153│     ):\r\n```\r\n\r\n","closed_by":{"login":"neersighted","id":1049222,"node_id":"MDQ6VXNlcjEwNDkyMjI=","avatar_url":"https://avatars.githubusercontent.com/u/1049222?v=4","gravatar_id":"","url":"https://api.github.com/users/neersighted","html_url":"https://github.com/neersighted","followers_url":"https://api.github.com/users/neersighted/followers","following_url":"https://api.github.com/users/neersighted/following{/other_user}","gists_url":"https://api.github.com/users/neersighted/gists{/gist_id}","starred_url":"https://api.github.com/users/neersighted/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/neersighted/subscriptions","organizations_url":"https://api.github.com/users/neersighted/orgs","repos_url":"https://api.github.com/users/neersighted/repos","events_url":"https://api.github.com/users/neersighted/events{/privacy}","received_events_url":"https://api.github.com/users/neersighted/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python-poetry/poetry/issues/4688/reactions","total_count":9,"+1":9,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python-poetry/poetry/issues/4688/timeline","performed_via_github_app":null,"state_reason":"completed"}