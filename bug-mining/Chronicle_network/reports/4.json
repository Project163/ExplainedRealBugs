{"url":"https://api.github.com/repos/OpenHFT/Chronicle-Network/issues/17","repository_url":"https://api.github.com/repos/OpenHFT/Chronicle-Network","labels_url":"https://api.github.com/repos/OpenHFT/Chronicle-Network/issues/17/labels{/name}","comments_url":"https://api.github.com/repos/OpenHFT/Chronicle-Network/issues/17/comments","events_url":"https://api.github.com/repos/OpenHFT/Chronicle-Network/issues/17/events","html_url":"https://github.com/OpenHFT/Chronicle-Network/issues/17","id":260674040,"node_id":"MDU6SXNzdWUyNjA2NzQwNDA=","number":17,"title":"Add atomic VanillaNetworkContext.close() method to avoid race condition","user":{"login":"gordonbuntting","id":9048131,"node_id":"MDQ6VXNlcjkwNDgxMzE=","avatar_url":"https://avatars.githubusercontent.com/u/9048131?v=4","gravatar_id":"","url":"https://api.github.com/users/gordonbuntting","html_url":"https://github.com/gordonbuntting","followers_url":"https://api.github.com/users/gordonbuntting/followers","following_url":"https://api.github.com/users/gordonbuntting/following{/other_user}","gists_url":"https://api.github.com/users/gordonbuntting/gists{/gist_id}","starred_url":"https://api.github.com/users/gordonbuntting/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gordonbuntting/subscriptions","organizations_url":"https://api.github.com/users/gordonbuntting/orgs","repos_url":"https://api.github.com/users/gordonbuntting/repos","events_url":"https://api.github.com/users/gordonbuntting/events{/privacy}","received_events_url":"https://api.github.com/users/gordonbuntting/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-09-26T15:43:27Z","updated_at":"2017-09-28T19:59:39Z","closed_at":"2017-09-28T19:59:39Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I found a bug in this method exposed by occasional failure of FIX AcceptorInitiatorTest.testStartAndEndOfConnection()\r\n\r\nBasically both the main thread and the event-loop-thread of the client FixEngine would attempt to call FixNetworkContext.close() and in fact enter the method simultaneously owing to lack of mutex.  This would result in listener being notified twice and failing the test.\r\n\r\nI think making the FixNetworkContext.close() method synchronised as in the base class is dangerous because it invokes listeners that could potentially do something to deadlock.  And it would be better to avoid locks altogether.\r\n\r\nMy suggestion instead is to add a new VanillaNetworkContext.closeWithCAS() method to return boolean if state is actually changed (using AtomicBoolean member instead of volatile boolean).","closed_by":{"login":"gordonbuntting","id":9048131,"node_id":"MDQ6VXNlcjkwNDgxMzE=","avatar_url":"https://avatars.githubusercontent.com/u/9048131?v=4","gravatar_id":"","url":"https://api.github.com/users/gordonbuntting","html_url":"https://github.com/gordonbuntting","followers_url":"https://api.github.com/users/gordonbuntting/followers","following_url":"https://api.github.com/users/gordonbuntting/following{/other_user}","gists_url":"https://api.github.com/users/gordonbuntting/gists{/gist_id}","starred_url":"https://api.github.com/users/gordonbuntting/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gordonbuntting/subscriptions","organizations_url":"https://api.github.com/users/gordonbuntting/orgs","repos_url":"https://api.github.com/users/gordonbuntting/repos","events_url":"https://api.github.com/users/gordonbuntting/events{/privacy}","received_events_url":"https://api.github.com/users/gordonbuntting/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/OpenHFT/Chronicle-Network/issues/17/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/OpenHFT/Chronicle-Network/issues/17/timeline","performed_via_github_app":null,"state_reason":"completed"}