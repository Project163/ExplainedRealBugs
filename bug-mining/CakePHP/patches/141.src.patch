diff --git a/src/Command/PluginUnloadCommand.php b/src/Command/PluginUnloadCommand.php
index ae0ff085c1..da127913cb 100644
--- a/src/Command/PluginUnloadCommand.php
+++ b/src/Command/PluginUnloadCommand.php
@@ -70,7 +70,8 @@ class PluginUnloadCommand extends Command
      */
     protected function modifyApplication(string $app, string $plugin): bool
     {
-        $finder = "@\\\$this\-\>addPlugin\(\s*'$plugin'(.|.\n|)+\);+@";
+        $finder = "/\s*\\\$this\-\>addPlugin\(\s*['\"]{$plugin}['\"](\s*,[\s\\n]*\[(\\n.*|.*){0,5}\][\\n\s]*)?\);/m";
+        // $finder = "@\\\$this\-\>addPlugin\(\s*'$plugin'(.|.\n|)+\);+@";
 
         $content = file_get_contents($app);
         $newContent = preg_replace($finder, '', $content);
diff --git a/tests/TestCase/Command/PluginUnloadCommandTest.php b/tests/TestCase/Command/PluginUnloadCommandTest.php
index b535487b8a..4c2a86c504 100644
--- a/tests/TestCase/Command/PluginUnloadCommandTest.php
+++ b/tests/TestCase/Command/PluginUnloadCommandTest.php
@@ -76,10 +76,6 @@ class PluginUnloadCommandTest extends TestCase
         $plugin2 = "\$this->addPlugin('TestPluginTwo', ['bootstrap' => false, 'routes' => false]);";
         $this->addPluginToApp($plugin1);
         $this->addPluginToApp($plugin2);
-
-        $contents = file_get_contents($this->app);
-        $this->assertStringContainsString($plugin1, $contents);
-
         $this->exec('plugin unload TestPlugin');
 
         $this->assertExitCode(Command::CODE_SUCCESS);
@@ -89,6 +85,26 @@ class PluginUnloadCommandTest extends TestCase
         $this->assertStringContainsString($plugin2, $contents);
     }
 
+    /**
+     * test removing the first plugin leaves the second behind.
+     *
+     * @return void
+     */
+    public function testUnloadFirstPlugin()
+    {
+        $plugin1 = "\$this->addPlugin('TestPlugin');";
+        $plugin2 = "\$this->addPlugin('TestPluginTwo');";
+        $this->addPluginToApp($plugin1);
+        $this->addPluginToApp($plugin2);
+        $this->exec('plugin unload TestPluginTwo');
+
+        $this->assertExitCode(Command::CODE_SUCCESS);
+        $contents = file_get_contents($this->app);
+
+        $this->assertStringNotContainsString($plugin2, $contents);
+        $this->assertStringContainsString($plugin1, $contents);
+    }
+
     /**
      * Data provider for various forms.
      *
@@ -176,7 +192,7 @@ class PluginUnloadCommandTest extends TestCase
     protected function addPluginToApp($insert)
     {
         $contents = file_get_contents($this->app);
-        $contents = preg_replace('/(function bootstrap\(\)(?:\s*)\:(?:\s*)void(?:\s+)\{)/m', '$1' . $insert, $contents);
+        $contents = preg_replace('/(function bootstrap\(\)(?:\s*)\:(?:\s*)void(?:\s+)\{)/m', "\$1\n        " . $insert, $contents);
         file_put_contents($this->app, $contents);
     }
 }
