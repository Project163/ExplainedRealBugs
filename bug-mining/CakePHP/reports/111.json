{"url":"https://api.github.com/repos/cakephp/cakephp/issues/13543","repository_url":"https://api.github.com/repos/cakephp/cakephp","labels_url":"https://api.github.com/repos/cakephp/cakephp/issues/13543/labels{/name}","comments_url":"https://api.github.com/repos/cakephp/cakephp/issues/13543/comments","events_url":"https://api.github.com/repos/cakephp/cakephp/issues/13543/events","html_url":"https://github.com/cakephp/cakephp/issues/13543","id":482762653,"node_id":"MDU6SXNzdWU0ODI3NjI2NTM=","number":13543,"title":"3.x cookies in the Cake\\http\\client are copied from the wrong (sub)domain during redirects","user":{"login":"michielkeijts","id":3382730,"node_id":"MDQ6VXNlcjMzODI3MzA=","avatar_url":"https://avatars.githubusercontent.com/u/3382730?v=4","gravatar_id":"","url":"https://api.github.com/users/michielkeijts","html_url":"https://github.com/michielkeijts","followers_url":"https://api.github.com/users/michielkeijts/followers","following_url":"https://api.github.com/users/michielkeijts/following{/other_user}","gists_url":"https://api.github.com/users/michielkeijts/gists{/gist_id}","starred_url":"https://api.github.com/users/michielkeijts/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/michielkeijts/subscriptions","organizations_url":"https://api.github.com/users/michielkeijts/orgs","repos_url":"https://api.github.com/users/michielkeijts/repos","events_url":"https://api.github.com/users/michielkeijts/events{/privacy}","received_events_url":"https://api.github.com/users/michielkeijts/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":60504544,"node_id":"MDU6TGFiZWw2MDUwNDU0NA==","url":"https://api.github.com/repos/cakephp/cakephp/labels/defect","name":"defect","color":"e50f2c","default":false,"description":""},{"id":60506139,"node_id":"MDU6TGFiZWw2MDUwNjEzOQ==","url":"https://api.github.com/repos/cakephp/cakephp/labels/http%20client","name":"http client","color":"FFFFFF","default":false,"description":""},{"id":1552340707,"node_id":"MDU6TGFiZWwxNTUyMzQwNzA3","url":"https://api.github.com/repos/cakephp/cakephp/labels/pinned","name":"pinned","color":"ef81ca","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/cakephp/cakephp/milestones/208","html_url":"https://github.com/cakephp/cakephp/milestone/208","labels_url":"https://api.github.com/repos/cakephp/cakephp/milestones/208/labels","id":4725634,"node_id":"MDk6TWlsZXN0b25lNDcyNTYzNA==","number":208,"title":"3.8.6","description":"Bugfixes for 3.8.x","creator":{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":41,"state":"closed","created_at":"2019-10-07T00:59:47Z","updated_at":"2019-11-07T01:30:12Z","due_on":"2019-11-06T08:00:00Z","closed_at":"2019-11-07T01:30:12Z"},"comments":1,"created_at":"2019-08-20T09:57:37Z","updated_at":"2019-10-14T02:02:38Z","closed_at":"2019-10-14T02:02:38Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"This is a (multiple allowed):\r\n\r\n* [x] bug\r\n* [ ] enhancement\r\n* [ ] feature-discussion (RFC)\r\n\r\n* CakePHP Version: 3.7\r\n\r\n### What you did\r\nIn the script I use the HTTP Client with the option to follow redirects (`$options['redirect'] = 10`). I opened an url with a post request (an authentication request) to `authentication.domain.com`. The response included a `Set-Cookie` header as well as a `Location` header, which redirected the location to `backstage.domain.com` The cookie had this domain also. \r\n\r\nThe cookie collection of the `Cake\\Http\\Client` holds all the cookies for the top level domain and all its subdomains (in this case: `backstage.domain.com` `authentication.domain.com`)\r\nDuring the redirect in the [Cake\\Http\\Client::send](https://github.com/cakephp/cakephp/blob/master/src/Http/Client.php#L417) method, the cookies from the requests' cookie collection for the new location are copied in the request, so the valid cookies for the new sub-domain are included, if any cookies for this subdomain exists in the requests' cookie collection\r\n\r\n### What happened\r\nIn my case, both the `authentication.domain.com` and the `backstage.domain.com` holds a cookie with the same name, but different value (SESSION=123 for backstage and SESSION=456 for authentication). \r\n\r\nWhen redirecting from the `authentication.domain.com` to the `backstage.domain.com`, the cookie SESSION from the authentication domain was copied in the request to `backstage.domain.com`. \r\nIn this case, the request did already have a cookie with name SESSION and value 123 for the `backstage.domain.com` and was overwritten by the requests` cookie collection cookie SESSION with value 456. So my session was basically overwritten.\r\n\r\nThis means that when cookies with different names or equal values were used, this problem would not have poped up. \r\n\r\nThis has to do with the fact that in the [Cake\\Http\\Client::send](https://github.com/cakephp/cakephp/blob/master/src/Http/Client.php#L417) method, the cookies are copied from the cookie collection, before the new url for the request is set. In other words: it looks for cookies for the current domain, which is still the `authentication.domain.com` in my case instead of the `backstage.domain.com`\r\n\r\n### What you expected to happen\r\nas said, the cookie from the cookie collection belonging to the domain `backstage.domain.com` should be copied or remained and not overwritten with a cookie with the same name from the other domain.\r\n\r\nThis can easily be done by placing the cookie injecting after the change of URI in the code:\r\n[Cake\\Http\\Client](https://github.com/cakephp/cakephp/blob/master/src/Http/Client.php#L417)\r\n```\r\npublic function send(Request $request, $options = [])\r\n    {\r\n      ...\r\n            if ($handleRedirect) {\r\n                $url = $request->getUri();\r\n                $request = $this->_cookies->addToRequest($request, []);\r\n                $location = $response->getHeaderLine('Location');\r\n                $locationUrl = $this->buildUrl($location, [], [\r\n                    'host' => $url->getHost(),\r\n                    'port' => $url->getPort(),\r\n                    'scheme' => $url->getScheme(),\r\n                    'protocolRelative' => true\r\n                ]);\r\n                $request = $request->withUri(new Uri($locationUrl));\r\n            }\r\n    ....\r\n    }\r\n```\r\n\r\nto \r\n```\r\npublic function send(Request $request, $options = [])\r\n    {\r\n      ...\r\n            if ($handleRedirect) {\r\n                $url = $request->getUri();\r\n                \r\n                $location = $response->getHeaderLine('Location');\r\n                $locationUrl = $this->buildUrl($location, [], [\r\n                    'host' => $url->getHost(),\r\n                    'port' => $url->getPort(),\r\n                    'scheme' => $url->getScheme(),\r\n                    'protocolRelative' => true\r\n                ]);\r\n                $request = $request->withUri(new Uri($locationUrl));\r\n\r\n                $request = $this->_cookies->addToRequest($request, []);\r\n            }\r\n    ....\r\n    }\r\n```\r\n\r\n\r\n","closed_by":{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/cakephp/cakephp/issues/13543/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/cakephp/cakephp/issues/13543/timeline","performed_via_github_app":null,"state_reason":"completed"}