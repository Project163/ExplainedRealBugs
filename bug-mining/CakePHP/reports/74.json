{"url":"https://api.github.com/repos/cakephp/cakephp/issues/13040","repository_url":"https://api.github.com/repos/cakephp/cakephp","labels_url":"https://api.github.com/repos/cakephp/cakephp/issues/13040/labels{/name}","comments_url":"https://api.github.com/repos/cakephp/cakephp/issues/13040/comments","events_url":"https://api.github.com/repos/cakephp/cakephp/issues/13040/events","html_url":"https://github.com/cakephp/cakephp/issues/13040","id":419211301,"node_id":"MDU6SXNzdWU0MTkyMTEzMDE=","number":13040,"title":"Inconsistent error output - UrlHelper / Router","user":{"login":"smarek","id":384824,"node_id":"MDQ6VXNlcjM4NDgyNA==","avatar_url":"https://avatars.githubusercontent.com/u/384824?v=4","gravatar_id":"","url":"https://api.github.com/users/smarek","html_url":"https://github.com/smarek","followers_url":"https://api.github.com/users/smarek/followers","following_url":"https://api.github.com/users/smarek/following{/other_user}","gists_url":"https://api.github.com/users/smarek/gists{/gist_id}","starred_url":"https://api.github.com/users/smarek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smarek/subscriptions","organizations_url":"https://api.github.com/users/smarek/orgs","repos_url":"https://api.github.com/users/smarek/repos","events_url":"https://api.github.com/users/smarek/events{/privacy}","received_events_url":"https://api.github.com/users/smarek/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/cakephp/cakephp/milestones/194","html_url":"https://github.com/cakephp/cakephp/milestone/194","labels_url":"https://api.github.com/repos/cakephp/cakephp/milestones/194/labels","id":4139115,"node_id":"MDk6TWlsZXN0b25lNDEzOTExNQ==","number":194,"title":"3.7.6","description":"Bug fixes for 3.7.","creator":{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":28,"state":"closed","created_at":"2019-03-14T02:00:31Z","updated_at":"2019-04-10T01:14:15Z","due_on":"2019-04-09T07:00:00Z","closed_at":"2019-04-10T01:14:15Z"},"comments":5,"created_at":"2019-03-10T17:36:05Z","updated_at":"2019-03-16T03:12:31Z","closed_at":"2019-03-16T03:12:31Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"This is a (multiple allowed):\r\n\r\n* [x] bug\r\n* [ ] enhancement\r\n* [ ] feature-discussion (RFC)\r\n\r\n* CakePHP Version: 3.7.3\r\n* Platform and Target: linux nginx php7.3\r\n\r\nThrough custom `App\\Error\\AppExceptionRenderer` I'm disabling/enabling Debug status for rendering PHP handled errors using something like\r\n\r\n```php\r\n<?php\r\n\r\nnamespace App\\Error;\r\n\r\nuse Cake\\Core\\Configure;\r\nuse Cake\\Error\\ExceptionRenderer;\r\n\r\nclass AppExceptionRenderer extends ExceptionRenderer\r\n{\r\n\r\n    public function render()\r\n    {\r\n        $is_debug = null;\r\n        if ($this->controller && $this->controller->Auth && !empty($this->controller->Auth->user())) {\r\n            // decide if the debug output should be shown, if that is so, set $is_debug to anything but null\r\n        }\r\n\r\n\r\n\r\n        if ($is_debug === null) {\r\n            // not show dev_err layout for non-debug users\r\n            Configure::write('debug', false);\r\n        }\r\n\r\n        return parent::render();\r\n    }\r\n\r\n}\r\n```\r\n\r\nIn situation, where this code decides current user is not to be shown \"dev_error layout, debug output\", the error output is inconsistent\r\n\r\nTwo states are seen\r\n  - Internal Server Error (500)\r\n  - Not Found Exception (404)\r\n\r\n**404 error** will show this stacktrace in `error.log` (accessing /en_US/wizarda, which is undefined route)\r\n\r\n```log\r\n2019-03-10 18:18:37 Error: [Cake\\Routing\\Exception\\MissingRouteException] A route matching \"/en_US/wizarda\" could not be found.\r\n#0 /var/www/myapp/vendor/cakephp/cakephp/src/Routing/Router.php(385): Cake\\Routing\\RouteCollection->parseRequest(Object(Cake\\Http\\ServerRequest))\r\n#1 /var/www/myapp/vendor/cakephp/cakephp/src/Routing/Middleware/RoutingMiddleware.php(146): Cake\\Routing\\Router::parseRequest(Object(Cake\\Http\\ServerRequest))\r\n#2 /var/www/myapp/vendor/cakephp/cakephp/src/Http/Runner.php(65): Cake\\Routing\\Middleware\\RoutingMiddleware->__invoke(Object(Cake\\Http\\ServerRequest), Object(Cake\\Http\\Response), Object(Ca\r\nke\\Http\\Runner))\r\n#3 /var/www/myapp/vendor/cakephp/cakephp/src/Error/Middleware/ErrorHandlerMiddleware.php(98): Cake\\Http\\Runner->__invoke(Object(Cake\\Http\\ServerRequest), Object(Cake\\Http\\Response))\r\n#4 /var/www/myapp/vendor/cakephp/cakephp/src/Http/Runner.php(65): Cake\\Error\\Middleware\\ErrorHandlerMiddleware->__invoke(Object(Cake\\Http\\ServerRequest), Object(Cake\\Http\\Response), Object\r\n(Cake\\Http\\Runner))\r\n#5 /var/www/myapp/vendor/cakephp/cakephp/src/Http/Middleware/CsrfProtectionMiddleware.php(108): Cake\\Http\\Runner->__invoke(Object(Cake\\Http\\ServerRequest), Object(Cake\\Http\\Response))\r\n#6 /var/www/myapp/vendor/cakephp/cakephp/src/Http/Runner.php(65): Cake\\Http\\Middleware\\CsrfProtectionMiddleware->__invoke(Object(Cake\\Http\\ServerRequest), Object(Cake\\Http\\Response), Objec\r\nt(Cake\\Http\\Runner))\r\n#7 /var/www/myapp/vendor/cakephp/cakephp/src/Routing/Middleware/AssetMiddleware.php(88): Cake\\Http\\Runner->__invoke(Object(Cake\\Http\\ServerRequest), Object(Cake\\Http\\Response))\r\n#8 /var/www/myapp/vendor/cakephp/cakephp/src/Http/Runner.php(65): Cake\\Routing\\Middleware\\AssetMiddleware->__invoke(Object(Cake\\Http\\ServerRequest), Object(Cake\\Http\\Response), Object(Cake\r\n\\Http\\Runner))\r\n#9 /var/www/myapp/vendor/cakephp/cakephp/src/Http/Runner.php(51): Cake\\Http\\Runner->__invoke(Object(Cake\\Http\\ServerRequest), Object(Cake\\Http\\Response))\r\n#10 /var/www/myapp/vendor/cakephp/cakephp/src/Http/Server.php(98): Cake\\Http\\Runner->run(Object(Cake\\Http\\MiddlewareQueue), Object(Cake\\Http\\ServerRequest), Object(Cake\\Http\\Response))\r\n#11 /var/www/myapp/webroot/index.php(40): Cake\\Http\\Server->run()\r\n#12 {main}\r\nRequest URL: /en_US/wizarda\r\n```\r\n\r\n**500 error** shows in `error.log` this way:\r\n```log\r\n2019-03-10 18:09:58 Error: [TypeError] Argument 2 passed to Cake\\Http\\BaseApplication::{closure}() must be an instance of Cake\\Http\\ServerRequest, null given, called in /var/www/myapp/vend\r\nor/cakephp/cakephp/src/Routing/Router.php on line 589                                                                                                                                          \r\n#0 /var/www/myapp/vendor/cakephp/cakephp/src/Routing/Router.php(589): Cake\\Http\\BaseApplication->{closure}(Array, NULL)                                                                     \r\n#1 /var/www/myapp/vendor/cakephp/cakephp/src/Routing/Router.php(679): Cake\\Routing\\Router::_applyUrlFilters(Array)                                                                          \r\n#2 /var/www/myapp/vendor/cakephp/cakephp/src/View/Helper/UrlHelper.php(56): Cake\\Routing\\Router::url(Array, false)                                                                          \r\n#3 /var/www/myapp/src/Template/Layout/default.ctp(44): Cake\\View\\Helper\\UrlHelper->build(Array)                                                                                             \r\n#4 /var/www/myapp/vendor/cakephp/cakephp/src/View/View.php(1413): include('/var/www/certif...')                                                                                             \r\n#5 /var/www/myapp/vendor/cakephp/cakephp/src/View/View.php(1374): Cake\\View\\View->_evaluate('/var/www/certif...', Array)                                                                    \r\n#6 /var/www/myapp/vendor/cakephp/cakephp/src/View/View.php(927): Cake\\View\\View->_render('/var/www/certif...')                                                                              \r\n#7 /var/www/myapp/vendor/cakephp/cakephp/src/View/View.php(885): Cake\\View\\View->renderLayout('', 'default')                                                                                \r\n#8 /var/www/myapp/vendor/cakephp/cakephp/src/Controller/Controller.php(791): Cake\\View\\View->render('error400', NULL)                                                                       \r\n#9 /var/www/myapp/vendor/cakephp/cakephp/src/Error/ExceptionRenderer.php(369): Cake\\Controller\\Controller->render('error400')                                                               \r\n#10 /var/www/myapp/vendor/cakephp/cakephp/src/Error/ExceptionRenderer.php(244): Cake\\Error\\ExceptionRenderer->_outputMessage('error400')                                                    \r\n#11 /var/www/myapp/src/Error/AppExceptionRenderer.php(29): Cake\\Error\\ExceptionRenderer->render()                                                                                           \r\n#12 /var/www/myapp/vendor/cakephp/cakephp/src/Error/Middleware/ErrorHandlerMiddleware.php(118): App\\Error\\AppExceptionRenderer->render()                                                    \r\n#13 /var/www/myapp/vendor/cakephp/cakephp/src/Error/Middleware/ErrorHandlerMiddleware.php(100): Cake\\Error\\Middleware\\ErrorHandlerMiddleware->handleException(Object(Cake\\Routing\\Exception\\\r\nMissingRouteException), Object(Cake\\Http\\ServerRequest), Object(Cake\\Http\\Response))                                                                                                           \r\n#14 /var/www/myapp/vendor/cakephp/cakephp/src/Http/Runner.php(65): Cake\\Error\\Middleware\\ErrorHandlerMiddleware->__invoke(Object(Cake\\Http\\ServerRequest), Object(Cake\\Http\\Response), Objec\r\nt(Cake\\Http\\Runner))                                                                                                                                                                           \r\n#15 /var/www/myapp/vendor/cakephp/cakephp/src/Http/Middleware/CsrfProtectionMiddleware.php(108): Cake\\Http\\Runner->__invoke(Object(Cake\\Http\\ServerRequest), Object(Cake\\Http\\Response))    \r\n#16 /var/www/myapp/vendor/cakephp/cakephp/src/Http/Runner.php(65): Cake\\Http\\Middleware\\CsrfProtectionMiddleware->__invoke(Object(Cake\\Http\\ServerRequest), Object(Cake\\Http\\Response), Obje\r\nct(Cake\\Http\\Runner))                                                                                                                                                                          \r\n#17 /var/www/myapp/vendor/cakephp/cakephp/src/Routing/Middleware/AssetMiddleware.php(88): Cake\\Http\\Runner->__invoke(Object(Cake\\Http\\ServerRequest), Object(Cake\\Http\\Response))           \r\n#18 /var/www/myapp/vendor/cakephp/cakephp/src/Http/Runner.php(65): Cake\\Routing\\Middleware\\AssetMiddleware->__invoke(Object(Cake\\Http\\ServerRequest), Object(Cake\\Http\\Response), Object(Cak\r\ne\\Http\\Runner))                                                                                                                                                                                \r\n#19 /var/www/myapp/vendor/cakephp/cakephp/src/Http/Runner.php(51): Cake\\Http\\Runner->__invoke(Object(Cake\\Http\\ServerRequest), Object(Cake\\Http\\Response))                                  \r\n#20 /var/www/myapp/vendor/cakephp/cakephp/src/Http/Server.php(98): Cake\\Http\\Runner->run(Object(Cake\\Http\\MiddlewareQueue), Object(Cake\\Http\\ServerRequest), Object(Cake\\Http\\Response))    \r\n#21 /var/www/myapp/webroot/index.php(40): Cake\\Http\\Server->run()                                                                                                                           \r\n#22 {main}                                                                                                                                                                                     \r\nRequest URL: /en_US/wizarda\r\n```\r\n\r\nThe **500 error**, judging by stacktrace, originates from `Cake\\Routing\\Router.php:589` which is applying URL filtering (method signature `protected static function _applyUrlFilters($url){}`), and the request gathered on line `587` through `$request = static::getRequest(true)` returned is null\r\n\r\nThis causes UrlHelper to fail in non-`dev_err` layout (aka the `src/Template/Layout/default.ctp`) and the error shown is different.\r\n\r\nHowever this seems to be the case in both errors, because HTML rendered looks like this:\r\n\r\n**404**:\r\n```html\r\n\r\n<!DOCTYPE html>\r\n<html lang=\"cs\">\r\n<head>\r\n    <meta charset=\"utf-8\"/>    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1, shrink-to-fit=no\">\r\n    <title>\r\n         myapp.eu\r\n    </title>\r\n    <link rel=\"icon\" type=\"image/png\" href=\"https://myapp.eu/favicon.png\"/>\r\n    <link rel=\"shortcut icon\" href=\"https://myapp.eu/favicon.ico\"/>\r\n    \r\n    <link rel=\"stylesheet\" href=\"https://use.fontawesome.com/releases/v5.4.1/css/all.css\"\r\n          integrity=\"sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz\" crossorigin=\"anonymous\">\r\n    <link rel=\"stylesheet\" href=\"/css/bootstrap.min.css\"/>    <link rel=\"stylesheet\" href=\"/css/toggle-switch.css\"/>    <link rel=\"stylesheet\" href=\"/css/select2.min.css\"/>    <link rel=\"stylesheet\" href=\"/css/pikaday/pikaday.css\"/>    <link rel=\"stylesheet\" href=\"/css/myapp.css?rand=1793391118\"/>    \r\n    <script src=\"/js/jquery-3.3.1.min.js\"></script>    <script src=\"/js/jquery.chained.selects.js?rand=1655205929\"></script>    <script src=\"/js/select2.full.min.js\"></script>    <script src=\"/js/moment-with-locales.js\"></script>    <script src=\"/js/pikaday.js\"></script>    <script src=\"/js/pikaday.jquery.js\"></script>    <script src=\"/js/popper.min.js\"></script>    <script src=\"/js/bootstrap.min.js\"></script>    <script src=\"/js/d3.v5.js\"></script>    <script src=\"/js/dagre-d3.js\"></script>    <script src=\"/js/myapp.js?ramd=757005104\"></script>\r\n    </head>\r\n<body>\r\n<nav class=\"navbar navbar-expand-lg navbar-light bg-light\" role=\"navigation\">\r\n    <a class=\"navbar-brand\" href=\"/\">\r\n        <img src=\"/favicon.png\" width=\"30\" height=\"30\" alt=\"myapp\">\r\n    </a>\r\n    <button class=\"navbar-toggler\" type=\"button\" data-toggle=\"collapse\" data-target=\"#navbarSupportedContent\"\r\n            aria-controls=\"navbarSupportedContent\" aria-expanded=\"false\" aria-label=\"Toggle navigation\">\r\n        <span class=\"navbar-toggler-icon\"></span>\r\n    </button>\r\n\r\n    <div class=\"collapse navbar-collapse\" id=\"navbarSupportedContent\">\r\n        <ul class=\"navbar-nav mr-auto\">\r\n\r\n                                        <li class=\"nav-item\">\r\n                    <a class=\"nav-link\"\r\n                       href=\"/user/dashboard\">User dashboard</a>\r\n                </li>\r\n                <li class=\"nav-item\">\r\n                    <a href=\"<!DOCTYPE html>\r\n<html>\r\n<head>\r\n    <meta charset=\"utf-8\"/>    <title>\r\n        Error    </title>\r\n    <link href=\"/favicon.ico\" type=\"image/x-icon\" rel=\"icon\"/><link href=\"/favicon.ico\" type=\"image/x-icon\" rel=\"shortcut icon\"/>\r\n    <link rel=\"stylesheet\" href=\"/css/base.css\"/>    <link rel=\"stylesheet\" href=\"/css/style.css\"/>\r\n            </head>\r\n<body>\r\n<div id=\"container\">\r\n    <div id=\"header\">\r\n        <h1>Error</h1>\r\n    </div>\r\n    <div id=\"content\">\r\n        \r\n        <h2>An Error Has Occurred</h2>\r\n<p class=\"alert alert-danger\">\r\n    <strong>Error: </strong>\r\n    Not Found</p>\r\n    </div>\r\n    <div id=\"footer\">\r\n        <a href=\"javascript:history.back()\">Back</a>    </div>\r\n</div>\r\n</body>\r\n</html>\r\n```\r\n\r\nand in **500**:\r\n```html\r\n\r\n<!DOCTYPE html>\r\n<html lang=\"cs\">\r\n<head>\r\n    <meta charset=\"utf-8\"/>    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1, shrink-to-fit=no\">\r\n    <title>\r\n         myapp.eu\r\n    </title>\r\n    <link rel=\"icon\" type=\"image/png\" href=\"https://myapp.eu/favicon.png\"/>\r\n    <link rel=\"shortcut icon\" href=\"https://myapp.eu/favicon.ico\"/>\r\n    \r\n    <link rel=\"stylesheet\" href=\"https://use.fontawesome.com/releases/v5.4.1/css/all.css\"\r\n          integrity=\"sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz\" crossorigin=\"anonymous\">\r\n    <link rel=\"stylesheet\" href=\"/css/bootstrap.min.css\"/>    <link rel=\"stylesheet\" href=\"/css/toggle-switch.css\"/>    <link rel=\"stylesheet\" href=\"/css/select2.min.css\"/>    <link rel=\"stylesheet\" href=\"/css/pikaday/pikaday.css\"/>    <link rel=\"stylesheet\" href=\"/css/myapp.css?rand=631317527\"/>    \r\n    <script src=\"/js/jquery-3.3.1.min.js\"></script>    <script src=\"/js/jquery.chained.selects.js?rand=1712123251\"></script>    <script src=\"/js/select2.full.min.js\"></script>    <script src=\"/js/moment-with-locales.js\"></script>    <script src=\"/js/pikaday.js\"></script>    <script src=\"/js/pikaday.jquery.js\"></script>    <script src=\"/js/popper.min.js\"></script>    <script src=\"/js/bootstrap.min.js\"></script>    <script src=\"/js/d3.v5.js\"></script>    <script src=\"/js/dagre-d3.js\"></script>    <script src=\"/js/myapp.js?ramd=2010716946\"></script>\r\n    </head>\r\n<body>\r\n<nav class=\"navbar navbar-expand-lg navbar-light bg-light\" role=\"navigation\">\r\n    <a class=\"navbar-brand\" href=\"An Internal Server Error Occurred\r\n```\r\n\r\nWhich clearly shows, that the UrlHelper error occurs in both cases, however only in one of them, gets handled as internal server error, and in the others as 404 not-found.","closed_by":{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/cakephp/cakephp/issues/13040/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/cakephp/cakephp/issues/13040/timeline","performed_via_github_app":null,"state_reason":"completed"}