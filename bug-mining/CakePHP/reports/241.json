{"url":"https://api.github.com/repos/cakephp/cakephp/issues/16562","repository_url":"https://api.github.com/repos/cakephp/cakephp","labels_url":"https://api.github.com/repos/cakephp/cakephp/issues/16562/labels{/name}","comments_url":"https://api.github.com/repos/cakephp/cakephp/issues/16562/comments","events_url":"https://api.github.com/repos/cakephp/cakephp/issues/16562/events","html_url":"https://github.com/cakephp/cakephp/issues/16562","id":1268216001,"node_id":"I_kwDOAAoEbs5Ll3DB","number":16562,"title":"BelongsToMany mishandles object data type foreign keys","user":{"login":"zachee54","id":42939319,"node_id":"MDQ6VXNlcjQyOTM5MzE5","avatar_url":"https://avatars.githubusercontent.com/u/42939319?v=4","gravatar_id":"","url":"https://api.github.com/users/zachee54","html_url":"https://github.com/zachee54","followers_url":"https://api.github.com/users/zachee54/followers","following_url":"https://api.github.com/users/zachee54/following{/other_user}","gists_url":"https://api.github.com/users/zachee54/gists{/gist_id}","starred_url":"https://api.github.com/users/zachee54/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zachee54/subscriptions","organizations_url":"https://api.github.com/users/zachee54/orgs","repos_url":"https://api.github.com/users/zachee54/repos","events_url":"https://api.github.com/users/zachee54/events{/privacy}","received_events_url":"https://api.github.com/users/zachee54/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":60504544,"node_id":"MDU6TGFiZWw2MDUwNDU0NA==","url":"https://api.github.com/repos/cakephp/cakephp/labels/defect","name":"defect","color":"e50f2c","default":false,"description":""},{"id":83815438,"node_id":"MDU6TGFiZWw4MzgxNTQzOA==","url":"https://api.github.com/repos/cakephp/cakephp/labels/ORM","name":"ORM","color":"0ed189","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/cakephp/cakephp/milestones/280","html_url":"https://github.com/cakephp/cakephp/milestone/280","labels_url":"https://api.github.com/repos/cakephp/cakephp/milestones/280/labels","id":8056006,"node_id":"MI_kwDOAAoEbs4AeuzG","number":280,"title":"4.4.1","description":"Bugfixes for 4.4.x","creator":{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":13,"state":"closed","created_at":"2022-06-07T03:21:20Z","updated_at":"2022-06-13T17:24:50Z","due_on":"2022-06-27T07:00:00Z","closed_at":"2022-06-13T17:24:50Z"},"comments":7,"created_at":"2022-06-11T09:17:07Z","updated_at":"2022-06-13T15:16:36Z","closed_at":"2022-06-13T15:16:36Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description\n\n## Description\r\n\r\nWhen `Articles BelongsToMany Tags`, and `Articles` has a composite foreign key including a field of object data type such as `date`, saving an article with associated tags deletes existing tags associations for this article.\r\n\r\n## Faulty code\r\n\r\n`src/ORM/Association/BelongsToMany.php` runs the following code in `_diffLinks` method :\r\n```\r\nforeach ($indexed as $i => $data) {\r\n    if ($fields === $data) {  // <-- Unexpected result here\r\n        unset($indexed[$i]);\r\n        $found = true;\r\n        break;\r\n    }\r\n}\r\n```\r\nThis code looks for links that were removed in the entity and marks them for deletion.\r\nUnfortunately, since `$fields` and `$data` are compared through the `===` operator, different object instances representing the same value aren't recognized as equals and are unintentionally deleted.\r\n\r\n## How to reproduce it\r\n\r\nCreate this database schema :\r\n```\r\nCREATE TABLE `articles` (\r\n  `author_id` int(11) NOT NULL,\r\n  `created` date NOT NULL,\r\n  `body` varchar(50) DEFAULT NULL,\r\n  PRIMARY KEY (`author_id`,`created`)\r\n);\r\nCREATE TABLE `articles_tags` (\r\n  `author_id` int(11) NOT NULL,\r\n  `created` date NOT NULL,\r\n  `tag_id` int(11) NOT NULL,\r\n  PRIMARY KEY (`author_id`,`created`,`tag_id`)\r\n);\r\nCREATE TABLE `articles_tags` (\r\n  `author_id` int(11) NOT NULL,\r\n  `created` date NOT NULL, -- Note that articles foreign key uses a date type\r\n  `tag_id` int(11) NOT NULL,\r\n  PRIMARY KEY (`author_id`,`created`,`tag_id`)\r\n);\r\n```\r\nInsert those values :\r\n```\r\nINSERT INTO articles VALUES (1, '2021-12-25', 'This is my article\\'s body');\r\nINSERT INTO tags VALUES (1, 'First tag'), (2, 'Second tag');\r\n```\r\nArticlesController :\r\n```\r\n<?php\r\ndeclare(strict_types=1);\r\n\r\nnamespace App\\Controller;\r\n\r\nclass ArticlesController extends AppController {\r\n  \r\n  public function index() {\r\n    $this->set('articles', $this->Articles->find());\r\n  }\r\n  \r\n  public function edit($authorId, $created) {\r\n    $article = $this->Articles->find()\r\n      ->contain('Tags')\r\n      ->where([\r\n        'author_id' => $authorId,\r\n        'created' => $created])\r\n      ->first();\r\n    \r\n    if ($this->request->is(['post', 'put'])) {\r\n      $this->Articles->patchEntity($article, $this->request->getData(), [\r\n        'associated' => ['Tags'] ]);\r\n      $this->Articles->save($article);\r\n    }\r\n    \r\n    $this->set('article', $article);\r\n    $this->set('tags', $this->Articles->Tags->find('list')->toArray());\r\n  }\r\n}\r\n\r\n```\r\nView `Articles/edit.php` :\r\n```\r\n<?php\r\necho $this->Form->create($article, [\r\n  'autocomplete' => 'off']);\r\n  \r\n  echo $this->Form->control('body');\r\n  echo $this->Form->control('tags._ids', [\r\n    'multiple' => 'checkbox',\r\n    'options' => $tags]);\r\n  \r\n  echo $this->Form->submit('Submit');\r\necho $this->Form->end();\r\n```\r\nIndex view (helper to access the article's edition page without effort) :\r\n```\r\n<?php\r\nforeach ($articles as $article) {\r\n  echo $this->Html->link(\r\n    $article->body,\r\n    [\r\n      'action' => 'edit',\r\n      $article->author_id,\r\n      $article->created->toDateString()\r\n    ]\r\n  );\r\n}\r\n```\r\n\r\n1. Open the `/articles/` page and click on the article body.\r\n2. Check the first tag and submit ; the first tag link is saved successfully, as you can see in database.\r\n3. Check the second tag (without unchecking the first one) and submit again.\r\n4. Look at SQL logs and at the join table in database : the first tag was unintentionally removed from the article.\r\n5. Re-submit the same query : the second tag was removed and the first tag re-added.\r\n\r\nDatabase lookup after 4. :\r\n```\r\nMariaDB [test]> select * from articles_tags;\r\n+-----------+------------+--------+\r\n| author_id | created    | tag_id |\r\n+-----------+------------+--------+\r\n|         1 | 2022-06-10 |      2 |\r\n+-----------+------------+--------+\r\n1 row in set (0.000 sec)\r\n```\r\nSQL logs after 4. :\r\n```\r\n(...)\r\nDELETE FROM\r\n    articles_tags\r\n  WHERE\r\n    (\r\n     author_id = 1\r\n      AND created = '2022-06-10'\r\n      AND tag_id = 1\r\n   )\r\nSELECT\r\n    1 AS existing\r\n  FROM\r\n    articles_tags ArticlesTags\r\n  WHERE\r\n    (\r\n     ArticlesTags.author_id = 1\r\n      AND ArticlesTags.created = '2022-06-10'\r\n      AND ArticlesTags.tag_id = 2   )\r\n  LIMIT\r\n    1\r\nINSERT INTO articles_tags (created, tag_id, author_id)\r\n  VALUES\r\n    ('2022-06-10', 2, 1)\r\nCOMMIT\r\n(...)\r\n```\r\n\r\nCake doesn't recognize the existing link, likely because the two `FrozenDate`s are of same value but not the same instance, then deletes the link and doesn't reinsert it.\r\n\r\n## Workaround\r\n\r\nI couldn't figure out a suitable workaround.\r\nNethertheless, deleting all related links before saving solves the problem. As a result, though, the app is exposed to data loss in case the save operation would fail after the links' deletion.\r\n```\r\n// In ArticlesController::edit\r\n// Delete related links before save\r\n$this->fetchTable('ArticlesTags')->query()\r\n  ->delete()\r\n  ->where([\r\n    'author_id' => $authorId,\r\n    'created' => $created])\r\n  ->execute();\r\n\r\n$this->Articles->patchEntity($article, $this->request->getData(), [\r\n  'associated' => ['Tags'] ]);\r\n$this->Articles->save($article);\r\n```\r\n\r\n## Possible correlated issue\r\n\r\nIf `Articles` has a non-composite primary key of date type (such as `created`), I get a PHP warning because `$key` is unexpectedly an empty array in EagerLoader.php line 842 :\r\n`Warning (2) : Illegal offset type [in /var/www/html/cake_test/vendor/cakephp/cakephp/src/ORM/EagerLoader.php, line 842]`\n\n### CakePHP Version\n\n4.4.0\n\n### PHP Version\n\n7.4.3","closed_by":{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/cakephp/cakephp/issues/16562/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/cakephp/cakephp/issues/16562/timeline","performed_via_github_app":null,"state_reason":"completed"}