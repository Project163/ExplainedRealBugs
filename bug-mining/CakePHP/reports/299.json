{"url":"https://api.github.com/repos/cakephp/cakephp/issues/17612","repository_url":"https://api.github.com/repos/cakephp/cakephp","labels_url":"https://api.github.com/repos/cakephp/cakephp/issues/17612/labels{/name}","comments_url":"https://api.github.com/repos/cakephp/cakephp/issues/17612/comments","events_url":"https://api.github.com/repos/cakephp/cakephp/issues/17612/events","html_url":"https://github.com/cakephp/cakephp/issues/17612","id":2175814476,"node_id":"I_kwDOAAoEbs6BsEtM","number":17612,"title":"FormProtector failing with csrfSessionMiddleware","user":{"login":"KrzysiekNDS","id":98674267,"node_id":"U_kgDOBeGmWw","avatar_url":"https://avatars.githubusercontent.com/u/98674267?v=4","gravatar_id":"","url":"https://api.github.com/users/KrzysiekNDS","html_url":"https://github.com/KrzysiekNDS","followers_url":"https://api.github.com/users/KrzysiekNDS/followers","following_url":"https://api.github.com/users/KrzysiekNDS/following{/other_user}","gists_url":"https://api.github.com/users/KrzysiekNDS/gists{/gist_id}","starred_url":"https://api.github.com/users/KrzysiekNDS/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/KrzysiekNDS/subscriptions","organizations_url":"https://api.github.com/users/KrzysiekNDS/orgs","repos_url":"https://api.github.com/users/KrzysiekNDS/repos","events_url":"https://api.github.com/users/KrzysiekNDS/events{/privacy}","received_events_url":"https://api.github.com/users/KrzysiekNDS/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":60504544,"node_id":"MDU6TGFiZWw2MDUwNDU0NA==","url":"https://api.github.com/repos/cakephp/cakephp/labels/defect","name":"defect","color":"e50f2c","default":false,"description":""},{"id":60506670,"node_id":"MDU6TGFiZWw2MDUwNjY3MA==","url":"https://api.github.com/repos/cakephp/cakephp/labels/testing","name":"testing","color":"FFFFFF","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/cakephp/cakephp/milestones/319","html_url":"https://github.com/cakephp/cakephp/milestone/319","labels_url":"https://api.github.com/repos/cakephp/cakephp/milestones/319/labels","id":11221866,"node_id":"MI_kwDOAAoEbs4Aqztq","number":319,"title":"5.0.10","description":"Bugfixes for 5.0","creator":{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":13,"state":"closed","created_at":"2024-06-24T03:02:56Z","updated_at":"2024-08-02T20:31:45Z","due_on":"2024-07-20T07:00:00Z","closed_at":"2024-08-02T20:31:45Z"},"comments":0,"created_at":"2024-03-08T11:06:32Z","updated_at":"2024-06-24T17:11:44Z","closed_at":"2024-06-24T17:11:43Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description\r\n\r\nIn integration testing, when executing a GET request, I get an error Error: Unexpected field `_csrfToken` in POST data after executing a POST type query with csrf token enabled. Imo, we can solve the problem by skipping adding tokens when the method is GET and the data field is empty.\r\n## Test to prove:\r\n```php\r\n    $this->enableSecurityToken();\r\n    $this->enableCsrfToken();\r\n    $this->post('/login');\r\n    $this->get('/login');\r\n    $this->assertResponseCode(200);\r\n```\r\nWith **CsrfProtectionMiddleware** will pass, with **sessionCsrfProtectionMiddleware** will fail - `Failed asserting that 200 matches response status code 400.`\r\n\r\n## Code:\r\nThe error is due to the inconsistency of the code in [CsrfProtectionMiddleware](https://github.com/cakephp/cakephp/blob/5.x/src/Http/Middleware/CsrfProtectionMiddleware.php#L156) and in [sessionCsrfProtectionMiddleware](https://github.com/cakephp/cakephp/blob/5.x/src/Http/Middleware/SessionCsrfProtectionMiddleware.php) - in sessionCsrfProtectionMiddleware, the `GET` method is sufficient to skip removing data. In CsrfProtectionMiddleware method must be `GET` and `$cookieData` must be empty to skip removing data.\r\n\r\n### CakePHP Version\r\n\r\n5.0.5\r\n\r\n### PHP Version\r\n\r\n8.2","closed_by":{"login":"othercorey","id":24221186,"node_id":"MDQ6VXNlcjI0MjIxMTg2","avatar_url":"https://avatars.githubusercontent.com/u/24221186?v=4","gravatar_id":"","url":"https://api.github.com/users/othercorey","html_url":"https://github.com/othercorey","followers_url":"https://api.github.com/users/othercorey/followers","following_url":"https://api.github.com/users/othercorey/following{/other_user}","gists_url":"https://api.github.com/users/othercorey/gists{/gist_id}","starred_url":"https://api.github.com/users/othercorey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/othercorey/subscriptions","organizations_url":"https://api.github.com/users/othercorey/orgs","repos_url":"https://api.github.com/users/othercorey/repos","events_url":"https://api.github.com/users/othercorey/events{/privacy}","received_events_url":"https://api.github.com/users/othercorey/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/cakephp/cakephp/issues/17612/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/cakephp/cakephp/issues/17612/timeline","performed_via_github_app":null,"state_reason":"completed"}