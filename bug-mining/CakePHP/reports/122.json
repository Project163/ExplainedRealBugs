{"url":"https://api.github.com/repos/cakephp/cakephp/issues/14032","repository_url":"https://api.github.com/repos/cakephp/cakephp","labels_url":"https://api.github.com/repos/cakephp/cakephp/issues/14032/labels{/name}","comments_url":"https://api.github.com/repos/cakephp/cakephp/issues/14032/comments","events_url":"https://api.github.com/repos/cakephp/cakephp/issues/14032/events","html_url":"https://github.com/cakephp/cakephp/issues/14032","id":538602235,"node_id":"MDU6SXNzdWU1Mzg2MDIyMzU=","number":14032,"title":"Testing EventFiredWith fails when comparing event data value","user":{"login":"mentisy","id":8539693,"node_id":"MDQ6VXNlcjg1Mzk2OTM=","avatar_url":"https://avatars.githubusercontent.com/u/8539693?v=4","gravatar_id":"","url":"https://api.github.com/users/mentisy","html_url":"https://github.com/mentisy","followers_url":"https://api.github.com/users/mentisy/followers","following_url":"https://api.github.com/users/mentisy/following{/other_user}","gists_url":"https://api.github.com/users/mentisy/gists{/gist_id}","starred_url":"https://api.github.com/users/mentisy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mentisy/subscriptions","organizations_url":"https://api.github.com/users/mentisy/orgs","repos_url":"https://api.github.com/users/mentisy/repos","events_url":"https://api.github.com/users/mentisy/events{/privacy}","received_events_url":"https://api.github.com/users/mentisy/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/cakephp/cakephp/milestones/212","html_url":"https://github.com/cakephp/cakephp/milestone/212","labels_url":"https://api.github.com/repos/cakephp/cakephp/milestones/212/labels","id":4934242,"node_id":"MDk6TWlsZXN0b25lNDkzNDI0Mg==","number":212,"title":"4.0.1","description":"Bugfixes for 4.0.","creator":{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":42,"state":"closed","created_at":"2019-12-16T03:02:24Z","updated_at":"2019-12-30T02:13:12Z","due_on":"2019-12-29T08:00:00Z","closed_at":"2019-12-30T02:13:12Z"},"comments":0,"created_at":"2019-12-16T19:19:50Z","updated_at":"2019-12-16T20:31:16Z","closed_at":"2019-12-16T20:31:16Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"This is a (multiple allowed):\r\n\r\n* [x] bug\r\n* [ ] enhancement\r\n* [ ] feature-discussion (RFC)\r\n\r\n* CakePHP Version: 767b164747df789db8c0fbcf3bcf9eaf3be55b38\r\n* Platform and Target: Windows 10 64-bit running on XAMPP, MySQL\r\n\r\n### What you did\r\nExisting application being migrated to 4.0. Old tests where asserting that an event is fired with an entity as dataValue is now failing on comparison. \r\n\r\nI have this simplified test in UsersTableTest to display the errors. This is pretty much taken straight from the 4.0 docs. https://book.cakephp.org/4/en/development/testing.html#testing-events\r\n```\r\npublic function testSave()\r\n{\r\n    $this->Users->getEventManager()->setEventList(new EventList());\r\n\r\n    $user = new User();\r\n    $user->name = \"Test person\";\r\n    $user->email = \"test@email.com\";\r\n    $user->password = \"a password\";\r\n\r\n    $this->Users->save($user);\r\n\r\n    $this->assertEventFired('Model.afterSave', $this->Users->getEventManager());\r\n    $this->assertEventFiredWith('Model.afterSave', 'entity', $user, $this->Users->getEventManager());\r\n}\r\n```\r\nThe first assertion if just to make sure that the event is fired at all. All failure messages come from the assertEventFiredWith assertion.\r\n\r\nFirst of all I am getting an error that says the $user variable needs to be string, object given. \r\nIf I add `(string)$user` to the assertion method instead, I can move on. After running the test again, I get a failed message saying:\r\n> Failed asserting that 'Model.afterSave' was fired with entity matching\r\n\r\nWhich makes sense, since it is now comparing a string to an Entity Object.\r\n\r\nIf I go to \r\nhttps://github.com/cakephp/cakephp/blob/master/src/TestSuite/Constraint/EventFiredWith.php#L104 \r\nand replace that line with `return (string)$event->getData($this->_dataKey) === $this->_dataValue;`\r\n\r\nthe test passes.\r\n\r\nSo I guess, why is the type hint set to string, when in reality more than strings should be able to be compared against?\r\n\r\nIf I remove the type hinting on the dataValue parameter, the tests also passes.\r\n\r\n### What were you expecting?\r\nI expect to be able to pass objects to the dataValue parameter of the EventFiredWith method, as to compare them against what is really being passed from the application Event.","closed_by":{"login":"dereuromark","id":39854,"node_id":"MDQ6VXNlcjM5ODU0","avatar_url":"https://avatars.githubusercontent.com/u/39854?v=4","gravatar_id":"","url":"https://api.github.com/users/dereuromark","html_url":"https://github.com/dereuromark","followers_url":"https://api.github.com/users/dereuromark/followers","following_url":"https://api.github.com/users/dereuromark/following{/other_user}","gists_url":"https://api.github.com/users/dereuromark/gists{/gist_id}","starred_url":"https://api.github.com/users/dereuromark/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dereuromark/subscriptions","organizations_url":"https://api.github.com/users/dereuromark/orgs","repos_url":"https://api.github.com/users/dereuromark/repos","events_url":"https://api.github.com/users/dereuromark/events{/privacy}","received_events_url":"https://api.github.com/users/dereuromark/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/cakephp/cakephp/issues/14032/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/cakephp/cakephp/issues/14032/timeline","performed_via_github_app":null,"state_reason":"completed"}