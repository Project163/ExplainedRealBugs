{"url":"https://api.github.com/repos/cakephp/cakephp/issues/18716","repository_url":"https://api.github.com/repos/cakephp/cakephp","labels_url":"https://api.github.com/repos/cakephp/cakephp/issues/18716/labels{/name}","comments_url":"https://api.github.com/repos/cakephp/cakephp/issues/18716/comments","events_url":"https://api.github.com/repos/cakephp/cakephp/issues/18716/events","html_url":"https://github.com/cakephp/cakephp/issues/18716","id":3114176054,"node_id":"I_kwDOAAoEbs65no42","number":18716,"title":"Chained calls to Table::find are not independent","user":{"login":"J4YB3","id":17246743,"node_id":"MDQ6VXNlcjE3MjQ2NzQz","avatar_url":"https://avatars.githubusercontent.com/u/17246743?v=4","gravatar_id":"","url":"https://api.github.com/users/J4YB3","html_url":"https://github.com/J4YB3","followers_url":"https://api.github.com/users/J4YB3/followers","following_url":"https://api.github.com/users/J4YB3/following{/other_user}","gists_url":"https://api.github.com/users/J4YB3/gists{/gist_id}","starred_url":"https://api.github.com/users/J4YB3/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/J4YB3/subscriptions","organizations_url":"https://api.github.com/users/J4YB3/orgs","repos_url":"https://api.github.com/users/J4YB3/repos","events_url":"https://api.github.com/users/J4YB3/events{/privacy}","received_events_url":"https://api.github.com/users/J4YB3/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":60504544,"node_id":"MDU6TGFiZWw2MDUwNDU0NA==","url":"https://api.github.com/repos/cakephp/cakephp/labels/defect","name":"defect","color":"e50f2c","default":false,"description":""},{"id":83815438,"node_id":"MDU6TGFiZWw4MzgxNTQzOA==","url":"https://api.github.com/repos/cakephp/cakephp/labels/ORM","name":"ORM","color":"0ed189","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/cakephp/cakephp/milestones/339","html_url":"https://github.com/cakephp/cakephp/milestone/339","labels_url":"https://api.github.com/repos/cakephp/cakephp/milestones/339/labels","id":12910548,"node_id":"MI_kwDOAAoEbs4AxP_U","number":339,"title":"5.2.5","description":"Bugfixes for 5.2","creator":{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":32,"state":"closed","created_at":"2025-05-17T03:17:01Z","updated_at":"2025-06-21T13:41:18Z","due_on":"2025-06-20T07:00:00Z","closed_at":"2025-06-21T13:41:18Z"},"comments":1,"created_at":"2025-06-03T14:15:58Z","updated_at":"2025-06-04T02:54:19Z","closed_at":"2025-06-04T02:54:19Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description\n\nI stumbled across a bug while using chained calls to different finders on a table.\n\nThe original bug is caused by this code snippet from my code:\n\n```php\n$affectedReservations = $this->Reservations\n    ->find('reservationsForThing', [$entity->id])\n    ->find('byTimespan', active: true, future: true);\n```\n\nThis produced the error \"Named parameter $active overwrites previous argument\". After investigating, I located the responsible lines in the `Table::invokeFinder` function.\n\nMy finders are defined like this:\n\n```php\npublic function findReservationsForDevices(\n    SelectQuery $query,\n    array $deviceIds,\n): SelectQuery {...}\n\npublic function findByTimespan(\n    SelectQuery $query,\n    bool $active = false,\n    bool $future = false,\n    bool $past = false,\n): SelectQuery {...}\n```\n\nWhat happens inside the `Table::invokeFinder` function is, that the arguments given to the finder are added to the `$query` instance via `$query->applyOptions($args)` in line 2705. This means, that the first call of `->find('reservationsForDevices', [$entity->id])` attaches the array containing the entity ID as a normal parameter into the `$args` array. The query arguments now look like this in case the entity ID is 2:\n\n```php\n$args = [\n    0 => [2],\n]\n```\n\nThe next call to the find function happens with named arguments: `->find('byTimespan', active: true, future: true)`. After attaching the new named arguments to the query in line 2705 and loading all arguments from the query in line 2707, the `$args` array looks like this:\n\n```php\n$args = [\n    0 => [2],\n    'active' => true,\n    'future' => true,\n]\n```\n\nHowever, this becomes a problem when invoking the actual finder in line 2728, since all `$args` are unwrapped and applied:\n\n```php\nreturn $callable($query, ...$args);\n```\n\nAs far as I understand, when trying to invoke my finder at the end of the `invokeFinder` method, the first argument, which is still coming from the first call to `findReservationsForDevices`, is written as the first argument of the `byTimespan` finder. Then, the `active` argument is written, which will now override the `$active` argument which was previously set by the positional argument. Therefore, the named parameter `active` would override the positional argument `$active = [2]`.\n\nWorkaround/Solution: When I use a named parameter for the first finder as well, everything works as expected.\n\n## Conclusion\nChained calls to finder methods are not independent of each other. This is also reflected in a related bug described further down. However, when using the query builder syntax with chained finders, I never would have expected that the two calls to `find` would be related to each other in the end, and can affect each other like this. I think this is counter-intuitive.\n\n## Another related problem\nA related problem that arises from this behavior is, that we can't have multiple chained finders that use the same names for their parameters, in case we are not defining all parameters.\n\nSuppose I have two finders like this:\n\n```php\npublic function findA(SelectQuery $query, array $a): SelectQuery {...}\n\npublic function findAb(SelectQuery $query, bool $a = true, bool $b = false): SelectQuery {...}\n```\n\nIf I call them like this, everything works:\n\n```php\n// This is okay\n$table->find('a', a: [])->find('ab', a: true, b: false);\n```\n\nBut if I don't define `a` in the second call, this results in an error, because `a` was already defined as an array in the first call, and persists inside the $query object. However, the second finder doesn't re-declare `a` again, which is why the persisted value is given to the second finder instead. This results in a Type error, because the array given to the second finder is not acceptable as a bool type:\n\n```php\n// Type error, because [] is used for bool $a in the second finder\n$table->find('a', a: [])->find('ab', b: false);\n```\n\nAgain, this is counter-intuitive. Especially, when a default value is defined for `$a` and `$b` in the `findAb` function, I would expect the default value to be used. But in the case that I don't specifically define all parameters for the second finder, the previously set values from finders before that bleed into the latter finder instead.\n\n### CakePHP Version\n\n5.1.6\n\n### PHP Version\n\n8.3","closed_by":{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/cakephp/cakephp/issues/18716/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/cakephp/cakephp/issues/18716/timeline","performed_via_github_app":null,"state_reason":"completed"}