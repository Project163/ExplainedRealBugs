{"url":"https://api.github.com/repos/cakephp/cakephp/issues/16432","repository_url":"https://api.github.com/repos/cakephp/cakephp","labels_url":"https://api.github.com/repos/cakephp/cakephp/issues/16432/labels{/name}","comments_url":"https://api.github.com/repos/cakephp/cakephp/issues/16432/comments","events_url":"https://api.github.com/repos/cakephp/cakephp/issues/16432/events","html_url":"https://github.com/cakephp/cakephp/issues/16432","id":1193174731,"node_id":"I_kwDOAAoEbs5HHmbL","number":16432,"title":"BelongsToMany + matching ignores bindingKey","user":{"login":"zachee54","id":42939319,"node_id":"MDQ6VXNlcjQyOTM5MzE5","avatar_url":"https://avatars.githubusercontent.com/u/42939319?v=4","gravatar_id":"","url":"https://api.github.com/users/zachee54","html_url":"https://github.com/zachee54","followers_url":"https://api.github.com/users/zachee54/followers","following_url":"https://api.github.com/users/zachee54/following{/other_user}","gists_url":"https://api.github.com/users/zachee54/gists{/gist_id}","starred_url":"https://api.github.com/users/zachee54/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zachee54/subscriptions","organizations_url":"https://api.github.com/users/zachee54/orgs","repos_url":"https://api.github.com/users/zachee54/repos","events_url":"https://api.github.com/users/zachee54/events{/privacy}","received_events_url":"https://api.github.com/users/zachee54/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":60504544,"node_id":"MDU6TGFiZWw2MDUwNDU0NA==","url":"https://api.github.com/repos/cakephp/cakephp/labels/defect","name":"defect","color":"e50f2c","default":false,"description":""},{"id":83815438,"node_id":"MDU6TGFiZWw4MzgxNTQzOA==","url":"https://api.github.com/repos/cakephp/cakephp/labels/ORM","name":"ORM","color":"0ed189","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/cakephp/cakephp/milestones/274","html_url":"https://github.com/cakephp/cakephp/milestone/274","labels_url":"https://api.github.com/repos/cakephp/cakephp/milestones/274/labels","id":7811448,"node_id":"MI_kwDOAAoEbs4AdzF4","number":274,"title":"4.3.8","description":"Bugfixes for 4.3.","creator":{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":18,"state":"closed","created_at":"2022-03-28T14:51:23Z","updated_at":"2022-04-23T01:47:20Z","due_on":"2022-04-22T07:00:00Z","closed_at":"2022-04-23T01:47:20Z"},"comments":4,"created_at":"2022-04-05T13:46:09Z","updated_at":"2022-04-11T21:11:08Z","closed_at":"2022-04-11T21:11:08Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description\n\nBelongsToMany with custom bindingKey works well with `contain()`, but ignores the bindingKey with `matching()` and fallbacks to primary key.\r\n\r\n## Database schema\r\n```\r\nCREATE TABLE `tags` (\r\n  `id` int unsigned NOT NULL,\r\n  `name` varchar(50) NOT NULL,\r\n  PRIMARY KEY (`id`)\r\n);\r\n\r\nCREATE TABLE `articles` (\r\n  `id` int unsigned NOT NULL,\r\n  `title` varchar(50) NOT NULL,\r\n  PRIMARY KEY (`id`)\r\n);\r\n\r\nCREATE TABLE `articles_tags` (\r\n  `tagname` varchar(50) NOT NULL, // Be aware that junction table references tag names\r\n  `article_id` int unsigned NOT NULL,\r\n  PRIMARY KEY (`tagname`,`article_id`)\r\n);\r\n```\r\n## Model definition\r\n```\r\nclass TagsTable extends Table\r\n{\r\n    public function initialize(array $config): void\r\n    {\r\n        parent::initialize($config);\r\n\r\n        $this->setTable('tags');\r\n        $this->setDisplayField('name');\r\n        $this->setPrimaryKey('id');\r\n\r\n        $this->belongsToMany('Articles', [\r\n            'foreignKey' => 'tagname',\r\n            'targetForeignKey' => 'article_id',\r\n            'bindingKey' => 'name', // This is the point\r\n            'joinTable' => 'articles_tags',\r\n        ]);\r\n    }\r\n}\r\n```\r\n## Controller\r\n```\r\nclass TagsController extends AppController\r\n{\r\n    public function index()\r\n    {\r\n        $tags = $this->Tags->find()\r\n          ->matching('Articles', function ($q) {\r\n            return $q->where('Articles.id > 0');\r\n          })\r\n          ->all();\r\n\r\n        $this->set(compact('tags'));\r\n    }\r\n}\r\n```\r\n## Generated query\r\n```\r\nSELECT \r\n  Tags.id AS Tags__id, \r\n  Tags.name AS Tags__name, \r\n  ArticlesTags.tagname AS ArticlesTags__tagname, \r\n  ArticlesTags.article_id AS ArticlesTags__article_id, \r\n  Articles.id AS Articles__id, \r\n  Articles.title AS Articles__title \r\nFROM \r\n  tags Tags \r\n  INNER JOIN articles_tags ArticlesTags ON Tags.id = ArticlesTags.tagname \r\n  INNER JOIN articles Articles ON (\r\n    Articles.id > 0 \r\n    AND Articles.id = ArticlesTags.article_id\r\n  )\r\n```\r\n\r\nObviously `Tags.id = ArticlesTags.tagname` tries to match tag name in junction table with tag id on source table, ignoring the custom binding key.\r\nIn contrast, the query works well with contain, although makes impossible to filter with conditions on associated data.\n\n### CakePHP Version\n\n4.3.7\n\n### PHP Version\n\n7.4.3","closed_by":{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/cakephp/cakephp/issues/16432/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/cakephp/cakephp/issues/16432/timeline","performed_via_github_app":null,"state_reason":"completed"}