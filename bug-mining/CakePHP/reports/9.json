{"url":"https://api.github.com/repos/cakephp/cakephp/issues/9227","repository_url":"https://api.github.com/repos/cakephp/cakephp","labels_url":"https://api.github.com/repos/cakephp/cakephp/issues/9227/labels{/name}","comments_url":"https://api.github.com/repos/cakephp/cakephp/issues/9227/comments","events_url":"https://api.github.com/repos/cakephp/cakephp/issues/9227/events","html_url":"https://github.com/cakephp/cakephp/issues/9227","id":169822137,"node_id":"MDU6SXNzdWUxNjk4MjIxMzc=","number":9227,"title":"DatabaseSession triggers warning when session is restarted","user":{"login":"thinkingmedia","id":551022,"node_id":"MDQ6VXNlcjU1MTAyMg==","avatar_url":"https://avatars.githubusercontent.com/u/551022?v=4","gravatar_id":"","url":"https://api.github.com/users/thinkingmedia","html_url":"https://github.com/thinkingmedia","followers_url":"https://api.github.com/users/thinkingmedia/followers","following_url":"https://api.github.com/users/thinkingmedia/following{/other_user}","gists_url":"https://api.github.com/users/thinkingmedia/gists{/gist_id}","starred_url":"https://api.github.com/users/thinkingmedia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/thinkingmedia/subscriptions","organizations_url":"https://api.github.com/users/thinkingmedia/orgs","repos_url":"https://api.github.com/users/thinkingmedia/repos","events_url":"https://api.github.com/users/thinkingmedia/events{/privacy}","received_events_url":"https://api.github.com/users/thinkingmedia/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":60504544,"node_id":"MDU6TGFiZWw2MDUwNDU0NA==","url":"https://api.github.com/repos/cakephp/cakephp/labels/defect","name":"defect","color":"e50f2c","default":false,"description":""},{"id":60525626,"node_id":"MDU6TGFiZWw2MDUyNTYyNg==","url":"https://api.github.com/repos/cakephp/cakephp/labels/need%20more%20info","name":"need more info","color":"eb6420","default":false,"description":""},{"id":72146358,"node_id":"MDU6TGFiZWw3MjE0NjM1OA==","url":"https://api.github.com/repos/cakephp/cakephp/labels/network","name":"network","color":"ffffff","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/cakephp/cakephp/milestones/100","html_url":"https://github.com/cakephp/cakephp/milestone/100","labels_url":"https://api.github.com/repos/cakephp/cakephp/milestones/100/labels","id":1981216,"node_id":"MDk6TWlsZXN0b25lMTk4MTIxNg==","number":100,"title":"3.3.4","description":"Bugfixes and minor features for 3.3.x","creator":{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":68,"state":"closed","created_at":"2016-09-03T02:27:21Z","updated_at":"2016-09-25T00:58:59Z","due_on":"2016-09-23T07:00:00Z","closed_at":"2016-09-25T00:58:59Z"},"comments":24,"created_at":"2016-08-07T23:24:07Z","updated_at":"2016-09-20T17:28:41Z","closed_at":"2016-09-20T17:28:41Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"This is a (multiple allowed):\n- [x] bug\n- [ ] enhancement\n- [ ] feature-discussion (RFC)\n- CakePHP Version: 3.2.12\n- Platform and Target: Apache 2.4, MySQL, PHP 7\n### What you did\n\nI get a 100% reproducible warning when restarting sessions that use the database for storage.\n\n```\nWarning (2): session_regenerate_id() [function.session-regenerate-id]: Session object destruction failed.  ID: user (path: ) [CORE\\src\\Network\\Session.php, line 578]\n```\n## Steps to reproduce\n1. Configure database sessions.\n2. Start a user session in the browser.\n3. Wait for the session to timeout.\n4. Make a web request to CakePHP\n5. Session is restarted and triggers warning.\n\nHere is my `app.php` configuration.\n\n```\n    'Session' => [\n        'cookie' => 'ahtag',\n        'defaults' => 'database',\n        'timeout' => 30,\n        'handler' => [\n            'model' => 'UserSessions'\n        ]\n    ],\n```\n\nThe problem here is that the session ID is used to restore the previous session, but that ID has been deleted from the database.\n\nThat happens in `Session.php, line 330` here:\n\n```\n        if ($this->_timedOut()) {\n            $this->destroy();\n            return $this->start();\n        }\n```\n\nThe destroy calls the database storage which does a table delete query on that ID. Later the `Session::renew()` is called and `session_id()` returns that same ID but PHP can not continue the session since the storage is now gone.\n\n> Note: It has taken me a while to gather the reasons behind this bug, because it requires a user's session to expire first and that makes it difficult to debug and trace.\n### Expected Behavior\n\nShould continue the session with out a warning, or it should just start a new session successfully.\n### Actual Behavior\n\nIt's a mix between code in CakePHP and the PHP session APIs. The `Session.php` is clearly deleting the previous session and then trying to start another one, but the code also tries to continue the previous one.\n\nI don't know what the current solution is?\n1. Should `Session::renew` be calling `session_regenerate_id`?\n2. Should `Session::start()` be destroying the old session?\n3. Should the `DatabaseSession` be deleting session records (i.e. should session records be allowed to stay around for X number of days)\n","closed_by":{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/cakephp/cakephp/issues/9227/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/cakephp/cakephp/issues/9227/timeline","performed_via_github_app":null,"state_reason":"completed"}