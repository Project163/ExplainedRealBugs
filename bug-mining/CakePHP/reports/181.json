{"url":"https://api.github.com/repos/cakephp/cakephp/issues/15008","repository_url":"https://api.github.com/repos/cakephp/cakephp","labels_url":"https://api.github.com/repos/cakephp/cakephp/issues/15008/labels{/name}","comments_url":"https://api.github.com/repos/cakephp/cakephp/issues/15008/comments","events_url":"https://api.github.com/repos/cakephp/cakephp/issues/15008/events","html_url":"https://github.com/cakephp/cakephp/issues/15008","id":713108719,"node_id":"MDU6SXNzdWU3MTMxMDg3MTk=","number":15008,"title":"Wrong case of alias in having/where clauses","user":{"login":"rturella3","id":65632255,"node_id":"MDQ6VXNlcjY1NjMyMjU1","avatar_url":"https://avatars.githubusercontent.com/u/65632255?v=4","gravatar_id":"","url":"https://api.github.com/users/rturella3","html_url":"https://github.com/rturella3","followers_url":"https://api.github.com/users/rturella3/followers","following_url":"https://api.github.com/users/rturella3/following{/other_user}","gists_url":"https://api.github.com/users/rturella3/gists{/gist_id}","starred_url":"https://api.github.com/users/rturella3/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rturella3/subscriptions","organizations_url":"https://api.github.com/users/rturella3/orgs","repos_url":"https://api.github.com/users/rturella3/repos","events_url":"https://api.github.com/users/rturella3/events{/privacy}","received_events_url":"https://api.github.com/users/rturella3/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":60504544,"node_id":"MDU6TGFiZWw2MDUwNDU0NA==","url":"https://api.github.com/repos/cakephp/cakephp/labels/defect","name":"defect","color":"e50f2c","default":false,"description":""},{"id":366710731,"node_id":"MDU6TGFiZWwzNjY3MTA3MzE=","url":"https://api.github.com/repos/cakephp/cakephp/labels/database","name":"database","color":"ffffff","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/cakephp/cakephp/milestones/239","html_url":"https://github.com/cakephp/cakephp/milestone/239","labels_url":"https://api.github.com/repos/cakephp/cakephp/milestones/239/labels","id":5948928,"node_id":"MDk6TWlsZXN0b25lNTk0ODkyOA==","number":239,"title":"4.1.6","description":"Bugfixes for 4.1","creator":{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":45,"state":"closed","created_at":"2020-10-05T01:16:51Z","updated_at":"2020-11-08T02:51:38Z","due_on":"2020-11-07T08:00:00Z","closed_at":"2020-11-08T02:51:38Z"},"comments":0,"created_at":"2020-10-01T19:04:38Z","updated_at":"2020-10-13T16:07:54Z","closed_at":"2020-10-13T16:07:54Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"This is a (multiple allowed):\r\n\r\n* [x] bug\r\n* [ ] enhancement\r\n* [ ] feature-discussion (RFC)\r\n\r\n* CakePHP Version: 4.1.4.\r\n* Platform and Target: Mysql 5.7.14, PHP 7.2.28.\r\n\r\n### What you did\r\n```\r\nCREATE TABLE test (\r\n\tid INT NOT NULL PRIMARY KEY AUTO_INCREMENT, \r\n\ttest VARCHAR(250)\r\n) ENGINE=INNODB CHARSET=utf8mb4;\r\n```\r\n\r\n```\r\n// in a controller\r\n$this->loadModel('Test');\r\n\r\n$test = $this->Test->find()->group(['Test.test'])->having([\r\n\t'COUNT(DISTINCT Test.id) >' => 1,\r\n]);\r\n\r\ndebug($test);\r\n```\r\n\r\n### What happened\r\n\r\nThe query generated was:\r\n\r\n```\r\nSELECT Test.id AS Test__id, Test.test AS Test__test FROM test Test GROUP BY Test.test  HAVING COUNT(DISTINCT test.id) > :c0 \r\n```\r\n\r\nAnd the MySQL error:\r\n\r\n```\r\nError: [PDOException] SQLSTATE[42S22]: Column not found: 1054 Unknown column 'test.id' in 'having clause'\r\n```\r\n\r\n### What you expected to happen\r\n\r\nI was expecting the query to be:\r\n\r\n```\r\nSELECT Test.id AS Test__id, Test.test AS Test__test FROM test Test GROUP BY Test.test  HAVING COUNT(DISTINCT Test.id) > :c0 \r\n```\r\n\r\nThe case of the column after the `DISTINCT` has been lowered. That was fine with a MySQL database on Windows, but when I moved the database to Linux, which is case-sensitive, an error of unknown column occurred.\r\n\r\nAdding backticks didn't worked also:\r\n\r\n```\r\n$test = $this->Test->find()->group(['Test.test'])->having([\r\n\t'COUNT(DISTINCT `Test.id`) >' => 1,\r\n]);\r\n```\r\n\r\nGenerates:\r\n\r\n```\r\nSELECT Test.id AS Test__id, Test.test AS Test__test FROM test Test GROUP BY Test.test  HAVING COUNT(DISTINCT `test.id`) > :c0 \r\n```\r\n\r\nThe same happens on `where` clause function also.\r\n\r\nI think it it related to spaces in the string of the clause, because the following code will also lowercase the alias:\r\n\r\n```\r\n$test = $this->Test->find()->group(['Test.test'])->where([\r\n\t'AAA(BBB( Test.id)) >' => 1,\r\n]);\r\n```\r\n\r\nOutput:\r\n\r\n```\r\nSELECT Test.id AS Test__id, Test.test AS Test__test FROM test Test WHERE AAA(BBB( test.id)) > :c0 GROUP BY Test.test \r\n```\r\n\r\nAdding backticks to the where clause will also keep the alias lowercase.\r\nBut if I remove the space before the \"Test.id\" in the where clause, I get the correct case of the alias:\r\n\r\n```\r\n$test = $this->Test->find()->group(['Test.test'])->where([\r\n\t'AAA(BBB(Test.id)) >' => 1,\r\n]);\r\n```\r\n\r\nOutput:\r\n\r\n```\r\nSELECT Test.id AS Test__id, Test.test AS Test__test FROM test Test WHERE AAA(BBB(Test.id)) > :c0 GROUP BY Test.test \r\n```\r\n\r\nI was able to solve using `distinct` function of the query builder and removing unnecessary spaces.\r\n\r\nI did not expected this behavior and was caught of surprise. Lost some time debugging and changing some of my code. Sorry if it's not a bug.\r\n","closed_by":{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/cakephp/cakephp/issues/15008/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/cakephp/cakephp/issues/15008/timeline","performed_via_github_app":null,"state_reason":"completed"}