{"url":"https://api.github.com/repos/cakephp/cakephp/issues/16499","repository_url":"https://api.github.com/repos/cakephp/cakephp","labels_url":"https://api.github.com/repos/cakephp/cakephp/issues/16499/labels{/name}","comments_url":"https://api.github.com/repos/cakephp/cakephp/issues/16499/comments","events_url":"https://api.github.com/repos/cakephp/cakephp/issues/16499/events","html_url":"https://github.com/cakephp/cakephp/issues/16499","id":1237161462,"node_id":"I_kwDOAAoEbs5JvZX2","number":16499,"title":"Non-consistent afterSaveCommit dispatch in saveMany in Table.php","user":{"login":"OlofMorra","id":7305332,"node_id":"MDQ6VXNlcjczMDUzMzI=","avatar_url":"https://avatars.githubusercontent.com/u/7305332?v=4","gravatar_id":"","url":"https://api.github.com/users/OlofMorra","html_url":"https://github.com/OlofMorra","followers_url":"https://api.github.com/users/OlofMorra/followers","following_url":"https://api.github.com/users/OlofMorra/following{/other_user}","gists_url":"https://api.github.com/users/OlofMorra/gists{/gist_id}","starred_url":"https://api.github.com/users/OlofMorra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/OlofMorra/subscriptions","organizations_url":"https://api.github.com/users/OlofMorra/orgs","repos_url":"https://api.github.com/users/OlofMorra/repos","events_url":"https://api.github.com/users/OlofMorra/events{/privacy}","received_events_url":"https://api.github.com/users/OlofMorra/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":60504544,"node_id":"MDU6TGFiZWw2MDUwNDU0NA==","url":"https://api.github.com/repos/cakephp/cakephp/labels/defect","name":"defect","color":"e50f2c","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/cakephp/cakephp/milestones/277","html_url":"https://github.com/cakephp/cakephp/milestone/277","labels_url":"https://api.github.com/repos/cakephp/cakephp/milestones/277/labels","id":7979489,"node_id":"MI_kwDOAAoEbs4AecHh","number":277,"title":"4.3.10","description":"Bugfixes for 4.3.","creator":{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":11,"state":"closed","created_at":"2022-05-14T01:29:15Z","updated_at":"2022-06-05T23:42:14Z","due_on":"2022-06-03T07:00:00Z","closed_at":"2022-06-05T23:42:14Z"},"comments":4,"created_at":"2022-05-16T13:27:22Z","updated_at":"2022-05-23T07:11:23Z","closed_at":"2022-05-23T05:11:23Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description\r\n\r\nWhen executing a save on a table, Model.afterSaveCommit is dispatched if the transaction is committed. However, this method is also used for saveMany (and saveManyOrFail), so in a different context. Then, the save method does not dispatch Model.afterSaveCommit as the transaction is not yet committed. Now, the save method cleans the entity and sets new to false. After all calls to save from saveMany Model.afterSaveCommit is dispatched with cleaned entities, hence, the information for dirty fields and original values is lost and is not passed to Model.afterSaveCommit. \r\n\r\nIn cakephp/src/ORM/Table.php\r\n```php\r\n\r\nprotected function _saveMany(iterable $entities, $options = []): iterable\r\n    {\r\n        ...\r\n\r\n        try {\r\n            $this->getConnection()\r\n                ->transactional(function () use ($entities, $options, &$isNew, &$failed) {\r\n                    foreach ($entities as $key => $entity) {\r\n                        $isNew[$key] = $entity->isNew();\r\n                        // normal save called here, so each entity is cleaned here\r\n                        if ($this->save($entity, $options) === false) {\r\n                            $failed = $entity;\r\n\r\n                            return false;\r\n                        }\r\n                    }\r\n                });\r\n        } catch (Exception $e) {\r\n            $cleanup($entities);\r\n\r\n            throw $e;\r\n        }\r\n\r\n       ...\r\n\r\n        if ($this->_transactionCommitted($options['atomic'], $options['_primary'])) {\r\n            foreach ($entities as $entity) {\r\n                // Cleaned entities are passed with the dispatch, missing dirty and original fields\r\n                $this->dispatchEvent('Model.afterSaveCommit', compact('entity', 'options'));\r\n            }\r\n        }\r\n\r\n        return $entities;\r\n    }\r\n\r\npublic function save(EntityInterface $entity, $options = [])\r\n    {\r\n        ...\r\n\r\n        if ($success) {\r\n            // transaction is committed for single save, but not for saveMany operation\r\n            if ($this->_transactionCommitted($options['atomic'], $options['_primary'])) {\r\n                $this->dispatchEvent('Model.afterSaveCommit', compact('entity', 'options'));\r\n            }\r\n            // For saveMany the entity is cleaned here, but the dispatch above was not executed.\r\n            // Hence, all fields unset by clean are lost (dirty, original, etc.)\r\n            if ($options['atomic'] || $options['_primary']) {\r\n                $entity->clean();\r\n                $entity->setNew(false);\r\n                $entity->setSource($this->getRegistryAlias());\r\n            }\r\n        }\r\n\r\n        return $success;\r\n    }\r\n```\r\n\r\nWhat I expected is that a saveMany dispatches the model.afterSaveCommit with the dirty and original values. So, I propose to execute the clean operation for entities saved via saveMany only after the dispatchEvent in the _saveMany method. \r\n\r\nLet me know if you agree with my logic, then I will make an MR!\r\n\r\n### CakePHP Version\r\n\r\n4.3.9\r\n\r\n### PHP Version\r\n\r\n8.1.5","closed_by":{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/cakephp/cakephp/issues/16499/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/cakephp/cakephp/issues/16499/timeline","performed_via_github_app":null,"state_reason":"completed"}