{"url":"https://api.github.com/repos/cakephp/cakephp/issues/16848","repository_url":"https://api.github.com/repos/cakephp/cakephp","labels_url":"https://api.github.com/repos/cakephp/cakephp/issues/16848/labels{/name}","comments_url":"https://api.github.com/repos/cakephp/cakephp/issues/16848/comments","events_url":"https://api.github.com/repos/cakephp/cakephp/issues/16848/events","html_url":"https://github.com/cakephp/cakephp/issues/16848","id":1437040104,"node_id":"I_kwDOAAoEbs5Vp33o","number":16848,"title":"Sqlserver driver: add an flag option to disable cursor client buffer","user":{"login":"celsowm","id":369336,"node_id":"MDQ6VXNlcjM2OTMzNg==","avatar_url":"https://avatars.githubusercontent.com/u/369336?v=4","gravatar_id":"","url":"https://api.github.com/users/celsowm","html_url":"https://github.com/celsowm","followers_url":"https://api.github.com/users/celsowm/followers","following_url":"https://api.github.com/users/celsowm/following{/other_user}","gists_url":"https://api.github.com/users/celsowm/gists{/gist_id}","starred_url":"https://api.github.com/users/celsowm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/celsowm/subscriptions","organizations_url":"https://api.github.com/users/celsowm/orgs","repos_url":"https://api.github.com/users/celsowm/repos","events_url":"https://api.github.com/users/celsowm/events{/privacy}","received_events_url":"https://api.github.com/users/celsowm/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":60504144,"node_id":"MDU6TGFiZWw2MDUwNDE0NA==","url":"https://api.github.com/repos/cakephp/cakephp/labels/enhancement","name":"enhancement","color":"bfe5bf","default":true,"description":""},{"id":1552340707,"node_id":"MDU6TGFiZWwxNTUyMzQwNzA3","url":"https://api.github.com/repos/cakephp/cakephp/labels/pinned","name":"pinned","color":"ef81ca","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/cakephp/cakephp/milestones/304","html_url":"https://github.com/cakephp/cakephp/milestone/304","labels_url":"https://api.github.com/repos/cakephp/cakephp/milestones/304/labels","id":10051364,"node_id":"MI_kwDOAAoEbs4AmV8k","number":304,"title":"4.6.0","description":"New features and forwards compatible changes for 4.x and backports from 5.x","creator":{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":16,"state":"closed","created_at":"2023-10-15T02:59:23Z","updated_at":"2025-03-23T02:55:17Z","due_on":"2025-03-22T07:00:00Z","closed_at":"2025-03-23T02:55:17Z"},"comments":16,"created_at":"2022-11-05T13:54:26Z","updated_at":"2024-11-02T16:57:42Z","closed_at":"2024-11-02T16:57:41Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description\r\n\r\nIn some situations, its desired to avoid the use of the [SQL Server Driver Client buffer](https://learn.microsoft.com/en-us/sql/connect/php/cursor-types-pdo-sqlsrv-driver?view=sql-server-ver16) (examples: performance, large result sets, use of varbinary etc.)\r\nCurrently, on CakePHP4.*, the are only \"two\" ways:\r\n\r\n- **First**: using **disableBufferedResults()** in all queries that can/could have potential to overflow the client buffer\r\n- **Second**: creating a CustomDriver extending Cake\\Database\\Driver\\Sqlserver and overwriting the [prepare method](https://github.com/cakephp/cakephp/blob/4.x/src/Database/Driver/Sqlserver.php#L200)  literally removing [this line](https://github.com/cakephp/cakephp/blob/78c541b884c04c9fbd983950b61c46ecb6a7a6ee/src/Database/Driver/Sqlserver.php#L207):\r\n`PDO::SQLSRV_ATTR_CURSOR_SCROLL_TYPE => PDO::SQLSRV_CURSOR_BUFFERED`\r\n\r\nI would like to propose a simple modification of on Sqlserver driver:\r\n\r\n```php\r\npublic function prepare($query): StatementInterface\r\n    {\r\n        $this->connect();\r\n\r\n        $sql = $query;\r\n        $options = [\r\n            PDO::ATTR_CURSOR => PDO::CURSOR_SCROLL,\r\n            $this->_config['flags'][PDO::SQLSRV_ATTR_CURSOR_SCROLL_TYPE]\r\n        ];\r\n        if ($query instanceof Query) {\r\n            $sql = $query->sql();\r\n            if (count($query->getValueBinder()->bindings()) > 2100) {\r\n                throw new InvalidArgumentException(\r\n                    'Exceeded maximum number of parameters (2100) for prepared statements in Sql Server. ' .\r\n                    'This is probably due to a very large WHERE IN () clause which generates a parameter ' .\r\n                    'for each value in the array. ' .\r\n                    'If using an Association, try changing the `strategy` from select to subquery.'\r\n                );\r\n            }\r\n\r\n            if (!$query->isBufferedResultsEnabled()) {\r\n                $options = [];\r\n            }\r\n        }\r\n\r\n        /** @psalm-suppress PossiblyInvalidArgument */\r\n        $statement = $this->_connection->prepare($sql, $options);\r\n\r\n        return new SqlserverStatement($statement, $this);\r\n    }\r\n\r\n```\r\n\r\nand of course a default setting for CURSOR on [connect()](https://github.com/cakephp/cakephp/blob/78c541b884c04c9fbd983950b61c46ecb6a7a6ee/src/Database/Driver/Sqlserver.php#L114) method, something like that:\r\n\r\n```php\r\nif (!$config['flags'][PDO::SQLSRV_ATTR_CURSOR_SCROLL_TYPE]) {\r\n            $config['flags'][PDO::SQLSRV_ATTR_CURSOR_SCROLL_TYPE] = PDO::SQLSRV_CURSOR_BUFFERED\r\n        }\r\n```\r\n\r\nI hope the devs consider this because currently I have had to create a custom driver to run my real application with sql server \r\n\r\n### CakePHP Version\r\n\r\n4.*","closed_by":{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/cakephp/cakephp/issues/16848/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/cakephp/cakephp/issues/16848/timeline","performed_via_github_app":null,"state_reason":"completed"}