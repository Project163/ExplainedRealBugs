{"url":"https://api.github.com/repos/cakephp/cakephp/issues/18968","repository_url":"https://api.github.com/repos/cakephp/cakephp","labels_url":"https://api.github.com/repos/cakephp/cakephp/issues/18968/labels{/name}","comments_url":"https://api.github.com/repos/cakephp/cakephp/issues/18968/comments","events_url":"https://api.github.com/repos/cakephp/cakephp/issues/18968/events","html_url":"https://github.com/cakephp/cakephp/issues/18968","id":3509109371,"node_id":"I_kwDOAAoEbs7RKMJ7","number":18968,"title":"SmtpTransport fails to detect broken socket and tries to reuse it infinitely","user":{"login":"bugbreeder","id":12463926,"node_id":"MDQ6VXNlcjEyNDYzOTI2","avatar_url":"https://avatars.githubusercontent.com/u/12463926?v=4","gravatar_id":"","url":"https://api.github.com/users/bugbreeder","html_url":"https://github.com/bugbreeder","followers_url":"https://api.github.com/users/bugbreeder/followers","following_url":"https://api.github.com/users/bugbreeder/following{/other_user}","gists_url":"https://api.github.com/users/bugbreeder/gists{/gist_id}","starred_url":"https://api.github.com/users/bugbreeder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bugbreeder/subscriptions","organizations_url":"https://api.github.com/users/bugbreeder/orgs","repos_url":"https://api.github.com/users/bugbreeder/repos","events_url":"https://api.github.com/users/bugbreeder/events{/privacy}","received_events_url":"https://api.github.com/users/bugbreeder/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":60504544,"node_id":"MDU6TGFiZWw2MDUwNDU0NA==","url":"https://api.github.com/repos/cakephp/cakephp/labels/defect","name":"defect","color":"e50f2c","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/cakephp/cakephp/milestones/344","html_url":"https://github.com/cakephp/cakephp/milestone/344","labels_url":"https://api.github.com/repos/cakephp/cakephp/milestones/344/labels","id":13751782,"node_id":"MI_kwDOAAoEbs4A0dXm","number":344,"title":"5.2.9","description":"Bugfixes for 5.2","creator":{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":20,"state":"closed","created_at":"2025-09-24T03:00:58Z","updated_at":"2025-10-24T04:02:50Z","due_on":"2025-10-17T07:00:00Z","closed_at":"2025-10-24T04:02:50Z"},"comments":0,"created_at":"2025-10-13T09:01:43Z","updated_at":"2025-10-15T14:55:49Z","closed_at":"2025-10-15T14:55:48Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description\n\nWe have a problem with sending emails. Our configuration uses an external SMTP server, i.e. transport configured to `'className' => 'Smtp'`. We use the Queue system to send mails, but with a custom Job that basically calls\n`TransportFactory::get($transport)->send($message)`. (With some additional try/catch, logging and marking items as sent/done.)\n\nThe problem is that the mail server is a bit unreliable. The network connection sometime breaks, leading to the \"SMTP Timeout\" exception in _smtpSend. (Log mentions `fwrite(): SSL: Broken pipe`.) This in itself is a minor problem.\n\nThe big problem is that the SmtpTransport apparently does not detect that the connection is broken. When it is reused for the next mail it detects the apparently existing connection and tries to send a RSET. This fails, because the connection is already broken. Repeatedly. Apparently this connection is never cleaned up, rendering the SmtpTransport - which is infinitely reused by the factory - unable to send any other mail ever again. I need to manually restart the queue process to get it back to work.\n\nAt a first glance it looks that there is a try/catch missing or the isConnected method needs to be more thorough.\n\nOne workaround I'm going to try is calling an explicit disconnect() before (re)using the transport.\n\nImportant note: We currently use an older version of CakePHP and we need to upgrade eventually. But as far as I have checked the relevant code has not changed, so I expect the same problem to happen in the current 5.x branch.\n\n### CakePHP Version\n\n4.3\n\n### PHP Version\n\n8.2.1","closed_by":{"login":"dereuromark","id":39854,"node_id":"MDQ6VXNlcjM5ODU0","avatar_url":"https://avatars.githubusercontent.com/u/39854?v=4","gravatar_id":"","url":"https://api.github.com/users/dereuromark","html_url":"https://github.com/dereuromark","followers_url":"https://api.github.com/users/dereuromark/followers","following_url":"https://api.github.com/users/dereuromark/following{/other_user}","gists_url":"https://api.github.com/users/dereuromark/gists{/gist_id}","starred_url":"https://api.github.com/users/dereuromark/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dereuromark/subscriptions","organizations_url":"https://api.github.com/users/dereuromark/orgs","repos_url":"https://api.github.com/users/dereuromark/repos","events_url":"https://api.github.com/users/dereuromark/events{/privacy}","received_events_url":"https://api.github.com/users/dereuromark/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/cakephp/cakephp/issues/18968/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/cakephp/cakephp/issues/18968/timeline","performed_via_github_app":null,"state_reason":"completed"}