{"url":"https://api.github.com/repos/cakephp/cakephp/issues/14564","repository_url":"https://api.github.com/repos/cakephp/cakephp","labels_url":"https://api.github.com/repos/cakephp/cakephp/issues/14564/labels{/name}","comments_url":"https://api.github.com/repos/cakephp/cakephp/issues/14564/comments","events_url":"https://api.github.com/repos/cakephp/cakephp/issues/14564/events","html_url":"https://github.com/cakephp/cakephp/issues/14564","id":614189317,"node_id":"MDU6SXNzdWU2MTQxODkzMTc=","number":14564,"title":"RFC: No way to reset Query::$_resultsCount","user":{"login":"Phally","id":112639,"node_id":"MDQ6VXNlcjExMjYzOQ==","avatar_url":"https://avatars.githubusercontent.com/u/112639?v=4","gravatar_id":"","url":"https://api.github.com/users/Phally","html_url":"https://github.com/Phally","followers_url":"https://api.github.com/users/Phally/followers","following_url":"https://api.github.com/users/Phally/following{/other_user}","gists_url":"https://api.github.com/users/Phally/gists{/gist_id}","starred_url":"https://api.github.com/users/Phally/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Phally/subscriptions","organizations_url":"https://api.github.com/users/Phally/orgs","repos_url":"https://api.github.com/users/Phally/repos","events_url":"https://api.github.com/users/Phally/events{/privacy}","received_events_url":"https://api.github.com/users/Phally/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":60504137,"node_id":"MDU6TGFiZWw2MDUwNDEzNw==","url":"https://api.github.com/repos/cakephp/cakephp/labels/RFC","name":"RFC","color":"c7def8","default":false,"description":null},{"id":366710731,"node_id":"MDU6TGFiZWwzNjY3MTA3MzE=","url":"https://api.github.com/repos/cakephp/cakephp/labels/database","name":"database","color":"ffffff","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/cakephp/cakephp/milestones/202","html_url":"https://github.com/cakephp/cakephp/milestone/202","labels_url":"https://api.github.com/repos/cakephp/cakephp/milestones/202/labels","id":4446782,"node_id":"MDk6TWlsZXN0b25lNDQ0Njc4Mg==","number":202,"title":"3.9.0","description":"","creator":{"login":"ravage84","id":625761,"node_id":"MDQ6VXNlcjYyNTc2MQ==","avatar_url":"https://avatars.githubusercontent.com/u/625761?v=4","gravatar_id":"","url":"https://api.github.com/users/ravage84","html_url":"https://github.com/ravage84","followers_url":"https://api.github.com/users/ravage84/followers","following_url":"https://api.github.com/users/ravage84/following{/other_user}","gists_url":"https://api.github.com/users/ravage84/gists{/gist_id}","starred_url":"https://api.github.com/users/ravage84/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ravage84/subscriptions","organizations_url":"https://api.github.com/users/ravage84/orgs","repos_url":"https://api.github.com/users/ravage84/repos","events_url":"https://api.github.com/users/ravage84/events{/privacy}","received_events_url":"https://api.github.com/users/ravage84/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":113,"state":"closed","created_at":"2019-06-27T16:30:16Z","updated_at":"2020-06-21T16:11:40Z","due_on":"2020-06-19T07:00:00Z","closed_at":"2020-06-21T16:09:25Z"},"comments":11,"created_at":"2020-05-07T16:29:57Z","updated_at":"2020-05-18T00:44:10Z","closed_at":"2020-05-18T00:44:10Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Issue\r\n\r\nThere's no direct way to reset the result set + count in a query object. It's the exacty functionality implemented in `Query::_dirty()`.\r\n\r\nThis is for CakePHP 3.x and 4.x.\r\n\r\nBasically, it's for reusing Query objects to run the same query many times. \r\n\r\nIn the past I've done a few things to work around it, but I keep bumping into it. See the use case below.\r\n\r\nThings I've done in the past to work around it:\r\n- Wrap the `$this->query()->..` in a method so I get a new query instance every time.\r\n- Clone the query object every time and then execute the clones instead.\r\n- Override `Table::query()` to give me a custom Query object with a `clean()` method which calls `Query::_dirty()`. (my personal favorite)\r\n\r\nAll these things work, but I feel this is missing in the framework.\r\n\r\n\r\n### Proposal\r\n\r\nI'm proposing a new public method `Query::clean()` which simply calls `Query::_dirty()`.\r\n\r\nAlternatively, I'm fine with having `Query::setResult(null)` call `Query::_dirty()` instead.\r\n\r\nWhich has your preference and should I send in a pull request?\r\n\r\n\r\n### Example use case\r\n\r\nIt comes down to reusing a query object when importing changes from a different table. These source tables are placed in the database using ETL for example.\r\n\r\nThese are tables with millions of rows and the number of changes are large as well. The sources can rarely be trusted to give us perfect data, so we almost always have to validate it as well.\r\n\r\nSo what I do is make a query that joins the source and target tables where the fields are different. This query will only give me the changed records and the new ones. A bit like a negative select query.\r\n\r\nI set an appropriate limit to the query so we don't run out of memory, let's say 1000 and then I'll execute this query in a loop until it no longer gives any results.\r\n\r\nIn the loop I will validate the data and update the target table(s) accordingly.\r\n\r\nSo, in this use case I execute the exact same query up to 100 times. `while ($query->count()) { .. }` won't work in the current situation. Not even after calling `Query::setResult(null)`.","closed_by":{"login":"markstory","id":24086,"node_id":"MDQ6VXNlcjI0MDg2","avatar_url":"https://avatars.githubusercontent.com/u/24086?v=4","gravatar_id":"","url":"https://api.github.com/users/markstory","html_url":"https://github.com/markstory","followers_url":"https://api.github.com/users/markstory/followers","following_url":"https://api.github.com/users/markstory/following{/other_user}","gists_url":"https://api.github.com/users/markstory/gists{/gist_id}","starred_url":"https://api.github.com/users/markstory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markstory/subscriptions","organizations_url":"https://api.github.com/users/markstory/orgs","repos_url":"https://api.github.com/users/markstory/repos","events_url":"https://api.github.com/users/markstory/events{/privacy}","received_events_url":"https://api.github.com/users/markstory/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/cakephp/cakephp/issues/14564/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/cakephp/cakephp/issues/14564/timeline","performed_via_github_app":null,"state_reason":"completed"}