{"url":"https://api.github.com/repos/neovim/neovim/issues/27942","repository_url":"https://api.github.com/repos/neovim/neovim","labels_url":"https://api.github.com/repos/neovim/neovim/issues/27942/labels{/name}","comments_url":"https://api.github.com/repos/neovim/neovim/issues/27942/comments","events_url":"https://api.github.com/repos/neovim/neovim/issues/27942/events","html_url":"https://github.com/neovim/neovim/issues/27942","id":2196340480,"node_id":"I_kwDOAPphoM6C6X8A","number":27942,"title":"ERROR in finalizer: bad argument #(...) (treesitter_treecursor expected, got no value)","user":{"login":"przepompownia","id":11404453,"node_id":"MDQ6VXNlcjExNDA0NDUz","avatar_url":"https://avatars.githubusercontent.com/u/11404453?v=4","gravatar_id":"","url":"https://api.github.com/users/przepompownia","html_url":"https://github.com/przepompownia","followers_url":"https://api.github.com/users/przepompownia/followers","following_url":"https://api.github.com/users/przepompownia/following{/other_user}","gists_url":"https://api.github.com/users/przepompownia/gists{/gist_id}","starred_url":"https://api.github.com/users/przepompownia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/przepompownia/subscriptions","organizations_url":"https://api.github.com/users/przepompownia/orgs","repos_url":"https://api.github.com/users/przepompownia/repos","events_url":"https://api.github.com/users/przepompownia/events{/privacy}","received_events_url":"https://api.github.com/users/przepompownia/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":435854234,"node_id":"MDU6TGFiZWw0MzU4NTQyMzQ=","url":"https://api.github.com/repos/neovim/neovim/labels/bug-crash","name":"bug-crash","color":"F9D0C4","default":false,"description":"issue reporting a crash or segfault"},{"id":619474658,"node_id":"MDU6TGFiZWw2MTk0NzQ2NTg=","url":"https://api.github.com/repos/neovim/neovim/labels/bug-regression","name":"bug-regression","color":"f9d0c4","default":false,"description":"wrong behavior that was introduced in a previous commit (please bisect)"},{"id":1481421490,"node_id":"MDU6TGFiZWwxNDgxNDIxNDkw","url":"https://api.github.com/repos/neovim/neovim/labels/has:bisected","name":"has:bisected","color":"0E8A16","default":false,"description":"issue has been tracked to a specific commit"},{"id":1799626557,"node_id":"MDU6TGFiZWwxNzk5NjI2NTU3","url":"https://api.github.com/repos/neovim/neovim/labels/treesitter","name":"treesitter","color":"c5def5","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"lewis6991","id":7904185,"node_id":"MDQ6VXNlcjc5MDQxODU=","avatar_url":"https://avatars.githubusercontent.com/u/7904185?v=4","gravatar_id":"","url":"https://api.github.com/users/lewis6991","html_url":"https://github.com/lewis6991","followers_url":"https://api.github.com/users/lewis6991/followers","following_url":"https://api.github.com/users/lewis6991/following{/other_user}","gists_url":"https://api.github.com/users/lewis6991/gists{/gist_id}","starred_url":"https://api.github.com/users/lewis6991/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lewis6991/subscriptions","organizations_url":"https://api.github.com/users/lewis6991/orgs","repos_url":"https://api.github.com/users/lewis6991/repos","events_url":"https://api.github.com/users/lewis6991/events{/privacy}","received_events_url":"https://api.github.com/users/lewis6991/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"lewis6991","id":7904185,"node_id":"MDQ6VXNlcjc5MDQxODU=","avatar_url":"https://avatars.githubusercontent.com/u/7904185?v=4","gravatar_id":"","url":"https://api.github.com/users/lewis6991","html_url":"https://github.com/lewis6991","followers_url":"https://api.github.com/users/lewis6991/followers","following_url":"https://api.github.com/users/lewis6991/following{/other_user}","gists_url":"https://api.github.com/users/lewis6991/gists{/gist_id}","starred_url":"https://api.github.com/users/lewis6991/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lewis6991/subscriptions","organizations_url":"https://api.github.com/users/lewis6991/orgs","repos_url":"https://api.github.com/users/lewis6991/repos","events_url":"https://api.github.com/users/lewis6991/events{/privacy}","received_events_url":"https://api.github.com/users/lewis6991/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":4,"created_at":"2024-03-20T00:36:28Z","updated_at":"2024-03-20T10:56:17Z","closed_at":"2024-03-20T10:56:17Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Problem\r\n\r\nI'm not sure if it's related to Neovim. Having fresh (master) nvim-treesitter with enabled highlight and indentation I get\r\n\r\n```lua\r\n{ naERROR in finalizer: bad argument #-10004 to 'match' (treesitter_treecursor expected, got no value)\r\n\tinit.lua [+]                                                                                          stack traceback:                                                                                                        70,5           Bot\r\n\t\t-- INSERT --                                                                                                            [C]: in function 'match'\r\n\t\t...from-src/share/nvim/runtime/lua/vim/treesitter/query.lua:745: in function 'match_preds'\r\n\t\t...from-src/share/nvim/runtime/lua/vim/treesitter/query.lua:955: in function '(for generator)'\r\n\t\t...c/share/nvim/runtime/lua/vim/treesitter/languagetree.lua:855: in function 'f'\r\n\t\t...c/share/nvim/runtime/lua/vim/treesitter/languagetree.lua:190: in function 'tcall'\r\n\t\t...c/share/nvim/runtime/lua/vim/treesitter/languagetree.lua:381: in function '_add_injections'\r\n\t\t...c/share/nvim/runtime/lua/vim/treesitter/languagetree.lua:444: in function 'parse'\r\n\t\t...rc/share/nvim/runtime/lua/vim/treesitter/highlighter.lua:391: in function <...rc/share/nvim/runtime/lua/vim/treesitter/highlighter.lua:386>\r\n\t\tERROR in finalizer: bad argument #-10004 to 'match' (treesitter_treecursor expected, got no value)\r\n\t\tstack traceback:\r\n\r\n\t\t[C]: in function 'match'\r\n\t\t...from-src/share/nvim/runtime/lua/vim/treesitter/query.lua:745: in function 'match_preds'\r\n\t\t\t...from-src/share/nvim/runtime/lua/vim/treesitter/query.lua:955: in function '(for generator)'\r\n\t\t\t...c/share/nvim/runtime/lua/vim/treesitter/languagetree.lua:855: in function 'f'\r\n\t\t\t...c/share/nvim/runtime/lua/vim/treesitter/languagetree.lua:190: in function 'tcall'\r\n\t\t\t...c/share/nvim/runtime/lua/vim/treesitter/languagetree.lua:381: in function '_add_injections'\r\n\t\t\t...c/share/nvim/runtime/lua/vim/treesitter/languagetree.lua:444: in function 'parse'\r\n\t\t\t...rc/share/nvim/runtime/lua/vim/treesitter/highlighter.lua:391: in function <...rc/share/nvim/runtime/lua/vim/treesitter/highlighter.lua:386>                                                                                                                                                                                                                           6\r\n```\r\n\r\nwhen make some edits.\r\n\r\n\r\n### Steps to reproduce\r\n\r\ninit.lua:\r\n```lua\r\nlocal thisInitFile = debug.getinfo(1).source:match('@?(.*)')\r\nlocal configDir = vim.fs.dirname(thisInitFile)\r\n\r\nvim.env['XDG_CONFIG_HOME'] = configDir\r\nvim.env['XDG_DATA_HOME'] = vim.fs.joinpath(configDir, '.xdg', 'data')\r\nvim.env['XDG_STATE_HOME'] = vim.fs.joinpath(configDir, '.xdg', 'state')\r\nvim.env['XDG_CACHE_HOME'] = vim.fs.joinpath(configDir, '.xdg', 'cache')\r\nlocal stdPathConfig = vim.fn.stdpath('config')\r\n\r\nvim.opt.runtimepath:prepend(stdPathConfig)\r\nvim.opt.packpath:prepend(stdPathConfig)\r\n\r\nlocal function gitClone(url, installPath, branch)\r\n  if vim.fn.isdirectory(installPath) ~= 0 then\r\n    return\r\n  end\r\n\r\n  local command = {'git', 'clone', '--', url, installPath}\r\n  if branch then\r\n    table.insert(command, 3, '--branch')\r\n    table.insert(command, 4, branch)\r\n  end\r\n  local sysObj = vim.system(command, {}):wait()\r\n  if sysObj.code ~= 0 then\r\n    error(sysObj.stderr)\r\n  end\r\n  vim.notify(sysObj.stdout)\r\n  vim.notify(sysObj.stderr, vim.log.levels.WARN)\r\nend\r\n\r\nlocal pluginsPath = 'nvim/pack/plugins/opt'\r\nvim.fn.mkdir(pluginsPath, 'p')\r\npluginsPath = vim.uv.fs_realpath(pluginsPath)\r\n\r\n--- @type table<string, {url:string, branch: string?}>\r\nlocal plugins = {\r\n  ['nvim-treesitter'] = {url = 'https://github.com/nvim-treesitter/nvim-treesitter'},\r\n}\r\n\r\nfor name, repo in pairs(plugins) do\r\n  local installPath = vim.fs.joinpath(pluginsPath, name)\r\n  gitClone(repo.url, installPath, repo.branch)\r\n  -- vim.opt.runtimepath:append(installPath)\r\n  vim.cmd.packadd({args = {name}, bang = true})\r\nend\r\n\r\nrequire 'nvim-treesitter.configs'.setup {\r\n  ensure_installed = {\r\n  },\r\n  highlight = {\r\n    enable = true,\r\n  },\r\n  incremental_selection = {\r\n    enable = true,\r\n    keymaps = tsKeymaps,\r\n  },\r\n  indent = {\r\n    enable = true,\r\n  },\r\n}\r\n```\r\n\r\n- Run `nvim-src-clean -u init.lua init.lua`\r\n- type `Go` (start Insert mode at the end of file)\r\n- insert empty `{}` pair and then inside start typing `name = ''` - for me it's enough to reproduce this error. \r\n\r\n### Expected behavior\r\n\r\nNo error\r\n\r\n### Neovim version (nvim -v)\r\n\r\nv0.10.0-dev-2656+g37db3d97e\r\n\r\n### Vim (not Nvim) behaves the same?\r\n\r\n-\r\n\r\n### Operating system/version\r\n\r\nDebian Sid\r\n\r\n### Terminal name/version\r\n\r\nalacritty 0.13.1, tmux 3.4-2\r\n\r\n### $TERM environment variable\r\n\r\ntmux-256color\r\n\r\n### Installation\r\n\r\nfrom repo","closed_by":{"login":"lewis6991","id":7904185,"node_id":"MDQ6VXNlcjc5MDQxODU=","avatar_url":"https://avatars.githubusercontent.com/u/7904185?v=4","gravatar_id":"","url":"https://api.github.com/users/lewis6991","html_url":"https://github.com/lewis6991","followers_url":"https://api.github.com/users/lewis6991/followers","following_url":"https://api.github.com/users/lewis6991/following{/other_user}","gists_url":"https://api.github.com/users/lewis6991/gists{/gist_id}","starred_url":"https://api.github.com/users/lewis6991/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lewis6991/subscriptions","organizations_url":"https://api.github.com/users/lewis6991/orgs","repos_url":"https://api.github.com/users/lewis6991/repos","events_url":"https://api.github.com/users/lewis6991/events{/privacy}","received_events_url":"https://api.github.com/users/lewis6991/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/neovim/neovim/issues/27942/reactions","total_count":7,"+1":7,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/neovim/neovim/issues/27942/timeline","performed_via_github_app":null,"state_reason":"completed"}