{"url":"https://api.github.com/repos/neovim/neovim/issues/31316","repository_url":"https://api.github.com/repos/neovim/neovim","labels_url":"https://api.github.com/repos/neovim/neovim/issues/31316/labels{/name}","comments_url":"https://api.github.com/repos/neovim/neovim/issues/31316/comments","events_url":"https://api.github.com/repos/neovim/neovim/issues/31316/events","html_url":"https://github.com/neovim/neovim/issues/31316","id":2684991876,"node_id":"I_kwDOAPphoM6gCbmE","number":31316,"title":"Regression: race condition(?) in msgpack handling (from dc37c1550bed46fffbb677d343cdc5bc94056219)","user":{"login":"Lyude","id":1527057,"node_id":"MDQ6VXNlcjE1MjcwNTc=","avatar_url":"https://avatars.githubusercontent.com/u/1527057?v=4","gravatar_id":"","url":"https://api.github.com/users/Lyude","html_url":"https://github.com/Lyude","followers_url":"https://api.github.com/users/Lyude/followers","following_url":"https://api.github.com/users/Lyude/following{/other_user}","gists_url":"https://api.github.com/users/Lyude/gists{/gist_id}","starred_url":"https://api.github.com/users/Lyude/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Lyude/subscriptions","organizations_url":"https://api.github.com/users/Lyude/orgs","repos_url":"https://api.github.com/users/Lyude/repos","events_url":"https://api.github.com/users/Lyude/events{/privacy}","received_events_url":"https://api.github.com/users/Lyude/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":242522707,"node_id":"MDU6TGFiZWwyNDI1MjI3MDc=","url":"https://api.github.com/repos/neovim/neovim/labels/channels-rpc","name":"channels-rpc","color":"c7def8","default":false,"description":"channels, RPC, msgpack"},{"id":435851959,"node_id":"MDU6TGFiZWw0MzU4NTE5NTk=","url":"https://api.github.com/repos/neovim/neovim/labels/has:repro","name":"has:repro","color":"0E8A16","default":false,"description":"issue contains minimal reproducing steps"},{"id":619474658,"node_id":"MDU6TGFiZWw2MTk0NzQ2NTg=","url":"https://api.github.com/repos/neovim/neovim/labels/bug-regression","name":"bug-regression","color":"f9d0c4","default":false,"description":"wrong behavior that was introduced in a previous commit (please bisect)"},{"id":1481421490,"node_id":"MDU6TGFiZWwxNDgxNDIxNDkw","url":"https://api.github.com/repos/neovim/neovim/labels/has:bisected","name":"has:bisected","color":"0E8A16","default":false,"description":"issue has been tracked to a specific commit"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/neovim/neovim/milestones/51","html_url":"https://github.com/neovim/neovim/milestone/51","labels_url":"https://api.github.com/repos/neovim/neovim/milestones/51/labels","id":12988090,"node_id":"MI_kwDOAPphoM4Axi66","number":51,"title":"0.11.3","description":"","creator":{"login":"zeertzjq","id":35768171,"node_id":"MDQ6VXNlcjM1NzY4MTcx","avatar_url":"https://avatars.githubusercontent.com/u/35768171?v=4","gravatar_id":"","url":"https://api.github.com/users/zeertzjq","html_url":"https://github.com/zeertzjq","followers_url":"https://api.github.com/users/zeertzjq/followers","following_url":"https://api.github.com/users/zeertzjq/following{/other_user}","gists_url":"https://api.github.com/users/zeertzjq/gists{/gist_id}","starred_url":"https://api.github.com/users/zeertzjq/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zeertzjq/subscriptions","organizations_url":"https://api.github.com/users/zeertzjq/orgs","repos_url":"https://api.github.com/users/zeertzjq/repos","events_url":"https://api.github.com/users/zeertzjq/events{/privacy}","received_events_url":"https://api.github.com/users/zeertzjq/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":49,"state":"closed","created_at":"2025-05-30T23:27:41Z","updated_at":"2025-07-14T12:18:57Z","due_on":null,"closed_at":"2025-07-14T12:18:57Z"},"comments":18,"created_at":"2024-11-22T23:56:18Z","updated_at":"2025-06-12T21:30:28Z","closed_at":"2025-06-12T09:35:35Z","author_association":"NONE","type":{"id":597163,"node_id":"IT_kwDOAGK_Pc4ACRyr","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T10:10:19Z","updated_at":"2024-07-26T10:12:30Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Problem\n\nWhen sending very large completion lists to a GUI client that supports ext_popup with text input going at the same time, it's possible to trigger a race condition that causes neovim to return one of the completion results with the same message id as we expect for the RPC result response. I've attached a log with a debug trace of some of the RPC transactions happening between neovim-gtk and neovim that seem to cause this. [race-reproduced.txt](https://github.com/user-attachments/files/17877569/race-reproduced.txt)\n\nI managed to do some bisecting on neovim and tracked the breaking change down to dc37c1550bed46fffbb677d343cdc5bc94056219\n\n### Steps to reproduce\n\n~~I know, I'm really sorry :(. There's supposed to be some steps here, but I am going to need a bit of assistance from y'all in coming up with a reasonable way to reproduce this without pulling in my whole setup. I'm going to do my best to figure something out next week or after Thanksgiving if I can, but hopefully this is a start and maybe you guys have some ideas on how I could come up with a simpler reproducer. I think the key is going to be figuring out how I can get nvim to spit out a super large list of completion results without having my .vimrc present or needing to be in a project source tree.~~\n\nSorry it took so long! [We have a reproducer now](https://github.com/neovim/neovim/issues/31316#issuecomment-2691626043)\n\nAlso FWIW: The good news is I can reproduce this very reliably on my own system, as can a number of other people with substantially different setups than my own (and am going to ask anyone with an easy reproducer for this to make a post here)[race-reproduced.txt](https://github.com/user-attachments/files/17877567/race-reproduced.txt)\n. Anyway: I'm going to give you the steps I'm following locally here, and hopefully we can figure something out.\n\n* Have LSP setup on neovim, the LSP configuration I'm currently using is for rust-analyzer and the code I'm using to reproduce this problem is a kernel source tree here\n* Use neovim-gtk (hopefully other clients can hit this, but with how hard it was to find a consistent reproducer for this it's -probably- better just to use my client for now)\n* Open up a project where you can get neovim to generate a really, really big set of results for autocompletion. Ideally, it should lag things a bit.\n* Start typing such that neovim starts popping up completion results using neovim-gtk's ext_popup support\n* Repeat until it crashes and says it no longer can read messages from neovim.\n\n### Expected behavior\n\nnvim_input should never return anything but a u64 in the response field when responding to an nvim_input call.\n\n### Nvim version (nvim -v)\n\nv0.10.2\n\n### Vim (not Nvim) behaves the same?\n\nN/A (this is related to RPC, so...)\n\n### Operating system/version\n\nFedora 41\n\n### Terminal name/version\n\nneovim-gtk\n\n### $TERM environment variable\n\nN/A (I think?)\n\n### Installation\n\nFrom fedora repository, but I can trigger it by building from source","closed_by":{"login":"bfredl","id":1363104,"node_id":"MDQ6VXNlcjEzNjMxMDQ=","avatar_url":"https://avatars.githubusercontent.com/u/1363104?v=4","gravatar_id":"","url":"https://api.github.com/users/bfredl","html_url":"https://github.com/bfredl","followers_url":"https://api.github.com/users/bfredl/followers","following_url":"https://api.github.com/users/bfredl/following{/other_user}","gists_url":"https://api.github.com/users/bfredl/gists{/gist_id}","starred_url":"https://api.github.com/users/bfredl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bfredl/subscriptions","organizations_url":"https://api.github.com/users/bfredl/orgs","repos_url":"https://api.github.com/users/bfredl/repos","events_url":"https://api.github.com/users/bfredl/events{/privacy}","received_events_url":"https://api.github.com/users/bfredl/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/neovim/neovim/issues/31316/reactions","total_count":19,"+1":19,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/neovim/neovim/issues/31316/timeline","performed_via_github_app":null,"state_reason":"completed"}