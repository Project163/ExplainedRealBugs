{"url":"https://api.github.com/repos/neovim/neovim/issues/31270","repository_url":"https://api.github.com/repos/neovim/neovim","labels_url":"https://api.github.com/repos/neovim/neovim/issues/31270/labels{/name}","comments_url":"https://api.github.com/repos/neovim/neovim/issues/31270/comments","events_url":"https://api.github.com/repos/neovim/neovim/issues/31270/events","html_url":"https://github.com/neovim/neovim/issues/31270","id":2672092015,"node_id":"I_kwDOAPphoM6fRONv","number":31270,"title":"Pattern of vim.uri_encode() for RFC2732 has unescaped magic characters","user":{"login":"broken-pen","id":5731814,"node_id":"MDQ6VXNlcjU3MzE4MTQ=","avatar_url":"https://avatars.githubusercontent.com/u/5731814?v=4","gravatar_id":"","url":"https://api.github.com/users/broken-pen","html_url":"https://github.com/broken-pen","followers_url":"https://api.github.com/users/broken-pen/followers","following_url":"https://api.github.com/users/broken-pen/following{/other_user}","gists_url":"https://api.github.com/users/broken-pen/gists{/gist_id}","starred_url":"https://api.github.com/users/broken-pen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/broken-pen/subscriptions","organizations_url":"https://api.github.com/users/broken-pen/orgs","repos_url":"https://api.github.com/users/broken-pen/repos","events_url":"https://api.github.com/users/broken-pen/events{/privacy}","received_events_url":"https://api.github.com/users/broken-pen/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":573222693,"node_id":"MDU6TGFiZWw1NzMyMjI2OTM=","url":"https://api.github.com/repos/neovim/neovim/labels/lua","name":"lua","color":"c5def5","default":false,"description":"stdlib"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/neovim/neovim/milestones/45","html_url":"https://github.com/neovim/neovim/milestone/45","labels_url":"https://api.github.com/repos/neovim/neovim/milestones/45/labels","id":11652398,"node_id":"MI_kwDOAPphoM4Asc0u","number":45,"title":"0.10.3","description":"","creator":{"login":"justinmk","id":1359421,"node_id":"MDQ6VXNlcjEzNTk0MjE=","avatar_url":"https://avatars.githubusercontent.com/u/1359421?v=4","gravatar_id":"","url":"https://api.github.com/users/justinmk","html_url":"https://github.com/justinmk","followers_url":"https://api.github.com/users/justinmk/followers","following_url":"https://api.github.com/users/justinmk/following{/other_user}","gists_url":"https://api.github.com/users/justinmk/gists{/gist_id}","starred_url":"https://api.github.com/users/justinmk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/justinmk/subscriptions","organizations_url":"https://api.github.com/users/justinmk/orgs","repos_url":"https://api.github.com/users/justinmk/repos","events_url":"https://api.github.com/users/justinmk/events{/privacy}","received_events_url":"https://api.github.com/users/justinmk/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":28,"state":"closed","created_at":"2024-09-30T11:50:04Z","updated_at":"2024-12-23T12:24:35Z","due_on":"2024-12-25T08:00:00Z","closed_at":"2024-12-23T12:24:35Z"},"comments":0,"created_at":"2024-11-19T13:02:23Z","updated_at":"2024-12-11T13:48:36Z","closed_at":"2024-12-11T13:48:18Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Problem\n\nFor `vim.uri_encode()`, there is the following definition:\n```lua\nlocal PATTERNS = {\n  ...\n  -- RFC 2732\n  -- https://tools.ietf.org/html/rfc2732\n  rfc2732 = \"^A-Za-z0-9%-_.!~*'()[]\",\n  ...\n}\n```\nSome of the characters here have special meaning within Lua patterns and should be escaped.\n\nEspecially, `uri_encode()` is defined as follows:\n```lua\nfunction M.uri_encode(str, rfc)\n  local pattern = PATTERNS[rfc] or PATTERNS.rfc3986\n  return (str:gsub('([' .. pattern .. '])', percent_encode_char)) -- clamped to 1 retval with ()\nend\n```\n\nFor RFC2732, this gives the following pattern:\n```lua\nreturn (str:gsub('([^A-Za-z0-9%-_.!~*'()[]])', percent_encode_char))\n```\n\nThis makes a bit clearer that the pattern now has two unescaped closing brackets. The matcher interprets this as a character group followed by a literal closing bracket.\n\nThe solution would be to escape all magic characters in `PATTERNS` with percents.\n\n### Steps to reproduce\n\nThe following command:\n```\n:=vim.uri_encode('[:]', 'rfc2732')\n```\nproduces the output:\n```\n[%3a\n```\n\n### Expected behavior\n\nIt should produce the output:\n```\n[%3a]\n```\n(Mind the closing bracket.)\n\n### Nvim version (nvim -v)\n\n0.10.2\n\n### Vim (not Nvim) behaves the same?\n\nNo, this is a Lua-exclusive bug\n\n### Operating system/version\n\nFedora Silverblue 41\n\n### Terminal name/version\n\nkitty 0.36.4\n\n### $TERM environment variable\n\nxterm-kitty\n\n### Installation\n\nAppImage","closed_by":{"login":"justinmk","id":1359421,"node_id":"MDQ6VXNlcjEzNTk0MjE=","avatar_url":"https://avatars.githubusercontent.com/u/1359421?v=4","gravatar_id":"","url":"https://api.github.com/users/justinmk","html_url":"https://github.com/justinmk","followers_url":"https://api.github.com/users/justinmk/followers","following_url":"https://api.github.com/users/justinmk/following{/other_user}","gists_url":"https://api.github.com/users/justinmk/gists{/gist_id}","starred_url":"https://api.github.com/users/justinmk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/justinmk/subscriptions","organizations_url":"https://api.github.com/users/justinmk/orgs","repos_url":"https://api.github.com/users/justinmk/repos","events_url":"https://api.github.com/users/justinmk/events{/privacy}","received_events_url":"https://api.github.com/users/justinmk/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/neovim/neovim/issues/31270/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/neovim/neovim/issues/31270/timeline","performed_via_github_app":null,"state_reason":"completed"}