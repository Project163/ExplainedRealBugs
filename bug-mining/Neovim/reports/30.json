{"url":"https://api.github.com/repos/neovim/neovim/issues/27395","repository_url":"https://api.github.com/repos/neovim/neovim","labels_url":"https://api.github.com/repos/neovim/neovim/issues/27395/labels{/name}","comments_url":"https://api.github.com/repos/neovim/neovim/issues/27395/comments","events_url":"https://api.github.com/repos/neovim/neovim/issues/27395/events","html_url":"https://github.com/neovim/neovim/issues/27395","id":2126060928,"node_id":"I_kwDOAPphoM5-uR2A","number":27395,"title":"Omnisharp Lsp server return \"null\" not handled in Neovim","user":{"login":"teast","id":1667313,"node_id":"MDQ6VXNlcjE2NjczMTM=","avatar_url":"https://avatars.githubusercontent.com/u/1667313?v=4","gravatar_id":"","url":"https://api.github.com/users/teast","html_url":"https://github.com/teast","followers_url":"https://api.github.com/users/teast/followers","following_url":"https://api.github.com/users/teast/following{/other_user}","gists_url":"https://api.github.com/users/teast/gists{/gist_id}","starred_url":"https://api.github.com/users/teast/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/teast/subscriptions","organizations_url":"https://api.github.com/users/teast/orgs","repos_url":"https://api.github.com/users/teast/repos","events_url":"https://api.github.com/users/teast/events{/privacy}","received_events_url":"https://api.github.com/users/teast/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":662566370,"node_id":"MDU6TGFiZWw2NjI1NjYzNzA=","url":"https://api.github.com/repos/neovim/neovim/labels/lsp","name":"lsp","color":"c5def5","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2024-02-08T21:00:11Z","updated_at":"2024-08-06T21:43:57Z","closed_at":"2024-03-11T01:47:01Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Problem\r\n\r\nOmnisharp version 1.39.11\r\nNeovim version 0.9.5\r\nPlatform: Windows & Linux (not tested on mac)\r\n\r\nOmnisharp language server seems to return \"null\" on some communications.\r\nThis are currently not handled in neovim and therefore we see this error.\r\nWould be interesting if someone who is more knowledge regarding LSP's could chime in on this.\r\n\r\nThere is an issue open in Omnisharp's github too regarding this: https://github.com/OmniSharp/omnisharp-roslyn/issues/2574\r\n\r\nI have pinpointed the \"error\" to Client:handle_body function in rpc.lua\r\nthe pcall to vim.json.decode returns ok and therefore the code will continue and start checking underlying properties on decoded (that is nil) variable.\r\n\r\n```lua\r\n  local ok, decoded = pcall(vim.json.decode, body, { luanil = { object = true } })\r\n  if not ok then\r\n    self:on_error(client_errors.INVALID_SERVER_JSON, decoded)\r\n    return\r\n  end\r\n  local _ = log.debug() and log.debug('rpc.receive', decoded)\r\n\r\n  if type(decoded.method) == 'string' and decoded.id then\r\n  -- ...\r\n```\r\n\r\nIf we would include an check if decoded is nil and return the error stop happening. But I'm unsure if that is an expected behavior.\r\n\r\n```lua\r\n  local ok, decoded = pcall(vim.json.decode, body, { luanil = { object = true } })\r\n  -- ...\r\n\r\n  if decoded == nil then\r\n    return\r\n  end\r\n  if type(decoded.method) == 'string' and decoded.id then\r\n  -- ...\r\n```\r\n\r\nWould be interesting if someone who is more knowledge regarding LSP's could chime in on this.\r\n\r\n\r\nStacktrace:\r\n```text\r\nError executing luv callback:\r\nC:\\opt\\nvim\\share\\nvim\\runtime/lua/vim/lsp/rpc.lua:393: attempt to index local 'decoded' (a nil value)\r\nstack traceback:\r\n        C:\\opt\\nvim\\share\\nvim\\runtime/lua/vim/lsp/rpc.lua:393: in function 'handle_body'\r\n        C:\\opt\\nvim\\share\\nvim\\runtime/lua/vim/lsp/rpc.lua:743: in function 'handle_body'\r\n        C:\\opt\\nvim\\share\\nvim\\runtime/lua/vim/lsp/rpc.lua:263: in function <C:\\opt\\nvim\\share\\nvim\\runtime/lua/vim/lsp/rpc.lua:247>\r\n```\r\n\r\n### Steps to reproduce using \"nvim -u minimal_init.lua\"\r\n\r\nopen an .cs file. it is a ~70% chance that Omnisharp lsp server will return null\r\n\r\n### Expected behavior\r\n\r\n_No response_\r\n\r\n### Neovim version (nvim -v)\r\n\r\n0.9.5\r\n\r\n### Language server name/version\r\n\r\nOmnisharp 1.39.11\r\n\r\n### Operating system/version\r\n\r\nWindows 11\r\n\r\n### Log file\r\n\r\n_No response_","closed_by":{"login":"mfussenegger","id":38700,"node_id":"MDQ6VXNlcjM4NzAw","avatar_url":"https://avatars.githubusercontent.com/u/38700?v=4","gravatar_id":"","url":"https://api.github.com/users/mfussenegger","html_url":"https://github.com/mfussenegger","followers_url":"https://api.github.com/users/mfussenegger/followers","following_url":"https://api.github.com/users/mfussenegger/following{/other_user}","gists_url":"https://api.github.com/users/mfussenegger/gists{/gist_id}","starred_url":"https://api.github.com/users/mfussenegger/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mfussenegger/subscriptions","organizations_url":"https://api.github.com/users/mfussenegger/orgs","repos_url":"https://api.github.com/users/mfussenegger/repos","events_url":"https://api.github.com/users/mfussenegger/events{/privacy}","received_events_url":"https://api.github.com/users/mfussenegger/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/neovim/neovim/issues/27395/reactions","total_count":2,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/neovim/neovim/issues/27395/timeline","performed_via_github_app":null,"state_reason":"completed"}