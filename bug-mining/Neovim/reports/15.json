{"url":"https://api.github.com/repos/neovim/neovim/issues/27720","repository_url":"https://api.github.com/repos/neovim/neovim","labels_url":"https://api.github.com/repos/neovim/neovim/issues/27720/labels{/name}","comments_url":"https://api.github.com/repos/neovim/neovim/issues/27720/comments","events_url":"https://api.github.com/repos/neovim/neovim/issues/27720/events","html_url":"https://github.com/neovim/neovim/issues/27720","id":2165478672,"node_id":"I_kwDOAPphoM6BEpUQ","number":27720,"title":"`nvim_buf_set_lines` adjustment of cursor and of topline is inconsistent","user":{"login":"pysan3","id":41065736,"node_id":"MDQ6VXNlcjQxMDY1NzM2","avatar_url":"https://avatars.githubusercontent.com/u/41065736?v=4","gravatar_id":"","url":"https://api.github.com/users/pysan3","html_url":"https://github.com/pysan3","followers_url":"https://api.github.com/users/pysan3/followers","following_url":"https://api.github.com/users/pysan3/following{/other_user}","gists_url":"https://api.github.com/users/pysan3/gists{/gist_id}","starred_url":"https://api.github.com/users/pysan3/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pysan3/subscriptions","organizations_url":"https://api.github.com/users/pysan3/orgs","repos_url":"https://api.github.com/users/pysan3/repos","events_url":"https://api.github.com/users/pysan3/events{/privacy}","received_events_url":"https://api.github.com/users/pysan3/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":619474658,"node_id":"MDU6TGFiZWw2MTk0NzQ2NTg=","url":"https://api.github.com/repos/neovim/neovim/labels/bug-regression","name":"bug-regression","color":"f9d0c4","default":false,"description":"wrong behavior that was introduced in a previous commit (please bisect)"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/neovim/neovim/milestones/36","html_url":"https://github.com/neovim/neovim/milestone/36","labels_url":"https://api.github.com/repos/neovim/neovim/milestones/36/labels","id":8997654,"node_id":"MI_kwDOAPphoM4AiUsW","number":36,"title":"0.10","description":"","creator":{"login":"bfredl","id":1363104,"node_id":"MDQ6VXNlcjEzNjMxMDQ=","avatar_url":"https://avatars.githubusercontent.com/u/1363104?v=4","gravatar_id":"","url":"https://api.github.com/users/bfredl","html_url":"https://github.com/bfredl","followers_url":"https://api.github.com/users/bfredl/followers","following_url":"https://api.github.com/users/bfredl/following{/other_user}","gists_url":"https://api.github.com/users/bfredl/gists{/gist_id}","starred_url":"https://api.github.com/users/bfredl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bfredl/subscriptions","organizations_url":"https://api.github.com/users/bfredl/orgs","repos_url":"https://api.github.com/users/bfredl/repos","events_url":"https://api.github.com/users/bfredl/events{/privacy}","received_events_url":"https://api.github.com/users/bfredl/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":440,"state":"closed","created_at":"2023-02-02T14:11:43Z","updated_at":"2025-01-05T13:24:13Z","due_on":"2024-05-12T07:00:00Z","closed_at":"2024-05-16T14:11:42Z"},"comments":18,"created_at":"2024-03-03T18:15:15Z","updated_at":"2024-03-14T11:24:35Z","closed_at":"2024-03-14T11:24:34Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Problem\r\n\r\n```lua\r\nlocal lines = vim.api.nvim_buf_get_lines(0, 0, -1, false)\r\nvim.api.nvim_buf_set_lines(0, 0, #lines, true, lines)\r\n```\r\n\r\nI believe the above code should do nothing to the buffer, but with the latest nightly, buffer is scrolled downwards resulting an inconsistent user experience.\r\n\r\nI was not able to bisect the exact commit causing this problem, but I'm pretty sure this was caused by the series of refactoring https://github.com/neovim/neovim/pull/24889 done by @bfredl .\r\n\r\nI found several similar issues, but they referred to the issue with some plugin or lsp.format, whereas my _steps to reproduce_ is reproducible without any setup (nvim -u NONE).\r\n\r\n### Steps to reproduce\r\n\r\n**No config file required.** (nvim -u NONE)\r\n\r\n1. Open a file that has more lines than nvim's window height.\r\n3. `G` to go to the bottom.\r\n4. `H` to move the cursor to the top of the window.\r\n5. Run the following code.\r\n\r\n```lua\r\nlocal lines = vim.api.nvim_buf_get_lines(0, 0, -1, false)\r\nvim.api.nvim_buf_set_lines(0, 0, #lines, true, lines)\r\n```\r\n\r\n### Result\r\n\r\nThe buffer and cursor moves down and lands one line above the bottom `scrolloff`. The exact same behavior as doing `zb` after `step 3.`.\r\n\r\n### Expected behavior\r\n\r\nDo not scroll the buffer, and have no visual change in above case.\r\n\r\n### Neovim version (nvim -v)\r\n\r\nNVIM v0.10.0-dev-2504+g3971797be1\r\n\r\n### Vim (not Nvim) behaves the same?\r\n\r\nN/A\r\n\r\n### Operating system/version\r\n\r\nLinux\r\n\r\n### Terminal name/version\r\n\r\nWezterm\r\n\r\n### $TERM environment variable\r\n\r\ntmux-256color\r\n\r\n### Installation\r\n\r\nBuild from source","closed_by":{"login":"bfredl","id":1363104,"node_id":"MDQ6VXNlcjEzNjMxMDQ=","avatar_url":"https://avatars.githubusercontent.com/u/1363104?v=4","gravatar_id":"","url":"https://api.github.com/users/bfredl","html_url":"https://github.com/bfredl","followers_url":"https://api.github.com/users/bfredl/followers","following_url":"https://api.github.com/users/bfredl/following{/other_user}","gists_url":"https://api.github.com/users/bfredl/gists{/gist_id}","starred_url":"https://api.github.com/users/bfredl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bfredl/subscriptions","organizations_url":"https://api.github.com/users/bfredl/orgs","repos_url":"https://api.github.com/users/bfredl/repos","events_url":"https://api.github.com/users/bfredl/events{/privacy}","received_events_url":"https://api.github.com/users/bfredl/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/neovim/neovim/issues/27720/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/neovim/neovim/issues/27720/timeline","performed_via_github_app":null,"state_reason":"completed"}