{"url":"https://api.github.com/repos/neovim/neovim/issues/28281","repository_url":"https://api.github.com/repos/neovim/neovim","labels_url":"https://api.github.com/repos/neovim/neovim/issues/28281/labels{/name}","comments_url":"https://api.github.com/repos/neovim/neovim/issues/28281/comments","events_url":"https://api.github.com/repos/neovim/neovim/issues/28281/events","html_url":"https://github.com/neovim/neovim/issues/28281","id":2238294349,"node_id":"I_kwDOAPphoM6FaalN","number":28281,"title":"LSP: tolerate invalid paths in locations_to_items","user":{"login":"chenf7","id":60933600,"node_id":"MDQ6VXNlcjYwOTMzNjAw","avatar_url":"https://avatars.githubusercontent.com/u/60933600?v=4","gravatar_id":"","url":"https://api.github.com/users/chenf7","html_url":"https://github.com/chenf7","followers_url":"https://api.github.com/users/chenf7/followers","following_url":"https://api.github.com/users/chenf7/following{/other_user}","gists_url":"https://api.github.com/users/chenf7/gists{/gist_id}","starred_url":"https://api.github.com/users/chenf7/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chenf7/subscriptions","organizations_url":"https://api.github.com/users/chenf7/orgs","repos_url":"https://api.github.com/users/chenf7/repos","events_url":"https://api.github.com/users/chenf7/events{/privacy}","received_events_url":"https://api.github.com/users/chenf7/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":298863445,"node_id":"MDU6TGFiZWwyOTg4NjM0NDU=","url":"https://api.github.com/repos/neovim/neovim/labels/needs:repro","name":"needs:repro","color":"FBCA04","default":false,"description":"We need minimal steps to reproduce the issue"},{"id":407246773,"node_id":"MDU6TGFiZWw0MDcyNDY3NzM=","url":"https://api.github.com/repos/neovim/neovim/labels/complexity:low","name":"complexity:low","color":"BFDADC","default":false,"description":"Low-risk, self-contained. Do NOT ask \"can I work on this\", just read CONTRIBUTING.md"},{"id":662566370,"node_id":"MDU6TGFiZWw2NjI1NjYzNzA=","url":"https://api.github.com/repos/neovim/neovim/labels/lsp","name":"lsp","color":"c5def5","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/neovim/neovim/milestones/6","html_url":"https://github.com/neovim/neovim/milestone/6","labels_url":"https://api.github.com/repos/neovim/neovim/milestones/6/labels","id":655037,"node_id":"MDk6TWlsZXN0b25lNjU1MDM3","number":6,"title":"backlog","description":"Low priority items. We plan to work on this but don't have a target date.","creator":{"login":"justinmk","id":1359421,"node_id":"MDQ6VXNlcjEzNTk0MjE=","avatar_url":"https://avatars.githubusercontent.com/u/1359421?v=4","gravatar_id":"","url":"https://api.github.com/users/justinmk","html_url":"https://github.com/justinmk","followers_url":"https://api.github.com/users/justinmk/followers","following_url":"https://api.github.com/users/justinmk/following{/other_user}","gists_url":"https://api.github.com/users/justinmk/gists{/gist_id}","starred_url":"https://api.github.com/users/justinmk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/justinmk/subscriptions","organizations_url":"https://api.github.com/users/justinmk/orgs","repos_url":"https://api.github.com/users/justinmk/repos","events_url":"https://api.github.com/users/justinmk/events{/privacy}","received_events_url":"https://api.github.com/users/justinmk/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":637,"closed_issues":749,"state":"open","created_at":"2014-05-10T20:43:04Z","updated_at":"2025-11-04T00:12:22Z","due_on":null,"closed_at":null},"comments":5,"created_at":"2024-04-11T18:15:29Z","updated_at":"2024-09-05T07:23:13Z","closed_at":"2024-09-05T07:23:13Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Problem\n\nI sometimes get an error when trying to go to definition of find code references. When the error occurs I get no results (no quick fix list). However, when checking the LspLog I see that a list of results is returned.\r\nThe list of results from LSP contains some non existing paths. The source of the problem is probably somewhere between sourcekit-lsp itself and my configuration files for the iOS project.\r\nHowever, I see no reason to give up on some of the correct results in the list just because of a few bad apples in it.\r\n\r\nThis is the error:\r\n```\r\nError executing vim.schedule lua callback: ...lar/neovim/0.9.4/share/nvim/runtime/lua/vim/lsp/util.lua:1828: index out of range\r\nstack traceback:\r\n        [C]: in function '_str_byteindex_enc'\r\n        ...lar/neovim/0.9.4/share/nvim/runtime/lua/vim/lsp/util.lua:1828: in function 'locations_to_items'\r\n        ...neovim/0.9.4/share/nvim/runtime/lua/vim/lsp/handlers.lua:398: in function 'handler'\r\n        ...w/Cellar/neovim/0.9.4/share/nvim/runtime/lua/vim/lsp.lua:1393: in function 'cb'\r\n        vim/_editor.lua:263: in function <vim/_editor.lua:262>\r\n```\r\n\r\nI propose to tolerate errors and just report them to the user. And this can also be put behind some config flag if ignoring errors feels to outrageous.\r\nIn `runtime/lua/vim/lsp/util.lua`, in function `M.locations_to_items`:\r\n```\r\n      local callOk, col = pcall(M._str_byteindex_enc, line, pos.character, offset_encoding)\r\n      if callOk then\r\n        table.insert(items, {\r\n          filename = filename,\r\n          lnum = row + 1,\r\n          col = col + 1,\r\n          text = line,\r\n          user_data = temp.location,\r\n        })\r\n      else\r\n        -- errorCount will be defined above, outside of the for loop\r\n        errorCount = errorCount + 1\r\n      end\r\n    end\r\n    -- out of for loop. notify on found errors\r\n    if errorCount > 0 then\r\n      print(\"Error found when processing LSP RPC.......\")\r\n    end\r\n``` \n\n### Steps to reproduce using \"nvim -u minimal_init.lua\"\n\nIn the unlikely scenario of working on an iOS xcworkspace with multiple xcodeproj projects and pod dependencies,\r\nRun either `vim.lsp.buf.definition` or `vim.lsp.buf.references` lua functions.\n\n### Expected behavior\n\n_No response_\n\n### Neovim version (nvim -v)\n\n0.9.4\n\n### Language server name/version\n\nsourcekit\n\n### Operating system/version\n\nmacOS 14.4.1\n\n### Log file\n\n_No response_","closed_by":{"login":"justinmk","id":1359421,"node_id":"MDQ6VXNlcjEzNTk0MjE=","avatar_url":"https://avatars.githubusercontent.com/u/1359421?v=4","gravatar_id":"","url":"https://api.github.com/users/justinmk","html_url":"https://github.com/justinmk","followers_url":"https://api.github.com/users/justinmk/followers","following_url":"https://api.github.com/users/justinmk/following{/other_user}","gists_url":"https://api.github.com/users/justinmk/gists{/gist_id}","starred_url":"https://api.github.com/users/justinmk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/justinmk/subscriptions","organizations_url":"https://api.github.com/users/justinmk/orgs","repos_url":"https://api.github.com/users/justinmk/repos","events_url":"https://api.github.com/users/justinmk/events{/privacy}","received_events_url":"https://api.github.com/users/justinmk/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/neovim/neovim/issues/28281/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/neovim/neovim/issues/28281/timeline","performed_via_github_app":null,"state_reason":"completed"}