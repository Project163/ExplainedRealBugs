{"url":"https://api.github.com/repos/neovim/neovim/issues/30846","repository_url":"https://api.github.com/repos/neovim/neovim","labels_url":"https://api.github.com/repos/neovim/neovim/issues/30846/labels{/name}","comments_url":"https://api.github.com/repos/neovim/neovim/issues/30846/comments","events_url":"https://api.github.com/repos/neovim/neovim/issues/30846/events","html_url":"https://github.com/neovim/neovim/issues/30846","id":2595092466,"node_id":"I_kwDOAPphoM6arffy","number":30846,"title":"empty output when executing `vim.system` in parallel","user":{"login":"vdrn","id":36032062,"node_id":"MDQ6VXNlcjM2MDMyMDYy","avatar_url":"https://avatars.githubusercontent.com/u/36032062?v=4","gravatar_id":"","url":"https://api.github.com/users/vdrn","html_url":"https://github.com/vdrn","followers_url":"https://api.github.com/users/vdrn/followers","following_url":"https://api.github.com/users/vdrn/following{/other_user}","gists_url":"https://api.github.com/users/vdrn/gists{/gist_id}","starred_url":"https://api.github.com/users/vdrn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vdrn/subscriptions","organizations_url":"https://api.github.com/users/vdrn/orgs","repos_url":"https://api.github.com/users/vdrn/repos","events_url":"https://api.github.com/users/vdrn/events{/privacy}","received_events_url":"https://api.github.com/users/vdrn/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":182884815,"node_id":"MDU6TGFiZWwxODI4ODQ4MTU=","url":"https://api.github.com/repos/neovim/neovim/labels/job-control","name":"job-control","color":"c5def5","default":false,"description":"OS processes, spawn"},{"id":242522707,"node_id":"MDU6TGFiZWwyNDI1MjI3MDc=","url":"https://api.github.com/repos/neovim/neovim/labels/channels-rpc","name":"channels-rpc","color":"c7def8","default":false,"description":"channels, RPC, msgpack"},{"id":713599092,"node_id":"MDU6TGFiZWw3MTM1OTkwOTI=","url":"https://api.github.com/repos/neovim/neovim/labels/system","name":"system","color":"c5def5","default":false,"description":"OS resources, pipes, streams"},{"id":5683343649,"node_id":"LA_kwDOAPphoM8AAAABUsDxIQ","url":"https://api.github.com/repos/neovim/neovim/labels/async","name":"async","color":"C5DEF5","default":false,"description":"futures/promises, async/await, concurrency, task pipelines"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/neovim/neovim/milestones/41","html_url":"https://github.com/neovim/neovim/milestone/41","labels_url":"https://api.github.com/repos/neovim/neovim/milestones/41/labels","id":10283236,"node_id":"MI_kwDOAPphoM4AnOjk","number":41,"title":"0.11","description":"","creator":{"login":"justinmk","id":1359421,"node_id":"MDQ6VXNlcjEzNTk0MjE=","avatar_url":"https://avatars.githubusercontent.com/u/1359421?v=4","gravatar_id":"","url":"https://api.github.com/users/justinmk","html_url":"https://github.com/justinmk","followers_url":"https://api.github.com/users/justinmk/followers","following_url":"https://api.github.com/users/justinmk/following{/other_user}","gists_url":"https://api.github.com/users/justinmk/gists{/gist_id}","starred_url":"https://api.github.com/users/justinmk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/justinmk/subscriptions","organizations_url":"https://api.github.com/users/justinmk/orgs","repos_url":"https://api.github.com/users/justinmk/repos","events_url":"https://api.github.com/users/justinmk/events{/privacy}","received_events_url":"https://api.github.com/users/justinmk/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":282,"state":"closed","created_at":"2023-12-07T23:09:35Z","updated_at":"2025-08-11T15:17:16Z","due_on":"2025-03-30T07:00:00Z","closed_at":"2025-03-26T14:28:55Z"},"comments":15,"created_at":"2024-10-17T15:36:27Z","updated_at":"2024-12-05T07:07:17Z","closed_at":"2024-12-04T14:44:41Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Problem\n\nWhen I try to run 2 `vim.system` requests at the same time, sometimes the one of the requests returns empty output. \nI'm reproducing the issue when running `nvim --clean` and sourcing the code below.\nUsing `vim.fn.jobstart` does not produce the same issue.\n\n``` lua\n-- test.lua\nlocal nvim_repo = \"/home/vedran/source/neovim\"\n\nfunction SystemTest()\n  local tries = 10\n  for i = 1, tries do\n    vim.defer_fn(function()\n      local file1 = nil\n      local file2 = nil\n      vim.system(\n        {\n          \"git\",\n          \"-C\", nvim_repo, \"cat-file\", \"-p\",\n          \"b7e896671500a6e9a0c773bc6bac2d073e588eba:src/nvim/tui/tui.c\"\n        },\n        { text = true },\n        function(o)\n          assert(o.code == 0)\n          file1 = o\n          if file2 then\n            -- print(\"2nd file finished first. Iter: \", i)\n            print(\"file1\", #file1.stdout)\n            print(\"file2\", #file2.stdout)\n          end\n        end\n      )\n      vim.system(\n        { \"git\", \"-C\", nvim_repo, \"cat-file\", \"-p\", \"4846bf05dc:src/nvim/tui/tui.c\" },\n        { text = true },\n        function(o)\n          assert(o.code == 0)\n          file2 = o\n          if file1 then\n            -- print(\"1st file finished first. Iter: \", i)\n            print(\"file1\", #file1.stdout)\n            print(\"file2\", #file2.stdout)\n          end\n        end\n      )\n    end, 0)\n  end\nend\nSystemTest()\n\n```\n\nExample output: \n```\nfile1 91246\nfile2 92332\n\nfile1 0\nfile2 92332\n\nfile1 91246\nfile2 92332\n\nfile1 91246\nfile2 92332\n\nfile1 91246\nfile2 92332\n\nfile1 91246\nfile2 0\n\nfile1 91246\nfile2 92332\n\nfile1 0\nfile2 92332\n\nfile1 91246\nfile2 92332\n\nfile1 91246\nfile2 92332\n```\n\nNeovim verison:\n```\nNVIM v0.11.0-dev-988+gfa6ab0d909\nBuild type: Release\nLuaJIT 2.1.1727870382\n```\n\n### Steps to reproduce\n\nmake sure to set `nvim_repo` in test.lua\n`nvim --clean test.lua`\n`:source`\n\n\n### Expected behavior\n\nI expect output to be \n```\nfile1 91246\nfile2 92332\n```\nrepeated 10 times\n\n### Nvim version (nvim -v)\n\nv0.11.0-dev-988+gfa6ab0d909\n\n### Vim (not Nvim) behaves the same?\n\nissue is with nvim only api\n\n### Operating system/version\n\nubuntu 20.04\n\n### Terminal name/version\n\nalacritty 0.12.0-dev (d5b2dac7)\n\n### $TERM environment variable\n\nscreen-256color\n\n### Installation\n\n build from repo ","closed_by":{"login":"lewis6991","id":7904185,"node_id":"MDQ6VXNlcjc5MDQxODU=","avatar_url":"https://avatars.githubusercontent.com/u/7904185?v=4","gravatar_id":"","url":"https://api.github.com/users/lewis6991","html_url":"https://github.com/lewis6991","followers_url":"https://api.github.com/users/lewis6991/followers","following_url":"https://api.github.com/users/lewis6991/following{/other_user}","gists_url":"https://api.github.com/users/lewis6991/gists{/gist_id}","starred_url":"https://api.github.com/users/lewis6991/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lewis6991/subscriptions","organizations_url":"https://api.github.com/users/lewis6991/orgs","repos_url":"https://api.github.com/users/lewis6991/repos","events_url":"https://api.github.com/users/lewis6991/events{/privacy}","received_events_url":"https://api.github.com/users/lewis6991/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/neovim/neovim/issues/30846/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/neovim/neovim/issues/30846/timeline","performed_via_github_app":null,"state_reason":"completed"}