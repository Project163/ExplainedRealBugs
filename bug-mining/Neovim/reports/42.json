{"url":"https://api.github.com/repos/neovim/neovim/issues/30656","repository_url":"https://api.github.com/repos/neovim/neovim","labels_url":"https://api.github.com/repos/neovim/neovim/issues/30656/labels{/name}","comments_url":"https://api.github.com/repos/neovim/neovim/issues/30656/comments","events_url":"https://api.github.com/repos/neovim/neovim/issues/30656/events","html_url":"https://github.com/neovim/neovim/issues/30656","id":2566305365,"node_id":"I_kwDOAPphoM6Y9rZV","number":30656,"title":"LSP completion: `CompleteDone`: unwanted cursor jumping","user":{"login":"przepompownia","id":11404453,"node_id":"MDQ6VXNlcjExNDA0NDUz","avatar_url":"https://avatars.githubusercontent.com/u/11404453?v=4","gravatar_id":"","url":"https://api.github.com/users/przepompownia","html_url":"https://github.com/przepompownia","followers_url":"https://api.github.com/users/przepompownia/followers","following_url":"https://api.github.com/users/przepompownia/following{/other_user}","gists_url":"https://api.github.com/users/przepompownia/gists{/gist_id}","starred_url":"https://api.github.com/users/przepompownia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/przepompownia/subscriptions","organizations_url":"https://api.github.com/users/przepompownia/orgs","repos_url":"https://api.github.com/users/przepompownia/repos","events_url":"https://api.github.com/users/przepompownia/events{/privacy}","received_events_url":"https://api.github.com/users/przepompownia/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":662566370,"node_id":"MDU6TGFiZWw2NjI1NjYzNzA=","url":"https://api.github.com/repos/neovim/neovim/labels/lsp","name":"lsp","color":"c5def5","default":false,"description":null},{"id":3214348835,"node_id":"MDU6TGFiZWwzMjE0MzQ4ODM1","url":"https://api.github.com/repos/neovim/neovim/labels/completion","name":"completion","color":"C5DEF5","default":false,"description":"Nvim built-in (omni)completion"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/neovim/neovim/milestones/41","html_url":"https://github.com/neovim/neovim/milestone/41","labels_url":"https://api.github.com/repos/neovim/neovim/milestones/41/labels","id":10283236,"node_id":"MI_kwDOAPphoM4AnOjk","number":41,"title":"0.11","description":"","creator":{"login":"justinmk","id":1359421,"node_id":"MDQ6VXNlcjEzNTk0MjE=","avatar_url":"https://avatars.githubusercontent.com/u/1359421?v=4","gravatar_id":"","url":"https://api.github.com/users/justinmk","html_url":"https://github.com/justinmk","followers_url":"https://api.github.com/users/justinmk/followers","following_url":"https://api.github.com/users/justinmk/following{/other_user}","gists_url":"https://api.github.com/users/justinmk/gists{/gist_id}","starred_url":"https://api.github.com/users/justinmk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/justinmk/subscriptions","organizations_url":"https://api.github.com/users/justinmk/orgs","repos_url":"https://api.github.com/users/justinmk/repos","events_url":"https://api.github.com/users/justinmk/events{/privacy}","received_events_url":"https://api.github.com/users/justinmk/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":282,"state":"closed","created_at":"2023-12-07T23:09:35Z","updated_at":"2025-08-11T15:17:16Z","due_on":"2025-03-30T07:00:00Z","closed_at":"2025-03-26T14:28:55Z"},"comments":2,"created_at":"2024-10-04T12:51:28Z","updated_at":"2024-10-10T09:40:05Z","closed_at":"2024-10-10T09:40:04Z","author_association":"CONTRIBUTOR","type":{"id":597163,"node_id":"IT_kwDOAGK_Pc4ACRyr","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T10:10:19Z","updated_at":"2024-07-26T10:12:30Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Problem\r\n\r\nI noticed that after expanding `vim._with()` context keys the cursor jumps to the end of line instead to the end of completed word (e.g. `bo`). I found that that case is treated as snippet expansion:\r\n\r\nhttps://github.com/neovim/neovim/blob/305012ea073267492e1d626a304c6993b0dfa145/runtime/lua/vim/lsp/completion.lua#L522-L523\r\n\r\nIs it correct in that case?\r\n\r\nThe text after cursor is cut and saved to `suffix` that is then appended to the text expanded as snippet. \r\n\r\nhttps://github.com/neovim/neovim/blob/305012ea073267492e1d626a304c6993b0dfa145/runtime/lua/vim/lsp/completion.lua#L535-L545\r\n\r\nAssuming that I commit complete `bo` in `vim._with({bo}, f)`, I get `bo}, f)` passed to `vim.snippet.expand`.\r\n\r\nhttps://github.com/neovim/neovim/blob/305012ea073267492e1d626a304c6993b0dfa145/runtime/lua/vim/lsp/completion.lua#L117-L123\r\n\r\nMaybe in \r\nhttps://github.com/neovim/neovim/blob/305012ea073267492e1d626a304c6993b0dfa145/runtime/lua/vim/lsp/completion.lua#L543\r\n\r\nreplacing `#line` with `cursor_col` would fix it? \r\n\r\n### Steps to reproduce\r\n\r\ninit.lua:\r\n```lua\r\nvim.api.nvim_create_autocmd('FileType', {\r\n  pattern = {'lua'},\r\n  group = vim.api.nvim_create_augroup('luals', {}),\r\n  callback = function ()\r\n    vim.lsp.start({\r\n      name = 'luals',\r\n      filetype = 'lua',\r\n      cmd = {'lua-language-server'},\r\n      root_dir = vim.uv.cwd(),\r\n      settings = {\r\n        Lua = {\r\n          runtime = {\r\n            path = {\r\n              '?.lua',\r\n              '?/init.lua',\r\n            },\r\n            version = 'LuaJIT',\r\n            pathStrict = true,\r\n          },\r\n          workspace = {\r\n            ignoreDir = {'lua'},\r\n            checkThirdParty = false,\r\n            library = {\r\n              vim.fs.joinpath(vim.env.VIMRUNTIME, 'lua'),\r\n              vim.fs.joinpath('${3rd}/luv/library', 'lua'),\r\n            },\r\n          },\r\n          diagnostics = {\r\n            globals = {'vim'},\r\n          },\r\n        },\r\n      },\r\n    })\r\n  end,\r\n})\r\n\r\nvim.api.nvim_create_autocmd('LspAttach', {\r\ngroup = vim.api.nvim_create_augroup('arctgx.completion', {clear = true}),\r\n  callback = function (args)\r\n    local clientId = args.data.client_id\r\n    local client = assert(vim.lsp.get_client_by_id(clientId))\r\n    vim.notify(('Server %s attached'):format(client.name), vim.log.levels.INFO)\r\n    vim.lsp.completion.enable(true, clientId, args.buf, {autotrigger = true})\r\n\r\n    vim.keymap.set({'i'}, '<C-Space>', function ()\r\n      vim.lsp.completion.trigger()\r\n    end, {buffer = args.buf})\r\n  end\r\n})\r\n\r\nvim.go.completeopt = 'noinsert,menuone'\r\n```\r\n- `nvim --clean -u init.lua new.lua`\r\n- after server is attached insert `vim._with({bo}, f)` and try to confirm `bo` completion with `<C-y>` and see the cursor on the end of line. \r\n\r\n### Expected behavior\r\n\r\nCursor stays at the end of `bo`. \r\n\r\n### Nvim version (nvim -v)\r\n\r\nv0.11.0-dev-897+g305012ea0\r\n\r\n### Vim (not Nvim) behaves the same?\r\n\r\nno\r\n\r\n### Operating system/version\r\n\r\nDebian Sid\r\n\r\n### Terminal name/version\r\n\r\nalacritty 0.14.0-dev (6585d604), tmux 3.5\r\n\r\n### $TERM environment variable\r\n\r\ntmux-256color\r\n\r\n### Installation\r\n\r\nfrom repo","closed_by":{"login":"mfussenegger","id":38700,"node_id":"MDQ6VXNlcjM4NzAw","avatar_url":"https://avatars.githubusercontent.com/u/38700?v=4","gravatar_id":"","url":"https://api.github.com/users/mfussenegger","html_url":"https://github.com/mfussenegger","followers_url":"https://api.github.com/users/mfussenegger/followers","following_url":"https://api.github.com/users/mfussenegger/following{/other_user}","gists_url":"https://api.github.com/users/mfussenegger/gists{/gist_id}","starred_url":"https://api.github.com/users/mfussenegger/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mfussenegger/subscriptions","organizations_url":"https://api.github.com/users/mfussenegger/orgs","repos_url":"https://api.github.com/users/mfussenegger/repos","events_url":"https://api.github.com/users/mfussenegger/events{/privacy}","received_events_url":"https://api.github.com/users/mfussenegger/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/neovim/neovim/issues/30656/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/neovim/neovim/issues/30656/timeline","performed_via_github_app":null,"state_reason":"completed"}