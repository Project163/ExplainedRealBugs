{"url":"https://api.github.com/repos/neovim/neovim/issues/33670","repository_url":"https://api.github.com/repos/neovim/neovim","labels_url":"https://api.github.com/repos/neovim/neovim/issues/33670/labels{/name}","comments_url":"https://api.github.com/repos/neovim/neovim/issues/33670/comments","events_url":"https://api.github.com/repos/neovim/neovim/issues/33670/events","html_url":"https://github.com/neovim/neovim/issues/33670","id":3022973456,"node_id":"I_kwDOAPphoM60LuoQ","number":33670,"title":"`cpoptions` resets on lua files","user":{"login":"shimeoki","id":79855381,"node_id":"MDQ6VXNlcjc5ODU1Mzgx","avatar_url":"https://avatars.githubusercontent.com/u/79855381?v=4","gravatar_id":"","url":"https://api.github.com/users/shimeoki","html_url":"https://github.com/shimeoki","followers_url":"https://api.github.com/users/shimeoki/followers","following_url":"https://api.github.com/users/shimeoki/following{/other_user}","gists_url":"https://api.github.com/users/shimeoki/gists{/gist_id}","starred_url":"https://api.github.com/users/shimeoki/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shimeoki/subscriptions","organizations_url":"https://api.github.com/users/shimeoki/orgs","repos_url":"https://api.github.com/users/shimeoki/repos","events_url":"https://api.github.com/users/shimeoki/events{/privacy}","received_events_url":"https://api.github.com/users/shimeoki/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":120251370,"node_id":"MDU6TGFiZWwxMjAyNTEzNzA=","url":"https://api.github.com/repos/neovim/neovim/labels/runtime","name":"runtime","color":"c5def5","default":false,"description":"funtime"},{"id":619474658,"node_id":"MDU6TGFiZWw2MTk0NzQ2NTg=","url":"https://api.github.com/repos/neovim/neovim/labels/bug-regression","name":"bug-regression","color":"f9d0c4","default":false,"description":"wrong behavior that was introduced in a previous commit (please bisect)"},{"id":1481421490,"node_id":"MDU6TGFiZWwxNDgxNDIxNDkw","url":"https://api.github.com/repos/neovim/neovim/labels/has:bisected","name":"has:bisected","color":"0E8A16","default":false,"description":"issue has been tracked to a specific commit"},{"id":3708202139,"node_id":"LA_kwDOAPphoM7dBqyb","url":"https://api.github.com/repos/neovim/neovim/labels/filetype","name":"filetype","color":"C5DEF5","default":false,"description":"filetype detection, filetype.lua, ftplugins"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/neovim/neovim/milestones/50","html_url":"https://github.com/neovim/neovim/milestone/50","labels_url":"https://api.github.com/repos/neovim/neovim/milestones/50/labels","id":12793246,"node_id":"MI_kwDOAPphoM4AwzWe","number":50,"title":"0.11.2","description":"","creator":{"login":"justinmk","id":1359421,"node_id":"MDQ6VXNlcjEzNTk0MjE=","avatar_url":"https://avatars.githubusercontent.com/u/1359421?v=4","gravatar_id":"","url":"https://api.github.com/users/justinmk","html_url":"https://github.com/justinmk","followers_url":"https://api.github.com/users/justinmk/followers","following_url":"https://api.github.com/users/justinmk/following{/other_user}","gists_url":"https://api.github.com/users/justinmk/gists{/gist_id}","starred_url":"https://api.github.com/users/justinmk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/justinmk/subscriptions","organizations_url":"https://api.github.com/users/justinmk/orgs","repos_url":"https://api.github.com/users/justinmk/repos","events_url":"https://api.github.com/users/justinmk/events{/privacy}","received_events_url":"https://api.github.com/users/justinmk/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":40,"state":"closed","created_at":"2025-04-26T13:55:41Z","updated_at":"2025-05-30T23:31:26Z","due_on":null,"closed_at":"2025-05-30T23:31:26Z"},"comments":8,"created_at":"2025-04-27T09:57:39Z","updated_at":"2025-04-27T11:55:16Z","closed_at":"2025-04-27T11:55:16Z","author_association":"NONE","type":{"id":597163,"node_id":"IT_kwDOAGK_Pc4ACRyr","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T10:10:19Z","updated_at":"2024-07-26T10:12:30Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Problem\n\nwhen the user opens a lua file for the first time, cpoptions resets to default values. from my tests, other filetypes are not affected.\n\nwhen i discovered this, at first i thought i was doing something wrong and the cpoptions just resets itself for some reason while opening any file for the first time, because i tested the behaviour on the `init.lua` file in my config directory.\n\nbut then i grepped the files from `:scriptnames` and found some lines in `/usr/share/nvim/runtime/ftplugin/lua.vim`.\n\nlines 25-26:\n```vim\nlet s:cpo_save = &cpo\nset cpo&vim\n```\n\nlines 61-67:\n```vim\n\" The rest of the file needs to be :sourced only once per Vim session\nif exists(\"s:loaded_lua\") || &cp\n  let &cpo = s:cpo_save\n  unlet s:cpo_save\n  finish\nendif\nlet s:loaded_lua = 1\n```\n\ni don't know vimscript, but if i understood correctly, the script saves previous cpo values into `s:cpo_save` variable and resets cpo to vim defaults. after that, because `cp` is set to false (i saw on the website in vim_diff section) and `s:loaded_lua` variable is non existent (created only after the block), the if block does not execute and cpo values are not restored. but after the first loaded file, the variable is created and the block is correctly executed.\n\n### Steps to reproduce\n\ncreate any lua file 1\n`touch sample1.lua`\n\ncreate any lua file 2\n`touch sample2.lua`\n\ncreate any not lua file 1\n`touch sample1.txt`\n\ncreate any not lua file 2\n`touch sample2.txt`\n\nlaunch nvim with clean config\n`nvim --clean`\n\ncheck default cpoptions (`aABceFs_`)\n`:set cpo?`\n\nmake any cpo change\n`:set cpo-=_`\n\ncheck the change (`aABceFs`)\n`:set cpo?`\n\nopen first not lua file\n`:e sample1.txt`\n\nverify that the cpoptions changes are still here\n`:set cpo?`\n\nopen first lua file\n`:e sample1.lua`\n\nfor some reason, cpoptions changed to default values\n`:set cpo?`\n\nopen second not lua file\n`:e sample2.txt`\n\nchange to default values is still here\n`:set cpo?`\n\nmake custom changes once again\n`:set cpo-=_`\n\ncheck the changes\n`:set cpo?`\n\nload first lua file (already buffered)\n`:e sample1.lua`\n\ncustom changes are still here\n`:set cpo?`\n\nopen second lua file (not buffered)\n`:e sample2.lua`\n\neverything is ok\n`:set cpo?`\n\n### Expected behavior\n\ncpoptions should not reset to default values when user edits a lua file for the first time\n\n### Nvim version (nvim -v)\n\n0.11.0\n\n### Vim (not Nvim) behaves the same?\n\nno, vim 9.1\n\n### Operating system/version\n\narch linux 6.14.3 (zen kernel)\n\n### Terminal name/version\n\nkitty 0.41.1\n\n### $TERM environment variable\n\nxterm-kitty\n\n### Installation\n\nsystem package manager (pacman)","closed_by":{"login":"justinmk","id":1359421,"node_id":"MDQ6VXNlcjEzNTk0MjE=","avatar_url":"https://avatars.githubusercontent.com/u/1359421?v=4","gravatar_id":"","url":"https://api.github.com/users/justinmk","html_url":"https://github.com/justinmk","followers_url":"https://api.github.com/users/justinmk/followers","following_url":"https://api.github.com/users/justinmk/following{/other_user}","gists_url":"https://api.github.com/users/justinmk/gists{/gist_id}","starred_url":"https://api.github.com/users/justinmk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/justinmk/subscriptions","organizations_url":"https://api.github.com/users/justinmk/orgs","repos_url":"https://api.github.com/users/justinmk/repos","events_url":"https://api.github.com/users/justinmk/events{/privacy}","received_events_url":"https://api.github.com/users/justinmk/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/neovim/neovim/issues/33670/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/neovim/neovim/issues/33670/timeline","performed_via_github_app":null,"state_reason":"completed"}