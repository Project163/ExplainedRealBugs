diff --git a/runtime/lua/vim/lsp/buf.lua b/runtime/lua/vim/lsp/buf.lua
index a512d48a06..d7463d74f8 100644
--- a/runtime/lua/vim/lsp/buf.lua
+++ b/runtime/lua/vim/lsp/buf.lua
@@ -897,19 +897,23 @@ function M.code_action(opts)
     else
       params = util.make_range_params(win, client.offset_encoding)
     end
-    if not context.diagnostics then
+    if context.diagnostics then
+      params.context = context
+    else
       local ns_push = vim.lsp.diagnostic.get_namespace(client.id, false)
       local ns_pull = vim.lsp.diagnostic.get_namespace(client.id, true)
       local diagnostics = {}
       local lnum = api.nvim_win_get_cursor(0)[1] - 1
       vim.list_extend(diagnostics, vim.diagnostic.get(bufnr, { namespace = ns_pull, lnum = lnum }))
       vim.list_extend(diagnostics, vim.diagnostic.get(bufnr, { namespace = ns_push, lnum = lnum }))
-      ---@diagnostic disable-next-line: no-unknown
-      context.diagnostics = vim.tbl_map(function(d)
-        return d.user_data.lsp
-      end, diagnostics)
+      params.context = vim.tbl_extend('force', context, {
+        ---@diagnostic disable-next-line: no-unknown
+        diagnostics = vim.tbl_map(function(d)
+          return d.user_data.lsp
+        end, diagnostics),
+      })
     end
-    params.context = context
+
     client.request(ms.textDocument_codeAction, params, on_result, bufnr)
   end
 end
