diff --git a/runtime/lua/vim/lsp/util.lua b/runtime/lua/vim/lsp/util.lua
index cbbe3a66b7..ec66449b54 100644
--- a/runtime/lua/vim/lsp/util.lua
+++ b/runtime/lua/vim/lsp/util.lua
@@ -1795,8 +1795,18 @@ function M.locations_to_items(locations, offset_encoding)
       local row = pos.line
       local end_row = end_pos.line
       local line = lines[row] or ''
-      local col = M._str_byteindex_enc(line, pos.character, offset_encoding)
-      local end_col = M._str_byteindex_enc(lines[end_row] or '', end_pos.character, offset_encoding)
+      local line_len = vim.fn.strcharlen(line)
+      local end_line = lines[end_row] or ''
+      local end_line_len = vim.fn.strcharlen(end_line)
+      -- LSP spec: if character > line length, default to the line length.
+      -- https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#position
+      local col = pos.character <= line_len
+          and M._str_byteindex_enc(line, pos.character, offset_encoding)
+        or line_len
+      local end_col = end_pos.character <= end_line_len
+          and M._str_byteindex_enc(end_line, end_pos.character, offset_encoding)
+        or end_line_len
+
       table.insert(items, {
         filename = filename,
         lnum = row + 1,
diff --git a/test/functional/plugin/lsp_spec.lua b/test/functional/plugin/lsp_spec.lua
index 1347ea9745..1d43b5d449 100644
--- a/test/functional/plugin/lsp_spec.lua
+++ b/test/functional/plugin/lsp_spec.lua
@@ -2673,7 +2673,7 @@ describe('LSP', function()
 
   describe('lsp.util.locations_to_items', function()
     it('Convert Location[] to items', function()
-      local expected = {
+      local expected_template = {
         {
           filename = '/fake/uri',
           lnum = 1,
@@ -2681,7 +2681,12 @@ describe('LSP', function()
           col = 3,
           end_col = 4,
           text = 'testing',
-          user_data = {
+          user_data = {},
+        },
+      }
+      local test_params = {
+        {
+          {
             uri = 'file:///fake/uri',
             range = {
               start = { line = 0, character = 2 },
@@ -2689,23 +2694,28 @@ describe('LSP', function()
             },
           },
         },
-      }
-      local actual = exec_lua(function()
-        local bufnr = vim.uri_to_bufnr('file:///fake/uri')
-        local lines = { 'testing', '123' }
-        vim.api.nvim_buf_set_lines(bufnr, 0, 1, false, lines)
-        local locations = {
+        {
           {
             uri = 'file:///fake/uri',
             range = {
               start = { line = 0, character = 2 },
-              ['end'] = { line = 1, character = 3 },
+              -- LSP spec: if character > line length, default to the line length.
+              ['end'] = { line = 1, character = 10000 },
             },
           },
-        }
-        return vim.lsp.util.locations_to_items(locations, 'utf-16')
-      end)
-      eq(expected, actual)
+        },
+      }
+      for _, params in ipairs(test_params) do
+        local actual = exec_lua(function(params0)
+          local bufnr = vim.uri_to_bufnr('file:///fake/uri')
+          local lines = { 'testing', '123' }
+          vim.api.nvim_buf_set_lines(bufnr, 0, 1, false, lines)
+          return vim.lsp.util.locations_to_items(params0, 'utf-16')
+        end, params)
+        local expected = vim.deepcopy(expected_template)
+        expected[1].user_data = params[1]
+        eq(expected, actual)
+      end
     end)
 
     it('Convert LocationLink[] to items', function()
