diff --git a/nbxml/src/main/java/org/apache/vysper/xml/decoder/XMLElementListener.java b/nbxml/src/main/java/org/apache/vysper/xml/decoder/XMLElementListener.java
index f4eb235d..14b5810e 100644
--- a/nbxml/src/main/java/org/apache/vysper/xml/decoder/XMLElementListener.java
+++ b/nbxml/src/main/java/org/apache/vysper/xml/decoder/XMLElementListener.java
@@ -23,4 +23,6 @@ import org.apache.vysper.xml.fragment.XMLElement;
 
 public interface XMLElementListener {
     void element(XMLElement element);
+    void close();
+    boolean isClosed();
 }
\ No newline at end of file
diff --git a/nbxml/src/main/java/org/apache/vysper/xml/decoder/XMPPContentHandler.java b/nbxml/src/main/java/org/apache/vysper/xml/decoder/XMPPContentHandler.java
index dc32873b..26dd847d 100644
--- a/nbxml/src/main/java/org/apache/vysper/xml/decoder/XMPPContentHandler.java
+++ b/nbxml/src/main/java/org/apache/vysper/xml/decoder/XMPPContentHandler.java
@@ -83,8 +83,7 @@ public class XMPPContentHandler implements ContentHandler {
             // complete stanza, emit
             emit();
         } else if (depth == 0) {
-            // end stream:stream element
-            // TODO handle
+            // End of stream. Handled in endDocument().
         } else {
             builder.endInnerElement();
         }
@@ -137,9 +136,10 @@ public class XMPPContentHandler implements ContentHandler {
     }
 
     /**
-     * {@inheritDoc}
+     * End of the XMPP stream. Tell the XML listener we're done.
      */
-    public void endDocument() throws SAXException { /* ignore */
+    public void endDocument() throws SAXException { 
+        this.listener.close();
     }
 
     /**
diff --git a/nbxml/src/main/java/org/apache/vysper/xml/decoder/XMPPDecoder.java b/nbxml/src/main/java/org/apache/vysper/xml/decoder/XMPPDecoder.java
index 4eb359eb..1e3d9888 100644
--- a/nbxml/src/main/java/org/apache/vysper/xml/decoder/XMPPDecoder.java
+++ b/nbxml/src/main/java/org/apache/vysper/xml/decoder/XMPPDecoder.java
@@ -34,7 +34,7 @@ import org.apache.vysper.xml.sax.impl.DefaultNonBlockingXMLReader;
  * @author The Apache MINA Project (dev@mina.apache.org)
  */
 public class XMPPDecoder extends CumulativeProtocolDecoder {
-
+    
     private static final String XML_DECL = "<?xml";
 
     private static final String STREAM_STREAM = "<stream:stream";
@@ -53,6 +53,7 @@ public class XMPPDecoder extends CumulativeProtocolDecoder {
 
     public static class MinaStanzaListener implements XMLElementListener {
         private ProtocolDecoderOutput protocolDecoder;
+        private boolean closed = false;
 
         public MinaStanzaListener(ProtocolDecoderOutput protocolDecoder) {
             this.protocolDecoder = protocolDecoder;
@@ -65,6 +66,14 @@ public class XMPPDecoder extends CumulativeProtocolDecoder {
 
             protocolDecoder.write(element);
         }
+        
+        public void close() {
+            this.closed = true;
+        }
+        
+        public boolean isClosed() {
+            return this.closed;
+        }
     }
 
     /**
@@ -90,11 +99,17 @@ public class XMPPDecoder extends CumulativeProtocolDecoder {
         }
 
         XMPPContentHandler contentHandler = (XMPPContentHandler) reader.getContentHandler();
-        contentHandler.setListener(new MinaStanzaListener(out));
+        XMLElementListener listener = new MinaStanzaListener(out);
+        contentHandler.setListener(listener);
 
         reader.parse(in, CharsetUtil.UTF8_DECODER);
-
-        // we have parsed what we got, invoke again when more data is available
-        return false;
+        
+        if (listener.isClosed()) {
+            session.close(true);
+            return true;
+        } else {
+            // we have parsed what we got, invoke again when more data is available
+            return false;
+        }
     }
 }
\ No newline at end of file
diff --git a/nbxml/src/main/java/org/apache/vysper/xml/sax/impl/XMLTokenizer.java b/nbxml/src/main/java/org/apache/vysper/xml/sax/impl/XMLTokenizer.java
index 42d4a33f..bb7199a0 100644
--- a/nbxml/src/main/java/org/apache/vysper/xml/sax/impl/XMLTokenizer.java
+++ b/nbxml/src/main/java/org/apache/vysper/xml/sax/impl/XMLTokenizer.java
@@ -55,7 +55,6 @@ public class XMLTokenizer {
     /**
      * @param byteBuffer
      * @param charsetDecoder
-     * @return the new particle or NULL, if the buffer was exhausted before the particle was completed
      * @throws Exception
      */
     public void parse(IoBuffer byteBuffer, CharsetDecoder decoder) throws SAXException {
@@ -66,6 +65,8 @@ public class XMLTokenizer {
                 if (c == '<') {
                     emit(c, byteBuffer);
                     state = State.IN_TAG;
+                } else if (Character.isWhitespace(c)) {
+                    // ignore
                 } else {
                     state = State.IN_TEXT;
                     buffer.put((byte) c);
diff --git a/nbxml/src/test/java/org/apache/vysper/xml/sax/impl/XMPPContentHandlerTestCase.java b/nbxml/src/test/java/org/apache/vysper/xml/sax/impl/XMPPContentHandlerTestCase.java
index 1603082f..ad3f5792 100644
--- a/nbxml/src/test/java/org/apache/vysper/xml/sax/impl/XMPPContentHandlerTestCase.java
+++ b/nbxml/src/test/java/org/apache/vysper/xml/sax/impl/XMPPContentHandlerTestCase.java
@@ -39,10 +39,14 @@ public class XMPPContentHandlerTestCase extends TestCase {
 
     private static class TestListener implements XMLElementListener {
         public List<XMLElement> elements = new ArrayList<XMLElement>();
+        private boolean closed = false;
 
         public void element(XMLElement element) {
             elements.add(element);
         }
+        
+        public void close() { closed = true; }
+        public boolean isClosed() { return closed; }
     }
 
     public void test() throws Exception {
@@ -63,6 +67,7 @@ public class XMPPContentHandlerTestCase extends TestCase {
         assertEquals("stanza", actual.next().getName());
         assertEquals("message", actual.next().getName());
         assertEquals("iq", actual.next().getName());
+        assertTrue(listener.isClosed());
     }
 
     private void parse(NonBlockingXMLReader reader, String xml) throws Exception {
diff --git a/nbxml/src/test/java/org/apache/vysper/xml/sax/perf/PerfRunner.java b/nbxml/src/test/java/org/apache/vysper/xml/sax/perf/PerfRunner.java
index 4030a740..7ec2b5f1 100644
--- a/nbxml/src/test/java/org/apache/vysper/xml/sax/perf/PerfRunner.java
+++ b/nbxml/src/test/java/org/apache/vysper/xml/sax/perf/PerfRunner.java
@@ -39,7 +39,9 @@ public class PerfRunner {
         public void element(XMLElement element) {
             counter++;
         }
-
+        
+        public void close() {}
+        public boolean isClosed() { return false; }
     }
 
     private static final String SINGLE_LEVEL_XML = "<child att='foo' att2='bar'></child>";
