{"url":"https://api.github.com/repos/srikanth-lingala/zip4j/issues/473","repository_url":"https://api.github.com/repos/srikanth-lingala/zip4j","labels_url":"https://api.github.com/repos/srikanth-lingala/zip4j/issues/473/labels{/name}","comments_url":"https://api.github.com/repos/srikanth-lingala/zip4j/issues/473/comments","events_url":"https://api.github.com/repos/srikanth-lingala/zip4j/issues/473/events","html_url":"https://github.com/srikanth-lingala/zip4j/issues/473","id":1363822142,"node_id":"I_kwDOCwUnhM5RSkY-","number":473,"title":"ZipOutputStream.putNextEntry no longer sets last modified file time on file entries","user":{"login":"mintern","id":3847612,"node_id":"MDQ6VXNlcjM4NDc2MTI=","avatar_url":"https://avatars.githubusercontent.com/u/3847612?v=4","gravatar_id":"","url":"https://api.github.com/users/mintern","html_url":"https://github.com/mintern","followers_url":"https://api.github.com/users/mintern/followers","following_url":"https://api.github.com/users/mintern/following{/other_user}","gists_url":"https://api.github.com/users/mintern/gists{/gist_id}","starred_url":"https://api.github.com/users/mintern/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mintern/subscriptions","organizations_url":"https://api.github.com/users/mintern/orgs","repos_url":"https://api.github.com/users/mintern/repos","events_url":"https://api.github.com/users/mintern/events{/privacy}","received_events_url":"https://api.github.com/users/mintern/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1347122727,"node_id":"MDU6TGFiZWwxMzQ3MTIyNzI3","url":"https://api.github.com/repos/srikanth-lingala/zip4j/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1623761937,"node_id":"MDU6TGFiZWwxNjIzNzYxOTM3","url":"https://api.github.com/repos/srikanth-lingala/zip4j/labels/resolved","name":"resolved","color":"b8dd11","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"srikanth-lingala","id":3450302,"node_id":"MDQ6VXNlcjM0NTAzMDI=","avatar_url":"https://avatars.githubusercontent.com/u/3450302?v=4","gravatar_id":"","url":"https://api.github.com/users/srikanth-lingala","html_url":"https://github.com/srikanth-lingala","followers_url":"https://api.github.com/users/srikanth-lingala/followers","following_url":"https://api.github.com/users/srikanth-lingala/following{/other_user}","gists_url":"https://api.github.com/users/srikanth-lingala/gists{/gist_id}","starred_url":"https://api.github.com/users/srikanth-lingala/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/srikanth-lingala/subscriptions","organizations_url":"https://api.github.com/users/srikanth-lingala/orgs","repos_url":"https://api.github.com/users/srikanth-lingala/repos","events_url":"https://api.github.com/users/srikanth-lingala/events{/privacy}","received_events_url":"https://api.github.com/users/srikanth-lingala/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"srikanth-lingala","id":3450302,"node_id":"MDQ6VXNlcjM0NTAzMDI=","avatar_url":"https://avatars.githubusercontent.com/u/3450302?v=4","gravatar_id":"","url":"https://api.github.com/users/srikanth-lingala","html_url":"https://github.com/srikanth-lingala","followers_url":"https://api.github.com/users/srikanth-lingala/followers","following_url":"https://api.github.com/users/srikanth-lingala/following{/other_user}","gists_url":"https://api.github.com/users/srikanth-lingala/gists{/gist_id}","starred_url":"https://api.github.com/users/srikanth-lingala/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/srikanth-lingala/subscriptions","organizations_url":"https://api.github.com/users/srikanth-lingala/orgs","repos_url":"https://api.github.com/users/srikanth-lingala/repos","events_url":"https://api.github.com/users/srikanth-lingala/events{/privacy}","received_events_url":"https://api.github.com/users/srikanth-lingala/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":4,"created_at":"2022-09-06T21:13:18Z","updated_at":"2022-09-12T15:04:01Z","closed_at":"2022-09-12T15:04:00Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"As of 2.11.0, file entries added via `putNextEntry` have a last modified date of 1980 when `ZipParameters` are passed with the default `lastModifiedFileTime == 0` value. https://github.com/srikanth-lingala/zip4j/commit/0f9901076d10f4fd4319d3ee3eb1d00f136f581e removed some conditional logic from `FileHeaderFactory.generateFileHeader`:\r\n\r\n```diff\r\n-    if (zipParameters.getLastModifiedFileTime() > 0) {\r\n-      fileHeader.setLastModifiedTime(Zip4jUtil.epochToExtendedDosTime(zipParameters.getLastModifiedFileTime()));\r\n-    } else {\r\n-      fileHeader.setLastModifiedTime(Zip4jUtil.epochToExtendedDosTime(System.currentTimeMillis()));\r\n-    }\r\n+    fileHeader.setLastModifiedTime(Zip4jUtil.epochToExtendedDosTime(zipParameters.getLastModifiedFileTime()));\r\n```\r\n\r\nThis logic was added to `putNextEntry` instead, but only for directory entries:\r\n\r\n```diff\r\n     if (isZipEntryDirectory(zipParameters.getFileNameInZip())) {\r\n       clonedZipParameters.setWriteExtendedLocalFileHeader(false);\r\n       clonedZipParameters.setCompressionMethod(CompressionMethod.STORE);\r\n       clonedZipParameters.setEncryptFiles(false);\r\n       clonedZipParameters.setEntrySize(0);\r\n+\r\n+      if (zipParameters.getLastModifiedFileTime() <= 0) {\r\n+        clonedZipParameters.setLastModifiedFileTime(System.currentTimeMillis());\r\n+      }\r\n     }\r\n```\r\n\r\nAs a result, the following test, which passes for 2.10.0, fails for 2.11.0 and 2.11.1:\r\n\r\n```java\r\n    @Test\r\n    public void recentLastModifiedTime() throws IOException {\r\n        long currentTime = System.currentTimeMillis();\r\n        ByteArrayOutputStream zip = new ByteArrayOutputStream();\r\n        try (ZipOutputStream zos = new ZipOutputStream(zip)) {\r\n            ZipParameters params = new ZipParameters();\r\n            params.setFileNameInZip(\"test\");\r\n            zos.putNextEntry(params);\r\n            zos.write(new byte[0]);\r\n            zos.closeEntry();\r\n        }\r\n        try (ZipInputStream zis = new ZipInputStream(new ByteArrayInputStream(zip.toByteArray()))) {\r\n            ZipEntry e = zis.getNextEntry();\r\n            long zipTime = e.getTime();\r\n            // ZIP only has 2 second precision, so adjust for potential rounding.\r\n            assertTrue(currentTime < zipTime + 2000,\r\n                    String.format(\"ZIP entry modified time (%d) should be near current time (%d)\",\r\n                            zipTime, currentTime));\r\n        }\r\n    }\r\n```\r\n\r\nWas this change intended as part of the fix to #434, or was this an unintended side effect?\r\n\r\nThe documentation for `ZipParameters.setLastModifiedTime` says:\r\n\r\n> Set the last modified time recorded in the ZIP file for the added files.  If less than 0, the last modified time is cleared and the current time is used\r\n\r\nbut the current time is not being used for file entries when `zipParams.getLastModifiedFileTime() <= 0` like it used to.\r\n\r\n(I noticed a separate potential bug where `ZipParameters.setLastModifiedTime` just returns when `lastModifiedFileTime <= 0`. It doesn't actually clear the current value as the documentation indicates.)","closed_by":{"login":"srikanth-lingala","id":3450302,"node_id":"MDQ6VXNlcjM0NTAzMDI=","avatar_url":"https://avatars.githubusercontent.com/u/3450302?v=4","gravatar_id":"","url":"https://api.github.com/users/srikanth-lingala","html_url":"https://github.com/srikanth-lingala","followers_url":"https://api.github.com/users/srikanth-lingala/followers","following_url":"https://api.github.com/users/srikanth-lingala/following{/other_user}","gists_url":"https://api.github.com/users/srikanth-lingala/gists{/gist_id}","starred_url":"https://api.github.com/users/srikanth-lingala/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/srikanth-lingala/subscriptions","organizations_url":"https://api.github.com/users/srikanth-lingala/orgs","repos_url":"https://api.github.com/users/srikanth-lingala/repos","events_url":"https://api.github.com/users/srikanth-lingala/events{/privacy}","received_events_url":"https://api.github.com/users/srikanth-lingala/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/srikanth-lingala/zip4j/issues/473/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/srikanth-lingala/zip4j/issues/473/timeline","performed_via_github_app":null,"state_reason":"completed"}