{"url":"https://api.github.com/repos/srikanth-lingala/zip4j/issues/313","repository_url":"https://api.github.com/repos/srikanth-lingala/zip4j","labels_url":"https://api.github.com/repos/srikanth-lingala/zip4j/issues/313/labels{/name}","comments_url":"https://api.github.com/repos/srikanth-lingala/zip4j/issues/313/comments","events_url":"https://api.github.com/repos/srikanth-lingala/zip4j/issues/313/events","html_url":"https://github.com/srikanth-lingala/zip4j/issues/313","id":867048275,"node_id":"MDU6SXNzdWU4NjcwNDgyNzU=","number":313,"title":"Bug: The last added folder defines progress monitor total work in asynchronous zipping task","user":{"login":"Searen1984","id":43062039,"node_id":"MDQ6VXNlcjQzMDYyMDM5","avatar_url":"https://avatars.githubusercontent.com/u/43062039?v=4","gravatar_id":"","url":"https://api.github.com/users/Searen1984","html_url":"https://github.com/Searen1984","followers_url":"https://api.github.com/users/Searen1984/followers","following_url":"https://api.github.com/users/Searen1984/following{/other_user}","gists_url":"https://api.github.com/users/Searen1984/gists{/gist_id}","starred_url":"https://api.github.com/users/Searen1984/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Searen1984/subscriptions","organizations_url":"https://api.github.com/users/Searen1984/orgs","repos_url":"https://api.github.com/users/Searen1984/repos","events_url":"https://api.github.com/users/Searen1984/events{/privacy}","received_events_url":"https://api.github.com/users/Searen1984/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1347122727,"node_id":"MDU6TGFiZWwxMzQ3MTIyNzI3","url":"https://api.github.com/repos/srikanth-lingala/zip4j/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1623761937,"node_id":"MDU6TGFiZWwxNjIzNzYxOTM3","url":"https://api.github.com/repos/srikanth-lingala/zip4j/labels/resolved","name":"resolved","color":"b8dd11","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"srikanth-lingala","id":3450302,"node_id":"MDQ6VXNlcjM0NTAzMDI=","avatar_url":"https://avatars.githubusercontent.com/u/3450302?v=4","gravatar_id":"","url":"https://api.github.com/users/srikanth-lingala","html_url":"https://github.com/srikanth-lingala","followers_url":"https://api.github.com/users/srikanth-lingala/followers","following_url":"https://api.github.com/users/srikanth-lingala/following{/other_user}","gists_url":"https://api.github.com/users/srikanth-lingala/gists{/gist_id}","starred_url":"https://api.github.com/users/srikanth-lingala/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/srikanth-lingala/subscriptions","organizations_url":"https://api.github.com/users/srikanth-lingala/orgs","repos_url":"https://api.github.com/users/srikanth-lingala/repos","events_url":"https://api.github.com/users/srikanth-lingala/events{/privacy}","received_events_url":"https://api.github.com/users/srikanth-lingala/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"srikanth-lingala","id":3450302,"node_id":"MDQ6VXNlcjM0NTAzMDI=","avatar_url":"https://avatars.githubusercontent.com/u/3450302?v=4","gravatar_id":"","url":"https://api.github.com/users/srikanth-lingala","html_url":"https://github.com/srikanth-lingala","followers_url":"https://api.github.com/users/srikanth-lingala/followers","following_url":"https://api.github.com/users/srikanth-lingala/following{/other_user}","gists_url":"https://api.github.com/users/srikanth-lingala/gists{/gist_id}","starred_url":"https://api.github.com/users/srikanth-lingala/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/srikanth-lingala/subscriptions","organizations_url":"https://api.github.com/users/srikanth-lingala/orgs","repos_url":"https://api.github.com/users/srikanth-lingala/repos","events_url":"https://api.github.com/users/srikanth-lingala/events{/privacy}","received_events_url":"https://api.github.com/users/srikanth-lingala/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":4,"created_at":"2021-04-25T16:06:53Z","updated_at":"2021-05-25T19:06:29Z","closed_at":"2021-05-25T19:06:29Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hello,\r\n\r\nI think I found a bug when adding multiple folders for asynchronous zipping. The last added folder sets the total work to be done. So the information about the running zip task is not correct in terms of percentage done.\r\n\r\nAt first the example corresponding to the documentation:\r\n```\r\nFile targetFile = new File...\r\nZipFile zipFile = new ZipFile(targetFile);\r\nProgressMonitor progressMonitor = zipFile.getProgressMonitor();\r\nzipFile.setRunInThread(true);\r\n\r\nfor (File path : paths) {\r\n  zipFile.addFolder(path);\r\n}\r\n\r\nwhile (!progressMonitor.getState().equals(ProgressMonitor.State.READY)) {\r\n  System.out.println(\"Percentage done: \" + progressMonitor.getPercentDone());\r\n  System.out.println(\"Current file: \" + progressMonitor.getFileName());\r\n  System.out.println(\"Current task: \" + progressMonitor.getCurrentTask());\r\n\r\n  Thread.sleep(100);\r\n}\r\n```\r\n\r\n**Here the problem:** Adding a folder resets the total work to be done (see line 28  [AsyncZipTask.java](https://github.com/srikanth-lingala/zip4j/blob/master/src/main/java/net/lingala/zip4j/tasks/AsyncZipTask.java)). The method `calculateTotalWork(taskParameters)` is defined through [AddFolderToZipTask.java](https://github.com/srikanth-lingala/zip4j/blob/master/src/main/java/net/lingala/zip4j/tasks/AddFolderToZipTask.java). There you can see that the total work corresponds to the size of all files inside only this folder. It is not accumulated. Therefore, the last folder defines the total work to be done and the percentage is not correct. \r\n\r\n**Here a solution proposal:** Just accumulating the work to be done might lead to strange effects because adding a folder increases the total work to be done and decreases the percentage. So instead create an `AccumulatedProgressMonitor` class which derives from the `ProgressMonitor` and allows to combine the state of multiple progress monitors into this single class. Then this `AccumulatedProgressMonitor` could be returned from the ZipFile class instead of the `ProgressMonitor`. Thus, there would be no interface break. Additionally each call to addFolder/addFile/addStream should return the `ProgressMonitor` for this zipping operation. In that way the user could also create an own `AccumulatedProgressMonitor` accumulating only specific operations. I did not think about the states but it might work ;)","closed_by":{"login":"srikanth-lingala","id":3450302,"node_id":"MDQ6VXNlcjM0NTAzMDI=","avatar_url":"https://avatars.githubusercontent.com/u/3450302?v=4","gravatar_id":"","url":"https://api.github.com/users/srikanth-lingala","html_url":"https://github.com/srikanth-lingala","followers_url":"https://api.github.com/users/srikanth-lingala/followers","following_url":"https://api.github.com/users/srikanth-lingala/following{/other_user}","gists_url":"https://api.github.com/users/srikanth-lingala/gists{/gist_id}","starred_url":"https://api.github.com/users/srikanth-lingala/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/srikanth-lingala/subscriptions","organizations_url":"https://api.github.com/users/srikanth-lingala/orgs","repos_url":"https://api.github.com/users/srikanth-lingala/repos","events_url":"https://api.github.com/users/srikanth-lingala/events{/privacy}","received_events_url":"https://api.github.com/users/srikanth-lingala/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/srikanth-lingala/zip4j/issues/313/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/srikanth-lingala/zip4j/issues/313/timeline","performed_via_github_app":null,"state_reason":"completed"}