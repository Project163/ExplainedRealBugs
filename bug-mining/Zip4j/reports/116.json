{"url":"https://api.github.com/repos/srikanth-lingala/zip4j/issues/279","repository_url":"https://api.github.com/repos/srikanth-lingala/zip4j","labels_url":"https://api.github.com/repos/srikanth-lingala/zip4j/issues/279/labels{/name}","comments_url":"https://api.github.com/repos/srikanth-lingala/zip4j/issues/279/comments","events_url":"https://api.github.com/repos/srikanth-lingala/zip4j/issues/279/events","html_url":"https://github.com/srikanth-lingala/zip4j/issues/279","id":792139266,"node_id":"MDU6SXNzdWU3OTIxMzkyNjY=","number":279,"title":"Errors while reading archives from java.util.zip via ZipInputStream","user":{"login":"TalgatAkhm","id":31318590,"node_id":"MDQ6VXNlcjMxMzE4NTkw","avatar_url":"https://avatars.githubusercontent.com/u/31318590?v=4","gravatar_id":"","url":"https://api.github.com/users/TalgatAkhm","html_url":"https://github.com/TalgatAkhm","followers_url":"https://api.github.com/users/TalgatAkhm/followers","following_url":"https://api.github.com/users/TalgatAkhm/following{/other_user}","gists_url":"https://api.github.com/users/TalgatAkhm/gists{/gist_id}","starred_url":"https://api.github.com/users/TalgatAkhm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TalgatAkhm/subscriptions","organizations_url":"https://api.github.com/users/TalgatAkhm/orgs","repos_url":"https://api.github.com/users/TalgatAkhm/repos","events_url":"https://api.github.com/users/TalgatAkhm/events{/privacy}","received_events_url":"https://api.github.com/users/TalgatAkhm/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1347122727,"node_id":"MDU6TGFiZWwxMzQ3MTIyNzI3","url":"https://api.github.com/repos/srikanth-lingala/zip4j/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1623761937,"node_id":"MDU6TGFiZWwxNjIzNzYxOTM3","url":"https://api.github.com/repos/srikanth-lingala/zip4j/labels/resolved","name":"resolved","color":"b8dd11","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"srikanth-lingala","id":3450302,"node_id":"MDQ6VXNlcjM0NTAzMDI=","avatar_url":"https://avatars.githubusercontent.com/u/3450302?v=4","gravatar_id":"","url":"https://api.github.com/users/srikanth-lingala","html_url":"https://github.com/srikanth-lingala","followers_url":"https://api.github.com/users/srikanth-lingala/followers","following_url":"https://api.github.com/users/srikanth-lingala/following{/other_user}","gists_url":"https://api.github.com/users/srikanth-lingala/gists{/gist_id}","starred_url":"https://api.github.com/users/srikanth-lingala/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/srikanth-lingala/subscriptions","organizations_url":"https://api.github.com/users/srikanth-lingala/orgs","repos_url":"https://api.github.com/users/srikanth-lingala/repos","events_url":"https://api.github.com/users/srikanth-lingala/events{/privacy}","received_events_url":"https://api.github.com/users/srikanth-lingala/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"srikanth-lingala","id":3450302,"node_id":"MDQ6VXNlcjM0NTAzMDI=","avatar_url":"https://avatars.githubusercontent.com/u/3450302?v=4","gravatar_id":"","url":"https://api.github.com/users/srikanth-lingala","html_url":"https://github.com/srikanth-lingala","followers_url":"https://api.github.com/users/srikanth-lingala/followers","following_url":"https://api.github.com/users/srikanth-lingala/following{/other_user}","gists_url":"https://api.github.com/users/srikanth-lingala/gists{/gist_id}","starred_url":"https://api.github.com/users/srikanth-lingala/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/srikanth-lingala/subscriptions","organizations_url":"https://api.github.com/users/srikanth-lingala/orgs","repos_url":"https://api.github.com/users/srikanth-lingala/repos","events_url":"https://api.github.com/users/srikanth-lingala/events{/privacy}","received_events_url":"https://api.github.com/users/srikanth-lingala/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":3,"created_at":"2021-01-22T16:27:33Z","updated_at":"2021-02-15T04:06:34Z","closed_at":"2021-02-15T04:06:34Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"There is an error while reading zip archive from standard java.util.zip archiver. Zip4j ZipInputStream successfully read only first header in archive, next it can not find any.\r\n\r\nHere is a full code example (with zip generating, and reading via zip4j stream) and reasoning below:\r\n```java\r\n   \r\n    @Test\r\n    public void test() throws IOException {\r\n        // Arrange\r\n        String archivePath = \"C:/Users/Public/test.zipByJavaUtilZip\";\r\n        File zipArchive = new File(archivePath);\r\n\r\n        File folderToZip = new File(\"C:/Users/Public/FolderToZip\");\r\n        int expectedNumberOfEntries;\r\n        try (java.util.zip.ZipOutputStream zos = new ZipOutputStream(new FileOutputStream(zipArchive))) {\r\n            expectedNumberOfEntries = zipByJavaUtilZip(zos, folderToZip, folderToZip.listFiles());\r\n            zos.flush();\r\n        }\r\n\r\n        // Act\r\n        List<String> elements = new ArrayList<>();\r\n        try(InputStream is = new FileInputStream(zipArchive);\r\n                net.lingala.zip4j.io.inputstream.ZipInputStream zis = new ZipInputStream(is)) {\r\n\r\n            LocalFileHeader fh;\r\n            while((fh = zis.getNextEntry()) != null)\r\n                elements.add(fh.getFileName());\r\n        }\r\n\r\n        // Act-assert\r\n        // Lets prove that there are five elements in archive\r\n        net.lingala.zip4j.ZipFile zf = new net.lingala.zip4j.ZipFile(zipArchive);\r\n        Assertions.assertEquals(expectedNumberOfEntries, zf.getFileHeaders().size());\r\n        Assertions.assertEquals(5, zf.getFileHeaders().size());\r\n\r\n        // Assert\r\n        // Check for mistakes in zip4j streams\r\n        Assertions.assertEquals(expectedNumberOfEntries, elements.size()); // (elements.size() == 1) = true\r\n    }\r\n\r\n    private static int zipByJavaUtilZip(ZipOutputStream zos, File rootFolder, File[] files) throws IOException {\r\n        int entriesNumber = 0;\r\n        for (File f : files) {\r\n            if (f.isDirectory())\r\n                entriesNumber += zipByJavaUtilZip(zos, rootFolder, f.listFiles());\r\n            else {\r\n                entriesNumber++;\r\n                String path = rootFolder.toPath().relativize(f.toPath()).toString().replaceAll(\"\\\\\\\\\", \"/\");\r\n                ZipEntry entry = new ZipEntry(path);\r\n                zos.putNextEntry(entry);\r\n                try (InputStream fis = new FileInputStream(f)) {\r\n                    IOUtils.copy(fis, zos);\r\n                }\r\n                zos.closeEntry();\r\n            }\r\n        }\r\n        return entriesNumber;\r\n    }\r\n```\r\n\r\nHowever, comparing archives from ```zip4j``` and ```java.util.zip``` in hex viewer, I found, that there are not many differences between them. One of them is the general purpose flag, but the 3rd bit of it have been set in both archives. That means, that in LFH compression size is 0, and the actual size is written in the data descriptor (they are identical). So it is normal to dont know the actual size while reading LFH. But the problem is, then I call  ```zis.getNextEntry()``` second time the result will be null, because in ```zis.getNextEntry()``` there is call of ```readUntilEndOfEntry()```, in it I can see this code:\r\n```java\r\n    if (localFileHeader.isDirectory() || localFileHeader.getCompressedSize() == 0) {\r\n      return;\r\n    }\r\n.....\r\n```\r\nIn this condition there is a leaving from function, because localFileHeader.getCompressedSize() is equal to zero. But after creating archive with the same content via zip4j ZipFile or ZipOutputStream, the test above will pass. So I found this as a strange behaviour.\r\n\r\nMoreover, if I fix it in my code with the problems will appear in reading directories-lfh:\r\n```\r\nif (!lfh.isDirectory())\r\n   zis.readAllBytes();\r\n```\r\n\r\nI donâ€™t know exactly why this is happening and how to fix it (maybe it doesn't need to be fixed at all).\r\nThe test archive in attach. Thank you!\r\n[test.zip](https://github.com/srikanth-lingala/zip4j/files/5857122/test.zip)\r\n","closed_by":{"login":"srikanth-lingala","id":3450302,"node_id":"MDQ6VXNlcjM0NTAzMDI=","avatar_url":"https://avatars.githubusercontent.com/u/3450302?v=4","gravatar_id":"","url":"https://api.github.com/users/srikanth-lingala","html_url":"https://github.com/srikanth-lingala","followers_url":"https://api.github.com/users/srikanth-lingala/followers","following_url":"https://api.github.com/users/srikanth-lingala/following{/other_user}","gists_url":"https://api.github.com/users/srikanth-lingala/gists{/gist_id}","starred_url":"https://api.github.com/users/srikanth-lingala/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/srikanth-lingala/subscriptions","organizations_url":"https://api.github.com/users/srikanth-lingala/orgs","repos_url":"https://api.github.com/users/srikanth-lingala/repos","events_url":"https://api.github.com/users/srikanth-lingala/events{/privacy}","received_events_url":"https://api.github.com/users/srikanth-lingala/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/srikanth-lingala/zip4j/issues/279/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/srikanth-lingala/zip4j/issues/279/timeline","performed_via_github_app":null,"state_reason":"completed"}