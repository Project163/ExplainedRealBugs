{% extends "base.html" %}
{% block title %}{% if lang == 'zh' %}缺陷查询{% else %}Bug Search{% endif %}{% endblock %}

{% block content %}
<h1 class="mb-3">{% if lang == 'zh' %}缺陷查询{% else %}Bug Search{% endif %}</h1>

<form method="get" action="/bugs" class="row g-2 mb-3">
  <input type="hidden" name="lang" value="{{ lang }}" />
  <div class="col-md-2">
    <label class="form-label">{% if lang == 'zh' %}项目{% else %}Project{% endif %}</label>
    <select class="form-select" name="project_id">
      <option value="">{% if lang == 'zh' %}全部{% else %}All{% endif %}</option>
      {% for p in projects %}
      <option value="{{ p }}" {% if current.project_id == p %}selected{% endif %}>{{ p }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-1">
    <label class="form-label">Bug ID</label>
    <input class="form-control" type="text" name="bug_id" value="{{ current.bug_id }}" />
  </div>
  <div class="col-md-2">
    <label class="form-label">Issue ID</label>
    <input class="form-control" type="text" name="issue_id" value="{{ current.issue_id }}" />
  </div>
  <div class="col-md-2">
    <label class="form-label">{% if lang == 'zh' %}类别{% else %}Label{% endif %}</label>
    <select class="form-select" name="label">
      <option value="">{% if lang == 'zh' %}全部{% else %}All{% endif %}</option>
      {% for l in labels %}
      <option value="{{ l }}" {% if current.label == l %}selected{% endif %}>{{ l }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">{% if lang == 'zh' %}关键字{% else %}Keyword{% endif %}</label>
    <input class="form-control" type="text" name="q" value="{{ current.q }}" placeholder="{% if lang == 'zh' %}标题/描述/讨论{% else %}title/description/discussion{% endif %}" />
  </div>
  <div class="col-md-2">
    <label class="form-label">{% if lang == 'zh' %}每页数量{% else %}Page size{% endif %}</label>
    <select class="form-select" name="page_size">
      {% set ps = current.page_size or 500 %}
      {% for size in [50, 100, 200, 500, 1000, 2000, 5000] %}
      <option value="{{ size }}" {% if ps == size %}selected{% endif %}>{{ size }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-1 d-flex align-items-end">
    <button class="btn btn-primary w-100" type="submit">{% if lang == 'zh' %}搜索{% else %}Search{% endif %}</button>
  </div>
</form>

<table class="table table-striped table-sm">
  <thead>
    <tr>
      <th>Project</th>
      <th>Bug ID</th>
      <th>Issue</th>
      <th>{% if lang == 'zh' %}标题{% else %}Title{% endif %}</th>
      <th>{% if lang == 'zh' %}类别{% else %}Label{% endif %}</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {% for r in rows %}
    <tr>
      <td>{{ r["project_id"] }}</td>
      <td>{{ r["bug_id"] }}</td>
      <td>
        {% if r["issue_id"] %}
          <a href="{{ r["issue_url"] }}" target="_blank">{{ r["issue_id"] }}</a>
        {% endif %}
      </td>
      <td>{{ r["title"] }}</td>
      <td>{{ r["manual_label"] or r["llm_label"] }}</td>
      <td>
        <a class="btn btn-sm btn-outline-secondary" href="/bugs/{{ r["project_id"] }}/{{ r["bug_id"] }}?lang={{ lang }}">{% if lang == 'zh' %}详情{% else %}Detail{% endif %}</a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{# 分页导航：上一页 / 下一页 #}
{% if rows and current.page_size %}
  <nav aria-label="Page navigation" class="mt-2">
    <ul class="pagination">
      {% set base_params = {
        'project_id': current.project_id,
        'bug_id': current.bug_id,
        'issue_id': current.issue_id,
        'label': current.label,
        'q': current.q,
        'page_size': current.page_size,
        'lang': lang,
      } %}

      {# 上一页 #}
      {% if current.page > 1 %}
        {% set prev_params = base_params.copy() %}
        {% set _ = prev_params.update({'page': current.page - 1}) %}
        <li class="page-item">
          <a class="page-link" href="?{% for k, v in prev_params.items() if v %}{{ k }}={{ v }}&{% endfor %}">{% if lang == 'zh' %}上一页{% else %}Previous{% endif %}</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">{% if lang == 'zh' %}上一页{% else %}Previous{% endif %}</span></li>
      {% endif %}

      {# 当前页显示 #}
      <li class="page-item disabled">
        <span class="page-link">{% if lang == 'zh' %}第 {{ current.page }} 页{% else %}Page {{ current.page }}{% endif %}</span>
      </li>

      {# 下一页：由于不知道总数，这里仅在本页记录数达到 page_size 时显示下一页按钮 #}
      {% if rows|length >= current.page_size %}
        {% set next_params = base_params.copy() %}
        {% set _ = next_params.update({'page': current.page + 1}) %}
        <li class="page-item">
          <a class="page-link" href="?{% for k, v in next_params.items() if v %}{{ k }}={{ v }}&{% endfor %}">{% if lang == 'zh' %}下一页{% else %}Next{% endif %}</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">{% if lang == 'zh' %}下一页{% else %}Next{% endif %}</span></li>
      {% endif %}
    </ul>
  </nav>
{% endif %}

{% endblock %}
